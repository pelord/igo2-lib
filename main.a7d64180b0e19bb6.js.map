{"version":3,"file":"main.a7d64180b0e19bb6.js","mappings":"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D,QAAQ6G,KAAK,6BAA6BzC,EAAgBP,4BAA1D,EACCyd,IACDthB,QAAQD,MAAM,iBAAiBqE,EAAgBP,2CAA/C,EACC,KACDjE,EAAQ,KAAD,EALT,EAQL,UCzIGgtC,gBACF01J,WAGFC,QACGC,gBAAgBV,IAChBjnJ,MAAMv5B,GAAOthB,QAAQC,IAAIqhB,GAF5B,oBCZA,QACA,aACA,gBACA,WACA,eACA,kBACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,cACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,mBACA,gBACA,aACA,gBACA,YACA,eACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,mBACA,gBACA,mBACA,gBACA,aACA,gBACA,aACA,gBACA,gBACA,mBACA,gBACA,mBACA,eACA,kBACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,aACA,gBACA,aACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,cACA,iBACA,aACA,gBACA,aACA,gBACA,mBACA,gBACA,mBACA,gBACA,WACA,cACA,aACA,gBACA,aACA,gBACA,YACA,eACA,mBACA,sBACA,kBACA,qBACA,aACA,gBACA,aACA,gBACA,WACA,cACA,aACA,gBACA,aACA,gBACA,gBACA,mBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,mBACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,mBACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,mBACA,gBACA,aACA,gBACA,iBACA,oBACA,gBACA,mBACA,aACA,gBACA,aACA,gBACA,mBACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,kBACA,qBACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,cACA,iBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,gBACA,mBACA,cACA,iBACA,aACA,gBACA,cACA,iBACA,cACA,kBACA,qBACA,iBACA,gBACA,mBACA,aACA,gBACA,aACA,gBACA,aACA,kBACA,qBACA,gBACA,aACA,gBACA,mBACA,sBACA,aACA,gBACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,gBACA,oBAIA,cACA,YACA,WACA,CACA,eACA,eACA,8CACA,gCACAmhL,CACA,CACA,YACA,CACAlxL,kBACA,sBACA,EACAA,aACAmxL,aACAnxL","names":["Base64","s","i","charCodeAt","this","ALPHA","indexOf","charAt","b10","pads","imax","length","x","String","PADCHAR","getByte64","push","fromCharCode","join","getByte","userAgent","Bowser","window","navigator","Clipboard","element","successful","textArea","createTextArea","selectText","copyTextToClipboard","destroyTextArea","text","document","createElement","value","body","appendChild","removeChild","getOSName","oldContentEditable","contentEditable","oldReadOnly","readOnly","range","createRange","selection","getSelection","contenteditable","readonly","selectNodeContents","removeAllRanges","addRange","setSelectionRange","select","compareVersion","execCommand","StringUtils","s1","s2","p","arguments","toString","changeData","getChanges","nextS","slice","mtc","ins","sbs","nextThis","del","diff","l","m","match","slen","o","fis","isThisLonger","c","longer","shorter","bi","split","len","cd","fil","sub","rc","getMatchingSubstring","rotateArray","b","array","n","res","Array","Ao","ChangeType","ChangeUtils","obj1","obj2","ignoreKeys","items","added","deleted","modified","u","obj1Clone","obj2Clone","fromItem","index","findIndex","id","change","type","DELETED","toItem","splice","fromItemClone","JSON","parse","stringify","toItemClone","keysChanged","compareObject","undefined","MODIFIED","oldValue","newValue","map","ADDED","itemAdded","baseKey","keys","Set","Object","forEach","keyString","key","isArray","concat","r","ObjectUtils","obj","keysArray","replace","current","shift","item","Date","target","source","ignoreUndefined","output","assign","isObject","filter","mergeDeep","src","prop","hasOwnProperty","copyDeep","summaryCapitalizeObject","capitalizeObject","upperCaseCount","property","upperCaseProperty","toUpperCase","count","capitalizedProperty","capitalizedPropertyObject","singlePossibility","paramClosestToLowercase","f","toLowerCase","reduce","prev","y","removeUndefined","removeNull","a","direction","nullsFirst","nullScore","ax","bx","_","$1","$2","Infinity","an","bn","nn","localeCompare","obj1Props","getOwnPropertyNames","obj2Props","_obj","NumberUtils","num","decimal","roundFactor","Math","pow","round","create","random","substring","S4","SubjectStatus","Le","Watcher","Subject","_status","status$","next","callback","scope","watch","status$$","pipe","distinctUntilChanged","subscribe","status","handleStatusChange","call","unwatch","unsubscribe","Waiting","ActivityService","BehaviorSubject","ids","uuid","counter$","factory","ActivityInterceptor","activityService","req","activity","headers","get","actReq","clone","delete","handle","register","finalize","unregister","i0","IgoActivityModule","ngModule","providers","provide","HTTP_INTERCEPTORS","useClass","multi","yl","lib","releaseDate","ConfigService","injector","config","options","baseConfig","default","path","http","HttpClient","Promise","resolve","_reject","catchError","error","console","log","throwError","configResponse","version","CONFIG_OPTIONS","InjectionToken","useValue","configService","load","IgoConfigModule","provideConfigOptions","APP_INITIALIZER","useFactory","configFactory","deps","LanguageLoader","prefix","suffix","t","lang","igoLocale$","getConfig","appLocale$","combineLatest","translations","acc","loader","TranslateLoader","defaultLanguageLoader","IgoMissingTranslationHandler","params","translateService","langs","Error","substr","IgoLanguageModule","provideDefaultLanguageLoader","TranslateModule","missingTranslationHandler","MissingTranslationHandler","IgoMessageModule","CommonModule","ToastrModule","positionClass","timeOut","extendedTimeOut","messageClass","closeButton","progressBar","enableHtml","tapToDismiss","maxOpened","preventDuplicates","resetTimeoutOnDuplicate","countDuplicates","includeTitleDuplicates","MessageType","LanguageService","translate","getBrowserLang","getLanguage","setDefaultLang","language$","language","use","reloadLang","MessageService","languageService","activeMessageTranslations","debounceTime","toastr","toasts","activeMessageTranslation","find","amt","toast","toastId","translatedTextInterpolateParams","textInterpolateParams","translatedTitleInterpolateParams","titleInterpolateParams","k","instant","forkJoin","textKey","titleKey","first","toastRef","componentInstance","message","title","ToastrService","httpError","caught","messageType","toastrConfig","iconClasses","messages$","currentDate","from","to","showIcon","handleTemplate","messageShown","SUCCESS","success","ERROR","INFO","info","SHOW","show","ALERT","WARNING","alert","handleNgxToastr","translatedTitlenterpolateParams","activeToast","translatedTitle","warning","remove","mess","template","html","Injector","ErrorInterceptor","originalReq","interceptError","errorContainer","handleError","handleCaughtError","handleUncaughtError","HttpErrorResponse","errorObj","statusText","url","toDisplay","messageService","IgoErrorModule","parentModule","dbConfig","name","objectStoresMeta","store","storeConfig","keyPath","autoIncrement","storeSchema","keypath","unique","IgoCoreModule","matIconRegistry","domSanitizer","addSvgIconSet","bypassSecurityTrustResourceUrl","HttpClientModule","forRoot","NgxIndexedDBModule","ROUTE_SERVICE_OPTIONS","RouteService","router","route","centerKey","zoomKey","projectionKey","contextKey","searchKey","visibleOnLayersKey","visibleOffLayersKey","directionsCoordKey","directionsOptionsKey","toolKey","wmsUrlKey","wmsLayersKey","wmtsUrlKey","wmtsLayersKey","arcgisUrlKey","arcgisLayersKey","iarcgisUrlKey","iarcgisLayersKey","tarcgisUrlKey","tarcgisLayersKey","vectorKey","decodeURIComponent","location","search","includes","queryParams","pair","navigate","Xt","Media","Cn","MediaOrientation","MediaService","breakpointObserver","observe","Breakpoints","matches","media$","Mobile","orientation$","Landscape","Portrait","Tablet","Desktop","documentElement","getMedia","qe","StorageScope","Sn","StorageServiceEventEnum","StorageService","SESSION","sessionStorage","getItem","LOCAL","localStorage","_a","previousValue","setItem","currentValue","storageChange$","event","removeItem","REMOVED","clear","CLEARED","v","endposition","CompressionService","Map","generateBase64Index","base64Index","set","indexBase64","blob","Observable","observer","reader","FileReader","readAsDataURL","onload","base64","result","valueOf","text64","compressed","compressStringBase64","object","compressedData","decompressed","decompressStringBase64","byteCharacters","atob","byteNumbers","byteArray","Uint8Array","Blob","out","bits","chr","rem","j","getNumber","NetworkService","EventEmitter","connection","onLine","checkNetworkState","onlineSubscription","fromEvent","previousMessageId","messageObj","state","emitEvent","offlineSubscription","stateChangeEventEmitter","emit","e","reportState","startWith","at","EntityTableColumnRenderer","Lo","EntityTableScrollBehavior","yi","EntityTableSelectionState","entity","safeObject","meta","getEntityProperty","idProperty","titleProperty","icon","iconProperty","EntityStateManager","ReplaySubject","getKey","getEntityId","size","setMany","entities","changes","exclusive","updateMany","updateManyExclusive","reverseMany","currentState","reversedChanges","reverseChanges","allKeys","getAllKeys","some","changeKey","entries","bunch","storeKeys","change$","EntityView","source$","lifted","joins","getKey$","count$","empty$","_index","values$","clause","values","sort","values$$","filter$","filterIndex","filters$","sort$","liftJoinedSource","liftSource","skip","processValues","setValues","sources$","joinData","computeJoinedValue","joinIndex","filters","filterValues","sortValues","clauses","every","v1","v2","valueAccessor","generateIndex","empty","EntityStore","_pristine","strategies","getProperty","createStateManager","view","createDataView","stateView","createStateView","lift","entities$","pristine","updateCount","softClear","destroy","insertMany","deleteMany","strategy","activate","existingStrategy","_strategy","constructor","bindStore","unbindStore","getStrategyOfType","deactivate","all$","currentRecord","statesAreTheSame","revision","ref","createIndex","record","newState","currentStateIsEmpty","newStateIsEmpty","EntityStoreWatcher","cdRef","setChangeDetector","setStore","teardownObservers","innerStateIndex","setupObservers","detectChanges","entities$$","onEntitiesChange","state$$","onStateChange","changesDetected","storeIndex","innerIndex","storeValue","innerValue","EntityStoreStrategy","stores","active$","active","doDeactivate","doActivate","EntityStoreFilterCustomFuncStrategy","filterStore","unfilterStore","filterAll","unfilterAll","addFilter","filterClauseFunc","filterId","removeFilter","EntityStoreFilterSelectionStrategy","has","selected","ctx_r0","EntitySelectorComponent","titleAccessor","getEntityTitle","emptyText","multiAllText","multiNoneText","disabled","watcher","selected$$","manyBy$","records","onSelectFromStore","multiSelect","_value","multiSelectValue","all","emptyValue","updateAll","selectedChange","selected$","updateMultiToggleWithEntities","multiText$","selectors","ctx","StopPropagationDirective","stopPropagation","onClick","EntityTablePaginatorComponent","mediaService","hidePageSize","pageIndex","pageSize","showFirstLastButtons","paginationLabelTranslation$$","rangeLabel","page","of","label","startIndex","endIndex","max","min","unsubscribeAll","count$$","emitPaginator","entitySortChange$$","entitySortChange$","paginator","firstPage","initPaginatorOptions","translateLabels","paginatorOptions","_b","_c","pageSizeOptions","_d","isMobile","_e","_f","_intl","firstPageLabel","getRangeLabel","itemsPerPageLabel","lastPageLabel","nextPageLabel","previousPageLabel","paginatorChange","MatPaginator","ImageErrorDirective","el","errorImageUrl","hideError","nativeElement","style","display","onError","EntityTableRowDirective","renderer","selectOnClick","highlightSelection","_selected","Auto","toggleSelected","scroll","addCls","selectedCls","highlightedCls","removeCls","scrollIntoView","scrollMode","behavior","block","inline","cls","addClass","removeClass","SanitizeHtmlPipe","_sanitizer","bypassSecurityTrustHtml","pure","SecureImagePipe","HttpHeaders","activityInterceptor","regexDepot","RegExp","test","responseType","err","switchMap","onloadend","complete","__decorate","Cacheable","maxCacheCount","onToggleRows","$event","ctx_r13","onShiftToggleRow","record_r11","onDateChange","onChange","onValueChange","onBooleanValueChange","onSelectValueChange","onAutocompleteValueChange","onButtonClick","EntityTableComponent","formBuilder","_focusMonitor","_elementRef","ngControl","_parentForm","_controlName","_defaultErrorStateMatcher","dateAdapter","UntypedFormGroup","filteredOptions","entityTableColumnRenderer","entityTableSelectionState","sortNullsFirst","withPaginator","MatTableDataSource","setLocale","_paginator","dataSource","columns","column","visible","selectionCheckbox","selectMany","fixedHeader","tableHeight","handleDatasource","getColumnKeyWithoutPropertiesTag","properties","checked","formGroup","controls","setValue","option","viewValue","moment","format","validation","mandatory","setControl","control","multiple","parseInt","valueChanges","domainValues","filterNormalized","normalize","formControlValue","isEdition","linkColumnForce","date","utc","newKey","getValidationAttributeValue","disable","unsubscribeStore","selection$$","firstSelected","firstSelectedStateviewPosition","pageMax","pageToReach","floor","selectionState$","computeSelectionState","dataSource$$","enableEdit","data","getValue","entitySortChange","lastRecordCheckedKey","entityClick","update","entitySelectChange","toggle","onToggleRow","selectNode","stopImmediatePropagation","recordIndex","lastRecordChecked","indexes","apply","_record","selectedRecords","selectionCount","None","All","Some","sortable","isUrl","pop","Boolean","list_id","Number","list_option","edition","validationType","Default","func","headerClassFunc","Function","rowClassFunc","tableFunc","cellClassFunc","columnFunc","clickFunc","MatFormFieldControl","useExisting","Dn","ActionbarMode","action","ActionbarItemComponent","color","withTitle","withIcon","withTooltip","disabled$","noDisplay$","args","ngClass","ngClass$$","updateNgClass","isObservable","icon$$","updateIcon","checkCondition","checkCondition$$","updateCheckCondition","tooltip","tooltip$$","updateTooltip","availability","availability$$","available","disabled$$","display$$","noDisplay","noDisplay$$","trigger","ngClass$","tooltip$","checkCondition$","icon$","scrollUp","onTriggerAction","scrollDown","ctx_r1","ActionbarComponent","overlay","elRef","actionbarMode","collapsed","handler","Dock","withToggleButton","horizontal","iconColor","scrollActive","xPosition","yPosition","_overlayClass","clientHeight","scrollHeight","scrollTop","scrollBy","IgoActionbarModule","MatButtonModule","MatIconModule","MatTooltipModule","MatMenuModule","MatListModule","MatCardModule","MatCheckboxModule","IgoActionModule","IgoBadgeIconDirective","hidden","inverseColor","inheritColor","getNamedSvgIcon","svgObj","svg","updateSvg","updateHidden","updateDisabled","updateColor","querySelector","badge","alignItems","justifyContent","innerHTML","background","getComputedStyle","getPropertyValue","originalColor","IgoMatBadgeIconModule","MatBadgeModule","ClickoutDirective","contains","clickout","handleMouseClick","IgoClickoutModule","CollapseDirective","_collapsed","_target","collapseTarget","expandTarget","click","CollapsibleComponent","_title","IgoCollapsibleModule","ConfirmDialogComponent","dialogRef","ConfirmDialogService","dialog","open","disableClose","confirmMessage","afterClosed","IgoConfirmDialogModule","imports","MatDialogModule","ContextMenuDirective","viewContainerRef","elementRef","TouchEvent","touches","pageX","pageY","MouseEvent","close","preventDefault","menuPosition","overlayRef","positionStrategy","position","flexibleConnectedTo","withPositions","originX","originY","overlayX","overlayY","scrollStrategy","scrollStrategies","attach","TemplatePortal","menuContext","$implicit","clickTarget","overlayElement","take","dispose","onContextMenu","LongPressDirective","touchDuration","onlyIOS","touchTimeout","setTimeout","longpress","touchEnd","clearTimeout","touchend","IgoContextMenuModule","CustomHtmlComponent","_html","IgoCustomHtmlModule","MatInputModule","DOMService","dom","response","toPromise","IgoDOMModule","IgoDrapDropModule","DynamicComponent","componentFactory","subscriptions","inputs","inputs$$","subscribers","componentRef","createComponent","updateInputs","updateSubscribers","unobserveAllInputs","instance","propName","unobserveInput","inputValue","observeInput","setInputValue","onUpdateInputs","prototype","getPrototypeOf","descriptor","getOwnPropertyDescriptor","outputs","emitter","subscriber","_subscriber","observable","DynamicComponentService","resolver","componentCls","resolveComponentFactory","DynamicOutletComponent","dynamicComponentService","component","eq","inputsAreEquivalents","subscribersAreEquivalents","dynamicComponent","renderComponent","setTarget","ViewContainerRef","IgoDynamicOutletModule","IgoDynamicComponentModule","IgoFlexibleModule","FormComponent","autocomplete","buttons","children","formData","setData","submitForm","getData","getAllFormFields","form","groups","group","fields","field","updateDataWithFormField","reset","IgoFormFormModule","FormsModule","ReactiveFormsModule","FormService","addControl","validator","validators","getValidators","setValidators","partial","validatorOption","validatorStr","getValidator","Validators","FormFieldService","FormFieldComponent","formFieldService","fieldInputs","fieldSubscribers","getFieldByType","errors","fieldOptions","placeholder","disableSwitch","formControl","required","IgoFormFieldModule","MatFormFieldModule","MatSelectModule","FormGroupComponent","colSpan","cols","colspan","getFieldColSpan","messages","errorMessages","getControlErrorMessage","IgoFormGroupModule","IgoFormModule","IgoEntitySelectorModule","IgoStopPropagationModule","IgoEntityTablePaginatorModule","MatPaginatorModule","IgoImageModule","IgoEntityTableModule","MatTableModule","MatAutocompleteModule","MatSortModule","MatDatepickerModule","IgoEntityModule","InteractiveTourLoader","jsonURL","getPathToConfigFile","getJSON","allToursOptions","toolName","nameInConfigFile","InteractiveTourService","interactiveTourLoader","shepherdService","nextIndex","isAppHaveTour","loadConfigTour","haveTour","getTourOptionData","stepConfig","conditions","buttonKind","classes","actionName","self","nbTry","checkExist","setInterval","getCurrentStep","attachTo","cancel","clearInterval","currentStepElement","getElement","querySelectorAll","classList","add","header","stepsArray","steps","progress","className","innerText","insertBefore","tour","service","nextStep","checkNext","_setupModal","step","actionConfig","condition","getAction","executeAction","waitFor","maxTry","maxWait","shepherdSteps","on","popperOptions","modifiers","offset","beforeShowPromise","executeActionPromise","previousStep","beforeChange","beforeShow","getButtons","noBackButton","class","highlightClass","scrollTo","scrollToElement","canClickTarget","disableInteraction","when","onShow","hide","onHide","defaultStepOptions","cancelIcon","enabled","getShepherdSteps","modal","confirmCancel","addSteps","tourObject","addProgress","start","Toolbox","activeToolHistory","tool","setToolbar","toolbar","initStore","activeTool$$","tools","toolbar$","getTool","deactivateTool","activateTool","clearActiveToolHistory","firstBy$","setActiveTool","activeTool$","ToolService","toolbox","setTools","getTools","startInteractiveTour","InteractiveTourComponent","interactiveTourService","toolService","tourToStart","styleButton","activeToolName","isActiveTool","isToolHaveTourConfig","getTourToStart","inMobileAndShow","isToolHaveTour","isTourDisplayInMobile","disabledTourButton","startTour","IgoInteractiveTourModule","KeyValuePipe","keyValues","IgoKeyValueModule","ListItemDirective","_color","_focused","_disabled","beforeFocus","beforeUnfocus","toggleFocusedClass","focus","unfocus","beforeSelect","beforeUnselect","toggleSelectedClass","unselect","beforeDisable","beforeEnable","toggleDisabledClass","enable","offsetTop","focused","focusedCls","disabledCls","ListComponent","_navigation","_selection","_selectedItem","focusedItem","_focusedItem","navigationEnabled","enableNavigation","listItems","init","listItems$$","toArray","igoList","getFocusedIndex","isScrolledIntoView","offsetHeight","selectedItem","navigation","getOffsetTop","elem","docViewTop","elemTop","findSelectedItem","findFocusedItem","item2","handleItemBeforeSelect","handleItemSelect","handleItemBeforeFocus","handleItemFocus","focusPrevious","focusNext","handleKeyboardEvent","disableNavigation","IgoListModule","PanelComponent","_withHeader","IgoPanelModule","SpinnerComponent","shown$","shown","SpinnerActivityDirective","spinner","counter$$","IgoSpinnerModule","MatProgressSpinnerModule","TableDataSource","_database","_model","_sort","_filterChange","merge","dataChange","sortChange","getFilteredData","getSortedData","filterable","propertyA","propertyB","DataSource","Si","TableActionColor","ctx_r14","handleClickAction","TableComponent","_hasFIlterInput","SelectionModel","database","model","displayedColumns","displayed","unshift","actions","changed","colorId","row","isAllSelected","MatSort","IgoTableModule","CdkTableModule","ActionStore","Bo","ToolboxColor","speed","transform","transition","animate","ToolboxComponent","White","Grey","Primary","toolbar$$","onToolbarChange","onActiveToolChange","actionStore","animating$","onAnimate","animation$","_tool","_toolbox","activeTool","toolActivated","childrenToolActivated","parent","unAnimate","animating$$","animation","toolSlideInOut","changeDetection","IgoToolboxModule","IgoToolModule","WidgetOutletComponent","onCancel","onComplete","destroyWidget","baseSubscribers","baseSubscriber","widget","IgoWidgetOutletModule","WidgetService","widgetCls","IgoWidgetModule","WorkspaceSelectorComponent","workspace","activateWorkspace","IgoWorkspaceSelectorModule","WorkspaceWidgetOutletComponent","widget$","widgetInputs$","widgetSubscribers$","deactivateWidget","IgoWorkspaceWidgetOutletModule","IgoWorkspaceModule","TableDatabase","copiedData","compType","WorkspaceStore","activeWorkspace$","deactivateWorkspace","Workspace","entityStore","AppHomeRoutingModule","RouterModule","AppHomeComponent","AppHomeModule","AppActivityRoutingModule","AppActivityComponent","idsActivity","counter","AppActivityModule","environment","production","igo","projections","code","alias","def","extent","auth","intern","allowAnonymous","interactiveTour","tourInMobile","importExport","catalog","sources","queryFormat","queryHtmlTarget","regFilters","tooltipType","searchSources","storedqueriesreverse","nominatim","icherche","searchUrl","order","limit","coordinatesreverse","showInPointerSummary","icherchereverse","ilayer","AppConfigRoutingModule","AppConfigComponent","configLanguage","AppConfigModule","AppLanguageRoutingModule","AppLanguageComponent","changeLanguage","setLanguage","AppLanguageModule","AppMediaRoutingModule","AppMediaComponent","media","orientation","getOrientation","isTouchScreen","AppMediaModule","AppMessageRoutingModule","AppMessageComponent","AppMessageModule","AppRequestRoutingModule","AppRequestComponent","callHttp","rep","callHttpError","AppRequestModule","AppActionRoutingModule","AppActionComponent","ngOnInit","added$","ngOnDestroy","AppActionModule","AppSalutationComponent","AppExplanationComponent","AppDynamicComponentRoutingModule","AppDynamicComponentComponent","toggleComponent","AppDynamicComponentModule","AppEntityTableRoutingModule","AppEntityTableComponent","description","image","AppEntityTableModule","AppEntitySelectorRoutingModule","AppEntitySelectorComponent","getTitle","onSelectedChange","AppEntitySelectorModule","AppFormRoutingModule","AppFormComponent","formService","fieldConfigs","choices","valueChanges$$","submitDisabled","valid","form$","fillForm","data$","clearForm","onSubmit","AppFormModule","AppTableRoutingModule","AppTableComponent","showName","handleSelect","rows","AppTableModule","AppSalutationToolComponent","ToolComponent","ChangeDetectorRef","AppAboutToolComponent","AppToolRoutingModule","AppToolComponent","panelTitle","activateSalutationTool","AppToolModule","AppSalutationWidgetComponent","AppWidgetRoutingModule","AppWidgetComponent","widgetService","onWidgetComplete","onWidgetCancel","AppWidgetModule","TokenService","token","tokenKey","jwtDecode","jwt","decode","currentTime","getTime","exp","AuthService","tokenService","anonymous","authenticate$","authenticated","logged$","globalCacheBusterNotifier","username","password","myHeader","encodePassword","loginCall","infosUser","typeConnection","post","tap","isExpired","isAuthenticated","redirectUrl","loginRoute","navigateByUrl","homeRoute","user","patch","isAnonymous","decodeToken","isAdmin","tokenDecoded","locale","expiredAlert","AuthGoogleComponent","authService","appRef","apiKey","clientId","loadSDKGoogle","loadPlatform","warn","gapi","auth2","getAuthInstance","signIn","signOut","initClient","client","discoveryDocs","then","handleSignOutClick","updateTextButton","isSignedIn","listen","updateSigninStatus","loginGoogle","getToken","access_token","btn","loginWithToken","tick","login","fjs","getElementsByTagName","js","handleClientLoad","parentNode","loginAnonymous","AuthInternComponent","fb","_allowAnonymous","loading","errorMsg","AuthFacebookComponent","appId","loadSDKFacebook","FB","Event","statusChangeCallback","loginFacebook","authResponse","accessToken","getElementById","subscribeEvents","AuthMicrosoftComponent","msalService","msalGuardConfig","PublicClientApplication","cache","cacheLocation","broadcastService","MsalBroadcastService","inProgress$","InteractionStatus","takeUntil","_destroying$","checkAccount","loginPopup","getConf","authRequest","setActiveAccount","account","acquireTokenSilent","tokenId","idToken","catch","__awaiter","InteractionRequiredAuthError","acquireTokenPopup","conf","MSAL_GUARD_CONFIG","MsalServiceb2c","hash","redirectHash","initializeWrapperLibrary","WrapperSKU","initialize","request","acquireTokenRedirect","silentRequest","handleRedirectPromise","loginRedirect","logoutRequest","logout","logoutRedirect","logoutPopup","ssoSilent","logger","getLogger","setLogger","MSAL_INSTANCE","MsalBroadcastServiceb2c","msalInstance","_msalSubject","msalSubject$","asObservable","_inProgress","addEventCallback","EventMessageUtils","verbose","eventType","AuthMicrosoftb2cComponent","browserAuthOptions","onLogin","home","AuthFormComponent","_backgroundDisable","_hasAlreadyConnectedDiv","_hasLogoutDiv","_showAlreadyConnectedDiv","_showLogoutDiv","isLogoutRoute","hasAlreadyConnectedDiv","hasLogoutDiv","analyzeRoute","getName","goToRedirectUrl","logoutRoute","firstName","sourceId","events","NavigationStart","changeEvent","currentRoute","isLoginRoute","AuthInterceptor","refreshInProgress","trustHosts","hostname","withCredentials","handleHostsWithCredentials","hostWithKey","handleHostsAuthByKey","refreshToken","href","host","authHeader","authReq","hashUser","Md5","xhr","setRequestHeader","urlDecomposed","urlWithKeyAdded","paramsToKeep","reqUrl","hostsWithCredentials","hostWithCredentials","domainRegFilters","hostsWithAuthByKey","hostWithAuthByKey","keyProperty","keyValue","msConf","redirectUri","authority","interactionType","InteractionType","scopes","loginHint","MSALConfigFactoryb2c","MSALAngularConfigFactoryb2c","MSALConfigFactory","MSALAngularConfigFactory","MsalService","AuthStorageService","userIgo","preference","g","mergePreference","IgoAuthModule","provideAuthMicrosoft","MsalModule","AppAuthFormRoutingModule","AppAuthFormComponent","AppAuthFormModule","MetadataService","metadata","extern","openMetadata","MetadataButtonComponent","metadataService","_layer","abstract","MetadataAbstractComponent","layerTitle","layer","MAT_DIALOG_DATA","IgoMetadataModule","FEATURE","ce","FeatureMotion","ImageWatcher","loaded","ol","handleLoadStart","handleLoadEnd","handleLoadError","un","__watchers__","watcherIndex","params_","LAYERS","layerOptions","sourceOptions","styleByAttribute","hoverStyle","featureClass","TileWatcher","tile","wms","generateWMSIdFromSourceOptions","wmts","generateWMTSIdFromSourceOptions","xyz","generateXYZIdFromSourceOptions","feature","generateFeatureIdFromSourceOptions","wfs","generateWfsIdFromSourceOptions","arcgisrest","generateArcgisRestIdFromSourceOptions","imagearcgisrest","tilearcgisrest","osm","_options","tiledebug","generateId","layers","standardizeUrl","featureTypes","origin","urlStandardized","dataService","createOlSource","generateIdFromSourceOptions","legend","FeatureDataSource","getSourceFormatFromOptions","olSourceVector","olFormatCls","formatType","olformat","formatOptions","queryTitle","ClusterDataSource","olSourceCluster","VectorWatcher","olSource","getUrl","str","mapProjection","lonLat","coordStr","negativeLon","degreesLon","minutesLon","secondsLon","directionLon","decimalLon","negativeLat","degreesLat","minutesLat","secondsLat","directionLat","decimalLat","zone","radius","lon","lat","projectionStr","opts","projectionPattern","toProjection","projectionRegex","lonlatCoord","lonLatPattern","lonLatRegex","dmsCoord","dmsCoordPattern","dmsRegex","patternUtm","utmRegex","patternMtm","mtmRegex","ddCoord","patternDd","ddRegex","dmdCoord","patternDmd","dmdRegex","patternBELL","bellRegex","mmCoord","mmPattern","mmRegex","isXYCoords","toLocaleUpperCase","trim","qp","pi","parseFloat","ro","convertDMSToDD","dl","epsgUtm","jZ","olproj","Gp","gl","epsgMtm","zZ","Qp","Zn","di","cn","da","forceNA","dest","abs","degrees","minutes","seconds","neg","dd","scale","dpi","inchesPerMeter","resolution","unit","originalEvent","altKey","MAC","metaKey","ctrlKey","shiftKey","coord","Layer","authInterceptor","legendCollapsed","firstLoadComponent","olLoadingProblem","displayed$","isInResolutionsRange$","visible$","createOlLayer","zIndex","baseLayer","maxResolution","getResolutionFromScale","maxScaleDenom","minResolution","minScaleDenom","opacity","legendOptions","setLegend","isIgoInternalLayer","getZIndex","setZIndex","setOpacity","getMaxResolution","setMaxResolution","updateInResolutionsRange","getMinResolution","setMinResolution","setVisible","hasBeenVisible$","showMessage","isInResolutionsRange","showInLayerList","igoMap","unobserveResolution","observeResolution","hasBeenVisible$$","resolution$$","viewController","resolution$","getResolution","it","OgcFilterOperatorType","G","OgcFilterOperator","OgcFilterWriter","filterSequence","PropertyIsEqualTo","spatial","fieldRestrict","PropertyIsNotEqualTo","PropertyIsLike","PropertyIsGreaterThan","PropertyIsGreaterThanOrEqualTo","PropertyIsLessThan","PropertyIsLessThanOrEqualTo","PropertyIsBetween","During","PropertyIsNull","Intersects","Within","Contains","ogcFiltersOptions","fieldNameGeometry","srcType","ogcFiltersDefaultValue","editable","geometryName","advancedOgcFilters","pushButtons","checkboxes","radioButtons","proj","ourBboxFilter","enableBbox","olfilter","getCode","checkIgoFiltersProperties","wfsOptions","srsName","featureNS","featurePrefix","bundleFilter","outputFormat","query","olFormatWFS","writeGetFeature","XMLSerializer","serializeToString","filterObject","logicalArray","createFilter","operator","logical","filterOptions","geometry","wfsPropertyName","propertyName","wfsPattern","pattern","wfsMatchCase","matchCase","wfsWildCard","wildCard","wfsSingleChar","singleChar","wfsEscapeChar","escapeChar","wfsLowerBoundary","lowerBoundary","wfsUpperBoundary","upperBoundary","wfsGeometryName","wfsExtent","wfsWktGeometry","wkt_geometry","wfsSrsName","wfsBegin","parseFilterOptionDate","begin","minDate","wfsEnd","end","maxDate","wfsExpression","expression","olFormatWKT","readGeometry","dataProjection","featureProjection","BBOX","And","Or","Not","level","defineInterfaceFilterSequence","addInterfaceFilter","defaultOperatorsType","allowedOperators","fieldsHasSpatialOperator","includeContains","effectiveOperators","srcField","allowedOperatorsType","Spatial","BasicAndSpatial","operators","Basic","Time","BasicNumericOperator","igoOgcFilterObject","parentLogical","filterid","sliderOptions","igoSpatialSelector","igoSNRC","filterArray","addFilterProperties","sequence","nextElement","lastProcessedFilter","lastParentLogical","uiFilter","computedSelectors","selector","bundles","bundle","selectorType","selectorGroup","ogcFilters","filterQueryStringSelector","filterQueryStringAdvancedFilters","pushConditions","formatGroupAndFilter","checkboxConditions","L","selectorsCorr","verifyMultipleEnableds","radioConditions","A","Y","selectConditions","P","Q","oe","buildFilter","filterQueryString","formatProcessedOgcFilter","enableds","list","selectorBundle","computeIgoSelector","bundleCondition","selectorsType","ogcselector","enabledSelector","processedFilter","layersOrTypenames","appliedFilter","layerOrTypenames","filterValue","defaultValue","isValid","defaultEpsg","defaultMaxFeatures","defaultWfsVersion","defaultFieldNameGeometry","gmlRegex","randomParam","igoFilters","paramsWFS","queryStringValues","formatWFSQueryString","ogcFilterWriter","filterOrBox","filterOrPush","handleOgcFiltersAppliedValue","xmlFilter","baseUrl","download","dynamicUrl","dataSourceOptions","epsg","forceDefaultOutputFormat","versionWfs200","urlWfs","effectiveCount","effectiveStartIndex","epsgCode","paramTypename","paramMaxFeatures","cnt","maxFeatures","srs","valueReference","sourceFields","fieldsNames","sourcefield","separator","getCapabilities","getFeature","getpropertyvalue","wfsDataSourceOptions","OlFormat","gmlFormat","olFormatGML2","olFormatGML32","olFormatGML3","olFormatOSMXML","VectorLayer","geoNetworkService","geoDBService","browsable","exportable","olOptions","flash","bind","trackFeature","enableTrackFeature","vector","olLayerVector","vectorSource","getSource","failure","customWFSLoader","customLoader","setLoader","listenerKey","vectorContext","getVectorContext","frameState","flashGeom","getGeometry","elapsed","time","elapsedRatio","duration","easeOut","newColor","ColorAsArray","getStyleFunction","style2","getImage","styleClone","getType","getRadius","setRadius","getStroke","setColor","setWidth","getWidth","getFill","setText","setStyle","drawGeometry","unByKey","render","onUnwatch","stopAnimation","trackFeatureListenerId","feat","getFeatureById","getView","setCenter","getCoordinates","getId","centerMapOnFeature","interceptor","wfsProj","olProjection","currentExtent","buildUrl","nbOfFeature","alteredUrl","getFeatures","threshold","idAssociatedCall","mostRecentIdCallOGCFilter","XMLHttpRequest","alteredUrlWithKeyAuth","alterUrlWithKeyAuth","modifiedUrl","interceptXhr","removeLoadedExtent","onerror","responseText","features","getFormat","readFeatures","addFeatures","send","projection","concatMap","content","V","DOMParser","parseFromString","readProjection","Z","responseXML","DataService","OSMDataSource","olSourceOSM","XYZDataSource","olSourceXYZ","WFSDataSource","wfsService","checkWfsParams","defineOgcFiltersDefaultOptions","sf","getSourceFieldsFromWFS","setOgcFilters","getFormatFromOptions","OlLoadingStrategy","triggerEvent","notify","WFSService","defineFieldAndValuefromWFS","getfeatureSourceField","nb","fieldList","fieldListWoGeom","fieldListWoGeomStr","olFormats","effectiveOlFormats","gmlDataSourceOptions","sourceFieldsToRetrieveValues","wfsGetFeature","firstFeature","getKeys","getGeometryName","processingArray","allowGml","results","mfeatures","loopFeatures","built_properties_value","d","kv","getProperties","boundedBy","fieldType","featureProperties","Xe","QueryFormat","rn","QueryFormatMimeType","fn","QueryHtmlTarget","WMSDataSource","sourceParams","DPI","MAP_RESOLUTION","FORMAT_OPTIONS","refreshIntervalSec","refresh","wfsCheckup","buildDynamicDownloadUrlFromParamsWFS","sourceField","initOgcFilters","calendarModeYear","FILTER","updateParams","timeFilterable","timeFilter","setTimeFilter","mapLabel","BLANK","igoRefresh","asWFSDataSourceOptions","olSourceImageWMS","ratio","timeFilter$","projParam","contentDependent","contentDependentLegend","VERSION","currentStyle","projectionExtent","getExtent","extentGetWidth","resolutions","matrixIds","z","olTileGridWMTS","extentGetTopLeft","WMTSDataSource","tileGrid","createDefaultTileGrid","olSourceWMTS","CartoDataSource","crossOrigin","olSourceCarto","htmlString","oneType","cartocss","colors","layer_name","ArcGISRestDataSource","esrijsonFormat","olFormatEsriJSON","attributions","overlaps","encodeURIComponent","customParams","olloadingstrategy","legendInfo","legendElement","htmlImgSrc","contentType","imageData","uniqueValueInfos","symbol","createSVG","stroke","strokeWidth","width","outlineColor","outline","fill","ImageArcGISRestDataSource","renderingRule","ImageArcGISRest","layerId","TileArcGISRestDataSource","olSourceTileArcGISRest","TileDebugDataSource","baseOptions","TileGrid","TileDebug","WebSocketDataSource","createWebSocket","ws","WebSocket","onmessage","onMessage","onclose","onClose","onopen","onOpen","featureAdded","readFeature","featureToRemove","removeFeature","addFeature","MVTDataSource","mvtFormat","olFormatMVT","olSourceVectorTile","EsriStyleGenerator","_converters","esriPMS","_convertEsriPMS","esriSFS","_convertEsriSFS","esriSLS","_convertEsriSLS","esriSMS","_convertEsriSMS","esriTS","_convertEsriTS","_renderers","uniqueValue","_renderUniqueValue","simple","_renderSimple","classBreaks","_renderClassBreaks","labelingInfo","mapUnits","styles","ii","labelExpression","maxScale","minScale","_getResolutionForScale","getText","defaultSymbol","defaultStyle","classBreakInfos","classBreakInfo","classMinValue","minValue","classMaxValue","field1","infos","me","layerInfo","drawingInfo","styleFunctions","drawingInfoStyle","labelingInfoStyleFunctions","_convertLabelingInfo","point","units","mpu","rotation","_transformAngle","angle","olstyle","_transformColor","font","weight","family","textBaseline","verticalAlignment","textAlign","horizontalAlignment","offsetX","_convertPointToPixel","xoffset","offsetY","yoffset","_convertOutline","lineDash","ol3Rad","PI","points","radius2","lt","TimeFilterType","Jt","TimeFilterStyle","MapService","Ko","TypeCapabilities","CapabilitiesService","mapService","WMSCapabilities","WMTSCapabilities","esriJSON","EsriJSON","capabilities","parseWMSOptions","parseWMTSOptions","jsonp","mapId","cartoOptions","parseCartoOptions","serviceCapabilities","arcgisOptions","parseArcgisOptions","legendUrl","parseTileOrImageArcgisOptions","HttpParams","fromObject","_i","parsers","read","findDataSourceInCapabilities","Capability","DataURL","Abstract","keywordList","KeywordList","queryable","getTimeFilter","Style","getStyle","isExtentInGeographic","EX_GeographicBoundingBox","getMap","w","mimeType","M","Request","GetFeatureInfo","Format","keyEnum","T","GEOJSON","GEOJSON2","GML3","GML2","HTML","_layerOptionsFromSource","Title","MaxScaleDenominator","MinScaleDenominator","OnlineResource","stepDate","Contents","Identifier","optionsFromCapabilities","ouputOptions","layer_definition","generateStyle","timeExtent","olAttribution","copyrightText","timeInfo","setTime","toUTCString","DATETIME","CALENDAR","serviceDescription","displayField","layerName","layerArray","Name","dimension","Dimension","minMaxDim","stylesAvailable","OptionsService","ProjectionService","registerProjection","utmZone","mtmZone","lon0","proj4","olproj4","setExtent","DataSourceService","capabilitiesService","optionsService","wfsDataSourceService","projectionService","context","detailedContextUri","createOSMDataSource","createFeatureDataSource","createWFSDataSource","wmsContext","createWMSDataSource","createWMTSDataSource","createXYZDataSource","createTileDebugDataSource","createCartoDataSource","createArcGISRestDataSource","createArcGISRestImageDataSource","createWebSocketDataSource","createMVTDataSource","createTileArcGISRestDataSource","createClusterDataSource","datasources$","observables","getWMSOptions","optionsFromApi","optionsMerged","getWMTSOptions","getCartoOptions","getArcgisOptions","getArcgisRestOptions","getImageArcgisOptions","projectionOut","olFeature","OlFormatGeoJSON","setId","mapTitle","getEntityRevision","getEntityIcon","projectionIn","olLayer","exclude","excludeOffline","idColumn","olFormat","startsWith","writeGeometryObject","excludeAttribute","excludeAttributeOffline","getRevision","olFeatures","olextent","featureExtent","olExtent","olFeatureExtent","olFeatureProjection","olGeometry","computeOlFeatureExtent","height","featuresExtent","viewExtent","scaleExtent","areaRatio","mapExtent","mapExtentArea","featuresExtentArea","getZoom","motion","computeOlFeaturesExtent","Zoom","zoomToExtent","Move","moveToExtent","featuresAreOutOfView","featuresAreTooDeepInView","bindLayer","addLayer","olFeaturesMap","olFeaturesToRemove","newOlFeature","olFeaturesToAddIds","FeatureStore","viewScale","checkLayer","featureToOl","setLayerOlFeatures","featureFromOl","computeOlFeaturesDiff","removeOlFeaturesFromLayer","addOlFeaturesToLayer","moveToOlFeatures","FeatureStoreInMapExtentStrategy","states$$","watchStore","empty$$","skipWhile","updateEntitiesInExtent","unwatchStore","unwatchAll","stores$$","state$","inMapExtent","entitiesInMapExtent","entitiesWithNoGeom","FeatureStoreInMapResolutionStrategy","updateEntitiesInResolution","mapResolution","inMapResolution","FeatureStoreLoadingStrategy","setMotion","subscription","onFeaturesChange","clearLayer","setLayerFeatures","selectMotion","getFeatureId","FeatureStoreLoadingLayerStrategy","onSourceChanges","flatMap","cluster","setStoreOlFeatures","OlDragSelectInteraction","OlDragBoxInteraction","FeatureStoreSelectionStrategy","_overlayStore","createOverlayStore","overlayStore","unlistenToMapClick","removeDragBoxInteraction","addOverlayLayer","listenToMapClick","dragBox","addDragBoxInteraction","watchAll","deactivateSelection","removeOverlayLayer","stores$","mapClickListener","onMapClick","ctrlKeyDown","reverse","getFeaturesAtPixel","pixel","hitTolerance","layerFilter","onSelectFromMap","olDragSelectInteraction","olInteractions","getInteractions","getArray","olInteraction","addInteraction","olDragSelectInteractionEndKey","onDragBoxEnd","removeInteraction","mapBrowserEvent","getFeaturesInExtent","doMotion","overlayFeaturesKeys","featuresKeys","groupedFeatures","groupFeaturesByStore","unselectAllFeaturesFromStore","selectFeaturesFromStore","overlayLayer","createOverlayLayer","removeLayer","addStrategy","activateStrategyOfType","markerColor","markerOutlineColor","isIE","newOutlineColor","imgSize","anchor","overflow","StyleService","createOverlayMarkerStyle","parsedStyle","parseStyle","labelMinResolution","labelMaxResolution","labelMinResolutionFromScale","labelMaxResolutionFromScale","attribute","getLabel","styleOptions","olCls","getOlCls","olKey","getOlKey","_key","guessTypeFeature","labelStyle","baseStyle","val","createStyle","OlFeature","clusterParam","layerStyle","clusterRanges","minRadius","maxRadius","showRange","dynamicRadius","clusterRadius","radiusMin","image_","radiusCalc","labelMatch","labelToGet","matchAll","createOverlayDefaultStyle","markerStyle","fillRGBA","bufferRadius","createBufferStyle","customStyle","geometryType","fillColor","strokeColor","fillWithOpacity","strokeWithOpacity","Overlay","overlayDataSource","createOverlayLayerStyle","setMap","removeOlFeature","addOlFeatures","removeFeatures","ze","LinkedProperties","sn","TooltipType","ImageLayer","valStatus","olLayerImage","setImageLoadFunction","abort","arrayBufferView","TextDecoder","imageUrl","URL","createObjectURL","TileLayer","tileLayer","olLayerTile","tileSource","setTileLoadFunction","VectorTileLayer","vectorTile","olLayerVectorTile","vectorTileSource","onLoad","LayerWatcher","propertyChange$","unwatchLayer","TIMEFILTER","OGCFILTERS","VISIBLE","OPACITY","MINRESOLUTION","MAXRESOLUTION","setPropertyChange","evt","layer$$","ei","MapViewAction","MapController","observerKeys","olMap","getOlMap","MapViewController","padding","maxZoomOnExtent","states","stateIndex","stateHistory","top","right","bottom","left","onMoveEnd","extent$$","extent$","rotation$","getRotation","olView","getProjection","center","getCenter","getOlProjection","calculateExtent","getSize","getScaleFromResolution","getUnits","zoomTo","zoom","cancelAnimations","easing","oleasing","hasPreviousState","setStateIndex","hasNextState","fromCenter","toCenter","distCenter","sqrt","fromExtent","fromSize","toSize","moySize","xSize","maxZoom","fit","isFinished","setState","state1","state2","tolerance","trunc","viewStatesAreEqual","GeolocationOverlayType","MapGeolocationController","storageService","subscriptions$$","_buffer","buffer","_accuracyThreshold","accuracyThreshold","_followPosition","followPosition","geolocationOverlay","handleFeatureCreation","position$","geolocation","getTracking","setTracking","tracking$","followPosition$","deleteFeatureByType","Position","Accuracy","Buffer","tracking","onPositionChange","deleteGeolocationFeatures","olGeolocation","trackingOptions","enableHighAccuracy","maximumAge","timeout","emissionIntervalSeconds$","interval","geolocate","alwaysTracking","storedTracking","storedFollowPosition","geolocateProperties","accuracy","altitude","altitudeAccuracy","heading","timestamp","featureById","positionGeometry","Point","accuracyGeometry","fromCircle","OlCircle","positionFeature","accuracyFeature","positionFeatureStyle","addOlFeature","accuracyFeatureStyle","bufferFeature","bufferStyle","bufferStroke","bufferFill","showBufferRadius","linkedLayers","linkId","layerToUse","parentLayer","hasParentLayer","getDirectParentLayerByProperty","hasLinkWithProperty","layerLLOptions","getLinkedLayersOptions","links","layerHasLinkWithProperty","currentLinkId","parents","pl","linkedIds","link","getIgoLayerByLinkId","lid","knownChildLayers","childLayers","getDirectChildLayersByProperty","cl","getAllChildLayersByProperty","syncedDelete","getDirectChildLayersByDeletion","getAllChildLayersByDeletion","rootLayersByProperty","plbp","getRootParentByProperty","layersId","IgoMap","attribution","defaultOptions","layerWatcher","layers$","olControlAttribution","scaleLine","olControlScaleLine","interactions","altShiftDragRotate","doubleClickZoom","keyboard","mouseWheelZoom","shiftDragZoom","dragPan","pinchRotate","pinchZoom","olinteraction","setView","setOlMap","queryResultsOverlay","searchResultsOverlay","once","geolocationController","updateGeolocationOptions","mapViewOptions","initLayerSyncFromRootParentLayers","monitorRotation","pc","propertyChange","initiatorIgoLayer","isLayerProperty","isDatasourceProperty","rootParentByProperty","clbp","resolutionPropertyHasChanged","initiatorIgoLayerSourceType","initiatorIgoLayerOgcFilterableDataSourceOptions","getUid","lLayerType","appliedOgcFilter","getParams","appliedTimeFilter","TIME","handleLayerPropertyChange","currentView","viewOptions","clearStateHistory","constrainResolution","maxLayerZoomExtent","getControls","removeControl","getBaseLayers","setMinZoom","minZoom","setMaxZoom","olUId","getLayerByOlUId","addLayers","offsetZIndex","offsetBaseLayerZIndex","addedLayers","doAddLayer","setLayers","removeLayers","newLayers","layersToRemove","handleLinkedLayersDeletion","linkedIndex","linkedLayer","doRemoveLayer","srcLayer","rootParentByDeletion","getDirectParentLayerByDeletion","hasLinkWithSyncedDelete","layerHasLinkDeletion","getRootParentByDeletion","clbd","getLayerIndex","moveLayer","raiseLayer","reverseLayers","lowerLayer","layerTo","zIndexFrom","changeBaseLayer","existingLayer","getLayerById","maxZIndex","watchLayer","sortLayersByZIndex","layer1","layer2","offline","offlineButtonToggle$","MapBrowserComponent","_view","updateView","_controls","updateControls","activityId","PointerPositionDirective","pointerPositionDelay","listenToMapPointerMove","unlistenToMapPointerMove","pointerMoveListener","onPointerEvent","delay","dragging","lastTimeoutRequest","lonlat","coordinate","pointerPositionCoord","HoverFeatureDirective","styleService","selectionMVT","hoverFeatureId","igoHoverFeatureDelay","igoHoverFeatureEnabled","subscribeToPointerStore","layers$$","tryBindStoreLayer","hoverFeatureMarker","selectionLayer","renderMode","declutter","olVectorTileSource","mvtStyleOptions","createHoverStyle","localHoverStyle","hasLabelStyle","backgroundFill","backgroundStroke","createStyleByAttribute","unsubscribeToPointerStore","unlistenToMapSingleClick","store$$","pointerHoverFeatureStore","addFeatureOverlay","resultsUnderPointerPosition","onMapEvent","singleClickMapListener","onMapSingleClickEvent","topMostOlLayer","maximumZindex","getPixelFromCoordinate","forEachFeatureAtPixel","mapFeature","layerOL","igoLayer","ol_uid","canProcessHover","localOlFeature","handleRenderFeature","setLayerStyleFromOptions","featuresToLoad","myLabelOlFeature","setProperties","labelGeom","OlGeom","setGeometry","setSource","mvtFeatures","localFeature","RenderFeature","hoverEntity","hoverSummary","getHoverSummary","summary","geom","getOrientedFlatCoordinates","coords","flatCoords","idx","mouseout","olStyle","OlStyle","ZoomButtonComponent","getMinZoom","getMaxZoom","onGeolocationClick","GeolocateButtonComponent","_map","tracking$$","HomeExtentButtonComponent","computeHomeExtent","homeExtentButtonExtent","extentOverride","homeExtentButtonCenter","centerOverride","homeExtentButtonZoom","zoomOverride","toggleWakeLock","WakeLockButtonComponent","noSleep","NoSleep","ie","edge","chrome","firefox","opera","safari","disableWakeLock","onblur","enableWakeLock","collapseOrExpand","BaseLayersSwitcherComponent","_baseLayers","expand","showButton","useStaticIcon","arrayLayers","baseLayers","mapZoom","bl","blHidden","GeoDBService","ngxIndexedDBService","compression","dbName","_newTiles","regionID","insertSource","insertEvent","geoDBData","compress","subject","object$","compressBlob","getByID","dbObject","currentRegionID","collisions","collisionsMap","customUpdate","deleteRequest","deleteByKey","isDeleted","decompressBlob","getRegionByID","tiles","IDBKey","IDBKeyRange","only","getAllByIndex","dbRequest","keyRange","lowerBound","mode","DBMode","openCursorByIndex","resetCollisionsMap","getByKey","GeoNetworkService","networkService","networkOnline","simpleGetOptions","getOnline","getOffline","LayerService","dataSourceService","geoNetwork","createTileLayer","createVectorLayer","createImageLayer","_layerOptions","computeMVTOptionsOnHover","createVectorTileLayer","createLayer","createAsyncDataSource","serviceStyle","clusterBaseStyle","createClusterStyle","layerOptionsOl","applyMapboxStyle","mapboxStyle","getStuff","sprite","getAbsoluteUrl","stylefunction","res2","MiniBaseMapComponent","layerService","basemap","_baseLayer","handleBaseLayerChanged","handleMainMapViewChange","mainMapView","mainMapViewProperties","setResolution","setRotation","baselayer","removeAllLayers","handleLinkedBaseLayer","currentLinks","layerToApply","linkedId","linkedLayerOptions","RotationButtonComponent","azimuthRounded","rotationRounded","currentStyle$","radians","deg","bearingToAzimuth","rotated$","InfoSectionComponent","infoContent","yt","CatalogItemType","Oe","TypeCatalog","Catalog","catalogService","WMSCatalog","loadCatalogWMSLayerItems","WMTSCatalog","loadCatalogWMTSLayerItems","BaselayersCatalog","baselayers","loadCatalogBaseLayerItems","ArcGISRestCatalog","loadCatalogArcGISRestItems","TileOrImageArcGISRestCatalog","typeCatalog","CompositeCatalog","composite","loadCatalogCompositeLayerItems","CatalogFactory","QueryService","queryEnabled","previousMessageIds","queryLayer","getQueryUrl","HTMLGML2","urlGml","mergeMap","mergedGML","mergeGML","gmlRes","imposedGeom","imposedProperties","extractData","pts","firstFeatureType","titleContent","queryTileField","olmpts","returnGeometry","olmline","olgeom","ptsArray","olmpoly","nbFeatures","bbox","getQueryParams","bboxExtent","queryTitleContent","featureGeometryCoordinates","featureGeometryType","appendLineString","appendPolygon","coordinates","convexHull","lower","cross","upper","imposedGeometry","queryDataSource","allowedFieldsAndAlias","getAllowedFieldsAndAlias","extractGML3Data","extractGeoJSONData","ESRIJSON","extractEsriJSONData","TEXT","extractTextData","extractHtmlData","extractGML2Data","geomToAdd","createGeometryFromUrlClick","wmsDatasource","FEATURE_COUNT","featureCount","defaultFeatureCount","R","getQueryTitle","sourceTitle","searchParams","bboxRaw","clickx","clicky","clickx1","clicky1","wktPoly","wmsParser","featureToResult","parser","htmlTarget","crs","IFRAME","bodyTagStart","bodyTagEnd","lastIndexOf","striptags","queryString","pairs","featureOL","featureGeometry","GEOMETRIE","shape","SHAPE","SHAPE_S","SHAPE_L","SHAPE_P","the_geom","datasource","forceGML2","queryUrl","getCustomQueryUrl","WMSGetFeatureInfoOptions","INFO_FORMAT","getMimeInfoFormat","QUERY_LAYERS","getFeatureInfoUrl","cartoDatasource","sql","meters","queryPrecision","tileArcGISRestDatasource","deltaX","deltaY","maxDelta","clickBuffer","serviceUrl","mime","getLabelMatch","layerIsQueryable","queryLayerFeatures","layerFeatureIsQueryable","QueryDirective","queryService","queries$$","queryFeatures","queryFeaturesHitTolerance","waitForAllQueries","cancelOngoingQueries","queries$","doQueryFeatures","queryLayers","zip","query$","clickedFeatures","values_","queryFormatAsWms","newFeature","nom","id_","_icon","OlRenderFeature","olRenderFeature","ends","getEnds","OlPolygon","getFlatCoordinates","OlPoint","OlLineString","renderFeatureFromOl","queryFeaturesCondition","olLayerFeatureIsQueryable","dragExtent","forEachFeatureIntersectingExtent","olDragSelectInteractionOnQuery","SearchSource","storageOptions","getDefaultOptions","settings","setParamFromSetting","setting","showInSettings","saveInStorage","confValue","term","settingsName","hashtags","searchSourceSetting","getSettingsValues","hashtagsValid","hashtagKey","hashtag","types","QuerySearchSource","GoogleLinks","encodeURI","markerOpacity","fillOpacity","strokeOpacity","isOlFeature","markerColorAsArray","markerColorRGB","getCommonVectorStyle","OsmLinks","CatalogService","contextConfig","catalogConfig","apiUrl","catalogsFromConfig","observables$","baseLayersCatalog","catalogsFromApi$","catalogs","_response","EMPTY","newCatalog","createInstanceCatalog","collectCatalogItems","getCatalogBaseLayersOptions","layersOptions","externalProvider","Group","getCatalogCapabilities","Service","finalLayers","flattenWmsCapabilities","groupSeparator","capabilitiesCapabilityLayer","includeRecursiveItems","modifiedParent","modifiedLayer","ff","getWMTSItems","getArcGISRESTItems","compositeCatalog","catalogsFromInstance","sortDirection","request1$","request2$","arr","flatDeepLayer","groupImpose","pushImposeGroup","outGroupImpose","address","flatLayer","obs","request3$","recursiveGroupByLayerAddress","keyFn","outItem","indicesMatchTitle","bInd","nPosition","newMetadataUrl","groupId","ind","ix","layerNameFromCatalog","forcedProperties","returnProperty","metadataUrl","metadataAbstract","metadataAbstractAll","metadataUrlAll","forcedPropertiesForAllLayers","forcedProperty","idParent","layersQueryFormat","baseAbstract","configuredQueryFormat","retrieveLayerInfoFormat","showLegend","baseSourceOptions","setCrossOriginAnonymous","propertiesToForce","computeForcedProperties","layerPrepare","itemListIn","regexes","idGroup","idGroupItemNextLevel","groupItem","prepareCatalogItemGroup","testLayerRegexes","layerItem","prepareCatalogItemLayer","itemsPrepare","loopLevel","findCatalogInfoFormat","idGroupItem","ServiceIdentification","matrixSet","requestEncoding","regex","currentLayerInfoFormat","baseInfoFormat","configuredInfoFormat","specific","onLayerAddedChange","CatalogBrowserComponent","catalogAllowLegend","toggleCollapsedGroup","currentItems","addLayerToMap","removeLayerFromMap","addGroupToMap","removeGroupFromMap","addLayersToMap","removeLayersFromMap","createAsyncLayer","oLayers","oLayer","returnItem","titleA","titleB","isLayer","sortCatalogItemsByTitle","toggleLegendItem","style_r18","onChangeStyle","onLoadImage","LayerLegendComponent","updateLegendOnResolutionChange","imagesHeight","getLegend","lastlLegend","listStyles","STYLES","onViewControllerStateChange","legendItems$","getLegendGraphic","leg","imgGraphValue","obsLegGraph","newLegends","outLegends","lastLegends","layerLegend","localLayerOptions","wmsDataSourceOptions","getScale","updateLegend","legendItems","transfertToggleLegendItem","sA","sa","elemRef","renderedLegends","renderedLegend","CatalogBrowserLayerComponent","mouseInsideAdd","isPreview$$","isPreview$","addedLayerIsPreview","layerTooltip","layerMetadata","TITLE","ABSTRACT","CUSTOM","onToggleClick","layerLegendShown$","igoLayer$","addedChange","inRange$","CatalogBrowserGroupComponent","toggleCollapsed","evaluateAdded","evaluateDisabled","layerAddedChange","tryToggleGroup","preview$","LayerListToolService","sortAlpha","onlyVisible","onlyInRange","keywordInitialized","sortedAlphaInitialized","onlyVisibleInitialized","onlyInRangeInitialized","check","toggleVisibility","toggleLayerTool","LayerItemComponent","_selectAll","toggleLegendOnVisibilityChange","expandLegendIfVisible","orderable","lowerDisabled","raiseDisabled","queryBadge","_activeLayer","selectionMode","layerTool$","layerCheck","inResolutionRange$","toggleLegend","updateQueryBadge","onResolutionChange","tooltipText","computeTooltip","network$$","showLegend$","inResolutionRange","queryBadgeHidden$","checkbox","gt","LayerListControlsEnum","io","LayerListSelectVisibleEnum","oi","LayerListDisplacement","selectAll","zoomLayerExtents","changeOpacity","zoomLayersExtents","lowerLayers","raiseLayers","LayerListComponent","thresholdToFilterAndSort","hideSelectedLayers","layersChecked","layersAreAllVisible","ogcButton","timeButton","floatLabel","layerFilterAndSortOptions","excludeBaseLayers","expandLegendOfVisibleLayers","_keyword","_onlyVisible","_sortedAlpha","toggleOpacity","_layers","removeProblemLayerInList","activeLayer$","activeLayer","getUpperLayer","isUpperBaselayer","getLowerLayer","isLowerBaselayer","raisableLayers","selectAllCheck","lowerableLayers","layersCheckedOpacity","change$$","debounce","timer","showToolbar$","computeShowToolbar","computeLayers","appliedFilterAndSort","keyword","selectAllCheck$$","selectAllCheck$","checks","layerTool","lay","showButtonZoomToExtent","layerExtent","layersExtent","actiontype","fromUi","sortedLayersToMove","ZINDEX","layersToMove","Raise","Lower","base","mapIndex","currentLayer","previousLayer","raisableLayer","layersToRaise","targetToScroll","checkItems","getElementsByClassName","itemFocused","nextLayer","lowerableLayer","layersToLower","layersOut","filterLayers","sortLayersByTitle","sortLayersByZindex","showToolbar","never","keepLayerIds","layerKeywords","kw","localKeyword","dataSourceType","keywordRegex","keywordInList","always","removable","layerItemChangeDetection$","isLayerRemovable","statusSelectedLayers","NULL","findTrue","findFalse","MIXED","ALL_VISIBLE","ALL_HIDDEN","eventMapIndex","elemSource","layersList","clearTerm","LayerListToolComponent","onlyVisible$","sortAlpha$","term$","term$$","onlyVisible$$","sortAlpha$$","LayerListBindingDirective","layersOrResolutionChange$$","shownLayers","setLayersVisibilityStatus","layersVisibility$$","visibles","allLayersAreVisible","toggleShowAllLegends","LayerLegendListComponent","showAllLegend","allowShowAllLegends","showAllLegendsValue","computeShownLayers","hasVisibleOrInRangeLayers$","hasVisibleAndNotInRangeLayers$","layersInUi$","allLegendsShown","toggleTrackFeature","TrackFeatureButtonComponent","disableTrackFeature","LayerLegendItemComponent","Gi","GeometryType","kn","FontType","DrawIconService","getIconsList","icons","getPath","zt","MeasureType","ye","MeasureLengthUnit","xs","Meters","Kilometers","Miles","Feet","Ho","ut","MeasureAreaUnit","zc","SquareMeters","SquareKilometers","SquareMiles","SquareFeet","Hectares","Acres","Xn","conversion","metersToKilometers","metersToMiles","metersToFeet","squareMetersToSquareKilometers","squareMetersToSquareMiles","squareMetersToSquareFeet","squareMetersToHectares","squareMetersToAcres","measure","parts","toLocaleString","minimumFractionDigits","maximumFractionDigits","toFixed","unitAbbr","MeasureLengthUnitAbbreviation","MeasureAreaUnitAbbreviation","olGetLength","measureOlGeometryLength","area","olGetArea","measureOlGeometryArea","lengths","coordinatesLength","olSegment","olMidpoints","olMidpointPoint","getOlGeometryMidpoints","midpointsLength","midpointCoordinate","getCoordinateAt","olMidpoint","setCoordinates","expectedNumber","clearOlMidpointTooltip","olTooltip","removeOverlay","olTooltips","getOlTooltipsAtMidpoints","olCenterTooltip","olCenter","getOlTooltipAtCenter","olPoint","srcGeomType","OlOverlay","stopEvent","setPosition","Olstyle","DrawStyleService","labelsAreShown","fontSize","Arial","fontStyle","fontSizeAndStyle","labelsAreOffset","flatCoordinates","cos","openSecureUrl","ctx_r8","FeatureDetailsComponent","sanitizer","ready","unsubscribe$","_source","_feature","selectFeature","htmlDisplayEvent","docOrImage","fileUrl","isEmbeddedLink","div","getAttribute","offlineButtonState","Route","olEvent","DrawControl","olDrawingLayer","drawingLayer","createOlInnerOverlayLayer","olGeometryType","activateModifyAndSelect","clearOlInnerOverlaySource","removeOlInnerOverlayLayer","removeOlInteractions","addOlInnerOverlayLayer","addOlInteractions","olDrawingLayerSource","OlVectorLayer","drawingLayerSource","OlVectorSource","drawingLayerStyle","olDrawInteraction","freehand$","OlDraw","maxPoints","freehand","stopClick","interactionStyle","freehandCondition","onDrawStartKey","onDrawStart","onDrawEndKey","onDrawEnd","onDrawAbortKey","abort$","olModifyInteraction","OlModify","olSelectInteraction","OlSelect","doubleClick","onSelect","unsubscribeKeyDown","onDrawKey","start$","olGeometryEvent","mousePosition","getMousePositionFromOlGeometryEvent","changes$","subscribeKeyDown","modify$","end$","select$","keyDown$$","removeLastPoint","finishDrawing","abortDrawing","DrawPopupComponent","confirmFlag","labelString","confirm","DrawShorcutsComponent","DrawLayerPopupComponent","deleteDrawings","onIconChange","openStyleModalDialog","DrawComponent","drawStyleService","drawIconService","draw","_stores","_drawControls","layerCounterID","draw$","drawControlIsDisabled","drawControlIsActive","isCreatingNewLayer","buildForm","getFillColor","getStrokeColor","getStrokeWidth","getLabelsAreShown","getIcons","getIcon","getFontSize","getFontStyle","_activeDrawingLayer","activeStore","activeDrawingLayer","activeDrawControl","drawControls","dc","deactivateDrawControl","allLayers","selectedFeatures$","onLayerChange","createDrawControl","setGeometryType","toggleDrawControl","drawControlsEvent","layersIDEvent","activeDrawingLayerSource","createInteractionStyle","newTitle","isNewLayer","StyleModalComponent","autoFocus","onFontChange","onColorChange","onOffsetLabelChange","isDrawEnd","currentLabel","updateLabelOfOlGeometry","updateFontSizeAndStyle","drawingStyle","updateFillAndStrokeColor","updateOffset","onSelectDraw","updateHeightTable","drawingLayerFeature","addFeatureToStore","clearLabelsOfOlGeometry","replaceFeatureInStore","olGeometryCoordinates","entityCoordinates","rad","center4326","point4326","lon4326","lat4326","featureId","OlGeoJSON","extent4326","getDistance","longitude","latitude","currGeometryType","onToggleLabels","activeLayerChange","selectionChange","openDrawDialog","selectedFeature","toggleLabelsAreShown","elementStyle","toggleIsChecked","currLayer","setupLayer","numberId","createIndividualElementStyle","tryAddLoadingStrategy","tryAddSelectionStrategy","many","isAnIcon","setFontSize","setFontStyle","setIcon","_label","fontStyle_","fillColor_","strokeColor_","offsetX_","offsetY_","getOffsetX","numberOfDrawings","tableTemplate","activateDrawControl","getTooltipsOfOlGeometry","drawEnd$$","onModifyDraw","drawSelect$$","linestringOnly","buildStyleData","styleModalData","getOffsetY","IgoLayerModule","MatDividerModule","MatSlideToggleModule","MatSliderModule","ColorPickerModule","IgoCatalogBrowserModule","type_r9","ctx_r5","ctx_r6","AddCatalogDialogComponent","defaultAddedCatalogType","predefinedCatalogs","addedCatalog","typeCapabilities","addedCatalogType$$","updateValueAndValidity","computePredefinedCatalogList","storeViewAll$$","emailAddress","patchValue","predefinedCatalogsList$","addCatalogDialog","CatalogLibaryComponent","addCatalogAllowed","catalogSelectChange","addingCatalog$$","predefinedCatalog","unsubscribeAddingCatalog","mapName","ServiceType","catalogToAdd","insert","newCatalogs","addedCatalogs","addCatalog","removeCatalogFromLibrary","CatalogLibaryItemComponent","catalogRemove","IgoCatalogLibraryModule","IgoCatalogModule","FilterableDataSourcePipe","arg","isTimeFilterable","isOgcFilterable","TimeFilterService","newdateformStart","newdateformEnd","dates","reformatDateTime","year","years","getFullYear","month","getMonth","day","getUTCDate","hour","getUTCHours","minute","getUTCMinutes","OGCFilterService","filterString","wfsDatasource","interfaceOgcFilters","filterByOgc","filtered","Ie","SpatialFilterType","It","SpatialFilterItemType","SpatialFilterService","AdmRegion","Arrond","CircFed","CircProv","DirReg","MRC","Mun","RegTour","bornes","hydro","routes","urlFilterList","featureCollection","getKeyByValue","itemType","thematic","Address","bufferInput","simplified","loc","featureType","featureCode","filterType","Predefined","bufferOutput","DownloadService","DSOptions","currentProj","outputFormatDownload","baseurl","openDownload","DownloadButtonComponent","downloadService","IgoDownloadModule","IgoDrawModule","MatButtonToggleModule","BrowserModule","BrowserAnimationsModule","IgoFeatureDetailsModule","IgoFeatureFormModule","IgoFeatureModule","ModifyControl","olModifyInteractionIsActive","olTranslateInteractionIsActive","olDrawInteractionIsActive","removedOlInteractions","modify","olOverlayLayer","olLinearRingsLayer","createOlLinearRingsLayer","removeOlModifyInteraction","removeOlTranslateInteraction","removeOlDrawInteraction","addOlDrawInteraction","addOlTranslateInteraction","activateTranslateInteraction","addOlModifyInteraction","activateModifyInteraction","olOverlaySource","createDrawHoleInteractionStyle","olLinearRingsSource","drawStyle","deactivateModifyInteraction","onModifyStartKey","onModifyStart","onModifyEndKey","onModifyEnd","onModifyKey","subscribeToKeyDown","unsubscribeToKeyDown","olTranslateInteraction","OlTranslate","deactivateTranslateInteraction","onTranslateStartKey","onTranslateStart","onTranslateEndKey","onTranslateEnd","onTranslateKey","olOuterGeometry","getOlGeometry","intersectsCoordinate","subscribeToDrawKeyDown","drawKeyDown$$","unsubscribeToDrawKeyDown","subscribeToDrawKeyUp","activateDrawInteraction","drawKeyUp$$","unsubscribeToDrawKeyUp","deactivateDrawInteraction","clearOlLinearRingsSource","addOlLinearRingsLayer","removeOlLinearRingsLayer","linearRingCoordinates","getLinearRing","addLinearRingToOlGeometry","_linearRingCoordinates","updateLinearRingOfOlGeometry","olPolygon","olLinearRing","appendLinearRing","addLinearRingToOlPolygon","OlLinearRing","newCoordinates","getLinearRings","LAYER","MeasurerDialogComponent","measureAreaUnit","measureLengthUnit","onToggleDisplayLines","onToggleDisplayDistance","onToggleDisplayAreas","onLengthUnitChange","onAreaUnitChange","onCalculateClick","onDeleteClick","MeasurerComponent","activeLengthUnit","formatMeasure","metersToUnit","activeAreaUnit","squareMetersToUnit","measureType","measureUnitsAuto","displayDistance","displayLines","displayAreas","showTooltips","minSegmentLength","_activeMeasureType","setActiveMeasureType","createDrawLineControl","createDrawPolygonControl","createModifyControl","updateTooltipsOfOlSource","checkDistanceAreaToggle","Length","deactivateModifyControl","freezeStore","activeMeasureType","onDisplayDistance","onDisplayLines","onDisplayAreas","table","activeOlGeometry","updateTooltipsOfOlGeometry","sum","perimeter","openDialog","olDrawSource","modifyControl","_olFeature","activateModifyControl","clearTooltipsOfOlGeometry","setOlGeometry","onFeatureAddedKey","updateMeasureOfOlGeometry","onFeatureRemovedKey","selectedFeatures$$","objectsExists","objectExist","hasArea$","hasLine$","deactivateStrategyOfType","drawLineControl","createMeasureInteractionStyle","drawPolygonControl","Area","drawControl","drawStart$$","drawChanges$$","onDrawChanges","clearMeasures","clearTooltipsOfOlSource","finalizeMeasureOfOlGeometry","measureOlGeometry","measure$","modifyStart$$","modifyEnd$$","modifyChanges$$","onModifyChanges","_measure","olMidpointsTooltips","updateOlGeometryMidpoints","typeGeom","createOlTooltipAtPoint","updateOlTooltipsAtMidpoints","updateOlTooltip","centerCoordinate","olGetCenter","updateOlGeometryCenter","updateOlTooltipAtCenter","shouldShowTooltip","addOverlay","forEachFeature","showTooltipsOfOlGeometry","_unit","_type","computeTooltipInnerHTML","MeasureFormatPipe","GeometryFormFieldInputComponent","createMeasureTooltip","drawGuide","_drawControlIsActive","controlOptions","_geometryType","deactivateControl","freehandDrawIsActive","toggleControl","_freehandDrawIsActive","_drawStyle","createDrawInteractionStyle","olGuideStyle","getGuideStyleFromDrawStyle","defaultDrawStyleRadius","_overlayStyle","addGeoJSONToOverlay","olModify","features_","overlayStyle","addOlOverlayLayer","onTouched","updateDrawStyleWithDrawGuide","activeControl","activateControl","olGeometryEnds$$","onOlGeometryEnds","olGeometryChanges$$","onOlGeometryChanges","removeMeasureTooltip","updateMeasureTooltip","circleToPoint","olGeoJSON","writeValue","lastIndex","lastLength","olLastMidpoint","innerHtml","isStyleWithRadius","IgoGeometryFormFieldModule","IgoGeometryModule","TimeFilterButtonComponent","timeFilterCollapse","handleDateChange","year_r21","handleYearChange","startYear_r27","endYear_r28","ctx_r34","toggleFilterState","playYear","resetFilter","ctx_r2","playFilter","ctx_r3","TimeFilterFormComponent","listYears","startListYears","endListYears","playIcon","resetIcon","YEAR","valueArray","startDate","endDate","isNaN","DATE","SLIDER","getStepDefinition","timeInterval","getTimezoneOffset","startYear","initStartYear","endYear","initEndYear","isRange","checkFilterValue","yearChange","storeCurrentFilterValue","timeFromWms","newStartListYears","newEndListYears","setupDateOutput","applyTypeChange","thumbLabel","findThumbLabel","mySlider","childNodes","textContent","stopFilter","newMinDateNumber","maxDateNumber","that","setSliderThumbLabel","handleSliderTooltip","getRoundedDate","toDateString","toTimeString","setSeconds","setHours","setMinutes","getDay","selectedHour","getHours","selectedMinute","getMinutes","atMinute","coeff","asMilliseconds","MatSlider","toggleFiltersCollapsed","toggleLegendOnClick","TimeFilterItemComponent","timeFilterService","filtersCollapsed","filterByYear","filterByDate","TimeFilterListComponent","WktService","wkt","wktProj","featureProj","olWKT","epsgTO","extentProj","roundCoordinateArray","wktLine","wktMultiPoints","coordinateArray","lproj","olUnits","roundArray","snrc","snrc250kIndex","snrc50kIndex","snrc1m","snrc250k","snrc50k","ar1m","part1m","part250k","part50k","partEW","partSN","index250kEW","index250kSN","index50kEW","index50kSN","increment250kEW","increment250kSN","increment50kEW","increment50kSN","unitPerTypeEW","unitPerTypeSN","ul","lr","ur","ll","clearSelectedField","updateFieldsList","changeField","changeSpatialSelector","clearProperty","updateValuesList","changeProperty","changeSNRC","changeMapExtentGeometry","OgcFilterFormComponent","wktService","ogcFilterOperator","defaultStepMillisecond","_snrc","allOgcFilterOperators","ogcFilterOperators$","igoSpatialSelectors","currentFilter","computeAllowedOperators","fields$","sFields","excludeFromOgcFilters","sfs","selectedField$","currentFilterIsSpatial","filteredFields$","_filterFields","pos","filteredValues$","_filterValues","detectedProperty","detectProperty","refreshFilters","currentFilterIsSpatial$","refreshFilter","changeSNRCGeometry","snrcToWkt","interfaceOgcFilter","extentToWkt","isSpatial","OgcFilterableFormComponent","addFilterToSequence","changeOgcFilterType","OgcFilterableItemComponent","ogcFilterService","hasActiveSpatialFilter","filtersAreEditable","hasSelector","setOgcWMSFiltersOptions","setOgcWFSFiltersOptions","lastRunOgcFilter","lastLevel","firstFieldName","includedFields","datasourceOptions","firstOperatorName","defaultLogicalParent","force","activeFilters","af","rebuiltIgoOgcFilterObjectFromSequence","rebuildFilter","ogcDataSource","ogcLayer","isAdvancedOgcFilters","changeOgcFiltersAdvancedOgcFilters","OgcFilterableListComponent","OgcFilterButtonComponent","ogcFilterCollapse","currentPushButtonGroup","gr","cntPushButtons","button","currentCheckboxGroup","cntCheckboxes","currentRadioButtonsGroup","cntRadioButtons","radio","currentSelectGroup","cntSelect","currentAutocompleteGroup","cntAutocomplete","filterActiveValue","OGCFilterTimeService","months","weeks","days","hours","week","newDate","stepMillisecond","toDate","subtract","onSelectionChange","bundle_r14","bundle_r26","emptyRadioButtons","bundle_r46","emptySelect","toggleAllSelection","selectOptionClick","bundle_r69","emptyAutocomplete","autocompleteOptionClick","bundle_r99","ctx_r113","OgcFilterSelectionComponent","domService","checkboxesIndex","radioButtonsIndex","baseIndex","selectAllSelected","filteredOgcAutocomplete","_currentFilter","ogcSelector","_g","_h","_j","_k","_l","_m","_o","_p","_q","_r","_s","_u","_v","_w","_x","_y","_z","_0","ue","pe","_1","_2","_3","ae","_4","_5","_6","pushButtonsGroup","checkboxesGroup","radioButtonsGroup","selectGroup","autocompleteGroup","selectEnabled$","applyFiltersTimeout","applyFilters","selectEnableds$","autocompleteEnabled$","selectMulti","currentPushButtonsGroup","currentCheckboxesGroup","getSelectEnabled","getSelectDomValues","getAutocompleteEnabled","getAutocompleteDomValues","onPushButtonsChangeGroup","onCheckboxesChangeGroup","onRadioButtonsChangeGroup","onSelectChangeGroup","onAutocompleteChangeGroup","compSelect","selectEnableds","selectEnabled","autocompleteEnabled","toolTip","domSelectors","domValues","domSelector","filterDOM","domOptions","getDom","newBundle","sel","getSelectGroups","comp","getAutocompleteGroups","pushButton","vertical","getPushButtonsGroups","getCheckboxesGroups","getRadioButtonsGroups","currentOgcSelection","markAsUntouched","deselect","newStatus","isUserInput","currentGroup","isTemporalOperator","selectorsLength","decls","SpatialFilterTypeComponent","UntypedFormControl","spatialType","Polygon","_store","selectedTypeIndex","activeDrawType","eventQueryType","selectedQueryType","zoneChange","zoneWithBufferChange","bufferChange","SpatialFilterListComponent","spatialFilterService","_queryType","queryType","_zone","zoneWithBuffer","bufferFormControl","formValueChanges$$","bufferValueChanges$$","measureUnit","loadBufferGeometry","selectedZone","featureGeom","loadItemById","measureUnitChange","onDrawControlChange","onfreehandControlChange","onMeasureUnitChange","onItemTypeChange","ctx_r37","clearSearch","clearDrawZone","toggleVisibleList","entityChange","SpatialFilterItemComponent","Thematics","NestedTreeControl","node","childrens","thematics","MatTreeNestedDataSource","selectedThematics","geometryTypeField","drawGuideField","drawGuidePlaceholder","listIsVisible","geometryTypes","drawGuide$","drawStyle$","radiusFormControl","PointStyle","PolyStyle","overlayStyle$","_thematicLength","loadThematicsList","limits","child","value$","value$$","drawZone","drawZoneEvent","radiusChanges$$","bufferChanges$$","bufferEvent","selectedRecordStrategy","selectionStrategy","detach","selectedItemType","itemTypeChange","isPolygon","isPoint","treeControl","isExpanded","collapse","numSelected","numNodes","bool","selectedThematicsName","hasChild","thematicChange","nodeSelected","freehandControl","isPredefined","radiusEvent","toggleSearch","thematicLength","openWorkspace","createTableTemplate","clearButtonEvent","clearSearchEvent","formValue","typeColumn","nameColumn","modeChange","changePropertyByPass","hour_r27","minute_r31","hour_r39","minute_r43","monthSelected","OgcFilterTimeComponent","ogcFilterTimeService","_defaultMin","_defaultMax","_defaultDisplayFormat","_defaultSliderModeEnabled","sliderMode","calendarTypeYear","_beginValue","_endValue","sliderInterval","displayFormat","beginValue","parseFilter","handleMin","endValue","handleMax","onlyYearBegin","getUTCFullYear","onlyYearEnd","isCalendarYearMode","setFilterStateDisable","updateHoursMinutesArray","updateValues","intervalInt","_now","endOf","getDateFromStringWithoutTime","dateStringFromYearNotime","valueTmp","getDateTime","calendarType","restrictedToStep","changeTemporalProperty","addStep","stepMilliseconds","toISOString","datePicker","yearSelected","stepIsYearDuration","stepIsMonthDuration","dateValue","monthDiff","dateValuePlus1","asYears","asMonths","stepIsWeekDuration","weekDiff","asWeeks","stepIsDayDuration","dayDiff","_mod","asDays","stepIsHourDuration","asHours","stepIsMinuteDuration","valuetmp2","valuetmp","beginHourFormControl","beginMinuteFormControl","endHourFormControl","endMinuteFormControl","checkEndValue","beginHours","handleHourIncrement","endHours","beginMinutes","handleMinuteIncrement","endMinutes","beginTmp","endTmp","fullBeginHoursArray","fullEndHoursArray","fullBeginMinutesArray","fullEndMinutesArray","restrictToStep","filterStateDisable","stringDate","dateItems","minDefaultDate","maxDefaultDate","minDefaultISOString","maxDefaultISOString","filterOriginConfig","todayDateStringNoTime","toLocaleDateString","OgcFilterTimeSliderComponent","sliderValue","calculatedStep","_defaultSliderInterval","sliderDisplayWith","dateToNumber","calculateStep","handleSliderInput","dateTmp","beginMillisecond","toAdd","slider","_increment","_emitInputEvent","matSliderChange","dateBeginTmp","dateEndTmp","startOf","maxMillisecond","IgoFilterModule","MAT_DATE_LOCALE","MatTabsModule","MatRadioModule","MatTreeModule","MatOptionModule","MatNativeDateModule","MatDatetimepickerModule","MatNativeDatetimeModule","ExportError","ExportInvalidFileError","setPrototypeOf","ExportNothingToExportError","ve","strEnum","EncodingFormat","ExportService","aggregateInComment","ogreUrl","gpxAggregateInComment","encoding","exportOlFeatures","generateFeature","exportAsync","ExportFormat","GPX","generateAggregatedFeature","comment","nothingToExport","ogreFormats","noOgreFallbacks","exportToFile","exportWithOgre","fileName","uri","setAttribute","downloadFromUri","downloadContent","writeFeatures","encodingType","featuresText","UTF8","acceptCharset","enctype","LATIN1","featuresJson","encodedProperties","encode","geojsonField","outputNameField","outputName","ogreFormat","outputFormatField","submit","GML","KML","Shapefile","CSVcomma","CSVsemicolon","file","styleListService","computeLayerTitleFromFile","imposedSourceOptions","imposedLayerOptions","distance","getStyleList","addLayerAndFeaturesStyledToMap","createImportedLayerRandomStyle","addLayerAndFeaturesToMap","messageTitle","handleNothingToImportError","sizeMb","ImportError","ImportInvalidFileError","ImportUnreadableFileError","ImportNothingToImportError","ImportSizeError","ImportSRSError","ImportOgreServerError","ImportService","configFileSizeMb","clientSideFileSizeMax","importAsync","extension","getFileExtension","allowedMimeTypes","allowedZipMimeTypes","allowedExtensions","importFile","importFileWithOgre","importer","getFileImporter","parseFeaturesFromFile","readAsText","FormData","append","parseFeaturesFromGeoJSON","errMsg","msg","GeoJSON","writeFeatureObject","StyleListService","styleList","baseStyleList","styleListResponse","projection_r6","inLayersIdToExportSelectionOnly","layer_r29","handleExportFormSubmit","ImportExportComponent","importService","exportService","forceNaming","controlFormat","popupChecked","selectFirstProj","_projectionsLimitations","selectedMode","loadConfig","computeProjections","importHtmlClarifications","exportHtmlClarifications","importForm","inputProj","exportableLayers$","fileSizeMb","exportOptions$$","exportOptions$","exportOptions","computeFormats","formLayer$$","handlePopup","handlePreviousLayerSpecs","selectedLayers","formats$","loading$","previousSpecs","previousLayerSpecs$","formats$$","formats","encodings$$","encodings$","encodings","exportableLayers$$","projections$","translateKey","projectionsConstraints","projectionsLimitations","projFromConfig","nad83","wgs84","webMercator","utm","mtm","minZone","maxZone","computeProjectionsConstraints","configProjection","wksFromLayerId","wksFromLayer","getWorkspaceByLayerId","firstBy","layersWithSelection","exportOptionsChange","specs","files","espgCodeRegex","import","onFileImportSuccess","onFileImportError","preCheck","p1","p2","closed","onPopupBlockedError","popupAllowed","geomTypesCSV","featuresCSV","filename","layerIndex","combineLayers","dSOptions","wks","featureInMapExtent","geomTypes","featureGeomType","currentGeomType","geomType","circle","circular","previousFeature","currentFeature","titleEmptyRows","createTitleEmptyRows","export","onFileExportError","onFileExportSuccess","titleRow","headerRow","emptyRow","previousFeatureKeys","firstKeyPrevious","currentFeatureKeys","firstKeyCurrent","previousKey","firstKeyAll","sameKeys","unset","handleFileImportSuccess","handleInvalidFileImportError","handleSizeFileImportError","handleUnreadbleFileImportError","handleSRSImportError","handleOgreServerImportError","handleFileImportError","extraMessage","handleNothingToExportError","handleFileExportError","loadEncodings","appliedformats","formatsType","onlyUrl","onlyVector","vectorAndUrl","customList","validateListFormat","allowedFormats","validatedListFormat","commonFormats","layersWithCustomFormats","previousCustomListFormats","finalFormats","selectMode","handleFileExportSuccess","STYLELIST_OPTIONS","IgoStyleListModule","provideStyleListOptions","styleListFactory","IgoImportExportModule","IgoMapModule","MeasurerItemComponent","_auto","toggleAutoUnit","measure$$","computeBestMeasureUnit","converted","possibleUnits","computeBestAreaUnit","computeBestLengthUnit","IgoMeasurerModule","IgoMeasureModule","er","OverlayAction","OverlayService","features$","OverlayDirective","overlayService","olFormatGeoJSON","features$$","handleFeatures","IgoOverlayModule","PrintService","paperFormat","doc","jspdf","dimensions","internal","margins","titleSizeResults","getTitleSize","addTitle","subtitle","subtitleSizeResult","titleH","getSubTitleSize","addSubTitle","showProjection","showScale","addProjScale","addComment","addMap","addScale","handleMeasureLayer","legendPosition","addLegendSamePage","addLegend","saveDoc","mapOverlayMeasuresHTML","getOverlayContainer","html2canvas","backgroundColor","canvasOverlayHTMLMeasures","addCanvas","legends","legendUrls","getLayersLegends","images$","getDataImage","rxMap","dataImage","htmlImg","dataImages","doZipFile","getLayersLegendHtml","useCORS","canvas","generateCanvaFileToZip","saveCanvasImageAsFile","pageWidth","pageHeight","titleSize","setFont","getTextWidth","titleMarginLeft","titleWidth","getStringUnitWidth","scaleFactor","titleTailleMinimale","titleFontSize","subtitleSize","subtitleWidth","titleMarginTop","subtitleFontSize","subtitleMarginLeft","subtitleMarginTop","heightPixels","textProjScale","formatScale","imageSize","addPage","imgData","toDataURL","addImage","pourcentageReduction","marginsLegend","mapSize","mapOverlayHTML","getOverlayContainerStopEvent","OverlayHTMLButtons","OverlayHTMLButtonsarr","allowTaint","canvasOverlayHTML","nbFileToProcess","ms","getImageSizeToFitPdf","rect","widthPixels","canvases","getViewport","mapStatus$$","mapStatus","renderMap","oldCanvas","newCanvas","newContext","getContext","positionHCanvas","positionWProjScale","commentWidth","measureText","positionHProjScale","commentNbLine","ceil","positionHComment","fillStyle","fillRect","fillText","projText","scaleText","mapScale","positionLastBlank","CommentLengthToCut","commentCurrentLine","positionFirstCutChar","drawImage","fileNameWithExt","tfwFileNameWithExt","tiwContent","getWorldFileInformation","addFileToZip","saveAs","saveFileProcessing","renderSync","updateSize","save","returnPromise","getHeight","canHeight","canWidth","heightRatio","widthRatio","maxRatio","currentResolution","nameWithExt","blobFormat","msSaveBlob","msToBlob","toBlob","zipFile","JSZip","getZipFile","generateAsync","PrintOutputFormat","PrintPaperFormat","PrintOrientation","Bu","PrintSaveImageFormat","PrintLegendPosition","PrintFormComponent","outputFormats","paperFormats","orientations","PrintResolution","imageFormats","legendPositions","isPrintService","imageFormat","imageFormatField","Jpeg","onlySelf","Pdf","paperFormatField","Letter","orientationField","landscape","resolutionField","legendPositionField","none","titleField","subtitleField","commentField","showProjectionField","showScaleField","showLegendField","doZipFileField","PrintComponent","printService","_outputFormat","_paperFormat","_orientation","_imageFormat","_legendPosition","_resolution","print","defineNbFileToProcess","nbRequests","downloadMapImage","getLayersLegendImage","IgoPrintModule","IgoQueryModule","querySearchSourceFactory","DirectionsSource","DirectionsSourceService","DirectionsFormat","ea","ta","SourceDirectionsType","Zo","ProposalType","Bn","DirectionType","Un","DirectionRelativePositionType","stopsStore","totalLength","relativePosition","Intermediate","Start","End","positions","stops","stop","maxPosition","insertPosition","lastPosition","stopToUpdate","computeRelativePosition","updateStoreSorting","vertexStyle","stopStyle","routeStyle","Stop","routesFeatureStore","geometry4326","olGeom","geojsonGeom","previousRoute","previousRouteRevision","routeFeatureStore","modifier","stepPosition","exit","directive","lastStep","cssClass","translatedDirection","translateBearing","translatedModifier","translateModifier","aggregatedDirection","coma","cntSuffix","instruction","bearing","clearStop","removeStop","onStopEnter","onStopLeave","stop_r1","setStopText","chooseProposal","DirectionsInputsComponent","invalidKeys","onMapClickEventKeys","stopIsDragged","coordRoundedDecimals","unlistenMapSingleClick","stopWithHover","geomCoord","pointOnFeature","validateTerm","keyIsValid","extra","stopsToComputePosition","computeStopsPosition","removeStopFromStore","moveStops","previousIndex","currentIndex","fromIndex","toIndex","moveItemInArray","stopInputHasFocus","listenMapSingleClick","stopsFeatureStore","roundedCoord","roundCoordTo","olProj","olObservable","DirectionsService","directionsSourceService","directionsOptions","routeSource","reverseSearch","str1","str2","caseSensitive","termFrom","termTo","fromToDiff","findDiff","toFromDiff","totalDiff","delta","SearchSourceService","getSources","SearchService","searchSourceService","termIsValid","stringToLonLat","getEnabledOnly","getEnabledSources","searchType","sourceCanSearch","asPointerSummary","reverseSourceFonction","sourceCanReverseSearchAsSummary","sourceCanReverseSearch","reverseSearchSources","resetStops","zoomRoute","copyDirectionsToClipboard","copyLinkToClipboard","DirectionsButtonsComponent","clearStops","addStopToStore","zoomToActiveRoute$","directionsBody","directionsToText","indent","activeRouteDirective","wayPointList","activeRoute","formatDistance","formatDuration","wayPointsCnt","stopText","localCnt","formatStep","formatInstruction","maneuver","bearing_after","contextUri","routingOptions","directionsKey","stopsCoordinates","directionsUrl","pathname","showSegment","onStepsListBlur","DirectionsResultsComponent","activeFeatureWithDirection","directions","activeDirection","stepFeatureStore","showRouteSegmentGeometry","vertexId","geometryMapProjection","routeSegmentCoordinates","lastPoint","previousVertex","previousVertexRevision","stepFeature","Vertex","DirectionsComponent","directionsService","searchService","routesQueries$$","focusOnStop","isTranslating","previousStops","searchs$$","initEntityStores","loadingStrategy","directionsStyle","initStopsFeatureStore","initRoutesFeatureStore","initStepFeatureStore","initOlInteraction","storeEmpty$$","storeChange$$","zoomRoute$$","freezeStores","selectStopInteraction","translateStop","selectedRoute","monitorEmptyEntityStore","monitorEntityStoreChange","monitorActiveRouteZoom","routeExtent","executeStopTranslation","olCondition","selectCoordinates","addedStop","getLength","translatedStopId","translationCoordinates","translatedStop","storeInitialized$","handleStopDiff","handleStopsFeature","getRoutes","simplifiedStops","stopIdToProcess","changedStop","researches","isCoord","cancelSearch","requests$","searchProposals","sp","Coord","Text","storedSource","addStopOverlay","stopFeature","isOverview","stopsWithCoordinates","roundedCoordinates","overviewDirectionsOptions","overview","alternatives","continue_straight","routeResponse","addDirectionToRoutesFeatureStore","stopColor","previousStop","stopFeatureStore","stopOpacity","addStopToStopsFeatureStore","IgoDirectionsModule","directionsSourceServiceFactory","DragDropModule","IChercheSearchResultFormatter","IgoHttpParameterCodec","IChercheSearchSource","formatter","hashtagsLieuxToKeep","title$","getAllowedTypes","ecmax","computeRequestParams","extractResults","typeSetting","typesMatched","computeOptionsParam","q","computeTerm","xMin","yMin","xMax","yMax","encoder","formatResult","dataToResult","computeProperties","dataType","titleHtml","highlight","title2","title3","score","computeTermSimilarity","nextPage","propertiesBlacklist","googleMaps","googleMapsNom","googleLinksProperties","GoogleMaps","getGoogleMapsCoordLink","getGoogleMapsNameLink","municipalite","GoogleStreetView","getGoogleStreetViewLink","routing","keep","h","IChercheReverseSearchSource","computeExtent","subtitleHtml","getSubtitle","pointerSummaryTitle","CoordinatesSearchResultFormatter","CoordinatesReverseSearchSource","dataDMS","lonLatDD","lonLatDMS","int","convertDDToDMS","rawCoord3857","convertedLonLat","igo2CoordFormat","utmZoneFromLonLat","utmName","rawCoordUtm","long","mtmZoneFromLonLat","mtmName","rawCoordMtm","rawCoord","numericEpsgCode","lonLatConversion","roundedCoordString","roundedCoordStringDMS","circleGeometry","polygonGeometry","writer","writeGeometry","OpenStreetMap","getOpenStreetMapLink","_projectionService","ILayerSearchResultFormatter","allowedKey","dataR","ILayerSearchSource","computeSearchRequestParams","computeLayerOptions","groupTitle","extractQueryParamsFromSourceUrl","formatOpt","urls","urlOpt","SEARCH_TYPES","SearchSelectorComponent","searchTypes","searchType$","setSearchType","searchType$$","onSetSearchType","enableSourcesByType","searchTypeChange","IgoSearchSelectorModule","checkUncheckAllSources","checkUncheckAll","setting_r13","changePointerReverseSearch","changeSearchResultsGeometry","SearchSettingsComponent","hasPointerReverseSearchSource","searchSourcesAllEnabled","now","displayBlock","pointerSummaryEnabled","searchResultsGeometryEnabled","pointerSummaryStatus","hasReverseSearchSourcesForPointerSummary","textSearchSources","computeSourcesCheckAllBehavior","settingValue","searchSourceChange","allEnabled","enabledSourcesCnt","disabledSourcesCnt","computeSettingCheckAllBehavior","getSearchSources","storage","searchResultsGeometryStatus","IgoSearchSettingsModule","onClearButtonClick","onSearchTypeChange","SearchBarComponent","appearance","termSplitter","minLength","searchSelector","searchSettings","setTerm","stream$$","stream$","onSetTerm","handlePlaceholder","clearFeature","doSearch","searchSettingsChange","slug","input","searchTermChange","ss","placeholder$","rawTerm","terms","researches$$","research","onResearchCompleted","newResults","onKeyup","IgoSearchBarModule","onZoomHandler","SearchResultsItemComponent","withZoomButton","titleHtmlProperty","getEntityTitleHtml","group_r2","resultFocus","resultUnfocus","displayMoreResults","SearchResultMode","ir","SearchResultsComponent","searchResultMode","pageIterator","Grouped","_term","_results$","liftResults","settingsChange$$","settingsChange$","resultSelect","groupResults","sortByOrder","r1","r2","displayOrder","grouped","sourceResults","stategy","moreResults","onMouseEvent","SearchResultAddButtonComponent","layersSubcriptions","IgoSearchResultsModule","SearchPointerSummaryDirective","reverseSearch$$","searchPointerSummaryFeatureId","igoSearchPointerSummaryDelay","igoSearchPointerSummaryEnabled","pointerPositionSummaryMarker","unsubscribeReverseSearch","pointerSearchStore","entitiesToPointerOverlay","closestResultByType","computeSummaryClosestFeature","summarizedClosestType","processedSummarizedClosestType","typeIndex","addPointerOverlay","onSearchCoordinate","_results","onSearch","pointerSummary","IgoSearchModule","searchSourceServiceFactory","defaultIChercheSearchResultFormatterFactory","defaultCoordinatesSearchResultFormatterFactory","ilayerSearchResultFormatterFactory","OgcFilterComponent","OgcFilterWidget","IgoOgcFilterModule","WfsWorkspace","queryOptions","tabQuery","mapQueryOnOpenTab","WfsWorkspaceService","srcId","workspaceId","createFeatureStore","inMapExtentStrategy","inMapResolutionStrategy","confQueryOverlayStyle","getCommonVectorSelectedStyle","zoomAuto","createFilterInMapExtentOrResolutionStrategy","relations","relationsColumn","relation","ws$","class_icon","columnsFromFeatures","col","WmsWorkspaceService","wmsLinkId","wfsLinkId","linkProperties","hasOgcFilters","clonedLinks","wksLayerOption","workspaceLayer","xe","ConfirmationPopupComponent","EditionWorkspace","editionWorkspaceService","edit","deleteUrl","columnName","primary","deleteFeature","editionOpt","getDomainValues","original_properties","original_geometry","idkey","editFeaturefilterClauseFunc","adding$","newFeaturefilterClauseFunc","addWithDraw","onGeometryTypeChange","featureOl","createModifyInteraction","olCollection","Collection","modifyStyle","EditionWorkspaceService","wksConfig","rendererType","editMode","modifyButton","editFeature","deleteButton","saveFeature","cancelEdit","cellClass","validateFeature","sanitizeParameter","addUrl","addHeaders","modifyProtocol","modifyUrl","protocole","modifyHeaders","modifyFeature","hasGeometry","refreshMap","rowsInMapExtentCheckCondition$","genericErrorMessage","relationLayers","relationLayers$","fromSave","wfsOlLayer","wmsOlLayer","_t","FeatureWorkspace","FeatureWorkspaceService","WorkspaceSelectorDirective","wfsWorkspaceService","wmsWorkspaceService","featureWorkspaceService","onLayersChange","changeWorkspace","adding","rowsInMapExtentCheckCondition","editableLayers","layerIsEditable","editableLayersIds","workspacesToAdd","getOrCreateWorkspace","workspacesToRemove","workspaceStore","createWorkspace","wmsWks","IgoWorkspaceUpdatorModule","IgoConfirmationPopupModule","IgoGeoWorkspaceModule","ogcFilterWidgetFactory","StopsStore","StopsFeatureStore","RoutesFeatureStore","StepFeatureStore","OsrmDirectionsSource","_name","directionsParams","getRouteParams","extractRoutesData","formatRoute","waypoints","geometries","roadNetworkRoute","stepsUI","legs","sourceType","weight_name","CadastreSearchSource","endsWith","numero","lot","computeGeometry","NoLot","NominatimSearchSource","place_id","display_name","osm_type","boundingbox","computeTermTags","tag","computeTermSettings","StoredQueriesSearchSource","storedQueriesOptions","defaultResultTitle","storedquery_id","splitPrefix","outputformat","srsname","resultTitle","multipleFieldsQuery","storedqueriesParams","resultArray","extractWFSData","idxEnd","resultTotLenght","patternGml3","geojson","wfsfeatures","splittedTerm","remainingTerm","splitterRegex","wfsversion","StoredQueriesReverseSearchSource","longField","latField","longLatParams","doc_type","AppSimpleMapRoutingModule","AppSimpleMapComponent","onPointerMove","pointerCoord","AppSimpleMapModule","AppLayerRoutingModule","AppLayerComponent","AppLayerModule","AppLegendRoutingModule","AppLegendComponent","AppLegendModule","AppOverlayRoutingModule","AppOverlayComponent","ngAfterViewInit","setFeatures","AppOverlayModule","AppGeometryRoutingModule","AppGeometryComponent","AppGeometryModule","AppFeatureRoutingModule","AppFeatureComponent","AppFeatureModule","AppHoverRoutingModule","AppHoverComponent","AppHoverModule","AppMeasureRoutingModule","AppMeasureComponent","AppMeasureModule","AppDrawRoutingModule","AppDrawComponent","AppDrawModule","AppQueryRoutingModule","AppQueryComponent","feature1","olLineString","feature2","feature3","handleQueryResults","feature$","AppQueryModule","AppCatalogRoutingModule","AppCatalogComponent","loadCatalogs","onCatalogSelectChange","loadCatalogItems","catalogStore","catalogItemStore","AppCatalogModule","qt","TypePermission","ContextService","contexts$","ours","importedContext","mapViewFromRoute","basePath","contextListFile","defaultContextUri","readParamsFromRoute","hasAuthService","logged","handleContextsChange","loadContexts","_defaultContextUri","permissions","defaultContextId$","getContextByUri","defaultContextId","imported","contexts","contextCreated","permission","write","contextCloned","contextId","toolId","profil","typePermission","permissionId","urlBase","resBase","resMerge","l2","t2","err2","getLocalContexts","loadFct","direct","getDefault","_context","addContextToList","setContext","loadContext","contextParam","context$","handleContextMessage","currentContext","keepCurrentView","setEditedContext","editedContext$","global","extraFeatures","currentLayers","layerFound","contextLayer","olVectorSource","Cluster","clusterSource","catalogLayer","removeAllAreNotError","contextToLoad","getDetails","getLocalContext","mapLayers","permissionError","titleContext","keepCurrentContext","editedContext","findContext","toolsChanged$","loadDefaultContext","editedFound","public","found","IgoContextImportExportModule","MapContextDirective","contextService","context$$","handleContextChange","viewContext","controlsContext","scaleLineOption","minWidth","LayerContextDirective","contextLayers","removeLayersOnContextChange","queryParams$$","layersAndIndex$","computeLayerVisibilityFromUrl","addImportedFeaturesStyledToMap","addImportedFeaturesToMap","currentLayerid","contextParams","visibleOnLayersParams","visibleOffLayersParams","visiblelayers","invisiblelayers","ContextListControlsEnum","BookmarkDialogComponent","favoriteClick","managePermissions","ContextItemComponent","showFavorite","favorite","clearFilter","manageTools","ContextListComponent","contextsInitial","shared","showHidden","thresholdToFilter","_contexts","_selectedContext","_defaultContextId","filterContextsList","createContext","sortedAlpha","sortContextsList","updateContexts","publics","showContextFilter","contextsList","getPermission","indeterminate","childs","parentPermission","childrenPermission","filterPermissionsChanged","ContextListBindingDirective","confirmDialogService","loadEditedContext","contextFromMap","getContextFromMap","msgSuccess","setDefault","titleD","showContext","hideContext","contexts$$","defaultContextId$$","storedContextUri","selectedContext$$","selectedContext","authenticate","getProfilByUser","profils","users","profilsAcc","cur","onFavorite","onManageTools","onManagePermissions","showHiddenContexts","onShowContext","onHideContext","PoiService","IgoContextMapButtonModule","IgoContextManagerModule","si","ImportExportType","Mn","ImportExportMode","ImportExportState","importExportType$","selectedMode$","ToolState","importExportState","toolToActivate","setsExportOptions","setMode","openSidenav$","StorageState","igoStorageService","FeatureActionsService","storageState","toolState","storageChange$$","selectOnlyCheckCondition$","buildActions","zoomAuto$","storageChange","handleZoomAuto","mapExtentStrategyActiveToolTip","noElementSelected","filterStrategy","filterSelectionStrategy","toolToActivateFromOptions","maximize$","WfsActionsService","ogcFilterWidget","activateWidget","EditionActionsService","WorkspaceState","featureActionsService","wfsActionsService","editionActionsService","workspacePanelExpanded","actionMaximize$$","initWorkspaces","workspace$","manyBy","workspaces","loadActions","setWorkspaceIsMaximized","maximized","activeWorkspace$$","activeWorkspaceWidget$$","activeWorkspaceWidget$","rowsInMapExtentCheckCondition$$","rowsInMapExtent","selectOnlyCheckCondition$$","selectOnly","workspaceMaximize$","wksFromId","wksFromTitle","teardownWorkspaces","SearchState","searchOverlayStyle","searchOverlayStyleSelection","searchOverlayStyleFocus","searchResultsGeometryEnabled$","createCustomFilterTermStrategy","searchDisabled$","searchTerm","searchTerm$","searchSettingsChange$","selectedResult$","IgoAppSearchBarModule","IgoAppSearchResultsToolModule","IgoAppSearchModule","AppSearchRoutingModule","AppSearchComponent","searchState","osmLayer","searchStore","onPointerSummaryStatusChange","onSearchTermChange","termWithoutHashtag","onSearchSettingsChange","onResultFocus","tryAddFeatureToMap","searchCoordinate","openGoogleMaps","openGoogleStreetView","removeFeatureFromMap","onContextMenuOpen","mapPosition","getCoordinateFromPixel","contextmenuPoint","mapBrowser","getBoundingClientRect","scrollY","scrollX","ElementRef","AppSearchModule","CoordinatesReverseSearchSourceFactory","cadastreSearchSourceFactory","ichercheSearchSourceFactory","ilayerSearchSourceFactory","nominatimSearchSourceFactory","ichercheReverseSearchSourceFactory","storedqueriesSearchSourceFactory","storedqueriesReverseSearchSourceFactory","AppPrintRoutingModule","AppPrintComponent","AppPrintModule","AppImportExportRoutingModule","AppImportExportComponent","AppImportExport","AppDirectionsRoutingModule","AppDirectionsComponent","AppDirectionsModule","osrmDirectionsSourcesFactory","AppTimeFilterRoutingModule","AppTimeFilterComponent","AppTimeFilterModule","AppOgcFilterRoutingModule","AppOgcFilterComponent","Circle","Fill","Stroke","AppOgcFilterModule","AppSpatialFilterRoutingModule","AppSpatialFilterComponent","getOutputType","getOutputQueryType","loadFilterList","spatialListStore","getOutputToggleSearch","loadThematics","getOutputClearSearch","clearMap","activeLayers","iterator","zeroResults","tryAddFeaturesToMap","loadFilterItem","featuresPoint","featuresLinePoly","idPoint","idLinePoly","tryAddPointToMap","tryAddLayerToMap","onZoneChange","zoomToFeatureExtent","_internal","featuresOl","createSvgIcon","pushLayer","xmlSerializer","AppSpatialFilterModule","AppWorkspaceRoutingModule","AppWorkspaceComponent","workspaceState","selectedWorkspace$","workspacePaginator","AppWorkspaceModule","AppContextRoutingModule","AppContextComponent","AppContextModule","HttpClientJsonpModule","redirectTo","pathMatch","AppRoutingModule","useHash","AppComponent","changeDetectorRef","mobileQuery","matchMedia","_mobileQueryListener","addEventListener","themeClass","detectOldBrowser","removeEventListener","oldBrowser","defaultTooltipOptions","showDelay","hideDelay","touchendHideDelay","disableTooltipInteractivity","AppModule","bootstrap","appInitializerFactory","MAT_TOOLTIP_DEFAULT_OPTIONS","MatSidenavModule","MatToolbarModule","HammerModule","getTranslation","enableProdMode","__NgCli_bootstrap_1","bootstrapModule","O","ao"],"sourceRoot":"webpack:///","sources":["./packages/utils/src/lib/base64.ts","./packages/utils/src/lib/user-agent.ts","./packages/utils/src/lib/clipboard.ts","./packages/utils/src/lib/string-utils.ts","./packages/utils/src/lib/change.interface.ts","./packages/utils/src/lib/change.ts","./packages/utils/src/lib/object-utils.ts","./packages/utils/src/lib/number-utils.ts","./packages/utils/src/lib/strenum.ts","./packages/utils/src/lib/uuid.ts","./packages/utils/src/lib/watcher.ts","./packages/core/src/lib/activity/activity.service.ts","./packages/core/src/lib/activity/activity.interceptor.ts","./packages/core/src/lib/activity/activity.module.ts","./packages/core/src/lib/config/version.ts","./packages/core/src/lib/config/config.service.ts","./packages/core/src/lib/config/config.provider.ts","./packages/core/src/lib/config/config.module.ts","./packages/core/src/lib/language/shared/language.loader.ts","./packages/core/src/lib/language/shared/language.provider.ts","./packages/core/src/lib/language/shared/missing-translation.guard.ts","./packages/core/src/lib/language/language.module.ts","./packages/core/src/lib/message/message.module.ts","./packages/core/src/lib/message/shared/message.enum.ts","./packages/core/src/lib/language/shared/language.service.ts","./packages/core/src/lib/message/shared/message.service.ts","./packages/core/src/lib/request/error.interceptor.ts","./packages/core/src/lib/request/error.module.ts","./packages/core/src/lib/core.module.ts","./packages/core/src/lib/route/route.service.ts","./packages/core/src/lib/media/media.enum.ts","./packages/core/src/lib/media/media.service.ts","./packages/core/src/lib/storage/storage.interface.ts","./packages/core/src/lib/storage/storage.service.ts","./packages/core/src/lib/compression/compression.service.ts","./packages/core/src/lib/network/network.service.ts","./packages/common/src/lib/entity/shared/entity.enums.ts","./packages/common/src/lib/entity/shared/entity.utils.ts","./packages/common/src/lib/entity/shared/state.ts","./packages/common/src/lib/entity/shared/view.ts","./packages/common/src/lib/entity/shared/store.ts","./packages/common/src/lib/entity/shared/watcher.ts","./packages/common/src/lib/entity/shared/strategies/strategy.ts","./packages/common/src/lib/entity/shared/strategies/filter-custom-function.ts","./packages/common/src/lib/entity/shared/strategies/filter-selection.ts","./packages/common/src/lib/entity/entity-selector/entity-selector.component.html","./packages/common/src/lib/entity/entity-selector/entity-selector.component.ts","./packages/common/src/lib/stop-propagation/stop-propagation.directive.ts","./packages/common/src/lib/entity/entity-table-paginator/entity-table-paginator.component.ts","./packages/common/src/lib/entity/entity-table-paginator/entity-table-paginator.component.html","./packages/common/src/lib/image/image-error.directive.ts","./packages/common/src/lib/entity/entity-table/entity-table-row.directive.ts","./packages/common/src/lib/custom-html/custom-html.pipe.ts","./packages/common/src/lib/image/secure-image.pipe.ts","./packages/common/src/lib/entity/entity-table/entity-table.component.html","./packages/common/src/lib/entity/entity-table/entity-table.component.ts","./packages/common/src/lib/action/shared/action.enums.ts","./packages/common/src/lib/action/actionbar/actionbar-item.component.html","./packages/common/src/lib/action/actionbar/actionbar-item.component.ts","./packages/common/src/lib/action/actionbar/actionbar.component.html","./packages/common/src/lib/action/actionbar/actionbar.component.ts","./packages/common/src/lib/action/actionbar/actionbar.module.ts","./packages/common/src/lib/action/action.module.ts","./packages/common/src/lib/badge-icon/badge-icon.directive.ts","./packages/common/src/lib/badge-icon/badge-icon.module.ts","./packages/common/src/lib/clickout/clickout.directive.ts","./packages/common/src/lib/clickout/clickout.module.ts","./packages/common/src/lib/collapsible/collapse.directive.ts","./packages/common/src/lib/collapsible/collapsible.component.ts","./packages/common/src/lib/collapsible/collapsible.component.html","./packages/common/src/lib/collapsible/collapsible.module.ts","./packages/common/src/lib/confirm-dialog/confirm-dialog.component.ts","./packages/common/src/lib/confirm-dialog/confirm-dialog.component.html","./packages/common/src/lib/confirm-dialog/confirm-dialog.service.ts","./packages/common/src/lib/confirm-dialog/confirm-dialog.module.ts","./packages/common/src/lib/context-menu/context-menu.directive.ts","./packages/common/src/lib/context-menu/long-press.directive.ts","./packages/common/src/lib/context-menu/context-menu.module.ts","./packages/common/src/lib/custom-html/custom-html.component.ts","./packages/common/src/lib/custom-html/custom-html.component.html","./packages/common/src/lib/custom-html/custom-html.module.ts","./packages/common/src/lib/dom/dom.service.ts","./packages/common/src/lib/dom/dom.module.ts","./packages/common/src/lib/drag-drop/drag-drop.module.ts","./packages/common/src/lib/dynamic-component/shared/dynamic-component.ts","./packages/common/src/lib/dynamic-component/shared/dynamic-component.service.ts","./packages/common/src/lib/dynamic-component/dynamic-outlet/dynamic-outlet.component.ts","./packages/common/src/lib/dynamic-component/dynamic-outlet/dynamic-outlet.component.html","./packages/common/src/lib/dynamic-component/dynamic-outlet/dynamic-outlet.module.ts","./packages/common/src/lib/dynamic-component/dynamic-component.module.ts","./packages/common/src/lib/flexible/flexible.module.ts","./packages/common/src/lib/form/form/form.component.ts","./packages/common/src/lib/form/shared/form.utils.ts","./packages/common/src/lib/form/form/form.component.html","./packages/common/src/lib/form/form/form.module.ts","./packages/common/src/lib/form/shared/form.service.ts","./packages/common/src/lib/form/shared/form-field.service.ts","./packages/common/src/lib/form/form-field/form-field.component.html","./packages/common/src/lib/form/form-field/form-field.component.ts","./packages/common/src/lib/form/form-field/form-field.module.ts","./packages/common/src/lib/form/form-group/form-group.component.html","./packages/common/src/lib/form/form-group/form-group.component.ts","./packages/common/src/lib/form/form-group/form-group.module.ts","./packages/common/src/lib/form/form.module.ts","./packages/common/src/lib/entity/entity-selector/entity-selector.module.ts","./packages/common/src/lib/stop-propagation/stop-propagation.module.ts","./packages/common/src/lib/entity/entity-table-paginator/entity-table-paginator.module.ts","./packages/common/src/lib/image/image.module.ts","./packages/common/src/lib/entity/entity-table/entity-table.module.ts","./packages/common/src/lib/entity/entity.module.ts","./packages/common/src/lib/interactive-tour/interactive-tour.loader.ts","./packages/common/src/lib/interactive-tour/interactive-tour.service.ts","./packages/common/src/lib/tool/shared/toolbox.ts","./packages/common/src/lib/tool/shared/tool.service.ts","./packages/common/src/lib/interactive-tour/interactive-tour.component.html","./packages/common/src/lib/interactive-tour/interactive-tour.component.ts","./packages/common/src/lib/interactive-tour/interactive-tour.module.ts","./packages/common/src/lib/keyvalue/keyvalue.pipe.ts","./packages/common/src/lib/keyvalue/keyvalue.module.ts","./packages/common/src/lib/list/list-item.directive.ts","./packages/common/src/lib/list/list.component.ts","./packages/common/src/lib/list/list.component.html","./packages/common/src/lib/list/list.module.ts","./packages/common/src/lib/panel/panel.component.html","./packages/common/src/lib/panel/panel.component.ts","./packages/common/src/lib/panel/panel.module.ts","./packages/common/src/lib/spinner/spinner.component.ts","./packages/common/src/lib/spinner/spinner.component.html","./packages/common/src/lib/spinner/spinner-activity.directive.ts","./packages/common/src/lib/spinner/spinner.module.ts","./packages/common/src/lib/table/table-datasource.ts","./packages/common/src/lib/table/table-action-color.enum.ts","./packages/common/src/lib/table/table.component.html","./packages/common/src/lib/table/table.component.ts","./packages/common/src/lib/table/table.module.ts","./packages/common/src/lib/action/shared/store.ts","./packages/common/src/lib/tool/shared/toolbox.enums.ts","./packages/common/src/lib/tool/toolbox/toolbox.animation.ts","./packages/common/src/lib/tool/toolbox/toolbox.component.html","./packages/common/src/lib/tool/toolbox/toolbox.component.ts","./packages/common/src/lib/tool/toolbox/toolbox.module.ts","./packages/common/src/lib/tool/tool.module.ts","./packages/common/src/lib/widget/widget-outlet/widget-outlet.component.html","./packages/common/src/lib/widget/widget-outlet/widget-outlet.component.ts","./packages/common/src/lib/widget/widget-outlet/widget-outlet.module.ts","./packages/common/src/lib/widget/shared/widget.service.ts","./packages/common/src/lib/widget/widget.module.ts","./packages/common/src/lib/workspace/workspace-selector/workspace-selector.component.ts","./packages/common/src/lib/workspace/workspace-selector/workspace-selector.component.html","./packages/common/src/lib/workspace/workspace-selector/workspace-selector.module.ts","./packages/common/src/lib/workspace/workspace-widget-outlet/workspace-widget-outlet.component.html","./packages/common/src/lib/workspace/workspace-widget-outlet/workspace-widget-outlet.component.ts","./packages/common/src/lib/workspace/workspace-widget-outlet/workspace-widget-outlet.module.ts","./packages/common/src/lib/workspace/workspace.module.ts","./packages/common/src/lib/table/table-database.ts","./packages/common/src/lib/tool/shared/tool-component.ts","./packages/common/src/lib/workspace/shared/store.ts","./packages/common/src/lib/workspace/shared/workspace.ts","./demo/src/app/core/home/home-routing.module.ts","./demo/src/app/core/home/home.component.ts","./demo/src/app/core/home/home.component.html","./demo/src/app/core/home/home.module.ts","./demo/src/app/core/activity/activity-routing.module.ts","./demo/src/app/core/activity/activity.component.ts","./demo/src/app/core/activity/activity.component.html","./demo/src/app/core/activity/activity.module.ts","./demo/src/environments/environment.prod.ts","./demo/src/app/core/config/config-routing.module.ts","./demo/src/app/core/config/config.component.ts","./demo/src/app/core/config/config.component.html","./demo/src/app/core/config/config.module.ts","./demo/src/app/core/language/language-routing.module.ts","./demo/src/app/core/language/language.component.ts","./demo/src/app/core/language/language.component.html","./demo/src/app/core/language/language.module.ts","./demo/src/app/core/media/media-routing.module.ts","./demo/src/app/core/media/media.component.ts","./demo/src/app/core/media/media.component.html","./demo/src/app/core/media/media.module.ts","./demo/src/app/core/message/message-routing.module.ts","./demo/src/app/core/message/message.component.ts","./demo/src/app/core/message/message.component.html","./demo/src/app/core/message/message.module.ts","./demo/src/app/core/request/request-routing.module.ts","./demo/src/app/core/request/request.component.ts","./demo/src/app/core/request/request.component.html","./demo/src/app/core/request/request.module.ts","./demo/src/app/common/action/action.component.html","./demo/src/app/common/action/action-routing.module.ts","./demo/src/app/common/action/action.component.ts","./demo/src/app/common/action/action.module.ts","./demo/src/app/common/dynamic-component/dynamic-component.component.ts","./demo/src/app/common/dynamic-component/dynamic-component-routing.module.ts","./demo/src/app/common/dynamic-component/dynamic-component.component.html","./demo/src/app/common/dynamic-component/dynamic-component.module.ts","./demo/src/app/common/entity-table/entity-table-routing.module.ts","./demo/src/app/common/entity-table/entity-table.component.ts","./demo/src/app/common/entity-table/entity-table.component.html","./demo/src/app/common/entity-table/entity-table.module.ts","./demo/src/app/common/entity-selector/entity-selector.component.html","./demo/src/app/common/entity-selector/entity-selector-routing.module.ts","./demo/src/app/common/entity-selector/entity-selector.component.ts","./demo/src/app/common/entity-selector/entity-selector.module.ts","./demo/src/app/common/form/form.component.html","./demo/src/app/common/form/form-routing.module.ts","./demo/src/app/common/form/form.component.ts","./demo/src/app/common/form/form.module.ts","./demo/src/app/common/table/table-routing.module.ts","./demo/src/app/common/table/table.component.ts","./demo/src/app/common/table/table.component.html","./demo/src/app/common/table/table.module.ts","./demo/src/app/common/tool/tool.component.html","./demo/src/app/common/tool/tool.component.ts","./demo/src/app/common/tool/tool-routing.module.ts","./demo/src/app/common/tool/tool.module.ts","./demo/src/app/common/widget/widget.component.ts","./demo/src/app/common/widget/widget-routing.module.ts","./demo/src/app/common/widget/widget.component.html","./demo/src/app/common/widget/widget.module.ts","./packages/auth/src/lib/shared/token.service.ts","./packages/auth/src/lib/shared/auth.service.ts","./packages/auth/src/lib/auth-form/auth-google.component.ts","./packages/auth/src/lib/auth-form/auth-google.component.html","./packages/auth/src/lib/auth-form/auth-intern.component.html","./packages/auth/src/lib/auth-form/auth-intern.component.ts","./packages/auth/src/lib/auth-form/auth-facebook.component.ts","./packages/auth/src/lib/auth-form/auth-facebook.component.html","./packages/auth/src/lib/auth-form/auth-microsoft.component.ts","./packages/auth/src/lib/auth-form/auth-microsoft.component.html","./packages/auth/src/lib/shared/auth-msalServiceb2c.service..ts","./packages/auth/src/lib/shared/auth-msalBroadcastServiceb2c.service.ts","./packages/auth/src/lib/auth-form/auth-microsoftb2c.component.ts","./packages/auth/src/lib/auth-form/auth-microsoftb2c.component.html","./packages/auth/src/lib/auth-form/auth-form.component.html","./packages/auth/src/lib/auth-form/auth-form.component.ts","./packages/auth/src/lib/shared/auth.interceptor.ts","./packages/auth/src/lib/shared/auth-microsoft.provider.ts","./packages/auth/src/lib/shared/storage.service.ts","./packages/auth/src/lib/auth.module.ts","./demo/src/app/auth/auth-form/auth-form-routing.module.ts","./demo/src/app/auth/auth-form/auth-form.component.ts","./demo/src/app/auth/auth-form/auth-form.component.html","./demo/src/app/auth/auth-form/auth-form.module.ts","./packages/geo/src/lib/metadata/shared/metadata.service.ts","./packages/geo/src/lib/metadata/metadata-button/metadata-button.component.html","./packages/geo/src/lib/metadata/metadata-button/metadata-abstract.component.html","./packages/geo/src/lib/metadata/metadata-button/metadata-button.component.ts","./packages/geo/src/lib/metadata/metadata.module.ts","./packages/geo/src/lib/feature/shared/feature.enums.ts","./packages/geo/src/lib/layer/utils/image-watcher.ts","./packages/geo/src/lib/layer/utils/layer.utils.ts","./packages/geo/src/lib/layer/utils/tile-watcher.ts","./packages/geo/src/lib/utils/id-generator.ts","./packages/geo/src/lib/datasource/shared/datasources/datasource.ts","./packages/geo/src/lib/datasource/shared/datasources/feature-datasource.ts","./packages/geo/src/lib/datasource/shared/datasources/cluster-datasource.ts","./packages/geo/src/lib/layer/utils/vector-watcher.ts","./packages/geo/src/lib/map/shared/map.utils.ts","./packages/geo/src/lib/layer/shared/layers/layer.ts","./packages/geo/src/lib/filter/shared/ogc-filter.enum.ts","./packages/geo/src/lib/filter/shared/ogc-filter.ts","./packages/geo/src/lib/datasource/shared/datasources/wms-wfs.utils.ts","./packages/geo/src/lib/layer/shared/layers/vector-layer.ts","./packages/geo/src/lib/datasource/shared/datasources/data.service.ts","./packages/geo/src/lib/datasource/shared/datasources/osm-datasource.ts","./packages/geo/src/lib/datasource/shared/datasources/xyz-datasource.ts","./packages/geo/src/lib/datasource/shared/datasources/wfs-datasource.ts","./packages/geo/src/lib/datasource/shared/datasources/wfs.service.ts","./packages/geo/src/lib/query/shared/query.enums.ts","./packages/geo/src/lib/datasource/shared/datasources/wms-datasource.ts","./packages/geo/src/lib/datasource/utils/tilegrid.ts","./packages/geo/src/lib/datasource/shared/datasources/wmts-datasource.ts","./packages/geo/src/lib/datasource/shared/datasources/carto-datasource.ts","./packages/geo/src/lib/datasource/shared/datasources/arcgisrest-datasource.ts","./packages/geo/src/lib/datasource/shared/datasources/imagearcgisrest-datasource.ts","./packages/geo/src/lib/datasource/shared/datasources/tilearcgisrest-datasource.ts","./packages/geo/src/lib/datasource/shared/datasources/tiledebug-datasource.ts","./packages/geo/src/lib/datasource/shared/datasources/websocket-datasource.ts","./packages/geo/src/lib/datasource/shared/datasources/mvt-datasource.ts","./packages/geo/src/lib/datasource/utils/esri-style-generator.ts","./packages/geo/src/lib/filter/shared/time-filter.enum.ts","./packages/geo/src/lib/map/shared/map.service.ts","./packages/geo/src/lib/datasource/shared/capabilities.service.ts","./packages/geo/src/lib/datasource/shared/options/options.service.ts","./packages/geo/src/lib/map/shared/projection.service.ts","./packages/geo/src/lib/datasource/shared/datasource.service.ts","./packages/geo/src/lib/feature/shared/feature.utils.ts","./packages/geo/src/lib/feature/shared/store.ts","./packages/geo/src/lib/feature/shared/strategies/in-map-extent.ts","./packages/geo/src/lib/feature/shared/strategies/in-map-resolution.ts","./packages/geo/src/lib/feature/shared/strategies/loading.ts","./packages/geo/src/lib/feature/shared/strategies/loading-layer.ts","./packages/geo/src/lib/feature/shared/strategies/selection.ts","./packages/geo/src/lib/feature/shared/strategies.utils.ts","./packages/geo/src/lib/overlay/shared/overlay-marker-style.utils.ts","./packages/geo/src/lib/layer/shared/style.service.ts","./packages/geo/src/lib/overlay/shared/overlay.utils.ts","./packages/geo/src/lib/overlay/shared/overlay.ts","./packages/geo/src/lib/layer/shared/layers/layer.interface.ts","./packages/geo/src/lib/layer/shared/layers/image-layer.ts","./packages/geo/src/lib/layer/shared/layers/tile-layer.ts","./packages/geo/src/lib/layer/shared/layers/vectortile-layer.ts","./packages/geo/src/lib/map/utils/layer-watcher.ts","./packages/geo/src/lib/map/shared/map.enums.ts","./packages/geo/src/lib/map/shared/controllers/controller.ts","./packages/geo/src/lib/map/shared/controllers/view.ts","./packages/geo/src/lib/map/shared/controllers/geolocation.ts","./packages/geo/src/lib/map/shared/linkedLayers.utils.ts","./packages/geo/src/lib/map/shared/map.ts","./packages/geo/src/lib/map/map-browser/map-browser.component.ts","./packages/geo/src/lib/map/map-browser/map-browser.component.html","./packages/geo/src/lib/map/shared/map-pointer-position.directive.ts","./packages/geo/src/lib/map/shared/hover-feature.directive.ts","./packages/geo/src/lib/map/zoom-button/zoom-button.component.ts","./packages/geo/src/lib/map/zoom-button/zoom-button.component.html","./packages/geo/src/lib/map/geolocate-button/geolocate-button.component.html","./packages/geo/src/lib/map/geolocate-button/geolocate-button.component.ts","./packages/geo/src/lib/map/home-extent-button/home-extent-button.component.ts","./packages/geo/src/lib/map/home-extent-button/home-extent-button.component.html","./packages/geo/src/lib/map/wake-lock-button/wake-lock-button.component.html","./packages/geo/src/lib/map/wake-lock-button/wake-lock-button.component.ts","./packages/geo/src/lib/map/baselayers-switcher/baselayers-switcher.component.html","./packages/geo/src/lib/map/baselayers-switcher/baselayers-switcher.component.ts","./packages/geo/src/lib/map/baselayers-switcher/baselayers-switcher.animation.ts","./packages/geo/src/lib/offline/geoDB/geoDB.service.ts","./packages/geo/src/lib/offline/shared/geo-network.service.ts","./packages/geo/src/lib/layer/shared/layer.service.ts","./packages/geo/src/lib/map/baselayers-switcher/mini-basemap.component.html","./packages/geo/src/lib/map/baselayers-switcher/mini-basemap.component.ts","./packages/geo/src/lib/map/rotation-button/rotation-button.component.html","./packages/geo/src/lib/map/rotation-button/rotation-button.component.ts","./packages/geo/src/lib/map/info-section/info-section.component.html","./packages/geo/src/lib/map/info-section/info-section.component.ts","./packages/geo/src/lib/catalog/shared/catalog.enum.ts","./packages/geo/src/lib/catalog/shared/catalog.abstract.ts","./packages/geo/src/lib/query/shared/query.service.ts","./packages/geo/src/lib/query/shared/query.utils.ts","./packages/geo/src/lib/query/shared/query.directive.ts","./packages/geo/src/lib/search/shared/sources/source.ts","./packages/geo/src/lib/query/shared/query-search-source.ts","./packages/geo/src/lib/utils/googleLinks.ts","./packages/geo/src/lib/utils/commonVectorStyle.ts","./packages/geo/src/lib/utils/osmLinks.ts","./packages/geo/src/lib/catalog/shared/catalog.service.ts","./packages/geo/src/lib/catalog/catalog-browser/catalog-browser.component.html","./packages/geo/src/lib/catalog/catalog-browser/catalog-browser.component.ts","./packages/geo/src/lib/layer/layer-legend/layer-legend.component.html","./packages/geo/src/lib/layer/layer-legend/layer-legend.component.ts","./packages/geo/src/lib/catalog/catalog-browser/catalog-browser-layer.component.html","./packages/geo/src/lib/catalog/catalog-browser/catalog-browser-layer.component.ts","./packages/geo/src/lib/catalog/catalog-browser/catalog-browser-group.component.html","./packages/geo/src/lib/catalog/catalog-browser/catalog-browser-group.component.ts","./packages/geo/src/lib/layer/layer-list-tool/layer-list-tool.service.ts","./packages/geo/src/lib/layer/layer-item/layer-item.component.html","./packages/geo/src/lib/layer/layer-item/layer-item.component.ts","./packages/geo/src/lib/layer/layer-list/layer-list.enum.ts","./packages/geo/src/lib/layer/layer-list/layer-list.component.html","./packages/geo/src/lib/layer/layer-list/layer-list.component.ts","./packages/geo/src/lib/layer/layer-list-tool/layer-list-tool.component.html","./packages/geo/src/lib/layer/layer-list-tool/layer-list-tool.component.ts","./packages/geo/src/lib/layer/layer-list/layer-list-binding.directive.ts","./packages/geo/src/lib/layer/layer-legend-list/layer-legend-list.component.html","./packages/geo/src/lib/layer/layer-legend-list/layer-legend-list.component.ts","./packages/geo/src/lib/layer/track-feature-button/track-feature-button.component.html","./packages/geo/src/lib/layer/track-feature-button/track-feature-button.component.ts","./packages/geo/src/lib/layer/layer-legend-item/layer-legend-item.component.ts","./packages/geo/src/lib/layer/layer-legend-item/layer-legend-item.component.html","./packages/geo/src/lib/draw/shared/draw.enum.ts","./packages/geo/src/lib/draw/shared/draw-icon.service.ts","./packages/geo/src/lib/measure/shared/measure.enum.ts","./packages/geo/src/lib/measure/shared/measure.utils.ts","./packages/geo/src/lib/draw/shared/draw.utils.ts","./packages/geo/src/lib/draw/shared/draw-style.service.ts","./packages/geo/src/lib/feature/feature-details/feature-details.component.html","./packages/geo/src/lib/feature/feature-details/feature-details.component.ts","./packages/geo/src/lib/geometry/shared/geometry.utils.ts","./packages/geo/src/lib/geometry/shared/geometry.errors.ts","./packages/geo/src/lib/geometry/shared/controls/draw.ts","./packages/geo/src/lib/draw/draw/draw-popup.component.ts","./packages/geo/src/lib/draw/draw/draw-popup.component.html","./packages/geo/src/lib/draw/draw/draw-shorcuts.component.ts","./packages/geo/src/lib/draw/draw/draw-shorcuts.component.html","./packages/geo/src/lib/draw/draw/draw-layer-popup.component.ts","./packages/geo/src/lib/draw/draw/draw-layer-popup.component.html","./packages/geo/src/lib/draw/draw/draw.component.html","./packages/geo/src/lib/draw/draw/draw.component.ts","./packages/geo/src/lib/layer/style-modal/style-modal.component.html","./packages/geo/src/lib/layer/style-modal/style-modal.component.ts","./packages/geo/src/lib/layer/layer.module.ts","./packages/geo/src/lib/catalog/catalog-browser/catalog-browser.module.ts","./packages/geo/src/lib/catalog/catalog-library/add-catalog-dialog.component.html","./packages/geo/src/lib/catalog/catalog-library/add-catalog-dialog.component.ts","./packages/geo/src/lib/catalog/catalog-library/catalog-library.component.html","./packages/geo/src/lib/catalog/catalog-library/catalog-library.component.ts","./packages/geo/src/lib/catalog/catalog-library/catalog-library-item.component.html","./packages/geo/src/lib/catalog/catalog-library/catalog-library-item.component.ts","./packages/geo/src/lib/catalog/catalog-library/catalog-library.module.ts","./packages/geo/src/lib/catalog/catalog.module.ts","./packages/geo/src/lib/filter/shared/filterable-datasource.pipe.ts","./packages/geo/src/lib/filter/shared/time-filter.service.ts","./packages/geo/src/lib/filter/shared/ogc-filter.service.ts","./packages/geo/src/lib/filter/shared/spatial-filter.enum.ts","./packages/geo/src/lib/filter/shared/spatial-filter.service.ts","./packages/geo/src/lib/download/shared/download.service.ts","./packages/geo/src/lib/download/download-button/download-button.component.html","./packages/geo/src/lib/download/download-button/download-button.component.ts","./packages/geo/src/lib/download/download.module.ts","./packages/geo/src/lib/draw/draw/draw.module.ts","./packages/geo/src/lib/feature/feature-details/feature-details.module.ts","./packages/geo/src/lib/feature/feature-form/feature-form.module.ts","./packages/geo/src/lib/feature/feature.module.ts","./packages/geo/src/lib/geometry/shared/controls/modify.ts","./packages/geo/src/lib/layer/shared/layer.enums.ts","./packages/geo/src/lib/measure/measurer/measurer-dialog.component.html","./packages/geo/src/lib/measure/measurer/measurer-dialog.component.ts","./packages/geo/src/lib/measure/measurer/measurer.component.html","./packages/geo/src/lib/measure/measurer/measurer.component.ts","./packages/geo/src/lib/measure/measurer/measure-format.pipe.ts","./packages/geo/src/lib/geometry/geometry-form-field/geometry-form-field-input.component.ts","./packages/geo/src/lib/geometry/geometry-form-field/geometry-form-field-input.component.html","./packages/geo/src/lib/geometry/geometry-form-field/geometry-form-field.module.ts","./packages/geo/src/lib/geometry/geometry.module.ts","./packages/geo/src/lib/filter/time-filter-button/time-filter-button.component.html","./packages/geo/src/lib/filter/time-filter-button/time-filter-button.component.ts","./packages/geo/src/lib/filter/time-filter-form/time-filter-form.component.html","./packages/geo/src/lib/filter/time-filter-form/time-filter-form.component.ts","./packages/geo/src/lib/filter/time-filter-item/time-filter-item.component.html","./packages/geo/src/lib/filter/time-filter-item/time-filter-item.component.ts","./packages/geo/src/lib/filter/time-filter-list/time-filter-list.component.html","./packages/geo/src/lib/filter/time-filter-list/time-filter-list.component.ts","./packages/geo/src/lib/wkt/shared/wkt.service.ts","./packages/geo/src/lib/filter/ogc-filter-form/ogc-filter-form.component.html","./packages/geo/src/lib/filter/ogc-filter-form/ogc-filter-form.component.ts","./packages/geo/src/lib/filter/ogc-filterable-form/ogc-filterable-form.component.html","./packages/geo/src/lib/filter/ogc-filterable-form/ogc-filterable-form.component.ts","./packages/geo/src/lib/filter/ogc-filterable-item/ogc-filterable-item.component.html","./packages/geo/src/lib/filter/ogc-filterable-item/ogc-filterable-item.component.ts","./packages/geo/src/lib/filter/ogc-filterable-list/ogc-filterable-list.component.html","./packages/geo/src/lib/filter/ogc-filterable-list/ogc-filterable-list.component.ts","./packages/geo/src/lib/filter/ogc-filter-button/ogc-filter-button.component.html","./packages/geo/src/lib/filter/ogc-filter-button/ogc-filter-button.component.ts","./packages/geo/src/lib/filter/shared/ogc-filter-time.service.ts","./packages/geo/src/lib/filter/ogc-filter-selection/ogc-filter-selection.component.html","./packages/geo/src/lib/filter/ogc-filter-selection/ogc-filter-selection.component.ts","./packages/geo/src/lib/filter/spatial-filter/spatial-filter-type/spatial-filter-type.component.html","./packages/geo/src/lib/filter/spatial-filter/spatial-filter-type/spatial-filter-type.component.ts","./packages/geo/src/lib/filter/spatial-filter/spatial-filter-list/spatial-filter-list.component.html","./packages/geo/src/lib/filter/spatial-filter/spatial-filter-list/spatial-filter-list.component.ts","./packages/geo/src/lib/filter/spatial-filter/spatial-filter-item/spatial-filter-item.component.html","./packages/geo/src/lib/filter/spatial-filter/spatial-filter-item/spatial-filter-item.component.ts","./packages/geo/src/lib/filter/ogc-filter-time/ogc-filter-time.component.html","./packages/geo/src/lib/filter/ogc-filter-time/ogc-filter-time.component.ts","./packages/geo/src/lib/filter/ogc-filter-time/ogc-filter-time-slider.component.ts","./packages/geo/src/lib/filter/ogc-filter-time/ogc-filter-time-slider.component.html","./packages/geo/src/lib/filter/filter.module.ts","./packages/geo/src/lib/import-export/shared/export.errors.ts","./packages/geo/src/lib/import-export/shared/export.type.ts","./packages/geo/src/lib/import-export/shared/export.service.ts","./packages/utils/src/lib/file.ts","./packages/geo/src/lib/import-export/shared/import.utils.ts","./packages/geo/src/lib/import-export/shared/import.errors.ts","./packages/geo/src/lib/import-export/shared/import.service.ts","./packages/geo/src/lib/import-export/style-list/style-list.service.ts","./packages/geo/src/lib/import-export/import-export/import-export.component.html","./packages/geo/src/lib/import-export/import-export/import-export.component.ts","./packages/geo/src/lib/map/shared/projection.utils.ts","./packages/geo/src/lib/import-export/shared/export.utils.ts","./packages/geo/src/lib/import-export/style-list/style-list.provider.ts","./packages/geo/src/lib/import-export/style-list/style-list.module.ts","./packages/geo/src/lib/import-export/import-export.module.ts","./packages/geo/src/lib/map/map.module.ts","./packages/geo/src/lib/measure/measurer/measurer-item.component.html","./packages/geo/src/lib/measure/measurer/measurer-item.component.ts","./packages/geo/src/lib/measure/measurer/measurer.module.ts","./packages/geo/src/lib/measure/measure.module.ts","./packages/geo/src/lib/overlay/shared/overlay.enum.ts","./packages/geo/src/lib/overlay/shared/overlay.service.ts","./packages/geo/src/lib/overlay/shared/overlay.directive.ts","./packages/geo/src/lib/overlay/overlay.module.ts","./packages/geo/src/lib/print/shared/print.service.ts","./packages/geo/src/lib/layer/utils/outputLegend.ts","./packages/geo/src/lib/print/shared/print.type.ts","./packages/geo/src/lib/print/print-form/print-form.component.html","./packages/geo/src/lib/print/print-form/print-form.component.ts","./packages/geo/src/lib/print/print/print.component.ts","./packages/geo/src/lib/print/print/print.component.html","./packages/geo/src/lib/print/print.module.ts","./packages/geo/src/lib/query/shared/query-search-source.providers.ts","./packages/geo/src/lib/query/query.module.ts","./packages/geo/src/lib/directions/directions-sources/directions-source.ts","./packages/geo/src/lib/directions/shared/directions-source.service.ts","./packages/geo/src/lib/directions/shared/directions.enum.ts","./packages/geo/src/lib/directions/shared/directions.utils.ts","./packages/geo/src/lib/directions/directions-inputs/directions-inputs.component.html","./packages/geo/src/lib/directions/directions-inputs/directions-inputs.component.ts","./packages/geo/src/lib/directions/shared/directions.service.ts","./packages/geo/src/lib/search/shared/search.utils.ts","./packages/geo/src/lib/search/shared/search-source.service.ts","./packages/geo/src/lib/search/shared/search.service.ts","./packages/geo/src/lib/directions/directions-buttons/directions-buttons.component.html","./packages/geo/src/lib/directions/directions-buttons/directions-buttons.component.ts","./packages/geo/src/lib/directions/directions-results/directions-results.component.html","./packages/geo/src/lib/directions/directions-results/directions-results.component.ts","./packages/geo/src/lib/directions/directions.component.ts","./packages/geo/src/lib/directions/directions.component.html","./packages/geo/src/lib/directions/directions.module.ts","./packages/geo/src/lib/search/shared/search-source-service.providers.ts","./packages/geo/src/lib/search/shared/sources/icherche.ts","./packages/geo/src/lib/search/shared/sources/icherche.providers.ts","./packages/geo/src/lib/search/shared/sources/coordinates.ts","./packages/geo/src/lib/search/shared/sources/coordinates.providers.ts","./packages/geo/src/lib/search/shared/sources/ilayer.ts","./packages/geo/src/lib/search/shared/sources/ilayer.providers.ts","./packages/geo/src/lib/search/shared/search.enums.ts","./packages/geo/src/lib/search/search-selector/search-selector.component.html","./packages/geo/src/lib/search/search-selector/search-selector.component.ts","./packages/geo/src/lib/search/search-selector/search-selector.module.ts","./packages/geo/src/lib/search/search-settings/search-settings.component.html","./packages/geo/src/lib/search/search-settings/search-settings.component.ts","./packages/geo/src/lib/search/search-settings/search-settings.module.ts","./packages/geo/src/lib/search/search-bar/search-bar.component.html","./packages/geo/src/lib/search/search-bar/search-bar.component.ts","./packages/geo/src/lib/search/search-bar/search-bar.module.ts","./packages/geo/src/lib/search/search-results/search-results-item.component.html","./packages/geo/src/lib/search/search-results/search-results-item.component.ts","./packages/geo/src/lib/search/search-results/search-results.component.html","./packages/geo/src/lib/search/search-results/search-results.component.ts","./packages/geo/src/lib/search/search-results/search-results-add-button.component.html","./packages/geo/src/lib/search/search-results/search-results-add-button.component.ts","./packages/geo/src/lib/search/search-results/search-results.module.ts","./packages/geo/src/lib/search/shared/search-pointer-summary.directive.ts","./packages/geo/src/lib/search/search.module.ts","./packages/geo/src/lib/workspace/widgets/ogc-filter/ogc-filter.component.ts","./packages/geo/src/lib/workspace/widgets/ogc-filter/ogc-filter.component.html","./packages/geo/src/lib/workspace/widgets/widgets.ts","./packages/geo/src/lib/workspace/widgets/ogc-filter/ogc-filter.module.ts","./packages/geo/src/lib/workspace/shared/wfs-workspace.ts","./packages/geo/src/lib/workspace/shared/wfs-workspace.service.ts","./packages/geo/src/lib/workspace/shared/wms-workspace.service.ts","./packages/geo/src/lib/workspace/confirmation-popup/confirmation-popup.component.ts","./packages/geo/src/lib/workspace/confirmation-popup/confirmation-popup.component.html","./packages/geo/src/lib/workspace/shared/edition-workspace.ts","./packages/geo/src/lib/workspace/shared/edition-workspace.service.ts","./packages/geo/src/lib/workspace/shared/feature-workspace.ts","./packages/geo/src/lib/workspace/shared/feature-workspace.service.ts","./packages/geo/src/lib/workspace/workspace-selector/workspace-selector.directive.ts","./packages/geo/src/lib/workspace/workspace-selector/workspace-selector.module.ts","./packages/geo/src/lib/workspace/workspace-updator/workspace-updator.module.ts","./packages/geo/src/lib/workspace/confirmation-popup/confirmation-popup.module.ts","./packages/geo/src/lib/workspace/workspace.module.ts","./packages/geo/src/lib/directions/shared/store.ts","./packages/geo/src/lib/directions/directions-sources/osrm-directions-source.ts","./packages/geo/src/lib/directions/directions-sources/directions-source.provider.ts","./packages/geo/src/lib/search/shared/sources/cadastre.ts","./packages/geo/src/lib/search/shared/sources/cadastre.providers.ts","./packages/geo/src/lib/search/shared/sources/nominatim.ts","./packages/geo/src/lib/search/shared/sources/nominatim.providers.ts","./packages/geo/src/lib/search/shared/sources/storedqueries.ts","./packages/geo/src/lib/search/shared/sources/storedqueries.providers.ts","./packages/geo/src/lib/workspace/shared/workspace.utils.ts","./demo/src/app/geo/simple-map/simple-map.component.html","./demo/src/app/geo/simple-map/simple-map-routing.module.ts","./demo/src/app/geo/simple-map/simple-map.component.ts","./demo/src/app/geo/simple-map/simple-map.module.ts","./demo/src/app/geo/layer/layer.component.html","./demo/src/app/geo/layer/layer-routing.module.ts","./demo/src/app/geo/layer/layer.component.ts","./demo/src/app/geo/layer/layer.module.ts","./demo/src/app/geo/legend/legend-routing.module.ts","./demo/src/app/geo/legend/legend.component.ts","./demo/src/app/geo/legend/legend.component.html","./demo/src/app/geo/legend/legend.module.ts","./demo/src/app/geo/overlay/overlay-routing.module.ts","./demo/src/app/geo/overlay/overlay.component.ts","./demo/src/app/geo/overlay/overlay.component.html","./demo/src/app/geo/overlay/overlay.module.ts","./demo/src/app/geo/geometry/geometry.component.html","./demo/src/app/geo/geometry/geometry-routing.module.ts","./demo/src/app/geo/geometry/geometry.component.ts","./demo/src/app/geo/geometry/geometry.module.ts","./demo/src/app/geo/feature/feature-routing.module.ts","./demo/src/app/geo/feature/feature.component.ts","./demo/src/app/geo/feature/feature.component.html","./demo/src/app/geo/feature/feature.module.ts","./demo/src/app/geo/hover/hover-routing.module.ts","./demo/src/app/geo/hover/hover.component.ts","./demo/src/app/geo/hover/hover.component.html","./demo/src/app/geo/hover/hover.module.ts","./demo/src/app/geo/measure/measure-routing.module.ts","./demo/src/app/geo/measure/measure.component.ts","./demo/src/app/geo/measure/measure.component.html","./demo/src/app/geo/measure/measure.module.ts","./demo/src/app/geo/draw/draw-routing.module.ts","./demo/src/app/geo/draw/draw.component.ts","./demo/src/app/geo/draw/draw.component.html","./demo/src/app/geo/draw/draw.module.ts","./demo/src/app/geo/query/query.component.html","./demo/src/app/geo/query/query-routing.module.ts","./demo/src/app/geo/query/query.component.ts","./demo/src/app/geo/query/query.module.ts","./demo/src/app/geo/catalog/catalog-routing.module.ts","./demo/src/app/geo/catalog/catalog.component.ts","./demo/src/app/geo/catalog/catalog.component.html","./demo/src/app/geo/catalog/catalog.module.ts","./packages/context/src/lib/context-import-export/shared/context-export.errors.ts","./packages/context/src/lib/context-import-export/shared/context-import.errors.ts","./packages/context/src/lib/context-manager/shared/context.enum.ts","./packages/context/src/lib/context-manager/shared/context.service.ts","./packages/context/src/lib/context-import-export/context-import-export.module.ts","./packages/context/src/lib/context-manager/shared/map-context.directive.ts","./packages/context/src/lib/context-manager/shared/layer-context.directive.ts","./packages/context/src/lib/context-import-export/shared/context-import.utils.ts","./packages/context/src/lib/context-manager/context-list/context-list.enum.ts","./packages/context/src/lib/context-map-button/bookmark-button/bookmark-dialog.component.ts","./packages/context/src/lib/context-map-button/bookmark-button/bookmark-dialog.component.html","./packages/context/src/lib/context-manager/context-item/context-item.component.html","./packages/context/src/lib/context-manager/context-item/context-item.component.ts","./packages/context/src/lib/context-manager/context-list/context-list.component.html","./packages/context/src/lib/context-manager/context-list/context-list.component.ts","./packages/context/src/lib/context-manager/context-list/context-list-binding.directive.ts","./packages/context/src/lib/context-map-button/poi-button/shared/poi.service.ts","./packages/context/src/lib/context-map-button/context-map-button.module.ts","./packages/context/src/lib/context-manager/context-manager.module.ts","./packages/integration/src/lib/import-export/import-export.state.ts","./packages/integration/src/lib/tool/tool.state.ts","./packages/integration/src/lib/workspace/shared/workspace.utils.ts","./packages/integration/src/lib/storage/storage.state.ts","./packages/integration/src/lib/workspace/shared/feature-actions.service.ts","./packages/integration/src/lib/workspace/shared/wfs-actions.service.ts","./packages/integration/src/lib/workspace/shared/edition-actions.service.ts","./packages/integration/src/lib/workspace/workspace.state.ts","./packages/integration/src/lib/search/search.state.ts","./packages/integration/src/lib/search/search-bar/search-bar.module.ts","./packages/integration/src/lib/search/search-results-tool/search-results-tool.module.ts","./packages/integration/src/lib/search/search.module.ts","./demo/src/app/geo/search/search.component.html","./demo/src/app/geo/search/search-routing.module.ts","./demo/src/app/geo/search/search.component.ts","./demo/src/app/geo/search/search.module.ts","./demo/src/app/geo/print/print-routing.module.ts","./demo/src/app/geo/print/print.component.ts","./demo/src/app/geo/print/print.component.html","./demo/src/app/geo/print/print.module.ts","./demo/src/app/geo/import-export/import-export-routing.module.ts","./demo/src/app/geo/import-export/import-export.component.ts","./demo/src/app/geo/import-export/import-export.component.html","./demo/src/app/geo/import-export/import-export.module.ts","./demo/src/app/geo/directions/directions-routing.module.ts","./demo/src/app/geo/directions/directions.component.ts","./demo/src/app/geo/directions/directions.component.html","./demo/src/app/geo/directions/directions.module.ts","./demo/src/app/geo/time-filter/time-filter-routing.module.ts","./demo/src/app/geo/time-filter/time-filter.component.ts","./demo/src/app/geo/time-filter/time-filter.component.html","./demo/src/app/geo/time-filter/time-filter.module.ts","./demo/src/app/geo/ogc-filter/ogc-filter-routing.module.ts","./demo/src/app/geo/ogc-filter/ogc-filter.component.ts","./demo/src/app/geo/ogc-filter/ogc-filter.component.html","./demo/src/app/geo/ogc-filter/ogc-filter.module.ts","./demo/src/app/geo/spatial-filter/spatial-filter.component.html","./demo/src/app/geo/spatial-filter/spatial-filter-routing.module.ts","./demo/src/app/geo/spatial-filter/spatial-filter.component.ts","./demo/src/app/geo/spatial-filter/spatial-filter.module.ts","./demo/src/app/geo/workspace/workspace.component.html","./demo/src/app/geo/workspace/workspace-routing.module.ts","./demo/src/app/geo/workspace/workspace.component.ts","./demo/src/app/geo/workspace/workspace.module.ts","./demo/src/app/context/context/context.component.html","./demo/src/app/context/context/context-routing.module.ts","./demo/src/app/context/context/context.component.ts","./demo/src/app/context/context/context.module.ts","./demo/src/app/app-routing.module.ts","./demo/src/app/app.component.ts","./demo/src/app/app.component.html","./demo/src/app/app.module.ts","./demo/src/main.ts","./node_modules/moment/locale/ sync ^\\.\\/.*$"],"sourcesContent":["/* eslint-disable */\r\n\r\nconst ALPHA =\r\n  'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';\r\n\r\nexport class Base64 {\r\n  private static PADCHAR: string = '=';\r\n  private static ALPHA: string = ALPHA;\r\n\r\n  private static getByte(s: string, i: number): number {\r\n    const x = s.charCodeAt(i);\r\n    return x;\r\n  }\r\n\r\n  private static getByte64(s: string, i: number): number {\r\n    const idx = this.ALPHA.indexOf(s.charAt(i));\r\n    return idx;\r\n  }\r\n\r\n  public static decode(s: string): string {\r\n    let pads = 0,\r\n      i,\r\n      b10,\r\n      imax = s.length,\r\n      x = [];\r\n\r\n    s = String(s);\r\n\r\n    if (imax === 0) {\r\n      return s;\r\n    }\r\n\r\n    if (s.charAt(imax - 1) === this.PADCHAR) {\r\n      pads = 1;\r\n      if (s.charAt(imax - 2) === this.PADCHAR) {\r\n        pads = 2;\r\n      }\r\n      imax -= 4;\r\n    }\r\n\r\n    for (i = 0; i < imax; i += 4) {\r\n      b10 =\r\n        (this.getByte64(s, i) << 18) |\r\n        (this.getByte64(s, i + 1) << 12) |\r\n        (this.getByte64(s, i + 2) << 6) |\r\n        this.getByte64(s, i + 3);\r\n      x.push(String.fromCharCode(b10 >> 16, (b10 >> 8) & 255, b10 & 255));\r\n    }\r\n\r\n    switch (pads) {\r\n      case 1:\r\n        b10 =\r\n          (this.getByte64(s, i) << 18) |\r\n          (this.getByte64(s, i + 1) << 12) |\r\n          (this.getByte64(s, i + 2) << 6);\r\n        x.push(String.fromCharCode(b10 >> 16, (b10 >> 8) & 255));\r\n        break;\r\n      case 2:\r\n        b10 = (this.getByte64(s, i) << 18) | (this.getByte64(s, i + 1) << 12);\r\n        x.push(String.fromCharCode(b10 >> 16));\r\n        break;\r\n    }\r\n\r\n    return x.join('');\r\n  }\r\n\r\n  public static encode(s: string): string {\r\n    s = String(s);\r\n\r\n    let i,\r\n      b10,\r\n      x = [],\r\n      imax = s.length - s.length % 3;\r\n\r\n    if (s.length === 0) {\r\n      return s;\r\n    }\r\n\r\n    for (i = 0; i < imax; i += 3) {\r\n      b10 =\r\n        (this.getByte(s, i) << 16) |\r\n        (this.getByte(s, i + 1) << 8) |\r\n        this.getByte(s, i + 2);\r\n      x.push(this.ALPHA.charAt(b10 >> 18));\r\n      x.push(this.ALPHA.charAt((b10 >> 12) & 63));\r\n      x.push(this.ALPHA.charAt((b10 >> 6) & 63));\r\n      x.push(this.ALPHA.charAt(b10 & 63));\r\n    }\r\n\r\n    switch (s.length - imax) {\r\n      case 1:\r\n        b10 = this.getByte(s, i) << 16;\r\n        x.push(\r\n          this.ALPHA.charAt(b10 >> 18) +\r\n            this.ALPHA.charAt((b10 >> 12) & 63) +\r\n            this.PADCHAR +\r\n            this.PADCHAR\r\n        );\r\n        break;\r\n      case 2:\r\n        b10 = (this.getByte(s, i) << 16) | (this.getByte(s, i + 1) << 8);\r\n        x.push(\r\n          this.ALPHA.charAt(b10 >> 18) +\r\n            this.ALPHA.charAt((b10 >> 12) & 63) +\r\n            this.ALPHA.charAt((b10 >> 6) & 63) +\r\n            this.PADCHAR\r\n        );\r\n        break;\r\n    }\r\n\r\n    return x.join('');\r\n  }\r\n}\r\n","import * as Bowser from 'bowser';\r\n\r\nexport interface UserAgent extends Bowser.Parser.Parser {\r\n  compareVersion: (version: string) => boolean;\r\n}\r\n\r\nexport const userAgent = Bowser.getParser(\r\n  window.navigator.userAgent\r\n) as UserAgent;\r\n","import { userAgent } from './user-agent';\r\n\r\nexport class Clipboard {\r\n  static copy(element: HTMLTextAreaElement | string): boolean {\r\n    let successful = false;\r\n    if (typeof element === 'string') {\r\n      const textArea = Clipboard.createTextArea(element);\r\n      Clipboard.selectText(textArea);\r\n      successful = Clipboard.copyTextToClipboard();\r\n      Clipboard.destroyTextArea(textArea);\r\n    } else {\r\n      Clipboard.selectText(element);\r\n      successful = Clipboard.copyTextToClipboard();\r\n    }\r\n    return successful;\r\n  }\r\n\r\n  private static createTextArea(text: string): HTMLTextAreaElement {\r\n    const textArea = document.createElement('textArea') as HTMLTextAreaElement;\r\n    textArea.value = text;\r\n    document.body.appendChild(textArea);\r\n    return textArea;\r\n  }\r\n\r\n  private static destroyTextArea(textArea) {\r\n    document.body.removeChild(textArea);\r\n  }\r\n\r\n  private static selectText(textArea) {\r\n    if (userAgent.getOSName() === 'iOS') {\r\n      const oldContentEditable = textArea.contentEditable;\r\n      const oldReadOnly = textArea.readOnly;\r\n      const range = document.createRange();\r\n      const selection = window.getSelection();\r\n\r\n      textArea.contenteditable = true;\r\n      textArea.readonly = false;\r\n      range.selectNodeContents(textArea);\r\n      selection.removeAllRanges();\r\n      selection.addRange(range);\r\n      textArea.setSelectionRange(0, 999999);\r\n      textArea.contentEditable = oldContentEditable;\r\n      textArea.readOnly = oldReadOnly;\r\n    } else {\r\n      textArea.select();\r\n    }\r\n  }\r\n\r\n  private static copyTextToClipboard(): boolean {\r\n    if (!(userAgent.getOSName() === 'iOS' && userAgent.compareVersion('<10'))) {\r\n      return document.execCommand('copy');\r\n    }\r\n    return false;\r\n  }\r\n}\r\n","export class StringUtils {\r\n  static diff(s1: string, s2: string, p = 4): string {\r\n    if (!s1 && !s2) {\r\n      return '';\r\n    }\r\n    if (!s1) {\r\n      return '<span class=\"inserted\">' + s2 + '</span>';\r\n    }\r\n    if (!s2) {\r\n      return '<span class=\"deleted\">' + s1 + '</span>';\r\n    }\r\n    s1 = s1.toString();\r\n    s2 = s2.toString();\r\n    const changeData = StringUtils.getChanges(s1, s2, '', p);\r\n    const nextS = s2.slice(\r\n      changeData.mtc.length + changeData.ins.length + changeData.sbs.length\r\n    ); // remaining part of \"s\"\r\n    const nextThis = s1.slice(\r\n      changeData.mtc.length + changeData.del.length + changeData.sbs.length\r\n    ); // remaining part of \"this\"\r\n    let result = ''; // the glorious result\r\n    if (changeData.del.length > 0) {\r\n      changeData.del = '<span class=\"deleted\">' + changeData.del + '</span>';\r\n    }\r\n    if (changeData.ins.length > 0) {\r\n      changeData.ins = '<span class=\"inserted\">' + changeData.ins + '</span>';\r\n    }\r\n    result = changeData.mtc + changeData.del + changeData.ins + changeData.sbs;\r\n    result +=\r\n      nextThis !== '' || nextS !== ''\r\n        ? StringUtils.diff(nextThis, nextS, p)\r\n        : '';\r\n    return result;\r\n  }\r\n\r\n  private static getMatchingSubstring(s, l, m) {\r\n    // returns the first matching substring in-between the two strings\r\n    let i = 0;\r\n    let match = false;\r\n    const slen = s.length;\r\n    const o = { fis: slen, mtc: m, sbs: '' }; // temporary object used to construct the cd (change data) object\r\n\r\n    while (i < slen) {\r\n      l[i] === s[i]\r\n        ? match\r\n          ? (o.sbs += s[i]) // o.sbs holds the matching substring itsef\r\n          : ((match = true), (o.fis = i), (o.sbs = s[i]))\r\n        : match\r\n          ? (i = slen) // stop after the first found substring\r\n          : (i = i);\r\n      ++i;\r\n    }\r\n    return o;\r\n  }\r\n\r\n  private static getChanges(s1, s2, m, p) {\r\n    const isThisLonger = s1.length >= s1.length ? true : false;\r\n    let [longer, shorter] = isThisLonger ? [s1, s2] : [s2, s1]; // assignment of longer and shorter by es6 destructuring\r\n    let bi = 0; // base index designating the index of first mismacthing character in both strings\r\n\r\n    while (shorter[bi] === longer[bi] && bi < shorter.length) {\r\n      ++bi;\r\n    } // make bi the index of first mismatching character\r\n    longer = longer.split('').slice(bi); // as the longer string will be rotated it is converted into array\r\n    shorter = shorter.slice(bi); // shorter and longer now starts from the first mismatching character\r\n\r\n    const len = longer.length; // length of the longer string\r\n    let cd: any = {\r\n      fis: shorter.length, // the index of matching string in the shorter string\r\n      fil: len, // the index of matching string in the longer string\r\n      sbs: '', // the matching substring itself\r\n      mtc: m + s2.slice(0, bi)\r\n    }; // if exists mtc holds the matching string at the front\r\n    let sub: any = { sbs: '' }; // returned substring per 1 character rotation of the longer string\r\n\r\n    if (shorter !== '') {\r\n      for (let rc = 0; rc < len && sub.sbs.length < p; rc++) {\r\n        // rc -> rotate count, p -> precision factor\r\n        sub = StringUtils.getMatchingSubstring(\r\n          shorter,\r\n          StringUtils.rotateArray(longer, rc),\r\n          cd.mtc\r\n        ); // rotate longer string 1 char and get substring\r\n        sub.fil =\r\n          rc < len - sub.fis\r\n            ? sub.fis + rc // mismatch is longer than the mismatch in short\r\n            : sub.fis - len + rc; // mismatch is shorter than the mismatch in short\r\n        if (sub.sbs.length > cd.sbs.length) {\r\n          cd = sub; // only keep the one with the longest substring.\r\n        }\r\n      }\r\n    }\r\n    // insert the mismatching delete subsrt and insert substr to the cd object and attach the previous substring\r\n    [cd.del, cd.ins] = isThisLonger\r\n      ? [longer.slice(0, cd.fil).join(''), shorter.slice(0, cd.fis)]\r\n      : [shorter.slice(0, cd.fis), longer.slice(0, cd.fil).join('')];\r\n    return cd.del.indexOf(' ') === -1 ||\r\n      cd.ins.indexOf(' ') === -1 ||\r\n      cd.del === '' ||\r\n      cd.ins === '' ||\r\n      cd.sbs === ''\r\n      ? cd\r\n      : StringUtils.getChanges(cd.del, cd.ins, cd.mtc, p);\r\n  }\r\n\r\n  private static rotateArray(array, n) {\r\n    const len = array.length;\r\n    const res = new Array(array.length);\r\n    if (n % len === 0) {\r\n      return array.slice();\r\n    } else {\r\n      for (let i = 0; i < len; i++) {\r\n        res[i] = array[(i + (len + (n % len))) % len];\r\n      }\r\n    }\r\n    return res;\r\n  }\r\n}\r\n","export enum ChangeType {\r\n  ADDED = 'added',\r\n  DELETED = 'deleted',\r\n  MODIFIED = 'modified'\r\n}\r\n\r\nexport interface Change {\r\n  type: ChangeType;\r\n  keysChanged?: {\r\n    key: string;\r\n    newValue: any;\r\n    oldValue: any;\r\n  }[];\r\n}\r\n\r\nexport interface GroupingChanges {\r\n  added: ChangeItem[];\r\n  deleted: ChangeItem[];\r\n  modified: ChangeItem[];\r\n}\r\n\r\nexport interface ChangeItem {\r\n  change: Change;\r\n  value: any;\r\n  oldValue?: any;\r\n  newValue?: any;\r\n}\r\n","import { StringUtils } from './string-utils';\r\nimport { GroupingChanges, ChangeType } from './change.interface';\r\n\r\nexport class ChangeUtils {\r\n  static findChanges(\r\n    obj1: any[],\r\n    obj2: any[],\r\n    ignoreKeys: string[] = []\r\n  ): GroupingChanges {\r\n    const items: GroupingChanges = {\r\n      added: [],\r\n      deleted: [],\r\n      modified: []\r\n    };\r\n\r\n    if (!obj1 || !obj2) {\r\n      return items;\r\n    }\r\n\r\n    const obj1Clone: any = [...obj1];\r\n    const obj2Clone: any = [...obj2];\r\n\r\n    for (const fromItem of obj1Clone) {\r\n      const index = obj2Clone.findIndex(s => s.id === fromItem.id);\r\n\r\n      if (index === -1) {\r\n        items.deleted.push({\r\n          change: { type: ChangeType.DELETED },\r\n          value: fromItem\r\n        });\r\n        continue;\r\n      }\r\n\r\n      const toItem = obj2Clone.splice(index, 1)[0];\r\n      const fromItemClone = JSON.parse(JSON.stringify(fromItem));\r\n      const toItemClone = JSON.parse(JSON.stringify(toItem));\r\n\r\n      const keysChanged = ChangeUtils.compareObject(\r\n        fromItemClone,\r\n        toItemClone,\r\n        undefined,\r\n        ignoreKeys\r\n      );\r\n\r\n      if (keysChanged.length) {\r\n        items.modified.push({\r\n          change: {\r\n            type: ChangeType.MODIFIED,\r\n            keysChanged\r\n          },\r\n          value: fromItemClone,\r\n          oldValue: fromItem,\r\n          newValue: toItem\r\n        });\r\n      }\r\n    }\r\n\r\n    items.added = obj2Clone.map(itemAdded => {\r\n      return {\r\n        change: { type: ChangeType.ADDED },\r\n        value: itemAdded\r\n      };\r\n    });\r\n\r\n    return items;\r\n  }\r\n\r\n  private static compareObject(fromItem, toItem, baseKey?, ignoreKeys = []) {\r\n    const fromItemClone = JSON.parse(JSON.stringify(fromItem));\r\n    const toItemClone = JSON.parse(JSON.stringify(toItem));\r\n\r\n    const keys: any = new Set([\r\n      ...Object.keys(fromItem),\r\n      ...Object.keys(toItem)\r\n    ]);\r\n    let keysChanged = [];\r\n    keys.forEach(key => {\r\n      const keyString = baseKey ? `${baseKey}.${key}` : key;\r\n      if (ignoreKeys.indexOf(keyString) !== -1) {\r\n        return;\r\n      }\r\n\r\n      if (Array.isArray(fromItem[key])) {\r\n        fromItem[key] = fromItem[key].join(',<br>');\r\n      }\r\n      if (Array.isArray(toItem[key])) {\r\n        toItem[key] = toItem[key].join(',<br>');\r\n      }\r\n\r\n      if (\r\n        typeof fromItem[key] === 'object' &&\r\n        typeof toItem[key] === 'object' &&\r\n        fromItem[key] !== null &&\r\n        toItem[key] !== null\r\n      ) {\r\n        keysChanged = keysChanged.concat(\r\n          this.compareObject(fromItem[key], toItem[key], keyString)\r\n        );\r\n      } else {\r\n        if (fromItem[key] !== toItem[key]) {\r\n          keysChanged.push({\r\n            key: keyString,\r\n            oldValue: fromItemClone[key],\r\n            newValue: toItemClone[key]\r\n          });\r\n          fromItem[key] = StringUtils.diff(fromItem[key], toItem[key]);\r\n        }\r\n      }\r\n    });\r\n\r\n    return keysChanged;\r\n  }\r\n}\r\n","export class ObjectUtils {\r\n  static resolve(obj: object, key: string): any {\r\n    const keysArray = key\r\n      .replace(/\\[/g, '.')\r\n      .replace(/\\]/g, '')\r\n      .split('.');\r\n    let current = obj;\r\n    while (keysArray.length) {\r\n      if (typeof current !== 'object') {\r\n        return undefined;\r\n      }\r\n      current = current[keysArray.shift()];\r\n    }\r\n\r\n    return current;\r\n  }\r\n\r\n  static isObject(item: object) {\r\n    return (\r\n      item &&\r\n      typeof item === 'object' &&\r\n      !Array.isArray(item) &&\r\n      item !== null &&\r\n      !(item instanceof Date)\r\n    );\r\n  }\r\n\r\n  static mergeDeep(\r\n    target: object,\r\n    source: object,\r\n    ignoreUndefined = false\r\n  ): any {\r\n    const output = Object.assign({}, target);\r\n    if (ObjectUtils.isObject(target) && ObjectUtils.isObject(source)) {\r\n      Object.keys(source)\r\n        .filter(key => !ignoreUndefined || source[key] !== undefined)\r\n        .forEach(key => {\r\n          if (ObjectUtils.isObject(source[key])) {\r\n            if (!(key in target)) {\r\n              Object.assign(output, { [key]: source[key] });\r\n            } else {\r\n              output[key] = ObjectUtils.mergeDeep(\r\n                target[key],\r\n                source[key],\r\n                ignoreUndefined\r\n              );\r\n            }\r\n          } else {\r\n            Object.assign(output, { [key]: source[key] });\r\n          }\r\n        });\r\n    }\r\n    return output;\r\n  }\r\n\r\n  static copyDeep(src): any {\r\n    const target = Array.isArray(src) ? [] : {};\r\n    for (const prop in src) {\r\n      if (src.hasOwnProperty(prop)) {\r\n        const value = src[prop];\r\n        if (value && typeof value === 'object') {\r\n          target[prop] = this.copyDeep(value);\r\n        } else {\r\n          target[prop] = value;\r\n        }\r\n      }\r\n    }\r\n    return target;\r\n  }\r\n\r\n  static removeDuplicateCaseInsensitive(obj: object) {\r\n    const summaryCapitalizeObject = {};\r\n    const capitalizeObject = {};\r\n    const upperCaseCount = [];\r\n\r\n    for (const property in obj) {\r\n      if (obj.hasOwnProperty(property)) {\r\n        const upperCaseProperty = property.toUpperCase();\r\n        if (!summaryCapitalizeObject.hasOwnProperty(upperCaseProperty)) {\r\n          summaryCapitalizeObject[upperCaseProperty] = [\r\n            { [property]: obj[property] }\r\n          ];\r\n        } else {\r\n          summaryCapitalizeObject[upperCaseProperty].push({\r\n            [property]: obj[property]\r\n          });\r\n        }\r\n        // counting the number of uppercase lettersMna\r\n        upperCaseCount.push({\r\n          key: property,\r\n          count: property.replace(/[^A-Z]/g, '').length\r\n        });\r\n      }\r\n    }\r\n    for (const capitalizedProperty in summaryCapitalizeObject) {\r\n      if (summaryCapitalizeObject.hasOwnProperty(capitalizedProperty)) {\r\n        if (summaryCapitalizeObject.hasOwnProperty(capitalizedProperty)) {\r\n          const capitalizedPropertyObject =\r\n            summaryCapitalizeObject[capitalizedProperty];\r\n          if (capitalizedPropertyObject.length === 1) {\r\n            // for single params (no duplicates)\r\n            const singlePossibility = capitalizedPropertyObject[0];\r\n            capitalizeObject[capitalizedProperty] =\r\n              singlePossibility[Object.keys(singlePossibility)[0]];\r\n          } else if (capitalizedPropertyObject.length > 1) {\r\n            // defining the closest to lowercase property\r\n            const paramClosestToLowercase = upperCaseCount\r\n              .filter(\r\n                f => f.key.toLowerCase() === capitalizedProperty.toLowerCase()\r\n              )\r\n              .reduce((prev, current) => {\r\n                return prev.y < current.y ? prev : current;\r\n              });\r\n            capitalizeObject[paramClosestToLowercase.key.toUpperCase()] =\r\n              obj[paramClosestToLowercase.key];\r\n          }\r\n        }\r\n      }\r\n    }\r\n    for (const property in obj) {\r\n      if (obj.hasOwnProperty(property)) {\r\n        delete obj[property];\r\n      }\r\n    }\r\n\r\n    for (const property in capitalizeObject) {\r\n      if (capitalizeObject.hasOwnProperty(property)) {\r\n        obj[property] = capitalizeObject[property];\r\n      }\r\n    }\r\n  }\r\n\r\n  static removeUndefined(obj: object): any {\r\n    const output = {};\r\n    if (ObjectUtils.isObject(obj)) {\r\n      Object.keys(obj)\r\n        .filter(key => obj[key] !== undefined)\r\n        .forEach(key => {\r\n          if (ObjectUtils.isObject(obj[key]) || Array.isArray(obj[key])) {\r\n            output[key] = ObjectUtils.removeUndefined(obj[key]);\r\n          } else {\r\n            output[key] = obj[key];\r\n          }\r\n        });\r\n\r\n      return output;\r\n    }\r\n\r\n    if (Array.isArray(obj)) {\r\n      return obj.map(o => ObjectUtils.removeUndefined(o));\r\n    }\r\n\r\n    return obj;\r\n  }\r\n\r\n  static removeNull(obj: object): any {\r\n    const output = {};\r\n    if (ObjectUtils.isObject(obj)) {\r\n      Object.keys(obj)\r\n        .filter(key => obj[key] !== null)\r\n        .forEach(key => {\r\n          if (ObjectUtils.isObject(obj[key]) || Array.isArray(obj[key])) {\r\n            output[key] = ObjectUtils.removeNull(obj[key]);\r\n          } else {\r\n            output[key] = obj[key];\r\n          }\r\n        });\r\n\r\n      return output;\r\n    }\r\n\r\n    if (Array.isArray(obj)) {\r\n      return obj.map(o => ObjectUtils.removeNull(o));\r\n    }\r\n\r\n    return obj;\r\n  }\r\n\r\n  static naturalCompare(a, b, direction = 'asc', nullsFirst?: boolean) {\r\n    if (direction === 'desc') {\r\n      b = [a, (a = b)][0];\r\n    }\r\n\r\n    // nullsFirst = undefined : end if direction = 'asc', first if direction = 'desc'\r\n    // nullsFirst = true : always first\r\n    // nullsFirst = false : always end\r\n    if (\r\n      a === null ||\r\n      a === '' ||\r\n      a === undefined ||\r\n      b === null ||\r\n      b === '' ||\r\n      b === undefined\r\n    ) {\r\n      const nullScore =\r\n        a === b\r\n          ? 0\r\n          : a === undefined\r\n          ? 3\r\n          : b === undefined\r\n          ? -3\r\n          : a === null\r\n          ? 2\r\n          : b === null\r\n          ? -2\r\n          : a === ''\r\n          ? 1\r\n          : -1;\r\n      if (direction === 'desc') {\r\n        return nullsFirst !== false ? nullScore : nullScore * -1;\r\n      }\r\n      return nullsFirst === true ? nullScore * -1 : nullScore;\r\n    }\r\n\r\n    const ax = [];\r\n    const bx = [];\r\n    a = '' + a;\r\n    b = '' + b;\r\n\r\n    a.replace(/(\\d+)|(\\D+)/g, (_, $1, $2) => {\r\n      ax.push([$1 || Infinity, $2 || '']);\r\n    });\r\n\r\n    b.replace(/(\\d+)|(\\D+)/g, (_, $1, $2) => {\r\n      bx.push([$1 || Infinity, $2 || '']);\r\n    });\r\n\r\n    while (ax.length && bx.length) {\r\n      const an = ax.shift();\r\n      const bn = bx.shift();\r\n      const nn = an[0] - bn[0] || an[1].localeCompare(bn[1]);\r\n      if (nn) {\r\n        return nn;\r\n      }\r\n    }\r\n\r\n    return ax.length - bx.length;\r\n  }\r\n\r\n  /**\r\n   * Return true if two object are equivalent.\r\n   * Objects are considered equivalent if they have the same properties and\r\n   * if all of their properties (first-level only) share the same value.\r\n   * @param obj1 First object\r\n   * @param obj2 Second object\r\n   * @returns Whether two objects arer equivalent\r\n   */\r\n  static objectsAreEquivalent(obj1: object, obj2: object): boolean {\r\n    if (obj1 === obj2) {\r\n      return true;\r\n    }\r\n\r\n    const obj1Props = Object.getOwnPropertyNames(obj1);\r\n    const obj2Props = Object.getOwnPropertyNames(obj2);\r\n    if (obj1Props.length !== obj2Props.length) {\r\n      return false;\r\n    }\r\n\r\n    for (const prop of obj1Props) {\r\n      if (obj1[prop] !== obj2[prop]) {\r\n        return false;\r\n      }\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Return a new object with an array of keys removed\r\n   * @param obj Source object\r\n   * @param keys Keys to remove\r\n   * @returns A new object\r\n   */\r\n  static removeKeys(obj: object, keys: string[]): object {\r\n    const newObj = Object.keys(obj)\r\n      .filter(key => keys.indexOf(key) < 0)\r\n      .reduce((_obj, key) => {\r\n        _obj[key] = obj[key];\r\n        return _obj;\r\n      }, {});\r\n\r\n    return newObj;\r\n  }\r\n}\r\n","export class NumberUtils {\r\n    static roundToNDecimal(num: number, decimal: number = 3): number {\r\n        const roundFactor = Math.pow(10, decimal);\r\n        return Math.round((num) * roundFactor) / roundFactor;\r\n    }\r\n}\r\n","/** Utility function to create a K:V from a list of strings */\r\nexport function strEnum<T extends string>(o: Array<T>): { [K in T]: K } {\r\n  return o.reduce((res, key) => {\r\n    res[key] = key;\r\n    return res;\r\n  }, Object.create(null));\r\n}\r\n","export function S4() {\r\n  // eslint-disable-next-line no-bitwise\r\n  return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);\r\n}\r\n\r\nexport function uuid() {\r\n  const id = `${S4()}${S4()}-${S4()}-${S4()}-${S4()}-${S4()}${S4()}${S4()}`;\r\n  return id.toLowerCase();\r\n}\r\n","import { Subject, Subscription } from 'rxjs';\r\nimport { distinctUntilChanged } from 'rxjs/operators';\r\n\r\nexport enum SubjectStatus {\r\n  Error = 0,\r\n  Done = 1,\r\n  Working = 2,\r\n  Waiting = 3\r\n}\r\n\r\nexport abstract class Watcher {\r\n  public status$ = new Subject<SubjectStatus>();\r\n  protected status$$: Subscription;\r\n\r\n  get status(): SubjectStatus {\r\n    return this._status;\r\n  }\r\n  set status(value: SubjectStatus) {\r\n    this._status = value;\r\n    this.status$.next(value);\r\n  }\r\n  private _status: SubjectStatus;\r\n\r\n  protected abstract watch();\r\n\r\n  protected abstract unwatch();\r\n\r\n  // eslint-disable-next-line @typescript-eslint/ban-types\r\n  subscribe(callback: Function, scope?: any) {\r\n    this.watch();\r\n\r\n    this.status$$ = this.status$\r\n      .pipe(distinctUntilChanged())\r\n      .subscribe((status: SubjectStatus) => {\r\n        this.handleStatusChange(status);\r\n        callback.call(scope, this);\r\n      });\r\n  }\r\n\r\n  unsubscribe() {\r\n    this.unwatch();\r\n    if (this.status$$ !== undefined) {\r\n      this.status$$.unsubscribe();\r\n      this.status$$ = undefined;\r\n    }\r\n    this.status = SubjectStatus.Waiting;\r\n  }\r\n\r\n  protected handleStatusChange(status: SubjectStatus) {}\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { uuid } from '@igo2/utils';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ActivityService {\r\n  public counter$ = new BehaviorSubject<number>(0);\r\n\r\n  private ids: string[] = [];\r\n\r\n  constructor() {}\r\n\r\n  register(): string {\r\n    const id = uuid();\r\n    this.ids.push(id);\r\n    this.counter$.next(this.ids.length);\r\n\r\n    return id;\r\n  }\r\n\r\n  unregister(id: string) {\r\n    const index = this.ids.indexOf(id);\r\n    if (index === -1) {\r\n      return;\r\n    }\r\n    this.ids.splice(index, 1);\r\n\r\n    this.counter$.next(this.ids.length);\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport {\r\n  HttpEvent,\r\n  HttpHandler,\r\n  HttpInterceptor,\r\n  HttpRequest\r\n} from '@angular/common/http';\r\n\r\nimport { Observable } from 'rxjs';\r\nimport { finalize } from 'rxjs/operators';\r\n\r\nimport { ActivityService } from './activity.service';\r\n\r\n@Injectable()\r\nexport class ActivityInterceptor implements HttpInterceptor {\r\n  constructor(private activityService: ActivityService) {}\r\n\r\n  intercept(\r\n    req: HttpRequest<any>,\r\n    next: HttpHandler\r\n  ): Observable<HttpEvent<any>> {\r\n    const activity = req.headers.get('activityInterceptor');\r\n    if (activity) {\r\n      const actReq = req.clone({\r\n        headers: req.headers.delete('activityInterceptor')\r\n      });\r\n      if (activity === 'false') {\r\n        return next.handle(actReq);\r\n      }\r\n    }\r\n\r\n    const id = this.activityService.register();\r\n\r\n    return next.handle(req).pipe(\r\n      finalize(() => {\r\n        this.activityService.unregister(id);\r\n      })\r\n    );\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { HTTP_INTERCEPTORS } from '@angular/common/http';\r\n\r\nimport { ActivityInterceptor } from './activity.interceptor';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [],\r\n  exports: []\r\n})\r\nexport class IgoActivityModule {\r\n  static forRoot(): ModuleWithProviders<IgoActivityModule> {\r\n    return {\r\n      ngModule: IgoActivityModule,\r\n      providers: [\r\n        {\r\n          provide: HTTP_INTERCEPTORS,\r\n          useClass: ActivityInterceptor,\r\n          multi: true\r\n        }\r\n      ]\r\n    };\r\n  }\r\n}\r\n","export interface Version {\r\n  lib: string;\r\n  releaseDate: number;\r\n}\r\n\r\nexport const version: Version = {\r\n  lib: '1.13.3',\r\n  releaseDate: 1668635669237\r\n};\r\n","import { Injectable, Injector } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { throwError } from 'rxjs';\r\nimport { catchError } from 'rxjs/operators';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport { ConfigOptions } from './config.interface';\r\nimport { version } from './version';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ConfigService {\r\n  private config: object = {};\r\n\r\n  constructor(private injector: Injector) {}\r\n\r\n  /**\r\n   * Use to get the data found in config file\r\n   */\r\n  public getConfig(key: string): any {\r\n    return ObjectUtils.resolve(this.config, key);\r\n  }\r\n\r\n  /**\r\n   * This method loads \"[path]\" to get all config's variables\r\n   */\r\n  public load(options: ConfigOptions) {\r\n    const baseConfig = options.default || {};\r\n    if (!options.path) {\r\n      this.config = baseConfig;\r\n      return true;\r\n    }\r\n\r\n    const http = this.injector.get(HttpClient);\r\n\r\n    return new Promise((resolve, _reject) => {\r\n      http\r\n        .get(options.path)\r\n        .pipe(\r\n          catchError((error: any): any => {\r\n            console.log(`Configuration file ${options.path} could not be read`);\r\n            resolve(true);\r\n            return throwError(error.error || 'Server error');\r\n          })\r\n        )\r\n        .subscribe((configResponse: object) => {\r\n          this.config = ObjectUtils.mergeDeep(\r\n            ObjectUtils.mergeDeep({ version }, baseConfig),\r\n            configResponse\r\n          );\r\n          resolve(true);\r\n        });\r\n    });\r\n  }\r\n}\r\n","import { APP_INITIALIZER, InjectionToken } from '@angular/core';\r\n\r\nimport { ConfigService } from './config.service';\r\nimport { ConfigOptions } from './config.interface';\r\n\r\nexport let CONFIG_OPTIONS = new InjectionToken<ConfigOptions>('configOptions');\r\n\r\nexport function provideConfigOptions(options: ConfigOptions) {\r\n  return {\r\n    provide: CONFIG_OPTIONS,\r\n    useValue: options\r\n  };\r\n}\r\n\r\nexport function configFactory(\r\n  configService: ConfigService,\r\n  options: ConfigOptions\r\n) {\r\n  return () => configService.load(options);\r\n}\r\n\r\nexport function provideConfigLoader() {\r\n  return {\r\n    provide: APP_INITIALIZER,\r\n    useFactory: configFactory,\r\n    multi: true,\r\n    deps: [ConfigService, CONFIG_OPTIONS]\r\n  };\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { provideConfigOptions, provideConfigLoader } from './config.provider';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [],\r\n  exports: []\r\n})\r\nexport class IgoConfigModule {\r\n  static forRoot(): ModuleWithProviders<IgoConfigModule> {\r\n    return {\r\n      ngModule: IgoConfigModule,\r\n      providers: [provideConfigOptions({}), provideConfigLoader()]\r\n    };\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\n\r\nimport { combineLatest } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { TranslateLoader } from '@ngx-translate/core';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport { ConfigService } from '../../config/config.service';\r\n\r\ndeclare function require(arg: string): any;\r\n\r\nexport class LanguageLoader implements TranslateLoader {\r\n  constructor(\r\n    private http: HttpClient,\r\n    private prefix?: string | string[],\r\n    private suffix: string = '.json',\r\n    private config?: ConfigService\r\n  ) {}\r\n\r\n  public getTranslation(lang: string): any {\r\n    const igoLocale$ = this.http.get(`locale/libs_locale/${lang}.json`);\r\n\r\n    if (this.config && !this.prefix) {\r\n      const prefix = this.config.getConfig('language.prefix');\r\n      this.prefix = !prefix || Array.isArray(prefix) ? prefix : [prefix];\r\n    }\r\n\r\n    if (!this.prefix || this.prefix.length === 0) {\r\n      return igoLocale$;\r\n    }\r\n\r\n    const appLocale$ = (this.prefix as string[]).map((prefix) =>\r\n      this.http.get(`${prefix}${lang}${this.suffix}`)\r\n    );\r\n\r\n    const locale$ = combineLatest([igoLocale$, ...appLocale$]);\r\n\r\n    return locale$.pipe(\r\n      map((translations) => {\r\n        return translations.reduce(\r\n          (acc, current) => ObjectUtils.mergeDeep(acc, current),\r\n          {}\r\n        );\r\n      })\r\n    );\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\nimport { TranslateLoader } from '@ngx-translate/core';\r\n\r\nimport { ConfigService } from '../../config/config.service';\r\nimport { LanguageLoader } from './language.loader';\r\n\r\nexport function defaultLanguageLoader(\r\n  http: HttpClient,\r\n  config?: ConfigService\r\n) {\r\n  return new LanguageLoader(http, undefined, undefined, config);\r\n}\r\n\r\nexport function provideLanguageLoader(loader?) {\r\n  return {\r\n    provide: TranslateLoader,\r\n    useFactory: loader || defaultLanguageLoader,\r\n    deps: [HttpClient]\r\n  };\r\n}\r\n\r\nexport function provideDefaultLanguageLoader(loader?) {\r\n  return {\r\n    provide: TranslateLoader,\r\n    useFactory: loader || defaultLanguageLoader,\r\n    deps: [HttpClient, ConfigService]\r\n  };\r\n}\r\n","import {\r\n  MissingTranslationHandler,\r\n  MissingTranslationHandlerParams\r\n} from '@ngx-translate/core';\r\n\r\nexport class IgoMissingTranslationHandler implements MissingTranslationHandler {\r\n  handle(params: MissingTranslationHandlerParams) {\r\n    if (!params.translateService.langs.length) {\r\n      const error =\r\n        'Translations are not yet loaded. \\\r\n         Check that the LanguageService is injected.';\r\n      throw new Error(error);\r\n    }\r\n\r\n    if (params.key.substr(0, 4) === 'igo.') {\r\n      throw new Error(`The Key \"${params.key}\" is missing in locale file.`);\r\n    } else {\r\n      return params.key;\r\n    }\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport {\r\n  TranslateModule,\r\n  MissingTranslationHandler\r\n} from '@ngx-translate/core';\r\n\r\nimport { provideDefaultLanguageLoader } from './shared/language.provider';\r\nimport { IgoMissingTranslationHandler } from './shared/missing-translation.guard';\r\n\r\n@NgModule({\r\n  imports: [\r\n    TranslateModule.forRoot({\r\n      missingTranslationHandler: {\r\n        provide: MissingTranslationHandler,\r\n        useClass: IgoMissingTranslationHandler\r\n      }\r\n    })\r\n  ],\r\n  declarations: [],\r\n  exports: [TranslateModule]\r\n})\r\nexport class IgoLanguageModule {\r\n  static forRoot(): ModuleWithProviders<IgoLanguageModule> {\r\n    return {\r\n      ngModule: IgoLanguageModule,\r\n      providers: [provideDefaultLanguageLoader()]\r\n    };\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { GlobalConfig, ToastrModule } from 'ngx-toastr';\r\n\r\n@NgModule({\r\n  imports: [CommonModule,\r\n    ToastrModule.forRoot({\r\n      positionClass: 'toast-bottom-right',\r\n      timeOut: 10000,\r\n      extendedTimeOut: 10000,\r\n      messageClass: 'toast-message mat-typography',\r\n      closeButton: true,\r\n      progressBar: true,\r\n      enableHtml: true,\r\n      tapToDismiss: true,\r\n      maxOpened: 4,\r\n      preventDuplicates: true,\r\n      resetTimeoutOnDuplicate: true,\r\n      countDuplicates: false,\r\n      includeTitleDuplicates: true\r\n    } as GlobalConfig)],\r\n  declarations: [],\r\n  exports: []\r\n})\r\nexport class IgoMessageModule {\r\n  static forRoot(): ModuleWithProviders<IgoMessageModule> {\r\n    return {\r\n      ngModule: IgoMessageModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","export enum MessageType {\r\n  ERROR = 'error',\r\n  ALERT = 'warning', // todo delete (transition to ngx-toastr)\r\n  WARNING = 'warning',\r\n  INFO = 'info',\r\n  SUCCESS = 'success',\r\n  SHOW = 'show'\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { TranslateService } from '@ngx-translate/core';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class LanguageService {\r\n  private language: string = this.translate.getBrowserLang();\r\n  readonly language$: BehaviorSubject<string> = new BehaviorSubject(undefined);\r\n\r\n  constructor(public translate: TranslateService) {\r\n    const lang = this.getLanguage();\r\n    this.translate.setDefaultLang(lang);\r\n    this.language$.next(lang);\r\n  }\r\n\r\n  public getLanguage(): string {\r\n    return this.language.match(/en|fr/) ? this.language : 'en';\r\n  }\r\n\r\n  public setLanguage(language: string) {\r\n    this.language = language.match(/en|fr/) ? language : 'en';\r\n    this.language$.next(this.language);\r\n    this.translate.use(this.language);\r\n    this.translate.reloadLang(this.language);\r\n  }\r\n}\r\n","import { Injectable, Inject, Injector } from '@angular/core';\r\nimport { HttpErrorResponse } from '@angular/common/http';\r\nimport { BehaviorSubject, forkJoin } from 'rxjs';\r\n\r\nimport { ConfigService } from '../../config/config.service';\r\n\r\nimport { Message, MessageOptions } from './message.interface';\r\nimport { ActiveToast, IndividualConfig, ToastrService } from 'ngx-toastr';\r\nimport { MessageType } from './message.enum';\r\nimport { LanguageService } from '../../language/shared/language.service';\r\nimport { debounceTime, first } from 'rxjs/operators';\r\n\r\ninterface ActiveMessageTranslation {\r\n  id: number;\r\n  titleKey: string;\r\n  textKey: string;\r\n  textInterpolateParams?: Object\r\n  titleInterpolateParams?: Object\r\n}\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class MessageService {\r\n  public messages$ = new BehaviorSubject<Message[]>([]);\r\n  private options: MessageOptions;\r\n  private activeMessageTranslations: ActiveMessageTranslation[] = [];\r\n\r\n  constructor(\r\n    @Inject(Injector) private injector: Injector,\r\n    private configService: ConfigService,\r\n    private languageService: LanguageService\r\n  ) {\r\n    this.options = this.configService.getConfig('message') || {};\r\n    this.languageService.language$.pipe(debounceTime(500)).subscribe(r => {\r\n      if (this.toastr.toasts.length === 0) {\r\n        this.activeMessageTranslations = [];\r\n      }\r\n      this.toastr.toasts.map(toast => {\r\n        const activeMessageTranslation = this.activeMessageTranslations.find(amt => amt.id === toast.toastId);\r\n        if (activeMessageTranslation) {\r\n          const translatedTextInterpolateParams = {...activeMessageTranslation.textInterpolateParams};\r\n          const translatedTitleInterpolateParams = {...activeMessageTranslation.titleInterpolateParams};\r\n\r\n          if (activeMessageTranslation.textInterpolateParams) {\r\n            Object.keys(activeMessageTranslation.textInterpolateParams).map(k => {\r\n              translatedTextInterpolateParams[k] =\r\n                this.languageService.translate.instant(activeMessageTranslation.textInterpolateParams[k]);\r\n            });\r\n          }\r\n          if (activeMessageTranslation.titleInterpolateParams) {\r\n            Object.keys(activeMessageTranslation.titleInterpolateParams).map(k => {\r\n              translatedTitleInterpolateParams[k] =\r\n                this.languageService.translate.instant(activeMessageTranslation.titleInterpolateParams[k]);\r\n            });\r\n          }\r\n\r\n\r\n          forkJoin([\r\n          this.languageService.translate.get(activeMessageTranslation.textKey, translatedTextInterpolateParams),\r\n          this.languageService.translate.get(activeMessageTranslation.titleKey, translatedTitleInterpolateParams)\r\n        ]).pipe(first()).subscribe((res: [string, string]) => {\r\n          toast.toastRef.componentInstance.message = res[0];\r\n          toast.toastRef.componentInstance.title = res[1];\r\n        });\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  private get toastr(): ToastrService {\r\n    return this.injector.get(ToastrService);\r\n  }\r\n\r\n  showError(httpError: HttpErrorResponse) {\r\n    httpError.error.caught = true;\r\n    return this.error(httpError.error.message, httpError.error.title);\r\n  }\r\n\r\n  message(message: Message) {\r\n    const messageType = message.type;\r\n    this.toastr.toastrConfig.iconClasses[messageType] = `toast-${messageType}`;\r\n\r\n    this.messages$.next(this.messages$.value.concat([message]));\r\n\r\n    message.options = message.options || {} as MessageOptions;\r\n    const currentDate = new Date();\r\n\r\n    message.options.from = message.options.from ? message.options.from : new Date('1 jan 1900');\r\n    message.options.to = message.options.to ? message.options.to : new Date('1 jan 3000');\r\n    if (typeof message.options.from === 'string') {\r\n      message.options.from = new Date(Date.parse(message.options.from.replace(/-/g, ' ')));\r\n    }\r\n    if (typeof message.options.to === 'string') {\r\n      message.options.to = new Date(Date.parse(message.options.to.replace(/-/g, ' ')));\r\n    }\r\n    if (currentDate > message.options.from && currentDate < message.options.to) {\r\n      if (message.showIcon === false) {\r\n        this.toastr.toastrConfig.iconClasses[messageType] = `toast-${messageType} toast-no-icon`;\r\n      }\r\n      message = this.handleTemplate(message);\r\n\r\n      if (message.text) {\r\n        let messageShown: ActiveToast<any>;\r\n        switch (message.type) {\r\n          case MessageType.SUCCESS:\r\n            messageShown = this.success(\r\n              message.text,\r\n              message.title,\r\n              message.options,\r\n              message.textInterpolateParams,\r\n              message.titleInterpolateParams);\r\n            break;\r\n          case MessageType.ERROR:\r\n            messageShown = this.error(\r\n              message.text,\r\n              message.title,\r\n              message.options,\r\n              message.textInterpolateParams,\r\n              message.titleInterpolateParams);\r\n            break;\r\n          case MessageType.INFO:\r\n            messageShown = this.info(\r\n              message.text,\r\n              message.title,\r\n              message.options,\r\n              message.textInterpolateParams,\r\n              message.titleInterpolateParams);\r\n            break;\r\n          case MessageType.SHOW:\r\n            messageShown = this.show(\r\n              message.text,\r\n              message.title,\r\n              message.options,\r\n              message.textInterpolateParams,\r\n              message.titleInterpolateParams);\r\n            break;\r\n          case MessageType.ALERT:\r\n          case MessageType.WARNING:\r\n            messageShown = this.alert(\r\n              message.text,\r\n              message.title,\r\n              message.options,\r\n              message.textInterpolateParams,\r\n              message.titleInterpolateParams);\r\n            break;\r\n          default:\r\n            messageShown = this.info(\r\n              message.text,\r\n              message.title,\r\n              message.options,\r\n              message.textInterpolateParams,\r\n              message.titleInterpolateParams);\r\n            break;\r\n        }\r\n        message.options.id = messageShown.toastId;\r\n      }\r\n    }\r\n  }\r\n\r\n  success(\r\n    text: string,\r\n    title: string = 'igo.core.message.success',\r\n    options: Partial<IndividualConfig> = {},\r\n    textInterpolateParams?: Object,\r\n    titleInterpolateParams?: Object): ActiveToast<any> {\r\n    return this.handleNgxToastr('success', text, title, options, textInterpolateParams, titleInterpolateParams);\r\n  }\r\n\r\n  error(\r\n    text: string,\r\n    title: string = 'igo.core.message.error',\r\n    options: Partial<IndividualConfig> = {},\r\n    textInterpolateParams?: Object,\r\n    titleInterpolateParams?: Object): ActiveToast<any> {\r\n    return this.handleNgxToastr('error', text, title, options, textInterpolateParams, titleInterpolateParams);\r\n  }\r\n\r\n  info(\r\n    text: string,\r\n    title: string = 'igo.core.message.info',\r\n    options: Partial<IndividualConfig> = {},\r\n    textInterpolateParams?: Object,\r\n    titleInterpolateParams?: Object): ActiveToast<any> {\r\n    return this.handleNgxToastr('info', text, title, options, textInterpolateParams, titleInterpolateParams);\r\n  }\r\n\r\n  alert(\r\n    text: string,\r\n    title: string = 'igo.core.message.alert',\r\n    options: Partial<IndividualConfig> = {},\r\n    textInterpolateParams?: Object,\r\n    titleInterpolateParams?: Object): ActiveToast<any> {\r\n    return this.handleNgxToastr('alert', text, title, options, textInterpolateParams, titleInterpolateParams);\r\n  }\r\n\r\n  show(\r\n    text: string,\r\n    title: string = 'igo.core.message.info',\r\n    options: Partial<IndividualConfig> = {},\r\n    textInterpolateParams?: Object,\r\n    titleInterpolateParams?: Object): ActiveToast<any> {\r\n    return this.handleNgxToastr('show', text, title, options, textInterpolateParams, titleInterpolateParams);\r\n  }\r\n\r\n  private handleNgxToastr(\r\n    type: 'alert' | 'info' | 'error' | 'success' | 'show',\r\n    text: string,\r\n    title: string,\r\n    options: Partial<IndividualConfig> = {},\r\n    textInterpolateParams?: Object,\r\n    titleInterpolateParams?: Object): ActiveToast<any> {\r\n\r\n    const translatedTextInterpolateParams = {...textInterpolateParams};\r\n    const translatedTitlenterpolateParams = {...titleInterpolateParams};\r\n\r\n    if (textInterpolateParams) {\r\n      Object.keys(textInterpolateParams).map(k => {\r\n        translatedTextInterpolateParams[k] =\r\n          this.languageService.translate.instant(textInterpolateParams[k]);\r\n      });\r\n    }\r\n    if (titleInterpolateParams) {\r\n      Object.keys(titleInterpolateParams).map(k => {\r\n        translatedTitlenterpolateParams[k] =\r\n          this.languageService.translate.instant(titleInterpolateParams[k]);\r\n      });\r\n    }\r\n\r\n\r\n    const message = this.languageService.translate.instant(text, translatedTextInterpolateParams);\r\n    const translatedTitle = this.languageService.translate.instant(title, translatedTitlenterpolateParams);\r\n\r\n    let activeToast;\r\n    switch (type) {\r\n      case 'success':\r\n        activeToast = this.toastr.success(message, translatedTitle, options);\r\n        break;\r\n      case 'error':\r\n        activeToast = this.toastr.error(message, translatedTitle, options);\r\n        break;\r\n      case 'show':\r\n      case 'info':\r\n        activeToast = this.toastr.info(message, translatedTitle, options);\r\n        break;\r\n      case 'alert':\r\n        activeToast = this.toastr.warning(message, translatedTitle, options);\r\n        break;\r\n    }\r\n    this.activeMessageTranslations.push({\r\n      id: activeToast.toastId,\r\n      titleKey: title,\r\n      textKey: text,\r\n      textInterpolateParams,\r\n      titleInterpolateParams });\r\n    return activeToast;\r\n\r\n  }\r\n\r\n  remove(id?: number) {\r\n    this.toastr.remove(id);\r\n  }\r\n\r\n  removeAllAreNotError() {\r\n    for (const mess of this.messages$.value) {\r\n      if (mess.type !== MessageType.ERROR) {\r\n        this.remove(mess.options.id);\r\n      }\r\n    }\r\n  }\r\n\r\n  private handleTemplate(message: Message): Message {\r\n    if (!this.options.template || message.html) {\r\n      return message;\r\n    }\r\n\r\n    let html = this.options.template;\r\n    html = html.replace('${text}', message.text);\r\n    html = html.replace('${title}', message.title);\r\n\r\n    message.html = undefined;\r\n    message.text = html;\r\n    message.title = undefined;\r\n    return message;\r\n  }\r\n}\r\n","import { Injectable, Injector } from '@angular/core';\r\nimport {\r\n  HttpInterceptor,\r\n  HttpHandler,\r\n  HttpRequest,\r\n  HttpEvent,\r\n  HttpErrorResponse\r\n} from '@angular/common/http';\r\n\r\nimport { Observable, throwError } from 'rxjs';\r\nimport { catchError, finalize } from 'rxjs/operators';\r\n\r\nimport { MessageService } from '../message/shared/message.service';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ErrorInterceptor implements HttpInterceptor {\r\n  constructor(\r\n    private injector: Injector\r\n  ) {}\r\n\r\n  intercept(\r\n    originalReq: HttpRequest<any>,\r\n    next: HttpHandler\r\n  ): Observable<HttpEvent<any>> {\r\n    const interceptError = originalReq.headers.get('interceptError');\r\n    const req = originalReq.clone({\r\n      headers: originalReq.headers.delete('interceptError')\r\n    });\r\n    if (interceptError === 'false') {\r\n      return next.handle(req);\r\n    }\r\n    const errorContainer = { httpError: undefined };\r\n    return next.handle(req).pipe(\r\n      catchError(error => this.handleError(error, errorContainer)),\r\n      finalize(() => {\r\n        this.handleCaughtError(errorContainer);\r\n        this.handleUncaughtError(errorContainer);\r\n      })\r\n    );\r\n  }\r\n\r\n  private handleError(\r\n    httpError: HttpErrorResponse,\r\n    errorContainer: { httpError: HttpErrorResponse }\r\n  ) {\r\n    if (httpError instanceof HttpErrorResponse) {\r\n      const errorObj = httpError.error === 'object' ? httpError.error : {};\r\n      errorObj.message = httpError.error.message || httpError.statusText;\r\n      errorObj.caught = false;\r\n\r\n      httpError = new HttpErrorResponse({\r\n        error: errorObj,\r\n        headers: httpError.headers,\r\n        status: httpError.status,\r\n        statusText: httpError.statusText,\r\n        url: httpError.url\r\n      });\r\n    }\r\n\r\n    errorContainer.httpError = httpError;\r\n    return throwError(httpError);\r\n  }\r\n\r\n  private handleCaughtError(errorContainer: { httpError: HttpErrorResponse }) {\r\n    const httpError = errorContainer.httpError;\r\n    if (httpError && httpError.error.toDisplay) {\r\n      httpError.error.caught = true;\r\n      const messageService = this.injector.get(MessageService);\r\n       messageService.error(httpError.error.message, httpError.error.title);\r\n    }\r\n  }\r\n\r\n  private handleUncaughtError(errorContainer: {\r\n    httpError: HttpErrorResponse;\r\n  }) {\r\n    const httpError = errorContainer.httpError;\r\n    if (httpError && !httpError.error.caught) {\r\n      const messageService = this.injector.get(MessageService);\r\n      httpError.error.caught = true;\r\n      messageService.error('igo.core.errors.uncaught.message', 'igo.core.errors.uncaught.title');\r\n    }\r\n  }\r\n}\r\n","import {\r\n  NgModule,\r\n  ModuleWithProviders,\r\n  Optional,\r\n  SkipSelf\r\n} from '@angular/core';\r\nimport { HTTP_INTERCEPTORS } from '@angular/common/http';\r\n\r\nimport { ErrorInterceptor } from './error.interceptor';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [],\r\n  exports: []\r\n})\r\nexport class IgoErrorModule {\r\n  static forRoot(): ModuleWithProviders<IgoErrorModule> {\r\n    return {\r\n      ngModule: IgoErrorModule,\r\n      providers: [\r\n        {\r\n          provide: HTTP_INTERCEPTORS,\r\n          useClass: ErrorInterceptor,\r\n          multi: true\r\n        }\r\n      ]\r\n    };\r\n  }\r\n\r\n  constructor(@Optional() @SkipSelf() parentModule: IgoErrorModule) {\r\n    if (parentModule) {\r\n      throw new Error(\r\n        'IgoErrorModule is already loaded. Import it in the AppModule only'\r\n      );\r\n    }\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { HttpClientModule } from '@angular/common/http';\r\nimport { DomSanitizer } from '@angular/platform-browser';\r\nimport { MatIconRegistry } from '@angular/material/icon';\r\n\r\nimport { IgoActivityModule } from './activity/activity.module';\r\nimport { IgoConfigModule } from './config/config.module';\r\nimport { IgoLanguageModule } from './language/language.module';\r\nimport { IgoMessageModule } from './message/message.module';\r\nimport { IgoErrorModule } from './request/error.module';\r\nimport { DBConfig, NgxIndexedDBModule } from 'ngx-indexed-db';\r\n\r\nconst dbConfig: DBConfig = {\r\n  name: 'igo2DB',\r\n  version: 1,\r\n  objectStoresMeta: [{\r\n    store: 'geoData',\r\n    storeConfig: { keyPath: 'url', autoIncrement: false },\r\n    storeSchema: [\r\n      { name: 'regionID', keypath: 'regionID', options: { unique: false }}\r\n    ]\r\n  }]\r\n};\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    HttpClientModule,\r\n    IgoActivityModule.forRoot(),\r\n    IgoConfigModule.forRoot(),\r\n    IgoErrorModule.forRoot(),\r\n    IgoLanguageModule.forRoot(),\r\n    IgoMessageModule.forRoot(),\r\n    NgxIndexedDBModule.forRoot(dbConfig)\r\n  ],\r\n  declarations: [],\r\n  exports: [\r\n    IgoActivityModule,\r\n    IgoConfigModule,\r\n    IgoErrorModule,\r\n    IgoLanguageModule,\r\n    IgoMessageModule\r\n  ]\r\n})\r\nexport class IgoCoreModule {\r\n  static forRoot(): ModuleWithProviders<IgoCoreModule> {\r\n    return {\r\n      ngModule: IgoCoreModule,\r\n      providers: []\r\n    };\r\n  }\r\n\r\n  constructor(matIconRegistry: MatIconRegistry, domSanitizer: DomSanitizer) {\r\n    matIconRegistry.addSvgIconSet(\r\n      domSanitizer.bypassSecurityTrustResourceUrl(\r\n        './assets/igo2/core/icons/mdi.svg'\r\n      )\r\n    );\r\n  }\r\n}\r\n","import { Injectable, Inject, InjectionToken, Optional } from '@angular/core';\r\nimport { ActivatedRoute, Params, Router } from '@angular/router';\r\nimport { Observable } from 'rxjs';\r\n\r\nimport { RouteServiceOptions } from './route.interface';\r\n\r\nexport let ROUTE_SERVICE_OPTIONS = new InjectionToken<RouteServiceOptions>(\r\n  'routeServiceOptions'\r\n);\r\n\r\nexport function provideRouteServiceOptions(options: RouteServiceOptions) {\r\n  return {\r\n    provide: ROUTE_SERVICE_OPTIONS,\r\n    useValue: options\r\n  };\r\n}\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class RouteService {\r\n  public options: RouteServiceOptions;\r\n\r\n  constructor(\r\n    private router: Router,\r\n    public route: ActivatedRoute,\r\n    @Inject(ROUTE_SERVICE_OPTIONS)\r\n    @Optional()\r\n    options: RouteServiceOptions\r\n  ) {\r\n    const defaultOptions = {\r\n      centerKey: 'center',\r\n      zoomKey: 'zoom',\r\n      projectionKey: 'projection',\r\n      contextKey: 'context',\r\n      searchKey: 'search',\r\n      visibleOnLayersKey: 'visiblelayers',\r\n      visibleOffLayersKey: 'invisiblelayers',\r\n      directionsCoordKey: 'routing',\r\n      directionsOptionsKey: 'routingOptions',\r\n      toolKey: 'tool',\r\n      wmsUrlKey: 'wmsUrl',\r\n      wmsLayersKey:  'wmsLayers',\r\n      wmtsUrlKey: 'wmtsUrl',\r\n      wmtsLayersKey:  'wmtsLayers',\r\n      arcgisUrlKey: 'arcgisUrl',\r\n      arcgisLayersKey:  'arcgisLayers',\r\n      iarcgisUrlKey: 'iarcgisUrl',\r\n      iarcgisLayersKey:  'iarcgisLayers',\r\n      tarcgisUrlKey: 'tarcgisUrl',\r\n      tarcgisLayersKey:  'tarcgisLayers',\r\n      vectorKey: 'vector'\r\n    };\r\n    this.options = Object.assign({}, defaultOptions, options);\r\n  }\r\n\r\n  get queryParams(): Observable<Params> {\r\n    let url = decodeURIComponent(location.search);\r\n    if (url.includes('er=')) {\r\n      url = url.replace('er', '&center');\r\n      const queryParams: any = url\r\n      .slice(1)\r\n      .split('&')\r\n      .map(p => p.split('='))\r\n      .reduce((obj, pair) => {\r\n        const [key, value] = pair.map(decodeURIComponent);\r\n        obj[key] = value;\r\n        return obj;\r\n      }, {});\r\n      this.router.navigate([], { queryParams });\r\n    }\r\n    return this.route.queryParams;\r\n  }\r\n}\r\n","export enum Media {\r\n  Mobile = 'mobile',\r\n  Tablet = 'tablet',\r\n  Desktop = 'desktop'\r\n}\r\n\r\nexport enum MediaOrientation {\r\n  Portrait = 'portrait',\r\n  Landscape = 'landscape'\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { Breakpoints, BreakpointObserver } from '@angular/cdk/layout';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { Media, MediaOrientation } from './media.enum';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class MediaService {\r\n  public media$ = new BehaviorSubject<Media>(undefined);\r\n  public orientation$ = new BehaviorSubject<MediaOrientation>(undefined);\r\n\r\n  constructor(breakpointObserver: BreakpointObserver) {\r\n    breakpointObserver\r\n      .observe([Breakpoints.HandsetLandscape])\r\n      .subscribe(res => {\r\n        if (res.matches) {\r\n          this.media$.next(Media.Mobile);\r\n          this.orientation$.next(MediaOrientation.Landscape);\r\n        }\r\n      });\r\n\r\n    breakpointObserver.observe([Breakpoints.HandsetPortrait]).subscribe(res => {\r\n      if (res.matches) {\r\n        this.media$.next(Media.Mobile);\r\n        this.orientation$.next(MediaOrientation.Portrait);\r\n      }\r\n    });\r\n\r\n    breakpointObserver.observe([Breakpoints.TabletLandscape]).subscribe(res => {\r\n      if (res.matches) {\r\n        this.media$.next(Media.Tablet);\r\n        this.orientation$.next(MediaOrientation.Landscape);\r\n      }\r\n    });\r\n\r\n    breakpointObserver.observe([Breakpoints.TabletPortrait]).subscribe(res => {\r\n      if (res.matches) {\r\n        this.media$.next(Media.Tablet);\r\n        this.orientation$.next(MediaOrientation.Portrait);\r\n      }\r\n    });\r\n\r\n    breakpointObserver.observe([Breakpoints.WebLandscape]).subscribe(res => {\r\n      if (res.matches) {\r\n        this.media$.next(Media.Desktop);\r\n        this.orientation$.next(MediaOrientation.Landscape);\r\n      }\r\n    });\r\n\r\n    breakpointObserver.observe([Breakpoints.WebPortrait]).subscribe(res => {\r\n      if (res.matches) {\r\n        this.media$.next(Media.Desktop);\r\n        this.orientation$.next(MediaOrientation.Portrait);\r\n      }\r\n    });\r\n  }\r\n\r\n  getMedia(): Media {\r\n    return this.media$.value;\r\n  }\r\n\r\n  getOrientation(): MediaOrientation {\r\n    return this.orientation$.value;\r\n  }\r\n\r\n  isTouchScreen(): boolean {\r\n    return 'ontouchstart' in document.documentElement ? true : false;\r\n  }\r\n\r\n  isMobile(): boolean {\r\n    const media = this.getMedia();\r\n    return media === 'mobile';\r\n  }\r\n\r\n  isDesktop(): boolean {\r\n    const media = this.getMedia();\r\n    return media === 'desktop';\r\n  }\r\n}\r\n","export enum StorageScope {\r\n  SESSION = 'Session',\r\n  LOCAL = 'Local'\r\n}\r\n\r\nexport interface StorageOptions {\r\n  key: string;\r\n}\r\n\r\nexport interface StorageServiceEvent {\r\n  key?: string;\r\n  scope: StorageScope;\r\n  event: StorageServiceEventEnum;\r\n  previousValue?: any;\r\n  currentValue?: any;\r\n}\r\n\r\nexport enum StorageServiceEventEnum {\r\n  ADDED = 'Added',\r\n  MODIFIED = 'Modified',\r\n  REMOVED = 'Removed',\r\n  CLEARED = 'Cleared'\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { ConfigService } from '../config/config.service';\r\nimport { StorageScope, StorageOptions, StorageServiceEvent, StorageServiceEventEnum } from './storage.interface';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class StorageService {\r\n  protected options: StorageOptions;\r\n\r\n  public storageChange$: BehaviorSubject<StorageServiceEvent> = new BehaviorSubject(undefined);\r\n\r\n  constructor(private config: ConfigService) {\r\n    this.options = this.config.getConfig('storage') || { key: 'igo' };\r\n  }\r\n  /**\r\n   * Use to get the data found in storage file\r\n   */\r\n  get(key: string, scope?: StorageScope): string | object | boolean | number {\r\n    let value: any;\r\n\r\n    if (!scope || scope === StorageScope.SESSION) {\r\n      value = sessionStorage.getItem(`${this.options.key}.${key}`);\r\n    }\r\n\r\n    if (scope === StorageScope.LOCAL || (!value && !scope)) {\r\n      value = localStorage.getItem(`${this.options.key}.${key}`);\r\n    }\r\n\r\n    if (value) {\r\n      try {\r\n        value = JSON.parse(value);\r\n      } catch {\r\n        value = value;\r\n      }\r\n    }\r\n\r\n    return value;\r\n  }\r\n\r\n  set(\r\n    key: string,\r\n    value: string | object | boolean | number,\r\n    scope: StorageScope = StorageScope.LOCAL\r\n  ) {\r\n    const previousValue = this.get(key, scope);\r\n    if (scope === StorageScope.SESSION) {\r\n      sessionStorage.setItem(\r\n        `${this.options.key}.${key}`,\r\n        JSON.stringify(value)\r\n      );\r\n    } else {\r\n      localStorage.setItem(`${this.options.key}.${key}`, JSON.stringify(value));\r\n    }\r\n    const currentValue = this.get(key, scope);\r\n\r\n    if (currentValue !== previousValue) {\r\n      this.storageChange$.next({\r\n        key, scope,\r\n        event: previousValue !== undefined ? StorageServiceEventEnum.MODIFIED : StorageServiceEventEnum.ADDED,\r\n        previousValue,\r\n        currentValue\r\n      });\r\n    }\r\n  }\r\n\r\n  remove(key: string, scope: StorageScope = StorageScope.LOCAL) {\r\n    const previousValue = this.get(key, scope);\r\n    if (scope === StorageScope.SESSION) {\r\n      sessionStorage.removeItem(`${this.options.key}.${key}`);\r\n    } else {\r\n      localStorage.removeItem(`${this.options.key}.${key}`);\r\n    }\r\n    this.storageChange$.next({key, scope, event: StorageServiceEventEnum.REMOVED, previousValue });\r\n  }\r\n\r\n  clear(scope: StorageScope = StorageScope.LOCAL) {\r\n    if (scope === StorageScope.SESSION) {\r\n      sessionStorage.clear();\r\n    } else {\r\n      localStorage.clear();\r\n    }\r\n    this.storageChange$.next({scope, event: StorageServiceEventEnum.CLEARED });\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { Observable, Observer } from 'rxjs';\r\nimport { CompressedData } from './compressedData.interface';\r\n\r\nfunction getNumber(v: number, endposition: number, length: number) {\r\n  /* tslint:disable:no-bitwise*/\r\n  const mask = ((1 << length) - 1);\r\n  return (v >> endposition) & mask;\r\n  /* tslint:enable:no-bitwise*/\r\n}\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class CompressionService {\r\n  private base64Index = new Map<string, number>();\r\n  private indexBase64 = new Map<number, string>();\r\n\r\n  constructor() {\r\n    this.generateBase64Index();\r\n  }\r\n\r\n  private generateBase64Index() {\r\n    // https://fr.wikipedia.org/wiki/Base64\r\n    // A-Z => [0, 25]\r\n    for (let i = 0; i < 26; i++) {\r\n      this.base64Index.set(String.fromCharCode('A'.charCodeAt(0) + i), i);\r\n      this.indexBase64.set(i, String.fromCharCode('A'.charCodeAt(0) + i));\r\n    }\r\n    // a-z => [26, 51]\r\n    for (let i = 0; i < 26; i++) {\r\n      this.base64Index.set(String.fromCharCode('a'.charCodeAt(0) + i), i + 26);\r\n      this.indexBase64.set(i + 26, String.fromCharCode('a'.charCodeAt(0) + i));\r\n    }\r\n    // 0-9 => [52, 61]\r\n    for (let i = 0; i < 10; i++) {\r\n      this.base64Index.set(String.fromCharCode('0'.charCodeAt(0) + i), i + 52);\r\n      this.indexBase64.set(i + 52, String.fromCharCode('0'.charCodeAt(0) + i));\r\n    }\r\n    // + / => [62, 63]\r\n    this.base64Index.set('+', 62);\r\n    this.base64Index.set('/', 63);\r\n    this.indexBase64.set(62, '+');\r\n    this.indexBase64.set(63, '/');\r\n  }\r\n\r\n  compressBlob(blob: Blob): Observable<CompressedData> {\r\n    if (!blob) {\r\n      return;\r\n    }\r\n\r\n    const observable = new Observable((observer: Observer<CompressedData>) => {\r\n      const reader = new FileReader();\r\n      reader.readAsDataURL(blob);\r\n      reader.onload = () => {\r\n        const base64 = reader.result.valueOf() as string;\r\n        const text64 = base64.substr(base64.indexOf(',') + 1);\r\n        const compressed = this.compressStringBase64(text64);\r\n        const compressedData: CompressedData = { length: text64.length,\r\n                                                 type: blob.type,\r\n                                                 object: compressed };\r\n        observer.next(compressedData);\r\n      };\r\n    });\r\n    return observable;\r\n  }\r\n\r\n  decompressBlob(compressedData: CompressedData): Blob {\r\n    /* tslint:disable:no-bitwise*/\r\n    const object = compressedData.object;\r\n    const length = compressedData.length;\r\n    const decompressed: string = this.decompressStringBase64(object, length);\r\n    const byteCharacters = atob(decompressed);\r\n    const byteNumbers = new Array(byteCharacters.length);\r\n    for (let i = 0; i < byteCharacters.length; i++) {\r\n        byteNumbers[i] = byteCharacters.charCodeAt(i);\r\n    }\r\n    const byteArray = new Uint8Array(byteNumbers);\r\n    const blob = new Blob([byteArray], {type: compressedData.type});\r\n    /* tslint:enable:no-bitwise*/\r\n    return blob;\r\n  }\r\n\r\n  private compressStringBase64(s: string): string {\r\n    /* tslint:disable:no-bitwise*/\r\n    let out = '';\r\n    let bits = 16;\r\n    let chr = 0;\r\n    let rem = 0;\r\n    for (const c of s) {\r\n      const value = this.base64Index.get(c);\r\n      if (bits > 6) {\r\n        bits -= 6;\r\n        chr += value << bits;\r\n      } else {\r\n        rem = 6 - bits;\r\n        chr += value >> rem;\r\n        out += String.fromCharCode(chr);\r\n        chr = (value) << (16 - rem);\r\n        bits = 16 - rem;\r\n      }\r\n    }\r\n    if (s.length % 8 !== 0) {\r\n      out += String.fromCharCode(chr);\r\n    }\r\n    /* tslint:enable:no-bitwise*/\r\n    return String.fromCharCode(9731) + out;\r\n  }\r\n\r\n  private decompressStringBase64(c: string, length: number): string {\r\n     /* tslint:disable:no-bitwise*/\r\n    if (!c) {\r\n      return;\r\n    }\r\n\r\n    if (c.charCodeAt(0) !== 9731) {\r\n      return c;\r\n    }\r\n\r\n    let chr = 0;\r\n    let rem = 0;\r\n    let bits = 16;\r\n    let out = '';\r\n    let j = 1;\r\n    let value = c.charCodeAt(j);\r\n    for (let i = 0; i < length; i++) {\r\n      if (bits > 6) {\r\n        bits -= 6;\r\n        chr = getNumber(value, bits, 6);\r\n        out += this.indexBase64.get(chr);\r\n      } else {\r\n        rem = 6 - bits;\r\n        chr = getNumber(value, 0, bits) << rem;\r\n        value = c.charCodeAt(++j);\r\n        chr += getNumber(value, 16 - rem, rem);\r\n        out += this.indexBase64.get(chr);\r\n        bits = 16 - rem;\r\n      }\r\n    }\r\n    return out;\r\n    /* tslint:enable:no-bitwise*/\r\n  }\r\n}\r\n","import { Injectable, EventEmitter, OnDestroy, Injector } from '@angular/core';\r\nimport { Observable, Subscription, fromEvent } from 'rxjs';\r\nimport { debounceTime, startWith } from 'rxjs/operators';\r\n\r\nimport { MessageService } from '../message/shared/message.service';\r\nimport { LanguageService } from '../language/shared/language.service';\r\nimport { ConnectionState } from './network.interfaces';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class NetworkService implements OnDestroy {\r\n  private stateChangeEventEmitter = new EventEmitter<ConnectionState>();\r\n  private onlineSubscription: Subscription;\r\n  private offlineSubscription: Subscription;\r\n  private previousMessageId;\r\n\r\n  private state: ConnectionState = {\r\n    connection: window.navigator.onLine\r\n  };\r\n\r\n  constructor(\r\n    private messageService: MessageService,\r\n    private injector: Injector\r\n  ) {\r\n      this.checkNetworkState();\r\n  }\r\n\r\n  private checkNetworkState() {\r\n    this.onlineSubscription = fromEvent(window, 'online').subscribe(() => {\r\n      if (this.previousMessageId) {\r\n        this.messageService.remove(this.previousMessageId);\r\n      }\r\n      const translate = this.injector.get(LanguageService).translate;\r\n      const message = translate.instant('igo.core.network.online.message');\r\n      const title = translate.instant('igo.core.network.online.title');\r\n      const messageObj = this.messageService.info(message, title);\r\n      this.previousMessageId = messageObj.toastId;\r\n      this.state.connection = true;\r\n      this.emitEvent();\r\n    });\r\n\r\n    this.offlineSubscription = fromEvent(window, 'offline').subscribe(() => {\r\n      if (this.previousMessageId) {\r\n        this.messageService.remove(this.previousMessageId);\r\n      }\r\n      const translate = this.injector.get(LanguageService).translate;\r\n      const message = translate.instant('igo.core.network.offline.message');\r\n      const title = translate.instant('igo.core.network.offline.title');\r\n      const messageObj = this.messageService.info(message, title);\r\n      this.previousMessageId = messageObj.toastId;\r\n      this.state.connection = false;\r\n      this.emitEvent();\r\n    });\r\n  }\r\n\r\n  private emitEvent() {\r\n    this.stateChangeEventEmitter.emit(this.state);\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    try {\r\n      this.offlineSubscription.unsubscribe();\r\n      this.onlineSubscription.unsubscribe();\r\n    } catch (e) {}\r\n  }\r\n\r\n  currentState(reportState = true): Observable<ConnectionState> {\r\n    return reportState\r\n      ? this.stateChangeEventEmitter.pipe(\r\n          debounceTime(300),\r\n          startWith(this.state)\r\n        )\r\n      : this.stateChangeEventEmitter.pipe(debounceTime(300));\r\n  }\r\n}\r\n","export enum EntityOperationType {\r\n  Insert = 'Insert',\r\n  Update = 'Update',\r\n  Delete = 'Delete'\r\n}\r\n\r\nexport enum EntityTableColumnRenderer {\r\n  Default = 'Default',\r\n  HTML = 'HTML',\r\n  UnsanitizedHTML = 'UnsanitizedHTML',\r\n  Editable = 'Editable',\r\n  Icon = 'Icon',\r\n  ButtonGroup = 'ButtonGroup'\r\n}\r\n\r\nexport enum EntityTableScrollBehavior {\r\n  Auto = 'auto',\r\n  Instant = 'instant',\r\n  Smooth = 'smooth'\r\n}\r\n\r\nexport enum EntityTableSelectionState {\r\n  None = 'None',\r\n  All = 'All',\r\n  Some = 'Some'\r\n}\r\n","import { t } from 'typy';\r\n\r\nimport { EntityKey } from './entity.interfaces';\r\n\r\n/**\r\n * Get an entity's named property. Nested properties are supported\r\n * with the dotted notation. (i.e 'author.name')\r\n *\r\n * Note: this method is a 'best attempt' at getting an entity's property.\r\n * It fits the most common cases but you might need to explicitely define\r\n * a property getter when using an EntityStore, for example.\r\n * @param entity Entity\r\n * @param property Property name\r\n * @returns Property value\r\n */\r\nexport function getEntityProperty(entity: object, property: string): any {\r\n  return t(entity, property).safeObject;\r\n}\r\n\r\n/**\r\n * Get an entity's id. An entity's id can be one of:\r\n * 'entity.meta.id', 'entity.meta.idProperty' or 'entity.id'.\r\n *\r\n * Note: See the note in the 'getEntityProperty' documentation.\r\n * @param entity Entity\r\n * @returns Entity id\r\n */\r\nexport function getEntityId(entity: object): EntityKey {\r\n  const meta = (entity as any).meta || {};\r\n  return meta.id ? meta.id : getEntityProperty(entity, meta.idProperty || 'id');\r\n}\r\n\r\n/**\r\n * Get an entity's title. An entity's title can be one of:\r\n * 'entity.meta.title', 'entity.meta.titleProperty' or 'entity.title'.\r\n * @param entity Entity\r\n * @returns Entity title\r\n */\r\nexport function getEntityTitle(entity: object): string {\r\n  const meta = (entity as any).meta || {};\r\n  return meta.title ? meta.title : getEntityProperty(entity, meta.titleProperty || 'title');\r\n}\r\n\r\n/**\r\n * Get an entity's HTML title. An entity's HTML title can be one of:\r\n * 'entity.meta.titleHtml', 'entity.meta.titleHtmlProperty' or 'entity.titleHtml'.\r\n * @param entity Entity\r\n * @returns Entity HTML title\r\n */\r\nexport function getEntityTitleHtml(entity: object): string {\r\n  const meta = (entity as any).meta || {};\r\n  return meta.titleHtml ? meta.titleHtml : getEntityProperty(entity, meta.titleHtmlProperty || 'titleHtml');\r\n}\r\n\r\n/**\r\n * Get an entity's icon. An entity's icon can be one of:\r\n * 'entity.meta.icon', 'entity.meta.iconProperty' or 'entity.icon'.\r\n * @param entity Entity\r\n * @returns Entity icon\r\n */\r\nexport function getEntityIcon(entity: object): string {\r\n  const meta = (entity as any).meta || {};\r\n  return meta.icon ? meta.icon : getEntityProperty(entity, meta.iconProperty || 'icon');\r\n}\r\n\r\n/**\r\n * Get an entity's revision.\r\n * @param entity Entity\r\n * @returns Entity revision\r\n */\r\nexport function getEntityRevision(entity: object): number {\r\n  const meta = (entity as any).meta || {};\r\n  return meta.revision || 0;\r\n}\r\n","import { ReplaySubject } from 'rxjs';\r\n\r\nimport { EntityKey, EntityState, EntityStateManagerOptions } from './entity.interfaces';\r\nimport { getEntityId } from './entity.utils';\r\nimport { EntityStore } from './store';\r\n\r\n/**\r\n * This class is used to track a store's entities state\r\n */\r\nexport class EntityStateManager<E extends object, S extends EntityState = EntityState> {\r\n\r\n  /**\r\n   * State index\r\n   */\r\n  readonly index = new Map<EntityKey, S>();\r\n\r\n  /**\r\n   * Change emitter\r\n   */\r\n  readonly change$ = new ReplaySubject<void>(1);\r\n\r\n  /**\r\n   * Method to get an entity's id\r\n   */\r\n  readonly getKey: (E) => EntityKey;\r\n\r\n  private store: EntityStore<object> | undefined;\r\n\r\n  constructor(options: EntityStateManagerOptions = {}) {\r\n    this.store = options.store ? options.store : undefined;\r\n    this.getKey = options.getKey\r\n      ? options.getKey\r\n      : (this.store ? this.store.getKey : getEntityId);\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Clear state\r\n   */\r\n  clear() {\r\n    if (this.index.size > 0) {\r\n      this.index.clear();\r\n      this.next();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get an entity's state\r\n   * @param entity Entity\r\n   * @returns State\r\n   */\r\n  get(entity: E): S {\r\n    return (this.index.get(this.getKey(entity)) || {}) as S;\r\n  }\r\n\r\n  /**\r\n   * Set an entity's state\r\n   * @param entity Entity\r\n   * @param state State\r\n   */\r\n  set(entity: E, state: S) {\r\n    this.setMany([entity], state);\r\n  }\r\n\r\n  /**\r\n   * Set many entitie's state\r\n   * @param entitie Entities\r\n   * @param state State\r\n   */\r\n  setMany(entities: E[], state: S) {\r\n    entities.forEach((entity: E) => {\r\n      this.index.set(this.getKey(entity), Object.assign({}, state));\r\n    });\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Set state of all entities that already have a state. This is not\r\n   * the same as setting the state of all the store's entities.\r\n   * @param state State\r\n   */\r\n  setAll(state: S) {\r\n    Array.from(this.index.keys()).forEach((key: EntityKey) => {\r\n      this.index.set(key, Object.assign({}, state));\r\n    });\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Update an entity's state\r\n   * @param entity Entity\r\n   * @param changes State changes\r\n   */\r\n  update(entity: E, changes: Partial<S>, exclusive = false) {\r\n    this.updateMany([entity], changes, exclusive);\r\n  }\r\n\r\n  /**\r\n   * Update many entitie's state\r\n   * @param entitie Entities\r\n   * @param changes State changes\r\n   */\r\n  updateMany(entities: E[], changes: Partial<S>, exclusive = false) {\r\n    if (exclusive === true) {\r\n      return this.updateManyExclusive(entities, changes);\r\n    }\r\n\r\n    entities.forEach((entity: E) => {\r\n      const state = Object.assign({}, this.get(entity), changes);\r\n      this.index.set(this.getKey(entity), state);\r\n    });\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Reversee an entity's state\r\n   * @param entity Entity\r\n   * @param keys State keys to reverse\r\n   */\r\n  reverse(entity: E, keys: string[]) {\r\n    this.reverseMany([entity], keys);\r\n  }\r\n\r\n  /**\r\n   * Reverse many entitie's state\r\n   * @param entitie Entities\r\n   * @param keys State keys to reverse\r\n   */\r\n  reverseMany(entities: E[], keys: string[]) {\r\n    entities.forEach((entity: E) => {\r\n      const currentState = this.get(entity);\r\n      const changes = keys.reduce((acc: {[key: string]: boolean}, key: string) => {\r\n        acc[key] = currentState[key] || false;\r\n        return acc;\r\n      }, {}) as Partial<S>;\r\n      const reversedChanges = this.reverseChanges(changes);\r\n      const state = Object.assign({}, currentState, reversedChanges);\r\n      this.index.set(this.getKey(entity), state);\r\n    });\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Update state of all entities that already have a state. This is not\r\n   * the same as updating the state of all the store's entities.\r\n   * @param changes State\r\n   */\r\n  updateAll(changes: Partial<S>) {\r\n    const allKeys = this.getAllKeys();\r\n    Array.from(allKeys).forEach((key: EntityKey) => {\r\n      const state = Object.assign({}, this.index.get(key), changes);\r\n      this.index.set(key, state);\r\n    });\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * When some state changes are flagged as 'exclusive', reverse\r\n   * the state of all other entities. Changes are reversable when\r\n   * they are boolean.\r\n   * @param entitie Entities\r\n   * @param changes State changes\r\n   */\r\n  private updateManyExclusive(entities: E[], changes: Partial<S>) {\r\n    const reverseChanges = this.reverseChanges(changes);\r\n\r\n    const keys = entities.map((entity: E) => this.getKey(entity));\r\n    const allKeys = new Set(keys.concat(Array.from(this.getAllKeys())));\r\n    allKeys.forEach((key: EntityKey) => {\r\n      const state = this.index.get(key) || {} as S;\r\n\r\n      if (keys.indexOf(key) >= 0) {\r\n        this.index.set(key, Object.assign({}, state, changes));\r\n      } else {\r\n        // Update only if the reverse changes would modify\r\n        // a key already present in the current state\r\n        const shouldUpdate = Object.keys(reverseChanges).some((changeKey: string) => {\r\n          return state[changeKey] !== undefined &&\r\n            state[changeKey] !== reverseChanges[changeKey];\r\n        });\r\n        if (shouldUpdate === true) {\r\n          this.index.set(key, Object.assign({}, state, reverseChanges));\r\n        }\r\n      }\r\n    });\r\n\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Compute a 'reversed' version of some state changes.\r\n   * Changes are reversable when they are boolean.\r\n   * @param changes State changes\r\n   * @returns Reversed state changes\r\n   */\r\n  private reverseChanges(changes: Partial<S>): Partial<S> {\r\n    return Object.entries(changes).reduce((reverseChanges: Partial<S>, bunch: [string, any]) => {\r\n      const [changeKey, value] = bunch;\r\n      if (typeof value === typeof true) {\r\n        (reverseChanges as object)[changeKey] = !value;\r\n      }\r\n      return reverseChanges;\r\n    }, {});\r\n  }\r\n\r\n  /**\r\n   * Return all the keys in that state and in the store it's bound to, if any.\r\n   * @returns Set of keys\r\n   */\r\n  private getAllKeys(): Set<EntityKey> {\r\n    const storeKeys = this.store ? Array.from(this.store.index.keys()) : [];\r\n    return new Set(Array.from(this.index.keys()).concat(storeKeys));\r\n  }\r\n\r\n  /**\r\n   * Emit 'change' event\r\n   */\r\n  private next() {\r\n    this.change$.next();\r\n  }\r\n\r\n}\r\n","import { BehaviorSubject, Observable, Subscription, combineLatest } from 'rxjs';\r\nimport { debounceTime, map, skip } from 'rxjs/operators';\r\n\r\nimport { ObjectUtils, uuid } from '@igo2/utils';\r\nimport {\r\n  EntityKey,\r\n  EntityFilterClause,\r\n  EntitySortClause,\r\n  EntityJoinClause\r\n} from './entity.interfaces';\r\n\r\n/**\r\n * An entity view streams entities from an observable source. These entities\r\n * can be filtered or sorted without affecting the source. A view can also\r\n * combine data from multiple sources, joined together.\r\n */\r\nexport class EntityView<E extends object, V extends object = E> {\r\n\r\n  /**\r\n   * Observable stream of values\r\n   */\r\n  readonly values$ = new BehaviorSubject<V[]>([]);\r\n\r\n  /**\r\n   * Subscription to the source (and joined sources) values\r\n   */\r\n  private values$$: Subscription;\r\n\r\n  /**\r\n   * Whether this view has been lifted\r\n   */\r\n  private lifted = false;\r\n\r\n  /**\r\n   * Join clauses\r\n   */\r\n  private joins: EntityJoinClause[] = [];\r\n\r\n  /**\r\n   * Observable of a filter clause\r\n   */\r\n  private filter$ = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Observable of filter clauses\r\n   */\r\n  private filters$: BehaviorSubject<EntityFilterClause[]> = new BehaviorSubject([]);\r\n\r\n  /**\r\n   * Filters index\r\n   */\r\n  private filterIndex: Map<string, EntityFilterClause> = new Map();\r\n\r\n  /**\r\n   * Observable of a sort clause\r\n   */\r\n  private sort$ = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Method for indexing\r\n   */\r\n  get getKey(): (V) => EntityKey { return this.getKey$.value; }\r\n  private getKey$: BehaviorSubject<(V) => EntityKey> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Number of entities\r\n   */\r\n  readonly count$ = new BehaviorSubject<number>(0);\r\n  get count(): number { return this.count$.value; }\r\n\r\n  /**\r\n   * Whether the store is empty\r\n   */\r\n  readonly empty$ = new BehaviorSubject<boolean>(true);\r\n  get empty(): boolean { return this.empty$.value; }\r\n\r\n  /**\r\n   * Store index\r\n   */\r\n  get index(): Map<EntityKey, V> { return this._index; }\r\n  private _index: Map<EntityKey, V>;\r\n\r\n  constructor(private source$: BehaviorSubject<E[]>) {}\r\n\r\n  /**\r\n   * Get a value from the view by key\r\n   * @param key Key\r\n   * @returns Value\r\n   */\r\n  get(key: EntityKey): V {\r\n    if (this._index === undefined) {\r\n      throw new Error('This view has no index, therefore, this method is unavailable.');\r\n    }\r\n    return this.index.get(key);\r\n  }\r\n\r\n  /**\r\n   * Get all the values\r\n   * @returns Array of values\r\n   */\r\n  all(): V[] {\r\n    return this.values$.value;\r\n  }\r\n\r\n  /**\r\n   * Observe all the values\r\n   * @returns Observable of values\r\n   */\r\n  all$(): BehaviorSubject<V[]> {\r\n    return this.values$;\r\n  }\r\n\r\n  /**\r\n   * Get the first value that respects a criteria\r\n   * @returns A value\r\n   */\r\n  firstBy(clause: EntityFilterClause<V>): V {\r\n    return this.values$.value.find(clause);\r\n  }\r\n\r\n  /**\r\n   * Observe the first value that respects a criteria\r\n   * @returns Observable of a value\r\n   */\r\n  firstBy$(clause: EntityFilterClause<V>): Observable<V> {\r\n    return this.values$.pipe(map((values: V[]) => values.find(clause)));\r\n  }\r\n\r\n  /**\r\n   * Get all the values that respect a criteria\r\n   * @returns Array of values\r\n   */\r\n  manyBy(clause: EntityFilterClause<V>): V[] {\r\n    return this.values$.value.filter(clause);\r\n  }\r\n\r\n  /**\r\n   * Observe all the values that respect a criteria\r\n   * @returns Observable of values\r\n   */\r\n  manyBy$(clause: EntityFilterClause<V>): Observable<V[]> {\r\n    return this.values$.pipe(map((values: V[]) => values.filter(clause)));\r\n  }\r\n\r\n  /**\r\n   * Clear the filter and sort and unsubscribe from the source\r\n   */\r\n  clear() {\r\n    this.filter(undefined);\r\n    this.sort(undefined);\r\n  }\r\n\r\n  destroy() {\r\n    if (this.values$$ !== undefined) {\r\n      this.values$$.unsubscribe();\r\n    }\r\n    this.clear();\r\n  }\r\n\r\n  /**\r\n   * Create an index\r\n   * @param getKey Method to get a value's id\r\n   * @returns The view\r\n   */\r\n  createIndex(getKey: (E) => EntityKey): EntityView<E, V> {\r\n    this._index = new Map();\r\n    this.getKey$.next(getKey);\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Join another source to the stream (chainable)\r\n   * @param clause Join clause\r\n   * @returns The view\r\n   */\r\n  join(clause: EntityJoinClause): EntityView<E, V> {\r\n    if (this.lifted === true) {\r\n      throw new Error('This view has already been lifted, therefore, no join is allowed.');\r\n    }\r\n    this.joins.push(clause);\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Filter values (chainable)\r\n   * @param clause Filter clause\r\n   * @returns The view\r\n   */\r\n  filter(clause: EntityFilterClause<V>): EntityView<E, V> {\r\n    this.filter$.next(clause);\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * @param clause Filter clause\r\n   * @returns The filter id\r\n   */\r\n  addFilter(clause: EntityFilterClause<V>): string {\r\n    const id = uuid();\r\n    this.filterIndex.set(id, clause);\r\n    this.filters$.next(Array.from(this.filterIndex.values()));\r\n    return id;\r\n  }\r\n\r\n  /**\r\n   * Remove a filter by id\r\n   * @param clause Filter clause\r\n   */\r\n  removeFilter(id: string) {\r\n    this.filterIndex.delete(id);\r\n    this.filters$.next(Array.from(this.filterIndex.values()));\r\n  }\r\n\r\n  /**\r\n   * Sort values (chainable)\r\n   * @param clauseSort clause\r\n   * @returns The view\r\n   */\r\n  sort(clause: EntitySortClause<V>): EntityView<E, V> {\r\n    this.sort$.next(clause);\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Create the final observable\r\n   * @returns Observable\r\n   */\r\n  lift() {\r\n    this.lifted = true;\r\n    const source$ = this.joins.length > 0 ? this.liftJoinedSource() : this.liftSource();\r\n    const observables$ = [\r\n      source$,\r\n      this.filters$,\r\n      this.filter$,\r\n      this.sort$,\r\n      this.getKey$\r\n    ];\r\n\r\n    this.values$$ = combineLatest(observables$)\r\n      .pipe(skip(1), debounceTime(5))\r\n      .subscribe((bunch: any[]) => {\r\n        const [_values, filters, filter, sort, getKey] = bunch;\r\n        const values = this.processValues(_values, filters, filter, sort);\r\n        const generateIndex = getKey !== undefined;\r\n        this.setValues(values, generateIndex);\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Create the source observable when no joins are defined\r\n   * @returns Observable\r\n   */\r\n  private liftSource(): Observable<V[]> {\r\n    return this.source$ as any as Observable<V[]>;\r\n  }\r\n\r\n  /**\r\n   * Create the source observable when joins are defined\r\n   * @returns Observable\r\n   */\r\n  private liftJoinedSource(): Observable<V[]> {\r\n    const sources$ = [this.source$, combineLatest(\r\n      this.joins.map((join: EntityJoinClause) => join.source)\r\n    )];\r\n\r\n    return combineLatest(sources$)\r\n      .pipe(\r\n        map((bunch: [E[], any[]]) => {\r\n          const [entities, joinData] = bunch;\r\n          return entities.reduce((values: V[], entity: E) => {\r\n            const value = this.computeJoinedValue(entity, joinData);\r\n            if (value !== undefined) {\r\n              values.push(value);\r\n            }\r\n            return values;\r\n          }, []);\r\n        })\r\n      );\r\n  }\r\n\r\n  /**\r\n   * Apply joins to a source's entity and return the final value\r\n   * @returns Final value\r\n   */\r\n  private computeJoinedValue(entity: E, joinData: any[]): V | undefined {\r\n    let value = entity as Partial<V>;\r\n    let joinIndex = 0;\r\n    while (value !== undefined && joinIndex < this.joins.length) {\r\n      value = this.joins[joinIndex].reduce(value, joinData[joinIndex]);\r\n      joinIndex += 1;\r\n    }\r\n    return value as V;\r\n  }\r\n\r\n  /**\r\n   * Filter and sort values before streaming them\r\n   * @param values Values\r\n   * @param filters Filter clauses\r\n   * @param filter Filter clause\r\n   * @param sort Sort clause\r\n   * @returns Filtered and sorted values\r\n   */\r\n  private processValues(\r\n    values: V[], filters: EntityFilterClause[], filter: EntityFilterClause, sort: EntitySortClause\r\n  ): V[] {\r\n    values = values.slice(0);\r\n    values = this.filterValues(values, filters.concat([filter]));\r\n    values = this.sortValues(values, sort);\r\n    return values;\r\n  }\r\n\r\n  /**\r\n   * Filter values\r\n   * @param values Values\r\n   * @param filters Filter clauses\r\n   * @returns Filtered values\r\n   */\r\n  private filterValues(values: V[], clauses: EntityFilterClause[]): V[] {\r\n    if (clauses.length === 0) { return values; }\r\n\r\n    return values\r\n      .filter((value: V) => {\r\n        return clauses\r\n          .filter((clause: EntityFilterClause) => clause !== undefined)\r\n          .every((clause: EntityFilterClause) => clause(value));\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Sort values\r\n   * @param values Values\r\n   * @param sort Sort clause\r\n   * @returns Sorted values\r\n   */\r\n  private sortValues(values: V[], clause: EntitySortClause): V[] {\r\n    if (clause === undefined) { return values; }\r\n    return values.sort((v1: V, v2: V) => {\r\n      return ObjectUtils.naturalCompare(\r\n        clause.valueAccessor(v1),\r\n        clause.valueAccessor(v2),\r\n        clause.direction,\r\n        clause.nullsFirst\r\n      );\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Set value and optionally generate an index\r\n   * @param values Values\r\n   * @param generateIndex boolean\r\n   */\r\n  private setValues(values: V[], generateIndex: boolean) {\r\n    if (generateIndex === true) {\r\n      this._index = this.generateIndex(values);\r\n    }\r\n\r\n    this.values$.next(values);\r\n\r\n    const count = values.length;\r\n    const empty = count === 0;\r\n    this.count$.next(count);\r\n    this.empty$.next(empty);\r\n  }\r\n\r\n  /**\r\n   * Generate a complete index of all the values\r\n   * @param entities Entities\r\n   * @returns Index\r\n   */\r\n  private generateIndex(values: V[]): Map<EntityKey, V> {\r\n    const entries = values.map((value: V) => [this.getKey(value), value]);\r\n    return new Map(entries as [EntityKey, V][]);\r\n  }\r\n}\r\n","import { BehaviorSubject } from 'rxjs';\r\n\r\nimport { EntityStateManager } from './state';\r\nimport { EntityView } from './view';\r\nimport { EntityKey, EntityState, EntityRecord, EntityStoreOptions } from './entity.interfaces';\r\nimport { getEntityId, getEntityProperty } from './entity.utils';\r\nimport { EntityStoreStrategy } from './strategies/strategy';\r\n\r\n/**\r\n * An entity store class holds any number of entities\r\n * as well as their state. It can be observed, filtered and sorted and\r\n * provides methods to insert, update or delete entities.\r\n */\r\nexport class EntityStore<E extends object = object, S extends EntityState = EntityState> {\r\n\r\n  /**\r\n   * Observable of the raw entities\r\n   */\r\n  readonly entities$ = new BehaviorSubject<E[]>([]);\r\n\r\n  /**\r\n   * Number of entities\r\n   */\r\n  readonly count$ = new BehaviorSubject<number>(0);\r\n  get count(): number { return this.count$.value; }\r\n\r\n  /**\r\n   * Whether the store is empty\r\n   */\r\n  readonly empty$ = new BehaviorSubject<boolean>(true);\r\n  get empty(): boolean { return this.empty$.value; }\r\n\r\n  /**\r\n   * Entity store state\r\n   */\r\n  readonly state: EntityStateManager<E, S>;\r\n\r\n  /**\r\n   * View of all the entities\r\n   */\r\n  readonly view: EntityView<E>;\r\n\r\n  /**\r\n   * View of all the entities and their state\r\n   */\r\n  readonly stateView: EntityView<E, EntityRecord<E, S>>;\r\n\r\n  /**\r\n   * Method to get an entity's id\r\n   */\r\n  readonly getKey: (E) => EntityKey;\r\n\r\n  /**\r\n   * Method to get an entity's named property\r\n   */\r\n  readonly getProperty: (E, prop: string) => any;\r\n\r\n  /**\r\n   * Store index\r\n   */\r\n  get index(): Map<EntityKey, E> { return this._index; }\r\n  private _index: Map<EntityKey, E>;\r\n\r\n  /**\r\n   * Store index\r\n   */\r\n  get pristine(): boolean { return this._pristine; }\r\n  private _pristine: boolean = true;\r\n\r\n  /**\r\n   * Strategies\r\n   */\r\n  private strategies: EntityStoreStrategy[] = [];\r\n\r\n  constructor(entities: E[], options: EntityStoreOptions = {}) {\r\n    this.getKey = options.getKey ? options.getKey : getEntityId;\r\n    this.getProperty = options.getProperty ? options.getProperty : getEntityProperty;\r\n\r\n    this.state = this.createStateManager();\r\n    this.view = this.createDataView();\r\n    this.stateView = this.createStateView();\r\n\r\n    this.view.lift();\r\n    this.stateView.lift();\r\n\r\n    if (entities.length > 0) {\r\n      this.load(entities);\r\n    } else {\r\n      this._index = this.generateIndex(entities);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get an entity from the store by key\r\n   * @param key Key\r\n   * @returns Entity\r\n   */\r\n  get(key: EntityKey): E {\r\n    return this.index.get(key);\r\n  }\r\n\r\n  /**\r\n   * Get all entities in the store\r\n   * @returns Array of entities\r\n   */\r\n  all(): E[] {\r\n    return this.entities$.value;\r\n  }\r\n\r\n  /**\r\n   * Set this store's entities\r\n   * @param entities Entities\r\n   */\r\n  load(entities: E[], pristine: boolean = true) {\r\n    this._index = this.generateIndex(entities);\r\n    this._pristine = pristine;\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Clear the store's entities but keep the state and views intact.\r\n   * Views won't return any data but future data will be subject to the\r\n   * current views filter and sort\r\n   */\r\n  softClear() {\r\n    if (this.index && this.index.size > 0) {\r\n      this.index.clear();\r\n      this._pristine = true;\r\n      this.next();\r\n    } else if (this.index) {\r\n      this.updateCount();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the store's entities, state and views\r\n   */\r\n  clear() {\r\n    this.stateView.clear();\r\n    this.view.clear();\r\n    this.state.clear();\r\n    this.softClear();\r\n  }\r\n\r\n  destroy() {\r\n    this.stateView.destroy();\r\n    this.view.destroy();\r\n    this.clear();\r\n  }\r\n\r\n  /**\r\n   * Insert an entity into the store\r\n   * @param entity Entity\r\n   */\r\n  insert(entity: E) {\r\n    this.insertMany([entity]);\r\n  }\r\n\r\n  /**\r\n   * Insert many entities into the store\r\n   * @param entities Entities\r\n   */\r\n  insertMany(entities: E[]) {\r\n    entities.forEach((entity: E) => this.index.set(this.getKey(entity), entity));\r\n    this._pristine = false;\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Update or insert an entity into the store\r\n   * @param entity Entity\r\n   */\r\n  update(entity: E) {\r\n    this.updateMany([entity]);\r\n  }\r\n\r\n  /**\r\n   * Update or insert many entities into the store\r\n   * @param entities Entities\r\n   */\r\n  updateMany(entities: E[]) {\r\n    entities.forEach((entity: E) => this.index.set(this.getKey(entity), entity));\r\n    this._pristine = false;\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Delete an entity from the store\r\n   * @param entity Entity\r\n   */\r\n  delete(entity: E) {\r\n    this.deleteMany([entity]);\r\n  }\r\n\r\n  /**\r\n   * Delete many entities from the store\r\n   * @param entities Entities\r\n   */\r\n  deleteMany(entities: E[]) {\r\n    entities.forEach((entity: E) => this.index.delete(this.getKey(entity)));\r\n    this._pristine = false;\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Add a strategy to this store\r\n   * @param strategy Entity store strategy\r\n   * @returns Entity store\r\n   */\r\n  addStrategy(strategy: EntityStoreStrategy, activate: boolean = false): EntityStore {\r\n    const existingStrategy = this.strategies.find((_strategy: EntityStoreStrategy) => {\r\n      return strategy.constructor === _strategy.constructor;\r\n    });\r\n    if (existingStrategy !== undefined) {\r\n      throw new Error('A strategy of this type already exists on that EntityStore.');\r\n    }\r\n\r\n    this.strategies.push(strategy);\r\n    strategy.bindStore(this);\r\n\r\n    if (activate === true) {\r\n      strategy.activate();\r\n    }\r\n\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Remove a strategy from this store\r\n   * @param strategy Entity store strategy\r\n   * @returns Entity store\r\n   */\r\n  removeStrategy(strategy: EntityStoreStrategy): EntityStore {\r\n    const index = this.strategies.indexOf(strategy);\r\n    if (index >= 0) {\r\n      this.strategies.splice(index, 1);\r\n      strategy.unbindStore(this);\r\n    }\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Return strategies of a given type\r\n   * @param type Entity store strategy class\r\n   * @returns Strategies\r\n   */\r\n  getStrategyOfType(type: typeof EntityStoreStrategy): EntityStoreStrategy {\r\n    return this.strategies.find((strategy: EntityStoreStrategy) => {\r\n      return strategy instanceof type;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Activate strategies of a given type\r\n   * @param type Entity store strategy class\r\n   */\r\n  activateStrategyOfType(type: typeof EntityStoreStrategy) {\r\n    const strategy = this.getStrategyOfType(type);\r\n    if (strategy !== undefined) {\r\n      strategy.activate();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Deactivate strategies of a given type\r\n   * @param type Entity store strategy class\r\n   */\r\n  deactivateStrategyOfType(type: typeof EntityStoreStrategy) {\r\n    const strategy = this.getStrategyOfType(type);\r\n    if (strategy !== undefined) {\r\n      strategy.deactivate();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Generate a complete index of all the entities\r\n   * @param entities Entities\r\n   * @returns Index\r\n   */\r\n  private generateIndex(entities: E[]): Map<EntityKey, E> {\r\n    const entries = entities.map((entity: E) => [this.getKey(entity), entity]);\r\n    return new Map(entries as [EntityKey, E][]);\r\n  }\r\n\r\n  /**\r\n   * Push the index's entities into the entities$ observable\r\n   */\r\n  private next() {\r\n    this.entities$.next(Array.from(this.index.values()));\r\n    this.updateCount();\r\n  }\r\n\r\n  /**\r\n   * Update the store's count and empty\r\n   */\r\n  private updateCount() {\r\n    const count = this.index.size;\r\n    const empty = count === 0;\r\n    this.count$.next(count);\r\n    this.empty$.next(empty);\r\n  }\r\n\r\n  /**\r\n   * Create the entity state manager\r\n   * @returns EntityStateManager\r\n   */\r\n  private createStateManager() {\r\n    return new EntityStateManager<E, S>({store: this});\r\n  }\r\n\r\n  /**\r\n   * Create the data view\r\n   * @returns EntityView<E>\r\n   */\r\n  private createDataView() {\r\n    return new EntityView<E>(this.entities$);\r\n  }\r\n\r\n  /**\r\n   * Create the state view\r\n   * @returns EntityView<EntityRecord<E>>\r\n   */\r\n  private createStateView() {\r\n    return new EntityView<E, EntityRecord<E, S>>(this.view.all$())\r\n      .join({\r\n        source: this.state.change$,\r\n        reduce: (entity: E): EntityRecord<E, S> => {\r\n          const key = this.getKey(entity);\r\n          const state = this.state.get(entity);\r\n          const currentRecord = this.stateView.get(key);\r\n\r\n          if (\r\n            currentRecord !== undefined &&\r\n            currentRecord.entity === entity &&\r\n            this.statesAreTheSame(currentRecord.state, state)\r\n          ) {\r\n            return currentRecord;\r\n          }\r\n\r\n          const revision = currentRecord ? currentRecord.revision + 1 : 1;\r\n          const ref = `${key}-${revision}`;\r\n          return {entity, state, revision, ref};\r\n        }\r\n      })\r\n      .createIndex((record: EntityRecord<E, S>) => this.getKey(record.entity));\r\n  }\r\n\r\n  private statesAreTheSame(currentState: S, newState: S): boolean {\r\n    if (currentState === newState) {\r\n      return true;\r\n    }\r\n\r\n    const currentStateIsEmpty = Object.keys(currentState).length === 0;\r\n    const newStateIsEmpty = Object.keys(newState).length === 0;\r\n    return currentStateIsEmpty && newStateIsEmpty;\r\n  }\r\n\r\n}\r\n","import { ChangeDetectorRef } from '@angular/core';\r\n\r\nimport { Subscription } from 'rxjs';\r\nimport { skip } from 'rxjs/operators';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\nimport { EntityKey } from './entity.interfaces';\r\n\r\nimport { EntityStore } from './store';\r\n\r\n/**\r\n * This class is used to synchronize a component's changes\r\n * detection with an EntityStore changes. For example, it is frequent\r\n * to have a component subscribe to a store's selected entity and, at the same time,\r\n * this component provides a way to select an entity with, let's say, a click.\r\n *\r\n * This class automatically handles those case and triggers the compoent's\r\n * change detection when needed.\r\n *\r\n * Note: If the component observes the store's stateView, a workspace is\r\n * probably not required because the stateView catches any changes to the\r\n * entities and their state.\r\n */\r\nexport class EntityStoreWatcher<E extends object> {\r\n\r\n  /**\r\n   * Component change detector\r\n   */\r\n  private cdRef: ChangeDetectorRef;\r\n\r\n  /**\r\n   * Entity store\r\n   */\r\n  private store: EntityStore<E>;\r\n\r\n  /**\r\n   * Component inner state\r\n   */\r\n  private innerStateIndex = new Map<EntityKey, {[key: string]: any}>();\r\n\r\n  /**\r\n   * Subscription to the store's entities\r\n   */\r\n  private entities$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to the store's state\r\n   */\r\n  private state$$: Subscription;\r\n\r\n  constructor(store?: EntityStore<E>, cdRef?: ChangeDetectorRef) {\r\n    this.setChangeDetector(cdRef);\r\n    this.setStore(store);\r\n  }\r\n\r\n  destroy() {\r\n    this.setChangeDetector(undefined);\r\n    this.setStore(undefined);\r\n  }\r\n\r\n  /**\r\n   * Bind this workspace to a store and start watching for changes\r\n   * @param store Entity store\r\n   */\r\n  setStore(store?: EntityStore<E>) {\r\n    if (store === undefined) {\r\n      this.teardownObservers();\r\n      this.innerStateIndex.clear();\r\n      this.store = undefined;\r\n      return;\r\n    }\r\n\r\n    this.setStore(undefined);\r\n    this.store = store;\r\n    this.setupObservers();\r\n    this.detectChanges();\r\n  }\r\n\r\n  /**\r\n   * Bind this workspace to a component's change detector\r\n   * @param cdRef Change detector\r\n   */\r\n  setChangeDetector(cdRef?: ChangeDetectorRef) {\r\n    this.cdRef = cdRef;\r\n  }\r\n\r\n  /**\r\n   * Set up observers on a store's entities and their state\r\n   * @param store Entity store\r\n   */\r\n  private setupObservers() {\r\n    this.teardownObservers();\r\n\r\n    this.entities$$ = this.store.entities$\r\n      .subscribe((entities: E[]) => this.onEntitiesChange(entities));\r\n\r\n    this.state$$ = this.store.state.change$\r\n      .pipe(skip(1))\r\n      .subscribe(() => this.onStateChange());\r\n  }\r\n\r\n  /**\r\n   * Teardown store observers\r\n   */\r\n  private teardownObservers() {\r\n    if (this.entities$$ !== undefined) {\r\n      this.entities$$.unsubscribe();\r\n    }\r\n    if (this.state$$ !== undefined) {\r\n      this.state$$.unsubscribe();\r\n    }\r\n    this.entities$$ = undefined;\r\n    this.state$$ = undefined;\r\n  }\r\n\r\n  /**\r\n   * When the entities change, always trigger the changes detection\r\n   */\r\n  private onEntitiesChange(entities: E[]) {\r\n    this.detectChanges();\r\n  }\r\n\r\n  /**\r\n   * When the entities state change, trigger the change detection\r\n   * only if the component has not handled these changes yet. For example,\r\n   * the component might have initiated thoses changes itself.\r\n   */\r\n  private onStateChange() {\r\n    let changesDetected = false;\r\n    const storeIndex = this.store.state.index;\r\n    const innerIndex = this.innerStateIndex;\r\n\r\n    if (storeIndex.size !== innerIndex.size) {\r\n      changesDetected = this.detectChanges();\r\n    }\r\n\r\n    const storeKeys = Array.from(storeIndex.keys());\r\n    for (const key of storeKeys) {\r\n      const storeValue = storeIndex.get(key);\r\n      const innerValue = innerIndex.get(key);\r\n      if (changesDetected === false) {\r\n        if (innerValue === undefined) {\r\n          changesDetected = this.detectChanges();\r\n        } else if (!ObjectUtils.objectsAreEquivalent(storeValue, innerValue)) {\r\n          changesDetected = this.detectChanges();\r\n        }\r\n      }\r\n\r\n      this.innerStateIndex.set(key, Object.assign({}, storeValue));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Trigger the change detection of the workspace is bound to a change detector\r\n   */\r\n  private detectChanges() {\r\n    if (this.cdRef !== undefined) {\r\n      this.cdRef.detectChanges();\r\n    }\r\n    return true;\r\n  }\r\n\r\n}\r\n","import { BehaviorSubject } from 'rxjs';\r\n\r\nimport { EntityStoreStrategyOptions } from '../entity.interfaces';\r\nimport { EntityStore } from '../store';\r\n\r\n/**\r\n * Entity store strategies. They can do pretty much anything during a store's\r\n * lifetime. For example, they may act as triggers when something happens.\r\n * Sharing a strategy is a good idea when multiple strategies would have\r\n * on cancelling effect on each other.\r\n *\r\n * At creation, strategy is inactive and needs to be manually activated.\r\n */\r\nexport class EntityStoreStrategy {\r\n\r\n  /**\r\n   * Feature store\r\n   * @internal\r\n   */\r\n  protected stores: EntityStore[] = [];\r\n\r\n  /**\r\n   * Whether this strategy is active\r\n   * @internal\r\n   */\r\n  get active(): boolean { return this.active$.value; }\r\n  readonly active$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  constructor(protected options: EntityStoreStrategyOptions = {}) {\r\n    this.options = options;\r\n  }\r\n\r\n  /**\r\n   * Activate the strategy. If it's already active, it'll be deactivated\r\n   * and activated again.\r\n   */\r\n  activate() {\r\n    if (this.active === true) {\r\n      this.doDeactivate();\r\n    }\r\n    this.active$.next(true);\r\n    this.doActivate();\r\n  }\r\n\r\n  /**\r\n   * Activate the strategy. If it's already active, it'll be deactivated\r\n   * and activated again.\r\n   */\r\n  deactivate() {\r\n    this.active$.next(false);\r\n    this.doDeactivate();\r\n  }\r\n\r\n  /**\r\n   * Bind this strategy to a store\r\n   * @param store Feature store\r\n   */\r\n  bindStore(store: EntityStore) {\r\n    if (this.stores.indexOf(store) < 0) {\r\n      this.stores.push(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from store\r\n   * @param store Feature store\r\n   */\r\n  unbindStore(store: EntityStore) {\r\n    const index = this.stores.indexOf(store);\r\n    if (index >= 0) {\r\n      this.stores.splice(index, 1);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Do the stataegy activation\r\n   * @internal\r\n   */\r\n  protected doActivate() {}\r\n\r\n  /**\r\n   * Do the strategy deactivation\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {}\r\n\r\n}\r\n","import { EntityStoreStrategyFuncOptions } from '../entity.interfaces';\r\nimport { EntityStore } from '../store';\r\nimport { EntityStoreStrategy } from './strategy';\r\n\r\n/**\r\n * When active, this strategy filters a store's stateView to return\r\n * selected entities only.\r\n */\r\nexport class EntityStoreFilterCustomFuncStrategy extends EntityStoreStrategy {\r\n\r\n  constructor(protected options: EntityStoreStrategyFuncOptions) {\r\n    super(options);\r\n  }\r\n\r\n  /**\r\n   * Store / filter ids map\r\n   */\r\n  private filters: Map<EntityStore, string> = new Map();\r\n\r\n  /**\r\n   * Bind this strategy to a store and start filtering it\r\n   * @param store Entity store\r\n   */\r\n  bindStore(store: EntityStore) {\r\n    super.bindStore(store);\r\n    if (this.active === true) {\r\n      this.filterStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from a store and stop filtering it\r\n   * @param store Entity store\r\n   */\r\n  unbindStore(store: EntityStore) {\r\n    super.unbindStore(store);\r\n    if (this.active === true) {\r\n      this.unfilterStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start filtering all stores\r\n   * @internal\r\n   */\r\n  protected doActivate() {\r\n    this.filterAll();\r\n  }\r\n\r\n  /**\r\n   * Stop filtering all stores\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {\r\n    this.unfilterAll();\r\n  }\r\n\r\n  /**\r\n   * Filter all stores\r\n   */\r\n  private filterAll() {\r\n    this.stores.forEach((store: EntityStore) => this.filterStore(store));\r\n  }\r\n\r\n  /**\r\n   * Unfilter all stores\r\n   */\r\n  private unfilterAll() {\r\n    this.stores.forEach((store: EntityStore) => this.unfilterStore(store));\r\n  }\r\n\r\n  /**\r\n   * Filter a store and add it to the filters map\r\n   */\r\n  private filterStore(store: EntityStore) {\r\n    this.filters.set(store, store.stateView.addFilter(this.options.filterClauseFunc));\r\n  }\r\n\r\n  /**\r\n   * Unfilter a store and delete it from the filters map\r\n   */\r\n  private unfilterStore(store: EntityStore) {\r\n    const filterId = this.filters.get(store);\r\n    if (filterId === undefined) {\r\n      return;\r\n    }\r\n\r\n    store.stateView.removeFilter(filterId);\r\n    this.filters.delete(store);\r\n  }\r\n}\r\n","import { EntityRecord } from '../entity.interfaces';\r\nimport { EntityStore } from '../store';\r\nimport { EntityStoreStrategy } from './strategy';\r\n\r\n/**\r\n * When active, this strategy filters a store's stateView to return\r\n * selected entities only.\r\n */\r\nexport class EntityStoreFilterSelectionStrategy extends EntityStoreStrategy {\r\n\r\n  /**\r\n   * Store / filter ids map\r\n   */\r\n  private filters: Map<EntityStore, string> = new Map();\r\n\r\n  /**\r\n   * Bind this strategy to a store and start filtering it\r\n   * @param store Entity store\r\n   */\r\n  bindStore(store: EntityStore) {\r\n    super.bindStore(store);\r\n    if (this.active === true) {\r\n      this.filterStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from a store and stop filtering it\r\n   * @param store Entity store\r\n   */\r\n  unbindStore(store: EntityStore) {\r\n    super.unbindStore(store);\r\n    if (this.active === true) {\r\n      this.unfilterStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start filtering all stores\r\n   * @internal\r\n   */\r\n  protected doActivate() {\r\n    this.filterAll();\r\n  }\r\n\r\n  /**\r\n   * Stop filtering all stores\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {\r\n    this.unfilterAll();\r\n  }\r\n\r\n  /**\r\n   * Filter all stores\r\n   */\r\n  private filterAll() {\r\n    this.stores.forEach((store: EntityStore) => this.filterStore(store));\r\n  }\r\n\r\n  /**\r\n   * Unfilter all stores\r\n   */\r\n  private unfilterAll() {\r\n    this.stores.forEach((store: EntityStore) => this.unfilterStore(store));\r\n  }\r\n\r\n  /**\r\n   * Filter a store and add it to the filters map\r\n   */\r\n  private filterStore(store: EntityStore) {\r\n    if (this.filters.has(store)) {\r\n      return;\r\n    }\r\n\r\n    const filter = (record: EntityRecord<object>) => {\r\n      return record.state.selected === true;\r\n    };\r\n    this.filters.set(store, store.stateView.addFilter(filter));\r\n  }\r\n\r\n  /**\r\n   * Unfilter a store and delete it from the filters map\r\n   */\r\n  private unfilterStore(store: EntityStore) {\r\n    const filterId = this.filters.get(store);\r\n    if (filterId === undefined) {\r\n      return;\r\n    }\r\n\r\n    store.stateView.removeFilter(filterId);\r\n    this.filters.delete(store);\r\n  }\r\n}\r\n","<mat-form-field class=\"igo-entity-selector\">\r\n  <mat-select\r\n    [disabled]=\"disabled\"\r\n    [value]=\"selected$ | async\"\r\n    [multiple]=\"multi\"\r\n    [placeholder]=\"placeholder\"\r\n    (selectionChange)=\"onSelectionChange($event)\">\r\n    <mat-option *ngIf=\"emptyText !== undefined && multi === false\" [value]=\"emptyValue\">{{emptyText}}</mat-option>\r\n    <mat-option *ngIf=\"multi === true\" [value]=\"multiSelectValue\">{{multiText$ | async}}</mat-option>\r\n    <ng-template ngFor let-record [ngForOf]=\"store.stateView.all$() | async\">\r\n      <mat-option [value]=\"record.entity\">\r\n        {{titleAccessor(record.entity)}}\r\n      </mat-option>\r\n    </ng-template>\r\n  </mat-select>\r\n</mat-form-field>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\nimport { EntityRecord } from '../shared/entity.interfaces';\r\nimport { EntityStore } from '../shared/store';\r\nimport { EntityStoreWatcher } from '../shared/watcher';\r\nimport { getEntityTitle } from '../shared/entity.utils';\r\n\r\n@Component({\r\n  selector: 'igo-entity-selector',\r\n  templateUrl: './entity-selector.component.html',\r\n  styleUrls: ['./entity-selector.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class EntitySelectorComponent implements OnInit, OnDestroy {\r\n\r\n  /**\r\n   * The selected entity\r\n   * @internal\r\n   */\r\n  readonly selected$ = new BehaviorSubject<object>(undefined);\r\n\r\n  /**\r\n   * The current multi select option text\r\n   * @internal\r\n   */\r\n  readonly multiText$ = new BehaviorSubject<string>(undefined);\r\n\r\n  readonly multiSelectValue = {id: 'IGO_MULTI_SELECT'};\r\n\r\n  readonly emptyValue = {id: 'IGO_EMPTY_SELECT'};\r\n\r\n  /**\r\n   * Subscription to the selected entity\r\n   */\r\n  private selected$$: Subscription;\r\n\r\n  /**\r\n   * Store watcher\r\n   */\r\n  private watcher: EntityStoreWatcher<object>;\r\n\r\n  /**\r\n   * Entity store\r\n   */\r\n  @Input() store: EntityStore<object>;\r\n\r\n  /**\r\n   * Title accessor\r\n   */\r\n  @Input() titleAccessor: (object) => string = getEntityTitle;\r\n\r\n  /**\r\n   * Text to display when nothing is selected\r\n   */\r\n  @Input() emptyText: string = undefined;\r\n\r\n  /**\r\n   * Wheter selecting many entities is allowed\r\n   */\r\n  @Input() multi: boolean = false;\r\n\r\n  /**\r\n   * Text to display for the select all option\r\n   */\r\n  @Input() multiAllText: string = 'All';\r\n\r\n  /**\r\n   * Text to display for the select none option\r\n   */\r\n  @Input() multiNoneText: string = 'None';\r\n\r\n  /**\r\n   * Field placeholder\r\n   */\r\n  @Input() placeholder: string;\r\n\r\n  /**\r\n   * Wheter the selector is disabled or not\r\n   */\r\n  @Input() disabled: boolean = false;\r\n\r\n  /**\r\n   * Event emitted when the selection changes\r\n   */\r\n  @Output() selectedChange = new EventEmitter<{\r\n    selected: boolean;\r\n    value: object | object[];\r\n  }>();\r\n\r\n  constructor(private cdRef: ChangeDetectorRef) {}\r\n\r\n  /**\r\n   * Create a store watcher and subscribe to the selected entity\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.watcher = new EntityStoreWatcher(this.store, this.cdRef);\r\n\r\n    this.selected$$ = this.store.stateView\r\n      .manyBy$((record: EntityRecord<object>) => record.state.selected === true)\r\n      .subscribe((records: EntityRecord<object>[]) => {\r\n        const entities = records.map((record: EntityRecord<object>) => record.entity);\r\n        this.onSelectFromStore(entities);\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to the selected entity and destroy the store watcher\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.watcher.destroy();\r\n    this.selected$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * On selection change, update the store's state and emit an event\r\n   * @internal\r\n   */\r\n  onSelectionChange(event: {value: object | undefined}) {\r\n    const values = event.value instanceof Array ? event.value : [event.value];\r\n\r\n    const multiSelect = values.find((_value: object) => _value === this.multiSelectValue);\r\n    let entities = values.filter((_value: object) => _value !== this.multiSelectValue);\r\n    if (multiSelect !== undefined) {\r\n      if (entities.length === this.store.count) {\r\n        entities = [];\r\n      } else if (entities.length < this.store.count) {\r\n        entities = this.store.all();\r\n      }\r\n    }\r\n\r\n    entities = entities.filter((entity: object) => entity !== this.emptyValue);\r\n    if (entities.length === 0) {\r\n      this.store.state.updateAll({selected: false});\r\n    } else {\r\n      this.store.state.updateMany(entities, {selected: true}, true);\r\n    }\r\n\r\n    const value = this.multi ? entities : event.value;\r\n    this.selectedChange.emit({selected: true, value});\r\n  }\r\n\r\n  private onSelectFromStore(entities: object[]) {\r\n    if (this.multi === true) {\r\n      this.selected$.next(entities);\r\n    } else {\r\n      const entity = entities.length > 0 ? entities[0] : undefined;\r\n      this.selected$.next(entity);\r\n    }\r\n\r\n    this.updateMultiToggleWithEntities(entities);\r\n  }\r\n\r\n  private updateMultiToggleWithEntities(entities: object[]) {\r\n    if (entities.length === this.store.count && this.multiText$.value !== this.multiNoneText) {\r\n      this.multiText$.next(this.multiNoneText);\r\n    } else if (entities.length < this.store.count && this.multiText$.value !== this.multiAllText) {\r\n      this.multiText$.next(this.multiAllText);\r\n    }\r\n  }\r\n\r\n}\r\n","import { Directive, HostListener } from '@angular/core';\r\n\r\n@Directive({\r\n  selector: '[igoStopPropagation]'\r\n})\r\nexport class StopPropagationDirective {\r\n  @HostListener('click', ['$event'])\r\n  public onClick(event: any): void {\r\n    event.stopPropagation();\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  OnChanges,\r\n  ViewChild,\r\n  Output,\r\n  EventEmitter,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport {\r\n  EntityStore\r\n} from '../shared';\r\nimport { MatPaginator, PageEvent } from '@angular/material/paginator';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport { LanguageService, MediaService } from '@igo2/core';\r\nimport { EntityTablePaginatorOptions } from './entity-table-paginator.interface';\r\n\r\n@Component({\r\n  selector: 'igo-entity-table-paginator',\r\n  templateUrl: './entity-table-paginator.component.html',\r\n  styleUrls: ['./entity-table-paginator.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class EntityTablePaginatorComponent implements OnChanges, OnDestroy {\r\n\r\n  public disabled: boolean = false;\r\n  public hidePageSize: boolean = false;\r\n  public pageIndex: number = 0;\r\n  public pageSize: number = 50;\r\n  public pageSizeOptions: number[] = [5, 10, 20, 50, 100, 200];\r\n  public showFirstLastButtons: boolean = true;\r\n  private count$$: Subscription;\r\n  private entitySortChange$$: Subscription;\r\n  private paginationLabelTranslation$$: Subscription[] = [];\r\n\r\n  @Input() entitySortChange$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  /**\r\n   * Entity store\r\n   */\r\n  @Input() store: EntityStore<object>;\r\n\r\n  /**\r\n   * Paginator options\r\n   */\r\n  @Input()\r\n  paginatorOptions: EntityTablePaginatorOptions;\r\n\r\n  /**\r\n   * Event emitted when the paginator changes the page size or page index.\r\n   */\r\n  @Output() page: EventEmitter<PageEvent>;\r\n\r\n  public length: number = 0;\r\n\r\n  /**\r\n   * Paginator emitted.\r\n   */\r\n  @Output() paginatorChange: EventEmitter<MatPaginator> = new EventEmitter<MatPaginator>();\r\n\r\n  constructor(private languageService: LanguageService, private mediaService: MediaService) {}\r\n\r\n  @ViewChild(MatPaginator, { static: true }) paginator: MatPaginator;\r\n\r\n  ngOnChanges() {\r\n    this.unsubscribeAll();\r\n    this.count$$ = this.store.stateView.count$.subscribe((count) => {\r\n      this.length = count;\r\n      this.emitPaginator();\r\n    });\r\n    this.entitySortChange$$ = this.entitySortChange$.subscribe(() => {\r\n      if (this.paginator) {\r\n        this.paginator.firstPage();\r\n      }\r\n    });\r\n    this.initPaginatorOptions();\r\n    this.translateLabels();\r\n  }\r\n\r\n  initPaginatorOptions() {\r\n    this.disabled = this.paginatorOptions?.disabled || this.disabled;\r\n    this.pageIndex = this.paginatorOptions?.pageIndex || this.pageIndex;\r\n    this.pageSize = this.paginatorOptions?.pageSize || this.pageSize;\r\n    this.pageSizeOptions = this.paginatorOptions?.pageSizeOptions || this.pageSizeOptions;\r\n    if (this.mediaService.isMobile()) {\r\n      this.showFirstLastButtons = false;\r\n      this.hidePageSize = true;\r\n    } else {\r\n      this.showFirstLastButtons = this.paginatorOptions?.showFirstLastButtons || this.showFirstLastButtons;\r\n      this.hidePageSize = this.paginatorOptions?.hidePageSize || this.hidePageSize;\r\n    }\r\n  }\r\n\r\n  translateLabels() {\r\n\r\n    this.paginationLabelTranslation$$.push(\r\n      this.languageService.translate.get('igo.common.paginator.firstPageLabel').subscribe((label: string) => {\r\n        this.paginator._intl.firstPageLabel = label;\r\n      }));\r\n\r\n    this.paginator._intl.getRangeLabel = this.rangeLabel;\r\n\r\n    this.paginationLabelTranslation$$.push(\r\n      this.languageService.translate.get('igo.common.paginator.itemsPerPageLabel').subscribe((label: string) => {\r\n        this.paginator._intl.itemsPerPageLabel = label;\r\n      }));\r\n    this.paginationLabelTranslation$$.push(\r\n      this.languageService.translate.get('igo.common.paginator.lastPageLabel').subscribe((label: string) => {\r\n        this.paginator._intl.lastPageLabel = label;\r\n      }));\r\n    this.paginationLabelTranslation$$.push(\r\n      this.languageService.translate.get('igo.common.paginator.nextPageLabel').subscribe((label: string) => {\r\n        this.paginator._intl.nextPageLabel = label;\r\n      }));\r\n    this.paginationLabelTranslation$$.push(\r\n      this.languageService.translate.get('igo.common.paginator.previousPageLabel').subscribe((label: string) => {\r\n        this.paginator._intl.previousPageLabel = label;\r\n      }));\r\n  }\r\n\r\n  rangeLabel = (page: number, pageSize: number, length: number) => {\r\n    const of: BehaviorSubject<string> = new BehaviorSubject('');\r\n\r\n    this.paginationLabelTranslation$$.push(\r\n      this.languageService.translate.get('igo.common.paginator.of').subscribe((label: string) => {\r\n        of.next(label);\r\n      }));\r\n    if (length === 0 || pageSize === 0) { return `0 ${of.value} ${length}`; }\r\n    length = Math.max(length, 0);\r\n    const startIndex = page * pageSize;\r\n    const endIndex = startIndex < length ?\r\n        Math.min(startIndex + pageSize, length) :\r\n        startIndex + pageSize;\r\n    return `${startIndex + 1} - ${endIndex} ${of.value} ${length}`;\r\n  };\r\n\r\n  private unsubscribeAll() {\r\n    this.paginationLabelTranslation$$.map(sub => sub.unsubscribe());\r\n    if (this.count$$) { this.count$$.unsubscribe(); }\r\n    if (this.entitySortChange$$) { this.entitySortChange$$.unsubscribe(); }\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this.unsubscribeAll();\r\n  }\r\n\r\n  emitPaginator() {\r\n    this.paginatorChange.emit(this.paginator);\r\n  }\r\n}\r\n","<mat-paginator \r\n  [disabled]=\"disabled\"\r\n  [hidePageSize]=\"hidePageSize\"\r\n  [length]=\"length\"\r\n  [pageIndex]=\"pageIndex\"\r\n  [pageSize]=\"pageSize\"\r\n  [pageSizeOptions]=\"pageSizeOptions\"\r\n  [showFirstLastButtons]=\"showFirstLastButtons\"\r\n  (page)=\"emitPaginator()\">\r\n</mat-paginator>\r\n","import {\r\n  Directive,\r\n  HostListener,\r\n  Input,\r\n  ElementRef\r\n} from '@angular/core';\r\n\r\n@Directive({\r\n  selector: '[igoImageError]'\r\n})\r\nexport class ImageErrorDirective {\r\n\r\n  @Input() errorImageUrl: string = '/assets/igo2/common/images/na.png';\r\n  @Input() hideError: boolean = false;\r\n\r\n  constructor(private el: ElementRef) {}\r\n\r\n  @HostListener(\"error\", ['$event'])\r\n  public onError(event: any): void {\r\n    if (this.hideError) {\r\n      this.el.nativeElement.style.display = \"none\";\r\n    } else {\r\n      event.target.src = this.errorImageUrl;\r\n    }\r\n\r\n  }\r\n\r\n}\r\n","import {\r\n  Directive,\r\n  Input,\r\n  ElementRef,\r\n  Renderer2,\r\n  EventEmitter,\r\n  Output,\r\n  HostListener\r\n} from '@angular/core';\r\n\r\nimport scrollIntoView from 'scroll-into-view-if-needed';\r\n\r\nimport { EntityTableScrollBehavior } from '../shared/entity.enums';\r\n\r\n/**\r\n * Directive that handles an entity table row click and selection.\r\n */\r\n@Directive({\r\n  selector: '[igoEntityTableRow]'\r\n})\r\nexport class EntityTableRowDirective {\r\n\r\n  /**\r\n   * Class added to a selected row\r\n   */\r\n  static selectedCls = 'igo-entity-table-row-selected';\r\n\r\n  /**\r\n   * Class added to a highlighted row\r\n   */\r\n  static highlightedCls = 'igo-entity-table-row-highlighted';\r\n\r\n  /**\r\n   * Whether a row supports selection\r\n   */\r\n  @Input() selection = false;\r\n\r\n  /**\r\n   * Whether clicking a row should select it (if selection is true)\r\n   */\r\n  @Input() selectOnClick: boolean = true;\r\n\r\n  /**\r\n   * Whether the selected row should be highlighted\r\n   */\r\n  @Input() highlightSelection: boolean = true;\r\n\r\n  /**\r\n   * Whether a row is selected\r\n   */\r\n  @Input()\r\n  set selected(value: boolean) {\r\n    if (this.selection === false) { return; }\r\n    if (value === this._selected) { return; }\r\n\r\n    this.toggleSelected(value);\r\n    this.scroll();\r\n  }\r\n  get selected(): boolean {\r\n    return this._selected;\r\n  }\r\n  private _selected = false;\r\n\r\n  /**\r\n   * Scroll behavior on selection\r\n   */\r\n  @Input()\r\n  scrollBehavior: EntityTableScrollBehavior = EntityTableScrollBehavior.Auto;\r\n\r\n  /**\r\n   * Event emitted when a row is selected\r\n   */\r\n  @Output() select = new EventEmitter<EntityTableRowDirective>();\r\n\r\n  /**\r\n   * When a row is clicked, select it if it's supported\r\n   * @ignore\r\n   */\r\n  @HostListener('click')\r\n  onClick() {\r\n    if (this.selection === false || this.selectOnClick === false) {\r\n      return;\r\n    }\r\n\r\n    this.toggleSelected(true);\r\n    this.select.emit(this);\r\n  }\r\n\r\n  constructor(private renderer: Renderer2, private el: ElementRef) {}\r\n\r\n  /**\r\n   * Select a row and add or remove the selected class from it\r\n   * @param selected Whether the row should be selected\r\n   */\r\n  private toggleSelected(selected: boolean) {\r\n    this._selected = selected;\r\n    if (selected === true) {\r\n      this.addCls(EntityTableRowDirective.selectedCls);\r\n      if (this.highlightSelection === true) {\r\n        this.addCls(EntityTableRowDirective.highlightedCls);\r\n      }\r\n    } else {\r\n      this.removeCls(EntityTableRowDirective.selectedCls);\r\n      this.removeCls(EntityTableRowDirective.highlightedCls);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Scroll to the selected row\r\n   */\r\n  private scroll() {\r\n    if (this._selected === true) {\r\n      scrollIntoView(this.el.nativeElement, {\r\n        scrollMode: 'if-needed',\r\n        behavior: 'smooth',\r\n        block: 'end',\r\n        inline: 'nearest'\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add the selected CSS class\r\n   */\r\n  private addCls(cls: string) {\r\n    this.renderer.addClass(this.el.nativeElement, cls);\r\n  }\r\n\r\n  /**\r\n   * Remove the selected CSS class\r\n   */\r\n  private removeCls(cls: string) {\r\n    this.renderer.removeClass(this.el.nativeElement, cls);\r\n  }\r\n}\r\n","import { Pipe, PipeTransform } from '@angular/core';\r\nimport { DomSanitizer, SafeHtml } from '@angular/platform-browser';\r\n\r\n@Pipe({ name: 'sanitizeHtml' })\r\nexport class SanitizeHtmlPipe implements PipeTransform {\r\n  constructor(private _sanitizer: DomSanitizer) {\r\n  }\r\n  transform(v: string): SafeHtml {\r\n    return this._sanitizer.bypassSecurityTrustHtml(v);\r\n  }\r\n}\r\n","import { Pipe, PipeTransform } from '@angular/core';\r\nimport { HttpClient, HttpHeaders } from '@angular/common/http';\r\n\r\nimport { Cacheable } from 'ts-cacheable';\r\nimport { Observable } from 'rxjs';\r\nimport { catchError, switchMap } from 'rxjs/operators';\r\nimport { ConfigService } from '@igo2/core';\r\n\r\n@Pipe({\r\n  name: 'secureImage'\r\n})\r\nexport class SecureImagePipe implements PipeTransform {\r\n  constructor(\r\n    private http: HttpClient,\r\n    private configService?: ConfigService) {}\r\n\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  transform(url: string): Observable<string> {\r\n    const headers = new HttpHeaders({\r\n      'Content-Type': 'text/plain',\r\n      activityInterceptor: 'false',\r\n      interceptError: 'false'\r\n    });\r\n\r\n    const regexDepot = new RegExp(this.configService?.getConfig('depot.url') + '.*?(?=\"|$)');\r\n    if (regexDepot.test(url)) {\r\n      url = url.match(regexDepot)[0];\r\n    }\r\n\r\n    return this.http\r\n      .get(url, {\r\n        headers,\r\n        responseType: 'blob'\r\n      })\r\n      .pipe(\r\n        catchError((err) => {\r\n          err.error.caught = true;\r\n          err.error.toDisplay = false;\r\n          throw err;\r\n        }),\r\n        switchMap((blob) => {\r\n          return new Observable((observer) => {\r\n            const reader = new FileReader();\r\n            reader.readAsDataURL(blob);\r\n            reader.onloadend = () => {\r\n              observer.next(reader.result);\r\n              observer.complete();\r\n            };\r\n          });\r\n        })\r\n      ) as Observable<string>;\r\n  }\r\n}\r\n","<div class=\"table-container\" [ngStyle]=\"{'height': tableHeight}\">\r\n  <table mat-table matSort [ngClass]=\"getTableClass()\" [dataSource]=\"dataSource\" [trackBy]=\"getTrackByFunction()\" (matSortChange)=\"onSort($event)\">\r\n      <ng-container matColumnDef=\"selectionCheckbox\" class=\"mat-cell-checkbox\">\r\n          <th mat-header-cell *matHeaderCellDef>\r\n              <ng-container *ngIf=\"selectMany\">\r\n                  <ng-container *ngIf=\"selectionState$ | async as selectionState\">\r\n                      <mat-checkbox (change)=\"onToggleRows($event.checked)\" [checked]=\"selectionState === entityTableSelectionState.All\"\r\n                      [indeterminate]=\"selectionState === entityTableSelectionState.Some\">\r\n                      </mat-checkbox>\r\n                  </ng-container>\r\n              </ng-container>\r\n          </th>\r\n          <td mat-cell *matCellDef=\"let record\">\r\n              <mat-checkbox (mousedown)=\"$event.shiftKey ? $event.preventDefault() : null\" (click)=\"$event.shiftKey ?\r\n              onShiftToggleRow(!rowIsSelected(record), record, $event) : $event.stopPropagation()\" (change)=\"onToggleRow($event.checked,record)\"\r\n              [checked]=\"rowIsSelected(record)\">\r\n              </mat-checkbox>\r\n          </td>\r\n      </ng-container>\r\n\r\n      <ng-container [matColumnDef]=\"column.name\" *ngFor=\"let column of template.columns\">\r\n          <ng-container *ngIf=\"columnIsSortable(column)\">\r\n              <th mat-header-cell *matHeaderCellDef mat-sort-header [matTooltip]=\"column.tooltip ? column.tooltip : undefined\">\r\n                  {{column.title}}\r\n              </th>\r\n          </ng-container>\r\n\r\n          <ng-container *ngIf=\"!columnIsSortable(column)\">\r\n              <th mat-header-cell *matHeaderCellDef [matTooltip]=\"column.tooltip ? column.tooltip : undefined\">\r\n                  {{column.title}}\r\n              </th>\r\n          </ng-container>\r\n\r\n          <ng-container *ngIf=\"getColumnRenderer(column) as columnRenderer\">\r\n              <ng-container *ngIf=\"columnRenderer === entityTableColumnRenderer.Default\">\r\n                  <ng-container *matCellDef=\"let record\">\r\n                      <td mat-cell class=\"mat-cell-text\" *ngIf=\"!isUrl(getValue(record, column));else isAnUrlDefault\" [ngClass]=\"getCellClass(record, column)\">\r\n                          {{getValue(record, column)}}\r\n                      </td>\r\n                      <ng-template #isAnUrlDefault>\r\n                          <td mat-cell class=\"mat-cell-text\" [ngClass]=\"getCellClass(record, column)\">\r\n                              <a href=\"{{getValue(record, column)}}\" target='_blank' rel=\"noopener noreferrer\" (click)=\"$event.stopPropagation()\">\r\n                                  <img igoImageError *ngIf=\"isImg(getValue(record, column));else notImg\" src=\"{{(getValue(record, column) | secureImage) | async}}\" width=\"50\" heigth=\"auto\">\r\n                                  <ng-template #notImg><span>{{\r\n                    'igo.common.entity-table.targetHtmlUrl' | translate }}\r\n                  </span></ng-template>\r\n                              </a>\r\n                          </td>\r\n                      </ng-template>\r\n                  </ng-container>\r\n              </ng-container>\r\n              <ng-container *ngIf=\"columnRenderer === entityTableColumnRenderer.HTML\">\r\n                  <ng-container *matCellDef=\"let record\">\r\n                      <td mat-cell class=\"mat-cell-text\" *ngIf=\"!isUrl(getValue(record, column));else isAnUrlHTML\" [ngClass]=\"getCellClass(record, column)\"\r\n                      [innerHTML]=\"getValue(record, column)\">\r\n                      </td>\r\n                      <ng-template #isAnUrlHTML>\r\n                          <td mat-cell class=\"mat-cell-text\" [ngClass]=\"getCellClass(record, column)\">\r\n                              <a href=\"{{getValue(record, column)}}\" target='_blank' rel=\"noopener noreferrer\" (click)=\"$event.stopPropagation()\">\r\n                                  <img igoImageError *ngIf=\"isImg(getValue(record, column));else notImg\" src=\"{{(getValue(record, column) | secureImage) | async}}\" width=\"50\" heigth=\"auto\">\r\n                                  <ng-template #notImg><span>{{ 'igo.geo.targetHtmlUrl' |\r\n                    translate }} </span></ng-template>\r\n                              </a>\r\n                          </td>\r\n                      </ng-template>\r\n                  </ng-container>\r\n              </ng-container>\r\n              <ng-container *ngIf=\"columnRenderer === entityTableColumnRenderer.UnsanitizedHTML\">\r\n                  <ng-container *matCellDef=\"let record\">\r\n                      <td mat-cell class=\"mat-cell-text edition\" [formGroup]=\"formGroup\" *ngIf=\"isEdition(record);else isUnsanitizedHTML\"\r\n                      [ngClass]=\"getCellClass(record, column)\">\r\n                          <div class=\"date-picker\" *ngIf=\"column.type === 'date'\">\r\n                              <mat-datepicker-toggle matSuffix [for]=\"picker\"></mat-datepicker-toggle>\r\n                              <input matInput [matDatepicker]=\"picker\" [formControlName]=\"column.name\" value=\"{{getValue(record, column)}}\"\r\n                              (dateChange)=\"onDateChange(column.name, record, $event)\">\r\n                              <mat-datepicker #picker></mat-datepicker>\r\n                          </div>\r\n                          <input matInput type=\"time\" *ngIf=\"column.type === 'time'\" [formControlName]=\"column.name\" step=\"900\" (focus)=\"column.onFocus($event)\"\r\n                          (keypress)=\"column.onChange($event)\" (blur)=\"column.onBlur($event)\">\r\n                          <input matInput type=\"number\" class=\"class_number_edition\" *ngIf=\"column.type === 'number'\" [formControlName]=\"column.name\" step=\"{{column.step}}\"\r\n                          value=\"{{getValue(record,column)}}\" (input)=\"onValueChange(column.name, record, $event)\"\r\n                          readonly=\"{{getValidationAttributeValue(column, 'readonly')}}\" required=\"{{getValidationAttributeValue(column, 'mandatory')}}\"\r\n                          min=\"{{getValidationAttributeValue(column, 'minValue')}}\" max=\"{{getValidationAttributeValue(column, 'maxValue')}}\">\r\n                          <input matInput type=\"text\" *ngIf=\"!column.type || column.type ==='string'\" [formControlName]=\"column.name\"\r\n                          value=\"{{getValue(record, column)}}\" (input)=\"onValueChange(column.name, record, $event)\"\r\n                          readonly=\"{{getValidationAttributeValue(column, 'readonly')}}\" required=\"{{getValidationAttributeValue(column, 'mandatory')}}\">\r\n                          <mat-checkbox *ngIf=\"column.type === 'boolean'\" [formControlName]=\"column.name\" [checked]=\"getValue(record,column)\"\r\n                          (change)=\"onBooleanValueChange(column.name, record,$event)\"></mat-checkbox>\r\n                          <mat-select *ngIf=\"column.type === 'list'\" required=\"{{getValidationAttributeValue(column, 'mandatory')}}\"\r\n                          [formControlName]=\"column.name\" [multiple]=\"column.multiple\" (selectionChange)=\"onSelectValueChange(column.name, record, $event)\"\r\n                          [value]=\"getValue(record, column)\">\r\n                              <mat-option *ngFor=\"let option of column.domainValues\" [value]=\"option.id\" [disabled]=\"option.disabled\">\r\n                                  {{ option.value }}\r\n                              </mat-option>\r\n                          </mat-select>\r\n                          <input matInput type=\"text\" [formControlName]=\"column.name\" *ngIf=\"column.type === 'autocomplete'\" [matAutocomplete]=\"auto\"\r\n                            required=\"{{getValidationAttributeValue(column, 'mandatory')}}\" value=\"{{getValue(record, column)}}\"\r\n                            readonly=\"{{getValidationAttributeValue(column, 'readonly')}}\">\r\n                                <mat-autocomplete #auto=\"matAutocomplete\" (optionSelected)=\"onAutocompleteValueChange(column, record, $event)\"\r\n                                panelWidth=\"430px\">\r\n                                    <mat-option *ngFor=\"let option of filteredOptions[column.name] | async\"\r\n                                        [value]=\"option.id\">\r\n                                        {{ option.value }}\r\n                                    </mat-option>\r\n                                </mat-autocomplete>\r\n                      </td>\r\n                      <ng-template #isUnsanitizedHTML>\r\n                          <td mat-cell class=\"mat-cell-text\" *ngIf=\"!isUrl(getValue(record, column));else isAnUrlUnsanitizedHTML\" [ngClass]=\"getCellClass(record, column)\"\r\n                          [innerHTML]=\"getValue(record, column) | sanitizeHtml\">\r\n                          </td>\r\n                          <ng-template #isAnUrlUnsanitizedHTML>\r\n                              <td mat-cell class=\"mat-cell-text\" [ngClass]=\"getCellClass(record, column)\">\r\n                                  <a href=\"{{getValue(record, column)}}\" target='_blank' rel=\"noopener noreferrer\" (click)=\"$event.stopPropagation()\">\r\n                                      <img igoImageError *ngIf=\"isImg(getValue(record, column));else notImg\" src=\"{{(getValue(record, column) | secureImage) | async}}\" width=\"50\" heigth=\"auto\">\r\n                                      <ng-template #notImg><span>{{ 'igo.geo.targetHtmlUrl' | translate }} </span></ng-template>\r\n                                  </a>\r\n                              </td>\r\n                          </ng-template>\r\n                      </ng-template>\r\n                  </ng-container>\r\n              </ng-container>\r\n              <ng-container *ngIf=\"columnRenderer === entityTableColumnRenderer.Icon\">\r\n                  <td mat-cell *matCellDef=\"let record\" class=\"mat-cell-text\" [ngClass]=\"getCellClass(record, column)\">\r\n                      <mat-icon *ngIf=\"column.onClick\" svgIcon=\"{{getValue(record, column)|| column.icon}}\" (click)=\"column.onClick($event)\"></mat-icon>\r\n                      <mat-icon *ngIf=\"!column.onClick\" svgIcon=\"{{getValue(record, column)|| column.icon}}\"></mat-icon>\r\n                  </td>\r\n              </ng-container>\r\n              <ng-container *ngIf=\"columnRenderer === entityTableColumnRenderer.ButtonGroup\">\r\n                  <ng-container *matCellDef=\"let record\">\r\n                      <td mat-cell class=\"mat-cell-text\" [ngClass]=\"getCellClass(record, column)\">\r\n                          <span *ngFor=\"let button of getValue(record, column)\">\r\n                              <ng-container *ngIf=\"isEdition(record) === button.editMode || button.editMode === undefined\">\r\n                                  <button *ngIf=\"button.style === 'mat-icon-button'\" igoStopPropagation mat-icon-button\r\n                                      [color]=\"button.color\" (mousedown)=\"onButtonClick(button.click, record)\" [disabled]=\"button.disabled\">\r\n                                      <mat-icon svgIcon=\"{{button.icon}}\"></mat-icon>\r\n                                  </button>\r\n                                  <button *ngIf=\"button.style !== 'mat-icon-button'\" igoStopPropagation mat-mini-fab\r\n                                      [color]=\"button.color\" (mousedown)=\"onButtonClick(button.click, record)\" [disabled]=\"button.disabled\">\r\n                                      <mat-icon svgIcon=\"{{button.icon}}\"></mat-icon>\r\n                                  </button>\r\n                              </ng-container>\r\n                          </span>\r\n                      </td>\r\n                  </ng-container>\r\n              </ng-container>\r\n          </ng-container>\r\n      </ng-container>\r\n\r\n      <tr mat-header-row *matHeaderRowDef=\"headers; sticky: fixedHeader\" [ngClass]=\"getHeaderClass()\">\r\n      </tr>\r\n      <tr mat-row igoEntityTableRow *matRowDef=\"let record; columns: headers;\" [scrollBehavior]=\"scrollBehavior\" [ngClass]=\"getRowClass(record)\" [selection]=\"selection\" [selected]=\"rowIsSelected(record)\" (select)=\"onRowSelect(record)\" (click)=\"onRowClick(record)\">\r\n      </tr>\r\n  </table>\r\n  <igo-entity-table-paginator *ngIf=\"withPaginator\" [store]=\"store\" [paginatorOptions]=\"paginatorOptions\" [entitySortChange$]=\"entitySortChange$\" (paginatorChange)=\"paginatorChange($event)\">\r\n  </igo-entity-table-paginator>\r\n</div>","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef,\r\n  OnInit,\r\n  OnDestroy,\r\n  OnChanges,\r\n  SimpleChanges,\r\n  ElementRef,\r\n  Optional,\r\n  Self\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject, Observable, Subscription } from 'rxjs';\r\n\r\nimport {\r\n  EntityKey,\r\n  EntityRecord,\r\n  EntityState,\r\n  EntityStore,\r\n  EntityTableTemplate,\r\n  EntityTableColumn,\r\n  EntityTableColumnRenderer,\r\n  EntityTableSelectionState,\r\n  EntityTableScrollBehavior\r\n} from '../shared';\r\nimport { MatPaginator } from '@angular/material/paginator';\r\nimport { MatTableDataSource } from '@angular/material/table';\r\nimport { EntityTablePaginatorOptions } from '../entity-table-paginator/entity-table-paginator.interface';\r\nimport { MatFormFieldControl } from '@angular/material/form-field';\r\nimport { UntypedFormBuilder, NgControl, NgForm, FormControlName, UntypedFormGroup } from '@angular/forms';\r\nimport { FocusMonitor } from '@angular/cdk/a11y';\r\nimport { DateAdapter, ErrorStateMatcher } from '@angular/material/core';\r\nimport { map } from 'rxjs/operators';\r\nimport { default as moment } from 'moment';\r\n\r\n@Component({\r\n  selector: 'igo-entity-table',\r\n  templateUrl: './entity-table.component.html',\r\n  styleUrls: ['./entity-table.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush,\r\n  providers: [{ provide: MatFormFieldControl, useExisting: EntityTableComponent }]\r\n})\r\nexport class EntityTableComponent implements OnInit, OnChanges, OnDestroy {\r\n\r\n  entitySortChange$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  public formGroup: UntypedFormGroup = new UntypedFormGroup({});\r\n\r\n  public filteredOptions = {};\r\n\r\n  /**\r\n   * Reference to the column renderer types\r\n   * @internal\r\n   */\r\n  entityTableColumnRenderer = EntityTableColumnRenderer;\r\n\r\n  /**\r\n   * Reference to the selection's state\r\n   * @internal\r\n   */\r\n  entityTableSelectionState = EntityTableSelectionState;\r\n\r\n  /**\r\n   * Observable of the selection,s state\r\n   * @internal\r\n   */\r\n  readonly selectionState$: BehaviorSubject<EntityTableSelectionState> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Subscription to the store's selection\r\n   */\r\n  private selection$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to the dataSource\r\n   */\r\n  private dataSource$$: Subscription;\r\n\r\n  /**\r\n   * The last record checked. Useful for selecting\r\n   * multiple records by holding the shift key and checking\r\n   * checkboxes.\r\n   */\r\n  private lastRecordCheckedKey: EntityKey;\r\n\r\n  /**\r\n   * Entity store\r\n   */\r\n  @Input() store: EntityStore<object>;\r\n\r\n  /**\r\n   * Table paginator\r\n   */\r\n  @Input() set paginator(value: MatPaginator) {\r\n    this._paginator = value;\r\n    this.dataSource.paginator = value;\r\n  }\r\n\r\n  get paginator(): MatPaginator {\r\n    return this._paginator;\r\n  }\r\n  private _paginator: MatPaginator;\r\n\r\n  /**\r\n   * Table template\r\n   */\r\n  @Input() template: EntityTableTemplate;\r\n\r\n  /**\r\n   * Scroll behavior on selection\r\n   */\r\n  @Input()\r\n  scrollBehavior: EntityTableScrollBehavior = EntityTableScrollBehavior.Auto;\r\n\r\n  /**\r\n   * Whether nulls should be first when sorting\r\n   */\r\n  @Input()\r\n  sortNullsFirst: boolean = false;\r\n\r\n  /**\r\n   * Show the table paginator or not. False by default.\r\n   */\r\n  @Input()\r\n  withPaginator: boolean = false;\r\n\r\n  /**\r\n   * Paginator options\r\n   */\r\n  @Input()\r\n  paginatorOptions: EntityTablePaginatorOptions;\r\n\r\n  /**\r\n   * Event emitted when an entity (row) is clicked\r\n   */\r\n  @Output() entityClick = new EventEmitter<object>();\r\n\r\n  /**\r\n   * Event emitted when an entity (row) is selected\r\n   */\r\n  @Output() entitySelectChange = new EventEmitter<{\r\n    added: object[];\r\n  }>();\r\n\r\n  /**\r\n   * Event emitted when the table sort is changed.\r\n   */\r\n  @Output() entitySortChange: EventEmitter<{column: EntityTableColumn, direction: string}> = new EventEmitter(undefined);\r\n\r\n  /**\r\n   * Table headers\r\n   * @internal\r\n   */\r\n  get headers(): string[] {\r\n    let columns = this.template.columns\r\n      .filter((column: EntityTableColumn) => column.visible !== false)\r\n      .map((column: EntityTableColumn) => column.name);\r\n\r\n    if (this.selectionCheckbox === true) {\r\n      columns = ['selectionCheckbox'].concat(columns);\r\n    }\r\n\r\n    return columns;\r\n  }\r\n\r\n  /**\r\n   * Data source consumable by the underlying material table\r\n   * @internal\r\n   */\r\n  dataSource = new MatTableDataSource<object>();\r\n\r\n  /**\r\n   * Whether selection is supported\r\n   * @internal\r\n   */\r\n  get selection(): boolean { return this.template.selection || false; }\r\n\r\n  /**\r\n   * Whether a selection checkbox should be displayed\r\n   * @internal\r\n   */\r\n  get selectionCheckbox(): boolean { return this.template.selectionCheckbox || false; }\r\n\r\n  /**\r\n   * Whether selection many entities should eb supported\r\n   * @internal\r\n   */\r\n  get selectMany(): boolean { return this.template.selectMany || false; }\r\n\r\n  /**\r\n   * Whether selection many entities should eb supported\r\n   * @internal\r\n   */\r\n  get fixedHeader(): boolean { return this.template.fixedHeader === undefined ? true : this.template.fixedHeader; }\r\n\r\n  get tableHeight(): string { return this.template.tableHeight ? this.template.tableHeight : 'auto'; }\r\n\r\n  constructor(private cdRef: ChangeDetectorRef,\r\n    private formBuilder: UntypedFormBuilder,\r\n    protected _focusMonitor: FocusMonitor,\r\n    protected _elementRef: ElementRef<HTMLElement>,\r\n    @Optional() @Self() public ngControl: NgControl,\r\n    @Optional() protected _parentForm: NgForm,\r\n    @Optional() protected _controlName: FormControlName,\r\n    protected _defaultErrorStateMatcher: ErrorStateMatcher,\r\n    private dateAdapter: DateAdapter<Date>\r\n  ) {\r\n    this.dateAdapter.setLocale('fr-CA');\r\n  }\r\n\r\n  /**\r\n   * Track the selection state to properly display the selection checkboxes\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.handleDatasource();\r\n    this.dataSource.paginator = this.paginator;\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnChanges(changes: SimpleChanges) {\r\n    const store = changes.store;\r\n    if (store && store.currentValue !== store.previousValue) {\r\n      this.handleDatasource();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Process text or number value change (edition)\r\n   */\r\n  onValueChange(column: string, record: EntityRecord<any>, event) {\r\n    const key = this.getColumnKeyWithoutPropertiesTag(column);\r\n    record.entity.properties[key] = event.target.value;\r\n  }\r\n\r\n  /**\r\n   * Process boolean value change (edition)\r\n   */\r\n  onBooleanValueChange(column: string, record: EntityRecord<any>, event) {\r\n    const key = this.getColumnKeyWithoutPropertiesTag(column);\r\n    record.entity.properties[key] = event.checked;\r\n  }\r\n\r\n  /**\r\n   * Process select value change (edition)\r\n   */\r\n  onSelectValueChange(column: string, record: EntityRecord<any>, event) {\r\n    const key = this.getColumnKeyWithoutPropertiesTag(column);\r\n    record.entity.properties[key] = event.value;\r\n  }\r\n\r\n  /**\r\n   * Process autocomplete value change (edition)\r\n   */\r\n  onAutocompleteValueChange(column: EntityTableColumn, record: EntityRecord<any>, event) {\r\n    this.formGroup.controls[column.name].setValue(event.option.viewValue);\r\n    const key = this.getColumnKeyWithoutPropertiesTag(column.name);\r\n    record.entity.properties[key] = event.option.value;\r\n  }\r\n\r\n  /**\r\n   * Process date value change (edition)\r\n   */\r\n  onDateChange(column: string, record: EntityRecord<any>, event) {\r\n    const format = \"YYYY-MM-DD\";\r\n    const value = moment(event.value).format(format);\r\n    const key = this.getColumnKeyWithoutPropertiesTag(column);\r\n    record.entity.properties[key] = value;\r\n  }\r\n\r\n  /**\r\n   * Enable edition mode for one row\r\n   * More than one row can be edited at the same time\r\n   */\r\n  private enableEdit(record: EntityRecord<any>) {\r\n    const item = record.entity.properties || record.entity;\r\n    this.template.columns.forEach(column => {\r\n      column.title = column.validation?.mandatory && !column.title.includes('*') ? column.title + ' *' : column.title;\r\n\r\n      const key = this.getColumnKeyWithoutPropertiesTag(column.name);\r\n      if (column.type === 'boolean') {\r\n        if (!item[key] || item[key] === null) {\r\n          item[key] = false;\r\n        } else if (typeof item[key] === 'string') {\r\n          item[key] = JSON.parse(item[key].toLowerCase());\r\n        }\r\n        this.formGroup.setControl(column.name, this.formBuilder.control(\r\n          item[key]\r\n        ));\r\n      } else if (column.type === 'list') {\r\n        if (column.multiple) {\r\n          this.formGroup.setControl(column.name, this.formBuilder.control(\r\n            [item[key]]\r\n          ));\r\n        } else {\r\n          this.formGroup.setControl(column.name, this.formBuilder.control(\r\n            item[key]\r\n          ));\r\n\r\n          typeof item[key] === 'string' ?\r\n            this.formGroup.controls[column.name].setValue(parseInt(item[key])) :\r\n            this.formGroup.controls[column.name].setValue(item[key]);\r\n        }\r\n      } else if (column.type === 'autocomplete') {\r\n        this.formGroup.setControl(column.name, this.formBuilder.control(\r\n          item[key]\r\n        ));\r\n\r\n        this.filteredOptions[column.name] = new Observable<any[]>();\r\n        this.filteredOptions[column.name] =\r\n          this.formGroup.controls[column.name].valueChanges.pipe(\r\n            map(value => {\r\n              if (value?.length) {\r\n                return column.domainValues?.filter((option) => {\r\n                  const filterNormalized = value ? value.toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g, '') : '';\r\n                  const featureNameNormalized = option.value.toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n                  return featureNameNormalized.includes(filterNormalized);\r\n                });\r\n              }\r\n            })\r\n          );\r\n\r\n        let formControlValue = item[key];\r\n        column.domainValues.forEach(option => {\r\n          if (typeof formControlValue === 'string' && /^\\d+$/.test(formControlValue)) {\r\n            formControlValue = parseInt(formControlValue);\r\n          }\r\n          if (option.value === formControlValue || option.id === formControlValue) {\r\n            formControlValue = option.value;\r\n          }\r\n        });\r\n\r\n        this.formGroup.controls[column.name].setValue(formControlValue);\r\n        if (this.isEdition(record) && column.linkColumnForce) {\r\n          const entity = record.entity as any;\r\n          this.formGroup.controls[column.name].setValue(\r\n            entity?.properties[this.getColumnKeyWithoutPropertiesTag(column.linkColumnForce)]\r\n          );\r\n        }\r\n      } else if (column.type === 'date') {\r\n        if (column.visible) {\r\n          if (item[key]) {\r\n            let date = moment(item[key]);\r\n            item[key] = date.utc().format('YYYY-MM-DD');\r\n            this.formGroup.setControl(column.name, this.formBuilder.control(\r\n              item[key]\r\n            ));\r\n          } else {\r\n            const newKey = this.getColumnKeyWithoutPropertiesTag(column.name);\r\n            record.entity.properties[newKey] = null;\r\n            this.formGroup.setControl(column.name, this.formBuilder.control(\r\n              null\r\n            ));\r\n          }\r\n        }\r\n      } else {\r\n        this.formGroup.setControl(column.name, this.formBuilder.control(\r\n          item[key]\r\n        ));\r\n      }\r\n\r\n      if (this.formGroup.controls[column.name] && this.getValidationAttributeValue(column, 'readonly')) {\r\n        this.formGroup.controls[column.name].disable();\r\n      }\r\n    });\r\n  }\r\n\r\n  private handleDatasource() {\r\n    this.unsubscribeStore();\r\n    this.selection$$ = this.store.stateView\r\n      .manyBy$((record: EntityRecord<object>) => record.state.selected === true)\r\n      .subscribe((records: EntityRecord<object>[]) => {\r\n        const firstSelected = records[0];\r\n        const firstSelectedStateviewPosition = this.store.stateView.all().indexOf(firstSelected);\r\n        const pageMax = this.paginator ? this.paginator.pageSize * (this.paginator.pageIndex + 1) : 0;\r\n        const pageMin = this.paginator ? pageMax - this.paginator.pageSize : 0;\r\n\r\n        if (\r\n          this.paginator &&\r\n          (firstSelectedStateviewPosition < pageMin ||\r\n          firstSelectedStateviewPosition >= pageMax)) {\r\n          const pageToReach = Math.floor(firstSelectedStateviewPosition / this.paginator.pageSize);\r\n          this.dataSource.paginator.pageIndex = pageToReach;\r\n        }\r\n        this.selectionState$.next(this.computeSelectionState(records));\r\n      });\r\n    this.dataSource$$ = this.store.stateView.all$().subscribe((all) => {\r\n      if (all[0]) {\r\n        this.enableEdit(all[0]);\r\n      }\r\n      this.dataSource.data = all;\r\n    });\r\n\r\n  }\r\n\r\n  /**\r\n   * Unbind the store watcher\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.unsubscribeStore();\r\n  }\r\n\r\n  private unsubscribeStore() {\r\n    if (this.selection$$) {\r\n      this.selection$$.unsubscribe();\r\n    }\r\n    if (this.dataSource$$) {\r\n      this.dataSource$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Trackby function\r\n   * @param record Record\r\n   * @param index Record index\r\n   * @internal\r\n   */\r\n  getTrackByFunction() {\r\n    return (index: number, record: EntityRecord<object, EntityState>) => {\r\n      return record.ref;\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Trigger a refresh of thre table. This can be useful when\r\n   * the data source doesn't emit a new value but for some reason\r\n   * the records need an update.\r\n   * @internal\r\n   */\r\n  refresh() {\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n  paginatorChange(event: MatPaginator) {\r\n    this.paginator = event;\r\n  }\r\n\r\n  /**\r\n   * On sort, sort the store\r\n   * @param event Sort event\r\n   * @internal\r\n   */\r\n  onSort(event: {active: string, direction: string}) {\r\n    const direction = event.direction;\r\n    const column = this.template.columns\r\n      .find((c: EntityTableColumn) => c.name === event.active);\r\n\r\n    if (direction === 'asc' || direction === 'desc') {\r\n      this.store.stateView.sort({\r\n        valueAccessor: (record: EntityRecord<object>) => this.getValue(record, column),\r\n        direction,\r\n        nullsFirst: this.sortNullsFirst\r\n      });\r\n      this.entitySortChange.emit({column, direction});\r\n      this.entitySortChange$.next(true);\r\n    } else {\r\n      this.store.stateView.sort(undefined);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * When an entity is clicked, emit an event\r\n   * @param record Record\r\n   * @internal\r\n   */\r\n  onRowClick(record: EntityRecord<object>) {\r\n    this.lastRecordCheckedKey = this.store.stateView.getKey(record);\r\n    this.entityClick.emit(record.entity);\r\n  }\r\n\r\n  /**\r\n   * When an entity is selected, select it in the store and emit an event. Even if\r\n   * \"many\" is set to true, this method always select a single, exclusive row. Selecting\r\n   * multiple rows should be achieved by using the checkboxes.\r\n   * @param record Record\r\n   * @internal\r\n   */\r\n  onRowSelect(record: EntityRecord<object>) {\r\n    if (this.selection === false) { return; }\r\n\r\n    const entity = record.entity;\r\n    this.store.state.update(entity, {selected: true}, true);\r\n    this.entitySelectChange.emit({added: [entity]});\r\n  }\r\n\r\n  /**\r\n   * Select or unselect all rows at once. On select, emit an event.\r\n   * @param toggle Select or unselect\r\n   * @internal\r\n   */\r\n  onToggleRows(toggle: boolean) {\r\n    if (this.selection === false) { return; }\r\n\r\n    this.store.state.updateAll({selected: toggle});\r\n    if (toggle === true) {\r\n      const entities = this.store.stateView\r\n        .all()\r\n        .map((record: EntityRecord<object>) => record.entity);\r\n      this.entitySelectChange.emit({added: [entities]});\r\n    }\r\n  }\r\n\r\n  /**\r\n   * When an entity is toggled, select or unselect it in the store. On select,\r\n   * emit an event.\r\n   * @param toggle Select or unselect\r\n   * @param record Record\r\n   * @internal\r\n   */\r\n  onToggleRow(toggle: boolean, record: EntityRecord<object>) {\r\n    if (this.selection === false) { return; }\r\n\r\n    const entity = record.entity;\r\n    const exclusive = toggle === true && !this.selectMany;\r\n    this.store.state.update(entity, {selected: toggle}, exclusive);\r\n    if (toggle === true) {\r\n      this.entitySelectChange.emit({added: [entity]});\r\n    }\r\n    this.lastRecordCheckedKey = this.store.stateView.getKey(record);\r\n  }\r\n\r\n  /**\r\n   * When an entity is toggled, select or unselect it in the store. On select,\r\n   * emit an event.\r\n   * @param toggle Select or unselect\r\n   * @param record Record\r\n   * @internal\r\n   */\r\n  onShiftToggleRow(toggle: boolean, record: EntityRecord<object>, event: MouseEvent) {\r\n    if (this.selection === false) { return; }\r\n\r\n    if (this.selectMany === false || this.lastRecordCheckedKey === undefined) {\r\n      this.onToggleRow(toggle, record);\r\n      return;\r\n    }\r\n\r\n    // This is a workaround mat checkbox wrong behavior\r\n    // when the shift key is held.\r\n    // See https://github.com/angular/components/issues/6232\r\n    const range = window.document.createRange();\r\n    range.selectNode(event.target as HTMLElement);\r\n    window.getSelection().removeAllRanges();\r\n    window.getSelection().addRange(range);\r\n    event.stopImmediatePropagation();\r\n\r\n    const records = this.store.stateView.all();\r\n    const recordIndex = records.indexOf(record);\r\n    const lastRecordChecked = this.store.stateView.get(this.lastRecordCheckedKey);\r\n    const lastRecordIndex = records.indexOf(lastRecordChecked);\r\n    const indexes = [recordIndex, lastRecordIndex];\r\n    const selectRecords = records.slice(Math.min(...indexes), Math.max(...indexes) + 1);\r\n\r\n    const entities = selectRecords.map((_record: EntityRecord<object>) => _record.entity);\r\n    this.store.state.updateMany(entities, {selected: toggle});\r\n    if (toggle === true) {\r\n      this.entitySelectChange.emit({added: entities});\r\n    }\r\n    this.lastRecordCheckedKey = this.store.stateView.getKey(record);\r\n  }\r\n\r\n  /**\r\n   * Compute the selection state\r\n   * @returns Whether all, some or no rows are selected\r\n   * @internal\r\n   */\r\n  private computeSelectionState(selectedRecords: EntityRecord<object>[]): EntityTableSelectionState {\r\n    const states = EntityTableSelectionState;\r\n    const selectionCount = selectedRecords.length;\r\n    return selectionCount === 0 ?\r\n      states.None :\r\n      (selectionCount === this.store.stateView.count ? states.All : states.Some);\r\n  }\r\n\r\n  /**\r\n   * Whether a column is sortable\r\n   * @param column Column\r\n   * @returns True if a column is sortable\r\n   * @internal\r\n   */\r\n  columnIsSortable(column: EntityTableColumn): boolean {\r\n    let sortable = column.sort;\r\n    if (sortable === undefined) {\r\n      sortable = this.template.sort === undefined ? false : this.template.sort;\r\n    }\r\n    return sortable;\r\n  }\r\n\r\n  /**\r\n   * Whether a row is should be selected based on the underlying entity state\r\n   * @param record Record\r\n   * @returns True if a row should be selected\r\n   * @internal\r\n   */\r\n  rowIsSelected(record: EntityRecord<object>): boolean {\r\n    const state = record.state;\r\n    return state.selected ? state.selected : false;\r\n  }\r\n\r\n  isImg(value) {\r\n    if (this.isUrl(value)) {\r\n      return (\r\n        ['jpg', 'png', 'gif'].indexOf(value.split('.').pop().toLowerCase()) !== -1\r\n      );\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  isUrl(value) {\r\n    if (typeof value === 'string') {\r\n      return (\r\n        value.slice(0, 8) === 'https://' || value.slice(0, 7) === 'http://'\r\n      );\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Method to access an entity's values\r\n   * @param record Record\r\n   * @param column Column\r\n   * @returns Any value\r\n   * @internal\r\n   */\r\n  getValue(record: EntityRecord<object>, column: EntityTableColumn): any {\r\n    const entity = record.entity;\r\n    let value;\r\n    if (column.valueAccessor !== undefined) {\r\n      return column.valueAccessor(entity, record);\r\n    }\r\n    if (this.template.valueAccessor !== undefined) {\r\n      return this.template.valueAccessor(entity, column.name, record);\r\n    }\r\n    value = this.store.getProperty(entity, column.name);\r\n\r\n    if (column.type === 'boolean') {\r\n      if (value === undefined || value === null || value === '') {\r\n        value = false;\r\n      } else if (typeof value !== 'boolean' && value !== undefined) {\r\n        if (typeof value === 'number'){\r\n          value = Boolean(value);\r\n        } else {\r\n          value = JSON.parse(value.toLowerCase());\r\n        }\r\n      }\r\n      if (!this.isEdition(record)){\r\n        value = value ? '&#10003;' : ''; // check mark\r\n      }\r\n    } else if (column.type === 'list' && value && column.domainValues) {\r\n      const entity = record.entity as any;\r\n      if (column.multiple) {\r\n        let list_id;\r\n        typeof value === 'string' ? list_id = value.match(/[\\w.-]+/g).map(Number) : list_id = value;\r\n        let list_option = [];\r\n\r\n        column.domainValues.forEach(option => {\r\n          if (list_id.includes(option.id)) {\r\n            if (record.edition) {\r\n              list_option.push(option.id);\r\n            } else {\r\n              list_option.push(option.value);\r\n            }\r\n          }\r\n        });\r\n\r\n        this.isEdition(record) ? value = list_id : value = list_option;\r\n      } else {\r\n        if (!this.isEdition(record) && column.linkColumnForce) {\r\n          value = entity?.properties[this.getColumnKeyWithoutPropertiesTag(column.linkColumnForce)];\r\n        } else {\r\n          column.domainValues.forEach(option => {\r\n            if (typeof value === 'string' && /^\\d+$/.test(value)) {\r\n              value = parseInt(value);\r\n            }\r\n            if (option.value === value || option.id === value) {\r\n              this.isEdition(record) ? value = option.id : value = option.value;\r\n            }\r\n          });\r\n        }\r\n      }\r\n    } else if (column.type === 'autocomplete' && value && column.domainValues) {\r\n      const entity = record.entity as any;\r\n      if (!this.isEdition(record) && column.linkColumnForce) {\r\n        value = entity?.properties[this.getColumnKeyWithoutPropertiesTag(column.linkColumnForce)];\r\n      } else {\r\n        column.domainValues.forEach(option => {\r\n          if (typeof value === 'string' && /^\\d+$/.test(value)) {\r\n            value = parseInt(value);\r\n          }\r\n          if (option.value === value || option.id === value) {\r\n            value = option.value;\r\n          }\r\n        });\r\n      }\r\n    } else if (column.type === 'date') {\r\n      if (this.isEdition(record)) {\r\n        if (value) {\r\n          let date = moment(value);\r\n          value = date.format();\r\n          this.formGroup.controls[column.name].setValue(value);\r\n        }\r\n      } else if (!this.isEdition(record) && value === null) {\r\n        value = \"\";\r\n      }\r\n    }\r\n\r\n    if (value === undefined) {\r\n      value = '';\r\n    }\r\n\r\n    return value;\r\n  }\r\n\r\n  /**\r\n   * Method to access an entity's validation values\r\n   * @param column Column\r\n   * @param validationType string\r\n   * @returns Any value (false if no validation or not the one concerned)\r\n   * @internal\r\n   */\r\n  getValidationAttributeValue(column: EntityTableColumn, validationType: string): any {\r\n    if (column.validation !== undefined && column.validation[validationType] !== undefined) {\r\n      return column.validation[validationType];\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  public isEdition(record) {\r\n    return record.entity.edition ? true : false;\r\n  }\r\n\r\n  /**\r\n   * Return the type of renderer of a column\r\n   * @param column Column\r\n   * @returns Renderer type\r\n   * @internal\r\n   */\r\n  getColumnRenderer(column: EntityTableColumn): EntityTableColumnRenderer {\r\n    if (column.renderer !== undefined) {\r\n      return column.renderer;\r\n    }\r\n    return EntityTableColumnRenderer.Default;\r\n  }\r\n\r\n  /**\r\n   * Return the table ngClass\r\n   * @returns ngClass\r\n   * @internal\r\n   */\r\n  getTableClass(): {[key: string]: boolean} {\r\n    return {\r\n      'igo-entity-table-with-selection': this.selection\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Return a header ngClass\r\n   * @returns ngClass\r\n   * @internal\r\n   */\r\n  getHeaderClass(): {[key: string]: boolean} {\r\n    const func = this.template.headerClassFunc;\r\n    if (func instanceof Function) {\r\n      return func();\r\n    }\r\n    return {};\r\n  }\r\n\r\n  /**\r\n   * Return a row ngClass\r\n   * @param record Record\r\n   * @returns ngClass\r\n   * @internal\r\n   */\r\n  getRowClass(record: EntityRecord<object>): {[key: string]: boolean} {\r\n    const entity = record.entity;\r\n    const func = this.template.rowClassFunc;\r\n    if (func instanceof Function) {\r\n      return func(entity, record);\r\n    }\r\n    return {};\r\n  }\r\n\r\n  /**\r\n   * Return a row ngClass\r\n   * @param record Record\r\n   * @param column Column\r\n   * @returns ngClass\r\n   * @internal\r\n   */\r\n  getCellClass(record: EntityRecord<object>, column: EntityTableColumn): {[key: string]: boolean} {\r\n    const entity = record.entity;\r\n    const cls = {};\r\n\r\n    const tableFunc = this.template.cellClassFunc;\r\n    if (tableFunc instanceof Function) {\r\n      Object.assign(cls, tableFunc(entity, column, record));\r\n    }\r\n\r\n    const columnFunc = column.cellClassFunc;\r\n    if (columnFunc instanceof Function) {\r\n      Object.assign(cls, columnFunc(entity, record));\r\n    }\r\n\r\n    return cls;\r\n  }\r\n\r\n  /**\r\n   * When a button is clicked\r\n   * @param func Function\r\n   * @param record Record\r\n   * @internal\r\n   */\r\n  onButtonClick(\r\n    clickFunc: (entity: object, record?: EntityRecord<object>) => void,\r\n    record: EntityRecord<object>\r\n  ) {\r\n    this.enableEdit(record);\r\n    if (typeof clickFunc === 'function') {\r\n      clickFunc(record.entity, record);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Retrieve column name without his \"properties\" tag (useful for edition workspace properties)\r\n   */\r\n  public getColumnKeyWithoutPropertiesTag(column: string) {\r\n    if (column.includes('properties.')) {\r\n      return column.split('.')[1];\r\n    }\r\n    return column;\r\n  }\r\n}\r\n","export enum ActionbarMode {\r\n  Dock = 'dock',\r\n  Overlay = 'overlay',\r\n  Context = 'context'\r\n}\r\n","<mat-list-item *ngIf=\"!action.checkbox\"\r\n  matTooltipClass=\"actionbarItemTooltip\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"withTooltip ? ((tooltip$ | async) || title | translate) : ''\"\r\n  [ngClass]=\"ngClass$ | async\"\r\n  (click)=\"onClick()\">\r\n  <button *ngIf=\"withIcon\"\r\n    mat-list-avatar\r\n    mat-icon-button\r\n    [color]=\"color\"\r\n    [disabled]=\"disabled$ | async\">\r\n    <mat-icon *ngIf=\"withIcon\" svgIcon=\"{{icon$ | async}}\"></mat-icon>\r\n  </button>\r\n  <h4 *ngIf=\"withTitle\" matLine>{{title | translate}}</h4>\r\n</mat-list-item>\r\n\r\n<mat-list-item class=\"item-checkbox\" *ngIf=\"action.checkbox\"\r\n  matTooltipClass=\"actionbarItemTooltip\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"withTooltip ? ((tooltip$ | async) || title | translate) : ''\"\r\n  [ngClass]=\"ngClass$ | async\">\r\n  <mat-checkbox *ngIf=\"withTitle\"\r\n      (change)=\"action.handler()\"\r\n      [checked]=\"checkCondition$ | async\">\r\n      {{title | translate}}\r\n  </mat-checkbox>\r\n</mat-list-item>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject, Subscription, isObservable } from 'rxjs';\r\n\r\nimport { Action } from '../shared/action.interfaces';\r\n\r\n /**\r\n  * An action button\r\n  */\r\n@Component({\r\n  selector: 'igo-actionbar-item',\r\n  templateUrl: './actionbar-item.component.html',\r\n  styleUrls: ['./actionbar-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class ActionbarItemComponent implements OnInit, OnDestroy {\r\n\r\n  readonly disabled$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  readonly checkCondition$: BehaviorSubject<boolean> = new BehaviorSubject(undefined);\r\n\r\n  readonly icon$: BehaviorSubject<string> = new BehaviorSubject(undefined);\r\n\r\n  readonly tooltip$: BehaviorSubject<string> = new BehaviorSubject(undefined);\r\n\r\n  readonly noDisplay$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  readonly ngClass$: BehaviorSubject<{[key: string]: boolean}> = new BehaviorSubject({});\r\n\r\n  private ngClass$$: Subscription;\r\n\r\n  private disabled$$: Subscription;\r\n\r\n  private availability$$: Subscription;\r\n\r\n  private icon$$: Subscription;\r\n\r\n  private checkCondition$$: Subscription;\r\n\r\n  private tooltip$$: Subscription;\r\n\r\n  private noDisplay$$: Subscription;\r\n\r\n  private display$$: Subscription;\r\n\r\n  /**\r\n   * Action\r\n   */\r\n  @Input() action: Action;\r\n\r\n  /**\r\n   * Color\r\n   */\r\n  @Input() color = 'default';\r\n\r\n  /**\r\n   * Whether the action title is displayed\r\n   */\r\n  @Input() withTitle = true;\r\n\r\n  /**\r\n   * Whether the action icon is displayed\r\n   */\r\n  @Input() withIcon = true;\r\n\r\n  /**\r\n   * Whether a tooltip should be shown\r\n   */\r\n  @Input() withTooltip = true;\r\n\r\n  /**\r\n   * Whether the action is disabled\r\n   */\r\n  @Input()\r\n  set disabled(value: boolean) { this.disabled$.next(value); }\r\n  get disabled(): boolean { return this.disabled$.value; }\r\n\r\n  /**\r\n   * Whether the action is display or not\r\n   */\r\n  @Input()\r\n  set noDisplay(value: boolean) { this.noDisplay$.next(value); }\r\n  get noDisplay(): boolean { return this.noDisplay$.value; }\r\n\r\n  /**\r\n   * Event emitted when the action button is clicked\r\n   */\r\n  @Output() trigger: EventEmitter<Action> = new EventEmitter();\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get title(): string { return this.action.title; }\r\n\r\n  constructor() {}\r\n\r\n  ngOnInit() {\r\n    const args = this.action.args || [];\r\n\r\n    if (this.action.ngClass !== undefined) {\r\n      this.ngClass$$ = this.action.ngClass(...args)\r\n        .subscribe((ngClass: {[key: string]: boolean}) => this.updateNgClass(ngClass));\r\n    }\r\n\r\n    if (isObservable(this.action.icon)) {\r\n      this.icon$$ = this.action.icon\r\n        .subscribe((icon: string) => this.updateIcon(icon));\r\n    } else {\r\n      this.updateIcon(this.action.icon);\r\n    }\r\n\r\n    if (isObservable(this.action.checkCondition)) {\r\n      this.checkCondition$$ = this.action.checkCondition\r\n        .subscribe((checkCondition: boolean) => this.updateCheckCondition(checkCondition));\r\n    } else {\r\n      this.updateCheckCondition(this.action.checkCondition);\r\n    }\r\n\r\n    if (isObservable(this.action.tooltip)) {\r\n      this.tooltip$$ = this.action.tooltip\r\n        .subscribe((tooltip: string) => this.updateTooltip(tooltip));\r\n    } else {\r\n      this.updateTooltip(this.action.tooltip);\r\n    }\r\n\r\n    if (this.action.availability !== undefined) {\r\n      this.availability$$ = this.action.availability(...args)\r\n        .subscribe((available: boolean) => this.disabled = !available);\r\n    }\r\n\r\n    this.disabled$$ = this.disabled$\r\n      .subscribe((disabled: boolean) => this.updateNgClass({'igo-actionbar-item-disabled': disabled}));\r\n\r\n    if (this.action.display !== undefined) {\r\n      this.display$$ = this.action.display(...args)\r\n        .subscribe((display: boolean) => this.noDisplay = !display);\r\n    }\r\n\r\n    this.noDisplay$$ = this.noDisplay$\r\n      .subscribe((noDisplay: boolean) => this.updateNgClass({'igo-actionbar-item-no-display': noDisplay}));\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    if (this.ngClass$$ !== undefined) {\r\n      this.ngClass$$.unsubscribe();\r\n      this.ngClass$$ = undefined;\r\n    }\r\n\r\n    if (this.availability$$ !== undefined) {\r\n      this.availability$$.unsubscribe();\r\n      this.availability$$ = undefined;\r\n    }\r\n\r\n    if (this.display$$ !== undefined) {\r\n      this.display$$.unsubscribe();\r\n      this.display$$ = undefined;\r\n    }\r\n\r\n    if (this.checkCondition$$ !== undefined) {\r\n      this.checkCondition$$.unsubscribe();\r\n      this.checkCondition$$ = undefined;\r\n    }\r\n\r\n    if (this.icon$$ !== undefined) {\r\n      this.icon$$.unsubscribe();\r\n      this.icon$$ = undefined;\r\n    }\r\n\r\n    if (this.tooltip$$ !== undefined) {\r\n      this.tooltip$$.unsubscribe();\r\n      this.tooltip$$ = undefined;\r\n    }\r\n\r\n    this.disabled$$.unsubscribe();\r\n    this.noDisplay$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * When the action button is clicked, emit the 'trigger' event but don't\r\n   * invoke the action handler. This is handled by the parent component.\r\n   * @internal\r\n   */\r\n  onClick() {\r\n    if (this.disabled === true) {\r\n      return;\r\n    }\r\n    this.trigger.emit(this.action);\r\n  }\r\n\r\n  private updateNgClass(ngClass: {[key: string]: boolean}) {\r\n    this.ngClass$.next(Object.assign({}, this.ngClass$.value, ngClass));\r\n  }\r\n\r\n  private updateTooltip(tooltip: string) {\r\n    this.tooltip$.next(tooltip);\r\n  }\r\n\r\n  private updateCheckCondition(checkCondition: boolean) {\r\n    this.checkCondition$.next(checkCondition);\r\n  }\r\n\r\n  private updateIcon(icon: string) {\r\n    this.icon$.next(icon);\r\n  }\r\n}\r\n","<mat-list *ngIf=\"mode === actionbarMode.Dock\">\r\n\r\n    <div *ngIf=\"heightCondition && positionConditionTop && isDesktop\"\r\n      id=\"topChevron\">\r\n      <button\r\n        mat-icon-button\r\n        tooltip-position=\"below\"\r\n        matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.common.actionbar.scrollUp' | translate\"\r\n        (click)=\"scrollUp()\">\r\n        <mat-icon svgIcon=\"chevron-up\"></mat-icon>\r\n      </button>\r\n    </div>\r\n\r\n    <igo-actionbar-item\r\n      *ngIf=\"withToggleButton\"\r\n      color=\"accent\"\r\n      [withTitle]=\"false\"\r\n      [withIcon]=\"true\"\r\n      [color]=\"color\"\r\n      [disabled]=\"store.view.empty\"\r\n      [action]=\"toggleCollapseAction\"\r\n      (trigger)=\"onTriggerAction(toggleCollapseAction)\">\r\n    </igo-actionbar-item>\r\n\r\n    <ng-template #buttonContent *ngIf=\"!collapsed\" ngFor let-action [ngForOf]=\"store.view.all$() | async\">\r\n      <igo-actionbar-item\r\n        color=\"accent\"\r\n        [withTitle]=\"withTitle\"\r\n        [withIcon]=\"withIcon\"\r\n        [withTooltip]=\"withTooltip\"\r\n        [color]=\"color\"\r\n        [disabled]=\"store.state.get(action).disabled\"\r\n        [action]=\"action\"\r\n        (trigger)=\"onTriggerAction(action)\">\r\n      </igo-actionbar-item>\r\n    </ng-template>\r\n\r\n    <div *ngIf=\"heightCondition && positionConditionLow && isDesktop\"\r\n      id=\"lowChevron\">\r\n      <button\r\n        mat-icon-button\r\n        tooltip-position=\"below\"\r\n        matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.common.actionbar.scrollDown' | translate\"\r\n        (click)=\"scrollDown()\">\r\n        <mat-icon svgIcon=\"chevron-down\"></mat-icon>\r\n      </button>\r\n    </div>\r\n\r\n</mat-list>\r\n\r\n<div *ngIf=\"mode === actionbarMode.Overlay\">\r\n  <button class=\"buttonOverlay\"\r\n    mat-icon-button\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"'igo.common.actionbar.icon' | translate\"\r\n    [matMenuTriggerFor]=\"actionbarMenu\"\r\n    [disabled]=\"store.view.empty\"\r\n    [color]=\"iconColor\">\r\n    <mat-icon [svgIcon]=\"icon\"></mat-icon>\r\n  </button>\r\n\r\n  <mat-menu\r\n    #actionbarMenu=\"matMenu\"\r\n    class=\"igo-compact-menu igo-no-min-width-menu\"\r\n    overlapTrigger=\"true\"\r\n    [xPosition]=\"xPosition\"\r\n    [yPosition]=\"yPosition\"\r\n    [class]=\"overlayClass\">\r\n\r\n    <mat-list>\r\n      <ng-template ngFor let-action [ngForOf]=\"store.view.all$() | async\">\r\n        <igo-actionbar-item\r\n          color=\"accent\"\r\n          [withTitle]=\"withTitle\"\r\n          [withIcon]=\"withIcon\"\r\n          [color]=\"color\"\r\n          [action]=\"action\"\r\n          (trigger)=\"onTriggerAction(action)\">\r\n        </igo-actionbar-item>\r\n      </ng-template>\r\n    </mat-list>\r\n  </mat-menu>\r\n</div>\r\n<mat-card *ngIf=\"mode === actionbarMode.Context\" class=\"context-menu-card mat-elevation-z4\">\r\n  <mat-list>\r\n      <ng-template ngFor let-action [ngForOf]=\"store.view.all$() | async\">\r\n          <igo-actionbar-item\r\n            color=\"accent\"\r\n            [withTitle]=\"withTitle\"\r\n            [withIcon]=\"withIcon\"\r\n            [color]=\"color\"\r\n            [action]=\"action\"\r\n            (trigger)=\"onTriggerAction(action)\">\r\n          </igo-actionbar-item>\r\n        <br/>\r\n      </ng-template>\r\n  </mat-list>\r\n</mat-card>\r\n","import {\r\n  Component,\r\n  Input,\r\n  HostBinding,\r\n  ChangeDetectorRef,\r\n  ChangeDetectionStrategy,\r\n  OnChanges,\r\n  OnDestroy,\r\n  SimpleChanges,\r\n  ElementRef\r\n} from '@angular/core';\r\n\r\nimport { MediaService, Media } from '@igo2/core';\r\nimport { EntityStoreWatcher } from '../../entity';\r\nimport { Action } from '../shared/action.interfaces';\r\nimport { ActionbarMode } from '../shared/action.enums';\r\nimport { ActionStore } from '../shared/store';\r\nimport { Overlay } from '@angular/cdk/overlay';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\n/**\r\n * A list of action buttons.\r\n * This component can be displayed in one of two way: 'dock' or 'overlay'\r\n */\r\n@Component({\r\n  selector: 'igo-actionbar',\r\n  templateUrl: './actionbar.component.html',\r\n  styleUrls: ['./actionbar.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class ActionbarComponent implements OnDestroy, OnChanges {\r\n\r\n  /**\r\n   * Reference to the ActionbarMode enum for use in the template\r\n   * @internal\r\n   */\r\n  actionbarMode = ActionbarMode;\r\n\r\n  /**\r\n   * Whether the actionbar is collapsed (Dock mode)\r\n   * @internal\r\n   */\r\n  collapsed = false;\r\n\r\n  /**\r\n   * Toggle collapse action (Dock)\r\n   * @internal\r\n   */\r\n  toggleCollapseAction = {\r\n    id: 'actionbar_toggle',\r\n    icon: 'dots-vertical',\r\n    handler: () => {\r\n      this.collapsed = !this.collapsed;\r\n    }\r\n  };\r\n\r\n  /**\r\n   * Action store watcher\r\n   * @internal\r\n   */\r\n  private watcher: EntityStoreWatcher<Action>;\r\n\r\n  /**\r\n   * Height Condition for scroll button\r\n   */\r\n  heightCondition$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(false);\r\n\r\n  /**\r\n   * Position Condition for top scroll button\r\n   */\r\n  positionConditionTop$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(true);\r\n\r\n  /**\r\n   * Position Condition for low scroll button\r\n   */\r\n  positionConditionLow$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(true);\r\n\r\n  /**\r\n   * Action store\r\n   */\r\n  @Input() store: ActionStore;\r\n\r\n  /**\r\n   * Actionbar mode\r\n   */\r\n  @Input() mode: ActionbarMode = ActionbarMode.Dock;\r\n\r\n  /**\r\n   * Whether a toggle button should be displayed (Dock mode)\r\n   */\r\n  @Input() withToggleButton = false;\r\n\r\n  /**\r\n   * Whether a the actionbar should display buttons horizontally\r\n   */\r\n  @Input() horizontal = false;\r\n\r\n  /**\r\n   * Color\r\n   */\r\n  @Input() color = 'default';\r\n\r\n  /**\r\n   * Color of the button if action mode === overlay\r\n   */\r\n  @Input() iconColor = 'default';\r\n\r\n  /**\r\n   * Whether action titles are displayed\r\n   */\r\n  @Input() withTitle = true;\r\n\r\n  /**\r\n   * Whether action tooltips are displayed\r\n   */\r\n  @Input() withTooltip = true;\r\n\r\n  /**\r\n   * Whether action titles are displayed (condition for scroll button)\r\n   */\r\n  @Input() scrollActive = true;\r\n\r\n  /**\r\n   * Whether action icons are displayed\r\n   */\r\n  @Input() withIcon = true;\r\n\r\n  /**\r\n   * Which icon want to be shown\r\n   */\r\n  @Input() icon = 'dots-horizontal';\r\n\r\n  /**\r\n   * Overlay X position\r\n   */\r\n  @Input() xPosition = 'before';\r\n\r\n  /**\r\n   * Overlay Y position\r\n   */\r\n  @Input() yPosition = 'above';\r\n\r\n  /**\r\n   * Class to add to the actionbar overlay\r\n   */\r\n  @Input()\r\n  set overlayClass(value: string) {\r\n    this._overlayClass = value;\r\n  }\r\n  get overlayClass(): string {\r\n    return [this._overlayClass, 'igo-actionbar-overlay'].join(' ');\r\n  }\r\n  private _overlayClass = '';\r\n\r\n  /**\r\n   * @ignore\r\n   */\r\n  @HostBinding('class.with-title')\r\n  get withTitleClass() {\r\n    return this.withTitle;\r\n  }\r\n\r\n  /**\r\n   * @ignore\r\n   */\r\n  @HostBinding('class.with-icon')\r\n  get withIconClass() {\r\n    return this.withIcon;\r\n  }\r\n\r\n  /**\r\n   * @ignore\r\n   */\r\n  @HostBinding('class.horizontal')\r\n  get horizontalClass() {\r\n    return this.horizontal;\r\n  }\r\n\r\n  get heightCondition(): boolean {\r\n    const el = this.elRef.nativeElement;\r\n    if (this.scrollActive === false) {\r\n      if (el.clientHeight < el.scrollHeight) {\r\n        return true;\r\n      }\r\n    }\r\n    return false;\r\n  }\r\n\r\n  get positionConditionTop(): boolean {\r\n    if (this.elRef.nativeElement.scrollTop === 0) {\r\n      return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  get positionConditionLow(): boolean {\r\n    const el = this.elRef.nativeElement;\r\n    if (el.scrollTop >= (el.scrollHeight - el.clientHeight)) {\r\n      return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  get isDesktop(): boolean {\r\n    return this.mediaService.getMedia() === Media.Desktop;\r\n  }\r\n\r\n  constructor(\r\n    public overlay: Overlay,\r\n    private elRef: ElementRef,\r\n    private cdRef: ChangeDetectorRef,\r\n    public mediaService: MediaService) {}\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnChanges(changes: SimpleChanges) {\r\n    const store = changes.store;\r\n    if (store && store.currentValue !== store.previousValue) {\r\n      if (this.watcher !== undefined) {\r\n        this.watcher.destroy();\r\n      }\r\n      this.watcher = new EntityStoreWatcher(this.store, this.cdRef);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.watcher.destroy();\r\n  }\r\n\r\n  /**\r\n   * Invoke the action handler\r\n   * @internal\r\n   */\r\n  onTriggerAction(action: Action) {\r\n    const args = action.args || [];\r\n    action.handler(...args);\r\n  }\r\n\r\n  scrollDown() {\r\n    this.elRef.nativeElement.scrollBy(0, 52);\r\n  }\r\n\r\n  scrollUp() {\r\n    this.elRef.nativeElement.scrollBy(0, -52);\r\n  }\r\n\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatMenuModule } from '@angular/material/menu';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { ActionbarComponent } from './actionbar.component';\r\nimport { ActionbarItemComponent } from './actionbar-item.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoLanguageModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    MatTooltipModule,\r\n    MatMenuModule,\r\n    MatListModule,\r\n    MatCardModule,\r\n    MatCheckboxModule\r\n  ],\r\n  exports: [ActionbarComponent],\r\n  declarations: [ActionbarComponent, ActionbarItemComponent]\r\n})\r\nexport class IgoActionbarModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoActionbarModule } from './actionbar/actionbar.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoActionbarModule\r\n  ],\r\n  exports: [\r\n    IgoActionbarModule\r\n  ],\r\n  declarations: [],\r\n  providers: []\r\n})\r\nexport class IgoActionModule {}\r\n","import { Directive, Input, ElementRef, OnInit } from '@angular/core';\r\nimport { MatIconRegistry } from '@angular/material/icon';\r\n\r\n\r\n/**\r\n * This directive allow to add an icon inside a matBadge.\r\n * A value must be set into the matBadge directive ex: matBadge=\"icon\".\r\n * The badge content will be overrided by this current directive.\r\n */\r\n@Directive({\r\n  selector: '[igoMatBadgeIcon]'\r\n})\r\nexport class IgoBadgeIconDirective implements OnInit {\r\n  @Input()\r\n  set igoMatBadgeIcon(value: string) {\r\n    this.matIconRegistry.getNamedSvgIcon(value).subscribe((svgObj) => {\r\n      this.svg = svgObj;\r\n      this.updateSvg();\r\n    });\r\n  }\r\n  private svg: SVGElement;\r\n\r\n  @Input()\r\n  set matBadgeHidden(value: boolean) {\r\n    this.hidden = value;\r\n    this.updateHidden();\r\n  }\r\n  private hidden = false;\r\n\r\n  @Input()\r\n  set matBadgeDisabled(value: boolean) {\r\n    this.disabled = value;\r\n    this.updateDisabled();\r\n  }\r\n  private disabled = false;\r\n\r\n  @Input()\r\n  set igoMatBadgeInverseColor(value: boolean) {\r\n    this.inverseColor = value;\r\n    this.updateColor();\r\n  }\r\n  private inverseColor = false;\r\n\r\n  @Input()\r\n  set igoMatBadgeInheritColor(value: boolean) {\r\n    this.inheritColor = value;\r\n    this.updateColor();\r\n  }\r\n  private inheritColor = false;\r\n\r\n  get badge() {\r\n    return this.el.nativeElement.querySelector('.mat-badge-content');\r\n  }\r\n\r\n  private originalColor: string;\r\n\r\n  constructor(\r\n    private el: ElementRef,\r\n    private matIconRegistry: MatIconRegistry\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.badge.style.alignItems = 'center';\r\n    this.badge.style.justifyContent = 'center';\r\n\r\n    this.updateHidden();\r\n    this.updateColor();\r\n    this.updateSvg();\r\n  }\r\n\r\n  private updateSvg() {\r\n    if (!this.badge) {\r\n      return;\r\n    }\r\n    this.badge.innerHTML = '';\r\n    if (this.svg) {\r\n      this.badge.appendChild(this.svg);\r\n    }\r\n  }\r\n  private updateColor() {\r\n    if (!this.badge) {\r\n      return;\r\n    }\r\n\r\n    if (this.inheritColor) {\r\n      if (this.inverseColor) {\r\n        this.badge.style.color = 'currentColor';\r\n        this.badge.style.background = 'none';\r\n      } else {\r\n        this.badge.style.color = '';\r\n        this.badge.style.background = 'currentColor';\r\n      }\r\n    } else {\r\n      if (this.inverseColor) {\r\n        this.badge.style.color = window\r\n          .getComputedStyle(this.badge, null)\r\n          .getPropertyValue('background-color');\r\n        this.badge.style.background = 'none';\r\n      } else {\r\n        this.badge.style.color = '';\r\n        this.badge.style.background = '';\r\n      }\r\n    }\r\n    this.originalColor = this.badge.style.color;\r\n    this.updateDisabled();\r\n  }\r\n\r\n  private updateHidden() {\r\n    if (!this.badge) {\r\n      return;\r\n    }\r\n    this.badge.style.display = this.hidden ? 'none' : 'flex';\r\n  }\r\n\r\n  private updateDisabled() {\r\n    if (!this.badge || !this.inverseColor) {\r\n      return;\r\n    }\r\n    if (this.disabled) {\r\n      this.originalColor = this.badge.style.color;\r\n      this.badge.style.color = '#b9b9b9';\r\n    } else {\r\n      this.badge.style.color = this.originalColor;\r\n    }\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { IgoBadgeIconDirective } from './badge-icon.directive';\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\n@NgModule({\r\n  imports: [MatBadgeModule, MatIconModule],\r\n  declarations: [IgoBadgeIconDirective],\r\n  exports: [MatBadgeModule, IgoBadgeIconDirective]\r\n})\r\nexport class IgoMatBadgeIconModule {\r\n  static forRoot(): ModuleWithProviders<IgoMatBadgeIconModule> {\r\n    return {\r\n      ngModule: IgoMatBadgeIconModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import {\r\n  Directive,\r\n  ElementRef,\r\n  EventEmitter,\r\n  HostListener,\r\n  Output\r\n} from '@angular/core';\r\n\r\n@Directive({\r\n  selector: '[igoClickout]'\r\n})\r\nexport class ClickoutDirective {\r\n  @Output() clickout = new EventEmitter<MouseEvent>();\r\n\r\n  @HostListener('document:click', ['$event', '$event.target'])\r\n  handleMouseClick(event: MouseEvent, target: HTMLElement) {\r\n    if (!target) {\r\n      return;\r\n    }\r\n\r\n    if (!this.el.nativeElement.contains(target)) {\r\n      this.clickout.emit(event);\r\n    }\r\n  }\r\n\r\n  constructor(private el: ElementRef) {}\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { ClickoutDirective } from './clickout.directive';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [ClickoutDirective],\r\n  exports: [ClickoutDirective]\r\n})\r\nexport class IgoClickoutModule {\r\n  static forRoot(): ModuleWithProviders<IgoClickoutModule> {\r\n    return {\r\n      ngModule: IgoClickoutModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import {\r\n  Directive,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  HostListener,\r\n  ElementRef,\r\n  Renderer2\r\n} from '@angular/core';\r\n\r\n@Directive({\r\n  selector: '[igoCollapse]'\r\n})\r\nexport class CollapseDirective {\r\n  @Input()\r\n  get target() {\r\n    return this._target;\r\n  }\r\n  set target(value: Element) {\r\n    this._target = value;\r\n  }\r\n  private _target: Element;\r\n\r\n  @Input()\r\n  get collapsed(): boolean {\r\n    return this._collapsed;\r\n  }\r\n  set collapsed(collapsed: boolean) {\r\n    collapsed ? this.collapseTarget() : this.expandTarget();\r\n    this._collapsed = collapsed;\r\n    this.toggle.emit(collapsed);\r\n  }\r\n  private _collapsed = false;\r\n\r\n  @Output() toggle: EventEmitter<boolean> = new EventEmitter();\r\n\r\n  @HostListener('click')\r\n  click() {\r\n    this.collapsed = !this.collapsed;\r\n  }\r\n\r\n  constructor(private renderer: Renderer2, private el: ElementRef) {}\r\n\r\n  private collapseTarget() {\r\n    this.renderer.addClass(this.target, 'igo-collapsed');\r\n    this.renderer.addClass(this.el.nativeElement, 'collapsed');\r\n  }\r\n\r\n  private expandTarget() {\r\n    this.renderer.removeClass(this.target, 'igo-collapsed');\r\n    this.renderer.removeClass(this.el.nativeElement, 'collapsed');\r\n  }\r\n}\r\n","import { Component, Input, Output, EventEmitter } from '@angular/core';\r\n\r\n@Component({\r\n  selector: 'igo-collapsible',\r\n  templateUrl: './collapsible.component.html',\r\n  styleUrls: ['./collapsible.component.scss']\r\n})\r\nexport class CollapsibleComponent {\r\n  @Input()\r\n  get title() {\r\n    return this._title;\r\n  }\r\n  set title(value: string) {\r\n    this._title = value;\r\n  }\r\n  private _title = '';\r\n\r\n  @Input()\r\n  get collapsed() {\r\n    return this._collapsed;\r\n  }\r\n  set collapsed(value: boolean) {\r\n    this._collapsed = value;\r\n    this.toggle.emit(value);\r\n  }\r\n  private _collapsed = false;\r\n\r\n  @Output() toggle: EventEmitter<boolean> = new EventEmitter();\r\n}\r\n","<mat-list-item>\r\n  <mat-icon\r\n    svgIcon=\"chevron-up\" \r\n    class=\"igo-chevron\"\r\n    mat-list-avatar\r\n    igoCollapse\r\n    [target]=\"content\"\r\n    [collapsed]=\"collapsed\"\r\n    (toggle)=\"collapsed = $event\">\r\n  </mat-icon>\r\n  <h4 matLine>{{title}}</h4>\r\n</mat-list-item>\r\n\r\n<div #content>\r\n  <ng-content></ng-content>\r\n</div>\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatListModule } from '@angular/material/list';\r\n\r\nimport { CollapseDirective } from './collapse.directive';\r\nimport { CollapsibleComponent } from './collapsible.component';\r\n\r\n@NgModule({\r\n  imports: [MatIconModule, MatListModule],\r\n  declarations: [CollapsibleComponent, CollapseDirective],\r\n  exports: [CollapsibleComponent, CollapseDirective]\r\n})\r\nexport class IgoCollapsibleModule {\r\n  static forRoot(): ModuleWithProviders<IgoCollapsibleModule> {\r\n    return {\r\n      ngModule: IgoCollapsibleModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import { Component } from '@angular/core';\r\nimport { MatDialogRef } from '@angular/material/dialog';\r\n\r\n@Component({\r\n  selector: 'igo-confirm-dialog',\r\n  templateUrl: './confirm-dialog.component.html',\r\n  styleUrls: ['./confirm-dialog.component.scss']\r\n})\r\nexport class ConfirmDialogComponent {\r\n  public confirmMessage: string;\r\n\r\n  constructor(public dialogRef: MatDialogRef<ConfirmDialogComponent>) {}\r\n}\r\n","<h2 mat-dialog-title class=\"mat-typography\">{{'igo.common.confirmDialog.title' |translate}}</h2>\r\n<div mat-dialog-content class=\"mat-typography\">{{confirmMessage}}</div>\r\n<div mat-dialog-actions>\r\n  <button mat-button color=\"primary\" (click)=\"dialogRef.close(true)\">{{'igo.common.confirmDialog.confirmBtn' | translate}}</button>\r\n  <button mat-button (click)=\"dialogRef.close(false)\">{{'igo.common.confirmDialog.cancelBtn' |translate}}</button>\r\n</div>\r\n","import { Injectable } from '@angular/core';\r\nimport { MatDialog } from '@angular/material/dialog';\r\n\r\nimport { Observable } from 'rxjs';\r\n\r\nimport { ConfirmDialogComponent } from './confirm-dialog.component';\r\n\r\n@Injectable()\r\nexport class ConfirmDialogService {\r\n  constructor(private dialog: MatDialog) {}\r\n\r\n  public open(message: string): Observable<any> {\r\n    const dialogRef = this.dialog.open(ConfirmDialogComponent, {\r\n      disableClose: false\r\n    });\r\n    dialogRef.componentInstance.confirmMessage = message;\r\n\r\n    return dialogRef.afterClosed();\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatDialogModule } from '@angular/material/dialog';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { ConfirmDialogComponent } from './confirm-dialog.component';\r\nimport { ConfirmDialogService } from './confirm-dialog.service';\r\n\r\n@NgModule({\r\n  imports: [MatButtonModule, MatDialogModule, IgoLanguageModule],\r\n  declarations: [ConfirmDialogComponent],\r\n  exports: [ConfirmDialogComponent],\r\n  providers: [ConfirmDialogService]\r\n})\r\nexport class IgoConfirmDialogModule {\r\n  static forRoot(): ModuleWithProviders<IgoConfirmDialogModule> {\r\n    return {\r\n      ngModule: IgoConfirmDialogModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import {\r\n  Directive,\r\n  ElementRef,\r\n  EventEmitter,\r\n  HostListener,\r\n  Input,\r\n  Output,\r\n  ViewContainerRef\r\n} from '@angular/core';\r\nimport type { TemplateRef } from '@angular/core';\r\n\r\nimport { TemplatePortal } from '@angular/cdk/portal';\r\nimport { fromEvent, Subscription } from 'rxjs';\r\nimport { filter, take } from 'rxjs/operators';\r\nimport { Overlay, OverlayRef } from '@angular/cdk/overlay';\r\n\r\n@Directive({\r\n  selector: '[igoContextMenu]'\r\n})\r\nexport class ContextMenuDirective {\r\n  private overlayRef: OverlayRef | null;\r\n  private sub: Subscription;\r\n\r\n  @Input('igoContextMenu') menuContext: TemplateRef<any>;\r\n  @Output() menuPosition = new EventEmitter<{ x: number; y: number }>();\r\n\r\n  constructor(\r\n    public overlay: Overlay,\r\n    public viewContainerRef: ViewContainerRef,\r\n    private elementRef: ElementRef\r\n  ) {}\r\n\r\n  @HostListener('longpress', ['$event'])\r\n  @HostListener('contextmenu', ['$event'])\r\n  public onContextMenu(e: MouseEvent | TouchEvent): void {\r\n    let x;\r\n    let y;\r\n    if (e instanceof TouchEvent) {\r\n      x = e.touches[0].pageX;\r\n      y = e.touches[0].pageY;\r\n    } else if (e instanceof MouseEvent) {\r\n      x = e.x;\r\n      y = e.y;\r\n    }\r\n    if (!x || !y) {\r\n      return;\r\n    }\r\n\r\n    this.close();\r\n    e.preventDefault();\r\n    this.menuPosition.emit({ x, y });\r\n    this.overlayRef = null;\r\n    const positionStrategy = this.overlay\r\n      .position()\r\n      .flexibleConnectedTo({ x, y })\r\n      .withPositions([\r\n        {\r\n          originX: 'end',\r\n          originY: 'bottom',\r\n          overlayX: 'start',\r\n          overlayY: 'top'\r\n        }\r\n      ]);\r\n    this.overlayRef = this.overlay.create({\r\n      positionStrategy,\r\n      scrollStrategy: this.overlay.scrollStrategies.close()\r\n    });\r\n    this.overlayRef.attach(\r\n      new TemplatePortal(this.menuContext, this.viewContainerRef, {\r\n        $implicit: undefined\r\n      })\r\n    );\r\n\r\n    this.sub = fromEvent<MouseEvent>(document, 'click')\r\n      .pipe(\r\n        filter(event => {\r\n          const clickTarget = event.target as HTMLElement;\r\n          this.close();\r\n          return (\r\n            !!this.overlayRef &&\r\n            !this.overlayRef.overlayElement.contains(clickTarget)\r\n          );\r\n        }),\r\n        take(1)\r\n      )\r\n      .subscribe(() => this.close());\r\n\r\n    this.sub = fromEvent<MouseEvent>(document, 'contextmenu')\r\n      .pipe(\r\n        filter(event => {\r\n          const clickTarget = event.target as HTMLElement;\r\n          if (\r\n            clickTarget &&\r\n            !this.elementRef.nativeElement.contains(clickTarget) &&\r\n            !this.overlayRef.overlayElement.contains(clickTarget)\r\n          ) {\r\n            return true;\r\n          } else {\r\n            event.preventDefault();\r\n          }\r\n        }),\r\n        take(1)\r\n      )\r\n      .subscribe(() => this.close());\r\n  }\r\n\r\n  close() {\r\n    if (this.overlayRef) {\r\n      this.overlayRef.dispose();\r\n      this.overlayRef = null;\r\n    }\r\n    if (this.sub) {\r\n      this.sub.unsubscribe();\r\n    }\r\n  }\r\n}\r\n","import { Directive, HostListener, Output, EventEmitter, Input } from '@angular/core';\r\nimport { userAgent } from '@igo2/utils';\r\n\r\n\r\n/**\r\n * IgoLongPress trigger longpress event after a define duration.\r\n * This directive exist to patch the unavailable contextmenu event on iOS.\r\n * @param touchDuration touch duration in ms, default value is 400ms\r\n * @param iOSOnly define if longpress is triggered only for iOS, default value = true\r\n */\r\n@Directive({\r\n  selector: '[igoLongPress]'\r\n})\r\nexport class LongPressDirective {\r\n  private touchTimeout: any;\r\n  @Input() touchDuration: number = 400;\r\n  @Input() onlyIOS: boolean = true;\r\n  @Output() longpress = new EventEmitter();\r\n\r\n  constructor() { }\r\n\r\n\r\n  @HostListener('touchstart', ['$event'])\r\n  public touchstart(e: TouchEvent) {\r\n    this.touchTimeout = setTimeout(() => {\r\n      if (this.onlyIOS) {\r\n        if (userAgent.getOSName() === 'iOS') {\r\n          this.longpress.emit(e);\r\n        }\r\n      } else {\r\n        this.longpress.emit(e);\r\n      }\r\n    }, this.touchDuration);\r\n  }\r\n  @HostListener('touchmove')\r\n  @HostListener('touchcancel')\r\n  @HostListener('touchend')\r\n  public touchend() {\r\n    this.touchEnd();\r\n  }\r\n\r\n\r\n  private touchEnd() {\r\n    clearTimeout(this.touchTimeout);\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { ContextMenuDirective } from './context-menu.directive';\r\nimport { LongPressDirective } from './long-press.directive';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [ContextMenuDirective, LongPressDirective],\r\n  exports: [ContextMenuDirective, LongPressDirective]\r\n})\r\nexport class IgoContextMenuModule {\r\n  static forRoot(): ModuleWithProviders<IgoContextMenuModule> {\r\n    return {\r\n      ngModule: IgoContextMenuModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import { Component, Input } from '@angular/core';\r\n\r\n@Component({\r\n  selector: 'igo-custom-html',\r\n  templateUrl: './custom-html.component.html',\r\n  styleUrls: ['./custom-html.component.scss']\r\n})\r\nexport class CustomHtmlComponent {\r\n  @Input()\r\n  get html(): string {\r\n    return this._html;\r\n  }\r\n  set html(value: string) {\r\n    this._html = value;\r\n  }\r\n  private _html = '';\r\n\r\n  constructor() {}\r\n}\r\n","<div class=\"custom-html\" [innerHTML]=\"html | sanitizeHtml\"></div>\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { CustomHtmlComponent } from './custom-html.component';\r\nimport { SanitizeHtmlPipe } from './custom-html.pipe';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatIconModule,\r\n    MatTooltipModule,\r\n    MatInputModule,\r\n    MatButtonModule,\r\n    IgoLanguageModule\r\n  ],\r\n  exports: [SanitizeHtmlPipe, CustomHtmlComponent],\r\n  declarations: [SanitizeHtmlPipe, CustomHtmlComponent]\r\n})\r\nexport class IgoCustomHtmlModule {\r\n  static forRoot(): ModuleWithProviders<IgoCustomHtmlModule> {\r\n    return {\r\n      ngModule: IgoCustomHtmlModule\r\n    };\r\n  }\r\n}\r\n","import { HttpClient, HttpErrorResponse } from '@angular/common/http';\r\nimport { catchError, map } from 'rxjs/operators';\r\nimport { throwError } from 'rxjs';\r\n\r\nimport { DOMOptions, DOMValue } from './dom.interfaces';\r\nimport { Injectable } from '@angular/core';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class DOMService {\r\n\r\n  constructor(private http: HttpClient) {}\r\n\r\n  async getDom(dom: DOMOptions): Promise<DOMValue[]> {\r\n    const url = dom.url;\r\n    let result: DOMValue[];\r\n\r\n    await this.http.get<any>(url).pipe(\r\n      map(response => {\r\n        result = response;\r\n        return response;\r\n      }),\r\n      catchError((err: HttpErrorResponse) => {\r\n        return throwError(err);\r\n      })\r\n    ).toPromise();\r\n\r\n    return result;\r\n  }\r\n\r\n}\r\n","import { ModuleWithProviders, NgModule } from '@angular/core';\r\n\r\nimport { DOMService } from './dom.service';\r\n\r\n@NgModule({\r\n  providers: [DOMService]\r\n})\r\nexport class IgoDOMModule {\r\n  static forRoot(): ModuleWithProviders<IgoDOMModule> {\r\n    return {\r\n      ngModule: IgoDOMModule,\r\n      providers: [\r\n        DOMService\r\n      ]\r\n    };\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { DragAndDropDirective } from './drag-drop.directive';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [DragAndDropDirective],\r\n  exports: [DragAndDropDirective]\r\n})\r\nexport class IgoDrapDropModule {\r\n  static forRoot(): ModuleWithProviders<IgoDrapDropModule> {\r\n    return {\r\n      ngModule: IgoDrapDropModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import {\r\n  ComponentFactory,\r\n  ComponentRef,\r\n  ViewContainerRef\r\n} from '@angular/core';\r\n\r\nimport { Observable, Subscription } from 'rxjs';\r\n\r\n/**\r\n * This class is used in the DynamicComponentOutlet component. It holds\r\n * a reference to a component factory and can render that component\r\n * in a target element on demand. It's also possible to set inputs\r\n * and to subscribe to outputs.\r\n */\r\nexport class DynamicComponent<C> {\r\n\r\n  /**\r\n   * Component reference\r\n   */\r\n  private componentRef: ComponentRef<C>;\r\n\r\n  /**\r\n   * Subscriptions to the component's outputs. Those need\r\n   * to be unsubscribed when the component is destroyed.\r\n   */\r\n  private subscriptions: Subscription[] = [];\r\n\r\n  /**\r\n   * Component target element\r\n   */\r\n  private target: ViewContainerRef;\r\n\r\n  /**\r\n   * Component inputs\r\n   */\r\n  private inputs: {[key: string]: any} = {};\r\n\r\n  /**\r\n   * Subscriptions to the component's async inputs\r\n   */\r\n  private inputs$$: {[key: string]: Subscription} = {};\r\n\r\n  /**\r\n   * Subscribers to the component's outputs\r\n   */\r\n  private subscribers: {[key: string]: (event: any) => void} = {};\r\n\r\n  constructor(private componentFactory: ComponentFactory<C>) {}\r\n\r\n  /**\r\n   * Render the component to a target element.\r\n   * Set it's inputs and subscribe to it's outputs.\r\n   * @param target Target element\r\n   */\r\n  setTarget(target: ViewContainerRef) {\r\n    this.target = target;\r\n    this.componentRef = target.createComponent(this.componentFactory);\r\n    this.updateInputs(this.inputs);\r\n    this.updateSubscribers(this.subscribers);\r\n  }\r\n\r\n  /**\r\n   * Destroy this component. That means, removing from it's target\r\n   * element and unsubscribing to it's outputs.\r\n   */\r\n  destroy() {\r\n    if (this.target !== undefined) {\r\n      this.target.clear();\r\n    }\r\n    if (this.componentRef !== undefined) {\r\n      this.componentRef.destroy();\r\n      this.componentRef = undefined;\r\n    }\r\n    this.unobserveAllInputs();\r\n    this.unsubscribeAll();\r\n  }\r\n\r\n  /**\r\n   * Update the component inputs. This is an update so any\r\n   * key not defined won't be overwritten.\r\n   */\r\n  updateInputs(inputs: {[key: string]: any}) {\r\n    this.inputs = inputs;\r\n    if (this.componentRef === undefined) {\r\n      return;\r\n    }\r\n\r\n    const instance = this.componentRef.instance;\r\n    const allowedInputs = this.componentFactory.inputs;\r\n    allowedInputs.forEach((value: {propName: string; templateName: string; }) => {\r\n      const key = value.propName;\r\n\r\n      this.unobserveInput(key);\r\n\r\n      const inputValue = inputs[key];\r\n      if (inputs.hasOwnProperty(key)) {\r\n        if (inputValue instanceof Observable) {\r\n          this.observeInput(key, inputValue);\r\n        } else {\r\n          this.setInputValue(instance, key, inputValue);\r\n        }\r\n      }\r\n    });\r\n\r\n    if (typeof (instance as any).onUpdateInputs === 'function') {\r\n      (instance as any).onUpdateInputs();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set an instance's input value\r\n   * @param instance Component instance\r\n   * @param key Input key\r\n   * @param value Input value\r\n   */\r\n  private setInputValue(instance: C, key: string, value: any) {\r\n    const currentValue = instance[key];\r\n    if (value === currentValue) {\r\n      return;\r\n    }\r\n\r\n    const prototype = Object.getPrototypeOf(instance);\r\n    const descriptor = Object.getOwnPropertyDescriptor(prototype, key);\r\n    if (descriptor !== undefined && descriptor.set !== undefined) {\r\n      descriptor.set.call(instance, value);\r\n    } else {\r\n      instance[key] = value;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update the component subscribers. This is an update so any\r\n   * key not defined won't be overwritten.\r\n   */\r\n  updateSubscribers(subscribers: {[key: string]: (event: any) => void}) {\r\n    this.subscribers = subscribers;\r\n    if (this.componentRef === undefined) {\r\n      return;\r\n    }\r\n\r\n    const instance = this.componentRef.instance;\r\n    const allowedSubscribers = this.componentFactory.outputs;\r\n    allowedSubscribers.forEach((value: {propName: string; templateName: string; }) => {\r\n      const key = value.propName;\r\n      if (subscribers.hasOwnProperty(key)) {\r\n        const emitter = instance[key];\r\n        const subscriber = subscribers[key];\r\n        if (Array.isArray(subscriber)) {\r\n          subscriber.forEach((_subscriber) => {\r\n            this.subscriptions.push(emitter.subscribe(_subscriber));\r\n          });\r\n        } else {\r\n          this.subscriptions.push(emitter.subscribe(subscriber));\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Subscribe to an observable input and update the component's input value\r\n   * accordingly\r\n   * @param key Input key\r\n   * @param observable Observable\r\n   */\r\n  private observeInput(key: string, observable: Observable<any>) {\r\n    this.inputs$$[key] = observable.subscribe((value: any) => {\r\n      const instance = this.componentRef.instance;\r\n      this.setInputValue(instance, key, value);\r\n\r\n      if (typeof (instance as any).onUpdateInputs === 'function') {\r\n        (instance as any).onUpdateInputs();\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to an observable input\r\n   * @param key Input key\r\n   */\r\n  private unobserveInput(key: string) {\r\n    if (this.inputs$$[key] !== undefined) {\r\n      this.inputs$$[key].unsubscribe();\r\n      this.inputs$$[key] = undefined;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to all outputs.\r\n   */\r\n  private unobserveAllInputs() {\r\n    Object.values(this.inputs$$).forEach((s: Subscription | undefined) => {\r\n      if (s !== undefined) {\r\n        s.unsubscribe();\r\n      }\r\n    });\r\n    this.inputs$$ = {};\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to all outputs.\r\n   */\r\n  private unsubscribeAll() {\r\n    this.subscriptions.forEach((s: Subscription) => s.unsubscribe());\r\n    this.subscriptions = [];\r\n  }\r\n\r\n}\r\n","import {\r\n  ComponentFactoryResolver,\r\n  Injectable\r\n} from '@angular/core';\r\n\r\nimport { DynamicComponent } from './dynamic-component';\r\n\r\n/**\r\n * Service to creates DynamicComponent instances from base component classes\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class DynamicComponentService {\r\n\r\n  constructor(private resolver: ComponentFactoryResolver) {}\r\n\r\n  /**\r\n   * Creates a DynamicComponent instance from a base component class\r\n   * @param componentCls The component class\r\n   * @returns DynamicComponent instance\r\n   */\r\n  create(componentCls: any): DynamicComponent<any> {\r\n    const factory = this.resolver.resolveComponentFactory(componentCls as any);\r\n    return new DynamicComponent<typeof componentCls>(factory);\r\n  }\r\n}\r\n","import {\r\n  Input,\r\n  ChangeDetectorRef,\r\n  ChangeDetectionStrategy,\r\n  Component,\r\n  OnChanges,\r\n  OnDestroy,\r\n  SimpleChanges,\r\n  ViewContainerRef,\r\n  ViewChild\r\n} from '@angular/core';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport { DynamicComponent } from '../shared/dynamic-component';\r\nimport { DynamicComponentService } from '../shared/dynamic-component.service';\r\n\r\n@Component({\r\n  selector: 'igo-dynamic-outlet',\r\n  templateUrl: 'dynamic-outlet.component.html',\r\n  styleUrls: ['dynamic-outlet.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class DynamicOutletComponent implements OnChanges, OnDestroy {\r\n  /**\r\n   * The dynamic component base class or the dynamic component itself\r\n   */\r\n  @Input() component: DynamicComponent<any> | any;\r\n\r\n  /**\r\n   * The dynamic component inputs\r\n   */\r\n  @Input() inputs: { [key: string]: any } = {};\r\n\r\n  /**\r\n   * The subscribers to the dynamic component outputs\r\n   */\r\n  @Input() subscribers: { [key: string]: (event: any) => void } = {};\r\n\r\n  /**\r\n   * The dynamic component\r\n   */\r\n  private dynamicComponent: DynamicComponent<any>;\r\n\r\n  /**\r\n   * The view element to render the component to\r\n   * @ignore\r\n   */\r\n  @ViewChild('target', { read: ViewContainerRef, static: true })\r\n  private target: ViewContainerRef;\r\n\r\n  constructor(\r\n    private dynamicComponentService: DynamicComponentService,\r\n    private cdRef: ChangeDetectorRef\r\n  ) {}\r\n\r\n  /**\r\n   * If the dynamic component changes, create it.\r\n   * If the inputs or subscribers change, update the current component's\r\n   * inputs or subscribers.\r\n   * @internal\r\n   */\r\n  ngOnChanges(changes: SimpleChanges) {\r\n    const component = changes.component;\r\n    const inputs = changes.inputs;\r\n    const subscribers = changes.subscribers;\r\n    const eq = ObjectUtils.objectsAreEquivalent;\r\n\r\n    if (!component || !component.currentValue) {\r\n      return;\r\n    }\r\n\r\n    if (component.currentValue !== component.previousValue) {\r\n      this.createComponent(component.currentValue);\r\n    } else {\r\n      const inputsAreEquivalents =\r\n        inputs && eq(inputs.currentValue || {}, inputs.previousValue || {});\r\n      const subscribersAreEquivalents =\r\n        subscribers &&\r\n        eq(subscribers.currentValue || {}, subscribers.previousValue || {});\r\n\r\n      if (inputsAreEquivalents === false) {\r\n        this.updateInputs();\r\n      }\r\n\r\n      if (subscribersAreEquivalents === false) {\r\n        this.updateSubscribers();\r\n      }\r\n    }\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n  /**\r\n   * Destroy the dynamic component and all it's subscribers\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    if (this.dynamicComponent) {\r\n      this.dynamicComponent.destroy();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create a  DynamicComponent out of the component class and render it.\r\n   * @internal\r\n   */\r\n  private createComponent(component: DynamicComponent<any> | any) {\r\n    if (this.dynamicComponent !== undefined) {\r\n      this.dynamicComponent.destroy();\r\n    }\r\n    this.dynamicComponent =\r\n      component instanceof DynamicComponent\r\n        ? component\r\n        : this.dynamicComponentService.create(component);\r\n    this.renderComponent();\r\n  }\r\n\r\n  /**\r\n   * Create and render the dynamic component. Set it's inputs and subscribers\r\n   * @internal\r\n   */\r\n  private renderComponent() {\r\n    this.updateInputs();\r\n    this.updateSubscribers();\r\n    this.dynamicComponent.setTarget(this.target);\r\n  }\r\n\r\n  /**\r\n   * Update the dynamic component inputs. This is an update so any\r\n   * key not defined won't be overwritten.\r\n   * @internal\r\n   */\r\n  private updateInputs() {\r\n    this.dynamicComponent.updateInputs(this.inputs);\r\n  }\r\n\r\n  /**\r\n   * Update the dynamic component subscribers. This is an update so any\r\n   * key not defined won't be overwritten.\r\n   * @internal\r\n   */\r\n  private updateSubscribers() {\r\n    this.dynamicComponent.updateSubscribers(this.subscribers);\r\n  }\r\n}\r\n","<ng-template #target></ng-template>\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { DynamicOutletComponent } from './dynamic-outlet.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule\r\n  ],\r\n  exports: [\r\n    DynamicOutletComponent\r\n  ],\r\n  declarations: [\r\n    DynamicOutletComponent\r\n  ]\r\n})\r\nexport class IgoDynamicOutletModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoDynamicOutletModule } from './dynamic-outlet/dynamic-outlet.module';\r\nimport { DynamicComponentService } from './shared/dynamic-component.service';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoDynamicOutletModule\r\n  ],\r\n  exports: [\r\n    IgoDynamicOutletModule\r\n  ],\r\n  providers: [\r\n    DynamicComponentService\r\n  ]\r\n})\r\nexport class IgoDynamicComponentModule {}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { FlexibleComponent } from './flexible.component';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [FlexibleComponent],\r\n  exports: [FlexibleComponent]\r\n})\r\nexport class IgoFlexibleModule {\r\n  static forRoot(): ModuleWithProviders<IgoFlexibleModule> {\r\n    return {\r\n      ngModule: IgoFlexibleModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  OnChanges,\r\n  SimpleChanges,\r\n  ChangeDetectionStrategy,\r\n  ViewChild,\r\n  ElementRef\r\n} from '@angular/core';\r\n\r\nimport { t } from 'typy';\r\n\r\nimport { Form, FormField, FormFieldGroup } from '../shared/form.interfaces';\r\nimport { getAllFormFields } from '../shared/form.utils';\r\n\r\n/**\r\n * A configurable form\r\n */\r\n@Component({\r\n  selector: 'igo-form',\r\n  templateUrl: './form.component.html',\r\n  styleUrls: ['./form.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class FormComponent implements OnChanges {\r\n\r\n  /**\r\n   * Form\r\n   */\r\n  @Input() form: Form;\r\n\r\n  /**\r\n   * Input data\r\n   */\r\n  @Input() formData: { [key: string]: any};\r\n\r\n  /**\r\n   * Form autocomplete\r\n   */\r\n  @Input() autocomplete: string = 'off';\r\n\r\n  /**\r\n   * Event emitted when the form is submitted\r\n   */\r\n  @Output() submitForm = new EventEmitter<{[key: string]: any}>();\r\n\r\n  @ViewChild('buttons', { static: true }) buttons: ElementRef;\r\n\r\n  get hasButtons(): boolean {\r\n    return this.buttons.nativeElement.children.length !== 0;\r\n  }\r\n\r\n  constructor() {}\r\n\r\n  /**\r\n   * Is the entity or the template change, recreate the form or repopulate it.\r\n   * @internal\r\n   */\r\n  ngOnChanges(changes: SimpleChanges) {\r\n    const formData = changes.formData;\r\n    if (formData && formData.currentValue !== formData.previousValue) {\r\n      if (formData.currentValue === undefined) {\r\n        this.clear();\r\n      } else {\r\n        this.setData(formData.currentValue);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Transform the form data to a feature and emit an event\r\n   * @param event Form submit event\r\n   * @internal\r\n   */\r\n  onSubmit() {\r\n    this.submitForm.emit(this.getData());\r\n  }\r\n\r\n  getData(): { [key: string]: any} {\r\n    const data = {};\r\n    getAllFormFields(this.form).forEach((field: FormField) => {\r\n      this.updateDataWithFormField(data, field);\r\n    });\r\n    return data;\r\n  }\r\n\r\n  private setData(data: {[key: string]: any}) {\r\n    this.form.fields.forEach((field: FormField) => {\r\n      field.control.setValue(t(data, field.name).safeObject);\r\n    });\r\n\r\n    this.form.groups.forEach((group: FormFieldGroup) => {\r\n      group.fields.forEach((field: FormField) => {\r\n        field.control.setValue(t(data, field.name).safeObject);\r\n      });\r\n    });\r\n  }\r\n\r\n  private updateDataWithFormField(data: { [key: string]: any}, field: FormField) {\r\n    const control = field.control;\r\n    if (!control.disabled) {\r\n      data[field.name] = control.value;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear form\r\n   */\r\n  private clear() {\r\n    this.form.control.reset();\r\n  }\r\n\r\n}\r\n","import { AbstractControl } from '@angular/forms';\r\n\r\nimport { Form, FormField, FormFieldGroup } from './form.interfaces';\r\n\r\nexport function formControlIsRequired(control: AbstractControl): boolean {\r\n  if (control.validator) {\r\n    const validator = control.validator({} as AbstractControl);\r\n    if (validator && validator.required) {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  if ((control as any).controls) {\r\n    const requiredControl = Object.keys((control as any).controls).find((key: string) => {\r\n      return formControlIsRequired((control as any).controls[key]);\r\n    });\r\n    return requiredControl !== undefined;\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\nexport function getDefaultErrorMessages(): {[key: string]: string} {\r\n  return {\r\n    required: 'igo.common.form.errors.required'\r\n  };\r\n}\r\n\r\nexport function getControlErrorMessage(control: AbstractControl, messages: {[key: string]: string}): string {\r\n  const errors = control.errors || {};\r\n  const errorKeys = Object.keys(errors);\r\n  const errorMessages = errorKeys\r\n    .map((key: string) => messages[key])\r\n    .filter((message: string) => message !== undefined);\r\n  return errorMessages.length > 0 ? errorMessages[0] : '';\r\n}\r\n\r\nexport function getAllFormFields(form: Form): FormField[] {\r\n  return form.groups.reduce((acc: FormField[], group: FormFieldGroup) => {\r\n    return acc.concat(group.fields);\r\n  }, [].concat(form.fields));\r\n}\r\n\r\nexport function getFormFieldByName(form: Form, name: string): FormField {\r\n  const fields = getAllFormFields(form);\r\n  return fields.find((field: FormField) => {\r\n    return field.name === name;\r\n  });\r\n}\r\n","\r\n<form\r\n  [autocomplete]=\"autocomplete\"\r\n  [formGroup]=\"form.control\"\r\n  (ngSubmit)=\"onSubmit()\">\r\n  <div class=\"igo-form-body\" [ngClass]=\"{'igo-form-body-with-buttons': hasButtons}\">\r\n    <div class=\"igo-form-content\">\r\n      <ng-content></ng-content>\r\n    </div>\r\n    <div #buttons class=\"igo-form-buttons\">\r\n      <ng-content select=\"[formButtons]\"></ng-content>\r\n    </div>\r\n  </div>\r\n</form>\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\n\r\nimport { FormComponent } from './form.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    ReactiveFormsModule\r\n  ],\r\n  exports: [\r\n    FormComponent,\r\n    FormsModule,\r\n    ReactiveFormsModule\r\n  ],\r\n  declarations: [\r\n    FormComponent\r\n  ]\r\n})\r\nexport class IgoFormFormModule {}\r\n","import { Injectable } from '@angular/core';\r\nimport { UntypedFormBuilder, Validators, ValidatorFn } from '@angular/forms';\r\n\r\nimport {\r\n  Form,\r\n  FormField,\r\n  FormFieldConfig,\r\n  FormFieldGroup,\r\n  FormFieldGroupConfig\r\n} from './form.interfaces';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class FormService {\r\n\r\n  constructor(private formBuilder: UntypedFormBuilder) {}\r\n\r\n  form(fields: FormField[], groups: FormFieldGroup[]): Form {\r\n    const control = this.formBuilder.group({});\r\n    fields.forEach((field: FormField) => {\r\n      control.addControl(field.name, field.control);\r\n    });\r\n    groups.forEach((group: FormFieldGroup) => {\r\n      control.addControl(group.name, group.control);\r\n    });\r\n\r\n    return {fields, groups, control};\r\n  }\r\n\r\n  group(config: FormFieldGroupConfig, fields: FormField[]): FormFieldGroup {\r\n    const options = config.options || {};\r\n    const control = this.formBuilder.group({});\r\n    fields.forEach((field: FormField) => {\r\n      control.addControl(field.name, field.control);\r\n    });\r\n\r\n    if (options.validator) {\r\n      const validators = this.getValidators(options.validator); // convert string to actual validator\r\n      control.setValidators(validators);\r\n    }\r\n\r\n    return Object.assign({}, config, {fields, control}) as FormFieldGroup;\r\n  }\r\n\r\n  field(config: FormFieldConfig): FormField {\r\n    const options = config.options || {};\r\n    const state = {\r\n      value: '',\r\n      disabled: options.disabled\r\n    };\r\n    const control = this.formBuilder.control(state);\r\n\r\n    if (options.validator) {\r\n      const validators = this.getValidators(options.validator); // convert string to actual validator\r\n      control.setValidators(validators);\r\n    }\r\n\r\n    return Object.assign({type: 'text'}, config, {control}) as FormField;\r\n  }\r\n\r\n  extendFieldConfig(config: FormFieldConfig, partial: Partial<FormFieldConfig>): FormFieldConfig {\r\n    const options = Object.assign({}, config.options || {}, partial.options || {});\r\n    const inputs = Object.assign({}, config.inputs || {}, partial.inputs || {});\r\n    const subscribers = Object.assign({}, config.subscribers || {}, partial.subscribers || {});\r\n    return Object.assign({}, config, {options, inputs, subscribers});\r\n  }\r\n\r\n  private getValidators(validatorOption: string | string[] | ValidatorFn): ValidatorFn | ValidatorFn[] {\r\n    if (Array.isArray(validatorOption)) {\r\n      return validatorOption.map((validatorStr) => {\r\n        return this.getValidator(validatorStr);\r\n      });\r\n    }\r\n\r\n    return this.getValidator(validatorOption);\r\n  }\r\n\r\n  private getValidator(validatorStr: string | ValidatorFn): ValidatorFn {\r\n    if (typeof validatorStr !== 'string') {\r\n      return validatorStr;\r\n    }\r\n\r\n    // regex pattern to extract arguments from string for e.g applying on \"minLength(8)\" would extract 8\r\n    const re = /^([a-zA-Z]{3,15})\\((.{0,20})\\)$/;\r\n    const match = validatorStr.match(re);\r\n\r\n    if (!match) {\r\n      return Validators[validatorStr];\r\n    }\r\n\r\n    const name = match[1];\r\n    const args = match[2];\r\n    return Validators[name](args);\r\n  }\r\n\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\n/**\r\n * Service where all available form fields are registered.\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class FormFieldService {\r\n\r\n  static fields: {[key: string]: any} = {};\r\n\r\n  static register(type: string, component: any) {\r\n    FormFieldService.fields[type] = component;\r\n  }\r\n\r\n  constructor() {}\r\n\r\n  /**\r\n   * Return field component by type\r\n   * @param type Field type\r\n   * @returns Field component\r\n   */\r\n  getFieldByType(type: string): any {\r\n    return FormFieldService.fields[type];\r\n  }\r\n\r\n}\r\n","\r\n\r\n<ng-container *ngIf=\"field !== undefined\">\r\n  <igo-dynamic-outlet\r\n    [component]=\"getFieldComponent()\"\r\n    [inputs]=\"getFieldInputs()\"\r\n    [subscribers]=\"getFieldSubscribers()\">\r\n  </igo-dynamic-outlet>\r\n</ng-container>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\n\r\nimport { FormField, FormFieldInputs, FormFieldOptions } from '../shared/form.interfaces';\r\nimport { FormFieldService } from '../shared/form-field.service';\r\nimport { getDefaultErrorMessages } from '../shared';\r\n\r\n/**\r\n * This component renders the proper form input based on\r\n * the field configuration it receives.\r\n */\r\n@Component({\r\n  selector: 'igo-form-field',\r\n  templateUrl: './form-field.component.html',\r\n  styleUrls: ['./form-field.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class FormFieldComponent {\r\n\r\n  /**\r\n   * Field configuration\r\n   */\r\n  @Input() field: FormField;\r\n\r\n  /**\r\n   * Field inputs cache\r\n   */\r\n  private fieldInputs: FormFieldInputs = undefined;\r\n\r\n  /**\r\n   * Field subscribers cache\r\n   */\r\n  private fieldSubscribers: {[key: string]: ({field: FormField, control: FormControl}) => void } = undefined;\r\n\r\n  get fieldOptions(): FormFieldOptions {\r\n    return this.field.options || {};\r\n  }\r\n\r\n  constructor(private formFieldService: FormFieldService) {}\r\n\r\n  getFieldComponent(): any {\r\n    return this.formFieldService.getFieldByType(this.field.type || 'text');\r\n  }\r\n\r\n  getFieldInputs(): FormFieldInputs {\r\n    if (this.fieldInputs !== undefined) {\r\n      return this.fieldInputs;\r\n    }\r\n\r\n    const errors = this.fieldOptions.errors || {};\r\n    this.fieldInputs = Object.assign(\r\n      {\r\n        placeholder: this.field.title,\r\n        disableSwitch: this.fieldOptions.disableSwitch || false\r\n      },\r\n      Object.assign({}, this.field.inputs || {}),\r\n      {\r\n        formControl: this.field.control,\r\n        errors: Object.assign({}, getDefaultErrorMessages(), errors)\r\n      }\r\n    );\r\n    return this.fieldInputs;\r\n  }\r\n\r\n  getFieldSubscribers(): {[key: string]: ({field: FormField, control: FormControl}) => void } {\r\n    if (this.fieldSubscribers !== undefined) {\r\n      return this.fieldSubscribers;\r\n    }\r\n\r\n    this.fieldSubscribers = Object.assign({}, this.field.subscribers || {});\r\n    return this.fieldSubscribers;\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSelectModule } from '@angular/material/select';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoDynamicOutletModule } from '../../dynamic-component/dynamic-outlet/dynamic-outlet.module';\r\n\r\nimport { FormFieldComponent } from './form-field.component';\r\nimport { FormFieldSelectComponent } from './form-field-select.component';\r\nimport { FormFieldTextComponent } from './form-field-text.component';\r\nimport { FormFieldTextareaComponent } from './form-field-textarea.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    MatIconModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatSelectModule,\r\n    IgoLanguageModule,\r\n    IgoDynamicOutletModule\r\n  ],\r\n  exports: [\r\n    FormFieldComponent,\r\n    FormFieldSelectComponent,\r\n    FormFieldTextComponent,\r\n    FormFieldTextareaComponent\r\n  ],\r\n  declarations: [\r\n    FormFieldComponent,\r\n    FormFieldSelectComponent,\r\n    FormFieldTextComponent,\r\n    FormFieldTextareaComponent\r\n  ]\r\n})\r\nexport class IgoFormFieldModule {}\r\n","<div\r\n  *ngIf=\"group && group.fields.length > 0\"\r\n  class=\"igo-form-group-fields\">\r\n  <div\r\n    *ngFor=\"let field of group.fields\"\r\n    class=\"igo-form-field-wrapper\"\r\n    [ngClass]=\"getFieldNgClass(field)\">\r\n    <igo-form-field [field]=\"field\"></igo-form-field>\r\n  </div>\r\n</div>\r\n\r\n<div class=\"igo-form-group-extra-content\">\r\n  <ng-content></ng-content>\r\n</div>\r\n\r\n<mat-error *ngIf=\"formControl.errors\">{{getErrorMessage() | translate}}</mat-error>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\nimport { UntypedFormGroup } from '@angular/forms';\r\n\r\nimport { getControlErrorMessage } from '../shared/form.utils';\r\nimport { FormField, FormFieldGroup } from '../shared/form.interfaces';\r\n\r\n/**\r\n * A configurable form, optionnally bound to an entity\r\n * (for example in case of un update). Submitting that form\r\n * emits an event with the form data but no other operation is performed.\r\n */\r\n@Component({\r\n  selector: 'igo-form-group',\r\n  templateUrl: './form-group.component.html',\r\n  styleUrls: ['./form-group.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class FormGroupComponent {\r\n\r\n  /**\r\n   * Form field group\r\n   */\r\n  @Input() group: FormFieldGroup;\r\n\r\n  /**\r\n   * Field placeholder\r\n   */\r\n  @Input() errors: {[key: string]: string};\r\n\r\n  /**\r\n   * Form group control\r\n   */\r\n  get formControl(): UntypedFormGroup { return this.group.control; }\r\n\r\n  constructor() {}\r\n\r\n  /**\r\n   * Return the number of columns a field should occupy.\r\n   * The maximum allowed is 2, even if the field config says more.\r\n   * @param field Field\r\n   * @returns Number of columns\r\n   * @internal\r\n   */\r\n  getFieldColSpan(field: FormField): number {\r\n    let colSpan = 2;\r\n    const options = field.options || {};\r\n    if (options.cols && options.cols > 0) {\r\n      colSpan = Math.min(options.cols, 2);\r\n    }\r\n\r\n    return colSpan;\r\n  }\r\n\r\n  /**\r\n   * Return the number of columns a field should occupy.\r\n   * The maximum allowed is 2, even if the field config says more.\r\n   * @param field Field\r\n   * @returns Number of columns\r\n   * @internal\r\n   */\r\n  getFieldNgClass(field: FormField): {[key: string]: boolean} {\r\n    const colspan = this.getFieldColSpan(field);\r\n    return {[`igo-form-field-colspan-${colspan}`]: true};\r\n  }\r\n\r\n  /**\r\n   * Get error message\r\n   */\r\n  getErrorMessage(): string {\r\n    const options = this.group.options || {};\r\n    return getControlErrorMessage(this.formControl, options.errors || {});\r\n  }\r\n\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { IgoFormFieldModule } from '../form-field/form-field.module';\r\nimport { FormGroupComponent } from './form-group.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatFormFieldModule,\r\n    IgoLanguageModule,\r\n    IgoFormFieldModule\r\n  ],\r\n  exports: [\r\n    FormGroupComponent\r\n  ],\r\n  declarations: [\r\n    FormGroupComponent\r\n  ]\r\n})\r\nexport class IgoFormGroupModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoFormFormModule } from './form/form.module';\r\nimport { IgoFormGroupModule } from './form-group/form-group.module';\r\nimport { IgoFormFieldModule } from './form-field/form-field.module';\r\nimport { FormService } from './shared/form.service';\r\nimport { FormFieldService } from './shared/form-field.service';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoFormGroupModule,\r\n    IgoFormFieldModule\r\n  ],\r\n  exports: [\r\n    IgoFormFormModule,\r\n    IgoFormGroupModule,\r\n    IgoFormFieldModule\r\n  ],\r\n  declarations: [],\r\n  providers: [\r\n    FormService,\r\n    FormFieldService\r\n  ]\r\n})\r\nexport class IgoFormModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\n\r\nimport { MatSelectModule } from '@angular/material/select';\r\n\r\nimport { EntitySelectorComponent } from './entity-selector.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    MatSelectModule\r\n  ],\r\n  exports: [EntitySelectorComponent],\r\n  declarations: [EntitySelectorComponent]\r\n})\r\nexport class IgoEntitySelectorModule {}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { StopDropPropagationDirective } from './stop-drop-propagation.directive';\r\nimport { StopPropagationDirective } from './stop-propagation.directive';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [StopDropPropagationDirective, StopPropagationDirective],\r\n  exports: [StopDropPropagationDirective, StopPropagationDirective]\r\n})\r\nexport class IgoStopPropagationModule {\r\n  static forRoot(): ModuleWithProviders<IgoStopPropagationModule> {\r\n    return {\r\n      ngModule: IgoStopPropagationModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { EntityTablePaginatorComponent } from './entity-table-paginator.component';\r\nimport { MatPaginatorModule } from '@angular/material/paginator';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    MatPaginatorModule,\r\n  ],\r\n  exports: [\r\n    EntityTablePaginatorComponent\r\n  ],\r\n  declarations: [\r\n    EntityTablePaginatorComponent,\r\n  ]\r\n})\r\nexport class IgoEntityTablePaginatorModule {}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { ImageErrorDirective } from './image-error.directive';\r\nimport { SecureImagePipe } from './secure-image.pipe';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [SecureImagePipe, ImageErrorDirective],\r\n  exports: [SecureImagePipe, ImageErrorDirective]\r\n})\r\nexport class IgoImageModule {\r\n  static forRoot(): ModuleWithProviders<IgoImageModule> {\r\n    return {\r\n      ngModule: IgoImageModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatSortModule } from '@angular/material/sort';\r\nimport { MatTableModule } from '@angular/material/table';\r\nimport { MatAutocompleteModule } from '@angular/material/autocomplete';\r\n\r\nimport { IgoStopPropagationModule } from '../../stop-propagation/stop-propagation.module';\r\nimport { IgoCustomHtmlModule } from '../../custom-html/custom-html.module';\r\nimport { EntityTableRowDirective } from './entity-table-row.directive';\r\nimport { EntityTableComponent } from './entity-table.component';\r\nimport { MatPaginatorModule } from '@angular/material/paginator';\r\nimport { IgoEntityTablePaginatorModule } from '../entity-table-paginator/entity-table-paginator.module';\r\nimport { IgoImageModule } from '../../image/image.module';\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\nimport { MatDatepickerModule } from '@angular/material/datepicker';\r\nimport { MatSelectModule } from '@angular/material/select';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatTableModule,\r\n    MatAutocompleteModule,\r\n    MatSortModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatCheckboxModule,\r\n    MatPaginatorModule,\r\n    MatSelectModule,\r\n    IgoStopPropagationModule,\r\n    IgoCustomHtmlModule,\r\n    IgoEntityTablePaginatorModule,\r\n    IgoImageModule,\r\n    IgoLanguageModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    MatInputModule,\r\n    MatDatepickerModule,\r\n    MatTooltipModule\r\n  ],\r\n  exports: [\r\n    EntityTableComponent\r\n  ],\r\n  declarations: [\r\n    EntityTableComponent,\r\n    EntityTableRowDirective\r\n  ]\r\n})\r\nexport class IgoEntityTableModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoEntitySelectorModule } from './entity-selector/entity-selector.module';\r\nimport { IgoEntityTableModule } from './entity-table/entity-table.module';\r\nimport { IgoEntityTablePaginatorModule } from './entity-table-paginator/entity-table-paginator.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule\r\n  ],\r\n  exports: [\r\n    IgoEntitySelectorModule,\r\n    IgoEntityTableModule,\r\n    IgoEntityTablePaginatorModule\r\n  ],\r\n  declarations: []\r\n})\r\nexport class IgoEntityModule {}\r\n","import { catchError } from 'rxjs/operators';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { Observable } from 'rxjs';\r\nimport { Injectable } from '@angular/core';\r\nimport { InteractiveTourOptions } from './interactive-tour.interface';\r\nimport { ConfigService } from '@igo2/core';\r\n\r\n@Injectable()\r\nexport class InteractiveTourLoader {\r\n  private jsonURL: string;\r\n  private allToursOptions;\r\n\r\n  constructor(private http: HttpClient, private configService: ConfigService) {\r\n    this.jsonURL = this.getPathToConfigFile();\r\n  }\r\n\r\n   public loadConfigTour() {\r\n      this.getJSON()\r\n        .subscribe(\r\n          (data) => {\r\n            this.allToursOptions = data;\r\n          },\r\n          (err) => {\r\n            throw new Error(`Problem with Interactive tour configuration file: interactiveTour.json not find. Check if the file and is path is set correctly.`);\r\n          }\r\n        );\r\n   }\r\n\r\n  public getPathToConfigFile(): string {\r\n    return (\r\n      this.configService.getConfig('interactiveTour.pathToConfigFile') ||\r\n      './config/interactiveTour.json'\r\n    );\r\n  }\r\n\r\n  public getJSON(): Observable<any> {\r\n    return this.http.get(this.jsonURL).pipe(\r\n      catchError((e) => {\r\n        e.error.caught = true;\r\n        throw e;\r\n      })\r\n    );\r\n  }\r\n\r\n  public getTourOptionData(toolName): InteractiveTourOptions {\r\n    if (this.allToursOptions === undefined) {\r\n      return undefined;\r\n    }\r\n    let nameInConfigFile = toolName;\r\n    nameInConfigFile = nameInConfigFile.replace(/\\s/g, '');\r\n    return this.allToursOptions[nameInConfigFile];\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { ShepherdService } from 'angular-shepherd';\r\n\r\nimport { ConfigService, MediaService, LanguageService } from '@igo2/core';\r\nimport { InteractiveTourLoader } from './interactive-tour.loader';\r\nimport {\r\n  InteractiveTourOptions,\r\n  InteractiveTourStep,\r\n  InteractiveTourAction\r\n} from './interactive-tour.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class InteractiveTourService {\r\n  private previousStep: InteractiveTourStep;\r\n  private nextIndex = 1;\r\n\r\n  constructor(\r\n    private configService: ConfigService,\r\n    private mediaService: MediaService,\r\n    private languageService: LanguageService,\r\n    private interactiveTourLoader: InteractiveTourLoader,\r\n    private shepherdService: ShepherdService\r\n  ) {\r\n    if (this.isAppHaveTour()) {\r\n      this.interactiveTourLoader.loadConfigTour();\r\n    }\r\n  }\r\n\r\n  public isAppHaveTour() {\r\n    const haveTour = this.configService.getConfig('interactiveTour.activateInteractiveTour');\r\n    if (haveTour === undefined) {\r\n      return true;\r\n    } else {\r\n      return haveTour;\r\n    }\r\n  }\r\n\r\n  public isToolHaveTourConfig(toolName: string): boolean {\r\n    const checkTourActiveOptions = this.interactiveTourLoader.getTourOptionData(\r\n      toolName\r\n    );\r\n    if (checkTourActiveOptions === undefined) {\r\n      return false;\r\n    } else {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  public disabledTourButton(toolName: string): boolean {\r\n    const stepConfig: InteractiveTourOptions = this.interactiveTourLoader.getTourOptionData(\r\n      toolName\r\n    );\r\n\r\n    if (stepConfig?.conditions) {\r\n      for (const condition of stepConfig?.conditions) {\r\n        if (document.querySelector(condition) === null) {\r\n          return true;\r\n        }\r\n      }\r\n    }\r\n    return false;\r\n  }\r\n\r\n  public isMobile(): boolean {\r\n    return this.mediaService.isMobile();\r\n  }\r\n\r\n  public isTourDisplayInMobile(): boolean {\r\n    const showInMobile = this.configService.getConfig(\r\n      'interactiveTour.tourInMobile'\r\n    );\r\n    if (showInMobile === undefined) {\r\n      return true;\r\n    }\r\n    return this.configService.getConfig('interactiveTour.tourInMobile');\r\n  }\r\n\r\n  private getButtons(buttonKind?: 'first' | 'last' | 'noBackButton') {\r\n    if (buttonKind === 'noBackButton') {\r\n      return [\r\n        {\r\n          classes: 'shepherd-button-primary',\r\n          text: this.languageService.translate.instant(\r\n            'igo.common.interactiveTour.nextButton'\r\n          ),\r\n          type: 'next'\r\n        }\r\n      ];\r\n    }\r\n    if (buttonKind === 'first') {\r\n      return [\r\n        {\r\n          classes: 'shepherd-button-secondary',\r\n          text: this.languageService.translate.instant(\r\n            'igo.common.interactiveTour.exitButton'\r\n          ),\r\n          type: 'cancel'\r\n        },\r\n        {\r\n          classes: 'shepherd-button-primary',\r\n          text: this.languageService.translate.instant(\r\n            'igo.common.interactiveTour.nextButton'\r\n          ),\r\n          type: 'next'\r\n        }\r\n      ];\r\n    }\r\n\r\n    if (buttonKind === 'last') {\r\n      return [\r\n        {\r\n          classes: 'shepherd-button-secondary',\r\n          text: this.languageService.translate.instant(\r\n            'igo.common.interactiveTour.backButton'\r\n          ),\r\n          type: 'back'\r\n        },\r\n        {\r\n          classes: 'shepherd-button-primary',\r\n          text: this.languageService.translate.instant(\r\n            'igo.common.interactiveTour.exitButton'\r\n          ),\r\n          type: 'cancel'\r\n        }\r\n      ];\r\n    }\r\n\r\n    return [\r\n      {\r\n        classes: 'shepherd-button-secondary',\r\n        text: this.languageService.translate.instant(\r\n          'igo.common.interactiveTour.backButton'\r\n        ),\r\n        type: 'back'\r\n      },\r\n      {\r\n        classes: 'shepherd-button-primary',\r\n        text: this.languageService.translate.instant(\r\n          'igo.common.interactiveTour.nextButton'\r\n        ),\r\n        type: 'next'\r\n      }\r\n    ];\r\n  }\r\n\r\n  private getAction(actionName: string) {\r\n    const action = {\r\n      click: 'click'\r\n    };\r\n    return action[actionName.toLowerCase()];\r\n  }\r\n\r\n  private addProgress() {\r\n    const self = this as any;\r\n    let nbTry = 0;\r\n    const maxTry = 21;\r\n    const checkExist = setInterval(() => {\r\n      if (self.getCurrentStep()) {\r\n        if (self.getCurrentStep().options.attachTo.element && !document.querySelector(self.getCurrentStep().options.attachTo.element)) {\r\n          self.cancel();\r\n          clearInterval(checkExist);\r\n          return;\r\n        } else {\r\n          const currentStepElement = self.getCurrentStep().getElement();\r\n          if (currentStepElement) {\r\n            const shepherdList = currentStepElement.querySelectorAll('.shepherd-content, .shepherd-text');\r\n            shepherdList.forEach(element => {\r\n              element.classList.add('mat-typography');\r\n            });\r\n          }\r\n          const header = currentStepElement\r\n            ? currentStepElement.querySelector('.shepherd-header')\r\n            : undefined;\r\n\r\n          nbTry++;\r\n          if (header || nbTry > maxTry) {\r\n            clearInterval(checkExist);\r\n          }\r\n\r\n          if (header) {\r\n            const stepsArray = self.steps;\r\n            const progress = document.createElement('span');\r\n            progress.className = 'shepherd-progress';\r\n            progress.innerText = `${\r\n              stepsArray.indexOf(self.getCurrentStep()) + 1\r\n            }/${stepsArray.length}`;\r\n            header.insertBefore(\r\n              progress,\r\n              currentStepElement.querySelector('.shepherd-cancel-icon')\r\n            );\r\n          }\r\n        }\r\n      }\r\n    }, 100);\r\n  }\r\n\r\n  private checkNext(index, tour, service) {\r\n    if (tour.getCurrentStep()) {\r\n      if (tour.getCurrentStep().options.attachTo.element && document.querySelector(tour.getCurrentStep().options.attachTo.element)) {\r\n        tour.complete();\r\n        return;\r\n      }\r\n\r\n      if (index.index === tour.steps.length - 1) {\r\n        tour.complete();\r\n        return;\r\n      }\r\n\r\n      tour.steps.splice(index.index, 1);\r\n      const nextStep = tour.steps[index.index];\r\n      if (nextStep.options.attachTo.element && !document.querySelector(nextStep.options.attachTo.element)) {\r\n        service.checkNext(index, tour, service);\r\n      } else {\r\n        tour._setupModal();\r\n        tour.show(nextStep.id);\r\n      }\r\n    }\r\n  }\r\n\r\n  private executeAction(\r\n    step: InteractiveTourStep,\r\n    actionConfig: InteractiveTourAction\r\n  ) {\r\n    if (!actionConfig) {\r\n      return;\r\n    }\r\n\r\n    if (\r\n      actionConfig.condition &&\r\n      ((actionConfig.condition.charAt(0) === '!' &&\r\n        document.querySelector(actionConfig.condition.slice(1))) ||\r\n        (actionConfig.condition.charAt(0) !== '!' &&\r\n          !document.querySelector(actionConfig.condition)))\r\n    ) {\r\n      return;\r\n    }\r\n\r\n    const element: HTMLElement = document.querySelector(\r\n      actionConfig.element || step.element\r\n    ) as HTMLElement;\r\n    const action = this.getAction(actionConfig.action);\r\n    if (element && action) {\r\n      element[action]();\r\n    }\r\n  }\r\n\r\n  private executeActionPromise(\r\n    step: InteractiveTourStep,\r\n    actionConfig: InteractiveTourAction\r\n  ) {\r\n    return new Promise<void>((resolve) => {\r\n      this.executeAction(step, actionConfig);\r\n      if (!actionConfig || !actionConfig.waitFor) {\r\n        resolve();\r\n        return;\r\n      }\r\n      let nbTry = 0;\r\n      const maxTry = actionConfig.maxWait ? actionConfig.maxWait / 100 : 20;\r\n      const checkExist = setInterval(() => {\r\n        nbTry++;\r\n        if (nbTry > maxTry || document.querySelector(actionConfig.waitFor)) {\r\n          clearInterval(checkExist);\r\n          resolve();\r\n        }\r\n      }, 100);\r\n    });\r\n  }\r\n\r\n  private getShepherdSteps(stepConfig: InteractiveTourOptions) {\r\n    const shepherdSteps = [];\r\n\r\n    let i = 0;\r\n    for (const step of stepConfig.steps) {\r\n      shepherdSteps.push({\r\n        attachTo: {\r\n          element: step.element,\r\n          on: step.position || stepConfig.position\r\n        },\r\n        popperOptions: {\r\n          modifiers: [{ name: 'offset', options: { offset: [0, 15] } }]\r\n        },\r\n        beforeShowPromise: () => {\r\n          return Promise.all([\r\n            this.executeActionPromise(\r\n              this.previousStep,\r\n              this.previousStep ? this.previousStep.beforeChange : undefined\r\n            ),\r\n            this.executeActionPromise(step, step.beforeShow)\r\n          ]);\r\n        },\r\n        buttons: this.getButtons(\r\n          i === 0\r\n            ? 'first'\r\n            : i + 1 === stepConfig.steps.length\r\n            ? 'last'\r\n            : stepConfig.steps[i].noBackButton\r\n            ? 'noBackButton'\r\n            : undefined\r\n        ),\r\n        classes: step.class,\r\n        highlightClass: step.highlightClass,\r\n        scrollTo: step.scrollToElement || stepConfig.scrollToElement || true,\r\n        canClickTarget: step.disableInteraction\r\n          ? !step.disableInteraction\r\n          : undefined,\r\n        title: this.languageService.translate.instant(\r\n          step.title || stepConfig.title\r\n        ),\r\n        text: [this.languageService.translate.instant(step.text)],\r\n        when: {\r\n          show: () => {\r\n            this.executeAction(step, step.onShow);\r\n          },\r\n          hide: () => {\r\n            this.previousStep = step;\r\n            this.executeAction(step, step.onHide);\r\n          }\r\n        }\r\n      });\r\n      i++;\r\n    }\r\n\r\n    return shepherdSteps;\r\n  }\r\n\r\n  public startTour(toolName: string) {\r\n    const stepConfig: InteractiveTourOptions = this.interactiveTourLoader.getTourOptionData(\r\n      toolName\r\n    );\r\n\r\n    this.shepherdService.defaultStepOptions = {\r\n      classes: stepConfig.class,\r\n      highlightClass: stepConfig.highlightClass,\r\n      canClickTarget: stepConfig.disableInteraction\r\n        ? !stepConfig.disableInteraction\r\n        : true,\r\n      cancelIcon: {\r\n        enabled: true\r\n      }\r\n    };\r\n\r\n    const shepherdSteps = this.getShepherdSteps(stepConfig);\r\n\r\n    this.shepherdService.modal = true;\r\n    this.shepherdService.confirmCancel = false;\r\n    this.shepherdService.addSteps(shepherdSteps);\r\n\r\n    this.shepherdService.tourObject.on('show', this.addProgress);\r\n    this.shepherdService.tourObject.on('cancel', (index) =>{\r\n      this.checkNext(index, this.shepherdService.tourObject, this);\r\n    });\r\n\r\n    this.shepherdService.start();\r\n  }\r\n}\r\n","import { EntityRecord, EntityStore } from '../../entity';\r\nimport { Tool, ToolboxOptions } from './tool.interface';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\n/**\r\n * Service where all available tools and their component are registered.\r\n */\r\nexport class Toolbox {\r\n  /**\r\n   * Observable of the active tool\r\n   */\r\n  activeTool$: BehaviorSubject<Tool> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Ordered list of tool names to display in a toolbar\r\n   */\r\n  toolbar$: BehaviorSubject<string[]> = new BehaviorSubject([]);\r\n\r\n  /**\r\n   * Observable of the active tool\r\n   */\r\n  private activeTool$$: Subscription;\r\n\r\n  /**\r\n   * Active tool history. Useful for activating the previous tool.\r\n   */\r\n  private activeToolHistory: string[] = [];\r\n\r\n  /**\r\n   * Tool store\r\n   */\r\n  private store = new EntityStore<Tool>([], {\r\n    getKey: (tool: Tool) => tool.name\r\n  });\r\n\r\n  get tools$(): BehaviorSubject<Tool[]> {\r\n    return this.store.entities$;\r\n  }\r\n\r\n  constructor(private options: ToolboxOptions = {}) {\r\n    this.setToolbar(options.toolbar);\r\n    this.initStore();\r\n  }\r\n\r\n  /**\r\n   * Destroy the toolbox\r\n   */\r\n  destroy() {\r\n    this.activeTool$$.unsubscribe();\r\n    this.store.destroy();\r\n  }\r\n\r\n  /**\r\n   * Return a tool\r\n   * @param name Tool name\r\n   * @returns tool Tool\r\n   */\r\n  getTool(name: string): Tool {\r\n    return this.store.get(name);\r\n  }\r\n\r\n  /**\r\n   * Return all tools\r\n   * @returns Array of tools\r\n   */\r\n  getTools(): Tool[] {\r\n    return this.store.all();\r\n  }\r\n\r\n  /**\r\n   * Set tool configurations\r\n   * @param tools Tools\r\n   */\r\n  setTools(tools: Tool[]) {\r\n    this.store.load(tools);\r\n  }\r\n\r\n  /**\r\n   * Get toolbar\r\n   * @returns Toolbar value\r\n   */\r\n  getToolbar(): string[] {\r\n    return this.toolbar$.getValue();\r\n  }\r\n\r\n  /**\r\n   * Set toolbar\r\n   * @param toolbar A list of tool names\r\n   */\r\n  setToolbar(toolbar: string[]) {\r\n    this.toolbar$.next(toolbar || []);\r\n  }\r\n\r\n  /**\r\n   * Activate a tool (and deactivate other tools)\r\n   * @param name Tool name\r\n   * @param options Tool options\r\n   */\r\n  activateTool(name: string, options: { [key: string]: any } = {}) {\r\n    const tool = this.getTool(name);\r\n    if (tool === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.store.state.update(tool, { active: true, options }, true);\r\n  }\r\n\r\n  /**\r\n   * Activate the previous tool, if any\r\n   */\r\n  activatePreviousTool() {\r\n    if (this.activeToolHistory.length <= 1) {\r\n      this.deactivateTool();\r\n      return;\r\n    }\r\n    const [previous, current] = this.activeToolHistory.splice(-2, 2);\r\n    this.activateTool(previous);\r\n  }\r\n\r\n  /**\r\n   * Activate the tool below, if any\r\n   */\r\n  /* activateBelowTool() {\r\n    const arrayTools = this.getToolbar();\r\n    const index = arrayTools.findIndex(t => t === this.activeTool$.getValue().name);\r\n    if (arrayTools[index + 1] !== undefined) {\r\n      this.deactivateTool();\r\n      const below = arrayTools[index + 1];\r\n      this.activateTool(below);\r\n    } else {\r\n      this.deactivateTool();\r\n      const below = arrayTools[0];\r\n      this.activateTool(below);\r\n    }\r\n  } */\r\n\r\n  /**\r\n   * Activate the tool above, if any\r\n   */\r\n  /* activateAboveTool() {\r\n    const arrayTools = this.getToolbar();\r\n    const index = arrayTools.findIndex(t => t === this.activeTool$.getValue().name);\r\n    if (arrayTools[index - 1] !== undefined) {\r\n      this.deactivateTool();\r\n      const above = arrayTools[index - 1];\r\n      this.activateTool(above);\r\n    } else {\r\n      this.deactivateTool();\r\n      const above = arrayTools[arrayTools.length - 1];\r\n      this.activateTool(above);\r\n    }\r\n  } */\r\n\r\n  /**\r\n   * Deactivate the active tool\r\n   */\r\n  deactivateTool() {\r\n    this.clearActiveToolHistory();\r\n    this.store.state.updateAll({ active: false });\r\n  }\r\n\r\n  /**\r\n   * Initialize the tool store and start observing the active tool\r\n   */\r\n  private initStore() {\r\n    this.store = new EntityStore<Tool>([], {\r\n      getKey: (entity: Tool) => entity.name\r\n    });\r\n\r\n    this.activeTool$$ = this.store.stateView\r\n      .firstBy$((record: EntityRecord<Tool>) => record.state.active === true)\r\n      .subscribe((record: EntityRecord<Tool>) => {\r\n        if (record === undefined) {\r\n          this.setActiveTool(undefined);\r\n          return;\r\n        }\r\n\r\n        const tool = record.entity;\r\n        const options = Object.assign(\r\n          {},\r\n          tool.options || {},\r\n          record.state.options || {}\r\n        );\r\n        this.setActiveTool(Object.assign({}, tool, { options }));\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Set the active tool and update the tool history\r\n   * @param tool Tool\r\n   */\r\n  private setActiveTool(tool: Tool | undefined) {\r\n    this.activeTool$.next(tool);\r\n    if (tool === undefined) {\r\n      this.clearActiveToolHistory();\r\n    } else {\r\n      this.activeToolHistory = this.activeToolHistory\r\n        .filter((name: string) => name !== tool.name)\r\n        .concat([tool.name]);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the tool history\r\n   */\r\n  private clearActiveToolHistory() {\r\n    this.activeToolHistory = [];\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { Tool } from './tool.interface';\r\nimport { Toolbox } from './toolbox';\r\n\r\n/**\r\n * Service where runtime tool configurations are registered\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ToolService {\r\n  static tools: { [key: string]: Tool } = {};\r\n\r\n  /**\r\n   * Toolbox that holds main tools\r\n   */\r\n  public toolbox: Toolbox = new Toolbox();\r\n\r\n  static register(tool: Tool) {\r\n    ToolService.tools[tool.name] = tool;\r\n  }\r\n\r\n  constructor() {\r\n    this.toolbox.setTools(this.getTools());\r\n  }\r\n\r\n  /**\r\n   * Return a tool\r\n   * @param name Tool name\r\n   * @returns tool Tool\r\n   */\r\n  getTool(name: string): Tool {\r\n    return ToolService.tools[name];\r\n  }\r\n\r\n  /**\r\n   * Return all tools\r\n   * @returns tTols\r\n   */\r\n  getTools(): Tool[] {\r\n    return Object.values(ToolService.tools);\r\n  }\r\n}\r\n","<button *ngIf=\"showTourButton\"\r\n  (click) = \"startInteractiveTour()\"\r\n  [ngClass]=\"getClass()\"\r\n  mat-raised-button\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [disabled]=disabledTourButton>\r\n  <span class=\"interactive-tour-button-title\">{{'igo.common.interactiveTour.buttonTitle' | translate}} {{(discoverTitleInLocale$ | async) | translate}}</span>\r\n  <mat-icon\r\n    svgIcon=\"presentation-play\"\r\n    [matTooltip]=\"disabledTourButton ?\r\n    ('igo.common.interactiveTour.disaledTooltipTourToolButton' | translate) :\r\n    ('igo.common.interactiveTour.tooltipTourToolButton' | translate)\">\r\n  </mat-icon>\r\n</button>\r\n","import { Component, ViewEncapsulation, Input } from '@angular/core';\r\nimport { InteractiveTourService } from './interactive-tour.service';\r\nimport { ToolService } from '../tool/shared/tool.service';\r\nimport { Observable, of } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'igo-interactive-tour',\r\n  templateUrl: './interactive-tour.component.html',\r\n  styleUrls: ['./interactive-tour.component.scss'],\r\n  encapsulation: ViewEncapsulation.None\r\n})\r\nexport class InteractiveTourComponent {\r\n  /**\r\n   * Toolbox that holds main tools\r\n   */\r\n  @Input() tourToStart: string = '';\r\n  @Input() styleButton: string;\r\n  @Input() discoverTitleInLocale$: Observable<string> = of('IGO');\r\n\r\n  getClass() {\r\n    return {\r\n      'tour-button-tool-icon': this.styleButton === 'icon',\r\n      'tour-button-tool': this.styleButton === 'raised'\r\n    };\r\n  }\r\n\r\n  get toolbox() {\r\n    return this.toolService.toolbox;\r\n  }\r\n\r\n  getTourToStart() {\r\n    if (this.tourToStart) {\r\n      return this.tourToStart;\r\n    } else {\r\n      return this.activeToolName;\r\n    }\r\n  }\r\n\r\n  get activeToolName() {\r\n    if (this.toolbox) {\r\n      if (this.isActiveTool) {\r\n        return this.toolbox.activeTool$.getValue().name;\r\n      } else {\r\n        return 'global';\r\n      }\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  get isActiveTool(): boolean {\r\n    if (this.toolbox) {\r\n      return this.toolbox.activeTool$.getValue() !== undefined;\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  get isToolHaveTour(): boolean {\r\n    if (this.activeToolName === 'about' && !this.tourToStart) {\r\n      return false;\r\n    }\r\n    return this.interactiveTourService.isToolHaveTourConfig(\r\n      this.getTourToStart()\r\n    );\r\n  }\r\n\r\n  get showTourButton(): boolean {\r\n    // 2 conditions to show: have Tour on tool in Config file and if we are in mobile displayInMobile= true\r\n    let haveTour: boolean;\r\n    haveTour = this.isToolHaveTour;\r\n    if (haveTour === false) {\r\n      return false;\r\n    }\r\n\r\n    let inMobileAndShow: boolean;\r\n    if (this.interactiveTourService.isMobile()) {\r\n      inMobileAndShow = this.isTourDisplayInMobile;\r\n      if (inMobileAndShow === false) {\r\n        return false;\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n\r\n  get isTourDisplayInMobile(): boolean {\r\n    return this.interactiveTourService.isTourDisplayInMobile();\r\n  }\r\n\r\n  get disabledTourButton(): boolean {\r\n    return this.interactiveTourService.disabledTourButton(this.activeToolName);\r\n  }\r\n\r\n  constructor(\r\n    private interactiveTourService: InteractiveTourService,\r\n    private toolService: ToolService\r\n  ) {}\r\n\r\n  startInteractiveTour() {\r\n    const tour = this.getTourToStart();\r\n    if (tour) {\r\n      this.interactiveTourService.startTour(tour);\r\n    } else {\r\n      return;\r\n    }\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { InteractiveTourService } from './interactive-tour.service';\r\nimport { InteractiveTourComponent } from './interactive-tour.component';\r\nimport { InteractiveTourLoader } from './interactive-tour.loader';\r\n\r\n@NgModule({\r\n  declarations: [InteractiveTourComponent],\r\n  imports: [\r\n    CommonModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatTooltipModule,\r\n    IgoLanguageModule\r\n  ],\r\n  providers: [InteractiveTourService, InteractiveTourLoader],\r\n  exports: [InteractiveTourComponent]\r\n})\r\nexport class IgoInteractiveTourModule {}\r\n","import { Pipe, PipeTransform } from '@angular/core';\r\n\r\n@Pipe({\r\n  name: 'keyvalue'\r\n})\r\nexport class KeyValuePipe implements PipeTransform {\r\n  transform(value: any, args?: any): any {\r\n    const keyValues = [];\r\n    Object.getOwnPropertyNames(value).forEach((key: string) =>\r\n      keyValues.push({ key, value: value[key] })\r\n    );\r\n\r\n    return keyValues;\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { KeyValuePipe } from './keyvalue.pipe';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [KeyValuePipe],\r\n  exports: [KeyValuePipe]\r\n})\r\nexport class IgoKeyValueModule {\r\n  static forRoot(): ModuleWithProviders<IgoKeyValueModule> {\r\n    return {\r\n      ngModule: IgoKeyValueModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import {\r\n  Directive,\r\n  Input,\r\n  Output,\r\n  ElementRef,\r\n  Renderer2,\r\n  HostListener,\r\n  EventEmitter\r\n} from '@angular/core';\r\n\r\n@Directive({\r\n  selector: '[igoListItem]'\r\n})\r\nexport class ListItemDirective {\r\n\r\n  static focusedCls = 'igo-list-item-focused';\r\n  static selectedCls = 'igo-list-item-selected';\r\n  static disabledCls = 'igo-list-item-disabled';\r\n\r\n  @Input()\r\n  get color() {\r\n    return this._color;\r\n  }\r\n  set color(value: string) {\r\n    this._color = value;\r\n  }\r\n  private _color = 'primary';\r\n\r\n  @Input()\r\n  get focused() {\r\n    return this._focused;\r\n  }\r\n  set focused(value: boolean) {\r\n    if (value === this._focused) {\r\n      return;\r\n    }\r\n    if (this.disabled) {\r\n      return;\r\n    }\r\n\r\n    value ? this.beforeFocus.emit(this) : this.beforeUnfocus.emit(this);\r\n\r\n    this._focused = value;\r\n    if (this.selected !== true) {\r\n      this.toggleFocusedClass();\r\n    }\r\n\r\n    value ? this.focus.emit(this) : this.unfocus.emit(this);\r\n  }\r\n  private _focused = false;\r\n\r\n  @Input()\r\n  get selected() {\r\n    return this._selected;\r\n  }\r\n  set selected(value: boolean) {\r\n    if (value === this._selected) {\r\n      return;\r\n    }\r\n    if (this.disabled) {\r\n      return;\r\n    }\r\n\r\n    value ? this.beforeSelect.emit(this) : this.beforeUnselect.emit(this);\r\n\r\n    this._selected = value;\r\n    this._focused = value;\r\n    this.toggleSelectedClass();\r\n\r\n    value ? this.select.emit(this) : this.unselect.emit(this);\r\n  }\r\n  private _selected = false;\r\n\r\n  @Input()\r\n  get disabled() {\r\n    return this._disabled;\r\n  }\r\n  set disabled(value: boolean) {\r\n    if (value === this._disabled) {\r\n      return;\r\n    }\r\n\r\n    if (value === true) {\r\n      this.selected = false;\r\n    }\r\n\r\n    value ? this.beforeDisable.emit(this) : this.beforeEnable.emit(this);\r\n\r\n    this._disabled = value;\r\n    this.toggleDisabledClass();\r\n\r\n    value ? this.disable.emit(this) : this.enable.emit(this);\r\n  }\r\n  private _disabled = false;\r\n\r\n  @Output() beforeSelect = new EventEmitter<ListItemDirective>();\r\n  @Output() beforeFocus = new EventEmitter<ListItemDirective>();\r\n  @Output() beforeUnselect = new EventEmitter<ListItemDirective>();\r\n  @Output() beforeUnfocus = new EventEmitter<ListItemDirective>();\r\n  @Output() beforeDisable = new EventEmitter<ListItemDirective>();\r\n  @Output() beforeEnable = new EventEmitter<ListItemDirective>();\r\n  @Output() focus = new EventEmitter<ListItemDirective>();\r\n  @Output() unfocus = new EventEmitter<ListItemDirective>();\r\n  @Output() select = new EventEmitter<ListItemDirective>();\r\n  @Output() unselect = new EventEmitter<ListItemDirective>();\r\n  @Output() disable = new EventEmitter<ListItemDirective>();\r\n  @Output() enable = new EventEmitter<ListItemDirective>();\r\n\r\n  @HostListener('click')\r\n  onClick() {\r\n    this.selected = true;\r\n  }\r\n\r\n  constructor(public renderer: Renderer2, public el: ElementRef) {}\r\n\r\n  getOffsetTop(): number {\r\n    const padding = 5;\r\n\r\n    return this.el.nativeElement.offsetTop - padding;\r\n  }\r\n\r\n  private toggleFocusedClass() {\r\n    if (this.focused) {\r\n      this.addCls(ListItemDirective.focusedCls);\r\n    } else {\r\n      this.removeCls(ListItemDirective.focusedCls);\r\n    }\r\n  }\r\n\r\n  private toggleSelectedClass() {\r\n    if (this.selected) {\r\n      this.addCls(ListItemDirective.selectedCls);\r\n      this.removeCls(ListItemDirective.focusedCls);\r\n    } else {\r\n      this.removeCls(ListItemDirective.selectedCls);\r\n    }\r\n  }\r\n\r\n  private toggleDisabledClass() {\r\n    if (this.disabled) {\r\n      this.addCls(ListItemDirective.disabledCls);\r\n    } else {\r\n      this.removeCls(ListItemDirective.disabledCls);\r\n    }\r\n  }\r\n\r\n  private addCls(cls: string) {\r\n    this.renderer.addClass(this.el.nativeElement, cls);\r\n  }\r\n\r\n  private removeCls(cls: string) {\r\n    this.renderer.removeClass(this.el.nativeElement, cls);\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  AfterViewInit,\r\n  OnInit,\r\n  OnDestroy,\r\n  Input,\r\n  ContentChildren,\r\n  HostListener,\r\n  ElementRef\r\n} from '@angular/core';\r\nimport type { QueryList } from '@angular/core';\r\n\r\nimport { Subscription } from 'rxjs';\r\n\r\nimport { ListItemDirective } from './list-item.directive';\r\n\r\n@Component({\r\n  selector: 'igo-list',\r\n  templateUrl: './list.component.html',\r\n  styleUrls: ['./list.component.scss']\r\n})\r\nexport class ListComponent implements AfterViewInit, OnInit, OnDestroy {\r\n  @Input()\r\n  get navigation() {\r\n    return this._navigation;\r\n  }\r\n  set navigation(value: boolean) {\r\n    this._navigation = value;\r\n  }\r\n  private _navigation = true;\r\n\r\n  @Input()\r\n  get selection() {\r\n    return this._selection;\r\n  }\r\n  set selection(value: boolean) {\r\n    this._selection = value;\r\n  }\r\n  private _selection = true;\r\n\r\n  get selectedItem() {\r\n    return this._selectedItem;\r\n  }\r\n  set selectedItem(value: ListItemDirective) {\r\n    this.focusedItem = value;\r\n    this._selectedItem = value;\r\n  }\r\n  private _selectedItem: ListItemDirective;\r\n\r\n  get focusedItem() {\r\n    return this._focusedItem;\r\n  }\r\n  set focusedItem(value: ListItemDirective) {\r\n    this._focusedItem = value;\r\n  }\r\n  private _focusedItem: ListItemDirective;\r\n\r\n  private navigationEnabled: boolean;\r\n  private listItems$$: Subscription;\r\n  private subscriptions: Subscription[] = [];\r\n\r\n  @ContentChildren(ListItemDirective, { descendants: true })\r\n  listItems: QueryList<ListItemDirective>;\r\n\r\n  @HostListener('document:keydown', ['$event'])\r\n  @HostListener('document:enter', ['$event'])\r\n  handleKeyboardEvent(event: KeyboardEvent) {\r\n    // It would be nice to be able to unsubscribe to the event\r\n    // completely but until ES7 this won't be possible because\r\n    // document events are not observables\r\n    if (this.navigationEnabled) {\r\n      if (event.key === 'ArrowUp' || event.key === 'ArrowDown') {\r\n        event.preventDefault();\r\n        this.navigate(event.key);\r\n      } else if (event.key === 'Enter') {\r\n        this.select(this.focusedItem);\r\n      }\r\n    }\r\n  }\r\n\r\n  constructor(private el: ElementRef) {}\r\n\r\n  ngOnInit() {\r\n    this.enableNavigation();\r\n  }\r\n\r\n  ngAfterViewInit() {\r\n    if (this.listItems.length) {\r\n      this.init();\r\n    }\r\n\r\n    this.listItems$$ = this.listItems.changes.subscribe(\r\n      (items: ListItemDirective[]) => this.init()\r\n    );\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.listItems$$.unsubscribe();\r\n  }\r\n\r\n  focus(item?: ListItemDirective) {\r\n    if (!this.selection) {\r\n      return;\r\n    }\r\n\r\n    this.unfocus();\r\n\r\n    // We need to make this check because dynamic\r\n    // lists such as in the search results list may fail\r\n    if (item !== undefined) {\r\n      item.focused = true;\r\n    }\r\n  }\r\n\r\n  unfocus() {\r\n    if (this.focusedItem !== undefined) {\r\n      this.focusedItem.focused = false;\r\n    }\r\n\r\n    this.focusedItem = undefined;\r\n  }\r\n\r\n  focusNext() {\r\n    const items = this.listItems.toArray();\r\n    let item;\r\n    const igoList = this.el.nativeElement;\r\n    let disabled = true;\r\n    let index = this.getFocusedIndex();\r\n    if (index === undefined) {\r\n      index = -1;\r\n    }\r\n\r\n    while (disabled && index < items.length - 1) {\r\n      index += 1;\r\n      item = items[index];\r\n      disabled = item.disabled;\r\n    }\r\n\r\n    if (item !== undefined) {\r\n      this.focus(item);\r\n    }\r\n\r\n    if (!items[index + 1]) {\r\n      igoList.scrollTop = igoList.scrollHeight - igoList.clientHeight;\r\n      return;\r\n    }\r\n\r\n    if (item !== undefined && !this.isScrolledIntoView(item.el.nativeElement)) {\r\n      igoList.scrollTop =\r\n        item.el.nativeElement.offsetTop +\r\n        item.el.nativeElement.children[0].offsetHeight -\r\n        igoList.clientHeight;\r\n    }\r\n  }\r\n\r\n  focusPrevious() {\r\n    const items = this.listItems.toArray();\r\n    let item: ListItemDirective;\r\n    const igoList = this.el.nativeElement;\r\n    let disabled = true;\r\n    let index = this.getFocusedIndex();\r\n\r\n    while (disabled && index > 0) {\r\n      index -= 1;\r\n      item = items[index];\r\n      disabled = item.disabled;\r\n    }\r\n\r\n    if (item !== undefined) {\r\n      this.focus(item);\r\n    }\r\n\r\n    if (!items[index - 1]) {\r\n      igoList.scrollTop = 0;\r\n      return;\r\n    }\r\n\r\n    if (item !== undefined && !this.isScrolledIntoView(item.el.nativeElement)) {\r\n      const padding = 3;\r\n      igoList.scrollTop = item.el.nativeElement.offsetTop - padding;\r\n    }\r\n  }\r\n\r\n  select(item?: ListItemDirective) {\r\n    if (!this.selection) {\r\n      return;\r\n    }\r\n\r\n    this.unselect();\r\n\r\n    if (item !== undefined) {\r\n      item.selected = true;\r\n    }\r\n  }\r\n\r\n  unselect() {\r\n    this.unfocus();\r\n\r\n    if (this.selectedItem !== undefined) {\r\n      this.selectedItem.selected = false;\r\n    }\r\n\r\n    this.selectedItem = undefined;\r\n  }\r\n\r\n  enableNavigation() {\r\n    if (this.navigation) {\r\n      this.navigationEnabled = true;\r\n    }\r\n  }\r\n\r\n  disableNavigation() {\r\n    this.navigationEnabled = false;\r\n  }\r\n\r\n  scrollToItem(item: ListItemDirective) {\r\n    this.el.nativeElement.scrollTop = item.getOffsetTop();\r\n  }\r\n\r\n  isScrolledIntoView(elem) {\r\n    const docViewTop =\r\n      this.el.nativeElement.scrollTop + this.el.nativeElement.offsetTop;\r\n    const docViewBottom = docViewTop + this.el.nativeElement.clientHeight;\r\n\r\n    const elemTop = elem.offsetTop;\r\n    const elemBottom = elemTop + elem.children[0].offsetHeight;\r\n    return elemBottom <= docViewBottom && elemTop >= docViewTop;\r\n  }\r\n\r\n  private init() {\r\n    this.subscribe();\r\n\r\n    this.selectedItem = this.findSelectedItem();\r\n    this.focusedItem = this.findFocusedItem();\r\n\r\n    this.enableNavigation();\r\n  }\r\n\r\n  private subscribe() {\r\n    this.unsubscribe();\r\n\r\n    this.listItems.toArray().forEach(item => {\r\n      this.subscriptions.push(\r\n        item.beforeSelect.subscribe((item2: ListItemDirective) =>\r\n          this.handleItemBeforeSelect(item2)\r\n        )\r\n      );\r\n\r\n      this.subscriptions.push(\r\n        item.select.subscribe((item2: ListItemDirective) =>\r\n          this.handleItemSelect(item2)\r\n        )\r\n      );\r\n\r\n      this.subscriptions.push(\r\n        item.beforeFocus.subscribe((item2: ListItemDirective) =>\r\n          this.handleItemBeforeFocus(item2)\r\n        )\r\n      );\r\n\r\n      this.subscriptions.push(\r\n        item.focus.subscribe((item2: ListItemDirective) =>\r\n          this.handleItemFocus(item2)\r\n        )\r\n      );\r\n    }, this);\r\n  }\r\n\r\n  private unsubscribe() {\r\n    this.subscriptions.forEach((sub: Subscription) => sub.unsubscribe());\r\n    this.subscriptions = [];\r\n  }\r\n\r\n  private handleItemBeforeFocus(item: ListItemDirective) {\r\n    if (item !== this.focusedItem) {\r\n      this.unfocus();\r\n    }\r\n  }\r\n\r\n  private handleItemFocus(item: ListItemDirective) {\r\n    this.focusedItem = item;\r\n  }\r\n\r\n  private handleItemBeforeSelect(item: ListItemDirective) {\r\n    if (item !== this.focusedItem) {\r\n      this.unselect();\r\n    }\r\n  }\r\n\r\n  private handleItemSelect(item: ListItemDirective) {\r\n    this.selectedItem = item;\r\n  }\r\n\r\n  private findSelectedItem() {\r\n    return this.listItems.toArray().find(item => item.selected);\r\n  }\r\n\r\n  private findFocusedItem() {\r\n    return this.listItems.toArray().find(item => item.focused);\r\n  }\r\n\r\n  private getFocusedIndex() {\r\n    return this.listItems\r\n      .toArray()\r\n      .findIndex(item => item === this.focusedItem);\r\n  }\r\n\r\n  private navigate(key: string) {\r\n    switch (key) {\r\n      case 'ArrowUp':\r\n        this.focusPrevious();\r\n        break;\r\n      case 'ArrowDown':\r\n        this.focusNext();\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n  }\r\n}\r\n","<mat-list\r\n  igoClickout\r\n  [ngClass]=\"{'selectable': selection}\"\r\n  (clickout)=\"disableNavigation()\"\r\n  (click)=\"enableNavigation()\">\r\n  <ng-content></ng-content>\r\n</mat-list>\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatListModule } from '@angular/material/list';\r\n\r\nimport { IgoClickoutModule } from '../clickout/clickout.module';\r\n\r\nimport { ListItemDirective } from './list-item.directive';\r\nimport { ListComponent } from './list.component';\r\n\r\n@NgModule({\r\n  imports: [CommonModule, MatIconModule, MatListModule, IgoClickoutModule],\r\n  declarations: [ListItemDirective, ListComponent],\r\n  exports: [ListItemDirective, ListComponent]\r\n})\r\nexport class IgoListModule {\r\n  static forRoot(): ModuleWithProviders<IgoListModule> {\r\n    return {\r\n      ngModule: IgoListModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","<div *ngIf=\"withHeader\" class=\"igo-panel-header mat-typography\" title=\"\">\r\n  <h3>\r\n    <ng-content select=\"[panelLeftButton]\"></ng-content>\r\n    <div class=\"igo-panel-title\">\r\n      {{ title }}\r\n      <ng-content select=\"[panelHeader]\"></ng-content>\r\n    </div>\r\n    <ng-content select=\"[panelRightButton]\"></ng-content>\r\n  </h3>\r\n</div>\r\n<div class=\"igo-panel-content\" title=\"\">\r\n  <ng-content></ng-content>\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  HostBinding\r\n} from '@angular/core';\r\n\r\n@Component({\r\n  selector: 'igo-panel',\r\n  templateUrl: './panel.component.html',\r\n  styleUrls: ['./panel.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class PanelComponent {\r\n  @Input()\r\n  get title() {\r\n    return this._title;\r\n  }\r\n  set title(value: string) {\r\n    this._title = value;\r\n  }\r\n  private _title: string;\r\n\r\n  @Input()\r\n  @HostBinding('class.igo-panel-with-header')\r\n  get withHeader(): boolean {\r\n    return this._withHeader;\r\n  }\r\n  set withHeader(value: boolean) {\r\n    this._withHeader = value;\r\n  }\r\n  private _withHeader = true;\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { PanelComponent } from './panel.component';\r\n\r\n@NgModule({\r\n  imports: [CommonModule],\r\n  exports: [PanelComponent],\r\n  declarations: [PanelComponent]\r\n})\r\nexport class IgoPanelModule {}\r\n","import { Component, Input } from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'igo-spinner',\r\n  templateUrl: './spinner.component.html',\r\n  styleUrls: ['./spinner.component.scss']\r\n})\r\nexport class SpinnerComponent {\r\n\r\n  public shown$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  @Input()\r\n  set shown(value: boolean) { this.shown$.next(value); }\r\n  get shown(): boolean { return this.shown$.value; }\r\n\r\n  constructor() {}\r\n\r\n  show() {\r\n    this.shown = true;\r\n  }\r\n\r\n  hide() {\r\n    this.shown = false;\r\n  }\r\n}\r\n","<div\r\n  [ngClass]=\"{'igo-spinner-container': true, 'igo-spinner-shown': (shown$ | async)}\">\r\n  <div class=\"igo-spinner-background\"></div>\r\n  <mat-progress-spinner diameter=\"40\" mode=\"indeterminate\"></mat-progress-spinner>\r\n</div>\r\n","import { Directive, Self, OnInit, OnDestroy } from '@angular/core';\r\nimport { Subscription } from 'rxjs';\r\nimport { debounceTime } from 'rxjs/operators';\r\n\r\nimport { ActivityService } from '@igo2/core';\r\nimport { SpinnerComponent } from './spinner.component';\r\n\r\n/**\r\n * A directive to bind a SpinnerComponent to the activity service.\r\n * The activity service tracks any HTTP request and this directive\r\n * will display the spinner it's attached to when the activity counter\r\n * is greater than 0.\r\n */\r\n@Directive({\r\n  selector: '[igoSpinnerActivity]'\r\n})\r\nexport class SpinnerActivityDirective implements OnInit, OnDestroy {\r\n  /**\r\n   * Subscription to the activity service counter\r\n   */\r\n  private counter$$: Subscription;\r\n\r\n  constructor(\r\n    @Self() private spinner: SpinnerComponent,\r\n    private activityService: ActivityService\r\n  ) {}\r\n\r\n  /**\r\n   * Subscribe to the activity service counter and display the spinner\r\n   * when it's is greater than 0.\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.counter$$ = this.activityService.counter$\r\n      .pipe(debounceTime(50))\r\n      .subscribe((count: number) => {\r\n        count > 0 ? this.spinner.show() : this.spinner.hide();\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Unsubcribe to the activity service counter.\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.counter$$.unsubscribe();\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatProgressSpinnerModule } from '@angular/material/progress-spinner';\r\n\r\nimport { SpinnerActivityDirective } from './spinner-activity.directive';\r\nimport { SpinnerComponent } from './spinner.component';\r\n\r\n@NgModule({\r\n  imports: [CommonModule, MatProgressSpinnerModule],\r\n  declarations: [SpinnerActivityDirective, SpinnerComponent],\r\n  exports: [SpinnerActivityDirective, SpinnerComponent]\r\n})\r\nexport class IgoSpinnerModule {}\r\n","import { DataSource } from '@angular/cdk/table';\r\nimport { MatSort } from '@angular/material/sort';\r\n\r\nimport { Observable, BehaviorSubject, merge } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport { TableDatabase, TableModel } from './index';\r\n\r\nexport class TableDataSource extends DataSource<any> {\r\n  get filter(): string {\r\n    return this._filterChange.value;\r\n  }\r\n  set filter(filter: string) {\r\n    this._filterChange.next(filter);\r\n  }\r\n  private _filterChange = new BehaviorSubject('');\r\n\r\n  constructor(\r\n    private _database: TableDatabase,\r\n    private _model: TableModel,\r\n    private _sort: MatSort\r\n  ) {\r\n    super();\r\n  }\r\n\r\n  // Connect function called by the table to retrieve one stream containing\r\n  // the data to render.\r\n  connect(): Observable<any[]> {\r\n    if (!this._database) {\r\n      return merge([]);\r\n    }\r\n    const displayDataChanges = [\r\n      this._database.dataChange,\r\n      this._filterChange,\r\n      this._sort.sortChange\r\n    ];\r\n\r\n    return merge(...displayDataChanges).pipe(\r\n      map(() => {\r\n        return this.getFilteredData(this._database.data);\r\n      }),\r\n      map(data => {\r\n        return this.getSortedData(data);\r\n      })\r\n    );\r\n  }\r\n\r\n  disconnect() {}\r\n\r\n  getFilteredData(data): any[] {\r\n    if (!this.filter) {\r\n      return data;\r\n    }\r\n    return data.slice().filter((item: any) => {\r\n      const searchStr: string = this._model.columns\r\n        .filter(c => c.filterable)\r\n        .map(c => ObjectUtils.resolve(item, c.name))\r\n        .join(' ')\r\n        .toLowerCase();\r\n\r\n      return searchStr.indexOf(this.filter.toLowerCase()) !== -1;\r\n    });\r\n  }\r\n\r\n  getSortedData(data): any[] {\r\n    if (!this._sort.active || this._sort.direction === '') {\r\n      return data;\r\n    }\r\n\r\n    return data.sort((a, b) => {\r\n      const propertyA: number | string = ObjectUtils.resolve(\r\n        a,\r\n        this._sort.active\r\n      );\r\n      const propertyB: number | string = ObjectUtils.resolve(\r\n        b,\r\n        this._sort.active\r\n      );\r\n\r\n      return ObjectUtils.naturalCompare(\r\n        propertyB,\r\n        propertyA,\r\n        this._sort.direction\r\n      );\r\n    });\r\n  }\r\n}\r\n","export enum TableActionColor {\r\n  primary,\r\n  accent,\r\n  warn\r\n}\r\n","<div class='table-box'>\r\n  <div class='table-header' *ngIf=\"hasFilterInput\">\r\n    <mat-form-field floatPlaceholder='never'>\r\n      <input matInput #filter [placeholder]=\"'igo.common.table.filter' | translate\">\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class='table-container'>\r\n    <table mat-table #table [dataSource]='dataSource' matSort>\r\n\r\n      <!-- Checkbox Column -->\r\n      <ng-container matColumnDef=\"selectionCheckbox\">\r\n        <th mat-header-cell *matHeaderCellDef>\r\n          <mat-checkbox (change)=\"$event ? masterToggle() : null\"\r\n                        [checked]=\"selection.hasValue() && isAllSelected()\"\r\n                        [indeterminate]=\"selection.hasValue() && !isAllSelected()\">\r\n          </mat-checkbox>\r\n        </th>\r\n        <td mat-cell *matCellDef=\"let row\">\r\n          <mat-checkbox (click)=\"$event.stopPropagation()\"\r\n                        (change)=\"$event ? selection.toggle(row) : null\"\r\n                        [checked]=\"selection.isSelected(row)\">\r\n          </mat-checkbox>\r\n        </td>\r\n      </ng-container>\r\n\r\n      <ng-container [matColumnDef]='column.name' *ngFor='let column of model.columns'>\r\n        <ng-container *ngIf='column.sortable'>\r\n          <th mat-header-cell *matHeaderCellDef mat-sort-header> {{column.title}} </th>\r\n        </ng-container>\r\n\r\n        <ng-container *ngIf='!column.sortable'>\r\n          <th mat-header-cell *matHeaderCellDef> {{column.title}} </th>\r\n        </ng-container>\r\n\r\n        <ng-container *ngIf=\"!column.html; else cellHTML\">\r\n          <td mat-cell *matCellDef='let row' class=\"mat-cell-text\"\r\n            [ngClass]=\"model.cellClassFunc ? model.cellClassFunc(row, column) : {}\">\r\n            {{getValue(row, column.name)}}\r\n          </td>\r\n        </ng-container>\r\n\r\n        <ng-template #cellHTML>\r\n          <td mat-cell *matCellDef='let row' class=\"mat-cell-text\"\r\n            [ngClass]=\"model.cellClassFunc ? model.cellClassFunc(row, column) : {}\"\r\n            [innerHTML]=\"getValue(row, column.name)\">\r\n          </td>\r\n        </ng-template>\r\n      </ng-container>\r\n\r\n      <!-- Action Column -->\r\n      <ng-container matColumnDef='action'>\r\n        <th mat-header-cell *matHeaderCellDef></th>\r\n        <td mat-cell *matCellDef='let row'>\r\n          <button *ngFor='let action of model.actions'\r\n          mat-mini-fab\r\n          [color]='getActionColor(action.color)'\r\n          (click)='handleClickAction($event, action, row)'>\r\n            <mat-icon svgIcon=\"{{action.icon}}\"></mat-icon>\r\n          </button>\r\n        </td>\r\n      </ng-container>\r\n\r\n      <tr mat-header-row *matHeaderRowDef='displayedColumns;'></tr>\r\n      <tr mat-row\r\n        *matRowDef='let row; columns: displayedColumns;'\r\n        [ngClass]=\"model.rowClassFunc ? model.rowClassFunc(row) : {}\"\r\n        (click)=\"selection.toggle(row)\">\r\n      </tr>\r\n\r\n    </table>\r\n  </div>\r\n\r\n</div>\r\n","import {\r\n  Component,\r\n  ElementRef,\r\n  ViewChild,\r\n  Input,\r\n  Output,\r\n  OnChanges,\r\n  OnInit,\r\n  AfterViewInit,\r\n  EventEmitter\r\n} from '@angular/core';\r\nimport { MatSort } from '@angular/material/sort';\r\nimport { SelectionModel } from '@angular/cdk/collections';\r\n\r\nimport { debounceTime, distinctUntilChanged } from 'rxjs/operators';\r\nimport { fromEvent } from 'rxjs';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport { TableModel } from './table-model.interface';\r\nimport { TableDatabase } from './table-database';\r\nimport { TableDataSource } from './table-datasource';\r\nimport { TableActionColor } from './table-action-color.enum';\r\n\r\n@Component({\r\n  selector: 'igo-table',\r\n  templateUrl: './table.component.html',\r\n  styleUrls: ['./table.component.scss']\r\n})\r\nexport class TableComponent implements OnChanges, OnInit, AfterViewInit {\r\n  @Input()\r\n  get database(): TableDatabase {\r\n    return this._database;\r\n  }\r\n  set database(value: TableDatabase) {\r\n    this._database = value;\r\n  }\r\n  private _database: TableDatabase;\r\n\r\n  @Input()\r\n  get model(): TableModel {\r\n    return this._model;\r\n  }\r\n  set model(value: TableModel) {\r\n    this._model = value;\r\n  }\r\n  private _model: TableModel;\r\n\r\n  @Input()\r\n  get hasFilterInput(): boolean {\r\n    return this._hasFIlterInput;\r\n  }\r\n  set hasFilterInput(value: boolean) {\r\n    this._hasFIlterInput = value;\r\n  }\r\n  private _hasFIlterInput = true;\r\n\r\n  public displayedColumns;\r\n  public dataSource: TableDataSource | null;\r\n  public selection = new SelectionModel<any>(true, []);\r\n\r\n  @Output()\r\n  select = new EventEmitter<{\r\n    added: any[];\r\n    removed: any[];\r\n    source: SelectionModel<any>;\r\n  }>();\r\n\r\n  @ViewChild('filter') filter: ElementRef;\r\n  @ViewChild(MatSort, { static: true }) sort: MatSort;\r\n\r\n  ngOnInit() {\r\n    this.dataSource = new TableDataSource(this.database, this.model, this.sort);\r\n\r\n    if (this.model) {\r\n      this.displayedColumns = this.model.columns\r\n        .filter(c => c.displayed !== false)\r\n        .map(c => c.name);\r\n\r\n      if (this.model.selectionCheckbox) {\r\n        this.displayedColumns.unshift('selectionCheckbox');\r\n      }\r\n      if (this.model.actions && this.model.actions.length) {\r\n        this.displayedColumns.push('action');\r\n      }\r\n    }\r\n\r\n    this.selection.changed.subscribe(e => this.select.emit(e));\r\n  }\r\n\r\n  ngAfterViewInit() {\r\n    if (this.filter) {\r\n      fromEvent(this.filter.nativeElement, 'keyup')\r\n        .pipe(\r\n          debounceTime(150),\r\n          distinctUntilChanged()\r\n        )\r\n        .subscribe(() => {\r\n          if (!this.dataSource) {\r\n            return;\r\n          }\r\n          this.dataSource.filter = this.filter.nativeElement.value;\r\n        });\r\n    }\r\n  }\r\n\r\n  ngOnChanges(change) {\r\n    if (change.database) {\r\n      this.dataSource = new TableDataSource(\r\n        this.database,\r\n        this.model,\r\n        this.sort\r\n      );\r\n      this.selection.clear();\r\n    }\r\n  }\r\n\r\n  getActionColor(colorId: number): string {\r\n    return TableActionColor[colorId];\r\n  }\r\n\r\n  getValue(row, key) {\r\n    return ObjectUtils.resolve(row, key);\r\n  }\r\n\r\n  /** Whether the number of selected elements matches the total number of rows. */\r\n  isAllSelected() {\r\n    const numSelected = this.selection.selected.length;\r\n    const numRows = this.database.data.length;\r\n    return numSelected === numRows;\r\n  }\r\n\r\n  /** Selects all rows if they are not all selected; otherwise clear selection. */\r\n  masterToggle() {\r\n    this.isAllSelected()\r\n      ? this.selection.clear()\r\n      : this.database.data.forEach(row => this.selection.select(row));\r\n  }\r\n\r\n  handleClickAction(event, action, row) {\r\n    event.stopPropagation();\r\n    action.click(row);\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\nimport { CdkTableModule } from '@angular/cdk/table';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSortModule } from '@angular/material/sort';\r\nimport { MatTableModule } from '@angular/material/table';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { TableComponent } from './table.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    CdkTableModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatTableModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatSortModule,\r\n    MatCheckboxModule,\r\n    IgoLanguageModule\r\n  ],\r\n  declarations: [TableComponent],\r\n  exports: [TableComponent]\r\n})\r\nexport class IgoTableModule {\r\n  static forRoot(): ModuleWithProviders<IgoTableModule> {\r\n    return {\r\n      ngModule: IgoTableModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import { EntityStore } from '../../entity';\r\nimport { Action } from './action.interfaces';\r\n\r\n/**\r\n * The class is a specialized version of an EntityStore that stores\r\n * actions.\r\n */\r\nexport class ActionStore extends EntityStore<Action> {\r\n\r\n}\r\n","export enum ToolboxColor {\r\n  White = 'white',\r\n  Grey = 'grey',\r\n  Primary = 'primary'\r\n}\r\n","import {\r\n  trigger,\r\n  state,\r\n  style,\r\n  transition,\r\n  animate,\r\n  AnimationTriggerMetadata\r\n} from '@angular/animations';\r\n\r\nexport function toolSlideInOut(\r\n  speed = '300ms',\r\n  type = 'ease-in-out'\r\n): AnimationTriggerMetadata {\r\n  return trigger('toolSlideInOut', [\r\n    state(\r\n      'enter',\r\n      style({\r\n        transform: 'translate3d(0, 0, 0)'\r\n      })\r\n    ),\r\n    transition('void => enter', animate(speed + ' ' + type))\r\n  ]);\r\n}\r\n","<igo-actionbar\r\n  *ngIf=\"(toolbar$ | async).length > 0\"\r\n  [store]=\"actionStore\"\r\n  [withIcon]=\"true\"\r\n  [withTitle]=\"toolbarWithTitle$ | async\"\r\n  [withTooltip]=\"(toolbarWithTitle$ | async) === false\"\r\n  [scrollActive]=\"toolbarWithTitle$ | async\"\r\n  [horizontal]=\"false\">\r\n</igo-actionbar>\r\n\r\n<div\r\n  *ngIf=\"activeTool$ | async as tool\"\r\n  class=\"igo-tool-container\"\r\n  [ngClass]=\"{'igo-tool-container-with-toolbar': !actionStore.empty, 'igo-tool-container-with-animation': animate}\"\r\n  [@toolSlideInOut]=\"animation$ | async\"\r\n  (@toolSlideInOut.start)=\"onAnimationStart()\"\r\n  (@toolSlideInOut.done)=\"onAnimationComplete()\">\r\n\r\n  <igo-dynamic-outlet\r\n    [component]=\"tool.component\"\r\n    [inputs]=\"getToolInputs(tool)\">\r\n  </igo-dynamic-outlet>\r\n\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnDestroy,\r\n  OnInit,\r\n  HostBinding,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\n\r\nimport { Subscription, BehaviorSubject, Observable } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { Action, ActionStore } from '../../action';\r\nimport { Tool } from '../shared/tool.interface';\r\nimport { ToolboxColor } from '../shared/toolbox.enums';\r\nimport { Toolbox } from '../shared/toolbox';\r\nimport { toolSlideInOut } from './toolbox.animation';\r\n\r\n@Component({\r\n  selector: 'igo-toolbox',\r\n  templateUrl: 'toolbox.component.html',\r\n  styleUrls: ['toolbox.component.scss'],\r\n  animations: [toolSlideInOut()],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class ToolboxComponent implements OnInit, OnDestroy {\r\n  /**\r\n   * Observable of the active tool\r\n   */\r\n  activeTool$: BehaviorSubject<Tool> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Store of actions that toggle tools\r\n   */\r\n  actionStore: ActionStore = new ActionStore([]);\r\n\r\n  /**\r\n   * Observable of he anmation state\r\n   */\r\n  animation$: BehaviorSubject<string> = new BehaviorSubject('none');\r\n\r\n  /**\r\n   * Observable of the toolbar\r\n   */\r\n  toolbar$: BehaviorSubject<string[]> = new BehaviorSubject([]);\r\n\r\n  /**\r\n   * Whether the Toolbar should display actions' titles\r\n   */\r\n  toolbarWithTitle$: Observable<boolean> = this.activeTool$.pipe(\r\n    map((tool: Tool | undefined) => tool === undefined)\r\n  );\r\n\r\n  /**\r\n   * Subscription to the active tool\r\n   */\r\n  private activeTool$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to the toolbar\r\n   */\r\n  private toolbar$$: Subscription;\r\n\r\n  /**\r\n   * Observable of the ongoing animation. This is useful when\r\n   * multiple animations are triggered at once i.e. when the user clicks\r\n   * too fast on different actions\r\n   */\r\n  private animating$ = new BehaviorSubject<boolean>(false);\r\n\r\n  /**\r\n   * Subscription to the ongoing animation\r\n   */\r\n  private animating$$: Subscription;\r\n\r\n  /**\r\n   * Toolbox\r\n   */\r\n  @Input() toolbox: Toolbox;\r\n\r\n  /**\r\n   * Whether the toolbox should animate the first tool entering\r\n   */\r\n  @Input() animate: boolean = false;\r\n\r\n  /**\r\n   * Color of Toolbox\r\n   */\r\n  @Input() color: ToolboxColor = ToolboxColor.White;\r\n\r\n  /**\r\n   * @ignore\r\n   */\r\n  @HostBinding('class.color-grey')\r\n  get classColorGrey() {\r\n    return this.color === ToolboxColor.Grey;\r\n  }\r\n\r\n  /**\r\n   * @ignore\r\n   */\r\n  @HostBinding('class.color-primary')\r\n  get classColorPrimary() {\r\n    return this.color === ToolboxColor.Primary;\r\n  }\r\n\r\n  /**\r\n   * Initialize the toolbar and subscribe to the active tool\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.toolbar$$ = this.toolbox.toolbar$.subscribe((toolbar: string[]) =>\r\n      this.onToolbarChange(toolbar)\r\n    );\r\n    this.activeTool$$ = this.toolbox.activeTool$.subscribe((tool: Tool) =>\r\n      this.onActiveToolChange(tool)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to the active tool and destroy the action store\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.toolbar$$.unsubscribe();\r\n    this.activeTool$$.unsubscribe();\r\n    this.actionStore.destroy();\r\n  }\r\n\r\n  /**\r\n   * Track the starting animation\r\n   * @internal\r\n   */\r\n  onAnimationStart() {\r\n    this.animating$.next(true);\r\n  }\r\n\r\n  /**\r\n   * Untrack the completed animation\r\n   * @internal\r\n   */\r\n  onAnimationComplete() {\r\n    this.animating$.next(false);\r\n  }\r\n\r\n  /**\r\n   * Return a tool's inputs\r\n   * @param tool Tool\r\n   * @returns Tool inputs\r\n   * @internal\r\n   */\r\n  getToolInputs(tool: Tool): { [key: string]: any } {\r\n    return tool.options || {};\r\n  }\r\n\r\n  /**\r\n   * Initialize an action store\r\n   * @param toolbar Toolbar\r\n   */\r\n  private onToolbarChange(toolbar: string[]) {\r\n    this.setToolbar(toolbar);\r\n  }\r\n\r\n  /**\r\n   * Activate a tool and trigger an animation or not\r\n   * @param tool Tool to activate\r\n   */\r\n  private onActiveToolChange(tool: Tool) {\r\n    if (!this.animate) {\r\n      this.setActiveTool(tool);\r\n      return;\r\n    }\r\n    this.onAnimate(() => this.setActiveTool(tool));\r\n  }\r\n\r\n  /**\r\n   * Set the active tool\r\n   * @param tool Tool to activate\r\n   */\r\n  private setActiveTool(tool: Tool | undefined) {\r\n    if (tool === undefined) {\r\n      this.actionStore.state.updateAll({ active: false });\r\n    } else {\r\n      const action = this.actionStore.get(tool.name);\r\n      if (action !== undefined) {\r\n        this.actionStore.state.update(action, { active: true }, true);\r\n      }\r\n    }\r\n\r\n    this.activeTool$.next(tool);\r\n    if (this.animate) {\r\n      this.animation$.next('enter');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Initialize the toolbar\r\n   */\r\n  private setToolbar(toolbar: string[]) {\r\n    const actions = toolbar.reduce((acc: Action[], toolName: string) => {\r\n      const tool = this.toolbox.getTool(toolName);\r\n      if (tool === undefined) {\r\n        return acc;\r\n      }\r\n\r\n      acc.push({\r\n        id: tool.name,\r\n        title: tool.title,\r\n        icon: tool.icon,\r\n        // iconImage: tool.iconImage,\r\n        tooltip: tool.tooltip,\r\n        args: [tool, this.toolbox],\r\n        handler: (_tool: Tool, _toolbox: Toolbox) => {\r\n          _toolbox.activateTool(_tool.name);\r\n        },\r\n        ngClass: (_tool: Tool, _toolbox: Toolbox) => {\r\n          return this.toolbox.activeTool$.pipe(\r\n            map((activeTool: Tool) => {\r\n              let toolActivated = false;\r\n              if (activeTool !== undefined && _tool.name === activeTool.name) {\r\n                toolActivated = true;\r\n              }\r\n\r\n              let childrenToolActivated = false;\r\n              if (\r\n                activeTool !== undefined &&\r\n                _tool.name === activeTool.parent\r\n              ) {\r\n                childrenToolActivated = true;\r\n              }\r\n\r\n              return {\r\n                'tool-activated': toolActivated,\r\n                'children-tool-activated': childrenToolActivated\r\n              };\r\n            })\r\n          );\r\n        }\r\n      });\r\n      return acc;\r\n    }, []);\r\n    this.actionStore.load(actions);\r\n    this.toolbar$.next(toolbar);\r\n  }\r\n\r\n  /**\r\n   * Observe the ongoing animation and ignore any incoming animation\r\n   * while one is still ongoing.\r\n   * @param callback Callback to execute when the animation completes\r\n   */\r\n  private onAnimate(callback: () => void) {\r\n    this.unAnimate();\r\n    this.animating$$ = this.animating$.subscribe((animation: boolean) => {\r\n      if (!animation) {\r\n        callback.call(this);\r\n        this.unAnimate();\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Stop observing an animation when it's complete\r\n   */\r\n  private unAnimate() {\r\n    if (this.animating$$) {\r\n      this.animating$$.unsubscribe();\r\n    }\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoActionModule } from '../../action/action.module';\r\nimport {\r\n    IgoDynamicComponentModule\r\n} from '../../dynamic-component/dynamic-component.module';\r\n\r\nimport { ToolboxComponent } from './toolbox.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoActionModule,\r\n    IgoDynamicComponentModule\r\n  ],\r\n  exports: [\r\n    ToolboxComponent\r\n  ],\r\n  declarations: [\r\n    ToolboxComponent\r\n  ]\r\n})\r\nexport class IgoToolboxModule {}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { ToolService } from './shared/tool.service';\r\nimport { IgoToolboxModule } from './toolbox/toolbox.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule\r\n  ],\r\n  exports: [\r\n    IgoToolboxModule\r\n  ],\r\n  declarations: []\r\n})\r\nexport class IgoToolModule {\r\n  static forRoot(): ModuleWithProviders<IgoToolModule> {\r\n    return {\r\n      ngModule: IgoToolModule,\r\n      providers: [\r\n        ToolService\r\n      ]\r\n    };\r\n  }\r\n}\r\n","<igo-dynamic-outlet\r\n  *ngIf=\"widget\"\r\n  [component]=\"widget\"\r\n  [inputs]=\"inputs\"\r\n  [subscribers]=\"getEffectiveSubscribers()\">\r\n</igo-dynamic-outlet>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { DynamicComponent } from '../../dynamic-component';\r\n\r\nimport { WidgetComponent } from '../shared/widget.interfaces';\r\n\r\n/**\r\n * This component dynamically renders a widget. It also subscribes\r\n * to the widget's 'cancel' and 'complete' events and destroys it\r\n * when any of those event is emitted.\r\n */\r\n@Component({\r\n  selector: 'igo-widget-outlet',\r\n  templateUrl: './widget-outlet.component.html',\r\n  styleUrls: ['./widget-outlet.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class WidgetOutletComponent implements OnDestroy {\r\n\r\n  /**\r\n   * Widget subscribers to 'cancel' and 'complete'\r\n   * @internal\r\n   */\r\n  private baseSubscribers = {\r\n    cancel: (event: any) => this.onCancel(event),\r\n    complete: (event: any) => this.onComplete(event)\r\n  };\r\n\r\n  /**\r\n   * Widget\r\n   */\r\n  @Input() widget: DynamicComponent<WidgetComponent>;\r\n\r\n  /**\r\n   * Widget inputs\r\n   */\r\n  @Input() inputs: {[key: string]: any};\r\n\r\n  /**\r\n   * Widget subscribers\r\n   */\r\n  @Input() subscribers: {[key: string]: (event: any) => void} = {};\r\n\r\n  /**\r\n   * Event emitted when the widget emits 'complete'\r\n   */\r\n  @Output() complete = new EventEmitter<any>();\r\n\r\n  /**\r\n   * Event emitted when the widget emits 'cancel'\r\n   */\r\n  @Output() cancel = new EventEmitter<any>();\r\n\r\n  constructor() {}\r\n\r\n  /**\r\n   * Destroy the current widget and all it's inner subscriptions\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.destroyWidget();\r\n  }\r\n\r\n  /**\r\n   * Get the effective subscribers. That means a combination of the base\r\n   * subscribers and any subscriber given as input.\r\n   * @returns Combined subscribers\r\n   * @internal\r\n   */\r\n  getEffectiveSubscribers(): {[key: string]: (event: any) => void} {\r\n    const subscribers = Object.assign({}, this.subscribers);\r\n\r\n    // Base subscribers\r\n    Object.keys(this.baseSubscribers).forEach((key: string) => {\r\n      const subscriber = subscribers[key];\r\n      const baseSubscriber = this.baseSubscribers[key];\r\n      if (subscriber !== undefined) {\r\n        subscribers[key] = (event: any) => {\r\n          subscriber(event);\r\n          baseSubscriber(event);\r\n        };\r\n      } else {\r\n        subscribers[key] = baseSubscriber;\r\n      }\r\n    });\r\n\r\n    return subscribers;\r\n  }\r\n\r\n  /**\r\n   * When the widget emits 'cancel', propagate that event and destroy\r\n   * the widget\r\n   */\r\n  private onCancel(event: any) {\r\n    this.cancel.emit(event);\r\n    this.destroyWidget();\r\n  }\r\n\r\n  /**\r\n   * When the widget emits 'complete', propagate that event and destroy\r\n   * the widget\r\n   */\r\n  private onComplete(event: any) {\r\n    this.complete.emit(event);\r\n    this.destroyWidget();\r\n  }\r\n\r\n  /**\r\n   * Destroy the current widget\r\n   */\r\n  private destroyWidget() {\r\n    if (this.widget !== undefined) {\r\n      this.widget.destroy();\r\n    }\r\n    this.widget = undefined;\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport {\r\n  IgoDynamicComponentModule\r\n} from '../../dynamic-component/dynamic-component.module';\r\n\r\nimport { WidgetOutletComponent } from './widget-outlet.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoDynamicComponentModule\r\n  ],\r\n  exports: [\r\n    WidgetOutletComponent\r\n  ],\r\n  declarations: [\r\n    WidgetOutletComponent\r\n  ]\r\n})\r\nexport class IgoWidgetOutletModule {}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { DynamicComponentService } from '../../dynamic-component/shared/dynamic-component.service';\r\n\r\nimport { Widget } from './widget';\r\nimport { WidgetComponent } from './widget.interfaces';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class WidgetService {\r\n\r\n  constructor(private dynamicComponentService: DynamicComponentService) {}\r\n\r\n  create(widgetCls: any): Widget {\r\n    return this.dynamicComponentService.create(widgetCls as WidgetComponent);\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoWidgetOutletModule } from './widget-outlet/widget-outlet.module';\r\nimport { WidgetService } from './shared/widget.service';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoWidgetOutletModule\r\n  ],\r\n  exports: [\r\n    IgoWidgetOutletModule\r\n  ],\r\n  declarations: [],\r\n  providers: [\r\n    WidgetService\r\n  ]\r\n})\r\nexport class IgoWidgetModule {}\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\n\r\nimport { getEntityTitle } from '../../entity';\r\nimport { Workspace } from '../shared/workspace';\r\nimport { WorkspaceStore } from '../shared/store';\r\n\r\n/**\r\n * Drop list that activates the selected workspace emit an event.\r\n */\r\n@Component({\r\n  selector: 'igo-workspace-selector',\r\n  templateUrl: './workspace-selector.component.html',\r\n  styleUrls: ['./workspace-selector.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class WorkspaceSelectorComponent {\r\n\r\n  /**\r\n   * Store that holds the available workspaces.\r\n   */\r\n  @Input() store: WorkspaceStore;\r\n\r\n  /**\r\n   * Wheither the selector must be disabled or not.\r\n   */\r\n  @Input() disabled: boolean;\r\n\r\n  /**\r\n   * Event emitted when an workspace is selected or unselected\r\n   */\r\n  @Output() selectedChange = new EventEmitter<{\r\n    selected: boolean;\r\n    value: Workspace;\r\n  }>();\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  getWorkspaceTitle(workspace: Workspace): string {\r\n    return getEntityTitle(workspace);\r\n  }\r\n\r\n  /**\r\n   * When an workspace is manually selected, select it into the\r\n   * store and emit an event.\r\n   * @internal\r\n   * @param event The selection change event\r\n   */\r\n  onSelectedChange(event: {value: Workspace}) {\r\n    const workspace = event.value;\r\n    this.store.activateWorkspace(workspace);\r\n    this.selectedChange.emit({selected: true, value: workspace});\r\n  }\r\n\r\n}\r\n","<igo-entity-selector\r\n  [store]=\"store\"\r\n  [multi]=\"false\"\r\n  [titleAccessor]=\"getWorkspaceTitle\"\r\n  [disabled]=\"disabled\"\r\n  (selectedChange)=\"onSelectedChange($event)\">\r\n</igo-entity-selector>\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoEntitySelectorModule } from '../../entity/entity-selector/entity-selector.module';\r\nimport { WorkspaceSelectorComponent } from './workspace-selector.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoEntitySelectorModule\r\n  ],\r\n  exports: [\r\n    WorkspaceSelectorComponent\r\n  ],\r\n  declarations: [\r\n    WorkspaceSelectorComponent\r\n  ]\r\n})\r\nexport class IgoWorkspaceSelectorModule {}\r\n","<ng-container *ngIf=\"widget$ | async as widget\">\r\n  <igo-widget-outlet\r\n    [widget]=\"widget\"\r\n    [inputs]=\"widgetInputs$ | async\"\r\n    [subscribers]=\"widgetSubscribers$ | async\"\r\n    (cancel)=\"onWidgetCancel(widget)\"\r\n    (complete)=\"onWidgetComplete(widget)\">\r\n  </igo-widget-outlet>\r\n</ng-container>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { Widget } from '../../widget';\r\nimport { Workspace } from '../shared/workspace';\r\n\r\n/**\r\n * This component dynamically render an Workspace's active widget.\r\n * It also deactivate that widget whenever the widget's component\r\n * emit the 'cancel' or 'complete' event.\r\n */\r\n@Component({\r\n  selector: 'igo-workspace-widget-outlet',\r\n  templateUrl: './workspace-widget-outlet.component.html',\r\n  styleUrls: ['./workspace-widget-outlet.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class WorkspaceWidgetOutletComponent {\r\n\r\n  /**\r\n   * Workspace\r\n   */\r\n  @Input() workspace: Workspace;\r\n\r\n  /**\r\n   * Event emitted when a widget is deactivate which happens\r\n   * when the widget's component emits the 'cancel' or 'complete' event.\r\n   */\r\n  @Output() deactivateWidget = new EventEmitter<Widget>();\r\n\r\n  /**\r\n   * Observable of the workspace's active widget\r\n   * @internal\r\n   */\r\n  get widget$(): BehaviorSubject<Widget> { return this.workspace.widget$; }\r\n\r\n  /**\r\n   * Observable of the workspace's widget inputs\r\n   * @internal\r\n   */\r\n  get widgetInputs$(): BehaviorSubject<{[key: string]: any}> {\r\n    return this.workspace.widgetInputs$;\r\n  }\r\n\r\n  /**\r\n   * Observable of the workspace's widget inputs\r\n   * @internal\r\n   */\r\n  get widgetSubscribers$(): BehaviorSubject<{[key: string]: (event: any) => void}> {\r\n    return this.workspace.widgetSubscribers$;\r\n  }\r\n\r\n  constructor() {}\r\n\r\n  /**\r\n   * When a widget's component emit the 'cancel' event,\r\n   * deactivate that widget and emit the 'deactivateWidget' event.\r\n   * @param widget Widget\r\n   * @internal\r\n   */\r\n  onWidgetCancel(widget: Widget) {\r\n    this.workspace.deactivateWidget();\r\n    this.deactivateWidget.emit(widget);\r\n  }\r\n\r\n  /**\r\n   * When a widget's component emit the 'cancel' event,\r\n   * deactivate that widget and emit the 'deactivateWidget' event.\r\n   * @param widget Widget\r\n   * @internal\r\n   */\r\n  onWidgetComplete(widget: Widget) {\r\n    this.workspace.deactivateWidget();\r\n    this.deactivateWidget.emit(widget);\r\n  }\r\n\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoWidgetOutletModule } from '../../widget/widget-outlet/widget-outlet.module';\r\n\r\nimport { WorkspaceWidgetOutletComponent } from './workspace-widget-outlet.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoWidgetOutletModule\r\n  ],\r\n  exports: [\r\n    WorkspaceWidgetOutletComponent\r\n  ],\r\n  declarations: [\r\n    WorkspaceWidgetOutletComponent\r\n  ]\r\n})\r\nexport class IgoWorkspaceWidgetOutletModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoWorkspaceSelectorModule } from './workspace-selector/workspace-selector.module';\r\nimport { IgoWorkspaceWidgetOutletModule } from './workspace-widget-outlet/workspace-widget-outlet.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule\r\n  ],\r\n  exports: [\r\n    IgoWorkspaceSelectorModule,\r\n    IgoWorkspaceWidgetOutletModule\r\n  ],\r\n  declarations: []\r\n})\r\nexport class IgoWorkspaceModule {}\r\n","import { BehaviorSubject } from 'rxjs';\r\n\r\nexport class TableDatabase {\r\n  /** Stream that emits whenever the data has been modified. */\r\n  dataChange: BehaviorSubject<any[]> = new BehaviorSubject<any[]>([]);\r\n  get data(): any[] {\r\n    return this.dataChange.value;\r\n  }\r\n\r\n  constructor(data?) {\r\n    if (data) {\r\n      this.dataChange.next(data);\r\n    }\r\n  }\r\n\r\n  set(data) {\r\n    this.dataChange.next(data);\r\n  }\r\n\r\n  add(item) {\r\n    const copiedData = this.data.slice();\r\n    copiedData.push(item);\r\n    this.set(copiedData);\r\n  }\r\n\r\n  remove(item) {\r\n    const copiedData = this.data.slice();\r\n    const index = copiedData.indexOf(item);\r\n    copiedData.splice(index, 1);\r\n    this.set(copiedData);\r\n  }\r\n}\r\n","import { Tool } from './tool.interface';\r\nimport { ToolService } from './tool.service';\r\n\r\nexport function ToolComponent(tool: Partial<Tool>): (cls: any) => any {\r\n  return (compType: any) => {\r\n    ToolService.register(Object.assign({}, tool, {\r\n      component: compType\r\n    } as Tool));\r\n  };\r\n}\r\n","import { EntityStore } from '../../entity';\r\nimport { Workspace } from './workspace';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\n/**\r\n * The class is a specialized version of an EntityStore that stores\r\n * workspaces.\r\n */\r\nexport class WorkspaceStore extends EntityStore<Workspace> {\r\n\r\n  activeWorkspace$: BehaviorSubject<Workspace> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Activate the an workspace workspace and deactivate the one currently active\r\n   * @param workspace Workspace\r\n   */\r\n  activateWorkspace(workspace: Workspace) {\r\n    const active = this.activeWorkspace$.value;\r\n    if (active !== undefined) {\r\n      active.deactivate();\r\n    }\r\n\r\n    this.deactivateWorkspace();\r\n    if (workspace !== undefined) {\r\n      this.state.update(workspace, {active: true, selected: true}, true);\r\n      this.activeWorkspace$.next(workspace);\r\n      workspace.activate();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Deactivate the current workspace\r\n   * @param workspace Workspace\r\n   */\r\n  deactivateWorkspace() {\r\n    const active = this.activeWorkspace$.value;\r\n    if (active !== undefined) {\r\n      active.deactivate();\r\n      this.activeWorkspace$.next(undefined);\r\n    }\r\n  }\r\n\r\n}\r\n","import { Subscription, BehaviorSubject, Subject } from 'rxjs';\r\n\r\nimport { ActionStore } from '../../action';\r\nimport { Widget } from '../../widget';\r\nimport { EntityStore } from '../../entity';\r\n\r\nimport { WorkspaceOptions } from './workspace.interfaces';\r\n\r\n/**\r\n * This class is responsible of managing the relations between\r\n * entities and the actions that consume them. It also defines an\r\n * entity table template that may be used by an entity table component.\r\n */\r\nexport class Workspace<E extends object = object> {\r\n\r\n  /**\r\n   * Observable of the selected widget\r\n   */\r\n  readonly widget$ = new BehaviorSubject<Widget>(undefined);\r\n\r\n  /**\r\n   * Observable of the selected widget's inputs\r\n   */\r\n  readonly widgetInputs$ = new BehaviorSubject<{[key: string]: any}>({});\r\n\r\n  /**\r\n   * Observable of the selected widget's subscribers\r\n   */\r\n  readonly widgetSubscribers$ = new BehaviorSubject<{[key: string]: (event: any) => void}>({});\r\n\r\n  /**\r\n   * Subscription to the selected entity\r\n   */\r\n  private entities$$: Subscription;\r\n\r\n  /**\r\n   * State change that trigger an update of the actions availability\r\n   */\r\n  private change: Subject<void> = new Subject();\r\n\r\n  /**\r\n   * Subscription to state changes\r\n   */\r\n  private change$: Subscription;\r\n\r\n  /**\r\n   * Workspace id\r\n   */\r\n  get id(): string { return this.options.id; }\r\n\r\n  /**\r\n   * Workspace title\r\n   */\r\n  get title(): string { return this.options.title; }\r\n\r\n  /**\r\n   * Workspace title\r\n   */\r\n  get meta(): {[key: string]: any} { return this.options.meta || {}; }\r\n\r\n  /**\r\n   * Entities store\r\n   */\r\n  get entityStore(): EntityStore<E> { return this.options.entityStore as EntityStore<E>; }\r\n\r\n  /**\r\n   * Actions store (some actions activate a widget)\r\n   */\r\n  get actionStore(): ActionStore { return this.options.actionStore; }\r\n\r\n  /**\r\n   * Selected widget\r\n   */\r\n  get widget(): Widget { return this.widget$.value; }\r\n\r\n  /**\r\n   * Whether a widget is selected\r\n   */\r\n  get hasWidget(): boolean { return this.widget !== undefined; }\r\n\r\n  constructor(protected options: WorkspaceOptions) {}\r\n\r\n  /**\r\n   * Whether this strategy is active\r\n   * @internal\r\n   */\r\n  get active(): boolean { return this.active$.value; }\r\n  readonly active$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  /**\r\n   * Activate the workspace. By doing that, the workspace will observe\r\n   * the selected entity (from the store) and update the actions availability.\r\n   * For example, some actions require an entity to be selected.\r\n   */\r\n  activate() {\r\n    if (this.active === true) {\r\n      this.deactivate();\r\n    }\r\n    this.active$.next(true);\r\n\r\n    if (this.entityStore !== undefined) {\r\n      this.entities$$ = this.entityStore.stateView.all$()\r\n        .subscribe(() => this.onStateChange());\r\n    }\r\n\r\n    this.change.next();\r\n  }\r\n\r\n  /**\r\n   * Deactivate the workspace. Unsubcribe to the selected entity.\r\n   */\r\n  deactivate() {\r\n    this.active$.next(false);\r\n    this.deactivateWidget();\r\n\r\n    if (this.entities$$ !== undefined) {\r\n      this.entities$$.unsubscribe();\r\n    }\r\n    if (this.change$ !== undefined) {\r\n      this.change$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Activate a widget. In itself, activating a widget doesn't render it but,\r\n   * if an WorkspaceWidgetOutlet component is bound to this workspace, the widget will\r\n   * show up.\r\n   * @param widget Widget\r\n   * @param inputs Inputs the widget will receive\r\n   */\r\n  activateWidget(\r\n    widget: Widget,\r\n    inputs: {[key: string]: any} = {},\r\n    subscribers: {[key: string]: (event: any) => void} = {}\r\n  ) {\r\n    this.widget$.next(widget);\r\n    this.widgetInputs$.next(inputs);\r\n    this.widgetSubscribers$.next(subscribers);\r\n    this.change.next();\r\n  }\r\n\r\n  /**\r\n   * Deactivate a widget.\r\n   */\r\n  deactivateWidget() {\r\n    this.widget$.next(undefined);\r\n    this.change.next();\r\n  }\r\n\r\n  /**\r\n   * When the state changes, update the actions availability.\r\n   */\r\n  private onStateChange() {\r\n    this.change.next();\r\n  }\r\n\r\n}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppHomeComponent } from './home.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'home',\r\n    component: AppHomeComponent\r\n  }\r\n];\r\n\r\nexport const AppHomeRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\nimport { InteractiveTourService } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'app-home',\r\n  templateUrl: './home.component.html',\r\n  styleUrls: ['./home.component.scss']\r\n})\r\nexport class AppHomeComponent {\r\n  constructor(private interactiveTourService: InteractiveTourService) {}\r\n\r\n  startTour() {\r\n    this.interactiveTourService.startTour('global');\r\n  }\r\n}\r\n","<div style=\"text-align:center\">\r\n  <h1 id=\"igo-title\">\r\n    Welcome to IGO\r\n  </h1>\r\n  <img  class=\"igo-logo\" width=\"180\" src=\"assets/igo2/core/logo.png\">\r\n</div>\r\n\r\n<p>\r\n  <igo-interactive-tour\r\n    tourToStart = \"global\"\r\n    menuIsOpen = true\r\n    styleButton = \"raised\">\r\n  </igo-interactive-tour>\r\n</p>\r\n\r\n<p>\r\n  IGO2 library contains many components and services that may benefit any web application. <br>\r\n  IGO2 library is open source project using Angular, Angular Material and OpenLayers.\r\n</p>\r\n\r\n<h3>IGO2 library is divided into several elements: </h3>\r\n<ul>\r\n  <li><b>@igo2/utils</b> : Basic utilies without dependency (ex: base64, clipboard, uuid)</li>\r\n  <li><b>@igo2/core</b> : Element affecting the core of the application (ex: config, language, message, media, request)</li>\r\n  <li><b>@igo2/common</b> : Library containing reusable components (ex: clickout, drag-drop, list, panel, spinner, table)</li>\r\n  <li><b>@igo2/auth</b> : Library grouping the authentication and security module</li>\r\n  <li><b>@igo2/geo</b> : Library containing the geomatic components. Depends on Openlayers.</li>\r\n  <li><b>@igo2/context</b> : Library of components uniting @igo2/geo and @igo2/auth</li>\r\n  <li><b>@igo2/integration</b> : Library integrate basic components</li>\r\n</ul>\r\n\r\n<h2>Here are some links to help you start: </h2>\r\n<ul>\r\n  <li>\r\n    <h2><a target=\"_blank\" rel=\"noopener\" href=\"https://github.com/infra-geo-ouverte/igo2-lib/blob/master/README.md#user-installation\">Installation</a></h2>\r\n  </li>\r\n  <li>\r\n    <h2><a target=\"_blank\" rel=\"noopener\" href=\"https://angular.io/docs\">Angular Documentation</a></h2>\r\n  </li>\r\n</ul>\r\n\r\n*** Modules in <code>@igo2/core</code> must be imported only once\r\n","import { NgModule } from '@angular/core';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { AppHomeComponent } from './home.component';\r\nimport { AppHomeRoutingModule } from './home-routing.module';\r\nimport { IgoInteractiveTourModule } from '@igo2/common';\r\n\r\n@NgModule({\r\n  declarations: [AppHomeComponent],\r\n  imports: [\r\n    AppHomeRoutingModule,\r\n    IgoInteractiveTourModule,\r\n    MatTooltipModule,\r\n    MatIconModule,\r\n    MatButtonModule\r\n  ],\r\n  exports: [AppHomeComponent]\r\n})\r\nexport class AppHomeModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\nimport { AppActivityComponent } from './activity.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'activity',\r\n    component: AppActivityComponent\r\n  }\r\n];\r\n\r\nexport const AppActivityRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { ActivityService } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'app-activity',\r\n  templateUrl: './activity.component.html',\r\n  styleUrls: ['./activity.component.scss']\r\n})\r\nexport class AppActivityComponent {\r\n  private idsActivity: string[] = [];\r\n\r\n  constructor(private activityService: ActivityService) {}\r\n\r\n  register() {\r\n    this.idsActivity.push(this.activityService.register());\r\n  }\r\n\r\n  unregister() {\r\n    this.activityService.unregister(this.idsActivity.pop());\r\n  }\r\n\r\n  get counter() {\r\n    return this.activityService.counter$.value;\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Core</mat-card-subtitle>\r\n  <mat-card-title>Activity</mat-card-title>\r\n  <mat-card-content>\r\n    <p>Register activities in service. Use to display a loading icon</p>\r\n\r\n    <li>Import <code>IgoActivityModule</code> only if you want register http calls</li>\r\n    <li>Import <code>IgoActivityModule</code> only once</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/core/activity\"> code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <mat-card-actions>\r\n    <button mat-raised-button (click)=\"register()\">Register</button>\r\n    <button mat-raised-button (click)=\"unregister()\">Unregister</button>\r\n  </mat-card-actions>\r\n  <p>Counter: {{counter}}</p>\r\n\r\n  <igo-spinner igoSpinnerActivity></igo-spinner>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoActivityModule } from '@igo2/core';\r\nimport { IgoSpinnerModule } from '@igo2/common';\r\n\r\nimport { AppActivityComponent } from './activity.component';\r\nimport { AppActivityRoutingModule } from './activity-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppActivityComponent],\r\n  imports: [\r\n    AppActivityRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoActivityModule.forRoot(), // Only if you want register http calls\r\n    IgoSpinnerModule\r\n  ],\r\n  exports: [AppActivityComponent]\r\n})\r\nexport class AppActivityModule {}\r\n","interface Environment {\r\n  production: boolean;\r\n  igo: any;\r\n}\r\n\r\nexport const environment: Environment = {\r\n  production: true,\r\n  igo: {\r\n    projections: [\r\n      {\r\n        code: 'EPSG:32198',\r\n        alias: 'Quebec Lambert',\r\n        def:\r\n          '+proj=lcc +lat_1=60 +lat_2=46 +lat_0=44 +lon_0=-68.5 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs',\r\n        extent: [-886251.0296, 180252.9126, 897177.3418, 2106143.8139]\r\n      }\r\n    ],\r\n    auth: {\r\n      intern: {\r\n        enabled: true\r\n      },\r\n      allowAnonymous: true\r\n    },\r\n    interactiveTour: {\r\n      tourInMobile: true\r\n    },\r\n    importExport: {\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ogre'\r\n    },\r\n    language: {\r\n      prefix: './locale/'\r\n    },\r\n    catalog: {\r\n      sources: [\r\n        {\r\n          id: 'Gououvert',\r\n          title: 'Gouvouvert',\r\n          url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi'\r\n        },\r\n        {\r\n          id: 'DefiningInfoFormat',\r\n          title: 'Defining info_format',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          queryFormat: {\r\n            html: '*',\r\n            'application/json': [\r\n              'stations_meteoroutieres',\r\n              'histo_stations_meteoroutieres'\r\n            ]\r\n          },\r\n          queryHtmlTarget: 'iframe',\r\n          count: 30\r\n        },\r\n        {\r\n          id: 'catalogwithregex',\r\n          title: 'Filtered catalog by regex',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          regFilters: ['zpegt']\r\n        },\r\n        {\r\n          id: 'catalogwithtooltipcontrol',\r\n          title: 'Controling tooltip format',\r\n          url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n          tooltipType: 'abstract' // or title\r\n        }\r\n      ]\r\n    },\r\n    searchSources: {\r\n      storedqueriesreverse: { enabled: false},\r\n      nominatim: {\r\n        enabled: false\r\n      },\r\n      icherche: {\r\n        searchUrl: 'https://geoegl.msp.gouv.qc.ca/apis/icherche',\r\n        order: 2,\r\n        enabled: true,\r\n        params: {\r\n          limit: '8'\r\n        }\r\n      },\r\n      coordinatesreverse: {\r\n        showInPointerSummary: true\r\n      },\r\n      icherchereverse: {\r\n        showInPointerSummary: true,\r\n        searchUrl: 'https://geoegl.msp.gouv.qc.ca/apis/terrapi',\r\n        order: 3,\r\n        enabled: true\r\n      },\r\n      ilayer: {\r\n        searchUrl: 'https://geoegl.msp.gouv.qc.ca/apis/layers/search',\r\n        order: 4,\r\n        enabled: true,\r\n        params: {\r\n          limit: '5'\r\n        }\r\n      }\r\n    }\r\n  }\r\n};\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppConfigComponent } from './config.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'config',\r\n    component: AppConfigComponent\r\n  }\r\n];\r\n\r\nexport const AppConfigRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\nimport { ConfigService, LanguageOptions } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'app-config',\r\n  templateUrl: './config.component.html',\r\n  styleUrls: ['./config.component.scss']\r\n})\r\nexport class AppConfigComponent {\r\n  public configLanguage: LanguageOptions;\r\n\r\n  constructor(private configService: ConfigService) {\r\n    this.configLanguage = this.configService.getConfig('language');\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Core</mat-card-subtitle>\r\n  <mat-card-title>config</mat-card-title>\r\n  <mat-card-content>\r\n    <p>Load config in your angular application</p>\r\n\r\n    <li>Import <code>IgoConfigModule</code> only once</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/core/config\"> code of this example</a> <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/environments\"> environment config</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <p>Config language: {{configLanguage | json }}<p>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoConfigModule, provideConfigOptions } from '@igo2/core';\r\n\r\nimport { environment } from '../../../environments/environment';\r\nimport { AppConfigComponent } from './config.component';\r\nimport { AppConfigRoutingModule } from './config-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppConfigComponent],\r\n  imports: [\r\n    AppConfigRoutingModule,\r\n    CommonModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoConfigModule.forRoot()\r\n  ],\r\n  exports: [AppConfigComponent],\r\n  providers: [\r\n    provideConfigOptions({\r\n      default: environment.igo\r\n    })\r\n  ]\r\n})\r\nexport class AppConfigModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppLanguageComponent } from './language.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'language',\r\n    component: AppLanguageComponent\r\n  }\r\n];\r\n\r\nexport const AppLanguageRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\nimport { LanguageService } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'app-language',\r\n  templateUrl: './language.component.html',\r\n  styleUrls: ['./language.component.scss']\r\n})\r\nexport class AppLanguageComponent {\r\n  public app = {\r\n    title: 'IGO'\r\n  };\r\n  constructor(private languageService: LanguageService) {}\r\n\r\n  changeLanguage(language: string) {\r\n    this.languageService.setLanguage(language);\r\n    console.log(this.languageService);\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Core</mat-card-subtitle>\r\n  <mat-card-title>language</mat-card-title>\r\n  <mat-card-content>\r\n    <p>Translate your angular application</p>\r\n\r\n    <li>Import <code>IgoLanguageModule</code> only once</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/core/language\">code of this example</a><br>\r\n    See language section of the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/environments\"> environment config</a><br>\r\n    See <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/locale\">locale files</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <mat-card-actions>\r\n    <button mat-raised-button (click)=\"changeLanguage('en')\">English</button>\r\n    <button mat-raised-button (click)=\"changeLanguage('fr')\">Franais</button>\r\n  </mat-card-actions>\r\n\r\n  <p>{{'welcome' | translate: app}}<p>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { AppLanguageComponent } from './language.component';\r\nimport { AppLanguageRoutingModule } from './language-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppLanguageComponent],\r\n  imports: [\r\n    AppLanguageRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoLanguageModule.forRoot()\r\n  ],\r\n  exports: [AppLanguageComponent]\r\n})\r\nexport class AppLanguageModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppMediaComponent } from './media.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'media',\r\n    component: AppMediaComponent\r\n  }\r\n];\r\n\r\nexport const AppMediaRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { MediaService } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'app-media',\r\n  templateUrl: './media.component.html',\r\n  styleUrls: ['./media.component.scss']\r\n})\r\nexport class AppMediaComponent {\r\n  constructor(private mediaService: MediaService) {}\r\n\r\n  get media() {\r\n    return this.mediaService.getMedia();\r\n  }\r\n\r\n  get orientation() {\r\n    return this.mediaService.getOrientation();\r\n  }\r\n\r\n  get isTouchScreen() {\r\n    return this.mediaService.isTouchScreen();\r\n  }\r\n\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Core</mat-card-subtitle>\r\n  <mat-card-title>Media</mat-card-title>\r\n  <mat-card-content>\r\n    <p>Detect type of media (mobile, tablet, desktop)</p>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/core/media\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <p>Current media: {{media}}</p>\r\n  <p>Current orientation: {{orientation}}</p>\r\n  <p>Device mode:  {{isTouchScreen ? 'Touch device' : 'Not a touch device '}}</p>\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { AppMediaComponent } from './media.component';\r\nimport { AppMediaRoutingModule } from './media-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppMediaComponent],\r\n  imports: [AppMediaRoutingModule, MatCardModule],\r\n  exports: [AppMediaComponent]\r\n})\r\nexport class AppMediaModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppMessageComponent } from './message.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'message',\r\n    component: AppMessageComponent\r\n  }\r\n];\r\n\r\nexport const AppMessageRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { MessageService } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'app-message',\r\n  templateUrl: './message.component.html',\r\n  styleUrls: ['./message.component.scss']\r\n})\r\nexport class AppMessageComponent {\r\n  constructor(private messageService: MessageService) {}\r\n\r\n  success() {\r\n    this.messageService.success('Congratulations', 'Success');\r\n  }\r\n\r\n  info() {\r\n    this.messageService.info('Welcome to IGO', 'Info');\r\n  }\r\n\r\n  alert() {\r\n    this.messageService.alert('Warning', 'Alert');\r\n  }\r\n  error() {\r\n    this.messageService.error('There is a bug', 'Error');\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Core</mat-card-subtitle>\r\n  <mat-card-title>Message</mat-card-title>\r\n  <mat-card-content>\r\n    <p>Show message to user.</p>\r\n\r\n    <li>Import <code>IgoMessageModule</code> only once</li>\r\n    <li>Dependencies: BrowserAnimationsModule </li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/core/message\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <mat-card-actions>\r\n    <button mat-raised-button (click)=\"success()\">Success message</button>\r\n    <button mat-raised-button color='primary' (click)=\"info()\">Info message</button>\r\n    <button mat-raised-button color='accent' (click)=\"alert()\">Alert message</button>\r\n    <button mat-raised-button color='warn' (click)=\"error()\">Error message</button>\r\n  </mat-card-actions>\r\n</mat-card>\r\n\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMessageModule } from '@igo2/core';\r\n\r\nimport { AppMessageComponent } from './message.component';\r\nimport { AppMessageRoutingModule } from './message-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppMessageComponent],\r\n  imports: [\r\n    AppMessageRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoMessageModule.forRoot()\r\n  ],\r\n  exports: [AppMessageComponent]\r\n})\r\nexport class AppMessageModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppRequestComponent } from './request.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'request',\r\n    component: AppRequestComponent\r\n  }\r\n];\r\n\r\nexport const AppRequestRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'app-request',\r\n  templateUrl: './request.component.html',\r\n  styleUrls: ['./request.component.scss']\r\n})\r\nexport class AppRequestComponent {\r\n  constructor(\r\n    private http: HttpClient,\r\n    public languageService: LanguageService\r\n  ) {}\r\n\r\n  callHttp() {\r\n    const url = 'https://geoegl.msp.gouv.qc.ca/apis/icherche/info';\r\n    this.http.get(url).subscribe(rep => {\r\n      console.log(rep);\r\n    });\r\n  }\r\n\r\n  callHttpError() {\r\n    const url = '404';\r\n    this.http.get(url).subscribe(rep => {\r\n      console.log(rep);\r\n    });\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Core</mat-card-subtitle>\r\n  <mat-card-title>Request</mat-card-title>\r\n  <mat-card-content>\r\n    <p>Register http calls in console</p>\r\n\r\n    <li>Import <code>IgoLoggingModule</code> only if you want register http calls in console</li>\r\n    <li>Import <code>IgoErrorModule</code> only if you want register errors from http call in console</li>\r\n    <li>Import modules only once</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/core/request\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <mat-card-actions>\r\n    <button mat-raised-button (click)=\"callHttp()\">Log</button>\r\n    <button mat-raised-button (click)=\"callHttpError()\">Error</button>\r\n  </mat-card-actions>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { HttpClientModule } from '@angular/common/http';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoErrorModule, IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { AppRequestComponent } from './request.component';\r\nimport { AppRequestRoutingModule } from './request-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppRequestComponent],\r\n  imports: [\r\n    AppRequestRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    HttpClientModule,\r\n    IgoLanguageModule.forRoot(),\r\n    IgoErrorModule.forRoot() // Only if you want register errors from http call in console\r\n    // IgoLoggingModule.forRoot() // Only if you want register http calls in console\r\n  ],\r\n  exports: [AppRequestComponent]\r\n})\r\nexport class AppRequestModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Action</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/action\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-actionbar\r\n    [store]=\"store\"\r\n    [withIcon]=\"true\"\r\n    [withTitle]=\"actionbarMode === 'overlay'\"\r\n    [horizontal]=\"true\"\r\n    [mode]=\"actionbarMode\">\r\n  </igo-actionbar>\r\n\r\n</mat-card>\r\n<p></p>\r\n\r\n<mat-card [igoContextMenu]= actionbarMenu>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Action context-menu</mat-card-title>\r\n  <div></div>\r\n</mat-card>\r\n\r\n\r\n\r\n<ng-template #actionbarMenu>\r\n  <igo-actionbar\r\n    [store]=\"store\"\r\n    [withIcon]=\"true\"\r\n    [horizontal]=\"true\"\r\n    [mode]=\"'context'\">\r\n  </igo-actionbar>\r\n</ng-template>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppActionComponent } from './action.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'action',\r\n    component: AppActionComponent\r\n  }\r\n];\r\n\r\nexport const AppActionRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit, OnDestroy } from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport {\r\n  Media,\r\n  MediaOrientation,\r\n  MediaService,\r\n  LanguageService\r\n} from '@igo2/core';\r\nimport { ActionStore, ActionbarMode } from '@igo2/common';\r\nimport { Overlay } from '@angular/cdk/overlay';\r\n\r\n@Component({\r\n  selector: 'app-action',\r\n  templateUrl: './action.component.html',\r\n  styleUrls: ['./action.component.scss']\r\n})\r\nexport class AppActionComponent implements OnInit, OnDestroy {\r\n  public store = new ActionStore([]);\r\n\r\n  private added$ = new BehaviorSubject(false);\r\n\r\n  get actionbarMode(): ActionbarMode {\r\n    const media = this.mediaService.media$.value;\r\n    const orientation = this.mediaService.orientation$.value;\r\n    if (media === Media.Desktop && orientation === MediaOrientation.Landscape) {\r\n      return ActionbarMode.Dock;\r\n    }\r\n    return ActionbarMode.Overlay;\r\n  }\r\n\r\n  constructor(\r\n    public overlay: Overlay,\r\n    private mediaService: MediaService,\r\n    private languageService: LanguageService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.store.load([\r\n      {\r\n        id: 'add',\r\n        title: 'Add',\r\n        icon: 'plus',\r\n        tooltip: 'Add Tooltip',\r\n        handler: () => {\r\n          alert('Add!');\r\n          this.added$.next(true);\r\n        }\r\n      },\r\n      {\r\n        id: 'edit',\r\n        title: 'Edit',\r\n        icon: 'pencil',\r\n        tooltip: 'Edit Tooltip',\r\n        args: ['1'],\r\n        handler: (item: string) => {\r\n          alert(`Edit item ${item}!`);\r\n        },\r\n        availability: () => this.added$\r\n      },\r\n      {\r\n        id: 'delete',\r\n        title: 'Delete',\r\n        tooltip: 'Delete Tooltip',\r\n        icon: 'delete',\r\n        handler: () => {\r\n          alert('Delete!');\r\n          this.added$.next(false);\r\n        },\r\n        availability: () => this.added$\r\n      }\r\n    ]);\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.store.destroy();\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoActionModule, IgoContextMenuModule } from '@igo2/common';\r\n\r\nimport { AppActionComponent } from './action.component';\r\nimport { AppActionRoutingModule } from './action-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppActionComponent],\r\n  imports: [\r\n    AppActionRoutingModule,\r\n    MatButtonModule,\r\n    MatCardModule,\r\n    IgoActionModule,\r\n    IgoContextMenuModule\r\n  ],\r\n  exports: [AppActionComponent]\r\n})\r\nexport class AppActionModule {}\r\n","import { Component, Input, ChangeDetectionStrategy, ChangeDetectorRef } from '@angular/core';\r\n\r\nimport { OnUpdateInputs } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'app-salutation-component',\r\n  template: '<p>Hello, my name is {{name}}.</p>',\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AppSalutationComponent implements OnUpdateInputs {\r\n\r\n  @Input() name: string;\r\n\r\n  constructor(private cdRef: ChangeDetectorRef) {}\r\n\r\n  onUpdateInputs() {\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n}\r\n\r\n@Component({\r\n  selector: 'app-explanation-component',\r\n  template: '<p>I am a dynamic component, rendered into an IgoDynamicOutlet.</p>',\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AppExplanationComponent implements OnUpdateInputs {\r\n\r\n  constructor(private cdRef: ChangeDetectorRef) {}\r\n\r\n  onUpdateInputs() {\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n}\r\n\r\n@Component({\r\n  selector: 'app-dynamic-component',\r\n  templateUrl: './dynamic-component.component.html',\r\n  styleUrls: ['./dynamic-component.component.scss']\r\n})\r\nexport class AppDynamicComponentComponent {\r\n\r\n  component: any = AppSalutationComponent;\r\n\r\n  inputs = {name: 'Bob'};\r\n\r\n  toggleComponent() {\r\n    this.component = this.component === AppSalutationComponent ?\r\n      AppExplanationComponent :\r\n      AppSalutationComponent;\r\n  }\r\n\r\n}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppDynamicComponentComponent } from './dynamic-component.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'dynamic-component',\r\n    component: AppDynamicComponentComponent\r\n  }\r\n];\r\n\r\nexport const AppDynamicComponentRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","<mat-card>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Dynamic Component</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/dynamic-component\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-dynamic-outlet\r\n    [component]=\"component\"\r\n    [inputs]=\"inputs\">\r\n  </igo-dynamic-outlet>\r\n\r\n  <button mat-flat-button color=\"primary\" (click)=\"toggleComponent()\">Toggle Component</button>\r\n</mat-card>\r\n\r\n\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoDynamicComponentModule } from '@igo2/common';\r\n\r\nimport {\r\n  AppSalutationComponent,\r\n  AppExplanationComponent,\r\n  AppDynamicComponentComponent\r\n} from './dynamic-component.component';\r\nimport { AppDynamicComponentRoutingModule } from './dynamic-component-routing.module';\r\n\r\n@NgModule({\r\n    declarations: [\r\n        AppSalutationComponent,\r\n        AppDynamicComponentComponent,\r\n        AppExplanationComponent\r\n    ],\r\n    imports: [\r\n        AppDynamicComponentRoutingModule,\r\n        MatButtonModule,\r\n        MatCardModule,\r\n        IgoDynamicComponentModule\r\n    ],\r\n    exports: [AppDynamicComponentComponent]\r\n})\r\nexport class AppDynamicComponentModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppEntityTableComponent } from './entity-table.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'entity-table',\r\n    component: AppEntityTableComponent\r\n  }\r\n];\r\n\r\nexport const AppEntityTableRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit, OnDestroy } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  EntityStore,\r\n  EntityTableButton,\r\n  getEntityProperty,\r\n  EntityTableColumnRenderer,\r\n  EntityTablePaginatorOptions\r\n} from '@igo2/common';\r\nimport { MatPaginator } from '@angular/material/paginator';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'app-entity-table',\r\n  templateUrl: './entity-table.component.html',\r\n  styleUrls: ['./entity-table.component.scss']\r\n})\r\nexport class AppEntityTableComponent implements OnInit, OnDestroy {\r\n  public store = new EntityStore([]);\r\n  public paginator: MatPaginator;\r\n  entitySortChange$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  public paginatorOptions: EntityTablePaginatorOptions = {pageSize: 10};\r\n\r\n  public template = {\r\n    selection: true,\r\n    selectionCheckbox: true,\r\n    selectMany: true,\r\n    sort: true,\r\n    valueAccessor: (entity: object, name: string) => {\r\n      return getEntityProperty(entity, name);\r\n    },\r\n    columns: [\r\n      {\r\n        name: 'selected',\r\n        title: 'Selected',\r\n        valueAccessor: (entity: object) => {\r\n          return this.store.state.get(entity).selected\r\n            ? 'radiobox-marked'\r\n            : 'radiobox-blank';\r\n        },\r\n        renderer: EntityTableColumnRenderer.Icon\r\n      },\r\n      {\r\n        name: 'id',\r\n        title: 'ID'\r\n      },\r\n      {\r\n        name: 'name',\r\n        title: 'Name'\r\n      },\r\n      {\r\n        name: 'description',\r\n        title: 'Description',\r\n        renderer: EntityTableColumnRenderer.HTML\r\n      },\r\n      {\r\n        name: 'url',\r\n        title: 'Hyperlink'\r\n      },\r\n      {\r\n        name: 'image',\r\n        title: 'Image'\r\n      },\r\n      {\r\n        name: 'action',\r\n        title: '',\r\n        valueAccessor: (entity: object) => {\r\n          return [{\r\n            icon: 'home',\r\n            color: 'warn',\r\n            click: (row) => { console.log(row); }\r\n          }] as EntityTableButton[];\r\n        },\r\n        renderer: EntityTableColumnRenderer.ButtonGroup\r\n      }\r\n    ]\r\n  };\r\n\r\n  constructor(private languageService: LanguageService) {}\r\n\r\n  ngOnInit() {\r\n    const ids = [2, 1, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13];\r\n\r\n    const entities = ids.map(id => {\r\n      if (id === 3) {\r\n        return { id , name: `Name ${id}`, description: `<b>Description ${id}</b>`, url: 'https://igouverte.org', image: 'https://www.igouverte.org/assets/img/NONEXISTINGIMAGE.png'};\r\n      }\r\n      return { id , name: `Name ${id}`, description: `<b>Description ${id}</b>`, url: 'https://igouverte.org', image: 'https://www.igouverte.org/assets/img/Igo_logoavec.png'};\r\n    });\r\n    this.store.load(entities);\r\n  }\r\n\r\n  entitySortChange() {\r\n    this.entitySortChange$.next(true);\r\n  }\r\n\r\n  paginatorChange(event: MatPaginator) {\r\n    this.paginator = event;\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.store.destroy();\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Entity Table</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/entity-table\">code of this example</a>\r\n  </mat-card-content>\r\n  <igo-entity-table\r\n    [store]=\"store\"\r\n    [withPaginator]=\"true\"\r\n    [paginatorOptions]=\"paginatorOptions\"\r\n    [template]=\"template\"\r\n    (entitySortChange)=\"entitySortChange()\">\r\n  </igo-entity-table>\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoEntityTableModule, IgoEntityTablePaginatorModule } from '@igo2/common';\r\n\r\nimport { AppEntityTableComponent } from './entity-table.component';\r\nimport { AppEntityTableRoutingModule } from './entity-table-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppEntityTableComponent],\r\n  imports: [\r\n    AppEntityTableRoutingModule,\r\n    MatCardModule,\r\n    IgoEntityTableModule,\r\n    IgoEntityTablePaginatorModule\r\n  ],\r\n  exports: [AppEntityTableComponent]\r\n})\r\nexport class AppEntityTableModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Entity Selector</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/entity-selector\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-entity-selector\r\n    [store]=\"store\"\r\n    [titleAccessor]=\"getTitle\"\r\n    [emptyText]=\"''\"\r\n    [placeholder]=\"'Select an entity'\"\r\n    (selectedChange)=\"onSelectedChange($event)\">\r\n  </igo-entity-selector>\r\n\r\n  <div *ngIf=\"selected$ | async as selected\">\r\n    <p>ID: {{selected.id}}</p>\r\n    <p>Name: {{selected.name}}</p>\r\n    <p>Description: <span [innerHtml]=\"selected.description\"></span></p>\r\n  </div>\r\n</mat-card>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppEntitySelectorComponent } from './entity-selector.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'entity-selector',\r\n    component: AppEntitySelectorComponent\r\n  }\r\n];\r\n\r\nexport const AppEntitySelectorRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit, OnDestroy } from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { EntityStore } from '@igo2/common';\r\n\r\ninterface DemoEntity {\r\n  id: string;\r\n  name: string;\r\n  description: string;\r\n}\r\n\r\n@Component({\r\n  selector: 'app-entity-selector',\r\n  templateUrl: './entity-selector.component.html',\r\n  styleUrls: ['./entity-selector.component.scss']\r\n})\r\nexport class AppEntitySelectorComponent implements OnInit, OnDestroy {\r\n\r\n  public store = new EntityStore([]);\r\n\r\n  public selected$ = new BehaviorSubject<DemoEntity>(undefined);\r\n\r\n  constructor(private languageService: LanguageService) {}\r\n\r\n  ngOnInit() {\r\n    this.store.load([\r\n      {id: '2', name: 'Name 2', description: '<b>Description 2</b>'},\r\n      {id: '1', name: 'Name 1', description: '<b>Description 1</b>'},\r\n      {id: '3', name: 'Name 3', description: '<b>Description 3</b>'}\r\n    ]);\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.store.destroy();\r\n  }\r\n\r\n  getTitle(entity: DemoEntity): string {\r\n    return entity.name;\r\n  }\r\n\r\n  onSelectedChange(event: {selected: boolean; entity: DemoEntity}) {\r\n    this.selected$.next(event.entity);\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoEntitySelectorModule } from '@igo2/common';\r\n\r\nimport { AppEntitySelectorComponent } from './entity-selector.component';\r\nimport { AppEntitySelectorRoutingModule } from './entity-selector-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppEntitySelectorComponent],\r\n  imports: [\r\n    CommonModule,\r\n    AppEntitySelectorRoutingModule,\r\n    MatCardModule,\r\n    IgoEntitySelectorModule\r\n  ],\r\n  exports: [AppEntitySelectorComponent]\r\n})\r\nexport class AppEntitySelectorModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Form</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/form\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-form\r\n    *ngIf=\"form$ | async as form\"\r\n    [form]=\"form\"\r\n    [formData]=\"data$ | async\"\r\n    (submitForm)=\"onSubmit($event)\">\r\n\r\n    <igo-form-group [group]=\"form.groups[0]\"></igo-form-group>\r\n\r\n    <div formButtons>\r\n      <button\r\n        mat-stroked-button\r\n        type=\"button\"\r\n        color=\"primary\"\r\n        (click)=\"fillForm()\">\r\n        Fill Form\r\n      </button>\r\n      <button\r\n        mat-stroked-button\r\n        type=\"button\"\r\n        color=\"primary\"\r\n        (click)=\"clearForm()\">\r\n        Clear Form\r\n      </button>\r\n      <button\r\n        mat-flat-button\r\n        type=\"submit\"\r\n        color=\"primary\"\r\n        [disabled]=\"submitDisabled\">\r\n        Submit\r\n      </button>\r\n    </div>\r\n  </igo-form>\r\n</mat-card>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppFormComponent } from './form.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'form',\r\n    component: AppFormComponent\r\n  }\r\n];\r\n\r\nexport const AppFormRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit, OnDestroy } from '@angular/core';\r\nimport { Validators } from '@angular/forms';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { Form, FormService } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'app-form',\r\n  templateUrl: './form.component.html',\r\n  styleUrls: ['./form.component.scss']\r\n})\r\nexport class AppFormComponent implements OnInit, OnDestroy {\r\n\r\n  form$ = new BehaviorSubject<Form>(undefined);\r\n\r\n  data$ = new BehaviorSubject<{[key: string]: any}>(undefined);\r\n\r\n  submitDisabled = true;\r\n\r\n  private valueChanges$$: Subscription;\r\n\r\n  constructor(\r\n    private formService: FormService,\r\n    private languageService: LanguageService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    const fieldConfigs = [\r\n      {\r\n        name: 'id',\r\n        title: 'ID',\r\n        options: {\r\n          cols: 1,\r\n          validator: Validators.required\r\n        }\r\n      },\r\n      {\r\n        name: 'name',\r\n        title: 'Name',\r\n        options: {\r\n          cols: 1,\r\n          validator: Validators.required\r\n        }\r\n      },\r\n      {\r\n        name: 'status',\r\n        title: 'Status',\r\n        type: 'select',\r\n        options: {\r\n          cols: 2\r\n        },\r\n        inputs: {\r\n          choices: [\r\n            {value: 1, title: 'Single'},\r\n            {value: 2, title: 'Married'}\r\n          ]\r\n        }\r\n      }\r\n    ];\r\n\r\n    const fields = fieldConfigs.map((config) => this.formService.field(config));\r\n    const form = this.formService.form([], [this.formService.group({name: 'info'}, fields)]);\r\n\r\n    this.valueChanges$$ = form.control.valueChanges.subscribe(() => {\r\n      this.submitDisabled = !form.control.valid;\r\n    });\r\n\r\n    this.form$.next(form);\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.valueChanges$$.unsubscribe();\r\n  }\r\n\r\n  fillForm() {\r\n    this.data$.next({\r\n      id: 1,\r\n      name: 'Bob',\r\n      status: 2\r\n    });\r\n  }\r\n\r\n  clearForm() {\r\n    this.form$.value.control.reset();\r\n  }\r\n\r\n  onSubmit(data: {[key: string]: any}) {\r\n    alert(JSON.stringify(data));\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoFormModule } from '@igo2/common';\r\n\r\nimport { AppFormComponent } from './form.component';\r\nimport { AppFormRoutingModule } from './form-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppFormComponent],\r\n  imports: [\r\n    CommonModule,\r\n    AppFormRoutingModule,\r\n    MatButtonModule,\r\n    MatCardModule,\r\n    IgoFormModule\r\n  ],\r\n  exports: [AppFormComponent]\r\n})\r\nexport class AppFormModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppTableComponent } from './table.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'table',\r\n    component: AppTableComponent\r\n  }\r\n];\r\n\r\nexport const AppTableRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { TableDatabase, TableActionColor } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'app-table',\r\n  templateUrl: './table.component.html',\r\n  styleUrls: ['./table.component.scss']\r\n})\r\nexport class AppTableComponent implements OnInit {\r\n  public database: TableDatabase;\r\n\r\n  public model = {\r\n    columns: [\r\n      {\r\n        name: 'id',\r\n        title: 'ID',\r\n        sortable: false,\r\n        filterable: true\r\n      },\r\n      {\r\n        name: 'name',\r\n        title: 'Name',\r\n        sortable: true,\r\n        filterable: true\r\n      },\r\n      {\r\n        name: 'description',\r\n        title: 'Description',\r\n        sortable: true,\r\n        filterable: true\r\n      }\r\n    ],\r\n    actions: [\r\n      {\r\n        icon: 'file-document',\r\n        color: TableActionColor.primary,\r\n        click: row => this.showName(row.name)\r\n      }\r\n    ],\r\n    selectionCheckbox: true\r\n  };\r\n\r\n  constructor(private languageService: LanguageService) {}\r\n\r\n  ngOnInit() {\r\n    this.database = new TableDatabase([\r\n      { id: '2', name: 'Name 2', description: 'Hello 2' },\r\n      { id: '1', name: 'Name 1', description: 'Bonjour 1' },\r\n      { id: '3', name: 'Name 3', description: 'Hola 3' }\r\n    ]);\r\n  }\r\n\r\n  showName(name) {\r\n    alert(name);\r\n  }\r\n\r\n  handleSelect(rows) {\r\n    console.log(rows);\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Table</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/table\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-table\r\n    [database]=\"database\"\r\n    [model]=\"model\"\r\n    [hasFilterInput]=\"true\"\r\n    (select)=\"handleSelect($event)\">\r\n  </igo-table>\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoTableModule } from '@igo2/common';\r\n\r\nimport { AppTableComponent } from './table.component';\r\nimport { AppTableRoutingModule } from './table-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppTableComponent],\r\n  imports: [\r\n    AppTableRoutingModule,\r\n    MatCardModule,\r\n    IgoTableModule\r\n  ],\r\n  exports: [AppTableComponent]\r\n})\r\nexport class AppTableModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Tool</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/tool\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-panel [title]=\"panelTitle\">\r\n    <button\r\n      mat-icon-button\r\n      panelLeftButton\r\n      (click)=\"toolbox.activatePreviousTool()\"\r\n      *ngIf=\"activeTool$ | async\">\r\n      <mat-icon svgIcon=\"arrow-back\"></mat-icon>\r\n    </button>\r\n\r\n    <button\r\n      mat-icon-button\r\n      panelRightButton\r\n      (click)=\"toolbox.deactivateTool()\"\r\n      *ngIf=\"activeTool$ | async\">\r\n      <mat-icon svgIcon=\"menu\"></mat-icon>\r\n    </button>\r\n\r\n    <igo-toolbox [toolbox]=\"toolbox\" [animate]=\"true\"></igo-toolbox>\r\n  </igo-panel>\r\n\r\n  <button\r\n    mat-flat-button\r\n    type=\"button\"\r\n    color=\"primary\"\r\n    (click)=\"activateSalutationTool()\">\r\n    Activate Salutation Tool\r\n  </button>\r\n\r\n</mat-card>\r\n","import {\r\n  Component,\r\n  OnInit,\r\n  OnDestroy,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  OnUpdateInputs,\r\n  Tool,\r\n  Toolbox,\r\n  ToolComponent,\r\n  ToolService\r\n} from '@igo2/common';\r\n\r\n@ToolComponent({\r\n  name: 'demo-salutation',\r\n  title: 'Salutation',\r\n  icon: 'account',\r\n  options: {name: 'Jack'}\r\n})\r\n@Component({\r\n  selector: 'app-salutation-tool',\r\n  template: `\r\n    <p>Hello, my name is {{name}}.</p>\r\n  `,\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AppSalutationToolComponent implements OnUpdateInputs {\r\n\r\n  @Input() name: string;\r\n\r\n  constructor(private cdRef: ChangeDetectorRef) {}\r\n\r\n  onUpdateInputs() {\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n}\r\n\r\n@ToolComponent({\r\n  name: 'demo-about',\r\n  title: 'About',\r\n  icon: 'information'\r\n})\r\n@Component({\r\n  selector: 'app-about-tool',\r\n  template: `\r\n    <p>I'm a tool inside a toolbox.</p>\r\n  `,\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AppAboutToolComponent {}\r\n\r\n@Component({\r\n  selector: 'app-tool',\r\n  templateUrl: './tool.component.html',\r\n  styleUrls: ['./tool.component.scss']\r\n})\r\nexport class AppToolComponent implements OnInit, OnDestroy {\r\n\r\n  toolbox = new Toolbox();\r\n\r\n  get activeTool$(): BehaviorSubject<Tool> {\r\n    return this.toolbox.activeTool$;\r\n  }\r\n\r\n  get panelTitle(): string {\r\n    return this.activeTool$.value ? this.activeTool$.value.title : 'Toolbox';\r\n  }\r\n\r\n  constructor(\r\n    private toolService: ToolService,\r\n    private languageService: LanguageService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.toolbox.setToolbar(['demo-salutation', 'demo-about']);\r\n    this.toolbox.setTools(this.toolService.getTools());\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.toolbox.destroy();\r\n  }\r\n\r\n  activateSalutationTool() {\r\n    this.toolbox.activateTool('demo-salutation', {name: 'Bob'});\r\n  }\r\n\r\n}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppToolComponent } from './tool.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'tool',\r\n    component: AppToolComponent\r\n  }\r\n];\r\n\r\nexport const AppToolRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoPanelModule, IgoToolModule } from '@igo2/common';\r\n\r\nimport {\r\n  AppToolComponent,\r\n  AppSalutationToolComponent,\r\n  AppAboutToolComponent\r\n} from './tool.component';\r\nimport { AppToolRoutingModule } from './tool-routing.module';\r\n\r\n@NgModule({\r\n    declarations: [\r\n        AppToolComponent,\r\n        AppSalutationToolComponent,\r\n        AppAboutToolComponent\r\n    ],\r\n    imports: [\r\n        CommonModule,\r\n        AppToolRoutingModule,\r\n        MatButtonModule,\r\n        MatIconModule,\r\n        MatCardModule,\r\n        IgoLanguageModule,\r\n        IgoPanelModule,\r\n        IgoToolModule.forRoot()\r\n    ],\r\n    exports: [AppToolComponent]\r\n})\r\nexport class AppToolModule {}\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\n\r\nimport { DynamicComponent, OnUpdateInputs, WidgetComponent, WidgetService } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'app-salutation-widget',\r\n  template: `\r\n    <p>Hello, my name is {{name}}.</p>\r\n    <button mat-flat-button (click)=\"complete.emit(name)\">Nice to meet you</button>\r\n    <button mat-flat-button (click)=\"cancel.emit(name)\">Dismiss</button>\r\n  `,\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AppSalutationWidgetComponent implements OnUpdateInputs, WidgetComponent {\r\n\r\n  @Input() name: string;\r\n\r\n  @Output() complete = new EventEmitter<string>();\r\n\r\n  @Output() cancel = new EventEmitter<string>();\r\n\r\n  constructor(private cdRef: ChangeDetectorRef) {}\r\n\r\n  onUpdateInputs() {\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n}\r\n\r\n@Component({\r\n  selector: 'app-widget',\r\n  templateUrl: './widget.component.html',\r\n  styleUrls: ['./widget.component.scss']\r\n})\r\nexport class AppWidgetComponent {\r\n\r\n  widget: DynamicComponent<WidgetComponent> = this.widgetService.create(AppSalutationWidgetComponent);\r\n\r\n  inputs = {name: 'Bob'};\r\n\r\n  constructor(private widgetService: WidgetService) {}\r\n\r\n  onWidgetComplete(name: string) {\r\n    alert(`${name} emitted event 'complete' then got automatically destroyed.`);\r\n  }\r\n\r\n  onWidgetCancel() {\r\n    alert(`Widget emitted event 'cancel' then got automatically destroyed.`);\r\n  }\r\n\r\n}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppWidgetComponent } from './widget.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'widget',\r\n    component: AppWidgetComponent\r\n  }\r\n];\r\n\r\nexport const AppWidgetRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","<mat-card>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Widget</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/widget\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-widget-outlet\r\n    [widget]=\"widget\"\r\n    [inputs]=\"inputs\"\r\n    (complete)=\"onWidgetComplete($event)\"\r\n    (cancel)=\"onWidgetCancel()\">\r\n  </igo-widget-outlet>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoWidgetModule } from '@igo2/common';\r\n\r\nimport {\r\n  AppSalutationWidgetComponent,\r\n  AppWidgetComponent\r\n} from './widget.component';\r\nimport { AppWidgetRoutingModule } from './widget-routing.module';\r\n\r\n@NgModule({\r\n    declarations: [\r\n        AppSalutationWidgetComponent,\r\n        AppWidgetComponent\r\n    ],\r\n    imports: [\r\n        AppWidgetRoutingModule,\r\n        MatButtonModule,\r\n        MatCardModule,\r\n        IgoWidgetModule\r\n    ],\r\n    exports: [AppWidgetComponent]\r\n})\r\nexport class AppWidgetModule {}\r\n","import { Injectable, Injector } from '@angular/core';\r\nimport jwtDecode from 'jwt-decode';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { AuthOptions } from './auth.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class TokenService {\r\n  private options: AuthOptions;\r\n\r\n  constructor(private injector: Injector) {}\r\n\r\n  set(token: string) {\r\n    localStorage.setItem(this.tokenKey, token);\r\n  }\r\n\r\n  remove() {\r\n    localStorage.removeItem(this.tokenKey);\r\n  }\r\n\r\n  get(): string {\r\n    return localStorage.getItem(this.tokenKey);\r\n  }\r\n\r\n  decode() {\r\n    const token = this.get();\r\n    if (!token) {\r\n      return;\r\n    }\r\n    return jwtDecode(token);\r\n  }\r\n\r\n  isExpired() {\r\n    const jwt = this.decode();\r\n    const currentTime = new Date().getTime() / 1000;\r\n    if (jwt && currentTime < jwt.exp) {\r\n      return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  private get tokenKey() {\r\n    const config = this.injector.get<ConfigService>(ConfigService);\r\n    this.options = config.getConfig('auth') || {};\r\n    return this.options.tokenKey;\r\n  }\r\n}\r\n","import { Injectable, Optional } from '@angular/core';\r\nimport { HttpClient, HttpHeaders } from '@angular/common/http';\r\nimport { Router } from '@angular/router';\r\n\r\nimport { Observable, BehaviorSubject, of } from 'rxjs';\r\nimport { tap, catchError } from 'rxjs/operators';\r\nimport { globalCacheBusterNotifier } from 'ts-cacheable';\r\n\r\nimport { ConfigService, LanguageService, MessageService } from '@igo2/core';\r\nimport { Base64 } from '@igo2/utils';\r\n\r\nimport { User, IInfosUser } from './auth.interface';\r\nimport { TokenService } from './token.service';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class AuthService {\r\n  public authenticate$ = new BehaviorSubject<boolean>(undefined);\r\n  public logged$ = new BehaviorSubject<boolean>(undefined);\r\n  public redirectUrl: string;\r\n  private anonymous = false;\r\n\r\n  get hasAuthService() {\r\n    return this.config.getConfig('auth.url') !== undefined;\r\n  }\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private tokenService: TokenService,\r\n    private config: ConfigService,\r\n    private languageService: LanguageService,\r\n    private messageService: MessageService,\r\n    @Optional() private router: Router\r\n  ) {\r\n    this.authenticate$.next(this.authenticated);\r\n    this.authenticate$.subscribe((authenticated) => {\r\n      this.logged$.next(authenticated);\r\n      globalCacheBusterNotifier.next();\r\n    });\r\n  }\r\n\r\n  login(username: string, password: string): Observable<void> {\r\n    const myHeader = new HttpHeaders({ 'Content-Type': 'application/json' });\r\n\r\n    const body = {\r\n      username,\r\n      password: this.encodePassword(password)\r\n    };\r\n\r\n    return this.loginCall(body, myHeader);\r\n  }\r\n\r\n  loginWithToken(token: string, type: string, infosUser?: IInfosUser): Observable<void> {\r\n    const myHeader = new HttpHeaders({ 'Content-Type': 'application/json' });\r\n\r\n    const body = {\r\n      token,\r\n      typeConnection: type,\r\n      infosUser\r\n    };\r\n\r\n    return this.loginCall(body, myHeader);\r\n  }\r\n\r\n  loginAnonymous(): Observable<boolean> {\r\n    this.anonymous = true;\r\n    this.logged$.next(true);\r\n    return of(true);\r\n  }\r\n\r\n  refresh(): Observable<void> {\r\n    const url = this.config.getConfig('auth.url');\r\n    return this.http.post(`${url}/refresh`, {}).pipe(\r\n      tap((data: any) => {\r\n        this.tokenService.set(data.token);\r\n      }),\r\n      catchError((err) => {\r\n        err.error.caught = true;\r\n        throw err;\r\n      })\r\n    );\r\n  }\r\n\r\n  logout(): Observable<boolean> {\r\n    this.anonymous = false;\r\n    this.tokenService.remove();\r\n    this.authenticate$.next(false);\r\n    return of(true);\r\n  }\r\n\r\n  isAuthenticated(): boolean {\r\n    return !this.tokenService.isExpired();\r\n  }\r\n\r\n  getToken(): string {\r\n    return this.tokenService.get();\r\n  }\r\n\r\n  decodeToken() {\r\n    if (this.isAuthenticated()) {\r\n      return this.tokenService.decode();\r\n    }\r\n    return false;\r\n  }\r\n\r\n  goToRedirectUrl() {\r\n    if (!this.router) {\r\n      return;\r\n    }\r\n    const redirectUrl = this.redirectUrl || this.router.url;\r\n\r\n    const options = this.config.getConfig('auth') || {};\r\n    if (redirectUrl === options.loginRoute) {\r\n      const homeRoute = options.homeRoute || '/';\r\n      this.router.navigateByUrl(homeRoute);\r\n    } else if (redirectUrl) {\r\n      this.router.navigateByUrl(redirectUrl);\r\n    }\r\n  }\r\n\r\n  getUserInfo(): Observable<User> {\r\n    const url = this.config.getConfig('auth.url') + '/info';\r\n    return this.http.get<User>(url);\r\n  }\r\n\r\n  getProfils(): Observable<{ profils: string[] }> {\r\n    const url = this.config.getConfig('auth.url');\r\n    return this.http.get<{ profils: string[] }>(`${url}/profils`);\r\n  }\r\n\r\n  updateUser(user: User): Observable<User> {\r\n    const url = this.config.getConfig('auth.url');\r\n    return this.http.patch<User>(url, user);\r\n  }\r\n\r\n  private encodePassword(password: string) {\r\n    return Base64.encode(password);\r\n  }\r\n\r\n  // authenticated or anonymous\r\n  get logged(): boolean {\r\n    return this.authenticated || this.isAnonymous;\r\n  }\r\n\r\n  get isAnonymous(): boolean {\r\n    return this.anonymous;\r\n  }\r\n\r\n  get authenticated(): boolean {\r\n    return this.isAuthenticated();\r\n  }\r\n\r\n  get isAdmin(): boolean {\r\n    const token = this.decodeToken();\r\n    if (token && token.user && token.user.isAdmin) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  private loginCall(body, headers) {\r\n    const url = this.config.getConfig('auth.url');\r\n    return this.http.post(`${url}/login`, body, { headers }).pipe(\r\n      tap((data: any) => {\r\n        this.tokenService.set(data.token);\r\n        const tokenDecoded = this.decodeToken();\r\n        if (tokenDecoded && tokenDecoded.user) {\r\n          if (tokenDecoded.user.locale) {\r\n            this.languageService.setLanguage(tokenDecoded.user.locale);\r\n          }\r\n          if (tokenDecoded.user.isExpired) {\r\n            this.languageService.translate\r\n              .get('igo.auth.error.Password expired')\r\n              .subscribe((expiredAlert) =>\r\n                this.messageService.alert(expiredAlert)\r\n              );\r\n          }\r\n        }\r\n        this.authenticate$.next(true);\r\n      }),\r\n      catchError((err) => {\r\n        err.error.caught = true;\r\n        throw err;\r\n      })\r\n    );\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  ChangeDetectionStrategy,\r\n  ApplicationRef,\r\n  Output,\r\n  EventEmitter\r\n} from '@angular/core';\r\n\r\nimport { ConfigService, LanguageService } from '@igo2/core';\r\nimport { AuthGoogleOptions } from '../shared/auth.interface';\r\nimport { AuthService } from '../shared/auth.service';\r\n\r\n@Component({\r\n  selector: 'igo-auth-google',\r\n  templateUrl: './auth-google.component.html',\r\n  styleUrls: ['./auth-google.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AuthGoogleComponent {\r\n  private options: AuthGoogleOptions;\r\n\r\n  @Output() login: EventEmitter<boolean> = new EventEmitter<boolean>();\r\n\r\n  constructor(\r\n    private authService: AuthService,\r\n    private config: ConfigService,\r\n    private languageService: LanguageService,\r\n    private appRef: ApplicationRef\r\n  ) {\r\n    this.options = this.config.getConfig('auth.google') || {};\r\n\r\n    if (this.options.apiKey && this.options.clientId) {\r\n      this.loadSDKGoogle();\r\n      this.loadPlatform();\r\n    } else {\r\n      console.warn('Google authentification needs \"apiKey\" and \"clientId\" options');\r\n    }\r\n  }\r\n\r\n  public handleSignInClick() {\r\n    (window as any).gapi.auth2.getAuthInstance().signIn();\r\n  }\r\n\r\n  public handleSignOutClick() {\r\n    (window as any).gapi.auth2.getAuthInstance().signOut();\r\n  }\r\n\r\n  private handleClientLoad() {\r\n    (window as any).gapi.load('client:auth2', () => this.initClient());\r\n  }\r\n\r\n  private initClient() {\r\n    (window as any).gapi.client\r\n      .init({\r\n        apiKey: this.options.apiKey,\r\n        clientId: this.options.clientId,\r\n        discoveryDocs: [\r\n          'https://people.googleapis.com/$discovery/rest?version=v1'\r\n        ],\r\n        scope: 'profile'\r\n      })\r\n      .then(() => {\r\n        this.handleSignOutClick();\r\n        this.updateTextButton();\r\n        (window as any).gapi.auth2.getAuthInstance().isSignedIn.listen(rep => {\r\n          this.updateSigninStatus(rep);\r\n        });\r\n      });\r\n  }\r\n\r\n  private updateSigninStatus(isSignedIn) {\r\n    this.updateTextButton();\r\n    if (isSignedIn) {\r\n      this.loginGoogle((window as any).gapi.client.getToken().access_token);\r\n    }\r\n  }\r\n\r\n  private updateTextButton() {\r\n    const btn = document.querySelector('span[id^=\"not_signed_\"]');\r\n    if (btn && this.languageService.getLanguage() !== 'en') {\r\n      if (btn.innerHTML === 'Sign in with Google') {\r\n        btn.innerHTML = this.languageService.translate.instant('igo.auth.google.login');\r\n      } else if (btn.innerHTML === 'Signed in with Google') {\r\n        btn.innerHTML = this.languageService.translate.instant('igo.auth.google.logged');\r\n      }\r\n    }\r\n  }\r\n\r\n  private loginGoogle(token) {\r\n    this.authService.loginWithToken(token, 'google').subscribe(() => {\r\n      this.appRef.tick();\r\n      this.login.emit(true);\r\n    });\r\n  }\r\n\r\n  private loadSDKGoogle() {\r\n    const fjs = document.getElementsByTagName('script')[0];\r\n    const js = document.createElement('script');\r\n    js.id = 'google-jssdk';\r\n    js.src = 'https://apis.google.com/js/api.js';\r\n    js.onload = () => {\r\n      this.handleClientLoad();\r\n    };\r\n    fjs.parentNode.insertBefore(js, fjs);\r\n  }\r\n\r\n  private loadPlatform() {\r\n    const fjs = document.getElementsByTagName('script')[0];\r\n    const js = document.createElement('script');\r\n    js.id = 'google-platform';\r\n    js.src = 'https://apis.google.com/js/platform.js';\r\n    fjs.parentNode.insertBefore(js, fjs);\r\n  }\r\n}\r\n","<div class=\"g-signin2 google-login-button\" data-height=\"40\" data-width=\"265\" data-longtitle=\"true\">\r\n","<form [formGroup]=\"form\" role=\"form\" (ngSubmit)=\"loginUser(form.value)\">\r\n  <div>\r\n    <mat-form-field class=\"full-width\">\r\n      <input matInput required placeholder=\"{{'igo.auth.user' | translate}}\" formControlName=\"username\">\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div>\r\n    <mat-form-field class=\"full-width\">\r\n      <input matInput required type=\"password\" placeholder=\"{{'igo.auth.password' | translate}}\" formControlName=\"password\">\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <button mat-raised-button type=\"submit\">{{'igo.auth.login' | translate}}</button>\r\n  <button *ngIf=\"allowAnonymous\" mat-raised-button class=\"anonymous\" type=\"button\" [disabled]=\"loading\" (click)=\"loginAnonymous()\">\r\n    {{'igo.auth.accessAnonymous' | translate }}\r\n  </button>\r\n  <div *ngIf=\"error\">\r\n    <br/>\r\n    <font size=\"3\" color=\"red\">{{error}}</font>\r\n  </div>\r\n</form>\r\n\r\n<!--\r\nThis part was removed from the below line to fix Angular issue 30616 : [disabled]=\"!form.valid || loading\r\n  <button mat-raised-button type=\"submit\" [disabled]=\"!form.valid || loading\">{{'igo.auth.login' | translate}}</button>*/\r\n-->\r\n","import {\r\n  Component,\r\n  ChangeDetectionStrategy,\r\n  Input,\r\n  Output,\r\n  EventEmitter\r\n} from '@angular/core';\r\nimport { Validators, UntypedFormGroup, UntypedFormBuilder } from '@angular/forms';\r\n\r\nimport { AuthService } from '../shared/auth.service';\r\nimport { LanguageService } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'igo-auth-intern',\r\n  templateUrl: './auth-intern.component.html',\r\n  styleUrls: ['./auth-intern.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.Default\r\n})\r\nexport class AuthInternComponent {\r\n  @Input()\r\n  get allowAnonymous(): boolean {\r\n    return this._allowAnonymous;\r\n  }\r\n  set allowAnonymous(value: boolean) {\r\n    this._allowAnonymous = value;\r\n  }\r\n  private _allowAnonymous = true;\r\n\r\n  public error = '';\r\n  public form: UntypedFormGroup;\r\n  public loading = false;\r\n\r\n  @Output() login: EventEmitter<boolean> = new EventEmitter<boolean>();\r\n\r\n  constructor(\r\n    public auth: AuthService,\r\n    private languageService: LanguageService,\r\n    fb: UntypedFormBuilder\r\n  ) {\r\n    this.form = fb.group({\r\n      username: ['', Validators.required],\r\n      password: ['', Validators.required]\r\n    });\r\n  }\r\n\r\n  loginUser(values: any) {\r\n    this.loading = true;\r\n    this.auth.login(values.username, values.password).subscribe(\r\n      () => {\r\n        this.login.emit(true);\r\n        this.loading = false;\r\n      },\r\n      (error: any) => {\r\n        try {\r\n          this.languageService.translate\r\n            .get('igo.auth.error.' + error.error.message)\r\n            .subscribe(errorMsg => (this.error = errorMsg));\r\n        } catch (e) {\r\n          this.error = error.error.message;\r\n        }\r\n        this.loading = false;\r\n      }\r\n    );\r\n    return false;\r\n  }\r\n\r\n  loginAnonymous() {\r\n    this.auth.loginAnonymous().subscribe(() => {\r\n      this.login.emit(true);\r\n    });\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  ChangeDetectionStrategy,\r\n  ApplicationRef,\r\n  Output,\r\n  EventEmitter\r\n} from '@angular/core';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { AuthFacebookOptions } from '../shared/auth.interface';\r\nimport { AuthService } from '../shared/auth.service';\r\n\r\n@Component({\r\n  selector: 'igo-auth-facebook',\r\n  templateUrl: './auth-facebook.component.html',\r\n  styleUrls: ['./auth-facebook.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AuthFacebookComponent {\r\n  private options: AuthFacebookOptions;\r\n\r\n  @Output() login: EventEmitter<boolean> = new EventEmitter<boolean>();\r\n\r\n  constructor(\r\n    private authService: AuthService,\r\n    private config: ConfigService,\r\n    private appRef: ApplicationRef\r\n  ) {\r\n    this.options = this.config.getConfig('auth.facebook') || {};\r\n\r\n    if (this.options.appId) {\r\n      this.loadSDKFacebook();\r\n    } else {\r\n      console.warn('Facebook authentification needs \"appId\" option');\r\n    }\r\n  }\r\n\r\n  private subscribeEvents() {\r\n    (window as any).FB.Event.subscribe('auth.statusChange', rep => {\r\n      this.statusChangeCallback(rep);\r\n    });\r\n  }\r\n\r\n  private statusChangeCallback(response) {\r\n    if (response.status === 'connected') {\r\n      const accessToken = response.authResponse.accessToken;\r\n      this.loginFacebook(accessToken);\r\n    }\r\n  }\r\n\r\n  private loginFacebook(token) {\r\n    this.authService.loginWithToken(token, 'facebook').subscribe(() => {\r\n      this.appRef.tick();\r\n      this.login.emit(true);\r\n    });\r\n  }\r\n\r\n  private loadSDKFacebook() {\r\n    if (document.getElementById('facebook-jssdk')) {\r\n      return;\r\n    }\r\n\r\n    const urlSDK =\r\n      'https://connect.facebook.net/fr_CA/sdk.js#xfbml=1&version=v2.9';\r\n\r\n    const fjs = document.getElementsByTagName('script')[0];\r\n    const js = document.createElement('script');\r\n    js.id = 'facebook-jssdk';\r\n    js.src = `${urlSDK}&appId=${this.options.appId}`;\r\n    js.onload = () => {\r\n      this.subscribeEvents();\r\n    };\r\n    fjs.parentNode.insertBefore(js, fjs);\r\n  }\r\n}\r\n","<div scope=\"public_profile,email\"\r\n     class=\"fb-login-button\" data-max-rows=\"1\" data-size=\"large\"\r\n     data-button-type=\"login_with\" data-show-faces=\"false\"\r\n     data-auto-logout-link=\"false\" data-use-continue-as=\"false\">\r\n</div>\r\n","import {\r\n  Component,\r\n  ChangeDetectionStrategy,\r\n  ApplicationRef,\r\n  Output,\r\n  EventEmitter,\r\n  Inject\r\n} from '@angular/core';\r\nimport { MsalBroadcastService, MsalService, MSAL_GUARD_CONFIG} from '@azure/msal-angular';\r\nimport {\r\n  InteractionStatus,\r\n  AuthenticationResult,\r\n  PublicClientApplication,\r\n  PopupRequest,\r\n  SilentRequest,\r\n  InteractionRequiredAuthError\r\n} from '@azure/msal-browser';\r\nimport { ConfigService } from '@igo2/core';\r\nimport { AuthMicrosoftOptions, MSPMsalGuardConfiguration } from '../shared/auth.interface';\r\nimport { AuthService } from '../shared/auth.service';\r\nimport { filter, takeUntil } from 'rxjs/operators';\r\nimport { Subject } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'igo-auth-microsoft',\r\n  templateUrl: './auth-microsoft.component.html',\r\n  styleUrls: ['./auth-microsoft.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AuthMicrosoftComponent {\r\n  private options: AuthMicrosoftOptions;\r\n  private readonly _destroying$ = new Subject<void>();\r\n  @Output() login: EventEmitter<boolean> = new EventEmitter<boolean>();\r\n  private broadcastService: MsalBroadcastService;\r\n\r\n  constructor(\r\n    private authService: AuthService,\r\n    private config: ConfigService,\r\n    private appRef: ApplicationRef,\r\n    private msalService: MsalService,\r\n    @Inject(MSAL_GUARD_CONFIG) private msalGuardConfig: MSPMsalGuardConfiguration[],\r\n  ) {\r\n    this.options = this.config.getConfig('auth.microsoft') || {};\r\n\r\n    this.msalService.instance = new PublicClientApplication({\r\n      auth: this.options,\r\n      cache: {\r\n        cacheLocation: 'sessionStorage'\r\n      }\r\n    });\r\n\r\n    this.broadcastService = new MsalBroadcastService(this.msalService.instance, this.msalService);\r\n\r\n    if (this.options.clientId) {\r\n      this.broadcastService.inProgress$\r\n      .pipe(\r\n        filter((status: InteractionStatus) => status === InteractionStatus.None),\r\n        takeUntil(this._destroying$)\r\n      )\r\n      .subscribe(() => {\r\n        this.checkAccount();\r\n      });\r\n\r\n    } else {\r\n      console.warn('Microsoft authentification needs \"clientId\" option');\r\n    }\r\n  }\r\n\r\n  public loginMicrosoft() {\r\n    this.msalService.loginPopup({...this.getConf().authRequest} as PopupRequest)\r\n    .subscribe((response: AuthenticationResult) => {\r\n      this.msalService.instance.setActiveAccount(response.account);\r\n      this.checkAccount();\r\n    });\r\n  }\r\n\r\n  private checkAccount() {\r\n    this.msalService.instance\r\n      .acquireTokenSilent(this.getConf().authRequest as SilentRequest)\r\n      .then((response: AuthenticationResult) => {\r\n        const tokenAccess = response.accessToken;\r\n        const tokenId = response.idToken;\r\n        this.authService.loginWithToken(tokenAccess, 'microsoft', { tokenId } ).subscribe(() => {\r\n          this.appRef.tick();\r\n          this.login.emit(true);\r\n        });\r\n      })\r\n      .catch(async (error) => {\r\n        if (error instanceof InteractionRequiredAuthError) {\r\n          // fallback to interaction when silent call fails\r\n          return this.msalService.acquireTokenPopup(this.getConf().authRequest as SilentRequest);\r\n        }\r\n        console.log(error);\r\n      }).catch(error => {\r\n        console.log('Silent token fails');\r\n      });\r\n  }\r\n\r\n  private getConf(): MSPMsalGuardConfiguration {\r\n    return this.msalGuardConfig.filter(conf => conf.type === 'add')[0];\r\n  }\r\n}\r\n","<button class=\"microsoft-login-button\" mat-raised-button (click)=\"loginMicrosoft()\">\r\n  <mat-icon svgIcon=\"microsoft\"></mat-icon>\r\n  {{'igo.auth.microsoft.login' | translate}}\r\n</button>\r\n","/*\r\n * Copyright (c) Microsoft Corporation. All rights reserved.\r\n * Licensed under the MIT License.\r\n */\r\n\r\nimport { Inject, Injectable } from '@angular/core';\r\nimport { Location } from '@angular/common';\r\nimport {\r\n    IPublicClientApplication,\r\n    EndSessionRequest,\r\n    EndSessionPopupRequest,\r\n    AuthenticationResult,\r\n    RedirectRequest,\r\n    SilentRequest,\r\n    PopupRequest,\r\n    SsoSilentRequest,\r\n    Logger,\r\n    WrapperSKU\r\n} from '@azure/msal-browser';\r\nimport { MSAL_INSTANCE } from '@azure/msal-angular';\r\nimport { Observable, from } from 'rxjs';\r\nimport { IMsalService } from '@azure/msal-angular';\r\n\r\n@Injectable()\r\nexport class MsalServiceb2c implements IMsalService {\r\n    private redirectHash: string;\r\n    private logger: Logger;\r\n    private name = '@azure/msal-angular';\r\n    private version = '2.0.0-beta.2';\r\n    constructor(\r\n        @Inject(MSAL_INSTANCE) public instance: IPublicClientApplication,\r\n        private location: Location\r\n    ) {\r\n        const hash = this.location.path(true).split('#').pop();\r\n        if (hash) {\r\n            this.redirectHash = `#${hash}`;\r\n        }\r\n        this.instance.initializeWrapperLibrary(WrapperSKU.Angular, this.version);\r\n    }\r\n\r\n    initialize(): Observable<void> {\r\n        return from(this.instance.initialize());\r\n    }\r\n\r\n    acquireTokenPopup(request: PopupRequest): Observable<AuthenticationResult> {\r\n        return from(this.instance.acquireTokenPopup(request));\r\n    }\r\n    acquireTokenRedirect(request: RedirectRequest): Observable<void> {\r\n        return from(this.instance.acquireTokenRedirect(request));\r\n    }\r\n    acquireTokenSilent(silentRequest: SilentRequest): Observable<AuthenticationResult> {\r\n        return from(this.instance.acquireTokenSilent(silentRequest));\r\n    }\r\n    handleRedirectObservable(hash?: string): Observable<AuthenticationResult> {\r\n        return from(this.instance.handleRedirectPromise(hash || this.redirectHash));\r\n    }\r\n    loginPopup(request?: PopupRequest): Observable<AuthenticationResult> {\r\n        return from(this.instance.loginPopup(request));\r\n    }\r\n    loginRedirect(request?: RedirectRequest): Observable<void> {\r\n        return from(this.instance.loginRedirect(request));\r\n    }\r\n    logout(logoutRequest?: EndSessionRequest): Observable<void> {\r\n        return from(this.instance.logout(logoutRequest));\r\n    }\r\n    logoutRedirect(logoutRequest?: EndSessionRequest): Observable<void> {\r\n        return from(this.instance.logoutRedirect(logoutRequest));\r\n    }\r\n    logoutPopup(logoutRequest?: EndSessionPopupRequest): Observable<void> {\r\n        return from(this.instance.logoutPopup(logoutRequest));\r\n    }\r\n    ssoSilent(request: SsoSilentRequest): Observable<AuthenticationResult> {\r\n        return from(this.instance.ssoSilent(request));\r\n    }\r\n    /**\r\n     * Gets logger for msal-angular.\r\n     * If no logger set, returns logger instance created with same options as msal-browser\r\n     */\r\n    getLogger(): Logger {\r\n        if (!this.logger) {\r\n            this.logger = this.instance.getLogger().clone(this.name, this.version);\r\n        }\r\n        return this.logger;\r\n    }\r\n    // Create a logger instance for msal-angular with the same options as msal-browser\r\n    setLogger(logger: Logger): void {\r\n        this.logger = logger.clone(this.name, this.version);\r\n        this.instance.setLogger(logger);\r\n    }\r\n\r\n}\r\n","/*\r\n * Copyright (c) Microsoft Corporation. All rights reserved.\r\n * Licensed under the MIT License.\r\n */\r\n\r\nimport { Inject, Injectable } from '@angular/core';\r\nimport { BehaviorSubject, Observable, Subject } from 'rxjs';\r\nimport { MSAL_INSTANCE } from '@azure/msal-angular';\r\nimport { EventMessage, EventMessageUtils, IPublicClientApplication, InteractionStatus } from '@azure/msal-browser';\r\nimport { MsalServiceb2c } from './auth-msalServiceb2c.service.';\r\n\r\n@Injectable()\r\nexport class MsalBroadcastServiceb2c {\r\n    private _msalSubject: Subject<EventMessage>;\r\n    public msalSubject$: Observable<EventMessage>;\r\n    private _inProgress: BehaviorSubject<InteractionStatus>;\r\n    public inProgress$: Observable<InteractionStatus>;\r\n\r\n    constructor(\r\n        @Inject(MSAL_INSTANCE) private msalInstance: IPublicClientApplication,\r\n        private authService: MsalServiceb2c\r\n    ) {\r\n        this._msalSubject = new Subject<EventMessage>();\r\n        this.msalSubject$ = this._msalSubject.asObservable();\r\n\r\n        // InProgress as BehaviorSubject so most recent inProgress state will be available upon subscription\r\n        this._inProgress = new BehaviorSubject<InteractionStatus>(InteractionStatus.Startup);\r\n        this.inProgress$ = this._inProgress.asObservable();\r\n\r\n        this.msalInstance.addEventCallback((message: EventMessage) => {\r\n            this._msalSubject.next(message);\r\n            const status = EventMessageUtils.getInteractionStatusFromEvent(message);\r\n            if (status !== null) {\r\n                this.authService.getLogger().verbose(`BroadcastService - ${message.eventType} results in setting inProgress to ${status}`);\r\n                this._inProgress.next(status);\r\n            }\r\n        });\r\n    }\r\n}\r\n","import {\r\n  Component,\r\n  ChangeDetectionStrategy,\r\n  ApplicationRef,\r\n  Output,\r\n  EventEmitter,\r\n  Inject\r\n} from '@angular/core';\r\n\r\nimport { MSAL_GUARD_CONFIG } from '@azure/msal-angular';\r\nimport {\r\n  InteractionStatus,\r\n  AuthenticationResult,\r\n  PublicClientApplication,\r\n  PopupRequest,\r\n  SilentRequest,\r\n  InteractionRequiredAuthError\r\n} from '@azure/msal-browser';\r\nimport { ConfigService } from '@igo2/core';\r\nimport { AuthMicrosoftb2cOptions, MSPMsalGuardConfiguration } from '../shared/auth.interface';\r\nimport { AuthService } from '../shared/auth.service';\r\nimport { filter, takeUntil } from 'rxjs/operators';\r\nimport { Subject } from 'rxjs';\r\nimport { MsalBroadcastServiceb2c } from '../shared/auth-msalBroadcastServiceb2c.service';\r\nimport { MsalServiceb2c } from '../shared/auth-msalServiceb2c.service.';\r\n\r\n@Component({\r\n  selector: 'igo-auth-microsoftb2c',\r\n  templateUrl: './auth-microsoftb2c.component.html',\r\n  styleUrls: ['./auth-microsoftb2c.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AuthMicrosoftb2cComponent {\r\n  private options: AuthMicrosoftb2cOptions;\r\n  private readonly _destroying$ = new Subject<void>();\r\n  @Output() login: EventEmitter<boolean> = new EventEmitter<boolean>();\r\n  private broadcastService: MsalBroadcastServiceb2c;\r\n\r\n  constructor(\r\n    private authService: AuthService,\r\n    private config: ConfigService,\r\n    private appRef: ApplicationRef,\r\n    private msalService: MsalServiceb2c,\r\n    @Inject(MSAL_GUARD_CONFIG) private msalGuardConfig: MSPMsalGuardConfiguration[],\r\n  ) {\r\n\r\n    this.options = this.config.getConfig('auth.microsoftb2c') || {};\r\n\r\n    this.msalService.instance = new PublicClientApplication({\r\n      auth: this.options.browserAuthOptions,\r\n      cache: {\r\n        cacheLocation: 'sessionStorage'\r\n      }\r\n    });\r\n\r\n    this.broadcastService = new MsalBroadcastServiceb2c(this.msalService.instance, this.msalService);\r\n\r\n    if (this.options.browserAuthOptions.clientId) {\r\n      this.broadcastService.inProgress$\r\n      .pipe(\r\n        filter((status: InteractionStatus) => status === InteractionStatus.None),\r\n        takeUntil(this._destroying$)\r\n      )\r\n      .subscribe(() => {\r\n        this.checkAccount();\r\n      });\r\n\r\n    } else {\r\n      console.warn('Microsoft authentification needs \"clientId\" option');\r\n    }\r\n  }\r\n\r\n  public loginMicrosoftb2c() {\r\n    this.msalService.loginPopup({...this.getConf().authRequest} as PopupRequest)\r\n    .subscribe((response: AuthenticationResult) => {\r\n      this.msalService.instance.setActiveAccount(response.account);\r\n      this.checkAccount();\r\n    });\r\n  }\r\n\r\n  private checkAccount() {\r\n    this.msalService.instance\r\n      .acquireTokenSilent(this.getConf().authRequest as SilentRequest)\r\n      .then((response: AuthenticationResult) => {\r\n        const token = response.idToken;\r\n        this.authService.loginWithToken(token, 'microsoftb2c').subscribe(() => {\r\n          this.appRef.tick();\r\n          this.login.emit(true);\r\n        });\r\n      })\r\n      .catch(async (error) => {\r\n        if (error instanceof InteractionRequiredAuthError) {\r\n          // fallback to interaction when silent call fails\r\n          return this.msalService.acquireTokenPopup(this.getConf().authRequest as SilentRequest);\r\n        }\r\n        }).catch(error => {\r\n          console.log('Silent token fails');\r\n        });\r\n  }\r\n\r\n  private getConf(): MSPMsalGuardConfiguration {\r\n    return this.msalGuardConfig.filter(conf => conf.type === 'b2c')[0];\r\n  }\r\n}\r\n","<button class=\"microsoft-login-button\" mat-raised-button (click)=\"loginMicrosoftb2c()\">\r\n  <mat-icon svgIcon=\"microsoft\"></mat-icon>\r\n  {{'igo.auth.microsoftb2c.login' | translate}}\r\n</button>\r\n","<div *ngIf=\"visible\">\r\n  <div *ngIf=\"!auth.logged && backgroundDisable\" class=\"backgroundDisable\"></div>\r\n\r\n  <div *ngIf=\"!auth.logged && showLoginDiv\" class=\"login center-block\">\r\n    <h1>{{'igo.auth.connection' | translate}}</h1>\r\n\r\n    <igo-auth-google\r\n      *ngIf=\"options.google && options.google.enabled !== false\"\r\n      (login)=\"onLogin()\">\r\n    </igo-auth-google>\r\n    <igo-auth-microsoft\r\n      *ngIf=\"options.microsoft && options.microsoft.enabled !== false\"\r\n      (login)=\"onLogin()\">\r\n    </igo-auth-microsoft>\r\n    <igo-auth-microsoftb2c\r\n      *ngIf=\"options.microsoftb2c && options.microsoftb2c.enabled !== false\"\r\n      (login)=\"onLogin()\">\r\n    </igo-auth-microsoftb2c>\r\n    <igo-auth-facebook\r\n      *ngIf=\"options.facebook && options.facebook.enabled !== false\"\r\n      (login)=\"onLogin()\">\r\n    </igo-auth-facebook>\r\n    <igo-auth-intern\r\n      *ngIf=\"!options.intern || options.intern.enabled !== false\"\r\n      [allowAnonymous]=\"options.allowAnonymous\"\r\n      (login)=\"onLogin()\">\r\n    </igo-auth-intern>\r\n  </div>\r\n\r\n  <div *ngIf=\"auth.logged && showAlreadyConnectedDiv\" class=\"login center-block\">\r\n    <p>{{'igo.auth.welcome' |translate: user}}</p>\r\n    <button mat-raised-button type=\"button\" (click)=\"logout()\">{{'igo.auth.signOut' |translate}}</button>\r\n  </div>\r\n\r\n  <div *ngIf=\"showLogoutDiv\" class=\"login center-block\">\r\n    <p>{{'igo.auth.deconnection' |translate}}</p>\r\n    <button *ngIf=\"options.homeRoute\" mat-raised-button type=\"button\" (click)=\"home()\">{{'igo.auth.home' |translate}}</button>\r\n  </div>\r\n\r\n</div>\r\n","import {\r\n  Component,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  Input,\r\n  Optional,\r\n  Output,\r\n  EventEmitter\r\n} from '@angular/core';\r\nimport { Router, NavigationStart } from '@angular/router';\r\nimport { filter } from 'rxjs/operators';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { AuthOptions } from '../shared/auth.interface';\r\nimport { AuthService } from '../shared/auth.service';\r\n\r\n@Component({\r\n  selector: 'igo-auth-form',\r\n  templateUrl: './auth-form.component.html',\r\n  styleUrls: ['./auth-form.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.Default\r\n})\r\nexport class AuthFormComponent implements OnInit {\r\n  @Input()\r\n  get backgroundDisable(): boolean {\r\n    if (this.isLogoutRoute || this.isLogoutRoute) {\r\n      return false;\r\n    }\r\n    return this._backgroundDisable;\r\n  }\r\n  set backgroundDisable(value: boolean) {\r\n    this._backgroundDisable = value.toString() === 'true';\r\n  }\r\n  private _backgroundDisable = true;\r\n\r\n  @Input()\r\n  get hasAlreadyConnectedDiv(): boolean {\r\n    return this._hasAlreadyConnectedDiv;\r\n  }\r\n  set hasAlreadyConnectedDiv(value: boolean) {\r\n    this._hasAlreadyConnectedDiv = value.toString() === 'true';\r\n  }\r\n  private _hasAlreadyConnectedDiv = true;\r\n\r\n  @Input()\r\n  get hasLogoutDiv(): boolean {\r\n    return this._hasLogoutDiv;\r\n  }\r\n  set hasLogoutDiv(value: boolean) {\r\n    this._hasLogoutDiv = value.toString() === 'true';\r\n  }\r\n  private _hasLogoutDiv = true;\r\n\r\n  @Input()\r\n  get showAlreadyConnectedDiv(): boolean {\r\n    if (this.isLogoutRoute) {\r\n      return this.hasAlreadyConnectedDiv;\r\n    }\r\n    return this._showAlreadyConnectedDiv;\r\n  }\r\n  set showAlreadyConnectedDiv(value: boolean) {\r\n    this._showAlreadyConnectedDiv = value.toString() === 'true';\r\n  }\r\n  private _showAlreadyConnectedDiv = false;\r\n\r\n  @Input()\r\n  get showLogoutDiv(): boolean {\r\n    if (this.isLogoutRoute) {\r\n      return this.hasLogoutDiv;\r\n    }\r\n    return this._showLogoutDiv;\r\n  }\r\n  set showLogoutDiv(value: boolean) {\r\n    this._showLogoutDiv = value.toString() === 'true';\r\n  }\r\n  private _showLogoutDiv = false;\r\n\r\n  get showLoginDiv(): boolean {\r\n    if (!this.isLogoutRoute) {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  @Output() login: EventEmitter<boolean> = new EventEmitter<boolean>();\r\n\r\n  public options: AuthOptions;\r\n  public user;\r\n\r\n  public visible = true;\r\n\r\n  private isLoginRoute: boolean;\r\n  private isLogoutRoute: boolean;\r\n\r\n  constructor(\r\n    public auth: AuthService,\r\n    private config: ConfigService,\r\n    @Optional() private router: Router\r\n  ) {\r\n    this.options = this.config.getConfig('auth') || {};\r\n    this.visible = Object.getOwnPropertyNames(this.options).length !== 0;\r\n  }\r\n\r\n  public ngOnInit() {\r\n    this.analyzeRoute();\r\n    this.getName();\r\n  }\r\n\r\n  public onLogin() {\r\n    this.auth.goToRedirectUrl();\r\n    this.getName();\r\n    this.login.emit(true);\r\n  }\r\n\r\n  public logout() {\r\n    this.auth.logout().subscribe(() => {\r\n      this.user = undefined;\r\n      if (this.router) {\r\n        if (this.options.logoutRoute) {\r\n          this.router.navigate([this.options.logoutRoute]);\r\n        } else if (this.options.homeRoute) {\r\n          this.router.navigate([this.options.homeRoute]);\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  public home() {\r\n    if (this.router && this.options.homeRoute) {\r\n      this.router.navigate([this.options.homeRoute]);\r\n    }\r\n  }\r\n\r\n  private getName() {\r\n    const tokenDecoded = this.auth.decodeToken();\r\n    if (tokenDecoded) {\r\n      this.user = {\r\n        name: tokenDecoded.user.firstName || tokenDecoded.user.sourceId\r\n      };\r\n    }\r\n  }\r\n\r\n  private analyzeRoute() {\r\n    if (!this.router) {\r\n      return;\r\n    }\r\n\r\n    this.router.events\r\n      .pipe(filter((event) => event instanceof NavigationStart))\r\n      .subscribe((changeEvent: any) => {\r\n        if (changeEvent.url) {\r\n          const currentRoute = changeEvent.url;\r\n          const logoutRoute = this.options.logoutRoute;\r\n          const loginRoute = this.options.loginRoute;\r\n\r\n          this.isLogoutRoute = currentRoute === logoutRoute;\r\n          this.isLoginRoute = currentRoute === loginRoute;\r\n\r\n          if (this.isLogoutRoute) {\r\n            this.auth.logout();\r\n          }\r\n        }\r\n      });\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport {\r\n  HttpEvent,\r\n  HttpInterceptor,\r\n  HttpHandler,\r\n  HttpRequest\r\n} from '@angular/common/http';\r\nimport { Observable } from 'rxjs';\r\nimport { Md5 } from 'ts-md5';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { TokenService } from './token.service';\r\nimport { AuthByKeyOptions, WithCredentialsOptions } from './auth.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class AuthInterceptor implements HttpInterceptor {\r\n  private refreshInProgress = false;\r\n\r\n  private get trustHosts() {\r\n    const trustHosts = this.config.getConfig('auth.trustHosts') || [];\r\n    trustHosts.push(window.location.hostname);\r\n    return trustHosts;\r\n  }\r\n\r\n  private get hostsWithCredentials(): WithCredentialsOptions[] {\r\n    return this.config.getConfig('auth.hostsWithCredentials') || [];\r\n  }\r\n\r\n  private get hostsWithAuthByKey(): AuthByKeyOptions[] {\r\n    return this.config.getConfig('auth.hostsByKey') || [];\r\n  }\r\n\r\n  constructor(\r\n    private config: ConfigService,\r\n    private tokenService: TokenService,\r\n    private http: HttpClient\r\n  ) {}\r\n\r\n  intercept(\r\n    originalReq: HttpRequest<any>,\r\n    next: HttpHandler\r\n  ): Observable<HttpEvent<any>> {\r\n    const withCredentials = this.handleHostsWithCredentials(originalReq.url);\r\n    let req = originalReq.clone();\r\n    const hostWithKey = this.handleHostsAuthByKey(originalReq.url);\r\n    if (hostWithKey) {\r\n      req = req.clone({\r\n        params: req.params.set(hostWithKey.key, hostWithKey.value)\r\n      });\r\n    }\r\n    if (withCredentials) {\r\n      req = originalReq.clone({\r\n        withCredentials\r\n      });\r\n      return next.handle(req);\r\n    }\r\n    this.refreshToken();\r\n    const token = this.tokenService.get();\r\n    const element = document.createElement('a');\r\n    element.href = req.url;\r\n    if (element.host === '') {\r\n      element.href = element.href; // FIX IE11, DO NOT REMOVE\r\n    }\r\n\r\n    if (!token || this.trustHosts.indexOf(element.hostname) === -1) {\r\n      return next.handle(req);\r\n    }\r\n\r\n    const authHeader = `Bearer ${token}`;\r\n    let authReq = req.clone({\r\n      headers: req.headers.set('Authorization', authHeader)\r\n    });\r\n\r\n    const tokenDecoded: any = this.tokenService.decode();\r\n    if (\r\n      authReq.params.get('_i') === 'true' &&\r\n      tokenDecoded &&\r\n      tokenDecoded.user &&\r\n      tokenDecoded.user.sourceId\r\n    ) {\r\n      const hashUser = Md5.hashStr(tokenDecoded.user.sourceId) as string;\r\n      authReq = authReq.clone({\r\n        params: authReq.params.set('_i', hashUser)\r\n      });\r\n    } else if (authReq.params.get('_i') === 'true') {\r\n      authReq = authReq.clone({\r\n        params: authReq.params.delete('_i')\r\n      });\r\n    }\r\n\r\n    return next.handle(authReq);\r\n  }\r\n\r\n  interceptXhr(xhr, url: string): boolean {\r\n    const withCredentials = this.handleHostsWithCredentials(url);\r\n    if (withCredentials) {\r\n       xhr.withCredentials = withCredentials;\r\n       return true;\r\n    }\r\n\r\n    this.refreshToken();\r\n    const element = document.createElement('a');\r\n    element.href = url;\r\n\r\n    const token = this.tokenService.get();\r\n    if (!token || this.trustHosts.indexOf(element.hostname) === -1) {\r\n      return false;\r\n    }\r\n    xhr.setRequestHeader('Authorization', 'Bearer ' + token);\r\n    return true;\r\n  }\r\n\r\n  alterUrlWithKeyAuth(url: string): string {\r\n    const hostWithKey = this.handleHostsAuthByKey(url);\r\n    let interceptedUrl = url;\r\n    if (hostWithKey) {\r\n      const urlDecomposed = interceptedUrl.split(/[?&]/);\r\n      let urlWithKeyAdded = urlDecomposed.shift();\r\n      const paramsToKeep = urlDecomposed.filter(p => p.length !== 0);\r\n      paramsToKeep.push(`${hostWithKey.key}=${hostWithKey.value}`);\r\n      if (paramsToKeep.length) {\r\n        urlWithKeyAdded += '?' + paramsToKeep.join('&');\r\n      }\r\n      return urlWithKeyAdded;\r\n    }\r\n    return;\r\n  }\r\n\r\n  private handleHostsWithCredentials(reqUrl: string) {\r\n    let withCredentials = false;\r\n    for (const hostWithCredentials of this.hostsWithCredentials) {\r\n      const domainRegex = new RegExp(hostWithCredentials.domainRegFilters);\r\n      if (domainRegex.test(reqUrl)) {\r\n        withCredentials = hostWithCredentials.withCredentials !== undefined ? hostWithCredentials.withCredentials : undefined;\r\n        break;\r\n      }\r\n    }\r\n    return withCredentials;\r\n  }\r\n\r\n  private handleHostsAuthByKey(reqUrl: string): {key: string, value: string} {\r\n    let hostWithKey;\r\n    for (const hostWithAuthByKey of this.hostsWithAuthByKey) {\r\n      const domainRegex = new RegExp(hostWithAuthByKey.domainRegFilters);\r\n      if (domainRegex.test(reqUrl)) {\r\n        var replace = `${hostWithAuthByKey.keyProperty}=${hostWithAuthByKey.keyValue}`;\r\n        var keyAdded = new RegExp(replace,\"gm\");\r\n        if (!keyAdded.test(reqUrl)) {\r\n          hostWithKey = {key : hostWithAuthByKey.keyProperty, value: hostWithAuthByKey.keyValue};\r\n          break;\r\n        }\r\n      }\r\n    }\r\n    return hostWithKey;\r\n  }\r\n\r\n  refreshToken() {\r\n    const jwt = this.tokenService.decode();\r\n    const currentTime = new Date().getTime() / 1000;\r\n\r\n    if (\r\n      !this.refreshInProgress &&\r\n      jwt &&\r\n      currentTime < jwt.exp &&\r\n      currentTime > jwt.exp - 1800\r\n    ) {\r\n      this.refreshInProgress = true;\r\n\r\n      const url = this.config.getConfig('auth.url');\r\n      return this.http.post(`${url}/refresh`, {}).subscribe(\r\n        (data: any) => {\r\n          this.tokenService.set(data.token);\r\n          this.refreshInProgress = false;\r\n        },\r\n        err => {\r\n          err.error.caught = true;\r\n          return err;\r\n        }\r\n      );\r\n    }\r\n  }\r\n}\r\n","import {\r\n  MSAL_GUARD_CONFIG,\r\n  MSAL_INSTANCE,\r\n  MsalService,\r\n} from '@azure/msal-angular';\r\n\r\nimport {\r\n  PublicClientApplication,\r\n  InteractionType\r\n} from '@azure/msal-browser';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\n\r\nimport { BrowserAuthOptions } from '@azure/msal-browser';\r\n\r\nimport { AuthMicrosoftOptions, MSPMsalGuardConfiguration } from './auth.interface';\r\n\r\nimport { MsalServiceb2c } from './auth-msalServiceb2c.service.';\r\n\r\nexport function MSALConfigFactory(config: ConfigService): PublicClientApplication {\r\n\r\n  const msConf: BrowserAuthOptions = config.getConfig('auth.microsoft') || {};\r\n\r\n  msConf.redirectUri = msConf.redirectUri || window.location.href;\r\n  msConf.authority = msConf.authority || 'https://login.microsoftonline.com/organizations';\r\n\r\n  const myMsalObj = new PublicClientApplication({\r\n    auth: msConf,\r\n    cache: {\r\n      cacheLocation: 'sessionStorage'\r\n    }\r\n  });\r\n\r\n  return myMsalObj;\r\n}\r\n\r\nexport function MSALConfigFactoryb2c(config: ConfigService): PublicClientApplication {\r\n\r\n  const msConf: BrowserAuthOptions = config.getConfig('auth.microsoftb2c.browserAuthOptions') || {};\r\n  msConf.redirectUri = msConf.redirectUri || window.location.href;\r\n  msConf.authority = msConf.authority || 'https://login.microsoftonline.com/organizations';\r\n\r\n  const myMsalObj = new PublicClientApplication({\r\n    auth: msConf,\r\n    cache: {\r\n      cacheLocation: 'sessionStorage'\r\n    }\r\n  });\r\n\r\n  return myMsalObj;\r\n}\r\n\r\nexport function MSALAngularConfigFactory(config: ConfigService): MSPMsalGuardConfiguration {\r\n\r\n  const msConf: AuthMicrosoftOptions = config.getConfig('auth.microsoft') || {};\r\n\r\n  return {\r\n    interactionType: InteractionType.Popup,\r\n    authRequest: {\r\n      scopes: ['user.read'],\r\n      loginHint: 'todo',\r\n    },\r\n    type: 'add'\r\n  };\r\n}\r\n\r\nexport function MSALAngularConfigFactoryb2c(config: ConfigService): MSPMsalGuardConfiguration {\r\n\r\n  const msConf: BrowserAuthOptions = config.getConfig('auth.microsoftb2c.browserAuthOptions') || {};\r\n\r\n  return {\r\n    interactionType: InteractionType.Popup,\r\n    authRequest: {\r\n      scopes: [msConf.clientId]\r\n    },\r\n    type: 'b2c'\r\n  };\r\n}\r\n\r\nexport function provideAuthMicrosoft(type?: string) {\r\n  if (type === 'b2c') {\r\n    return [\r\n      {\r\n        provide: MSAL_INSTANCE,\r\n        useFactory: MSALConfigFactoryb2c,\r\n        deps: [ConfigService]\r\n      },\r\n      {\r\n        provide: MSAL_GUARD_CONFIG,\r\n        useFactory: MSALAngularConfigFactoryb2c,\r\n        deps: [ConfigService],\r\n        multi: true\r\n      },\r\n      MsalServiceb2c\r\n    ];\r\n  } else {\r\n    return [\r\n      {\r\n        provide: MSAL_INSTANCE,\r\n        useFactory: MSALConfigFactory,\r\n        deps: [ConfigService]\r\n      },\r\n      {\r\n        provide: MSAL_GUARD_CONFIG,\r\n        useFactory: MSALAngularConfigFactory,\r\n        deps: [ConfigService],\r\n        multi: true\r\n      },\r\n      MsalService\r\n    ];\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\n\r\nimport { StorageService, StorageScope, ConfigService } from '@igo2/core';\r\nimport { AuthService } from './auth.service';\r\nimport { TokenService } from './token.service';\r\nimport { AuthStorageOptions } from './storage.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class AuthStorageService extends StorageService {\r\n  protected options: AuthStorageOptions;\r\n\r\n  constructor(\r\n    config: ConfigService,\r\n    private http: HttpClient,\r\n    private authService: AuthService,\r\n    private tokenService: TokenService\r\n  ) {\r\n    super(config);\r\n\r\n    this.authService.authenticate$.subscribe(isAuthenticated => {\r\n      if (isAuthenticated && this.options.url) {\r\n        this.http\r\n          .get(this.options.url)\r\n          .subscribe((userIgo: { preference: object }) => {\r\n            if (userIgo && userIgo.preference) {\r\n              for (const key of Object.keys(userIgo.preference)) {\r\n                const value = userIgo.preference[key];\r\n                super.set(key, value);\r\n              }\r\n            }\r\n          });\r\n      }\r\n    });\r\n  }\r\n\r\n  set(\r\n    key: string,\r\n    value: string | object | boolean | number,\r\n    scope: StorageScope = StorageScope.LOCAL\r\n  ) {\r\n    if (\r\n      scope === StorageScope.LOCAL &&\r\n      this.authService.authenticated &&\r\n      this.options.url\r\n    ) {\r\n      const preference = {};\r\n      preference[key] = value;\r\n      this.http.patch(this.options.url, { preference }).subscribe();\r\n    }\r\n    super.set(key, value, scope);\r\n  }\r\n\r\n  remove(key: string, scope: StorageScope = StorageScope.LOCAL) {\r\n    if (\r\n      scope === StorageScope.LOCAL &&\r\n      this.authService.authenticated &&\r\n      this.options.url\r\n    ) {\r\n      const preference = {};\r\n      preference[key] = undefined;\r\n      this.http.patch(this.options.url, { preference }).subscribe();\r\n    }\r\n    super.remove(key, scope);\r\n  }\r\n\r\n  clear(scope: StorageScope = StorageScope.LOCAL) {\r\n    if (\r\n      scope === StorageScope.LOCAL &&\r\n      this.authService.authenticated &&\r\n      this.options.url\r\n    ) {\r\n      this.http.patch(this.options.url, { preference: {}}, {\r\n        params: {\r\n          mergePreference: 'false'\r\n        }\r\n      }).subscribe();\r\n    }\r\n\r\n    let token: string;\r\n    if (scope === StorageScope.LOCAL) {\r\n      token = this.tokenService.get();\r\n    }\r\n\r\n    super.clear(scope);\r\n\r\n    if (token) {\r\n      this.tokenService.set(token);\r\n    }\r\n\r\n    if (\r\n      scope === StorageScope.LOCAL &&\r\n      this.authService.authenticated &&\r\n      this.options.url\r\n    ) {\r\n      this.http\r\n        .get(this.options.url)\r\n        .subscribe((userIgo: { preference: object }) => {\r\n          if (userIgo && userIgo.preference) {\r\n            for (const key of Object.keys(userIgo.preference)) {\r\n              const value = userIgo.preference[key];\r\n              super.set(key, value);\r\n            }\r\n          }\r\n        });\r\n    }\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { HTTP_INTERCEPTORS } from '@angular/common/http';\r\nimport { ReactiveFormsModule } from '@angular/forms';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MsalModule } from '@azure/msal-angular';\r\n\r\nimport { StorageService, IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { AuthStorageService } from './shared/storage.service';\r\nimport { ProtectedDirective } from './shared/protected.directive';\r\nimport { AuthInterceptor } from './shared/auth.interceptor';\r\nimport { provideAuthMicrosoft } from './shared/auth-microsoft.provider';\r\n\r\nimport { AuthInternComponent } from './auth-form/auth-intern.component';\r\nimport { AuthFormComponent } from './auth-form/auth-form.component';\r\nimport { AuthGoogleComponent } from './auth-form/auth-google.component';\r\nimport { AuthFacebookComponent } from './auth-form/auth-facebook.component';\r\nimport { AuthMicrosoftComponent } from './auth-form/auth-microsoft.component';\r\nimport { AuthMicrosoftb2cComponent } from './auth-form/auth-microsoftb2c.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    ReactiveFormsModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    IgoLanguageModule,\r\n    MsalModule\r\n  ],\r\n  declarations: [\r\n    AuthFormComponent,\r\n    AuthGoogleComponent,\r\n    AuthInternComponent,\r\n    AuthFacebookComponent,\r\n    AuthMicrosoftComponent,\r\n    AuthMicrosoftb2cComponent,\r\n    ProtectedDirective\r\n  ],\r\n  exports: [AuthFormComponent, ProtectedDirective]\r\n})\r\nexport class IgoAuthModule {\r\n  static forRoot(): ModuleWithProviders<IgoAuthModule> {\r\n    return {\r\n      ngModule: IgoAuthModule,\r\n      providers: [\r\n        {\r\n          provide: HTTP_INTERCEPTORS,\r\n          useClass: AuthInterceptor,\r\n          multi: true\r\n        },\r\n        {\r\n          provide: StorageService,\r\n          useClass: AuthStorageService\r\n        },\r\n        ...provideAuthMicrosoft('add'),\r\n        ...provideAuthMicrosoft('b2c')\r\n      ]\r\n    };\r\n  }\r\n}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\nimport { AppAuthFormComponent } from './auth-form.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'auth-form',\r\n    component: AppAuthFormComponent\r\n  }\r\n];\r\n\r\nexport const AppAuthFormRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'app-auth-form',\r\n  templateUrl: './auth-form.component.html',\r\n  styleUrls: ['./auth-form.component.scss']\r\n})\r\nexport class AppAuthFormComponent {\r\n  private idsActivity: string[] = [];\r\n\r\n  constructor(private languageService: LanguageService) {}\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Auth</mat-card-subtitle>\r\n  <mat-card-title>Authentification</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: ConfigService, LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/auth/auth-form\">code of this example</a><br>\r\n    See auth section of the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/environments\"> environment config</a>\r\n  </mat-card-content>\r\n</mat-card>\r\n\r\n<igo-auth-form></igo-auth-form>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoAuthModule } from '@igo2/auth';\r\n\r\nimport { AppAuthFormComponent } from './auth-form.component';\r\nimport { AppAuthFormRoutingModule } from './auth-form-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppAuthFormComponent],\r\n  imports: [AppAuthFormRoutingModule, MatCardModule, IgoAuthModule.forRoot()],\r\n  exports: [AppAuthFormComponent]\r\n})\r\nexport class AppAuthFormModule {}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { MetadataOptions } from './metadata.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class MetadataService {\r\n  constructor() {}\r\n\r\n  open(metadata: MetadataOptions) {\r\n    if (metadata.extern) {\r\n      window.open(metadata.url, '_blank');\r\n    }\r\n  }\r\n}\r\n","<button\r\n  *ngIf=\"(options && options.metadata && options.metadata.url) || (options && options.metadata && options.metadata.abstract)\"\r\n  mat-icon-button\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.metadata.show' | translate\"\r\n  [color]=\"color\"\r\n  (click)=\"openMetadata(options.metadata)\">\r\n  <mat-icon svgIcon=\"information-outline\"></mat-icon>\r\n</button>\r\n","<h2 mat-dialog-title>{{ data.layerTitle }}</h2>\r\n<button class=\"close-button\" mat-button mat-dialog-close>X</button>\r\n<mat-dialog-content *ngIf=\"data.type !== 'arcgisrest'\" class=\"mat-typography\">\r\n  <h3>{{ data.abstract }}</h3>\r\n</mat-dialog-content>\r\n<mat-dialog-content *ngIf=\"data.type === 'arcgisrest'\" class=\"mat-typography\">\r\n  <h3 [innerHTML]=\"data.abstract\"></h3>\r\n</mat-dialog-content>\r\n","import { Component, Input, ChangeDetectionStrategy, Inject, ViewEncapsulation } from '@angular/core';\r\nimport { MatDialog, MAT_DIALOG_DATA } from '@angular/material/dialog';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\n\r\nimport {\r\n  MetadataOptions,\r\n  MetadataLayerOptions\r\n} from '../shared/metadata.interface';\r\nimport { MetadataService } from '../shared/metadata.service';\r\n\r\n@Component({\r\n  selector: 'igo-metadata-button',\r\n  templateUrl: './metadata-button.component.html',\r\n  styleUrls: ['./metadata-button.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class MetadataButtonComponent {\r\n  @Input()\r\n  get layer(): Layer {\r\n    return this._layer;\r\n  }\r\n  set layer(value: Layer) {\r\n    this._layer = value;\r\n  }\r\n  private _layer: Layer;\r\n\r\n  @Input()\r\n  get color() {\r\n    return this._color;\r\n  }\r\n  set color(value: string) {\r\n    this._color = value;\r\n  }\r\n  private _color = 'primary';\r\n\r\n  constructor(\r\n    private metadataService: MetadataService,\r\n    private dialog: MatDialog) {}\r\n\r\n  openMetadata(metadata: MetadataOptions) {\r\n    if (metadata.extern) {\r\n      if (!metadata.url && metadata.abstract) {\r\n        this.dialog.open(MetadataAbstractComponent, {\r\n          data: {\r\n            layerTitle: this.layer.title,\r\n            abstract: metadata.abstract,\r\n            type: metadata.type\r\n          }\r\n        });\r\n      } else if (metadata.url) {\r\n        this.metadataService.open(metadata);\r\n      }\r\n    } else if (!metadata.extern && metadata.abstract) {\r\n      this.dialog.open(MetadataAbstractComponent, {\r\n        data: {\r\n          layerTitle: this.layer.title,\r\n          abstract: metadata.abstract,\r\n          type: metadata.type\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  get options(): MetadataLayerOptions {\r\n    if (!this.layer) {\r\n      return;\r\n    }\r\n    return this.layer.options;\r\n  }\r\n}\r\n\r\n@Component({\r\n  selector: 'igo-metadata-abstract',\r\n  templateUrl: './metadata-abstract.component.html',\r\n  styleUrls: ['./metadata-abstract.component.scss'],\r\n  encapsulation: ViewEncapsulation.None\r\n})\r\nexport class MetadataAbstractComponent {\r\n  constructor(@Inject(MAT_DIALOG_DATA) public data: MetadataOptions) {}\r\n}\r\n","import { MatDialogModule } from '@angular/material/dialog';\r\nimport { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { MetadataButtonComponent, MetadataAbstractComponent } from './metadata-button/metadata-button.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatTooltipModule,\r\n    IgoLanguageModule,\r\n    MatDialogModule\r\n  ],\r\n  exports: [\r\n    MetadataButtonComponent,\r\n    MetadataAbstractComponent],\r\n  declarations: [\r\n    MetadataButtonComponent,\r\n    MetadataAbstractComponent]\r\n})\r\nexport class IgoMetadataModule {\r\n  static forRoot(): ModuleWithProviders<IgoMetadataModule> {\r\n    return {\r\n      ngModule: IgoMetadataModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","export const FEATURE = 'Feature';\r\n\r\nexport enum FeatureMotion {\r\n  None,\r\n  Move,\r\n  Zoom,\r\n  Default\r\n}\r\n","import olSourceImage from 'ol/source/Image';\r\nimport { uuid, Watcher, SubjectStatus } from '@igo2/utils';\r\nimport { LanguageService, MessageService } from '@igo2/core';\r\nimport { ImageLayer } from '../shared/layers/image-layer';\r\n\r\n\r\nexport class ImageWatcher extends Watcher {\r\n  protected id: string;\r\n  protected loaded = 0;\r\n  protected loading = 0;\r\n\r\n  private source: olSourceImage;\r\n\r\n  private messageService: MessageService;\r\n  private languageService: LanguageService;\r\n\r\n  constructor(layer: ImageLayer, messageService: MessageService, languageService: LanguageService) {\r\n    super();\r\n    this.source = layer.options.source.ol;\r\n    this.id = uuid();\r\n    this.messageService = messageService;\r\n    this.languageService = languageService;\r\n  }\r\n\r\n  protected watch() {\r\n    this.source.on(`imageloadstart`, e => this.handleLoadStart(e));\r\n    this.source.on(`imageloadend`, e => this.handleLoadEnd(e));\r\n    this.source.on(`imageloaderror`, e => this.handleLoadEnd(e));\r\n    this.source.on(`imageloaderror`, e => this.handleLoadError(e));\r\n  }\r\n\r\n  protected unwatch() {\r\n    this.source.un(`imageloadstart`, e => this.handleLoadStart(e));\r\n    this.source.un(`imageloadend`, e => this.handleLoadEnd(e));\r\n    this.source.un(`imageloaderror`, e => this.handleLoadEnd(e));\r\n    this.source.un(`imageloaderror`, e => this.handleLoadError(e));\r\n  }\r\n\r\n  private handleLoadStart(event: any) {\r\n    if (!event.image.__watchers__) {\r\n      event.image.__watchers__ = [];\r\n    }\r\n    event.image.__watchers__.push(this.id);\r\n\r\n    this.loading += 1;\r\n    this.status = SubjectStatus.Working;\r\n  }\r\n\r\n  private handleLoadEnd(event) {\r\n    if (!event.image.__watchers__) {\r\n      return;\r\n    }\r\n\r\n    const watcherIndex = event.image.__watchers__.indexOf(this.id);\r\n    if (watcherIndex < 0) {\r\n      return;\r\n    }\r\n\r\n    event.image.__watchers__.splice(watcherIndex, 1);\r\n\r\n    this.loaded += 1;\r\n\r\n    const loading = this.loading;\r\n    if (this.loaded >= loading) {\r\n      if (loading === this.loading) {\r\n        this.status = SubjectStatus.Done;\r\n        this.loaded = this.loading = 0;\r\n      }\r\n    }\r\n  }\r\n\r\n  private handleLoadError(event) {\r\n\r\n    if (!event.image.__watchers__) {\r\n      return;\r\n    }\r\n    const title = this.languageService.translate.instant(\r\n      'igo.geo.dataSource.unavailableTitle'\r\n    );\r\n    const message = this.languageService.translate.instant(\r\n      'igo.geo.dataSource.unavailable', {value: event.target.params_.LAYERS}\r\n    );\r\n\r\n    this.messageService.error(message, title);\r\n    this.loaded = -1;\r\n    this.loading = 0;\r\n    this.status = SubjectStatus.Error;\r\n\r\n  }\r\n}\r\n","import { AnyLayerOptions } from \"../shared/layers/any-layer.interface\";\r\nimport { VectorTileLayerOptions } from \"../shared/layers/vectortile-layer.interface\";\r\n\r\n\r\nexport function computeMVTOptionsOnHover(layerOptions: AnyLayerOptions) {\r\n  const vectorTileLayerOptions = layerOptions as VectorTileLayerOptions;\r\n  if (\r\n    vectorTileLayerOptions.sourceOptions?.type === 'mvt' &&\r\n    (vectorTileLayerOptions.styleByAttribute?.hoverStyle || vectorTileLayerOptions.hoverStyle)) {\r\n    const fc = vectorTileLayerOptions.sourceOptions.featureClass;\r\n    vectorTileLayerOptions.sourceOptions.featureClass = fc ? fc : 'feature';\r\n  }\r\n  return layerOptions;\r\n}\r\n","import olSourceTile from 'ol/source/Tile';\r\nimport { uuid, Watcher, SubjectStatus } from '@igo2/utils';\r\n\r\nimport { TileLayer } from '../shared/layers/tile-layer';\r\nimport { VectorTileLayer } from '../shared/layers/vectortile-layer';\r\n\r\nexport class TileWatcher extends Watcher {\r\n  private id: string;\r\n  private loaded = 0;\r\n  private loading = 0;\r\n\r\n  private source: olSourceTile;\r\n\r\n  constructor(layer: TileLayer | VectorTileLayer) {\r\n    super();\r\n    this.source = layer.options.source.ol;\r\n    this.id = uuid();\r\n  }\r\n\r\n  protected watch() {\r\n    this.source.on(`tileloadstart`, e => this.handleLoadStart(e));\r\n    this.source.on(`tileloadend`, e => this.handleLoadEnd(e));\r\n    this.source.on(`tileloaderror`, e => this.handleLoadEnd(e));\r\n  }\r\n\r\n  protected unwatch() {\r\n    this.source.un(`tileloadstart`, e => this.handleLoadStart(e));\r\n    this.source.un(`tileloadend`, e => this.handleLoadEnd(e));\r\n    this.source.un(`tileloaderror`, e => this.handleLoadEnd(e));\r\n  }\r\n\r\n  private handleLoadStart(event: any) {\r\n    // This is to avoid increasing\r\n    // the number of loaded tiles if a tile was loading\r\n    // before subscribing to this watcher\r\n    if (!event.tile.__watchers__) {\r\n      event.tile.__watchers__ = [];\r\n    }\r\n    event.tile.__watchers__.push(this.id);\r\n\r\n    this.loading += 1;\r\n    this.status = SubjectStatus.Working;\r\n  }\r\n\r\n  private handleLoadEnd(event) {\r\n    if (!event.tile.__watchers__) {\r\n      return;\r\n    }\r\n\r\n    const watcherIndex = event.tile.__watchers__.indexOf(this.id);\r\n    if (watcherIndex < 0) {\r\n      return;\r\n    }\r\n\r\n    event.tile.__watchers__.splice(watcherIndex, 1);\r\n\r\n    this.loaded += 1;\r\n\r\n    const loading = this.loading;\r\n    if (this.loaded >= loading) {\r\n      if (loading === this.loading) {\r\n        this.status = SubjectStatus.Done;\r\n        this.loaded = this.loading = 0;\r\n      }\r\n    }\r\n  }\r\n}\r\n","import { ArcGISRestDataSourceOptions } from './../datasource/shared/datasources/arcgisrest-datasource.interface';\r\nimport { Md5 } from 'ts-md5';\r\n\r\nimport { uuid } from '@igo2/utils';\r\n\r\nimport { AnyDataSourceOptions } from '../datasource/shared/datasources/any-datasource.interface';\r\nimport { DataSourceOptions } from '../datasource/shared/datasources/datasource.interface';\r\nimport { WMSDataSourceOptions } from '../datasource/shared/datasources/wms-datasource.interface';\r\nimport { WMTSDataSourceOptions } from '../datasource/shared/datasources/wmts-datasource.interface';\r\nimport { WFSDataSourceOptions } from '../datasource';\r\n\r\n/**\r\n * Generate a id from it's datasource options.\r\n * @param options Data source options\r\n * @returns A id\r\n */\r\nexport function generateIdFromSourceOptions(options: DataSourceOptions): string {\r\n  const generators = {\r\n    wms: generateWMSIdFromSourceOptions,\r\n    wmts: generateWMTSIdFromSourceOptions,\r\n    xyz: generateXYZIdFromSourceOptions,\r\n    feature: generateFeatureIdFromSourceOptions,\r\n    wfs: generateWfsIdFromSourceOptions,\r\n    arcgisrest: generateArcgisRestIdFromSourceOptions,\r\n    imagearcgisrest: generateArcgisRestIdFromSourceOptions,\r\n    tilearcgisrest: generateArcgisRestIdFromSourceOptions,\r\n    osm: (_options: AnyDataSourceOptions) => 'OSM',\r\n    tiledebug: (_options: AnyDataSourceOptions) => 'tiledebug'\r\n  };\r\n  const generator = generators[options.type] || generateId;\r\n  return generator(options);\r\n}\r\n\r\n/**\r\n * Generate a id from WMS data source options\r\n * @param options WMS data source options\r\n * @returns A md5 hash of the the url and layers\r\n */\r\nexport function generateWMSIdFromSourceOptions(options: WMSDataSourceOptions) {\r\n  const layers = options.params.LAYERS;\r\n  const url = standardizeUrl(options.url);\r\n  const chain = 'wms' + url + layers;\r\n  return Md5.hashStr(chain) as string;\r\n}\r\n\r\n/**\r\n * Generate a id from WMTS data source options\r\n * @param options WMTS data source options\r\n * @returns A md5 hash of the the url and layer\r\n */\r\nexport function generateWMTSIdFromSourceOptions(options: WMTSDataSourceOptions) {\r\n  const layer = options.layer;\r\n  const url = standardizeUrl(options.url);\r\n  const chain = 'wmts' + url + layer;\r\n  return Md5.hashStr(chain) as string;\r\n}\r\n\r\n/**\r\n * Generate a id from XYZ data source options\r\n * @param options XYZ data source options\r\n * @returns A md5 hash of the the url and layer\r\n */\r\nexport function generateXYZIdFromSourceOptions(options: WMTSDataSourceOptions) {\r\n  const url = standardizeUrl(options.url);\r\n  const chain = 'xyz' + url;\r\n  return Md5.hashStr(chain) as string;\r\n}\r\n\r\n/**\r\n * Generate a id from feature data source options\r\n * @param options XYZ data source options\r\n * @returns A md5 hash of the the url and layer\r\n */\r\nexport function generateFeatureIdFromSourceOptions(options: WMTSDataSourceOptions) {\r\n  if (!options.url) { return generateId(options); }\r\n  const url = standardizeUrl(options.url);\r\n  const chain = 'feature' + url;\r\n  return Md5.hashStr(chain) as string;\r\n}\r\n\r\n/**\r\n * Generate a id from feature data source options\r\n * @param options XYZ data source options\r\n * @returns A md5 hash of the the url and layer\r\n */\r\nexport function generateWfsIdFromSourceOptions(options: WFSDataSourceOptions) {\r\n  if (!options.url || !options.params) { return generateId(options); }\r\n  const url = standardizeUrl(options.url);\r\n  const chain = 'wfs' + url + options.params.featureTypes;\r\n  return Md5.hashStr(chain) as string;\r\n}\r\n/**\r\n * Generate a id from ArcGIS Rest data source options\r\n * @param options ArcGIS Rest data source options\r\n * @returns A md5 hash of the url and layers\r\n */\r\nexport function generateArcgisRestIdFromSourceOptions(options: ArcGISRestDataSourceOptions) {\r\n  const layers = options.layer;\r\n  const url = standardizeUrl(options.url);\r\n  const chain = (options.type || 'arcgis') + url + layers;\r\n  return Md5.hashStr(chain) as string;\r\n}\r\n\r\n/**\r\n * Generate a unique id\r\n * @returns A uuid\r\n */\r\nexport function generateId(_options: AnyDataSourceOptions) {\r\n  return uuid();\r\n}\r\n\r\nexport function standardizeUrl(url: string): string {\r\n  const absUrl = url.charAt(0) === '/' ? window.location.origin + url : url;\r\n  const urlDecomposed = absUrl.split(/[?&]/);\r\n  let urlStandardized = urlDecomposed.shift();\r\n  const paramsToKeep = urlDecomposed.filter(p => p.length !== 0 && p.charAt(0) !== '_');\r\n  if (paramsToKeep.length) {\r\n    urlStandardized += '?' + paramsToKeep.join('&');\r\n  }\r\n  return urlStandardized;\r\n}\r\n","import olSource from 'ol/source/Source';\r\nimport olVectorSource from 'ol/source/Vector';\r\nimport olClusterSource from 'ol/source/Cluster';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport {\r\n  DataSourceOptions,\r\n  Legend\r\n} from './datasource.interface';\r\n\r\nimport { DataService } from './data.service';\r\nimport { generateIdFromSourceOptions } from '../../../utils/id-generator';\r\nimport { LegendMapViewOptions, LegendOptions } from '../../../layer/shared/layers/layer.interface';\r\n\r\nexport abstract class DataSource {\r\n\r\n  public id: string;\r\n  public ol: olSource | olVectorSource<OlGeometry> | olClusterSource ;\r\n  private legend: Legend[];\r\n\r\n  constructor(\r\n    public options: DataSourceOptions = {},\r\n    protected dataService?: DataService\r\n  ) {\r\n    this.options = options;\r\n    this.id = this.options.id ||this.generateId();\r\n    this.ol = this.createOlSource();\r\n  }\r\n\r\n  protected abstract createOlSource(): olSource;\r\n\r\n  protected generateId(): string {\r\n    return generateIdFromSourceOptions(this.options);\r\n  }\r\n\r\n  public getLegend(style?: string, view?: LegendMapViewOptions): Legend[] {\r\n    return this.legend ? this.legend : [];\r\n  }\r\n\r\n  public setLegend(options: LegendOptions): Legend[] {\r\n    if (options.url) {\r\n      this.legend = [{ url: options.url} ];\r\n    } else if (options.html) {\r\n      this.legend = [{ html: options.html} ];\r\n    } else {\r\n      this.legend = [];\r\n    }\r\n\r\n    return this.legend;\r\n  }\r\n\r\n  protected abstract onUnwatch();\r\n}\r\n","import olSourceVector from 'ol/source/Vector';\r\nimport * as olformat from 'ol/format';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { FeatureDataSourceOptions } from './feature-datasource.interface';\r\n\r\nexport class FeatureDataSource extends DataSource {\r\n  public options: FeatureDataSourceOptions;\r\n  public ol: olSourceVector<OlGeometry>;\r\n  protected createOlSource(): olSourceVector<OlGeometry> {\r\n    const sourceOptions = {\r\n      format: this.getSourceFormatFromOptions(this.options)\r\n    };\r\n\r\n    return new olSourceVector(Object.assign(sourceOptions, this.options));\r\n  }\r\n\r\n  protected getSourceFormatFromOptions(options: FeatureDataSourceOptions) {\r\n    if (options.format) {\r\n      return options.format;\r\n    }\r\n    let olFormatCls;\r\n    const formatType = options.formatType;\r\n    if (!formatType) {\r\n      olFormatCls = olformat.GeoJSON;\r\n    } else {\r\n      olFormatCls = olformat[formatType];\r\n      if (olFormatCls === undefined) {\r\n        throw new Error('Invalid vector source format ${formatType}.');\r\n      }\r\n    }\r\n\r\n    const formatOptions = options.formatOptions;\r\n    let format;\r\n    if (formatOptions) {\r\n      format = new olFormatCls(formatOptions);\r\n    } else {\r\n      format = new olFormatCls();\r\n    }\r\n\r\n    return format;\r\n  }\r\n\r\n  public onUnwatch() {}\r\n\r\n  get queryTitle(): string {\r\n    return (this.options as any).queryTitle\r\n      ? (this.options as any).queryTitle\r\n      : 'title';\r\n  }\r\n}\r\n","import olSourceCluster from 'ol/source/Cluster';\r\n\r\nimport { uuid } from '@igo2/utils';\r\n\r\nimport { FeatureDataSource } from './feature-datasource';\r\nimport { ClusterDataSourceOptions } from './cluster-datasource.interface';\r\n\r\nexport class ClusterDataSource extends FeatureDataSource {\r\n  public options: ClusterDataSourceOptions;\r\n  public ol: olSourceCluster;\r\n\r\n  protected createOlSource(): olSourceCluster {\r\n    this.options.format = this.getSourceFormatFromOptions(this.options);\r\n    this.options.source = super.createOlSource();\r\n    return new olSourceCluster(this.options);\r\n  }\r\n\r\n  protected generateId() {\r\n    return uuid();\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import { uuid, Watcher, SubjectStatus } from '@igo2/utils';\r\n\r\nimport { VectorLayer } from '../shared/layers/vector-layer';\r\nimport { ClusterDataSource } from '../../datasource/shared/datasources/cluster-datasource';\r\n\r\nexport class VectorWatcher extends Watcher {\r\n  private id: string;\r\n  private loaded = 0;\r\n  private loading = 0;\r\n\r\n  private layer: VectorLayer;\r\n\r\n  constructor(layer: VectorLayer) {\r\n    super();\r\n    this.layer = layer;\r\n    this.id = uuid();\r\n  }\r\n\r\n  protected watch() {\r\n    let olSource = this.layer.options.source.ol;\r\n    if (this.layer.dataSource instanceof ClusterDataSource) {\r\n      olSource = (this.layer.options.source.options as any).source;\r\n     }\r\n\r\n    if (olSource.getUrl()) {\r\n      olSource.on(`featuresloadstart`, e => this.handleLoadStart(e));\r\n      olSource.on(`featuresloadend`, e => this.handleLoadEnd(e));\r\n      olSource.on(`featuresloaderror`, e => this.handleLoadEnd(e));\r\n    }\r\n\r\n  }\r\n\r\n  protected unwatch() {\r\n    let olSource = this.layer.options.source.ol;\r\n    if (this.layer.dataSource instanceof ClusterDataSource) {\r\n      olSource = (this.layer.options.source.options as any).source;\r\n     }\r\n    if (olSource.getUrl()) {\r\n      olSource.un(`featuresloadstart`, e => this.handleLoadStart(e));\r\n      olSource.un(`featuresloadend`, e => this.handleLoadEnd(e));\r\n      olSource.un(`featuresloaderror`, e => this.handleLoadEnd(e));\r\n    }\r\n  }\r\n\r\n  private handleLoadStart(event: any) {\r\n    this.loading += 1;\r\n    this.status = SubjectStatus.Working;\r\n  }\r\n\r\n  private handleLoadEnd(event: any) {\r\n    this.loaded += 1;\r\n\r\n    const loading = this.loading;\r\n    if (this.loaded >= loading) {\r\n      if (loading === this.loading) {\r\n        this.status = SubjectStatus.Done;\r\n        this.loaded = this.loading = 0;\r\n      }\r\n    }\r\n  }\r\n}\r\n","import * as olproj from 'ol/proj';\r\nimport MapBrowserPointerEvent from 'ol/MapBrowserEvent';\r\nimport { MAC } from 'ol/has';\r\n\r\nimport { NumberUtils } from '@igo2/utils';\r\n\r\nimport { MapViewState } from './map.interface';\r\nimport { Projection } from './projection.interfaces';\r\n\r\n/**\r\n * This method extracts a coordinate tuple from a string.\r\n * @param str Any string\r\n * @param mapProjection string Map Projection\r\n * @param opts.forceNA boolean Force North America Zone\r\n * @returns object:\r\n *             lonLat: Coordinate,\r\n *             message: Message of error,\r\n *             radius: radius of the confience of coordinate,\r\n *             conf: confidence of the coordinate}\r\n */\r\nexport function stringToLonLat(\r\n  str: string,\r\n  mapProjection: string,\r\n  opts: { forceNA?: boolean } = {}\r\n): {\r\n  lonLat: [number, number] | undefined;\r\n  message: string;\r\n  radius: number | undefined;\r\n  conf: number | undefined;\r\n} {\r\n  let lonLat: [number, number];\r\n  let coordStr: string;\r\n  let negativeLon: string;\r\n  let degreesLon: string;\r\n  let minutesLon: string;\r\n  let secondsLon: string;\r\n  let directionLon: string;\r\n  let decimalLon: string;\r\n  let negativeLat: string;\r\n  let degreesLat: string;\r\n  let minutesLat: string;\r\n  let secondsLat: string;\r\n  let directionLat: string;\r\n  let decimalLat: string;\r\n  let zone: string;\r\n  let radius: string;\r\n  let conf: string;\r\n  let lon: any;\r\n  let lat: any;\r\n\r\n  const projectionPattern = '(\\\\s*;\\\\s*[\\\\d]{4,6})';\r\n  const toProjection = '4326';\r\n  let projectionStr: string;\r\n  const projectionRegex = new RegExp(projectionPattern, 'g');\r\n\r\n  const lonlatCoord = '([-+])?([\\\\d]{1,3})([,.](\\\\d+))?';\r\n  const lonLatPattern = `${lonlatCoord}[\\\\s,]+${lonlatCoord}`;\r\n  const lonLatRegex = new RegExp(`^${lonLatPattern}$`, 'g');\r\n\r\n  const dmsCoord =\r\n    '([0-9]{1,2})[:|]?\\\\s*([0-9]{1,2})?[:|\\'||]?\\\\s*([0-9]{1,2}(?:.[0-9]+){0,1})?\\\\s*[\"||]?\\\\s*';\r\n  const dmsCoordPattern = `${dmsCoord}([N|S|E|W|O]),?\\\\s*${dmsCoord}([N|S|E|W|O])`;\r\n  const dmsRegex = new RegExp(`^${dmsCoordPattern}$`, 'gi');\r\n\r\n  const patternUtm =\r\n    '(UTM)-?(\\\\d{1,2})[\\\\s,]*(\\\\d+[.,]?\\\\d+)[\\\\s,]+(\\\\d+[.,]?\\\\d+)';\r\n  const utmRegex = new RegExp(`^${patternUtm}`, 'gi');\r\n\r\n  const patternMtm =\r\n    '(MTM)-?(\\\\d{1,2})[\\\\s,]*(\\\\d+[.,]?\\\\d+)[\\\\s,]+(\\\\d+[.,]?\\\\d+)';\r\n  const mtmRegex = new RegExp(`^${patternMtm}`, 'gi');\r\n\r\n  const ddCoord = '([-+])?(\\\\d{1,3})[,.](\\\\d+)';\r\n  const patternDd = `${ddCoord}\\\\s*[,]?\\\\s*${ddCoord}`;\r\n  const ddRegex = new RegExp(`^${patternDd}`, 'g');\r\n\r\n  const dmdCoord =\r\n    '([-+])?(\\\\d{1,3})[\\\\s,.]{1}(\\\\d{1,2})[\\\\s,.]{1}(\\\\d{1,2})[.,]?(\\\\d{1,5})?';\r\n  const patternDmd = `${dmdCoord}\\\\s*[,.]?\\\\s*${dmdCoord}`;\r\n  const dmdRegex = new RegExp(`^${patternDmd}`, 'g');\r\n\r\n /* eslint-disable max-len */\r\n  const patternBELL =\r\n    'LAT\\\\s*[\\\\s:]*\\\\s*([-+])?(\\\\d{1,2})[\\\\s.,]?(\\\\d+)?[\\\\s.,]?\\\\s*(\\\\d{1,2}([.,]\\\\d+)?)?\\\\s*(N|S|E|W)?\\\\s*LONG\\\\s*[\\\\s:]*\\\\s*([-+])?(\\\\d{1,3})[\\\\s.,]?(\\\\d+)?[\\\\s.,]?\\\\s*(\\\\d{1,2}([.,]\\\\d+)?)?\\\\s*(N|S|E|W)?\\\\s*UNC\\\\s*[\\\\s:]?\\\\s*(\\\\d+)\\\\s*CONF\\\\s*[\\\\s:]?\\\\s*(\\\\d{1,3})';\r\n  const bellRegex = new RegExp(`^${patternBELL}?`, 'gi');\r\n\r\n  const mmCoord = '([-+]?\\\\d+)[,.]?(\\\\d+)?';\r\n  const mmPattern = `${mmCoord}[\\\\s,]+${mmCoord}`;\r\n  const mmRegex = new RegExp(`^${mmPattern}$`, 'g');\r\n\r\n  let isXYCoords = false;\r\n\r\n  str = str.toLocaleUpperCase().trim();\r\n\r\n  // Extract projection\r\n  if (projectionRegex.test(str)) {\r\n    [coordStr, projectionStr] = str.split(';').map(s => s.trim());\r\n  } else {\r\n    coordStr = str;\r\n  }\r\n  if (lonLatRegex.test(coordStr)) {\r\n    [\r\n      ,\r\n      negativeLon,\r\n      lon,\r\n      ,\r\n      decimalLon,\r\n      negativeLat,\r\n      lat,\r\n      ,\r\n      decimalLat\r\n    ] = coordStr.match(lonLatPattern);\r\n\r\n    lon = parseFloat((negativeLon ? negativeLon : '') + lon + '.' + decimalLon);\r\n    lat = parseFloat((negativeLat ? negativeLat : '') + lat + '.' + decimalLat);\r\n  } else if (dmsRegex.test(coordStr)) {\r\n    [\r\n      ,\r\n      degreesLon,\r\n      minutesLon,\r\n      secondsLon,\r\n      directionLon,\r\n      degreesLat,\r\n      minutesLat,\r\n      secondsLat,\r\n      directionLat\r\n    ] = coordStr.match(dmsCoordPattern);\r\n\r\n    if (directionLon === 'S' || directionLon === 'N') {\r\n      degreesLon = [degreesLat, (degreesLat = degreesLon)][0];\r\n      minutesLon = [minutesLat, (minutesLat = minutesLon)][0];\r\n      secondsLon = [secondsLat, (secondsLat = secondsLon)][0];\r\n      directionLon = [directionLat, (directionLat = directionLon)][0];\r\n    }\r\n\r\n    lon = convertDMSToDD(\r\n      parseFloat(degreesLon),\r\n      parseFloat(minutesLon),\r\n      parseFloat(secondsLon),\r\n      directionLon\r\n    );\r\n    lat = convertDMSToDD(\r\n      parseFloat(degreesLat),\r\n      parseFloat(minutesLat),\r\n      parseFloat(secondsLat),\r\n      directionLat\r\n    );\r\n  } else if (utmRegex.test(coordStr)) {\r\n    isXYCoords = true;\r\n    [, , zone, lon, lat] = coordStr.match(patternUtm);\r\n    const epsgUtm = Number(zone) < 10 ? `EPSG:3260${zone}` : `EPSG:326${zone}`;\r\n    [lon, lat] = olproj.transform(\r\n      [parseFloat(lon), parseFloat(lat)],\r\n      epsgUtm,\r\n      'EPSG:4326'\r\n    );\r\n  } else if (mtmRegex.test(coordStr)) {\r\n    isXYCoords = true;\r\n    [, , zone, lon, lat] = coordStr.match(patternMtm);\r\n    const epsgMtm =\r\n      Number(zone) < 10 ? `EPSG:3218${zone}` : `EPSG:321${80 + Number(zone)}`;\r\n    [lon, lat] = olproj.transform(\r\n      [parseFloat(lon), parseFloat(lat)],\r\n      epsgMtm,\r\n      'EPSG:4326'\r\n    );\r\n  } else if (dmdRegex.test(coordStr)) {\r\n    [\r\n      ,\r\n      negativeLon,\r\n      degreesLon,\r\n      minutesLon,\r\n      secondsLon,\r\n      decimalLon,\r\n      negativeLat,\r\n      degreesLat,\r\n      minutesLat,\r\n      secondsLat,\r\n      decimalLat\r\n    ] = coordStr.match(patternDmd);\r\n\r\n    lon = convertDMSToDD(\r\n      parseFloat((negativeLon ? negativeLon : '') + degreesLon),\r\n      parseFloat(minutesLon),\r\n      parseFloat(secondsLon),\r\n      directionLon\r\n    );\r\n    lat = convertDMSToDD(\r\n      parseFloat((negativeLat ? negativeLat : '') + degreesLat),\r\n      parseFloat(minutesLat),\r\n      parseFloat(secondsLat),\r\n      directionLat\r\n    );\r\n  } else if (ddRegex.test(coordStr)) {\r\n    [\r\n      ,\r\n      negativeLon,\r\n      degreesLon,\r\n      decimalLon,\r\n      negativeLat,\r\n      degreesLat,\r\n      decimalLat\r\n    ] = coordStr.match(patternDd);\r\n\r\n    lon = convertDMSToDD(\r\n      parseFloat((negativeLon ? negativeLon : '') + degreesLon),\r\n      parseFloat(minutesLon),\r\n      parseFloat(secondsLon),\r\n      directionLon\r\n    );\r\n    lat = convertDMSToDD(\r\n      parseFloat((negativeLat ? negativeLat : '') + degreesLat),\r\n      parseFloat(minutesLat),\r\n      parseFloat(secondsLat),\r\n      directionLat\r\n    );\r\n  } else if (bellRegex.test(coordStr)) {\r\n    [\r\n      ,\r\n      negativeLat,\r\n      degreesLat,\r\n      minutesLat,\r\n      secondsLat,\r\n      ,\r\n      directionLat,\r\n      negativeLon,\r\n      degreesLon,\r\n      minutesLon,\r\n      secondsLon,\r\n      ,\r\n      directionLon,\r\n      radius,\r\n      conf\r\n    ] = coordStr.match(patternBELL);\r\n\r\n    // Set default value for North America\r\n    if (!directionLon) {\r\n      directionLon = 'W';\r\n    }\r\n\r\n    // Check if real minutes or decimals\r\n    if (minutesLon && minutesLon.length > 2) {\r\n      lon = parseFloat(\r\n        (negativeLon ? negativeLon : '') + degreesLon + '.' + minutesLon\r\n      );\r\n    } else {\r\n      lon = convertDMSToDD(\r\n        parseFloat(degreesLon),\r\n        parseFloat(minutesLon),\r\n        parseFloat(secondsLon),\r\n        directionLon\r\n      );\r\n    }\r\n\r\n    if (minutesLat && minutesLat.length > 2) {\r\n      lat = parseFloat(\r\n        (negativeLat ? negativeLat : '') + degreesLat + '.' + minutesLat\r\n      );\r\n    } else {\r\n      lat = convertDMSToDD(\r\n        parseFloat(degreesLat),\r\n        parseFloat(minutesLat),\r\n        parseFloat(secondsLat),\r\n        directionLat\r\n      );\r\n    }\r\n  } else if (mmRegex.test(coordStr)) {\r\n    isXYCoords = true;\r\n    [, lon, decimalLon, lat, decimalLat] = coordStr.match(mmPattern);\r\n\r\n    if (decimalLon) {\r\n      lon = parseFloat(lon + '.' + decimalLon);\r\n    }\r\n\r\n    if (decimalLat) {\r\n      lat = parseFloat(lat + '.' + decimalLat);\r\n    }\r\n  } else {\r\n    return {\r\n      lonLat: undefined,\r\n      message: '',\r\n      radius: undefined,\r\n      conf: undefined\r\n    };\r\n  }\r\n\r\n  if (opts.forceNA && !isXYCoords) {\r\n    // Set a negative coordinate for North America zone\r\n    if (lon > 0 && lat > 0) {\r\n      if (lon > lat) {\r\n        lon = -lon;\r\n      } else {\r\n        lat = -lat;\r\n      }\r\n    }\r\n\r\n    // Reverse coordinate to respect lonLat convention\r\n    if (lon > lat) {\r\n      lon = [lat, (lat = lon)][0];\r\n    }\r\n  }\r\n\r\n  lonLat = [Number(lon), Number(lat)] as [number, number];\r\n\r\n  // Reproject the coordinate if projection parameter have been set and coord is not 4326\r\n  if (\r\n    (projectionStr !== undefined && projectionStr !== toProjection) ||\r\n    (lonLat[0] > 180 || lonLat[0] < -180) ||\r\n    (lonLat[1] > 90 || lonLat[1] < -90)\r\n  ) {\r\n    const source = projectionStr ? 'EPSG:' + projectionStr : mapProjection;\r\n    const dest = 'EPSG:' + toProjection;\r\n\r\n    try {\r\n      lonLat = olproj.transform(lonLat, source, dest) as [number, number];\r\n    } catch (e) {\r\n      return {\r\n        lonLat: undefined,\r\n        message: 'Projection ' + source + ' not supported',\r\n        radius: undefined,\r\n        conf: undefined\r\n      };\r\n    }\r\n  }\r\n  if (Math.abs(lonLat[0]) <= 180 && Math.abs(lonLat[1]) <= 90) {\r\n    return {\r\n      lonLat,\r\n      message: '',\r\n      radius: radius ? parseInt(radius, 10) : undefined,\r\n      conf: conf ? parseInt(conf, 10) : undefined\r\n    };\r\n  } else {\r\n    return {\r\n      lonLat: undefined,\r\n      message: 'Coordinate out of Longitude/Latitude bounds',\r\n      radius: undefined,\r\n      conf: undefined\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Convert degrees minutes seconds to dd\r\n * @param degrees Degrees\r\n * @param minutes Minutes\r\n * @param seconds Seconds\r\n * @param direction Direction\r\n */\r\nfunction convertDMSToDD(\r\n  degrees: number,\r\n  minutes: number,\r\n  seconds: number,\r\n  direction: string\r\n) {\r\n  minutes = minutes || 0;\r\n  seconds = seconds || 0;\r\n\r\n  const neg = degrees < 0;\r\n  let dd = Math.abs(degrees) + minutes / 60 + seconds / 3600;\r\n\r\n  if (neg || direction === 'S' || direction === 'W') {\r\n    dd = -dd;\r\n  } // Don't do anything for N or E\r\n  return dd;\r\n}\r\n\r\n/**\r\n * Convert dd to degrees minutes seconds\r\n * @param lonLatDD longitude and latitude in dd\r\n * @param decimal number of decimals for seconds\r\n * @returns longitude and latitude in dms\r\n */\r\nexport function convertDDToDMS(\r\n  lonLatDD: [number, number], decimal: number = 3\r\n): string[] {\r\n  const lonLatDMS = [];\r\n\r\n  lonLatDD.forEach(dd => {\r\n    const degrees = dd < 0 ? Math.ceil(dd) : Math.floor(dd);\r\n    const int = dd < 0 ? (degrees - dd) * 60 : (dd - degrees) * 60;\r\n    const minutes = Math.floor(int);\r\n    const seconds = ((int - minutes) * 60).toFixed(decimal);\r\n\r\n    lonLatDMS.push(`${degrees} ${minutes}' ${seconds}\"`);\r\n  });\r\n  return lonLatDMS;\r\n}\r\n\r\n/**\r\n * Return true of two view states are equal.\r\n * @param state1 View state\r\n * @param state2 View state\r\n * @returns True if the view states are equal\r\n */\r\nexport function viewStatesAreEqual(\r\n  state1: MapViewState,\r\n  state2: MapViewState\r\n): boolean {\r\n  if (state1 === undefined || state2 === undefined) {\r\n    return false;\r\n  }\r\n\r\n  const tolerance = 1 / 10000;\r\n  return (\r\n    state1.zoom === state2.zoom &&\r\n    Math.trunc(state1.center[0] / tolerance) ===\r\n      Math.trunc(state2.center[0] / tolerance) &&\r\n    Math.trunc(state1.center[1] / tolerance) ===\r\n      Math.trunc(state2.center[1] / tolerance)\r\n  );\r\n}\r\n\r\n/**\r\n * Format the scale to a human readable text\r\n * @param Scale of the map\r\n * @returns Human readable scale text\r\n */\r\nexport function formatScale(scale) {\r\n  scale = Math.round(scale);\r\n  if (scale < 10000) {\r\n    return scale + '';\r\n  }\r\n\r\n  scale = Math.round(scale / 1000);\r\n  if (scale < 1000) {\r\n    return scale + 'K';\r\n  }\r\n\r\n  scale = Math.round(scale / 1000);\r\n  return scale + 'M';\r\n}\r\n\r\n/**\r\n * Return the resolution from a scale denom\r\n * @param scale Scale denom\r\n * @param dpi DPI\r\n * @returns Resolution\r\n */\r\nexport function getResolutionFromScale(\r\n  scale: number,\r\n  dpi: number = 96\r\n): number {\r\n  const inchesPerMeter = 39.3701;\r\n  return scale / (inchesPerMeter * dpi);\r\n}\r\n\r\n/**\r\n * Return the resolution from a scale denom\r\n * @param Scale denom\r\n * @returns Resolution\r\n */\r\nexport function getScaleFromResolution(\r\n  resolution: number,\r\n  unit: string = 'm',\r\n  dpi: number = 96\r\n): number {\r\n  const inchesPerMeter = 39.3701;\r\n  return resolution * olproj.METERS_PER_UNIT[unit] * inchesPerMeter * dpi;\r\n}\r\n\r\n/**\r\n * Returns true if the CTRL key is pushed during an Ol MapBrowserPointerEvent\r\n * @param event OL MapBrowserPointerEvent\r\n * @returns Whether the CTRL key is pushed\r\n */\r\nexport function ctrlKeyDown(event: MapBrowserPointerEvent<any>): boolean {\r\n  const originalEvent = event.originalEvent;\r\n  return (\r\n    !originalEvent.altKey &&\r\n    (MAC ? originalEvent.metaKey : originalEvent.ctrlKey) &&\r\n    !originalEvent.shiftKey\r\n  );\r\n}\r\n\r\nexport function roundCoordTo(coord: [number, number], decimal: number = 3): [number, number] {\r\n  return [\r\n    NumberUtils.roundToNDecimal(coord[0], decimal),\r\n    NumberUtils.roundToNDecimal(coord[1], decimal)] as [number, number];\r\n}\r\n\r\n/**\r\n * Returns an array of converted coordinates.\r\n * Conversion is done for every configured projections\r\n * and for the current UTM zone and MTM zone.\r\n * @param lonLat [number, number] array of the coordinate to transform.\r\n * @param projections  Projection[] Array of destination projection.\r\n * @returns Returns an array of converted coordinates.\r\n */\r\nexport function lonLatConversion(\r\n  lonLat: [number, number],\r\n  projections: Projection[]\r\n): {\r\n  code: string;\r\n  alias: string;\r\n  coord: [number, number];\r\n  igo2CoordFormat: string;\r\n}[] {\r\n  const rawCoord3857 = olproj.transform(lonLat, 'EPSG:4326', 'EPSG:3857') as [number, number];\r\n  const convertedLonLat = [\r\n    {\r\n      code: 'EPSG:3857',\r\n      alias: 'Web Mercator',\r\n      coord: rawCoord3857,\r\n      igo2CoordFormat: `${roundCoordTo(rawCoord3857).join(', ')} ; 3857`\r\n    }\r\n  ];\r\n\r\n  // detect the current utm zone.\r\n  const utmZone = utmZoneFromLonLat(lonLat);\r\n  const epsgUtm = utmZone < 10 ? `EPSG:3260${utmZone}` : `EPSG:326${utmZone}`;\r\n  const utmName = `UTM-${utmZone}`;\r\n  const rawCoordUtm = olproj.transform(lonLat, 'EPSG:4326', epsgUtm) as [number, number];\r\n  convertedLonLat.push({\r\n    code: epsgUtm,\r\n    alias: 'UTM',\r\n    coord: rawCoordUtm,\r\n    igo2CoordFormat: `${utmName} ${roundCoordTo(rawCoordUtm).join(', ')}`\r\n  });\r\n\r\n  // detect the current mtm zone.\r\n  const mtmZone = mtmZoneFromLonLat(lonLat);\r\n  if (mtmZone) {\r\n    const epsgMtm =\r\n      mtmZone < 10 ? `EPSG:3218${mtmZone}` : `EPSG:321${80 + mtmZone}`;\r\n    const mtmName = `MTM-${mtmZone}`;\r\n    const rawCoordMtm = olproj.transform(lonLat, 'EPSG:4326', epsgMtm) as [number, number];\r\n    convertedLonLat.push({\r\n      code: epsgMtm,\r\n      alias: 'MTM',\r\n      coord: rawCoordMtm,\r\n      igo2CoordFormat: `${mtmName} ${roundCoordTo(rawCoordMtm).join(', ')}`\r\n    });\r\n  }\r\n\r\n  projections.forEach(projection => {\r\n    const rawCoord = olproj.transform(lonLat, 'EPSG:4326', projection.code) as [number, number];\r\n    const numericEpsgCode = projection.code.split(':')[1];\r\n    convertedLonLat.push({\r\n      code: projection.code,\r\n      alias: projection.alias || projection.code,\r\n      coord: rawCoord,\r\n      igo2CoordFormat: `${roundCoordTo(rawCoord).join(\r\n        ', '\r\n      )} ; ${numericEpsgCode}`\r\n    });\r\n  });\r\n\r\n  return convertedLonLat;\r\n}\r\n\r\n/**\r\n * Detect the current utm zone of the lon/lat coordinate.\r\n * @param lonLat [number, number] array of the coordinate to detect the UTM zone.\r\n * @returns number The UTM zone.\r\n */\r\nexport function utmZoneFromLonLat(lonLat: [number, number]) {\r\n  return Math.ceil((lonLat[0] + 180) / 6);\r\n}\r\n\r\n/**\r\n * Detect the current mtm zone of the lon/lat coordinate.\r\n * @param lonLat [number, number] array of the coordinate to detect the MTM zone.\r\n * @returns number The MTM zone. Undefined if outside of the mtm application zone.\r\n */\r\nexport function mtmZoneFromLonLat(lonLat: [number, number]) {\r\n  const long = lonLat[0];\r\n  let mtmZone;\r\n  if (long < -51 && long > -54) {\r\n    mtmZone = 1;\r\n  }\r\n  if (long < -54 && long > -57) {\r\n    mtmZone = 2;\r\n  }\r\n  if (long < -57 && long > -60) {\r\n    mtmZone = 3;\r\n  }\r\n  if (long < -60 && long > -63) {\r\n    mtmZone = 4;\r\n  }\r\n  if (long < -63 && long > -66) {\r\n    mtmZone = 5;\r\n  }\r\n  if (long < -66 && long > -69) {\r\n    mtmZone = 6;\r\n  }\r\n  if (long < -69 && long > -72) {\r\n    mtmZone = 7;\r\n  }\r\n  if (long < -72 && long > -75) {\r\n    mtmZone = 8;\r\n  }\r\n  if (long < -75 && long > -78) {\r\n    mtmZone = 9;\r\n  }\r\n  if (long < -78 && long > -81) {\r\n    mtmZone = 10;\r\n  }\r\n  return mtmZone;\r\n}\r\n","import {\r\n  BehaviorSubject,\r\n  Observable,\r\n  Subject,\r\n  Subscription,\r\n  combineLatest\r\n} from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport olLayer from 'ol/layer/Layer';\r\nimport olSource from 'ol/source/Source';\r\n\r\nimport { AuthInterceptor } from '@igo2/auth';\r\nimport { SubjectStatus } from '@igo2/utils';\r\n\r\nimport { DataSource, Legend } from '../../../datasource';\r\nimport { IgoMap } from '../../../map/shared/map';\r\nimport { getResolutionFromScale } from '../../../map/shared/map.utils';\r\n\r\nimport { LayerOptions } from './layer.interface';\r\nimport { Message, MessageService } from '@igo2/core';\r\n\r\nexport abstract class Layer {\r\n  public collapsed: boolean;\r\n  public dataSource: DataSource;\r\n  public legend: Legend[];\r\n  public legendCollapsed: boolean = true;\r\n  public firstLoadComponent: boolean = true;\r\n  public map: IgoMap;\r\n  public ol: olLayer<olSource>;\r\n  public olLoadingProblem: boolean = false;\r\n  public status$: Subject<SubjectStatus>;\r\n  public hasBeenVisible$: BehaviorSubject<boolean> = new BehaviorSubject(undefined);\r\n  private hasBeenVisible$$: Subscription;\r\n  private resolution$$: Subscription;\r\n\r\n  /**\r\n   * Define if a layer is generated by code OR defined by layer/context user layer.\r\n   * Useful for filtering layers list in mapOffline.directive or in the sharemap...\r\n   * return false by default.\r\n   */\r\n  get isIgoInternalLayer(): boolean {\r\n    return this.options.isIgoInternalLayer || false;\r\n  }\r\n\r\n  get id(): string {\r\n    return this.options.id || this.dataSource.id;\r\n  }\r\n\r\n  get alias(): string {\r\n    return this.options.alias;\r\n  }\r\n\r\n  get title(): string {\r\n    return this.options.title;\r\n  }\r\n\r\n  set title(title: string) {\r\n    this.options.title = title;\r\n  }\r\n\r\n  get zIndex(): number {\r\n    return this.ol.getZIndex();\r\n  }\r\n\r\n  set zIndex(zIndex: number) {\r\n    this.ol.setZIndex(zIndex);\r\n  }\r\n\r\n  get baseLayer(): boolean {\r\n    return this.options.baseLayer;\r\n  }\r\n\r\n  set baseLayer(baseLayer: boolean) {\r\n    this.options.baseLayer = baseLayer;\r\n  }\r\n\r\n  get opacity(): number {\r\n    return this.ol.get('opacity');\r\n  }\r\n\r\n  set opacity(opacity: number) {\r\n    this.ol.setOpacity(opacity);\r\n  }\r\n\r\n  set isInResolutionsRange(value: boolean) {\r\n    this.isInResolutionsRange$.next(value);\r\n  }\r\n  get isInResolutionsRange(): boolean {\r\n    return this.isInResolutionsRange$.value;\r\n  }\r\n  readonly isInResolutionsRange$: BehaviorSubject<\r\n    boolean\r\n  > = new BehaviorSubject(false);\r\n\r\n  set maxResolution(value: number) {\r\n    this.ol.setMaxResolution(value || Infinity);\r\n    this.updateInResolutionsRange();\r\n  }\r\n  get maxResolution(): number {\r\n    return this.ol.getMaxResolution();\r\n  }\r\n\r\n  set minResolution(value: number) {\r\n    this.ol.setMinResolution(value || 0);\r\n    this.updateInResolutionsRange();\r\n  }\r\n  get minResolution(): number {\r\n    return this.ol.getMinResolution();\r\n  }\r\n\r\n  set visible(value: boolean) {\r\n    this.ol.setVisible(value);\r\n    this.visible$.next(value);\r\n    if (!this.hasBeenVisible$.value && value){\r\n      this.hasBeenVisible$.next(value);\r\n    }\r\n    if (this.options?.messages && value) {\r\n      this.options?.messages\r\n        .filter(m => m.options?.showOnEachLayerVisibility)\r\n        .map(message =>\r\n          this.showMessage(message)\r\n        );\r\n    }\r\n  }\r\n  get visible(): boolean {\r\n    return this.visible$.value;\r\n  }\r\n  readonly visible$: BehaviorSubject<boolean> = new BehaviorSubject(undefined);\r\n\r\n  get displayed(): boolean {\r\n    return this.visible && this.isInResolutionsRange;\r\n  }\r\n  readonly displayed$: Observable<boolean> = combineLatest([\r\n    this.isInResolutionsRange$,\r\n    this.visible$\r\n  ]).pipe(map((bunch: [boolean, boolean]) => bunch[0] && bunch[1]));\r\n\r\n  get showInLayerList(): boolean {\r\n    return this.options.showInLayerList !== false;\r\n  }\r\n\r\n\r\n  constructor(\r\n    public options: LayerOptions,\r\n    protected messageService?: MessageService,\r\n    protected authInterceptor?: AuthInterceptor\r\n  ) {\r\n    this.dataSource = options.source;\r\n\r\n    this.ol = this.createOlLayer();\r\n    if (options.zIndex !== undefined) {\r\n      this.zIndex = options.zIndex;\r\n    }\r\n\r\n    if (options.baseLayer && options.visible === undefined) {\r\n      options.visible = false;\r\n    }\r\n\r\n    this.maxResolution = options.maxResolution || getResolutionFromScale(Number(options.maxScaleDenom));\r\n    this.minResolution = options.minResolution || getResolutionFromScale(Number(options.minScaleDenom));\r\n\r\n    this.visible = options.visible === undefined ? true : options.visible;\r\n    this.opacity = options.opacity === undefined ? 1 : options.opacity;\r\n\r\n    if (\r\n      options.legendOptions &&\r\n      (options.legendOptions.url || options.legendOptions.html)\r\n    ) {\r\n      this.legend = this.dataSource.setLegend(options.legendOptions);\r\n    }\r\n\r\n    this.legendCollapsed = options.legendOptions\r\n      ? options.legendOptions.collapsed\r\n        ? options.legendOptions.collapsed\r\n        : true\r\n      : true;\r\n\r\n    this.ol.set('_layer', this, true);\r\n  }\r\n\r\n  protected abstract createOlLayer(): olLayer<olSource>;\r\n\r\n  setMap(igoMap: IgoMap | undefined) {\r\n    this.map = igoMap;\r\n\r\n    this.unobserveResolution();\r\n    if (igoMap !== undefined) {\r\n      this.observeResolution();\r\n      this.hasBeenVisible$$ = this.hasBeenVisible$.subscribe(() => {\r\n        if (this.options.messages && this.visible) {\r\n          this.options.messages.map(message => {\r\n            this.showMessage(message);\r\n          });\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  private showMessage(message: Message) {\r\n    if (!this.messageService) {\r\n      return;\r\n    }\r\n    message.title = message.title;\r\n    message.text = message.text;\r\n    this.messageService.message(message as Message);\r\n  }\r\n\r\n  private observeResolution() {\r\n    this.resolution$$ = this.map.viewController.resolution$.subscribe(() =>\r\n      this.updateInResolutionsRange()\r\n    );\r\n  }\r\n\r\n  private unobserveResolution() {\r\n    if (this.resolution$$ !== undefined) {\r\n      this.resolution$$.unsubscribe();\r\n      this.resolution$$ = undefined;\r\n    }\r\n  }\r\n\r\n  private updateInResolutionsRange() {\r\n    if (this.map !== undefined) {\r\n      const resolution = this.map.viewController.getResolution();\r\n      const minResolution = this.minResolution;\r\n      const maxResolution = this.maxResolution === undefined ? Infinity : this.maxResolution;\r\n      this.isInResolutionsRange = resolution >= minResolution && resolution <= maxResolution;\r\n    } else {\r\n      this.isInResolutionsRange = false;\r\n    }\r\n  }\r\n}\r\n","export enum OgcFilterOperatorType {\r\n    BasicNumericOperator = 'basicnumericoperator',\r\n    Basic = 'basic',\r\n    BasicAndSpatial = 'basicandspatial',\r\n    Spatial = 'spatial',\r\n    All = 'all',\r\n    Time = 'time'\r\n}\r\n\r\nexport enum OgcFilterOperator {\r\n    BBOX = 'BBox',\r\n    PropertyIsBetween = 'PropertyIsBetween',\r\n    Contains = 'Contains',\r\n    During = 'During',\r\n    PropertyIsEqualTo = 'PropertyIsEqualTo',\r\n    PropertyIsGreaterThan = 'PropertyIsGreaterThan',\r\n    PropertyIsGreaterThanOrEqualTo = 'PropertyIsGreaterThanOrEqualTo',\r\n    Intersects = 'Intersects',\r\n    PropertyIsNull = 'PropertyIsNull',\r\n    PropertyIsLessThan = 'PropertyIsLessThan',\r\n    PropertyIsLessThanOrEqualTo = 'PropertyIsLessThanOrEqualTo',\r\n    PropertyIsLike = 'PropertyIsLike',\r\n    PropertyIsNotEqualTo = 'PropertyIsNotEqualTo',\r\n    Within = 'Within',\r\n    And = 'And',\r\n    Or = 'Or',\r\n    Not = 'Not'\r\n}\r\n","import * as olfilter from 'ol/format/filter';\r\nimport olFormatWKT from 'ol/format/WKT';\r\nimport olFormatWFS, { WriteGetFeatureOptions } from 'ol/format/WFS';\r\nimport olGeometry from 'ol/geom/Geometry';\r\n\r\nimport olProjection from 'ol/proj/Projection';\r\n\r\nimport { uuid, ObjectUtils } from '@igo2/utils';\r\n\r\nimport {\r\n  OgcFilter,\r\n  IgoOgcFilterObject,\r\n  AnyBaseOgcFilterOptions,\r\n  OgcInterfaceFilterOptions,\r\n  OgcFilterableDataSourceOptions,\r\n  OgcFiltersOptions,\r\n  IgoOgcSelector,\r\n  SelectorGroup,\r\n  OgcSelectorBundle\r\n} from './ogc-filter.interface';\r\nimport { OgcFilterOperatorType, OgcFilterOperator } from './ogc-filter.enum';\r\nimport { SourceFieldsOptionsParams } from '../../datasource/shared/datasources/datasource.interface';\r\nimport { default as moment } from 'moment';\r\nexport class OgcFilterWriter {\r\n  private filterSequence: OgcInterfaceFilterOptions[] = [];\r\n  public operators = {\r\n    [OgcFilterOperator.PropertyIsEqualTo as string]: {\r\n      spatial: false,\r\n      fieldRestrict: []\r\n    },\r\n    [OgcFilterOperator.PropertyIsNotEqualTo as string]: {\r\n      spatial: false,\r\n      fieldRestrict: []\r\n    },\r\n    [OgcFilterOperator.PropertyIsLike as string]: {\r\n      spatial: false,\r\n      fieldRestrict: ['string']\r\n    },\r\n    [OgcFilterOperator.PropertyIsGreaterThan as string]: {\r\n      spatial: false,\r\n      fieldRestrict: ['number']\r\n    },\r\n    [OgcFilterOperator.PropertyIsGreaterThanOrEqualTo as string]: {\r\n      spatial: false,\r\n      fieldRestrict: ['number']\r\n    },\r\n    [OgcFilterOperator.PropertyIsLessThan as string]: {\r\n      spatial: false,\r\n      fieldRestrict: ['number']\r\n    },\r\n    [OgcFilterOperator.PropertyIsLessThanOrEqualTo as string]: {\r\n      spatial: false,\r\n      fieldRestrict: ['number']\r\n    },\r\n    [OgcFilterOperator.PropertyIsBetween as string]: {\r\n      spatial: false,\r\n      fieldRestrict: ['number']\r\n    },\r\n    [OgcFilterOperator.During as string]: { spatial: false, fieldRestrict: [] },\r\n    [OgcFilterOperator.PropertyIsNull as string]: {\r\n      spatial: false,\r\n      fieldRestrict: []\r\n    },\r\n    [OgcFilterOperator.Intersects as string]: {\r\n      spatial: true,\r\n      fieldRestrict: []\r\n    },\r\n    [OgcFilterOperator.Within as string]: { spatial: true, fieldRestrict: [] },\r\n    [OgcFilterOperator.Contains as string]: { spatial: true, fieldRestrict: [] }\r\n  };\r\n\r\n  defineOgcFiltersDefaultOptions(\r\n    ogcFiltersOptions: OgcFiltersOptions,\r\n    fieldNameGeometry: string,\r\n    srcType?: string\r\n  ): OgcFiltersOptions {\r\n    let ogcFiltersDefaultValue = true; // default values for wfs.\r\n    if (srcType && srcType === 'wms') {\r\n      ogcFiltersDefaultValue = false;\r\n    }\r\n\r\n    ogcFiltersOptions = ogcFiltersOptions || {};\r\n    ogcFiltersOptions.enabled =\r\n      ogcFiltersOptions.enabled === undefined\r\n        ? ogcFiltersDefaultValue\r\n        : ogcFiltersOptions.enabled;\r\n    ogcFiltersOptions.editable =\r\n      ogcFiltersOptions.editable === undefined\r\n        ? ogcFiltersDefaultValue\r\n        : ogcFiltersOptions.editable;\r\n    ogcFiltersOptions.geometryName = fieldNameGeometry;\r\n\r\n    ogcFiltersOptions.advancedOgcFilters = true;\r\n    if (ogcFiltersOptions.enabled && (ogcFiltersOptions.pushButtons || ogcFiltersOptions.checkboxes\r\n      || ogcFiltersOptions.radioButtons || ogcFiltersOptions.select || ogcFiltersOptions.autocomplete)) {\r\n      ogcFiltersOptions.advancedOgcFilters = false;\r\n    }\r\n    return ogcFiltersOptions;\r\n  }\r\n\r\n  public buildFilter(\r\n    filters?: IgoOgcFilterObject,\r\n    extent?: [number, number, number, number],\r\n    proj?: olProjection,\r\n    fieldNameGeometry?: string,\r\n    options?: OgcFilterableDataSourceOptions\r\n  ): string {\r\n    let ourBboxFilter;\r\n    let enableBbox: boolean;\r\n    if (/intersects|contains|within/gi.test(JSON.stringify(filters))) {\r\n      enableBbox = false;\r\n    } else {\r\n      enableBbox = true;\r\n    }\r\n    if (filters) {\r\n      fieldNameGeometry =\r\n        (filters as any).geometryName !== undefined\r\n          ? (filters as any).geometryName\r\n          : fieldNameGeometry;\r\n    }\r\n    if (extent && filters) {\r\n      ourBboxFilter = olfilter.bbox(fieldNameGeometry, extent, proj.getCode());\r\n    }\r\n    let filterAssembly: OgcFilter;\r\n    if (filters) {\r\n      filters = this.checkIgoFiltersProperties(\r\n        filters,\r\n        fieldNameGeometry,\r\n        proj\r\n      );\r\n      if (extent && enableBbox) {\r\n        filterAssembly = olfilter.and(\r\n          ourBboxFilter,\r\n          this.bundleFilter(filters, options)\r\n        );\r\n      } else {\r\n        filterAssembly = this.bundleFilter(filters, options);\r\n      }\r\n    } else {\r\n      return 'bbox=' + extent.join(',') + ',' + proj.getCode();\r\n    }\r\n\r\n    const wfsOptions: WriteGetFeatureOptions = {\r\n      srsName: '',\r\n      featureNS: '',\r\n      featurePrefix: '',\r\n      featureTypes: ['featureTypes'],\r\n      filter: filterAssembly,\r\n      outputFormat: '',\r\n      geometryName: fieldNameGeometry\r\n    };\r\n\r\n    const query = new olFormatWFS().writeGetFeature(wfsOptions);\r\n    const str = new XMLSerializer().serializeToString(query);\r\n    const regexp1 = /typenames *=|typename *=\\\"featureTypes\\\" *>/gi;\r\n    const regexp2 = /<\\/Query><\\/GetFeature>/gi;\r\n\r\n    return 'filter=' + str.split(regexp1)[1].split(regexp2)[0];\r\n  }\r\n\r\n  private bundleFilter(\r\n    filterObject: any,\r\n    options?: OgcFilterableDataSourceOptions\r\n  ) {\r\n    if (filterObject instanceof Array) {\r\n      const logicalArray = [];\r\n      filterObject.forEach((element) => {\r\n        logicalArray.push(this.bundleFilter(element, options));\r\n      });\r\n      return logicalArray;\r\n    } else {\r\n      if (filterObject.hasOwnProperty('logical')) {\r\n        return this.createFilter(\r\n          {\r\n            operator: filterObject.logical,\r\n            logicalArray: this.bundleFilter(filterObject.filters, options)\r\n          },\r\n          options\r\n        );\r\n      } else if (filterObject.hasOwnProperty('operator')) {\r\n        return this.createFilter(\r\n          filterObject as AnyBaseOgcFilterOptions,\r\n          options\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  private createFilter(\r\n    filterOptions,\r\n    options?: OgcFilterableDataSourceOptions\r\n  ): OgcFilter {\r\n    const operator = filterOptions.operator;\r\n    const logicalArray = filterOptions.logicalArray;\r\n\r\n    const wfsPropertyName = filterOptions.propertyName;\r\n    const wfsPattern = filterOptions.pattern;\r\n    const wfsMatchCase = filterOptions.matchCase\r\n      ? filterOptions.matchCase\r\n      : true;\r\n    const wfsWildCard = filterOptions.wildCard ? filterOptions.wildCard : '*';\r\n    const wfsSingleChar = filterOptions.singleChar\r\n      ? filterOptions.singleChar\r\n      : '.';\r\n    const wfsEscapeChar = filterOptions.escapeChar\r\n      ? filterOptions.escapeChar\r\n      : '!';\r\n\r\n    const wfsLowerBoundary = filterOptions.lowerBoundary;\r\n    const wfsUpperBoundary = filterOptions.upperBoundary;\r\n\r\n    const wfsGeometryName = filterOptions.geometryName;\r\n    const wfsExtent = filterOptions.extent;\r\n    const wfsWktGeometry = filterOptions.wkt_geometry;\r\n    const wfsSrsName = filterOptions.srsName\r\n      ? filterOptions.srsName\r\n      : 'EPSG:3857';\r\n\r\n    const wfsBegin = this.parseFilterOptionDate(\r\n      filterOptions.begin,\r\n      options ? options.minDate : undefined\r\n    );\r\n    const wfsEnd = this.parseFilterOptionDate(\r\n      filterOptions.end,\r\n      options ? options.maxDate : undefined\r\n    );\r\n\r\n    const wfsExpression = filterOptions.expression;\r\n\r\n    let geometry: olGeometry;\r\n    if (wfsWktGeometry) {\r\n      const wkt = new olFormatWKT();\r\n      geometry = wkt.readGeometry(wfsWktGeometry, {\r\n        dataProjection: wfsSrsName,\r\n        featureProjection: wfsSrsName || 'EPSG:3857'\r\n      });\r\n    }\r\n\r\n    switch (operator.toLowerCase()) {\r\n      case OgcFilterOperator.BBOX.toLowerCase():\r\n        return olfilter.bbox(wfsGeometryName, wfsExtent, wfsSrsName);\r\n      case OgcFilterOperator.PropertyIsBetween.toLowerCase():\r\n        return olfilter.between(\r\n          wfsPropertyName,\r\n          wfsLowerBoundary || 1e40*-1,\r\n          wfsUpperBoundary || 1e40\r\n        );\r\n      case OgcFilterOperator.Contains.toLowerCase():\r\n        return olfilter.contains(wfsGeometryName, geometry, wfsSrsName);\r\n      case OgcFilterOperator.During.toLowerCase():\r\n        return olfilter.during(wfsPropertyName, wfsBegin, wfsEnd);\r\n      case OgcFilterOperator.PropertyIsEqualTo.toLowerCase():\r\n        return olfilter.equalTo(wfsPropertyName, wfsExpression, wfsMatchCase);\r\n      case OgcFilterOperator.PropertyIsGreaterThan.toLowerCase():\r\n        return olfilter.greaterThan(wfsPropertyName, wfsExpression);\r\n      case OgcFilterOperator.PropertyIsGreaterThanOrEqualTo.toLowerCase():\r\n        return olfilter.greaterThanOrEqualTo(wfsPropertyName, wfsExpression);\r\n      case OgcFilterOperator.Intersects.toLowerCase():\r\n        return olfilter.intersects(wfsGeometryName, geometry, wfsSrsName);\r\n      case OgcFilterOperator.PropertyIsNull.toLowerCase():\r\n        return olfilter.isNull(wfsPropertyName);\r\n      case OgcFilterOperator.PropertyIsLessThan.toLowerCase():\r\n        return olfilter.lessThan(wfsPropertyName, wfsExpression);\r\n      case OgcFilterOperator.PropertyIsLessThanOrEqualTo.toLowerCase():\r\n        return olfilter.lessThanOrEqualTo(wfsPropertyName, wfsExpression);\r\n      case OgcFilterOperator.PropertyIsLike.toLowerCase():\r\n        return olfilter.like(\r\n          wfsPropertyName,\r\n          wfsPattern ? wfsPattern.replace(/[()_]/gi, wfsSingleChar): wfsWildCard,\r\n          wfsWildCard,\r\n          wfsSingleChar,\r\n          wfsEscapeChar,\r\n          wfsMatchCase\r\n        );\r\n      case OgcFilterOperator.PropertyIsNotEqualTo.toLowerCase():\r\n        return olfilter.notEqualTo(\r\n          wfsPropertyName,\r\n          wfsExpression,\r\n          wfsMatchCase\r\n        );\r\n      case OgcFilterOperator.Within.toLowerCase():\r\n        return olfilter.within(wfsGeometryName, geometry, wfsSrsName);\r\n      // LOGICAL\r\n      case OgcFilterOperator.And.toLowerCase():\r\n        return olfilter.and.apply(null, logicalArray);\r\n      case OgcFilterOperator.Or.toLowerCase():\r\n        return olfilter.or.apply(null, logicalArray);\r\n      case OgcFilterOperator.Not.toLowerCase():\r\n        return olfilter.not.apply(null, logicalArray);\r\n\r\n      default:\r\n        return undefined;\r\n    }\r\n  }\r\n\r\n  public defineInterfaceFilterSequence(\r\n    filterObject: any,\r\n    geometryName,\r\n    logical = '',\r\n    level = -1\r\n  ): OgcInterfaceFilterOptions[] {\r\n    if (filterObject instanceof Array) {\r\n      filterObject.forEach((element) => {\r\n        this.filterSequence.concat(\r\n          this.defineInterfaceFilterSequence(\r\n            element,\r\n            geometryName,\r\n            logical,\r\n            level\r\n          )\r\n        );\r\n      });\r\n    } else {\r\n      if (filterObject.hasOwnProperty('logical')) {\r\n        level = level + 1;\r\n        this.filterSequence.concat(\r\n          this.defineInterfaceFilterSequence(\r\n            filterObject.filters,\r\n            geometryName,\r\n            filterObject.logical,\r\n            level\r\n          )\r\n        );\r\n      } else if (filterObject.hasOwnProperty('operator')) {\r\n        this.filterSequence.push(\r\n          this.addInterfaceFilter(filterObject, geometryName, level, logical)\r\n        );\r\n      }\r\n    }\r\n    return this.filterSequence;\r\n  }\r\n\r\n  public computeAllowedOperators(\r\n    fields?: SourceFieldsOptionsParams[],\r\n    propertyName?: string,\r\n    defaultOperatorsType?: OgcFilterOperatorType\r\n  ) {\r\n    let effectiveOperators: {} = {};\r\n    let allowedOperators;\r\n    let fieldsHasSpatialOperator: boolean;\r\n    let includeContains: boolean;\r\n\r\n    if (fields && propertyName) {\r\n      const srcField = fields.find((field) => field.name === propertyName);\r\n      allowedOperators =\r\n        srcField && srcField.allowedOperatorsType\r\n          ? srcField.allowedOperatorsType\r\n          : defaultOperatorsType;\r\n    }\r\n\r\n    if (fields) {\r\n      fields.map((field) => {\r\n        if (!field.allowedOperatorsType) {\r\n          return;\r\n        }\r\n        const allowedOperatorsType = field.allowedOperatorsType.toLowerCase();\r\n        if (\r\n          allowedOperatorsType === OgcFilterOperatorType.All.toLowerCase() ||\r\n          allowedOperatorsType ===\r\n            OgcFilterOperatorType.Spatial.toLowerCase() ||\r\n          allowedOperatorsType ===\r\n            OgcFilterOperatorType.BasicAndSpatial.toLowerCase()\r\n        ) {\r\n          fieldsHasSpatialOperator = true;\r\n          if (\r\n            allowedOperatorsType === OgcFilterOperatorType.All.toLowerCase()\r\n          ) {\r\n            includeContains = true;\r\n          }\r\n        }\r\n      });\r\n    }\r\n\r\n    allowedOperators = allowedOperators\r\n      ? allowedOperators\r\n      : OgcFilterOperatorType.BasicAndSpatial;\r\n\r\n    switch (allowedOperators.toLowerCase()) {\r\n      case OgcFilterOperatorType.All:\r\n        effectiveOperators = this.operators;\r\n        break;\r\n      case OgcFilterOperatorType.Spatial:\r\n        effectiveOperators = {\r\n          [OgcFilterOperator.Intersects]: { spatial: true, fieldRestrict: [] },\r\n          [OgcFilterOperator.Within]: { spatial: true, fieldRestrict: [] }\r\n        };\r\n        break;\r\n      case OgcFilterOperatorType.BasicAndSpatial:\r\n        effectiveOperators = {\r\n          [OgcFilterOperator.PropertyIsEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: []\r\n          },\r\n          [OgcFilterOperator.PropertyIsNotEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: []\r\n          },\r\n          [OgcFilterOperator.Intersects]: { spatial: true, fieldRestrict: [] },\r\n          [OgcFilterOperator.Within]: { spatial: true, fieldRestrict: [] }\r\n        };\r\n        break;\r\n      case OgcFilterOperatorType.Basic:\r\n        effectiveOperators = {\r\n          [OgcFilterOperator.PropertyIsEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: []\r\n          },\r\n          [OgcFilterOperator.PropertyIsNotEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: []\r\n          }\r\n        };\r\n        break;\r\n      case OgcFilterOperatorType.Time:\r\n        effectiveOperators = {\r\n          [OgcFilterOperator.During]: { spatial: false, fieldRestrict: [] }\r\n        };\r\n        break;\r\n      case OgcFilterOperatorType.BasicNumericOperator:\r\n        effectiveOperators = {\r\n          [OgcFilterOperator.PropertyIsEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: []\r\n          },\r\n          [OgcFilterOperator.PropertyIsNotEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: []\r\n          },\r\n          [OgcFilterOperator.PropertyIsGreaterThan]: {\r\n            spatial: false,\r\n            fieldRestrict: ['number']\r\n          },\r\n          [OgcFilterOperator.PropertyIsGreaterThanOrEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: ['number']\r\n          },\r\n          [OgcFilterOperator.PropertyIsLessThan]: {\r\n            spatial: false,\r\n            fieldRestrict: ['number']\r\n          },\r\n          [OgcFilterOperator.PropertyIsLessThanOrEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: ['number']\r\n          }\r\n        };\r\n        break;\r\n      default:\r\n        effectiveOperators = {\r\n          [OgcFilterOperator.PropertyIsEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: []\r\n          },\r\n          [OgcFilterOperator.PropertyIsNotEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: []\r\n          },\r\n          [OgcFilterOperator.Intersects]: { spatial: true, fieldRestrict: [] },\r\n          [OgcFilterOperator.Within]: { spatial: true, fieldRestrict: [] }\r\n        };\r\n    }\r\n\r\n    if (fieldsHasSpatialOperator) {\r\n      (effectiveOperators as any).Intersects = {\r\n        spatial: true,\r\n        fieldRestrict: []\r\n      };\r\n      (effectiveOperators as any).Within = { spatial: true, fieldRestrict: [] };\r\n      if (includeContains) {\r\n        (effectiveOperators as any).Contains = {\r\n          spatial: true,\r\n          fieldRestrict: []\r\n        };\r\n      }\r\n    }\r\n\r\n    return effectiveOperators;\r\n  }\r\n\r\n  public addInterfaceFilter(\r\n    igoOgcFilterObject?,\r\n    geometryName?,\r\n    level = 0,\r\n    parentLogical = 'Or'\r\n  ): OgcInterfaceFilterOptions {\r\n    if (!igoOgcFilterObject) {\r\n      igoOgcFilterObject = { operator: 'PropertyIsEqualTo' };\r\n    }\r\n    const f = {\r\n      propertyName: '',\r\n      operator: '',\r\n      active: '',\r\n      filterid: uuid(),\r\n      step: '',\r\n      begin: '',\r\n      end: '',\r\n      sliderOptions: {},\r\n      lowerBoundary: '',\r\n      upperBoundary: '',\r\n      expression: '',\r\n      pattern: '',\r\n      wildCard: '*',\r\n      singleChar: '.',\r\n      escapeChar: '!',\r\n      matchCase: true,\r\n      igoSpatialSelector: '',\r\n      igoSNRC: '',\r\n      geometryName: '',\r\n      geometry: '',\r\n      wkt_geometry: '',\r\n      extent: '',\r\n      srsName: '',\r\n      parentLogical: '',\r\n      level: 0\r\n    };\r\n\r\n    return Object.assign(\r\n      f,\r\n      {\r\n        parentLogical,\r\n        level,\r\n        geometryName\r\n      },\r\n      igoOgcFilterObject\r\n    );\r\n  }\r\n\r\n  public checkIgoFiltersProperties(\r\n    filterObject: any,\r\n    fieldNameGeometry,\r\n    proj: olProjection,\r\n    active = false\r\n  ) {\r\n    const filterArray = [];\r\n    if (filterObject instanceof Array) {\r\n      filterObject.forEach((element) => {\r\n        filterArray.push(\r\n          this.checkIgoFiltersProperties(\r\n            element,\r\n            fieldNameGeometry,\r\n            proj,\r\n            active\r\n          )\r\n        );\r\n      });\r\n      return filterArray;\r\n    } else {\r\n      if (filterObject.hasOwnProperty('logical')) {\r\n        return Object.assign(\r\n          {},\r\n          {\r\n            logical: filterObject.logical,\r\n            filters: this.checkIgoFiltersProperties(\r\n              filterObject.filters,\r\n              fieldNameGeometry,\r\n              proj,\r\n              active\r\n            )\r\n          }\r\n        );\r\n      } else if (filterObject.hasOwnProperty('operator')) {\r\n        return this.addFilterProperties(\r\n          filterObject as OgcInterfaceFilterOptions,\r\n          fieldNameGeometry,\r\n          proj,\r\n          active\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  private addFilterProperties(\r\n    igoOgcFilterObject: OgcInterfaceFilterOptions,\r\n    fieldNameGeometry,\r\n    proj: olProjection,\r\n    active = false\r\n  ) {\r\n    const filterid = igoOgcFilterObject.hasOwnProperty('filterid')\r\n      ? igoOgcFilterObject.filterid\r\n      : uuid();\r\n    const status = igoOgcFilterObject.hasOwnProperty('active')\r\n      ? igoOgcFilterObject.active\r\n      : active;\r\n\r\n    const srsName = igoOgcFilterObject.hasOwnProperty('srsName')\r\n      ? igoOgcFilterObject.srsName\r\n      : proj\r\n      ? proj.getCode()\r\n      : 'EPSG:3857';\r\n\r\n    return Object.assign(\r\n      {},\r\n      {\r\n        filterid,\r\n        active: status,\r\n        igoSpatialSelector: 'fixedExtent',\r\n        srsName\r\n      },\r\n      igoOgcFilterObject,\r\n      { geometryName: fieldNameGeometry }\r\n    );\r\n  }\r\n\r\n  public rebuiltIgoOgcFilterObjectFromSequence(\r\n    sequence: OgcInterfaceFilterOptions[]\r\n  ): IgoOgcFilterObject {\r\n    if (sequence instanceof Array) {\r\n      if (sequence.length >= 1) {\r\n        let lastParentLogical = sequence[0].parentLogical;\r\n        let nextElement: any;\r\n        let logicalArray = [];\r\n        let lastProcessedFilter;\r\n        sequence.forEach((uiFilter) => {\r\n          const element = Object.assign({}, uiFilter);\r\n          const index = sequence.indexOf(uiFilter);\r\n          if (index >= 0 && index < sequence.length - 1) {\r\n            nextElement = sequence[index + 1];\r\n          } else {\r\n            nextElement = element;\r\n          }\r\n          delete element.active;\r\n          delete element.filterid;\r\n          delete element.parentLogical;\r\n          logicalArray.push(element);\r\n\r\n          if (sequence.length === 1) {\r\n            lastProcessedFilter = element;\r\n          } else if (lastParentLogical !== nextElement.parentLogical) {\r\n            if (logicalArray.length === 1) {\r\n              console.log(\r\n                'You must set at ' +\r\n                  'least two operator in a logical (' +\r\n                  lastParentLogical +\r\n                  ')'\r\n              );\r\n            } else {\r\n              lastProcessedFilter = Object.assign(\r\n                {},\r\n                { logical: lastParentLogical, filters: logicalArray }\r\n              );\r\n              logicalArray = [lastProcessedFilter];\r\n              lastParentLogical = nextElement.parentLogical;\r\n            }\r\n          }\r\n        });\r\n        return lastProcessedFilter;\r\n      } else {\r\n        return undefined;\r\n      }\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  private computeIgoSelector(selectors: IgoOgcSelector): IgoOgcSelector {\r\n    if (\r\n      selectors.groups.every((group) => group.computedSelectors !== undefined)\r\n    ) {\r\n      return selectors;\r\n    }\r\n    let selector: IgoOgcSelector;\r\n    if (selectors.groups && selectors.bundles) {\r\n      if (!selectors.bundles.every((bundle) => bundle.id !== undefined)) {\r\n        throw new Error(\r\n          'You must set an id for each of your bundles'\r\n        );\r\n      }\r\n      selector = ObjectUtils.copyDeep(selectors);\r\n      selector.groups.forEach((group) => {\r\n        group.title = group.title ? group.title : group.name;\r\n        group.enabled = group.enabled ? group.enabled : false;\r\n        group.computedSelectors = ObjectUtils.copyDeep(\r\n          selector.bundles.filter((b) => group.ids.includes(b.id))\r\n        );\r\n      });\r\n    } else if (!selectors.groups && selectors.bundles) {\r\n      selector = ObjectUtils.copyDeep(selectors);\r\n      selector.groups = [\r\n        {\r\n          title: 'group1',\r\n          name: 'group1',\r\n          computedSelectors: ObjectUtils.copyDeep(selector.bundles)\r\n        } as SelectorGroup\r\n      ];\r\n    } else {\r\n      selector = {\r\n        bundles: selectors as any,\r\n        groups: [\r\n          {\r\n            title: 'group1',\r\n            name: 'group1',\r\n            computedSelectors: ObjectUtils.copyDeep(\r\n              selectors\r\n            ) as OgcSelectorBundle[]\r\n          } as SelectorGroup\r\n        ],\r\n        selectorType: selector.selectorType\r\n      };\r\n    }\r\n    if (!selector.groups.find((selectorGroup) => selectorGroup.enabled)) {\r\n      selector.groups[0].enabled = true;\r\n    }\r\n    return selector;\r\n  }\r\n\r\n  public handleOgcFiltersAppliedValue(\r\n    options: OgcFilterableDataSourceOptions,\r\n    fieldNameGeometry: string,\r\n    extent?: [number, number, number, number],\r\n    proj?: olProjection\r\n  ): string {\r\n    const ogcFilters = options.ogcFilters;\r\n    if (!ogcFilters) {\r\n      return;\r\n    }\r\n    const conditions = [];\r\n    let filterQueryStringSelector = '';\r\n    let filterQueryStringAdvancedFilters = '';\r\n    if (ogcFilters.enabled && (ogcFilters.pushButtons || ogcFilters.checkboxes || ogcFilters.radioButtons || ogcFilters.select\r\n      || ogcFilters.autocomplete)) {\r\n      let selectors;\r\n      if (ogcFilters.pushButtons) {\r\n        selectors = ogcFilters.pushButtons;\r\n        const pushConditions = this.formatGroupAndFilter(ogcFilters, selectors);\r\n        for (const condition of pushConditions) {\r\n          conditions.push(condition);\r\n        }\r\n      }\r\n      if (ogcFilters.checkboxes) {\r\n        selectors = ogcFilters.checkboxes;\r\n        const checkboxConditions = this.formatGroupAndFilter(ogcFilters, selectors);\r\n        for (const condition of checkboxConditions) {\r\n          conditions.push(condition);\r\n        }\r\n      }\r\n      if (ogcFilters.radioButtons) {\r\n        selectors = ogcFilters.radioButtons;\r\n        const selectorsCorr = this.verifyMultipleEnableds(selectors);\r\n        const radioConditions = this.formatGroupAndFilter(ogcFilters, selectorsCorr);\r\n        for (const condition of radioConditions) {\r\n          conditions.push(condition);\r\n        }\r\n      }\r\n      if (ogcFilters.select) {\r\n        selectors = ogcFilters.select;\r\n        const selectorsCorr = this.verifyMultipleEnableds(selectors);\r\n        const selectConditions = this.formatGroupAndFilter(ogcFilters, selectorsCorr);\r\n        for (const condition of selectConditions) {\r\n          conditions.push(condition);\r\n        }\r\n      }\r\n      if (ogcFilters.autocomplete) {\r\n        selectors = ogcFilters.autocomplete;\r\n        const selectConditions = this.formatGroupAndFilter(ogcFilters, selectors);\r\n        for (const condition of selectConditions) {\r\n          conditions.push(condition);\r\n        }\r\n      }\r\n\r\n      if (conditions.length >= 1) {\r\n        filterQueryStringSelector = this.buildFilter(\r\n          conditions.length === 1\r\n            ? conditions[0]\r\n            : { logical: 'And', filters: conditions },\r\n          extent,\r\n          proj,\r\n          ogcFilters.geometryName\r\n        );\r\n      }\r\n    }\r\n    if (ogcFilters.enabled && ogcFilters.filters) {\r\n      ogcFilters.geometryName = ogcFilters.geometryName || fieldNameGeometry;\r\n      const igoFilters = ogcFilters.filters;\r\n      filterQueryStringAdvancedFilters = this.buildFilter(\r\n        igoFilters,\r\n        extent,\r\n        proj,\r\n        ogcFilters.geometryName,\r\n        options\r\n      );\r\n    }\r\n\r\n    let filterQueryString = ogcFilters.advancedOgcFilters\r\n      ? filterQueryStringAdvancedFilters\r\n      : filterQueryStringSelector;\r\n    if (options.type === 'wms') {\r\n      filterQueryString = this.formatProcessedOgcFilter(\r\n        filterQueryString,\r\n        (options as any).params.LAYERS\r\n      );\r\n    }\r\n    if (options.type === 'wfs') {\r\n      filterQueryString = this.formatProcessedOgcFilter(\r\n        filterQueryString,\r\n        (options as any).params.featureTypes\r\n      );\r\n    }\r\n\r\n    return filterQueryString;\r\n  }\r\n\r\n  public verifyMultipleEnableds(selectors) {\r\n    selectors.bundles.forEach(bundle => {\r\n      if (!bundle.multiple && bundle.selectors) {\r\n        const enableds = bundle.selectors.reduce((list, filter, index) => (filter.enabled) === true ? list.concat(index) : list, []);\r\n        if (enableds.length > 1) {\r\n          enableds.splice(0, 1);\r\n          enableds.forEach(index => {\r\n            bundle.selectors[index].enabled = false;\r\n          });\r\n        }\r\n      }\r\n    });\r\n    return selectors;\r\n  }\r\n\r\n  public formatGroupAndFilter(ogcFilters: OgcFiltersOptions, selectors) {\r\n    selectors = this.computeIgoSelector(\r\n      selectors\r\n    );\r\n    const selectorBundle = selectors.groups.find(\r\n      (g) => g.enabled\r\n    ).computedSelectors;\r\n    const conditions = [];\r\n    selectorBundle.map((bundle) => {\r\n      const bundleCondition = [];\r\n      const selectorsType = bundle.selectors as any;\r\n      if (!selectorsType) {\r\n        return;\r\n      }\r\n      selectorsType\r\n        .filter((ogcselector) => ogcselector.enabled === true)\r\n        .forEach((enabledSelector) => bundleCondition.push(enabledSelector.filters));\r\n      if (bundleCondition.length === 1) {\r\n        conditions.push(bundleCondition[0]);\r\n      } else if (bundleCondition.length > 1) {\r\n        conditions.push({\r\n          logical: bundle.logical,\r\n          filters: bundleCondition\r\n        });\r\n      }\r\n    });\r\n\r\n    if (selectors.selectorType === 'pushButton') {\r\n      ogcFilters.pushButtons = selectors;\r\n    } else if (selectors.selectorType === 'checkbox') {\r\n      ogcFilters.checkboxes = selectors;\r\n    } else if (selectors.selectorType === 'radioButton') {\r\n      ogcFilters.radioButtons = selectors;\r\n    } else if (selectors.selectorType === 'select') {\r\n      ogcFilters.select = selectors;\r\n    } else if (selectors.selectorType === 'autocomplete') {\r\n      ogcFilters.autocomplete = selectors;\r\n    }\r\n    return conditions;\r\n  }\r\n\r\n  public formatProcessedOgcFilter(\r\n    processedFilter: string,\r\n    layersOrTypenames: string\r\n  ): string {\r\n\r\n    if (!processedFilter) {return undefined;};\r\n    let appliedFilter = '';\r\n    if (processedFilter.length === 0 && layersOrTypenames.indexOf(',') === -1) {\r\n      appliedFilter = processedFilter;\r\n    } else {\r\n      layersOrTypenames.split(',').forEach((layerOrTypenames) => {\r\n        appliedFilter = `${appliedFilter}(${processedFilter.replace(\r\n          'filter=',\r\n          ''\r\n        )})`;\r\n      });\r\n    }\r\n    appliedFilter = appliedFilter.replace(/\\(\\)/g, '');\r\n    const filterValue =\r\n      appliedFilter.length > 0\r\n        ? appliedFilter.replace('filter=', '')\r\n        : undefined;\r\n    return filterValue;\r\n  }\r\n\r\n  public parseFilterOptionDate(value: string, defaultValue?: string): string {\r\n    if (!value) {\r\n      return defaultValue;\r\n    } else if (value === 'today') {\r\n      return undefined;\r\n    } else if (moment(value).isValid()) {\r\n      return value;\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n}\r\n","import { WFSDataSourceOptions } from './wfs-datasource.interface';\r\nimport { WMSDataSourceOptions } from './wms-datasource.interface';\r\nimport { OgcFiltersOptions } from '../../../filter/shared/ogc-filter.interface';\r\nimport { OgcFilterWriter } from '../../../filter/shared/ogc-filter';\r\n\r\nimport * as OlFormat from 'ol/format';\r\nimport olFormatGML2 from 'ol/format/GML2';\r\nimport olFormatGML3 from 'ol/format/GML3';\r\nimport olFormatGML32 from 'ol/format/GML32';\r\nimport olFormatOSMXML from 'ol/format/OSMXML';\r\nimport olProjection from 'ol/proj/Projection';\r\n\r\nexport const defaultEpsg = 'EPSG:3857';\r\nexport const defaultMaxFeatures = 5000;\r\nexport const defaultWfsVersion = '2.0.0';\r\nexport const defaultFieldNameGeometry = 'geometry';\r\nexport const gmlRegex = new RegExp(/(.*)?gml(.*)?/gi);\r\nexport const jsonRegex = new RegExp(/(.*)?json(.*)?/gi);\r\n\r\n\r\n/**\r\n * This method build the WFS URL based on the layer property.\r\n * @param options  WFSDataSourceOptions The common wfs datasource options interface\r\n * @param extent  An extent like array [number, number, number, number]\r\n * @param proj  olProjection\r\n * @param ogcFilters  OgcFiltersOptions\r\n * @returns A string representing the datasource options, based on filter and views\r\n */\r\nexport function buildUrl(\r\n  options: WFSDataSourceOptions,\r\n  extent,\r\n  proj: olProjection,\r\n  ogcFilters: OgcFiltersOptions,\r\n  randomParam?: boolean): string {\r\n  const paramsWFS = options.paramsWFS;\r\n  const queryStringValues = formatWFSQueryString(options, undefined, options.paramsWFS.srsName);\r\n  let igoFilters;\r\n  if (ogcFilters && ogcFilters.enabled) {\r\n    igoFilters = ogcFilters.filters;\r\n  }\r\n  const ogcFilterWriter = new OgcFilterWriter();\r\n  const filterOrBox = ogcFilterWriter.buildFilter(igoFilters, extent, proj, ogcFilters.geometryName, options);\r\n  let filterOrPush = ogcFilterWriter.handleOgcFiltersAppliedValue(options, ogcFilters.geometryName, extent, proj);\r\n\r\n  let prefix = 'filter';\r\n  if (!filterOrPush) {\r\n    prefix = 'bbox';\r\n    filterOrPush = extent.join(',') + ',' + proj.getCode();\r\n  }\r\n\r\n  paramsWFS.xmlFilter = ogcFilters.advancedOgcFilters ? filterOrBox : `${prefix}=${filterOrPush}`;\r\n  let baseUrl = queryStringValues.find(f => f.name === 'getfeature').value;\r\n  const patternFilter = /(filter|bbox)=.*/gi;\r\n  baseUrl = patternFilter.test(paramsWFS.xmlFilter) ? `${baseUrl}&${paramsWFS.xmlFilter}` : baseUrl;\r\n  options.download = Object.assign({}, options.download, { dynamicUrl: baseUrl });\r\n  if (randomParam) {\r\n    baseUrl += `$&_t${new Date().getTime()}`;\r\n  }\r\n  return baseUrl.replace(/&&/g, '&');\r\n}\r\n\r\n\r\n/**\r\n * This method build/standardize WFS call query params based on the layer property.\r\n * @param wfsDataSourceOptions  WFSDataSourceOptions The common wfs datasource options interface\r\n * @param count  Number: Used to control the number of feature. Used to bypass whe wfs datasource options interface (maxFeatures)\r\n * @param epsg  String: Used to control the EPSG code (es: 'EPSG3857'). Used to bypass whe wfs datasource options interface (srsName)\r\n * @param properties  String: Used to control the queried fields  (WFS service).\r\n * @returns An array array of {name: '', value: ''} of predefined query params.\r\n */\r\nexport function formatWFSQueryString(\r\n  dataSourceOptions: WFSDataSourceOptions | WMSDataSourceOptions,\r\n  count?: number,\r\n  epsg?: string,\r\n  properties?: string,\r\n  startIndex: number = 0,\r\n  forceDefaultOutputFormat: boolean = false\r\n): { name: string; value: string }[] {\r\n  const versionWfs200 = '2.0.0'; // not the same usage as defaultWfsVersion.\r\n  const url = dataSourceOptions.urlWfs;\r\n  const paramsWFS = dataSourceOptions.paramsWFS;\r\n  const effectiveCount = count || defaultMaxFeatures;\r\n  const effectiveStartIndex = paramsWFS.version === versionWfs200 ? `startIndex=${startIndex}` : '';\r\n  const epsgCode = epsg || defaultEpsg;\r\n  let outputFormat = paramsWFS.outputFormat\r\n    ? `outputFormat=${paramsWFS.outputFormat}`\r\n    : '';\r\n  let version = paramsWFS.version\r\n    ? `version=${paramsWFS.version}`\r\n    : `version=${defaultWfsVersion}`;\r\n  const paramTypename =\r\n    paramsWFS.version === versionWfs200 ? 'typenames' : 'typename';\r\n  const featureTypes = `${paramTypename}=${paramsWFS.featureTypes}`;\r\n  const paramMaxFeatures =\r\n    paramsWFS.version === versionWfs200 ? 'count' : 'maxFeatures';\r\n  let cnt = count\r\n    ? `${paramMaxFeatures}=${effectiveCount}`\r\n    : paramsWFS.maxFeatures\r\n    ? `${paramMaxFeatures}=${paramsWFS.maxFeatures}`\r\n    : `${paramMaxFeatures}=${effectiveCount}`;\r\n  if (forceDefaultOutputFormat) {\r\n      outputFormat = '';\r\n      version = 'version=1.1.0';\r\n      cnt = cnt.replace('count', 'maxFeatures');\r\n    }\r\n\r\n  const srs = epsg\r\n    ? `srsname=${epsgCode}`\r\n    : paramsWFS.srsName\r\n    ? 'srsname=' + paramsWFS.srsName\r\n    : `srsname=${epsgCode}`;\r\n\r\n  let propertyName = '';\r\n  let valueReference = '';\r\n  if (properties) {\r\n    propertyName = `propertyName=${properties}`;\r\n    valueReference = `valueReference=${properties}`;\r\n  }\r\n  const sourceFields = dataSourceOptions.sourceFields;\r\n  if (!propertyName && sourceFields && sourceFields.length > 0) {\r\n    const fieldsNames = [];\r\n    dataSourceOptions.sourceFields.forEach(sourcefield => {\r\n      fieldsNames.push(sourcefield.name);\r\n    });\r\n    propertyName = `propertyName=${fieldsNames.join(',')},${\r\n      paramsWFS.fieldNameGeometry\r\n    }`;\r\n  }\r\n\r\n  const separator = url.indexOf('?') === -1 ? '?' : '&';\r\n  const getCapabilities = `${url}${separator}service=WFS&request=GetCapabilities&${version}`;\r\n  let getFeature = `${url}${separator}service=WFS&request=GetFeature&${version}&${featureTypes}&`;\r\n  getFeature += `${outputFormat}&${srs}&${cnt}&${propertyName}&${effectiveStartIndex}`;\r\n\r\n  let getpropertyvalue = `${url}?service=WFS&request=GetPropertyValue&version=${versionWfs200}&${featureTypes}&`;\r\n  getpropertyvalue += `&${cnt}&${valueReference}`;\r\n\r\n  return [\r\n    { name: 'outputformat', value: outputFormat },\r\n    { name: 'version', value: version },\r\n    { name: 'typename', value: featureTypes },\r\n    { name: 'count', value: cnt },\r\n    { name: 'srsname', value: srs },\r\n    { name: 'propertyname', value: propertyName },\r\n    { name: 'valuereference', value: valueReference },\r\n    { name: 'getcapabilities', value: getCapabilities.replace(/&&/g, '&') },\r\n    { name: 'getfeature', value: getFeature.replace(/&&/g, '&') },\r\n    { name: 'getpropertyvalue', value: getpropertyvalue.replace(/&&/g, '&') }\r\n  ];\r\n}\r\n\r\n/**\r\n * Validate/Modify layer's wfs options based on :\r\n * 1- an Openlayers's issue with GML provided from WFS. Refer to\r\n * https://github.com/openlayers/openlayers/pull/6400\r\n * 2- Set default values for optionals parameters.\r\n * @param wfsDataSourceOptions  WFSDataSourceOptions The common wfs datasource options interface\r\n * @returns An array array of {name: '', value: ''} of predefined query params.\r\n */\r\nexport function checkWfsParams(wfsDataSourceOptions, srcType?: string) {\r\n  if (srcType && srcType === 'wfs') {\r\n    // reassignation of params to paramsWFS and url to urlWFS to have a common interface with wms-wfs datasources\r\n    wfsDataSourceOptions.paramsWFS = wfsDataSourceOptions.params;\r\n  }\r\n\r\n  const paramsWFS = wfsDataSourceOptions.paramsWFS;\r\n  wfsDataSourceOptions.urlWfs =\r\n    wfsDataSourceOptions.urlWfs || wfsDataSourceOptions.url;\r\n\r\n  paramsWFS.version = paramsWFS.version || defaultWfsVersion;\r\n  paramsWFS.fieldNameGeometry =\r\n    paramsWFS.fieldNameGeometry || defaultFieldNameGeometry;\r\n  paramsWFS.maxFeatures = paramsWFS.maxFeatures || defaultMaxFeatures;\r\n\r\n  let outputFormat;\r\n  if (paramsWFS.outputFormat) {\r\n    outputFormat = paramsWFS.outputFormat;\r\n  }\r\n\r\n  if (gmlRegex.test(outputFormat) || !outputFormat) {\r\n    paramsWFS.version = '1.1.0';\r\n  }\r\n  return Object.assign({}, wfsDataSourceOptions);\r\n}\r\n\r\nexport function getFormatFromOptions(\r\n  options: WFSDataSourceOptions | WMSDataSourceOptions\r\n) {\r\n  const wfsOptions = options as WFSDataSourceOptions;\r\n\r\n  let olFormatCls;\r\n  const outputFormat = wfsOptions.paramsWFS.outputFormat\r\n    ? wfsOptions.paramsWFS.outputFormat\r\n    : undefined;\r\n\r\n  if (!outputFormat) {\r\n    olFormatCls = OlFormat.WFS;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  }\r\n\r\n  if (OlFormat[outputFormat]) {\r\n    olFormatCls = OlFormat[outputFormat];\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('gml2')) {\r\n    olFormatCls = OlFormat.WFS;\r\n    return new olFormatCls({ ...wfsOptions.formatOptions, ...{ gmlFormat: olFormatGML2 }});\r\n  } else if (outputFormat.toLowerCase().match('gml32')) {\r\n    olFormatCls = OlFormat.WFS;\r\n    return new olFormatCls({ ...wfsOptions.formatOptions, ...{ gmlFormat: olFormatGML32 }});\r\n  } else if (outputFormat.toLowerCase().match('gml3')) {\r\n    olFormatCls = OlFormat.WFS;\r\n    return new olFormatCls({ ...wfsOptions.formatOptions, ...{ gmlFormat: olFormatGML3 }});\r\n  } else if (outputFormat.toLowerCase().match('topojson')) {\r\n    olFormatCls = OlFormat.TopoJSON;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('geojson')) {\r\n    olFormatCls = OlFormat.GeoJSON;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('esrijson')) {\r\n    olFormatCls = OlFormat.EsriJSON;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('json')) {\r\n    olFormatCls = OlFormat.GeoJSON;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('gpx')) {\r\n    olFormatCls = OlFormat.GPX;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('WKT')) {\r\n    olFormatCls = OlFormat.WKT;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('osmxml')) {\r\n    olFormatCls = olFormatOSMXML;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('kml')) {\r\n    olFormatCls = OlFormat.KML;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  }\r\n\r\n  return new olFormatCls();\r\n}\r\n","import olLayerVector from 'ol/layer/Vector';\r\nimport olSourceVector from 'ol/source/Vector';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport { unByKey } from 'ol/Observable';\r\nimport { easeOut } from 'ol/easing';\r\nimport { asArray as ColorAsArray } from 'ol/color';\r\nimport { getVectorContext } from 'ol/render';\r\nimport olFeature from 'ol/Feature';\r\nimport olProjection from 'ol/proj/Projection';\r\nimport * as olproj from 'ol/proj';\r\n\r\nimport { FeatureDataSource } from '../../../datasource/shared/datasources/feature-datasource';\r\nimport { WFSDataSource } from '../../../datasource/shared/datasources/wfs-datasource';\r\nimport { ArcGISRestDataSource } from '../../../datasource/shared/datasources/arcgisrest-datasource';\r\nimport { WebSocketDataSource } from '../../../datasource/shared/datasources/websocket-datasource';\r\nimport { ClusterDataSource } from '../../../datasource/shared/datasources/cluster-datasource';\r\n\r\nimport { VectorWatcher } from '../../utils';\r\nimport { IgoMap, MapExtent } from '../../../map';\r\nimport { Layer } from './layer';\r\nimport { VectorLayerOptions } from './vector-layer.interface';\r\nimport { AuthInterceptor } from '@igo2/auth';\r\nimport { MessageService } from '@igo2/core';\r\nimport { WFSDataSourceOptions } from '../../../datasource/shared/datasources/wfs-datasource.interface';\r\nimport { buildUrl, defaultMaxFeatures } from '../../../datasource/shared/datasources/wms-wfs.utils';\r\nimport { OgcFilterableDataSourceOptions } from '../../../filter/shared/ogc-filter.interface';\r\nimport { GeoNetworkService, SimpleGetOptions } from '../../../offline/shared/geo-network.service';\r\nimport { catchError, concatMap, first } from 'rxjs/operators';\r\nimport { GeoDBService } from '../../../offline/geoDB/geoDB.service';\r\nimport { of } from 'rxjs';\r\nexport class VectorLayer extends Layer {\r\n  public dataSource:\r\n    | FeatureDataSource\r\n    | WFSDataSource\r\n    | ArcGISRestDataSource\r\n    | WebSocketDataSource\r\n    | ClusterDataSource;\r\n  public options: VectorLayerOptions;\r\n  public ol: olLayerVector<olSourceVector<OlGeometry>>;\r\n  private watcher: VectorWatcher;\r\n  private trackFeatureListenerId;\r\n\r\n  get browsable(): boolean {\r\n    return this.options.browsable !== false;\r\n  }\r\n\r\n  get exportable(): boolean {\r\n    return this.options.exportable !== false;\r\n  }\r\n\r\n  constructor(\r\n    options: VectorLayerOptions,\r\n    public messageService?: MessageService,\r\n    public authInterceptor?: AuthInterceptor,\r\n    private geoNetworkService?: GeoNetworkService,\r\n    private geoDBService?: GeoDBService\r\n  ) {\r\n    super(options, messageService, authInterceptor);\r\n    this.watcher = new VectorWatcher(this);\r\n    this.status$ = this.watcher.status$;\r\n  }\r\n\r\n  protected createOlLayer(): olLayerVector<olSourceVector<OlGeometry>> {\r\n    const olOptions = Object.assign({}, this.options, {\r\n      source: this.options.source.ol as olSourceVector<OlGeometry>\r\n    });\r\n\r\n    if (this.options.animation) {\r\n      this.dataSource.ol.on(\r\n        'addfeature',\r\n        function(e) {\r\n          this.flash(e.feature);\r\n        }.bind(this)\r\n      );\r\n    }\r\n\r\n    if (this.options.trackFeature) {\r\n      this.enableTrackFeature(this.options.trackFeature);\r\n    }\r\n\r\n    const vector = new olLayerVector(olOptions);\r\n    const vectorSource = vector.getSource() as olSourceVector<OlGeometry>;\r\n    const url = vectorSource.getUrl();\r\n    if (url) {\r\n      let loader;\r\n      const wfsOptions = olOptions.sourceOptions as WFSDataSourceOptions;\r\n      if (wfsOptions?.type === 'wfs' && (wfsOptions.params || wfsOptions.paramsWFS)) {\r\n        loader = (extent, resolution, proj, success, failure) => {\r\n          this.customWFSLoader(\r\n            vectorSource,\r\n            wfsOptions,\r\n            this.authInterceptor,\r\n            extent,\r\n            resolution,\r\n            proj,\r\n            success,\r\n            failure\r\n          );\r\n        };\r\n      } else {\r\n        loader = (extent, resolution, proj, success, failure) => {\r\n          this.customLoader(\r\n            vectorSource,\r\n            url,\r\n            this.authInterceptor,\r\n            extent,\r\n            resolution,\r\n            proj,\r\n            success,\r\n            failure\r\n          );\r\n        };\r\n      }\r\n      if (loader) {\r\n        vectorSource.setLoader(loader);\r\n      }\r\n    }\r\n    return vector;\r\n  }\r\n\r\n  protected flash(feature) {\r\n    const start = new Date().getTime();\r\n    const listenerKey = this.ol.on('postrender', animate.bind(this));\r\n\r\n    function animate(event) {\r\n      const vectorContext = getVectorContext(event);\r\n      const frameState = event.frameState;\r\n      const flashGeom = feature.getGeometry().clone();\r\n      const elapsed = frameState.time - start;\r\n      const elapsedRatio = elapsed / this.options.animation.duration;\r\n      const opacity = easeOut(1 - elapsedRatio);\r\n      const newColor = ColorAsArray(this.options.animation.color || 'red');\r\n      newColor[3] = opacity;\r\n      let style = this.ol\r\n        .getStyleFunction()\r\n        .call(this, feature)\r\n        .find((style2) => {\r\n          return style2.getImage();\r\n        });\r\n      if (!style) {\r\n        style = this.ol.getStyleFunction().call(this, feature)[0];\r\n      }\r\n      const styleClone = style.clone();\r\n\r\n      switch (feature.getGeometry().getType()) {\r\n        case 'Point':\r\n          if(styleClone.getImage() !== null &&\r\n            typeof styleClone.getImage().getRadius === 'function'){\r\n            const radius =\r\n            easeOut(elapsedRatio) * (styleClone.getImage().getRadius() * 3);\r\n            styleClone.getImage().setRadius(radius);\r\n            styleClone.getImage().setOpacity(opacity);\r\n          }\r\n\r\n          break;\r\n        case 'LineString':\r\n          // TODO\r\n          if (styleClone.getImage()) {\r\n            styleClone.getImage().getStroke().setColor(newColor);\r\n            styleClone\r\n              .getImage()\r\n              .getStroke()\r\n              .setWidth(\r\n                easeOut(elapsedRatio) *\r\n                  (styleClone.getImage().getStroke().getWidth() * 3)\r\n              );\r\n          }\r\n          if (styleClone.getStroke()) {\r\n            styleClone.getStroke().setColor(newColor);\r\n            styleClone\r\n              .getStroke()\r\n              .setWidth(\r\n                easeOut(elapsedRatio) * (styleClone.getStroke().getWidth() * 3)\r\n              );\r\n          }\r\n          break;\r\n        case 'Polygon':\r\n          // TODO\r\n          if (styleClone.getImage()) {\r\n            styleClone.getImage().getFill().setColor(newColor);\r\n          }\r\n          if (styleClone.getFill()) {\r\n            styleClone.getFill().setColor(newColor);\r\n          }\r\n          break;\r\n      }\r\n\r\n      styleClone.setText('');\r\n      vectorContext.setStyle(styleClone);\r\n      vectorContext.drawGeometry(flashGeom);\r\n\r\n      if (elapsed > this.options.animation.duration) {\r\n        unByKey(listenerKey);\r\n        // remove last geometry\r\n        // there is a little flash before feature disappear, better solution ?\r\n        this.map.ol.render();\r\n        return;\r\n      }\r\n      // tell OpenLayers to continue postcompose animation\r\n      this.map.ol.render();\r\n    }\r\n  }\r\n\r\n  public setMap(map: IgoMap | undefined) {\r\n    if (map === undefined) {\r\n      this.watcher.unsubscribe();\r\n    } else {\r\n      this.watcher.subscribe(() => {});\r\n    }\r\n    super.setMap(map);\r\n  }\r\n\r\n  public setExtent(extent: MapExtent): void {\r\n    this.options.extent = extent;\r\n  }\r\n\r\n  public onUnwatch() {\r\n    this.dataSource.onUnwatch();\r\n    this.stopAnimation();\r\n  }\r\n\r\n  public stopAnimation() {\r\n    this.dataSource.ol.un(\r\n      'addfeature',\r\n      function(e) {\r\n        if (this.visible) {\r\n          this.flash(e.feature);\r\n        }\r\n      }.bind(this)\r\n    );\r\n  }\r\n\r\n  public enableTrackFeature(id: string | number) {\r\n    this.trackFeatureListenerId = this.dataSource.ol.on(\r\n      'addfeature',\r\n      this.trackFeature.bind(this, id)\r\n    );\r\n  }\r\n  public centerMapOnFeature(id: string | number) {\r\n    const feat = this.dataSource.ol.getFeatureById(id);\r\n    if (feat) {\r\n      this.map.ol.getView().setCenter((feat.getGeometry() as any).getCoordinates());\r\n    }\r\n  }\r\n\r\n  public trackFeature(id, feat) {\r\n    if (feat.feature.getId() === id && this.visible) {\r\n      this.centerMapOnFeature(id);\r\n    }\r\n  }\r\n\r\n  public disableTrackFeature(id?: string | number) {\r\n    unByKey(this.trackFeatureListenerId);\r\n  }\r\n\r\n  /**\r\n   * Custom loader for a WFS datasource\r\n   * @internal\r\n   * @param vectorSource the vector source to be created\r\n   * @param options olOptions from source\r\n   * @param interceptor the interceptor of the data\r\n   * @param extent the extent of the requested data\r\n   * @param resolution the current resolution\r\n   * @param proj the projection to retrieve the data\r\n   * @param success success callback\r\n   * @param failure failure callback\r\n   * @param randomParam random parameter to ensure cache is not causing problems in retrieving new data\r\n   */\r\n  public customWFSLoader(\r\n    vectorSource,\r\n    options,\r\n    interceptor,\r\n    extent,\r\n    resolution,\r\n    proj,\r\n    success,\r\n    failure,\r\n    randomParam?: boolean\r\n  ) {\r\n    {\r\n      const paramsWFS = options.paramsWFS;\r\n      const wfsProj = paramsWFS.srsName ? new olProjection({ code: paramsWFS.srsName }) : proj;\r\n      const currentExtent = olproj.transformExtent(extent, proj, wfsProj);\r\n      paramsWFS.srsName = paramsWFS.srsName || proj.getCode();\r\n      const url = buildUrl(\r\n        options,\r\n        currentExtent,\r\n        wfsProj,\r\n        (options as OgcFilterableDataSourceOptions).ogcFilters,\r\n        randomParam);\r\n      let startIndex = 0;\r\n      if (paramsWFS.version === '2.0.0' && paramsWFS.maxFeatures > defaultMaxFeatures) {\r\n        const nbOfFeature = 1000;\r\n        while (startIndex < paramsWFS.maxFeatures) {\r\n          let alteredUrl = url.replace('count=' + paramsWFS.maxFeatures, 'count=' + nbOfFeature);\r\n          alteredUrl = alteredUrl.replace('startIndex=0', '0');\r\n          alteredUrl += '&startIndex=' + startIndex;\r\n          alteredUrl.replace(/&&/g, '&');\r\n          this.getFeatures(vectorSource, interceptor, currentExtent, wfsProj, proj, alteredUrl, nbOfFeature, success, failure);\r\n          startIndex += nbOfFeature;\r\n        }\r\n      } else {\r\n        this.getFeatures(vectorSource, interceptor, currentExtent, wfsProj, proj, url, paramsWFS.maxFeatures, success, failure);\r\n      }\r\n    }\r\n  }\r\n\r\n\r\n  /**\r\n   * Custom loader to get feature from a WFS datasource\r\n   * @internal\r\n   * @param vectorSource the vector source to be created\r\n   * @param interceptor the interceptor of the data\r\n   * @param extent the extent of the requested data\r\n   * @param dataProjection the projection of the retrieved data\r\n   * @param featureProjection the projection of the created features\r\n   * @param url the url string to retrieve the data\r\n   * @param threshold the threshold to manage \"more features\" (TODO)\r\n   * @param success success callback\r\n   * @param failure failure callback\r\n   */\r\n  private getFeatures(\r\n    vectorSource: olSourceVector<OlGeometry>,\r\n    interceptor,\r\n    extent,\r\n    dataProjection,\r\n    featureProjection,\r\n    url: string,\r\n    threshold: number,\r\n    success, failure) {\r\n\r\n    const idAssociatedCall = (this.dataSource as WFSDataSource).mostRecentIdCallOGCFilter;\r\n    const xhr = new XMLHttpRequest();\r\n    const alteredUrlWithKeyAuth = interceptor.alterUrlWithKeyAuth(url);\r\n    let modifiedUrl = url;\r\n    if (alteredUrlWithKeyAuth) {\r\n      modifiedUrl = alteredUrlWithKeyAuth;\r\n    }\r\n    xhr.open('GET', modifiedUrl);\r\n    if (interceptor) {\r\n      interceptor.interceptXhr(xhr, modifiedUrl);\r\n    }\r\n    const onError = () => {\r\n      vectorSource.removeLoadedExtent(extent);\r\n      failure();\r\n    };\r\n    xhr.onerror = onError;\r\n    xhr.onload = () => {\r\n      if (xhr.status === 200 && xhr.responseText.length > 0) {\r\n        const features =\r\n          vectorSource\r\n            .getFormat()\r\n            .readFeatures(xhr.responseText, { dataProjection, featureProjection }) as olFeature<OlGeometry>[];\r\n        // TODO Manage \"More feature\"\r\n        /*if (features.length === 0 || features.length < threshold ) {\r\n          console.log('No more data to download at this resolution');\r\n        }*/\r\n        // Avoids retrieving an older call that took longer to be process\r\n        if (idAssociatedCall === (this.dataSource as WFSDataSource).mostRecentIdCallOGCFilter)\r\n        {\r\n            vectorSource.addFeatures(features);\r\n            success(features);\r\n        }\r\n        else {\r\n            success([]);\r\n        }\r\n      } else {\r\n        onError();\r\n      }\r\n    };\r\n    xhr.send();\r\n  }\r\n\r\n  /**\r\n   * Custom loader for vector layer.\r\n   * @internal\r\n   * @param vectorSource the vector source to be created\r\n   * @param url the url string or function to retrieve the data\r\n   * @param interceptor the interceptor of the data\r\n   * @param extent the extent of the requested data\r\n   * @param resolution the current resolution\r\n   * @param projection the projection to retrieve the data\r\n   */\r\n  private customLoader(\r\n    vectorSource,\r\n    url,\r\n    interceptor,\r\n    extent,\r\n    resolution,\r\n    projection,\r\n    success,\r\n    failure\r\n  ) {\r\n    const xhr = new XMLHttpRequest();\r\n    let modifiedUrl = url;\r\n    if (typeof url !== 'function') {\r\n      const alteredUrlWithKeyAuth = interceptor.alterUrlWithKeyAuth(url);\r\n      if (alteredUrlWithKeyAuth) {\r\n        modifiedUrl = alteredUrlWithKeyAuth;\r\n      }\r\n    } else {\r\n      modifiedUrl = url(extent, resolution, projection);\r\n    }\r\n\r\n    if (this.geoNetworkService && typeof url !== 'function') {\r\n      const format = vectorSource.getFormat();\r\n      const type = format.getType();\r\n\r\n      let responseType = type;\r\n      const onError = () => {\r\n        vectorSource.removeLoadedExtent(extent);\r\n        failure();\r\n      };\r\n\r\n      const options: SimpleGetOptions = { responseType };\r\n      this.geoNetworkService.geoDBService.get(url).pipe(concatMap(r =>\r\n        r ? of(r) : this.geoNetworkService.get(modifiedUrl, options)\r\n          .pipe(\r\n            first(),\r\n            catchError((res) => {\r\n              onError();\r\n              throw res;\r\n            })\r\n          )\r\n      ))\r\n      .subscribe((content) => {\r\n          if (content) {\r\n            const format = vectorSource.getFormat();\r\n            const type = format.getType();\r\n            let source;\r\n            if (type === 'json' || type === 'text') {\r\n              source = content;\r\n            } else if (type === 'xml') {\r\n              source = content;\r\n              if (!source) {\r\n                source = new DOMParser().parseFromString(\r\n                  content,\r\n                  'application/xml'\r\n                );\r\n              }\r\n            } else if (type === 'arraybuffer') {\r\n              source = content;\r\n            }\r\n            if (source) {\r\n              const features = format.readFeatures(source, { extent, featureProjection: projection });\r\n              vectorSource.addFeatures(features, format.readProjection(source));\r\n              success(features);\r\n            } else {\r\n              onError();\r\n            }\r\n          }\r\n        });\r\n\r\n    } else {\r\n    xhr.open( 'GET', modifiedUrl);\r\n    const format = vectorSource.getFormat();\r\n    if (format.getType() === 'arraybuffer') {\r\n      xhr.responseType = 'arraybuffer';\r\n    }\r\n    if (interceptor) {\r\n      interceptor.interceptXhr(xhr, modifiedUrl);\r\n    }\r\n\r\n    const onError = () => {\r\n      vectorSource.removeLoadedExtent(extent);\r\n      failure();\r\n    };\r\n    xhr.onerror = onError;\r\n    xhr.onload = () => {\r\n      // status will be 0 for file:// urls\r\n      if (!xhr.status || (xhr.status >= 200 && xhr.status < 300)) {\r\n        const type = format.getType();\r\n        let source;\r\n        if (type === 'json' || type === 'text') {\r\n          source = xhr.responseText;\r\n        } else if (type === 'xml') {\r\n          source = xhr.responseXML;\r\n          if (!source) {\r\n            source = new DOMParser().parseFromString(\r\n              xhr.responseText,\r\n              'application/xml'\r\n            );\r\n          }\r\n        } else if (type === 'arraybuffer') {\r\n          source = xhr.response;\r\n        }\r\n        if (source) {\r\n          const features = format.readFeatures(source, { extent, featureProjection: projection });\r\n          vectorSource.addFeatures(features, format.readProjection(source));\r\n          success(features);\r\n        } else {\r\n          onError();\r\n        }\r\n      } else {\r\n        onError();\r\n      }\r\n    };\r\n    xhr.send();\r\n  }\r\n  }\r\n}\r\n","export abstract class DataService {\r\n    abstract getData(): string;\r\n}\r\n","import olSourceOSM from 'ol/source/OSM';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { OSMDataSourceOptions } from './osm-datasource.interface';\r\n\r\nexport class OSMDataSource extends DataSource {\r\n  public options: OSMDataSourceOptions;\r\n  public ol: olSourceOSM;\r\n\r\n  protected createOlSource(): olSourceOSM {\r\n    if (!this.options.url) {\r\n      this.options.url = 'https://tile.openstreetmap.org/{z}/{x}/{y}.png';\r\n    }\r\n    return new olSourceOSM(this.options);\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import olSourceXYZ from 'ol/source/XYZ';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { XYZDataSourceOptions } from './xyz-datasource.interface';\r\n\r\nexport class XYZDataSource extends DataSource {\r\n  public options: XYZDataSourceOptions;\r\n  public ol: olSourceXYZ;\r\n\r\n  protected createOlSource(): olSourceXYZ {\r\n    return new olSourceXYZ(this.options);\r\n  }\r\n\r\n  public onUnwatch() {}\r\n\r\n}\r\n","import olSourceVector from 'ol/source/Vector';\r\nimport * as OlLoadingStrategy from 'ol/loadingstrategy';\r\nimport olProjection from 'ol/proj/Projection';\r\nimport * as olproj from 'ol/proj';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { WFSDataSourceOptions } from './wfs-datasource.interface';\r\nimport { WFSService } from './wfs.service';\r\n\r\nimport { OgcFilterWriter } from '../../../filter/shared/ogc-filter';\r\nimport { OgcFilterableDataSourceOptions, OgcFiltersOptions } from '../../../filter/shared/ogc-filter.interface';\r\nimport {\r\n  defaultFieldNameGeometry,\r\n  checkWfsParams,\r\n  getFormatFromOptions,\r\n  buildUrl\r\n} from './wms-wfs.utils';\r\nimport { AuthInterceptor } from '@igo2/auth';\r\n\r\nexport class WFSDataSource extends DataSource {\r\n  public ol: olSourceVector<OlGeometry>;\r\n  public mostRecentIdCallOGCFilter: number = 0;\r\n\r\n  set ogcFilters(value: OgcFiltersOptions) {\r\n    (this.options as OgcFilterableDataSourceOptions).ogcFilters = value;\r\n  }\r\n  get ogcFilters(): OgcFiltersOptions {\r\n    return (this.options as OgcFilterableDataSourceOptions).ogcFilters;\r\n  }\r\n\r\n  constructor(\r\n    public options: WFSDataSourceOptions,\r\n    protected wfsService: WFSService,\r\n    private authInterceptor?: AuthInterceptor\r\n  ) {\r\n    super(checkWfsParams(options, 'wfs'));\r\n\r\n    const ogcFilters = (this.options as OgcFilterableDataSourceOptions).ogcFilters;\r\n    const fieldNameGeometry = this.options.paramsWFS.fieldNameGeometry || defaultFieldNameGeometry;\r\n    const ogcFilterWriter = new OgcFilterWriter();\r\n    (this.options as OgcFilterableDataSourceOptions).ogcFilters =\r\n      ogcFilterWriter.defineOgcFiltersDefaultOptions(ogcFilters, fieldNameGeometry);\r\n    if (\r\n      (this.options as OgcFilterableDataSourceOptions).ogcFilters.enabled &&\r\n      (this.options as OgcFilterableDataSourceOptions).ogcFilters.editable &&\r\n      (options.sourceFields || []).filter(sf => !sf.values).length > 0\r\n    ) {\r\n      this.wfsService.getSourceFieldsFromWFS(this.options);\r\n    }\r\n\r\n    if (ogcFilters?.pushButtons){\r\n      ogcFilters.pushButtons.selectorType = 'pushButton';\r\n    }\r\n    if (ogcFilters?.checkboxes){\r\n      ogcFilters.checkboxes.selectorType = 'checkbox';\r\n    }\r\n    if (ogcFilters?.radioButtons){\r\n      ogcFilters.radioButtons.selectorType = 'radioButton';\r\n    }\r\n    if (ogcFilters?.select){\r\n      ogcFilters.select.selectorType = 'select';\r\n    }\r\n    if (ogcFilters?.autocomplete){\r\n      ogcFilters.autocomplete.selectorType = 'autocomplete';\r\n    }\r\n\r\n    this.setOgcFilters((this.options as OgcFilterableDataSourceOptions).ogcFilters, true);\r\n  }\r\n\r\n  protected createOlSource(): olSourceVector<OlGeometry> {\r\n    const vectorSource = new olSourceVector({\r\n      format: getFormatFromOptions(this.options),\r\n      url: (extent, resolution, proj: olProjection) => {\r\n        const paramsWFS = this.options.paramsWFS;\r\n        const wfsProj = paramsWFS.srsName ? new olProjection({ code: paramsWFS.srsName }) : proj;\r\n        const ogcFilters = (this.options as OgcFilterableDataSourceOptions).ogcFilters;\r\n        const currentExtent = olproj.transformExtent(extent, proj, wfsProj);\r\n        paramsWFS.srsName = paramsWFS.srsName || proj.getCode();\r\n        return buildUrl(this.options, currentExtent, wfsProj, ogcFilters);\r\n      },\r\n      strategy: OlLoadingStrategy.bbox\r\n    });\r\n    return vectorSource;\r\n  }\r\n\r\n  setOgcFilters(ogcFilters: OgcFiltersOptions, triggerEvent: boolean = false) {\r\n    this.ogcFilters = ogcFilters;\r\n    this.mostRecentIdCallOGCFilter += 1;\r\n    if (triggerEvent) {\r\n      this.ol.notify('ogcFilters', this.ogcFilters);\r\n    }\r\n  }\r\n\r\n  public onUnwatch() { }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { combineLatest, Observable, of } from 'rxjs';\r\nimport olFeature from 'ol/Feature';\r\nimport { WFSDataSourceOptions } from './wfs-datasource.interface';\r\nimport { WMSDataSourceOptions } from './wms-datasource.interface';\r\nimport { DataService } from './data.service';\r\nimport { formatWFSQueryString,\r\n          gmlRegex,\r\n          defaultEpsg,\r\n          defaultMaxFeatures,\r\n          getFormatFromOptions} from './wms-wfs.utils';\r\nimport { concatMap } from 'rxjs/operators';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class WFSService extends DataService {\r\n  constructor(private http: HttpClient) {\r\n    super();\r\n  }\r\n\r\n  getData() {\r\n    console.log('This is defining a data service.');\r\n    return 'This is defining a data service.';\r\n  }\r\n\r\n  public getSourceFieldsFromWFS(dataSourceOptions: WFSDataSourceOptions | WMSDataSourceOptions) {\r\n    if (!dataSourceOptions.sourceFields || dataSourceOptions.sourceFields.length === 0 ) {\r\n      dataSourceOptions.sourceFields = [];\r\n      this.defineFieldAndValuefromWFS(dataSourceOptions).subscribe(getfeatureSourceField => {\r\n        dataSourceOptions.sourceFields = getfeatureSourceField;\r\n      });\r\n\r\n    } else {\r\n      this.defineFieldAndValuefromWFS(dataSourceOptions).subscribe(getfeatureSourceField => {\r\n        dataSourceOptions.sourceFields.forEach(sourcefield => {\r\n          if (sourcefield.alias === undefined) {\r\n            sourcefield.alias = sourcefield.name; // to allow only a list of sourcefield with names\r\n          }\r\n          if (sourcefield.values === undefined || sourcefield.values.length === 0) {\r\n            sourcefield.values = getfeatureSourceField.find(sf => sf.name === sourcefield.name).values;\r\n          }\r\n        });\r\n      });\r\n    }\r\n  }\r\n\r\n  private wfsGetFeature(\r\n    dataSourceOptions: WFSDataSourceOptions | WMSDataSourceOptions,\r\n    nb: number = defaultMaxFeatures,\r\n    epsgCode: string = defaultEpsg,\r\n    propertyName?: string,\r\n    startIndex: number = 0,\r\n    forceDefaultOutputFormat: boolean = false\r\n  ): Observable<any> {\r\n    const queryStringValues = formatWFSQueryString(dataSourceOptions, nb, epsgCode, propertyName, startIndex, forceDefaultOutputFormat );\r\n    const baseUrl = queryStringValues.find(f => f.name === 'getfeature').value;\r\n    const outputFormat = dataSourceOptions.paramsWFS.outputFormat;\r\n    if (forceDefaultOutputFormat || gmlRegex.test(outputFormat) || !outputFormat) {\r\n      return this.http.get(baseUrl, { responseType: 'text' });\r\n    } else {\r\n      return this.http.get(baseUrl);\r\n    }\r\n  }\r\n\r\n  defineFieldAndValuefromWFS(\r\n    dataSourceOptions: WFSDataSourceOptions | WMSDataSourceOptions\r\n  ): Observable<any> {\r\n    return new Observable(d => {\r\n      const sourceFields = [];\r\n      let fieldList;\r\n      let fieldListWoGeom;\r\n      let fieldListWoGeomStr;\r\n      let olFormats;\r\n      let effectiveOlFormats;\r\n\r\n      olFormats = getFormatFromOptions(dataSourceOptions);\r\n      const gmlDataSourceOptions: WFSDataSourceOptions | WMSDataSourceOptions = JSON.parse(\r\n        JSON.stringify(dataSourceOptions)\r\n      );\r\n      delete gmlDataSourceOptions.paramsWFS.outputFormat;\r\n      delete (gmlDataSourceOptions as WFSDataSourceOptions).formatOptions;\r\n\r\n      effectiveOlFormats = getFormatFromOptions(gmlDataSourceOptions);\r\n      let sourceFieldsToRetrieveValues = dataSourceOptions.sourceFields?.filter(f => !f.values).map(f => f.name);\r\n\r\n      // Validate if the service manage no outputformat (wfs 1.0.0 and GML is the default return)\r\n      this.wfsGetFeature(dataSourceOptions, 1, undefined, undefined, 0, true).pipe(\r\n        concatMap(res => String(res).toLowerCase().includes('exception') ? of(false) : of(true)),\r\n        concatMap(allowGml => {\r\n          // If the service return GML (return no exception)\r\n          return this.wfsGetFeature(dataSourceOptions, 1).pipe(\r\n            concatMap(firstFeature => {\r\n              const features = olFormats.readFeatures(firstFeature);\r\n              fieldList = features[0].getKeys();\r\n              if (dataSourceOptions.sourceFields || dataSourceOptions.sourceFields.length === 0) {\r\n                sourceFieldsToRetrieveValues = fieldList;\r\n              }\r\n              fieldListWoGeom = fieldList.filter(\r\n                field =>\r\n                  sourceFieldsToRetrieveValues.includes(field) &&\r\n                  field !== features[0].getGeometryName() &&\r\n                  !field.match(/boundedby/gi)\r\n              );\r\n              fieldListWoGeomStr = fieldListWoGeom.join(',');\r\n              const processingArray = [];\r\n              let startIndex = 0;\r\n              // If the service do not allow gml return, dice the call in multiple\r\n              // calls by increment of chunkSize with the original outputFormat\r\n              if (\r\n                !allowGml && dataSourceOptions.paramsWFS.version === '2.0.0' &&\r\n                dataSourceOptions.paramsWFS.maxFeatures > defaultMaxFeatures) {\r\n                const chunkSize = 1000;\r\n                while (startIndex < dataSourceOptions.paramsWFS.maxFeatures) {\r\n                  processingArray.push(this.wfsGetFeature(\r\n                    dataSourceOptions,\r\n                    chunkSize,\r\n                    dataSourceOptions.paramsWFS.srsName,\r\n                    fieldListWoGeomStr,\r\n                    startIndex\r\n                  ));\r\n                  startIndex += chunkSize;\r\n                }\r\n                effectiveOlFormats = olFormats;\r\n              } else {\r\n                processingArray.push(this.wfsGetFeature(\r\n                  dataSourceOptions,\r\n                  dataSourceOptions.paramsWFS.maxFeatures || defaultMaxFeatures,\r\n                  dataSourceOptions.paramsWFS.srsName,\r\n                  fieldListWoGeomStr,\r\n                  0, true\r\n                ));\r\n              }\r\n              return combineLatest(processingArray);\r\n            })\r\n          );\r\n        })).subscribe((results) => {\r\n          let mfeatures: olFeature<OlGeometry>[] = [];\r\n          results.map((result) => {\r\n            const loopFeatures = effectiveOlFormats.readFeatures(result);\r\n            mfeatures = mfeatures.concat(loopFeatures);\r\n          });\r\n          this.built_properties_value(mfeatures).forEach(element => {\r\n            sourceFields.push(element);\r\n          });\r\n          d.next(sourceFields);\r\n          d.complete();\r\n        });\r\n    });\r\n  }\r\n\r\n  private built_properties_value(features: olFeature<OlGeometry>[]): string[] {\r\n    if (features.length === 0) {\r\n      return [];\r\n    }\r\n    const kv = Object.assign({}, features[0].getProperties());\r\n    delete kv[features[0].getGeometryName()];\r\n    delete kv.boundedBy;\r\n    const sourceFields = [];\r\n    for (const property in kv) {\r\n      if (kv.hasOwnProperty(property)) {\r\n        const fieldType =\r\n          typeof features[0].get(property) === 'object'\r\n            ? undefined\r\n            : typeof features[0].get(property);\r\n        sourceFields.push({\r\n          name: property,\r\n          alias: property,\r\n          type: fieldType,\r\n          values: [kv[property]]\r\n        });\r\n      }\r\n    }\r\n    features.every((element) => {\r\n      const featureProperties = element.getProperties();\r\n      for (const key in featureProperties) {\r\n        if (featureProperties.hasOwnProperty(key) && key in kv) {\r\n          sourceFields.filter(f => f.name === key).forEach(v => {\r\n            if (v.values.indexOf(featureProperties[key]) === -1) {\r\n              v.values.push(featureProperties[key]);\r\n            }\r\n          });\r\n        }\r\n      }\r\n      return true;\r\n    });\r\n    return sourceFields;\r\n  }\r\n}\r\n","export enum QueryFormat {\r\n  GML2 = 'gml2',\r\n  GML3 = 'gml3',\r\n  JSON = 'json',\r\n  GEOJSON = 'geojson',\r\n  GEOJSON2 = 'geojson2',\r\n  ESRIJSON = 'esrijson',\r\n  TEXT = 'text',\r\n  HTML = 'html',\r\n  HTMLGML2 = 'htmlgml2'\r\n}\r\n\r\nexport enum QueryFormatMimeType {\r\n  GML2 = 'application/vnd.ogc.gml',\r\n  GML3 = 'application/vnd.ogc.gml/3.1.1',\r\n  JSON = 'application/json',\r\n  GEOJSON = 'application/geojson',\r\n  GEOJSON2 = 'geojson',\r\n  ESRIJSON = 'application/json',\r\n  TEXT = 'text/plain',\r\n  HTML = 'text/html',\r\n  HTMLGML2 = 'text/html'\r\n}\r\n\r\nexport enum QueryHtmlTarget {\r\n  IFRAME = 'iframe',\r\n  BLANK = '_blank'\r\n}\r\n","import olSourceImageWMS from 'ol/source/ImageWMS';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { Legend } from './datasource.interface';\r\nimport { WMSDataSourceOptions } from './wms-datasource.interface';\r\nimport { WFSService } from './wfs.service';\r\n\r\nimport { OgcFilterWriter } from '../../../filter/shared/ogc-filter';\r\nimport { OgcFilterableDataSourceOptions, OgcFiltersOptions, OgcFilterDuringOptions } from '../../../filter/shared/ogc-filter.interface';\r\nimport { QueryHtmlTarget } from '../../../query/shared/query.enums';\r\nimport {\r\n  formatWFSQueryString,\r\n  checkWfsParams,\r\n  defaultFieldNameGeometry\r\n} from './wms-wfs.utils';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\nimport { LegendMapViewOptions } from '../../../layer/shared/layers/layer.interface';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport { TimeFilterableDataSourceOptions, TimeFilterOptions } from '../../../filter/shared/time-filter.interface';\r\n\r\nexport class WMSDataSource extends DataSource {\r\n  public ol: olSourceImageWMS;\r\n\r\n  get params(): any {\r\n    return this.options.params as any;\r\n  }\r\n\r\n  get queryTitle(): string {\r\n    return (this.options as any).queryTitle\r\n      ? (this.options as any).queryTitle\r\n      : 'title';\r\n  }\r\n\r\n  get mapLabel(): string {\r\n    return (this.options as any).mapLabel;\r\n  }\r\n\r\n  get queryHtmlTarget(): string {\r\n    return (this.options as any).queryHtmlTarget\r\n      ? (this.options as any).queryHtmlTarget\r\n      : QueryHtmlTarget.BLANK;\r\n  }\r\n\r\n  set ogcFilters(value: OgcFiltersOptions) {\r\n    (this.options as OgcFilterableDataSourceOptions).ogcFilters = value;\r\n  }\r\n  get ogcFilters(): OgcFiltersOptions {\r\n    return (this.options as OgcFilterableDataSourceOptions).ogcFilters;\r\n  }\r\n\r\n  set timeFilter(value: TimeFilterOptions ) {\r\n    (this.options as TimeFilterableDataSourceOptions).timeFilter = value;\r\n  }\r\n  get timeFilter(): TimeFilterOptions {\r\n    return (this.options as TimeFilterableDataSourceOptions).timeFilter;\r\n  }\r\n  readonly timeFilter$: BehaviorSubject<TimeFilterOptions> = new BehaviorSubject(undefined);\r\n\r\n  constructor(\r\n    public options: WMSDataSourceOptions,\r\n    protected wfsService: WFSService\r\n  ) {\r\n    super(options);\r\n    const sourceParams: any = options.params;\r\n\r\n    const dpi = sourceParams.DPI || 96;\r\n    sourceParams.DPI = dpi;\r\n    sourceParams.MAP_RESOLUTION = dpi;\r\n    sourceParams.FORMAT_OPTIONS = 'dpi:' + dpi;\r\n\r\n    if (options.refreshIntervalSec && options.refreshIntervalSec > 0) {\r\n      setInterval(() => {\r\n        this.refresh();\r\n      }, options.refreshIntervalSec * 1000); // Convert seconds to MS\r\n    }\r\n\r\n    let fieldNameGeometry = defaultFieldNameGeometry;\r\n\r\n    // ####   START if paramsWFS\r\n    if (options.paramsWFS) {\r\n      const wfsCheckup = checkWfsParams(options, 'wms');\r\n      ObjectUtils.mergeDeep(options.paramsWFS, wfsCheckup.paramsWFS);\r\n\r\n      fieldNameGeometry =\r\n        options.paramsWFS.fieldNameGeometry || fieldNameGeometry;\r\n\r\n      options.download = Object.assign({}, options.download, {\r\n        dynamicUrl: this.buildDynamicDownloadUrlFromParamsWFS(options)\r\n      });\r\n    } //  ####   END  if paramsWFS\r\n\r\n    if (!options.sourceFields || options.sourceFields.length === 0) {\r\n      options.sourceFields = [];\r\n    } else {\r\n      options.sourceFields.forEach(sourceField => {\r\n        sourceField.alias = sourceField.alias\r\n          ? sourceField.alias\r\n          : sourceField.name;\r\n        // to allow only a list of sourcefield with names\r\n      });\r\n    }\r\n    const initOgcFilters = (options as OgcFilterableDataSourceOptions)\r\n      .ogcFilters;\r\n    const ogcFilterWriter = new OgcFilterWriter();\r\n\r\n    if (!initOgcFilters) {\r\n      (options as OgcFilterableDataSourceOptions).ogcFilters = ogcFilterWriter.defineOgcFiltersDefaultOptions(\r\n        initOgcFilters,\r\n        fieldNameGeometry,\r\n        'wms'\r\n      );\r\n    } else {\r\n      initOgcFilters.advancedOgcFilters = (initOgcFilters.pushButtons || initOgcFilters.checkboxes\r\n        || initOgcFilters.radioButtons || initOgcFilters.select || initOgcFilters.autocomplete)\r\n        ? false\r\n        : true;\r\n      if (initOgcFilters.advancedOgcFilters && initOgcFilters.filters) {\r\n          const filterDuring = initOgcFilters.filters as OgcFilterDuringOptions;\r\n          if(filterDuring.calendarModeYear) {\r\n            initOgcFilters.advancedOgcFilters = false;\r\n          }\r\n      }\r\n      if (initOgcFilters.pushButtons){\r\n        initOgcFilters.pushButtons.selectorType = 'pushButton';\r\n      }\r\n      if (initOgcFilters.checkboxes){\r\n        initOgcFilters.checkboxes.selectorType = 'checkbox';\r\n      }\r\n      if (initOgcFilters.radioButtons){\r\n        initOgcFilters.radioButtons.selectorType = 'radioButton';\r\n      }\r\n      if (initOgcFilters.select){\r\n        initOgcFilters.select.selectorType = 'select';\r\n      }\r\n      if (initOgcFilters.autocomplete){\r\n        initOgcFilters.autocomplete.selectorType = 'autocomplete';\r\n      }\r\n    }\r\n\r\n    if (\r\n      sourceParams.LAYERS.split(',').length > 1 &&\r\n      initOgcFilters &&\r\n      initOgcFilters.enabled\r\n    ) {\r\n      console.log('*******************************');\r\n      console.log(\r\n        'BE CAREFULL, YOUR WMS LAYERS (' +\r\n          sourceParams.LAYERS +\r\n          ') MUST SHARE THE SAME FIELDS TO ALLOW ogcFilters TO WORK !! '\r\n      );\r\n      console.log('*******************************');\r\n    }\r\n\r\n    if (\r\n      options.paramsWFS &&\r\n      initOgcFilters &&\r\n      initOgcFilters.enabled &&\r\n      initOgcFilters.editable &&\r\n      (options.sourceFields || []).filter(sf => !sf.values).length > 0) {\r\n      this.wfsService.getSourceFieldsFromWFS(options);\r\n    }\r\n\r\n    const filterQueryString = ogcFilterWriter.handleOgcFiltersAppliedValue(\r\n      options,\r\n      fieldNameGeometry\r\n    );\r\n    sourceParams.FILTER = filterQueryString;\r\n    this.ol.updateParams({'FILTER': sourceParams.FILTER});\r\n    this.setOgcFilters(initOgcFilters, true);\r\n\r\n    const timeFilterableDataSourceOptions = (options as TimeFilterableDataSourceOptions);\r\n    if (\r\n      timeFilterableDataSourceOptions?.timeFilterable &&\r\n      timeFilterableDataSourceOptions?.timeFilter) {\r\n      this.setTimeFilter(timeFilterableDataSourceOptions.timeFilter, true);\r\n    }\r\n  }\r\n\r\n  refresh() {\r\n    this.ol.updateParams({ igoRefresh: Math.random() });\r\n  }\r\n\r\n  private buildDynamicDownloadUrlFromParamsWFS(asWFSDataSourceOptions) {\r\n    const queryStringValues = formatWFSQueryString(asWFSDataSourceOptions);\r\n    const downloadUrl = queryStringValues.find(f => f.name === 'getfeature')\r\n      .value;\r\n    return downloadUrl;\r\n  }\r\n\r\n  protected createOlSource(): olSourceImageWMS {\r\n    return new olSourceImageWMS(Object.assign({ratio: 1}, this.options));\r\n  }\r\n\r\n  setOgcFilters(ogcFilters: OgcFiltersOptions, triggerEvent: boolean = false) {\r\n    this.ogcFilters = ogcFilters;\r\n    if (triggerEvent) {\r\n      this.ol.notify('ogcFilters', this.ogcFilters);\r\n    }\r\n  }\r\n\r\n  setTimeFilter(timeFilter: TimeFilterOptions, triggerEvent: boolean = false) {\r\n    this.timeFilter = timeFilter;\r\n    if (triggerEvent) {\r\n      this.timeFilter$.next(this.timeFilter);\r\n      this.ol.notify('timeFilter', this.ogcFilters);\r\n    }\r\n  }\r\n\r\n  getLegend(style?: string, view?: LegendMapViewOptions): Legend[] {\r\n    let legend = super.getLegend();\r\n    if (legend.length > 0 && (style === undefined && !view?.scale)) {\r\n      return legend;\r\n    }\r\n\r\n    let contentDependent = false;\r\n    let projParam;\r\n\r\n    if (view?.size && view?.extent && view?.projection && this.options.contentDependentLegend) {\r\n      projParam = this.params.VERSION === '1.3.0' || this.params.VERSION === undefined ? 'CRS' : 'SRS';\r\n      contentDependent = true;\r\n    }\r\n\r\n    const sourceParams = this.params;\r\n\r\n    let layers = [];\r\n    if (sourceParams.LAYERS !== undefined) {\r\n      layers = sourceParams.LAYERS.split(',');\r\n    }\r\n\r\n    const baseUrl = this.options.url.replace(/\\?$/, '');\r\n    const params = [\r\n      'REQUEST=GetLegendGraphic',\r\n      'SERVICE=WMS',\r\n      'FORMAT=image/png',\r\n      'SLD_VERSION=1.1.0',\r\n      `VERSION=${sourceParams.VERSION || '1.3.0'}`\r\n    ];\r\n    if (style !== undefined) {\r\n      params.push(`STYLE=${style}`);\r\n    }\r\n    if (view?.scale !== undefined) {\r\n      params.push(`SCALE=${view.scale}`);\r\n    }\r\n    if (contentDependent) {\r\n      params.push(`WIDTH=${view.size[0]}`);\r\n      params.push(`HEIGHT=${view.size[1]}`);\r\n      params.push(`BBOX=${view.extent.join(',')}`);\r\n      params.push(`${projParam}=${view.projection}`);\r\n    }\r\n\r\n    legend = layers.map((layer: string) => {\r\n      const separator = baseUrl.match(/\\?/) ? '&' : '?';\r\n      return {\r\n        url: `${baseUrl}${separator}${params.join('&')}&LAYER=${layer}`,\r\n        title: layers.length > 1 ? layer : undefined,\r\n        currentStyle: style === undefined ? undefined : style as string\r\n      };\r\n    });\r\n\r\n    return legend;\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import olTileGridWMTS from 'ol/tilegrid/WMTS';\r\nimport * as olproj from 'ol/proj';\r\nimport {\r\n  getTopLeft as extentGetTopLeft,\r\n  getWidth as extentGetWidth\r\n} from 'ol/extent.js';\r\n\r\nexport function createDefaultTileGrid(epsg?: string): olTileGridWMTS {\r\n  const projection = epsg ? olproj.get(epsg) : olproj.get('EPSG:3857');\r\n  const projectionExtent = projection.getExtent();\r\n  const size = extentGetWidth(projectionExtent) / 256;\r\n  const resolutions = new Array(20);\r\n  const matrixIds = new Array(20);\r\n  for (let z = 0; z < 20; ++z) {\r\n    resolutions[z] = size / Math.pow(2, z);\r\n    matrixIds[z] = z;\r\n  }\r\n\r\n  return new olTileGridWMTS({\r\n    origin: extentGetTopLeft(projectionExtent),\r\n    resolutions,\r\n    matrixIds\r\n  });\r\n}\r\n","import { Options } from 'ol/source/WMTS';\r\nimport olSourceWMTS from 'ol/source/WMTS';\r\n\r\nimport { createDefaultTileGrid } from '../../utils/tilegrid';\r\nimport { DataSource } from './datasource';\r\nimport { WMTSDataSourceOptions } from './wmts-datasource.interface';\r\n\r\nexport class WMTSDataSource extends DataSource {\r\n  public options: WMTSDataSourceOptions;\r\n  public ol: olSourceWMTS;\r\n\r\n  constructor(options: WMTSDataSourceOptions) {\r\n    super(options);\r\n  }\r\n\r\n  protected createOlSource(): olSourceWMTS {\r\n    const sourceOptions = Object.assign(\r\n      {\r\n        tileGrid: createDefaultTileGrid(this.options.projection as string)\r\n      },\r\n      this.options\r\n    ) as Options;\r\n\r\n    return new olSourceWMTS(sourceOptions);\r\n  }\r\n\r\n  public onUnwatch() {}\r\n\r\n}\r\n","import olSourceCarto from 'ol/source/CartoDB';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { Legend } from './datasource.interface';\r\nimport { CartoDataSourceOptions } from './carto-datasource.interface';\r\nimport { QueryHtmlTarget } from '../../../query/shared/query.enums';\r\n\r\nexport class CartoDataSource extends DataSource {\r\n  public ol: olSourceCarto;\r\n  public options: CartoDataSourceOptions;\r\n\r\n  get params(): any {\r\n    return this.options.params as any;\r\n  }\r\n\r\n  get queryTitle(): string {\r\n    return (this.options as any).queryTitle\r\n      ? (this.options as any).queryTitle\r\n      : 'title';\r\n  }\r\n\r\n  get mapLabel(): string {\r\n    return (this.options as any).mapLabel;\r\n  }\r\n\r\n  get queryHtmlTarget(): string {\r\n    return (this.options as any).queryHtmlTarget\r\n      ? (this.options as any).queryHtmlTarget\r\n      : QueryHtmlTarget.BLANK;\r\n  }\r\n\r\n  protected createOlSource(): olSourceCarto {\r\n    const crossOrigin = this.options.crossOrigin\r\n      ? this.options.crossOrigin\r\n      : 'anonymous';\r\n    const sourceOptions = Object.assign(\r\n      {\r\n        crossOrigin\r\n      },\r\n      this.options\r\n    );\r\n    return new olSourceCarto(sourceOptions);\r\n  }\r\n\r\n  getLegend(): Legend[] {\r\n    const legend = super.getLegend();\r\n    if (legend.length > 0) {\r\n      return legend;\r\n    }\r\n\r\n    let htmlString = '<table>';\r\n    if (this.options.config.layers[0].legend !== null) {\r\n      this.options.config.layers[0].legend.items.forEach(f => {\r\n        if (f.visible === true) {\r\n          htmlString +=\r\n            '<tr><td>' +\r\n            '<p><font size=\"5\" color=\"' +\r\n            f.value +\r\n            '\"> &#9679</font></p></td>' +\r\n            '<td>' +\r\n            f.name +\r\n            '</td></tr>';\r\n        }\r\n      });\r\n      htmlString += '</table>';\r\n      return [{ html: htmlString }];\r\n    } else {\r\n      // Try to build the legend from the cartocss options\r\n      const layerOptions = this.options.config.layers[0].options;\r\n      // All available cartocss style options\r\n      const types = [\r\n        'polygon-fill:',\r\n        'marker-fill:',\r\n        'shield-fill:',\r\n        'building-fill:',\r\n        'line-color:'\r\n      ];\r\n      for (const oneType of types) {\r\n        if (layerOptions.cartocss.includes(oneType)) {\r\n          const type = layerOptions.cartocss.split(oneType).pop();\r\n          const color = type.substr(0, type.indexOf(';'));\r\n          if (color.includes('ramp')) {\r\n            const colors = color.split(', (')[1].split(',');\r\n            const data = color.split(', (')[2].split(',');\r\n            for (let j = 0; j < colors.length; j++) {\r\n              colors[j] = colors[j].replace(/(\"|\\))/g, '');\r\n              data[j] = data[j].replace(/(\"|\\))/g, '');\r\n              if (data[j].replace(/\\s+/g, '') === '=') {\r\n                data[j] = 'Autres';\r\n              }\r\n              htmlString +=\r\n                '<tr><td>' +\r\n                '<p><font size=\"5\" color=\"' +\r\n                colors[j] +\r\n                '\"> &#9679</font></p></td>' +\r\n                '<td>' +\r\n                data[j] +\r\n                '</td></tr>';\r\n            }\r\n            break;\r\n          } else {\r\n            const title = layerOptions.layer_name\r\n              ? layerOptions.layer_name\r\n              : '';\r\n            htmlString +=\r\n              '<tr><td>' +\r\n              '<p><font size=\"5\" color=\"' +\r\n              color +\r\n              '\"> &#9679</font></p>' +\r\n              '</td><td>' +\r\n              title +\r\n              '</td></tr>';\r\n            break;\r\n          }\r\n        }\r\n      }\r\n      htmlString += '</table>';\r\n      return [{ html: htmlString }];\r\n    }\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import olSourceVector from 'ol/source/Vector';\r\nimport olFormatEsriJSON from 'ol/format/EsriJSON';\r\nimport * as olloadingstrategy from 'ol/loadingstrategy';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { Legend } from './datasource.interface';\r\nimport { ArcGISRestDataSourceOptions } from './arcgisrest-datasource.interface';\r\n\r\nexport class ArcGISRestDataSource extends DataSource {\r\n  public ol: olSourceVector<OlGeometry>;\r\n  public options: ArcGISRestDataSourceOptions;\r\n\r\n  protected createOlSource(): olSourceVector<OlGeometry> {\r\n    const esrijsonFormat = new olFormatEsriJSON();\r\n    return new olSourceVector({\r\n      attributions: this.options.params.attributions,\r\n      overlaps: false,\r\n      format: esrijsonFormat,\r\n      url: function(extent, resolution, proj) {\r\n        const baseUrl = this.options.url + '/' + this.options.layer + '/query/';\r\n        const geometry = encodeURIComponent(\r\n          '{\"xmin\":' +\r\n            extent[0] +\r\n            ',\"ymin\":' +\r\n            extent[1] +\r\n            ',\"xmax\":' +\r\n            extent[2] +\r\n            ',\"ymax\":' +\r\n            extent[3] +\r\n            ',\"spatialReference\":{\"wkid\":102100}}'\r\n        );\r\n        const params = [\r\n          'f=json',\r\n          `geometry=${geometry}`,\r\n          'geometryType=esriGeometryEnvelope',\r\n          'inSR=102100',\r\n          'spatialRel=esriSpatialRelIntersects',\r\n          'outFields=*',\r\n          'returnGeometry=true',\r\n          'outSR=102100'\r\n        ];\r\n        if (this.options.params.time) {\r\n          const time = `time=${this.options.params.time}`;\r\n          params.push(time);\r\n        }\r\n        if (this.options.params.customParams) {\r\n          this.options.params.customParams.forEach(element => {\r\n            params.push(element);\r\n          });\r\n        }\r\n        return `${baseUrl}?${params.join('&')}`;\r\n      }.bind(this),\r\n      strategy: olloadingstrategy.bbox\r\n    });\r\n  }\r\n\r\n  getLegend(): Legend[] {\r\n    const legendInfo = this.options.legendInfo;\r\n    const legend = super.getLegend();\r\n    if (legendInfo === undefined || legend.length > 0) {\r\n      return legend;\r\n    }\r\n    if (!legendInfo) {\r\n      return;\r\n    }\r\n    let htmlString = '<table>';\r\n    let src: string;\r\n    let label: string;\r\n    let svg: string;\r\n\r\n    if (legendInfo.legend) {\r\n      for (const legendElement of legendInfo.legend) {\r\n        src = this.htmlImgSrc(legendElement.contentType, legendElement.imageData);\r\n        label = legendElement.label ? legendElement.label.replace('<Null>', 'Null') : '';\r\n        htmlString +=\r\n          `<tr><td align='left'><img src=\"` +\r\n          src +\r\n          `\" alt ='' /></td><td class=\"mat-typography\">` +\r\n          label +\r\n          '</td></tr>';\r\n      }\r\n    } else if (legendInfo.type === \"uniqueValue\") {\r\n      for (const legendElement of legendInfo.uniqueValueInfos) {\r\n        label = legendElement.label.replace('<Null>', 'Null');\r\n        if (legendElement.symbol.type === 'esriPMS') {\r\n          src = this.htmlImgSrc(legendElement.symbol.contentType, legendElement.symbol.imageData);\r\n          htmlString +=\r\n            `<tr><td align='left'><img src=\"` +\r\n            src +\r\n            `\" alt ='' /></td><td class=\"mat-typography\">` +\r\n            label +\r\n            '</td></tr>';\r\n        } else if (legendElement.symbol.type !== 'esriPMS') {\r\n          svg = this.createSVG(legendElement.symbol);\r\n          htmlString += `<tr><td align='left'>` + svg + `</td><td class=\"mat-typography\">` + label + '</td></tr>';\r\n        }\r\n      }\r\n    } else if (legendInfo.type === \"simple\") {\r\n      label = legendInfo.label ? legendInfo.label.replace('<Null>', 'Null') : '';\r\n      if (legendInfo.symbol.type === 'esriPMS') {\r\n        src = this.htmlImgSrc(legendInfo.symbol.contentType, legendInfo.symbol.imageData);\r\n        htmlString +=\r\n          `<tr><td align='left'><img src=\"` +\r\n          src +\r\n          `\" alt ='' /></td><td class=\"mat-typography\">` +\r\n          label +\r\n          '</td></tr>';\r\n      } else if (legendInfo.symbol.type !== 'esriPMS') {\r\n        svg = this.createSVG(legendInfo.symbol);\r\n        htmlString += `<tr><td align='left'>` + svg + `</td><td class=\"mat-typography\">` + label + '</td></tr>';\r\n      }\r\n    }\r\n    htmlString += '</table>';\r\n    return [{ html: htmlString }];\r\n  }\r\n\r\n  htmlImgSrc(contentType: string, imageData: string): string {\r\n    return `data:${contentType};base64,${imageData}`;\r\n  }\r\n\r\n  createSVG(symbol): string {\r\n    let svg: string = '';\r\n\r\n    const color: Array<number> = symbol.color ? symbol.color : [0, 0, 0, 0];\r\n\r\n    if (symbol.type === 'esriSLS') {\r\n      const width: number = symbol.width ? symbol.width : 0;\r\n\r\n      const stroke: string = `stroke:rgba(` + color[0] + ',' + color[1] + ',' + color[2] + ',' + color[3] + ')';\r\n      const strokeWidth: string = `stroke-width:` + width;\r\n\r\n      if (symbol.style === 'esriSLSSolid') {\r\n        svg = `<svg height=\"30\" width=\"30\"><line x1=\"0\" y1=\"15\" x2=\"30\" y2=\"15\" style=\"` + stroke + ';' + strokeWidth + `\"/></svg>`;\r\n      } else if (symbol.style === 'esriSLSDash') {\r\n        const strokeDashArray: string = `stroke-dasharray=\"5,5\"`;\r\n        svg = `<svg height=\"30\" width=\"30\"><line x1=\"0\" y1=\"15\" x2=\"30\" y2=\"15\" style=\"` + stroke + ';' + strokeWidth + `\" `+ strokeDashArray + `/></svg>`;\r\n      }\r\n    } else if (symbol.style === 'esriSMSCircle' || symbol.style === 'esriSFSSolid') {\r\n      const outlineColor = symbol.outline.color;\r\n      const outlineWidth = symbol.outline.width;\r\n      const size = symbol.size;\r\n\r\n      const stroke = `stroke:rgba(` + outlineColor[0] + ',' + outlineColor[1] + ',' + outlineColor[2] + ',' + outlineColor[3] + ')';\r\n      const strokeWidth = `stroke-width:` + outlineWidth;\r\n      const fill = `fill:rgba(` + color[0] + ',' + color[1] + ',' + color[2] + ',' + color[3] + ')';\r\n\r\n      if (symbol.style === 'esriSMSCircle') {\r\n        svg = `<svg height=\"30\" width=\"30\"><circle cx=\"15\" cy=\"15\" r=\"` + size/2 + `\" style=\"` + stroke + ';' + strokeWidth + ';' + fill + `\"/></svg>`;\r\n      } else {\r\n        svg = `<svg height=\"30\" width=\"30\"><rect x=\"5\" y=\"5\" width=\"20\" height=\"20\" style =\"` + stroke + ';' + strokeWidth + ';' + fill + `\"/></svg>`;\r\n      }\r\n    }\r\n    return svg;\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import ImageArcGISRest from 'ol/source/ImageArcGISRest';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { Legend } from './datasource.interface';\r\nimport { ArcGISRestImageDataSourceOptions } from './imagearcgisrest-datasource.interface';\r\nimport { QueryHtmlTarget } from '../../../query/shared/query.enums';\r\nexport class ImageArcGISRestDataSource extends DataSource {\r\n  public ol: ImageArcGISRest;\r\n  public options: ArcGISRestImageDataSourceOptions;\r\n\r\n  get params(): any {\r\n    return this.options.params as any;\r\n  }\r\n\r\n  get queryTitle(): string {\r\n    return (this.options as any).queryTitle\r\n      ? (this.options as any).queryTitle\r\n      : 'title';\r\n  }\r\n\r\n  get mapLabel(): string {\r\n    return (this.options as any).mapLabel;\r\n  }\r\n\r\n  get queryHtmlTarget(): string {\r\n    return (this.options as any).queryHtmlTarget\r\n      ? (this.options as any).queryHtmlTarget\r\n      : QueryHtmlTarget.BLANK;\r\n  }\r\n\r\n  protected createOlSource(): ImageArcGISRest {\r\n    const params = this.options.layer === undefined ? this.options.params : Object.assign(\r\n      {LAYERS: `show:${this.options.layer}`},\r\n      this.options.params\r\n    );\r\n\r\n    if (typeof params.renderingRule === 'object') {\r\n      params.renderingRule = JSON.stringify(params.renderingRule);\r\n    }\r\n\r\n    return new ImageArcGISRest({\r\n      ratio: 1,\r\n      params,\r\n      url: this.options.url\r\n    });\r\n  }\r\n\r\n  getLegend(): Legend[] {\r\n    const legendInfo = this.options.legendInfo;\r\n    const legend = super.getLegend();\r\n    if (legendInfo === undefined || this.options.layer === undefined || legend.length > 0) {\r\n      return legend;\r\n    }\r\n\r\n    if (!legendInfo) {\r\n      return;\r\n    }\r\n    let htmlString = '<table>';\r\n\r\n    for (const legendElement of legendInfo.legend) {\r\n      const src = `${this.options.url}/${legendInfo.layerId}/images/${legendElement.url}`;\r\n      const label = legendElement.label.replace('<Null>', 'Null');\r\n      htmlString +=\r\n        `<tr><td align='left'><img src=\"` +\r\n        src +\r\n        `\" alt ='' /></td><td class=\"mat-typography\">` +\r\n        label +\r\n        '</td></tr>';\r\n    }\r\n    htmlString += '</table>';\r\n    return [{ html: htmlString }];\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import olSourceTileArcGISRest from 'ol/source/TileArcGISRest';\r\nimport { Options } from 'ol/source/TileArcGISRest';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { Legend } from './datasource.interface';\r\nimport { TileArcGISRestDataSourceOptions } from './tilearcgisrest-datasource.interface';\r\nimport { QueryHtmlTarget } from '../../../query/shared/query.enums';\r\n\r\nexport class TileArcGISRestDataSource extends DataSource {\r\n  public ol: olSourceTileArcGISRest;\r\n  public options: TileArcGISRestDataSourceOptions;\r\n\r\n  get params(): any {\r\n    return this.options.params as any;\r\n  }\r\n\r\n  get queryTitle(): string {\r\n    return (this.options as any).queryTitle\r\n      ? (this.options as any).queryTitle\r\n      : 'title';\r\n  }\r\n\r\n  get mapLabel(): string {\r\n    return (this.options as any).mapLabel;\r\n  }\r\n\r\n  get queryHtmlTarget(): string {\r\n    return (this.options as any).queryHtmlTarget\r\n      ? (this.options as any).queryHtmlTarget\r\n      : QueryHtmlTarget.BLANK;\r\n  }\r\n\r\n  protected createOlSource(): olSourceTileArcGISRest {\r\n    return new olSourceTileArcGISRest(this.options as Options);\r\n  }\r\n\r\n  getLegend(): Legend[] {\r\n    const legendInfo = this.options.legendInfo;\r\n    const legend = super.getLegend();\r\n    if (legendInfo === undefined || this.options.layer === undefined || legend.length > 0) {\r\n      return legend;\r\n    }\r\n\r\n    if (!legendInfo) {\r\n      return;\r\n    }\r\n    let htmlString = '<table>';\r\n\r\n    for (const legendElement of legendInfo.legend) {\r\n      const src = `${this.options.url}/${legendInfo.layerId}/images/${legendElement.url}`;\r\n      const label = legendElement.label.replace('<Null>', 'Null');\r\n      htmlString +=\r\n        `<tr><td align='left'><img src=\"` +\r\n        src +\r\n        `\" alt ='' /></td><td class=\"mat-typography\">` +\r\n        label +\r\n        '</td></tr>';\r\n    }\r\n    htmlString += '</table>';\r\n    return [{ html: htmlString }];\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import TileDebug from 'ol/source/TileDebug';\r\nimport TileGrid from 'ol/tilegrid/TileGrid';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { TileDebugDataSourceOptions } from './tiledebug-datasource.interface';\r\n\r\nexport class TileDebugDataSource extends DataSource {\r\n  public options: TileDebugDataSourceOptions;\r\n  public ol: TileDebug;\r\n\r\n  protected createOlSource(): TileDebug {\r\n    const baseOptions = JSON.parse(JSON.stringify(this.options)); // to avoid to alter the original options\r\n    if (this.options.tileGrid) {\r\n      delete baseOptions.tileGrid;\r\n      baseOptions.tileGrid = new TileGrid(this.options.tileGrid);\r\n    }\r\n    return new TileDebug(baseOptions);\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import olSourceVector from 'ol/source/Vector';\r\nimport olFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport { FeatureDataSource } from './feature-datasource';\r\nimport { WebSocketDataSourceOptions } from './websocket-datasource.interface';\r\n\r\nexport class WebSocketDataSource extends FeatureDataSource {\r\n  public ws: WebSocket;\r\n  public options: WebSocketDataSourceOptions;\r\n\r\n  protected createOlSource(): olSourceVector<OlGeometry> {\r\n    this.createWebSocket();\r\n    this.options.format = this.getSourceFormatFromOptions(this.options);\r\n    return super.createOlSource();\r\n  }\r\n\r\n  private createWebSocket() {\r\n    this.ws = new WebSocket(this.options.url);\r\n    this.ws.onmessage = this.onMessage.bind(this);\r\n\r\n    if (this.options.onclose) {\r\n      this.ws.onclose = this.onClose.bind(this);\r\n    }\r\n\r\n    if (this.options.onerror) {\r\n      this.ws.onerror = this.onError.bind(this);\r\n    }\r\n\r\n    if (this.options.onopen) {\r\n      this.ws.onopen = this.onOpen.bind(this);\r\n    }\r\n  }\r\n\r\n  onMessage(event) {\r\n    const featureAdded = this.options.format.readFeature(event.data) as olFeature<OlGeometry>;\r\n\r\n    switch (this.options.onmessage) {\r\n      case 'update':\r\n        // ol don't add if same ID\r\n        const featureToRemove = this.ol.getFeatureById(featureAdded.getId());\r\n        if (featureToRemove) {\r\n          this.ol.removeFeature(featureToRemove);\r\n        }\r\n        this.ol.addFeature(featureAdded);\r\n        break;\r\n      case 'delete':\r\n        this.ol.clear(true);\r\n        this.ol.addFeature(featureAdded);\r\n        break;\r\n      case 'add':\r\n      default:\r\n        this.ol.addFeature(featureAdded);\r\n    }\r\n  }\r\n\r\n  onClose(event) {\r\n    // thrown message to user\r\n  }\r\n\r\n  onError(event) {\r\n    // thrown message to user\r\n  }\r\n\r\n  onOpen(event) {\r\n    // thrown message to user ?\r\n  }\r\n\r\n  public onUnwatch() {\r\n    this.ws.close();\r\n  }\r\n}\r\n","import { Md5 } from 'ts-md5';\r\nimport feature from 'ol/Feature';\r\nimport olSourceVectorTile from 'ol/source/VectorTile';\r\nimport olFormatMVT from 'ol/format/MVT';\r\n\r\nimport { uuid } from '@igo2/utils';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { MVTDataSourceOptions } from './mvt-datasource.interface';\r\n\r\nexport class MVTDataSource extends DataSource {\r\n  public options: MVTDataSourceOptions;\r\n  public ol: olSourceVectorTile;\r\n\r\n  protected createOlSource(): olSourceVectorTile {\r\n    let mvtFormat;\r\n    if (this.options.featureClass === 'feature') {\r\n      mvtFormat = new olFormatMVT({featureClass: feature});\r\n    } else {\r\n      mvtFormat = new olFormatMVT();\r\n    }\r\n    this.options.format = mvtFormat;\r\n    return new olSourceVectorTile(this.options);\r\n  }\r\n\r\n  protected generateId() {\r\n    if (!this.options.url) {\r\n        return uuid();\r\n    }\r\n    const chain = 'mvt' + this.options.url;\r\n    return Md5.hashStr(chain) as string;\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import * as olstyle from 'ol/style';\r\nimport * as olproj from 'ol/proj';\r\n\r\nexport class EsriStyleGenerator {\r\n  public _converters: any;\r\n  public _renderers: any;\r\n\r\n  constructor() {\r\n    this._converters = {};\r\n    this._converters.esriPMS = EsriStyleGenerator._convertEsriPMS;\r\n    this._converters.esriSFS = EsriStyleGenerator._convertEsriSFS;\r\n    this._converters.esriSLS = EsriStyleGenerator._convertEsriSLS;\r\n    this._converters.esriSMS = EsriStyleGenerator._convertEsriSMS;\r\n    this._converters.esriTS = EsriStyleGenerator._convertEsriTS;\r\n    this._renderers = {};\r\n    this._renderers.uniqueValue = this._renderUniqueValue;\r\n    this._renderers.simple = this._renderSimple;\r\n    this._renderers.classBreaks = this._renderClassBreaks;\r\n  }\r\n  static _convertPointToPixel(point) {\r\n    return point / 0.75;\r\n  }\r\n  static _transformColor(color): [number, number, number, number] {\r\n    // alpha channel is different, runs from 0-255 but in ol3 from 0-1\r\n    return [color[0], color[1], color[2], color[3] / 255];\r\n  }\r\n\r\n  static _getResolutionForScale(scale, units) {\r\n    const dpi = 96;\r\n    const mpu = olproj.METERS_PER_UNIT[units];\r\n    const inchesPerMeter = 39.3701;\r\n    return parseFloat(scale) / (mpu * inchesPerMeter * dpi);\r\n  }\r\n\r\n  /* convert an Esri Text Symbol */\r\n  static _convertEsriTS(symbol) {\r\n    const rotation = EsriStyleGenerator._transformAngle(symbol.angle);\r\n    const text = symbol.text !== undefined ? symbol.text : undefined;\r\n    return new olstyle.Style({\r\n      text: new olstyle.Text({\r\n        fill: new olstyle.Fill({\r\n          color: EsriStyleGenerator._transformColor(symbol.color)\r\n        }),\r\n        font:\r\n          symbol.font.style +\r\n          ' ' +\r\n          symbol.font.weight +\r\n          ' ' +\r\n          symbol.font.size +\r\n          ' px ' +\r\n          symbol.font.family,\r\n        textBaseline: symbol.verticalAlignment,\r\n        textAlign: symbol.horizontalAlignment,\r\n        offsetX: EsriStyleGenerator._convertPointToPixel(symbol.xoffset),\r\n        offsetY: EsriStyleGenerator._convertPointToPixel(symbol.yoffset),\r\n        rotation,\r\n        text\r\n      })\r\n    });\r\n  }\r\n  /* convert an Esri Picture Marker Symbol */\r\n  static _convertEsriPMS(symbol) {\r\n    const src = 'data:' + symbol.contentType + ';base64, ' + symbol.imageData;\r\n    const rotation = EsriStyleGenerator._transformAngle(symbol.angle);\r\n\r\n    return new olstyle.Style({\r\n      image: new olstyle.Icon({\r\n        src,\r\n        rotation\r\n      })\r\n    });\r\n  }\r\n  /* convert an Esri Simple Fill Symbol */\r\n  static _convertEsriSFS(symbol) {\r\n    // there is no support in openlayers currently for fill patterns, so style is not interpreted\r\n    const fill = new olstyle.Fill({\r\n      color: EsriStyleGenerator._transformColor(symbol.color)\r\n    });\r\n    const stroke = symbol.outline\r\n      ? EsriStyleGenerator._convertOutline(symbol.outline)\r\n      : undefined;\r\n    return new olstyle.Style({\r\n      fill,\r\n      stroke\r\n    });\r\n  }\r\n  static _convertOutline(outline) {\r\n    let lineDash;\r\n    const color = EsriStyleGenerator._transformColor(outline.color);\r\n    if (outline.style === 'esriSLSDash') {\r\n      lineDash = [5];\r\n    } else if (outline.style === 'esriSLSDashDot') {\r\n      lineDash = [5, 5, 1, 2];\r\n    } else if (outline.style === 'esriSLSDashDotDot') {\r\n      lineDash = [5, 5, 1, 2, 1, 2];\r\n    } else if (outline.style === 'esriSLSDot') {\r\n      lineDash = [1, 2];\r\n    } else if (outline.style === 'esriSLSNull') {\r\n      // line not visible, make color fully transparent\r\n      color[3] = 0;\r\n    }\r\n    return new olstyle.Stroke({\r\n      color,\r\n      lineDash,\r\n      width: EsriStyleGenerator._convertPointToPixel(outline.width)\r\n    });\r\n  }\r\n  /* convert an Esri Simple Line Symbol */\r\n  static _convertEsriSLS(symbol) {\r\n    return new olstyle.Style({\r\n      stroke: EsriStyleGenerator._convertOutline(symbol)\r\n    });\r\n  }\r\n  static _transformAngle(angle) {\r\n    if (angle === 0 || angle === undefined) {\r\n      return undefined;\r\n    }\r\n    const normalRad = (angle * Math.PI) / 180;\r\n    const ol3Rad = -normalRad + Math.PI / 2;\r\n    if (ol3Rad < 0) {\r\n      return 2 * Math.PI + ol3Rad;\r\n    } else {\r\n      return ol3Rad;\r\n    }\r\n  }\r\n  /* convert an Esri Simple Marker Symbol */\r\n  static _convertEsriSMS(symbol) {\r\n    const fill = new olstyle.Fill({\r\n      color: EsriStyleGenerator._transformColor(symbol.color)\r\n    });\r\n    const stroke = symbol.outline\r\n      ? EsriStyleGenerator._convertOutline(symbol.outline)\r\n      : undefined;\r\n    const radius = EsriStyleGenerator._convertPointToPixel(symbol.size) / 2;\r\n    const rotation = EsriStyleGenerator._transformAngle(symbol.angle);\r\n    if (symbol.style === 'esriSMSCircle') {\r\n      return new olstyle.Style({\r\n        image: new olstyle.Circle({\r\n          radius,\r\n          fill,\r\n          stroke\r\n        })\r\n      });\r\n    } else if (symbol.style === 'esriSMSCross') {\r\n      return new olstyle.Style({\r\n        image: new olstyle.RegularShape({\r\n          fill,\r\n          stroke,\r\n          points: 4,\r\n          radius,\r\n          radius2: 0,\r\n          angle: 0,\r\n          rotation\r\n        })\r\n      });\r\n    } else if (symbol.style === 'esriSMSDiamond') {\r\n      return new olstyle.Style({\r\n        image: new olstyle.RegularShape({\r\n          fill,\r\n          stroke,\r\n          points: 4,\r\n          radius,\r\n          rotation\r\n        })\r\n      });\r\n    } else if (symbol.style === 'esriSMSSquare') {\r\n      return new olstyle.Style({\r\n        image: new olstyle.RegularShape({\r\n          fill,\r\n          stroke,\r\n          points: 4,\r\n          radius,\r\n          angle: Math.PI / 4,\r\n          rotation\r\n        })\r\n      });\r\n    } else if (symbol.style === 'esriSMSX') {\r\n      return new olstyle.Style({\r\n        image: new olstyle.RegularShape({\r\n          fill,\r\n          stroke,\r\n          points: 4,\r\n          radius,\r\n          radius2: 0,\r\n          angle: Math.PI / 4,\r\n          rotation\r\n        })\r\n      });\r\n    } else if (symbol.style === 'esriSMSTriangle') {\r\n      return new olstyle.Style({\r\n        image: new olstyle.RegularShape({\r\n          fill,\r\n          stroke,\r\n          points: 3,\r\n          radius,\r\n          angle: 0,\r\n          rotation\r\n        })\r\n      });\r\n    }\r\n  }\r\n\r\n  _convertLabelingInfo(labelingInfo, mapUnits) {\r\n    const styles = [];\r\n    for (let i = 0, ii = labelingInfo.length; i < ii; ++i) {\r\n      const labelExpression = labelingInfo[i].labelExpression;\r\n      // only limited support for label expressions\r\n      const field = labelExpression.substr(\r\n        labelExpression.indexOf('[') + 1,\r\n        labelExpression.indexOf(']') - 1\r\n      );\r\n      const symbol = labelingInfo[i].symbol;\r\n      const maxScale = labelingInfo[i].maxScale;\r\n      const minScale = labelingInfo[i].minScale;\r\n      let minResolution = null;\r\n      if (maxScale !== 0) {\r\n        minResolution = EsriStyleGenerator._getResolutionForScale(\r\n          maxScale,\r\n          mapUnits\r\n        );\r\n      }\r\n      let maxResolution = null;\r\n      if (minScale !== 0) {\r\n        maxResolution = EsriStyleGenerator._getResolutionForScale(\r\n          minScale,\r\n          mapUnits\r\n        );\r\n      }\r\n      const style = this._converters[symbol.type].call(this, symbol);\r\n      styles.push(\r\n        (() => {\r\n          return function(feature, resolution) {\r\n            let visible = true;\r\n            if (this.minResolution !== null && this.maxResolution !== null) {\r\n              visible =\r\n                resolution < this.maxResolution &&\r\n                resolution >= this.minResolution;\r\n            } else if (this.minResolution !== null) {\r\n              visible = resolution >= this.minResolution;\r\n            } else if (this.maxResolution !== null) {\r\n              visible = resolution < this.maxResolution;\r\n            }\r\n            if (visible) {\r\n              const value = feature.get(this.field);\r\n              this.style.getText().setText(value);\r\n              return [this.style];\r\n            }\r\n          };\r\n        })().bind({\r\n          minResolution,\r\n          maxResolution,\r\n          field,\r\n          style\r\n        })\r\n      );\r\n    }\r\n    return styles;\r\n  }\r\n\r\n  _renderSimple(renderer) {\r\n    const style = this._converters[renderer.symbol.type].call(\r\n      this,\r\n      renderer.symbol\r\n    );\r\n    return (() => {\r\n      return () => {\r\n        return [style];\r\n      };\r\n    })();\r\n  }\r\n  _renderClassBreaks(renderer) {\r\n    const defaultSymbol = renderer.defaultSymbol;\r\n    const defaultStyle = this._converters[defaultSymbol.type].call(\r\n      this,\r\n      defaultSymbol\r\n    );\r\n    const field = renderer.field;\r\n    const classes = [];\r\n    for (let i = 0, ii = renderer.classBreakInfos.length; i < ii; ++i) {\r\n      const classBreakInfo = renderer.classBreakInfos[i];\r\n      let min;\r\n      if (\r\n        classBreakInfo.classMinValue === null ||\r\n        classBreakInfo.classMinValue === undefined\r\n      ) {\r\n        if (i === 0) {\r\n          min = renderer.minValue;\r\n        } else {\r\n          min = renderer.classBreakInfos[i - 1].classMaxValue;\r\n        }\r\n      } else {\r\n        min = classBreakInfo.classMinValue;\r\n      }\r\n      const max = classBreakInfo.classMaxValue;\r\n      const symbol = classBreakInfo.symbol;\r\n      const style = this._converters[symbol.type].call(this, symbol);\r\n      classes.push({ min, max, style });\r\n    }\r\n    return (() => {\r\n      return (feature) => {\r\n        const value = feature.get(field);\r\n        for (let i = 0, ii = classes.length; i < ii; ++i) {\r\n          let condition;\r\n          if (i === 0) {\r\n            condition = value >= classes[i].min && value <= classes[i].max;\r\n          } else {\r\n            condition = value > classes[i].min && value <= classes[i].max;\r\n          }\r\n          if (condition) {\r\n            return [classes[i].style];\r\n          }\r\n        }\r\n        return [defaultStyle];\r\n      };\r\n    })();\r\n  }\r\n  _renderUniqueValue(renderer) {\r\n    const defaultSymbol = renderer.defaultSymbol;\r\n    let defaultStyle = [];\r\n    if (defaultSymbol) {\r\n      defaultStyle = [\r\n        this._converters[defaultSymbol.type].call(this, defaultSymbol)\r\n      ];\r\n    }\r\n    const field = renderer.field1;\r\n    const infos = renderer.uniqueValueInfos;\r\n    const me = this;\r\n    return (() => {\r\n      const hash = {};\r\n      for (let i = 0, ii = infos.length; i < ii; ++i) {\r\n        const info = infos[i];\r\n        const symbol = info.symbol;\r\n        hash[info.value] = [me._converters[symbol.type].call(me, symbol)];\r\n      }\r\n\r\n      return (feature) => {\r\n        const style = hash[feature.get(field)];\r\n        return style ? style : defaultStyle;\r\n      };\r\n    })();\r\n  }\r\n  generateStyle(layerInfo, mapUnits) {\r\n    const drawingInfo = layerInfo.drawingInfo;\r\n    let styleFunctions = [];\r\n    const drawingInfoStyle = this._renderers[drawingInfo.renderer.type].call(\r\n      this,\r\n      drawingInfo.renderer\r\n    );\r\n    if (drawingInfoStyle !== undefined) {\r\n      styleFunctions.push(drawingInfoStyle);\r\n    }\r\n    if (layerInfo.labelingInfo) {\r\n      const labelingInfoStyleFunctions = this._convertLabelingInfo(\r\n        layerInfo.labelingInfo,\r\n        mapUnits\r\n      );\r\n      styleFunctions = styleFunctions.concat(labelingInfoStyleFunctions);\r\n    }\r\n    if (styleFunctions.length === 1) {\r\n      return styleFunctions[0];\r\n    } else {\r\n      return (() => {\r\n        return (feature, resolution) => {\r\n          let styles = [];\r\n          for (let i = 0, ii = styleFunctions.length; i < ii; ++i) {\r\n            const result = styleFunctions[i].call(null, feature, resolution);\r\n            if (result) {\r\n              styles = styles.concat(result);\r\n            }\r\n          }\r\n          return styles;\r\n        };\r\n      })();\r\n    }\r\n  }\r\n}\r\n","export enum TimeFilterType {\r\n    DATE = 'date',\r\n    TIME = 'time',\r\n    DATETIME = 'datetime',\r\n    YEAR = 'year',\r\n}\r\n\r\nexport enum TimeFilterStyle {\r\n    CALENDAR = 'calendar',\r\n    SLIDER = 'slider',\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { IgoMap } from './map';\r\n\r\n/**\r\n * MapService\r\n *\r\n * This service tracks the IgoMap instance, if any.\r\n * Currently, only one map instance is supported\r\n * but support for multiple maps may be added in the future.\r\n * This will impact other services such as the OverlayService\r\n * because these maps won't be sharing overlayed features.\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class MapService {\r\n  private map: IgoMap;\r\n\r\n  constructor() {}\r\n\r\n  getMap(): IgoMap {\r\n    return this.map;\r\n  }\r\n\r\n  setMap(map: IgoMap) {\r\n    this.map = map;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport {\r\n  HttpClient,\r\n  HttpParams\r\n} from '@angular/common/http';\r\nimport { Observable, forkJoin, of } from 'rxjs';\r\nimport { map, catchError } from 'rxjs/operators';\r\nimport { Cacheable } from 'ts-cacheable';\r\n\r\nimport { WMSCapabilities, WMTSCapabilities, EsriJSON } from 'ol/format';\r\nimport { optionsFromCapabilities } from 'ol/source/WMTS.js';\r\nimport olAttribution from 'ol/control/Attribution';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\nimport { MapService } from '../../map/shared/map.service';\r\nimport { getResolutionFromScale } from '../../map/shared/map.utils';\r\nimport { EsriStyleGenerator } from '../utils/esri-style-generator';\r\nimport {\r\n  QueryFormat,\r\n  QueryFormatMimeType\r\n} from '../../query/shared/query.enums';\r\n\r\nimport {\r\n  WMTSDataSourceOptions,\r\n  WMSDataSourceOptions,\r\n  CartoDataSourceOptions,\r\n  ArcGISRestDataSourceOptions,\r\n  TileArcGISRestDataSourceOptions,\r\n  ArcGISRestImageDataSourceOptions\r\n} from './datasources';\r\nimport {\r\n  LegendOptions,\r\n  ItemStyleOptions\r\n} from '../../layer/shared/layers/layer.interface';\r\nimport {\r\n  TimeFilterType,\r\n  TimeFilterStyle\r\n} from '../../filter/shared/time-filter.enum';\r\nimport * as olproj from 'ol/proj';\r\n\r\nexport enum TypeCapabilities {\r\n  wms = 'wms',\r\n  wmts = 'wmts',\r\n  arcgisrest = 'esriJSON',\r\n  imagearcgisrest = 'esriJSON',\r\n  tilearcgisrest = 'esriJSON'\r\n}\r\n\r\nexport type TypeCapabilitiesStrings = keyof typeof TypeCapabilities;\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class CapabilitiesService {\r\n  private parsers = {\r\n    wms: new WMSCapabilities(),\r\n    wmts: new WMTSCapabilities(),\r\n    esriJSON: new EsriJSON()\r\n  };\r\n\r\n  constructor(private http: HttpClient, private mapService: MapService) {}\r\n\r\n  getWMSOptions(\r\n    baseOptions: WMSDataSourceOptions\r\n  ): Observable<WMSDataSourceOptions> {\r\n    const url = baseOptions.url;\r\n    const version = (baseOptions.params as any).VERSION;\r\n\r\n    return this.getCapabilities('wms', url, version).pipe(\r\n      map((capabilities: any) => {\r\n        return capabilities\r\n          ? this.parseWMSOptions(baseOptions, capabilities)\r\n          : undefined;\r\n      })\r\n    );\r\n  }\r\n\r\n  getWMTSOptions(\r\n    baseOptions: WMTSDataSourceOptions\r\n  ): Observable<WMTSDataSourceOptions> {\r\n    const url = baseOptions.url;\r\n    const version = baseOptions.version;\r\n\r\n    const options = this.getCapabilities('wmts', url, version).pipe(\r\n      map((capabilities: any) => {\r\n        return capabilities\r\n          ? this.parseWMTSOptions(baseOptions, capabilities)\r\n          : undefined;\r\n      })\r\n    );\r\n    return options;\r\n  }\r\n\r\n  getCartoOptions(\r\n    baseOptions: CartoDataSourceOptions\r\n  ): Observable<CartoDataSourceOptions> {\r\n    const baseUrl =\r\n      'https://' +\r\n      baseOptions.account +\r\n      '.carto.com/api/v2/viz/' +\r\n      baseOptions.mapId +\r\n      '/viz.json';\r\n\r\n    return this.http\r\n      .jsonp(baseUrl, 'callback')\r\n      .pipe(\r\n        map((cartoOptions: any) =>\r\n          this.parseCartoOptions(baseOptions, cartoOptions)\r\n        )\r\n      );\r\n  }\r\n\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  getArcgisOptions(\r\n    baseOptions: ArcGISRestDataSourceOptions\r\n  ): Observable<ArcGISRestDataSourceOptions> {\r\n    const baseUrl = baseOptions.url + '/' + baseOptions.layer + '?f=json';\r\n    const serviceCapabilities = this.getCapabilities('arcgisrest', baseOptions.url);\r\n    const arcgisOptions = this.http.get(baseUrl);\r\n    return forkJoin([arcgisOptions, serviceCapabilities]).pipe(\r\n      map((res: any) => {\r\n        return this.parseArcgisOptions(baseOptions, res[0], res[1]);\r\n      })\r\n    );\r\n  }\r\n\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  getImageArcgisOptions(\r\n    baseOptions: ArcGISRestImageDataSourceOptions | TileArcGISRestDataSourceOptions\r\n  ): Observable<ArcGISRestImageDataSourceOptions | TileArcGISRestDataSourceOptions> {\r\n    const baseUrl = baseOptions.url + '/' + baseOptions.layer + '?f=json';\r\n    const legendUrl = baseOptions.url + '/legend?f=json';\r\n    const serviceCapabilities = this.getCapabilities('imagearcgisrest', baseOptions.url);\r\n    const arcgisOptions = this.http.get(baseUrl);\r\n    const legend = this.http.get(legendUrl).pipe(\r\n      map((res: any) => res),\r\n      catchError((err) => {\r\n        console.log('No legend associated with this Image Service');\r\n        return of(err);\r\n      })\r\n    );\r\n    return forkJoin([arcgisOptions, legend, serviceCapabilities]).pipe(\r\n      map((res: any) => {\r\n        return this.parseTileOrImageArcgisOptions(baseOptions, res[0], res[1], res[2]);\r\n      })\r\n    );\r\n  }\r\n\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  getTileArcgisOptions(\r\n    baseOptions: TileArcGISRestDataSourceOptions\r\n  ): Observable<ArcGISRestImageDataSourceOptions | TileArcGISRestDataSourceOptions> {\r\n    const baseUrl = baseOptions.url + '/' + baseOptions.layer + '?f=json';\r\n    const legendUrl = baseOptions.url + '/legend?f=json';\r\n    const serviceCapabilities = this.getCapabilities('tilearcgisrest', baseOptions.url);\r\n    const arcgisOptions = this.http.get(baseUrl);\r\n    const legendInfo = this.http.get(legendUrl).pipe(\r\n      map((res: any) => res),\r\n      catchError((err) => {\r\n        console.log('No legend associated with this Tile Service');\r\n        return of(err);\r\n      })\r\n    );\r\n    return forkJoin([arcgisOptions, legendInfo, serviceCapabilities]).pipe(\r\n      map((res: any) =>\r\n        this.parseTileOrImageArcgisOptions(baseOptions, res[0], res[1], res[2])\r\n      )\r\n    );\r\n  }\r\n\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  getCapabilities(\r\n    service: TypeCapabilitiesStrings,\r\n    baseUrl: string,\r\n    version?: string\r\n  ): Observable<any> {\r\n    const params = new HttpParams({\r\n      fromObject: {\r\n        request: 'GetCapabilities',\r\n        service: service.toUpperCase(),\r\n        version: version || '1.3.0',\r\n        _i: 'true'\r\n      }\r\n    });\r\n\r\n    let request;\r\n    if (TypeCapabilities[service] === 'esriJSON') {\r\n      request = this.http.get(baseUrl + '?f=json');\r\n    } else {\r\n      request = this.http.get(baseUrl, {\r\n        params,\r\n        responseType: 'text'\r\n      });\r\n    }\r\n\r\n    return request.pipe(\r\n      map((res) => {\r\n        if (TypeCapabilities[service] === 'esriJSON') {\r\n          return res as object;\r\n        }\r\n        if (\r\n          String(res).toLowerCase().includes('serviceexception') &&\r\n          String(res).toLowerCase().includes('access denied')\r\n        ) {\r\n          throw {\r\n            error: {\r\n              message: 'Service error getCapabilities: Access is denied'\r\n            }\r\n          };\r\n        } else {\r\n          return this.parsers[service].read(res);\r\n        }\r\n      }),\r\n      catchError((e) => {\r\n        if (typeof e.error !== 'undefined') {\r\n          e.error.caught = true;\r\n        }\r\n        throw e;\r\n      })\r\n    );\r\n  }\r\n\r\n  private parseWMSOptions(\r\n    baseOptions: WMSDataSourceOptions,\r\n    capabilities: any\r\n  ): WMSDataSourceOptions {\r\n    const layers = (baseOptions.params as any).LAYERS;\r\n    const layer = this.findDataSourceInCapabilities(\r\n      capabilities.Capability.Layer,\r\n      layers\r\n    );\r\n\r\n    if (!layer) {\r\n      throw {\r\n        error: {\r\n          message: 'Layer not found'\r\n        }\r\n      };\r\n    }\r\n    const metadata = layer.DataURL ? layer.DataURL[0] : undefined;\r\n    const abstract = layer.Abstract ? layer.Abstract : undefined;\r\n    const keywordList = layer.KeywordList ? layer.KeywordList : undefined;\r\n    let queryable = layer.queryable;\r\n    const timeFilter = this.getTimeFilter(layer);\r\n    const timeFilterable = timeFilter && Object.keys(timeFilter).length > 0;\r\n    const legendOptions = layer.Style ? this.getStyle(layer.Style) : undefined;\r\n    let isExtentInGeographic = true;\r\n    if (layer.EX_GeographicBoundingBox) {\r\n      layer.EX_GeographicBoundingBox.forEach((coord, index) => {\r\n        if (index < 2 && (coord > 180 || coord < -180)) {\r\n          isExtentInGeographic = false;\r\n        }\r\n        if (index >= 2 && (coord > 90 || coord < -90)) {\r\n          isExtentInGeographic = false;\r\n        }\r\n      });\r\n    } else {\r\n      isExtentInGeographic = false;\r\n    }\r\n\r\n    const extent = isExtentInGeographic ?\r\n        olproj.transformExtent(layer.EX_GeographicBoundingBox, 'EPSG:4326', this.mapService.getMap().projection) :\r\n        undefined;\r\n\r\n    let queryFormat: QueryFormat;\r\n    const queryFormatMimeTypePriority = [\r\n      QueryFormatMimeType.GEOJSON,\r\n      QueryFormatMimeType.GEOJSON2,\r\n      QueryFormatMimeType.GML3,\r\n      QueryFormatMimeType.GML2,\r\n      QueryFormatMimeType.JSON,\r\n      QueryFormatMimeType.HTML\r\n    ];\r\n\r\n    for (const mimeType of queryFormatMimeTypePriority) {\r\n      if (\r\n        capabilities.Capability.Request.GetFeatureInfo.Format.indexOf(\r\n          mimeType\r\n        ) !== -1\r\n      ) {\r\n        const keyEnum = Object.keys(QueryFormatMimeType).find(\r\n          (key) => QueryFormatMimeType[key] === mimeType\r\n        );\r\n        queryFormat = QueryFormat[keyEnum];\r\n        break;\r\n      }\r\n    }\r\n    if (!queryFormat) {\r\n      queryable = false;\r\n    }\r\n\r\n    const options: WMSDataSourceOptions = ObjectUtils.removeUndefined({\r\n      _layerOptionsFromSource: {\r\n        title: layer.Title,\r\n        maxResolution: getResolutionFromScale(layer.MaxScaleDenominator),\r\n        minResolution: getResolutionFromScale(layer.MinScaleDenominator),\r\n        extent,\r\n        metadata: {\r\n          url: metadata ? metadata.OnlineResource : undefined,\r\n          extern: metadata ? true : undefined,\r\n          abstract,\r\n          keywordList\r\n        },\r\n        legendOptions\r\n      },\r\n      queryable,\r\n      queryFormat,\r\n      timeFilter: timeFilterable ? timeFilter : undefined,\r\n      timeFilterable: timeFilterable ? true : undefined,\r\n      minDate: timeFilterable ? timeFilter.min : undefined,\r\n      maxDate: timeFilterable ? timeFilter.max : undefined,\r\n      stepDate: timeFilterable ? timeFilter.step : undefined\r\n    });\r\n\r\n    return ObjectUtils.mergeDeep(options, baseOptions);\r\n  }\r\n\r\n  private parseWMTSOptions(\r\n    baseOptions: WMTSDataSourceOptions,\r\n    capabilities: any\r\n  ): WMTSDataSourceOptions {\r\n    // Put Title source in _layerOptionsFromSource. (For source & catalog in _layerOptionsFromSource, if not already on config)\r\n    const layer = capabilities.Contents.Layer.find(\r\n      (el) => el.Identifier === baseOptions.layer\r\n    );\r\n\r\n    const options = optionsFromCapabilities(capabilities, baseOptions);\r\n\r\n    const ouputOptions = Object.assign(options, baseOptions);\r\n    const sourceOptions = ObjectUtils.removeUndefined({\r\n      _layerOptionsFromSource: {\r\n        title: layer.Title\r\n      }\r\n    });\r\n\r\n    return ObjectUtils.mergeDeep(sourceOptions, ouputOptions);\r\n  }\r\n\r\n  private parseCartoOptions(\r\n    baseOptions: CartoDataSourceOptions,\r\n    cartoOptions: any\r\n  ): CartoDataSourceOptions {\r\n    const layers = [];\r\n    const params = cartoOptions.layers[1].options.layer_definition;\r\n    params.layers.forEach((element) => {\r\n      layers.push({\r\n        type: element.type.toLowerCase(),\r\n        options: element.options,\r\n        legend: element.legend\r\n      });\r\n    });\r\n    const options = ObjectUtils.removeUndefined({\r\n      config: {\r\n        version: params.version,\r\n        layers\r\n      }\r\n    });\r\n    return ObjectUtils.mergeDeep(options, baseOptions);\r\n  }\r\n\r\n  private parseArcgisOptions(\r\n    baseOptions: ArcGISRestDataSourceOptions,\r\n    arcgisOptions: any,\r\n    serviceCapabilities: any,\r\n  ): ArcGISRestDataSourceOptions {\r\n    const title = arcgisOptions.name;\r\n    let legendInfo: any;\r\n\r\n    if (arcgisOptions.drawingInfo?.renderer) {\r\n      legendInfo = arcgisOptions.drawingInfo.renderer;\r\n    } else {\r\n      legendInfo = undefined;\r\n    }\r\n\r\n    let style;\r\n    if (arcgisOptions.drawingInfo) {\r\n      const styleGenerator = new EsriStyleGenerator();\r\n      const units = arcgisOptions.units === 'esriMeters' ? 'm' : 'degrees';\r\n      style = styleGenerator.generateStyle(arcgisOptions, units);\r\n    }\r\n    const attributions = new olAttribution({\r\n      target: arcgisOptions.copyrightText\r\n    });\r\n    let timeExtent;\r\n    let timeFilter;\r\n    if (arcgisOptions.timeInfo) {\r\n      const time = arcgisOptions.timeInfo.timeExtent;\r\n      timeExtent = time[0] + ',' + time[1];\r\n      const min = new Date();\r\n      min.setTime(time[0]);\r\n      const max = new Date();\r\n      max.setTime(time[1]);\r\n      timeFilter = {\r\n        min: min.toUTCString(),\r\n        max: max.toUTCString(),\r\n        range: true,\r\n        type: TimeFilterType.DATETIME,\r\n        style: TimeFilterStyle.CALENDAR\r\n      };\r\n    }\r\n    const params = Object.assign(\r\n      {},\r\n      {\r\n        style,\r\n        LAYERS: baseOptions.layer ? 'show:' + baseOptions.layer : undefined,\r\n        time: timeExtent\r\n      }\r\n    );\r\n    const options = ObjectUtils.removeUndefined({\r\n      params,\r\n      _layerOptionsFromSource: {\r\n        title,\r\n        minResolution: getResolutionFromScale(arcgisOptions.maxScale),\r\n        maxResolution: getResolutionFromScale(arcgisOptions.minScale),\r\n        metadata: {\r\n          extern: false,\r\n          abstract: arcgisOptions.description || serviceCapabilities.serviceDescription\r\n        },\r\n      },\r\n      legendInfo,\r\n      timeFilter,\r\n      sourceFields: arcgisOptions.fields,\r\n      queryTitle: arcgisOptions.displayField\r\n    });\r\n    options.attributions = attributions;\r\n    return ObjectUtils.mergeDeep(options, baseOptions);\r\n  }\r\n\r\n  private parseTileOrImageArcgisOptions(\r\n    baseOptions: TileArcGISRestDataSourceOptions | ArcGISRestImageDataSourceOptions,\r\n    arcgisOptions: any,\r\n    legend: any,\r\n    serviceCapabilities: any\r\n  ): TileArcGISRestDataSourceOptions | ArcGISRestImageDataSourceOptions {\r\n    const title = arcgisOptions.name;\r\n    const legendInfo = legend.layers ? legend.layers.find(x => x.layerName === title) : undefined;\r\n    const attributions = new olAttribution({\r\n      target: arcgisOptions.copyrightText\r\n    });\r\n    let timeExtent;\r\n    let timeFilter;\r\n    if (arcgisOptions.timeInfo) {\r\n      const time = arcgisOptions.timeInfo.timeExtent;\r\n      timeExtent = time[0] + ',' + time[1];\r\n      const min = new Date();\r\n      min.setTime(time[0]);\r\n      const max = new Date();\r\n      max.setTime(time[1]);\r\n      timeFilter = {\r\n        min: min.toUTCString(),\r\n        max: max.toUTCString(),\r\n        range: true,\r\n        type: TimeFilterType.DATETIME,\r\n        style: TimeFilterStyle.CALENDAR\r\n      };\r\n    }\r\n    const params = Object.assign(\r\n      {},\r\n      {\r\n        LAYERS: baseOptions.layer ? 'show:' + baseOptions.layer : undefined,\r\n        time: timeExtent\r\n      }\r\n    );\r\n    const options = ObjectUtils.removeUndefined({\r\n      params,\r\n      _layerOptionsFromSource: {\r\n        title,\r\n        minResolution: getResolutionFromScale(arcgisOptions.maxScale),\r\n        maxResolution: getResolutionFromScale(arcgisOptions.minScale),\r\n        metadata: {\r\n          extern: false,\r\n          abstract: arcgisOptions.description || serviceCapabilities.serviceDescription\r\n        },\r\n      },\r\n      legendInfo,\r\n      timeFilter,\r\n      sourceFields: arcgisOptions.fields,\r\n      queryTitle: arcgisOptions.displayField\r\n    });\r\n    options.attributions = attributions;\r\n    return ObjectUtils.mergeDeep(options, baseOptions);\r\n  }\r\n\r\n  private findDataSourceInCapabilities(layerArray, name): any {\r\n    if (Array.isArray(layerArray)) {\r\n      let layer;\r\n      layerArray.find((value) => {\r\n        layer = this.findDataSourceInCapabilities(value, name);\r\n        return layer !== undefined;\r\n      }, this);\r\n\r\n      return layer;\r\n    } else if (layerArray.Layer) {\r\n      return this.findDataSourceInCapabilities(layerArray.Layer, name);\r\n    } else {\r\n      if (layerArray.Name && layerArray.Name === name) {\r\n        return layerArray;\r\n      }\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  getTimeFilter(layer) {\r\n    let dimension;\r\n\r\n    if (layer.Dimension) {\r\n      const timeFilter: any = {};\r\n      dimension = layer.Dimension[0];\r\n\r\n      if (dimension.values) {\r\n        const minMaxDim = dimension.values.split('/');\r\n        timeFilter.min = minMaxDim[0] !== undefined ? minMaxDim[0] : undefined;\r\n        timeFilter.max = minMaxDim[1] !== undefined ? minMaxDim[1] : undefined;\r\n        timeFilter.step = minMaxDim[2] !== undefined ? minMaxDim[2] : undefined;\r\n      }\r\n\r\n      if (dimension.default) {\r\n        timeFilter.value = dimension.default;\r\n      }\r\n      return timeFilter;\r\n    }\r\n  }\r\n\r\n  getStyle(Style): LegendOptions {\r\n    const styleOptions: ItemStyleOptions[] = Style.map((style) => {\r\n      return {\r\n        name: style.Name,\r\n        title: style.Title\r\n      };\r\n    })\r\n      // Handle repeat the style \"default\" in output  (MapServer or OpenLayer)\r\n      .filter(\r\n        (item, index, self) =>\r\n          self.findIndex((i: ItemStyleOptions) => i.name === item.name) ===\r\n          index\r\n      );\r\n\r\n    const legendOptions: LegendOptions = {\r\n      stylesAvailable: styleOptions\r\n    } as LegendOptions;\r\n\r\n    return legendOptions;\r\n  }\r\n}\r\n","import { Observable } from 'rxjs';\r\n\r\nimport {\r\n  ArcGISRestDataSourceOptions,\r\n  ArcGISRestImageDataSourceOptions,\r\n  TileArcGISRestDataSourceOptions,\r\n  WMSDataSourceOptions\r\n} from '../datasources';\r\n\r\nexport abstract class OptionsService {\r\n  abstract getWMSOptions(\r\n    _baseOptions: WMSDataSourceOptions,\r\n    detailedContextUri?: string\r\n  ): Observable<WMSDataSourceOptions>;\r\n  abstract getArcgisRestOptions(\r\n    _baseOptions: ArcGISRestDataSourceOptions | ArcGISRestImageDataSourceOptions | TileArcGISRestDataSourceOptions,\r\n    detailedContextUri?: string\r\n  ): Observable<ArcGISRestDataSourceOptions | ArcGISRestImageDataSourceOptions | TileArcGISRestDataSourceOptions>;\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport proj4 from 'proj4';\r\nimport * as olproj from 'ol/proj';\r\nimport * as olproj4 from 'ol/proj/proj4';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\n\r\nimport { Projection } from './projection.interfaces';\r\n\r\n/**\r\n * When injected, this service automatically registers and\r\n * projection defined in the application config. A custom projection\r\n * needs to be registered to be usable by OL.\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ProjectionService {\r\n\r\n  constructor(private config: ConfigService) {\r\n    const projections = this.config.getConfig('projections') || [];\r\n    projections.forEach((projection: Projection) => {\r\n      projection.alias = projection.alias ? projection.alias : projection.code;\r\n      this.registerProjection(projection);\r\n    });\r\n\r\n    // register all utm zones\r\n    for (let utmZone = 1; utmZone < 61; utmZone++) {\r\n      const code = utmZone < 10 ? `EPSG:3260${utmZone}` : `EPSG:326${utmZone}`;\r\n      const def = `+proj=utm +zone=${utmZone} +datum=WGS84 +units=m +no_defs`;\r\n      const proj: Projection = { code, def, extent : undefined};\r\n      this.registerProjection(proj);\r\n    }\r\n\r\n    // register all mtm zones\r\n    for (let mtmZone = 1; mtmZone < 11; mtmZone++) {\r\n      const code = mtmZone < 10 ? `EPSG:3218${mtmZone}` : `EPSG:321${80 + mtmZone}`;\r\n      let lon0;\r\n      if (Number(mtmZone) <= 2) {\r\n        lon0 = -50 - Number(mtmZone) * 3;\r\n      } else if (Number(mtmZone) >= 12) {\r\n        lon0 = -81 - (Number(mtmZone) - 12) * 3;\r\n      } else {\r\n        lon0 = -49.5 - Number(mtmZone) * 3;\r\n      }\r\n      const def = `+proj=tmerc +lat_0=0 +lon_0=${lon0} +k=0.9999 +x_0=304800 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs\"`;\r\n      const proj: Projection = { code, def, extent : undefined};\r\n      this.registerProjection(proj);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Define a proj4 projection and register it in OL\r\n   * @param projection Projection\r\n   */\r\n  registerProjection(projection: Projection) {\r\n    proj4.defs(projection.code, projection.def);\r\n    olproj4.register(proj4);\r\n    if (projection.extent) {\r\n      olproj.get(projection.code).setExtent(projection.extent);\r\n    }\r\n  }\r\n\r\n}\r\n","import { Injectable, Optional } from '@angular/core';\r\nimport { forkJoin, of, Observable, BehaviorSubject } from 'rxjs';\r\nimport { map, catchError } from 'rxjs/operators';\r\n\r\nimport { CapabilitiesService } from './capabilities.service';\r\nimport { OptionsService } from './options/options.service';\r\nimport { WFSService } from './datasources/wfs.service';\r\nimport {\r\n  DataSource,\r\n  OSMDataSource,\r\n  OSMDataSourceOptions,\r\n  FeatureDataSource,\r\n  FeatureDataSourceOptions,\r\n  XYZDataSource,\r\n  XYZDataSourceOptions,\r\n  TileDebugDataSource,\r\n  TileDebugDataSourceOptions,\r\n  WFSDataSource,\r\n  WFSDataSourceOptions,\r\n  WMTSDataSource,\r\n  WMTSDataSourceOptions,\r\n  WMSDataSource,\r\n  WMSDataSourceOptions,\r\n  CartoDataSource,\r\n  CartoDataSourceOptions,\r\n  ArcGISRestDataSource,\r\n  ArcGISRestDataSourceOptions,\r\n  ImageArcGISRestDataSource,\r\n  ArcGISRestImageDataSourceOptions,\r\n  TileArcGISRestDataSource,\r\n  TileArcGISRestDataSourceOptions,\r\n  WebSocketDataSource,\r\n  AnyDataSourceOptions,\r\n  MVTDataSource,\r\n  MVTDataSourceOptions,\r\n  ClusterDataSource,\r\n  ClusterDataSourceOptions\r\n} from './datasources';\r\nimport { ObjectUtils } from '@igo2/utils';\r\nimport { LanguageService, MessageService } from '@igo2/core';\r\nimport { ProjectionService } from '../../map/shared/projection.service';\r\nimport { AuthInterceptor } from '@igo2/auth';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class DataSourceService {\r\n  public datasources$ = new BehaviorSubject<DataSource[]>([]);\r\n\r\n  constructor(\r\n    private capabilitiesService: CapabilitiesService,\r\n    @Optional() private optionsService: OptionsService,\r\n    private wfsDataSourceService: WFSService,\r\n    private languageService: LanguageService,\r\n    private messageService: MessageService,\r\n    private projectionService: ProjectionService,\r\n    private authInterceptor?: AuthInterceptor\r\n  ) {}\r\n\r\n  createAsyncDataSource(context: AnyDataSourceOptions, detailedContextUri?: string): Observable<DataSource> {\r\n    if (!context.type) {\r\n      console.error(context);\r\n      throw new Error('Datasource needs a type');\r\n    }\r\n    let dataSource;\r\n    switch (context.type.toLowerCase()) {\r\n      case 'osm':\r\n        dataSource = this.createOSMDataSource(context as OSMDataSourceOptions);\r\n        break;\r\n      case 'vector':\r\n        dataSource = this.createFeatureDataSource(\r\n          context as FeatureDataSourceOptions\r\n        );\r\n        break;\r\n      case 'wfs':\r\n        dataSource = this.createWFSDataSource(context as WFSDataSourceOptions);\r\n        break;\r\n      case 'wms':\r\n        const wmsContext = context as WMSDataSourceOptions;\r\n        ObjectUtils.removeDuplicateCaseInsensitive(wmsContext.params);\r\n        dataSource = this.createWMSDataSource(wmsContext, detailedContextUri);\r\n        break;\r\n      case 'wmts':\r\n        dataSource = this.createWMTSDataSource(\r\n          context as WMTSDataSourceOptions\r\n        );\r\n        break;\r\n      case 'xyz':\r\n        dataSource = this.createXYZDataSource(context as XYZDataSourceOptions);\r\n        break;\r\n      case 'tiledebug':\r\n        dataSource = this.createTileDebugDataSource(context as TileDebugDataSource);\r\n        break;\r\n      case 'carto':\r\n        dataSource = this.createCartoDataSource(\r\n          context as CartoDataSourceOptions\r\n        );\r\n        break;\r\n      case 'arcgisrest':\r\n        dataSource = this.createArcGISRestDataSource(\r\n          context as ArcGISRestDataSourceOptions, detailedContextUri\r\n        );\r\n        break;\r\n      case 'imagearcgisrest':\r\n        dataSource = this.createArcGISRestImageDataSource(\r\n          context as ArcGISRestImageDataSourceOptions, detailedContextUri\r\n        );\r\n        break;\r\n      case 'websocket':\r\n        dataSource = this.createWebSocketDataSource(\r\n          context as FeatureDataSourceOptions\r\n        );\r\n        break;\r\n      case 'mvt':\r\n        dataSource = this.createMVTDataSource(context as MVTDataSourceOptions);\r\n        break;\r\n      case 'tilearcgisrest':\r\n        dataSource = this.createTileArcGISRestDataSource(\r\n          context as TileArcGISRestDataSourceOptions, detailedContextUri\r\n        );\r\n        break;\r\n      case 'cluster':\r\n        dataSource = this.createClusterDataSource(\r\n          context as ClusterDataSourceOptions\r\n        );\r\n        break;\r\n      default:\r\n        console.error(context);\r\n        throw new Error('Invalid datasource type');\r\n    }\r\n\r\n    this.datasources$.next(this.datasources$.value.concat([dataSource]));\r\n\r\n    return dataSource;\r\n  }\r\n\r\n  private createOSMDataSource(\r\n    context: OSMDataSourceOptions\r\n  ): Observable<OSMDataSource> {\r\n    return new Observable(d => d.next(new OSMDataSource(context)));\r\n  }\r\n\r\n  private createFeatureDataSource(\r\n    context: FeatureDataSourceOptions\r\n  ): Observable<FeatureDataSource> {\r\n    return new Observable(d => d.next(new FeatureDataSource(context)));\r\n  }\r\n\r\n  private createWebSocketDataSource(\r\n    context: FeatureDataSourceOptions\r\n  ): Observable<WebSocketDataSource> {\r\n    return new Observable(d => d.next(new WebSocketDataSource(context)));\r\n  }\r\n\r\n  private createWFSDataSource(\r\n    context: WFSDataSourceOptions\r\n  ): Observable<WFSDataSource> {\r\n    return new Observable(d =>\r\n      d.next(new WFSDataSource(context, this.wfsDataSourceService, this.authInterceptor))\r\n    );\r\n  }\r\n\r\n  private createWMSDataSource(context: WMSDataSourceOptions, detailedContextUri?: string): Observable<any> {\r\n    const observables = [];\r\n    if (context.optionsFromCapabilities) {\r\n      observables.push(\r\n        this.capabilitiesService.getWMSOptions(context).pipe(\r\n          catchError(e => {\r\n            const title = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.unavailableTitle'\r\n            );\r\n            const message = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.unavailable',\r\n              { value: context.params.LAYERS }\r\n            );\r\n\r\n            this.messageService.error(message, title);\r\n            throw e;\r\n          })\r\n        )\r\n      );\r\n    }\r\n\r\n    if (this.optionsService && context.optionsFromApi === true) {\r\n      observables.push(\r\n        this.optionsService.getWMSOptions(context, detailedContextUri).pipe(\r\n          catchError(e => {\r\n            e.error.toDisplay = true;\r\n            e.error.title = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.unavailableTitle'\r\n            );\r\n            e.error.message = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.optionsApiUnavailable'\r\n            );\r\n            return of({});\r\n          })\r\n        )\r\n      );\r\n    }\r\n\r\n    observables.push(of(context));\r\n\r\n    return forkJoin(observables).pipe(\r\n      map((options: WMSDataSourceOptions[]) => {\r\n        const optionsMerged = options.reduce((a, b) =>\r\n          ObjectUtils.mergeDeep(a, b)\r\n        );\r\n        return new WMSDataSource(optionsMerged, this.wfsDataSourceService);\r\n      }),\r\n      catchError(() => {\r\n        return of(undefined);\r\n      })\r\n    );\r\n  }\r\n\r\n  private createWMTSDataSource(\r\n    context: WMTSDataSourceOptions\r\n  ): Observable<WMTSDataSource> {\r\n    if (context.optionsFromCapabilities) {\r\n      return this.capabilitiesService.getWMTSOptions(context).pipe(\r\n        map((options: WMTSDataSourceOptions) => {\r\n          return options ? new WMTSDataSource(options) : undefined;\r\n        }),\r\n        catchError(() => {\r\n          const title = this.languageService.translate.instant(\r\n            'igo.geo.dataSource.unavailableTitle'\r\n          );\r\n          const message = this.languageService.translate.instant(\r\n            'igo.geo.dataSource.unavailable',\r\n            { value: context.layer }\r\n          );\r\n\r\n          this.messageService.error(message, title);\r\n          return of(undefined);\r\n        })\r\n      );\r\n    }\r\n\r\n    return new Observable(d => d.next(new WMTSDataSource(context)));\r\n  }\r\n\r\n  private createXYZDataSource(\r\n    context: XYZDataSourceOptions\r\n  ): Observable<XYZDataSource> {\r\n    return new Observable(d => d.next(new XYZDataSource(context)));\r\n  }\r\n\r\n  private createTileDebugDataSource(\r\n    context: TileDebugDataSourceOptions\r\n  ): Observable<TileDebugDataSource> {\r\n    return new Observable(d => d.next(new TileDebugDataSource(context)));\r\n  }\r\n\r\n  private createCartoDataSource(\r\n    context: CartoDataSourceOptions\r\n  ): Observable<CartoDataSource> {\r\n    if (context.mapId) {\r\n      return this.capabilitiesService\r\n        .getCartoOptions(context)\r\n        .pipe(\r\n          map((options: CartoDataSourceOptions) => new CartoDataSource(options))\r\n        );\r\n    }\r\n    return new Observable(d => d.next(new CartoDataSource(context)));\r\n  }\r\n\r\n  private createArcGISRestDataSource(\r\n    context: ArcGISRestDataSourceOptions,\r\n    detailedContextUri?: string\r\n  ): Observable<ArcGISRestDataSource> {\r\n    const observables = [];\r\n    observables.push(this.capabilitiesService.getArcgisOptions(context).pipe(\r\n      catchError(e => {\r\n        const title = this.languageService.translate.instant(\r\n          'igo.geo.dataSource.unavailableTitle'\r\n        );\r\n        const message = this.languageService.translate.instant(\r\n          'igo.geo.dataSource.unavailable',\r\n          { value: context.layer }\r\n        );\r\n\r\n        this.messageService.error(message, title);\r\n        throw e;\r\n      })\r\n    ));\r\n    if (this.optionsService && context.optionsFromApi === true) {\r\n      observables.push(\r\n        this.optionsService.getArcgisRestOptions(context, detailedContextUri).pipe(\r\n          catchError(e => {\r\n            e.error.toDisplay = true;\r\n            e.error.title = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.unavailableTitle'\r\n            );\r\n            e.error.message = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.optionsApiUnavailable'\r\n            );\r\n            return of({});\r\n          })\r\n        )\r\n      );\r\n    }\r\n    observables.push(of(context));\r\n    return forkJoin(observables).pipe(\r\n      map((options: ArcGISRestDataSource[]) => {\r\n        const optionsMerged = options.reduce((a, b) =>\r\n          ObjectUtils.mergeDeep(a, b)\r\n        );\r\n        return new ArcGISRestDataSource(optionsMerged);\r\n      }),\r\n      catchError(() => {\r\n        return of(undefined);\r\n      })\r\n    );\r\n  }\r\n\r\n  private createArcGISRestImageDataSource(\r\n    context: ArcGISRestImageDataSourceOptions,\r\n    detailedContextUri?: string\r\n  ): Observable<ArcGISRestImageDataSourceOptions> {\r\n    const observables = [];\r\n\r\n    observables.push(this.capabilitiesService.getImageArcgisOptions(context).pipe(\r\n      catchError(e => {\r\n        const title = this.languageService.translate.instant(\r\n          'igo.geo.dataSource.unavailableTitle'\r\n        );\r\n        const message = this.languageService.translate.instant(\r\n          'igo.geo.dataSource.unavailable',\r\n          { value: context.params.LAYERS }\r\n        );\r\n\r\n        this.messageService.error(message, title);\r\n        throw e;\r\n      })\r\n    ));\r\n    if (this.optionsService && context.optionsFromApi === true) {\r\n      observables.push(\r\n        this.optionsService.getArcgisRestOptions(context, detailedContextUri).pipe(\r\n          catchError(e => {\r\n            e.error.toDisplay = true;\r\n            e.error.title = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.unavailableTitle'\r\n            );\r\n            e.error.message = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.optionsApiUnavailable'\r\n            );\r\n            return of({});\r\n          })\r\n        )\r\n      );\r\n    }\r\n    observables.push(of(context));\r\n    return forkJoin(observables).pipe(\r\n      map((options: ImageArcGISRestDataSource[]) => {\r\n        const optionsMerged = options.reduce((a, b) =>\r\n          ObjectUtils.mergeDeep(a, b)\r\n        );\r\n        return new ImageArcGISRestDataSource(optionsMerged);\r\n      }),\r\n      catchError(() => {\r\n        return of(undefined);\r\n      })\r\n    );\r\n  }\r\n\r\n  private createTileArcGISRestDataSource(\r\n    context: TileArcGISRestDataSourceOptions,\r\n    detailedContextUri?: string\r\n  ): Observable<TileArcGISRestDataSource> {\r\n    const observables = [];\r\n    observables.push(this.capabilitiesService.getImageArcgisOptions(context).pipe(\r\n      catchError(e => {\r\n        const title = this.languageService.translate.instant(\r\n          'igo.geo.dataSource.unavailableTitle'\r\n        );\r\n        const message = this.languageService.translate.instant(\r\n          'igo.geo.dataSource.unavailable',\r\n          { value: context.params.LAYERS }\r\n        );\r\n\r\n        this.messageService.error(message, title);\r\n        throw e;\r\n      })\r\n    ));\r\n    if (this.optionsService && context.optionsFromApi === true) {\r\n      observables.push(\r\n        this.optionsService.getArcgisRestOptions(context, detailedContextUri).pipe(\r\n          catchError(e => {\r\n            e.error.toDisplay = true;\r\n            e.error.title = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.unavailableTitle'\r\n            );\r\n            e.error.message = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.optionsApiUnavailable'\r\n            );\r\n            return of({});\r\n          })\r\n        )\r\n      );\r\n    }\r\n    observables.push(of(context));\r\n    return forkJoin(observables).pipe(\r\n      map((options: TileArcGISRestDataSource[]) => {\r\n        const optionsMerged = options.reduce((a, b) =>\r\n          ObjectUtils.mergeDeep(a, b)\r\n        );\r\n        return new TileArcGISRestDataSource(optionsMerged);\r\n      }),\r\n      catchError(() => {\r\n        return of(undefined);\r\n      })\r\n    );\r\n  }\r\n\r\n  private createMVTDataSource(\r\n    context: MVTDataSourceOptions\r\n  ): Observable<MVTDataSource> {\r\n    return new Observable(d => d.next(new MVTDataSource(context)));\r\n  }\r\n\r\n  private createClusterDataSource(\r\n    context: ClusterDataSourceOptions\r\n  ): Observable<ClusterDataSource> {\r\n    return new Observable(d => d.next(new ClusterDataSource(context)));\r\n  }\r\n}\r\n","import * as olextent from 'ol/extent';\r\nimport * as olproj from 'ol/proj';\r\nimport * as olstyle from 'ol/style';\r\nimport OlFeature from 'ol/Feature';\r\nimport type { GeometryLayout } from 'ol/geom/Geometry';\r\nimport OlPolygon from 'ol/geom/Polygon';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport OlLineString from 'ol/geom/LineString';\r\nimport OlRenderFeature from 'ol/render/Feature';\r\nimport OlFormatGeoJSON from 'ol/format/GeoJSON';\r\nimport OlLayer from 'ol/layer/Layer';\r\nimport OlSource from 'ol/source/Source';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport { uuid } from '@igo2/utils';\r\n\r\nimport {\r\n  EntityKey,\r\n  getEntityId,\r\n  getEntityTitle,\r\n  getEntityRevision,\r\n  getEntityIcon,\r\n  getEntityProperty\r\n} from '@igo2/common';\r\n\r\nimport { IgoMap } from '../../map';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { FeatureDataSource } from '../../datasource';\r\nimport { FEATURE, FeatureMotion } from './feature.enums';\r\nimport { Feature, FeatureGeometry } from './feature.interfaces';\r\nimport { FeatureStore } from './store';\r\n\r\n/**\r\n * Create an Openlayers feature object out of a feature definition.\r\n * The output object has a reference to the feature id.\r\n * @param feature Feature definition\r\n * @param projectionOut Feature object projection\r\n * @returns OpenLayers feature object\r\n */\r\nexport function featureToOl(\r\n  feature: Feature,\r\n  projectionOut: string,\r\n  getId?: (Feature) => EntityKey\r\n): OlFeature<OlGeometry> {\r\n  getId = getId ? getId : getEntityId;\r\n\r\n  const olFormat = new OlFormatGeoJSON();\r\n  const olFeature = olFormat.readFeature(feature, {\r\n    dataProjection: feature.projection,\r\n    featureProjection: projectionOut\r\n  });\r\n\r\n  olFeature.setId(getId(feature));\r\n\r\n  const title = getEntityTitle(feature);\r\n  if (title !== undefined) {\r\n    olFeature.set('_title', title, true);\r\n  }\r\n\r\n  if (feature.extent !== undefined) {\r\n    olFeature.set('_extent', feature.extent, true);\r\n  }\r\n\r\n  if (feature.projection !== undefined) {\r\n    olFeature.set('_projection', feature.projection, true);\r\n  }\r\n\r\n  const mapTitle = getEntityProperty(feature, 'meta.mapTitle');\r\n  if (mapTitle !== undefined) {\r\n    olFeature.set('_mapTitle', mapTitle, true);\r\n  }\r\n\r\n  olFeature.set('_entityRevision', getEntityRevision(feature), true);\r\n\r\n  const icon = getEntityIcon(feature);\r\n  if (icon !== undefined) {\r\n    olFeature.set('_icon', icon, true);\r\n  }\r\n\r\n  if (feature.meta && feature.meta.style) {\r\n    olFeature.set('_style', feature.meta.style, true);\r\n  }\r\n\r\n  if (feature.sourceId) {\r\n    olFeature.set('_sourceId', feature.sourceId, true);\r\n  }\r\n\r\n  return olFeature;\r\n}\r\n\r\nexport function renderFeatureFromOl(\r\n  olRenderFeature: OlRenderFeature,\r\n  projectionIn: string,\r\n  olLayer?: OlLayer<OlSource>,\r\n  projectionOut = 'EPSG:4326'\r\n): Feature {\r\n  let geom;\r\n  let title;\r\n  let exclude;\r\n  let excludeOffline;\r\n\r\n  if (olLayer) {\r\n    title = olLayer.get('title');\r\n    if (olLayer.get('sourceOptions')) {\r\n      exclude = olLayer.get('sourceOptions').excludeAttribute;\r\n      excludeOffline = olLayer.get('sourceOptions').excludeAttributeOffline;\r\n    }\r\n  } else {\r\n    title = olRenderFeature.get('_title');\r\n  }\r\n\r\n  const olFormat = new OlFormatGeoJSON();\r\n  const properties = olRenderFeature.getProperties();\r\n  const geometryType = olRenderFeature.getType();\r\n\r\n  if (geometryType === 'Polygon') {\r\n    const ends = olRenderFeature.getEnds() as number[];\r\n    geom = new OlPolygon(\r\n      olRenderFeature.getFlatCoordinates(),\r\n      'XY' as GeometryLayout,\r\n      ends\r\n    );\r\n  } else if (geometryType === 'Point') {\r\n    geom = new OlPoint(olRenderFeature.getFlatCoordinates(), 'XY' as GeometryLayout);\r\n  } else if (geometryType === 'LineString') {\r\n    geom = new OlLineString(\r\n      olRenderFeature.getFlatCoordinates(),\r\n      'XY' as GeometryLayout,\r\n    );\r\n  }\r\n\r\n  const geometry = olFormat.writeGeometryObject(geom, {\r\n    dataProjection: projectionOut,\r\n    featureProjection: projectionIn\r\n  }) as FeatureGeometry;\r\n\r\n  const id = olRenderFeature.getId() ? olRenderFeature.getId() : uuid();\r\n  const mapTitle = olRenderFeature.get('_mapTitle');\r\n  const extent = olproj.transformExtent(olRenderFeature.getExtent(), projectionIn, projectionOut) as [number, number, number, number];\r\n  return {\r\n    type: FEATURE,\r\n    projection: projectionOut,\r\n    extent,\r\n    meta: {\r\n      id,\r\n      title: title ? title : mapTitle ? mapTitle : id,\r\n      mapTitle,\r\n      excludeAttribute: exclude,\r\n      excludeAttributeOffline: excludeOffline\r\n    },\r\n    properties,\r\n    geometry,\r\n    ol: olRenderFeature\r\n  };\r\n}\r\n/**\r\n * Create a feature object out of an OL feature\r\n * The output object has a reference to the feature id.\r\n * @param olFeature OL Feature\r\n * @param projectionIn OL feature projection\r\n * @param olLayer OL Layer\r\n * @param projectionOut Feature projection\r\n * @returns Feature\r\n */\r\nexport function featureFromOl(\r\n  olFeature: OlFeature<OlGeometry>,\r\n  projectionIn: string,\r\n  olLayer?: OlLayer<OlSource>,\r\n  projectionOut = 'EPSG:4326'\r\n): Feature {\r\n  let title;\r\n  let exclude;\r\n  let excludeOffline;\r\n  let idColumn; // for arcgisrest and tilearcgisrest source\r\n  const olFormat = new OlFormatGeoJSON();\r\n\r\n  const keys = olFeature.getKeys().filter((key: string) => {\r\n    return !key.startsWith('_') && key !== 'geometry';\r\n  });\r\n  const properties = keys.reduce((acc: object, key: string) => {\r\n    acc[key] = olFeature.get(key);\r\n    return acc;\r\n  }, {});\r\n\r\n  const geometry = olFormat.writeGeometryObject(olFeature.getGeometry(), {\r\n    dataProjection: projectionOut,\r\n    featureProjection: projectionIn\r\n  }) as FeatureGeometry;\r\n\r\n  if (olLayer) {\r\n    title = olLayer.get('title');\r\n    const sourceOptions = olLayer.get('sourceOptions');\r\n    if (sourceOptions) {\r\n      exclude = sourceOptions.excludeAttribute;\r\n      excludeOffline = sourceOptions.excludeAttributeOffline;\r\n      idColumn =\r\n        sourceOptions.idColumn ||\r\n        ((sourceOptions.type === 'arcgisrest' || sourceOptions.type === 'tilearcgisrest') ? 'OBJECTID' : undefined );\r\n    }\r\n  } else {\r\n    title = olFeature.get('_title');\r\n  }\r\n  const mapTitle = olFeature.get('_mapTitle');\r\n  const id = olFeature.getId() ? olFeature.getId() : olFeature.get(idColumn) ? olFeature.get(idColumn) : uuid();\r\n  const newFeature = olFeature.get('_newFeature');\r\n\r\n  return {\r\n    type: FEATURE,\r\n    projection: projectionOut,\r\n    extent: olFeature.get('_extent'),\r\n    meta: {\r\n      id,\r\n      title: title ? title : mapTitle ? mapTitle : id,\r\n      mapTitle,\r\n      revision: olFeature.getRevision(),\r\n      style: olFeature.get('_style'),\r\n      excludeAttribute: exclude,\r\n      excludeAttributeOffline: excludeOffline\r\n    },\r\n    properties,\r\n    geometry,\r\n    ol: olFeature\r\n  };\r\n}\r\n\r\n/**\r\n * Compute an OL feature extent in it's map projection\r\n * @param map Map\r\n * @param olFeature OL feature\r\n * @returns Extent in the map projection\r\n */\r\nexport function computeOlFeatureExtent(\r\n  map: IgoMap,\r\n  olFeature: OlFeature<OlGeometry>\r\n): [number, number, number, number] {\r\n  let olExtent = olextent.createEmpty();\r\n\r\n  const olFeatureExtent = olFeature.get('_extent');\r\n  const olFeatureProjection = olFeature.get('_projection');\r\n  if (olFeatureExtent !== undefined && olFeatureProjection !== undefined) {\r\n    olExtent = olproj.transformExtent(\r\n      olFeatureExtent,\r\n      olFeatureProjection,\r\n      map.projection\r\n    );\r\n  } else {\r\n    const olGeometry = olFeature.getGeometry();\r\n    if (olGeometry !== null) {\r\n      olExtent = olGeometry.getExtent();\r\n    }\r\n  }\r\n\r\n  return olExtent as [number, number, number, number];\r\n}\r\n\r\n/**\r\n * Compute a multiple OL features extent in their map projection\r\n * @param map Map\r\n * @param olFeatures OL features\r\n * @returns Extent in the map projection\r\n */\r\nexport function computeOlFeaturesExtent(\r\n  map: IgoMap,\r\n  olFeatures: OlFeature<OlGeometry>[]\r\n): [number, number, number, number] {\r\n  const extent = olextent.createEmpty();\r\n\r\n  olFeatures.forEach((olFeature: OlFeature<OlGeometry>) => {\r\n    const featureExtent = computeOlFeatureExtent(map, olFeature);\r\n    olextent.extend(extent, featureExtent);\r\n  });\r\n\r\n  return extent as [number, number, number, number];\r\n}\r\n\r\n/**\r\n * Scale an extent.\r\n * @param extent Extent\r\n * @param Scaling factors for top, right, bottom and left directions, in that order\r\n * @returns Scaled extent\r\n */\r\nexport function scaleExtent(\r\n  extent: [number, number, number, number],\r\n  scale: [number, number, number, number]\r\n): [number, number, number, number] {\r\n  const [width, height] = olextent.getSize(extent);\r\n  return [\r\n    scale[3] ? extent[0] - width * scale[3] : extent[0],\r\n    scale[2] ? extent[1] - height * scale[2] : extent[1],\r\n    scale[1] ? extent[2] + width * scale[1] : extent[2],\r\n    scale[0] ? extent[3] + height * scale[0] : extent[3]\r\n  ];\r\n}\r\n\r\n/**\r\n * Return true if features are out of view.\r\n * If features are too close to the edge, they are considered out of view.\r\n * We define the edge as 5% of the extent size.\r\n * @param map Map\r\n * @param featuresExtent The features's extent\r\n * @returns Return true if features are out of view\r\n */\r\nexport function featuresAreOutOfView(\r\n  map: IgoMap,\r\n  featuresExtent: [number, number, number, number]\r\n) {\r\n  const mapExtent = map.viewController.getExtent();\r\n  const edgeRatio = 0.05;\r\n  const scale = [-1, -1, -1, -1].map(x => x * edgeRatio);\r\n  const viewExtent = scaleExtent(mapExtent, scale as [\r\n    number,\r\n    number,\r\n    number,\r\n    number\r\n  ]);\r\n\r\n  return !olextent.containsExtent(viewExtent, featuresExtent);\r\n}\r\n\r\n/**\r\n * Return true if features are too deep into the view. This results\r\n * in features being too small.\r\n * Features are considered too small if their extent occupies less than\r\n * 1% of the map extent.\r\n * @param map Map\r\n * @param featuresExtent The features's extent\r\n * @param areaRatio The features extent to view extent acceptable ratio\r\n * @returns Return true if features are too deep in the view\r\n */\r\nexport function featuresAreTooDeepInView(\r\n  map: IgoMap,\r\n  featuresExtent: [number, number, number, number],\r\n  areaRatio?: number\r\n) {\r\n  // An area ratio of 0.004 means that the feature extent's width and height\r\n  // should be about 1/16 of the map extent's width and height\r\n  areaRatio = areaRatio ? areaRatio : 0.004;\r\n  const mapExtent = map.viewController.getExtent();\r\n  const mapExtentArea = olextent.getArea(mapExtent);\r\n  const featuresExtentArea = olextent.getArea(featuresExtent);\r\n\r\n  if (featuresExtentArea === 0 && map.viewController.getZoom() > 13) {\r\n    // In case it's a point\r\n    return false;\r\n  }\r\n\r\n  return featuresExtentArea / mapExtentArea < areaRatio;\r\n}\r\n\r\n/**\r\n * Fit view to include the features extent.\r\n * By default, this method will let the features occupy about 50% of the viewport.\r\n * @param map Map\r\n * @param olFeatures OL features\r\n * @param motion To motion to the new map view\r\n * @param scale If this is defined, the original view will be scaled\r\n *  by that factor before any logic is applied.\r\n */\r\nexport function moveToOlFeatures(\r\n  map: IgoMap,\r\n  olFeatures: OlFeature<OlGeometry>[],\r\n  motion: FeatureMotion = FeatureMotion.Default,\r\n  scale?: [number, number, number, number],\r\n  areaRatio?: number\r\n) {\r\n  const featuresExtent = computeOlFeaturesExtent(map, olFeatures);\r\n  let viewExtent = featuresExtent;\r\n  if (scale !== undefined) {\r\n    viewExtent = scaleExtent(viewExtent, scale);\r\n  }\r\n\r\n  if (motion === FeatureMotion.Zoom) {\r\n    map.viewController.zoomToExtent(viewExtent);\r\n  } else if (motion === FeatureMotion.Move) {\r\n    map.viewController.moveToExtent(viewExtent);\r\n  } else if (motion === FeatureMotion.Default) {\r\n    if (\r\n      featuresAreOutOfView(map, featuresExtent) ||\r\n      featuresAreTooDeepInView(map, featuresExtent, areaRatio)\r\n    ) {\r\n      map.viewController.zoomToExtent(viewExtent);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Hide an OL feature\r\n * @param olFeature OL feature\r\n */\r\nexport function hideOlFeature(olFeature: OlFeature<OlGeometry>) {\r\n  olFeature.setStyle(new olstyle.Style({}));\r\n}\r\n\r\n/**\r\n * Try to bind a layer to a store if none is bound already.\r\n * The layer will also be added to the store's map.\r\n * If no layer is given to that function, a basic one will be created.\r\n * @param store The store to bind the layer\r\n * @param layer An optional VectorLayer\r\n */\r\nexport function tryBindStoreLayer(store: FeatureStore, layer?: VectorLayer) {\r\n  if (store.layer !== undefined) {\r\n    if (store.layer.map === undefined) {\r\n      store.map.addLayer(store.layer);\r\n    }\r\n    return;\r\n  }\r\n\r\n  layer = layer\r\n    ? layer\r\n    : new VectorLayer({\r\n        source: new FeatureDataSource()\r\n      });\r\n  store.bindLayer(layer);\r\n  if (store.layer.map === undefined) {\r\n    store.map.addLayer(store.layer);\r\n  }\r\n}\r\n\r\n/**\r\n * Compute a diff between a source array of Ol features and a target array\r\n * @param source Source array of OL features\r\n * @param starget Target array of OL features\r\n * @returns Features to add and remove\r\n */\r\nexport function computeOlFeaturesDiff(\r\n  source: OlFeature<OlGeometry>[],\r\n  target: OlFeature<OlGeometry>[]\r\n): {\r\n  add: OlFeature<OlGeometry>[];\r\n  remove: OlFeature<OlGeometry>[];\r\n} {\r\n  const olFeaturesMap = new Map();\r\n  target.forEach((olFeature: OlFeature<OlGeometry>) => {\r\n    olFeaturesMap.set(olFeature.getId(), olFeature);\r\n  });\r\n\r\n  const olFeaturesToRemove = [];\r\n  source.forEach((olFeature: OlFeature<OlGeometry>) => {\r\n    const newOlFeature = olFeaturesMap.get(olFeature.getId());\r\n    if (newOlFeature === undefined) {\r\n      olFeaturesToRemove.push(olFeature);\r\n    } else if (\r\n      newOlFeature.get('_entityRevision') !== olFeature.get('_entityRevision')\r\n    ) {\r\n      olFeaturesToRemove.push(olFeature);\r\n    } else {\r\n      olFeaturesMap.delete(newOlFeature.getId());\r\n    }\r\n  });\r\n\r\n  const olFeaturesToAddIds = Array.from(olFeaturesMap.keys());\r\n  const olFeaturesToAdd = target.filter((olFeature: OlFeature<OlGeometry>) => {\r\n    return olFeaturesToAddIds.indexOf(olFeature.getId()) >= 0;\r\n  });\r\n\r\n  return {\r\n    add: olFeaturesToAdd,\r\n    remove: olFeaturesToRemove\r\n  };\r\n}\r\n","import OlFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport * as olextent from 'ol/extent';\r\n\r\nimport {\r\n  getEntityId,\r\n  EntityKey,\r\n  EntityStore\r\n} from '@igo2/common';\r\n\r\nimport { FeatureDataSource } from '../../datasource';\r\nimport { VectorLayer } from '../../layer';\r\nimport { IgoMap, MapExtent } from '../../map';\r\n\r\nimport { FeatureMotion } from './feature.enums';\r\nimport { Feature, FeatureStoreOptions } from './feature.interfaces';\r\nimport { computeOlFeaturesDiff, featureFromOl, featureToOl, moveToOlFeatures, computeOlFeaturesExtent } from './feature.utils';\r\n\r\n/**\r\n * The class is a specialized version of an EntityStore that stores\r\n * features and the map layer to display them on. Synchronization\r\n * between the store and the layer is handled by strategies.\r\n */\r\nexport class FeatureStore<T extends Feature = Feature> extends EntityStore<T> {\r\n\r\n  /**\r\n   * Vector layer to display the features on\r\n   */\r\n  layer: VectorLayer;\r\n\r\n  /**\r\n   * The map the layer is bound to\r\n   */\r\n  readonly map: IgoMap;\r\n\r\n  /**\r\n   * The layer's data source\r\n   */\r\n  get source(): FeatureDataSource {\r\n    return this.layer ? this.layer.dataSource as FeatureDataSource : undefined;\r\n  }\r\n\r\n  constructor(entities: T[], options: FeatureStoreOptions) {\r\n    super(entities, options);\r\n    this.map = options.map;\r\n  }\r\n\r\n  /**\r\n   * Bind this store to a vector layer\r\n   * @param layer Vector layer\r\n   * @returns Feature store\r\n   */\r\n  bindLayer(layer: VectorLayer): FeatureStore {\r\n    this.layer = layer;\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Set the layer's features and perform a motion to make them visible. Strategies\r\n   * make extensive use of that method.\r\n   * @param features Features\r\n   * @param motion Optional: The type of motion to perform\r\n   */\r\n  setLayerFeatures(\r\n    features: Feature[],\r\n    motion: FeatureMotion = FeatureMotion.Default,\r\n    viewScale?: [number, number, number, number],\r\n    areaRatio?: number,\r\n    getId?: (Feature) => EntityKey\r\n  ) {\r\n    getId = getId ? getId : getEntityId;\r\n    this.checkLayer();\r\n\r\n    const olFeatures = features\r\n      .map((feature: Feature) => featureToOl(feature, this.map.projection, getId));\r\n    this.setLayerOlFeatures(olFeatures, motion, viewScale, areaRatio);\r\n  }\r\n\r\n  /**\r\n   * Set the store's features from an array of OL features.\r\n   * @param olFeatures Ol features\r\n   */\r\n  setStoreOlFeatures(olFeatures: OlFeature<OlGeometry>[]) {\r\n    this.checkLayer();\r\n\r\n    const features = olFeatures.map((olFeature: OlFeature<OlGeometry>) => {\r\n      olFeature.set('_featureStore', this, true);\r\n      return featureFromOl(olFeature, this.layer.map.projection);\r\n    });\r\n    this.load(features as T[]);\r\n  }\r\n\r\n  /**\r\n   * Remove all features from the layer\r\n   */\r\n  clearLayer() {\r\n    this.checkLayer();\r\n    this.source.ol.clear();\r\n  }\r\n\r\n  /**\r\n   * Check wether a layer is bound or not and throw an error if not.\r\n   */\r\n  private checkLayer() {\r\n    if (this.layer === undefined) {\r\n      throw new Error('This FeatureStore is not bound to a layer.');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set the layer's features and perform a motion to make them visible.\r\n   * @param features Openlayers feature objects\r\n   * @param motion Optional: The type of motion to perform\r\n   */\r\n  public setLayerOlFeatures(\r\n    olFeatures: OlFeature<OlGeometry>[],\r\n    motion: FeatureMotion = FeatureMotion.Default,\r\n    viewScale?: [number, number, number, number],\r\n    areaRatio?: number\r\n  ) {\r\n    const olSource = this.layer.ol.getSource();\r\n    const diff = computeOlFeaturesDiff(olSource.getFeatures(), olFeatures);\r\n    if (diff.remove.length > 0) {\r\n      this.removeOlFeaturesFromLayer(diff.remove);\r\n    }\r\n\r\n    if (diff.add.length > 0) {\r\n      this.addOlFeaturesToLayer(diff.add);\r\n    }\r\n\r\n    if (diff.add.length > 0) {\r\n      // If features are added, do a motion toward the newly added features\r\n      moveToOlFeatures(this.map, diff.add, motion, viewScale, areaRatio);\r\n    } else if (diff.remove.length > 0) {\r\n      // Else, do a motion toward all the features\r\n      moveToOlFeatures(this.map, olFeatures, motion, viewScale, areaRatio);\r\n    }\r\n  }\r\n\r\n  setLayerExtent(): void {\r\n    let features = this.entities$.getValue();\r\n    let extent = olextent.createEmpty() as MapExtent;\r\n    let olFeatures = [];\r\n\r\n    features.forEach((feature) => {\r\n      olFeatures.push(featureToOl(feature, this.map.projection));\r\n    });\r\n    const featuresExtent = computeOlFeaturesExtent(this.map, olFeatures);\r\n    olextent.extend(extent, featuresExtent);\r\n    this.layer.setExtent(extent);\r\n  }\r\n  /**\r\n   * Add features to the the layer\r\n   * @param features Openlayers feature objects\r\n   */\r\n  private addOlFeaturesToLayer(olFeatures: OlFeature<OlGeometry>[]) {\r\n    olFeatures.forEach((olFeature: OlFeature<OlGeometry>) => {\r\n      olFeature.set('_featureStore', this, true);\r\n    });\r\n    this.source.ol.addFeatures(olFeatures);\r\n  }\r\n\r\n  /**\r\n   * Remove features from the the layer\r\n   * @param features Openlayers feature objects\r\n   */\r\n  private removeOlFeaturesFromLayer(olFeatures: OlFeature<OlGeometry>[]) {\r\n    olFeatures.forEach((olFeature: OlFeature<OlGeometry>) => {\r\n      this.source.ol.removeFeature(olFeature);\r\n    });\r\n  }\r\n\r\n}\r\n","import * as olextent from 'ol/extent';\r\n\r\nimport { EntityStoreStrategy } from '@igo2/common';\r\n\r\nimport { FeatureStore } from '../store';\r\nimport { FeatureStoreInMapExtentStrategyOptions } from '../feature.interfaces';\r\nimport { Subscription } from 'rxjs';\r\nimport { skipWhile } from 'rxjs/operators';\r\n\r\n/**\r\n * This strategy maintain the store features updated while the map is moved.\r\n * The features's state inside the map are tagged inMapExtent = true;\r\n */\r\nexport class FeatureStoreInMapExtentStrategy extends EntityStoreStrategy {\r\n\r\n  /**\r\n   * Subscription to the store's OL source changes\r\n   */\r\n  private stores$$ = new Map<FeatureStore, string>();\r\n  private states$$: Subscription[] = [];\r\n  private empty$$: Subscription;\r\n\r\n  constructor(protected options: FeatureStoreInMapExtentStrategyOptions) {\r\n    super(options);\r\n  }\r\n\r\n  /**\r\n   * Bind this strategy to a store and start watching for Ol source changes\r\n   * @param store Feature store\r\n   */\r\n  bindStore(store: FeatureStore) {\r\n    super.bindStore(store);\r\n    if (this.active === true) {\r\n      this.watchStore(store);\r\n    }\r\n    this.empty$$ = store.empty$\r\n      .pipe(skipWhile((empty) => !empty))\r\n      .subscribe(() => this.updateEntitiesInExtent(store));\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from a store and stop watching for Ol source changes\r\n   * @param store Feature store\r\n   */\r\n  unbindStore(store: FeatureStore) {\r\n    super.unbindStore(store);\r\n    if (this.active === true) {\r\n      this.unwatchStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start watching all stores already bound to that strategy at once.\r\n   * @internal\r\n   */\r\n  protected doActivate() {\r\n    this.stores.forEach((store: FeatureStore) => this.watchStore(store));\r\n  }\r\n\r\n  /**\r\n   * Stop watching all stores bound to that strategy\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {\r\n    this.unwatchAll();\r\n  }\r\n\r\n  /**\r\n   * Watch for a store's  OL source changes\r\n   * @param store Feature store\r\n   */\r\n  private watchStore(store: FeatureStore) {\r\n    if (this.stores$$.has(store)) {\r\n      return;\r\n    }\r\n\r\n    this.updateEntitiesInExtent(store);\r\n    this.states$$.push(store.layer.map.viewController.state$.subscribe(() => {\r\n      this.updateEntitiesInExtent(store);\r\n    }));\r\n  }\r\n\r\n  private updateEntitiesInExtent(store) {\r\n    if (store?.layer?.map?.viewController) {\r\n      store.state.updateAll({ inMapExtent: false });\r\n      const mapExtent = store.layer.map.viewController.getExtent();\r\n      let entitiesInMapExtent = [];\r\n      let entitiesWithNoGeom = [];\r\n      for (const entity of store.entities$.value) {\r\n        if (entity.ol) {\r\n          if (olextent.intersects(entity.ol.getGeometry().getExtent(), mapExtent)) {\r\n            entitiesInMapExtent.push(entity);\r\n          }\r\n        } else {\r\n          entitiesWithNoGeom.push(entity);\r\n        }\r\n      }\r\n      if (entitiesInMapExtent.length > 0) {\r\n        store.state.updateMany(entitiesInMapExtent, { inMapExtent: true }, false);\r\n      }\r\n      if (entitiesWithNoGeom.length > 0) {\r\n        store.state.updateMany(entitiesWithNoGeom, { inMapExtent: true }, false);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop watching for a store's OL source changes\r\n   * @param store Feature store\r\n   */\r\n  private unwatchStore(store: FeatureStore) {\r\n    const key = this.stores$$.get(store);\r\n    if (key !== undefined) {\r\n      this.stores$$.delete(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop watching for OL source changes in all stores.\r\n   */\r\n  private unwatchAll() {\r\n    this.stores$$.clear();\r\n    this.states$$.map(state => state.unsubscribe());\r\n    if (this.empty$$) { this.empty$$.unsubscribe(); }\r\n  }\r\n}\r\n","import { EntityStoreStrategy } from '@igo2/common';\r\n\r\nimport { FeatureStore } from '../store';\r\nimport { FeatureStoreInMapResolutionStrategyOptions } from '../feature.interfaces';\r\nimport { Subscription } from 'rxjs';\r\n\r\n\r\n/**\r\n * This strategy maintain the store features updated while the map is scrolled.\r\n * The features's state inside the map's resolution are tagged inMapResolution = true;\r\n */\r\nexport class FeatureStoreInMapResolutionStrategy extends EntityStoreStrategy {\r\n\r\n  /**\r\n   * Subscription to the store's OL source changes\r\n   */\r\n  private stores$$ = new Map<FeatureStore, string>();\r\n  private resolution$$: Subscription[] = [];\r\n  private empty$$: Subscription;\r\n\r\n  constructor(protected options: FeatureStoreInMapResolutionStrategyOptions) {\r\n    super(options);\r\n  }\r\n\r\n  /**\r\n   * Bind this strategy to a store and start watching for Ol source changes\r\n   * @param store Feature store\r\n   */\r\n  bindStore(store: FeatureStore) {\r\n    super.bindStore(store);\r\n    if (this.active === true) {\r\n      this.watchStore(store);\r\n    }\r\n    this.empty$$ = store.empty$\r\n      .subscribe(() => this.updateEntitiesInResolution(store, store.layer.map.viewController.getResolution()));\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from a store and stop watching for Ol source changes\r\n   * @param store Feature store\r\n   */\r\n  unbindStore(store: FeatureStore) {\r\n    super.unbindStore(store);\r\n    if (this.active === true) {\r\n      this.unwatchStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start watching all stores already bound to that strategy at once.\r\n   * @internal\r\n   */\r\n  protected doActivate() {\r\n    this.stores.forEach((store: FeatureStore) => this.watchStore(store));\r\n  }\r\n\r\n  /**\r\n   * Stop watching all stores bound to that strategy\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {\r\n    this.unwatchAll();\r\n  }\r\n\r\n  /**\r\n   * Watch for a store's  OL source changes\r\n   * @param store Feature store\r\n   */\r\n  private watchStore(store: FeatureStore) {\r\n    if (this.stores$$.has(store)) {\r\n      return;\r\n    }\r\n\r\n    this.updateEntitiesInResolution(store, store.layer.map.viewController.getResolution());\r\n    this.resolution$$.push(store.layer.map.viewController.resolution$.subscribe((res) => {\r\n      this.updateEntitiesInResolution(store, res);\r\n    }));\r\n  }\r\n\r\n  private updateEntitiesInResolution(store, mapResolution: number) {\r\n    if (mapResolution > store.layer.minResolution && mapResolution < store.layer.maxResolution) {\r\n      store.state.updateAll({ inMapResolution: true });\r\n    } else {\r\n      store.state.updateAll({ inMapResolution: false });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop watching for a store's OL source changes\r\n   * @param store Feature store\r\n   */\r\n  private unwatchStore(store: FeatureStore) {\r\n    const key = this.stores$$.get(store);\r\n    if (key !== undefined) {\r\n      this.stores$$.delete(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop watching for OL source changes in all stores.\r\n   */\r\n  private unwatchAll() {\r\n    this.stores$$.clear();\r\n    this.resolution$$.map(state => state.unsubscribe());\r\n    if (this.empty$$) { this.empty$$.unsubscribe(); }\r\n  }\r\n}\r\n","import { Subscription } from 'rxjs';\r\n\r\nimport { EntityStoreStrategy } from '@igo2/common';\r\n\r\nimport { FeatureMotion } from '../feature.enums';\r\nimport { Feature, FeatureStoreLoadingStrategyOptions } from '../feature.interfaces';\r\nimport { FeatureStore } from '../store';\r\n\r\n/**\r\n * This strategy loads a store's features into it's layer counterpart.\r\n * The store -> layer binding is a one-way binding. That means any entity\r\n * added to the store will be added to the layer but the opposite is false.\r\n *\r\n * Important: This strategy observes filtered entities, not raw entities. This\r\n * is not configurable yet.\r\n */\r\nexport class FeatureStoreLoadingStrategy extends EntityStoreStrategy {\r\n\r\n  /**\r\n   * Subscription to the store's features\r\n   */\r\n  private stores$$ = new Map<FeatureStore, Subscription>();\r\n\r\n  private motion: FeatureMotion;\r\n\r\n  constructor(protected options: FeatureStoreLoadingStrategyOptions) {\r\n    super(options);\r\n    this.setMotion(options.motion);\r\n  }\r\n\r\n  /**\r\n   * Bind this strategy to a store and start watching for entities changes\r\n   * @param store Feature store\r\n   */\r\n  bindStore(store: FeatureStore) {\r\n    super.bindStore(store);\r\n    if (this.active === true) {\r\n      this.watchStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from a store and stop watching for entities changes\r\n   * @param store Feature store\r\n   */\r\n  unbindStore(store: FeatureStore) {\r\n    super.unbindStore(store);\r\n    if (this.active === true) {\r\n      this.unwatchStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Define the motion to apply on load\r\n   * @param motion Feature motion\r\n   */\r\n  setMotion(motion: FeatureMotion) {\r\n    this.motion = motion;\r\n  }\r\n\r\n  /**\r\n   * Start watching all stores already bound to that strategy at once.\r\n   * @internal\r\n   */\r\n  protected doActivate() {\r\n    this.stores.forEach((store: FeatureStore) => this.watchStore(store));\r\n  }\r\n\r\n  /**\r\n   * Stop watching all stores bound to that strategy\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {\r\n    this.unwatchAll();\r\n  }\r\n\r\n  /**\r\n   * Watch for entities changes in a store.\r\n   * Important: Never observe a store's sorted entities. It makes no sense\r\n   * to display sorted entities (instead of unsorted) on a layer and it\r\n   * would potentially result in a lot of useless computation.\r\n   * @param store Feature store\r\n   */\r\n  private watchStore(store: FeatureStore) {\r\n    if (this.stores$$.has(store)) {\r\n      return;\r\n    }\r\n\r\n    const subscription = store.view.all$()\r\n      .subscribe((features: Feature[]) => this.onFeaturesChange(features, store));\r\n    this.stores$$.set(store, subscription);\r\n  }\r\n\r\n  /**\r\n   * Stop watching for entities changes in a store.\r\n   * @param store Feature store\r\n   */\r\n  private unwatchStore(store: FeatureStore) {\r\n    const subscription = this.stores$$.get(store);\r\n    if (subscription !== undefined) {\r\n      subscription.unsubscribe();\r\n      this.stores$$.delete(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop watching for entities changes in all stores.\r\n   */\r\n  private unwatchAll() {\r\n    Array.from(this.stores$$.entries()).forEach((entries: [FeatureStore, Subscription]) => {\r\n      entries[1].unsubscribe();\r\n    });\r\n    this.stores$$.clear();\r\n  }\r\n\r\n  /**\r\n   * Load features into a layer or clear the layer if the array of features is empty.\r\n   * @param features Store filtered features\r\n   * @param store Feature store\r\n   */\r\n  private onFeaturesChange(features: Feature[], store: FeatureStore) {\r\n    if (features.length === 0) {\r\n      store.clearLayer();\r\n    } else {\r\n      store.setLayerFeatures(\r\n        features,\r\n        this.selectMotion(store),\r\n        this.options.viewScale,\r\n        this.options.areaRatio,\r\n        this.options.getFeatureId\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Selects the best motion\r\n   * @param store A FeatureStore to apply the motion\r\n   * @returns The motion selected\r\n   */\r\n  private selectMotion(store: FeatureStore) {\r\n    if (this.motion !== undefined) { return this.motion; }\r\n\r\n    if (store.pristine === true) {\r\n      // If features have just been loaded into the store, move/zoom on them\r\n      return FeatureMotion.Default;\r\n    } else if (store.count > store.view.count) {\r\n      // If features have been filtered, move/zoom on the remaining ones\r\n      return FeatureMotion.Default;\r\n    } else {\r\n      // On insert, update or delete, do nothing\r\n      return FeatureMotion.None;\r\n    }\r\n  }\r\n}\r\n","import OlEvent from 'ol/events/Event';\r\n\r\nimport { EntityStoreStrategy } from '@igo2/common';\r\n\r\nimport { FeatureStore } from '../store';\r\nimport { FeatureStoreLoadingLayerStrategyOptions } from '../feature.interfaces';\r\nimport { ClusterDataSource } from '../../../datasource/shared/datasources/cluster-datasource';\r\n\r\n/**\r\n * This strategy loads a layer's features into it's store counterpart.\r\n * The layer -> store binding is a one-way binding. That means any OL feature\r\n * added to the layer will be added to the store but the opposite is false.\r\n *\r\n * Important: In it's current state, this strategy is to meant to be combined\r\n * with a standard Loading strategy and it would probably cause recursion issues.\r\n */\r\nexport class FeatureStoreLoadingLayerStrategy extends EntityStoreStrategy {\r\n\r\n  /**\r\n   * Subscription to the store's OL source changes\r\n   */\r\n  private stores$$ = new Map<FeatureStore, string>();\r\n\r\n  constructor(protected options: FeatureStoreLoadingLayerStrategyOptions) {\r\n    super(options);\r\n  }\r\n\r\n  /**\r\n   * Bind this strategy to a store and start watching for Ol source changes\r\n   * @param store Feature store\r\n   */\r\n  bindStore(store: FeatureStore) {\r\n    super.bindStore(store);\r\n    if (this.active === true) {\r\n      this.watchStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from a store and stop watching for Ol source changes\r\n   * @param store Feature store\r\n   */\r\n  unbindStore(store: FeatureStore) {\r\n    super.unbindStore(store);\r\n    if (this.active === true) {\r\n      this.unwatchStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start watching all stores already bound to that strategy at once.\r\n   * @internal\r\n   */\r\n  protected doActivate() {\r\n    this.stores.forEach((store: FeatureStore) => this.watchStore(store));\r\n  }\r\n\r\n  /**\r\n   * Stop watching all stores bound to that strategy\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {\r\n    this.unwatchAll();\r\n  }\r\n\r\n  /**\r\n   * Watch for a store's  OL source changes\r\n   * @param store Feature store\r\n   */\r\n  private watchStore(store: FeatureStore) {\r\n    if (this.stores$$.has(store)) {\r\n      return;\r\n    }\r\n\r\n    this.onSourceChanges(store);\r\n    const olSource = store.layer.ol.getSource();\r\n    olSource.on('change', (event: OlEvent) => {\r\n      this.onSourceChanges(store);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Stop watching for a store's OL source changes\r\n   * @param store Feature store\r\n   */\r\n  private unwatchStore(store: FeatureStore) {\r\n    const key = this.stores$$.get(store);\r\n    if (key !== undefined) {\r\n      this.stores$$.delete(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop watching for OL source changes in all stores.\r\n   */\r\n  private unwatchAll() {\r\n    Array.from(this.stores$$.entries()).forEach((entries: [FeatureStore, string]) => {\r\n    });\r\n    this.stores$$.clear();\r\n  }\r\n\r\n  /**\r\n   * Load features from an OL source into a  store or clear the store if the source is empty\r\n   * @param features Store filtered features\r\n   * @param store Feature store\r\n   */\r\n  private onSourceChanges(store: FeatureStore) {\r\n    let olFeatures = store.layer.ol.getSource().getFeatures();\r\n\r\n    if (store.layer.dataSource instanceof ClusterDataSource) {\r\n      olFeatures = (olFeatures as any).flatMap((cluster: any) =>\r\n        cluster.get('features')\r\n      );\r\n    }\r\n    if (olFeatures.length === 0) {\r\n      store.clear();\r\n    } else {\r\n      store.setStoreOlFeatures(olFeatures);\r\n    }\r\n  }\r\n}\r\n","import OlFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport OlDragBoxInteraction, { DragBoxEvent } from 'ol/interaction/DragBox';\r\nimport { DragBoxEvent as OlDragBoxEvent } from 'ol/interaction/DragBox';\r\nimport { EventsKey } from 'ol/events';\r\nimport MapBrowserPointerEvent from 'ol/MapBrowserEvent';\r\nimport { unByKey } from 'ol/Observable';\r\n\r\nimport { Subscription, combineLatest } from 'rxjs';\r\nimport { map, debounceTime, skip } from 'rxjs/operators';\r\n\r\nimport { EntityKey, EntityRecord, EntityStoreStrategy } from '@igo2/common';\r\n\r\nimport { FeatureDataSource } from '../../../datasource';\r\nimport { VectorLayer } from '../../../layer/shared/layers/vector-layer';\r\nimport { IgoMap } from '../../../map/shared/map';\r\nimport { ctrlKeyDown } from '../../../map/shared/map.utils';\r\n\r\nimport {\r\n  Feature,\r\n  FeatureStoreSelectionStrategyOptions\r\n} from '../feature.interfaces';\r\nimport { FeatureStore } from '../store';\r\nimport { FeatureMotion } from '../feature.enums';\r\n\r\nexport class OlDragSelectInteraction extends OlDragBoxInteraction {\r\n  constructor(options) {\r\n    super(options);\r\n  }\r\n}\r\n\r\n/**\r\n * This strategy synchronizes a store and a layer selected entities.\r\n * The store <-> layer binding is a two-way binding.\r\n *\r\n * In many cases, a single strategy bound to multiple stores\r\n * will yield better results that multiple strategies with each their\r\n * own store. In the latter scenario, a click on overlapping features\r\n * would trigger the strategy of each layer and they would cancel\r\n * each other as well as move the map view around needlessly.\r\n */\r\nexport class FeatureStoreSelectionStrategy extends EntityStoreStrategy {\r\n  /**\r\n   * Listener to the map click event that allows selecting a feature\r\n   * by clicking on the map\r\n   */\r\n  private mapClickListener;\r\n\r\n  private olDragSelectInteraction: OlDragSelectInteraction;\r\n\r\n  private olDragSelectInteractionEndKey: EventsKey | EventsKey[];\r\n\r\n  /**\r\n   * Subscription to all stores selected entities\r\n   */\r\n  private stores$$: Subscription;\r\n\r\n  private motion: FeatureMotion;\r\n\r\n  /**\r\n   * The map the layers belong to\r\n   */\r\n  get map(): IgoMap {\r\n    return this.options.map;\r\n  }\r\n\r\n  /**\r\n   * A feature store that'll contain the selected features. It has it's own\r\n   * layer, shared by all the stores this staretgy is bound to.\r\n   */\r\n  get overlayStore(): FeatureStore {\r\n    return this._overlayStore;\r\n  }\r\n  private _overlayStore: FeatureStore;\r\n\r\n  constructor(protected options: FeatureStoreSelectionStrategyOptions) {\r\n    super(options);\r\n    this.setMotion(options.motion);\r\n    this._overlayStore = this.createOverlayStore();\r\n  }\r\n\r\n  /**\r\n   * Bind this strategy to a store and force this strategy's\r\n   * reactivation to properly setup watchers.\r\n   * @param store Feature store\r\n   */\r\n  bindStore(store: FeatureStore) {\r\n    super.bindStore(store);\r\n    if (this.active === true) {\r\n      // Force reactivation\r\n      this.activate();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from a store and force this strategy's\r\n   * reactivation to properly setup watchers.\r\n   * @param store Feature store\r\n   */\r\n  unbindStore(store: FeatureStore) {\r\n    super.unbindStore(store);\r\n    if (this.active === true) {\r\n      // Force reactivation\r\n      this.activate();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Define the motion to apply on select\r\n   * @param motion Feature motion\r\n   */\r\n  setMotion(motion: FeatureMotion) {\r\n    this.motion = motion;\r\n  }\r\n\r\n  /**\r\n   * Unselect all entities, from all stores\r\n   */\r\n  unselectAll() {\r\n    this.stores.forEach((store: FeatureStore) => {\r\n      store.state.updateAll({ selected: false });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay\r\n   */\r\n  clear() {\r\n    this.overlayStore.source.ol.clear();\r\n    this.overlayStore.clear();\r\n  }\r\n\r\n  /**\r\n   * Deactivate the selection without removing the selection\r\n   * overlay.\r\n   */\r\n  deactivateSelection() {\r\n    this.unlistenToMapClick();\r\n    this.removeDragBoxInteraction();\r\n    this.unwatchAll();\r\n  }\r\n\r\n  /**\r\n   * Add the overlay layer, setup the map click lsitener and\r\n   * start watching for stores selection\r\n   * @internal\r\n   */\r\n  protected doActivate() {\r\n    this.addOverlayLayer();\r\n    this.listenToMapClick();\r\n    if (this.options.dragBox === true) {\r\n      this.addDragBoxInteraction();\r\n    }\r\n    this.watchAll();\r\n  }\r\n\r\n  /**\r\n   * Remove the overlay layer, remove the map click lsitener and\r\n   * stop watching for stores selection\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {\r\n    this.deactivateSelection();\r\n    this.removeOverlayLayer();\r\n  }\r\n\r\n  /**\r\n   * Create a single observable of all the stores. With a single observable,\r\n   * features can be added all at once to the overlay layer and a single\r\n   * motion can be performed. Multiple observable would have\r\n   * a cancelling effect on each other.\r\n   */\r\n  private watchAll() {\r\n    this.unwatchAll();\r\n\r\n    const stores$ = this.stores.map((store: FeatureStore) => {\r\n      return store.stateView\r\n        .manyBy$((record: EntityRecord<Feature>) => {\r\n          return record.state.selected === true;\r\n        })\r\n        .pipe(\r\n          map((records: EntityRecord<Feature>[]) =>\r\n            records.map((record) => record.entity)\r\n          )\r\n        );\r\n    });\r\n    this.stores$$ = combineLatest(stores$)\r\n      .pipe(\r\n        debounceTime(5),\r\n        skip(1), // Skip intial selection\r\n        map((features: Array<Feature[]>) =>\r\n          features.reduce((a, b) => a.concat(b))\r\n        )\r\n      )\r\n      .subscribe((features: Feature[]) => this.onSelectFromStore(features));\r\n  }\r\n\r\n  /**\r\n   * Stop watching for selection in all stores.\r\n   */\r\n  private unwatchAll() {\r\n    if (this.stores$$ !== undefined) {\r\n      this.stores$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add a 'singleclick' listener to the map that'll allow selecting\r\n   * features by clicking on the map. The selection will be performed\r\n   * only on the layers bound to this strategy.\r\n   */\r\n  private listenToMapClick() {\r\n    this.mapClickListener = this.map.ol.on(\r\n      'singleclick',\r\n      (event: MapBrowserPointerEvent<any>) => {\r\n        this.onMapClick(event);\r\n      }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Remove the map click listener\r\n   */\r\n  private unlistenToMapClick() {\r\n    unByKey(this.mapClickListener);\r\n  }\r\n\r\n  /**\r\n   * On map click, select feature at pixel\r\n   * @param event OL MapBrowserPointerEvent\r\n   */\r\n  private onMapClick(event: MapBrowserPointerEvent<any>) {\r\n    const exclusive = !ctrlKeyDown(event);\r\n    const reverse = !exclusive;\r\n    const olFeatures = event.map.getFeaturesAtPixel(event.pixel, {\r\n      hitTolerance: this.options.hitTolerance || 0,\r\n      layerFilter: olLayer => {\r\n        const storeOlLayer = this.stores.find((store: FeatureStore) => {\r\n          return store.layer?.ol === olLayer;\r\n        });\r\n        return storeOlLayer !== undefined;\r\n      }\r\n    }) as OlFeature<OlGeometry>[];\r\n    this.onSelectFromMap(olFeatures, exclusive, reverse);\r\n  }\r\n\r\n  /**\r\n   * Add a drag box interaction and, on drag box end, select features\r\n   */\r\n  private addDragBoxInteraction() {\r\n    let olDragSelectInteraction;\r\n    const olInteractions = this.map.ol.getInteractions().getArray();\r\n\r\n    // There can only be one dragbox interaction, so find the current one, if any\r\n    // Don't keep a reference to the current dragbox because we don't want\r\n    // to remove it when this startegy is deactivated\r\n    for (const olInteraction of olInteractions) {\r\n      if (olInteraction instanceof OlDragSelectInteraction) {\r\n        olDragSelectInteraction = olInteraction;\r\n        break;\r\n      }\r\n    }\r\n    // If no drag box interaction is found, create a new one and add it to the map\r\n    if (olDragSelectInteraction === undefined) {\r\n      olDragSelectInteraction = new OlDragSelectInteraction({\r\n        condition: ctrlKeyDown\r\n      });\r\n      this.map.ol.addInteraction(olDragSelectInteraction);\r\n      this.olDragSelectInteraction = olDragSelectInteraction;\r\n    }\r\n\r\n    this.olDragSelectInteractionEndKey = olDragSelectInteraction.on(\r\n      'boxend',\r\n      (event: DragBoxEvent) => this.onDragBoxEnd(event)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Remove drag box interaction\r\n   */\r\n  private removeDragBoxInteraction() {\r\n    if (this.olDragSelectInteractionEndKey !== undefined) {\r\n      unByKey(this.olDragSelectInteractionEndKey);\r\n    }\r\n    if (this.olDragSelectInteraction !== undefined) {\r\n      this.map.ol.removeInteraction(this.olDragSelectInteraction);\r\n    }\r\n    this.olDragSelectInteraction = undefined;\r\n  }\r\n\r\n  /**\r\n   * On dragbox end, select features in drag box\r\n   * @param event OL MapBrowserPointerEvent\r\n   */\r\n  private onDragBoxEnd(event: OlDragBoxEvent) {\r\n    const exclusive = !ctrlKeyDown(event.mapBrowserEvent);\r\n    const target = event.target as any;\r\n    const extent = target.getGeometry().getExtent();\r\n    const olFeatures = this.stores.reduce(\r\n      (acc: OlFeature<OlGeometry>[], store: FeatureStore) => {\r\n        const olSource = store.layer.ol.getSource();\r\n        acc.push(...olSource.getFeaturesInExtent(extent));\r\n        return acc;\r\n      },\r\n      []\r\n    );\r\n    this.onSelectFromMap(olFeatures, exclusive, false);\r\n  }\r\n\r\n  /**\r\n   * When features are selected from the store, add\r\n   * them to this startegy's overlay layer (select on map)\r\n   * @param features Store features\r\n   */\r\n  private onSelectFromStore(features: Feature[]) {\r\n    const motion = this.motion;\r\n    const olOverlayFeatures = this.overlayStore.layer.ol\r\n      .getSource()\r\n      .getFeatures();\r\n    const overlayFeaturesKeys = olOverlayFeatures.map((olFeature: OlFeature<OlGeometry>) =>\r\n      olFeature.getId()\r\n    );\r\n    const featuresKeys = features.map(this.overlayStore.getKey);\r\n\r\n    let doMotion;\r\n    if (features.length === 0) {\r\n      doMotion = false;\r\n    } else {\r\n      doMotion =\r\n        overlayFeaturesKeys.length !== featuresKeys.length ||\r\n        !overlayFeaturesKeys.every(\r\n          (key: EntityKey) => featuresKeys.indexOf(key) >= 0\r\n        );\r\n    }\r\n\r\n    this.overlayStore.setLayerFeatures(\r\n      features,\r\n      doMotion ? motion : FeatureMotion.None,\r\n      this.options.viewScale,\r\n      this.options.areaRatio,\r\n      this.options.getFeatureId\r\n    );\r\n  }\r\n\r\n  /**\r\n   * When features are selected from the map, also select them\r\n   * in their store.\r\n   * @param olFeatures OL feature objects\r\n   */\r\n  private onSelectFromMap(\r\n    olFeatures: OlFeature<OlGeometry>[],\r\n    exclusive: boolean,\r\n    reverse: boolean\r\n  ) {\r\n    const groupedFeatures = this.groupFeaturesByStore(olFeatures);\r\n\r\n    this.stores.forEach((store: FeatureStore) => {\r\n      const features = groupedFeatures.get(store);\r\n      if (features === undefined && exclusive === true) {\r\n        this.unselectAllFeaturesFromStore(store);\r\n      } else if (features === undefined && exclusive === false) {\r\n        // Do nothing\r\n      } else {\r\n        this.selectFeaturesFromStore(store, features, exclusive, reverse);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Select features in store\r\n   * @param store: Feature store\r\n   * @param features Features\r\n   */\r\n  private selectFeaturesFromStore(\r\n    store: FeatureStore,\r\n    features: Feature[],\r\n    exclusive: boolean,\r\n    reverse: boolean\r\n  ) {\r\n    if (reverse === true) {\r\n      store.state.reverseMany(features, ['selected']);\r\n    } else {\r\n      store.state.updateMany(features, { selected: true }, exclusive);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unselect all features from store\r\n   * @param store: Feature store\r\n   */\r\n  private unselectAllFeaturesFromStore(store: FeatureStore) {\r\n    store.state.updateAll({ selected: false });\r\n  }\r\n\r\n  /**\r\n   * This method returns a store -> features mapping from a list\r\n   * of OL selected features. OL features keep a reference to the store\r\n   * they are from.\r\n   * @param olFeatures: OL feature objects\r\n   * @returns Store -> features mapping\r\n   */\r\n  private groupFeaturesByStore(\r\n    olFeatures: OlFeature<OlGeometry>[]\r\n  ): Map<FeatureStore, Feature[]> {\r\n    const groupedFeatures = new Map<FeatureStore, Feature[]>();\r\n    if (olFeatures === null || olFeatures === undefined) {\r\n      return groupedFeatures;\r\n    }\r\n\r\n    olFeatures.forEach((olFeature: OlFeature<OlGeometry>) => {\r\n      const store = olFeature.get('_featureStore');\r\n      if (store === undefined) {\r\n        return;\r\n      }\r\n\r\n      let features = groupedFeatures.get(store);\r\n      if (features === undefined) {\r\n        features = [];\r\n        groupedFeatures.set(store, features);\r\n      }\r\n\r\n      const feature = store.get(olFeature.getId());\r\n      if (feature !== undefined) {\r\n        features.push(feature);\r\n      }\r\n    });\r\n\r\n    return groupedFeatures;\r\n  }\r\n\r\n  /**\r\n   * Create an overlay store that'll contain the selected features.\r\n   * @returns Overlay store\r\n   */\r\n  private createOverlayStore(): FeatureStore {\r\n    const overlayLayer = this.options.layer\r\n      ? this.options.layer\r\n      : this.createOverlayLayer();\r\n    return new FeatureStore([], { map: this.map }).bindLayer(overlayLayer);\r\n  }\r\n\r\n  /**\r\n   * Create an overlay store that'll contain the selected features.\r\n   * @returns Overlay layer\r\n   */\r\n  private createOverlayLayer(): VectorLayer {\r\n    return new VectorLayer({\r\n      zIndex: 300,\r\n      source: new FeatureDataSource(),\r\n      style: undefined,\r\n      showInLayerList: false,\r\n      exportable: false,\r\n      browsable: false\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Add the overlay store's layer to the map to display the selected\r\n   * features.\r\n   */\r\n  private addOverlayLayer() {\r\n    if (this.overlayStore.layer.map === undefined) {\r\n      this.map.addLayer(this.overlayStore.layer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove the overlay layer from the map\r\n   */\r\n  private removeOverlayLayer() {\r\n    this.overlayStore.source.ol.clear();\r\n    this.map.removeLayer(this.overlayStore.layer);\r\n  }\r\n}\r\n","import { FeatureStore } from './store';\r\nimport { FeatureStoreSelectionStrategy } from './strategies/selection';\r\nimport { FeatureStoreLoadingStrategy } from './strategies/loading';\r\n\r\n/**\r\n * Try to add a loading strategy to a store and activate it.\r\n * If no strategy is given to that function, a basic one will be created.\r\n * @param store The store to bind the loading strategy\r\n * @param strategy An optional loading strategy\r\n */\r\nexport function tryAddLoadingStrategy(\r\n  store: FeatureStore,\r\n  strategy?: FeatureStoreLoadingStrategy\r\n) {\r\n  if (store.getStrategyOfType(FeatureStoreLoadingStrategy) !== undefined) {\r\n    store.activateStrategyOfType(FeatureStoreLoadingStrategy);\r\n    return;\r\n  }\r\n\r\n  strategy = strategy ? strategy : new FeatureStoreLoadingStrategy({});\r\n  store.addStrategy(strategy);\r\n  strategy.activate();\r\n}\r\n\r\n/**\r\n * Try to add a selection strategy to a store and activate it.\r\n * If no strategy is given to that function, a basic one will be created.\r\n * @param store The store to bind the selection strategy\r\n * @param [strategy] An optional selection strategy\r\n */\r\nexport function tryAddSelectionStrategy(\r\n  store: FeatureStore,\r\n  strategy?: FeatureStoreSelectionStrategy\r\n) {\r\n  if (store.getStrategyOfType(FeatureStoreSelectionStrategy) !== undefined) {\r\n    store.activateStrategyOfType(FeatureStoreSelectionStrategy);\r\n    return;\r\n  }\r\n  strategy = strategy\r\n    ? strategy\r\n    : new FeatureStoreSelectionStrategy({\r\n        map: store.map\r\n      });\r\n  store.addStrategy(strategy);\r\n  strategy.activate();\r\n}\r\n","import * as olstyle from 'ol/style';\r\nimport { asArray as ColorAsArray } from 'ol/color';\r\n\r\n/**\r\n * Create a marker style for points\r\n * @returns Style\r\n */\r\nexport function createOverlayMarkerStyle({\r\n  text,\r\n  opacity = 1,\r\n  markerColor = [0, 161, 222],\r\n  markerOutlineColor = [255, 255, 255]\r\n}: {\r\n  text?: string;\r\n  opacity?: number;\r\n  markerColor?: string | number[];\r\n  markerOutlineColor?: string | number[];\r\n} = {}): olstyle.Style {\r\n  let iconColor;\r\n  let svgIconColor;\r\n  let svgOutlineColor;\r\n  let svg;\r\n\r\n  const isIE = /msie\\s|trident\\/|edge\\//i.test(window.navigator.userAgent); // To fix IE11 svg bug (temporarly)\r\n\r\n  const newColor = ColorAsArray(markerColor).slice(0);\r\n  const newOutlineColor = ColorAsArray(markerOutlineColor).slice(0);\r\n\r\n  if (newColor.length === 4 && (typeof markerColor !== 'string' || /^#[0-9A-F]{8}$/i.test(markerColor as string))) {\r\n    opacity = newColor[3];\r\n  }\r\n\r\n  svgIconColor = `\"rgba(${newColor[0]},${newColor[1]},${newColor[2]},${opacity})\"`;\r\n  iconColor = markerColor;\r\n\r\n  svgOutlineColor = `\"rgb(${newOutlineColor[0]},${newOutlineColor[1]},${newOutlineColor[2]})\"`;\r\n\r\n  svg =\r\n    'data:image/svg+xml;utf8,<svg version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" height=\"36\" width=\"36\" viewBox=\"0 0 36 36\">' +\r\n    '<path fill=' +\r\n    svgIconColor +\r\n    ' stroke=' +\r\n    svgOutlineColor +\r\n    ` stroke-width=\"2\" d=\"M 17.692635,32.565644 C 15.71852,30.330584 13.290925,27.058065 11.6766,24.455732 9.3398623,20.688851 7.8905694,17.205334 7.6297492,14.728733 7.5616025,14.081649 7.5739557,12.528552 7.6513363,12.014724 8.1013861,9.0262716 9.8047068,6.3655569 12.310675,4.7364878 c 1.113691,-0.7239832 2.508083,-1.2834131 3.776687,-1.5152052 0.242945,-0.044389 0.451656,-0.09393 0.463804,-0.1100911 0.01215,-0.016161 0.638282,-0.025502 1.391411,-0.02076 1.088235,0.00685 1.450932,0.024316 1.766871,0.085071 2.650763,0.5097353 4.947142,1.8701891 6.498786,3.8501033 0.628018,0.8013587 1.297046,2.0200608 1.640967,2.9891872 0.191065,0.538399 0.427644,1.447408 0.477391,1.834287 0.0164,0.127546 0.0434,0.231902 0.06,0.231902 0.0166,0 0.03122,0.626135 0.03249,1.391411 0.0013,0.765276 -0.011,1.391411 -0.02726,1.391411 -0.01626,0 -0.05449,0.154049 -0.08495,0.342331 -0.08815,0.544879 -0.387235,1.721449 -0.604837,2.379406 -1.209421,3.656888 -4.014463,8.349762 -7.849521,13.132357 -0.790496,0.985807 -1.795217,2.167992 -1.842543,2.167992 -0.01896,0 -0.161766,-0.144111 -0.317336,-0.320246 z m 1.066937,-15.36525 c 0.133519,-0.02121 0.248766,-0.05657 0.256105,-0.07859 0.0073,-0.02202 0.04918,-0.03066 0.09298,-0.0192 0.0438,0.01145 0.107628,-0.0072 0.141834,-0.04137 0.03421,-0.03421 0.08456,-0.05474 0.111888,-0.04563 0.02733,0.0091 0.07703,-0.01077 0.110429,-0.04417 0.03341,-0.03341 0.08416,-0.05293 0.112796,-0.04338 0.02863,0.0095 0.08974,-0.01867 0.135802,-0.06271 0.04606,-0.04403 0.111902,-0.08625 0.146319,-0.09381 0.204084,-0.04483 0.762371,-0.519108 1.079463,-0.917027 0.26749,-0.335672 0.570987,-0.878795 0.529019,-0.946701 -0.01496,-0.0242 -0.0067,-0.044 0.01835,-0.044 0.05645,0 0.196809,-0.467982 0.158801,-0.529481 -0.01521,-0.02461 -0.0043,-0.04475 0.02427,-0.04475 0.03157,0 0.04365,-0.04329 0.03082,-0.11043 -0.01161,-0.06074 -0.0066,-0.110429 0.01124,-0.110429 0.01779,0 0.03235,-0.258405 0.03235,-0.574233 0,-0.315829 -0.01545,-0.574234 -0.03434,-0.574234 -0.01889,0 -0.02437,-0.03811 -0.01219,-0.08469 0.04412,-0.168712 -0.336329,-1.152668 -0.481536,-1.245401 -0.02327,-0.01486 -0.04022,-0.03992 -0.03765,-0.05568 0.01222,-0.07498 -0.156557,-0.318365 -0.406379,-0.586027 -0.295921,-0.317054 -0.773059,-0.690104 -0.83427,-0.652274 -0.0206,0.01273 -0.03745,0.0024 -0.03745,-0.02289 0,-0.06107 -0.433076,-0.2789369 -0.487546,-0.245273 -0.02338,0.01445 -0.04251,0.0068 -0.04251,-0.01695 0,-0.056281 -0.393995,-0.1865457 -0.613804,-0.2029397 -0.0943,-0.00703 -0.188579,-0.023183 -0.209503,-0.035888 -0.02092,-0.012705 -0.276571,-0.023337 -0.568105,-0.023627 -0.534044,-5.301e-4 -1.12638,0.091025 -1.12638,0.1741017 0,0.023781 -0.01713,0.032648 -0.03808,0.019705 -0.05054,-0.031232 -0.403641,0.1088602 -0.403641,0.1601422 0,0.02204 -0.01988,0.02779 -0.04417,0.01278 -0.0243,-0.01501 -0.04417,-0.0051 -0.04417,0.02209 0,0.02716 -0.01988,0.0371 -0.04417,0.02209 -0.0243,-0.01501 -0.04417,-0.0051 -0.04417,0.02209 0,0.02716 -0.01915,0.03755 -0.04256,0.02308 -0.02341,-0.01447 -0.08138,0.01252 -0.128834,0.05997 -0.04745,0.04745 -0.0974,0.07515 -0.111001,0.06155 -0.0136,-0.0136 -0.03722,0.0078 -0.05248,0.0476 -0.01526,0.03978 -0.0411,0.06408 -0.0574,0.054 -0.03277,-0.02025 -0.462299,0.323995 -0.491977,0.394291 -0.01026,0.02429 -0.07454,0.0912 -0.142856,0.148686 -0.248033,0.208705 -0.730279,0.974169 -0.672565,1.067553 0.0145,0.02346 0.0059,0.04266 -0.01914,0.04266 -0.05907,0 -0.241471,0.599428 -0.208527,0.685278 0.01385,0.0361 0.0044,0.06564 -0.02098,0.06564 -0.02539,0 -0.04169,0.0646 -0.03622,0.143558 0.0055,0.07896 -0.0042,0.213129 -0.02144,0.29816 -0.04741,0.233576 0.0511,1.055502 0.167516,1.397721 0.126048,0.370516 0.310099,0.740163 0.426484,0.856548 0.04776,0.04776 0.07554,0.08684 0.06174,0.08684 -0.0138,0 0.01516,0.05653 0.06436,0.125632 0.131301,0.184396 0.499365,0.587266 0.518785,0.567846 0.0092,-0.0092 0.09821,0.06081 0.197812,0.155562 0.09961,0.09475 0.190589,0.162786 0.202187,0.151188 0.0116,-0.0116 0.05991,0.01774 0.107361,0.06519 0.04745,0.04745 0.105426,0.07444 0.128834,0.05997 0.02341,-0.01447 0.04256,-0.0057 0.04256,0.01958 0,0.06106 0.344664,0.23496 0.399061,0.201341 0.02346,-0.0145 0.04266,-0.0059 0.04266,0.01914 0,0.05907 0.599429,0.241471 0.685279,0.208527 0.0361,-0.01385 0.06564,-0.0065 0.06564,0.01645 0,0.05196 1.079115,0.04833 1.413314,-0.0048 z\"></path>` +\r\n    '</svg>';\r\n\r\n  let src;\r\n  if (isIE) {\r\n    switch (markerColor) {\r\n      case 'blue' || [0, 161, 222] || '#00a1de':\r\n        iconColor = 'blue';\r\n        break;\r\n      case 'red' || '#f64139':\r\n        iconColor = 'red';\r\n        break;\r\n      case 'yellow' || '#ffd700':\r\n        iconColor = 'yellow';\r\n        break;\r\n      case 'green' || '#008000':\r\n        iconColor = 'green';\r\n        break;\r\n      default:\r\n        iconColor = 'blue';\r\n        break;\r\n    }\r\n    src = './assets/igo2/geo/icons/place_' + iconColor + '_36px.svg';\r\n  } else {\r\n    src = svg;\r\n  }\r\n\r\n  return new olstyle.Style({\r\n    image: new olstyle.Icon({\r\n      src: svg,\r\n      opacity,\r\n      imgSize: [36, 36], // for ie\r\n      anchor: [0.5, 0.92]\r\n    }),\r\n    text: new olstyle.Text({\r\n      text,\r\n      font: '12px Calibri,sans-serif',\r\n      fill: new olstyle.Fill({ color: '#000' }),\r\n      stroke: new olstyle.Stroke({ color: '#fff', width: 3 }),\r\n      overflow: true\r\n    })\r\n  });\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport * as olstyle from 'ol/style';\r\nimport OlFeature from 'ol/Feature';\r\nimport { StyleByAttribute } from './vector-style.interface';\r\n\r\nimport { ClusterParam } from './clusterParam';\r\nimport { createOverlayMarkerStyle } from '../../overlay/shared/overlay-marker-style.utils';\r\nimport RenderFeature from 'ol/render/Feature';\r\nimport { getResolutionFromScale } from '../../map/shared/map.utils';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class StyleService {\r\n  public style: olstyle.Style;\r\n\r\n  /**\r\n   * Create a style based on a object as\r\n   * style: {\r\n   *       \"stroke\": {\r\n   *         \"color\": \"blue\",\r\n   *         \"lineDash\": [10, 5]\r\n   *       },\r\n   *       \"text\": {\r\n   *         \"minScaleDenom\": 50000,\r\n   *         \"maxScaleDenom\": 200000,\r\n   *         \"minResolution\": 100,\r\n   *         \"maxResolution\": 400,\r\n   *         \"attribute\": \"THE COLUMN NAME TO RETRIEVE THE LABEL VALUE\",\r\n   *         \"text\": \"MY HARCODED TEXT\",\r\n   *         \"stroke\": {\r\n   *           \"color\": \"blue\",\r\n   *           \"width\": 0.75\r\n   *         },\r\n   *         \"fill\": {\r\n   *           \"color\": \"black\"\r\n   *         },\r\n   *         \"font\": \"20px sans-serif\",\r\n   *         \"overflow\": true,\r\n   *         \"offsetX\": 10,\r\n   *         \"offsetY\": 20,\r\n   *         \"padding\": [2.5, 2.5, 2.5, 2.5]\r\n   *       },\r\n   *       \"width\": 5\r\n   *     }\r\n   *\r\n   * @param options\r\n   * @param feature feature to apply style on\r\n   * @param resolution current map resolution, to control label resolution range\r\n   * @returns\r\n   */\r\n  createStyle(options: { [key: string]: any }, feature?: RenderFeature | OlFeature<OlGeometry>, resolution?: number) {\r\n\r\n    if (!options) {\r\n      return createOverlayMarkerStyle();\r\n    }\r\n    if (typeof options === 'function' || options instanceof olstyle.Style) {\r\n      return options;\r\n    }\r\n    const parsedStyle = this.parseStyle('style', options);\r\n    if (parsedStyle.getText()) {\r\n      let labelMinResolution = 0;\r\n      let labelMaxResolution = Infinity;\r\n      if (options.text) {\r\n        const labelMinResolutionFromScale =\r\n          options.text?.minScaleDenom ? getResolutionFromScale(Number(options.text.minScaleDenom)) : undefined;\r\n        const labelMaxResolutionFromScale =\r\n          options.text?.maxScaleDenom ? getResolutionFromScale(Number(options.text.maxScaleDenom)) : undefined;\r\n        const minResolution = options.text?.minResolution ? options.text.minResolution : 0;\r\n        const maxResolution = options.text?.maxResolution ? options.text.maxResolution : Infinity;\r\n\r\n        labelMinResolution = labelMinResolutionFromScale || minResolution;\r\n        labelMaxResolution = labelMaxResolutionFromScale || maxResolution;\r\n      }\r\n      if (feature && resolution >= labelMinResolution && resolution <= labelMaxResolution) {\r\n        if (feature && options.text.attribute) {\r\n          parsedStyle.getText().setText(this.getLabel(feature, options.text.attribute));\r\n        }\r\n      } else {\r\n        parsedStyle.setText();\r\n      }\r\n    }\r\n    return parsedStyle;\r\n  }\r\n\r\n  private parseStyle(key: string, value: any) {\r\n    const styleOptions = {};\r\n    const olCls = this.getOlCls(key);\r\n\r\n    if (olCls && value instanceof Object) {\r\n      Object.keys(value).forEach(_key => {\r\n        const olKey = this.getOlKey(_key);\r\n        styleOptions[olKey] = this.parseStyle(_key, value[_key]);\r\n      });\r\n      return new olCls(styleOptions);\r\n    } else {\r\n      return value;\r\n    }\r\n  }\r\n\r\n  private getOlKey(key: any) {\r\n    let olKey;\r\n    switch (key.toLowerCase()) {\r\n      case 'circle':\r\n      case 'regularshape':\r\n      case 'icon':\r\n        olKey = 'image';\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n\r\n    return olKey || key;\r\n  }\r\n\r\n  private getOlCls(key: any) {\r\n    let olCls = olstyle[key.charAt(0).toUpperCase() + key.slice(1)];\r\n    if (key === 'regularshape') {\r\n      olCls = olstyle.RegularShape;\r\n    }\r\n    if (key === 'backgroundFill') {\r\n      olCls = olstyle.Fill;\r\n    }\r\n    if (key === 'backgroundStroke') {\r\n      olCls = olstyle.Stroke;\r\n    }\r\n\r\n    return olCls;\r\n  }\r\n\r\n  createStyleByAttribute(feature: RenderFeature | OlFeature<OlGeometry>, styleByAttribute: StyleByAttribute, resolution: number) {\r\n\r\n    let style;\r\n    const type = styleByAttribute.type ? styleByAttribute.type : this.guessTypeFeature(feature);\r\n    const attribute = styleByAttribute.attribute;\r\n    const data = styleByAttribute.data;\r\n    const stroke = styleByAttribute.stroke;\r\n    const width = styleByAttribute.width;\r\n    const fill = styleByAttribute.fill;\r\n    const anchor = styleByAttribute.anchor;\r\n    const radius = styleByAttribute.radius;\r\n    const icon = styleByAttribute.icon;\r\n    const scale = styleByAttribute.scale;\r\n    const size = data ? data.length : 0;\r\n    const label = styleByAttribute.label ? styleByAttribute.label.attribute : undefined;\r\n    const labelMinResolutionFromScale =\r\n      styleByAttribute.label?.minScaleDenom ? getResolutionFromScale(Number(styleByAttribute.label.minScaleDenom)) : undefined;\r\n    const labelMaxResolutionFromScale =\r\n      styleByAttribute.label?.maxScaleDenom ? getResolutionFromScale(Number(styleByAttribute.label.maxScaleDenom)) : undefined;\r\n    const minResolution = styleByAttribute.label?.minResolution ? styleByAttribute.label.minResolution : 0;\r\n    const maxResolution = styleByAttribute.label?.maxResolution ? styleByAttribute.label.maxResolution : Infinity;\r\n\r\n    const labelMinResolution = labelMinResolutionFromScale || minResolution;\r\n    const labelMaxResolution = labelMaxResolutionFromScale || maxResolution;\r\n\r\n    let labelStyle = styleByAttribute.label?.style ? this.parseStyle('text', styleByAttribute.label.style) : undefined;\r\n    if (!labelStyle && label) {\r\n        labelStyle = new olstyle.Text();\r\n    }\r\n    const baseStyle = styleByAttribute.baseStyle;\r\n\r\n    if (labelStyle) {\r\n      if (resolution >= labelMinResolution && resolution <= labelMaxResolution) {\r\n        labelStyle.setText(this.getLabel(feature, label));\r\n      } else {\r\n        labelStyle.setText('');\r\n      }\r\n    }\r\n\r\n    if (type === 'circle') {\r\n      for (let i = 0; i < size; i++) {\r\n        const val =\r\n          typeof feature.get(attribute) !== 'undefined' && feature.get(attribute) !== null\r\n            ? feature.get(attribute)\r\n            : '';\r\n        if (val === data[i] || val.toString().match(new RegExp(data[i], 'gmi'))) {\r\n          if (icon) {\r\n            style = [\r\n              new olstyle.Style({\r\n                image: new olstyle.Icon({\r\n                  color: fill ? fill[i] : undefined,\r\n                  src: icon[i],\r\n                  scale: scale ? scale[i] : 1,\r\n                  anchor: anchor ? anchor[i] : [0.5, 0.5]\r\n                }),\r\n                text: labelStyle instanceof olstyle.Text ? labelStyle : undefined\r\n              })\r\n            ];\r\n            return style;\r\n          }\r\n          style = [\r\n            new olstyle.Style({\r\n              image: new olstyle.Circle({\r\n                radius: radius ? radius[i] : 4,\r\n                stroke: new olstyle.Stroke({\r\n                  color: stroke ? stroke[i] : 'black',\r\n                  width: width ? width[i] : 1\r\n                }),\r\n                fill: new olstyle.Fill({\r\n                  color: fill ? fill[i] : 'black'\r\n                })\r\n              }),\r\n              text: labelStyle instanceof olstyle.Text ? labelStyle : undefined\r\n            })\r\n          ];\r\n          return style;\r\n        }\r\n      }\r\n      if (!(feature as OlFeature<OlGeometry>).getStyle()) {\r\n        if (baseStyle) {\r\n          style = this.createStyle(baseStyle, feature, resolution);\r\n          if (labelStyle) {\r\n            style.setText(labelStyle);\r\n          }\r\n          return style;\r\n        }\r\n        style = [\r\n          new olstyle.Style({\r\n            image: new olstyle.Circle({\r\n              radius: 4,\r\n              stroke: new olstyle.Stroke({\r\n                color: 'black'\r\n              }),\r\n              fill: new olstyle.Fill({\r\n                color: '#bbbbf2'\r\n              })\r\n            })\r\n          })\r\n        ];\r\n        return style;\r\n      }\r\n    } else if (type === 'regular') {\r\n      for (let i = 0; i < size; i++) {\r\n        const val =\r\n        typeof feature.get(attribute) !== 'undefined' && feature.get(attribute) !== null\r\n            ? feature.get(attribute)\r\n            : '';\r\n        if (val === data[i] || val.toString().match(new RegExp(data[i], 'gmi'))) {\r\n          style = [\r\n            new olstyle.Style({\r\n              stroke: new olstyle.Stroke({\r\n                color: stroke ? stroke[i] : 'black',\r\n                width: width ? width[i] : 1\r\n              }),\r\n              fill: new olstyle.Fill({\r\n                color: fill ? fill[i] : 'rgba(255,255,255,0.4)'\r\n              }),\r\n              text: labelStyle instanceof olstyle.Text ? labelStyle : undefined\r\n            })\r\n          ];\r\n          return style;\r\n        }\r\n      }\r\n      if (feature instanceof OlFeature) {\r\n        if (!feature.getStyle()) {\r\n          if (baseStyle) {\r\n            style = this.createStyle(baseStyle, feature, resolution);\r\n            if (labelStyle) {\r\n              style.setText(labelStyle);\r\n            }\r\n            return style;\r\n          }\r\n          style = [\r\n            new olstyle.Style({\r\n              stroke: new olstyle.Stroke({\r\n                color: 'black'\r\n              }),\r\n              fill: new olstyle.Fill({\r\n                color: '#bbbbf2'\r\n              })\r\n            })\r\n          ];\r\n          return style;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  createClusterStyle(feature: RenderFeature | OlFeature<OlGeometry>, resolution: number, clusterParam: ClusterParam = {}, layerStyle) {\r\n    let style;\r\n    const size = feature.get('features').length;\r\n    if (size !== 1) {\r\n      if (clusterParam.clusterRanges) {\r\n        for (const r of clusterParam.clusterRanges) {\r\n          if (\r\n            (!r.minRadius || r.minRadius <= size) &&\r\n            (!r.maxRadius || r.maxRadius >= size)\r\n          ) {\r\n            style = this.createStyle(r.style) as olstyle.Circle;\r\n\r\n            if (r.showRange) {\r\n              const text = new olstyle.Text({\r\n                text: size.toString(),\r\n                fill: new olstyle.Fill({\r\n                  color: '#fff'\r\n                })\r\n              });\r\n              style.setText(text);\r\n            }\r\n\r\n            if (r.dynamicRadius) {\r\n              let clusterRadius: number;\r\n              const radiusMin = style.getRadius();\r\n              clusterRadius = 5 * Math.log(size);\r\n              if (clusterRadius < radiusMin) {\r\n                clusterRadius = radiusMin;\r\n              }\r\n              style.image_.setRadius(clusterRadius);\r\n            }\r\n            break;\r\n          }\r\n        }\r\n      }\r\n\r\n      if (!style) {\r\n        let clusterRadius: number;\r\n        if (clusterParam.radiusCalc) {\r\n          clusterRadius = clusterParam.radiusCalc(size);\r\n        } else {\r\n          const radiusMin = 6;\r\n          clusterRadius = 5 * Math.log(size);\r\n          if (clusterRadius < radiusMin) {\r\n            clusterRadius = radiusMin;\r\n          }\r\n        }\r\n\r\n        style = [\r\n          new olstyle.Style({\r\n            image: new olstyle.Circle({\r\n              radius: clusterRadius,\r\n              stroke: new olstyle.Stroke({\r\n                color: 'black'\r\n              }),\r\n              fill: new olstyle.Fill({\r\n                color: 'rgba(24, 134, 45, 0.5)'\r\n              })\r\n            }),\r\n            text: new olstyle.Text({\r\n              text: size.toString(),\r\n              fill: new olstyle.Fill({\r\n                color: '#fff'\r\n              })\r\n            })\r\n          })\r\n        ];\r\n      }\r\n    } else {\r\n      style = this.createStyle(layerStyle, feature, resolution);\r\n    }\r\n    return style;\r\n  }\r\n\r\n  getLabel(feature, labelMatch): string {\r\n    let label = labelMatch;\r\n    if (!label) {\r\n      return;\r\n    }\r\n    const labelToGet = Array.from(labelMatch.matchAll(/\\$\\{([^\\{\\}]+)\\}/g));\r\n\r\n    labelToGet.forEach(v => {\r\n      label = label.replace(v[0], feature.get(v[1]));\r\n    });\r\n\r\n    // Nothing done? check feature's attribute\r\n    if (labelToGet.length === 0 && label === labelMatch) {\r\n      label = feature.get(labelMatch) || labelMatch;\r\n    }\r\n\r\n    return label;\r\n  }\r\n\r\n  private guessTypeFeature(feature) {\r\n    switch (feature.getGeometry().getType()) {\r\n      case 'Point':\r\n      case 'MultiPoint':\r\n      case 'Circle':\r\n        return 'circle';\r\n      default:\r\n        return 'regular';\r\n    }\r\n  }\r\n}\r\n","import * as olstyle from 'ol/style';\r\nimport OlFeature from 'ol/Feature';\r\nimport { asArray as ColorAsArray } from 'ol/color';\r\n\r\nimport { FeatureDataSource } from '../../datasource';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { StyleService } from '../../layer/shared/style.service';\r\nimport { createOverlayMarkerStyle } from './overlay-marker-style.utils';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\n/**\r\n * Create an overlay layer and it's source\r\n * @returns Overlay layer\r\n */\r\nexport function createOverlayLayer(): VectorLayer {\r\n  const overlayDataSource = new FeatureDataSource();\r\n  return new VectorLayer({\r\n    title: 'Overlay',\r\n    zIndex: 300,\r\n    source: overlayDataSource,\r\n    style: createOverlayLayerStyle()\r\n  });\r\n}\r\n\r\n/**\r\n * Create an overlay style with markers for points and a basic stroke/fill\r\n * combination for lines and polygons\r\n * @returns Style function\r\n */\r\nfunction createOverlayLayerStyle(): (olFeature: OlFeature<OlGeometry>, resolution: number) => olstyle.Style {\r\n  const defaultStyle = createOverlayDefaultStyle();\r\n  const markerStyle = createOverlayMarkerStyle();\r\n\r\n  let style;\r\n\r\n  return (olFeature: OlFeature<OlGeometry>, resolution) => {\r\n    if (olFeature.getId() === 'bufferFeature') {\r\n      style = createBufferStyle(\r\n        olFeature.get('bufferStroke'),\r\n        2,\r\n        olFeature.get('bufferFill'),\r\n        olFeature.get('bufferText')\r\n      );\r\n      return style;\r\n    } else {\r\n      const customStyle = olFeature.get('_style');\r\n      if (customStyle) {\r\n        const styleService = new StyleService();\r\n        return styleService.createStyle(customStyle, olFeature, resolution);\r\n      }\r\n      const geometryType = olFeature.getGeometry().getType();\r\n      style = geometryType === 'Point' ? markerStyle : defaultStyle;\r\n      style.getText().setText(olFeature.get('_mapTitle'));\r\n      return style;\r\n    }\r\n  };\r\n}\r\n\r\n/**\r\n * Create a basic style for lines and polygons\r\n * @returns Style\r\n */\r\nexport function createOverlayDefaultStyle({\r\n  text,\r\n  strokeWidth = 2,\r\n  fillColor = [0, 161, 222, 0.3],\r\n  strokeColor = [0, 161, 222, 0.9],\r\n}: {\r\n  text?: string;\r\n  strokeWidth?: number;\r\n  fillColor?: string | number[];\r\n  strokeColor?: string | number[];\r\n} = {}): olstyle.Style {\r\n  const fillWithOpacity = ColorAsArray(fillColor).slice(0);\r\n  const strokeWithOpacity = ColorAsArray(strokeColor).slice(0);\r\n\r\n  const stroke = new olstyle.Stroke({\r\n    width: strokeWidth,\r\n    color: strokeWithOpacity\r\n  });\r\n\r\n  const fill = new olstyle.Fill({\r\n    color: fillWithOpacity\r\n  });\r\n\r\n  return new olstyle.Style({\r\n    stroke,\r\n    fill,\r\n    image: new olstyle.Circle({\r\n      radius: 5,\r\n      stroke,\r\n      fill\r\n    }),\r\n    text: new olstyle.Text({\r\n      text,\r\n      font: '12px Calibri,sans-serif',\r\n      fill: new olstyle.Fill({ color: '#000' }),\r\n      stroke: new olstyle.Stroke({ color: '#fff', width: 3 }),\r\n      overflow: true\r\n    })\r\n  });\r\n}\r\n\r\nfunction createBufferStyle(\r\n  strokeRGBA: [number, number, number, number] = [0, 161, 222, 1],\r\n  strokeWidth: number = 2,\r\n  fillRGBA: [number, number, number, number] = [0, 161, 222, 0.15],\r\n  bufferRadius?\r\n): olstyle.Style {\r\n  const stroke = new olstyle.Stroke({\r\n    width: strokeWidth,\r\n    color: strokeRGBA\r\n  });\r\n\r\n  const fill = new olstyle.Fill({\r\n    color: fillRGBA\r\n  });\r\n\r\n  return new olstyle.Style({\r\n    stroke,\r\n    fill,\r\n    image: new olstyle.Circle({\r\n      radius: 5,\r\n      stroke,\r\n      fill\r\n    }),\r\n    text: new olstyle.Text({\r\n      font: '12px Calibri,sans-serif',\r\n      text: bufferRadius,\r\n      fill: new olstyle.Fill({ color: '#000' }),\r\n      stroke: new olstyle.Stroke({ color: '#fff', width: 3 }),\r\n      overflow: true\r\n    })\r\n  });\r\n}\r\n","import OlFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport {\r\n  Feature,\r\n  FeatureMotion,\r\n  featureToOl,\r\n  moveToOlFeatures\r\n} from '../../feature/shared';\r\nimport { FeatureDataSource } from '../../datasource';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { IgoMap } from '../../map/shared/map';\r\n\r\nimport { createOverlayLayer } from './overlay.utils';\r\n\r\n/**\r\n * This class is simply a shortcut for adding features to a map.\r\n * It does nothing more than a standard layer but it's shipped with\r\n * a defautl style based on the geometry type of the features it contains.\r\n * @todo Enhance that by using a FeatureStore and strategies.\r\n */\r\nexport class Overlay {\r\n  /**\r\n   * The map to add the layer to\r\n   */\r\n  private map: IgoMap;\r\n\r\n  /**\r\n   * Overlay layer\r\n   */\r\n  private layer: VectorLayer;\r\n\r\n  /**\r\n   * Overlay layer's data source\r\n   */\r\n  get dataSource(): FeatureDataSource {\r\n    return this.layer.dataSource as FeatureDataSource;\r\n  }\r\n\r\n  constructor(map?: IgoMap) {\r\n    this.layer = createOverlayLayer();\r\n    this.setMap(map);\r\n  }\r\n\r\n  /**\r\n   * Bind this to a map and add the overlay layer to that map\r\n   * @param map Map\r\n   */\r\n  setMap(map: IgoMap) {\r\n    if (map === undefined) {\r\n      if (this.map !== undefined) {\r\n        this.map.ol.removeLayer(this.layer.ol);\r\n      }\r\n    } else {\r\n      map.ol.addLayer(this.layer.ol);\r\n    }\r\n    this.map = map;\r\n  }\r\n\r\n  /**\r\n   * Set the overlay features and, optionally, move to them\r\n   * @param features Features\r\n   * @param motion Optional: Apply this motion to the map view\r\n   * @param sourceId Optional: Remove features of certain sourceId (ex: 'Map' for query features)\r\n   */\r\n  setFeatures(\r\n    features: Feature[],\r\n    motion: FeatureMotion = FeatureMotion.Default,\r\n    sourceId?: string\r\n  ) {\r\n    if (sourceId) {\r\n      for (const olFeature of this.dataSource.ol.getFeatures()) {\r\n        if (olFeature.get('_sourceId') === sourceId) {\r\n          this.removeOlFeature(olFeature);\r\n        }\r\n      }\r\n    } else {\r\n      this.clear();\r\n    }\r\n    this.addFeatures(features, motion);\r\n  }\r\n\r\n  /**\r\n   * Add a feature to the  overlay and, optionally, move to it\r\n   * @param feature Feature\r\n   * @param motion Optional: Apply this motion to the map view\r\n   */\r\n  addFeature(feature: Feature, motion: FeatureMotion = FeatureMotion.Default) {\r\n    this.addFeatures([feature], motion);\r\n  }\r\n\r\n  /**\r\n   * Add features to the  overlay and, optionally, move to them\r\n   * @param features Features\r\n   * @param motion Optional: Apply this motion to the map view\r\n   */\r\n  addFeatures(\r\n    features: Feature[],\r\n    motion: FeatureMotion = FeatureMotion.Default\r\n  ) {\r\n    const olFeatures = [];\r\n    features.forEach((feature: Feature) => {\r\n      const olFeature = featureToOl(feature, this.map.projection);\r\n      const olGeometry = olFeature.getGeometry();\r\n      if (olGeometry === null) {\r\n        return;\r\n      }\r\n      olFeatures.push(olFeature);\r\n    });\r\n\r\n    this.addOlFeatures(olFeatures, motion);\r\n  }\r\n\r\n  /**\r\n   * Add a OpenLayers feature to the  overlay and, optionally, move to it\r\n   * @param olFeature OpenLayers Feature\r\n   * @param motion Optional: Apply this motion to the map view\r\n   */\r\n  addOlFeature(\r\n    olFeature: OlFeature<OlGeometry>,\r\n    motion: FeatureMotion = FeatureMotion.Default\r\n  ) {\r\n    this.addOlFeatures([olFeature], motion);\r\n  }\r\n\r\n  /**\r\n   * Add OpenLayers features to the overlay and, optionally, move to them\r\n   * @param olFeatures OpenLayers Features\r\n   * @param motion Optional: Apply this motion to the map view\r\n   */\r\n  addOlFeatures(\r\n    olFeatures: OlFeature<OlGeometry>[],\r\n    motion: FeatureMotion = FeatureMotion.Default\r\n  ) {\r\n    this.dataSource.ol.addFeatures(olFeatures);\r\n    moveToOlFeatures(this.map, olFeatures, motion);\r\n  }\r\n\r\n  /**\r\n   * Remove a feature from the overlay\r\n   * @param feature Feature\r\n   */\r\n  removeFeature(feature: Feature) {\r\n    this.removeFeatures([feature]);\r\n  }\r\n\r\n  /**\r\n   * Remove features from the overlay\r\n   * @param features Features\r\n   */\r\n  removeFeatures(features: Feature[]) {\r\n    features.forEach((feature: Feature) => {\r\n      if (feature.meta) {\r\n        if (this.dataSource.ol.getFeatureById(feature.meta.id)) {\r\n          this.removeOlFeature(this.dataSource.ol.getFeatureById(feature.meta.id));\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Remove an OpenLayers feature from the overlay\r\n   * @param olFeature OpenLayers Feature\r\n   */\r\n  removeOlFeature(olFeature: OlFeature<OlGeometry>) {\r\n    this.dataSource.ol.removeFeature(olFeature);\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay\r\n   */\r\n  clear() {\r\n    this.dataSource.ol.clear();\r\n  }\r\n}\r\n","import olLayer from 'ol/layer/Layer';\r\nimport olSource from 'ol/source/Source';\r\nimport { Message } from '@igo2/core';\r\n\r\nimport { DataSource } from '../../../datasource/shared/datasources/datasource';\r\nimport { AnyDataSourceOptions } from '../../../datasource/shared/datasources/any-datasource.interface';\r\nimport { MapExtent, MapViewOptions } from '../../../map/shared/map.interface';\r\n\r\nexport interface LayerOptions {\r\n  isIgoInternalLayer?: boolean; // useful when mapOffline directive set the resolution of the layers.\r\n  source?: DataSource;\r\n  sourceOptions?: AnyDataSourceOptions;\r\n  title?: string;\r\n  id?: string;\r\n  alias?: string;\r\n  baseLayer?: boolean;\r\n  opacity?: number;\r\n  visible?: boolean;\r\n  extent?: MapExtent;\r\n  zIndex?: number;\r\n  messages?: Message[];\r\n  minResolution?: number;\r\n  maxResolution?: number;\r\n  minScaleDenom?: number;\r\n  maxScaleDenom?: number;\r\n  showInLayerList?: boolean;\r\n  removable?: boolean;\r\n  workspace?: GeoWorkspaceOptions;\r\n  legendOptions?: LegendOptions;\r\n  ol?: olLayer<olSource>;\r\n  tooltip?: TooltipContent;\r\n  _internal?: { [key: string]: string };\r\n  active?: boolean;\r\n  check?: boolean;\r\n  linkedLayers?: LayersLink;\r\n  showButtonZoomToExtent?: boolean;\r\n}\r\n\r\nexport interface GeoWorkspaceOptions {\r\n  srcId?: string;\r\n  workspaceId?: string;\r\n  minResolution?: number;\r\n  maxResolution?: number;\r\n  enabled?: boolean;\r\n  queryOptions?: GeoWorkspaceQueryOptions;\r\n  pageSize?: number;\r\n  pageSizeOptions?: number[];\r\n}\r\n\r\nexport interface GeoWorkspaceQueryOptions {\r\n  mapQueryOnOpenTab?: boolean;\r\n  tabQuery?: boolean;\r\n}\r\n\r\nexport interface LayersLink {\r\n  linkId: string;\r\n  links?: LayersLinkProperties[];\r\n}\r\nexport interface LayersLinkProperties {\r\n  linkedIds: string[];\r\n  syncedDelete: boolean;\r\n  properties: LinkedProperties[];\r\n}\r\n\r\nexport enum LinkedProperties {\r\n  OPACITY = 'opacity',\r\n  VISIBLE = 'visible',\r\n  OGCFILTERS = 'ogcFilters',\r\n  MINRESOLUTION = 'minResolution',\r\n  MAXRESOLUTION = 'maxResolution',\r\n  ZINDEX = 'zIndex',\r\n  TIMEFILTER = 'timeFilter'\r\n}\r\n\r\nexport interface GroupLayers {\r\n  title: string;\r\n  layers?: LayerOptions;\r\n  collapsed?: boolean;\r\n}\r\n\r\nexport interface TooltipContent {\r\n  type?: TooltipType;\r\n  text?: string;\r\n}\r\nexport enum TooltipType {\r\n  TITLE = 'title',\r\n  ABSTRACT = 'abstract',\r\n  CUSTOM = 'custom'\r\n}\r\n\r\nexport interface LegendOptions {\r\n  collapsed?: boolean;\r\n  display?: boolean;\r\n  url?: string;\r\n  html?: string;\r\n  stylesAvailable?: ItemStyleOptions[];\r\n}\r\n\r\nexport interface LegendMapViewOptions extends MapViewOptions{\r\n  scale?: number;\r\n  size?: [number, number];\r\n}\r\n\r\nexport interface ItemStyleOptions {\r\n  name: string;\r\n  title?: string;\r\n}\r\n\r\nexport interface OutputLayerLegend {\r\n  title: string;\r\n  url: string;\r\n  display: boolean;\r\n}\r\n","import olLayerImage from 'ol/layer/Image';\r\nimport olSourceImage from 'ol/source/Image';\r\n\r\nimport { AuthInterceptor } from '@igo2/auth';\r\n\r\nimport { ImageWatcher } from '../../utils';\r\nimport { IgoMap } from '../../../map';\r\n\r\nimport { WMSDataSource } from '../../../datasource/shared/datasources/wms-datasource';\r\n\r\nimport { Layer } from './layer';\r\nimport { ImageLayerOptions } from './image-layer.interface';\r\nimport { ImageArcGISRestDataSource } from '../../../datasource/shared/datasources/imagearcgisrest-datasource';\r\nimport { LanguageService, MessageService } from '@igo2/core';\r\n\r\nexport class ImageLayer extends Layer {\r\n  public dataSource: WMSDataSource | ImageArcGISRestDataSource;\r\n  public options: ImageLayerOptions;\r\n  public ol: olLayerImage<olSourceImage>;\r\n\r\n  private watcher: ImageWatcher;\r\n\r\n  constructor(\r\n    options: ImageLayerOptions,\r\n    public messageService: MessageService,\r\n    private languageService: LanguageService,\r\n    public authInterceptor?: AuthInterceptor\r\n  ) {\r\n    super(options, messageService, authInterceptor);\r\n    this.watcher = new ImageWatcher(this, this.messageService, this.languageService);\r\n    this.status$ = this.watcher.status$;\r\n    this.status$.subscribe(valStatus => {\r\n      if (valStatus === 0) {\r\n        this.olLoadingProblem = true;\r\n      }\r\n    });\r\n  }\r\n\r\n  protected createOlLayer(): olLayerImage<olSourceImage> {\r\n    const olOptions = Object.assign({}, this.options, {\r\n      source: this.options.source.ol as olSourceImage\r\n    });\r\n\r\n    const image = new olLayerImage(olOptions);\r\n    if (this.authInterceptor) {\r\n      (image.getSource() as any).setImageLoadFunction((tile, src) => {\r\n        this.customLoader(tile, src, this.authInterceptor, this.messageService, this.languageService);\r\n      });\r\n    }\r\n\r\n    return image;\r\n  }\r\n\r\n  public setMap(map: IgoMap | undefined) {\r\n    if (map === undefined) {\r\n      this.watcher.unsubscribe();\r\n    } else {\r\n      this.watcher.subscribe(() => {});\r\n    }\r\n    super.setMap(map);\r\n  }\r\n\r\n  private customLoader(tile, src: string, interceptor: AuthInterceptor, messageService: MessageService, languageService: LanguageService) {\r\n    const xhr = new XMLHttpRequest();\r\n\r\n    const alteredUrlWithKeyAuth = interceptor.alterUrlWithKeyAuth(src);\r\n    let url = src;\r\n    if (alteredUrlWithKeyAuth) {\r\n      url = alteredUrlWithKeyAuth;\r\n    }\r\n    xhr.open('GET', url);\r\n    const intercepted = interceptor.interceptXhr(xhr, url);\r\n    if (!intercepted) {\r\n      xhr.abort();\r\n      tile.getImage().src = url;\r\n      return;\r\n    }\r\n\r\n    xhr.responseType = 'arraybuffer';\r\n\r\n    xhr.onload = function() {\r\n      const arrayBufferView = new Uint8Array((this as any).response);\r\n      const responseString = new TextDecoder().decode(arrayBufferView);\r\n      if (responseString.includes('ServiceExceptionReport')) {\r\n        messageService.error(languageService.translate.instant(\r\n          'igo.geo.dataSource.optionsApiUnavailable'\r\n        ),\r\n        languageService.translate.instant(\r\n          'igo.geo.dataSource.unavailableTitle'\r\n        ));\r\n      }\r\n      const blob = new Blob([arrayBufferView], { type: 'image/png' });\r\n      const urlCreator = window.URL;\r\n      const imageUrl = urlCreator.createObjectURL(blob);\r\n      tile.getImage().src = imageUrl;\r\n    };\r\n    xhr.send();\r\n  }\r\n}\r\n","import olLayerTile from 'ol/layer/Tile';\r\nimport olSourceTile from 'ol/source/Tile';\r\nimport Tile from 'ol/Tile';\r\n\r\nimport { TileWatcher } from '../../utils';\r\nimport { IgoMap } from '../../../map';\r\n\r\nimport { OSMDataSource } from '../../../datasource/shared/datasources/osm-datasource';\r\nimport { WMTSDataSource } from '../../../datasource/shared/datasources/wmts-datasource';\r\nimport { XYZDataSource } from '../../../datasource/shared/datasources/xyz-datasource';\r\nimport { CartoDataSource } from '../../../datasource/shared/datasources/carto-datasource';\r\nimport { TileArcGISRestDataSource } from '../../../datasource/shared/datasources/tilearcgisrest-datasource';\r\nimport { TileDebugDataSource } from '../../../datasource/shared/datasources/tiledebug-datasource';\r\n\r\nimport { Layer } from './layer';\r\nimport { TileLayerOptions } from './tile-layer.interface';\r\n\r\nimport { MessageService } from '@igo2/core';\r\nimport { AuthInterceptor } from '@igo2/auth';\r\nexport class TileLayer extends Layer {\r\n  public dataSource:\r\n    | OSMDataSource\r\n    | WMTSDataSource\r\n    | XYZDataSource\r\n    | TileDebugDataSource\r\n    | CartoDataSource\r\n    | TileArcGISRestDataSource;\r\n  public options: TileLayerOptions;\r\n  public ol: olLayerTile<olSourceTile>;\r\n\r\n  private watcher: TileWatcher;\r\n\r\n  constructor(\r\n    options: TileLayerOptions,\r\n    public messageService?: MessageService,\r\n    public authInterceptor?: AuthInterceptor) {\r\n    super(options, messageService);\r\n\r\n    this.watcher = new TileWatcher(this);\r\n    this.status$ = this.watcher.status$;\r\n  }\r\n\r\n  protected createOlLayer(): olLayerTile<olSourceTile> {\r\n    const olOptions = Object.assign({}, this.options, {\r\n      source: this.options.source.ol\r\n    });\r\n    const tileLayer = new olLayerTile(olOptions);\r\n    const tileSource = tileLayer.getSource();\r\n    tileSource.setTileLoadFunction((tile: Tile, url: string) => {\r\n      this.customLoader(tile, url, this.authInterceptor);\r\n    });\r\n\r\n    return tileLayer;\r\n  }\r\n\r\n  /**\r\n   * Custom loader for tile layer.\r\n   * @internal\r\n   * @param tile the current tile\r\n   * @param url the url string or function to retrieve the data\r\n   */\r\n  customLoader(tile, url: string, interceptor: AuthInterceptor ) {\r\n\r\n    const alteredUrlWithKeyAuth = interceptor.alterUrlWithKeyAuth(url);\r\n    let modifiedUrl = url;\r\n    if (alteredUrlWithKeyAuth) {\r\n      modifiedUrl = alteredUrlWithKeyAuth;\r\n    }\r\n    tile.getImage().src = modifiedUrl;\r\n  }\r\n\r\n  public setMap(map: IgoMap | undefined) {\r\n    if (map === undefined) {\r\n      this.watcher.unsubscribe();\r\n    } else {\r\n      this.watcher.subscribe(() => {});\r\n    }\r\n    super.setMap(map);\r\n  }\r\n}\r\n","import olLayerVectorTile from 'ol/layer/VectorTile';\r\nimport olSourceVectorTile from 'ol/source/VectorTile';\r\n\r\nimport { MVTDataSource } from '../../../datasource/shared/datasources/mvt-datasource';\r\n\r\nimport { Layer } from './layer';\r\nimport { VectorTileLayerOptions } from './vectortile-layer.interface';\r\nimport { TileWatcher } from '../../utils';\r\nimport { AuthInterceptor } from '@igo2/auth';\r\nimport { IgoMap } from '../../../map';\r\nimport { MessageService } from '@igo2/core';\r\nimport VectorTile from 'ol/VectorTile';\r\n\r\nexport class VectorTileLayer extends Layer {\r\n  public dataSource: MVTDataSource;\r\n  public options: VectorTileLayerOptions;\r\n  public ol: olLayerVectorTile;\r\n\r\n  private watcher: TileWatcher;\r\n\r\n  constructor(\r\n    options: VectorTileLayerOptions,\r\n    public messageService?: MessageService,\r\n    public authInterceptor?: AuthInterceptor) {\r\n    super(options, messageService, authInterceptor);\r\n    this.watcher = new TileWatcher(this);\r\n    this.status$ = this.watcher.status$;\r\n  }\r\n\r\n  protected createOlLayer(): olLayerVectorTile {\r\n    const olOptions = Object.assign({}, this.options, {\r\n      source: this.options.source.ol as olSourceVectorTile\r\n    });\r\n\r\n    const vectorTile = new olLayerVectorTile(olOptions);\r\n    const vectorTileSource = vectorTile.getSource() as olSourceVectorTile;\r\n\r\n    vectorTileSource.setTileLoadFunction((tile: VectorTile, url: string) => {\r\n      const loader = this.customLoader(url, tile.getFormat(), this.authInterceptor, tile.onLoad.bind(tile));\r\n      if (loader) {\r\n        tile.setLoader(loader);\r\n      }\r\n    }\r\n    );\r\n\r\n    return vectorTile;\r\n  }\r\n\r\n  /**\r\n   * Custom loader for vector tile layer. Modified from the loadFeaturesXhr function in ol\\featureloader.js\r\n   * @internal\r\n   * @param url the url string or function to retrieve the data\r\n   * @param format the format of the tile\r\n   * @param interceptor the interceptor of the data\r\n   * @param success On success event action to trigger\r\n   * @param failure On failure event action to trigger TODO\r\n   */\r\n  customLoader(url, format, interceptor, success, failure?) {\r\n    return ((extent, resolution, projection) => {\r\n      const xhr = new XMLHttpRequest();\r\n      let modifiedUrl = url;\r\n      if (typeof url !== 'function') {\r\n        const alteredUrlWithKeyAuth = interceptor.alterUrlWithKeyAuth(url);\r\n        if (alteredUrlWithKeyAuth) {\r\n          modifiedUrl = alteredUrlWithKeyAuth;\r\n        }\r\n      } else {\r\n        modifiedUrl = url(extent, resolution, projection);\r\n      }\r\n      xhr.open( 'GET', modifiedUrl);\r\n      if (interceptor) {\r\n        interceptor.interceptXhr(xhr, modifiedUrl);\r\n      }\r\n\r\n      if (format.getType() === 'arraybuffer') {\r\n        xhr.responseType = 'arraybuffer';\r\n      }\r\n      xhr.onload = (event) => {\r\n        if (!xhr.status || xhr.status >= 200 && xhr.status < 300) {\r\n          const type = format.getType();\r\n          let source;\r\n          if (type === 'json' || type === 'text') {\r\n            source = xhr.responseText;\r\n          }\r\n          else if (type === 'xml') {\r\n            source = xhr.responseXML;\r\n            if (!source) {\r\n              source = new DOMParser().parseFromString(xhr.responseText, 'application/xml');\r\n            }\r\n          }\r\n          else if (type === 'arraybuffer') {\r\n            source = xhr.response;\r\n          }\r\n          if (source) {\r\n            success.call(this, format.readFeatures(source, {\r\n              extent,\r\n              featureProjection: projection\r\n            }), format.readProjection(source));\r\n          }\r\n          else {\r\n            // TODO\r\n            failure.call(this);\r\n          }\r\n        } else {\r\n          // TODO\r\n          failure.call(this);\r\n        }\r\n      };\r\n      xhr.onerror = () => {\r\n        // TODO\r\n        failure.call(this);\r\n      };\r\n      xhr.send();\r\n    });\r\n  }\r\n\r\n  public setMap(map: IgoMap | undefined) {\r\n    if (map === undefined) {\r\n      this.watcher.unsubscribe();\r\n    } else {\r\n      this.watcher.subscribe(() => {});\r\n    }\r\n    super.setMap(map);\r\n  }\r\n}\r\n","import { BehaviorSubject, Subscription } from 'rxjs';\r\nimport { distinctUntilChanged } from 'rxjs/operators';\r\n\r\nimport { Watcher, SubjectStatus } from '@igo2/utils';\r\nimport { Layer, LinkedProperties } from '../../layer/shared/layers';\r\nimport { ObjectEvent } from 'ol/Object';\r\n\r\nexport class LayerWatcher extends Watcher {\r\n  public propertyChange$: BehaviorSubject<{event:ObjectEvent, layer: Layer}> = new BehaviorSubject(undefined);\r\n  private loaded = 0;\r\n  private loading = 0;\r\n  private layers: Layer[] = [];\r\n  private subscriptions: Subscription[] = [];\r\n\r\n  constructor() {\r\n    super();\r\n  }\r\n\r\n  watch() {}\r\n\r\n  unwatch() {\r\n    this.layers.forEach(layer => this.unwatchLayer(layer), this);\r\n  }\r\n\r\n  setPropertyChange(change: ObjectEvent, layer: Layer) {\r\n\r\n    if (![\r\n      LinkedProperties.TIMEFILTER,\r\n      LinkedProperties.OGCFILTERS,\r\n      LinkedProperties.VISIBLE,\r\n      LinkedProperties.OPACITY,\r\n      LinkedProperties.MINRESOLUTION,\r\n      LinkedProperties.MAXRESOLUTION]\r\n      .includes(change.key as any)) {\r\n      return;\r\n  }\r\n  this.propertyChange$.next({event: change, layer});\r\n  }\r\n\r\n  watchLayer(layer: Layer) {\r\n    if (layer.status$ === undefined) {\r\n      return;\r\n    }\r\n    layer.ol.on('propertychange', evt => this.setPropertyChange(evt, layer));\r\n    layer.dataSource.ol.on('propertychange', evt => this.setPropertyChange(evt, layer));\r\n\r\n\r\n    this.layers.push(layer);\r\n\r\n    const layer$$ = layer.status$\r\n      .pipe(distinctUntilChanged())\r\n      .subscribe(status => {\r\n        if (status === SubjectStatus.Error) {\r\n          this.loading = 0;\r\n          this.loaded = -1;\r\n        }\r\n        if (status === SubjectStatus.Working) {\r\n          this.loading += 1;\r\n        } else if (status === SubjectStatus.Done) {\r\n          this.loaded += 1;\r\n        }\r\n\r\n        if (this.loaded >= this.loading) {\r\n          this.loading = this.loaded = 0;\r\n          this.status = SubjectStatus.Done;\r\n        } else if (this.loading > 0) {\r\n          this.status = SubjectStatus.Working;\r\n        }\r\n      });\r\n\r\n    this.subscriptions.push(layer$$);\r\n  }\r\n\r\n  unwatchLayer(layer: Layer) {\r\n    layer.ol.un('propertychange', evt => this.setPropertyChange(evt,layer));\r\n    layer.dataSource.ol.un('propertychange', evt => this.setPropertyChange(evt, layer));\r\n    layer.status$.next(SubjectStatus.Done);\r\n    const index = this.layers.indexOf(layer);\r\n    if (index >= 0) {\r\n      const status = (layer as any).watcher.status;\r\n      if (\r\n        [SubjectStatus.Working, SubjectStatus.Waiting].indexOf(status) !== -1\r\n      ) {\r\n        this.loaded += 1;\r\n      }\r\n      this.subscriptions[index].unsubscribe();\r\n      this.subscriptions.splice(index, 1);\r\n      this.layers.splice(index, 1);\r\n      (layer as any).watcher.unwatch();\r\n    }\r\n  }\r\n}\r\n","export enum MapViewAction {\r\n  Move,\r\n  Zoom\r\n}\r\n","import { EventsKey } from 'ol/events';\r\nimport OlMap from 'ol/Map';\r\nimport { unByKey } from 'ol/Observable';\r\n\r\n/**\r\n * Base map controller\r\n */\r\nexport class MapController {\r\n\r\n  /**\r\n   * OL Map\r\n   */\r\n  protected olMap: OlMap;\r\n\r\n  /**\r\n   * Array of observer keys\r\n   */\r\n  protected observerKeys: EventsKey[] = [];\r\n\r\n  /**\r\n   * Return the OL map this controller is bound to\r\n   * @returns OL Map\r\n   */\r\n  getOlMap(): OlMap {\r\n    return this.olMap;\r\n  }\r\n\r\n  /**\r\n   * Add or remove this controller to/from a map.\r\n   * @param map OL Map\r\n   */\r\n  setOlMap(olMap: OlMap | undefined) {\r\n    if (olMap !== undefined && this.getOlMap() !== undefined) {\r\n      throw new Error('This controller is already bound to a map.');\r\n    }\r\n\r\n    if (olMap === undefined) {\r\n      this.teardownObservers();\r\n      this.olMap = olMap;\r\n      return;\r\n    }\r\n\r\n    this.olMap = olMap;\r\n  }\r\n\r\n  /**\r\n   * Teardown any observers\r\n   */\r\n  teardownObservers() {\r\n    this.observerKeys.forEach((key: EventsKey) => unByKey(key));\r\n    this.observerKeys = [];\r\n  }\r\n\r\n}\r\n","import OlMap from 'ol/Map';\r\nimport OlMapEvent from 'ol/MapEvent';\r\n\r\nimport { BehaviorSubject, Subject, Subscription } from 'rxjs';\r\nimport { debounceTime } from 'rxjs/operators';\r\n\r\nimport * as oleasing from 'ol/easing';\r\nimport * as olproj from 'ol/proj';\r\nimport OlProjection from 'ol/proj/Projection';\r\nimport OlView from 'ol/View';\r\n\r\nimport { MapViewAction } from '../map.enums';\r\nimport { MapExtent, MapViewState } from '../map.interface';\r\nimport { getScaleFromResolution, viewStatesAreEqual } from '../map.utils';\r\nimport { MapController } from './controller';\r\nimport { EventsKey } from 'ol/events';\r\nimport { ObjectEvent } from 'ol/Object';\r\n\r\nexport interface MapViewControllerOptions {\r\n  stateHistory: boolean;\r\n}\r\n\r\n/**\r\n * Controller to handle map view interactions\r\n */\r\nexport class MapViewController extends MapController {\r\n  /**\r\n   * Observable of the current rotation in radians\r\n   */\r\n   readonly rotation$ = new BehaviorSubject<number>(0);\r\n\r\n  /**\r\n   * Observable of the current resolution\r\n   */\r\n  resolution$ = new BehaviorSubject<number>(undefined);\r\n\r\n  /**\r\n   * Observable of the current state\r\n   */\r\n  state$ = new BehaviorSubject<MapViewState>(undefined);\r\n\r\n  /**\r\n   * View Padding\r\n   * Values in the array are top, right, bottom and left padding.\r\n   */\r\n  padding = [0, 0, 0, 0];\r\n\r\n  /**\r\n   * Max zoom after set extent\r\n   */\r\n  maxZoomOnExtent = 19;\r\n\r\n  /**\r\n   * Max extent possible when zooming\r\n   */\r\n  maxLayerZoomExtent: MapExtent;\r\n\r\n  /**\r\n   * Extent stream\r\n   */\r\n  private extent$ = new Subject<{ extent: MapExtent; action: MapViewAction }>();\r\n\r\n  /**\r\n   * Subscription to the movement stream\r\n   */\r\n  private extent$$: Subscription;\r\n\r\n  /**\r\n   * History of states\r\n   */\r\n  private states: MapViewState[] = [];\r\n\r\n  /**\r\n   * Current state index\r\n   */\r\n  private stateIndex: number = 0;\r\n\r\n  /**\r\n   * Whether the view controller should keep the view's state history\r\n   */\r\n  get stateHistory(): boolean {\r\n    return this.options ? this.options.stateHistory === true : false;\r\n  }\r\n\r\n  /**\r\n   * OL View\r\n   */\r\n  get olView(): OlView {\r\n    return this.olMap.getView();\r\n  }\r\n\r\n  constructor(private options?: MapViewControllerOptions) {\r\n    super();\r\n  }\r\n\r\n  setPadding(padding: { top?: number, bottom?: number, left?: number, right?: number }) {\r\n    // Values in the array are top, right, bottom and left padding.\r\n    if (padding.top || padding.top === 0) {\r\n      this.padding[0] = padding.top;\r\n    }\r\n    if (padding.right || padding.right === 0) {\r\n      this.padding[1] = padding.right;\r\n    }\r\n    if (padding.bottom || padding.bottom === 0) {\r\n      this.padding[2] = padding.bottom;\r\n    }\r\n    if (padding.left || padding.left === 0) {\r\n      this.padding[3] = padding.left;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add or remove this controller to/from a map.\r\n   * @param map OL Map\r\n   */\r\n  setOlMap(olMap: OlMap | undefined) {\r\n    super.setOlMap(olMap);\r\n    this.setupObservers();\r\n  }\r\n\r\n  /**\r\n   * Observe move moveend and subscribe to the extent stream\r\n   */\r\n  setupObservers() {\r\n    if (this.stateHistory === true) {\r\n      this.observerKeys.push(\r\n        this.olMap.on('moveend', (event: OlMapEvent) => this.onMoveEnd(event)) as EventsKey\r\n      );\r\n    }\r\n\r\n    this.extent$$ = this.extent$\r\n      .pipe(debounceTime(25))\r\n      .subscribe((value: { extent: MapExtent; action: MapViewAction }) => {\r\n        this.setExtent(value.extent, value.action);\r\n      });\r\n  }\r\n\r\n  monitorRotation() {\r\n    this.observerKeys.push(\r\n      this.olMap.getView().on('change:rotation', (evt: ObjectEvent) => {\r\n        this.rotation$.next(evt.target.getRotation());\r\n      }) as EventsKey\r\n      );\r\n  }\r\n\r\n  /**\r\n   * Teardown any observers\r\n   */\r\n  teardownObservers() {\r\n    super.teardownObservers();\r\n    if (this.extent$$ !== undefined) {\r\n      this.extent$$.unsubscribe();\r\n      this.extent$$ = undefined;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get the view's OL projection\r\n   * @returns OL projection\r\n   */\r\n  getOlProjection(): OlProjection {\r\n    return this.olView.getProjection();\r\n  }\r\n\r\n  /**\r\n   * Get the current map view center\r\n   * @param projection Output projection\r\n   * @returns Center\r\n   */\r\n  getCenter(projection?: string | OlProjection): [number, number] {\r\n    let center = this.olView.getCenter() as [number, number];\r\n    if (projection && center) {\r\n      center = olproj.transform(center, this.getOlProjection(), projection) as [number, number];\r\n    }\r\n    return center;\r\n  }\r\n\r\n  /**\r\n   * Get the current view extent\r\n   * @param projection Output projection\r\n   * @returns Extent\r\n   */\r\n  getExtent(projection?: string | OlProjection): MapExtent {\r\n    let extent = this.olView.calculateExtent(this.olMap.getSize());\r\n    if (projection && extent) {\r\n      extent = olproj.transformExtent(\r\n        extent,\r\n        this.getOlProjection(),\r\n        projection\r\n      );\r\n    }\r\n    return extent as [number, number, number, number];\r\n  }\r\n\r\n  /**\r\n   * Get the current scale\r\n   * @param dpi Dot per inches\r\n   * @returns View scale\r\n   */\r\n  getScale(dpi = 96) {\r\n    return getScaleFromResolution(\r\n      this.getResolution(),\r\n      this.getOlProjection().getUnits(),\r\n      dpi\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Get the current resolution\r\n   * @returns Projection denominator\r\n   */\r\n  getResolution(): number {\r\n    return this.olView.getResolution();\r\n  }\r\n\r\n  /**\r\n   * Get the current zoom level\r\n   * @returns Zoom level\r\n   */\r\n  getZoom(): number {\r\n    return Math.round(this.olView.getZoom());\r\n  }\r\n\r\n  /**\r\n   * Zoom in\r\n   */\r\n  zoomIn() {\r\n    this.zoomTo(this.olView.getZoom() + 1);\r\n  }\r\n\r\n  /**\r\n   * Zoom out\r\n   */\r\n  zoomOut() {\r\n    this.zoomTo(this.olView.getZoom() - 1);\r\n  }\r\n\r\n  /**\r\n   * Zoom to specific zoom level\r\n   * @param zoom Zoom level\r\n   */\r\n  zoomTo(zoom: number) {\r\n    this.olView.cancelAnimations();\r\n    this.olView.animate({\r\n      zoom,\r\n      duration: 250,\r\n      easing: oleasing.easeOut\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Move to extent after a short delay (100ms) unless\r\n   * a new movement gets registered in the meantime.\r\n   * @param extent Extent to move to\r\n   */\r\n  moveToExtent(extent: [number, number, number, number]) {\r\n    this.extent$.next({ extent, action: MapViewAction.Move });\r\n  }\r\n\r\n  /**\r\n   * Zoom to extent after a short delay (100ms) unless\r\n   * a new movement gets registered in the meantime.\r\n   * @param extent Extent to zoom to\r\n   */\r\n  zoomToExtent(extent: [number, number, number, number]) {\r\n    this.extent$.next({ extent, action: MapViewAction.Zoom });\r\n  }\r\n\r\n  /**\r\n   * Return the current view rotation\r\n   * @returns Rotation angle in radians\r\n   */\r\n  getRotation(): number {\r\n    return this.olView.getRotation();\r\n  }\r\n\r\n  /**\r\n   * Reset the view rotation to 0\r\n   */\r\n  resetRotation() {\r\n    this.olView.animate({ rotation: 0 });\r\n  }\r\n\r\n  /**\r\n   * Whether the view has a previous state\r\n   * @returns True if the view has a previous state\r\n   */\r\n  hasPreviousState(): boolean {\r\n    return this.states.length > 1 && this.stateIndex > 0;\r\n  }\r\n\r\n  /**\r\n   * Whether the view has a next state\r\n   * @returns True if the view has a next state\r\n   */\r\n  hasNextState(): boolean {\r\n    return this.states.length > 1 && this.stateIndex < this.states.length - 1;\r\n  }\r\n\r\n  /**\r\n   * Restore the previous view state\r\n   */\r\n  previousState() {\r\n    if (this.hasPreviousState()) {\r\n      this.setStateIndex(this.stateIndex - 1);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Restore the next view state\r\n   */\r\n  nextState() {\r\n    if (this.hasNextState()) {\r\n      this.setStateIndex(this.stateIndex + 1);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the state history\r\n   */\r\n  clearStateHistory() {\r\n    this.states = [];\r\n    this.stateIndex = 0;\r\n  }\r\n\r\n  /**\r\n   * Update the the view to it's intial state\r\n   */\r\n  setInitialState() {\r\n    if (this.states.length > 0) {\r\n      this.setStateIndex(0);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Move to the extent retrieved from the stream\r\n   * @param extent Extent\r\n   * @param action Either zoom or move\r\n   * @param animation With or without animation to the target extent.\r\n   */\r\n  private setExtent(\r\n    extent: MapExtent,\r\n    action: MapViewAction,\r\n    animation: boolean = true\r\n  ) {\r\n    const olView = this.olView;\r\n    olView.cancelAnimations();\r\n    const duration = animation ? 500 : 0;\r\n    const zoom = olView.getZoom();\r\n\r\n    const fromCenter = olView.getCenter();\r\n    const toCenter = [\r\n      extent[0] + (extent[2] - extent[0]) / 2,\r\n      extent[1] + (extent[3] - extent[1]) / 2\r\n    ];\r\n    const distCenter = Math.sqrt(\r\n      Math.pow(fromCenter[0] - toCenter[0], 2) +\r\n        Math.pow(fromCenter[1] - toCenter[1], 2)\r\n    );\r\n    const fromExtent = olView.calculateExtent();\r\n    const fromSize = Math.sqrt(\r\n      Math.pow(fromExtent[2] - fromExtent[0], 2) +\r\n        Math.pow(fromExtent[3] - fromExtent[1], 2)\r\n    );\r\n    const toSize = Math.sqrt(\r\n      Math.pow(extent[2] - extent[0], 2) + Math.pow(extent[3] - extent[1], 2)\r\n    );\r\n    const moySize = (toSize + fromSize) / 2;\r\n    const xSize = distCenter / moySize;\r\n\r\n    const maxZoom =\r\n      action === MapViewAction.Move || zoom > this.maxZoomOnExtent\r\n        ? zoom\r\n        : this.maxZoomOnExtent;\r\n\r\n    olView.fit(extent, {\r\n      size: this.olMap.getSize(),\r\n      maxZoom,\r\n      padding: this.padding,\r\n      duration: xSize > 4 ? 0 : duration,\r\n      callback: (isFinished: boolean) => {\r\n        if (!isFinished) {\r\n          olView.fit(extent, {\r\n            size: this.olMap.getSize(),\r\n            maxZoom,\r\n            padding: this.padding,\r\n            duration: xSize > 4 ? 0 : duration\r\n          });\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Set the view state index\r\n   * @param index State index\r\n   */\r\n  private setStateIndex(index: number) {\r\n    this.stateIndex = index;\r\n    this.setState(this.states[index]);\r\n  }\r\n\r\n  /**\r\n   * Set the view state\r\n   * @param state View state\r\n   */\r\n  private setState(state: MapViewState) {\r\n    this.olView.animate({\r\n      resolution: state.resolution,\r\n      center: state.center,\r\n      duration: 0\r\n    });\r\n  }\r\n\r\n  /**\r\n   * On move end, get the view state and record it.\r\n   * @param event Map event\r\n   */\r\n  private onMoveEnd(event: OlMapEvent) {\r\n    const resolution = this.getResolution();\r\n    if (this.resolution$.value !== resolution) {\r\n      this.resolution$.next(resolution);\r\n    }\r\n\r\n    const state = {\r\n      resolution,\r\n      center: this.getCenter(),\r\n      zoom: this.getZoom()\r\n    };\r\n\r\n    if (this.stateHistory === true) {\r\n      const stateIndex = this.stateIndex;\r\n      const stateAtIndex =\r\n        this.states.length === 0 ? undefined : this.states[stateIndex];\r\n      if (!viewStatesAreEqual(state, stateAtIndex)) {\r\n        this.states = this.states.slice(0, stateIndex + 1).concat([state]);\r\n        this.stateIndex = this.states.length - 1;\r\n      }\r\n    }\r\n\r\n    this.state$.next(state);\r\n  }\r\n}\r\n","import OlMap from 'ol/Map';\r\nimport olGeolocation from 'ol/Geolocation';\r\nimport { BehaviorSubject, interval, Subscription } from 'rxjs';\r\n\r\nimport * as olproj from 'ol/proj';\r\nimport olFeature from 'ol/Feature';\r\nimport { MapController } from './controller';\r\nimport { Point, Polygon } from 'ol/geom';\r\nimport { fromCircle } from 'ol/geom/Polygon';\r\nimport OlCircle from 'ol/geom/Circle';\r\nimport { IgoMap } from '../map';\r\nimport * as olstyle from 'ol/style';\r\nimport { Overlay } from '../../../overlay/shared/overlay';\r\nimport { FeatureMotion } from '../../../feature/shared/feature.enums';\r\nimport { StorageService, ConfigService } from '@igo2/core';\r\nimport { MapViewOptions } from '../map.interface';\r\nimport { switchMap } from 'rxjs/operators';\r\nexport interface MapGeolocationControllerOptions {\r\n  //  todo keepPositionHistory?: boolean;\r\n  projection: olproj.ProjectionLike\r\n  accuracyThreshold?: number;\r\n  followPosition?: boolean;\r\n  buffer?: GeolocationBuffer;\r\n}\r\nexport interface MapGeolocationState {\r\n  position: number[];\r\n  projection: string;\r\n  accuracy: number;\r\n  altitude: number;\r\n  altitudeAccuracy: number;\r\n  heading: number;\r\n  speed: number;\r\n  enableHighAccuracy: boolean;\r\n  timestamp: Date;\r\n}\r\nexport interface GeolocationBuffer {\r\n  bufferRadius?: number;\r\n  bufferStroke?: [number, number, number, number];\r\n  bufferFill?: [number, number, number, number];\r\n  showBufferRadius?: boolean;\r\n}\r\n\r\n\r\nenum GeolocationOverlayType {\r\n  Position = 'position',\r\n  Accuracy = 'accuracy',\r\n  Buffer= 'buffer'\r\n}\r\n\r\n/**\r\n * Controller to handle map view interactions\r\n */\r\nexport class MapGeolocationController extends MapController {\r\n\r\n  private subscriptions$$: Subscription[] = [];\r\n  private geolocationOverlay: Overlay;\r\n  private positionFeatureStyle: olstyle.Style | olstyle.Style[] = new olstyle.Style({\r\n    image: new olstyle.Circle({\r\n      radius: 6,\r\n      fill: new olstyle.Fill({\r\n        color: '#3399CC',\r\n      }),\r\n      stroke: new olstyle.Stroke({\r\n        color: '#fff',\r\n        width: 2,\r\n      }),\r\n    }),\r\n  });\r\n  private accuracyFeatureStyle: olstyle.Style | olstyle.Style[] = new olstyle.Style({\r\n    stroke: new olstyle.Stroke({\r\n      color: 'rgba(120, 120, 120, 0.4)',\r\n      width: 1,\r\n    }),\r\n    fill: new olstyle.Fill({\r\n      color: 'rgba(120, 120, 120, 0.4)',\r\n    }),\r\n  });\r\n\r\n  private geolocation: olGeolocation;\r\n\r\n  /**\r\n   * Observable of the current emission interval of the position. In seconds\r\n   */\r\n   public readonly emissionIntervalSeconds$: BehaviorSubject<number> = new BehaviorSubject(5);\r\n\r\n  /**\r\n   * Observable of the current position\r\n   */\r\n  public readonly position$ = new BehaviorSubject<MapGeolocationState>(undefined);\r\n  /**\r\n   * Observable of the tracking state\r\n   */\r\n  public readonly tracking$ = new BehaviorSubject<boolean>(undefined);\r\n  /**\r\n   * Observable of the follow position state\r\n   */\r\n  public readonly followPosition$ = new BehaviorSubject<boolean>(undefined);\r\n\r\n\r\n  /**\r\n   * History of positions\r\n   */\r\n  // private positions: MapGeolocationState[] = [];\r\n\r\n  /**\r\n   * Whether the geolocate controller should keep the position history\r\n   */\r\n  /*\r\n  // todo: refine this method\r\n  set keepPositionHistory(value) {\r\n    this._keepPositionHistory = value;\r\n  }\r\n  get keepPositionHistory(): boolean {\r\n    return this._keepPositionHistory;\r\n  }\r\n  private _keepPositionHistory: boolean = this.options && this.options.keepPositionHistory ? this.options.keepPositionHistory : true;\r\n*/\r\n  /**\r\n   * Whether the geolocate should show a buffer around the current position\r\n   */\r\n   set buffer(value: GeolocationBuffer) {\r\n    this._buffer = value;\r\n    this.handleFeatureCreation(this.position$.value);\r\n  }\r\n   get buffer(): GeolocationBuffer {\r\n    return this._buffer;\r\n  }\r\n  private _buffer: GeolocationBuffer = this.options && this.options.buffer ? this.options.buffer : undefined;\r\n\r\n  /**\r\n   * Whether the geolocate controller accuracy threshold to store/show the position.\r\n   */\r\n  set accuracyThreshold(value: number) {\r\n    this._accuracyThreshold = value;\r\n    this.handleFeatureCreation(this.position$.value);\r\n  }\r\n\r\n  get accuracyThreshold(): number {\r\n    return this._accuracyThreshold;\r\n  }\r\n  private _accuracyThreshold = this.options && this.options.accuracyThreshold ? this.options.accuracyThreshold : 5000;\r\n\r\n\r\n  /**\r\n   * Whether the activate the geolocation.\r\n   */\r\n  get tracking() {\r\n    return this.geolocation.getTracking();\r\n  }\r\n\r\n  set tracking(value: boolean) {\r\n    this.geolocation.setTracking(value || false);\r\n    this.tracking$.next(value);\r\n    if (this.storageService && value !== undefined) {\r\n      this.storageService.set('geolocation.tracking', value);\r\n    }\r\n    if (!value) {\r\n      this.position$.next(undefined);\r\n    }\r\n  }\r\n\r\n    /**\r\n   * Whether the activate the view tracking of the current position\r\n   */\r\n  set followPosition(value: boolean) {\r\n    this._followPosition = value;\r\n    this.followPosition$.next(value);\r\n    if (this.configService?.getConfig('geolocate.followPosition') === false) {\r\n      this._followPosition = false;\r\n      this.followPosition$.next(false);\r\n    }\r\n    this.handleFeatureCreation(this.position$.value);\r\n    if (this.storageService && value !== undefined) {\r\n      this.storageService.set('geolocation.followPosition', value);\r\n    }\r\n  }\r\n\r\n  get followPosition() {\r\n    return this._followPosition;\r\n  }\r\n\r\n\r\n  private _followPosition = this.options && this.options.followPosition ? this.options.followPosition : false;\r\n\r\n\r\n  constructor(\r\n    private map: IgoMap,\r\n    private options?: MapGeolocationControllerOptions,\r\n    private storageService?: StorageService,\r\n    private configService?: ConfigService) {\r\n    super();\r\n    this.geolocationOverlay = new Overlay(this.map);\r\n  }\r\n\r\n  /**\r\n   * Add or remove this controller to/from a map.\r\n   * @param map OL Map\r\n   */\r\n  setOlMap(olMap: OlMap | undefined) {\r\n    super.setOlMap(olMap);\r\n    this.setupObservers();\r\n  }\r\n\r\n  private deleteGeolocationFeatures() {\r\n    this.deleteFeatureByType(GeolocationOverlayType.Position);\r\n    this.deleteFeatureByType(GeolocationOverlayType.Accuracy);\r\n    this.deleteFeatureByType(GeolocationOverlayType.Buffer);\r\n  }\r\n\r\n  setupObservers() {\r\n    this.tracking$.subscribe(tracking => {\r\n      if (tracking) {\r\n        this.onPositionChange(true, true);\r\n      } else {\r\n        this.deleteGeolocationFeatures();\r\n      }\r\n    });\r\n\r\n    this.geolocation = new olGeolocation({\r\n      // enableHighAccuracy must be set to true to have the heading value.\r\n      trackingOptions: {\r\n        enableHighAccuracy: true,\r\n        maximumAge: 10000,\r\n        timeout: 600000\r\n      },\r\n      projection: this.options.projection,\r\n    });\r\n    let tracking = false;\r\n    this.subscriptions$$.push(this.emissionIntervalSeconds$\r\n      .pipe(switchMap(value => interval(value * 1000)))\r\n      .subscribe(() => {\r\n        if (tracking === this.tracking) {\r\n          this.onPositionChange(true);\r\n        } else {\r\n          tracking = this.tracking;\r\n          this.onPositionChange(true, true);\r\n        }\r\n      }));\r\n  }\r\n\r\n  public updateGeolocationOptions(options: MapViewOptions) {\r\n    if (!options) { return;}\r\n    // todo maybe a dedicated interface for geolocation should be defined instead of putting these inside the mapviewoptions?\r\n    let tracking = options.geolocate;\r\n    let followPosition = options.alwaysTracking;\r\n    if (this.storageService) {\r\n      const storedTracking = this.storageService.get('geolocation.tracking') as boolean;\r\n      if (storedTracking !== null && storedTracking !== undefined) {\r\n        tracking = storedTracking;\r\n      }\r\n\r\n      const storedFollowPosition = this.storageService.get('geolocation.followPosition') as boolean;\r\n      if (storedFollowPosition !== null && storedFollowPosition !== undefined) {\r\n        followPosition = storedFollowPosition;\r\n      }\r\n    }\r\n    this.tracking = tracking;\r\n    this.followPosition = followPosition;\r\n    this.buffer = options.buffer;\r\n  }\r\n\r\n  /**\r\n   * Teardown any observers\r\n   */\r\n  teardownObservers() {\r\n    if (this.subscriptions$$.length) {\r\n      this.subscriptions$$.map(s => s.unsubscribe());\r\n    }\r\n    super.teardownObservers();\r\n  }\r\n\r\n  /**\r\n   * Clear the position  history\r\n   */\r\n  /*\r\n  // todo\r\n  clearPositionsHistory() {\r\n    this.positions = [];\r\n  }*/\r\n\r\n  /**\r\n   * On position change, get the position, show it on the map and record it.\r\n   * @param emitEvent Map event\r\n   */\r\n  private onPositionChange(emitEvent: boolean = false, zoomTo: boolean = false) {\r\n    if (!this.tracking) {\r\n      return;\r\n    }\r\n    const geolocateProperties = this.geolocation.getProperties();\r\n\r\n    if (geolocateProperties.accuracy > this.accuracyThreshold) {\r\n      console.warn('Poor geolocation accuracy. No position are stored/shown');\r\n      this.position$.next(undefined);\r\n      return;\r\n    }\r\n\r\n    const position: MapGeolocationState = {\r\n      position: geolocateProperties.position,\r\n      projection: this.geolocation.getProjection().getCode(),\r\n      accuracy: geolocateProperties.accuracy,\r\n      altitude: geolocateProperties.altitude,\r\n      altitudeAccuracy: geolocateProperties.altitudeAccuracy,\r\n      heading: geolocateProperties.heading,\r\n      speed: geolocateProperties.speed,\r\n      enableHighAccuracy: geolocateProperties.trackingOptions?.enableHighAccuracy ? true : false,\r\n      timestamp: new Date()\r\n    };\r\n    this.handleFeatureCreation(position, zoomTo);\r\n    if (emitEvent) {\r\n      this.position$.next(position);\r\n      /*if (this.keepPositionHistory === true) {\r\n        // handle position diff to store only true diff;\r\n        this.positions.push(position);\r\n      }*/\r\n    }\r\n  }\r\n\r\n  private deleteFeatureByType(type: GeolocationOverlayType) {\r\n    const featureById = this.geolocationOverlay.dataSource.ol.getFeatureById(type);\r\n    if (featureById) {\r\n      this.geolocationOverlay.dataSource.ol.removeFeature(featureById);\r\n    }\r\n\r\n  }\r\n\r\n  private handleFeatureCreation(position: MapGeolocationState, zoomTo: boolean = false) {\r\n    if (!position || !position.position) {\r\n      return;\r\n    }\r\n    this.deleteGeolocationFeatures();\r\n    const positionGeometry = new Point(position.position);\r\n    const accuracyGeometry = fromCircle(new OlCircle(position.position, position.accuracy || 0));\r\n\r\n    const positionFeature = new olFeature<Point>({ geometry: positionGeometry });\r\n    const accuracyFeature = new olFeature<Polygon>({ geometry: accuracyGeometry });\r\n\r\n    if (positionGeometry) {\r\n      let motion = this.followPosition ? FeatureMotion.Move : FeatureMotion.None;\r\n      if (zoomTo) {\r\n        motion = FeatureMotion.Zoom;\r\n      }\r\n      positionFeature.setId(GeolocationOverlayType.Position);\r\n      positionFeature.setStyle(this.positionFeatureStyle);\r\n      this.geolocationOverlay.addOlFeature(positionFeature, motion);\r\n      if (accuracyGeometry) {\r\n        accuracyFeature.setId(GeolocationOverlayType.Accuracy);\r\n        accuracyFeature.setStyle(this.accuracyFeatureStyle);\r\n        this.geolocationOverlay.addOlFeature(accuracyFeature, motion);\r\n      }\r\n      if (this.buffer) {\r\n        const bufferFeature = new olFeature(new OlCircle(position.position, this.buffer.bufferRadius));\r\n        const bufferStyle = new olstyle.Style({\r\n          stroke: new olstyle.Stroke({ width: 2, color: this.buffer.bufferStroke }),\r\n          fill: new olstyle.Fill({ color: this.buffer.bufferFill }),\r\n          text: new olstyle.Text({\r\n            textAlign: 'left',\r\n            offsetX: 10,\r\n            offsetY: -10,\r\n            font: '12px Calibri,sans-serif',\r\n            text: this.buffer.showBufferRadius ? `${this.buffer.bufferRadius}m` : '',\r\n            fill: new olstyle.Fill({ color: '#000' }),\r\n            stroke: new olstyle.Stroke({ color: '#fff', width: 3 })\r\n          })\r\n        });\r\n        bufferFeature.setId(GeolocationOverlayType.Buffer);\r\n        bufferFeature.setStyle(bufferStyle);\r\n        this.geolocationOverlay.addOlFeature(bufferFeature, motion);\r\n      }\r\n\r\n    }\r\n\r\n  }\r\n}\r\n","import { ObjectEvent } from \"ol/Object\";\r\nimport { getUid } from \"ol/util\";\r\nimport { WMSDataSource } from \"../../datasource/shared/datasources/wms-datasource\";\r\nimport { OgcFilterableDataSource, OgcFilterableDataSourceOptions } from \"../../filter/shared/ogc-filter.interface\";\r\nimport { TimeFilterableDataSource, TimeFilterableDataSourceOptions } from \"../../filter/shared/time-filter.interface\";\r\nimport { Layer, LinkedProperties } from \"../../layer/shared/layers\";\r\nimport { IgoMap } from \"./map\";\r\nimport olSourceImageWMS from 'ol/source/ImageWMS';\r\nimport { OgcFilterWriter } from '../../filter/shared/ogc-filter';\r\n\r\nexport function getLinkedLayersOptions(layer: Layer) {\r\n    return layer.options.linkedLayers;\r\n}\r\n\r\nexport function getIgoLayerByLinkId(map: IgoMap, id: string) {\r\n    return map.layers.find(l => l.options.linkedLayers?.linkId === id);\r\n}\r\n\r\nexport function layerHasLinkWithProperty(layer: Layer, property: LinkedProperties): boolean {\r\n    let hasLinkWithProperty = false;\r\n    const layerLLOptions = getLinkedLayersOptions(layer);\r\n    if (layerLLOptions?.links) {\r\n        const link = layerLLOptions.links.find(l => l.properties.includes(property));\r\n        hasLinkWithProperty = link ? true : false;\r\n    }\r\n    return hasLinkWithProperty;\r\n}\r\n\r\nexport function layerHasLinkDeletion(layer: Layer): boolean {\r\n  let hasLinkWithSyncedDelete = false;\r\n  const layerLLOptions = getLinkedLayersOptions(layer);\r\n  if (layerLLOptions?.links) {\r\n      const link = layerLLOptions.links.find(l => l.syncedDelete);\r\n      hasLinkWithSyncedDelete = link ? true : false;\r\n  }\r\n  return hasLinkWithSyncedDelete;\r\n}\r\n\r\nexport function getRootParentByProperty(map: IgoMap, layer: Layer, property: LinkedProperties): Layer {\r\n    let layerToUse = layer;\r\n    let parentLayer = layerToUse;\r\n    let hasParentLayer = true;\r\n    while (hasParentLayer) {\r\n        layerToUse = parentLayer;\r\n        parentLayer = getDirectParentLayerByProperty(map, layerToUse, property);\r\n        hasParentLayer = parentLayer ? true : false;\r\n    }\r\n    if (!hasParentLayer) {\r\n        if (!layerHasLinkWithProperty(layerToUse,property)) {\r\n            layerToUse = undefined;\r\n        }\r\n    }\r\n    return hasParentLayer ? parentLayer : layerToUse;\r\n}\r\n\r\nexport function getDirectParentLayerByProperty(map: IgoMap, layer: Layer, property: LinkedProperties): Layer {\r\n    if (layer?.options.linkedLayers?.linkId) {\r\n        const currentLinkId = layer.options.linkedLayers.linkId;\r\n        let parents = map.layers.filter(pl => {\r\n            const linkedLayers = pl.options.linkedLayers;\r\n            if (linkedLayers && linkedLayers.links) {\r\n                const a = linkedLayers.links.find(l => l.linkedIds.includes(currentLinkId) && l.properties.includes(property));\r\n                return a;\r\n            }\r\n        });\r\n        if (parents.length > 1) {\r\n            console.warn(`Your layer ${layer.title || layer.id} must only have 1 parent (${parents.map(p => p.title || p.id)})\r\n            , The first parent (${parents[0].title || parents[0].id}) will be use to sync properties`);\r\n        }\r\n        return parents[0];\r\n    }\r\n}\r\n\r\nexport function getDirectChildLayersByProperty(map: IgoMap, layer: Layer, property: LinkedProperties): Layer[] {\r\n    let linkedIds = [];\r\n    if (layer?.options.linkedLayers?.links) {\r\n        layer.options.linkedLayers.links\r\n        .filter(l => l.properties.includes(property))\r\n        .map(link => {\r\n            linkedIds = linkedIds.concat(link.linkedIds);});\r\n    }\r\n    return linkedIds.map(lid => getIgoLayerByLinkId(map, lid));\r\n}\r\n\r\nexport function getAllChildLayersByProperty(map: IgoMap, layer: Layer, knownChildLayers: Layer[], property: LinkedProperties): Layer[] {\r\n    let childLayers = getDirectChildLayersByProperty(map, layer,property);\r\n    childLayers.map(cl => {\r\n        knownChildLayers.push(cl);\r\n        const directChildLayers = getDirectChildLayersByProperty(map, cl, property);\r\n        if (directChildLayers) {\r\n            getAllChildLayersByProperty(map, cl, knownChildLayers, property);\r\n        }\r\n\r\n    });\r\n    return knownChildLayers;\r\n}\r\n\r\nexport function getRootParentByDeletion(map: IgoMap, layer: Layer): Layer {\r\n  let layerToUse = layer;\r\n  let parentLayer = layerToUse;\r\n  let hasParentLayer = true;\r\n  while (hasParentLayer) {\r\n      layerToUse = parentLayer;\r\n      parentLayer = getDirectParentLayerByDeletion(map, layerToUse);\r\n      hasParentLayer = parentLayer ? true : false;\r\n  }\r\n  if (!hasParentLayer) {\r\n    if (!layerHasLinkDeletion(layerToUse)) {\r\n      layerToUse = undefined;\r\n    }\r\n  }\r\n  return hasParentLayer ? parentLayer : layerToUse;\r\n}\r\n\r\nexport function getDirectParentLayerByDeletion(map: IgoMap, layer: Layer): Layer {\r\n  if (layer.options.linkedLayers?.linkId) {\r\n      const currentLinkId = layer.options.linkedLayers.linkId;\r\n      let parents = map.layers.filter(pl => {\r\n          const linkedLayers = pl.options.linkedLayers;\r\n          if (linkedLayers && linkedLayers.links) {\r\n              const a = linkedLayers.links.find(l => (l.linkedIds.includes(currentLinkId) && l.syncedDelete));\r\n              return a;\r\n          }\r\n      });\r\n      if (parents.length > 1) {\r\n          console.warn(`Your layer ${layer.title || layer.id} must only have 1 parent (${parents.map(p => p.title || p.id)})\r\n          , The first parent (${parents[0].title || parents[0].id}) will be use to sync properties`);\r\n      }\r\n      return parents[0];\r\n  }\r\n}\r\n\r\nexport function getDirectChildLayersByDeletion(map: IgoMap, layer: Layer): Layer[] {\r\n  let linkedIds = [];\r\n  if (layer?.options.linkedLayers?.links) {\r\n      layer.options.linkedLayers.links\r\n      .filter(l => l.syncedDelete)\r\n      .map(link => {\r\n          linkedIds = linkedIds.concat(link.linkedIds);});\r\n  }\r\n  return linkedIds.map(lid => getIgoLayerByLinkId(map, lid));\r\n}\r\n\r\nexport function getAllChildLayersByDeletion(map: IgoMap, layer: Layer, knownChildLayers: Layer[]): Layer[] {\r\n  let childLayers = getDirectChildLayersByDeletion(map, layer);\r\n  childLayers.map(cl => {\r\n      knownChildLayers.push(cl);\r\n      const directChildLayers = getDirectChildLayersByDeletion(map, cl);\r\n      if (directChildLayers) {\r\n        getAllChildLayersByDeletion(map, cl, knownChildLayers);\r\n      }\r\n\r\n  });\r\n  return knownChildLayers;\r\n}\r\n\r\nexport function initLayerSyncFromRootParentLayers(map: IgoMap, layers: Layer[]) {\r\n    const rootLayersByProperty = {};\r\n    const keys = Object.keys(LinkedProperties);\r\n    keys.map(k => {\r\n      rootLayersByProperty[LinkedProperties[k]] = [];\r\n    });\r\n    layers\r\n      .filter(l => getLinkedLayersOptions(l))\r\n      .map(l => {\r\n        keys.map(key => {\r\n          const k = LinkedProperties[key];\r\n          const plbp = getRootParentByProperty(map, l, k as LinkedProperties);\r\n          const layers = rootLayersByProperty[k];\r\n          const layersId = layers.map(l => l.id);\r\n          if (plbp && !layersId.includes(plbp.id)) {\r\n            rootLayersByProperty[k].push(plbp);\r\n          }\r\n        });\r\n      });\r\n    Object.keys(rootLayersByProperty).map(k => {\r\n      const layers = rootLayersByProperty[k];\r\n      layers.map((l: Layer) => l.ol.notify(k, undefined));\r\n    });\r\n  }\r\n\r\n  export function handleLayerPropertyChange(map: IgoMap, propertyChange: ObjectEvent, initiatorIgoLayer: Layer) {\r\n    if (!propertyChange) {\r\n      return;\r\n    }\r\n    const ogcFilterWriter = new OgcFilterWriter();\r\n    let isLayerProperty = true;\r\n    let isDatasourceProperty = true;\r\n    const key = propertyChange.key;\r\n    let newValue;\r\n    if (key === 'ogcFilters') {\r\n      isLayerProperty = false;\r\n      isDatasourceProperty = true;\r\n      newValue = (initiatorIgoLayer.dataSource.options as OgcFilterableDataSourceOptions).ogcFilters;\r\n    } else if (key === 'timeFilter') {\r\n      isLayerProperty = false;\r\n      isDatasourceProperty = true;\r\n      newValue = (initiatorIgoLayer.dataSource.options as TimeFilterableDataSourceOptions).timeFilter;\r\n    } else {\r\n      isLayerProperty = true;\r\n      isDatasourceProperty = false;\r\n      newValue = initiatorIgoLayer.ol.get(key);\r\n    }\r\n\r\n    const initiatorLinkedLayersOptions = getLinkedLayersOptions(initiatorIgoLayer);\r\n    if (initiatorLinkedLayersOptions) {\r\n      let rootParentByProperty = getRootParentByProperty(map,initiatorIgoLayer, key as LinkedProperties);\r\n      if (!rootParentByProperty) {\r\n        rootParentByProperty = initiatorIgoLayer;\r\n      }\r\n\r\n      const clbp = [rootParentByProperty];\r\n      getAllChildLayersByProperty(map, rootParentByProperty, clbp, key as LinkedProperties);\r\n\r\n      let resolutionPropertyHasChanged = false;\r\n      const initiatorIgoLayerSourceType = initiatorIgoLayer.options.source.options.type;\r\n      const initiatorIgoLayerOgcFilterableDataSourceOptions = initiatorIgoLayer.dataSource.options as OgcFilterableDataSourceOptions;\r\n      clbp.map(l => {\r\n        if (initiatorIgoLayer && l && getUid(initiatorIgoLayer.ol) !== getUid(l?.ol)) {\r\n          const lLayerType = l.options.source.options.type;\r\n          if (isLayerProperty) {\r\n          l.ol.set(key, newValue, true);\r\n          if (key === 'visible') {\r\n            l.visible$.next(newValue);\r\n          }\r\n          if (key === 'minResolution' || key === 'maxResolution') {\r\n            resolutionPropertyHasChanged = true;\r\n          }\r\n          } else if (isDatasourceProperty) {\r\n            if (key === 'ogcFilters') {\r\n              (l.dataSource as OgcFilterableDataSource).setOgcFilters(newValue, false);\r\n              if (lLayerType === 'wfs') {\r\n                l.ol.getSource().refresh();\r\n              }\r\n              if (lLayerType === 'wms') {\r\n                let appliedOgcFilter;\r\n                if (initiatorIgoLayerSourceType === 'wfs') {\r\n                  appliedOgcFilter = ogcFilterWriter.handleOgcFiltersAppliedValue(\r\n                    initiatorIgoLayerOgcFilterableDataSourceOptions,\r\n                    (initiatorIgoLayer.dataSource.options as any).fieldNameGeometry,\r\n                    undefined,\r\n                    map.viewController.getOlProjection()\r\n                  );\r\n                } else if (initiatorIgoLayerSourceType === 'wms') {\r\n                  appliedOgcFilter = (initiatorIgoLayer.dataSource as WMSDataSource).ol.getParams().FILTER;\r\n                }\r\n                (l.dataSource as WMSDataSource).ol.updateParams({ FILTER: appliedOgcFilter });\r\n              }\r\n            } else if (l.dataSource instanceof WMSDataSource && key === 'timeFilter') {\r\n              (l.dataSource as TimeFilterableDataSource).setTimeFilter(newValue, false);\r\n              const appliedTimeFilter = (initiatorIgoLayer.ol.getSource() as olSourceImageWMS).getParams().TIME;\r\n              l.dataSource.ol.updateParams({ TIME: appliedTimeFilter });\r\n            }\r\n          }\r\n        }\r\n      });\r\n      if (resolutionPropertyHasChanged) {\r\n        map.viewController.resolution$.next(map.viewController.resolution$.value);\r\n      }\r\n\r\n\r\n    }\r\n  }\r\n","import olMap from 'ol/Map';\r\nimport olView from 'ol/View';\r\nimport olControlAttribution from 'ol/control/Attribution';\r\nimport olControlScaleLine from 'ol/control/ScaleLine';\r\nimport * as olproj from 'ol/proj';\r\nimport * as olproj4 from 'ol/proj/proj4';\r\nimport OlProjection from 'ol/proj/Projection';\r\nimport * as olinteraction from 'ol/interaction';\r\nimport {getUid} from 'ol/util';\r\nimport olLayer from 'ol/layer/Layer';\r\nimport olSource from 'ol/source/Source';\r\n\r\nimport proj4 from 'proj4';\r\nimport { BehaviorSubject, skipWhile, Subject } from 'rxjs';\r\n\r\nimport { SubjectStatus } from '@igo2/utils';\r\n\r\nimport { Layer } from '../../layer/shared/layers';\r\nimport { Overlay } from '../../overlay/shared/overlay';\r\n\r\nimport { LayerWatcher } from '../utils/layer-watcher';\r\nimport {\r\n  MapViewOptions,\r\n  MapOptions,\r\n  MapAttributionOptions,\r\n  MapScaleLineOptions,\r\n  MapExtent,\r\n  MapControlsOptions\r\n} from './map.interface';\r\nimport { MapViewController } from './controllers/view';\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { MapGeolocationController } from './controllers/geolocation';\r\nimport { StorageService, ConfigService } from '@igo2/core';\r\nimport { ObjectEvent } from 'ol/Object';\r\nimport {\r\n  getAllChildLayersByDeletion,\r\n  getRootParentByDeletion,\r\n  handleLayerPropertyChange,\r\n  initLayerSyncFromRootParentLayers\r\n} from './linkedLayers.utils';\r\n\r\n// TODO: This class is messy. Clearly define it's scope and the map browser's.\r\n// Move some stuff into controllers.\r\nexport class IgoMap {\r\n  public ol: olMap;\r\n  public offlineButtonToggle$ = new BehaviorSubject<boolean>(false);\r\n  public layers$ = new BehaviorSubject<Layer[]>([]);\r\n  public status$: Subject<SubjectStatus>;\r\n  public propertyChange$: Subject<{event:ObjectEvent, layer: Layer}>;\r\n  public overlay: Overlay;\r\n  public queryResultsOverlay: Overlay;\r\n  public searchResultsOverlay: Overlay;\r\n  public viewController: MapViewController;\r\n  public geolocationController: MapGeolocationController;\r\n  public swipeEnabled$ = new BehaviorSubject<boolean>(false);\r\n  public mapCenter$ = new BehaviorSubject<boolean>(false);\r\n  public selectedFeatures$ = new BehaviorSubject<Layer[]>(null);\r\n\r\n  public bufferDataSource: FeatureDataSource;\r\n\r\n  private layerWatcher: LayerWatcher;\r\n  private options: MapOptions;\r\n  private mapViewOptions: MapViewOptions;\r\n  private defaultOptions: Partial<MapOptions> = {\r\n    controls: { attribution: false }\r\n  };\r\n\r\n  get layers(): Layer[] {\r\n    return this.layers$.value;\r\n  }\r\n\r\n  get projection(): string {\r\n    return this.viewController.getOlProjection().getCode();\r\n  }\r\n\r\n  constructor(\r\n    options?: MapOptions,\r\n    private storageService?: StorageService,\r\n    private configService?: ConfigService) {\r\n    this.options = Object.assign({}, this.defaultOptions, options);\r\n    this.layerWatcher = new LayerWatcher();\r\n    this.status$ = this.layerWatcher.status$;\r\n    this.propertyChange$ = this.layerWatcher.propertyChange$;\r\n    olproj4.register(proj4);\r\n    this.init();\r\n  }\r\n\r\n  init() {\r\n    const controls = [];\r\n    if (this.options.controls) {\r\n      if (this.options.controls.attribution) {\r\n        const attributionOpt = (this.options.controls.attribution === true\r\n          ? {}\r\n          : this.options.controls.attribution) as MapAttributionOptions;\r\n        controls.push(new olControlAttribution(attributionOpt));\r\n      }\r\n      if (this.options.controls.scaleLine) {\r\n        const scaleLineOpt = (this.options.controls.scaleLine === true\r\n          ? {}\r\n          : this.options.controls.scaleLine) as MapScaleLineOptions;\r\n        controls.push(new olControlScaleLine(scaleLineOpt));\r\n      }\r\n    }\r\n    let interactions = {};\r\n    if (this.options.interactions === false) {\r\n      interactions = {\r\n        altShiftDragRotate: false,\r\n        doubleClickZoom: false,\r\n        keyboard: false,\r\n        mouseWheelZoom: false,\r\n        shiftDragZoom: false,\r\n        dragPan: false,\r\n        pinchRotate: false,\r\n        pinchZoom: false\r\n      };\r\n    }\r\n\r\n    this.ol = new olMap({\r\n      interactions: olinteraction.defaults(interactions),\r\n      controls\r\n    });\r\n\r\n    this.setView(this.options.view || {});\r\n    this.viewController = new MapViewController({\r\n      stateHistory: true\r\n    });\r\n    this.viewController.setOlMap(this.ol);\r\n    this.overlay = new Overlay(this);\r\n    this.queryResultsOverlay = new Overlay(this);\r\n    this.searchResultsOverlay = new Overlay(this);\r\n    this.ol.once('rendercomplete', () => {\r\n      this.geolocationController = new MapGeolocationController(\r\n        this,\r\n        {\r\n          projection: this.viewController.getOlProjection()\r\n        },\r\n        this.storageService,\r\n        this.configService);\r\n      this.geolocationController.setOlMap(this.ol);\r\n      if (this.geolocationController) {\r\n        this.geolocationController.updateGeolocationOptions(this.mapViewOptions);\r\n      }\r\n      this.layers$.subscribe((layers) => {\r\n        for (const layer of layers) {\r\n          if (layer.options.linkedLayers) {\r\n            layer.ol.once('postrender', () => {\r\n              initLayerSyncFromRootParentLayers(this, this.layers);\r\n            });\r\n          }\r\n        }\r\n      });\r\n      this.viewController.monitorRotation();\r\n  });\r\n  this.propertyChange$.pipe(skipWhile((pc) => !pc)).subscribe(p => handleLayerPropertyChange(this, p.event, p.layer));\r\n  }\r\n\r\n\r\n  setTarget(id: string) {\r\n    this.ol.setTarget(id);\r\n    if (id !== undefined) {\r\n      this.layerWatcher.subscribe(() => { }, null);\r\n    } else {\r\n      this.layerWatcher.unsubscribe();\r\n    }\r\n  }\r\n\r\n  updateView(options: MapViewOptions) {\r\n    const currentView = this.ol.getView();\r\n    const viewOptions = Object.assign(\r\n      {\r\n        zoom: currentView.getZoom()\r\n      },\r\n      currentView.getProperties()\r\n    );\r\n\r\n    this.setView(Object.assign(viewOptions, options));\r\n    if (options.maxZoomOnExtent) {\r\n      this.viewController.maxZoomOnExtent = options.maxZoomOnExtent;\r\n    }\r\n    this.mapViewOptions = options;\r\n  }\r\n\r\n  /**\r\n   * Set the map view\r\n   * @param options Map view options\r\n   */\r\n  setView(options: MapViewOptions) {\r\n    if (this.viewController !== undefined) {\r\n      this.viewController.clearStateHistory();\r\n    }\r\n\r\n    options = Object.assign({ constrainResolution: true }, options);\r\n    const view = new olView(options);\r\n    this.ol.setView(view);\r\n\r\n    if (options) {\r\n      if (options.maxLayerZoomExtent) {\r\n        this.viewController.maxLayerZoomExtent = options.maxLayerZoomExtent;\r\n      }\r\n\r\n      if (options.center) {\r\n        const projection = view.getProjection().getCode();\r\n        const center = olproj.fromLonLat(options.center, projection);\r\n        view.setCenter(center);\r\n      }\r\n    }\r\n  }\r\n\r\n  updateControls(value: MapControlsOptions) {\r\n    if (value === undefined) {\r\n      return;\r\n    }\r\n\r\n    const controls = [];\r\n    if (value.attribution) {\r\n      const attributionOpt = (value.attribution === true\r\n        ? {}\r\n        : value.attribution) as MapAttributionOptions;\r\n      controls.push(new olControlAttribution(attributionOpt));\r\n    }\r\n    if (value.scaleLine) {\r\n      const scaleLineOpt = (value.scaleLine === true\r\n        ? {}\r\n        : value.scaleLine) as MapScaleLineOptions;\r\n      controls.push(new olControlScaleLine(scaleLineOpt));\r\n    }\r\n\r\n    const currentControls = Object.assign([], this.ol.getControls().getArray());\r\n    currentControls.forEach(control => {\r\n      this.ol.removeControl(control);\r\n    });\r\n    controls.forEach(control => {\r\n      this.ol.addControl(control);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Deprecated\r\n   * TODO: Move to ViewController and update every place it's used\r\n   */\r\n  getCenter(projection?: string | OlProjection): [number, number] {\r\n    return this.viewController.getCenter(projection);\r\n  }\r\n\r\n  /**\r\n   * Deprecated\r\n   * TODO: Move to ViewController and update every place it's used\r\n   */\r\n  getExtent(projection?: string | OlProjection): MapExtent {\r\n    return this.viewController.getExtent(projection);\r\n  }\r\n\r\n  // TODO: Move to ViewController and update every place it's used\r\n  getZoom(): number {\r\n    return this.viewController.getZoom();\r\n  }\r\n\r\n  changeBaseLayer(baseLayer: Layer) {\r\n    if (!baseLayer) {\r\n      return;\r\n    }\r\n\r\n    for (const bl of this.getBaseLayers()) {\r\n      bl.visible = false;\r\n    }\r\n\r\n    baseLayer.visible = true;\r\n\r\n    this.viewController.olView.setMinZoom(\r\n      baseLayer.dataSource.options.minZoom || (this.options.view || {}).minZoom\r\n    );\r\n    this.viewController.olView.setMaxZoom(\r\n      baseLayer.dataSource.options.maxZoom || (this.options.view || {}).maxZoom\r\n    );\r\n  }\r\n\r\n  getBaseLayers(): Layer[] {\r\n    return this.layers.filter((layer: Layer) => layer.baseLayer === true);\r\n  }\r\n\r\n  getLayerById(id: string): Layer {\r\n    return this.layers.find((layer: Layer) => layer.id && layer.id === id);\r\n  }\r\n\r\n  getLayerByAlias(alias: string): Layer {\r\n    return this.layers.find(\r\n      (layer: Layer) => layer.alias && layer.alias === alias\r\n    );\r\n  }\r\n\r\n  getLayerByOlUId(olUId: string): Layer {\r\n    return this.layers.find(\r\n      (layer: Layer) => getUid(layer.ol) && getUid(layer.ol) === olUId\r\n    );\r\n  }\r\n\r\n  getLayerByOlLayer(olLayer: olLayer<olSource>): Layer {\r\n    const olUId = getUid(olLayer);\r\n    return this.getLayerByOlUId(olUId);\r\n  }\r\n\r\n  /**\r\n   * Add a single layer\r\n   * @param layer Layer to add\r\n   * @param push DEPRECATED\r\n   */\r\n  addLayer(layer: Layer, push = true) {\r\n    this.addLayers([layer]);\r\n  }\r\n\r\n  /**\r\n   * Add many layers\r\n   * @param layers Layers to add\r\n   * @param push DEPRECATED\r\n   */\r\n  addLayers(layers: Layer[], push = true) {\r\n    let offsetZIndex = 0;\r\n    let offsetBaseLayerZIndex = 0;\r\n    const addedLayers = layers\r\n      .map((layer: Layer) => {\r\n        if (!layer) { return; }\r\n        const offset = layer.zIndex\r\n          ? 0\r\n          : layer.baseLayer\r\n            ? offsetBaseLayerZIndex++\r\n            : offsetZIndex++;\r\n        return this.doAddLayer(layer, offset);\r\n      })\r\n      .filter((layer: Layer | undefined) => layer !== undefined);\r\n    this.setLayers([].concat(this.layers, addedLayers));\r\n  }\r\n\r\n  /**\r\n   * Remove a single layer\r\n   * @param layer Layer to remove\r\n   */\r\n  removeLayer(layer: Layer) {\r\n    this.removeLayers([layer]);\r\n  }\r\n\r\n  /**\r\n   * Remove many layers\r\n   * @param layers Layers to remove\r\n   */\r\n  removeLayers(layers: Layer[]) {\r\n    const newLayers = this.layers$.value.slice(0);\r\n    const layersToRemove = [];\r\n    layers.forEach((layer: Layer) => {\r\n      const index = newLayers.indexOf(layer);\r\n      if (index >= 0) {\r\n        layersToRemove.push(layer);\r\n        newLayers.splice(index, 1);\r\n        this.handleLinkedLayersDeletion(layer, layersToRemove);\r\n        layersToRemove.map(linkedLayer => {\r\n          const linkedIndex = newLayers.indexOf(linkedLayer);\r\n          if (linkedIndex >= 0) {\r\n            newLayers.splice(linkedIndex, 1);\r\n          }\r\n        });\r\n      }\r\n    });\r\n\r\n    layersToRemove.forEach((layer: Layer) => this.doRemoveLayer(layer));\r\n    this.setLayers(newLayers);\r\n  }\r\n\r\n  /**\r\n   * Build a list of linked layers to delete\r\n   * @param srcLayer Layer that has triggered the deletion\r\n   * @param layersToRemove list to append the layer to delete into\r\n   */\r\n  handleLinkedLayersDeletion(srcLayer: Layer, layersToRemove: Layer[]) {\r\n    let rootParentByDeletion = getRootParentByDeletion(this, srcLayer);\r\n    if (!rootParentByDeletion) {\r\n      rootParentByDeletion = srcLayer;\r\n    }\r\n    const clbd = getAllChildLayersByDeletion(this, rootParentByDeletion, [rootParentByDeletion]);\r\n    for (const layer of clbd) {\r\n      layersToRemove.push(layer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove all layers\r\n   */\r\n  removeAllLayers() {\r\n    this.layers.forEach((layer: Layer) => this.doRemoveLayer(layer));\r\n    this.layers$.next([]);\r\n  }\r\n\r\n  raiseLayer(layer: Layer) {\r\n    const index = this.getLayerIndex(layer);\r\n    if (index > 1) {\r\n      this.moveLayer(layer, index, index - 1);\r\n    }\r\n  }\r\n\r\n  raiseLayers(layers: Layer[]) {\r\n    for (const layer of layers) {\r\n      this.raiseLayer(layer);\r\n    }\r\n  }\r\n\r\n  lowerLayer(layer: Layer) {\r\n    const index = this.getLayerIndex(layer);\r\n    if (index < this.layers.length - 1) {\r\n      this.moveLayer(layer, index, index + 1);\r\n    }\r\n  }\r\n\r\n  lowerLayers(layers: Layer[]) {\r\n    const reverseLayers = layers.reverse();\r\n    for (const layer of reverseLayers) {\r\n      this.lowerLayer(layer);\r\n    }\r\n  }\r\n\r\n  moveLayer(layer: Layer, from: number, to: number) {\r\n    const layerTo = this.layers[to];\r\n    const zIndexTo = layerTo.zIndex;\r\n    const zIndexFrom = layer.zIndex;\r\n\r\n    if (layerTo.baseLayer || layer.baseLayer) {\r\n      return;\r\n    }\r\n\r\n    layer.zIndex = zIndexTo;\r\n    layerTo.zIndex = zIndexFrom;\r\n\r\n    this.layers[to] = layer;\r\n    this.layers[from] = layerTo;\r\n    this.layers$.next(this.layers.slice(0));\r\n  }\r\n\r\n  /**\r\n   * Add a layer to the OL map and start watching. If the layer is already\r\n   * added to this map, make it visible but don't add it one again.\r\n   * @param layer Layer\r\n   * @returns The layer added, if any\r\n   */\r\n  private doAddLayer(layer: Layer, offsetZIndex: number) {\r\n    if (layer.baseLayer && layer.visible) {\r\n      this.changeBaseLayer(layer);\r\n    }\r\n\r\n    const existingLayer = this.getLayerById(layer.id);\r\n    if (existingLayer !== undefined) {\r\n      existingLayer.visible = true;\r\n      return;\r\n    }\r\n\r\n    if (!layer.baseLayer && layer.zIndex) {\r\n      layer.zIndex += 10;\r\n    }\r\n\r\n    if (layer.zIndex === undefined || layer.zIndex === 0) {\r\n      const maxZIndex = Math.max(\r\n        layer.baseLayer ? 0 : 10,\r\n        ...this.layers\r\n          .filter(\r\n            (l) => l.baseLayer === layer.baseLayer && l.zIndex < 200 // zIndex > 200 = system layer\r\n          )\r\n          .map((l) => l.zIndex)\r\n      );\r\n      layer.zIndex = maxZIndex + 1 + offsetZIndex;\r\n    }\r\n\r\n    if (layer.baseLayer && layer.zIndex > 9) {\r\n      layer.zIndex = 10; // baselayer must have zIndex < 10\r\n    }\r\n\r\n    layer.setMap(this);\r\n    this.layerWatcher.watchLayer(layer);\r\n    this.ol.addLayer(layer.ol);\r\n\r\n    return layer;\r\n  }\r\n\r\n  /**\r\n   * Remove a layer from the OL map and stop watching\r\n   * @param layer Layer\r\n   */\r\n  private doRemoveLayer(layer: Layer) {\r\n    this.layerWatcher.unwatchLayer(layer);\r\n    this.ol.removeLayer(layer.ol);\r\n    layer.setMap(undefined);\r\n  }\r\n\r\n  /**\r\n   * Update the layers observable\r\n   * @param layers Layers\r\n   */\r\n  private setLayers(layers: Layer[]) {\r\n    this.layers$.next(this.sortLayersByZIndex(layers).slice(0));\r\n  }\r\n\r\n  /**\r\n   * Sort layers by descending zIndex\r\n   * @param layers Array of layers\r\n   * @returns The original array, sorted by zIndex\r\n   */\r\n  private sortLayersByZIndex(layers: Layer[]) {\r\n    // Sort by descending zIndex\r\n    return layers.sort(\r\n      (layer1: Layer, layer2: Layer) => layer2.zIndex - layer1.zIndex\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Get layer index in the map's inenr array of layers\r\n   * @param layer Layer\r\n   * @returns The layer index\r\n   */\r\n  private getLayerIndex(layer: Layer) {\r\n    return this.layers.findIndex((_layer: Layer) => _layer === layer);\r\n  }\r\n\r\n  onOfflineToggle(offline: boolean) {\r\n    this.offlineButtonToggle$.next(offline);\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  AfterViewInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\nimport { Subscription } from 'rxjs';\r\n\r\nimport { SubjectStatus } from '@igo2/utils';\r\nimport { ActivityService } from '@igo2/core';\r\n\r\nimport { IgoMap } from '../shared/map';\r\nimport { MapControlsOptions, MapViewOptions } from '../shared/map.interface';\r\n\r\n@Component({\r\n  selector: 'igo-map-browser',\r\n  templateUrl: './map-browser.component.html',\r\n  styleUrls: ['./map-browser.component.scss']\r\n})\r\nexport class MapBrowserComponent implements OnInit, AfterViewInit, OnDestroy {\r\n  private activityId: string;\r\n  private status$$: Subscription;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input()\r\n  get view(): MapViewOptions {\r\n    return this._view;\r\n  }\r\n  set view(value: MapViewOptions) {\r\n    this._view = value;\r\n    if (this.map !== undefined) {\r\n      this.map.updateView(value);\r\n    }\r\n  }\r\n  private _view: MapViewOptions;\r\n\r\n  get controls(): MapControlsOptions {\r\n    return this._controls;\r\n  }\r\n\r\n  set controls(value: MapControlsOptions) {\r\n    this._controls = value;\r\n    if (this.map !== undefined) {\r\n      this.map.updateControls(value);\r\n    }\r\n  }\r\n  private _controls: MapControlsOptions;\r\n\r\n  public id = `igo-map-target-${new Date().getTime()}`;\r\n\r\n  constructor(private activityService: ActivityService) {}\r\n\r\n  ngOnInit() {\r\n    this.status$$ = this.map.status$.subscribe(status =>\r\n      this.handleStatusChange(status)\r\n    );\r\n  }\r\n\r\n  ngAfterViewInit() {\r\n    this.map.setTarget(this.id);\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.map.setTarget(undefined);\r\n    this.activityService.unregister(this.activityId);\r\n    this.status$$.unsubscribe();\r\n  }\r\n\r\n  private handleStatusChange(status: SubjectStatus) {\r\n    if (status === SubjectStatus.Working && this.activityId === undefined) {\r\n      this.activityId = this.activityService.register();\r\n    } else if (status === SubjectStatus.Done && this.activityId !== undefined) {\r\n      this.activityService.unregister(this.activityId);\r\n      this.activityId = undefined;\r\n    }\r\n  }\r\n}\r\n","<div [id]=\"id\" class=\"igo-map-browser-target\"></div>\r\n<ng-content></ng-content>\r\n","import {\r\n  Directive,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  OnDestroy,\r\n  Self,\r\n  OnInit\r\n} from '@angular/core';\r\n\r\nimport MapBrowserPointerEvent from 'ol/MapBrowserEvent';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { MapBrowserComponent } from '../../map/map-browser/map-browser.component';\r\n\r\nimport { transform } from 'ol/proj';\r\nimport { MediaService } from '@igo2/core';\r\nimport { unByKey } from 'ol/Observable';\r\n/**\r\n * This directive return the pointer coordinate (on click or pointermove)\r\n * in [longitude, latitude], delayed by in input (pointerMoveDelay)\r\n * to avoid too many emitted values.\r\n */\r\n@Directive({\r\n  selector: '[igoPointerPosition]'\r\n})\r\nexport class PointerPositionDirective implements OnInit, OnDestroy {\r\n\r\n  private lastTimeoutRequest;\r\n\r\n  /**\r\n   * Listener to the pointer move event\r\n   */\r\n  private pointerMoveListener;\r\n\r\n  /**\r\n   * Listener to the map click event\r\n   */\r\n  private mapClickListener;\r\n\r\n  /**\r\n   * Delay before emitting an event\r\n   */\r\n  @Input() pointerPositionDelay: number = 1000;\r\n\r\n  /**\r\n   * Event emitted when the pointer move, delayed by pointerMoveDelay\r\n   */\r\n  @Output() pointerPositionCoord = new EventEmitter<[number, number]>();\r\n\r\n  /**\r\n   * IGO map\r\n   * @internal\r\n   */\r\n  get map(): IgoMap {\r\n    return this.component.map;\r\n  }\r\n\r\n  get mapProjection(): string {\r\n    return (this.component.map as IgoMap).projection;\r\n  }\r\n\r\n  constructor(\r\n    @Self() private component: MapBrowserComponent,\r\n    private mediaService: MediaService\r\n  ) { }\r\n\r\n  /**\r\n   * Start listening to pointermove\r\n   * @internal\r\n   */\r\n  ngOnInit(): void {\r\n    this.listenToMapPointerMove();\r\n    this.listenToMapClick();\r\n  }\r\n\r\n  /**\r\n   * Stop listening to pointermove\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.unlistenToMapPointerMove();\r\n    this.unlistenToMapClick();\r\n  }\r\n\r\n  /**\r\n   * On map pointermove\r\n   */\r\n  private listenToMapPointerMove() {\r\n    this.pointerMoveListener = this.map.ol.on(\r\n      'pointermove',\r\n      (event: MapBrowserPointerEvent<any>) => this.onPointerEvent(event, this.pointerPositionDelay)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * On map click\r\n   */\r\n  private listenToMapClick() {\r\n    this.mapClickListener = this.map.ol.on(\r\n      'singleclick',\r\n      (event: MapBrowserPointerEvent<any>) => this.onPointerEvent(event, 0)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Stop listening for map pointermove\r\n   */\r\n  private unlistenToMapPointerMove() {\r\n    unByKey(this.pointerMoveListener);\r\n    this.pointerMoveListener = undefined;\r\n  }\r\n\r\n  /**\r\n   * Stop listening for map clicks\r\n   */\r\n  private unlistenToMapClick() {\r\n    this.mapClickListener = undefined;\r\n  }\r\n\r\n  /**\r\n   * emit delayed coordinate (longitude, latitude array) based on pointerMoveDelay or on click\r\n   * @param event OL map browser pointer event\r\n   */\r\n  private onPointerEvent(event: MapBrowserPointerEvent<any>, delay: number) {\r\n    if (event.dragging || this.mediaService.isTouchScreen()) {return; }\r\n    if (typeof this.lastTimeoutRequest !== 'undefined') { // cancel timeout when the mouse moves\r\n      clearTimeout(this.lastTimeoutRequest);\r\n    }\r\n\r\n    const lonlat = transform(event.coordinate, this.mapProjection, 'EPSG:4326') as [number, number];\r\n    this.lastTimeoutRequest = setTimeout(() => {\r\n      this.pointerPositionCoord.emit(lonlat);\r\n    }, delay);\r\n  }\r\n}\r\n","import {\r\n  Directive,\r\n  Input,\r\n  OnDestroy,\r\n  Self,\r\n  OnInit,\r\n  HostListener\r\n} from '@angular/core'\r\n  ;\r\nimport olLayerVectorTile from 'ol/layer/VectorTile';\r\nimport olLayerVector from 'ol/layer/Vector';\r\n\r\nimport { Subscription } from 'rxjs';\r\nimport olVectorTileSource from 'ol/source/VectorTile';\r\n\r\nimport type { default as OlMapBrowserEvent } from 'ol/MapBrowserEvent';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { MapBrowserComponent } from '../../map/map-browser/map-browser.component';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\n\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport OlFeature from 'ol/Feature';\r\nimport * as OlStyle from 'ol/style';\r\nimport * as OlGeom from 'ol/geom';\r\n\r\nimport { EntityStore } from '@igo2/common';\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { VectorLayer, Layer, VectorTileLayer } from '../../layer/shared/layers';\r\nimport { take } from 'rxjs/operators';\r\nimport { tryBindStoreLayer } from '../../feature/shared/feature.utils';\r\nimport { FeatureStore } from '../../feature/shared/store';\r\nimport { FeatureMotion } from '../../feature/shared/feature.enums';\r\nimport { MediaService } from '@igo2/core';\r\nimport { StyleService } from '../../layer/shared/style.service';\r\nimport { unByKey } from 'ol/Observable';\r\nimport RenderFeature from 'ol/render/Feature';\r\nimport { StyleByAttribute } from '../../layer/shared/vector-style.interface';\r\n\r\n/**\r\n * This directive makes the mouse coordinate trigger a reverse search on available search sources.\r\n * The search results are placed into a label, on a cross icon, representing the mouse coordinate.\r\n * By default, no search sources. Config in config file must be defined.\r\n * the layer level.\r\n */\r\n@Directive({\r\n  selector: '[igoHoverFeature]'\r\n})\r\nexport class HoverFeatureDirective implements OnInit, OnDestroy {\r\n\r\n  public store: FeatureStore<Feature>;\r\n  private pointerHoverFeatureStore: EntityStore<OlFeature<OlGeometry>> = new EntityStore<OlFeature<OlGeometry>>([]);\r\n  private lastTimeoutRequest;\r\n  private store$$: Subscription;\r\n  private layers$$: Subscription;\r\n\r\n  private selectionLayer: olLayerVectorTile;\r\n  private selectionMVT = {};\r\n  private mvtStyleOptions: StyleByAttribute;\r\n\r\n  /**\r\n   * Listener to the pointer move event\r\n   */\r\n  private pointerMoveListener;\r\n\r\n  private singleClickMapListener;\r\n\r\n  private hoverFeatureId: string = 'hoverFeatureId';\r\n  /**\r\n   * The delay where the mouse must be motionless before trigger the reverse search\r\n   */\r\n  @Input() igoHoverFeatureDelay: number = 1000;\r\n\r\n  /**\r\n   * If the user has enabled or not the directive\r\n   */\r\n  @Input() igoHoverFeatureEnabled: boolean = false;\r\n\r\n  @HostListener('mouseout')\r\n  mouseout() {\r\n    clearTimeout(this.lastTimeoutRequest);\r\n    this.clearLayer();\r\n  }\r\n\r\n  /**\r\n   * IGO map\r\n   * @internal\r\n   */\r\n  get map(): IgoMap {\r\n    return this.component.map;\r\n  }\r\n\r\n  get mapProjection(): string {\r\n    return (this.component.map as IgoMap).projection;\r\n  }\r\n\r\n  constructor(\r\n    @Self() private component: MapBrowserComponent,\r\n    private mediaService: MediaService,\r\n    private styleService: StyleService,\r\n  ) { }\r\n\r\n  /**\r\n   * Start listening to pointermove and reverse search results.\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.listenToMapPointerMove();\r\n    this.subscribeToPointerStore();\r\n    this.listenToMapClick();\r\n\r\n    this.map.status$.pipe(take(1)).subscribe(() => {\r\n      this.store = new FeatureStore<Feature>([], { map: this.map });\r\n      this.initStore();\r\n    });\r\n\r\n    // To handle context change without using the contextService.\r\n    this.layers$$ = this.map.layers$.subscribe((layers: Layer[]) => {\r\n      if (this.store && !layers.find(l => l.id === 'hoverFeatureId')) {\r\n        this.initStore();\r\n      }\r\n    });\r\n\r\n  }\r\n\r\n  /**\r\n   * Initialize the pointer position store\r\n   * @internal\r\n   */\r\n  private initStore() {\r\n    const store = this.store;\r\n\r\n    const layer = new VectorLayer({\r\n      isIgoInternalLayer: true,\r\n      id: 'hoverFeatureId',\r\n      title: 'hoverFeature',\r\n      zIndex: 900,\r\n      source: new FeatureDataSource(),\r\n      showInLayerList: false,\r\n      exportable: false,\r\n      browsable: false,\r\n      style: hoverFeatureMarker\r\n    });\r\n    tryBindStoreLayer(store, layer);\r\n\r\n    this.selectionLayer = new olLayerVectorTile({\r\n      map: this.map.ol,\r\n      zIndex: 901,\r\n      renderMode: \"vector\",\r\n      declutter: true,\r\n      source: new olVectorTileSource({}),\r\n      style: (feature, resolution) => {\r\n        if (this.mvtStyleOptions && feature.getId() in this.selectionMVT) {\r\n          return this.createHoverStyle(feature, this.mvtStyleOptions, resolution);\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  createHoverStyle(feature: RenderFeature | OlFeature<OlGeometry>, hoverStyle: StyleByAttribute, resolution: number) {\r\n    const localHoverStyle = { ...hoverStyle };\r\n    let label = hoverStyle.label ? hoverStyle.label.attribute : undefined;\r\n    let hasLabelStyle = hoverStyle.label?.style ? true : false;\r\n\r\n    if (!feature.get('_isLabel')) {\r\n      localHoverStyle.label = undefined;\r\n      hasLabelStyle = false;\r\n      label = undefined;\r\n    } else {\r\n      // clear the style for label....\r\n      const size = localHoverStyle.data ? localHoverStyle.data.length : 0;\r\n      const radius = [];\r\n      const stroke = [];\r\n      const width = [];\r\n      const fill = [];\r\n      for (let i = 0; i < size; i++) {\r\n        radius.push(0);\r\n        stroke.push('rgba(255, 255, 255, 0)');\r\n        width.push(0);\r\n        fill.push('rgba(255, 255, 255, 0)');\r\n      }\r\n      localHoverStyle.radius = radius;\r\n      localHoverStyle.stroke = stroke;\r\n      localHoverStyle.width = width;\r\n      localHoverStyle.fill = fill;\r\n    }\r\n    if (!hasLabelStyle && label) {\r\n      localHoverStyle.label.style =\r\n      {\r\n        textAlign: 'left',\r\n        textBaseline: 'top',\r\n        font: '12px Calibri,sans-serif',\r\n        fill: { color: '#000' },\r\n        backgroundFill: { color: 'rgba(255, 255, 255, 0.5)' },\r\n        backgroundStroke: { color: 'rgba(200, 200, 200, 0.75)', width: 2 },\r\n        stroke: { color: '#fff', width: 3 },\r\n        overflow: true,\r\n        offsetX: 10,\r\n        offsetY: 20,\r\n        padding: [2.5, 2.5, 2.5, 2.5]\r\n      };\r\n    }\r\n    return this.styleService.createStyleByAttribute(feature, localHoverStyle, resolution);\r\n  }\r\n\r\n  /**\r\n   * Stop listening to pointermove and reverse search results.\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.unlistenToMapPointerMove();\r\n    this.unsubscribeToPointerStore();\r\n    this.unlistenToMapSingleClick();\r\n    this.layers$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * Subscribe to pointermove result store\r\n   * @internal\r\n   */\r\n  subscribeToPointerStore() {\r\n    this.store$$ = this.pointerHoverFeatureStore.entities$.subscribe(resultsUnderPointerPosition => {\r\n      this.addFeatureOverlay(resultsUnderPointerPosition);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * On map pointermove\r\n   */\r\n  private listenToMapPointerMove() {\r\n    this.pointerMoveListener = this.map.ol.on(\r\n      'pointermove',\r\n      (event: OlMapBrowserEvent<any>) => this.onMapEvent(event)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * On map singleclick\r\n   */\r\n  private listenToMapClick() {\r\n    this.singleClickMapListener = this.map.ol.on(\r\n      'singleclick',\r\n      (event: OlMapBrowserEvent<any>) => this.onMapSingleClickEvent(event)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to pointer store.\r\n   * @internal\r\n   */\r\n  unsubscribeToPointerStore() {\r\n    this.store$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * Stop listening for map pointermove\r\n   * @internal\r\n   */\r\n  private unlistenToMapPointerMove() {\r\n    unByKey(this.pointerMoveListener);\r\n    this.pointerMoveListener = undefined;\r\n  }\r\n\r\n  /**\r\n   * Stop listening for map singleclick\r\n   * @internal\r\n   */\r\n  private unlistenToMapSingleClick() {\r\n    unByKey(this.singleClickMapListener);\r\n    this.singleClickMapListener = undefined;\r\n  }\r\n\r\n  /**\r\n   * Trigger clear layer on singleclick.\r\n   * @param event OL map browser singleclick event\r\n   */\r\n  private onMapSingleClickEvent(event: OlMapBrowserEvent<any>) {\r\n    this.clearLayer();\r\n  }\r\n\r\n  /**\r\n   * Trigger hover when the mouse is motionless during the defined delay (pointerMoveDelay).\r\n   * @param event OL map browser pointer event\r\n   */\r\n  private onMapEvent(event: OlMapBrowserEvent<any>) {\r\n    if (\r\n      event.dragging || !this.igoHoverFeatureEnabled ||\r\n      this.mediaService.isTouchScreen()) {\r\n      this.clearLayer();\r\n      return;\r\n    }\r\n    if (typeof this.lastTimeoutRequest !== 'undefined') { // cancel timeout when the mouse moves\r\n      clearTimeout(this.lastTimeoutRequest);\r\n    }\r\n    let maximumZindex = -Infinity;\r\n    let topMostOlLayer;\r\n    const pixel = this.map.ol.getPixelFromCoordinate(event.coordinate);\r\n    this.lastTimeoutRequest = setTimeout(() => {\r\n\r\n      // retrieve the topmost layer with feature to only apply the hover on this layer.\r\n      this.map.ol.forEachFeatureAtPixel(pixel, (mapFeature: RenderFeature | OlFeature<OlGeometry>, layerOL: any) => {\r\n        if (!layerOL) {\r\n          return;\r\n        }\r\n        const igoLayer = this.map.getLayerByOlUId((layerOL as any).ol_uid);\r\n        if (!this.canProcessHover(igoLayer as any)) {\r\n          return;\r\n        }\r\n        if (igoLayer.zIndex <= maximumZindex) {\r\n          return;\r\n        }\r\n        maximumZindex = igoLayer.zIndex;\r\n        topMostOlLayer = layerOL;\r\n\r\n      }, {\r\n        hitTolerance: 10, layerFilter: olLayer => olLayer instanceof olLayerVector || olLayer instanceof olLayerVectorTile\r\n      });\r\n      if (!topMostOlLayer) {\r\n        // To clear label\r\n        this.clearLayer();\r\n        this.pointerHoverFeatureStore.clear();\r\n        return;\r\n      }\r\n\r\n      this.map.ol.forEachFeatureAtPixel(pixel, (mapFeature: RenderFeature | OlFeature<OlGeometry>, layerOL: any) => {\r\n        // To avoid flashing feature\r\n        if (\r\n          mapFeature.get('hoverSummary') === undefined &&\r\n          mapFeature.getProperties() !== this.pointerHoverFeatureStore.all()[0]?.getProperties()\r\n        ) {\r\n          this.clearLayer();\r\n          let igoLayer;\r\n          if (layerOL instanceof olLayerVector) {\r\n            igoLayer = this.map.getLayerByOlUId((layerOL as any).ol_uid) as VectorLayer;\r\n            if (!this.canProcessHover(igoLayer)) {\r\n              return;\r\n            }\r\n            let localOlFeature = this.handleRenderFeature(mapFeature);\r\n            this.setLayerStyleFromOptions(igoLayer, localOlFeature);\r\n            const featuresToLoad = [localOlFeature];\r\n            localOlFeature.set(\"_isLabel\", false);\r\n            const myLabelOlFeature = new OlFeature();\r\n            myLabelOlFeature.setProperties(localOlFeature.getProperties());\r\n            const labelGeom =\r\n              localOlFeature.getGeometry().getType() === 'Point' ? localOlFeature.getGeometry() : new OlGeom.Point(event.coordinate);\r\n            myLabelOlFeature.setGeometry(labelGeom);\r\n            myLabelOlFeature.setId(localOlFeature.getId());\r\n            myLabelOlFeature.set(\"_isLabel\", true);\r\n            this.setLayerStyleFromOptions(igoLayer, myLabelOlFeature);\r\n            featuresToLoad.push(myLabelOlFeature);\r\n            this.pointerHoverFeatureStore.load(featuresToLoad);\r\n            return true;\r\n          }\r\n          if (layerOL instanceof olLayerVectorTile) {\r\n            igoLayer = this.map.getLayerByOlUId((layerOL as any).ol_uid) as VectorTileLayer;\r\n            if (!this.canProcessHover(igoLayer)) {\r\n              return;\r\n            }\r\n            if (igoLayer?.options?.styleByAttribute?.hoverStyle) {\r\n              this.mvtStyleOptions = igoLayer.options.styleByAttribute.hoverStyle;\r\n            } else if (igoLayer?.options?.hoverStyle) {\r\n              this.mvtStyleOptions = igoLayer.options.hoverStyle;\r\n            }\r\n            this.selectionLayer.setSource(layerOL.getSource());\r\n            layerOL.getFeatures(event.pixel).then((mvtFeatures: (RenderFeature | OlFeature<OlGeometry>)[]) => {\r\n              if (!mvtFeatures.length) {\r\n                this.selectionMVT = {};\r\n                this.selectionLayer.changed();\r\n                this.clearLayer();\r\n                return;\r\n              }\r\n              const feature = mvtFeatures[0];\r\n              if (!feature) {\r\n                this.clearLayer();\r\n                return;\r\n              }\r\n              let localOlFeature = this.handleRenderFeature(feature);\r\n              localOlFeature.set(\"_isLabel\", false);\r\n              const myLabelOlFeature = new OlFeature();\r\n              myLabelOlFeature.setProperties(localOlFeature.getProperties());\r\n              const labelGeom =\r\n              localOlFeature.getGeometry().getType() === 'Point' ? localOlFeature.getGeometry() : new OlGeom.Point(event.coordinate);\r\n              myLabelOlFeature.setGeometry(labelGeom);\r\n              myLabelOlFeature.setId(localOlFeature.getId());\r\n              myLabelOlFeature.set(\"_isLabel\", true);\r\n              this.setLayerStyleFromOptions(igoLayer, myLabelOlFeature);\r\n              this.pointerHoverFeatureStore.load([myLabelOlFeature]);\r\n              this.selectionMVT[feature.getId()] = localOlFeature;\r\n              this.selectionLayer.changed();\r\n            });\r\n          }\r\n        }\r\n      }, {\r\n        hitTolerance: 10, layerFilter: olLayer => olLayer === topMostOlLayer\r\n      });\r\n    }, this.igoHoverFeatureDelay);\r\n  }\r\n\r\n  canProcessHover(igoLayer: VectorLayer | VectorTileLayer): boolean {\r\n    if (!igoLayer) {\r\n      return false;\r\n    }\r\n    if (!igoLayer.visible) {\r\n      return false;\r\n    }\r\n    if (!igoLayer.options) {\r\n      return false;\r\n    }\r\n\r\n    if (!igoLayer.options.styleByAttribute && !igoLayer.options.hoverStyle) {\r\n      return false;\r\n    }\r\n\r\n    if (\r\n      (igoLayer.options.styleByAttribute && !igoLayer.options.styleByAttribute.hoverStyle) &&\r\n      !igoLayer.options.hoverStyle) {\r\n      return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  handleRenderFeature(feature: RenderFeature | OlFeature<OlGeometry>): OlFeature<OlGeometry> {\r\n    let localFeature: OlFeature<OlGeometry>;\r\n    if (feature instanceof RenderFeature) {\r\n      localFeature = new OlFeature({\r\n        geometry: this.getGeometry(feature)\r\n      });\r\n      localFeature.setId(feature.getId());\r\n    } else if (feature instanceof OlFeature) {\r\n      localFeature = feature;\r\n    }\r\n    localFeature.setProperties(feature.getProperties());\r\n    return localFeature;\r\n  }\r\n\r\n  /**\r\n   * Add a feature to the pointer store\r\n   * @param text string\r\n   */\r\n  private addFeatureOverlay(hoverEntity: OlFeature<OlGeometry>[]) {\r\n\r\n    if (hoverEntity.length > 0) {\r\n\r\n      const result = hoverEntity[0];\r\n      this.clearLayer();\r\n      const feature = new OlFeature({\r\n        geometry: result.getGeometry(),\r\n        meta: { id: this.hoverFeatureId },\r\n        hoverSummary: this.getHoverSummary(result.getProperties())\r\n      });\r\n\r\n      this.store.setLayerOlFeatures([feature], FeatureMotion.None);\r\n    }\r\n  }\r\n\r\n  private setLayerStyleFromOptions(igoLayer: VectorLayer | VectorTileLayer, feature: OlFeature<OlGeometry>) {\r\n    const resolution = this.store.layer.map.viewController.getResolution();\r\n    if (igoLayer?.options?.styleByAttribute?.hoverStyle) {\r\n      this.store.layer.ol.setStyle(this.createHoverStyle(feature, igoLayer.options.styleByAttribute.hoverStyle, resolution));\r\n      return;\r\n    }\r\n    if (igoLayer?.options?.hoverStyle) {\r\n      this.store.layer.ol.setStyle(this.createHoverStyle(feature, igoLayer.options.hoverStyle, resolution));\r\n    }\r\n  }\r\n\r\n  private getHoverSummary(properties): string {\r\n    let summary = '';\r\n    for (const [key, value] of Object.entries(properties)) {\r\n      if (!key.startsWith('_') && key !== 'geometry') {\r\n        summary += `${key}: ${value}` + '\\n';\r\n      }\r\n    }\r\n    return summary.length >= 2 ? summary.slice(0, -2) : summary;\r\n  }\r\n\r\n  private getGeometry(feature): OlGeom.Geometry {\r\n    let geom;\r\n    if (!feature.getOrientedFlatCoordinates) {\r\n      geom = feature.getGeometry();\r\n    } else {\r\n\r\n      const coords = feature.getOrientedFlatCoordinates();\r\n      const flatCoords = [];\r\n\r\n      coords.forEach((c, idx) => {\r\n        if (idx % 2 === 0) {\r\n          flatCoords.push([parseFloat(coords[idx]), parseFloat(coords[idx + 1])]);\r\n        }\r\n      });\r\n\r\n      // TODO: test MultiX\r\n      switch (feature.getType()) {\r\n        case 'Point':\r\n          geom = new OlGeom.Point(flatCoords);\r\n          break;\r\n        case 'Polygon':\r\n          geom = new OlGeom.Polygon([flatCoords]);\r\n          break;\r\n        case 'LineString':\r\n          geom = new OlGeom.LineString([flatCoords]);\r\n          break;\r\n      }\r\n    }\r\n\r\n    return geom;\r\n  }\r\n\r\n\r\n  /**\r\n   * Clear the pointer store features\r\n   */\r\n  private clearLayer() {\r\n    this.selectionMVT = {};\r\n    if (this.selectionLayer) {\r\n      this.selectionLayer.changed();\r\n    }\r\n    if (this.store) {\r\n      this.store.clearLayer();\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Create a default style for the pointer position and it's label summary.\r\n * @param feature OlFeature\r\n * @returns OL style function\r\n */\r\nexport function hoverFeatureMarker(feature: OlFeature<OlGeom.Geometry>, resolution: number): OlStyle.Style[] {\r\n\r\n  const olStyleText = new OlStyle.Style({\r\n    text: new OlStyle.Text({\r\n      text: feature.get('hoverSummary'),\r\n      textAlign: 'left',\r\n      textBaseline: 'top',\r\n      font: '12px Calibri,sans-serif',\r\n      fill: new OlStyle.Fill({ color: '#000' }),\r\n      backgroundFill: new OlStyle.Fill({ color: 'rgba(255, 255, 255, 0.5)' }),\r\n      backgroundStroke: new OlStyle.Stroke({ color: 'rgba(200, 200, 200, 0.75)', width: 2 }),\r\n      stroke: new OlStyle.Stroke({ color: '#fff', width: 3 }),\r\n      overflow: true,\r\n      offsetX: 10,\r\n      offsetY: 20,\r\n      padding: [2.5, 2.5, 2.5, 2.5]\r\n    })\r\n  });\r\n\r\n  const olStyle = [olStyleText];\r\n  switch (feature.getGeometry().getType()) {\r\n    case 'Point':\r\n      olStyle.push(new OlStyle.Style({\r\n        image: new OlStyle.Circle({\r\n          radius: 10,\r\n          stroke: new OlStyle.Stroke({\r\n            color: 'blue',\r\n            width: 3\r\n          })\r\n        })\r\n      }));\r\n      break;\r\n    default:\r\n      olStyle.push(new OlStyle.Style({\r\n        stroke: new OlStyle.Stroke({\r\n          color: 'white',\r\n          width: 5\r\n        })\r\n      }));\r\n      olStyle.push(new OlStyle.Style({\r\n        stroke: new OlStyle.Stroke({\r\n          color: 'blue',\r\n          width: 3\r\n        })\r\n      }));\r\n  }\r\n\r\n  return olStyle;\r\n\r\n}\r\n","import { Component, Input } from '@angular/core';\r\n\r\nimport { IgoMap } from '../shared/map';\r\n\r\n@Component({\r\n  selector: 'igo-zoom-button',\r\n  templateUrl: './zoom-button.component.html',\r\n  styleUrls: ['./zoom-button.component.scss']\r\n})\r\nexport class ZoomButtonComponent {\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() color: string;\r\n\r\n  get zoom(): number { return this.map.viewController.getZoom(); }\r\n\r\n  get minZoom(): number { return this.map.viewController.olView.getMinZoom() || 1; }\r\n\r\n  get maxZoom(): number { return this.map.viewController.olView.getMaxZoom(); }\r\n\r\n  constructor() {}\r\n}\r\n","<div class=\"igo-zoom-button-container\">\r\n  <button\r\n    mat-icon-button\r\n    [matTooltip]=\"'igo.geo.mapButtons.zoomIn' | translate: {zoom: zoom + 1}\"\r\n    matTooltipPosition=\"left\"\r\n    [color]=\"color\"\r\n    [disabled]=\"zoom >= maxZoom\"\r\n    (click)=\"map.viewController.zoomIn()\">\r\n    <mat-icon svgIcon=\"plus\"></mat-icon>\r\n  </button>\r\n\r\n  <button\r\n    mat-icon-button\r\n    [matTooltip]=\"'igo.geo.mapButtons.zoomOut' | translate: {zoom: zoom - 1}\"\r\n    matTooltipPosition=\"left\"\r\n    [color]=\"color\"\r\n    [disabled]=\"zoom <= minZoom\"\r\n    (click)=\"map.viewController.zoomOut()\">\r\n    <mat-icon svgIcon=\"minus\"></mat-icon>\r\n  </button>\r\n</div>\r\n","<div class=\"igo-geolocate-button-container\" *ngIf=\"map.geolocationController\">\r\n  <button\r\n    mat-icon-button\r\n    [matTooltip]=\"map.geolocationController.tracking ? ('igo.geo.mapButtons.geolocateInactive' | translate) :('igo.geo.mapButtons.geolocate' | translate)\"\r\n    matTooltipPosition=\"left\"\r\n    [color]=\"color\"\r\n    (click)=\"onGeolocationClick()\">\r\n    <mat-icon svgIcon=\"{{icon$ | async}}\"></mat-icon>\r\n  </button>\r\n</div>\r\n","import { AfterContentInit, Component, Input, OnDestroy } from '@angular/core';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\n\r\nimport { IgoMap } from '../shared/map';\r\n\r\n@Component({\r\n  selector: 'igo-geolocate-button',\r\n  templateUrl: './geolocate-button.component.html',\r\n  styleUrls: ['./geolocate-button.component.scss']\r\n})\r\nexport class GeolocateButtonComponent implements AfterContentInit, OnDestroy {\r\n\r\n  private tracking$$: Subscription;\r\n  readonly icon$: BehaviorSubject<string> = new BehaviorSubject('crosshairs-gps');\r\n\r\n  @Input()\r\n  get map(): IgoMap {\r\n    return this._map;\r\n  }\r\n  set map(value: IgoMap) {\r\n    this._map = value;\r\n  }\r\n  private _map: IgoMap;\r\n\r\n  @Input()\r\n  get color(): string {\r\n    return this._color;\r\n  }\r\n  set color(value: string) {\r\n    this._color = value;\r\n  }\r\n  private _color: string;\r\n\r\n  constructor(private configService: ConfigService) {}\r\n  ngAfterContentInit(): void {\r\n    this.map.ol.once('rendercomplete', () => {\r\n      this.tracking$$ =this.map.geolocationController.tracking$.subscribe(tracking => {\r\n        if (tracking) {\r\n          this.icon$.next('crosshairs-gps');\r\n        } else {\r\n          this.configService.getConfig('geolocate.basic') ? this.icon$.next('crosshairs-gps') : this.icon$.next('crosshairs');\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    if (this.tracking$$) {\r\n      this.tracking$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  onGeolocationClick() {\r\n    const tracking = this.map.geolocationController.tracking;\r\n    this.map.geolocationController.tracking = tracking ? false : true;\r\n  }\r\n}\r\n","import { ConfigService } from '@igo2/core';\r\nimport { Component, Input } from '@angular/core';\r\nimport { IgoMap } from '../shared/map';\r\nimport { MapExtent } from '../shared/map.interface';\r\nimport * as olproj from 'ol/proj';\r\n/*\r\nButton to center the map to the home extent\r\n*/\r\n@Component({\r\n  selector: 'igo-home-extent-button',\r\n  templateUrl:'./home-extent-button.component.html',\r\n  styleUrls: ['./home-extent-button.component.scss'],\r\n})\r\nexport class HomeExtentButtonComponent {\r\n  @Input() map: IgoMap;\r\n  @Input() color: string;\r\n  @Input() extentOverride?: MapExtent;\r\n  @Input() centerOverride?: [number, number];\r\n  @Input() zoomOverride?: number;\r\n\r\n  private homeExtentButtonExtent;\r\n  private homeExtentButtonCenter;\r\n  private homeExtentButtonZoom;\r\n\r\n constructor(public configService: ConfigService) {\r\n      this.computeHomeExtent();\r\n  }\r\n\r\n  computeHomeExtent() {\r\n    this.homeExtentButtonExtent = this.extentOverride || this.configService.getConfig('homeExtentButton.homeExtButtonExtent');\r\n    this.homeExtentButtonCenter = this.centerOverride || this.configService.getConfig('homeExtentButton.homeExtButtonCenter');\r\n    this.homeExtentButtonZoom = this.zoomOverride || this.configService.getConfig('homeExtentButton.homeExtButtonZoom');\r\n\r\n    // priority over extent if these 2 properties are defined;\r\n    if (this.centerOverride && this.zoomOverride) {\r\n      this.homeExtentButtonExtent = undefined;\r\n    }\r\n  }\r\n\r\n  onToggleClick() {\r\n    this.computeHomeExtent();\r\n    if (this.homeExtentButtonExtent) {\r\n      this.map.viewController.zoomToExtent(this.homeExtentButtonExtent);\r\n    } else if (this.homeExtentButtonCenter && this.homeExtentButtonZoom) {\r\n      const center = olproj.fromLonLat(this.homeExtentButtonCenter, this.map.viewController.olView.getProjection().getCode());\r\n      this.map.viewController.olView.setCenter(center);\r\n      this.map.viewController.zoomTo(this.homeExtentButtonZoom);\r\n    }\r\n  }\r\n}\r\n","<div class=\"igo-home-extent-button-container\"><button\r\n    mat-icon-button\r\n    [matTooltip]=\"'igo.geo.mapButtons.home-extent' | translate\"\r\n            matTooltipPosition=\"left\"\r\n    [color]=\"color\"\r\n    (click)=\"onToggleClick()\"><mat-icon svgIcon = \"home-map-marker\"></mat-icon></button></div>\r\n","<div *ngIf=\"visible\" class=\"igo-wake-lock-button-container\">\r\n  <div>\r\n    <button \r\n      [color]=\"color\"\r\n      mat-icon-button\r\n      [matTooltip]=\"enabled ? ('igo.geo.mapButtons.preventSreenLock' | translate): ('igo.geo.mapButtons.letScreenLock' | translate)\"\r\n      matTooltipPosition=\"left\"\r\n      (click)=\"toggleWakeLock()\">\r\n      <mat-icon svgIcon=\"{{icon$ | async}}\"></mat-icon>\r\n    </button>\r\n  </div>\r\n</div>","import { Component, Input } from '@angular/core';\r\nimport { ConfigService, StorageService } from '@igo2/core';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport NoSleep from 'nosleep.js';\r\nimport { IgoMap } from '../shared/map';\r\nimport { userAgent } from '@igo2/utils';\r\n\r\n@Component({\r\n  selector: 'igo-wake-lock-button',\r\n  templateUrl: './wake-lock-button.component.html',\r\n  styleUrls: ['./wake-lock-button.component.scss']\r\n})\r\n\r\n/**\r\n * Prevent display sleep and enable wake lock in all Android and iOS web browsers.\r\n * On iOS, the Wake Lock API is not supported\r\n * https://developer.mozilla.org/en-US/docs/Web/API/Screen_Wake_Lock_API\r\n * On not supported browser, a fake video is used to keep the screen open.\r\n *\r\n * TODO: When the API will be supported by every browser, We should remove the NoSleep.js dependency\r\n * and replace it by a WakeLock API implementation.\r\n */\r\nexport class WakeLockButtonComponent {\r\n\r\n  @Input() color: string = 'primary';\r\n  @Input() map: IgoMap;\r\n  @Input()\r\n  get enabled(): boolean {\r\n    return this.storageService.get('wakeLockEnabled') as boolean;\r\n  }\r\n  set enabled(value: boolean) {\r\n    this.storageService.set('wakeLockEnabled', value);\r\n  }\r\n\r\n  private noSleep: NoSleep;\r\n  readonly icon$: BehaviorSubject<string> = new BehaviorSubject('sleep');\r\n  public visible = false;\r\n\r\n  constructor(\r\n    private config: ConfigService,\r\n    private storageService: StorageService\r\n  ) {\r\n    this.visible = this.config.getConfig('wakeLockApiButton') ? true : false;\r\n    this.noSleep = new NoSleep();\r\n    const nonWakeLockApiBrowser = userAgent.satisfies({\r\n      ie: '>0',\r\n      edge: '<84',\r\n      chrome: '<84',\r\n      firefox: '>0',\r\n      opera: '<70',\r\n      safari: '>0'\r\n    });\r\n    if (nonWakeLockApiBrowser) {\r\n      this.disableWakeLock();\r\n      this.enabled = false;\r\n      window.onblur = () => {\r\n        this.disableWakeLock();\r\n        this.enabled = false;\r\n    };\r\n    }\r\n    this.enabled ? this.enableWakeLock() : this.disableWakeLock();\r\n  }\r\n\r\n  /**\r\n   * Prevent display sleep and enable wake lock in all Android and iOS web browsers.\r\n   * On iOS, the Wake Lock API is not supported\r\n   * https://developer.mozilla.org/en-US/docs/Web/API/Screen_Wake_Lock_API\r\n   * On not supported browser, a fake video is used to keep the screen open.\r\n   */\r\n  private enableWakeLock() {\r\n    this.noSleep.enable();\r\n    this.enabled = true;\r\n    this.icon$.next('sleep-off');\r\n  }\r\n  /**\r\n   * Let display sleep\r\n   */\r\n  private disableWakeLock() {\r\n    this.noSleep.disable();\r\n    this.enabled = false;\r\n    this.icon$.next('sleep');\r\n  }\r\n\r\n  toggleWakeLock() {\r\n    if (this.enabled) {\r\n      this.disableWakeLock();\r\n    } else {\r\n      this.enableWakeLock();\r\n    }\r\n  }\r\n}\r\n","<div *ngIf=\"baseLayers.length > 0\"\r\n     class=\"igo-baselayers-switcher-container\"\r\n     [ngClass]=\"{'container-expand': expand}\"\r\n     [@baseLayerSwitcherState]=\"expand ? 'expand' : useStaticIcon ? 'collapseIcon' : 'collapseMap'\"\r\n     (@baseLayerSwitcherState.start)=\"showButton=false\"\r\n     (@baseLayerSwitcherState.done)=\"showButton=true\"\r\n     (click)=\"collapseOrExpand()\">\r\n\r\n     <div *ngIf=\"useStaticIcon && !expand && showButton\" class=\"igo-baselayers-switcher-button-container\">\r\n       <button\r\n         mat-icon-button\r\n         [matTooltip]=\"'igo.geo.mapButtons.baselayerSwitcher' | translate\"\r\n         matTooltipPosition=\"right\"\r\n         color=\"primary\">\r\n         <mat-icon svgIcon=\"image-multiple\"></mat-icon>\r\n       </button>\r\n     </div>\r\n\r\n     <igo-mini-basemap class=\"mat-typography\" *ngFor=\"let baseLayer of baseLayers; let i = index\"\r\n       [map]=\"map\"\r\n       [baseLayer]=\"baseLayer\"\r\n       [title]=\"(baseLayers.length > 2 && !expand) ? ('igo.geo.baselayersSwitcher.title' | translate) : baseLayer.title\"\r\n       [display]=\"expand || (i === 0 && !useStaticIcon)\"\r\n       [disabled]=\"!expand && baseLayers.length > 1\">\r\n     </igo-mini-basemap>\r\n\r\n    <div class=\"more-baselayers\">\r\n      <mat-icon class=\"material-icons mat-icon mat-list-avatar\" color=\"primary\" svgIcon=\"menu-down\"></mat-icon>\r\n    </div>\r\n\r\n</div>\r\n","import { Component, Input, AfterViewInit, OnDestroy } from '@angular/core';\r\nimport { Subscription } from 'rxjs';\r\n\r\nimport { MediaService, Media } from '@igo2/core';\r\nimport { Layer } from '../../layer';\r\nimport { IgoMap } from '../shared';\r\nimport { baseLayersSwitcherSlideInOut } from './baselayers-switcher.animation';\r\n\r\n@Component({\r\n  selector: 'igo-baselayers-switcher',\r\n  templateUrl: './baselayers-switcher.component.html',\r\n  styleUrls: ['./baselayers-switcher.component.scss'],\r\n  animations: [baseLayersSwitcherSlideInOut()]\r\n})\r\nexport class BaseLayersSwitcherComponent implements AfterViewInit, OnDestroy {\r\n  @Input() map: IgoMap;\r\n  @Input() useStaticIcon: boolean;\r\n\r\n  public _baseLayers: Layer[] = [];\r\n  public expand = false;\r\n  public showButton = true;\r\n\r\n  private layers$$: Subscription;\r\n\r\n  constructor(private mediaService: MediaService) {\r\n    const media = this.mediaService.media$.value;\r\n    if (media === Media.Mobile && this.useStaticIcon === undefined) {\r\n      this.useStaticIcon = true;\r\n    }\r\n  }\r\n\r\n  ngAfterViewInit() {\r\n    this.layers$$ = this.map.layers$.subscribe(arrayLayers => {\r\n      this._baseLayers = arrayLayers.filter(l => l.baseLayer);\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.layers$$.unsubscribe();\r\n  }\r\n\r\n  collapseOrExpand() {\r\n    if (this.baseLayers.length > 1 || this.useStaticIcon) {\r\n      this.expand = !this.expand;\r\n    } else {\r\n      this.expand = false;\r\n    }\r\n  }\r\n\r\n  get baseLayers(): Layer[] {\r\n    const mapResolution = this.map.viewController.getResolution();\r\n    const mapZoom = this.map.viewController.getZoom();\r\n\r\n    const bl = this._baseLayers.filter(l => {\r\n      return (\r\n        (!l.options.maxResolution ||\r\n          mapResolution <= l.options.maxResolution) &&\r\n        (!l.options.minResolution || mapResolution >= l.options.minResolution) &&\r\n        (!l.options.source.options.maxZoom || mapZoom <= l.options.source.options.maxZoom) &&\r\n        (!l.options.source.options.minZoom || mapZoom >= l.options.source.options.minZoom)\r\n      );\r\n    });\r\n\r\n    const blHidden = bl.filter(l => !l.visible);\r\n    return blHidden.length + 1 === bl.length ? blHidden : bl;\r\n  }\r\n}\r\n","import {\r\n  trigger,\r\n  state,\r\n  style,\r\n  transition,\r\n  animate,\r\n  AnimationTriggerMetadata\r\n} from '@angular/animations';\r\n\r\nexport function baseLayersSwitcherSlideInOut(): AnimationTriggerMetadata {\r\n  return trigger('baseLayerSwitcherState', [\r\n    state(\r\n      'collapseIcon',\r\n      style({\r\n        height: '40px',\r\n        width: '40px',\r\n        overflow: 'hidden'\r\n      })\r\n    ),\r\n    state(\r\n      'collapseMap',\r\n      style({\r\n        height: '85px',\r\n        overflow: 'hidden'\r\n      })\r\n    ),\r\n    state(\r\n      'expand',\r\n      style({\r\n        overflow: 'hidden'\r\n      })\r\n    ),\r\n    transition('collapse => expand', animate('200ms')),\r\n    transition('expand => collapse', animate('200ms'))\r\n  ]);\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { DBMode, NgxIndexedDBService } from 'ngx-indexed-db';\r\nimport { Observable, of, Subject } from 'rxjs';\r\nimport { concatMap, first, map, take } from 'rxjs/operators';\r\nimport { CompressionService } from '@igo2/core';\r\nimport { GeoDBData } from './geoDB.interface';\r\nimport { InsertSourceInsertDBEnum } from './geoDB.enums';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class GeoDBService {\r\n  readonly dbName: string = 'geoData';\r\n  public collisionsMap: Map<number, string[]> = new Map();\r\n  public _newTiles: number = 0;\r\n\r\n  constructor(\r\n    private ngxIndexedDBService: NgxIndexedDBService,\r\n    private compression: CompressionService\r\n  ) { }\r\n\r\n  /**\r\n   * Only blob can be will be compressed\r\n   * @param url\r\n   * @param regionID\r\n   * @param object object to handle\r\n   * @param insertSource type of event user or system\r\n   * @param insertEvent Name of the event where the insert has been triggered\r\n   * @returns\r\n   */\r\n  update(url: string, regionID: any, object: any, insertSource: InsertSourceInsertDBEnum, insertEvent: string): Observable<any> {\r\n    if (!object) {\r\n      return;\r\n    }\r\n    let compress = false;\r\n\r\n    const subject: Subject<GeoDBData> = new Subject();\r\n    let object$: Observable<any> = of(object);\r\n    if (object instanceof Blob) {\r\n      object$ = this.compression.compressBlob(object);\r\n      compress = true;\r\n    }\r\n    let geoDBData: GeoDBData;\r\n    object$.pipe(\r\n      first(),\r\n      concatMap(object => {\r\n        geoDBData = {\r\n          url,\r\n          regionID,\r\n          object: object,\r\n          compressed: compress,\r\n          insertSource,\r\n          insertEvent\r\n        };\r\n        return this.ngxIndexedDBService.getByID(this.dbName, url);\r\n      }),\r\n      concatMap((dbObject: GeoDBData) => {\r\n        if (!dbObject) {\r\n          this._newTiles++;\r\n          return this.ngxIndexedDBService.add(this.dbName, geoDBData);\r\n        } else {\r\n          const currentRegionID = dbObject.regionID;\r\n          if (currentRegionID !== regionID) {\r\n            const collisions = this.collisionsMap.get(currentRegionID);\r\n            if (collisions !== undefined) {\r\n              collisions.push(dbObject.url);\r\n              this.collisionsMap.set(currentRegionID, collisions);\r\n            } else {\r\n              this.collisionsMap.set(currentRegionID, [dbObject.url]);\r\n            }\r\n          }\r\n          return this.customUpdate(geoDBData);\r\n        }\r\n      })\r\n    ).subscribe((response) => {\r\n      subject.next(response);\r\n      subject.complete();\r\n    });\r\n    return subject;\r\n  }\r\n\r\n  private customUpdate(geoDBData: GeoDBData): Observable<GeoDBData> {\r\n    const subject: Subject<GeoDBData> = new Subject();\r\n    const deleteRequest = this.ngxIndexedDBService.deleteByKey(this.dbName, geoDBData.url);\r\n    deleteRequest.pipe(\r\n      concatMap(isDeleted => isDeleted ? this.ngxIndexedDBService.add(this.dbName, geoDBData) : of(undefined))\r\n    )\r\n    .subscribe(object => {\r\n      if (object) {\r\n        subject.next(object);\r\n      }\r\n      subject.complete();\r\n    });\r\n    return subject;\r\n  }\r\n\r\n  get(url: string): Observable<any> {\r\n    return this.ngxIndexedDBService.getByID(this.dbName, url).pipe(\r\n      map((data: GeoDBData) => {\r\n        if (data) {\r\n          const object = data.object;\r\n          if (!data.compressed) {\r\n            return object;\r\n          }\r\n          return this.compression.decompressBlob(object);\r\n        }\r\n      })\r\n    );\r\n  }\r\n\r\n  getByID(url: string): Observable<any> {\r\n    return this.ngxIndexedDBService.getByID(this.dbName, url);\r\n  }\r\n\r\n  deleteByKey(url: string): Observable<any> {\r\n    return this.ngxIndexedDBService.deleteByKey(this.dbName, url);\r\n  }\r\n\r\n  getRegionTileCountByID(id: number): Observable<number> {\r\n    const subject: Subject<number> = new Subject();\r\n    const dbRequest = this.getRegionByID(id)\r\n      .subscribe((tiles) => {\r\n        subject.next(tiles.length);\r\n        subject.complete();\r\n      });\r\n    return subject;\r\n  }\r\n\r\n  getRegionByID(id: number): Observable<any[]> {\r\n    if (!id) {\r\n      return;\r\n    }\r\n\r\n    const IDBKey: IDBKeyRange = IDBKeyRange.only(id);\r\n    const dbRequest = this.ngxIndexedDBService.getAllByIndex(this.dbName, 'regionID', IDBKey);\r\n    return dbRequest;\r\n  }\r\n\r\n  deleteByRegionID(id: number): Observable<any> {\r\n    if (!id) {\r\n      return;\r\n    }\r\n\r\n    const IDBKey: IDBKeyRange = IDBKeyRange.only(id);\r\n    const dbRequest = this.ngxIndexedDBService.getAllByIndex(this.dbName, 'regionID', IDBKey);\r\n    dbRequest.subscribe((tiles: GeoDBData[]) => {\r\n      tiles.forEach((tile) => {\r\n        this.ngxIndexedDBService.deleteByKey(this.dbName, tile.url);\r\n      });\r\n    });\r\n    return dbRequest;\r\n  }\r\n\r\n  openCursor(\r\n    keyRange: IDBKeyRange = IDBKeyRange.lowerBound(0),\r\n    mode: DBMode = DBMode.readonly\r\n  ) {\r\n    const request = this.ngxIndexedDBService.openCursorByIndex(this.dbName, 'regionID', keyRange, mode);\r\n    return request;\r\n  }\r\n\r\n  resetCounters() {\r\n    this.resetCollisionsMap();\r\n    this._newTiles = 0;\r\n  }\r\n\r\n  resetCollisionsMap() {\r\n    this.collisionsMap = new Map();\r\n  }\r\n\r\n  revertCollisions() {\r\n    for (const [regionID, collisions] of this.collisionsMap) {\r\n      for (const url of collisions) {\r\n        this.ngxIndexedDBService.getByKey(this.dbName, url)\r\n          .pipe(take(1))\r\n          .subscribe((dbObject: GeoDBData) => {\r\n            const updatedObject = dbObject;\r\n            updatedObject.regionID = regionID;\r\n            this.customUpdate(dbObject);\r\n          });\r\n      }\r\n    }\r\n  }\r\n\r\n  get newTiles(): number {\r\n    return this._newTiles;\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\nimport { Injectable } from '@angular/core';\r\nimport { ConnectionState, NetworkService } from '@igo2/core';\r\nimport { Observable } from 'rxjs';\r\nimport { GeoDBService } from '../geoDB/geoDB.service';\r\n\r\nexport enum ResponseType {\r\n  Arraybuffer= 'arraybuffer',\r\n  Blob= 'blob',\r\n  Text= 'text',\r\n  Json= 'json',\r\n}\r\nexport interface SimpleGetOptions {\r\n  responseType: ResponseType;\r\n  withCredentials?: boolean;\r\n}\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class GeoNetworkService {\r\n  private networkOnline: boolean = true;\r\n  constructor(\r\n    private http: HttpClient,\r\n    public geoDBService: GeoDBService,\r\n    private networkService: NetworkService,\r\n  ) {\r\n    this.networkService.currentState().subscribe((state: ConnectionState) => {\r\n      this.networkOnline = state.connection;\r\n    });\r\n  }\r\n\r\n  get(url: string, simpleGetOptions: SimpleGetOptions): Observable<any> {\r\n    if (window.navigator.onLine && this.networkOnline) {\r\n      return this.getOnline(url, simpleGetOptions);\r\n    }\r\n    return this.getOffline(url);\r\n  }\r\n\r\n  private getOnline(url: string, simpleGetOptions: SimpleGetOptions): Observable<any> {\r\n    let request;\r\n    switch (simpleGetOptions.responseType) {\r\n      // TODO Ajuster pour autre formats\r\n      case 'arraybuffer':\r\n        request = this.http.get(url, { responseType: 'arraybuffer', withCredentials: simpleGetOptions.withCredentials });\r\n        break;\r\n      case 'blob':\r\n        request = this.http.get(url, { responseType: 'blob', withCredentials: simpleGetOptions.withCredentials });\r\n        break;\r\n      case 'text':\r\n        request = this.http.get(url, { responseType: 'text', withCredentials: simpleGetOptions.withCredentials });\r\n          break;\r\n      case 'json':\r\n        request = this.http.get(url, { responseType: 'json', withCredentials: simpleGetOptions.withCredentials });\r\n        break;\r\n      default:\r\n        request = this.http.get(url, { responseType: 'blob', withCredentials: simpleGetOptions.withCredentials });\r\n        break;\r\n    }\r\n    return request;\r\n  }\r\n\r\n  private getOffline(url: string): Observable<any> {\r\n    return this.geoDBService.get(url);\r\n  }\r\n\r\n  public isOnline() {\r\n    return this.networkOnline && window.navigator.onLine;\r\n  }\r\n}\r\n","import { Injectable, Optional } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { Observable, of } from 'rxjs';\r\nimport { map, catchError } from 'rxjs/operators';\r\nimport {stylefunction} from \"ol-mapbox-style\";\r\nimport { AuthInterceptor } from '@igo2/auth';\r\nimport { ObjectUtils } from '@igo2/utils';\r\nimport olLayerVectorTile from 'ol/layer/VectorTile';\r\n\r\nimport { Style } from 'ol/style';\r\n\r\nimport {\r\n  OSMDataSource,\r\n  FeatureDataSource,\r\n  XYZDataSource,\r\n  TileDebugDataSource,\r\n  WFSDataSource,\r\n  WMTSDataSource,\r\n  WMSDataSource,\r\n  CartoDataSource,\r\n  ImageArcGISRestDataSource,\r\n  ArcGISRestDataSource,\r\n  TileArcGISRestDataSource,\r\n  WebSocketDataSource,\r\n  MVTDataSource,\r\n  ClusterDataSource\r\n} from '../../datasource';\r\n\r\nimport { DataSourceService } from '../../datasource/shared/datasource.service';\r\n\r\nimport {\r\n  Layer,\r\n  ImageLayer,\r\n  ImageLayerOptions,\r\n  TileLayer,\r\n  TileLayerOptions,\r\n  VectorLayer,\r\n  VectorLayerOptions,\r\n  AnyLayerOptions,\r\n  VectorTileLayer,\r\n  VectorTileLayerOptions\r\n} from './layers';\r\n\r\nimport { computeMVTOptionsOnHover } from '../utils/layer.utils';\r\nimport { StyleService } from './style.service';\r\nimport { LanguageService, MessageService } from '@igo2/core';\r\nimport { GeoNetworkService } from '../../offline/shared/geo-network.service';\r\nimport { StyleLike as OlStyleLike } from 'ol/style/Style';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class LayerService {\r\n  constructor(\r\n    private http: HttpClient,\r\n    private styleService: StyleService,\r\n    private dataSourceService: DataSourceService,\r\n    private geoNetwork: GeoNetworkService,\r\n    private messageService: MessageService,\r\n    private languageService: LanguageService,\r\n    @Optional() private authInterceptor: AuthInterceptor\r\n  ) {}\r\n\r\n  createLayer(layerOptions: AnyLayerOptions): Layer {\r\n    if (!layerOptions.source) {\r\n      return;\r\n    }\r\n\r\n    if (\r\n      layerOptions.source.options &&\r\n      layerOptions.source.options._layerOptionsFromSource\r\n    ) {\r\n      layerOptions = ObjectUtils.mergeDeep(\r\n        layerOptions.source.options._layerOptionsFromSource,\r\n        layerOptions || {}\r\n      );\r\n    }\r\n\r\n    let layer;\r\n    switch (layerOptions.source.constructor) {\r\n      case OSMDataSource:\r\n      case WMTSDataSource:\r\n      case XYZDataSource:\r\n      case TileDebugDataSource:\r\n      case CartoDataSource:\r\n      case TileArcGISRestDataSource:\r\n        layer = this.createTileLayer(layerOptions as TileLayerOptions);\r\n        break;\r\n      case FeatureDataSource:\r\n      case WFSDataSource:\r\n      case ArcGISRestDataSource:\r\n      case WebSocketDataSource:\r\n      case ClusterDataSource:\r\n        layer = this.createVectorLayer(layerOptions as VectorLayerOptions);\r\n        break;\r\n      case ImageArcGISRestDataSource:\r\n      case WMSDataSource:\r\n        layer = this.createImageLayer(layerOptions as ImageLayerOptions);\r\n        break;\r\n      case MVTDataSource:\r\n        const _layerOptions = computeMVTOptionsOnHover(layerOptions);\r\n        layer = this.createVectorTileLayer(\r\n          _layerOptions as VectorTileLayerOptions\r\n        );\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n\r\n    return layer;\r\n  }\r\n\r\n  createAsyncLayer(_layerOptions: AnyLayerOptions, detailedContextUri?: string): Observable<Layer> {\r\n    const layerOptions = computeMVTOptionsOnHover(_layerOptions);\r\n    if (layerOptions.source) {\r\n      return new Observable(d => d.next(this.createLayer(layerOptions)));\r\n    }\r\n\r\n    return this.dataSourceService\r\n      .createAsyncDataSource(layerOptions.sourceOptions, detailedContextUri)\r\n      .pipe(\r\n        map(source => {\r\n          if (source === undefined) {\r\n            return undefined;\r\n          }\r\n          return this.createLayer(Object.assign(layerOptions, { source }));\r\n        })\r\n      );\r\n  }\r\n\r\n  private createImageLayer(layerOptions: ImageLayerOptions): ImageLayer {\r\n    return new ImageLayer(layerOptions, this.messageService, this.languageService, this.authInterceptor);\r\n  }\r\n\r\n  private createTileLayer(layerOptions: TileLayerOptions): TileLayer {\r\n    return new TileLayer(layerOptions, this.messageService, this.authInterceptor);\r\n  }\r\n\r\n  private createVectorLayer(layerOptions: VectorLayerOptions): VectorLayer {\r\n    let style: Style[] | Style | OlStyleLike;\r\n    let igoLayer: VectorLayer;\r\n    if (layerOptions.style !== undefined) {\r\n      style = (feature, resolution) => this.styleService.createStyle(layerOptions.style, feature, resolution);\r\n    }\r\n\r\n    if (layerOptions.source instanceof ArcGISRestDataSource) {\r\n      const source = layerOptions.source as ArcGISRestDataSource;\r\n      style = source.options.params.style;\r\n    } else if (layerOptions.styleByAttribute) {\r\n      const serviceStyle = this.styleService;\r\n      layerOptions.style = (feature, resolution) => {\r\n        return serviceStyle.createStyleByAttribute(\r\n          feature,\r\n          layerOptions.styleByAttribute,\r\n          resolution\r\n        );\r\n      };\r\n      igoLayer = new VectorLayer(layerOptions, this.messageService, this.authInterceptor, this.geoNetwork);\r\n    }\r\n\r\n    if (layerOptions.source instanceof ClusterDataSource) {\r\n      const serviceStyle = this.styleService;\r\n      const baseStyle = layerOptions.clusterBaseStyle;\r\n      layerOptions.style = (feature, resolution) => {\r\n        return serviceStyle.createClusterStyle(\r\n          feature,\r\n          resolution,\r\n          layerOptions.clusterParam,\r\n          baseStyle\r\n        );\r\n      };\r\n      igoLayer = new VectorLayer(layerOptions, this.messageService, this.authInterceptor, this.geoNetwork);\r\n    }\r\n\r\n    const layerOptionsOl = Object.assign({}, layerOptions, {\r\n      style\r\n    });\r\n\r\n    if (!igoLayer) {\r\n      igoLayer = new VectorLayer(layerOptionsOl, this.messageService, this.authInterceptor, this.geoNetwork);\r\n    }\r\n\r\n    this.applyMapboxStyle(igoLayer, layerOptionsOl as any);\r\n\r\n    return igoLayer;\r\n  }\r\n\r\n  private createVectorTileLayer(\r\n    layerOptions: VectorTileLayerOptions\r\n  ): VectorTileLayer {\r\n    let style: Style[] | Style | OlStyleLike;\r\n    let igoLayer: VectorTileLayer;\r\n\r\n    if (layerOptions.style !== undefined) {\r\n      style = (feature, resolution) => this.styleService.createStyle(layerOptions.style, feature, resolution);\r\n    }\r\n\r\n    if (layerOptions.styleByAttribute) {\r\n      const serviceStyle = this.styleService;\r\n      layerOptions.style = (feature, resolution) => {\r\n        return serviceStyle.createStyleByAttribute(\r\n          feature,\r\n          layerOptions.styleByAttribute,\r\n          resolution\r\n        );\r\n      };\r\n      igoLayer = new VectorTileLayer(layerOptions, this.messageService, this.authInterceptor);\r\n    }\r\n\r\n    const layerOptionsOl = Object.assign({}, layerOptions, {\r\n      style\r\n    });\r\n\r\n    if (!igoLayer) {\r\n      igoLayer = new VectorTileLayer(layerOptionsOl, this.messageService, this.authInterceptor);\r\n    }\r\n\r\n    this.applyMapboxStyle(igoLayer, layerOptionsOl);\r\n    return igoLayer;\r\n  }\r\n\r\n  private applyMapboxStyle(layer: Layer, layerOptions: VectorTileLayerOptions) {\r\n    if (layerOptions.mapboxStyle) {\r\n      this.getStuff(layerOptions.mapboxStyle.url).subscribe(res => {\r\n        if (res.sprite){\r\n          const url = this.getAbsoluteUrl(layerOptions.mapboxStyle.url, res.sprite);\r\n          this.getStuff(url+'.json').subscribe(res2 => {\r\n            stylefunction(layer.ol as olLayerVectorTile, res, layerOptions.mapboxStyle.source, undefined, res2,\r\n              url+'.png');\r\n          });\r\n        } else {\r\n          stylefunction(layer.ol as olLayerVectorTile, res, layerOptions.mapboxStyle.source);\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  private getStuff(url: string) {\r\n    return this.http.get(url).pipe(\r\n      map((res: any) => res),\r\n      catchError(err => {\r\n        console.log('No style was found');\r\n        return of(err);\r\n      })\r\n    );\r\n  }\r\n\r\n  private getAbsoluteUrl(source, url) {\r\n    const r = new RegExp('^http|\\/\\/', 'i');\r\n    if(r.test(url)){\r\n      return url;\r\n    } else {\r\n      if ( source.substr(source.length -1) === \"/\"){\r\n        return source + url;\r\n      } else{\r\n        return source + \"/\" + url;\r\n      }\r\n    }\r\n  }\r\n\r\n}\r\n","<div class=\"igo-mini-basemap-container\">\r\n\r\n  <div *ngIf=\"display\" (click)=\"changeBaseLayer(baseLayer)\">\r\n    <igo-map-browser [map]=\"basemap\"></igo-map-browser>\r\n    <div *ngIf='title' class='igo-mini-basemap-title'> {{title}} </div>\r\n  </div>\r\n\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  AfterViewInit,\r\n  OnDestroy,\r\n  ApplicationRef\r\n} from '@angular/core';\r\n\r\nimport { Layer, LayerOptions } from '../../layer/shared';\r\nimport { LayerService } from '../../layer/shared/layer.service';\r\nimport { IgoMap } from '../shared';\r\n\r\nimport OlMap from 'ol/Map';\r\nimport OlView from 'ol/View';\r\n\r\n@Component({\r\n  selector: 'igo-mini-basemap',\r\n  templateUrl: './mini-basemap.component.html',\r\n  styleUrls: ['./mini-basemap.component.scss']\r\n})\r\nexport class MiniBaseMapComponent implements AfterViewInit, OnDestroy {\r\n\r\n  @Input() map: IgoMap;\r\n  @Input() disabled: boolean;\r\n  @Input() display: boolean;\r\n  @Input() title: string;\r\n\r\n  @Input()\r\n  get baseLayer(): Layer {\r\n    return this._baseLayer;\r\n  }\r\n  set baseLayer(value: Layer) {\r\n    this._baseLayer = value;\r\n    this.handleBaseLayerChanged(value);\r\n  }\r\n  private _baseLayer: Layer;\r\n\r\n  public basemap = new IgoMap({\r\n    controls: {},\r\n    interactions: false\r\n  });\r\n\r\n  constructor(\r\n    private layerService: LayerService,\r\n    private appRef: ApplicationRef\r\n  ) { }\r\n\r\n  ngAfterViewInit() {\r\n    this.handleMainMapViewChange(this.map.ol.getView());\r\n    this.map.viewController.olView.on('change', change => {\r\n      this.handleMainMapViewChange((change.target as OlView));\r\n    });\r\n    this.map.ol.on('pointerdrag', change => {\r\n      this.handleMainMapViewChange((change.target as OlMap).getView());\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.map.viewController.olView.un('change', change => {\r\n      this.handleMainMapViewChange((change.target as OlView));\r\n    });\r\n    this.map.ol.un('pointerdrag', change => {\r\n      this.handleMainMapViewChange((change.target as OlMap).getView());\r\n    });\r\n  }\r\n\r\n  changeBaseLayer(baseLayer: Layer) {\r\n    if (this.disabled) {\r\n      return;\r\n    }\r\n    this.map.changeBaseLayer(baseLayer);\r\n    this.appRef.tick();\r\n  }\r\n\r\n  private handleMainMapViewChange(mainMapView) {\r\n    const mainMapViewProperties = mainMapView.getProperties();\r\n    this.basemap.viewController.olView.setResolution(mainMapViewProperties.resolution);\r\n    this.basemap.viewController.olView.setRotation(mainMapViewProperties.rotation);\r\n    this.basemap.viewController.olView.setCenter(this.map.viewController.getCenter());\r\n  }\r\n\r\n  private handleBaseLayerChanged(baselayer: Layer) {\r\n    this.basemap.removeAllLayers();\r\n\r\n    const options: any = Object.assign(\r\n      Object.create(baselayer.options),\r\n      baselayer.options,\r\n      {\r\n        visible: true,\r\n        baseLayer: false\r\n      }\r\n    );\r\n\r\n    const layer = this.layerService.createLayer(options);\r\n    this.basemap.addLayer(layer);\r\n    this.handleLinkedBaseLayer(layer);\r\n  }\r\n\r\n  private handleLinkedBaseLayer(baselayer: Layer) {\r\n    const linkedLayers = baselayer.options.linkedLayers;\r\n    if (!linkedLayers) {\r\n      return;\r\n    }\r\n    const currentLinkedId = linkedLayers.linkId;\r\n    const currentLinks = linkedLayers.links;\r\n    const isParentLayer = currentLinks ? true : false;\r\n    if (isParentLayer && currentLinkedId === baselayer.options.linkedLayers.linkId) {\r\n      // search for child layers\r\n      currentLinks.map(link => {\r\n        link.linkedIds.map(linkedId => {\r\n          const layerToApply = this.map.layers.find(l => l.options.linkedLayers?.linkId === linkedId);\r\n          if (layerToApply) {\r\n            const linkedLayerOptions: any = Object.assign(\r\n              Object.create(layerToApply.options),\r\n              layerToApply.options,\r\n              {\r\n                zIndex: 9000,\r\n                visible: true,\r\n                baseLayer: false,\r\n              } as LayerOptions\r\n            );\r\n            this.basemap.addLayer(this.layerService.createLayer(linkedLayerOptions));\r\n          }\r\n        });\r\n      });\r\n    }\r\n  }\r\n}\r\n","<div *ngIf=\"((rotated$ | async) && !showIfNoRotation) || showIfNoRotation\" class=\"igo-rotation-button-container\"\r\n  [matTooltip]=\"(rotated$ | async) ? ('igo.geo.mapButtons.resetRotation' | translate: {azimuth: azimuthRounded, rotation: rotationRounded}): ('igo.geo.mapButtons.tipRotation' | translate)\"\r\n  matTooltipPosition=\"left\">\r\n  <button mat-icon-button matTooltipPosition=\"left\" [color]=\"color\" [disabled]=\"(rotated$ | async) === false\"\r\n    (click)=\"map.viewController.resetRotation()\">\r\n    <mat-icon [ngStyle]=\"currentStyle$ | async\" svgIcon=\"navigation\">\r\n    </mat-icon>\r\n  </button>\r\n</div>\r\n","import { AfterContentInit, Component, Input } from '@angular/core';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport { bearingToAzimuth } from '@turf/helpers';\r\n\r\nimport { IgoMap } from '../shared/map';\r\n\r\n@Component({\r\n  selector: 'igo-rotation-button',\r\n  templateUrl: './rotation-button.component.html',\r\n  styleUrls: ['./rotation-button.component.scss']\r\n})\r\nexport class RotationButtonComponent implements AfterContentInit {\r\n  readonly rotated$ = new BehaviorSubject<boolean>(false);\r\n  public azimuthRounded: number = 0;\r\n  public rotationRounded: number = 0;\r\n  readonly currentStyle$ = new BehaviorSubject<{}>({\r\n    transform: 'rotate(0rad)'\r\n  });\r\n\r\n  @Input() map: IgoMap;\r\n  @Input() showIfNoRotation: boolean;\r\n  @Input() color: string;\r\n\r\n  constructor() { }\r\n\r\n  ngAfterContentInit() {\r\n    this.map.viewController.rotation$.subscribe(r => {\r\n      const radians = r || 0;\r\n      const deg = radians * 180 / Math.PI;\r\n      this.rotationRounded = Math.round(deg);\r\n      this.azimuthRounded = Math.round(bearingToAzimuth(deg * -1));\r\n      this.currentStyle$.next({\r\n        transform: 'rotate(' + radians + 'rad)'\r\n      });\r\n      this.rotated$.next(radians !== 0);\r\n    }\r\n    );\r\n  }\r\n}\r\n","<div *ngIf=\"infoContent && infoContent.length\" class=\"infoSection\">\r\n    <pre>{{infoContent}}</pre>\r\n</div>","import { Component, Input } from '@angular/core';\r\n\r\n@Component({\r\n  selector: 'igo-info-section',\r\n  templateUrl: './info-section.component.html',\r\n  styleUrls: ['./info-section.component.scss']\r\n})\r\nexport class InfoSectionComponent {\r\n\r\n  @Input() infoContent: string = '';\r\n\r\n  constructor() {}\r\n\r\n}\r\n","export enum CatalogItemType {\r\n  Layer = 'layer',\r\n  Group = 'group'\r\n}\r\n\r\nexport enum TypeCatalog {\r\n  wms, wmts, baselayers, arcgisrest, tilearcgisrest, imagearcgisrest, composite\r\n}\r\n\r\nexport type TypeCatalogStrings = keyof typeof TypeCatalog;\r\n","import { Observable } from 'rxjs';\r\n\r\nimport { TooltipType } from '../../layer';\r\nimport { TimeFilterOptions } from '../../filter';\r\nimport { QueryFormat, QueryHtmlTarget } from '../../query';\r\n\r\nimport { ICatalog, ICompositeCatalog , CatalogItem, CatalogItemGroup } from './catalog.interface';\r\nimport { CatalogService } from './catalog.service';\r\nimport { TypeCatalog, TypeCatalogStrings } from './catalog.enum';\r\n\r\nexport abstract class Catalog implements ICatalog {\r\n\r\n    // ICatalog -----------------------------\r\n    id: string;\r\n    title: string;\r\n    url: string;\r\n    removable?: boolean;\r\n    externalProvider?: boolean;\r\n    abstract?: string;\r\n    forcedProperties?: any[];\r\n    items?: CatalogItem[];\r\n    type?: TypeCatalogStrings;\r\n    version?: string;\r\n    matrixSet?: string;\r\n    requestEncoding?: string;\r\n    regFilters?: string[];\r\n    groupImpose?: CatalogItemGroup;\r\n    groupSeparator?: string;\r\n    timeFilter?: TimeFilterOptions;\r\n    queryFormat?: QueryFormat;\r\n    queryHtmlTarget?: QueryHtmlTarget;\r\n    queryParams?: { [key: string]: string; };\r\n    sourceOptions?: { [key: string]: any; };\r\n    count?: number;\r\n    tooltipType?: TooltipType.ABSTRACT | TooltipType.TITLE;\r\n    sortDirection?: 'asc' | 'desc';\r\n    setCrossOriginAnonymous?: boolean;\r\n    showLegend?: boolean;\r\n    // ICatalog -----------------------------\r\n\r\n    protected catalogService: CatalogService;\r\n\r\n    constructor(options: Catalog, service: CatalogService) {\r\n        Object.assign(this, options);\r\n        this.catalogService = service;\r\n    }\r\n\r\n    public abstract collectCatalogItems(): Observable<CatalogItem[]>;\r\n}\r\n\r\nclass WMSCatalog extends Catalog {\r\n    constructor(options: Catalog, service: CatalogService) {\r\n        super(options, service);\r\n        const sType: string = TypeCatalog[TypeCatalog.wms];\r\n        this.type = TypeCatalog[sType];\r\n    }\r\n\r\n    public collectCatalogItems(): Observable<CatalogItem[]> {\r\n        return this.catalogService.loadCatalogWMSLayerItems(this);\r\n    }\r\n}\r\n\r\nclass WMTSCatalog extends Catalog {\r\n    constructor(options: Catalog, service: CatalogService) {\r\n        super(options, service);\r\n        const sType: string = TypeCatalog[TypeCatalog.wmts];\r\n        this.type = TypeCatalog[sType];\r\n    }\r\n\r\n    public collectCatalogItems(): Observable<CatalogItem[]> {\r\n        return this.catalogService.loadCatalogWMTSLayerItems(this);\r\n    }\r\n}\r\n\r\nclass BaselayersCatalog extends Catalog {\r\n    constructor(options: Catalog, service: CatalogService) {\r\n        super(options, service);\r\n        const sType: string = TypeCatalog[TypeCatalog.baselayers];\r\n        this.type = TypeCatalog[sType];\r\n    }\r\n\r\n    public collectCatalogItems(): Observable<CatalogItemGroup[]> {\r\n        return this.catalogService.loadCatalogBaseLayerItems(this);\r\n    }\r\n}\r\n\r\nclass ArcGISRestCatalog extends Catalog {\r\n    constructor(options: Catalog, service: CatalogService) {\r\n        super(options, service);\r\n        const sType: string = TypeCatalog[TypeCatalog.arcgisrest];\r\n        this.type = TypeCatalog[sType];\r\n    }\r\n\r\n    public collectCatalogItems() {\r\n        return this.catalogService.loadCatalogArcGISRestItems(this);\r\n    }\r\n}\r\n\r\nclass TileOrImageArcGISRestCatalog extends Catalog {\r\n    constructor(options: Catalog, service: CatalogService, typeCatalog: TypeCatalog) {\r\n        super(options, service);\r\n        this.type = TypeCatalog[TypeCatalog[typeCatalog]];\r\n    }\r\n\r\n    public collectCatalogItems() {\r\n        return this.catalogService.loadCatalogArcGISRestItems(this);\r\n    }\r\n}\r\n\r\nexport class CompositeCatalog extends Catalog implements ICompositeCatalog {\r\n    composite: ICatalog[];\r\n\r\n    constructor(options: Catalog, service: CatalogService) {\r\n        super(options, service);\r\n        const sType: string = TypeCatalog[TypeCatalog.composite];\r\n        this.type = TypeCatalog[sType];\r\n        this.url = null;\r\n    }\r\n\r\n    public collectCatalogItems(): Observable<CatalogItem[]> {\r\n        return this.catalogService.loadCatalogCompositeLayerItems(this);\r\n    }\r\n}\r\n\r\nexport class CatalogFactory {\r\n\r\n    public static createInstanceCatalog(options: Catalog, service: CatalogService): Catalog {\r\n\r\n        let catalog: Catalog;\r\n        if (options.hasOwnProperty('composite')) {\r\n            catalog = new CompositeCatalog(options, service);\r\n        } else if (options.type === TypeCatalog[TypeCatalog.baselayers]) {\r\n            catalog = new BaselayersCatalog(options, service);\r\n        } else if (options.type === TypeCatalog[TypeCatalog.arcgisrest]) {\r\n            catalog = new ArcGISRestCatalog(options, service);\r\n        } else if (options.type === TypeCatalog[TypeCatalog.tilearcgisrest]) {\r\n            catalog = new TileOrImageArcGISRestCatalog(options, service, TypeCatalog.tilearcgisrest);\r\n        } else if (options.type === TypeCatalog[TypeCatalog.imagearcgisrest]) {\r\n            catalog = new TileOrImageArcGISRestCatalog(options, service, TypeCatalog.imagearcgisrest);\r\n        } else if (options.type === TypeCatalog[TypeCatalog.wmts]) {\r\n            catalog = new WMTSCatalog(options, service);\r\n        } else {\r\n            catalog = new WMSCatalog(options, service);\r\n        }\r\n\r\n        return catalog;\r\n    }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { Observable, of } from 'rxjs';\r\nimport { map, mergeMap } from 'rxjs/operators';\r\n\r\nimport { default as striptags } from 'striptags';\r\n\r\nimport * as olformat from 'ol/format';\r\nimport * as olextent from 'ol/extent';\r\nimport olFormatGML2 from 'ol/format/GML2';\r\nimport olFormatGML3 from 'ol/format/GML3';\r\nimport olFormatEsriJSON from 'ol/format/EsriJSON';\r\nimport olFeature from 'ol/Feature';\r\nimport * as olgeom from 'ol/geom';\r\n\r\nimport { LanguageService, MessageService } from '@igo2/core';\r\nimport { uuid } from '@igo2/utils';\r\nimport { Feature, FeatureGeometry } from '../../feature/shared/feature.interfaces';\r\nimport { FEATURE } from '../../feature/shared/feature.enums';\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport {\r\n  WMSDataSource,\r\n  CartoDataSource,\r\n  TileArcGISRestDataSource,\r\n  WMSDataSourceOptions,\r\n  ImageArcGISRestDataSource\r\n} from '../../datasource';\r\n\r\nimport {\r\n  QueryFormat,\r\n  QueryFormatMimeType,\r\n  QueryHtmlTarget\r\n} from './query.enums';\r\nimport {\r\n  QueryOptions,\r\n  QueryableDataSource,\r\n  QueryableDataSourceOptions\r\n} from './query.interfaces';\r\nimport { MapExtent } from '../../map/shared/map.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class QueryService {\r\n  public queryEnabled = true;\r\n  public defaultFeatureCount = 20; // default feature count\r\n  public featureCount = 20; // feature count\r\n\r\n  private previousMessageIds = [];\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private messageService: MessageService,\r\n    private languageService: LanguageService) {}\r\n\r\n  query(layers: Layer[], options: QueryOptions): Observable<Feature[]>[] {\r\n    if (this.previousMessageIds.length) {\r\n      this.previousMessageIds.forEach(id => {\r\n        this.messageService.remove(id);\r\n      });\r\n    }\r\n    return layers\r\n      .filter((layer: Layer) => layer.visible && layer.isInResolutionsRange)\r\n      .map((layer: Layer) => this.queryLayer(layer, options));\r\n  }\r\n\r\n  queryLayer(layer: Layer, options: QueryOptions): Observable<Feature[]> {\r\n    const url = this.getQueryUrl(layer.dataSource, options, false, layer.map.viewController.getExtent());\r\n    if (!url) {\r\n      return of([]);\r\n    }\r\n\r\n    if (\r\n      (layer.dataSource as QueryableDataSource).options.queryFormat ===\r\n      QueryFormat.HTMLGML2\r\n    ) {\r\n      const urlGml = this.getQueryUrl(layer.dataSource, options, true);\r\n      return this.http.get(urlGml, { responseType: 'text' }).pipe(\r\n        mergeMap(gmlRes => {\r\n          const mergedGML = this.mergeGML(gmlRes, url, layer);\r\n          const imposedGeom = mergedGML[0];\r\n          const imposedProperties = mergedGML[1];\r\n          return this.http\r\n            .get(url, { responseType: 'text' })\r\n            .pipe(\r\n              map(res =>\r\n                this.extractData(res, layer, options, url, imposedGeom, imposedProperties)\r\n              )\r\n            );\r\n        })\r\n      );\r\n    }\r\n\r\n    const request = this.http.get(url, { responseType: 'text' });\r\n    return request.pipe(map(res => this.extractData(res, layer, options, url)));\r\n  }\r\n\r\n  private mergeGML(gmlRes, url, layer: Layer): [FeatureGeometry, { [key: string]: any }] {\r\n    const parser = new olFormatGML2();\r\n    let features = parser.readFeatures(gmlRes);\r\n    // Handle non standard GML output (MapServer)\r\n    if (features.length === 0) {\r\n      const wmsParser = new olformat.WMSGetFeatureInfo();\r\n      features = wmsParser.readFeatures(gmlRes);\r\n    }\r\n    const olmline = new olgeom.MultiLineString([]);\r\n    let pts;\r\n    const ptsArray = [];\r\n    let olmpoly = new olgeom.MultiPolygon([]);\r\n    let firstFeatureType;\r\n    const nbFeatures = features.length;\r\n\r\n    // Check if geometry intersect bbox\r\n    // for geoserver getfeatureinfo response in data projection, not call projection\r\n    const searchParams: any = this.getQueryParams(url.toLowerCase());\r\n    const bboxRaw = searchParams.bbox;\r\n    const bbox = bboxRaw.split(',');\r\n    const bboxExtent = olextent.createEmpty();\r\n    olextent.extend(bboxExtent, bbox);\r\n    const outBboxExtent = false;\r\n    let titleContent;\r\n    let queryTileField;\r\n    if (layer.options?.source?.options) {\r\n      const dataSourceOptions = layer.options.source\r\n        .options as QueryableDataSourceOptions;\r\n      if (dataSourceOptions.queryTitle) {\r\n        queryTileField = dataSourceOptions.queryTitle;\r\n      }\r\n    }\r\n    features.map(feature => {\r\n\r\n      if (queryTileField) {\r\n        let queryTitleContent = feature.getProperties()[queryTileField];\r\n        if (queryTitleContent) {\r\n          titleContent = !titleContent ? queryTitleContent : `${titleContent},${queryTitleContent}`;\r\n        }\r\n      }\r\n      /*  if (!feature.getGeometry().simplify(100).intersectsExtent(bboxExtent)) {\r\n        outBboxExtent = true;\r\n        // TODO: Check to project the geometry?\r\n      }*/\r\n      const featureGeometryCoordinates = (feature.getGeometry() as any).getCoordinates();\r\n      const featureGeometryType = feature.getGeometry().getType();\r\n\r\n      if (!firstFeatureType && !outBboxExtent) {\r\n        firstFeatureType = featureGeometryType;\r\n      }\r\n      if (!outBboxExtent) {\r\n        switch (featureGeometryType) {\r\n          case 'Point':\r\n            if (nbFeatures === 1) {\r\n              pts = new olgeom.Point(featureGeometryCoordinates, 'XY');\r\n            } else {\r\n              ptsArray.push(featureGeometryCoordinates);\r\n            }\r\n            break;\r\n          case 'LineString':\r\n            olmline.appendLineString(\r\n              new olgeom.LineString(featureGeometryCoordinates, 'XY')\r\n            );\r\n            break;\r\n          case 'Polygon':\r\n            olmpoly.appendPolygon(\r\n              new olgeom.Polygon(featureGeometryCoordinates, 'XY')\r\n            );\r\n            break;\r\n          case 'MultiPolygon':\r\n            olmpoly = new olgeom.MultiPolygon(featureGeometryCoordinates, 'XY');\r\n            break;\r\n          default:\r\n            return;\r\n        }\r\n      }\r\n    });\r\n\r\n    let olmpts;\r\n    if (ptsArray.length === 0 && pts) {\r\n      olmpts = {\r\n        type: pts.getType(),\r\n        coordinates: pts.getCoordinates()\r\n      };\r\n    } else {\r\n      olmpts = {\r\n        type: 'Polygon',\r\n        coordinates: [this.convexHull(ptsArray)]\r\n      };\r\n    }\r\n\r\n    let returnGeometry;\r\n    switch (firstFeatureType) {\r\n      case 'LineString':\r\n        returnGeometry = {\r\n          type: olmline.getType(),\r\n          coordinates: olmline.getCoordinates()\r\n        };\r\n      case 'Point':\r\n        returnGeometry = olmpts;\r\n      case 'Polygon':\r\n        returnGeometry = {\r\n          type: olmpoly.getType(),\r\n          coordinates: olmpoly.getCoordinates()\r\n        };\r\n      case 'MultiPolygon':\r\n        returnGeometry = {\r\n          type: olmpoly.getType(),\r\n          coordinates: olmpoly.getCoordinates()\r\n        };\r\n    }\r\n    const imposedProperties = {};\r\n\r\n    if (queryTileField) {\r\n      imposedProperties[queryTileField] = titleContent;\r\n    }\r\n\r\n    return [ returnGeometry, imposedProperties];\r\n\r\n\r\n  }\r\n\r\n  cross(a, b, o) {\r\n    return (a[0] - o[0]) * (b[1] - o[1]) - (a[1] - o[1]) * (b[0] - o[0]);\r\n  }\r\n\r\n  /**\r\n   * @param points An array of [X, Y] coordinates\r\n   * This method is use instead of turf.js convexHull because Turf needs at least 3 point to make a hull.\r\n   * https://en.wikibooks.org/wiki/Algorithm_Implementation/Geometry/Convex_hull/Monotone_chain#JavaScript\r\n   */\r\n  convexHull(points) {\r\n    points.sort((a, b) => {\r\n      return a[0] === b[0] ? a[1] - b[1] : a[0] - b[0];\r\n    });\r\n\r\n    const lower = [];\r\n    for (const point of points) {\r\n      while (\r\n        lower.length >= 2 &&\r\n        this.cross(lower[lower.length - 2], lower[lower.length - 1], point) <= 0\r\n      ) {\r\n        lower.pop();\r\n      }\r\n      lower.push(point);\r\n    }\r\n\r\n    const upper = [];\r\n    for (let i = points.length - 1; i >= 0; i--) {\r\n      while (\r\n        upper.length >= 2 &&\r\n        this.cross(\r\n          upper[upper.length - 2],\r\n          upper[upper.length - 1],\r\n          points[i]\r\n        ) <= 0\r\n      ) {\r\n        upper.pop();\r\n      }\r\n      upper.push(points[i]);\r\n    }\r\n\r\n    upper.pop();\r\n    lower.pop();\r\n    return lower.concat(upper);\r\n  }\r\n\r\n  private extractData(\r\n    res,\r\n    layer: Layer,\r\n    options: QueryOptions,\r\n    url: string,\r\n    imposedGeometry?,\r\n    imposedProperties?: { [key: string]: any }\r\n  ): Feature[] {\r\n    const queryDataSource = layer.dataSource as QueryableDataSource;\r\n\r\n    const allowedFieldsAndAlias = this.getAllowedFieldsAndAlias(layer);\r\n    let features = [];\r\n    switch (queryDataSource.options.queryFormat) {\r\n      case QueryFormat.GML3:\r\n        features = this.extractGML3Data(\r\n          res,\r\n          layer.zIndex,\r\n          allowedFieldsAndAlias\r\n        );\r\n        break;\r\n      case QueryFormat.JSON:\r\n      case QueryFormat.GEOJSON:\r\n      case QueryFormat.GEOJSON2:\r\n        features = this.extractGeoJSONData(res, layer.zIndex, allowedFieldsAndAlias);\r\n        break;\r\n      case QueryFormat.ESRIJSON:\r\n        features = this.extractEsriJSONData(res, layer.zIndex, allowedFieldsAndAlias);\r\n        break;\r\n      case QueryFormat.TEXT:\r\n        features = this.extractTextData(res);\r\n        break;\r\n      case QueryFormat.HTML:\r\n        features = this.extractHtmlData(\r\n          res,\r\n          queryDataSource.queryHtmlTarget,\r\n          url\r\n        );\r\n        break;\r\n      case QueryFormat.HTMLGML2:\r\n        features = this.extractHtmlData(\r\n          res,\r\n          queryDataSource.queryHtmlTarget,\r\n          url,\r\n          imposedGeometry,\r\n          imposedProperties\r\n        );\r\n        break;\r\n      case QueryFormat.GML2:\r\n      default:\r\n        features = this.extractGML2Data(res, layer, allowedFieldsAndAlias);\r\n        break;\r\n    }\r\n\r\n    if (features.length > 0 && features[0].geometry === null) {\r\n      const geomToAdd = this.createGeometryFromUrlClick(url);\r\n\r\n      for (const feature of features) {\r\n        feature.geometry = geomToAdd;\r\n      }\r\n    }\r\n\r\n    const wmsDatasource = layer.dataSource as WMSDataSource;\r\n    const featureCount = wmsDatasource.params?.FEATURE_COUNT ?\r\n      new RegExp('FEATURE_COUNT=' + this.featureCount) :\r\n      new RegExp('FEATURE_COUNT=' + this.defaultFeatureCount);\r\n\r\n    if (\r\n      featureCount.test(url) &&\r\n      ((wmsDatasource.params?.FEATURE_COUNT && features.length === this.featureCount) ||\r\n      (!wmsDatasource.params?.FEATURE_COUNT && features.length === this.defaultFeatureCount))) {\r\n      this.languageService.translate.get('igo.geo.query.featureCountMax', {value: layer.title}).subscribe(message => {\r\n        const messageObj = this.messageService.info(message);\r\n        this.previousMessageIds.push(messageObj.toastId);\r\n      });\r\n    }\r\n\r\n    return features.map((feature: Feature, index: number) => {\r\n      const mapLabel = feature.properties[queryDataSource.mapLabel];\r\n\r\n      let exclude;\r\n      if (layer.options.sourceOptions?.type === 'wms') {\r\n        const sourceOptions = layer.options\r\n          .sourceOptions as WMSDataSourceOptions;\r\n        exclude = sourceOptions ? sourceOptions.excludeAttribute : undefined;\r\n      }\r\n\r\n      let title = this.getQueryTitle(feature, layer);\r\n      if (!title && features.length > 1) {\r\n        title = `${layer.title} (${index + 1})`;\r\n      } else if (!title) {\r\n        title = layer.title;\r\n      }\r\n\r\n      const meta = Object.assign({}, feature.meta || {}, {\r\n        id: uuid(),\r\n        title,\r\n        mapTitle: mapLabel,\r\n        sourceTitle: layer.title,\r\n        order: 1000 - layer.zIndex,\r\n        excludeAttribute: exclude\r\n      });\r\n\r\n      return Object.assign(feature, {\r\n        meta,\r\n        projection:\r\n          queryDataSource.options.type === 'carto'\r\n            ? 'EPSG:4326'\r\n            : options.projection\r\n      });\r\n    });\r\n  }\r\n\r\n  private createGeometryFromUrlClick(url) {\r\n    const searchParams: any = this.getQueryParams(url.toLowerCase());\r\n    const bboxRaw = searchParams.bbox;\r\n    const width = parseInt(searchParams.width, 10);\r\n    const height = parseInt(searchParams.height, 10);\r\n    const xPosition = parseInt(searchParams.i || searchParams.x, 10);\r\n    const yPosition = parseInt(searchParams.j || searchParams.y, 10);\r\n\r\n    const bbox = bboxRaw.split(',');\r\n    let threshold =\r\n      (Math.abs(parseFloat(bbox[0])) - Math.abs(parseFloat(bbox[2]))) * 0.05;\r\n\r\n    // for context in degree (EPSG:4326,4269...)\r\n    if (Math.abs(parseFloat(bbox[0])) < 180) {\r\n      threshold = 0.045;\r\n    }\r\n    const clickx =\r\n      parseFloat(bbox[0]) +\r\n      (Math.abs(parseFloat(bbox[0]) - parseFloat(bbox[2])) * xPosition) /\r\n        width -\r\n      threshold;\r\n    const clicky =\r\n      parseFloat(bbox[1]) +\r\n      (Math.abs(parseFloat(bbox[1]) - parseFloat(bbox[3])) * yPosition) /\r\n        height -\r\n      threshold;\r\n    const clickx1 = clickx + threshold * 2;\r\n    const clicky1 = clicky + threshold * 2;\r\n\r\n    const wktPoly =\r\n      'POLYGON((' +\r\n      clickx +\r\n      ' ' +\r\n      clicky +\r\n      ', ' +\r\n      clickx +\r\n      ' ' +\r\n      clicky1 +\r\n      ', ' +\r\n      clickx1 +\r\n      ' ' +\r\n      clicky1 +\r\n      ', ' +\r\n      clickx1 +\r\n      ' ' +\r\n      clicky +\r\n      ', ' +\r\n      clickx +\r\n      ' ' +\r\n      clicky +\r\n      '))';\r\n\r\n    const format = new olformat.WKT();\r\n    const tenPercentWidthGeom = format.readFeature(wktPoly);\r\n    const f = tenPercentWidthGeom.getGeometry() as any;\r\n\r\n    const newGeom = {\r\n      type: f.getType(),\r\n      coordinates: f.getCoordinates()\r\n    };\r\n\r\n    return newGeom;\r\n  }\r\n\r\n  private extractGML2Data(res, zIndex, allowedFieldsAndAlias?) {\r\n    const parser = new olFormatGML2();\r\n    let features = parser.readFeatures(res);\r\n    // Handle non standard GML output (MapServer)\r\n    if (features.length === 0) {\r\n      const wmsParser = new olformat.WMSGetFeatureInfo();\r\n      try {\r\n        features = wmsParser.readFeatures(res);\r\n      } catch (e) {\r\n        console.warn(\r\n          'query.service: Multipolygons are badly managed in mapserver in GML2. Use another format.'\r\n        );\r\n      }\r\n    }\r\n\r\n    return features.map(feature =>\r\n      this.featureToResult(feature, zIndex, allowedFieldsAndAlias)\r\n    );\r\n  }\r\n\r\n  private extractGML3Data(res, zIndex, allowedFieldsAndAlias?) {\r\n    const parser = new olFormatGML3();\r\n    let features = [];\r\n    try {\r\n      features = parser.readFeatures(res);\r\n    } catch (e) {\r\n      console.warn('query.service: GML3 is not well supported');\r\n    }\r\n    return features.map(feature =>\r\n      this.featureToResult(feature, zIndex, allowedFieldsAndAlias)\r\n    );\r\n  }\r\n\r\n  private extractGeoJSONData(res, zIndex, allowedFieldsAndAlias?) {\r\n    let features = [];\r\n    try {\r\n      features = JSON.parse(res.replace(/(\\r|\\n)/g, ' ')).features;\r\n    } catch (e) {\r\n      console.warn('query.service: Unable to parse geojson', '\\n', res);\r\n    }\r\n    features.map(feature => feature.meta = {\r\n      id: uuid(),\r\n      order: 1000 - zIndex,\r\n      alias: allowedFieldsAndAlias\r\n    });\r\n    return features;\r\n  }\r\n\r\n  private extractEsriJSONData(res, zIndex, allowedFieldsAndAlias) {\r\n    if (res) {\r\n      try {\r\n        if (JSON.parse(res).error) {\r\n          return [];\r\n        }\r\n      } catch (e) {}\r\n    }\r\n    const parser = new olFormatEsriJSON();\r\n    const features = parser.readFeatures(res);\r\n\r\n    return features.map(feature => this.featureToResult(feature, zIndex, allowedFieldsAndAlias));\r\n  }\r\n\r\n  private extractTextData(res) {\r\n    // TODO\r\n    return [];\r\n  }\r\n\r\n  private extractHtmlData(\r\n    res,\r\n    htmlTarget: QueryHtmlTarget,\r\n    url,\r\n    imposedGeometry?,\r\n    imposedProperties?: { [key: string]: any }\r\n  ) {\r\n    const searchParams: any = this.getQueryParams(url.toLowerCase());\r\n    const projection = searchParams.crs || searchParams.srs || 'EPSG:3857';\r\n    const geomToAdd = this.createGeometryFromUrlClick(url);\r\n\r\n    if (\r\n      htmlTarget !== QueryHtmlTarget.BLANK &&\r\n      htmlTarget !== QueryHtmlTarget.IFRAME\r\n    ) {\r\n      htmlTarget = QueryHtmlTarget.IFRAME;\r\n    }\r\n\r\n    const bodyTagStart = res.toLowerCase().indexOf('<body>');\r\n    const bodyTagEnd = res.toLowerCase().lastIndexOf('</body>') + 7;\r\n    // replace \\r \\n  and ' ' with '' to validate if the body is really empty. Clear all the html tags from body\r\n    const body = striptags(res.slice(bodyTagStart, bodyTagEnd).replace(/(\\r|\\n|\\s)/g, ''));\r\n    if (body === '' || res === '') {\r\n      return [];\r\n    }\r\n\r\n    return [\r\n      {\r\n        type: FEATURE,\r\n        projection,\r\n        properties: Object.assign({ target: htmlTarget, body: res, url }, imposedProperties),\r\n        geometry: imposedGeometry || geomToAdd\r\n      }\r\n    ];\r\n  }\r\n\r\n  private getQueryParams(url) {\r\n    const queryString = url.split('?');\r\n    if (!queryString[1]) {\r\n      return;\r\n    }\r\n    const pairs = queryString[1].split('&');\r\n\r\n    const result = {};\r\n    pairs.forEach(pair => {\r\n      pair = pair.split('=');\r\n      result[pair[0]] = decodeURIComponent(pair[1] || '');\r\n    });\r\n    return result;\r\n  }\r\n\r\n  public featureToResult(\r\n    featureOL: olFeature<olgeom.Geometry>,\r\n    zIndex: number,\r\n    allowedFieldsAndAlias?\r\n  ): Feature {\r\n    const featureGeometry = featureOL.getGeometry() as any;\r\n    const properties: any = Object.assign({}, featureOL.getProperties());\r\n    delete properties.geometry;\r\n    delete properties.GEOMETRIE;\r\n    delete properties.boundedBy;\r\n    delete properties.shape;\r\n    delete properties.SHAPE;\r\n    delete properties.SHAPE_S;\r\n    delete properties.SHAPE_L;\r\n    delete properties.SHAPE_P;\r\n    delete properties.the_geom;\r\n    delete properties.geom;\r\n\r\n    let geometry;\r\n    if (featureGeometry) {\r\n      geometry = {\r\n        type: featureGeometry.getType(),\r\n        coordinates: featureGeometry.getCoordinates()\r\n      };\r\n    }\r\n\r\n    return {\r\n      type: FEATURE,\r\n      projection: undefined,\r\n      properties,\r\n      geometry,\r\n      meta: {\r\n        id: uuid(),\r\n        order: 1000 - zIndex,\r\n        alias: allowedFieldsAndAlias\r\n      }\r\n    };\r\n  }\r\n\r\n  private getQueryUrl(\r\n    datasource: QueryableDataSource,\r\n    options: QueryOptions,\r\n    forceGML2 = false,\r\n    mapExtent?: MapExtent\r\n  ): string {\r\n    let url;\r\n\r\n    if (datasource.options.queryUrl) {\r\n      return this.getCustomQueryUrl(datasource, options, mapExtent);\r\n    }\r\n\r\n    switch (datasource.constructor) {\r\n      case WMSDataSource:\r\n        const wmsDatasource = datasource as WMSDataSource;\r\n\r\n        const WMSGetFeatureInfoOptions = {\r\n          INFO_FORMAT:\r\n            wmsDatasource.params.INFO_FORMAT ||\r\n            this.getMimeInfoFormat(datasource.options.queryFormat),\r\n          QUERY_LAYERS: wmsDatasource.params.LAYERS,\r\n          FEATURE_COUNT: wmsDatasource.params.FEATURE_COUNT || this.defaultFeatureCount\r\n        };\r\n\r\n        if (wmsDatasource.params.FEATURE_COUNT) {\r\n          this.featureCount = wmsDatasource.params.FEATURE_COUNT;\r\n        }\r\n\r\n        if (forceGML2) {\r\n          WMSGetFeatureInfoOptions.INFO_FORMAT = this.getMimeInfoFormat(\r\n            QueryFormat.GML2\r\n          );\r\n        }\r\n\r\n        url = wmsDatasource.ol.getFeatureInfoUrl(\r\n          options.coordinates,\r\n          options.resolution,\r\n          options.projection,\r\n          WMSGetFeatureInfoOptions\r\n        );\r\n        // const wmsVersion =\r\n        //   wmsDatasource.params.VERSION ||\r\n        //   wmsDatasource.params.version ||\r\n        //   '1.3.0';\r\n        // if (wmsVersion !== '1.3.0') {\r\n        //   url = url.replace('&I=', '&X=');\r\n        //   url = url.replace('&J=', '&Y=');\r\n        // }\r\n        break;\r\n      case CartoDataSource:\r\n        const cartoDatasource = datasource as CartoDataSource;\r\n        const baseUrl =\r\n          'https://' +\r\n          cartoDatasource.options.account +\r\n          '.carto.com/api/v2/sql?';\r\n        const format = 'format=GeoJSON';\r\n        const sql =\r\n          '&q=' + cartoDatasource.options.config.layers[0].options.sql;\r\n        const clause =\r\n          ' WHERE ST_Intersects(the_geom_webmercator,ST_BUFFER(ST_SetSRID(ST_POINT(';\r\n        const meters = cartoDatasource.options.queryPrecision\r\n          ? cartoDatasource.options.queryPrecision\r\n          : '1000';\r\n        const coordinates =\r\n          options.coordinates[0] +\r\n          ',' +\r\n          options.coordinates[1] +\r\n          '),3857),' +\r\n          meters +\r\n          '))';\r\n\r\n        url = `${baseUrl}${format}${sql}${clause}${coordinates}`;\r\n        break;\r\n      case ImageArcGISRestDataSource:\r\n      case TileArcGISRestDataSource:\r\n        const tileArcGISRestDatasource = datasource as TileArcGISRestDataSource;\r\n        const deltaX = Math.abs(mapExtent[0] - mapExtent[2]);\r\n        const deltaY = Math.abs(mapExtent[1] - mapExtent[3]);\r\n        const maxDelta = deltaX > deltaY ? deltaX : deltaY;\r\n        const clickBuffer = maxDelta * 0.005;\r\n        const threshold = tileArcGISRestDatasource.options.queryPrecision ? tileArcGISRestDatasource.options.queryPrecision : clickBuffer;\r\n        const extent = olextent.buffer(\r\n          olextent.boundingExtent([options.coordinates]),\r\n          threshold\r\n        );\r\n        const serviceUrl =\r\n          tileArcGISRestDatasource.options.url +\r\n          '/' +\r\n          tileArcGISRestDatasource.options.layer +\r\n          '/query/';\r\n        const geometry = encodeURIComponent(\r\n          '{\"xmin\":' +\r\n            extent[0] +\r\n            ',\"ymin\":' +\r\n            extent[1] +\r\n            ',\"xmax\":' +\r\n            extent[2] +\r\n            ',\"ymax\":' +\r\n            extent[3] +\r\n            ',\"spatialReference\":{\"wkid\":102100}}'\r\n        );\r\n        const params = [\r\n          'f=json',\r\n          `geometry=${geometry}`,\r\n          'geometryType=esriGeometryEnvelope',\r\n          'inSR=102100',\r\n          'spatialRel=esriSpatialRelIntersects',\r\n          'outFields=*',\r\n          'returnGeometry=true',\r\n          'outSR=102100'\r\n        ];\r\n        url = `${serviceUrl}?${params.join('&')}`;\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n\r\n    return url;\r\n  }\r\n\r\n  private getMimeInfoFormat(queryFormat: string) {\r\n    let mime = 'application/vnd.ogc.gml';\r\n    const keyEnum = Object.keys(QueryFormat).find(\r\n      key => QueryFormat[key] === queryFormat\r\n    );\r\n    if (keyEnum) {\r\n      mime = QueryFormatMimeType[keyEnum];\r\n    }\r\n\r\n    return mime;\r\n  }\r\n\r\n  getAllowedFieldsAndAlias(layer: any) {\r\n    let allowedFieldsAndAlias;\r\n    if (\r\n      layer.options?.source?.options?.sourceFields &&\r\n      layer.options.source.options.sourceFields.length >= 1\r\n    ) {\r\n      allowedFieldsAndAlias = {};\r\n      layer.options.source.options.sourceFields.forEach(sourceField => {\r\n        const alias = sourceField.alias ? sourceField.alias : sourceField.name;\r\n        allowedFieldsAndAlias[sourceField.name] = alias;\r\n      });\r\n    }\r\n    return allowedFieldsAndAlias;\r\n  }\r\n\r\n  getQueryTitle(feature: Feature, layer: Layer): string {\r\n    let title;\r\n    if (layer.options?.source?.options) {\r\n      const dataSourceOptions = layer.options.source\r\n        .options as QueryableDataSourceOptions;\r\n      if (dataSourceOptions.queryTitle) {\r\n        title = this.getLabelMatch(feature, dataSourceOptions.queryTitle);\r\n      }\r\n    }\r\n\r\n    return title;\r\n  }\r\n\r\n  getLabelMatch(feature: Feature, labelMatch): string {\r\n    let label = labelMatch;\r\n    const labelToGet = Array.from(labelMatch.matchAll(/\\$\\{([^\\{\\}]+)\\}/g));\r\n\r\n    labelToGet.forEach(v => {\r\n      label = label.replace(v[0], feature.properties[v[1]]);\r\n    });\r\n\r\n    // Nothing done? check feature's attribute\r\n    if (labelToGet.length === 0 && label === labelMatch) {\r\n      label = feature.properties[labelMatch] || labelMatch;\r\n    }\r\n\r\n    return label;\r\n  }\r\n\r\n  /**\r\n   * @param datasource QueryableDataSource\r\n   * @param options QueryOptions\r\n   * @mapExtent extent of the map when click event\r\n   *\r\n   */\r\n\r\n  getCustomQueryUrl(\r\n    datasource: QueryableDataSource,\r\n    options: QueryOptions,\r\n    mapExtent?: MapExtent): string {\r\n\r\n      let url = datasource.options.queryUrl.replace(/\\{xmin\\}/g, mapExtent[0].toString())\r\n      .replace(/\\{ymin\\}/g, mapExtent[1].toString())\r\n      .replace(/\\{xmax\\}/g, mapExtent[2].toString())\r\n      .replace(/\\{ymax\\}/g, mapExtent[3].toString())\r\n      .replace(/\\{x\\}/g, options.coordinates[0].toString())\r\n      .replace(/\\{y\\}/g, options.coordinates[1].toString())\r\n      .replace(/\\{resolution\\}/g, options.resolution.toString())\r\n      .replace(/\\{srid\\}/g, options.projection.replace('EPSG:',''));\r\n\r\n      return url;\r\n    }\r\n}\r\n","import OlLayer from 'ol/layer/Layer';\r\nimport OlSource from 'ol/source/Source';\r\n\r\nimport { AnyLayer } from '../../layer/shared/layers/any-layer';\r\nimport { QueryableDataSource } from './query.interfaces';\r\n\r\n/**\r\n * Whether a layer is queryable\r\n * @param layer Layer\r\n * @returns True if the layer s squeryable\r\n */\r\nexport function layerIsQueryable(layer: AnyLayer): boolean {\r\n  const dataSource = layer.dataSource as QueryableDataSource;\r\n  return dataSource.options.queryable === true;\r\n}\r\n\r\n/**\r\n * Whether an OL layer is queryable\r\n * @param layer Layer\r\n * @returns True if the ol layer is queryable\r\n */\r\nexport function olLayerIsQueryable(olLayer: OlLayer<OlSource>): boolean {\r\n  const layer = olLayer.get('_layer');\r\n  return layer === undefined ? false : layerIsQueryable(layer);\r\n}\r\n\r\n/**\r\n * Whether a layer's feature is queryable\r\n * @param layer Layer\r\n * @returns True if the layer's feature is queryable\r\n */\r\nexport function layerFeatureIsQueryable(layer: AnyLayer): boolean {\r\n  const dataSource = layer.dataSource as QueryableDataSource;\r\n  return dataSource.options.queryLayerFeatures !== undefined ? (dataSource.options.queryLayerFeatures === true) : true;\r\n}\r\n\r\n/**\r\n * Whether an OL Vector layer is queryable\r\n * @param layer Layer\r\n * @returns True if the ol vector layer is queryable\r\n */\r\nexport function olLayerFeatureIsQueryable(olLayer: OlLayer<OlSource>): boolean {\r\n  const layer = olLayer.get('_layer');\r\n  return layer === undefined ? false : (layerIsQueryable(layer) && layerFeatureIsQueryable(layer));\r\n}\r\n","import {\r\n  Directive,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  OnDestroy,\r\n  AfterViewInit,\r\n  Self\r\n} from '@angular/core';\r\n\r\nimport { Subscription, Observable, of, zip } from 'rxjs';\r\nimport { unByKey } from 'ol/Observable';\r\n\r\nimport OlFeature from 'ol/Feature';\r\nimport OlRenderFeature from 'ol/render/Feature';\r\nimport OlLayer from 'ol/layer/Layer';\r\nimport OlSource from 'ol/source/Source';\r\nimport olVectorSource from 'ol/source/Vector';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport MapBrowserPointerEvent from 'ol/MapBrowserEvent';\r\nimport { EventsKey } from 'ol/events';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { MapBrowserComponent } from '../../map/map-browser/map-browser.component';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport { renderFeatureFromOl } from '../../feature/shared/feature.utils';\r\nimport { featureFromOl } from '../../feature/shared/feature.utils';\r\nimport { QueryService } from './query.service';\r\nimport { layerIsQueryable, olLayerFeatureIsQueryable } from './query.utils';\r\nimport { ctrlKeyDown } from '../../map/shared/map.utils';\r\nimport { OlDragSelectInteraction } from '../../feature/shared/strategies/selection';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { QueryableDataSourceOptions } from './query.interfaces';\r\n\r\n/**\r\n * This directive makes a map queryable with a click of with a drag box.\r\n * By default, all layers are queryable but this can ben controlled at\r\n * the layer level.\r\n */\r\n@Directive({\r\n  selector: '[igoQuery]'\r\n})\r\nexport class QueryDirective implements AfterViewInit, OnDestroy {\r\n  /**\r\n   * Subscriptions to ongoing queries\r\n   */\r\n  private queries$$: Subscription[] = [];\r\n\r\n  /**\r\n   * Listener to the map click event\r\n   */\r\n  private mapClickListener;\r\n\r\n  /**\r\n   * OL drag box interaction\r\n   */\r\n  private olDragSelectInteraction: OlDragSelectInteraction;\r\n\r\n  /**\r\n   * Ol drag box \"end\" event key\r\n   */\r\n  private olDragSelectInteractionEndKey: EventsKey | EventsKey[];\r\n\r\n  /**\r\n   * Whter to query features or not\r\n   */\r\n  @Input() queryFeatures: boolean = false;\r\n\r\n  /**\r\n   * Feature query hit tolerance\r\n   */\r\n  @Input() queryFeaturesHitTolerance: number = 0;\r\n\r\n  /**\r\n   * Feature query hit tolerance\r\n   */\r\n  @Input() queryFeaturesCondition: (olLayer: OlLayer<OlSource>) => boolean;\r\n\r\n  /**\r\n   * Whether all query should complete before emitting an event\r\n   */\r\n  @Input() waitForAllQueries: boolean = true;\r\n\r\n  /**\r\n   * Event emitted when a query (or all queries) complete\r\n   */\r\n  @Output() query = new EventEmitter<{\r\n    features: Feature[] | Feature[][];\r\n    event: MapBrowserPointerEvent<any>;\r\n  }>();\r\n\r\n  /**\r\n   * IGO map\r\n   * @internal\r\n   */\r\n  get map(): IgoMap {\r\n    return (this.component.map as any) as IgoMap;\r\n  }\r\n\r\n  constructor(\r\n    @Self() private component: MapBrowserComponent,\r\n    private queryService: QueryService\r\n  ) {}\r\n\r\n  /**\r\n   * Start listening to click and drag box events\r\n   * @internal\r\n   */\r\n  ngAfterViewInit() {\r\n    this.listenToMapClick();\r\n    this.addDragBoxInteraction();\r\n  }\r\n\r\n  /**\r\n   * Stop listening to click and drag box events and cancel ongoind requests\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.cancelOngoingQueries();\r\n    this.unlistenToMapClick();\r\n    this.removeDragBoxInteraction();\r\n  }\r\n\r\n  /**\r\n   * On map click, issue queries\r\n   */\r\n  private listenToMapClick() {\r\n    this.mapClickListener = this.map.ol.on(\r\n      'singleclick',\r\n      (event: MapBrowserPointerEvent<any>) => this.onMapEvent(event)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Stop listening for map clicks\r\n   */\r\n  private unlistenToMapClick() {\r\n    unByKey(this.mapClickListener);\r\n    this.mapClickListener = undefined;\r\n  }\r\n\r\n  /**\r\n   * Issue queries from a map event and emit events with the results\r\n   * @param event OL map browser pointer event\r\n   */\r\n  private onMapEvent(event: MapBrowserPointerEvent<any>) {\r\n    this.cancelOngoingQueries();\r\n    if (!this.queryService.queryEnabled) {\r\n      return;\r\n    }\r\n\r\n    const queries$ = [];\r\n    if (this.queryFeatures) {\r\n      queries$.push(this.doQueryFeatures(event));\r\n    }\r\n\r\n    const resolution = this.map.ol.getView().getResolution();\r\n    const queryLayers = this.map.layers.filter(layerIsQueryable);\r\n    queries$.push(\r\n      ...this.queryService.query(queryLayers, {\r\n        coordinates: event.coordinate as [number, number],\r\n        projection: this.map.projection,\r\n        resolution\r\n      })\r\n    );\r\n\r\n    if (queries$.length === 0) {\r\n      return;\r\n    }\r\n\r\n    if (this.waitForAllQueries) {\r\n      this.queries$$.push(\r\n        zip(...queries$).subscribe((results: Feature[][]) => {\r\n          const features = [].concat(...results);\r\n          this.query.emit({ features, event });\r\n        })\r\n      );\r\n    } else {\r\n      this.queries$$ = queries$.map((query$: Observable<Feature[]>) => {\r\n        return query$.subscribe((features: Feature[]) => {\r\n          this.query.emit({ features, event });\r\n        });\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Query features already present on the map\r\n   * @param event OL map browser pointer event\r\n   */\r\n  private doQueryFeatures(\r\n    event: MapBrowserPointerEvent<any>\r\n  ): Observable<Feature[]> {\r\n    const clickedFeatures = [];\r\n\r\n    if (event.type === 'singleclick') {\r\n      this.map.ol.forEachFeatureAtPixel(\r\n        event.pixel,\r\n        (featureOL: OlFeature<OlGeometry>, layerOL: any) => {\r\n          const layer = this.map.getLayerById(layerOL.values_._layer.id);\r\n          if ((layer.dataSource.options as QueryableDataSourceOptions).queryFormatAsWms) {\r\n            return;\r\n          }\r\n          if (featureOL) {\r\n            if (featureOL.get('features')) {\r\n              for (const feature of featureOL.get('features')) {\r\n                const newFeature = featureFromOl(feature, this.map.projection);\r\n                newFeature.meta = {\r\n                  title: feature.values_.nom,\r\n                  id: layerOL.values_._layer.id + '.' + feature.id_,\r\n                  icon: feature.values_._icon,\r\n                  sourceTitle: layerOL.values_.title,\r\n                  alias: this.queryService.getAllowedFieldsAndAlias(layer),\r\n                  // title: this.queryService.getQueryTitle(newFeature, layer) || newFeature.meta.title\r\n                };\r\n                clickedFeatures.push(newFeature);\r\n              }\r\n            } else if (featureOL instanceof OlRenderFeature) {\r\n              const newFeature = renderFeatureFromOl(\r\n                featureOL,\r\n                this.map.projection,\r\n                layerOL\r\n              );\r\n              newFeature.meta = {\r\n                id: layerOL.values_._layer.id + '.' + newFeature.meta.id,\r\n                sourceTitle: layerOL.values_.title,\r\n                alias: this.queryService.getAllowedFieldsAndAlias(layer),\r\n                title: this.queryService.getQueryTitle(newFeature, layer) || newFeature.meta.title\r\n              };\r\n              clickedFeatures.push(newFeature);\r\n            } else {\r\n              const newFeature = featureFromOl(\r\n                featureOL,\r\n                this.map.projection,\r\n                layerOL\r\n              );\r\n              newFeature.meta = {\r\n                id: layerOL.values_._layer.id + '.' + newFeature.meta.id,\r\n                sourceTitle: layerOL.values_.title,\r\n                alias: this.queryService.getAllowedFieldsAndAlias(layer),\r\n                title: this.queryService.getQueryTitle(newFeature, layer) || newFeature.meta.title\r\n              };\r\n              clickedFeatures.push(newFeature);\r\n            }\r\n          }\r\n        },\r\n        {\r\n          hitTolerance: this.queryFeaturesHitTolerance || 0,\r\n          layerFilter: this.queryFeaturesCondition\r\n            ? this.queryFeaturesCondition\r\n            : olLayerFeatureIsQueryable\r\n        }\r\n      );\r\n    } else if (event.type === 'boxend') {\r\n      const target = event.target as any;\r\n      const dragExtent = target.getGeometry().getExtent();\r\n      this.map.layers\r\n        .filter(layerIsQueryable)\r\n        .filter(layer => layer instanceof VectorLayer && layer.visible)\r\n        .map(layer => {\r\n          const featuresOL = layer.dataSource.ol as olVectorSource<OlGeometry>;\r\n          featuresOL.forEachFeatureIntersectingExtent(dragExtent, (olFeature: any) => {\r\n            const newFeature: Feature = featureFromOl(olFeature, this.map.projection, layer.ol);\r\n            newFeature.meta = {\r\n              id: layer.id + '.' + olFeature.getId(),\r\n              icon: olFeature.values_._icon,\r\n              sourceTitle: layer.title,\r\n              alias: this.queryService.getAllowedFieldsAndAlias(layer),\r\n              title: this.queryService.getQueryTitle(newFeature, layer) || newFeature.meta.title\r\n            };\r\n            clickedFeatures.push(newFeature);\r\n          });\r\n        });\r\n    }\r\n\r\n\r\n    return of(clickedFeatures);\r\n  }\r\n\r\n  /**\r\n   * Cancel ongoing requests, if any\r\n   */\r\n  private cancelOngoingQueries() {\r\n    this.queries$$.forEach((sub: Subscription) => sub.unsubscribe());\r\n    this.queries$$ = [];\r\n  }\r\n\r\n  /**\r\n   * Add a drag box interaction and, on drag box end, select features\r\n   */\r\n  private addDragBoxInteraction() {\r\n    let olDragSelectInteractionOnQuery;\r\n    const olInteractions = this.map.ol.getInteractions().getArray();\r\n\r\n    // There can only be one dragbox interaction, so find the current one, if any\r\n    // Don't keep a reference to the current dragbox because we don't want\r\n    // to remove it when this startegy is deactivated\r\n    for (const olInteraction of olInteractions) {\r\n      if (olInteraction instanceof OlDragSelectInteraction) {\r\n        olDragSelectInteractionOnQuery = olInteraction;\r\n        break;\r\n      }\r\n    }\r\n    // If no drag box interaction is found, create a new one and add it to the map\r\n    if (olDragSelectInteractionOnQuery === undefined) {\r\n      olDragSelectInteractionOnQuery = new OlDragSelectInteraction({\r\n        condition: ctrlKeyDown\r\n      });\r\n      this.map.ol.addInteraction(olDragSelectInteractionOnQuery);\r\n      this.olDragSelectInteraction = olDragSelectInteractionOnQuery;\r\n    }\r\n\r\n    this.olDragSelectInteractionEndKey = olDragSelectInteractionOnQuery.on(\r\n      'boxend',\r\n      (event: MapBrowserPointerEvent<any>) => this.onMapEvent(event)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Remove drag box interaction\r\n   */\r\n  private removeDragBoxInteraction() {\r\n    if (this.olDragSelectInteractionEndKey !== undefined) {\r\n      unByKey(this.olDragSelectInteractionEndKey);\r\n    }\r\n    if (this.olDragSelectInteraction !== undefined) {\r\n      this.map.ol.removeInteraction(this.olDragSelectInteraction);\r\n    }\r\n    this.olDragSelectInteraction = undefined;\r\n  }\r\n}\r\n","import { Observable } from 'rxjs';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\nimport { StorageService } from '@igo2/core';\r\nimport { SearchResult } from '../search.interfaces';\r\nimport {\r\n  SearchSourceOptions,\r\n  TextSearchOptions,\r\n  ReverseSearchOptions,\r\n  SearchSourceSettings\r\n} from './source.interfaces';\r\n\r\n/**\r\n * Base search source class\r\n */\r\nexport class SearchSource {\r\n  /**\r\n   * Search source ID\r\n   * @internal\r\n   */\r\n  static id = '';\r\n\r\n  /**\r\n   * Search source type\r\n   * @internal\r\n   */\r\n  static type = '';\r\n\r\n  /**\r\n   * Search source options\r\n   * @internal\r\n   */\r\n  protected options: SearchSourceOptions;\r\n\r\n  /**\r\n   * Get search source's id\r\n   * @returns Search source's id\r\n   */\r\n  getId(): string {\r\n    throw new Error('You have to implement the method \"getId\".');\r\n  }\r\n  /**\r\n   * Get search source's type\r\n   * @returns Search source's type\r\n   */\r\n  getType(): string {\r\n    throw new Error('You have to implement the method \"getType\".');\r\n  }\r\n\r\n  /**\r\n   * Get search source's default options\r\n   * @returns Search source default options\r\n   */\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    throw new Error('You have to implement the method \"getDefaultOptions\".');\r\n  }\r\n\r\n  /**\r\n   * Search source's title\r\n   */\r\n  get title(): string {\r\n    return this.options.title;\r\n  }\r\n\r\n  /**\r\n   * Whether the search source is available\r\n   */\r\n  get available(): boolean {\r\n    return this.options.available !== false;\r\n  }\r\n\r\n  /**\r\n   * Whether the search source is enabled\r\n   */\r\n  set enabled(value: boolean) {\r\n    this.options.enabled = value;\r\n  }\r\n  get enabled(): boolean {\r\n    return this.available && this.options.enabled !== false;\r\n  }\r\n\r\n  get showInPointerSummary(): boolean {\r\n    const showInPointerSummary = this.options.showInPointerSummary;\r\n    return showInPointerSummary ? showInPointerSummary : false;\r\n  }\r\n\r\n  get showInSettings(): boolean {\r\n    const showInSettings = this.options.showInSettings;\r\n    return showInSettings === undefined ? true : showInSettings;\r\n  }\r\n\r\n  /**\r\n   * Search url\r\n   */\r\n  get searchUrl(): string {\r\n    return this.options.searchUrl;\r\n  }\r\n\r\n  /**\r\n   * Search query params\r\n   */\r\n  get params(): { [key: string]: string } {\r\n    return this.options.params === undefined ? {} : this.options.params;\r\n  }\r\n\r\n  /**\r\n   * Search settings\r\n   */\r\n  get settings(): SearchSourceSettings[] {\r\n    return this.options.settings === undefined ? [] : this.options.settings;\r\n  }\r\n\r\n  /**\r\n   * Set params from selected settings\r\n   */\r\n  setParamFromSetting(setting: SearchSourceSettings, saveInStorage = true) {\r\n    switch (setting.type) {\r\n      case 'radiobutton':\r\n        setting.values.forEach(conf => {\r\n          if (conf.enabled) {\r\n            this.options.params = Object.assign(this.options.params || {}, {\r\n              [setting.name]: conf.value\r\n            });\r\n          }\r\n        });\r\n        break;\r\n      case 'checkbox':\r\n        let confValue = '';\r\n        setting.values\r\n          .filter(s => s.available !== false)\r\n          .forEach(conf => {\r\n            if (conf.enabled) {\r\n              confValue += conf.value + ',';\r\n            }\r\n          });\r\n        confValue = confValue.slice(0, -1);\r\n        this.options.params = Object.assign(this.options.params || {}, {\r\n          [setting.name]: confValue\r\n        });\r\n        break;\r\n    }\r\n\r\n    if (saveInStorage && this.storageService) {\r\n      this.storageService.set(\r\n        this.getId() + '.options',\r\n        {params: this.options.params}\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Search results display order\r\n   */\r\n  get displayOrder(): number {\r\n    return this.options.order === undefined ? 99 : this.options.order;\r\n  }\r\n\r\n  constructor(options: SearchSourceOptions, private storageService?: StorageService) {\r\n    this.options = options;\r\n    if (this.storageService) {\r\n      const storageOptions = this.storageService.get(\r\n        this.getId() + '.options'\r\n      ) as object;\r\n      if (storageOptions) {\r\n        this.options = ObjectUtils.mergeDeep(this.options, storageOptions);\r\n      }\r\n    }\r\n\r\n    this.options = ObjectUtils.mergeDeep(this.getDefaultOptions(), this.options);\r\n\r\n\r\n    // Set Default Params from Settings\r\n    this.settings.forEach(setting => {\r\n      this.setParamFromSetting(setting, false);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get hashtags valid\r\n   * @param hashtag hashtag from query\r\n   */\r\n  getHashtagsValid(term: string, settingsName: string): string[] {\r\n    const hashtags = term.match(/(#[A-Za-z+]+)/g);\r\n    if (!hashtags) {\r\n      return undefined;\r\n    }\r\n\r\n    const searchSourceSetting = this.getSettingsValues(settingsName);\r\n    const hashtagsValid = [];\r\n    hashtags.forEach(hashtag => {\r\n      searchSourceSetting.values.forEach(conf => {\r\n        const hashtagKey = hashtag.substring(1);\r\n        if (typeof conf.value === 'string') {\r\n          const types = conf.value\r\n            .toLowerCase()\r\n            .normalize('NFD')\r\n            .replace(/[\\u0300-\\u036f]/g, '')\r\n            .split(',');\r\n          const index = types.indexOf(\r\n            hashtagKey\r\n              .toLowerCase()\r\n              .normalize('NFD')\r\n              .replace(/[\\u0300-\\u036f]/g, '')\r\n          );\r\n          if (index !== -1) {\r\n            hashtagsValid.push(types[index]);\r\n          }\r\n        }\r\n        if (conf.hashtags && conf.hashtags.indexOf(hashtagKey.toLowerCase()) !== -1) {\r\n          hashtagsValid.push(conf.value);\r\n        }\r\n      });\r\n    });\r\n\r\n    return hashtagsValid.filter((a, b) => hashtagsValid.indexOf(a) === b);\r\n  }\r\n\r\n  getSettingsValues(search: string): SearchSourceSettings {\r\n    return this.getDefaultOptions().settings.find(\r\n      (value: SearchSourceSettings) => {\r\n        return value.name === search;\r\n      }\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * Search sources that allow searching by text implement this class\r\n */\r\nexport interface TextSearch {\r\n  /**\r\n   * Search by text\r\n   * @param term Text\r\n   * @param options Optional: TextSearchOptions\r\n   * @returns Observable or search results\r\n   */\r\n  search(\r\n    term: string | undefined,\r\n    options?: TextSearchOptions\r\n  ): Observable<SearchResult[]>;\r\n}\r\n\r\n/**\r\n * Search sources that allow searching by coordinates implement this class\r\n */\r\nexport interface ReverseSearch {\r\n  /**\r\n   * Search by text\r\n   * @param lonLat Coordinates\r\n   * @param options Optional: ReverseSearchOptions\r\n   * @returns Observable or search results\r\n   */\r\n  reverseSearch(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions\r\n  ): Observable<SearchResult[]>;\r\n}\r\n","import { Injectable, Inject } from '@angular/core';\r\n\r\nimport { FEATURE } from '../../feature/shared/feature.enums';\r\nimport { SearchSource } from '../../search/shared/sources/source';\r\nimport { SearchSourceOptions } from '../../search/shared/sources/source.interfaces';\r\n/**\r\n * Map search source. For now it has no search capability. All it does\r\n * is act as a placeholder for the map query results' \"search source\".\r\n */\r\n@Injectable()\r\nexport class QuerySearchSource extends SearchSource {\r\n  static id = 'map';\r\n  static type = FEATURE;\r\n\r\n  constructor(@Inject('options') options: SearchSourceOptions) {\r\n    super(options);\r\n  }\r\n\r\n  getId(): string {\r\n    return QuerySearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return QuerySearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    return {\r\n      title: 'Carte'\r\n    };\r\n  }\r\n}\r\n","export class GoogleLinks {\r\n  static getGoogleMapsCoordLink(lon, lat) {\r\n    return 'https://www.google.com/maps?q=' + lat + ',' + lon;\r\n  }\r\n\r\n  static getGoogleStreetViewLink(lon, lat) {\r\n    return 'https://www.google.com/maps?q=&layer=c&cbll=' + lat + ',' + lon;\r\n  }\r\n\r\n  static getGoogleMapsNameLink(name) {\r\n    const encodedName = encodeURI(name);\r\n    return 'https://www.google.com/maps?q=' + encodedName;\r\n  }\r\n}\r\n","import type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport * as olstyle from 'ol/style';\r\nimport olFeature from 'ol/Feature';\r\nimport { asArray as ColorAsArray } from 'ol/color';\r\n\r\nimport { createOverlayMarkerStyle } from '../overlay/shared/overlay-marker-style.utils';\r\nimport { createOverlayDefaultStyle } from '../overlay/shared/overlay.utils';\r\nimport { FeatureCommonVectorStyleOptions } from './commonVectorStyle.interface';\r\nimport { Feature } from '../feature';\r\n\r\n\r\n/**\r\n * Generate a style for selected features\r\n * @param feature The feature to generate the style\r\n * @returns A olStyle\r\n */\r\nexport function getCommonVectorSelectedStyle(\r\n  {\r\n    feature,\r\n    markerColor = [0, 161, 222],\r\n    markerOpacity = 1,\r\n    markerOutlineColor = [0, 255, 255],\r\n    fillColor,\r\n    fillOpacity = 0.15,\r\n    strokeColor = [0, 255, 255],\r\n    strokeOpacity = 0.5,\r\n    strokeWidth = 4\r\n  }: FeatureCommonVectorStyleOptions): olstyle.Style {\r\n\r\n  return getCommonVectorStyle({\r\n    feature,\r\n    markerColor,\r\n    markerOpacity,\r\n    markerOutlineColor,\r\n    fillColor,\r\n    fillOpacity,\r\n    strokeColor,\r\n    strokeOpacity,\r\n    strokeWidth\r\n  });\r\n}\r\n\r\n/**\r\n * Generate a basic style for features\r\n * @param feature The feature to generate the style\r\n * @returns A olStyle\r\n */\r\nexport function getCommonVectorStyle(\r\n  {\r\n    feature,\r\n    markerColor = [0, 161, 222],\r\n    markerOpacity = 0.5,\r\n    markerOutlineColor,\r\n    fillColor = [0, 161, 222],\r\n    fillOpacity = 0.15,\r\n    strokeColor = [0, 161, 222],\r\n    strokeOpacity = 0.5,\r\n    strokeWidth = 2\r\n  }: FeatureCommonVectorStyleOptions): olstyle.Style {\r\n\r\n  const isOlFeature = feature instanceof olFeature;\r\n  let geometry;\r\n  let text;\r\n  if (isOlFeature) {\r\n    feature = feature as olFeature<OlGeometry>;\r\n    geometry = feature.getGeometry();\r\n  } else {\r\n    feature = feature as Feature;\r\n    geometry = feature.geometry;\r\n    text = feature.meta.mapTitle;\r\n  }\r\n  const geometryType = isOlFeature ? geometry.getType() : geometry.type;\r\n\r\n  if (!geometry || geometryType === 'Point') {\r\n    const markerColorAsArray = ColorAsArray(markerColor).slice(0);\r\n    const markerColorRGB = markerColorAsArray.slice(0, 3);\r\n\r\n    if (markerColorAsArray.length === 4 &&\r\n        (typeof markerColor !== 'string' || /^#[0-9A-F]{8}$/i.test(markerColor as string))) {\r\n      markerOpacity = markerColorAsArray[3];\r\n    }\r\n\r\n    return createOverlayMarkerStyle({\r\n      text,\r\n      opacity: markerOpacity,\r\n      markerOutlineColor,\r\n      markerColor: markerColorRGB\r\n    });\r\n  } else {\r\n    const fillWithOpacity = ColorAsArray(fillColor).slice(0);\r\n    const strokeWithOpacity = ColorAsArray(strokeColor).slice(0);\r\n\r\n    if (!(fillWithOpacity.length === 4 &&\r\n        (typeof fillColor !== 'string' || /^#[0-9A-F]{8}$/i.test(fillColor as string)))) {\r\n      fillWithOpacity[3] = fillOpacity;\r\n    }\r\n\r\n    if (!(strokeWithOpacity.length === 4 &&\r\n        (typeof strokeColor !== 'string' || /^#[0-9A-F]{8}$/i.test(strokeColor as string)))) {\r\n      strokeWithOpacity[3] = strokeOpacity;\r\n    }\r\n\r\n    return createOverlayDefaultStyle({\r\n      text,\r\n      strokeWidth,\r\n      strokeColor: strokeWithOpacity,\r\n      fillColor: fillWithOpacity\r\n    });\r\n  }\r\n}\r\n","export class OsmLinks {\r\n  static getOpenStreetMapLink(lon, lat, zoom: number = 17) {\r\n    // return 'https://www.google.com/maps?q=' + lat + ',' + lon;\r\n    return `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}#map=${zoom}/${lat}/${lon}`;\r\n  }\r\n\r\n  static getOpenStreetCamLink(lon, lat, zoom: number = 17) {\r\n    return `https://openstreetcam.org/map/@${lat},${lon},${zoom}z`;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient, HttpErrorResponse } from '@angular/common/http';\r\nimport { EMPTY, Observable, of, zip } from 'rxjs';\r\nimport { map, catchError } from 'rxjs/operators';\r\n\r\nimport { uuid, ObjectUtils } from '@igo2/utils';\r\nimport { LanguageService, MessageService, ConfigService } from '@igo2/core';\r\nimport {\r\n  CapabilitiesService,\r\n  WMSDataSourceOptions,\r\n  WMSDataSourceOptionsParams,\r\n  WMTSDataSourceOptions,\r\n  ArcGISRestDataSourceOptions\r\n} from '../../datasource';\r\nimport { LayerOptions, ImageLayerOptions } from '../../layer';\r\nimport { getResolutionFromScale } from '../../map';\r\n\r\nimport {\r\n  CatalogItem,\r\n  CatalogItemLayer,\r\n  CatalogItemGroup,\r\n  ForcedProperty\r\n} from './catalog.interface';\r\nimport { Catalog, CatalogFactory, CompositeCatalog } from './catalog.abstract';\r\nimport { CatalogItemType, TypeCatalog } from './catalog.enum';\r\nimport { QueryFormat } from '../../query';\r\nimport { generateIdFromSourceOptions } from '../../utils';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class CatalogService {\r\n  constructor(\r\n    private http: HttpClient,\r\n    private config: ConfigService,\r\n    private languageService: LanguageService,\r\n    private messageService: MessageService,\r\n    private capabilitiesService: CapabilitiesService\r\n  ) {}\r\n\r\n  loadCatalogs(): Observable<Catalog[]> {\r\n    const contextConfig = this.config.getConfig('context') || {};\r\n    const catalogConfig = this.config.getConfig('catalog') || {};\r\n    const apiUrl = catalogConfig.url || contextConfig.url;\r\n    const catalogsFromConfig = catalogConfig.sources || [];\r\n\r\n    const observables$ = [];\r\n\r\n    if (apiUrl) {\r\n      // Base layers catalog\r\n      if (catalogConfig.baseLayers) {\r\n        const translate = this.languageService.translate;\r\n        const title = translate.instant('igo.geo.catalog.baseLayers');\r\n        const baseLayersCatalog = [\r\n          {\r\n            id: 'catalog.baselayers',\r\n            title,\r\n            url: `${apiUrl}/baselayers`,\r\n            type: 'baselayers'\r\n          }\r\n        ];\r\n        observables$.push(of(baseLayersCatalog));\r\n      }\r\n\r\n      // Catalogs from API\r\n      const catalogsFromApi$ = this.http\r\n        .get<Catalog[]>(`${apiUrl}/catalogs`)\r\n        .pipe(\r\n          map((catalogs) =>\r\n            catalogs.map((c: any) => Object.assign(c, c.options))\r\n          ),\r\n          catchError((_response: HttpErrorResponse) => EMPTY)\r\n        );\r\n      observables$.push(catalogsFromApi$);\r\n    }\r\n\r\n    // Catalogs from config\r\n    if (catalogsFromConfig.length > 0) {\r\n      observables$.push(\r\n        of(catalogsFromConfig).pipe(\r\n          map((catalogs: Catalog[]) =>\r\n            catalogs.map((c) => {\r\n              if (!c.id) {\r\n                c.id = uuid();\r\n              }\r\n              return c;\r\n            })\r\n          )\r\n        )\r\n      );\r\n    }\r\n\r\n    return zip(...observables$).pipe(\r\n      map((catalogs: Catalog[][]) => [].concat.apply([], catalogs))\r\n    ) as Observable<Catalog[]>;\r\n  }\r\n\r\n  loadCatalogItems(catalog: Catalog): Observable<CatalogItem[]> {\r\n    let newCatalog: Catalog;\r\n    newCatalog = CatalogFactory.createInstanceCatalog(catalog, this);\r\n    return newCatalog.collectCatalogItems();\r\n  }\r\n\r\n  loadCatalogBaseLayerItems(catalog: Catalog): Observable<CatalogItemGroup[]> {\r\n    return this.getCatalogBaseLayersOptions(catalog).pipe(\r\n      map((layersOptions: LayerOptions[]) => {\r\n        const items = layersOptions.map((layerOptions: LayerOptions) => {\r\n          return {\r\n            id: generateIdFromSourceOptions(layerOptions.sourceOptions),\r\n            title: layerOptions.title,\r\n            type: CatalogItemType.Layer,\r\n            externalProvider: catalog.externalProvider,\r\n            options: layerOptions\r\n          } as CatalogItemLayer;\r\n        });\r\n        return [\r\n          {\r\n            id: 'catalog.group.baselayers',\r\n            type: CatalogItemType.Group,\r\n            externalProvider: catalog.externalProvider,\r\n            title: catalog.title,\r\n            items\r\n          }\r\n        ];\r\n      })\r\n    );\r\n  }\r\n\r\n  private getCatalogBaseLayersOptions(\r\n    catalog: Catalog\r\n  ): Observable<LayerOptions[]> {\r\n    return this.http.get<LayerOptions[]>(catalog.url);\r\n  }\r\n\r\n  loadCatalogWMSLayerItems(catalog: Catalog): Observable<CatalogItem[]> {\r\n    return this.getCatalogCapabilities(catalog).pipe(\r\n      map((capabilities: any) => {\r\n        const items = [];\r\n        if (!capabilities) {\r\n          return items;\r\n        }\r\n        if (capabilities.Service && capabilities.Service.Abstract && capabilities.Service.Abstract.length) {\r\n          catalog.abstract = capabilities.Service.Abstract;\r\n        }\r\n        const finalLayers = [];\r\n        this.flattenWmsCapabilities(capabilities.Capability.Layer, 0, finalLayers, catalog.groupSeparator);\r\n        const capabilitiesCapabilityLayer = Object.assign({}, capabilities.Capability.Layer);\r\n        capabilitiesCapabilityLayer.Layer = finalLayers.filter(f => f.Layer.length !== 0);\r\n        this.includeRecursiveItems(\r\n          catalog,\r\n          capabilitiesCapabilityLayer,\r\n          items\r\n        );\r\n        return items;\r\n      })\r\n    );\r\n  }\r\n\r\n  flattenWmsCapabilities(parent, level = 0, finalLayers, separator = ' / ') {\r\n    if (!finalLayers.includes(parent.Title)) {\r\n        const modifiedParent = Object.assign({}, parent);\r\n        modifiedParent.Layer = [];\r\n        finalLayers.push(modifiedParent);\r\n    }\r\n    for (const layer of parent.Layer) {\r\n        const modifiedLayer = Object.assign({}, layer);\r\n        if (level > 0) {\r\n          modifiedLayer.Title = parent.Title + separator + layer.Title;\r\n        }\r\n        if (layer.Layer) {\r\n            this.flattenWmsCapabilities(modifiedLayer, level + 1, finalLayers, separator);\r\n        } else {\r\n            finalLayers.find(ff => ff.Title === parent.Title).Layer.push(layer);\r\n         }\r\n    }\r\n}\r\n\r\n  loadCatalogWMTSLayerItems(catalog: Catalog): Observable<CatalogItem[]> {\r\n    return this.getCatalogCapabilities(catalog).pipe(\r\n      map((capabilities: any) => this.getWMTSItems(catalog, capabilities))\r\n    );\r\n  }\r\n\r\n  loadCatalogArcGISRestItems(catalog: Catalog): Observable<CatalogItem[]> {\r\n    return this.getCatalogCapabilities(catalog).pipe(\r\n      map((capabilities: any) => {\r\n        return this.getArcGISRESTItems(catalog, capabilities);\r\n      })\r\n    );\r\n  }\r\n\r\n  loadCatalogCompositeLayerItems(catalog: Catalog): Observable<CatalogItem[]> {\r\n    const compositeCatalog = (catalog as CompositeCatalog).composite;\r\n\r\n    const catalogsFromInstance = [] as Catalog[];\r\n    compositeCatalog.map((component: Catalog) => {\r\n      component.sortDirection = catalog.sortDirection; // propagate sortDirection with parent value\r\n      catalogsFromInstance.push(\r\n        CatalogFactory.createInstanceCatalog(component, this)\r\n    );\r\n  }\r\n    );\r\n\r\n    // get CatalogItems for each original Catalog-----------------------------------------------------\r\n    const request1$ = [];\r\n    catalogsFromInstance.map((component: Catalog) =>\r\n      request1$.push(component.collectCatalogItems())\r\n    );\r\n\r\n    // integrate imposed group -----------------------------------------------------\r\n    let request2$ = [];\r\n\r\n    function flatDeepLayer(arr) {\r\n      return arr.reduce(\r\n        (acc, val) =>\r\n          acc.concat(\r\n            val.type === CatalogItemType.Group ? flatDeepLayer(val.items) : val\r\n          ),\r\n        []\r\n      );\r\n    }\r\n\r\n    if (\r\n      Object.keys(compositeCatalog).find((k) => compositeCatalog[k].groupImpose)\r\n    ) {\r\n      const pushImposeGroup = (item, index) => {\r\n        const c = catalogsFromInstance[index];\r\n        const outGroupImpose = Object.assign({}, c.groupImpose);\r\n        outGroupImpose.address = c.id;\r\n        outGroupImpose.type = CatalogItemType.Group;\r\n        outGroupImpose.externalProvider = c.externalProvider;\r\n        if (outGroupImpose.sortDirection === undefined) {\r\n          outGroupImpose.sortDirection = c.sortDirection;\r\n        }\r\n        outGroupImpose.items = [];\r\n\r\n        const flatLayer = flatDeepLayer(item);\r\n        flatLayer.map(\r\n          (v) => (v.address = `${outGroupImpose.address}.${outGroupImpose.id}`)\r\n        );\r\n        outGroupImpose.items = flatLayer;\r\n\r\n        return outGroupImpose;\r\n      };\r\n\r\n      request2$ = request1$.map((obs, idx) =>\r\n        obs.pipe(\r\n          map((items) =>\r\n            compositeCatalog[idx].groupImpose\r\n              ? pushImposeGroup(items, idx)\r\n              : items\r\n          )\r\n        )\r\n      );\r\n    } else {\r\n      request2$ = request1$;\r\n    }\r\n\r\n    // concat Group -----------------------------------------------------\r\n    const request3$ = zip(...request2$).pipe(\r\n      map(\r\n        (output: CatalogItem[]) => [].concat(...output) // [].concat.apply([], result1\r\n      )\r\n    );\r\n\r\n    // merge Group (first level only) -----------------------------------------------------\r\n    const groupByGroupId = (data, keyFn) =>\r\n      data.reduce((acc, group) => {\r\n        const groupId = keyFn(group);\r\n        const ind = acc.find((x) => x.id === groupId);\r\n\r\n        if (!ind) {\r\n          acc[acc.length] = group;\r\n        } else {\r\n          const ix = acc.indexOf(ind);\r\n          if (acc[ix].address.split('|').indexOf(group.address) === -1) {\r\n            acc[ix].address = `${acc[ix].address}|${group.address}`;\r\n          }\r\n          acc[ix].items.push(...group.items);\r\n        }\r\n        return acc;\r\n      }, []);\r\n\r\n    // merge Layer for each Level (catalog, group(recursive))\r\n    const recursiveGroupByLayerAddress = (items, keyFn) =>\r\n      items.reduce((acc, item, idx, arr) => {\r\n        const layerTitle = keyFn(item);\r\n        const outItem = Object.assign({}, item);\r\n\r\n        if (item.type === CatalogItemType.Layer) {\r\n          // same title, same address => result: only one item is kept\r\n\r\n          // same title, address diff\r\n          const indicesMatchTitle = [];\r\n          const indicesMatchNewMetadataUrl = []; // metadata\r\n          const diffAddress = arr.filter((x, i) => {\r\n            let bInd = false;\r\n            if (x.title === layerTitle && x.type === CatalogItemType.Layer) {\r\n              if (i !== idx && x.address !== item.address) {\r\n                bInd = true;\r\n              }\r\n              indicesMatchTitle.push(i);\r\n            }\r\n            return bInd;\r\n          }); // $& i !== idx\r\n\r\n          if (diffAddress.length > 0) {\r\n            let nPosition = indicesMatchTitle.findIndex((x) => x === idx) + 1;\r\n            outItem.title = `${item.title} (${nPosition})`; // source: ${item.address.split('.')[0]}\r\n            nPosition = indicesMatchNewMetadataUrl.findIndex((x) => x === idx) + 1;\r\n            outItem.newMetadataUrl = `${item.newMetadataUrl} (${nPosition})`; // source: ${item.address.split('.')[0]}\r\n          }\r\n\r\n          const exist = acc.find(\r\n            (x) => x.title === outItem.title && x.type === CatalogItemType.Layer\r\n          );\r\n          if (!exist) {\r\n            acc[acc.length] = outItem;\r\n          }\r\n        } else if (item.type === CatalogItemType.Group) {\r\n          outItem.items = recursiveGroupByLayerAddress(\r\n            item.items,\r\n            (layer) => layer.title\r\n          );\r\n          acc[acc.length] = outItem;\r\n        }\r\n\r\n        return acc;\r\n      }, []);\r\n\r\n    const request4$ = request3$.pipe(\r\n      map((output) => groupByGroupId(output, (group) => group.id)),\r\n      map((output) => [].concat(...output)),\r\n      map((data) => recursiveGroupByLayerAddress(data, (layer) => layer.title))\r\n    );\r\n\r\n    return request4$;\r\n  }\r\n\r\n  private getCatalogCapabilities(catalog: Catalog): Observable<any> {\r\n    const sType: string = TypeCatalog[catalog.type as string];\r\n    return this.capabilitiesService\r\n      .getCapabilities(sType as any, catalog.url, catalog.version)\r\n      .pipe(\r\n        catchError((e) => {\r\n          const title = this.languageService.translate.instant(\r\n            'igo.geo.catalog.unavailableTitle'\r\n          );\r\n          const message =\r\n          catalog.title ? this.languageService.translate.instant(\r\n            'igo.geo.catalog.unavailable',\r\n            { value: catalog.title }\r\n          ) : this.languageService.translate.instant(\r\n            'igo.geo.catalog.someUnavailable'\r\n          );\r\n\r\n          this.messageService.error(message, title);\r\n          console.error(e);\r\n          return of(undefined);\r\n        })\r\n      );\r\n  }\r\n\r\n  private computeForcedProperties(\r\n    layerNameFromCatalog: string,\r\n    forcedProperties: ForcedProperty[]): ForcedProperty {\r\n\r\n    if (!forcedProperties || forcedProperties.length === 0) {\r\n      return;\r\n    }\r\n    const returnProperty: ForcedProperty = {\r\n      layerName: layerNameFromCatalog,\r\n      title: undefined,\r\n      metadataUrl: undefined,\r\n      metadataAbstract: undefined,\r\n      metadataAbstractAll: undefined,\r\n      metadataUrlAll: undefined\r\n    };\r\n    //process wildcard before\r\n    // if there is a * wildcard\r\n    const forcedPropertiesForAllLayers = forcedProperties.find(f => f.layerName === '*');\r\n    if (forcedPropertiesForAllLayers) {\r\n      // metadataAbstractAll\r\n      if (forcedPropertiesForAllLayers.metadataAbstractAll) {\r\n        returnProperty.metadataAbstractAll = forcedPropertiesForAllLayers.metadataAbstractAll;\r\n      }\r\n      // metadataUrlAll\r\n      if (forcedPropertiesForAllLayers.metadataUrlAll) {\r\n        returnProperty.metadataUrlAll = forcedPropertiesForAllLayers.metadataUrlAll;\r\n      }\r\n    }\r\n    forcedProperties.map(forcedProperty => {\r\n      // if match found\r\n      if (layerNameFromCatalog === forcedProperty.layerName) {\r\n        // title\r\n        if (forcedProperty.title) {\r\n          returnProperty.title = forcedProperty.title;\r\n        }\r\n        // metadataUrl\r\n        if (forcedProperty.metadataUrl) {\r\n          returnProperty.metadataUrl = forcedProperty.metadataUrl;\r\n        }\r\n        // metadataAbstract\r\n        if (forcedProperty.metadataAbstract) {\r\n          returnProperty.metadataAbstract = forcedProperty.metadataAbstract;\r\n        }\r\n      }\r\n    });\r\n    return returnProperty;\r\n  }\r\n\r\n  /// WMS\r\n\r\n  private prepareCatalogItemLayer(layer, idParent, layersQueryFormat, catalog) {\r\n    const configuredQueryFormat = this.retrieveLayerInfoFormat(\r\n      layer.Name,\r\n      layersQueryFormat\r\n    );\r\n\r\n    const legendOptions =\r\n      catalog.showLegend && layer.Style\r\n        ? this.capabilitiesService.getStyle(layer.Style)\r\n        : undefined;\r\n\r\n    const params = Object.assign({}, catalog.queryParams, {\r\n      LAYERS: layer.Name,\r\n      VERSION: catalog.version\r\n    } as WMSDataSourceOptionsParams);\r\n\r\n    const baseSourceOptions = {\r\n      type: 'wms',\r\n      url: catalog.url,\r\n      crossOrigin: catalog.setCrossOriginAnonymous ? 'anonymous' : undefined,\r\n      queryFormat: configuredQueryFormat,\r\n      queryHtmlTarget:\r\n        configuredQueryFormat === QueryFormat.HTML ||\r\n        configuredQueryFormat === QueryFormat.HTMLGML2\r\n          ? 'iframe'\r\n          : undefined,\r\n      optionsFromCapabilities: true\r\n    };\r\n\r\n    const sourceOptions = Object.assign(\r\n      {},\r\n      baseSourceOptions,\r\n      catalog.sourceOptions,\r\n      { params }\r\n    ) as WMSDataSourceOptions;\r\n\r\n    const propertiesToForce = this.computeForcedProperties(layer.Name, catalog.forcedProperties);\r\n    let baseAbstract;\r\n    let extern = true;\r\n    if (layer.Abstract) {\r\n      baseAbstract = layer.Abstract;\r\n    } else if (!layer.Abstract && catalog.abstract) {\r\n      baseAbstract = catalog.abstract;\r\n    }\r\n    const layerOnlineResource = layer?.DataURL && layer?.DataURL.length >0 ? layer?.DataURL[0].OnlineResource : undefined;\r\n\r\n    let metadataUrl = propertiesToForce?.metadataUrl || propertiesToForce?.metadataUrlAll || layerOnlineResource;\r\n    let metadataAbstract = propertiesToForce?.metadataAbstract || propertiesToForce?.metadataAbstractAll || baseAbstract;\r\n\r\n    if (\r\n      !propertiesToForce?.metadataUrl &&\r\n      !propertiesToForce?.metadataUrlAll &&\r\n      (propertiesToForce?.metadataAbstract ||\r\n        propertiesToForce?.metadataAbstractAll)\r\n    ) {\r\n      extern = false;\r\n    }\r\n    if (propertiesToForce?.metadataAbstract && propertiesToForce?.metadataUrlAll) {\r\n      extern = false;\r\n    }\r\n\r\n    const layerPrepare = {\r\n      id: generateIdFromSourceOptions(sourceOptions),\r\n      type: CatalogItemType.Layer,\r\n      title: propertiesToForce?.title ? propertiesToForce.title : layer.Title,\r\n      address: idParent,\r\n      externalProvider: catalog.externalProvider || false,\r\n      options: {\r\n        maxResolution: getResolutionFromScale(layer.MaxScaleDenominator),\r\n        minResolution: getResolutionFromScale(layer.MinScaleDenominator),\r\n        metadata: {\r\n          url: metadataUrl,\r\n          extern,\r\n          abstract: metadataAbstract,\r\n          type: baseSourceOptions.type\r\n        },\r\n        legendOptions,\r\n        tooltip: { type: catalog.tooltipType },\r\n        sourceOptions\r\n      }\r\n    } as CatalogItem;\r\n\r\n    return ObjectUtils.removeUndefined(layerPrepare);\r\n  }\r\n\r\n  private prepareCatalogItemGroup(\r\n    itemListIn,\r\n    regexes,\r\n    idGroup,\r\n    layersQueryFormat,\r\n    catalog\r\n  ) {\r\n    const groupPrepare = {\r\n      id: idGroup,\r\n      type: CatalogItemType.Group,\r\n      title: itemListIn.Title,\r\n      address: catalog.id,\r\n      externalProvider: catalog.externalProvider || false,\r\n      sortDirection: catalog.sortDirection, // propagate sortDirection\r\n      items: itemListIn.Layer.reduce((items: CatalogItem[], layer: any) => {\r\n        if (layer.Layer !== undefined) {\r\n          // recursive, check next level\r\n          const idGroupItemNextLevel =\r\n            idGroup + `.group.${layer.Name || layer.Layer[0].Name}`;\r\n          const groupItem: CatalogItemGroup = this.prepareCatalogItemGroup(\r\n            layer,\r\n            regexes,\r\n            idGroupItemNextLevel,\r\n            layersQueryFormat,\r\n            catalog\r\n          );\r\n\r\n          items.push(groupItem);\r\n        } else {\r\n          if (this.testLayerRegexes(layer.Name, regexes) === false) {\r\n            return items;\r\n          }\r\n\r\n          const layerItem: CatalogItemLayer<ImageLayerOptions> = this.prepareCatalogItemLayer(\r\n            layer,\r\n            idGroup,\r\n            layersQueryFormat,\r\n            catalog\r\n          );\r\n\r\n          items.push(layerItem);\r\n        }\r\n        return items;\r\n      }, [])\r\n    };\r\n    return groupPrepare;\r\n  }\r\n\r\n  private includeRecursiveItems(\r\n    catalog: Catalog,\r\n    itemListIn: any,\r\n    itemsPrepare: CatalogItem[],\r\n    loopLevel: number = 0\r\n  ) {\r\n    // Dig all levels until last level (layer object are not defined on last level)\r\n    const regexes = (catalog.regFilters || []).map(\r\n      (pattern: string) => new RegExp(pattern)\r\n    );\r\n    if (!itemListIn.Layer) {\r\n      return;\r\n    }\r\n\r\n    for (const item of itemListIn.Layer) {\r\n      if (item.Layer !== undefined) {\r\n        // recursive, check next level\r\n        this.includeRecursiveItems(catalog, item, itemsPrepare, loopLevel + 1);\r\n        continue;\r\n      }\r\n\r\n      const layersQueryFormat = this.findCatalogInfoFormat(catalog);\r\n\r\n      // group(with layers) and layer(without group) level 1\r\n      if (loopLevel !== 0) {\r\n        // TODO: Slice that into multiple methods\r\n        // Define object of group layer\r\n        const idGroupItem = `catalog.group.${itemListIn.Name || item.Name}`;\r\n        const groupItem = this.prepareCatalogItemGroup(\r\n          itemListIn,\r\n          regexes,\r\n          idGroupItem,\r\n          layersQueryFormat,\r\n          catalog\r\n        );\r\n\r\n        if (groupItem.items.length !== 0) {\r\n          itemsPrepare.push(groupItem);\r\n        }\r\n\r\n        // Break the group (don't add a group of layer for each of their layer!)\r\n        break;\r\n      } else {\r\n        // layer without group\r\n        if (this.testLayerRegexes(item.Name, regexes) !== false) {\r\n          const layerItem = this.prepareCatalogItemLayer(\r\n            item,\r\n            catalog.id,\r\n            layersQueryFormat,\r\n            catalog\r\n          );\r\n          itemsPrepare.push(layerItem);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /// WMTS\r\n\r\n  private getWMTSItems(\r\n    catalog,\r\n    capabilities: { [key: string]: any }\r\n  ): CatalogItemLayer[] {\r\n    if (!capabilities) {\r\n      return [];\r\n    }\r\n    const layers = capabilities.Contents.Layer;\r\n    const regexes = (catalog.regFilters || []).map(\r\n      (pattern: string) => new RegExp(pattern)\r\n    );\r\n\r\n    if (\r\n      capabilities.ServiceIdentification &&\r\n      capabilities.ServiceIdentification.Abstract &&\r\n      capabilities.ServiceIdentification.Abstract.length) {\r\n      catalog.abstract = capabilities.ServiceIdentification.Abstract;\r\n    }\r\n\r\n    return layers\r\n      .map((layer: any) => {\r\n\r\n        const propertiesToForce = this.computeForcedProperties(layer.Title, catalog.forcedProperties);\r\n        let extern = true;\r\n\r\n        let metadataUrl = propertiesToForce?.metadataUrl || propertiesToForce?.metadataUrlAll;\r\n        let metadataAbstract = propertiesToForce?.metadataAbstract || propertiesToForce?.metadataAbstractAll || catalog.abstract;\r\n\r\n        if (\r\n          !propertiesToForce?.metadataUrl &&\r\n          !propertiesToForce?.metadataUrlAll &&\r\n          (propertiesToForce?.metadataAbstract ||\r\n            propertiesToForce?.metadataAbstractAll)\r\n        ) {\r\n          extern = false;\r\n        }\r\n        if (propertiesToForce?.metadataAbstract && propertiesToForce?.metadataUrlAll) {\r\n          extern = false;\r\n        }\r\n\r\n\r\n      if (this.testLayerRegexes(layer.Identifier, regexes) === false) {\r\n        return undefined;\r\n      }\r\n      const params = Object.assign({}, catalog.queryParams, {\r\n        version: '1.0.0'\r\n      });\r\n      const baseSourceOptions = {\r\n        type: 'wmts',\r\n        url: catalog.url,\r\n        crossOrigin: catalog.setCrossOriginAnonymous\r\n          ? 'anonymous'\r\n          : undefined,\r\n        layer: layer.Identifier,\r\n        matrixSet: catalog.matrixSet,\r\n        optionsFromCapabilities: true,\r\n        requestEncoding: catalog.requestEncoding || 'KVP',\r\n        style: 'default'\r\n      } as WMTSDataSourceOptions;\r\n      const sourceOptions = Object.assign(\r\n        {},\r\n        baseSourceOptions,\r\n        catalog.sourceOptions,\r\n        { params }\r\n      ) as WMTSDataSourceOptions;\r\n\r\n      return ObjectUtils.removeUndefined({\r\n        id: generateIdFromSourceOptions(sourceOptions),\r\n        type: CatalogItemType.Layer,\r\n        title: propertiesToForce?.title ? propertiesToForce.title : layer.Title,\r\n        address: catalog.id,\r\n        externalProvider: catalog.externalProvider,\r\n        options: {\r\n          sourceOptions,\r\n          metadata: {\r\n            url: metadataUrl,\r\n            extern,\r\n            abstract: metadataAbstract,\r\n            type: baseSourceOptions.type\r\n          }\r\n        }\r\n      } as CatalogItem);\r\n    })\r\n    .filter((item: CatalogItemLayer | undefined) => item !== undefined);\r\n}\r\n\r\n/// ERSI\r\n\r\n  private getArcGISRESTItems(\r\n    catalog,\r\n    capabilities\r\n  ): CatalogItemLayer[] {\r\n    if (!capabilities) {\r\n      return [];\r\n    }\r\n    const layers =\r\n    !capabilities.layers ? [] : capabilities.layers.filter(layer => !layer.type || layer.type === 'Feature Layer');\r\n    if (!capabilities.layers) {\r\n      this.messageService.error(\r\n        this.languageService.translate.instant('igo.geo.catalog.someUnavailable'),\r\n        this.languageService.translate.instant('igo.geo.catalog.unavailableTitle')\r\n      );\r\n    }\r\n\r\n    const regexes = (catalog.regFilters || []).map(\r\n      (pattern: string) => new RegExp(pattern)\r\n    );\r\n\r\n    let abstract;\r\n    if (capabilities.serviceDescription && capabilities.serviceDescription.length) {\r\n      const regex = /(<([^>]+)>)/ig;\r\n      abstract = capabilities.serviceDescription.replace(regex, '');\r\n    }\r\n\r\n    return layers\r\n      .map((layer: any) => {\r\n\r\n        const propertiesToForce = this.computeForcedProperties(layer.name, catalog.forcedProperties);\r\n        let baseAbstract;\r\n        let extern = true;\r\n        if (layer.Abstract) {\r\n          baseAbstract = layer.Abstract;\r\n        } else if (!layer.Abstract && catalog.abstract) {\r\n          baseAbstract = catalog.abstract;\r\n        }\r\n\r\n        let metadataUrl = propertiesToForce?.metadataUrl || propertiesToForce?.metadataUrlAll;\r\n        let metadataAbstract = propertiesToForce?.metadataAbstract || propertiesToForce?.metadataAbstractAll || baseAbstract;\r\n\r\n        if (\r\n          !propertiesToForce?.metadataUrl &&\r\n          !propertiesToForce?.metadataUrlAll &&\r\n          (propertiesToForce?.metadataAbstract ||\r\n            propertiesToForce?.metadataAbstractAll)\r\n        ) {\r\n          extern = false;\r\n        }\r\n        if (propertiesToForce?.metadataAbstract && propertiesToForce?.metadataUrlAll) {\r\n          extern = false;\r\n        }\r\n\r\n        if (this.testLayerRegexes(layer.id, regexes) === false) {\r\n          return undefined;\r\n        }\r\n        const baseSourceOptions = {\r\n          type: TypeCatalog[catalog.type],\r\n          url: catalog.url,\r\n          crossOrigin: catalog.setCrossOriginAnonymous\r\n            ? 'anonymous'\r\n            : undefined,\r\n          layer: layer.id as string,\r\n          queryable: true,\r\n          queryFormat: 'esrijson',\r\n          matrixSet: catalog.matrixSet,\r\n          optionsFromCapabilities: true,\r\n          style: 'default'\r\n        } as ArcGISRestDataSourceOptions;\r\n        const sourceOptions = Object.assign(\r\n          {},\r\n          baseSourceOptions,\r\n          catalog.sourceOptions\r\n        ) as ArcGISRestDataSourceOptions;\r\n        return ObjectUtils.removeUndefined({\r\n          id: generateIdFromSourceOptions(sourceOptions),\r\n          type: CatalogItemType.Layer,\r\n          title: propertiesToForce?.title ? propertiesToForce.title : layer.name,\r\n          externalProvider: catalog.externalProvider,\r\n          address: catalog.id,\r\n          options: {\r\n            sourceOptions,\r\n            minResolution: getResolutionFromScale(layer.maxScale),\r\n            maxResolution: getResolutionFromScale(layer.minScale),\r\n            metadata: {\r\n              url: metadataUrl,\r\n              extern,\r\n              abstract: metadataAbstract,\r\n              type: baseSourceOptions.type\r\n            },\r\n          }\r\n        } as CatalogItem);\r\n      })\r\n      .filter((item: CatalogItemLayer | undefined) => item !== undefined);\r\n  }\r\n\r\n  private testLayerRegexes(layerName: string, regexes: RegExp[]): boolean {\r\n    if (regexes.length === 0) {\r\n      return true;\r\n    }\r\n    return regexes.find((regex: RegExp) => regex.test(layerName)) !== undefined;\r\n  }\r\n\r\n  private retrieveLayerInfoFormat(\r\n    layerNameFromCatalog: string,\r\n    layersQueryFormat: { layer: string; queryFormat: QueryFormat }[]\r\n  ): QueryFormat {\r\n    const currentLayerInfoFormat = layersQueryFormat.find(\r\n      (f) => f.layer === layerNameFromCatalog\r\n    );\r\n    const baseInfoFormat = layersQueryFormat.find((f) => f.layer === '*');\r\n    let queryFormat: QueryFormat;\r\n    if (currentLayerInfoFormat) {\r\n      queryFormat = currentLayerInfoFormat.queryFormat;\r\n    } else if (baseInfoFormat) {\r\n      queryFormat = baseInfoFormat.queryFormat;\r\n    }\r\n    return queryFormat;\r\n  }\r\n\r\n  private findCatalogInfoFormat(\r\n    catalog: Catalog\r\n  ): { layer: string; queryFormat: QueryFormat }[] {\r\n    const layersQueryFormat: { layer: string; queryFormat: QueryFormat }[] = [];\r\n    if (!catalog.queryFormat) {\r\n      return layersQueryFormat;\r\n    }\r\n    Object.keys(catalog.queryFormat).forEach((configuredInfoFormat) => {\r\n      if (catalog.queryFormat[configuredInfoFormat] instanceof Array) {\r\n        catalog.queryFormat[configuredInfoFormat].forEach((layerName) => {\r\n          if (\r\n            !layersQueryFormat.find((specific) => specific.layer === layerName)\r\n          ) {\r\n            layersQueryFormat.push({\r\n              layer: layerName,\r\n              queryFormat: configuredInfoFormat as QueryFormat\r\n            });\r\n          }\r\n        });\r\n      } else {\r\n        if (\r\n          !layersQueryFormat.find(\r\n            (specific) =>\r\n              specific.layer === catalog.queryFormat[configuredInfoFormat]\r\n          )\r\n        ) {\r\n          layersQueryFormat.push({\r\n            layer: catalog.queryFormat[configuredInfoFormat],\r\n            queryFormat: configuredInfoFormat as QueryFormat\r\n          });\r\n        }\r\n      }\r\n    });\r\n    return layersQueryFormat;\r\n  }\r\n}\r\n","<igo-list [navigation]=\"false\" [selection]=\"false\">\r\n  <ng-template ngFor let-item [ngForOf]=\"store.view.all$() | async\">\r\n    <ng-container *ngIf=\"isGroup(item)\">\r\n      <igo-catalog-browser-group\r\n        [catalog]=\"catalog\"\r\n        [group]=\"item\"\r\n        [state]=\"store.state\"\r\n        [resolution]=\"resolution$ | async\"\r\n        [catalogAllowLegend]=\"catalogAllowLegend\"\r\n        [collapsed]=\"(store.count === 1) ? false : true\"\r\n        [toggleCollapsed]=\"toggleCollapsedGroup\"\r\n        (addedChange)=\"onGroupAddedChange($event)\"\r\n        (layerAddedChange)=\"onLayerAddedChange($event)\">\r\n      </igo-catalog-browser-group>\r\n    </ng-container>\r\n\r\n    <ng-container *ngIf=\"isLayer(item)\">\r\n      <igo-catalog-browser-layer\r\n        igoListItem\r\n        [layer]=\"item\"\r\n        [resolution]=\"resolution$ | async\"\r\n        [catalogAllowLegend]=\"catalogAllowLegend\"\r\n        [added]=\"store.state.get(item).added\"\r\n        (addedChange)=\"onLayerAddedChange($event)\">\r\n      </igo-catalog-browser-layer>\r\n    </ng-container>\r\n  </ng-template>\r\n</igo-list>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { zip, BehaviorSubject } from 'rxjs';\r\n\r\nimport { EntityStore, EntityStoreWatcher } from '@igo2/common';\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { LayerService } from '../../layer/shared/layer.service';\r\nimport { IgoMap } from '../../map';\r\n\r\nimport {\r\n  Catalog,\r\n  CatalogItem,\r\n  CatalogItemLayer,\r\n  CatalogItemGroup,\r\n  CatalogItemState,\r\n  CatalogItemType\r\n} from '../shared';\r\n\r\n/**\r\n * Component to browse a catalog's groups and layers and display them on a map.\r\n */\r\n@Component({\r\n  selector: 'igo-catalog-browser',\r\n  templateUrl: './catalog-browser.component.html',\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class CatalogBrowserComponent implements OnInit, OnDestroy {\r\n  /**\r\n   * Catalog items store watcher\r\n   */\r\n  private watcher: EntityStoreWatcher<CatalogItem>;\r\n\r\n // private resolution$$: Subscription;\r\n\r\n  get resolution$(): BehaviorSubject<number> { return this.map.viewController.resolution$; }\r\n\r\n  @Input() catalogAllowLegend = false;\r\n\r\n  /**\r\n   * Catalog\r\n   */\r\n  @Input() catalog: Catalog;\r\n\r\n  /**\r\n   * Store holding the catalog's items\r\n   */\r\n  @Input() store: EntityStore<CatalogItem, CatalogItemState>;\r\n\r\n  /**\r\n   * Map to add the catalog items to\r\n   */\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * Whether a group can be toggled when it's collapsed\r\n   */\r\n  @Input() toggleCollapsedGroup: boolean = true;\r\n\r\n  constructor(\r\n    private layerService: LayerService,\r\n    private cdRef: ChangeDetectorRef\r\n  ) {}\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    const currentItems = this.map.layers.map((layer: Layer) => {\r\n      return {\r\n        id: layer.options.source.id,\r\n        title: layer.title,\r\n        type: CatalogItemType.Layer\r\n      };\r\n    });\r\n    this.store.state.updateMany(currentItems, { added: true }, true);\r\n    if (this.catalog && this.catalog.sortDirection !== undefined) {\r\n      this.store.view.sort({\r\n        direction: this.catalog.sortDirection,\r\n        valueAccessor: (item: CatalogItem) => item.title\r\n      });\r\n    }\r\n\r\n    const catalogShowLegend = this.catalog ? this.catalog.showLegend : false;\r\n    this.catalogAllowLegend = catalogShowLegend ? catalogShowLegend : this.catalogAllowLegend;\r\n\r\n    this.watcher = new EntityStoreWatcher(this.store, this.cdRef);\r\n\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.watcher.destroy();\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  isGroup(item: CatalogItem): boolean {\r\n    return item.type === CatalogItemType.Group;\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  isLayer(item: CatalogItem): boolean {\r\n    return item.type === CatalogItemType.Layer;\r\n  }\r\n\r\n  /**\r\n   * When a layer is added or removed, add or remove it from the map\r\n   * @internal\r\n   * @param event Layer added event\r\n   */\r\n  onLayerAddedChange(event: { added: boolean; layer: CatalogItemLayer }) {\r\n    const layer = event.layer;\r\n    this.store.state.update(layer, { added: event.added }, false);\r\n    event.added ? this.addLayerToMap(layer) : this.removeLayerFromMap(layer);\r\n  }\r\n\r\n  /**\r\n   * When a froup is added or removed, add or remove it from the map\r\n   * @internal\r\n   * @param event Group added event\r\n   */\r\n  onGroupAddedChange(event: { added: boolean; group: CatalogItemGroup }) {\r\n    const group = event.group;\r\n    this.store.state.update(group, { added: event.added }, false);\r\n    event.added ? this.addGroupToMap(group) : this.removeGroupFromMap(group);\r\n  }\r\n\r\n  /**\r\n   * Add layer to map\r\n   * @param layer Catalog layer\r\n   */\r\n  private addLayerToMap(layer: CatalogItemLayer) {\r\n    this.addLayersToMap([layer]);\r\n  }\r\n\r\n  /**\r\n   * Remove layer from map\r\n   * @param layer Catalog layer\r\n   */\r\n  private removeLayerFromMap(layer: CatalogItemLayer) {\r\n    this.removeLayersFromMap([layer]);\r\n  }\r\n\r\n  /**\r\n   * Add multiple layers to map\r\n   * @param layers Catalog layers\r\n   */\r\n  private addLayersToMap(layers: CatalogItemLayer[]) {\r\n    const layers$ = layers.map((layer: CatalogItemLayer) => {\r\n      if (!layer.options.sourceOptions.optionsFromApi) {\r\n        layer.options.sourceOptions.optionsFromApi = true;\r\n      }\r\n      return this.layerService.createAsyncLayer(layer.options);\r\n    });\r\n\r\n    zip(...layers$).subscribe((oLayers: Layer[]) => {\r\n      this.store.state.updateMany(layers, { added: true });\r\n      this.map.addLayers(oLayers);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Remove multiple layers from map\r\n   * @param layers Catalog layers\r\n   */\r\n  private removeLayersFromMap(layers: CatalogItemLayer[]) {\r\n    layers.forEach((layer: CatalogItemLayer) => {\r\n      this.store.state.update(layer, { added: false });\r\n      if (layer.options.baseLayer === true) {\r\n        const oLayer = this.map.getLayerById(layer.options.id);\r\n        if (oLayer !== undefined) {\r\n          this.map.removeLayer(oLayer);\r\n        }\r\n      } else {\r\n        const oLayer = this.map.getLayerById(layer.id);\r\n        if (oLayer !== undefined) {\r\n          this.map.removeLayer(oLayer);\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Sort the layers by title. asc or desc.\r\n   * @internal\r\n   */\r\n  private sortCatalogItemsByTitle(items: CatalogItem[], direction) {\r\n    const returnItem = items.sort((a, b) => {\r\n      const titleA = a.title.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n      const titleB = b.title.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n\r\n      if (titleA < titleB) {\r\n        return -1;\r\n      }\r\n      if (titleA > titleB) {\r\n        return 1;\r\n      }\r\n      return 0;\r\n    });\r\n    switch (direction) {\r\n      case 'asc':\r\n        return returnItem;\r\n      case 'desc':\r\n        return returnItem.reverse();\r\n      default:\r\n        return items;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add all the layers of a group to map\r\n   * @param group Catalog group\r\n   */\r\n  private addGroupToMap(group: CatalogItemGroup) {\r\n    let layers = group.items.filter((item: CatalogItem) => {\r\n      const added = this.store.state.get(item).added || false;\r\n      return this.isLayer(item) && added === false;\r\n    });\r\n    if (group.sortDirection !== undefined) {\r\n      layers = this.sortCatalogItemsByTitle(layers, group.sortDirection);\r\n    }\r\n    this.addLayersToMap(layers.reverse() as CatalogItemLayer[]);\r\n  }\r\n\r\n  /**\r\n   * Remove all the layers of a group from map\r\n   * @param group Catalog group\r\n   */\r\n  private removeGroupFromMap(group: CatalogItemGroup) {\r\n    const layers = group.items.filter((item: CatalogItem) => {\r\n      const added = this.store.state.get(item).added || false;\r\n      return this.isLayer(item) && added === true;\r\n    });\r\n    this.removeLayersFromMap(layers as CatalogItemLayer[]);\r\n  }\r\n}\r\n","<ng-container *ngIf=\"legendItems$ | async as items\">\r\n  <ng-container *ngIf=\"items.length; else noItems\">\r\n    <ng-container *ngFor=\"let item of items.slice().reverse()\" #renderedLegends>\r\n      <div *ngIf=\"getLegend; else noItems\">\r\n        <mat-list-item *ngIf=\"item.title\">\r\n          <mat-icon\r\n            id=\"legend-toggle\"\r\n            class=\"igo-chevron\"\r\n            mat-list-avatar\r\n            igoCollapse\r\n            [target]=\"legend\"\r\n            [collapsed]=\"(item.collapsed)\"\r\n            (toggle)=\"toggleLegendItem($event, item)\"\r\n            svgIcon=\"chevron-up\">\r\n          </mat-icon>\r\n          <h4 matLine>{{computeItemTitle(item) | async}} </h4>\r\n        </mat-list-item>\r\n        <div #legend class=\"igo-layer-legend\" [ngClass]=\"{'with-title': item.title}\">\r\n          <div *ngIf=\"currentStyle !== undefined\">\r\n              <mat-form-field>\r\n                <mat-select tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n                  [matTooltip]=\"'igo.geo.layer.legend.selectStyle' | translate\" [(ngModel)]=\"currentStyle\"\r\n                  (selectionChange)=\"onChangeStyle()\">\r\n                  <mat-option *ngFor=\"let style of styles\" [value]=\"style.name\">{{style.title}}</mat-option>\r\n                </mat-select>\r\n            </mat-form-field>\r\n          </div>\r\n          <div *ngIf=\"!(item.collapsed)\">\r\n            <div *ngIf=\"item.url\">\r\n              <img igoImageError *ngIf=\"item.imgGraphValue\" hideError=\"true\" #renderedLegend id=\"{{item.title}}\" (load)=\"onLoadImage(item.title)\"\r\n                [src]=\"item.imgGraphValue\"\r\n                alt=\"{{'igo.geo.layer.legend.loadingLegendText' | translate}}\">\r\n              <small *ngIf=\"imagesHeight[item.title]<16\">\r\n                  {{'igo.geo.layer.legend.noLegendScale' | translate}}\r\n              </small>\r\n            </div>\r\n            <div\r\n              [ngStyle]=\"item.style\"\r\n              [innerHTML]=\"item.html | sanitizeHtml\"\r\n              *ngIf=\"item.html\">\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </ng-container>\r\n  </ng-container>\r\n\r\n  <ng-template #noItems>\r\n    <small>\r\n      {{'igo.geo.layer.legend.noLegendText' | translate}}\r\n    </small>\r\n  </ng-template>\r\n\r\n</ng-container>\r\n","import { HttpClient } from '@angular/common/http';\r\nimport { Component, Input, OnInit, OnDestroy, ChangeDetectionStrategy, ViewChildren, ElementRef, ChangeDetectorRef } from '@angular/core';\r\nimport type { QueryList } from '@angular/core';\r\n\r\nimport { Subscription, BehaviorSubject, of, Observable } from 'rxjs';\r\n\r\nimport { Legend } from '../../datasource/shared/datasources/datasource.interface';\r\nimport { Layer, ItemStyleOptions } from '../shared/layers';\r\nimport { LegendMapViewOptions } from '../shared/layers/layer.interface';\r\nimport { CapabilitiesService } from '../../datasource/shared/capabilities.service';\r\nimport { catchError, map } from 'rxjs/operators';\r\nimport { LanguageService, ConfigService } from '@igo2/core';\r\nimport { WMSDataSource, WMSDataSourceOptions } from '../../datasource';\r\nimport { SecureImagePipe } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'igo-layer-legend',\r\n  templateUrl: './layer-legend.component.html',\r\n  styleUrls: ['./layer-legend.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class LayerLegendComponent implements OnInit, OnDestroy {\r\n\r\n  @Input() updateLegendOnResolutionChange: boolean = false;\r\n\r\n  /**\r\n   * Observable of the legend items\r\n   */\r\n  legendItems$: BehaviorSubject<Legend[]> = new BehaviorSubject([]);\r\n\r\n  /**\r\n   * Subscription to the map's resolution\r\n   */\r\n  private state$$: Subscription;\r\n\r\n  /**\r\n   * The available styles\r\n   */\r\n  public styles;\r\n\r\n  /**\r\n   * The style used to make the legend\r\n   */\r\n  public currentStyle;\r\n\r\n  /**\r\n   * The scale used to make the legend\r\n   */\r\n  private scale: number = undefined;\r\n\r\n  /**\r\n   * The extent used to make the legend\r\n   */\r\n  private view: LegendMapViewOptions = undefined;\r\n  /**\r\n   * Get list of images display\r\n   */\r\n  @ViewChildren('renderedLegend') renderedLegends: QueryList<ElementRef>;\r\n\r\n  /**\r\n   * List of size of images displayed\r\n   */\r\n  public imagesHeight: { [srcKey: string]: number } = {};\r\n\r\n  /**\r\n   * Layer\r\n   */\r\n  @Input() layer: Layer;\r\n\r\n  /**\r\n   * if getLegendGraphic is authorized\r\n   */\r\n  public getLegend = true;\r\n\r\n  /**\r\n   * activeLegend\r\n   */\r\n\r\n  constructor(\r\n    private capabilitiesService: CapabilitiesService,\r\n    private languageService: LanguageService,\r\n    private configService: ConfigService,\r\n    private http: HttpClient,\r\n    private cdRef: ChangeDetectorRef) {}\r\n\r\n  /**\r\n   * On init, subscribe to the map's resolution and update the legend accordingly\r\n   */\r\n  ngOnInit() {\r\n    let lastlLegend = this.layer.legend;\r\n    this.styles = this.listStyles();\r\n    const sourceOptions = this.layer.options.source.options as any;\r\n    if (sourceOptions && sourceOptions.params && sourceOptions.params.STYLES) {\r\n      // if a styles is provided into the layers wms params\r\n      this.currentStyle = this.styles.find(style => style.name === sourceOptions.params.STYLES).name;\r\n    } else if (!lastlLegend) {\r\n      // if no legend is manually provided\r\n      if (this.styles && this.styles.length > 1) {\r\n        this.currentStyle = this.styles[0].name;\r\n      }\r\n    } else if (this.styles && this.styles.length > 1) {\r\n      this.currentStyle = lastlLegend[0].currentStyle;\r\n    }\r\n    if (typeof this.layer.options.legendOptions !== 'undefined' && this.layer.options.legendOptions.display === false) {\r\n      lastlLegend = [];\r\n    } else {\r\n      lastlLegend = this.layer.dataSource.getLegend(this.currentStyle, this.view);\r\n    }\r\n\r\n    if (this.updateLegendOnResolutionChange || (sourceOptions as WMSDataSourceOptions).contentDependentLegend) {\r\n      const state$ = this.layer.map.viewController.state$;\r\n      this.state$$ = state$.subscribe(() => this.onViewControllerStateChange());\r\n    } else if (lastlLegend && lastlLegend.length !== 0) {\r\n      this.legendItems$.next(lastlLegend);\r\n      for (const legend of lastlLegend) {\r\n        this.getLegendGraphic(legend);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * On destroy, unsubscribe to the map's view state\r\n   */\r\n  ngOnDestroy() {\r\n    if (this.state$$ !== undefined) {\r\n      this.state$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  getLegendGraphic(item: Legend) {\r\n    if (item.url) {\r\n      const secureIMG = new SecureImagePipe(this.http, this.configService);\r\n      secureIMG.transform(item.url).pipe(\r\n        catchError((err) => {\r\n          if (err.error) {\r\n            err.error.caught = true;\r\n            this.getLegend = false;\r\n            this.cdRef.detectChanges();\r\n            return err;\r\n          }\r\n        })\r\n        ).subscribe(obsLegGraph => {\r\n          const idx = this.legendItems$.value.findIndex(leg => leg.title === item.title);\r\n          const legendGraph = obsLegGraph as string;\r\n          this.legendItems$.value[idx].imgGraphValue = legendGraph;\r\n          this.cdRef.detectChanges();\r\n        }\r\n      );\r\n    }\r\n  }\r\n\r\n  toggleLegendItem(collapsed: boolean, item: Legend) {\r\n    item.collapsed = collapsed;\r\n  }\r\n\r\n  private transfertToggleLegendItem(newLegends: Legend[]): Legend[] {\r\n    const outLegends: Legend[] = newLegends;\r\n    const lastLegends = this.layer.legend;\r\n    for (let i = 0; i < lastLegends.length; i++) {\r\n      outLegends[i].collapsed = lastLegends[i].collapsed;\r\n   }\r\n    return outLegends;\r\n  }\r\n\r\n  computeItemTitle(layerLegend): Observable<string> {\r\n    const layerOptions = this.layer.dataSource.options as any;\r\n    if (layerOptions.type !== 'wms') {\r\n      return of(layerLegend.title);\r\n    }\r\n\r\n    const layers = layerOptions.params.LAYERS.split(',');\r\n    const localLayerOptions = JSON.parse(JSON.stringify(layerOptions)); // to avoid to alter the original options.\r\n    localLayerOptions.params.LAYERS = layers.find(layer => layer === layerLegend.title);\r\n    return this.capabilitiesService\r\n      .getWMSOptions(localLayerOptions)\r\n      .pipe(map(wmsDataSourceOptions => {\r\n        return wmsDataSourceOptions._layerOptionsFromSource.title;\r\n      }));\r\n  }\r\n\r\n  /**\r\n   * On resolution change, compute the effective scale level and update the\r\n   * legend accordingly.\r\n   * @param resolution Map resolution\r\n   */\r\n  private onViewControllerStateChange() {\r\n    this.view = {\r\n      resolution: this.layer.map.viewController.getResolution(),\r\n      extent: this.layer.map.viewController.getExtent(),\r\n      projection: this.layer.map.viewController.getOlProjection().getCode(),\r\n      scale: this.layer.map.viewController.getScale(),\r\n      size: this.layer.map.ol.getSize()\r\n    } as LegendMapViewOptions;\r\n    this.updateLegend();\r\n  }\r\n\r\n  /**\r\n   * Update the legend with scale level and style define\r\n   */\r\n  private updateLegend() {\r\n    let legendItems = this.layer.dataSource.getLegend(this.currentStyle, this.view);\r\n    if (this.layer.legend && this.layer.legend.length > 1) { legendItems = this.transfertToggleLegendItem(legendItems); }\r\n    this.layer.legend = legendItems;\r\n\r\n    if (legendItems.length === 0 && this.legendItems$.value.length === 0) {\r\n      return;\r\n    }\r\n    this.legendItems$.next(legendItems);\r\n    for (const legend of this.legendItems$.value) {\r\n      this.getLegendGraphic(legend);\r\n    }\r\n  }\r\n\r\n  private listStyles() {\r\n    const layerOptions = this.layer.options;\r\n    if (layerOptions && layerOptions.legendOptions) {\r\n      const translate = this.languageService.translate;\r\n      const title = translate.instant('igo.geo.layer.legend.default');\r\n      let stylesAvailable = [{ name: '', title } as ItemStyleOptions];\r\n      if (layerOptions.legendOptions.stylesAvailable) {\r\n        stylesAvailable = stylesAvailable.concat(layerOptions.legendOptions.stylesAvailable.filter(sA => (\r\n          sA.name.normalize('NFD').replace(/[\\u0300-\\u036f]/gi, '') !== 'default' &&\r\n          sA.name.normalize('NFD').replace(/[\\u0300-\\u036f]/gi, '') !== 'defaut')));\r\n      }\r\n      stylesAvailable.filter(sa => !sa.title).map((sa) => sa.title = sa.name);\r\n      stylesAvailable.map(s => s.title = s.title.charAt(0).toUpperCase() + s.title.slice(1).replace(/_/g, ' '));\r\n      return stylesAvailable;\r\n    }\r\n    return ;\r\n  }\r\n\r\n  onChangeStyle() {\r\n    this.updateLegend();\r\n    let STYLES = '';\r\n    if (this.layer.dataSource instanceof WMSDataSource) {\r\n      this.layer.dataSource.ol.getParams().LAYERS.split(',').map(layer =>\r\n        STYLES += this.currentStyle + ','\r\n      );\r\n      STYLES = STYLES.slice(0, -1);\r\n      this.layer.dataSource.ol.updateParams({ STYLES });\r\n    }\r\n  }\r\n\r\n  onLoadImage(id: string) {\r\n    let elemRef: HTMLImageElement;\r\n    if (this.renderedLegends.length === 1) {\r\n      elemRef = this.renderedLegends.first.nativeElement as HTMLImageElement;\r\n    } else {\r\n      elemRef = this.renderedLegends.find(renderedLegend => renderedLegend.nativeElement.id === id).nativeElement as HTMLImageElement;\r\n    }\r\n    this.imagesHeight[id] = elemRef.height;\r\n  }\r\n}\r\n","<mat-list-item>\r\n  <mat-icon *ngIf=\"haveGroup()\" mat-list-avatar svgIcon=\"blank\"></mat-icon>\r\n  <h4 mat-line matTooltipShowDelay=\"500\" [ngClass]=\"(catalogAllowLegend)?'igo-cataloglayer-title':''\" (click)=\"askForLegend($event)\" [matTooltip]=\"computeTitleTooltip()\">{{title}}</h4>\r\n\r\n    <button *ngIf=\"layer.externalProvider\"\r\n      disabled=\"true\"\r\n      mat-icon-button>\r\n    <mat-icon\r\n      class=\"igo-cataloglayer-external-icon\"\r\n      *ngIf=\"layer.externalProvider\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.catalog.externalProvider.layer' | translate\"\r\n      color=\"primary\"\r\n      (click)=\"$event.stopPropagation()\"\r\n      svgIcon=\"earth-arrow-right\">\r\n    </mat-icon>\r\n  </button>\r\n  <igo-metadata-button [layer]=\"layer\"></igo-metadata-button>\r\n\r\n  <button\r\n    (mouseenter)=\"onMouseEvent($event)\" (mouseleave)=\"onMouseEvent($event)\"\r\n    mat-icon-button\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"computeTooltip() | translate\"\r\n    [color]=\"(isPreview$ | async) ? '' : added ? 'warn' : ''\"\r\n    (click)=\"onToggleClick($event)\">\r\n    <mat-icon\r\n       matBadge=\"icon\"\r\n       igoMatBadgeIcon=\"eye-off\"\r\n       igoMatBadgeInverseColor=\"true\"\r\n       [matBadgeHidden]=\"isInResolutionsRange()\"\r\n       matBadgeDisabled=\"true\"\r\n       matBadgeSize=\"small\"\r\n       matBadgePosition=\"after\"\r\n       [svgIcon]=\"(isPreview$ | async) ? 'plus' : added ? 'delete' : 'plus'\">\r\n    </mat-icon>\r\n  </button>\r\n\r\n</mat-list-item>\r\n\r\n<div #legend class=\"igo-cataloglayer-legend-container\">\r\n  <igo-layer-legend\r\n    *ngIf=\"(layerLegendShown$ | async) && (igoLayer$ | async) && catalogAllowLegend\"\r\n    [layer]=\"igoLayer$ | async\">\r\n  </igo-layer-legend>\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  Output,\r\n  EventEmitter,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { getEntityTitle, getEntityIcon } from '@igo2/common';\r\n\r\nimport { CatalogItemLayer } from '../shared';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport { LayerService } from '../../layer/shared/layer.service';\r\nimport { first } from 'rxjs/operators';\r\nimport { Layer, TooltipType } from '../../layer/shared/layers';\r\nimport { MetadataLayerOptions } from '../../metadata/shared/metadata.interface';\r\n\r\n/**\r\n * Catalog browser layer item\r\n */\r\n@Component({\r\n  selector: 'igo-catalog-browser-layer',\r\n  templateUrl: './catalog-browser-layer.component.html',\r\n  styleUrls: ['./catalog-browser-layer.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class CatalogBrowserLayerComponent implements OnInit, OnDestroy {\r\n  public inRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n  public isPreview$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  private isPreview$$: Subscription;\r\n  private lastTimeoutRequest;\r\n\r\n  public layerLegendShown$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  public igoLayer$ = new BehaviorSubject<Layer>(undefined);\r\n\r\n  private mouseInsideAdd: boolean = false;\r\n\r\n  @Input() resolution: number;\r\n\r\n  @Input() catalogAllowLegend = false;\r\n\r\n  /**\r\n   * Catalog layer\r\n   */\r\n  @Input() layer: CatalogItemLayer;\r\n\r\n  /**\r\n   * Whether the layer is already added to the map\r\n   */\r\n  @Input() added = false;\r\n\r\n  /**\r\n   * Event emitted when the add/remove button is clicked\r\n   */\r\n  @Output() addedChange = new EventEmitter<{\r\n    added: boolean;\r\n    layer: CatalogItemLayer;\r\n  }>();\r\n\r\n  @Output() addedLayerIsPreview = new EventEmitter<boolean>();\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get title(): string {\r\n    return getEntityTitle(this.layer);\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get icon(): string {\r\n    return getEntityIcon(this.layer) || 'layers';\r\n  }\r\n\r\n  constructor(private layerService: LayerService ) {}\r\n\r\n  ngOnInit(): void {\r\n    this.isInResolutionsRange();\r\n    this.isPreview$$ = this.isPreview$.subscribe(value => this.addedLayerIsPreview.emit(value));\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.isPreview$$.unsubscribe();\r\n  }\r\n\r\n  computeTitleTooltip(): string {\r\n      const layerOptions = this.layer.options;\r\n      if (!layerOptions.tooltip) {\r\n        return getEntityTitle(this.layer);\r\n      }\r\n      const layerTooltip = layerOptions.tooltip;\r\n      const layerMetadata = (layerOptions as MetadataLayerOptions).metadata;\r\n      switch (layerOptions.tooltip.type) {\r\n        case TooltipType.TITLE:\r\n          return this.layer.title;\r\n        case TooltipType.ABSTRACT:\r\n          if (layerMetadata && layerMetadata.abstract) {\r\n            return layerMetadata.abstract;\r\n          } else {\r\n            return this.layer.title;\r\n          }\r\n        case TooltipType.CUSTOM:\r\n          if (layerTooltip && layerTooltip.text) {\r\n            return layerTooltip.text;\r\n          } else {\r\n            return this.layer.title;\r\n          }\r\n        default:\r\n          return this.layer.title;\r\n      }\r\n  }\r\n\r\n  /**\r\n   * On mouse event, mouseenter /mouseleave\r\n   * @internal\r\n   */\r\n  onMouseEvent(event) {\r\n    this.onToggleClick(event);\r\n  }\r\n\r\n  askForLegend(event) {\r\n    this.layerLegendShown$.next(!this.layerLegendShown$.value);\r\n    this.layerService.createAsyncLayer(this.layer.options).pipe(first())\r\n    .subscribe(layer => this.igoLayer$.next(layer));\r\n  }\r\n\r\n  /**\r\n   * On toggle button click, emit the added change event\r\n   * @internal\r\n   */\r\n  onToggleClick(event) {\r\n    if (typeof this.lastTimeoutRequest !== 'undefined') {\r\n      clearTimeout(this.lastTimeoutRequest);\r\n    }\r\n    if (event.type === 'mouseenter' && this.mouseInsideAdd ) {\r\n      return;\r\n    }\r\n    switch (event.type) {\r\n      case 'click':\r\n        if (!this.isPreview$.value) {\r\n          if (this.added) {\r\n            this.remove();\r\n          } else {\r\n            this.add();\r\n          }\r\n        }\r\n        this.isPreview$.next(false);\r\n        break;\r\n      case 'mouseenter':\r\n        if (!this.isPreview$.value && !this.added) {\r\n          this.lastTimeoutRequest = setTimeout(() => {\r\n            this.add();\r\n            this.isPreview$.next(true);\r\n          }, 500);\r\n        }\r\n        this.mouseInsideAdd = true;\r\n        break;\r\n      case 'mouseleave':\r\n        if (this.isPreview$.value) {\r\n          this.remove();\r\n          this.isPreview$.next(false);\r\n        }\r\n        this.mouseInsideAdd = false;\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Emit added change event with added = true\r\n   */\r\n  private add() {\r\n    if (!this.added) {\r\n      this.added = true;\r\n      this.addedChange.emit({ added: true, layer: this.layer });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Emit added change event with added = false\r\n   */\r\n  private remove() {\r\n    if (this.added) {\r\n      this.added = false;\r\n      this.addedChange.emit({ added: false, layer: this.layer });\r\n    }\r\n  }\r\n\r\n  haveGroup(): boolean {\r\n    return !(!this.layer.address || this.layer.address.split('.').length === 1);\r\n  }\r\n\r\n  isInResolutionsRange(): boolean {\r\n    const minResolution = this.layer.options.minResolution || 0;\r\n    const maxResolution = this.layer.options.maxResolution || Infinity;\r\n    this.inRange$.next(\r\n      this.resolution >= minResolution && this.resolution <= maxResolution\r\n    );\r\n    return this.inRange$.value;\r\n  }\r\n\r\n  computeTooltip(): string {\r\n    if (this.added) {\r\n      return this.isPreview$.value\r\n        ? 'igo.geo.catalog.layer.addToMap'\r\n        : this.inRange$.value\r\n        ? 'igo.geo.catalog.layer.removeFromMap'\r\n        : 'igo.geo.catalog.layer.removeFromMapOutRange';\r\n    } else {\r\n      return this.inRange$.value\r\n        ? 'igo.geo.catalog.layer.addToMap'\r\n        : 'igo.geo.catalog.layer.addToMapOutRange';\r\n    }\r\n  }\r\n}\r\n","<mat-list-item>\r\n  <mat-icon\r\n    mat-list-avatar\r\n    svgIcon=\"chevron-up\"\r\n    igoCollapse\r\n    class=\"igo-chevron\"\r\n    [target]=\"items\"\r\n    [collapsed]=\"collapsed\"\r\n    (toggle)=\"onToggleCollapsed($event)\">\r\n  </mat-icon>\r\n\r\n  <h4 class=\"igo-catalog-group-title\" id=\"catalog-group-title\" mat-line matTooltipShowDelay=\"500\" [matTooltip]=\"title\" (click)=\"onTitleClick()\">{{title}}</h4>\r\n\r\n  <button *ngIf=\"group.externalProvider\"\r\n    disabled=\"true\"\r\n    mat-icon-button>\r\n    <mat-icon\r\n      class=\"igo-cataloggroup-external-icon\"\r\n      *ngIf=\"group.externalProvider\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.catalog.externalProvider.group' | translate\"\r\n      color=\"primary\"\r\n      (click)=\"$event.stopPropagation()\"\r\n      svgIcon=\"earth-arrow-right\">\r\n    </mat-icon>\r\n  </button>\r\n\r\n  <ng-container *ngIf=\"(added$ | async) && (preview$ | async) === false; else notadded\">\r\n    <button\r\n      mat-icon-button\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.catalog.group.removeFromMap' | translate\"\r\n      color=\"warn\"\r\n      [disabled]=\"disabled$ | async\"\r\n      (click)=\"onToggleClick()\">\r\n      <mat-icon svgIcon=\"delete\"></mat-icon>\r\n    </button>\r\n  </ng-container>\r\n\r\n  <ng-template #notadded>\r\n    <button\r\n      mat-icon-button\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.catalog.group.addToMap' | translate\"\r\n      [disabled]=\"disabled$ | async\"\r\n      (click)=\"onToggleClick()\">\r\n      <mat-icon svgIcon=\"plus\"></mat-icon>\r\n    </button>\r\n  </ng-template>\r\n</mat-list-item>\r\n\r\n<div #items>\r\n  <ng-template ngFor let-item [ngForOf]=\"store.view.all$() | async\">\r\n    <ng-container *ngIf=\"isGroup(item)\">\r\n      <!-- todo: add display ans manage CatalogItemGroup -->\r\n    </ng-container>\r\n    <ng-container *ngIf=\"isLayer(item)\">\r\n      <igo-catalog-browser-layer\r\n        igoListItem\r\n        [layer]=\"item\"\r\n        [resolution]=\"resolution\"\r\n        [catalogAllowLegend]=\"catalogAllowLegend\"\r\n        [added]=\"state.get(item).added\"\r\n        (addedLayerIsPreview)=\"onLayerPreview($event)\"\r\n        (addedChange)=\"onLayerAddedChange($event)\">\r\n      </igo-catalog-browser-layer>\r\n    </ng-container>\r\n  </ng-template>\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { EntityStore } from '@igo2/common';\r\nimport type { EntityStateManager } from '@igo2/common';\r\n\r\nimport {\r\n  Catalog,\r\n  CatalogItem,\r\n  CatalogItemGroup,\r\n  CatalogItemLayer,\r\n  CatalogItemState,\r\n  CatalogItemType\r\n} from '../shared';\r\n\r\n/**\r\n * Catalog browser group item\r\n */\r\n@Component({\r\n  selector: 'igo-catalog-browser-group',\r\n  templateUrl: './catalog-browser-group.component.html',\r\n  styleUrls: ['./catalog-browser-group.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class CatalogBrowserGroupComponent implements OnInit, OnDestroy {\r\n\r\n  /**\r\n   * Group's items store\r\n   * @internal\r\n   */\r\n  store = new EntityStore<CatalogItem, CatalogItemState>([]);\r\n\r\n  /**\r\n   * Whether all the layers of the group are added\r\n   * @internal\r\n   */\r\n  added$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  preview$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  /**\r\n   * Whether the toggle button is disabled\r\n   * @internal\r\n   */\r\n  disabled$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  /**\r\n   * Catalog\r\n   */\r\n  @Input() catalog: Catalog;\r\n\r\n  /**\r\n   * Catalog group\r\n   */\r\n  @Input() group: CatalogItemGroup;\r\n\r\n  /**\r\n   * Whether the group is collapsed\r\n   */\r\n  @Input() collapsed: boolean = true;\r\n\r\n  @Input() resolution: number;\r\n\r\n  @Input() catalogAllowLegend = false;\r\n\r\n  /**\r\n   * Whether the group can be toggled when it's collapsed\r\n   */\r\n  @Input() toggleCollapsed: boolean = true;\r\n\r\n  /**\r\n   * Parent catalog's items store state. Groups share a unique\r\n   * EntityState that tracks the group and it's layers state (whether they are added or not).\r\n   * Sharing a unique state would also allow us to expand this component to allow\r\n   * the selection of a layer while unselecting any layer already selected in another group.\r\n   * This could be useful to display some layer info before adding it, for example.\r\n   */\r\n  @Input() state: EntityStateManager<CatalogItem, CatalogItemState>;\r\n\r\n  /**\r\n   * Event emitted when the add/remove button of the group is clicked\r\n   */\r\n  @Output() addedChange = new EventEmitter<{\r\n    added: boolean;\r\n    group: CatalogItemGroup;\r\n  }>();\r\n\r\n  /**\r\n   * Event emitted when the add/remove button of a layer is clicked\r\n   */\r\n  @Output() layerAddedChange = new EventEmitter<{\r\n    added: boolean;\r\n    layer: CatalogItemLayer;\r\n  }>();\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get title(): string {\r\n    return this.group.title;\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.store.load(this.group.items);\r\n    this.evaluateAdded();\r\n    this.evaluateDisabled(this.collapsed);\r\n    if (this.group.sortDirection !== undefined) {\r\n      this.store.view.sort({\r\n        direction: this.group.sortDirection,\r\n        valueAccessor: (item: CatalogItem) => item.title\r\n        });\r\n    }\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.store.destroy();\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  isGroup(item: CatalogItem): boolean {\r\n    return item.type === CatalogItemType.Group;\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  isLayer(item: CatalogItem): boolean {\r\n    return item.type === CatalogItemType.Layer;\r\n  }\r\n\r\n  /**\r\n   * On toggle button click, emit the added change event\r\n   * @internal\r\n   */\r\n  onToggleClick() {\r\n    this.added$.value ? this.remove() : this.add();\r\n  }\r\n\r\n  /**\r\n   * On toggle button click, emit the added change event\r\n   * @internal\r\n   */\r\n  onToggleCollapsed(collapsed: boolean) {\r\n    this.evaluateDisabled(collapsed);\r\n  }\r\n\r\n  /**\r\n   * When a layer is added or removed, evaluate if all the layers of the group\r\n   * are now added or removed. If so, consider that the group itself is added\r\n   * or removed.\r\n   * @internal\r\n   * @param event Layer added change event\r\n   */\r\n  onLayerAddedChange(event: { added: boolean; layer: CatalogItemLayer }) {\r\n    this.layerAddedChange.emit(event);\r\n    this.tryToggleGroup(event);\r\n  }\r\n\r\n  /**\r\n   * Emit added change event with added = true\r\n   */\r\n  private add() {\r\n    this.added$.next(true);\r\n    this.addedChange.emit({\r\n      added: true,\r\n      group: this.group\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Emit added change event with added = true\r\n   */\r\n  private remove() {\r\n    this.added$.next(false);\r\n    this.addedChange.emit({\r\n      added: false,\r\n      group: this.group\r\n    });\r\n  }\r\n\r\n  onLayerPreview(event) {\r\n    this.preview$.next(event);\r\n  }\r\n\r\n  /**\r\n   * If all the layers of the group added or removed, add or remove the group itself.\r\n   * @param event The last layer added change event to occur\r\n   */\r\n  private tryToggleGroup(event: { added: boolean; layer: CatalogItemLayer }) {\r\n    const added = event.added;\r\n    const layer = event.layer;\r\n\r\n    const layersAdded = this.store.view\r\n      .all()\r\n      .filter((item: CatalogItem) => item.id !== layer.id)\r\n      .map((item: CatalogItem) => this.state.get(item).added || false);\r\n\r\n    if (layersAdded.every(value => value === added)) {\r\n      added ? this.add() : this.remove();\r\n    } else if (this.added$.value === true) {\r\n      this.added$.next(false);\r\n    }\r\n  }\r\n\r\n  private evaluateAdded() {\r\n    const added = this.store.all().every((item: CatalogItem) => {\r\n      return (this.state.get(item).added || false) === true;\r\n    });\r\n    this.added$.next(added);\r\n  }\r\n\r\n  private evaluateDisabled(collapsed: boolean) {\r\n    let disabled = false;\r\n    if (this.toggleCollapsed === false) {\r\n      disabled = collapsed;\r\n    }\r\n    this.disabled$.next(disabled);\r\n  }\r\n\r\n  onTitleClick() {\r\n    this.collapsed = !this.collapsed;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class LayerListToolService {\r\n  public keyword: string;\r\n  public sortAlpha = false;\r\n  public onlyVisible = false;\r\n  public onlyInRange = false;\r\n  public keywordInitialized = false;\r\n  public sortedAlphaInitialized = false;\r\n  public onlyVisibleInitialized = false;\r\n  public onlyInRangeInitialized = false;\r\n\r\n  constructor() {}\r\n\r\n}\r\n","<mat-list-item class= \"igo-layer-list-item\">\r\n  <mat-checkbox *ngIf=\"selectionMode\"\r\n    class=\"layerCheck\"\r\n    mat-list-icon\r\n    (change)=\"check()\"\r\n    [checked]=\"layerCheck\">\r\n  </mat-checkbox>\r\n  <h4 (click)=\"toggleLegendOnClick()\" matLine class=\"igo-layer-title\" [matTooltip]=\"tooltipText\" matTooltipShowDelay=\"500\">{{layer.title}}</h4>\r\n\r\n  <button *ngIf=\"!selectionMode\"\r\n    mat-icon-button\r\n    [color]=\"layer.visible ? 'primary' : 'default'\"\r\n    collapsibleButton\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"eyeTooltip | translate\"\r\n    (click)=\"toggleVisibility()\">\r\n    <mat-icon\r\n      matBadge=\"?\"\r\n      matBadgeColor=\"accent\"\r\n      matBadgeSize=\"small\"\r\n      matBadgePosition=\"after\"\r\n      [matBadgeHidden]=\"queryBadgeHidden$ | async\"\r\n      [ngClass]=\"{disabled: (inResolutionRange$ | async)===false}\"\r\n      [svgIcon]=\"(layer.visible$ | async) ? 'eye' : 'eye-off'\">\r\n    </mat-icon>\r\n  </button>\r\n\r\n  <button *ngIf=\"selectionMode\" class=\"selection-eye\"\r\n  mat-icon-button\r\n  [color]=\"layer.visible ? 'primary' : 'default'\"\r\n  collapsibleButton\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"layer.visible ?\r\n                ('igo.geo.layer.hideLayer' | translate) :\r\n                ('igo.geo.layer.showLayer' | translate)\"\r\n  (click)=\"toggleVisibility()\">\r\n  <mat-icon\r\n    matBadge=\"?\"\r\n    matBadgeColor=\"accent\"\r\n    matBadgeSize=\"small\"\r\n    matBadgePosition=\"after\"\r\n    [matBadgeHidden]=\"queryBadgeHidden$ | async\"\r\n    [ngClass]=\"{disabled: (inResolutionRange$ | async)===false}\"\r\n    [svgIcon]=\"layer.visible ? 'eye' : 'eye-off'\">\r\n  </mat-icon>\r\n</button>\r\n\r\n  <button *ngIf=\"!selectionMode\"\r\n    class=\"actions-button\"\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]= \"'igo.geo.layer.moreOptions' | translate\"\r\n    mat-icon-button\r\n    color=\"primary\"\r\n    (click)=\"toggleLayerTool()\">\r\n    <mat-icon svgIcon=\"dots-horizontal\"></mat-icon>\r\n  </button>\r\n</mat-list-item>\r\n\r\n<div #legend class=\"igo-layer-legend-container\">\r\n  <igo-layer-legend\r\n    *ngIf=\"showLegend$ | async\"\r\n    [layer]=\"layer\"\r\n    [updateLegendOnResolutionChange]=\"updateLegendOnResolutionChange\">\r\n  </igo-layer-legend>\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy,\r\n  Output,\r\n  EventEmitter,\r\n  Renderer2,\r\n  ElementRef,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\nimport { Subscription, BehaviorSubject } from 'rxjs';\r\n\r\nimport { MetadataLayerOptions } from '../../metadata/shared/metadata.interface';\r\nimport { layerIsQueryable } from '../../query/shared/query.utils';\r\nimport { Layer, TooltipType } from '../shared/layers';\r\nimport { NetworkService, ConnectionState } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'igo-layer-item',\r\n  templateUrl: './layer-item.component.html',\r\n  styleUrls: ['./layer-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class LayerItemComponent implements OnInit, OnDestroy {\r\n  public focusedCls = 'igo-layer-item-focused';\r\n\r\n  @Input()\r\n  get activeLayer() {\r\n    return this._activeLayer;\r\n  }\r\n  set activeLayer(value) {\r\n    if (value && this.layer && value.id === this.layer.id && !this.selectionMode) {\r\n      this.layerTool$.next(true);\r\n      this.renderer.addClass(this.elRef.nativeElement, this.focusedCls);\r\n    } else {\r\n      this.renderer.removeClass(this.elRef.nativeElement, this.focusedCls);\r\n    }\r\n  }\r\n  private _activeLayer;\r\n\r\n  layerTool$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  showLegend$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  inResolutionRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  queryBadgeHidden$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  tooltipText: string;\r\n\r\n  state: ConnectionState;\r\n\r\n  @Input()\r\n  get selectAll() {\r\n    return this._selectAll;\r\n  }\r\n  set selectAll(value: boolean) {\r\n    this._selectAll = value;\r\n    if (value === true) {\r\n      this.layerCheck = true;\r\n    }\r\n  }\r\n  private _selectAll = false;\r\n\r\n  @Input() layerCheck;\r\n\r\n  private resolution$$: Subscription;\r\n  private network$$: Subscription;\r\n  private layers$$: Subscription;\r\n\r\n  layers$: BehaviorSubject<Layer> = new BehaviorSubject<Layer>(undefined);\r\n\r\n  @Input()\r\n  get layer() {\r\n    return this._layer;\r\n  }\r\n  set layer(value) {\r\n    this._layer = value;\r\n    this.layers$.next(value);\r\n  }\r\n  private _layer;\r\n\r\n  @Input() toggleLegendOnVisibilityChange: boolean = false;\r\n\r\n  @Input() expandLegendIfVisible: boolean = false;\r\n\r\n  @Input() updateLegendOnResolutionChange: boolean = false;\r\n\r\n  @Input() orderable: boolean = true;\r\n\r\n  @Input() lowerDisabled: boolean = false;\r\n\r\n  @Input() raiseDisabled: boolean = false;\r\n\r\n  @Input() queryBadge: boolean = false;\r\n\r\n  @Input() selectionMode;\r\n\r\n  @Input() changeDetection;\r\n\r\n  get opacity() {\r\n    return this.layer.opacity * 100;\r\n  }\r\n  set opacity(opacity: number) {\r\n    this.layer.opacity = opacity / 100;\r\n  }\r\n\r\n  get eyeTooltip() {\r\n    if (this.inResolutionRange$.getValue() === false) {\r\n      return 'igo.geo.layer.notInResolution';\r\n    } else {\r\n      return this.layer.visible ? 'igo.geo.layer.hideLayer' : 'igo.geo.layer.showLayer';\r\n    }\r\n  }\r\n\r\n  @Output() action: EventEmitter<Layer> = new EventEmitter<Layer>(undefined);\r\n  @Output() checkbox = new EventEmitter<{\r\n    layer: Layer;\r\n    check: boolean;\r\n  }>();\r\n\r\n  constructor(\r\n    private networkService: NetworkService,\r\n    private renderer: Renderer2,\r\n    private elRef: ElementRef,\r\n    private cdRef: ChangeDetectorRef) {}\r\n\r\n  ngOnInit() {\r\n    if (\r\n      this.layer.visible &&\r\n      this.expandLegendIfVisible &&\r\n      this.layer.firstLoadComponent === true\r\n    ) {\r\n      this.layer.firstLoadComponent = false;\r\n      this.layer.legendCollapsed = false;\r\n    }\r\n    this.toggleLegend(this.layer.legendCollapsed);\r\n    this.updateQueryBadge();\r\n\r\n    const resolution$ = this.layer.map.viewController.resolution$;\r\n    this.resolution$$ = resolution$.subscribe(() => {\r\n      this.onResolutionChange();\r\n    });\r\n    this.tooltipText = this.computeTooltip();\r\n\r\n    this.network$$ = this.networkService.currentState().subscribe((state: ConnectionState) => {\r\n      this.state = state;\r\n      this.onResolutionChange();\r\n    });\r\n\r\n    this.layers$$ = this.layers$.subscribe(() => {\r\n      if (this.layer && this.layer.options.active) {\r\n        this.layerTool$.next(true);\r\n        this.renderer.addClass(this.elRef.nativeElement, this.focusedCls);\r\n      }\r\n    });\r\n\r\n    if (this.changeDetection) {\r\n      this.changeDetection.subscribe(() => this.cdRef.detectChanges());\r\n    }\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.resolution$$.unsubscribe();\r\n    this.network$$.unsubscribe();\r\n    this.layers$$.unsubscribe();\r\n  }\r\n\r\n  toggleLegend(collapsed: boolean) {\r\n    this.layer.legendCollapsed = collapsed;\r\n    this.showLegend$.next(!collapsed);\r\n  }\r\n\r\n  toggleLegendOnClick() {\r\n    this.toggleLegend(this.showLegend$.value);\r\n  }\r\n\r\n  toggleVisibility() {\r\n    this.layer.visible = !this.layer.visible;\r\n    if (this.toggleLegendOnVisibilityChange) {\r\n      this.toggleLegend(!this.layer.visible);\r\n    }\r\n    this.updateQueryBadge();\r\n  }\r\n\r\n  computeTooltip(): string {\r\n    const layerOptions = this.layer.options;\r\n    if (!layerOptions.tooltip) {\r\n      return this.layer.title;\r\n    }\r\n    const layerTooltip = layerOptions.tooltip;\r\n    const layerMetadata = (layerOptions as MetadataLayerOptions).metadata;\r\n    switch (layerOptions.tooltip.type) {\r\n      case TooltipType.TITLE:\r\n        return this.layer.title;\r\n      case TooltipType.ABSTRACT:\r\n        if (layerMetadata && layerMetadata.abstract) {\r\n          return layerMetadata.abstract;\r\n        } else {\r\n          return this.layer.title;\r\n        }\r\n      case TooltipType.CUSTOM:\r\n        if (layerTooltip && layerTooltip.text) {\r\n          return layerTooltip.text;\r\n        } else {\r\n          return this.layer.title;\r\n        }\r\n      default:\r\n        return this.layer.title;\r\n    }\r\n  }\r\n\r\n  private onResolutionChange() {\r\n    const inResolutionRange = this.layer.isInResolutionsRange;\r\n    if (\r\n      inResolutionRange === false &&\r\n      this.updateLegendOnResolutionChange === true\r\n    ) {\r\n      this.toggleLegend(true);\r\n    }\r\n    this.inResolutionRange$.next(inResolutionRange);\r\n  }\r\n\r\n  private updateQueryBadge() {\r\n    const hidden =\r\n      this.queryBadge === false ||\r\n      this.layer.visible === false ||\r\n      !layerIsQueryable(this.layer);\r\n    this.queryBadgeHidden$.next(hidden);\r\n  }\r\n\r\n  toggleLayerTool() {\r\n    this.layerTool$.next(!this.layerTool$.getValue());\r\n    if (this.layerTool$.getValue() === true) {\r\n      this.renderer.addClass(this.elRef.nativeElement, this.focusedCls);\r\n    } else {\r\n      this.renderer.removeClass(this.elRef.nativeElement, this.focusedCls);\r\n    }\r\n    this.action.emit(this.layer);\r\n  }\r\n\r\n  public check() {\r\n    this.layerCheck = !this.layerCheck;\r\n    this.checkbox.emit({layer: this.layer, check: this.layerCheck});\r\n  }\r\n}\r\n","export enum LayerListControlsEnum {\r\n  always = 'always',\r\n  never = 'never',\r\n  default = 'default'\r\n}\r\nexport enum LayerListSelectVisibleEnum {\r\n  ALL_VISIBLE = 'ALL_VISIBLE',\r\n  ALL_HIDDEN = 'ALL_HIDDEN',\r\n  MIXED = 'MIXED',\r\n  NULL = 'NULL'\r\n}\r\n\r\nexport enum LayerListDisplacement {\r\n  Raise = 'raise',\r\n  Lower = 'lower',\r\n}\r\n","<mat-list>\r\n  <igo-layer-list-tool *ngIf=\"showToolbar$ | async\"\r\n    floatLabel=\"auto\"\r\n    [layersAreAllVisible]=\"layersAreAllVisible\"\r\n    [term]=\"layerFilterAndSortOptions.keyword\"\r\n    [onlyVisible]=\"layerFilterAndSortOptions.onlyVisible\"\r\n    [sortAlpha]=\"layerFilterAndSortOptions.sortAlpha\"\r\n    (appliedFilterAndSort)=\"onAppliedFilterAndSortChange($event)\"\r\n    (selection)=\"toggleSelectionMode($event)\">\r\n  </igo-layer-list-tool>\r\n</mat-list>\r\n\r\n<mat-list-item *ngIf=\"selection\" class=\"select-all\">\r\n  <mat-checkbox\r\n    class=\"select-all-checkbox mat-subheading-2\"\r\n    [color]=\"!selectAllCheck && layersChecked.length > 0 ? 'accent' : 'primary'\"\r\n    (change)=\"selectAll()\"\r\n    [checked]=\"selectAllCheck\"\r\n    [indeterminate]=\"!selectAllCheck && layersChecked.length > 0\"> {{selectAllCheck ? ('igo.geo.layer.deselectAll' | translate) : ('igo.geo.layer.selectAll' | translate)}}\r\n  </mat-checkbox>\r\n</mat-list-item>\r\n<mat-divider></mat-divider>\r\n\r\n<igo-list #igoList [ngClass]=\"{'igo-list-tools-multi': selection, 'igo-list-tools-single': (layerTool && !selection), 'igo-list-no-tools': (!layerTool && !selection)}\" [navigation]=\"false\" [selection]=\"false\">\r\n  <ng-template ngFor let-layer let-i=\"index\" [ngForOf]=\"layers$ | async\">\r\n    <igo-layer-item *ngIf=\"!(excludeBaseLayers && layer.baseLayer)\"\r\n      igoListItem\r\n      [layer]=\"layer\"\r\n      [activeLayer]=\"activeLayer\"\r\n      [orderable]=\"orderable && !layer.baseLayer\"\r\n      [lowerDisabled]=\"getLowerLayer().id === layer.id\"\r\n      [raiseDisabled]=\"getUpperLayer().id === layer.id\"\r\n      [queryBadge]=\"queryBadge\"\r\n      [expandLegendIfVisible]=\"expandLegendOfVisibleLayers\"\r\n      [updateLegendOnResolutionChange]=\"updateLegendOnResolutionChange\"\r\n      [toggleLegendOnVisibilityChange]=\"toggleLegendOnVisibilityChange\"\r\n      [selectionMode]=\"selection\"\r\n      [selectAll]=\"selectAllCheck\"\r\n      [layerCheck]=\"layer.options.check\"\r\n      [changeDetection]=\"layerItemChangeDetection$\"\r\n      (action)=\"toggleLayerTool($event)\"\r\n      (checkbox)=\"layersCheck($event)\">\r\n    </igo-layer-item>\r\n  </ng-template>\r\n</igo-list>\r\n\r\n<igo-panel *ngIf=\"!selection && layerTool && activeLayer\" class=\"igo-layer-actions-container\" [title]=\"activeLayer.title\">\r\n  <div class=\"igo-layer-button-group\">\r\n    <button\r\n      *ngIf=\"isLayerRemovable(activeLayer)\"\r\n      class=\"delete-button\"\r\n      mat-icon-button\r\n      color=\"warn\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.layer.removeLayer' | translate\"\r\n      (click)=\"removeLayers()\">\r\n      <mat-icon svgIcon=\"delete\"></mat-icon>\r\n    </button>\r\n\r\n    <button\r\n      class=\"down-button\"\r\n      mat-icon-button\r\n      color=\"primary\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"(sortAlpha || onlyVisible || keyword) ? ('igo.geo.layer.filterLowerLayer' | translate) : ('igo.geo.layer.lowerLayer' | translate)\"\r\n      [disabled]=\"lowerDisabled\"\r\n      (click)=\"moveActiveLayer(activeLayer,layerListDisplacement.Lower, true)\">\r\n      <mat-icon [matBadge]=\"(sortAlpha || onlyVisible || keyword) ? '!' : ''\" matBadgeColor=\"warn\" matBadgeSize=\"medium\" [matBadgeHidden]=\"lowerDisabled\"\r\n                svgIcon=\"arrow-down\"></mat-icon>\r\n    </button>\r\n\r\n    <button\r\n      class=\"up-button\"\r\n      color=\"primary\"\r\n      mat-icon-button\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"(sortAlpha || onlyVisible || keyword) ? ('igo.geo.layer.filterRaiseLayer' | translate) : ('igo.geo.layer.raiseLayer' | translate)\"\r\n      [disabled]=\"raiseDisabled\"\r\n      (click)=\"moveActiveLayer(activeLayer,layerListDisplacement.Raise, true)\">\r\n      <mat-icon [matBadge]=\"(sortAlpha || onlyVisible || keyword) ? '!' : ''\" matBadgeColor=\"warn\" matBadgeSize=\"medium\" [matBadgeHidden]=\"raiseDisabled\"\r\n                svgIcon=\"arrow-up\"></mat-icon>\r\n    </button>\r\n\r\n    <!-- <label>{{ 'igo.geo.layer.opacity' | translate }} </label> -->\r\n    <button\r\n      class=\"opacity-button\"\r\n      color=\"primary\"\r\n      mat-icon-button\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matMenuTriggerFor]=\"opacityMenu\"\r\n      [matTooltip]=\"'igo.geo.layer.opacity' | translate\">\r\n      <mat-icon [matBadge]=\"badgeOpacity\" matBadgeColor=\"primary\" matBadgeSize=\"medium\" svgIcon=\"opacity\"></mat-icon>\r\n    </button>\r\n\r\n    <mat-menu #opacityMenu=\"matMenu\" class=\"mat-menu-opacity-slider\">\r\n      <div id=\"opacity-menu\">\r\n        <mat-slider\r\n          id=\"opacity-slider\"\r\n          color=\"primary\"\r\n          thumbLabel\r\n          tickInterval=\"5\"\r\n          step=\"5\"\r\n          [min]=\"0\"\r\n          [max]=\"100\"\r\n          [value]=\"opacity\"\r\n          (input)=\"changeOpacity($event)\"\r\n          [matTooltip]=\"'igo.geo.layer.opacity' | translate\"\r\n          (click) = \"$event.stopPropagation()\"\r\n          matTooltipShowDelay=\"500\"\r\n          tooltip-position=\"below\">\r\n        </mat-slider>\r\n      </div>\r\n    </mat-menu>\r\n\r\n    <button\r\n      *ngIf=\"activeLayerExtentIsValid(activeLayer)\"\r\n      class=\"zoomLayer-button\"\r\n      color=\"primary\"\r\n      mat-icon-button\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.layer.zoomLayer' | translate\"\r\n      (click)=\"zoomLayerExtents(activeLayer)\">\r\n      <mat-icon matBadgeColor=\"primary\" matBadgeSize=\"medium\" svgIcon=\"magnify-scan\"></mat-icon>\r\n    </button>\r\n\r\n    <ng-container igoLayerItemToolbar\r\n      [ngTemplateOutlet]=\"templateLayerToolbar\"\r\n      [ngTemplateOutletContext]=\"{layer: activeLayer}\">\r\n    </ng-container>\r\n\r\n    <ng-content select=\"[igoLayerItemToolbar]\"></ng-content>\r\n  </div>\r\n</igo-panel>\r\n\r\n<igo-panel *ngIf=\"selection && layers.length > 0\" class=\"igo-layer-actions-container\" [title]=\"'igo.geo.layer.tools' | translate\">\r\n  <div class=\"actions-buttons-multi\">\r\n    <button\r\n      class=\"delete-button\"\r\n      mat-icon-button\r\n      color=\"warn\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [disabled]=\"layersChecked.length === 0\"\r\n      [matTooltip]=\"isAllLayersRemovable(layersChecked) ? ('igo.geo.layer.removeSelectedLayers' | translate) : 'igo.geo.layer.removeSelectedLayersRestriction' | translate\"\r\n      (click)=\"removeLayers(layersChecked)\">\r\n      <mat-icon [matBadge]=\"'!'\" matBadgeColor=\"warn\" matBadgeSize=\"medium\" [matBadgeHidden]=\"isAllLayersRemovable(layersChecked)\"\r\n                svgIcon=\"delete\"></mat-icon>\r\n    </button>\r\n\r\n    <button\r\n      class=\"eye-button\"\r\n      mat-icon-button\r\n      color=\"primary\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [disabled]=\"layersChecked.length === 0\"\r\n      [matTooltip]=\"statusSelectedLayersCheck === 'ALL_HIDDEN' ? ('igo.geo.layer.showSelectedLayers' | translate) : ('igo.geo.layer.hideSelectedLayers' | translate)\"\r\n      (click)=\"toggleVisibility(layersChecked)\">\r\n      <mat-icon\t[svgIcon]=\"(statusSelectedLayersCheck === 'ALL_HIDDEN') ? 'eye-off' : 'eye'\"></mat-icon>\r\n    </button>\r\n\r\n    <button\r\n      class=\"down-button\"\r\n      mat-icon-button\r\n      color=\"primary\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"(sortAlpha || onlyVisible || keyword) ? ('igo.geo.layer.filterLowerLayer' | translate) : ('igo.geo.layer.lowerLayer' | translate)\"\r\n      [disabled]=\"lowerDisabledSelection\"\r\n      (click)=\"lowerLayers(layersChecked)\">\r\n      <mat-icon [matBadge]=\"(sortAlpha || onlyVisible || keyword) ? '!' : ''\" matBadgeColor=\"warn\" matBadgeSize=\"medium\" [matBadgeHidden]=\"lowerDisabledSelection\"\r\n                svgIcon=\"arrow-down\"></mat-icon>\r\n    </button>\r\n\r\n    <button\r\n      class=\"up-button\"\r\n      color=\"primary\"\r\n      mat-icon-button\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"(sortAlpha || onlyVisible || keyword) ? ('igo.geo.layer.filterRaiseLayer' | translate) : ('igo.geo.layer.raiseLayer' | translate)\"\r\n      [disabled]=\"raiseDisabledSelection\"\r\n      (click)=\"raiseLayers(layersChecked)\">\r\n      <mat-icon [matBadge]=\"(sortAlpha || onlyVisible || keyword) ? '!' : ''\" matBadgeColor=\"warn\" matBadgeSize=\"medium\" [matBadgeHidden]=\"raiseDisabledSelection\"\r\n                svgIcon=\"arrow-up\"></mat-icon>\r\n    </button>\r\n\r\n    <button\r\n      class=\"opacity-button\"\r\n      color=\"primary\"\r\n      mat-icon-button\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [disabled]=\"layersChecked.length === 0\"\r\n      [matMenuTriggerFor]=\"opacityMenu\"\r\n      [matTooltip]=\"'igo.geo.layer.opacity' | translate\">\r\n      <mat-icon svgIcon=\"opacity\"></mat-icon>\r\n    </button>\r\n\r\n    <mat-menu #opacityMenu=\"matMenu\"  class=\"mat-menu-opacity-slider\">\r\n      <div id=\"opacity-menu\">\r\n        <mat-slider *ngIf=\"layersChecked.length\"\r\n          id=\"opacity-slider\"\r\n          color=\"primary\"\r\n          thumbLabel\r\n          tickInterval=\"5\"\r\n          step=\"5\"\r\n          [min]=\"0\"\r\n          [max]=\"100\"\r\n          [(ngModel)]=\"checkOpacity\"\r\n          [matTooltip]=\"'igo.geo.layer.opacity' | translate\"\r\n          matTooltipShowDelay=\"500\"\r\n          tooltip-position=\"below\"\r\n          (click) = \"$event.stopPropagation()\">\r\n        </mat-slider>\r\n      </div>\r\n    </mat-menu>\r\n\r\n    <button\r\n    *ngIf=\"layersChecked.length !== 0 && activeLayersExtentAreValid(layersChecked)\"\r\n      class=\"zoomLayer-button\"\r\n      color=\"primary\"\r\n      mat-icon-button\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.layer.zoomLayers' | translate\"\r\n      (click)=\"zoomLayersExtents(layersChecked)\">\r\n      <mat-icon svgIcon=\"magnify-scan\"></mat-icon>\r\n    </button>\r\n  </div>\r\n</igo-panel>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  ContentChild,\r\n  OnInit,\r\n  OnDestroy,\r\n  Output,\r\n  EventEmitter,\r\n  ElementRef\r\n} from '@angular/core';\r\nimport type { TemplateRef } from '@angular/core';\r\n\r\nimport scrollIntoView from 'scroll-into-view-if-needed';\r\n\r\nimport { FloatLabelType } from '@angular/material/form-field';\r\nimport { LayerListControlsEnum, LayerListDisplacement } from './layer-list.enum';\r\nimport { LayerListSelectVisibleEnum } from './layer-list.enum';\r\nimport {\r\n  BehaviorSubject,\r\n  ReplaySubject,\r\n  Subscription,\r\n  EMPTY,\r\n  timer\r\n} from 'rxjs';\r\nimport { debounce } from 'rxjs/operators';\r\nimport {\r\n  MetadataOptions,\r\n  MetadataLayerOptions\r\n} from '../../metadata/shared/metadata.interface';\r\nimport { LayerListControlsOptions } from '../layer-list-tool/layer-list-tool.interface';\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { Layer } from '../shared/layers/layer';\r\nimport { LinkedProperties } from '../shared/layers/layer.interface';\r\nimport { MatSliderChange } from '@angular/material/slider';\r\nimport * as olextent from 'ol/extent';\r\nimport { getAllChildLayersByProperty, getRootParentByProperty } from '../../map/shared/linkedLayers.utils';\r\n\r\n// TODO: This class could use a clean up. Also, some methods could be moved ealsewhere\r\n@Component({\r\n  selector: 'igo-layer-list',\r\n  templateUrl: './layer-list.component.html',\r\n  styleUrls: ['./layer-list.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class LayerListComponent implements OnInit, OnDestroy {\r\n  orderable = true;\r\n  thresholdToFilterAndSort = 5;\r\n\r\n  layers$: BehaviorSubject<Layer[]> = new BehaviorSubject([]);\r\n\r\n  change$ = new ReplaySubject<void>(1);\r\n\r\n  showToolbar$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  public layerTool: boolean;\r\n\r\n  public hideSelectedLayers: boolean = true;\r\n  activeLayer$: BehaviorSubject<Layer> = new BehaviorSubject(undefined);\r\n\r\n  layersChecked: Layer[] = [];\r\n  public selection: boolean;\r\n\r\n  private change$$: Subscription;\r\n  private layers$$: Subscription;\r\n  public layerItemChangeDetection$ = new BehaviorSubject(undefined);\r\n\r\n  @ContentChild('igoLayerItemToolbar', /* TODO: add static flag */ {})\r\n  templateLayerToolbar: TemplateRef<any>;\r\n\r\n  @Input() layersAreAllVisible: boolean = true;\r\n\r\n  @Input() ogcButton: boolean = true;\r\n\r\n  @Input() timeButton: boolean = true;\r\n\r\n  @Input()\r\n  get map(): IgoMap {\r\n    return this._map;\r\n  }\r\n  set map(value: IgoMap) {\r\n    this._map = value;\r\n  }\r\n  private _map: IgoMap;\r\n\r\n  @Input()\r\n  set layers(value: Layer[]) {\r\n    this._layers = this.removeProblemLayerInList(value);\r\n    this.next();\r\n  }\r\n  get layers(): Layer[] {\r\n    return this._layers;\r\n  }\r\n  private _layers: Layer[];\r\n\r\n  set activeLayer(value: Layer) {\r\n    this._activeLayer = value;\r\n    this.activeLayer$.next(value);\r\n  }\r\n  get activeLayer(): Layer {\r\n    return this._activeLayer;\r\n  }\r\n  private _activeLayer: Layer;\r\n\r\n  @Input() floatLabel: FloatLabelType = 'auto';\r\n\r\n  @Input() layerFilterAndSortOptions: LayerListControlsOptions = {};\r\n\r\n  @Input() excludeBaseLayers: boolean = false;\r\n\r\n  @Input() toggleLegendOnVisibilityChange: boolean = false;\r\n\r\n  @Input() expandLegendOfVisibleLayers: boolean = false;\r\n\r\n  @Input() updateLegendOnResolutionChange: boolean = false;\r\n\r\n  @Input() queryBadge: boolean = false;\r\n\r\n  @Output() appliedFilterAndSort = new EventEmitter<LayerListControlsOptions>();\r\n\r\n  get keyword(): string {\r\n    return this._keyword;\r\n  }\r\n  set keyword(value: string) {\r\n    this._keyword = value;\r\n    this.next();\r\n  }\r\n  private _keyword = undefined;\r\n\r\n  get onlyVisible(): boolean {\r\n    return this._onlyVisible;\r\n  }\r\n  set onlyVisible(value: boolean) {\r\n    this._onlyVisible = value;\r\n    this.next();\r\n  }\r\n  private _onlyVisible = false;\r\n\r\n  get sortAlpha(): boolean {\r\n    return this._sortedAlpha;\r\n  }\r\n  set sortAlpha(value: boolean) {\r\n    this._sortedAlpha = value;\r\n    this.next();\r\n  }\r\n  private _sortedAlpha = false;\r\n\r\n  get opacity() {\r\n    return Math.round(this.activeLayer$.getValue().opacity * 100);\r\n  }\r\n  set opacity(opacity: number) {\r\n    this.activeLayer$.getValue().opacity = opacity / 100;\r\n  }\r\n\r\n  get badgeOpacity() {\r\n    if (this.opacity === 100) {\r\n      return;\r\n    }\r\n    return this.opacity;\r\n  }\r\n\r\n  get raiseDisabled(): boolean {\r\n    if (\r\n      !this.orderable ||\r\n      this.activeLayer.baseLayer ||\r\n      this.getUpperLayer().id === this.activeLayer.id ||\r\n      this.isUpperBaselayer(this.activeLayer)\r\n    ) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  get lowerDisabled(): boolean {\r\n    if (\r\n      !this.orderable ||\r\n      this.activeLayer.baseLayer ||\r\n      this.getLowerLayer().id === this.activeLayer.id ||\r\n      this.isLowerBaselayer(this.activeLayer)\r\n    ) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  get raiseDisabledSelection(): boolean {\r\n    if (\r\n      this.layersChecked.length === 0 ||\r\n      !this.orderable ||\r\n      !this.raisableLayers(this.layersChecked) ||\r\n      this.selectAllCheck === true\r\n    ) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  get lowerDisabledSelection(): boolean {\r\n    if (\r\n      this.layersChecked.length === 0 ||\r\n      !this.orderable ||\r\n      !this.lowerableLayers(this.layersChecked) ||\r\n      this.selectAllCheck === true\r\n    ) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  get checkOpacity() {\r\n    return this.layersCheckedOpacity() * 100;\r\n  }\r\n  set checkOpacity(opacity: number) {\r\n    for (const layer of this.layersChecked) {\r\n      layer.opacity = opacity / 100;\r\n    }\r\n  }\r\n\r\n  get layerListDisplacement(): typeof LayerListDisplacement {\r\n    return LayerListDisplacement;\r\n  }\r\n\r\n  public toggleOpacity = false;\r\n\r\n  public selectAllCheck: boolean;\r\n  public selectAllCheck$ = new BehaviorSubject<boolean>(undefined);\r\n  private selectAllCheck$$: Subscription;\r\n\r\n  constructor(private elRef: ElementRef) { }\r\n\r\n  /**\r\n   * Subscribe to the search term stream and trigger researches\r\n   * @internal\r\n   */\r\n  ngOnInit(): void {\r\n    this.change$$ = this.change$\r\n      .pipe(\r\n        debounce(() => {\r\n          return this.layers.length === 0 ? EMPTY : timer(50);\r\n        })\r\n      )\r\n      .subscribe(() => {\r\n        this.showToolbar$.next(this.computeShowToolbar());\r\n        this.layers$.next(this.computeLayers(this.layers.slice(0)));\r\n        this.appliedFilterAndSort.emit({\r\n          keyword: this.keyword,\r\n          sortAlpha: this.sortAlpha,\r\n          onlyVisible: this.onlyVisible\r\n        });\r\n      });\r\n\r\n    this.selectAllCheck$$ = this.selectAllCheck$.subscribe((value) => {\r\n      this.selectAllCheck = value;\r\n    });\r\n\r\n    this.layers$$ = this.layers$.subscribe(() => {\r\n      if (this.layers) {\r\n        let checks = 0;\r\n        for (const layer of this.layers) {\r\n          layer.status$.subscribe(valStatus => {\r\n            if (valStatus === 0) {\r\n              this.map.removeLayer(layer);\r\n            }\r\n          });\r\n          if (layer.options.active) {\r\n            this.activeLayer = layer;\r\n            this.layerTool = true;\r\n          }\r\n          if (layer.options.check) {\r\n            checks += 1;\r\n          }\r\n        }\r\n        if (this.excludeBaseLayers) {\r\n          this.selectAllCheck =\r\n            checks ===\r\n              this.layers.filter(\r\n                (lay) => lay.baseLayer !== true && lay.showInLayerList\r\n              ).length\r\n              ? true\r\n              : false;\r\n        } else {\r\n          this.selectAllCheck =\r\n            checks === this.layers.filter((lay) => lay.showInLayerList).length\r\n              ? true\r\n              : false;\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.change$$.unsubscribe();\r\n    this.selectAllCheck$$.unsubscribe();\r\n    this.layers$$.unsubscribe();\r\n  }\r\n\r\n  activeLayerExtentIsValid(layer: Layer): boolean {\r\n    let valid = false;\r\n    if (layer.options.showButtonZoomToExtent === false) {\r\n      return false;\r\n    }\r\n    const layerExtent = layer.options.extent;\r\n    const maxLayerZoomExtent = this.map.viewController.maxLayerZoomExtent;\r\n\r\n    if (layerExtent) {\r\n      if (maxLayerZoomExtent) {\r\n        valid = olextent.containsExtent(maxLayerZoomExtent, layerExtent);\r\n      } else {\r\n        valid = true;\r\n      }\r\n    }\r\n    return valid;\r\n  }\r\n\r\n  activeLayersExtentAreValid(layers: Layer[]): boolean {\r\n    let valid = false;\r\n    const layersExtent = olextent.createEmpty();\r\n    const maxLayerZoomExtent = this.map.viewController.maxLayerZoomExtent;\r\n\r\n    for (const layer of layers) {\r\n      const layerExtent = layer.options.extent;\r\n\r\n      if (layerExtent && !layerExtent.includes(Infinity)) {\r\n        olextent.extend(layersExtent, layerExtent);\r\n      }\r\n    }\r\n\r\n    if (!olextent.isEmpty(layersExtent)) {\r\n      if (maxLayerZoomExtent) {\r\n        valid = (olextent.containsExtent(maxLayerZoomExtent, layersExtent));\r\n      } else {\r\n        valid = true;\r\n      }\r\n    }\r\n    return valid;\r\n  }\r\n\r\n  zoomLayerExtents(layer: Layer) {\r\n    this.map.viewController.zoomToExtent(layer.options.extent);\r\n  }\r\n\r\n  zoomLayersExtents(layers: Layer[]) {\r\n    const layersExtent = olextent.createEmpty() as [number, number, number, number];\r\n\r\n    for (const layer of layers) {\r\n      const layerExtent = layer.options.extent;\r\n\r\n      if (layerExtent) {\r\n        olextent.extend(layersExtent, layerExtent);\r\n      }\r\n    }\r\n    this.map.viewController.zoomToExtent(layersExtent);\r\n  }\r\n\r\n  changeOpacity(event: MatSliderChange){\r\n    this.opacity = event.value;\r\n  }\r\n\r\n  clearKeyword() {\r\n    this.keyword = undefined;\r\n  }\r\n\r\n  getLowerLayer() {\r\n    return this.layers\r\n      .filter((l) => !l.baseLayer)\r\n      .reduce(\r\n        (prev, current) => {\r\n          return prev.zIndex < current.zIndex ? prev : current;\r\n        },\r\n        { zIndex: undefined, id: undefined }\r\n      );\r\n  }\r\n\r\n  isLowerBaselayer(layer) {\r\n    const index = this.layers.findIndex((lay) => layer.id === lay.id);\r\n    if (\r\n      this.layers &&\r\n      this.layers[index + 1] &&\r\n      this.layers[index + 1].baseLayer === true\r\n    ) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  getUpperLayer() {\r\n    return this.layers\r\n      .filter((l) => !l.baseLayer)\r\n      .reduce(\r\n        (prev, current) => {\r\n          return prev.zIndex > current.zIndex ? prev : current;\r\n        },\r\n        { zIndex: undefined, id: undefined }\r\n      );\r\n  }\r\n\r\n  isUpperBaselayer(layer) {\r\n    const index = this.layers.findIndex((lay) => layer.id === lay.id);\r\n    if (\r\n      this.layers &&\r\n      this.layers[index - 1] &&\r\n      this.layers[index - 1].baseLayer === true\r\n    ) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  moveActiveLayer(activeLayer: Layer, actiontype: LayerListDisplacement, fromUi: boolean = false) {\r\n    const sortedLayersToMove = [];\r\n    getRootParentByProperty(this.map,activeLayer,LinkedProperties.ZINDEX);\r\n    let rootParentByProperty = getRootParentByProperty(this.map,activeLayer,LinkedProperties.ZINDEX);\r\n    if (!rootParentByProperty) {\r\n      rootParentByProperty = activeLayer;\r\n    }\r\n    const layersToMove = [rootParentByProperty];\r\n    getAllChildLayersByProperty(this.map, rootParentByProperty, layersToMove, LinkedProperties.ZINDEX);\r\n\r\n    this.layers.map(layer => {\r\n      if (layersToMove.indexOf(layer) !== -1) {\r\n        sortedLayersToMove.push(layer);\r\n      }\r\n    });\r\n\r\n    if (actiontype === LayerListDisplacement.Raise) {\r\n      this.raiseLayers(sortedLayersToMove, fromUi);\r\n    } else if (actiontype === LayerListDisplacement.Lower) {\r\n      this.lowerLayers(sortedLayersToMove, fromUi);\r\n    }\r\n  }\r\n\r\n  /*\r\n   * For selection mode disabled attribute\r\n   */\r\n  raisableLayers(layers: Layer[]) {\r\n    let response = false;\r\n    let base = 0;\r\n    for (const layer of layers) {\r\n      const mapIndex = this.layers.findIndex((lay) => layer.id === lay.id);\r\n      const currentLayer = this.layers[mapIndex];\r\n      if (currentLayer.baseLayer) {\r\n        base += 1;\r\n      }\r\n\r\n      const previousLayer = this.layers[mapIndex - 1];\r\n      if (\r\n        previousLayer &&\r\n        previousLayer.baseLayer !== true &&\r\n        !layers.find((lay) => previousLayer.id === lay.id) &&\r\n        currentLayer.baseLayer !== true\r\n      ) {\r\n        response = true;\r\n      }\r\n    }\r\n\r\n    if (\r\n      (this.layersChecked.length === 1 && this.layersChecked[0].baseLayer) ||\r\n      base === this.layersChecked.length\r\n    ) {\r\n      response = false;\r\n    }\r\n    return response;\r\n  }\r\n\r\n  /*\r\n   * When multiple layers is selected but some may be allow to move\r\n   */\r\n  raisableLayer(index: number) {\r\n    if (index < 1) {\r\n      return false;\r\n    }\r\n\r\n    if (this.layers[index - 1].options.check) {\r\n      return this.raisableLayer(index - 1);\r\n    }\r\n    return true;\r\n  }\r\n\r\n  raiseLayers(layers: Layer[], fromUi: boolean = true) {\r\n    const layersToRaise = [];\r\n    for (const layer of layers) {\r\n      const index = this.layers.findIndex((lay) => lay.id === layer.id);\r\n      if (this.raisableLayer(index)) {\r\n        layersToRaise.push(layer);\r\n      }\r\n    }\r\n    this.map.raiseLayers(layersToRaise);\r\n    if (fromUi) {\r\n      setTimeout(() => {\r\n        const checkItems = this.elRef.nativeElement.getElementsByClassName('mat-checkbox-checked');\r\n        const itemFocused = this.elRef.nativeElement.getElementsByClassName('igo-layer-item-focused');\r\n        let targetToScroll;\r\n        if (checkItems.length) {\r\n          targetToScroll = checkItems[0];\r\n        }\r\n        if (itemFocused.length) {\r\n          targetToScroll = itemFocused[0];\r\n        }\r\n        if (targetToScroll) {\r\n          scrollIntoView(targetToScroll, {\r\n            scrollMode: 'if-needed',\r\n            behavior: 'smooth',\r\n            block: 'end',\r\n            inline: 'nearest'\r\n          });\r\n        }\r\n      }, 100);\r\n    }\r\n  }\r\n  /*\r\n   * For selection mode disabled attribute\r\n   */\r\n  lowerableLayers(layers: Layer[]) {\r\n    let response = false;\r\n    let base = 0;\r\n    for (const layer of layers) {\r\n      const mapIndex = this.layers.findIndex((lay) => layer.id === lay.id);\r\n      const currentLayer = this.layers[mapIndex];\r\n      if (currentLayer.baseLayer) {\r\n        base += 1;\r\n      }\r\n\r\n      const nextLayer = this.layers[mapIndex + 1];\r\n      if (\r\n        nextLayer &&\r\n        nextLayer.baseLayer !== true &&\r\n        !layers.find((lay) => nextLayer.id === lay.id)\r\n      ) {\r\n        response = true;\r\n      }\r\n    }\r\n\r\n    if (\r\n      (this.layersChecked.length === 1 && this.layersChecked[0].baseLayer) ||\r\n      base === this.layersChecked.length\r\n    ) {\r\n      response = false;\r\n    }\r\n    return response;\r\n  }\r\n\r\n  /*\r\n   * When multiple layers is selected but some may be allow to move\r\n   */\r\n  lowerableLayer(index: number) {\r\n    if (\r\n      index >\r\n      this.layers.filter((lay) => lay.baseLayer !== true).length - 2\r\n    ) {\r\n      return false;\r\n    }\r\n\r\n    if (this.layers[index + 1].options.check) {\r\n      return this.lowerableLayer(index + 1);\r\n    }\r\n    return true;\r\n  }\r\n\r\n  lowerLayers(layers: Layer[], fromUi: boolean = true) {\r\n    const layersToLower = [];\r\n    for (const layer of layers) {\r\n      const index = this.layers.findIndex((lay) => lay.id === layer.id);\r\n      if (this.lowerableLayer(index)) {\r\n        layersToLower.push(layer);\r\n      }\r\n    }\r\n    this.map.lowerLayers(layersToLower);\r\n    if (fromUi) {\r\n      setTimeout(() => {\r\n        const checkItems = this.elRef.nativeElement.getElementsByClassName('mat-checkbox-checked');\r\n        const itemFocused = this.elRef.nativeElement.getElementsByClassName('igo-layer-item-focused');\r\n        let targetToScroll;\r\n        if (checkItems.length) {\r\n          targetToScroll = checkItems[checkItems.length-1];\r\n        }\r\n        if (itemFocused.length) {\r\n          targetToScroll = itemFocused[0];\r\n        }\r\n        if (targetToScroll) {\r\n          scrollIntoView(targetToScroll, {\r\n            scrollMode: 'if-needed',\r\n            behavior: 'smooth',\r\n            block: 'end',\r\n            inline: 'nearest'\r\n          });\r\n        }\r\n      }, 100);\r\n    }\r\n  }\r\n  private next() {\r\n    this.change$.next();\r\n  }\r\n\r\n  private computeLayers(layers: Layer[]): Layer[] {\r\n    let layersOut = this.filterLayers(layers);\r\n    if (this.sortAlpha) {\r\n      layersOut = this.sortLayersByTitle(layersOut);\r\n    } else {\r\n      layersOut = this.sortLayersByZindex(layersOut);\r\n    }\r\n    return layersOut;\r\n  }\r\n\r\n  onKeywordChange(term) {\r\n    this.keyword = term;\r\n  }\r\n\r\n  onAppliedFilterAndSortChange(appliedFilter: LayerListControlsOptions) {\r\n    this.keyword = appliedFilter.keyword;\r\n    this.onlyVisible = appliedFilter.onlyVisible;\r\n    this.sortAlpha = appliedFilter.sortAlpha;\r\n  }\r\n\r\n  private filterLayers(layers: Layer[]): Layer[] {\r\n    if (\r\n      this.layerFilterAndSortOptions.showToolbar === LayerListControlsEnum.never\r\n    ) {\r\n      return layers;\r\n    }\r\n    if (!this.keyword && !this.onlyVisible) {\r\n      return layers;\r\n    }\r\n\r\n    const keepLayerIds = layers.map((layer: Layer) => layer.id);\r\n\r\n    layers.forEach((layer: Layer) => {\r\n      const layerOptions = (layer.options as MetadataLayerOptions) || {};\r\n      const dataSourceOptions = layer.dataSource.options || {};\r\n      const metadata = layerOptions.metadata || ({} as MetadataOptions);\r\n      const keywords = metadata.keywordList || [];\r\n      const layerKeywords = keywords.map((kw: string) => {\r\n        return kw.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n      });\r\n\r\n      if (this.keyword && layer.title) {\r\n        const localKeyword = this.keyword\r\n          .normalize('NFD')\r\n          .replace(/[\\u0300-\\u036f]/g, '');\r\n        const layerTitle = layer.title\r\n          .normalize('NFD')\r\n          .replace(/[\\u0300-\\u036f]/g, '');\r\n        const dataSourceType = dataSourceOptions.type || '';\r\n        const keywordRegex = new RegExp(localKeyword, 'gi');\r\n        const keywordInList =\r\n          layerKeywords.find((kw: string) => keywordRegex.test(kw)) !==\r\n          undefined;\r\n        if (\r\n          !keywordRegex.test(layerTitle) &&\r\n          !(this.keyword.toLowerCase() === dataSourceType.toLowerCase()) &&\r\n          !keywordInList\r\n        ) {\r\n          const index = keepLayerIds.indexOf(layer.id);\r\n          if (index > -1) {\r\n            keepLayerIds.splice(index, 1);\r\n          }\r\n        }\r\n      }\r\n\r\n      if (this.onlyVisible && layer.visible === false) {\r\n        const index = keepLayerIds.indexOf(layer.id);\r\n        if (index > -1) {\r\n          keepLayerIds.splice(index, 1);\r\n        }\r\n      }\r\n    });\r\n\r\n    return layers.filter(\r\n      (layer: Layer) => keepLayerIds.indexOf(layer.id) !== -1\r\n    );\r\n  }\r\n\r\n  private sortLayersByZindex(layers: Layer[]) {\r\n    return layers.sort((layer1, layer2) => layer2.zIndex - layer1.zIndex);\r\n  }\r\n\r\n  private sortLayersByTitle(layers: Layer[]) {\r\n    return layers.sort((a, b) => {\r\n      if (this.normalize(a.title) < this.normalize(b.title)) {\r\n        return -1;\r\n      }\r\n      if (this.normalize(a.title) > this.normalize(b.title)) {\r\n        return 1;\r\n      }\r\n      return 0;\r\n    });\r\n  }\r\n\r\n  private normalize(str: string) {\r\n    return str\r\n      .normalize('NFD')\r\n      .replace(/[\\u0300-\\u036f]/g, '')\r\n      .toLowerCase();\r\n  }\r\n\r\n  private computeShowToolbar(): boolean {\r\n    switch (this.layerFilterAndSortOptions.showToolbar) {\r\n      case LayerListControlsEnum.always:\r\n        return true;\r\n      case LayerListControlsEnum.never:\r\n        return false;\r\n      default:\r\n        if (\r\n          this.layers.length >= this.thresholdToFilterAndSort ||\r\n          this.keyword ||\r\n          this.onlyVisible\r\n        ) {\r\n          return true;\r\n        }\r\n        return false;\r\n    }\r\n  }\r\n\r\n  toggleLayerTool(layer) {\r\n    this.toggleOpacity = false;\r\n    if (this.layerTool && layer === this.activeLayer) {\r\n      this.layerTool = false;\r\n    } else {\r\n      this.layerTool = true;\r\n    }\r\n\r\n    for (const lay of this.layers) {\r\n      lay.options.active = false;\r\n    }\r\n    layer.options.active = true;\r\n    this.activeLayer = layer;\r\n  }\r\n\r\n  removeLayers(layers?: Layer[]) {\r\n    if (layers && layers.length > 0) {\r\n      this.layersChecked = [];\r\n      for (const layer of layers) {\r\n        if (layer.options.removable !== false) {\r\n          layer.map.removeLayer(layer);\r\n        } else {\r\n          this.layersChecked.push(layer);\r\n        }\r\n      }\r\n    } else if (!layers && this.activeLayer.options.removable !== false) {\r\n      this.activeLayer.map.removeLayer(this.activeLayer);\r\n      this.layerTool = false;\r\n    }\r\n  }\r\n\r\n  toggleVisibility(layers?: Layer[]) {\r\n    if (layers && layers.length > 0) {\r\n      for (const layer of layers) {\r\n        layer.visible = this.hideSelectedLayers;\r\n      }\r\n    }\r\n    this.layerItemChangeDetection$.next(true);\r\n  }\r\n\r\n  isLayerRemovable(layer: Layer): boolean {\r\n    return layer.options.removable !== false;\r\n  }\r\n\r\n  isAllLayersRemovable(layers: Layer[]): boolean {\r\n    return layers.every(l => this.isLayerRemovable(l));\r\n  }\r\n\r\n  get statusSelectedLayersCheck(): LayerListSelectVisibleEnum {\r\n    let statusSelectedLayers: LayerListSelectVisibleEnum =\r\n      LayerListSelectVisibleEnum.NULL;\r\n    let findTrue: boolean = false;\r\n    let findFalse: boolean = false;\r\n\r\n    if (this.layersChecked.length === 0) {\r\n      statusSelectedLayers = LayerListSelectVisibleEnum.NULL;\r\n    } else {\r\n      statusSelectedLayers = LayerListSelectVisibleEnum.MIXED;\r\n      this.hideSelectedLayers = false;\r\n\r\n      for (const layer2 of this.layersChecked) {\r\n        if (layer2.visible === true) {\r\n          findTrue = true;\r\n        }\r\n        if (layer2.visible === false) {\r\n          findFalse = true;\r\n        }\r\n      }\r\n\r\n      if (findTrue === true && findFalse === false) {\r\n        statusSelectedLayers = LayerListSelectVisibleEnum.ALL_VISIBLE;\r\n      }\r\n      if (findTrue === false && findFalse === true) {\r\n        statusSelectedLayers = LayerListSelectVisibleEnum.ALL_HIDDEN;\r\n        this.hideSelectedLayers = true;\r\n      }\r\n    }\r\n\r\n    return statusSelectedLayers;\r\n  }\r\n\r\n  layersCheck(event: { layer: Layer; check: boolean }) {\r\n    event.layer.options.check = event.check;\r\n    if (event.check === true) {\r\n      const eventMapIndex = this.layers.findIndex(\r\n        (layer) => event.layer.id === layer.id\r\n      );\r\n      for (const layer of this.layersChecked) {\r\n        const mapIndex = this.layers.findIndex((lay) => layer.id === lay.id);\r\n        if (eventMapIndex < mapIndex) {\r\n          this.layersChecked.splice(\r\n            this.layersChecked.findIndex((lay) => layer.id === lay.id),\r\n            0,\r\n            event.layer\r\n          );\r\n\r\n          if (this.excludeBaseLayers) {\r\n            if (\r\n              this.layersChecked.length ===\r\n              this.layers.filter(\r\n                (lay) => lay.baseLayer !== true && lay.showInLayerList\r\n              ).length\r\n            ) {\r\n              this.selectAllCheck = true;\r\n            } else {\r\n              this.selectAllCheck = false;\r\n            }\r\n          } else if (!this.excludeBaseLayers) {\r\n            if (\r\n              this.layersChecked.length ===\r\n              this.layers.filter((lay) => lay.showInLayerList).length\r\n            ) {\r\n              this.selectAllCheck = true;\r\n            } else {\r\n              this.selectAllCheck = false;\r\n            }\r\n          }\r\n          return;\r\n        }\r\n      }\r\n      this.layersChecked.push(event.layer);\r\n    } else {\r\n      const index = this.layersChecked.findIndex(\r\n        (layer) => event.layer.id === layer.id\r\n      );\r\n      this.layersChecked.splice(index, 1);\r\n    }\r\n\r\n    if (this.excludeBaseLayers) {\r\n      if (\r\n        this.layersChecked.length ===\r\n        this.layers.filter(\r\n          (lay) => lay.baseLayer !== true && lay.showInLayerList\r\n        ).length\r\n      ) {\r\n        this.selectAllCheck = true;\r\n      } else {\r\n        this.selectAllCheck = false;\r\n      }\r\n    } else if (!this.excludeBaseLayers) {\r\n      if (\r\n        this.layersChecked.length ===\r\n        this.layers.filter((lay) => lay.showInLayerList).length\r\n      ) {\r\n        this.selectAllCheck = true;\r\n      } else {\r\n        this.selectAllCheck = false;\r\n      }\r\n    }\r\n  }\r\n\r\n  toggleSelectionMode(value: boolean) {\r\n    this.selection = value;\r\n    this.activeLayer = undefined;\r\n    if (value === true) {\r\n      this.layerTool = false;\r\n      for (const layer of this.layers) {\r\n        if (layer.options.check) {\r\n          this.layersChecked.push(layer);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  layersCheckedOpacity(): any {\r\n    if (this.layersChecked.length > 1) {\r\n      return 1;\r\n    } else {\r\n      const opacity = [];\r\n      for (const layer of this.layersChecked) {\r\n        opacity.push(layer.opacity);\r\n      }\r\n      return opacity;\r\n    }\r\n  }\r\n\r\n  selectAll() {\r\n    if (!this.selectAllCheck) {\r\n      for (const layer of this.layers) {\r\n        if (\r\n          this.excludeBaseLayers &&\r\n          layer.baseLayer !== true &&\r\n          layer.showInLayerList\r\n        ) {\r\n          layer.options.check = true;\r\n          this.layersChecked.push(layer);\r\n        } else if (!this.excludeBaseLayers && layer.showInLayerList) {\r\n          layer.options.check = true;\r\n          this.layersChecked.push(layer);\r\n        }\r\n      }\r\n      this.selectAllCheck$.next(true);\r\n    } else {\r\n      for (const layer of this.layers) {\r\n        layer.options.check = false;\r\n      }\r\n      this.layersChecked = [];\r\n      this.selectAllCheck$.next(false);\r\n    }\r\n  }\r\n\r\n  isScrolledIntoView(elemSource, elem) {\r\n    const docViewTop = elemSource.scrollTop;\r\n    const docViewBottom = docViewTop + elemSource.clientHeight;\r\n\r\n    const elemTop = elem.offsetTop;\r\n    const elemBottom = elemTop + elem.clientHeight;\r\n    return elemBottom <= docViewBottom && elemTop >= docViewTop;\r\n  }\r\n\r\n  removeProblemLayerInList(layersList: Layer[]): Layer[] {\r\n    for (const layer of layersList) {\r\n      if (layer.olLoadingProblem === true) {\r\n        this.map.removeLayer(layer);\r\n      }\r\n    }\r\n    return layersList;\r\n  }\r\n}\r\n","  <mat-list-item>\r\n      <mat-form-field class=\"inputFilter\" [floatLabel]=\"floatLabel\">\r\n        <input\r\n          matInput\r\n          [placeholder]=\"'igo.geo.layer.filterPlaceholder' | translate\"\r\n          [matTooltip]=\"'igo.geo.layer.subsetLayersListKeyword' | translate\"\r\n          matTooltipShowDelay=\"500\"\r\n          type=\"text\" [(ngModel)]=\"term\">\r\n        <button\r\n          mat-button\r\n          *ngIf=\"term\"\r\n          matSuffix\r\n          mat-icon-button\r\n          aria-label=\"Clear\"\r\n          color=\"warn\"\r\n          (click)=\"clearTerm()\">\r\n          <mat-icon svgIcon=\"close\"></mat-icon>\r\n        </button>\r\n      </mat-form-field>\r\n\r\n      <div [matTooltip]=\"sortAlpha ?\r\n      ('igo.geo.layer.sortMapOrder' | translate) :\r\n      ('igo.geo.layer.sortAlphabetically' | translate)\" matTooltipShowDelay=\"500\">\r\n        <button class=\"sort-alpha\" [color]=\"sortAlpha ? 'warn' : 'primary'\" mat-icon-button (click)=\"toggleSortAlpha()\">\r\n          <mat-icon [svgIcon]=\"sortAlpha ? 'sort-ascending' : 'sort-alphabetical-ascending'\"></mat-icon>\r\n        </button>\r\n      </div>\r\n\r\n       <div [matTooltip]=\"onlyVisible ?\r\n        ('igo.geo.layer.resetLayersList' | translate) :\r\n        ('igo.geo.layer.subsetLayersListOnlyVisible' | translate)\" matTooltipShowDelay=\"500\">\r\n         <button class=\"only-visible\" mat-icon-button [disabled]=\"layersAreAllVisible && !onlyVisible\"\r\n           [color]=\"onlyVisible ? 'warn' : 'primary'\" (click)=\"toggleOnlyVisible()\">\r\n           <mat-icon\r\n             matBadge=\"icon\"\r\n             igoMatBadgeIcon=\"eye\"\r\n             igoMatBadgeInverseColor=\"true\"\r\n             igoMatBadgeInheritColor=\"true\"\r\n             [svgIcon]=\"onlyVisible ? 'filter-remove' : 'filter'\">\r\n           </mat-icon>\r\n         </button>\r\n       </div>\r\n\r\n       <div [matTooltip]=\"selectionMode ?\r\n        ('igo.geo.layer.deactivateSelectionMode' | translate) :\r\n        ('igo.geo.layer.activateSelectionMode' | translate)\" matTooltipShowDelay=\"500\">\r\n         <button class=\"selection-mode\" mat-icon-button\r\n           color=\"primary\" (click)=\"toggleSelectionMode()\">\r\n           <mat-icon [svgIcon]=\"selectionMode ? 'checkbox-multiple-marked-outline' : 'checkbox-multiple-blank-outline'\"></mat-icon>\r\n         </button>\r\n       </div>\r\n\r\n</mat-list-item>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  EventEmitter,\r\n  Output,\r\n  OnDestroy\r\n} from '@angular/core';\r\nimport { FloatLabelType } from '@angular/material/form-field';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport { LayerListControlsOptions } from './layer-list-tool.interface';\r\n\r\n@Component({\r\n  selector: 'igo-layer-list-tool',\r\n  templateUrl: './layer-list-tool.component.html',\r\n  styleUrls: ['./layer-list-tool.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class LayerListToolComponent implements OnInit, OnDestroy {\r\n  public onlyVisible$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  public sortAlpha$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  public term$: BehaviorSubject<string> = new BehaviorSubject(undefined);\r\n  onlyVisible$$: Subscription;\r\n  sortAlpha$$: Subscription;\r\n  term$$: Subscription;\r\n\r\n  @Input() layersAreAllVisible: boolean = true;\r\n\r\n  @Input() floatLabel: FloatLabelType = 'auto';\r\n\r\n  @Input()\r\n  set onlyVisible(value: boolean) {\r\n    this.onlyVisible$.next(value);\r\n  }\r\n  get onlyVisible(): boolean {\r\n    return this.onlyVisible$.value;\r\n  }\r\n\r\n  @Input()\r\n  set sortAlpha(value: boolean) {\r\n    this.sortAlpha$.next(value);\r\n  }\r\n  get sortAlpha(): boolean {\r\n    return this.sortAlpha$.value;\r\n  }\r\n\r\n  @Input()\r\n  set term(value: string) {\r\n    this.term$.next(value);\r\n  }\r\n  get term(): string {\r\n    return this.term$.value;\r\n  }\r\n\r\n  public selectionMode = false;\r\n\r\n  @Output() appliedFilterAndSort = new EventEmitter<LayerListControlsOptions>();\r\n  @Output() selection = new EventEmitter<boolean>();\r\n\r\n  ngOnInit(): void {\r\n    this.term$$ = this.term$.subscribe(keyword => {\r\n      this.appliedFilterAndSort.emit({\r\n        keyword,\r\n        onlyVisible: this.onlyVisible,\r\n        sortAlpha: this.sortAlpha\r\n      });\r\n    });\r\n\r\n    this.onlyVisible$$ = this.onlyVisible$.subscribe(onlyVisible => {\r\n      this.appliedFilterAndSort.emit({\r\n        keyword: this.term,\r\n        onlyVisible,\r\n        sortAlpha: this.sortAlpha\r\n      });\r\n    });\r\n    this.sortAlpha$$ = this.sortAlpha$.subscribe(sortAlpha => {\r\n      this.appliedFilterAndSort.emit({\r\n        keyword: this.term,\r\n        onlyVisible: this.onlyVisible,\r\n        sortAlpha\r\n      });\r\n    });\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this.onlyVisible$$.unsubscribe();\r\n    this.sortAlpha$$.unsubscribe();\r\n    this.term$$.unsubscribe();\r\n  }\r\n\r\n  clearTerm() {\r\n    this.term = undefined;\r\n  }\r\n  toggleSortAlpha() {\r\n    this.sortAlpha = !this.sortAlpha;\r\n  }\r\n\r\n  toggleOnlyVisible() {\r\n    this.onlyVisible = !this.onlyVisible;\r\n  }\r\n\r\n  toggleSelectionMode() {\r\n    this.selectionMode = !this.selectionMode;\r\n    this.selection.emit(this.selectionMode);\r\n  }\r\n}\r\n","import { Directive, Self, OnInit, OnDestroy, Optional } from '@angular/core';\r\nimport { Subscription, combineLatest } from 'rxjs';\r\n\r\nimport { RouteService } from '@igo2/core';\r\nimport { MapService } from '../../map/shared/map.service';\r\nimport { LayerListComponent } from './layer-list.component';\r\nimport { Layer } from '../shared/layers/layer';\r\nimport { map, debounceTime } from 'rxjs/operators';\r\n\r\n@Directive({\r\n  selector: '[igoLayerListBinding]'\r\n})\r\nexport class LayerListBindingDirective implements OnInit, OnDestroy {\r\n  private component: LayerListComponent;\r\n  private layersOrResolutionChange$$: Subscription;\r\n  layersVisibility$$: Subscription;\r\n\r\n  constructor(\r\n    @Self() component: LayerListComponent,\r\n    private mapService: MapService,\r\n    @Optional() private route: RouteService\r\n  ) {\r\n    this.component = component;\r\n  }\r\n\r\n  ngOnInit() {\r\n    // Override input layers\r\n    // this.component.layers = [];\r\n    this.layersOrResolutionChange$$ = combineLatest([\r\n      this.mapService.getMap().layers$,\r\n      this.mapService.getMap().viewController.resolution$]\r\n    ).pipe(\r\n      debounceTime(10)\r\n    ).subscribe((bunch: [Layer[], number]) => {\r\n      const shownLayers = bunch[0].filter((layer: Layer) => {\r\n        return layer.showInLayerList === true;\r\n      });\r\n      this.component.layers = shownLayers;\r\n      this.setLayersVisibilityStatus(shownLayers, this.component.excludeBaseLayers);\r\n    });\r\n  }\r\n\r\n  private setLayersVisibilityStatus(layers: Layer[], excludeBaseLayers: boolean) {\r\n    if (this.layersVisibility$$ !== undefined) {\r\n      this.layersVisibility$$.unsubscribe();\r\n      this.layersVisibility$$ = undefined;\r\n    }\r\n    this.layersVisibility$$ = combineLatest(layers\r\n      .filter(layer => layer.baseLayer !== excludeBaseLayers )\r\n      .map((layer: Layer) => layer.visible$))\r\n      .pipe(map((visibles: boolean[]) => visibles.every(Boolean)))\r\n      .subscribe((allLayersAreVisible: boolean) =>\r\n        this.component.layersAreAllVisible = allLayersAreVisible);\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.layersOrResolutionChange$$.unsubscribe();\r\n    if (this.layersVisibility$$ !== undefined) {\r\n      this.layersVisibility$$.unsubscribe();\r\n      this.layersVisibility$$ = undefined;\r\n    }\r\n  }\r\n\r\n}\r\n","\r\n<div class=\"layer-legend-list-container\">\r\n  <mat-slide-toggle \r\n  tooltip-position=\"above\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.layer.legend.showAll' | translate\"\r\n  [checked]=\"showAllLegendsValue\" class=\"mat-typography\" \r\n  *ngIf=\"(layersInUi$ | async).length && allowShowAllLegends\" [labelPosition]=\"'before'\" (change)=\"toggleShowAllLegends($event.checked)\">\r\n    {{'igo.geo.layer.legend.showAll' | translate}}\r\n  </mat-slide-toggle>\r\n  <mat-divider *ngIf=\"(layersInUi$ | async).length && allowShowAllLegends\"></mat-divider>\r\n  <igo-list [navigation]=\"false\" [selection]=\"false\">\r\n    <ng-template ngFor let-layer let-i=\"index\" [ngForOf]=\"layers$ | async\">\r\n      <igo-layer-legend-item *ngIf=\"!(excludeBaseLayers && layer.baseLayer)\"\r\n          igoListItem [layer]=\"layer\"\r\n          [updateLegendOnResolutionChange]=\"updateLegendOnResolutionChange\">\r\n      </igo-layer-legend-item>\r\n    </ng-template>\r\n  </igo-list>\r\n  <p class=\"layers-empty mat-typography\" \r\n    *ngIf=\"!showAllLegendsValue && (layersInUi$ | async).length && (hasVisibleOrInRangeLayers$ | async)===false && (hasVisibleAndNotInRangeLayers$ | async)===false && allowShowAllLegends\">\r\n    {{'igo.geo.layer.legend.noLayersVisibleWithShowAllButton' | translate}} \r\n  </p>\r\n  <p class=\"layers-empty mat-typography\" \r\n    *ngIf=\"!showAllLegendsValue && (layersInUi$ | async).length && (hasVisibleOrInRangeLayers$ | async)===false && (hasVisibleAndNotInRangeLayers$ | async) && allowShowAllLegends\">\r\n    {{'igo.geo.layer.legend.noLayersVisibleWithShowAllButtonButZoom' | translate}} \r\n  </p>\r\n  <p class=\"layers-empty mat-typography\"\r\n    *ngIf=\"(layersInUi$ | async).length && (hasVisibleOrInRangeLayers$ | async)===false && (hasVisibleAndNotInRangeLayers$ | async)===false && !allowShowAllLegends\">\r\n    {{'igo.geo.layer.legend.noLayersVisible' | translate}} \r\n  </p>\r\n  <p class=\"layers-empty mat-typography\"\r\n    *ngIf=\"(layersInUi$ | async).length && (hasVisibleOrInRangeLayers$ | async)===false && (hasVisibleAndNotInRangeLayers$ | async) && !allowShowAllLegends\">\r\n    {{'igo.geo.layer.legend.noLayersVisibleButZoom' | translate}} \r\n  </p>\r\n\r\n</div>","import { Component, Input, ChangeDetectionStrategy, OnInit, OnDestroy, EventEmitter, Output } from '@angular/core';\r\nimport { Layer } from '../shared';\r\nimport { BehaviorSubject, ReplaySubject, Subscription, EMPTY, timer } from 'rxjs';\r\nimport { debounce } from 'rxjs/operators';\r\n\r\n@Component({\r\n  selector: 'igo-layer-legend-list',\r\n  templateUrl: './layer-legend-list.component.html',\r\n  styleUrls: ['./layer-legend-list.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class LayerLegendListComponent implements OnInit, OnDestroy {\r\n  orderable = true;\r\n\r\n  hasVisibleOrInRangeLayers$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n  hasVisibleAndNotInRangeLayers$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n  layersInUi$: BehaviorSubject<Layer[]> = new BehaviorSubject([]);\r\n  layers$: BehaviorSubject<Layer[]> = new BehaviorSubject([]);\r\n  showAllLegend: boolean = false;\r\n  public change$ = new ReplaySubject<void>(1);\r\n  private change$$: Subscription;\r\n  @Input()\r\n  set layers(value: Layer[]) {\r\n    this._layers = value;\r\n    this.next();\r\n  }\r\n  get layers(): Layer[] {\r\n    return this._layers;\r\n  }\r\n  private _layers: Layer[];\r\n  @Input() excludeBaseLayers: boolean = false;\r\n\r\n  @Input() updateLegendOnResolutionChange: boolean = false;\r\n\r\n  @Input() allowShowAllLegends: boolean = false;\r\n\r\n  @Input() showAllLegendsValue: boolean = false;\r\n\r\n  @Output() allLegendsShown = new EventEmitter<boolean>(false);\r\n\r\n  constructor() { }\r\n  ngOnInit(): void {\r\n    this.change$$ = this.change$\r\n      .pipe(debounce(() => {\r\n        return this.layers.length === 0 ? EMPTY : timer(50);\r\n      }))\r\n      .subscribe(() => {\r\n        const layers = this.computeShownLayers(this.layers.slice(0));\r\n        this.layers$.next(layers);\r\n        this.hasVisibleOrInRangeLayers$.next(\r\n          this.layers.slice(0)\r\n            .filter(layer => layer.baseLayer !== true)\r\n            .filter(layer => layer.visible$.value && layer.isInResolutionsRange$.value).length > 0\r\n        );\r\n        this.hasVisibleAndNotInRangeLayers$.next(\r\n          this.layers.slice(0)\r\n            .filter(layer => layer.baseLayer !== true)\r\n            .filter(layer => layer.visible$.value && !layer.isInResolutionsRange$.value).length > 0\r\n        );\r\n\r\n        this.layersInUi$.next(\r\n          this.layers.slice(0).filter(layer => layer.showInLayerList !== false && (!this.excludeBaseLayers || !layer.baseLayer))\r\n        );\r\n      });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.change$$.unsubscribe();\r\n  }\r\n  private next() {\r\n    this.change$.next();\r\n  }\r\n  private computeShownLayers(layers: Layer[]) {\r\n    let shownLayers = layers.filter((layer: Layer) => layer.visible && layer.isInResolutionsRange);\r\n    if (this.showAllLegendsValue) {\r\n      shownLayers = layers;\r\n    }\r\n    return this.sortLayersByZindex(shownLayers);\r\n  }\r\n  private sortLayersByZindex(layers: Layer[]) {\r\n    return layers.sort((layer1, layer2) => layer2.zIndex - layer1.zIndex);\r\n  }\r\n\r\n  toggleShowAllLegends(toggle: boolean) {\r\n      this.showAllLegendsValue = toggle;\r\n      this.next();\r\n      this.allLegendsShown.emit(toggle);\r\n  }\r\n}\r\n","<button *ngIf=\"options.trackFeature\"\r\n  mat-icon-button\r\n  collapsibleButton\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.layer.trackFeature' | translate\"\r\n  [color]=\"color\"\r\n  (click)=\"toggleTrackFeature()\">\r\n  <mat-icon svgIcon=\"crosshairs-gps\"></mat-icon>\r\n</button>\r\n","import { Component, Input, ChangeDetectionStrategy, OnInit } from '@angular/core';\r\n\r\nimport { VectorLayer } from '../shared/layers';\r\nimport { VectorLayerOptions } from '../shared/layers/vector-layer.interface';\r\n\r\n@Component({\r\n  selector: 'igo-track-feature-button',\r\n  templateUrl: './track-feature-button.component.html',\r\n  styleUrls: ['./track-feature-button.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class TrackFeatureButtonComponent implements OnInit {\r\n\r\n  @Input() layer: VectorLayer;\r\n\r\n  @Input() trackFeature = false;\r\n\r\n  get options(): VectorLayerOptions {\r\n    if (!this.layer) {\r\n      return;\r\n    }\r\n    return this.layer.options;\r\n  }\r\n\r\n  public color: string = 'primary';\r\n\r\n  constructor() {}\r\n\r\n  ngOnInit() {\r\n    this.color = this.trackFeature ? 'primary' : 'basic';\r\n  }\r\n\r\n  toggleTrackFeature() {\r\n    if (this.trackFeature) {\r\n      this.layer.disableTrackFeature(this.layer.options.trackFeature);\r\n      this.color = 'basic';\r\n    } else {\r\n      this.layer.enableTrackFeature(this.layer.options.trackFeature);\r\n      this.color = 'primary';\r\n    }\r\n    this.trackFeature = !this.trackFeature;\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\nimport { Subscription, BehaviorSubject } from 'rxjs';\r\n\r\nimport { MetadataLayerOptions } from '../../metadata/shared/metadata.interface';\r\nimport { Layer, TooltipType } from '../shared/layers';\r\nimport { NetworkService, ConnectionState } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'igo-layer-legend-item',\r\n  templateUrl: './layer-legend-item.component.html',\r\n  styleUrls: ['./layer-legend-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class LayerLegendItemComponent implements OnInit, OnDestroy {\r\n\r\n  inResolutionRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  tooltipText: string;\r\n\r\n  state: ConnectionState;\r\n\r\n  private resolution$$: Subscription;\r\n  private network$$: Subscription;\r\n\r\n  @Input() layer: Layer;\r\n\r\n  @Input() updateLegendOnResolutionChange: boolean = false;\r\n\r\n  constructor(private networkService: NetworkService) {}\r\n\r\n  ngOnInit() {\r\n    const resolution$ = this.layer.map.viewController.resolution$;\r\n    this.resolution$$ = resolution$.subscribe(() => {\r\n      this.onResolutionChange();\r\n    });\r\n    this.tooltipText = this.computeTooltip();\r\n\r\n    this.network$$ = this.networkService.currentState().subscribe((state: ConnectionState) => {\r\n      this.state = state;\r\n      this.onResolutionChange();\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.resolution$$.unsubscribe();\r\n    this.network$$.unsubscribe();\r\n  }\r\n\r\n  computeTooltip(): string {\r\n    const layerOptions = this.layer.options;\r\n    if (!layerOptions.tooltip) {\r\n      return this.layer.title;\r\n    }\r\n    const layerTooltip = layerOptions.tooltip;\r\n    const layerMetadata = (layerOptions as MetadataLayerOptions).metadata;\r\n    switch (layerOptions.tooltip.type) {\r\n      case TooltipType.TITLE:\r\n        return this.layer.title;\r\n      case TooltipType.ABSTRACT:\r\n        if (layerMetadata && layerMetadata.abstract) {\r\n          return layerMetadata.abstract;\r\n        } else {\r\n          return this.layer.title;\r\n        }\r\n      case TooltipType.CUSTOM:\r\n        if (layerTooltip && layerTooltip.text) {\r\n          return layerTooltip.text;\r\n        } else {\r\n          return this.layer.title;\r\n        }\r\n      default:\r\n        return this.layer.title;\r\n    }\r\n  }\r\n\r\n  private onResolutionChange() {\r\n    const inResolutionRange = this.layer.isInResolutionsRange;\r\n    this.inResolutionRange$.next(inResolutionRange);\r\n  }\r\n}\r\n","<mat-list-item class= \"igo-layer-list-item\">\r\n  <h4 matLine class=\"igo-layer-title\" [matTooltip]=\"tooltipText\" matTooltipShowDelay=\"500\">{{layer.title}}</h4>\r\n</mat-list-item>\r\n\r\n<div #legend class=\"igo-layer-legend-container\">\r\n  <igo-layer-legend\r\n    [layer]=\"layer\"\r\n    [updateLegendOnResolutionChange]=\"updateLegendOnResolutionChange\">\r\n  </igo-layer-legend>\r\n</div>\r\n","export enum GeometryType {\r\n    Point = 'Point',\r\n    LineString = 'LineString',\r\n    Polygon = 'Polygon',\r\n    Circle = 'Circle'\r\n}\r\n\r\nexport enum FontType {\r\n    Arial = 'Arial',\r\n    ArialBlack = 'Arial Black',\r\n    Verdana = 'Verdana',\r\n    Tahoma = 'Tahoma',\r\n    TrebuchetMS = 'Trebuchet MS',\r\n    Impact = 'Impact',\r\n    TimesNewRoman = 'Times New Roman',\r\n    Georgia = 'Georgia',\r\n    AmericanTypewriter = 'American Typewriter',\r\n    Courier = 'Courier',\r\n    LucidaConsole = 'Lucida Console',\r\n    BrushScriptMT = 'Brush Script MT',\r\n    ComicSansMS = 'Comic Sans MS'\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\n\r\n@Injectable({\r\n    providedIn: 'root'\r\n  })\r\nexport class DrawIconService {\r\n\r\n    protected icons: Array<string>;\r\n\r\n    constructor(\r\n      protected config: ConfigService\r\n    ) {\r\n        this.getIconsList();\r\n    }\r\n\r\n    getIcons() {\r\n        return this.icons;\r\n    }\r\n\r\n    getPath(): any {\r\n      return this.config.getConfig('drawingTool.icons') || [];\r\n    }\r\n\r\n    getIconsList() {\r\n      this.icons = this.getPath();\r\n    }\r\n}\r\n","\r\nexport const MEASURE_UNIT_AUTO = 'auto';\r\n\r\nexport enum MeasureType {\r\n  Length = 'length',\r\n  Area = 'area'\r\n}\r\n\r\nexport enum MeasureLengthUnit {\r\n  Meters = 'meters',\r\n  Kilometers = 'kilometers',\r\n  Miles = 'miles',\r\n  Feet = 'feet'\r\n}\r\n\r\nexport const MeasureLengthUnitAbbreviation = {\r\n  [MeasureLengthUnit.Meters]: 'm',\r\n  [MeasureLengthUnit.Kilometers]: 'km',\r\n  [MeasureLengthUnit.Miles]: 'mi',\r\n  [MeasureLengthUnit.Feet]: 'ft'\r\n};\r\n\r\nexport enum MeasureAreaUnit {\r\n  SquareMeters = 'squareMeters',\r\n  SquareKilometers = 'squareKilometers',\r\n  SquareMiles = 'squareMiles',\r\n  SquareFeet = 'squareFeet',\r\n  Hectares = 'hectares',\r\n  Acres = 'acres'\r\n}\r\n\r\nexport const MeasureAreaUnitAbbreviation = {\r\n  [MeasureAreaUnit.SquareMeters]: 'm',\r\n  [MeasureAreaUnit.SquareKilometers]: 'km',\r\n  [MeasureAreaUnit.SquareMiles]: 'mi',\r\n  [MeasureAreaUnit.SquareFeet]: 'ft',\r\n  [MeasureAreaUnit.Hectares]: 'ha',\r\n  [MeasureAreaUnit.Acres]: 'ac'\r\n};\r\n","import { LanguageService } from '@igo2/core';\r\nimport * as olstyle from 'ol/style';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport OlLineString from 'ol/geom/LineString';\r\nimport OlPolygon from 'ol/geom/Polygon';\r\nimport OlCircle from 'ol/geom/Circle';\r\nimport OlOverlay from 'ol/Overlay';\r\nimport { getCenter as olGetCenter } from 'ol/extent';\r\nimport {\r\n  getLength as olGetLength,\r\n  getArea as olGetArea\r\n} from 'ol/sphere';\r\n\r\nimport { Measure } from './measure.interfaces';\r\nimport {\r\n  MeasureAreaUnit,\r\n  MeasureAreaUnitAbbreviation,\r\n  MeasureLengthUnit,\r\n  MeasureLengthUnitAbbreviation\r\n} from './measure.enum';\r\n\r\n/**\r\n * Convert value from meters to kilometers\r\n * @param value Value in meters\r\n * @returns Value in kilometers\r\n */\r\nexport function metersToKilometers(value: number): number {\r\n  return value * 0.001;\r\n}\r\n\r\n/**\r\n * Convert value from meters to feet\r\n * @param value Value in meters\r\n * @returns Value in feet\r\n */\r\nexport function metersToFeet(value: number): number {\r\n  return value * 3.2808;\r\n}\r\n\r\n/**\r\n * Convert value from meters to miles\r\n * @param value Value in meters\r\n * @returns Value in miles\r\n */\r\nexport function metersToMiles(value: number): number {\r\n  return value * 0.000621;\r\n}\r\n\r\n/**\r\n * Convert value from square meters to square kilometers\r\n * @param value Value in square meters\r\n * @returns Value in square kilometers\r\n */\r\nexport function squareMetersToSquareKilometers(value: number): number {\r\n  return value * 0.000001;\r\n}\r\n\r\n/**\r\n * Convert value from square meters to square miles\r\n * @param value Value in square meters\r\n * @returns Value in square miles\r\n */\r\nexport function squareMetersToSquareMiles(value: number): number {\r\n  return value * 0.0000003861;\r\n}\r\n\r\n/**\r\n * Convert value from square meters to square feet\r\n * @param value Value in square meters\r\n * @returns Value in square feet\r\n */\r\nexport function squareMetersToSquareFeet(value: number): number {\r\n  return value * 10.764;\r\n}\r\n\r\n/**\r\n * Convert value from square meters to hectares\r\n * @param value Value in square meters\r\n * @returns Value in hectares\r\n */\r\nexport function squareMetersToHectares(value: number): number {\r\n  return value * 0.0001;\r\n}\r\n\r\n/**\r\n * Convert value from square meters to acres\r\n * @param value Value in square meters\r\n * @returns Value in acres\r\n */\r\nexport function squareMetersToAcres(value: number): number {\r\n  return value * 0.00024711;\r\n}\r\n\r\n/**\r\n * Convert value from meters to the specified length unit\r\n * @param value Value in meters\r\n * @param unit Length unit\r\n * @returns Value in unit\r\n */\r\nexport function metersToUnit(value: number, unit: MeasureLengthUnit): number | undefined {\r\n  const conversionMapper = new Map([\r\n    [MeasureLengthUnit.Meters, (val: number) => val],\r\n    [MeasureLengthUnit.Kilometers, metersToKilometers],\r\n    [MeasureLengthUnit.Miles, metersToMiles],\r\n    [MeasureLengthUnit.Feet, metersToFeet],\r\n  ]);\r\n  const conversion = conversionMapper.get(unit);\r\n\r\n  return conversion ? conversion(value) : undefined;\r\n}\r\n\r\n/**\r\n * Convert value from square meters to the specified area unit\r\n * @param value Value in meters\r\n * @param unit Area unit\r\n * @returns Value in unit\r\n */\r\nexport function squareMetersToUnit(value: number, unit: MeasureAreaUnit): number | undefined {\r\n  const conversionMapper = new Map([\r\n    [MeasureAreaUnit.SquareMeters, (val: number) => val],\r\n    [MeasureAreaUnit.SquareKilometers, squareMetersToSquareKilometers],\r\n    [MeasureAreaUnit.SquareMiles, squareMetersToSquareMiles],\r\n    [MeasureAreaUnit.SquareFeet, squareMetersToSquareFeet],\r\n    [MeasureAreaUnit.Hectares, squareMetersToHectares],\r\n    [MeasureAreaUnit.Acres, squareMetersToAcres],\r\n  ]);\r\n  const conversion = conversionMapper.get(unit);\r\n\r\n  return conversion ? conversion(value) : undefined;\r\n}\r\n\r\n/**\r\n * This method format a measure to a readable format\r\n * @param measure Measure\r\n * @param options Formatting options\r\n * @returns Formatted measure\r\n */\r\nexport function formatMeasure(\r\n  measure: number,\r\n  options?: {\r\n    decimal?: number;\r\n    unit?: MeasureAreaUnit | MeasureLengthUnit;\r\n    unitAbbr?: boolean;\r\n    locale?: string;\r\n  },\r\n  languageService?: LanguageService) {\r\n  let decimal = options.decimal;\r\n  if (decimal === undefined || decimal < 0) {\r\n    decimal = 1;\r\n  }\r\n\r\n  const parts = [];\r\n  if (options.locale !== undefined) {\r\n    parts.push(measure.toLocaleString(options.locale, {\r\n      minimumFractionDigits: decimal,\r\n      maximumFractionDigits: decimal\r\n    }));\r\n  } else {\r\n    parts.push(measure.toFixed(decimal).toString());\r\n  }\r\n\r\n  if (options.unit !== undefined && options.unitAbbr === true) {\r\n    if (languageService) {\r\n      parts.push(\r\n        MeasureLengthUnitAbbreviation[options.unit] ?\r\n          languageService.translate.instant('igo.geo.measure.' + MeasureLengthUnitAbbreviation[options.unit]) :\r\n          languageService.translate.instant('igo.geo.measure.' + MeasureAreaUnitAbbreviation[options.unit])\r\n      );\r\n    } else {\r\n      parts.push(\r\n        MeasureLengthUnitAbbreviation[options.unit] || MeasureAreaUnitAbbreviation[options.unit]\r\n      );\r\n    }\r\n  }\r\n\r\n  return parts.filter(p => p !== undefined).join(' ');\r\n}\r\n\r\n/**\r\n * Compute best length measure unit for a given measure in meters\r\n * @param value Value in meters\r\n * @returns Measure unit\r\n */\r\nexport function computeBestLengthUnit(value: number): MeasureLengthUnit {\r\n  let unit = MeasureLengthUnit.Meters;\r\n  let converted = value;\r\n  const possibleUnits = [MeasureLengthUnit.Kilometers];\r\n  while (converted > 1000 && possibleUnits.length > 0) {\r\n    unit = possibleUnits.pop();\r\n    converted = metersToUnit(value, unit);\r\n  }\r\n  return unit;\r\n}\r\n\r\n/**\r\n * Compute best length measure unit for a given measure in square meters\r\n * @param value Value in meters\r\n * @returns Measure unit\r\n */\r\nexport function computeBestAreaUnit(value: number): MeasureAreaUnit {\r\n  let unit = MeasureAreaUnit.SquareMeters;\r\n  let converted = value;\r\n  const possibleUnits = [MeasureAreaUnit.SquareKilometers];\r\n  while (converted > 1000000 && possibleUnits.length > 0) {\r\n    unit = possibleUnits.pop();\r\n    converted = squareMetersToUnit(value, unit);\r\n  }\r\n  return unit;\r\n}\r\n\r\n/**\r\n * Create a default style for a measure interaction\r\n * @returns OL style\r\n */\r\nexport function createMeasureInteractionStyle(): olstyle.Style {\r\n  return new olstyle.Style({\r\n    stroke: new olstyle.Stroke({\r\n      color: '#ffcc33',\r\n      lineDash: [10, 10],\r\n      width: 2\r\n    }),\r\n    fill:  new olstyle.Fill({\r\n      color: 'rgba(255, 255, 255, 0.2)'\r\n    }),\r\n    image: new olstyle.Circle({\r\n      radius: 5,\r\n      stroke: new olstyle.Stroke({\r\n        color: '#ffcc33',\r\n      }),\r\n      fill: new olstyle.Fill({\r\n        color: 'rgba(255, 255, 255, 0.2)'\r\n      })\r\n    })\r\n  });\r\n}\r\n\r\n/**\r\n * Create a default style for a measure layer\r\n * @returns OL style\r\n */\r\nexport function createMeasureLayerStyle(): olstyle.Style {\r\n  return new olstyle.Style({\r\n    stroke: new olstyle.Stroke({\r\n      color: '#ffcc33',\r\n      width: 2\r\n    }),\r\n    fill:  new olstyle.Fill({\r\n      color: 'rgba(255, 255, 255, 0.2)'\r\n    })\r\n  });\r\n}\r\n\r\n/**\r\n * Compute the length in meters of an OL geometry with a given projection\r\n * @param olGeometry Ol geometry\r\n * @param projection olGeometry's projection\r\n * @returns Length in meters\r\n */\r\nexport function measureOlGeometryLength(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle, projection: string): number | undefined {\r\n  if (olGeometry instanceof OlPoint) {\r\n    return undefined;\r\n  }\r\n  if (olGeometry.getFlatCoordinates().length === 0) {\r\n    return undefined;\r\n  }\r\n  return olGetLength(olGeometry, {projection});\r\n}\r\n\r\n/**\r\n * Compute the area in square meters of an OL geometry with a given projection\r\n * @param olGeometry Ol geometry\r\n * @param projection olGeometry's projection\r\n * @returns Area in square meters\r\n */\r\nexport function measureOlGeometryArea(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle, projection: string): number | undefined {\r\n  if (olGeometry instanceof OlPoint || olGeometry instanceof OlLineString) {\r\n    return undefined;\r\n  }\r\n  if (olGeometry.getFlatCoordinates().length === 0) {\r\n    return undefined;\r\n  }\r\n  return olGetArea(olGeometry, {projection});\r\n}\r\n\r\n/**\r\n * Compute the area (square meters), length (meters) and last length (meters)\r\n * of an OL geometry with a given projection.\r\n * @param olGeometry Ol geometry\r\n * @param projection olGeometry's projection\r\n * @returns Computed measure\r\n */\r\nexport function measureOlGeometry(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle, projection: string): Measure {\r\n  const length = measureOlGeometryLength(olGeometry, projection);\r\n  const area = measureOlGeometryArea(olGeometry, projection);\r\n\r\n  const lengths = [];\r\n  const coordinates = olGeometry.getFlatCoordinates();\r\n  const coordinatesLength = coordinates.length;\r\n  for (let i = 0; i <= coordinatesLength - 4; i += 2) {\r\n    const olSegment = new OlLineString([\r\n      [coordinates[i], coordinates[i + 1]],\r\n      [coordinates[i + 2], coordinates[i + 3]]\r\n    ]);\r\n\r\n    lengths.push(measureOlGeometryLength(olSegment, projection));\r\n  }\r\n\r\n  return {\r\n    area,\r\n    length,\r\n    lengths\r\n  };\r\n}\r\n\r\n/**\r\n * Update an OL geometry midpoints and return an array of those points\r\n * @param olGeometry OL Geometry\r\n * @returns OL points\r\n */\r\nexport function updateOlGeometryMidpoints(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlPoint[] {\r\n  let olMidpoints;\r\n  if (olGeometry instanceof OlPoint) {\r\n    const olMidpointPoint = new OlPoint(olGeometry.getFlatCoordinates());\r\n    olMidpoints = new Array(1);\r\n    olMidpoints[0] = olMidpointPoint;\r\n  } else {\r\n    olMidpoints = getOlGeometryMidpoints(olGeometry);\r\n    // TODO: handle multi geometries\r\n    const coordinates = olGeometry.getFlatCoordinates();\r\n    const midpointsLength = olMidpoints.length;\r\n    for (let i = 0; i < midpointsLength; i++) {\r\n      const j = i * 2;\r\n      const olSegment = new OlLineString([\r\n        [coordinates[j], coordinates[j + 1]],\r\n        [coordinates[j + 2], coordinates[j + 3]]\r\n      ]);\r\n\r\n      const midpointCoordinate = olSegment.getCoordinateAt(0.5);\r\n      const olMidpoint = olMidpoints[i];\r\n      if (olMidpoint !== undefined) {\r\n        olMidpoint.setCoordinates(midpointCoordinate);\r\n      } else {\r\n        olMidpoints[i] = new OlPoint(midpointCoordinate);\r\n      }\r\n    }\r\n  }\r\n  return olMidpoints;\r\n}\r\n\r\n/**\r\n * Clear an OL geometry midpoints and return an array of those points\r\n * @param olGeometry OL Geometry\r\n */\r\nexport function clearOlGeometryMidpoints(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle) {\r\n  const olMidpoints = olGeometry.get('_midpoints') || [];\r\n  const midpointsLength = olMidpoints.length;\r\n  for (let i = 0; i < midpointsLength; i++) {\r\n    const olMidpoint = olMidpoints[i];\r\n    if (olMidpoint !== undefined) {\r\n      if (olMidpoint !== undefined) {\r\n        clearOlMidpointTooltip(olMidpoint);\r\n      }\r\n    }\r\n  }\r\n\r\n  olGeometry.set('_midpoints', undefined, true);\r\n\r\n  return olMidpoints;\r\n}\r\n\r\n/**\r\n * Return an array of  OL geometry midpoints, if any\r\n * @param olGeometry OL Geometry\r\n * @returns OL points\r\n */\r\nfunction getOlGeometryMidpoints(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlPoint[] {\r\n  let expectedNumber;\r\n  if (olGeometry instanceof OlCircle) {\r\n    expectedNumber = 0;\r\n  } else {\r\n    expectedNumber = Math.max((olGeometry.getFlatCoordinates().length / 2) - 1, 0);\r\n  }\r\n  // TODO: This works but it's quite messy. If time permits,\r\n  // clean this. Maybe a Tooltip class could handle that\r\n  let olMidpoints = olGeometry.get('_midpoints');\r\n\r\n  if (olMidpoints === undefined) {\r\n    if (olGeometry instanceof OlPoint) {\r\n      olMidpoints = new Array(1);\r\n    } else {\r\n      olMidpoints = new Array(expectedNumber);\r\n    }\r\n    olGeometry.set('_midpoints', olMidpoints, true);\r\n    return olMidpoints;\r\n  }\r\n\r\n  if (expectedNumber === 0) {\r\n    return olMidpoints;\r\n  }\r\n\r\n  if (expectedNumber === olMidpoints.length) {\r\n    return olMidpoints;\r\n  }\r\n\r\n  if (expectedNumber > olMidpoints.length) {\r\n    olMidpoints.push(...new Array(expectedNumber - olMidpoints.length));\r\n    return olMidpoints;\r\n  }\r\n\r\n  for (let i = expectedNumber; i < olMidpoints.length; i++) {\r\n    const olMidpoint = olMidpoints[expectedNumber];\r\n    if (olMidpoint !== undefined) {\r\n      clearOlMidpointTooltip(olMidpoint);\r\n    }\r\n  }\r\n  olMidpoints.splice(expectedNumber);\r\n\r\n  return olMidpoints;\r\n}\r\n\r\n/**\r\n * Remove an OL midpoint's tooltip from the map\r\n * @param olMidpoint OL Point\r\n */\r\nfunction clearOlMidpointTooltip(olMidpoint: OlPoint) {\r\n  const olTooltip = olMidpoint.get('_tooltip');\r\n  if (olTooltip !== undefined) {\r\n    const olMap = olTooltip.getMap();\r\n    if (olMap !== undefined) {\r\n      olMap.removeOverlay(olTooltip);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Add an OL overlay at each midpoint and return an array of those overlays\r\n * @param olGeometry OL Geometry\r\n * @returns OL overlays\r\n */\r\nexport function updateOlTooltipsAtMidpoints(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlOverlay[] {\r\n  const olMidpoints = updateOlGeometryMidpoints(olGeometry);\r\n  let typeGeom = '';\r\n  if (olGeometry instanceof OlLineString) {\r\n  typeGeom = 'line-';\r\n  } else if (olGeometry instanceof OlPolygon) {\r\n    typeGeom = 'polygone-';\r\n    }\r\n  const olTooltips = olMidpoints.map((olMidpoint: OlPoint) => {\r\n    let olTooltip = olMidpoint.get('_tooltip');\r\n    if (olTooltip === undefined) {\r\n      olTooltip = createOlTooltipAtPoint(olMidpoint, false, typeGeom);\r\n    } else {\r\n      olTooltip.setPosition(olMidpoint.getFlatCoordinates());\r\n    }\r\n    return olTooltip;\r\n  });\r\n  return olTooltips;\r\n}\r\n\r\n/**\r\n * Return an array of OL overlay at midspoints, if any\r\n * @param olGeometry OL Geometry\r\n * @returns OL overlays\r\n */\r\nexport function getOlTooltipsAtMidpoints(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlOverlay[] {\r\n  const olMidpoints = getOlGeometryMidpoints(olGeometry);\r\n  return olMidpoints.map((olMidpoint: OlPoint) => {\r\n    return olMidpoint ? olMidpoint.get('_tooltip') : undefined;\r\n  });\r\n}\r\n\r\n/**\r\n * Update an OL geometry center and return it\r\n * @param olGeometry OL Geometry\r\n * @returns OL point\r\n */\r\nexport function updateOlGeometryCenter(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlPoint {\r\n  let olCenter = olGeometry.get('_center');\r\n  const centerCoordinate = olGetCenter(olGeometry.getExtent());\r\n  if (olCenter !== undefined) {\r\n    olCenter.setCoordinates(centerCoordinate);\r\n  } else {\r\n    olCenter = new OlPoint(centerCoordinate);\r\n    olGeometry.set('_center', olCenter);\r\n  }\r\n\r\n  return olCenter;\r\n}\r\n\r\n/**\r\n * Add an OL overlay at the center of a geometry and return that overlay\r\n * @param olGeometry OL Geometry\r\n * @returns OL overlay\r\n */\r\nexport function updateOlTooltipAtCenter(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlOverlay {\r\n  const olCenter = updateOlGeometryCenter(olGeometry);\r\n  let olTooltip = olCenter.get('_tooltip');\r\n  if (olTooltip === undefined) {\r\n    olTooltip = createOlTooltipAtPoint(olCenter, true);\r\n  } else {\r\n    olTooltip.setPosition(olCenter.getFlatCoordinates());\r\n  }\r\n  return olTooltip;\r\n}\r\n\r\n/**\r\n * Return an array of OL overlay at midspoints, if any\r\n * @param olGeometry OL Geometry\r\n * @returns OL overlays\r\n */\r\nexport function getOlTooltipAtCenter(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlOverlay {\r\n  const olCenter = olGeometry.get('_center');\r\n  return olCenter ? olCenter.get('_tooltip') : undefined;\r\n}\r\n\r\n/**\r\n * Get all the tooltips of an OL geometry\r\n * @param olGeometry OL Geometry\r\n * @returns OL overlays\r\n */\r\nexport function getTooltipsOfOlGeometry(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlOverlay[] {\r\n  const olTooltips = [].concat(getOlTooltipsAtMidpoints(olGeometry) || []);\r\n  const olCenterTooltip = getOlTooltipAtCenter(olGeometry);\r\n  if (olCenterTooltip !== undefined) {\r\n    olTooltips.push(olCenterTooltip);\r\n  }\r\n  return olTooltips;\r\n}\r\n\r\n/**\r\n * Create an OL overlay at a point and bind the overlay to the point\r\n * @param olPoint OL Point\r\n * @returns OL overlay\r\n */\r\nexport function createOlTooltipAtPoint(olPoint: OlPoint, center: boolean = false, srcGeomType: string= ''): OlOverlay {\r\n  const olTooltip = new OlOverlay({\r\n    element: document.createElement('div'),\r\n    offset: [-30, -10],\r\n    className: (center ?\r\n    [ 'igo-map-tooltip',\r\n      'igo-map-tooltip-measure', 'igo-map-tooltip-measure-area'] : ['igo-map-tooltip', 'igo-map-tooltip-measure',\r\n      `igo-map-tooltip-measure-${srcGeomType}segments`]).join(' '),\r\n    stopEvent: false\r\n  });\r\n  olTooltip.setPosition(olPoint.getFlatCoordinates());\r\n  olPoint.set('_tooltip', olTooltip);\r\n\r\n  return olTooltip;\r\n}\r\n","import * as Olstyle from 'ol/style';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport OlLineString from 'ol/geom/LineString';\r\nimport OlPolygon from 'ol/geom/Polygon';\r\nimport OlCircle from 'ol/geom/Circle';\r\nimport OlOverlay from 'ol/Overlay';\r\nimport {\r\n  updateOlGeometryMidpoints,\r\n  updateOlGeometryCenter\r\n} from '../../measure/shared/measure.utils';\r\n\r\n\r\n/**\r\n * Create a default style\r\n * @param fillColor the fill color\r\n * @param strokeColor the stroke color\r\n * @param strokeWidth the stroke width\r\n * @param label a label\r\n * @returns OL style\r\n */\r\nexport function createInteractionStyle(fillColor?: string, strokeColor?: string, strokeWidth?: number, label?: string): Olstyle.Style {\r\n  return new Olstyle.Style({\r\n    stroke: new Olstyle.Stroke({\r\n      color: strokeColor ? strokeColor : 'rgba(143,7,7,1)',\r\n      width: strokeWidth ? strokeWidth : 1\r\n    }),\r\n    fill: new Olstyle.Fill({\r\n      color: fillColor ? fillColor : 'rgba(255,255,255,0.4)'\r\n    }),\r\n    image: new Olstyle.Circle({\r\n      radius: 5,\r\n      stroke: new Olstyle.Stroke({\r\n        color: strokeColor ? strokeColor : 'rgba(143,7,7,1)',\r\n        width: strokeWidth ? strokeWidth : 1\r\n      }),\r\n      fill: new Olstyle.Fill({\r\n        color: fillColor ? fillColor : 'rgba(255,255,255,0.4)'\r\n      })\r\n    })\r\n  });\r\n}\r\n\r\n/**\r\n * Add an OL overlay at each midpoint and return an array of those overlays\r\n * @param olGeometry OL Geometry\r\n * @returns OL overlays\r\n */\r\nexport function updateOlTooltipsDrawAtMidpoints(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlOverlay[] {\r\n  let olMidpoints;\r\n  if (olGeometry instanceof OlPoint) {\r\n    const olMidpointPoint = new OlPoint(olGeometry.getFlatCoordinates());\r\n    olMidpoints = new Array(1);\r\n    olMidpoints[0] = olMidpointPoint;\r\n    olGeometry.setProperties({_midpoints: olMidpoints}, true);\r\n  } else if (olGeometry instanceof OlCircle) {\r\n    const olMidpointPoint = new OlPoint(olGeometry.getCenter());\r\n    olMidpoints = new Array(1);\r\n    olMidpoints[0] = olMidpointPoint;\r\n    olGeometry.setProperties({_midpoints: olMidpoints}, true);\r\n  } else {\r\n    olMidpoints = updateOlGeometryMidpoints(olGeometry);\r\n  }\r\n  const olTooltips = olMidpoints.map((olMidpoint: OlPoint) => {\r\n    let olTooltip = olMidpoint.get('_tooltip');\r\n    if (olTooltip === undefined) {\r\n      olTooltip = createOlTooltipDrawAtPoint(olMidpoint);\r\n    } else {\r\n      olTooltip.setPosition(olMidpoint.getFlatCoordinates());\r\n    }\r\n    return olTooltip;\r\n  });\r\n  return olTooltips;\r\n}\r\n\r\n/**\r\n * Add an OL overlay at the center of a geometry and return that overlay\r\n * @param olGeometry OL Geometry\r\n * @returns OL overlay\r\n */\r\nexport function updateOlTooltipDrawAtCenter(olGeometry: OlLineString | OlPolygon): OlOverlay {\r\n  const olCenter = updateOlGeometryCenter(olGeometry);\r\n  let olTooltip = olCenter.get('_tooltip');\r\n  if (olTooltip === undefined) {\r\n    olTooltip = createOlTooltipDrawAtPoint(olCenter);\r\n  } else {\r\n    olTooltip.setPosition(olCenter.getFlatCoordinates());\r\n  }\r\n  return olTooltip;\r\n}\r\n\r\n/**\r\n * Create an OL overlay at a point and bind the overlay to the point\r\n * @param olPoint OL Point\r\n * @returns OL overlay\r\n */\r\nexport function createOlTooltipDrawAtPoint(olPoint: OlPoint): OlOverlay {\r\n  const olTooltip = new OlOverlay({\r\n    element: document.createElement('div'),\r\n    offset: [-30, -10],\r\n    className: [\r\n      'igo-map-tooltip',\r\n      'igo-map-tooltip-draw'\r\n    ].join(' '),\r\n    stopEvent: false\r\n  });\r\n  olTooltip.setPosition(olPoint.getFlatCoordinates());\r\n  olPoint.set('_tooltip', olTooltip);\r\n\r\n  return olTooltip;\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport * as OlStyle from 'ol/style';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport { transform } from 'ol/proj';\r\nimport { MapService } from '../../map/shared/map.service';\r\nimport { FontType } from './draw.enum';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class DrawStyleService {\r\n  private fillColor = 'rgba(255,255,255,0.4)';\r\n  private strokeColor = 'rgba(143,7,7,1)';\r\n  private strokeWidth: number = 1;\r\n  private labelsAreShown = true;\r\n  private icon: string;\r\n  private fontSize: string = '20';\r\n  private fontStyle: string = FontType.Arial.toString();\r\n  private offsetX: number = 0;\r\n  private offsetY: number = 0;\r\n\r\n  constructor(\r\n    private mapService: MapService\r\n  ) {}\r\n\r\n  getFillColor(): string {\r\n    return this.fillColor;\r\n  }\r\n\r\n  setFillColor(fillColor: string) {\r\n    this.fillColor = fillColor;\r\n  }\r\n\r\n  getStrokeColor(): string {\r\n    return this.strokeColor;\r\n  }\r\n\r\n  setStrokeColor(strokeColor: string) {\r\n    this.strokeColor = strokeColor;\r\n  }\r\n\r\n  getStrokeWidth(): number {\r\n    return this.strokeWidth;\r\n  }\r\n\r\n  getLabelsAreShown() {\r\n    return this.labelsAreShown;\r\n  }\r\n\r\n  toggleLabelsAreShown() {\r\n    this.labelsAreShown = !this.labelsAreShown;\r\n  }\r\n\r\n  setIcon(icon: string) {\r\n    this.icon = icon;\r\n  }\r\n\r\n  getIcon() {\r\n    return this.icon;\r\n  }\r\n\r\n  // To edit the label of drawing\r\n  getFontSize() {\r\n    return this.fontSize;\r\n  }\r\n\r\n  setFontSize(fontSize: string) {\r\n    this.fontSize = fontSize;\r\n  }\r\n\r\n  getFontStyle() {\r\n    return this.fontStyle;\r\n  }\r\n\r\n  setFontStyle(fontStyle: string) {\r\n    this.fontStyle = fontStyle;\r\n  }\r\n\r\n  getOffsetX(): number {\r\n    return this.offsetX;\r\n  }\r\n\r\n  setOffsetX(offsetX: number) {\r\n    this.offsetX = offsetX;\r\n  }\r\n\r\n  getOffsetY(): number {\r\n    return this.offsetY;\r\n  }\r\n\r\n  setOffsetY(offsetY: number) {\r\n    this.offsetY = offsetY;\r\n  }\r\n\r\n  createIndividualElementStyle(\r\n    feature,\r\n    resolution,\r\n    labelsAreShown: boolean,\r\n    fontSizeAndStyle: string,\r\n    fillColor: string,\r\n    strokeColor: string,\r\n    offsetX: number,\r\n    offsetY: number,\r\n    icon?: string\r\n  ): OlStyle.Style {\r\n    let style;\r\n    let labelsAreOffset: boolean = false;\r\n    const proj = this.mapService.getMap().projection;\r\n    const geom = feature.getGeometry();\r\n\r\n    if (geom instanceof OlPoint) {\r\n      labelsAreOffset = !labelsAreOffset;\r\n    }\r\n\r\n    // if feature is a circle\r\n    if (feature.get('rad')) {\r\n      const coordinates = transform(feature.getGeometry().flatCoordinates, proj, 'EPSG:4326');\r\n\r\n      style = new OlStyle.Style({\r\n        text: new OlStyle.Text({\r\n          text: labelsAreShown ? feature.get('draw') : '',\r\n          stroke: new OlStyle.Stroke({\r\n            color: 'white',\r\n            width: 0.75\r\n          }),\r\n          fill: new OlStyle.Fill({\r\n            color: 'black'\r\n          }),\r\n\r\n          font: fontSizeAndStyle,\r\n          overflow: true,\r\n          offsetX: offsetX,\r\n          offsetY: offsetY\r\n        }),\r\n\r\n        image: new OlStyle.Circle({\r\n          radius: feature.get('rad') / Math.cos((Math.PI / 180) * coordinates[1]) / resolution,\r\n          stroke: new OlStyle.Stroke({\r\n            color: strokeColor ? strokeColor : this.strokeColor,\r\n            width: this.strokeWidth\r\n          }),\r\n          fill: new OlStyle.Fill({\r\n            color: fillColor\r\n          })\r\n        })\r\n      });\r\n      return style;\r\n\r\n      // if feature is an icon\r\n    } else if (icon) {\r\n      this.offsetY = -26;\r\n      style = new OlStyle.Style({\r\n        text: new OlStyle.Text({\r\n          text: labelsAreShown ? feature.get('draw') : '',\r\n          stroke: new OlStyle.Stroke({\r\n            color: 'white',\r\n            width: 0.75\r\n          }),\r\n          fill: new OlStyle.Fill({\r\n            color: 'black'\r\n          }),\r\n          font: fontSizeAndStyle,\r\n          overflow: true,\r\n          offsetX: offsetX,\r\n          offsetY: offsetY\r\n        }),\r\n\r\n        stroke: new OlStyle.Stroke({\r\n          color: strokeColor,\r\n          width: this.strokeWidth\r\n        }),\r\n\r\n        fill: new OlStyle.Fill({\r\n          color: fillColor\r\n        }),\r\n\r\n        image: new OlStyle.Icon({\r\n          src: icon\r\n        })\r\n      });\r\n      return style;\r\n\r\n      // if feature is a point, a linestring or a polygon\r\n    } else {\r\n      this.offsetY = labelsAreOffset ? -15 : 0;\r\n      style = new OlStyle.Style({\r\n        text: new OlStyle.Text({\r\n          text: labelsAreShown ? feature.get('draw') : '',\r\n          stroke: new OlStyle.Stroke({\r\n            color: 'white',\r\n            width: 0.75\r\n          }),\r\n          fill: new OlStyle.Fill({\r\n            color: 'black'\r\n          }),\r\n          font: fontSizeAndStyle,\r\n          overflow: true,\r\n\r\n          offsetX: offsetX,\r\n          offsetY: offsetY\r\n        }),\r\n\r\n        stroke: new OlStyle.Stroke({\r\n          color: strokeColor,\r\n          width: this.strokeWidth\r\n        }),\r\n\r\n        fill: new OlStyle.Fill({\r\n          color: fillColor\r\n        }),\r\n\r\n        image: new OlStyle.Circle({\r\n          radius: 5,\r\n          stroke: new OlStyle.Stroke({\r\n            color: strokeColor,\r\n            width: this.strokeWidth\r\n          }),\r\n          fill: new OlStyle.Fill({\r\n            color: fillColor\r\n          })\r\n        })\r\n      });\r\n      return style;\r\n    }\r\n  }\r\n}\r\n","<table class=\"igo-striped mat-typography\" *ngIf=\"ready && feature && isObject(feature.properties) && feature.properties.target !== 'iframe'\">\r\n  <tbody>\r\n    <tr *ngFor=\"let property of filterFeatureProperties(feature) | keyvalue\">\r\n\r\n      <td *ngIf=\"feature.properties.target === '_blank' && property.key === 'url'\">\r\n        <mat-icon mat-list-avatar svgIcon=\"{{icon}}\"></mat-icon>\r\n      </td>\r\n\r\n      <td *ngIf=\"feature.properties.target === '_blank' && property.key === 'url'\">\r\n        <a href=\"{{property.value}}\" target='_blank' rel=\"noopener noreferrer\"> {{ 'igo.geo.targetHtmlUrl' | translate }} {{title}}</a>\r\n        <button class=\"copyClipboard\" mat-icon-button (click)=\"copyTextToClipboard(property.value)\">\r\n          <mat-icon svgIcon=\"content-copy\"></mat-icon>\r\n        </button>\r\n      </td>\r\n\r\n      <td id=\"keyValue\" *ngIf=\"feature.properties.target === undefined\">\r\n        {{property.key}}\r\n      </td>\r\n\r\n      <td *ngIf=\"feature.properties.target === undefined && !isObject(property.value) && !isUrl(property.value) && !isEmbeddedLink(property.value)\" [innerHTML]=\"property.value\">\r\n      </td>\r\n\r\n      <td *ngIf=\"feature.properties.target === undefined && isEmbeddedLink(property.value)\">\r\n        <u [ngStyle]=\"{'cursor': 'pointer', 'color': 'blue'}\" (click)=\"openSecureUrl(property.value)\">{{ getEmbeddedLinkText(property.value) }}</u>\r\n      </td>\r\n\r\n      <td *ngIf=\"feature.properties.target === undefined && !isObject(property.value) && (isDoc(property.value) || isUrl(property.value)) && !isImg(property.value)\">\r\n        <u [ngStyle]=\"{'cursor': 'pointer', 'color': 'blue'}\" (click)=\"openSecureUrl(property.value)\">{{ 'igo.geo.targetHtmlUrl' | translate }}</u>\r\n        <button class=\"copyClipboard\" mat-icon-button (click)=\"copyTextToClipboard(property.value)\">\r\n          <mat-icon svgIcon=\"content-copy\"></mat-icon>\r\n        </button>\r\n      </td>\r\n\r\n      <td *ngIf=\"feature.properties.target === undefined && !isObject(property.value) && isUrl(property.value) && isImg(property.value)\">\r\n        <a href=\"{{property.value}}\" target='_blank' (click)=\"openSecureUrl(property.value)\" rel=\"noopener noreferrer\">\r\n          <img igoImageError src=\"{{(property.value | secureImage) |async}}\" width=\"225\" height=\"auto\">\r\n        </a>\r\n      </td>\r\n\r\n      <td *ngIf=\"feature.properties.target === undefined && isObject(property.value)\" [innerHTML]=\"property.value | json\">\r\n      </td>\r\n\r\n    </tr>\r\n  </tbody>\r\n</table>\r\n\r\n<iframe *ngIf=\"isHtmlDisplay()\" [srcdoc]=\"htmlSanitizer(feature.properties)\" [src]=\"urlSanitizer(feature.properties.url)\"></iframe>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef,\r\n  Output,\r\n  EventEmitter,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\nimport { DomSanitizer, SafeResourceUrl } from '@angular/platform-browser';\r\nimport { Subject } from 'rxjs';\r\nimport { takeUntil } from 'rxjs/operators';\r\n\r\nimport { userAgent } from '@igo2/utils';\r\nimport { NetworkService, ConnectionState, MessageService } from '@igo2/core';\r\nimport { ConfigService } from '@igo2/core';\r\nimport { getEntityTitle, getEntityIcon } from '@igo2/common';\r\nimport type { Toolbox } from '@igo2/common';\r\n\r\nimport { Feature } from '../shared';\r\nimport { SearchSource } from '../../search/shared/sources/source';\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { Clipboard } from '@igo2/utils';\r\n@Component({\r\n  selector: 'igo-feature-details',\r\n  templateUrl: './feature-details.component.html',\r\n  styleUrls: ['./feature-details.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\n\r\nexport class FeatureDetailsComponent implements OnInit, OnDestroy {\r\n  private state: ConnectionState;\r\n  private unsubscribe$ = new Subject<void>();\r\n  ready = false;\r\n\r\n  @Input()\r\n  get source(): SearchSource {\r\n    return this._source;\r\n  }\r\n  set source(value: SearchSource) {\r\n    this._source = value;\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() toolbox: Toolbox;\r\n\r\n  @Input()\r\n  get feature(): Feature {\r\n    return this._feature;\r\n  }\r\n  set feature(value: Feature) {\r\n    this._feature = value;\r\n    this.cdRef.detectChanges();\r\n    this.selectFeature.emit();\r\n  }\r\n\r\n  private _feature: Feature;\r\n  private _source: SearchSource;\r\n\r\n  @Output() routeEvent = new EventEmitter<boolean>();\r\n  @Output() selectFeature = new EventEmitter<boolean>();\r\n  @Output() htmlDisplayEvent = new EventEmitter<boolean>();\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get title(): string {\r\n    return getEntityTitle(this.feature);\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get icon(): string {\r\n    return getEntityIcon(this.feature) || 'link';\r\n  }\r\n\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private cdRef: ChangeDetectorRef,\r\n    private sanitizer: DomSanitizer,\r\n    private networkService: NetworkService,\r\n    private messageService: MessageService,\r\n    private configService: ConfigService\r\n  ) {\r\n    this.networkService.currentState().pipe(takeUntil(this.unsubscribe$)).subscribe((state: ConnectionState) => {\r\n      this.state = state;\r\n    });\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.ready = true;\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.unsubscribe$.next();\r\n    this.unsubscribe$.complete();\r\n  }\r\n\r\n  urlSanitizer(value): SafeResourceUrl {\r\n    return this.sanitizer.bypassSecurityTrustResourceUrl(value);\r\n  }\r\n\r\n\r\n  isHtmlDisplay(): boolean {\r\n    if (this.feature && this.isObject(this.feature.properties) && this.feature.properties.target === 'iframe') {\r\n      this.htmlDisplayEvent.emit(true);\r\n      return true;\r\n    } else {\r\n      this.htmlDisplayEvent.emit(false);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  htmlSanitizer(value): SafeResourceUrl {\r\n    if (!value.body || userAgent.getBrowserName() === 'Internet Explorer') {\r\n      return;\r\n    }\r\n    const regexBase = /<base href=\"[\\w:\\/\\.]+\">/;\r\n    if (!regexBase.test(value.body)) {\r\n      const url = new URL(value.url, window.location.origin);\r\n      value.body = value.body.replace('<head>', `<head><base href=\"${url.origin}\">`);\r\n    }\r\n\r\n    return this.sanitizer.bypassSecurityTrustHtml(value.body);\r\n  }\r\n\r\n  isObject(value) {\r\n    return typeof value === 'object';\r\n  }\r\n\r\n  openSecureUrl(value) {\r\n    let url: string;\r\n    const regexDepot = new RegExp(this.configService?.getConfig('depot.url') + '.*?(?=\"|$)');\r\n\r\n    if (regexDepot.test(value)) {\r\n      url = value.match(regexDepot)[0];\r\n\r\n      this.http.get(url, {\r\n        responseType: 'blob'\r\n      })\r\n      .subscribe((docOrImage) => {\r\n        const fileUrl = URL.createObjectURL(docOrImage);\r\n        window.open(fileUrl, '_blank');\r\n        this.cdRef.detectChanges();\r\n      },\r\n      (error: Error) => {\r\n        this.messageService.error('igo.geo.targetHtmlUrlUnauthorized', 'igo.geo.targetHtmlUrlUnauthorizedTitle');\r\n      });\r\n    } else {\r\n      let url = value;\r\n      if (this.isEmbeddedLink(value)) {\r\n        var div = document.createElement('div');\r\n        div.innerHTML = value;\r\n        url = div.children[0].getAttribute('href');\r\n      }\r\n      window.open(url, '_blank');\r\n    }\r\n  }\r\n\r\n  isUrl(value) {\r\n    if (typeof value === 'string') {\r\n      const regex = /^https?:\\/\\//;\r\n      return regex.test(value);\r\n    }\r\n  }\r\n\r\n  isDoc(value) {\r\n    if (typeof value === 'string') {\r\n      if (this.isUrl(value)) {\r\n        const regex = /(pdf|docx?|xlsx?)$/;\r\n        return regex.test(value.toLowerCase());\r\n      } else {\r\n        return false;\r\n      }\r\n    }\r\n  }\r\n\r\n  isImg(value) {\r\n    if (typeof value ==='string') {\r\n      if (this.isUrl(value)) {\r\n        const regex = /(jpe?g|png|gif)$/;\r\n        return regex.test(value.toLowerCase());\r\n      } else {\r\n        return false;\r\n      }\r\n    }\r\n  }\r\n\r\n  isEmbeddedLink(value) {\r\n    if (typeof value === 'string') {\r\n        const matchRegex = /<a/g;\r\n        const match = value.match(matchRegex) || [];\r\n        const count = match.length;\r\n        if (count === 1) {\r\n            return true;\r\n        } else {\r\n            return false;\r\n        }\r\n    }\r\n    return false;\r\n}\r\n\r\n  getEmbeddedLinkText(value) {\r\n    const regex = /(?:>).*?(?=<|$)/;\r\n    let text = value.match(regex)[0] as string;\r\n    text = text.replace(/>/g, '');\r\n    return text;\r\n  }\r\n\r\n  filterFeatureProperties(feature) {\r\n    const allowedFieldsAndAlias = feature.meta ? feature.meta.alias : undefined;\r\n    const properties = {};\r\n    let offlineButtonState;\r\n\r\n    if (this.map) {\r\n      this.map.offlineButtonToggle$.pipe(takeUntil(this.unsubscribe$)).subscribe(state => {\r\n        offlineButtonState = state;\r\n      });\r\n    }\r\n\r\n    if (feature.properties && feature.properties.Route && this.toolbox && !this.toolbox.getTool('directions')) {\r\n      delete feature.properties.Route;\r\n    }\r\n\r\n    if (allowedFieldsAndAlias) {\r\n      Object.keys(allowedFieldsAndAlias).forEach(field => {\r\n        properties[allowedFieldsAndAlias[field]] = feature.properties[field];\r\n      });\r\n      return properties;\r\n    } else if (offlineButtonState !== undefined) {\r\n      if (!offlineButtonState) {\r\n        if (this.state.connection && feature.meta && feature.meta.excludeAttribute) {\r\n          const excludeAttribute = feature.meta.excludeAttribute;\r\n          excludeAttribute.forEach(attribute => {\r\n            delete feature.properties[attribute];\r\n          });\r\n        } else if (!this.state.connection && feature.meta && feature.meta.excludeAttributeOffline) {\r\n          const excludeAttributeOffline = feature.meta.excludeAttributeOffline;\r\n          excludeAttributeOffline.forEach(attribute => {\r\n            delete feature.properties[attribute];\r\n          });\r\n        }\r\n      } else {\r\n        if (feature.meta && feature.meta.excludeAttributeOffline) {\r\n          const excludeAttributeOffline = feature.meta.excludeAttributeOffline;\r\n          excludeAttributeOffline.forEach(attribute => {\r\n            delete feature.properties[attribute];\r\n          });\r\n        }\r\n      }\r\n    } else {\r\n      if (this.state.connection && feature.meta && feature.meta.excludeAttribute) {\r\n        const excludeAttribute = feature.meta.excludeAttribute;\r\n        excludeAttribute.forEach(attribute => {\r\n          delete feature.properties[attribute];\r\n        });\r\n      } else if (!this.state.connection && feature.meta && feature.meta.excludeAttributeOffline) {\r\n        const excludeAttributeOffline = feature.meta.excludeAttributeOffline;\r\n        excludeAttributeOffline.forEach(attribute => {\r\n          delete feature.properties[attribute];\r\n        });\r\n      }\r\n    }\r\n    return feature.properties;\r\n  }\r\n\r\n  /**\r\n   * Copy the url to a clipboard\r\n   */\r\n  copyTextToClipboard(value: string): void {\r\n    const successful = Clipboard.copy(value);\r\n    if (successful) {\r\n      this.messageService.success('igo.geo.query.link.message');\r\n    }\r\n  }\r\n}\r\n","import OlCircle from 'ol/geom/Circle';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport * as olstyle from 'ol/style';\r\nimport OlLineString from 'ol/geom/LineString';\r\nimport OlLinearRing from 'ol/geom/LinearRing';\r\nimport OlPolygon from 'ol/geom/Polygon';\r\nimport BasicEvent from 'ol/events/Event';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport lineIntersect from '@turf/line-intersect';\r\nimport { lineString } from '@turf/helpers';\r\n\r\nimport {\r\n  GeometrySliceMultiPolygonError,\r\n  GeometrySliceLineStringError,\r\n  GeometrySliceTooManyIntersectionError\r\n } from './geometry.errors';\r\n\r\n/**\r\n * Create a default style for draw and modify interactions\r\n * @param color Style color (R, G, B)\r\n * @returns OL style\r\n */\r\nexport function createDrawInteractionStyle(color?: [number, number, number]): olstyle.Circle {\r\n  color = color || [0, 153, 255];\r\n  return new olstyle.Circle({\r\n    stroke: new olstyle.Stroke({\r\n      color: color.concat([1]),\r\n      width: 2\r\n    }),\r\n    fill:  new olstyle.Fill({\r\n      color: color.concat([0.2])\r\n    }),\r\n    radius: 8\r\n  });\r\n}\r\n\r\n/**\r\n * Create a default style for drawing a hole\r\n * @returns OL style\r\n */\r\nexport function createDrawHoleInteractionStyle(): olstyle.Style {\r\n  return new olstyle.Style({\r\n    stroke: new olstyle.Stroke({\r\n      color:  [0, 153, 255, 1],\r\n      width: 2\r\n    })\r\n  });\r\n}\r\n\r\n/**\r\n * Slice geometry into two parts\r\n * @param olGeometry OL geometry\r\n * @param olSlicer Slicing line\r\n * @returns New OL geometries\r\n */\r\nexport function sliceOlGeometry(\r\n  olGeometry: OlLineString | OlPolygon,\r\n  olSlicer: OlLineString\r\n): Array<OlLineString | OlPolygon> {\r\n  if (olGeometry instanceof OlPolygon) {\r\n    return sliceOlPolygon(olGeometry, olSlicer);\r\n  } else if (olGeometry instanceof OlLineString) {\r\n    return sliceOlLineString(olGeometry, olSlicer);\r\n  }\r\n  return [];\r\n}\r\n\r\n/**\r\n * Slice OL LineString into one or more lines\r\n * @param olLineString OL line string\r\n * @param olSlicer Slicing line\r\n * @returns New OL line strings\r\n */\r\nexport function sliceOlLineString(olLineString: OlLineString, olSlicer: OlLineString): OlLineString[] {\r\n  return [];\r\n}\r\n\r\n/**\r\n * Slice OL Polygon into one or more polygons\r\n * @param olPolygon OL polygon\r\n * @param olSlicer Slicing line\r\n * @returns New OL polygons\r\n */\r\nexport function sliceOlPolygon(olPolygon: OlPolygon, olSlicer: OlLineString): OlPolygon[] {\r\n  if (olPolygon.getLinearRingCount() > 1) {\r\n    throw new GeometrySliceMultiPolygonError();\r\n  }\r\n\r\n  if (olSlicer.getCoordinates().length > 2) {\r\n    throw new GeometrySliceLineStringError();\r\n  }\r\n\r\n  const olGeoJSON = new OlGeoJSON();\r\n  const slicer = olGeoJSON.writeGeometryObject(olSlicer) as any;\r\n  const outerCoordinates = olPolygon.getLinearRing(0).getCoordinates();\r\n\r\n  const parts = [[], []];\r\n  let totalIntersectionCount = 0;\r\n  for (let i = 0, ii = outerCoordinates.length - 1; i < ii; i++) {\r\n    const segmentCoordinates = [outerCoordinates[i], outerCoordinates[i + 1]];\r\n    const segment = lineString(segmentCoordinates);\r\n    const intersections = lineIntersect(segment, slicer).features;\r\n\r\n    const intersectionCount = intersections.length;\r\n    totalIntersectionCount += intersectionCount;\r\n    if (intersectionCount > 1 || totalIntersectionCount > 2) {\r\n      throw new GeometrySliceTooManyIntersectionError();\r\n    }\r\n\r\n    parts[0].push(segmentCoordinates[0]);\r\n    if (intersectionCount === 1) {\r\n      const intersection = intersections[0].geometry.coordinates;\r\n      parts[0].push(intersection);\r\n      parts[1].push(intersection);\r\n      parts.reverse();\r\n    }\r\n  }\r\n\r\n  if (totalIntersectionCount <= 1) {\r\n    return [];\r\n  }\r\n\r\n  parts[0].push(parts[0][0]);\r\n  parts[1].push(parts[1][0]);\r\n\r\n  return [new OlPolygon([parts[0]]), new OlPolygon([parts[1]])];\r\n}\r\n\r\n/**\r\n * Splice geometry into two parts\r\n * @param olGeometry OL geometry\r\n * @param olSlicer Slicing line\r\n * @returns New OL geometries\r\n */\r\nexport function addLinearRingToOlPolygon(olPolygon: OlPolygon, olLinearRing: OlLinearRing ) {\r\n  // TODO: make some validation and support updating an existing linear ring\r\n  olPolygon.appendLinearRing(olLinearRing);\r\n}\r\n\r\nexport function getMousePositionFromOlGeometryEvent(\r\n  olEvent: BasicEvent\r\n) {\r\n  const olGeometry = olEvent.target as OlGeometry;\r\n  if (olGeometry instanceof OlPolygon) {\r\n    return olGeometry.getFlatCoordinates().slice(-4, -2) as [number, number];\r\n  }\r\n  const olGeometryCast = olGeometry as OlPoint | OlLineString | OlCircle;\r\n  return olGeometryCast.getFlatCoordinates().slice(-2) as [number, number];\r\n}\r\n","/* eslint-disable */\r\n// See this issue: https://github.com/Microsoft/TypeScript/issues/13965\r\n// And the solution: https://github.com/Microsoft/TypeScript/wiki/Breaking-Changes#extending-built-ins-like-error-array-and-map-may-no-longer-work\r\n// for an explanation as to why the prototype is set manually\r\n/* eslint-enable */\r\n\r\nexport class GeometrySliceError extends Error {}\r\n\r\nexport class GeometrySliceMultiPolygonError extends GeometrySliceError {\r\n  constructor() {\r\n    super('Can\\'t slice a MultiPolygon.');\r\n    Object.setPrototypeOf(this, GeometrySliceMultiPolygonError.prototype);\r\n  }\r\n}\r\n\r\nexport class GeometrySliceLineStringError extends GeometrySliceError {\r\n  constructor() {\r\n    super('Can\\'t slice with a line that has more than 2 points.');\r\n    Object.setPrototypeOf(this, GeometrySliceLineStringError.prototype);\r\n  }\r\n}\r\n\r\nexport class GeometrySliceTooManyIntersectionError extends GeometrySliceError {\r\n  constructor() {\r\n    super('More than 2 intersections found between the target polygon and the slicing line.');\r\n    Object.setPrototypeOf(this, GeometrySliceTooManyIntersectionError.prototype);\r\n  }\r\n}\r\n","import { EventsKey } from 'ol/events';\r\nimport OlMap from 'ol/Map';\r\nimport { StyleLike as OlStyleLike } from 'ol/style/Style';\r\nimport type { Type } from 'ol/geom/Geometry';\r\nimport OlVectorSource from 'ol/source/Vector';\r\nimport OlVectorLayer from 'ol/layer/Vector';\r\nimport OlDraw from 'ol/interaction/Draw';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport OlModify from 'ol/interaction/Modify';\r\nimport OlSelect from 'ol/interaction/Select';\r\nimport BasicEvent from 'ol/events/Event';\r\nimport { DrawEvent as OlDrawEvent } from 'ol/interaction/Draw';\r\nimport { SelectEvent as OlSelectEvent } from 'ol/interaction/Select';\r\nimport { unByKey } from 'ol/Observable';\r\nimport { doubleClick } from 'ol/events/condition';\r\n\r\nimport { Subject, Subscription, fromEvent, BehaviorSubject } from 'rxjs';\r\n\r\nimport { getMousePositionFromOlGeometryEvent } from '../geometry.utils';\r\n\r\nexport interface DrawControlOptions {\r\n  geometryType: Type | string;\r\n  drawingLayerSource?: OlVectorSource<OlGeometry>;\r\n  drawingLayer?: OlVectorLayer<OlVectorSource<OlGeometry>>;\r\n  drawingLayerStyle?: OlStyleLike;\r\n  interactionStyle?: OlStyleLike;\r\n  maxPoints?: number;\r\n}\r\n\r\n/**\r\n * Control to draw entities\r\n */\r\nexport class DrawControl {\r\n  /**\r\n   * Draw start observable\r\n   */\r\n  public start$: Subject<OlGeometry> = new Subject();\r\n\r\n  /**\r\n   * Draw end observable\r\n   */\r\n  public end$: Subject<OlGeometry> = new Subject();\r\n\r\n  /**\r\n   * Draw changes observable (while drawing)\r\n   */\r\n  public changes$: Subject<any> = new Subject();\r\n\r\n  /**\r\n   * Draw modify observable (modify drawn features)\r\n   */\r\n  public modify$: Subject<OlGeometry> = new Subject();\r\n\r\n  /**\r\n   * Draw select observable (modify drawn features)\r\n   */\r\n  public select$: Subject<any> = new Subject();\r\n\r\n  /**\r\n   * Draw abort observable (abort drawn features)\r\n   */\r\n     public abort$: Subject<any> = new Subject();\r\n\r\n  /**\r\n   * Freehand mode observable (defaults to false)\r\n   */\r\n  freehand$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  private keyDown$$: Subscription;\r\n\r\n  private olGeometryType: Type;\r\n  private olMap: OlMap;\r\n  private olDrawingLayer: OlVectorLayer<OlVectorSource<OlGeometry>>;\r\n  private olDrawInteraction: OlDraw;\r\n  private olSelectInteraction: OlSelect;\r\n  private olModifyInteraction: OlModify;\r\n  private onDrawStartKey: EventsKey;\r\n  private onDrawEndKey: EventsKey;\r\n  private onDrawAbortKey: EventsKey;\r\n  private onDrawKey: EventsKey;\r\n\r\n  private mousePosition: [number, number];\r\n\r\n  /**\r\n   * Wheter the control is active\r\n   */\r\n  get active(): boolean {\r\n    return this.olMap !== undefined;\r\n  }\r\n\r\n  /**\r\n   * OL overlay source\r\n   * @internal\r\n   */\r\n  get olDrawingLayerSource(): OlVectorSource<OlGeometry> {\r\n    return this.olDrawingLayer.getSource();\r\n  }\r\n\r\n  constructor(private options: DrawControlOptions) {\r\n    this.olDrawingLayer = options.drawingLayer ? options.drawingLayer : this.createOlInnerOverlayLayer();\r\n    this.olGeometryType = this.options.geometryType as Type;\r\n  }\r\n\r\n  /**\r\n   * Add or remove this control to/from a map.\r\n   * @param map OL Map\r\n   */\r\n  setOlMap(olMap: OlMap | undefined, activateModifyAndSelect?: boolean) {\r\n    if (!olMap) {\r\n      this.clearOlInnerOverlaySource();\r\n      this.removeOlInnerOverlayLayer();\r\n      this.removeOlInteractions();\r\n      this.olMap = olMap;\r\n      return;\r\n    }\r\n\r\n    this.olMap = olMap;\r\n    this.addOlInnerOverlayLayer();\r\n    this.addOlInteractions(activateModifyAndSelect);\r\n  }\r\n\r\n  /**\r\n   * Return the drawing layer source\r\n   */\r\n  getSource(): OlVectorSource<OlGeometry> {\r\n    return this.olDrawingLayerSource;\r\n  }\r\n\r\n  /**\r\n   * Set the current geometry type\r\n   * @param geometryType the geometry type\r\n   */\r\n  setGeometryType(geometryType: Type) {\r\n    this.olGeometryType = geometryType;\r\n  }\r\n\r\n  /**\r\n   * Create a drawing source if none is defined in the options\r\n   */\r\n  private createOlInnerOverlayLayer(): OlVectorLayer<OlVectorSource<OlGeometry>> {\r\n    return new OlVectorLayer({\r\n      source: this.options.drawingLayerSource ? this.options.drawingLayerSource : new OlVectorSource(),\r\n      style: this.options.drawingLayerStyle,\r\n      zIndex: 500\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Clear the drawing layer if it wasn't defined in the options\r\n   */\r\n  private removeOlInnerOverlayLayer() {\r\n    if (!this.options.drawingLayer && this.olMap) {\r\n      this.olMap.removeLayer(this.olDrawingLayer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add the drawing layer if it wasn't defined in the options\r\n   */\r\n  private addOlInnerOverlayLayer() {\r\n    if (!this.options.drawingLayer) {\r\n      this.olMap.addLayer(this.olDrawingLayer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the drawing layer source if it wasn't defined in the options\r\n   */\r\n  private clearOlInnerOverlaySource() {\r\n    if (!this.options.drawingLayer && !this.options.drawingLayerSource) {\r\n      this.olDrawingLayerSource.clear(true);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add interactions to the map an set up some listeners\r\n   */\r\n  addOlInteractions(activateModifyAndSelect?: boolean) {\r\n    // Create Draw interaction\r\n    let olDrawInteraction;\r\n    if (!this.freehand$.getValue()) {\r\n      olDrawInteraction = new OlDraw({\r\n        type: this.olGeometryType,\r\n        source: this.getSource(),\r\n        stopClick: true,\r\n        style: this.options.interactionStyle,\r\n        maxPoints: this.options.maxPoints,\r\n        freehand: false,\r\n        freehandCondition: () => false\r\n      });\r\n\r\n    } else {\r\n      if (this.olGeometryType === 'Point') {\r\n        olDrawInteraction = new OlDraw({\r\n          type: 'Circle',\r\n          source: this.getSource(),\r\n          maxPoints: this.options.maxPoints,\r\n          freehand: true\r\n        });\r\n\r\n      } else {\r\n        olDrawInteraction = new OlDraw({\r\n          type: this.olGeometryType,\r\n          source: this.getSource(),\r\n          maxPoints: this.options.maxPoints,\r\n          freehand: true\r\n        });\r\n      }\r\n    }\r\n\r\n    // Add Draw interaction to map and create listeners\r\n    this.olMap.addInteraction(olDrawInteraction);\r\n    this.olDrawInteraction = olDrawInteraction;\r\n\r\n    this.onDrawStartKey = olDrawInteraction.on('drawstart', (event: OlDrawEvent) => this.onDrawStart(event));\r\n    this.onDrawEndKey = olDrawInteraction.on('drawend', (event: OlDrawEvent) => this.onDrawEnd(event));\r\n    this.onDrawAbortKey = olDrawInteraction.on('drawabort', (event: OlDrawEvent) => this.abort$.next(event.feature.getGeometry()));\r\n\r\n    if (activateModifyAndSelect) {\r\n      // Create a Modify interaction, add it to map and create a listener\r\n      const olModifyInteraction = new OlModify({\r\n        source: this.getSource()\r\n      });\r\n\r\n      this.olMap.addInteraction(olModifyInteraction);\r\n      this.olModifyInteraction = olModifyInteraction;\r\n\r\n      // Create a select interaction and add it to map\r\n      if (!this.olSelectInteraction) {\r\n        const olSelectInteraction = new OlSelect({\r\n          condition: doubleClick,\r\n          style: undefined\r\n        });\r\n        this.olMap.addInteraction(olSelectInteraction);\r\n        this.olSelectInteraction = olSelectInteraction;\r\n\r\n        this.olSelectInteraction.on('select', (event: OlSelectEvent) => this.onSelect(event));\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove interactions\r\n   */\r\n  private removeOlInteractions() {\r\n    this.unsubscribeKeyDown();\r\n    unByKey([this.onDrawStartKey, this.onDrawEndKey, this.onDrawKey, this.onDrawAbortKey]);\r\n\r\n    if (this.olMap) {\r\n      this.olMap.removeInteraction(this.olDrawInteraction);\r\n      this.olMap.removeInteraction(this.olModifyInteraction);\r\n    }\r\n\r\n    this.olDrawInteraction = undefined;\r\n    this.olModifyInteraction = undefined;\r\n  }\r\n\r\n  /**\r\n   * When drawing starts, clear the overlay and start watching for changes\r\n   * @param event Draw start event\r\n   */\r\n  private onDrawStart(event: OlDrawEvent) {\r\n    const olGeometry = event.feature.getGeometry();\r\n    this.start$.next(olGeometry);\r\n    this.clearOlInnerOverlaySource();\r\n    this.onDrawKey = olGeometry.on('change', (olGeometryEvent: BasicEvent) => {\r\n      this.mousePosition = getMousePositionFromOlGeometryEvent(olGeometryEvent);\r\n      this.changes$.next(olGeometryEvent.target);\r\n    });\r\n    this.subscribeKeyDown();\r\n  }\r\n\r\n  /**\r\n   * When drawing ends, update the drawing (feature) geometry observable and add\r\n   * @param event Draw event (drawend)\r\n   */\r\n  private onDrawEnd(event: OlDrawEvent) {\r\n    this.unsubscribeKeyDown();\r\n    unByKey(this.onDrawKey);\r\n    const olGeometry = event.feature.getGeometry();\r\n    olGeometry.on('change', () => {\r\n      this.modify$.next(olGeometry);\r\n    });\r\n    this.end$.next(olGeometry);\r\n  }\r\n\r\n  /**\r\n   * When a feature is selected, update the selected feature observable\r\n   * @param event Modify event (modifyend)\r\n   */\r\n  private onSelect(event: OlSelectEvent) {\r\n    if (event.selected.length === 1) {\r\n      this.select$.next(event.selected[0]);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Subscribe to key downs used as drawing interaction shorcuts\r\n   */\r\n  private subscribeKeyDown() {\r\n    this.unsubscribeKeyDown();\r\n    this.keyDown$$ = fromEvent(document, 'keydown').subscribe((event: KeyboardEvent) => {\r\n      // On Escape or 'c' keydowns, abort the current drawing\r\n      if (event.key === 'Escape') {\r\n        this.olDrawInteraction.abortDrawing();\r\n        return;\r\n      }\r\n\r\n      // On Backspace or 'u' keydowns, remove last vertex of current drawing\r\n      if (event.key === 'Backspace') {\r\n        this.olDrawInteraction.removeLastPoint();\r\n      }\r\n\r\n      // On Enter or 'f' keydowns, finish current drawing\r\n      if (event.key === 'Enter') {\r\n        this.olDrawInteraction.finishDrawing();\r\n      }\r\n\r\n      // On space bar key down, pan to the current mouse position\r\n      if (event.key === ' ') {\r\n        this.olMap.getView().animate({\r\n          center: this.mousePosition,\r\n          duration: 100\r\n        });\r\n        return;\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to key down\r\n   */\r\n  private unsubscribeKeyDown() {\r\n    if (this.keyDown$$) {\r\n      this.keyDown$$.unsubscribe();\r\n      this.keyDown$$ = undefined;\r\n    }\r\n  }\r\n}\r\n","import { Component, Inject, Input } from '@angular/core';\r\nimport { MatDialogRef, MAT_DIALOG_DATA } from '@angular/material/dialog';\r\n\r\n@Component({\r\n  selector: 'igo-draw-popup-component',\r\n  templateUrl: './draw-popup.component.html',\r\n  styleUrls: ['./draw-popup.component.scss']\r\n  })\r\nexport class DrawPopupComponent {\r\n  @Input() confirmFlag: boolean = false;\r\n\r\n  constructor(\r\n    public dialogRef: MatDialogRef<DrawPopupComponent>,\r\n    @Inject(MAT_DIALOG_DATA) public data: { currentLabel: string }){}\r\n\r\n  cancelDrawing() {\r\n    this.dialogRef.close();\r\n  }\r\n\r\n  confirm(labelString: string) {\r\n    this.confirmFlag = true;\r\n    this.dialogRef.close(labelString);\r\n  }\r\n}\r\n","<div mat-dialog-content>\r\n  <p class=\"mat-typography\">{{ 'igo.geo.draw.dialogInstruction' | translate }}</p>\r\n  <mat-form-field class=\"example-full-width\">\r\n    <input\r\n      #input\r\n      matInput\r\n      placeholder=\"{{'igo.geo.draw.dialogTitle' | translate}}\"\r\n      value=\"{{data.currentLabel}}\"/>\r\n  </mat-form-field>\r\n</div>\r\n<div mat-dialog-actions>\r\n  <button \r\n    mat-raised-button \r\n    (click)=\"cancelDrawing()\">{{'igo.geo.draw.cancel' | translate}}\r\n  </button>\r\n  <button \r\n    mat-raised-button \r\n    color=\"primary\" \r\n    (click)=\"confirm(input.value)\">OK\r\n  </button>\r\n</div>\r\n","import { Component } from '@angular/core';\r\n\r\n@Component({\r\n  selector: 'igo-draw-shorcuts',\r\n  templateUrl: './draw-shorcuts.component.html',\r\n  styleUrls: ['./draw-shorcuts.component.scss']\r\n})\r\n\r\nexport class DrawShorcutsComponent {}\r\n","<mat-dialog-content>\r\n  <div>\r\n    <span class=\"shortcut mat-typography\">\r\n      <mat-icon class=\"shortcut-icon\" svgIcon=\"keyboard-return\"></mat-icon>{{'igo.geo.draw.finish' | translate}}</span>\r\n  </div>\r\n  <div>\r\n    <span class=\"shortcut mat-typography\">\r\n      <mat-icon class=\"shortcut-icon\" svgIcon=\"backspace-outline\"></mat-icon>{{'igo.geo.draw.undo' | translate}}</span>\r\n  </div>\r\n  <div>\r\n    <span class=\"shortcut mat-typography\">\r\n      <mat-icon class=\"shortcut-icon\" svgIcon=\"keyboard-esc\"></mat-icon>{{'igo.geo.draw.abort' | translate}}</span>\r\n  </div>\r\n  <div>\r\n    <span class=\"shortcut mat-typography\">\r\n      <mat-icon class=\"shortcut-icon\" svgIcon=\"keyboard-space\"></mat-icon>{{'igo.geo.draw.move' | translate}}</span>\r\n  </div>\r\n</mat-dialog-content>\r\n<mat-dialog-actions class=\"shortcuts-close\">\r\n  <button mat-raised-button mat-dialog-close color=\"primary\">OK</button>\r\n</mat-dialog-actions>","import { Component, Input } from '@angular/core';\r\nimport { MatDialogRef } from '@angular/material/dialog';\r\n\r\nexport interface DialogData {\r\n  label: string;\r\n}\r\n\r\n@Component({\r\n  selector: 'igo-draw-popup-component',\r\n  templateUrl: './draw-layer-popup.component.html',\r\n  styleUrls: ['./draw-layer-popup.component.scss']\r\n})\r\nexport class DrawLayerPopupComponent {\r\n  @Input() confirmFlag: boolean = false;\r\n\r\n  constructor(\r\n    public dialogRef: MatDialogRef<DrawLayerPopupComponent>,\r\n    // @Inject(MAT_DIALOG_DATA) public data: { currentLabel: string }\r\n  ) {}\r\n\r\n  cancelDrawing() {\r\n    this.dialogRef.close();\r\n  }\r\n  confirm(labelString: string) {\r\n    this.confirmFlag = true;\r\n    this.dialogRef.close(labelString);\r\n  }\r\n}\r\n","<div mat-dialog-content>\r\n  <p class=\"mat-typography\">\r\n    {{ 'igo.geo.draw.layer.layerDialogInstruction' | translate }}\r\n  </p>\r\n  <mat-form-field class=\"example-full-width\">\r\n    <input\r\n      #input\r\n      matInput\r\n      placeholder=\"{{ 'igo.geo.draw.layer.title' | translate }}\"\r\n      />\r\n  </mat-form-field>\r\n</div>\r\n<div mat-dialog-actions>\r\n  <button mat-raised-button (click)=\"cancelDrawing()\">\r\n    {{ 'igo.geo.draw.cancel' | translate }}\r\n  </button>\r\n  <button mat-raised-button color=\"primary\" (click)=\"confirm(input.value)\">\r\n    OK\r\n  </button>\r\n</div>\r\n","<div>\r\n  <div class=\"geometry-type-toggle mat-typography\">\r\n    <mat-button-toggle-group\r\n      (change)=\"onGeometryTypeChange($event.value)\" [value]=\"geometryType.Point\">\r\n      <mat-button-toggle [value]=\"geometryType.Point\">\r\n        {{'igo.geo.draw.' + geometryType.Point | translate}}\r\n      </mat-button-toggle>\r\n\r\n      <mat-button-toggle [value]=\"geometryType.LineString\">\r\n        {{'igo.geo.draw.' + geometryType.LineString | translate}}\r\n      </mat-button-toggle>\r\n\r\n      <mat-button-toggle [value]=\"geometryType.Polygon\">\r\n        {{'igo.geo.draw.' + geometryType.Polygon | translate}}\r\n      </mat-button-toggle>\r\n\r\n      <mat-button-toggle [value]=\"geometryType.Circle\">\r\n        {{'igo.geo.draw.' + geometryType.Circle | translate}}\r\n      </mat-button-toggle>\r\n    </mat-button-toggle-group>\r\n  </div>\r\n\r\n  <div class=\"draw-options mat-typography\">\r\n    <mat-slide-toggle\r\n      [disabled]=\"drawControlIsDisabled\"\r\n      [checked]=\"drawControlIsActive\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onToggleDrawControl($event.checked)\">\r\n      {{'igo.geo.spatialFilter.drawControl' | translate}}\r\n    </mat-slide-toggle>\r\n\r\n    <mat-slide-toggle\r\n      [checked]=\"labelsAreShown\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onToggleLabels()\"\r\n    >\r\n      {{ 'igo.geo.draw.toggleMapTooltips' | translate }}\r\n    </mat-slide-toggle>\r\n  </div>\r\n\r\n  <mat-divider></mat-divider>\r\n\r\n  <div>\r\n    <mat-form-field appearance=\"outline\" class=\"layer-select\">\r\n      <mat-label>{{'igo.geo.draw.layer.title' | translate}}</mat-label>\r\n      <mat-select #selectedLayer (selectionChange)=\"onLayerChange(selectedLayer.value)\" [value]=\"updateActiveLayer()\">\r\n        <mat-option *ngFor=\"let layer of allLayers\" [value]=\"layer\">\r\n          {{ layer.title }}\r\n        </mat-option>\r\n        <mat-option id=\"createNewLayer\" >\r\n          {{'igo.geo.draw.layer.createNewLayer' | translate}}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n    <button\r\n      *ngIf=\"activeDrawingLayer\"\r\n      mat-icon-button\r\n      [color]=\"activeDrawingLayer.visible ? 'primary' : 'default'\"\r\n      collapsibleButton\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"activeDrawingLayer.visible ?\r\n                    ('igo.geo.layer.hideLayer' | translate) :\r\n                    ('igo.geo.layer.showLayer' | translate)\"\r\n      (click)=\"activeDrawingLayer.visible = !activeDrawingLayer.visible\">\r\n      <mat-icon\r\n        [svgIcon]=\"activeDrawingLayer.visible ? 'eye' : 'eye-off'\">\r\n      </mat-icon>\r\n    </button>\r\n  </div>\r\n  <mat-divider></mat-divider>\r\n  <div>\r\n    <button\r\n      *ngIf=\"activeStore.count$.getValue() > 0\"\r\n      class=\"deleteBtn\"\r\n      mat-icon-button\r\n      color=\"warn\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.draw.delete' | translate\"\r\n      [disabled]=\"(selectedFeatures$ | async).length === 0\"\r\n      (click)=\"deleteDrawings()\">\r\n      <mat-icon svgIcon=\"delete\"></mat-icon>\r\n    </button>\r\n\r\n    <div>\r\n      <igo-entity-table\r\n        #table\r\n        class=\"table-compact\"\r\n        [store]=\"activeStore\"\r\n        [template]=\"tableTemplate\"\r\n        (dblclick)=\"editLabelDrawing()\">\r\n      </igo-entity-table>\r\n    </div>\r\n  </div>\r\n\r\n  <div class=\"icon-options\">\r\n    <mat-form-field *ngIf=\"icons.length >= 1\">\r\n      <mat-label>{{ 'igo.geo.draw.icon' | translate }}</mat-label>\r\n      <mat-select>\r\n        <mat-select-trigger>\r\n          <div *ngIf=\"icon\" class=\"box\">\r\n            <img src=\"{{ icon }}\">\r\n          </div>\r\n        </mat-select-trigger>\r\n        <mat-option value=\"\" (click)=\"onIconChange()\">{{ 'igo.geo.draw.noIcon' | translate }}</mat-option>\r\n        <mat-option\r\n          *ngFor=\"let icon_html of icons\"\r\n          [value]=\"icon_html\"\r\n          (click)=\"onIconChange(icon_html)\">\r\n          <div class=\"box\">\r\n            <img src=\"{{ icon_html }}\">\r\n          </div>\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <button\r\n    mat-icon-button\r\n    color=\"accent\"\r\n    disableRipple=\"true\"\r\n    (click)=\"openShorcutsDialog()\"\r\n  >\r\n    <mat-icon\r\n      class=\"shortcuts-icon\"\r\n      svgIcon=\"keyboard-outline\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.draw.shortcuts' | translate\"\r\n    >\r\n    </mat-icon>\r\n  </button>\r\n\r\n  <button\r\n    *ngIf=\"selectedFeatures$.value.length\"\r\n    mat-raised-button\r\n    color=\"primary\"\r\n    (click)=\"openStyleModalDialog()\"\r\n    [matTooltip]=\"'igo.geo.layer.style.styleModalTooltip' | translate\">\r\n    {{'igo.geo.layer.style.styleModal' | translate}}\r\n    <mat-icon\r\n      class=\"style-icon\"\r\n      svgIcon=\"palette\"\r\n      [matBadge]=\"selectedFeatures$.value.length\"\r\n      matBadgeColor=\"warn\"\r\n      matBadgeSize=\"medium\">\r\n    </mat-icon>\r\n  </button>\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy,\r\n  Output,\r\n  EventEmitter,\r\n  ViewChild\r\n} from '@angular/core';\r\n\r\nimport {\r\n  FEATURE,\r\n  FeatureStore,\r\n  FeatureStoreSelectionStrategy,\r\n  tryBindStoreLayer,\r\n  tryAddLoadingStrategy,\r\n  tryAddSelectionStrategy,\r\n  FeatureMotion,\r\n  FeatureStoreLoadingStrategy,\r\n  featureToOl\r\n} from '../../feature';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { MatDialog } from '@angular/material/dialog';\r\nimport { FontType, GeometryType } from '../shared/draw.enum';\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport { Draw, FeatureWithDraw } from '../shared/draw.interface';\r\nimport { UntypedFormGroup, UntypedFormBuilder } from '@angular/forms';\r\nimport { VectorSourceEvent as OlVectorSourceEvent } from 'ol/source/Vector';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { DrawControl } from '../../geometry/shared/controls/draw';\r\nimport {\r\n  EntityRecord,\r\n  EntityTableTemplate\r\n} from '@igo2/common';\r\n\r\nimport * as OlStyle from 'ol/style';\r\nimport OlVectorSource from 'ol/source/Vector';\r\nimport OlCircle from 'ol/geom/Circle';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport OlFeature from 'ol/Feature';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport OlOverlay from 'ol/Overlay';\r\nimport type { Type } from 'ol/geom/Geometry';\r\nimport { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport { getDistance } from 'ol/sphere';\r\nimport { DrawStyleService } from '../shared/draw-style.service';\r\nimport { first, skip } from 'rxjs/operators';\r\nimport { DrawPopupComponent } from './draw-popup.component';\r\nimport { DrawShorcutsComponent } from './draw-shorcuts.component';\r\nimport { getTooltipsOfOlGeometry } from '../../measure/shared/measure.utils';\r\nimport { createInteractionStyle } from '../shared/draw.utils';\r\nimport { transform } from 'ol/proj';\r\nimport { DrawIconService } from '../shared/draw-icon.service';\r\nimport { StyleModalComponent, StyleModalData } from '../../layer/style-modal/style-modal.component';\r\n\r\nimport {\r\n  trigger,\r\n  state,\r\n  style,\r\n  animate,\r\n  transition\r\n} from '@angular/animations';\r\nimport Point from 'ol/geom/Point';\r\n\r\nimport { DrawLayerPopupComponent } from './draw-layer-popup.component';\r\n\r\n@Component({\r\n  selector: 'igo-draw',\r\n  animations: [\r\n    trigger('openClose', [\r\n      state(\r\n        'open',\r\n        style({\r\n          opacity: 1\r\n        })\r\n      ),\r\n      state(\r\n        'closed',\r\n        style({\r\n          opacity: 0\r\n        })\r\n      ),\r\n      transition('open => closed', [animate('600ms ease')]),\r\n      transition('closed => open', [animate('800ms ease')])\r\n    ])\r\n  ],\r\n  templateUrl: './draw.component.html',\r\n  styleUrls: ['./draw.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class DrawComponent implements OnInit, OnDestroy {\r\n  /**\r\n   * Table template\r\n   * @internal\r\n   */\r\n  public tableTemplate: EntityTableTemplate = {\r\n    selection: true,\r\n    selectMany: true,\r\n    selectionCheckbox: true,\r\n    sort: true,\r\n    fixedHeader: true,\r\n    tableHeight: 'auto',\r\n    columns: [\r\n      {\r\n        name: 'Drawing',\r\n        title: this.languageService.translate.instant('igo.geo.draw.labels'),\r\n        tooltip: this.languageService.translate.instant('igo.geo.draw.changeLabel'),\r\n        valueAccessor: (feature: FeatureWithDraw) => {\r\n          return feature.properties.draw;\r\n        }\r\n      }\r\n    ]\r\n  };\r\n\r\n  public geometryType = GeometryType; // Reference to the GeometryType enum\r\n  @Input() map: IgoMap; // Map to draw on\r\n\r\n  @Input()\r\n  get stores(): FeatureStore<FeatureWithDraw>[] {\r\n    return this._stores;\r\n  }\r\n  set stores(value: FeatureStore<FeatureWithDraw>[]) {\r\n    this._stores = value;\r\n  }\r\n  private _stores:FeatureStore<FeatureWithDraw>[] = [];\r\n\r\n  @Input()\r\n  get drawControls(): [string, DrawControl][]{\r\n    return this._drawControls;\r\n  }\r\n  set drawControls(value: [string, DrawControl][]){\r\n    this._drawControls = value;\r\n  }\r\n  private _drawControls = [];\r\n\r\n  @Input()\r\n  get activeDrawingLayer(): VectorLayer {\r\n    return this._activeDrawingLayer;\r\n  }\r\n  set activeDrawingLayer(value: VectorLayer) {\r\n    this._activeDrawingLayer = value;\r\n  }\r\n  private _activeDrawingLayer: VectorLayer;\r\n\r\n  @Output() activeLayerChange = new EventEmitter<VectorLayer>();\r\n  @Output() drawControlsEvent = new EventEmitter<[string, DrawControl][]>();\r\n  @Output() layersIDEvent = new EventEmitter<string>();\r\n\r\n  @Output() fillColor: string;\r\n  @Output() strokeColor: string;\r\n  @Output() strokeWidth: number;\r\n\r\n  @Output() fontSize: string;\r\n  @Output() fontStyle: string;\r\n\r\n  public activeStore: FeatureStore<FeatureWithDraw>;\r\n  private layerCounterID: number = 0;\r\n  public draw$: BehaviorSubject<Draw> = new BehaviorSubject({}); // Observable of draw\r\n  private activeDrawingLayerSource = new OlVectorSource();\r\n  private activeDrawControl: DrawControl;\r\n  private drawEnd$$: Subscription;\r\n  private drawSelect$$: Subscription;\r\n  public selectedFeatures$: BehaviorSubject<FeatureWithDraw[]> =\r\n    new BehaviorSubject([]);\r\n  public fillForm: string;\r\n  public strokeForm: string;\r\n  public drawControlIsDisabled: boolean = true;\r\n  public drawControlIsActive: boolean = false;\r\n  public labelsAreShown: boolean;\r\n  private subscriptions$$: Subscription[] = [];\r\n\r\n  public position: string = 'bottom';\r\n  public form: UntypedFormGroup;\r\n  public icons: Array<string>;\r\n  public icon: string;\r\n\r\n  private numberOfDrawings: number;\r\n  public isCreatingNewLayer: boolean = false;\r\n  private currGeometryType = this.geometryType.Point as any;\r\n\r\n  @ViewChild('selectedLayer') select;\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private formBuilder: UntypedFormBuilder,\r\n    private drawStyleService: DrawStyleService,\r\n    private dialog: MatDialog,\r\n    private drawIconService: DrawIconService\r\n  ) {\r\n    this.buildForm();\r\n    this.fillColor = this.drawStyleService.getFillColor();\r\n    this.strokeColor = this.drawStyleService.getStrokeColor();\r\n    this.strokeWidth = this.drawStyleService.getStrokeWidth();\r\n    this.labelsAreShown = this.drawStyleService.getLabelsAreShown();\r\n    this.icons = this.drawIconService.getIcons();\r\n    this.icon = this.drawStyleService.getIcon();\r\n\r\n    this.fontSize = this.drawStyleService.getFontSize();\r\n    this.fontStyle = this.drawStyleService.getFontStyle();\r\n  }\r\n\r\n  // Initialize the store that will contain the entities and create the Draw control\r\n  ngOnInit() {\r\n    if (!this.stores.length) {\r\n      this.activeStore = new FeatureStore<FeatureWithDraw>([], {\r\n        map: this.map\r\n      });\r\n      this.initStore();\r\n      this.activeDrawControl = this.createDrawControl(\r\n        this.fillColor,\r\n        this.strokeColor,\r\n        this.strokeWidth\r\n      );\r\n      this.activeDrawControl.setGeometryType(this.geometryType.Point as any);\r\n      this.toggleDrawControl();\r\n      this.stores.push(this.activeStore);\r\n      this.drawControls.push([this.activeDrawingLayer.id, this.activeDrawControl]);\r\n      this.drawControlsEvent.emit(this.drawControls);\r\n      this.layersIDEvent.emit(this.activeDrawingLayer.id);\r\n      this.onLayerChange(this.activeDrawingLayer);\r\n    } else {\r\n      this.activeStore = this.stores.find(store => store.layer.id === this.activeDrawingLayer.id);\r\n      this.activeDrawControl = this.drawControls.find(dc => dc[0] === this.activeDrawingLayer.id)[1];\r\n      this.deactivateDrawControl();\r\n      this.allLayers.forEach(layer => {\r\n        if (layer.id !== this.activeDrawingLayer.id) {\r\n          layer.opacity = 0;\r\n        }\r\n        let store = this.stores.find(s => s.layer.id === layer.id);\r\n\r\n        this.subscriptions$$.push(\r\n          store.stateView\r\n            .manyBy$((record: EntityRecord<FeatureWithDraw>) => {\r\n              return record.state.selected === true;\r\n            })\r\n            .pipe(\r\n              first()\r\n            )\r\n            .subscribe((records: EntityRecord<FeatureWithDraw>[]) => {\r\n              records.forEach((record) => {\r\n                record.state.selected = false;\r\n              });\r\n            })\r\n        );\r\n\r\n        this.subscriptions$$.push(\r\n          store.stateView\r\n            .manyBy$((record: EntityRecord<FeatureWithDraw>) => {\r\n              return record.state.selected === true;\r\n            })\r\n            .pipe(\r\n              skip(1) // Skip initial emission\r\n            )\r\n            .subscribe((records: EntityRecord<FeatureWithDraw>[]) => {\r\n              this.selectedFeatures$.next(records.map((record) => record.entity));\r\n            })\r\n        );\r\n\r\n        this.subscriptions$$.push(\r\n          store.count$.subscribe((cnt) => {\r\n            cnt >= 1\r\n              ? (this.activeStore.layer.options.showInLayerList = true)\r\n              : (this.activeStore.layer.options.showInLayerList = false);\r\n          })\r\n        );\r\n      });\r\n      this.onLayerChange(this.activeDrawingLayer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove the drawing layer and the interactions\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.allLayers.forEach(layer => layer.opacity = 1);\r\n    this.activeStore.state.updateAll({selected: false});\r\n    this.deactivateDrawControl();\r\n    this.subscriptions$$.map((s) => s.unsubscribe());\r\n  }\r\n\r\n  /**\r\n   * Create a Draw Control\r\n   * @param fillColor the fill color\r\n   * @param strokeColor the stroke color\r\n   * @param strokeWidth the stroke width\r\n   * @returns a Draw Control\r\n   */\r\n  createDrawControl(\r\n    fillColor?: string,\r\n    strokeColor?: string,\r\n    strokeWidth?: number\r\n  ) {\r\n    const activeDrawControl = new DrawControl({\r\n      geometryType: undefined,\r\n      drawingLayerSource: this.activeDrawingLayerSource,\r\n      drawingLayerStyle: new OlStyle.Style({}),\r\n      interactionStyle: createInteractionStyle(\r\n        fillColor,\r\n        strokeColor,\r\n        strokeWidth\r\n      )\r\n    });\r\n    return activeDrawControl;\r\n  }\r\n\r\n  /**\r\n   * Store initialization, including drawing layer creation\r\n   */\r\n\r\n  private initStore(newTitle?: string, isNewLayer?: boolean) {\r\n    this.createLayer(newTitle, isNewLayer);\r\n    this.subscriptions$$.push(\r\n      this.activeStore.stateView\r\n        .manyBy$((record: EntityRecord<FeatureWithDraw>) => {\r\n          return record.state.selected === true;\r\n        })\r\n        .pipe(\r\n          skip(1) // Skip initial emission\r\n        )\r\n        .subscribe((records: EntityRecord<FeatureWithDraw>[]) => {\r\n          this.selectedFeatures$.next(records.map((record) => record.entity));\r\n        })\r\n    );\r\n\r\n    this.subscriptions$$.push(\r\n      this.activeStore.count$.subscribe((cnt) => {\r\n        cnt >= 1\r\n          ? (this.activeStore.layer.options.showInLayerList = true)\r\n          : (this.activeStore.layer.options.showInLayerList = false);\r\n      })\r\n    );\r\n  }\r\n\r\n/**\r\n * Open the style modal dialog box\r\n */\r\n  openStyleModalDialog() {\r\n    setTimeout(() => {\r\n      // open the dialog box used to style features\r\n      const dialogRef = this.dialog.open(StyleModalComponent, {\r\n        disableClose: false,\r\n        data: {\r\n          features: this.selectedFeatures$.getValue(),\r\n          icons: this.icons,\r\n          icon: this.icon\r\n        },\r\n        autoFocus: false\r\n      });\r\n\r\n      // when dialog box is closed, get label and set it to geometry\r\n      dialogRef.afterClosed().subscribe((data: StyleModalData) => {\r\n        // checks if the user clicked ok\r\n        if (dialogRef.componentInstance.confirmFlag) {\r\n          this.onFontChange(this.labelsAreShown, data.fontSize, data.fontStyle);\r\n          this.onColorChange(this.labelsAreShown, this.icon ? true : false, data.fillColor, data.strokeColor);\r\n          this.onOffsetLabelChange(this.labelsAreShown, data.offsetX, data.offsetY);\r\n        }\r\n      });\r\n    }, 250);\r\n  }\r\n\r\n  /**\r\n   * Open a dialog box to enter label and do something\r\n   * @param olGeometry geometry at draw end or selected geometry\r\n   * @param drawEnd event fired at drawEnd?\r\n   */\r\n  private openDrawDialog(olGeometry, isDrawEnd: boolean) {\r\n    setTimeout(() => {\r\n      // open the dialog box used to enter label\r\n      const dialogRef = this.dialog.open(DrawPopupComponent, {\r\n        disableClose: false,\r\n        data: { currentLabel: olGeometry.get('draw') }\r\n      });\r\n\r\n      // when dialog box is closed, get label and set it to geometry\r\n      dialogRef.afterClosed().subscribe((label: string) => {\r\n        // checks if the user clicked ok\r\n        if (dialogRef.componentInstance.confirmFlag) {\r\n          this.updateLabelOfOlGeometry(olGeometry, label);\r\n          if (!olGeometry.values_.fontStyle) {\r\n            this.updateFontSizeAndStyle(olGeometry, '20', FontType.Arial);\r\n          }\r\n          if (!olGeometry.values_.drawingStyle) {\r\n            this.updateFillAndStrokeColor(\r\n              olGeometry,\r\n              'rgba(255,255,255,0.4)',\r\n              'rgba(143,7,7,1)'\r\n            );\r\n          }\r\n          if (!(olGeometry.values_.offsetX || olGeometry.values_.offsetY)) {\r\n            this.updateOffset(\r\n              olGeometry,\r\n              0,\r\n              olGeometry instanceof Point ? -15 : 0\r\n            );\r\n          }\r\n\r\n          // if event was fired at draw end\r\n          if (isDrawEnd) {\r\n            this.onDrawEnd(olGeometry);\r\n            // if event was fired at select\r\n          } else {\r\n            this.onSelectDraw(olGeometry, label);\r\n          }\r\n          this.updateHeightTable();\r\n        }\r\n        // deletes the feature\r\n        else {\r\n          this.activeDrawingLayerSource\r\n            .getFeatures()\r\n            .forEach((drawingLayerFeature) => {\r\n              const geometry = drawingLayerFeature.getGeometry() as any;\r\n              if (olGeometry === geometry) {\r\n                this.activeDrawingLayerSource.removeFeature(\r\n                  drawingLayerFeature\r\n                );\r\n              }\r\n            });\r\n        }\r\n      });\r\n    }, 250);\r\n  }\r\n\r\n  /**\r\n   * Clear the draw source and track the geometry being draw\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onDrawEnd(olGeometry: OlGeometry, radius?: number) {\r\n    this.addFeatureToStore(olGeometry, radius);\r\n    this.clearLabelsOfOlGeometry(olGeometry);\r\n    this.activeStore.layer.ol.getSource().refresh();\r\n  }\r\n\r\n  private onModifyDraw(olGeometry) {\r\n    const entities = this.activeStore.all();\r\n\r\n    entities.forEach((entity) => {\r\n      const entityId = entity.properties.id;\r\n\r\n      const olGeometryId = olGeometry.ol_uid;\r\n\r\n      if (entityId === olGeometryId) {\r\n        this.updateLabelOfOlGeometry(olGeometry, entity.properties.draw);\r\n        this.updateFontSizeAndStyle(\r\n          olGeometry,\r\n          entity.properties.fontStyle.split(' ')[0].replace('px', ''),\r\n          entity.properties.fontStyle.substring(\r\n            entity.properties.fontStyle.indexOf(' ') + 1\r\n          )\r\n        );\r\n        this.updateFillAndStrokeColor(\r\n          olGeometry,\r\n          entity.properties.drawingStyle.fill,\r\n          entity.properties.drawingStyle.stroke\r\n        );\r\n        this.updateOffset(\r\n          olGeometry,\r\n          entity.properties.offsetX,\r\n          entity.properties.offsetY\r\n        );\r\n        this.replaceFeatureInStore(entity, olGeometry);\r\n      }\r\n    });\r\n  }\r\n\r\n  private onSelectDraw(olFeature: OlFeature<OlGeometry>, label: string) {\r\n    const entities = this.activeStore.all();\r\n\r\n    const olGeometry = olFeature.getGeometry() as any;\r\n    olGeometry.ol_uid = olFeature.get('id');\r\n\r\n    const olGeometryCoordinates = JSON.stringify(\r\n      olGeometry.getCoordinates()[0]\r\n    );\r\n\r\n    entities.forEach((entity) => {\r\n      const entityCoordinates = JSON.stringify(entity.geometry.coordinates[0]);\r\n      if (olGeometryCoordinates === entityCoordinates) {\r\n        const fontSize = olFeature\r\n          .get('fontStyle')\r\n          .split(' ')[0]\r\n          .replace('px', '');\r\n        const fontStyle = olFeature\r\n          .get('fontStyle')\r\n          .substring(olFeature.get('fontStyle').indexOf(' ') + 1);\r\n\r\n        const fillColor = olFeature.get('drawingStyle').fill;\r\n        const strokeColor = olFeature.get('drawingStyle').stroke;\r\n\r\n        const offsetX = olFeature.get('offsetX');\r\n        const offsetY = olFeature.get('offsetY');\r\n\r\n        const rad: number = entity.properties.rad\r\n          ? entity.properties.rad\r\n          : undefined;\r\n        this.updateLabelOfOlGeometry(olGeometry, label);\r\n        this.updateFontSizeAndStyle(olGeometry, fontSize, fontStyle);\r\n        this.updateFillAndStrokeColor(olGeometry, fillColor, strokeColor);\r\n        this.updateOffset(olGeometry, offsetX, offsetY);\r\n        this.replaceFeatureInStore(entity, olGeometry, rad);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Add a feature with draw label to the store. The loading stragegy of the store\r\n   * will trigger and add the feature to the map.\r\n   * @internal\r\n   */\r\n  private addFeatureToStore(\r\n    olGeometry,\r\n    radius?: number,\r\n    feature?: FeatureWithDraw\r\n  ) {\r\n    let rad: number;\r\n    let center4326: Array<number>;\r\n    let point4326: Array<number>;\r\n    let lon4326: number;\r\n    let lat4326: number;\r\n    const featureId = feature ? feature.properties.id : olGeometry.ol_uid;\r\n    const projection = this.map.ol.getView().getProjection();\r\n\r\n    const geometry = new OlGeoJSON().writeGeometryObject(olGeometry, {\r\n      featureProjection: projection,\r\n      dataProjection: projection\r\n    }) as any;\r\n\r\n    if (olGeometry instanceof OlCircle || radius) {\r\n      if (radius) {\r\n        rad = radius;\r\n      } else {\r\n        geometry.type = 'Point';\r\n        geometry.coordinates = olGeometry.getCenter();\r\n        const extent4326 = transform(\r\n          [\r\n            olGeometry.getFlatCoordinates()[2],\r\n            olGeometry.getFlatCoordinates()[3]\r\n          ],\r\n          projection,\r\n          'EPSG:4326'\r\n        );\r\n        center4326 = transform(\r\n          [\r\n            olGeometry.getFlatCoordinates()[0],\r\n            olGeometry.getFlatCoordinates()[1]\r\n          ],\r\n          projection,\r\n          'EPSG:4326'\r\n        );\r\n        lon4326 = center4326[0];\r\n        lat4326 = center4326[1];\r\n        rad = getDistance(center4326, extent4326);\r\n      }\r\n    }\r\n\r\n    if (olGeometry instanceof OlPoint) {\r\n      point4326 = transform(\r\n        olGeometry.getFlatCoordinates(),\r\n        projection,\r\n        'EPSG:4326'\r\n      );\r\n      lon4326 = point4326[0];\r\n      lat4326 = point4326[1];\r\n    }\r\n\r\n    this.activeStore.update({\r\n      type: FEATURE,\r\n      geometry,\r\n      projection: projection.getCode(),\r\n      properties: {\r\n        id: featureId,\r\n        draw: olGeometry.get('_label'),\r\n        longitude: lon4326 ? lon4326 : null,\r\n        latitude: lat4326 ? lat4326 : null,\r\n        rad: rad ? rad : null,\r\n        fontStyle: olGeometry.get('fontStyle_'),\r\n        drawingStyle: {\r\n          fill: olGeometry.get('fillColor_'),\r\n          stroke: olGeometry.get('strokeColor_')\r\n        },\r\n        offsetX: olGeometry.get('offsetX_'),\r\n        offsetY: olGeometry.get('offsetY_')\r\n      },\r\n      meta: {\r\n        id: featureId\r\n      }\r\n    });\r\n  }\r\n\r\n  private buildForm() {\r\n    this.form = this.formBuilder.group({\r\n      fill: [''],\r\n      stroke: ['']\r\n    });\r\n  }\r\n\r\n  public setupLayer(isNewLayer?: boolean) {\r\n    setTimeout(() => {\r\n      const dialogRef = this.dialog.open(DrawLayerPopupComponent, {\r\n        disableClose: false,\r\n      });\r\n      dialogRef.afterClosed().subscribe((label: string) => {\r\n        if (dialogRef.componentInstance.confirmFlag) {\r\n          this.activeStore.state.updateAll({selected: false});\r\n          this.activeStore = new FeatureStore<FeatureWithDraw>([], { map: this.map });\r\n          this.activeDrawingLayerSource = new OlVectorSource();\r\n          this.activeDrawingLayer.opacity = 0;\r\n          this.deactivateDrawControl();\r\n          this.initStore(label, isNewLayer);\r\n          this.activeDrawControl = this.createDrawControl(\r\n            this.fillColor,\r\n            this.strokeColor,\r\n            this.strokeWidth\r\n          );\r\n          this.activeDrawControl.setGeometryType(this.currGeometryType);\r\n          this.toggleDrawControl();\r\n          this.stores.push(this.activeStore);\r\n          this.drawControls.push([this.activeDrawingLayer.id, this.activeDrawControl]);\r\n          this.drawControlsEvent.emit(this.drawControls);\r\n          this.layersIDEvent.emit(this.activeDrawingLayer.id);\r\n          this.isCreatingNewLayer = false;\r\n          if (!this.labelsAreShown){\r\n            this.onToggleLabels();\r\n          }\r\n          this.activeLayerChange.emit(this.activeDrawingLayer);\r\n        } else {\r\n          this.select.value = this.activeDrawingLayer;\r\n          this.select.selectionChange.emit(this.activeDrawingLayer);\r\n        }\r\n      });\r\n    }, 250);\r\n  }\r\n\r\n  // HTML user interactions\r\n\r\n  /**\r\n   * Called when the user double-clicks the selected drawing\r\n   */\r\n  editLabelDrawing() {\r\n    if (this.selectedFeatures$.value.length) {\r\n      const olGeometry = featureToOl(\r\n        this.selectedFeatures$.value[0],\r\n        this.map.ol.getView().getProjection().getCode()\r\n      );\r\n      this.openDrawDialog(olGeometry, false);\r\n    }\r\n  }\r\n\r\n  openShorcutsDialog() {\r\n    this.dialog.open(DrawShorcutsComponent);\r\n  }\r\n\r\n  deleteDrawings() {\r\n    this.activeStore.deleteMany(this.selectedFeatures$.value);\r\n    this.selectedFeatures$.value.forEach((selectedFeature) => {\r\n      this.activeDrawingLayerSource\r\n        .getFeatures()\r\n        .forEach((drawingLayerFeature) => {\r\n          const geometry = drawingLayerFeature.getGeometry() as any;\r\n          if (selectedFeature.properties.id === geometry.ol_uid) {\r\n            this.activeDrawingLayerSource.removeFeature(drawingLayerFeature);\r\n          }\r\n        });\r\n    });\r\n    this.updateHeightTable();\r\n  }\r\n\r\n  /**\r\n   * Called when the user toggles the labels toggle\r\n   */\r\n  onToggleLabels() {\r\n    this.drawStyleService.toggleLabelsAreShown();\r\n    this.labelsAreShown = !this.labelsAreShown;\r\n    this.icon\r\n      ? this.elementStyle(\r\n          this.labelsAreShown,\r\n          true\r\n        )\r\n      : this.elementStyle(\r\n          this.labelsAreShown,\r\n          false\r\n        );\r\n    this.createDrawControl();\r\n  }\r\n\r\n  /**\r\n   * Called when the user toggles the Draw control is toggled\r\n   * @internal\r\n   */\r\n  onToggleDrawControl(toggleIsChecked: boolean) {\r\n    toggleIsChecked ? this.toggleDrawControl() : this.deactivateDrawControl();\r\n  }\r\n\r\n  // User changes properties of a drawing element\r\n\r\n  /**\r\n   * Display the current layer with the current store and the current layerSource\r\n   */\r\n\r\n  public onLayerChange(currLayer?: VectorLayer) {\r\n    if (currLayer) {\r\n      this.activeStore.state.updateAll({selected: false});\r\n      this.isCreatingNewLayer = false;\r\n      this.activeDrawingLayer.opacity = 0;\r\n      this.activeDrawingLayer = currLayer;\r\n      this.activeDrawingLayer.opacity = 1;\r\n      this.deactivateDrawControl();\r\n      if (!this.labelsAreShown){\r\n        this.onToggleLabels();\r\n      }\r\n      this.activeStore = this.stores.find(store => store.layer.id === this.activeDrawingLayer.id);\r\n      this.activeDrawControl = this.drawControls.find(dc => dc[0] === this.activeDrawingLayer.id)[1];\r\n      this.activeDrawingLayerSource = this.activeDrawControl.olDrawingLayerSource;\r\n      this.activeDrawControl.setGeometryType(this.currGeometryType);\r\n      this.toggleDrawControl();\r\n    } else {\r\n      this.setupLayer(true);\r\n    }\r\n    this.activeLayerChange.emit(this.activeDrawingLayer);\r\n  }\r\n\r\n  public createLayer(newTitle?, isNewLayer?) {\r\n    for (const layer of this.allLayers){\r\n      let numberId = Number(layer.id.replace('igo-draw-layer',''));\r\n      this.layerCounterID = Math.max(numberId,this.layerCounterID);\r\n    }\r\n    this.activeDrawingLayer = new VectorLayer({\r\n      isIgoInternalLayer: true,\r\n      id: 'igo-draw-layer' + ++this.layerCounterID,\r\n      title: isNewLayer\r\n        ? newTitle\r\n        : this.languageService.translate.instant('igo.geo.draw.drawing'),\r\n      zIndex: 200,\r\n      source: new FeatureDataSource(),\r\n      style: (feature, resolution) => {\r\n        return this.drawStyleService.createIndividualElementStyle(\r\n          feature,\r\n          resolution,\r\n          this.labelsAreShown,\r\n          feature.get('fontStyle'),\r\n          feature.get('drawingStyle').fill,\r\n          feature.get('drawingStyle').stroke,\r\n          feature.get('offsetX'),\r\n          feature.get('offsetY'),\r\n          this.icon\r\n        );\r\n      },\r\n      showInLayerList: true,\r\n      exportable: true,\r\n      browsable: false,\r\n      workspace: {\r\n        enabled: false\r\n      }\r\n    });\r\n\r\n    tryBindStoreLayer(this.activeStore, this.activeDrawingLayer);\r\n\r\n    tryAddLoadingStrategy(\r\n      this.activeStore,\r\n      new FeatureStoreLoadingStrategy({\r\n        motion: FeatureMotion.None\r\n      })\r\n    );\r\n\r\n    tryAddSelectionStrategy(\r\n      this.activeStore,\r\n      new FeatureStoreSelectionStrategy({\r\n        map: this.map,\r\n        motion: FeatureMotion.None,\r\n        many: true\r\n      })\r\n    );\r\n    this.activeStore.layer.visible = true;\r\n    this.activeStore.source.ol.on(\r\n      'removefeature',\r\n      (event: OlVectorSourceEvent<OlGeometry>) => {\r\n        const olGeometry = event.feature.getGeometry();\r\n        this.clearLabelsOfOlGeometry(olGeometry);\r\n      }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Called when the user changes the color in a color picker\r\n   * @param labelsAreShown wheter the labels are shown or not\r\n   * @param isAnIcon wheter the feature is an icon or not\r\n   * @param fillColor which is the filling color\r\n   * @param strokeColor which is the stroke color\r\n   */\r\n  onColorChange(\r\n    labelsAreShown: boolean,\r\n    isAnIcon: boolean,\r\n    fillColor: string,\r\n    strokeColor: string\r\n  ) {\r\n    if (this.selectedFeatures$.value.length > 0 && !isAnIcon) {\r\n      this.selectedFeatures$.value.forEach((feature) => {\r\n        let olFeature = featureToOl(\r\n          feature,\r\n          this.map.ol.getView().getProjection().getCode()\r\n        );\r\n        this.updateFillAndStrokeColor(olFeature, fillColor, strokeColor);\r\n\r\n        const entity = this.activeStore\r\n          .all()\r\n          .find((e) => e.meta.id === olFeature.getId());\r\n        entity.properties.drawingStyle.fill = olFeature.get('fillColor_');\r\n        entity.properties.drawingStyle.stroke = olFeature.get('strokeColor_');\r\n        this.activeStore.update(entity);\r\n      });\r\n    }\r\n\r\n    this.elementStyle(labelsAreShown, isAnIcon);\r\n    this.createDrawControl();\r\n  }\r\n\r\n  /**\r\n   * Called when the user changes the font size or/and style\r\n   * @param labelsAreShown wheter the labels are shown or not\r\n   * @param size the size of the font\r\n   * @param style the style of the font\r\n   */\r\n\r\n  onFontChange(labelsAreShown: boolean, size: string, style: FontType) {\r\n    if (this.selectedFeatures$.value.length > 0) {\r\n      this.selectedFeatures$.value.forEach((feature) => {\r\n        let olFeature = featureToOl(\r\n          feature,\r\n          this.map.ol.getView().getProjection().getCode()\r\n        );\r\n        this.updateFontSizeAndStyle(olFeature, size, style);\r\n        const entity = this.activeStore\r\n          .all()\r\n          .find((e) => e.meta.id === olFeature.getId());\r\n        entity.properties.fontStyle = olFeature.get('fontStyle_');\r\n        this.activeStore.update(entity);\r\n        olFeature = this.activeStore.layer.ol.getSource().getFeatures().find(f => f.getId() === entity.meta.id);\r\n        olFeature.setProperties({ fontStyle: entity.properties.fontStyle });\r\n        olFeature.changed();\r\n      });\r\n\r\n      this.fontSize = size;\r\n      this.fontStyle = style;\r\n\r\n      this.drawStyleService.setFontSize(size);\r\n      this.drawStyleService.setFontStyle(style);\r\n\r\n      this.elementStyle(labelsAreShown);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Called when the user changes the value of the horizontal/vertical offset\r\n   * @param labelsAreShown wheter the labels are shown or not\r\n   * @param offsetX horizontal offset of the label\r\n   * @param offsetY vertical offset of the label\r\n   */\r\n\r\n  onOffsetLabelChange(\r\n    labelsAreShown: boolean,\r\n    offsetX: number,\r\n    offsetY: number\r\n  ) {\r\n    if (this.selectedFeatures$.value.length > 0) {\r\n      this.selectedFeatures$.value.forEach((feature) => {\r\n        let olFeature = featureToOl(\r\n          feature,\r\n          this.map.ol.getView().getProjection().getCode()\r\n        );\r\n        this.updateOffset(olFeature, offsetX, offsetY);\r\n        const entity = this.activeStore\r\n          .all()\r\n          .find((e) => e.meta.id === olFeature.getId());\r\n        entity.properties.offsetX = olFeature.get('offsetX_');\r\n        entity.properties.offsetY = olFeature.get('offsetY_');\r\n        this.activeStore.update(entity);\r\n        olFeature = this.activeStore.layer.ol.getSource().getFeatures().find(f => f.getId() === entity.meta.id);\r\n        olFeature.setProperties({ offsetX: entity.properties.offsetX, offsetY: entity.properties.offsetY });\r\n        olFeature.changed();\r\n      });\r\n      this.elementStyle(labelsAreShown);\r\n    }\r\n  }\r\n\r\n  onIconChange(event?) {\r\n    this.icon = event;\r\n    this.drawStyleService.setIcon(this.icon);\r\n    this.elementStyle(true, this.icon);\r\n  }\r\n\r\n  /**\r\n   * Called when the user selects a new geometry type\r\n   * @param geometryType the geometry type selected by the user\r\n   */\r\n  onGeometryTypeChange(geometryType: Type) {\r\n    this.currGeometryType = geometryType;\r\n    this.activeDrawControl.setGeometryType(geometryType);\r\n    this.toggleDrawControl();\r\n  }\r\n\r\n  // Updates the properties of olFeature inputted\r\n\r\n  /**\r\n   * Update the label of a geometry when a label is entered in a dialog box\r\n   * @param olGeometry the geometry\r\n   * @param label the label\r\n   */\r\n  private updateLabelOfOlGeometry(olGeometry: OlGeometry, label: string) {\r\n    olGeometry.setProperties(\r\n      {\r\n        _label: label\r\n      },\r\n      true\r\n    );\r\n  }\r\n\r\n  private updateFontSizeAndStyle(\r\n    olFeature: OlFeature<OlGeometry>,\r\n    fontSize: string,\r\n    fontStyle: string\r\n  ) {\r\n    olFeature.setProperties(\r\n      {\r\n        fontStyle_: `${fontSize}px ${fontStyle}`\r\n      },\r\n      true\r\n    );\r\n  }\r\n\r\n  private updateFillAndStrokeColor(\r\n    olFeature: OlFeature<OlGeometry>,\r\n    fillColor: string,\r\n    strokeColor: string\r\n  ) {\r\n    olFeature.setProperties(\r\n      {\r\n        fillColor_: fillColor,\r\n        strokeColor_: strokeColor\r\n      },\r\n      true\r\n    );\r\n  }\r\n\r\n  private updateOffset(\r\n    olFeature: OlFeature<OlGeometry>,\r\n    offsetX: number,\r\n    offsetY: number\r\n  ) {\r\n    olFeature.setProperties(\r\n      {\r\n        offsetX_: offsetX,\r\n        offsetY_: offsetY\r\n      },\r\n      true\r\n    );\r\n  }\r\n\r\n  // Updates values of the selected element on the HTML view\r\n\r\n  getFeatureFontSize(): string {\r\n    return this.selectedFeatures$.value.length > 0\r\n      ? this.selectedFeatures$.value[0].properties.fontStyle\r\n          .split(' ')[0]\r\n          .replace('px', '')\r\n      : '20';\r\n  }\r\n\r\n  getFeatureFontStyle() {\r\n    return this.selectedFeatures$.value.length > 0\r\n      ? this.selectedFeatures$.value[0].properties.fontStyle.substring(\r\n          this.selectedFeatures$.value[0].properties.fontStyle.indexOf(' ') + 1\r\n        )\r\n      : FontType.Arial;\r\n  }\r\n\r\n  getFeatureFillColor() {\r\n    return this.selectedFeatures$.value.length > 0\r\n      ? this.selectedFeatures$.value[0].properties.drawingStyle.fill\r\n      : 'rgba(255,255,255,0.4)';\r\n  }\r\n\r\n  getFeatureStrokeColor() {\r\n    return this.selectedFeatures$.value.length > 0\r\n      ? this.selectedFeatures$.value[0].properties.drawingStyle.stroke\r\n      : 'rgba(143,7,7,1)';\r\n  }\r\n\r\n  getFeatureOffsetX() {\r\n    return this.selectedFeatures$.value.length > 0\r\n      ? this.selectedFeatures$.value[0].properties.offsetX\r\n      : this.drawStyleService.getOffsetX();\r\n  }\r\n\r\n  getFeatureOffsetY() {\r\n    return this.selectedFeatures$.value.length > 0\r\n      ? this.selectedFeatures$.value[0].properties.offsetY\r\n      : '0';\r\n  }\r\n\r\n  get allFontStyles(): string[] {\r\n    return Object.values(FontType);\r\n  }\r\n\r\n  get allLayers() {\r\n    return this.map.layers.filter((layer) =>\r\n      layer.id.includes('igo-draw-layer')\r\n    );\r\n  }\r\n\r\n  updateHeightTable() {\r\n    // Check the amount of rows as a possible alternative\r\n\r\n    this.numberOfDrawings = this.activeStore.count$.getValue();\r\n    this.numberOfDrawings > 10\r\n      ? (this.tableTemplate.tableHeight = '35vh')\r\n      : (this.tableTemplate.tableHeight = 'auto');\r\n  }\r\n\r\n  updateActiveLayer() {\r\n    let currLayer = this.allLayers.find(layer => layer.title === this.activeDrawingLayer.title);\r\n    return currLayer ? currLayer : this.allLayers[0];\r\n  }\r\n\r\n  // Helper methods\r\n\r\n  /**\r\n   * Activate the correct control\r\n   */\r\n  private toggleDrawControl() {\r\n    this.deactivateDrawControl();\r\n    this.activateDrawControl();\r\n  }\r\n\r\n  /**\r\n   * Clear the tooltips of an OL geometry\r\n   * @param olGeometry OL geometry with tooltips\r\n   */\r\n  private clearLabelsOfOlGeometry(olGeometry) {\r\n    getTooltipsOfOlGeometry(olGeometry).forEach(\r\n      (olTooltip: OlOverlay | undefined) => {\r\n        if (olTooltip && olTooltip.getMap()) {\r\n          this.map.ol.removeOverlay(olTooltip);\r\n        }\r\n      }\r\n    );\r\n  }\r\n  /**\r\n   * Replace the feature in the store\r\n   * @param entity the entity to replace\r\n   * @param olGeometry the new geometry to insert in the store\r\n   */\r\n  private replaceFeatureInStore(\r\n    entity,\r\n    olGeometry: OlGeometry,\r\n    radius?: number\r\n  ) {\r\n    this.activeStore.delete(entity);\r\n    this.onDrawEnd(olGeometry, radius);\r\n  }\r\n\r\n  /**\r\n   * Deactivate the active draw control\r\n   */\r\n  private deactivateDrawControl() {\r\n    if (!this.activeDrawControl) {\r\n      return;\r\n    }\r\n\r\n    if (this.drawEnd$$) {\r\n      this.drawEnd$$.unsubscribe();\r\n    }\r\n\r\n    this.activeDrawControl.setOlMap(undefined);\r\n    this.drawControlIsActive = false;\r\n  }\r\n\r\n  /**\r\n   * Activate a given control\r\n   */\r\n  private activateDrawControl() {\r\n    this.drawControlIsDisabled = false;\r\n    this.drawControlIsActive = true;\r\n    this.drawEnd$$ = this.activeDrawControl.end$.subscribe(\r\n      (olGeometry: OlGeometry) => {\r\n        this.openDrawDialog(olGeometry, true);\r\n      }\r\n    );\r\n\r\n    this.activeDrawControl.modify$.subscribe((olGeometry: OlGeometry) => {\r\n      this.onModifyDraw(olGeometry);\r\n    });\r\n\r\n    if (!this.drawSelect$$) {\r\n      this.drawSelect$$ = this.activeDrawControl.select$.subscribe(\r\n        (olFeature: OlFeature<OlGeometry>) => {\r\n          this.openDrawDialog(olFeature, false);\r\n        }\r\n      );\r\n    }\r\n\r\n    this.activeDrawControl.setOlMap(this.map.ol, true);\r\n  }\r\n\r\n  /**\r\n   * Recreates the style of the feature stored\r\n   */\r\n  private elementStyle(labelsAreShown: boolean, isAnIcon?) {\r\n    if (isAnIcon) {\r\n      this.activeStore.layer.ol.setStyle((feature, resolution) => {\r\n        return this.drawStyleService.createIndividualElementStyle(\r\n          feature,\r\n          resolution,\r\n          labelsAreShown,\r\n          feature.get('fontStyle'),\r\n          feature.get('drawingStyle').fill,\r\n          feature.get('drawingStyle').stroke,\r\n          feature.get('offsetX'),\r\n          feature.get('offsetY'),\r\n          this.icon\r\n        );\r\n      });\r\n    } else {\r\n      this.activeStore.layer.ol.setStyle((feature, resolution) => {\r\n        return this.drawStyleService.createIndividualElementStyle(\r\n          feature,\r\n          resolution,\r\n          labelsAreShown,\r\n          feature.get('fontStyle'),\r\n          feature.get('drawingStyle').fill,\r\n          feature.get('drawingStyle').stroke,\r\n          feature.get('offsetX'),\r\n          feature.get('offsetY')\r\n        );\r\n      });\r\n    }\r\n  }\r\n}\r\n","<div mat-dialog-content>\r\n  <h2 mat-dialog-title class=\"mat-typography\">{{ 'igo.geo.layer.style.styleModal' | translate }}</h2>\r\n  <div\r\n  class=\"edition-drawing mat-typography\"\r\n  [hidden]=\"data.features.length === 0\">\r\n    <form\r\n      class=\"igo-form\"\r\n      [formGroup]=\"form\">\r\n      <div class=\"fill-color-picker mat-typography\" *ngIf=\"linestringOnly !== true\">\r\n        <span>\r\n          <mat-icon class=\"stroke-palette-icon\" svgIcon=\"square\"></mat-icon>\r\n          {{ 'igo.geo.draw.fill' | translate }}\r\n        </span>\r\n\r\n        <mat-form-field\r\n          class=\"fill-field\"\r\n          appearance=\"outline\"\r\n          floatLabel=\"always\"\r\n          tooltip-position=\"below\"\r\n          matTooltipShowDelay=\"500\"\r\n          [matTooltip]=\"'igo.geo.draw.colorPicker' | translate\">\r\n          <mat-label>{{ getFeatureFillColor() }}</mat-label>\r\n          <input\r\n            #fillColorInput\r\n            formControlName=\"fill\"\r\n            matInput\r\n            type=\"text\"\r\n            [style.background]=\"getFeatureFillColor()\"\r\n            [readonly]=\"true\"\r\n            [colorPicker]=\"getFeatureFillColor()\"\r\n            [cpWidth]=\"'200px'\"\r\n            [cpOutputFormat]=\"'rgba'\"\r\n            [cpPosition]=\"'bottom'\"\r\n            [cpPositionOffset]=\"'-75%'\"\r\n            [cpCancelButton]=\"true\"\r\n            [cpCancelButtonText]=\"'igo.geo.draw.cancel' | translate\"\r\n            [cpOKButton]=\"true\"\r\n            (colorPickerChange)=\"styleModalData.fillColor = $event\">\r\n        </mat-form-field>\r\n      </div>\r\n\r\n      <div class=\"stroke-color-picker mat-typography\">\r\n        <span>\r\n          <mat-icon\r\n            class=\"stroke-palette-icon\"\r\n            svgIcon=\"square-outline\">\r\n          </mat-icon>\r\n          {{'igo.geo.draw.stroke' | translate}}\r\n        </span>\r\n\r\n        <mat-form-field\r\n          class=\"stroke-field\"\r\n          appearance=\"outline\"\r\n          floatLabel=\"always\"\r\n          tooltip-position=\"below\"\r\n          matTooltipShowDelay=\"500\"\r\n          [matTooltip]=\"'igo.geo.draw.colorPicker' | translate\">\r\n          <mat-label>{{ getFeatureStrokeColor() }}</mat-label>\r\n          <input\r\n            #strokeColorInput\r\n            formControlName=\"stroke\"\r\n            matInput\r\n            type=\"text\"\r\n            [style.background]=\"getFeatureStrokeColor()\"\r\n            [readonly]=\"true\"\r\n            [colorPicker]=\"getFeatureStrokeColor()\"\r\n            [cpWidth]=\"'200px'\"\r\n            [cpPosition]=\"'bottom'\"\r\n            [cpPositionOffset]=\"'-75%'\"\r\n            [cpOutputFormat]=\"'rgba'\"\r\n            [cpCancelButton]=\"true\"\r\n            [cpCancelButtonText]=\"'igo.geo.draw.cancel' | translate\"\r\n            [cpOKButton]=\"true\"\r\n            (colorPickerChange)=\"styleModalData.strokeColor = $event\">\r\n        </mat-form-field>\r\n      </div>\r\n\r\n      <div class=\"igo-input-container\">\r\n        <mat-form-field appearance=\"outline\" class=\"igo-form-input-box\">\r\n          <mat-label>{{ 'igo.geo.draw.fontSize' | translate }}</mat-label>\r\n          <input\r\n            matInput\r\n            #testFontSize\r\n            type=\"number\"\r\n            placeholder=\"10\"\r\n            min=\"10\"\r\n            onkeydown=\"return event.keyCode !== 69\"\r\n            [value]=\"getFeatureFontSize()\"\r\n            (input)=\"styleModalData.fontSize = $event.target.value\">\r\n          <span matSuffix>px</span>\r\n        </mat-form-field>\r\n        <mat-form-field appearance=\"outline\" class=\"igo-form-input-box\">\r\n          <mat-label>{{ 'igo.geo.draw.fontStyle' | translate }}</mat-label>\r\n          <mat-select\r\n            #testFontStyle\r\n            [value]=\"getFeatureFontStyle()\"\r\n            (selectionChange)=\"styleModalData.fontStyle = $event.value\">\r\n            <mat-option\r\n              *ngFor=\"let fontSelect of allFontStyles\"\r\n              [value]=\"fontSelect\">\r\n              {{ fontSelect }}\r\n            </mat-option>\r\n          </mat-select>\r\n        </mat-form-field>\r\n      </div>\r\n\r\n      <div class=\"igo-input-container\">\r\n        <mat-form-field appearance=\"outline\" class=\"igo-form-input-box\">\r\n          <mat-label>{{ 'igo.geo.draw.offsetX' | translate }}</mat-label>\r\n          <input\r\n            matInput\r\n            #offsetXInput\r\n            type=\"number\"\r\n            onkeydown=\"return event.keyCode !== 69\"\r\n            [value]=\"getFeatureOffsetX()\"\r\n            (input)=\"styleModalData.offsetX = $event.target.value\">\r\n        </mat-form-field>\r\n        <mat-form-field appearance=\"outline\" class=\"igo-form-input-box\">\r\n          <mat-label>{{ 'igo.geo.draw.offsetY' | translate }}</mat-label>\r\n          <input\r\n            matInput\r\n            #offsetYInput\r\n            type=\"number\"\r\n            onkeydown=\"return event.keyCode !== 69\"\r\n            [value]=\"getFeatureOffsetY()\"\r\n            (input)=\"styleModalData.offsetY= $event.target.value\">\r\n        </mat-form-field>\r\n      </div>\r\n    </form>\r\n  </div>\r\n</div>\r\n<div mat-dialog-actions>\r\n  <button \r\n    mat-raised-button \r\n    (click)=\"cancelDrawing()\">{{'igo.geo.draw.cancel' | translate}}\r\n  </button>\r\n  <button \r\n    mat-raised-button \r\n    color=\"primary\" \r\n    (click)=\"confirm()\">OK\r\n  </button>\r\n</div>\r\n","import { Component, Inject, Input, OnInit } from '@angular/core';\r\nimport { MatDialogRef, MAT_DIALOG_DATA } from '@angular/material/dialog';\r\nimport { UntypedFormGroup, UntypedFormBuilder } from '@angular/forms';\r\n\r\nimport { DrawStyleService, FontType } from '../../draw';\r\n\r\nexport interface StyleModalData {\r\n  fillColor: string;\r\n  strokeColor: string;\r\n  fontSize: string;\r\n  fontStyle: FontType;\r\n  offsetX: number;\r\n  offsetY: number;\r\n}\r\n\r\n@Component({\r\n  selector: 'igo-style-modal-component',\r\n  templateUrl: './style-modal.component.html',\r\n  styleUrls: ['./style-modal.component.scss']\r\n})\r\nexport class StyleModalComponent implements OnInit {\r\n  @Input() confirmFlag: boolean = false;\r\n\r\n  public form: UntypedFormGroup;\r\n\r\n  public styleModalData: StyleModalData;\r\n  public linestringOnly: boolean;\r\n\r\n  constructor(\r\n    public dialogRef: MatDialogRef<StyleModalComponent>,\r\n    private formBuilder: UntypedFormBuilder,\r\n    private drawStyleService: DrawStyleService,\r\n    @Inject(MAT_DIALOG_DATA) public data: { features }) {\r\n      this.buildForm();\r\n    }\r\n\r\n  ngOnInit() {\r\n    this.linestringOnly = true;\r\n    for (const feature of this.data.features) {\r\n      if (feature.geometry.type !== 'LineString') {\r\n        this.linestringOnly = false;\r\n      }\r\n    }\r\n    this.buildStyleData();\r\n  }\r\n\r\n  private buildForm() {\r\n    this.form = this.formBuilder.group({\r\n      fill: [''],\r\n      stroke: ['']\r\n    });\r\n  }\r\n\r\n  private buildStyleData() {\r\n    this.styleModalData = {\r\n      fillColor:\r\n        this.data.features.length > 0\r\n        ? this.data.features[0].properties.drawingStyle.fill\r\n        : 'rgba(255,255,255,0.4)',\r\n      strokeColor:\r\n        this.data.features.length > 0\r\n        ? this.data.features[0].properties.drawingStyle.stroke\r\n        : 'rgba(143,7,7,1)',\r\n      fontSize:\r\n        this.data.features.length > 0\r\n        ? this.data.features[0].properties.fontStyle\r\n            .split(' ')[0]\r\n            .replace('px', '')\r\n        : '20',\r\n      fontStyle:\r\n        this.data.features.length > 0\r\n        ? this.data.features[0].properties.fontStyle.substring(\r\n            this.data.features[0].properties.fontStyle.indexOf(' ') + 1)\r\n        : FontType.Arial,\r\n      offsetX:\r\n        this.data.features.length > 0\r\n        ? this.data.features[0].properties.offsetX\r\n        : this.drawStyleService.getOffsetX(),\r\n      offsetY:\r\n        this.data.features.length > 0\r\n        ? this.data.features[0].properties.offsetY\r\n        : this.drawStyleService.getOffsetY()\r\n    };\r\n  }\r\n\r\n  get allFontStyles(): string[] {\r\n    return Object.values(FontType);\r\n  }\r\n\r\n  getFeatureFontSize(): string {\r\n    if (!this.styleModalData.fontSize) {\r\n      return this.data.features.length > 0\r\n      ? this.data.features[0].properties.fontStyle\r\n          .split(' ')[0]\r\n          .replace('px', '')\r\n      : '20';\r\n    } else {\r\n      return this.styleModalData.fontSize;\r\n    }\r\n  }\r\n\r\n  getFeatureFontStyle() {\r\n    if (!this.styleModalData.fontStyle) {\r\n      return this.data.features.length > 0\r\n      ? this.data.features[0].properties.fontStyle.substring(\r\n        this.data.features[0].properties.fontStyle.indexOf(' ') + 1\r\n        )\r\n      : FontType.Arial;\r\n    } else {\r\n      return this.styleModalData.fontStyle;\r\n    }\r\n  }\r\n\r\n  getFeatureFillColor() {\r\n    if (!this.styleModalData.fillColor) {\r\n      return this.data.features.length > 0\r\n        ? this.data.features[0].properties.drawingStyle.fill\r\n        : 'rgba(255,255,255,0.4)';\r\n    } else {\r\n      return this.styleModalData.fillColor;\r\n    }\r\n  }\r\n\r\n  getFeatureStrokeColor() {\r\n    if (!this.styleModalData.strokeColor) {\r\n      return this.data.features.length > 0\r\n        ? this.data.features[0].properties.drawingStyle.stroke\r\n        : 'rgba(143,7,7,1)';\r\n    } else {\r\n      return this.styleModalData.strokeColor;\r\n    }\r\n  }\r\n\r\n  getFeatureOffsetX() {\r\n    if (!this.styleModalData.offsetX) {\r\n      return this.data.features.length > 0\r\n        ? this.data.features[0].properties.offsetX\r\n        : this.drawStyleService.getOffsetX();\r\n    } else {\r\n      return this.styleModalData.offsetX;\r\n    }\r\n  }\r\n\r\n  getFeatureOffsetY() {\r\n    if (!this.styleModalData.offsetY) {\r\n      return this.data.features.length > 0\r\n      ? this.data.features[0].properties.offsetY\r\n      : this.drawStyleService.getOffsetY();\r\n    } else {\r\n      return this.styleModalData.offsetY;\r\n    }\r\n  }\r\n\r\n  cancelDrawing() {\r\n    this.dialogRef.close();\r\n  }\r\n\r\n  confirm() {\r\n    this.confirmFlag = true;\r\n    this.dialogRef.close(this.styleModalData);\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatDividerModule } from '@angular/material/divider';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatMenuModule } from '@angular/material/menu';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatSlideToggleModule } from '@angular/material/slide-toggle';\r\nimport { MatSliderModule } from '@angular/material/slider';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { ColorPickerModule } from 'ngx-color-picker';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport {\r\n  IgoListModule,\r\n  IgoCollapsibleModule,\r\n  IgoImageModule,\r\n  IgoPanelModule,\r\n  IgoMatBadgeIconModule,\r\n  IgoCustomHtmlModule\r\n} from '@igo2/common';\r\n\r\nimport { LayerService } from './shared/layer.service';\r\nimport { StyleService } from './shared/style.service';\r\nimport { LayerListToolService } from './layer-list-tool/layer-list-tool.service';\r\nimport { LayerItemComponent } from './layer-item/layer-item.component';\r\nimport { LayerLegendComponent } from './layer-legend/layer-legend.component';\r\nimport { LayerListComponent } from './layer-list/layer-list.component';\r\nimport { LayerListToolComponent } from './layer-list-tool/layer-list-tool.component';\r\nimport { LayerListBindingDirective } from './layer-list/layer-list-binding.directive';\r\nimport { LayerLegendListBindingDirective } from './layer-legend-list/layer-legend-list-binding.directive';\r\nimport { TrackFeatureButtonComponent } from './track-feature-button/track-feature-button.component';\r\nimport { LayerLegendListComponent } from './layer-legend-list/layer-legend-list.component';\r\nimport { LayerLegendItemComponent } from './layer-legend-item/layer-legend-item.component';\r\nimport { StyleModalComponent } from './style-modal/style-modal.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    MatInputModule,\r\n    ReactiveFormsModule,\r\n    MatFormFieldModule,\r\n    CommonModule,\r\n    FormsModule,\r\n    MatDividerModule,\r\n    MatMenuModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatSlideToggleModule,\r\n    MatSelectModule,\r\n    MatTooltipModule,\r\n    MatListModule,\r\n    MatSliderModule,\r\n    MatBadgeModule,\r\n    MatCheckboxModule,\r\n    ColorPickerModule,\r\n    IgoLanguageModule,\r\n    IgoListModule,\r\n    IgoCollapsibleModule,\r\n    IgoImageModule,\r\n    IgoPanelModule,\r\n    IgoMatBadgeIconModule,\r\n    IgoCustomHtmlModule\r\n  ],\r\n  exports: [\r\n    LayerItemComponent,\r\n    LayerLegendItemComponent,\r\n    LayerLegendComponent,\r\n    LayerListComponent,\r\n    LayerListToolComponent,\r\n    LayerLegendListComponent,\r\n    LayerListBindingDirective,\r\n    LayerLegendListBindingDirective,\r\n    TrackFeatureButtonComponent,\r\n    StyleModalComponent\r\n  ],\r\n  declarations: [\r\n    LayerItemComponent,\r\n    LayerLegendItemComponent,\r\n    LayerLegendComponent,\r\n    LayerListComponent,\r\n    LayerListToolComponent,\r\n    LayerLegendListComponent,\r\n    LayerListBindingDirective,\r\n    LayerLegendListBindingDirective,\r\n    TrackFeatureButtonComponent,\r\n    StyleModalComponent\r\n  ]\r\n})\r\nexport class IgoLayerModule {\r\n  static forRoot(): ModuleWithProviders<IgoLayerModule> {\r\n    return {\r\n      ngModule: IgoLayerModule,\r\n      providers: [LayerService, StyleService, LayerListToolService]\r\n    };\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport {\r\n  IgoMatBadgeIconModule,\r\n  IgoCollapsibleModule,\r\n  IgoListModule\r\n} from '@igo2/common';\r\n\r\nimport { IgoMetadataModule } from './../../metadata/metadata.module';\r\nimport { CatalogBrowserComponent } from './catalog-browser.component';\r\nimport { CatalogBrowserLayerComponent } from './catalog-browser-layer.component';\r\nimport { CatalogBrowserGroupComponent } from './catalog-browser-group.component';\r\nimport { IgoLayerModule } from '../../layer/layer.module';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatBadgeModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    MatListModule,\r\n    MatTooltipModule,\r\n    IgoMatBadgeIconModule,\r\n    IgoLanguageModule,\r\n    IgoListModule,\r\n    IgoCollapsibleModule,\r\n    IgoMetadataModule,\r\n    IgoLayerModule\r\n  ],\r\n  exports: [\r\n    CatalogBrowserComponent\r\n  ],\r\n  declarations: [\r\n    CatalogBrowserComponent,\r\n    CatalogBrowserGroupComponent,\r\n    CatalogBrowserLayerComponent\r\n  ]\r\n})\r\nexport class IgoCatalogBrowserModule {}\r\n","<h1 mat-dialog-title class=\"mat-typography\">{{'igo.geo.catalog.library.addTitle' | translate}}</h1>\r\n<div mat-dialog-content class=\"mat-typography\">\r\n  <form class=\"igo-form\" [formGroup]=\"form\">\r\n    <div class=\"igo-input-container\">\r\n      <mat-form-field>\r\n        <input type=\"text\" formControlName=\"title\" placeholder=\"{{'igo.geo.printForm.title' | translate}}\" matInput [matAutocomplete]=\"auto2\">\r\n        <mat-autocomplete #auto2=\"matAutocomplete\" (optionSelected)='changeUrlOrTitle($event.option.value)'>\r\n          <mat-option *ngFor=\"let predefinedCatalog of (predefinedCatalogsList$ | async)\" matTooltipShowDelay=\"500\"\r\n            [matTooltip]=\"predefinedCatalog.title\" [value]=\"predefinedCatalog\">\r\n            {{predefinedCatalog.title}}\r\n          </mat-option>\r\n        </mat-autocomplete>\r\n      </mat-form-field>\r\n    </div>\r\n    <div class=\"igo-input-container\">\r\n      <mat-form-field>\r\n        <input type=\"text\" formControlName=\"url\" placeholder=\"URL\" matInput [matAutocomplete]=\"auto\">\r\n        <mat-autocomplete #auto=\"matAutocomplete\" (optionSelected)='changeUrlOrTitle($event.option.value)'>\r\n          <mat-option *ngFor=\"let predefinedCatalog of (predefinedCatalogsList$ | async)\" matTooltipShowDelay=\"500\"\r\n            [matTooltip]=\"predefinedCatalog.url\" [value]=\"predefinedCatalog\">\r\n            {{predefinedCatalog.url}}\r\n          </mat-option>\r\n        </mat-autocomplete>\r\n      </mat-form-field>\r\n    </div>\r\n    <div class=\"igo-input-container\">\r\n      <mat-form-field>\r\n        <mat-select\r\n          formControlName=\"type\"\r\n          placeholder=\"Type\">\r\n          <mat-option\r\n            *ngFor=\"let type of typeCapabilities\"\r\n            [value]=\"type\"\r\n            (click)=\"$event.stopPropagation()\">\r\n              <p mat-line>{{type}}</p>\r\n          </mat-option>\r\n        </mat-select>\r\n      </mat-form-field>\r\n    </div>\r\n  </form>\r\n  <span *ngIf=\"error && addedCatalog && emailAddress\">\r\n    <p class=\"error\">{{languageService.translate.instant('igo.geo.catalog.externalProvider.unavailableWithEmail', { value: addedCatalog.url, email: emailAddress })}}</p>\r\n  </span>\r\n  <span *ngIf=\"error && addedCatalog && !emailAddress\">\r\n    <p class=\"error\">{{languageService.translate.instant('igo.geo.catalog.unavailable', { value: addedCatalog.url })}}</p>\r\n  </span>\r\n</div>\r\n<div mat-dialog-actions style=\"justify-content: center\">\r\n  <div class=\"igo-form-button-group add-catalog-button-top-padding\">\r\n    <button\r\n      mat-raised-button\r\n      type=\"button\"\r\n      (click)=\"cancel()\">\r\n      {{'igo.geo.catalog.library.cancel' | translate}}\r\n    </button>\r\n    <button\r\n      id=\"addCatalogBtnDialog\"\r\n      mat-raised-button\r\n      type=\"button\"\r\n      color=\"primary\"\r\n      [disabled]=\"!form.valid\"\r\n      (click)=\"addCatalog(form.value)\">\r\n      {{'igo.geo.catalog.library.add' | translate}}\r\n    </button>\r\n  </div>\r\n</div>","import { LanguageService, ConfigService } from '@igo2/core';\r\nimport { Component, OnInit, OnDestroy, Optional, Inject } from '@angular/core';\r\nimport { MatDialogRef, MAT_DIALOG_DATA } from '@angular/material/dialog';\r\nimport { UntypedFormBuilder, UntypedFormGroup, Validators } from '@angular/forms';\r\nimport { Subscription, BehaviorSubject } from 'rxjs';\r\n\r\nimport { EntityStore } from '@igo2/common';\r\nimport { TypeCapabilities } from '../../datasource';\r\nimport { Catalog } from '../shared/catalog.abstract';\r\n\r\n@Component({\r\n  selector: 'igo-add-catalog-dialog',\r\n  templateUrl: './add-catalog-dialog.component.html',\r\n  styleUrls: ['./add-catalog-dialog.component.scss']\r\n})\r\nexport class AddCatalogDialogComponent implements OnInit, OnDestroy {\r\n  public form: UntypedFormGroup;\r\n  private defaultAddedCatalogType = 'wms';\r\n  private addedCatalogType$$: Subscription;\r\n  public predefinedCatalogsList$ = new BehaviorSubject<Catalog[]>([]);\r\n  typeCapabilities: string[];\r\n  predefinedCatalogs: Catalog[] = [];\r\n  store: EntityStore<Catalog>;\r\n  error = false;\r\n  addedCatalog: Catalog;\r\n  emailAddress: string;\r\n  private storeViewAll$$: Subscription;\r\n\r\n  constructor(\r\n    private formBuilder: UntypedFormBuilder,\r\n    public languageService: LanguageService,\r\n    private configService: ConfigService,\r\n    public dialogRef: MatDialogRef<AddCatalogDialogComponent>,\r\n    @Optional()\r\n    @Inject(MAT_DIALOG_DATA)\r\n    public data: { predefinedCatalogs: Catalog[]; store: EntityStore<Catalog>; error: boolean; addedCatalog: Catalog }\r\n  ) {\r\n    this.store = data.store;\r\n    this.predefinedCatalogs = data.predefinedCatalogs;\r\n    this.error = data.error;\r\n    this.addedCatalog = data.addedCatalog;\r\n    this.form = this.formBuilder.group({\r\n      id: ['', []],\r\n      title: ['', []],\r\n      url: ['', [Validators.required]],\r\n      type: [this.defaultAddedCatalogType, [Validators.required]]\r\n    });\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.store.state.clear();\r\n    this.typeCapabilities = Object.keys(TypeCapabilities);\r\n\r\n    this.addedCatalogType$$ = this.form\r\n      .get('type')\r\n      .valueChanges.subscribe((value) => {\r\n        if (value === 'wmts') {\r\n          this.form.get('title').setValidators(Validators.required);\r\n        } else {\r\n          this.form.get('title').setValidators([]);\r\n        }\r\n        this.form.get('title').updateValueAndValidity();\r\n      });\r\n\r\n    this.computePredefinedCatalogList();\r\n    this.storeViewAll$$ = this.store.view\r\n      .all$()\r\n      .subscribe(() => this.computePredefinedCatalogList());\r\n\r\n    this.emailAddress = this.configService.getConfig('emailAddress');\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.addedCatalogType$$.unsubscribe();\r\n    this.storeViewAll$$.unsubscribe();\r\n  }\r\n\r\n  changeUrlOrTitle(catalog: Catalog) {\r\n    this.form.patchValue(catalog);\r\n    this.error = false;\r\n    this.computePredefinedCatalogList();\r\n  }\r\n\r\n  computePredefinedCatalogList() {\r\n    this.predefinedCatalogsList$.next(\r\n      this.predefinedCatalogs.filter((c) => !this.store.get(c.id))\r\n    );\r\n  }\r\n\r\n  addCatalog(addedCatalog: Catalog) {\r\n    this.error = false;\r\n    this.dialogRef.close(addedCatalog);\r\n  }\r\n\r\n  cancel() {\r\n    this.error = false;\r\n    this.dialogRef.close();\r\n  }\r\n}\r\n","<igo-list [navigation]=\"false\">\r\n  <ng-template ngFor let-catalog [ngForOf]=\"getCatalogs() | async\">\r\n    <igo-catalog-library-item\r\n      igoListItem\r\n      color=\"accent\"\r\n      [map]=\"map\"\r\n      [catalog]=\"catalog\"\r\n      (catalogRemove)=\"onCatalogRemove(catalog)\"\r\n      (select)=\"onCatalogSelect(catalog)\">\r\n    </igo-catalog-library-item>\r\n  </ng-template>\r\n</igo-list>\r\n\r\n<div *ngIf=\"addCatalogAllowed\" class=btnAddCatalog>\r\n  <button\r\n    mat-raised-button\r\n    [matTooltip]=\"'igo.geo.catalog.library.addBtn' | translate\"\r\n    matTooltipPosition=\"above\"\r\n    color=\"primary\"\r\n    (click)=\"addCatalogDialog()\">\r\n    {{'igo.geo.catalog.library.addBtn' | translate}}\r\n    <mat-icon svgIcon=\"earth-plus\"></mat-icon>\r\n  </button>\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\nimport { MatDialog } from '@angular/material/dialog';\r\n\r\nimport { EntityStore } from '@igo2/common';\r\nimport { LanguageService, MessageService, StorageService } from '@igo2/core';\r\nimport { ObjectUtils } from '@igo2/utils';\r\nimport { Observable, Subscription } from 'rxjs';\r\nimport { catchError } from 'rxjs/operators';\r\nimport { Md5 } from 'ts-md5';\r\nimport { CapabilitiesService } from '../../datasource';\r\nimport { IgoMap } from '../../map';\r\nimport { standardizeUrl } from '../../utils/id-generator';\r\nimport { Catalog } from '../shared/catalog.abstract';\r\nimport { AddCatalogDialogComponent } from './add-catalog-dialog.component';\r\n\r\n/**\r\n * Component to browse a list of available catalogs\r\n */\r\n@Component({\r\n  selector: 'igo-catalog-library',\r\n  templateUrl: './catalog-library.component.html',\r\n  styleUrls: ['./catalog-library.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class CatalogLibaryComponent implements OnInit, OnDestroy {\r\n  /**\r\n   * Store holding the catalogs\r\n   */\r\n  @Input() store: EntityStore<Catalog>;\r\n\r\n  /**\r\n   * Map to add the catalog items to\r\n   */\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * Determine if the form to add a catalog is allowed\r\n   */\r\n  @Input() addCatalogAllowed: boolean = false;\r\n\r\n  /**\r\n   * Determine if the form to add a catalog is allowed\r\n   */\r\n  @Input() predefinedCatalogs: Catalog[] = [];\r\n\r\n  /**\r\n   * Event emitted a catalog is selected or unselected\r\n   */\r\n  @Output() catalogSelectChange = new EventEmitter<{\r\n    selected: boolean;\r\n    catalog: Catalog;\r\n  }>();\r\n\r\n  submitDisabled = true;\r\n  private addingCatalog$$: Subscription;\r\n\r\n  get addedCatalogs(): Catalog[] {\r\n    return (this.storageService.get('addedCatalogs') || []) as Catalog[];\r\n  }\r\n  set addedCatalogs(catalogs: Catalog[]) {\r\n    this.storageService.set('addedCatalogs', catalogs);\r\n  }\r\n\r\n  constructor(\r\n    private capabilitiesService: CapabilitiesService,\r\n    private messageService: MessageService,\r\n    private languageService: LanguageService,\r\n    private storageService: StorageService,\r\n    private dialog: MatDialog\r\n  ) {}\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.store.state.clear();\r\n\r\n    this.predefinedCatalogs = this.predefinedCatalogs.map(c => {\r\n      c.id = Md5.hashStr(\r\n        (c.type || 'wms') + standardizeUrl(c.url)\r\n      ) as string;\r\n      c.title = c.title === '' || !c.title ? c.url : c.title;\r\n      return c;\r\n    });\r\n  }\r\n\r\n  getCatalogs(): Observable<Catalog[]> {\r\n    return this.store.view.all$();\r\n  }\r\n\r\n  /**\r\n   * When a catalog is selected, update it's state in the store\r\n   * and emit the catalog select change event\r\n   * @internal\r\n   */\r\n  onCatalogSelect(catalog: Catalog) {\r\n    this.store.state.update(\r\n      catalog,\r\n      {\r\n        selected: true,\r\n        focused: true\r\n      },\r\n      true\r\n    );\r\n    this.catalogSelectChange.emit({ selected: true, catalog });\r\n  }\r\n\r\n  private unsubscribeAddingCatalog() {\r\n    if (this.addingCatalog$$) {\r\n      this.addingCatalog$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  addCatalog(addedCatalog: Catalog) {\r\n    if (!addedCatalog) {\r\n      return;\r\n    }\r\n    let id = Md5.hashStr(\r\n      addedCatalog.type + standardizeUrl(addedCatalog.url)\r\n    ) as string;\r\n    const predefinedCatalog = this.predefinedCatalogs.find(\r\n      (c) => c.id === addedCatalog.id\r\n    );\r\n\r\n    if (predefinedCatalog) {\r\n      addedCatalog.version = predefinedCatalog.version;\r\n      addedCatalog.externalProvider = predefinedCatalog.externalProvider;\r\n      id = predefinedCatalog.id;\r\n    }\r\n\r\n    if (this.store.get(id)) {\r\n      const title = this.languageService.translate.instant(\r\n        'igo.geo.catalog.library.inlist.title'\r\n      );\r\n      const message = this.languageService.translate.instant(\r\n        'igo.geo.catalog.library.inlist.message'\r\n      );\r\n      this.messageService.alert(message, title);\r\n      return;\r\n    }\r\n    this.unsubscribeAddingCatalog();\r\n\r\n    this.addingCatalog$$ = this.capabilitiesService\r\n    .getCapabilities(addedCatalog.type as any, addedCatalog.url, addedCatalog.version)\r\n      .pipe(\r\n        catchError((e) => {\r\n          const title = this.languageService.translate.instant('igo.geo.catalog.unavailableTitle');\r\n          if (e.error) {\r\n            this.addCatalogDialog(true, addedCatalog);\r\n            e.error.caught = true;\r\n            return e;\r\n          }\r\n          const message = this.languageService.translate.instant('igo.geo.catalog.unavailable', { value: addedCatalog.url });\r\n          this.messageService.error(message, title);\r\n          throw e;\r\n        })\r\n      )\r\n      .subscribe((capabilities) => {\r\n        let title;\r\n        let version;\r\n        switch (addedCatalog.type) {\r\n          case 'wms':\r\n            title = addedCatalog.title || capabilities.Service.Title;\r\n            version = addedCatalog.version || capabilities.version;\r\n            break;\r\n          case 'arcgisrest':\r\n          case 'imagearcgisrest':\r\n          case 'tilearcgisrest':\r\n            title = addedCatalog.title || capabilities.mapName;\r\n            break;\r\n          case 'wmts':\r\n            title =\r\n              addedCatalog.title ||\r\n              capabilities.ServiceIdentification.ServiceType;\r\n            break;\r\n          default:\r\n            title = addedCatalog.title;\r\n        }\r\n\r\n        const catalogToAdd = ObjectUtils.removeUndefined(\r\n          Object.assign({},\r\n            predefinedCatalog,\r\n            ObjectUtils.removeUndefined({\r\n              id,\r\n              title,\r\n              url: addedCatalog.url,\r\n              type: addedCatalog.type || 'wms',\r\n              externalProvider: addedCatalog.externalProvider || false,\r\n              removable: true,\r\n              version\r\n            })) as Catalog);\r\n        this.store.insert(catalogToAdd);\r\n        const newCatalogs = this.addedCatalogs.slice(0);\r\n        newCatalogs.push(catalogToAdd);\r\n        this.addedCatalogs = newCatalogs;\r\n        this.unsubscribeAddingCatalog();\r\n      });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.unsubscribeAddingCatalog();\r\n  }\r\n\r\n  onCatalogRemove(catalog) {\r\n    this.store.delete(catalog);\r\n    this.addedCatalogs = this.addedCatalogs\r\n      .slice(0)\r\n      .filter((c) => c.id !== catalog.id);\r\n  }\r\n\r\n  addCatalogDialog(error?, addedCatalog?: Catalog) {\r\n    const dialogRef = this.dialog.open(AddCatalogDialogComponent, {\r\n      width: '700px',\r\n      data: {\r\n        predefinedCatalogs: this.predefinedCatalogs,\r\n        store: this.store,\r\n        error,\r\n        addedCatalog\r\n      }\r\n    });\r\n\r\n    dialogRef.afterClosed().subscribe((catalog) => {\r\n      this.addCatalog(catalog);\r\n    });\r\n  }\r\n}\r\n","<mat-list-item>\r\n  <h4 mat-line>\r\n    {{title}}\r\n  </h4>\r\n  <mat-icon\r\n    class=\"igo-external-provider\"\r\n    *ngIf=\"catalog.externalProvider\"\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"'igo.geo.catalog.externalProvider.catalog' | translate\"\r\n    color=\"primary\"\r\n    (click)=\"$event.stopPropagation()\"\r\n    svgIcon=\"earth-arrow-right\">\r\n  </mat-icon>\r\n\r\n  <button\r\n  *ngIf=\"catalog.removable\"\r\n  mat-icon-button\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.catalog.library.remove' | translate\"\r\n  color=\"warn\"\r\n  (click)=\"removeCatalogFromLibrary($event)\">\r\n  <mat-icon svgIcon=\"delete\"></mat-icon>\r\n</button>\r\n\r\n<button\r\n  class=\"igo-blank\"\r\n  *ngIf=\"!catalog.removable\"\r\n  disabled=\"true\"\r\n  mat-icon-button>\r\n  <mat-icon svgIcon=\"blank\"></mat-icon>\r\n</button>\r\n</mat-list-item>\r\n","import { Component, Input, ChangeDetectionStrategy, Output, EventEmitter } from '@angular/core';\r\n\r\nimport { getEntityTitle } from '@igo2/common';\r\nimport { IgoMap } from '../../map';\r\nimport { Catalog } from '../shared/catalog.abstract';\r\n\r\n/**\r\n * Catalog library item\r\n */\r\n@Component({\r\n  selector: 'igo-catalog-library-item',\r\n  templateUrl: './catalog-library-item.component.html',\r\n  styleUrls: ['./catalog-library-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class CatalogLibaryItemComponent {\r\n\r\n  /**\r\n   * Catalog\r\n   */\r\n  @Input() catalog: Catalog;\r\n\r\n  /**\r\n   * Map to add the catalog items to\r\n   */\r\n  @Input() map: IgoMap;\r\n\r\n  @Output() catalogRemove = new EventEmitter();\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get title(): string { return getEntityTitle(this.catalog); }\r\n\r\n  removeCatalogFromLibrary(event) {\r\n    event.stopPropagation();\r\n    this.catalogRemove.emit();\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoListModule } from '@igo2/common';\r\n\r\nimport { CatalogLibaryComponent, } from './catalog-library.component';\r\nimport { CatalogLibaryItemComponent } from './catalog-library-item.component';\r\nimport { AddCatalogDialogComponent } from './add-catalog-dialog.component';\r\n\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { ReactiveFormsModule } from '@angular/forms';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatAutocompleteModule } from '@angular/material/autocomplete';\r\nimport { MatDialogModule } from '@angular/material/dialog';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatIconModule,\r\n    MatBadgeModule,\r\n    MatListModule,\r\n    MatTooltipModule,\r\n    IgoListModule,\r\n    IgoLanguageModule,\r\n    MatButtonModule,\r\n    MatFormFieldModule,\r\n    ReactiveFormsModule,\r\n    MatInputModule,\r\n    MatSelectModule,\r\n    MatAutocompleteModule,\r\n    MatDialogModule\r\n  ],\r\n  exports: [\r\n    CatalogLibaryComponent,\r\n    AddCatalogDialogComponent\r\n  ],\r\n  declarations: [\r\n    CatalogLibaryComponent,\r\n    CatalogLibaryItemComponent,\r\n    AddCatalogDialogComponent\r\n  ]\r\n})\r\nexport class IgoCatalogLibraryModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoListModule, IgoCollapsibleModule, IgoMatBadgeIconModule } from '@igo2/common';\r\n\r\nimport { IgoCatalogBrowserModule } from './catalog-browser/catalog-browser.module';\r\nimport { IgoCatalogLibraryModule } from './catalog-library/catalog-library.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatBadgeModule,\r\n    MatIconModule,\r\n    MatListModule,\r\n    MatTooltipModule,\r\n    IgoMatBadgeIconModule,\r\n    IgoListModule,\r\n    IgoCollapsibleModule\r\n  ],\r\n  exports: [\r\n    IgoCatalogBrowserModule,\r\n    IgoCatalogLibraryModule\r\n  ],\r\n  declarations: []\r\n})\r\nexport class IgoCatalogModule {}\r\n","import { Pipe, PipeTransform } from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\n\r\nimport { OgcFilterableDataSource } from './ogc-filter.interface';\r\nimport { TimeFilterableDataSource } from './time-filter.interface';\r\n\r\n@Pipe({\r\n  name: 'filterableDataSource'\r\n})\r\nexport class FilterableDataSourcePipe implements PipeTransform {\r\n  transform(value: Layer[], arg: string): Layer[] {\r\n    let layers;\r\n\r\n    if (arg === 'time') {\r\n      layers = value.filter((layer: Layer) => {\r\n        const datasource = layer.dataSource as TimeFilterableDataSource;\r\n        return (\r\n          this.isTimeFilterable(datasource) &&\r\n          datasource.options.timeFilter !== undefined &&\r\n          Object.keys(datasource.options.timeFilter).length\r\n        );\r\n      });\r\n    }\r\n    if (arg === 'ogc') {\r\n      layers = value.filter((layer: Layer) => {\r\n        const datasource = layer.dataSource as OgcFilterableDataSource;\r\n        return this.isOgcFilterable(datasource);\r\n      });\r\n    }\r\n    return layers;\r\n  }\r\n\r\n  private isTimeFilterable(dataSource: TimeFilterableDataSource) {\r\n    if (dataSource.options.type !== 'wms') {\r\n      return false;\r\n    }\r\n    return dataSource.options.timeFilterable;\r\n  }\r\n\r\n  private isOgcFilterable(dataSource: OgcFilterableDataSource): boolean {\r\n    let isOgcFilterable = false;\r\n    if (\r\n      dataSource.options.ogcFilters &&\r\n      dataSource.options.ogcFilters.enabled &&\r\n      dataSource.options.ogcFilters.editable\r\n    ) {\r\n      isOgcFilterable = true;\r\n    }\r\n    if (\r\n      dataSource.options.ogcFilters &&\r\n      dataSource.options.ogcFilters.enabled &&\r\n      (\r\n        dataSource.options.ogcFilters.pushButtons ||\r\n        dataSource.options.ogcFilters.checkboxes ||\r\n        dataSource.options.ogcFilters.radioButtons ||\r\n        dataSource.options.ogcFilters.select ||\r\n        dataSource.options.ogcFilters.autocomplete)) {\r\n        isOgcFilterable = true;\r\n    }\r\n    return isOgcFilterable;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { WMSDataSource } from '../../datasource/shared/datasources/wms-datasource';\r\nimport { TileArcGISRestDataSource } from '../../datasource/shared/datasources/tilearcgisrest-datasource';\r\n\r\n@Injectable()\r\nexport class TimeFilterService {\r\n  constructor() {}\r\n\r\n  filterByDate(\r\n    datasource: WMSDataSource | TileArcGISRestDataSource,\r\n    date: Date | [Date, Date]\r\n  ) {\r\n    let time;\r\n    let newdateform;\r\n    let newdateformStart;\r\n    let newdateformEnd;\r\n\r\n    if (Array.isArray(date)) {\r\n      const dates = [];\r\n      if (date[0]) {\r\n        newdateformStart = this.reformatDateTime(date[0]);\r\n        dates.push(date[0]);\r\n      }\r\n      if (date[1]) {\r\n        newdateformEnd = this.reformatDateTime(date[1]);\r\n        dates.push(date[1]);\r\n      }\r\n      if (dates.length === 2 && newdateformStart !== newdateformEnd) {\r\n        if (datasource instanceof TileArcGISRestDataSource) {\r\n          time = newdateformStart + ',' + newdateformEnd;\r\n        } else {\r\n          time = newdateformStart + '/' + newdateformEnd;\r\n        }\r\n      }\r\n      if (newdateformStart === newdateformEnd) {\r\n        time = newdateformStart;\r\n      }\r\n    } else if (date) {\r\n      newdateform = this.reformatDateTime(date);\r\n      time = newdateform;\r\n    }\r\n\r\n    const params = { TIME: time };\r\n    datasource.ol.updateParams(params);\r\n    if (datasource instanceof WMSDataSource) {\r\n      const wmsDataSource = datasource as WMSDataSource;\r\n      wmsDataSource.setTimeFilter(wmsDataSource.timeFilter, true);\r\n    }\r\n  }\r\n\r\n  filterByYear(\r\n    datasource: WMSDataSource | TileArcGISRestDataSource,\r\n    year: string | [string, string]\r\n  ) {\r\n    let time;\r\n    let newdateformStart;\r\n    let newdateformEnd;\r\n\r\n    if (Array.isArray(year)) {\r\n      const years = [];\r\n      if (year[0]) {\r\n        newdateformStart = year[0];\r\n        years.push(year[0]);\r\n      }\r\n      if (year[1]) {\r\n        newdateformEnd = year[1];\r\n        years.push(year[1]);\r\n      }\r\n      if (years.length === 2 && newdateformStart !== newdateformEnd) {\r\n        if (datasource instanceof TileArcGISRestDataSource) {\r\n          time = newdateformStart + ',' + newdateformEnd;\r\n        } else {\r\n          time = newdateformStart + '/' + newdateformEnd;\r\n        }\r\n      }\r\n      if (newdateformStart === newdateformEnd) {\r\n        time = newdateformStart;\r\n      }\r\n    } else { // to reset filter.\r\n      time = year;\r\n    }\r\n\r\n    const params = { TIME: time };\r\n    datasource.ol.updateParams(params);\r\n    if (datasource instanceof WMSDataSource) {\r\n      const wmsDataSource = datasource as WMSDataSource;\r\n      wmsDataSource.setTimeFilter(wmsDataSource.timeFilter, true);\r\n    }\r\n  }\r\n\r\n  private reformatDateTime(value) {\r\n    const year = value.getFullYear();\r\n    let month = value.getMonth() + 1;\r\n    let day = value.getUTCDate();\r\n    let hour = value.getUTCHours();\r\n    let minute = value.getUTCMinutes();\r\n\r\n    if (Number(month) < 10) {\r\n      month = '0' + month;\r\n    }\r\n\r\n    if (Number(day) < 10) {\r\n      day = '0' + day;\r\n    }\r\n\r\n    if (Number(hour) < 10) {\r\n      hour = '0' + hour;\r\n    }\r\n\r\n    if (Number(minute) < 10) {\r\n      minute = '0' + minute;\r\n    }\r\n\r\n    return year + '-' + month + '-' + day + 'T' + hour + ':' + minute + ':00Z';\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport olProjection from 'ol/proj/Projection';\r\n\r\nimport { WMSDataSource } from '../../datasource/shared/datasources/wms-datasource';\r\nimport { OgcFilterWriter } from './ogc-filter';\r\nimport { OgcFilterableDataSource } from './ogc-filter.interface';\r\n\r\n@Injectable()\r\nexport class OGCFilterService {\r\n  constructor() {}\r\n\r\n  public filterByOgc(wmsDatasource: WMSDataSource, filterString: string) {\r\n    const appliedFilter = new OgcFilterWriter().formatProcessedOgcFilter(filterString, wmsDatasource.options.params.LAYERS);\r\n    wmsDatasource.ol.updateParams({ FILTER: appliedFilter });\r\n  }\r\n\r\n  public setOgcWFSFiltersOptions(wfsDatasource: OgcFilterableDataSource) {\r\n    const options: any = wfsDatasource.options;\r\n    const ogcFilterWriter = new OgcFilterWriter();\r\n\r\n    if (options.ogcFilters.enabled && options.ogcFilters.filters) {\r\n      options.ogcFilters.filters = ogcFilterWriter.checkIgoFiltersProperties(\r\n        options.ogcFilters.filters,\r\n        options.paramsWFS.fieldNameGeometry,\r\n        new olProjection({ code: options.paramsWFS.srsName }),\r\n        true\r\n      );\r\n      if (!options.ogcFilters.interfaceOgcFilters) {\r\n        options.ogcFilters.interfaceOgcFilters = ogcFilterWriter.defineInterfaceFilterSequence(\r\n          options.ogcFilters.filters,\r\n          options.paramsWFS.fieldNameGeometry\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  public setOgcWMSFiltersOptions(wmsDatasource: OgcFilterableDataSource) {\r\n    const options: any = wmsDatasource.options;\r\n    const ogcFilterWriter = new OgcFilterWriter();\r\n\r\n    if (options.ogcFilters.enabled && options.ogcFilters.filters) {\r\n      options.ogcFilters.filters = ogcFilterWriter.checkIgoFiltersProperties(\r\n        options.ogcFilters.filters,\r\n        options.fieldNameGeometry,\r\n        undefined,\r\n        true\r\n      );\r\n      if (!options.ogcFilters.interfaceOgcFilters) {\r\n        options.ogcFilters.interfaceOgcFilters = ogcFilterWriter.defineInterfaceFilterSequence(\r\n          // With some wms server, this param must be set to make spatials call.\r\n          options.ogcFilters.filters,\r\n          options.fieldNameGeometry\r\n        );\r\n      }\r\n      this.filterByOgc(\r\n        wmsDatasource as WMSDataSource,\r\n        ogcFilterWriter.buildFilter(options.ogcFilters.filters,\r\n        undefined,\r\n        undefined,\r\n        undefined,\r\n        wmsDatasource.options\r\n        )\r\n      );\r\n      options.filtered = true;\r\n    } else {\r\n      options.ogcFilters.filters = undefined;\r\n      options.ogcFilters.interfaceOgcFilters = [];\r\n      options.filtered = false;\r\n    }\r\n  }\r\n}\r\n","export enum SpatialFilterQueryType {\r\n    AdmRegion = 'AdmRegion',\r\n    Mun = 'Mun',\r\n    Arrond = 'Arrond',\r\n    CircFed = 'CircFed',\r\n    CircProv = 'CircProv',\r\n    DirReg = 'DirReg',\r\n    MRC = 'MRC',\r\n    RegTour = 'RegTour'\r\n}\r\n\r\nexport enum SpatialFilterType {\r\n    Predefined = 'Predefined',\r\n    Polygon = 'Polygon',\r\n    Point = 'Point'\r\n}\r\n\r\nexport enum SpatialFilterItemType {\r\n    Address = 'Address',\r\n    Thematics = 'Thematics'\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { ConfigService, LanguageService } from '@igo2/core';\r\nimport { map } from 'rxjs/operators';\r\nimport { Observable } from 'rxjs';\r\nimport { Feature } from '../../feature/shared';\r\nimport {\r\n  SpatialFilterQueryType,\r\n  SpatialFilterItemType,\r\n  SpatialFilterType\r\n} from './spatial-filter.enum';\r\nimport { SpatialFilterThematic } from './spatial-filter.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class SpatialFilterService {\r\n  public baseUrl: string = 'https://geoegl.msp.gouv.qc.ca/apis/terrapi/';\r\n\r\n  /*\r\n   * Type association with URL\r\n   */\r\n  public urlFilterList = {\r\n    AdmRegion: 'regadmin',\r\n    Arrond: 'arrondissements',\r\n    CircFed: 'circ-fed',\r\n    CircProv: 'circ-prov',\r\n    DirReg: 'dir-reg',\r\n    MRC: 'mrc',\r\n    Mun: 'municipalites',\r\n    RegTour: 'tourisme',\r\n    bornes: 'bornes-sumi',\r\n    hydro: 'hydro',\r\n    routes: 'routes'\r\n  };\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private languageService: LanguageService,\r\n    private configService: ConfigService\r\n  ) {\r\n    this.baseUrl =\r\n      this.configService.getConfig('spatialFilter.url') || this.baseUrl;\r\n  }\r\n\r\n  getKeyByValue(object, value) {\r\n    return Object.keys(object).find(key => object[key] === value);\r\n  }\r\n\r\n  /*\r\n   * Loading data for spatial filter list component (NO GEOMETRY)\r\n   */\r\n  loadFilterList(type: SpatialFilterQueryType): Observable<Feature[]> {\r\n    const urlPath = type as string;\r\n    if (urlPath) {\r\n      return this.http\r\n        .get<{ features: Feature[] }>(\r\n          this.baseUrl + this.urlFilterList[urlPath]\r\n        )\r\n        .pipe(\r\n          map(featureCollection =>\r\n            featureCollection.features.map(f => {\r\n              f.meta = {\r\n                id: f.properties.code\r\n              };\r\n              return f;\r\n            })\r\n          )\r\n        );\r\n    }\r\n  }\r\n\r\n  /*\r\n   * Loading item list (STRING)\r\n   */\r\n  loadThematicsList() {\r\n    const url = 'types';\r\n    const items: SpatialFilterThematic[] = [];\r\n    return this.http.get(this.baseUrl + url).pipe(\r\n      map((types: string[]) => {\r\n        types.forEach(type => {\r\n          if (type.startsWith('lieux')) {\r\n            const item: SpatialFilterThematic = {\r\n              name: undefined,\r\n              source: type\r\n            };\r\n            let substr = type.substring(6, type.length);\r\n            let name = substr;\r\n            if (substr.includes('.')) {\r\n              const index = substr.indexOf('.');\r\n              name = substr.substring(index + 1, substr.length);\r\n              substr = substr.substring(0, index);\r\n            }\r\n            try {\r\n              item.name = this.languageService.translate.instant(\r\n                'igo.geo.terrapi.' + name\r\n              );\r\n            } catch (e) {\r\n              item.name = name.substring(0, 1).toUpperCase() + name.substring(1, name.length - 1);\r\n            }\r\n\r\n            try {\r\n              item.group = this.languageService.translate.instant(\r\n                'igo.geo.spatialFilter.group.' + substr\r\n              );\r\n            } catch (e) {\r\n              item.group = substr.substring(0, 1).toUpperCase() + substr.substring(1, name.length - 1);\r\n            }\r\n\r\n            items.push(item);\r\n          } else {\r\n            if (this.getKeyByValue(this.urlFilterList, type)) {\r\n              const item: SpatialFilterThematic = {\r\n                name: undefined,\r\n                source: type\r\n              };\r\n              const name = this.getKeyByValue(this.urlFilterList, type);\r\n              try {\r\n                item.name = this.languageService.translate.instant(\r\n                  'igo.geo.terrapi.' + name\r\n                );\r\n              } catch (e) {\r\n                item.name = name.substring(0, 1).toUpperCase() + name.substring(1, name.length - 1);\r\n              }\r\n              item.source = type;\r\n\r\n              items.push(item);\r\n            }\r\n          }\r\n        });\r\n        return items;\r\n      })\r\n    );\r\n  }\r\n\r\n  /*\r\n   * Loading data for spatial filter item component (Address or Thematics) depends on predefined zone or draw zone (feature)\r\n   */\r\n  loadFilterItem(\r\n    feature,\r\n    itemType: SpatialFilterItemType,\r\n    type?: SpatialFilterQueryType,\r\n    thematic?: SpatialFilterThematic,\r\n    buffer?: number\r\n  ) {\r\n    if (type) {\r\n      // Predefined type\r\n      const urlType = type as string;\r\n      const url = this.baseUrl + this.urlFilterList[urlType];\r\n      let urlItem = '';\r\n      if (itemType === SpatialFilterItemType.Address) {\r\n        urlItem = 'adresses';\r\n        return this.http\r\n          .get<{ features: Feature[] }>(\r\n            url + '/' + feature.properties.code + '/' + urlItem,\r\n            {\r\n              params: {\r\n                geometry: 'true',\r\n                icon: 'true',\r\n                bufferInput: buffer.toString(),\r\n                simplified: '100'\r\n              }\r\n            }\r\n          )\r\n          .pipe(\r\n            map(featureCollection =>\r\n              featureCollection.features.map(f => {\r\n                f.meta = {\r\n                  id: f.properties.code,\r\n                  title: this.languageService.translate.instant(\r\n                    'igo.geo.spatialFilter.Address'\r\n                  ),\r\n                  icon: (f as any).icon\r\n                };\r\n                return f;\r\n              })\r\n            )\r\n          );\r\n      } else {\r\n        // If thematics search\r\n        urlItem = thematic.source;\r\n        return this.http\r\n          .get<{ features: Feature[] }>(\r\n            url + '/' + feature.properties.code + '/' + urlItem,\r\n            {\r\n              params: {\r\n                geometry: 'true',\r\n                icon: 'true',\r\n                bufferInput: buffer.toString(),\r\n                simplified: '100'\r\n              }\r\n            }\r\n          )\r\n          .pipe(\r\n            map(featureCollection =>\r\n              featureCollection.features.map(f => {\r\n                f.meta = {\r\n                  id: f.properties.code,\r\n                  title: thematic.name,\r\n                  icon: (f as any).icon\r\n                };\r\n                return f;\r\n              })\r\n            )\r\n          );\r\n      }\r\n    } else {\r\n      // Draw type\r\n      const url = this.baseUrl + 'locate';\r\n      if (itemType === SpatialFilterItemType.Address) {\r\n        const urlItem = '?type=adresses';\r\n        return this.http\r\n          .post<{ features: Feature[] }>(url + urlItem, {\r\n            geometry: 'true',\r\n            icon: 'true',\r\n            loc: JSON.stringify(feature),\r\n            bufferInput: buffer.toString(),\r\n            simplified: '100'\r\n          })\r\n          .pipe(\r\n            map(featureCollection =>\r\n              featureCollection.features.map(f => {\r\n                f.meta = {\r\n                  id: f.properties.code,\r\n                  title: this.languageService.translate.instant(\r\n                    'igo.geo.spatialFilter.Address'\r\n                  ),\r\n                  icon: (f as any).icon\r\n                };\r\n                return f;\r\n              })\r\n            )\r\n          );\r\n      } else {\r\n        // If thematics search\r\n        const urlItem = '?type=' + thematic.source;\r\n        return this.http\r\n          .post<{ features: Feature[] }>(url + urlItem, {\r\n            geometry: 'true',\r\n            icon: 'true',\r\n            loc: JSON.stringify(feature),\r\n            bufferInput: buffer.toString(),\r\n            simplified: '100'\r\n          })\r\n          .pipe(\r\n            map(featureCollection =>\r\n              featureCollection.features.map(f => {\r\n                f.meta = {\r\n                  id: f.properties.code,\r\n                  title: thematic.name,\r\n                  icon: (f as any).icon\r\n                };\r\n                return f;\r\n              })\r\n            )\r\n          );\r\n      }\r\n    }\r\n  }\r\n\r\n  /*\r\n   * Get one territory by id (WITH GEOMETRY)\r\n   */\r\n  loadItemById(\r\n    feature: Feature,\r\n    type: SpatialFilterQueryType\r\n  ): Observable<Feature> {\r\n    const featureType = this.urlFilterList[type];\r\n    const featureCode = '/' + feature.properties.code;\r\n    if (featureType && featureCode) {\r\n      return this.http\r\n        .get<Feature>(this.baseUrl + featureType + featureCode, {\r\n          params: {\r\n            geometry: 'true'\r\n          }\r\n        })\r\n        .pipe(\r\n          map(f => {\r\n            f.meta = {\r\n              id: f.properties.code,\r\n              alias: f.properties.nom,\r\n              title: f.properties.nom\r\n            };\r\n            return f;\r\n          })\r\n        );\r\n    }\r\n  }\r\n\r\n  /*\r\n   * Get buffer geometry\r\n   */\r\n  loadBufferGeometry(\r\n    feature: Feature,\r\n    filterType: SpatialFilterType,\r\n    buffer?: number,\r\n    type?: SpatialFilterQueryType,\r\n  ): Observable<Feature> {\r\n    if (filterType === SpatialFilterType.Predefined) {\r\n      const featureType = this.urlFilterList[type];\r\n      const featureCode = '/' + feature.properties.code;\r\n      if (featureType && featureCode) {\r\n        return this.http\r\n          .get<Feature>(this.baseUrl + featureType + featureCode,\r\n            {\r\n              params: {\r\n                geometry: '100',\r\n                bufferOutput: buffer.toString()\r\n              }\r\n            }\r\n          )\r\n          .pipe(\r\n            map(f => {\r\n              f.meta = {\r\n                id: f.properties.code,\r\n                alias: f.properties.nom,\r\n                title: f.properties.nom\r\n              };\r\n              return f;\r\n            })\r\n          );\r\n      }\r\n    } else {\r\n      return this.http\r\n        .post<Feature>(this.baseUrl + 'geospatial/buffer?', {\r\n          buffer,\r\n          loc: JSON.stringify(feature)\r\n        })\r\n        .pipe(\r\n          map(f => {\r\n            return f;\r\n          })\r\n        );\r\n    }\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport olProjection from 'ol/proj/Projection';\r\nimport * as olproj from 'ol/proj';\r\n\r\nimport { MessageService, LanguageService } from '@igo2/core';\r\n\r\nimport { Layer } from '../../layer/shared';\r\nimport { OgcFilterWriter, OgcFilterableDataSourceOptions } from '../../filter/shared';\r\n\r\nimport { DataSourceOptions } from '../../datasource/shared/datasources/datasource.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class DownloadService {\r\n\r\n  constructor(\r\n    private messageService: MessageService,\r\n    private languageService: LanguageService\r\n  ) {}\r\n\r\n  open(layer: Layer) {\r\n    const translate = this.languageService.translate;\r\n    const title = translate.instant('igo.geo.download.title');\r\n    this.messageService.success(\r\n      translate.instant('igo.geo.download.start'),\r\n      title\r\n    );\r\n\r\n    const DSOptions: DataSourceOptions = layer.dataSource.options;\r\n    if (Object.keys(DSOptions.download).length > 0) {\r\n      if (\r\n        DSOptions.download.dynamicUrl &&\r\n        DSOptions.download.url === undefined\r\n      ) {\r\n        let wfsOptions;\r\n        let currentProj = new olProjection({ code: layer.map.projection });\r\n        const paramsWFS = (layer.dataSource.options as any).paramsWFS;\r\n        if (paramsWFS && Object.keys(paramsWFS).length > 0\r\n        ) {\r\n          currentProj = paramsWFS.srsName ? new olProjection({ code: paramsWFS.srsName }) : currentProj;\r\n          wfsOptions = (layer.dataSource.options as any).paramsWFS;\r\n        } else {\r\n          wfsOptions = (layer.dataSource.options as any).params;\r\n        }\r\n\r\n        const currentExtent = olproj.transformExtent(\r\n          layer.map.viewController.getExtent(),\r\n          new olProjection({ code: layer.map.projection }),\r\n          currentProj\r\n        );\r\n        const outputFormatDownload =\r\n          wfsOptions.outputFormatDownload === undefined\r\n            ? wfsOptions.outputFormat === undefined ? '' : 'outputformat=' + wfsOptions.outputFormat\r\n            : 'outputformat=' + wfsOptions.outputFormatDownload;\r\n\r\n        const baseurl = DSOptions.download.dynamicUrl\r\n          .replace(/&?outputformat=[^&]*/gi, '')\r\n          .replace(/&?filter=[^&]*/gi, '')\r\n          .replace(/&?bbox=[^&]*/gi, '');\r\n\r\n        const ogcFilters = (layer.dataSource.options as OgcFilterableDataSourceOptions).ogcFilters;\r\n\r\n        let filterQueryString;\r\n        filterQueryString = new OgcFilterWriter()\r\n        .handleOgcFiltersAppliedValue(\r\n          layer.dataSource.options,\r\n          ogcFilters.geometryName,\r\n          currentExtent as [number, number, number, number],\r\n          currentProj);\r\n        if (!filterQueryString) {\r\n          // Prevent getting all the features for empty filter\r\n            filterQueryString = new OgcFilterWriter().buildFilter(\r\n            undefined,\r\n            currentExtent as [number, number, number, number],\r\n            currentProj,\r\n            ogcFilters.geometryName\r\n          );\r\n        } else {\r\n          filterQueryString = 'filter=' + encodeURIComponent(filterQueryString);\r\n        }\r\n        window.open(\r\n          `${baseurl}&${filterQueryString}&${outputFormatDownload}`,\r\n          '_blank'\r\n        );\r\n      } else if (DSOptions.download) {\r\n        window.open(DSOptions.download.url, '_blank');\r\n      }\r\n    }\r\n  }\r\n}\r\n","<button\r\n  *ngIf=\"options && options.download && (options.download['dynamicUrl'] || options.download['url']) \"\r\n  mat-icon-button\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.download.action' | translate\"\r\n  [color]=\"color\"\r\n  (click)=\"openDownload(layer)\">\r\n  <mat-icon svgIcon=\"download\"></mat-icon>\r\n</button>\r\n","import { Component, Input, ChangeDetectionStrategy } from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\n\r\nimport { DownloadDataSourceOptions } from '../shared/download.interface';\r\nimport { DownloadService } from '../shared/download.service';\r\n\r\n@Component({\r\n  selector: 'igo-download-button',\r\n  templateUrl: './download-button.component.html',\r\n  styleUrls: ['./download-button.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class DownloadButtonComponent {\r\n  @Input()\r\n  get layer(): Layer {\r\n    return this._layer;\r\n  }\r\n  set layer(value: Layer) {\r\n    this._layer = value;\r\n  }\r\n  private _layer: Layer;\r\n\r\n  @Input()\r\n  get color() {\r\n    return this._color;\r\n  }\r\n  set color(value: string) {\r\n    this._color = value;\r\n  }\r\n  private _color = 'primary';\r\n\r\n  constructor(private downloadService: DownloadService) {}\r\n\r\n  openDownload(layer: Layer) {\r\n    this.downloadService.open(layer);\r\n  }\r\n\r\n  get options(): DownloadDataSourceOptions {\r\n    if (!this.layer) {\r\n      return;\r\n    }\r\n    return this.layer.dataSource.options;\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { DownloadButtonComponent } from './download-button/download-button.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatTooltipModule,\r\n    IgoLanguageModule\r\n  ],\r\n  exports: [DownloadButtonComponent],\r\n  declarations: [DownloadButtonComponent]\r\n})\r\nexport class IgoDownloadModule {\r\n  static forRoot(): ModuleWithProviders<IgoDownloadModule> {\r\n    return {\r\n      ngModule: IgoDownloadModule\r\n    };\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatButtonToggleModule } from '@angular/material/button-toggle';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatSlideToggleModule } from '@angular/material/slide-toggle';\r\nimport { MatDividerModule } from '@angular/material/divider';\r\nimport { MatDialogModule } from '@angular/material/dialog';\r\nimport { ColorPickerModule } from 'ngx-color-picker';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoEntityTableModule } from '@igo2/common';\r\nimport { DrawComponent } from './draw.component';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { DrawPopupComponent } from './draw-popup.component';\r\nimport { DrawShorcutsComponent } from './draw-shorcuts.component';\r\nimport { DrawLayerPopupComponent } from './draw-layer-popup.component';\r\n\r\nimport { BrowserModule } from '@angular/platform-browser';\r\nimport { BrowserAnimationsModule } from '@angular/platform-browser/animations';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    CommonModule,\r\n    MatButtonModule,\r\n    MatButtonToggleModule,\r\n    MatDividerModule,\r\n    MatFormFieldModule,\r\n    MatIconModule,\r\n    MatBadgeModule,\r\n    MatTooltipModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatListModule,\r\n    MatSelectModule,\r\n    MatSlideToggleModule,\r\n    MatDialogModule,\r\n    IgoLanguageModule,\r\n    IgoEntityTableModule,\r\n    ColorPickerModule,\r\n    BrowserModule,\r\n    BrowserAnimationsModule\r\n  ],\r\n  declarations: [DrawComponent, DrawPopupComponent, DrawLayerPopupComponent, DrawShorcutsComponent],\r\n  exports: [DrawComponent]\r\n})\r\nexport class IgoDrawModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoKeyValueModule, IgoImageModule } from '@igo2/common';\r\n\r\nimport { FeatureDetailsComponent } from './feature-details.component';\r\nimport { FeatureDetailsDirective } from './feature-details.directive';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatIconModule,\r\n    IgoLanguageModule,\r\n    IgoKeyValueModule,\r\n    IgoImageModule\r\n  ],\r\n  exports: [\r\n    FeatureDetailsComponent,\r\n    FeatureDetailsDirective],\r\n  declarations: [\r\n    FeatureDetailsComponent,\r\n    FeatureDetailsDirective]\r\n})\r\nexport class IgoFeatureDetailsModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoFormModule } from '@igo2/common';\r\n\r\nimport { FeatureFormComponent } from './feature-form.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoFormModule\r\n  ],\r\n  exports: [\r\n    IgoFormModule,\r\n    FeatureFormComponent\r\n  ],\r\n  declarations: [\r\n    FeatureFormComponent\r\n  ]\r\n})\r\nexport class IgoFeatureFormModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoFeatureDetailsModule } from './feature-details/feature-details.module';\r\nimport { IgoFeatureFormModule } from './feature-form/feature-form.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule\r\n  ],\r\n  exports: [\r\n    IgoFeatureDetailsModule,\r\n    IgoFeatureFormModule\r\n  ],\r\n  declarations: [],\r\n  providers: []\r\n})\r\nexport class IgoFeatureModule {}\r\n","import OlMap from 'ol/Map';\r\nimport OlFeature from 'ol/Feature';\r\nimport * as OlStyle from 'ol/style';\r\nimport { StyleLike as OlStyleLike } from 'ol/style/Style';\r\nimport OlVectorSource from 'ol/source/Vector';\r\nimport OlVectorLayer from 'ol/layer/Vector';\r\nimport OlModify from 'ol/interaction/Modify';\r\nimport OlTranslate from 'ol/interaction/Translate';\r\nimport OlDraw from 'ol/interaction/Draw';\r\nimport OlPolygon from 'ol/geom/Polygon';\r\nimport OlLineString from 'ol/geom/LineString';\r\nimport OlCircle from 'ol/geom/Circle';\r\nimport OlLinearRing from 'ol/geom/LinearRing';\r\nimport OlInteraction from 'ol/interaction/Interaction';\r\nimport OlDragBoxInteraction from 'ol/interaction/DragBox';\r\nimport MapBrowserEvent from 'ol/MapBrowserEvent';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport BasicEvent from 'ol/events/Event';\r\nimport { ModifyEvent as OlModifyEvent } from 'ol/interaction/Modify';\r\nimport { TranslateEvent as OlTranslateEvent } from 'ol/interaction/Translate';\r\nimport { DrawEvent as OlDrawEvent } from 'ol/interaction/Draw';\r\nimport { unByKey } from 'ol/Observable';\r\n\r\nimport { Subject, Subscription, fromEvent } from 'rxjs';\r\n\r\nimport {\r\n  addLinearRingToOlPolygon,\r\n  createDrawHoleInteractionStyle,\r\n  getMousePositionFromOlGeometryEvent\r\n} from '../geometry.utils';\r\n\r\nexport interface ModifyControlOptions {\r\n  source?: OlVectorSource<any>;\r\n  layer?: OlVectorLayer<any>;\r\n  layerStyle?: OlStyleLike;\r\n  drawStyle?: OlStyleLike;\r\n  modify?: boolean;\r\n  translate?: boolean;\r\n}\r\n\r\n/**\r\n * Control to modify geometries\r\n */\r\nexport class ModifyControl {\r\n  /**\r\n   * Modify start observable\r\n   */\r\n  public start$: Subject<OlGeometry> = new Subject();\r\n\r\n  /**\r\n   * Modify end observable\r\n   */\r\n  public end$: Subject<OlGeometry> = new Subject();\r\n\r\n  /**\r\n   * Geometry changes observable\r\n   */\r\n  public changes$: Subject<OlGeometry> = new Subject();\r\n\r\n  private olMap: OlMap;\r\n  private olOverlayLayer: OlVectorLayer<any>;\r\n  public olModifyInteraction: OlModify;\r\n  private onModifyStartKey: any;\r\n  private onModifyEndKey: any;\r\n  private onModifyKey: any;\r\n  private olModifyInteractionIsActive: boolean = false;\r\n  private olTranslateInteraction: OlTranslate;\r\n  private onTranslateStartKey: any;\r\n  private onTranslateEndKey: any;\r\n  private onTranslateKey: any;\r\n  private olTranslateInteractionIsActive: boolean = false;\r\n  private olDrawInteraction: OlDraw;\r\n  private onDrawStartKey: any;\r\n  private onDrawEndKey: any;\r\n  private onDrawKey: any;\r\n  private olDrawInteractionIsActive: boolean = false;\r\n\r\n  private mousePosition: [number, number];\r\n\r\n  private keyDown$$: Subscription;\r\n  private drawKeyUp$$: Subscription;\r\n  private drawKeyDown$$: Subscription;\r\n\r\n  private removedOlInteractions: OlInteraction[] = [];\r\n  private olLinearRingsLayer: OlVectorLayer<any>;\r\n\r\n  // This is the geometry to test against when drawing holes\r\n  private olOuterGeometry: OlGeometry;\r\n\r\n  /**\r\n   * Wheter the control is active\r\n   */\r\n  get active(): boolean {\r\n    return this.olMap !== undefined;\r\n  }\r\n\r\n  /**\r\n   * OL overlay source\r\n   * @internal\r\n   */\r\n  get olOverlaySource(): OlVectorSource<any> {\r\n    return this.olOverlayLayer.getSource();\r\n  }\r\n\r\n  /**\r\n   * OL linear rings source\r\n   * @internal\r\n   */\r\n  get olLinearRingsSource(): OlVectorSource<any> {\r\n    return this.olLinearRingsLayer.getSource();\r\n  }\r\n\r\n  /**\r\n   * Whether a modify control should be available\r\n   */\r\n  private modify: boolean = true;\r\n\r\n  /**\r\n   * Whether a translate control should be available\r\n   */\r\n  private translate: boolean = true;\r\n\r\n  constructor(private options: ModifyControlOptions) {\r\n    if (options.modify !== undefined) {\r\n      this.modify = options.modify;\r\n    }\r\n    if (options.translate !== undefined) {\r\n      this.translate = options.translate;\r\n    }\r\n\r\n    if (options.layer !== undefined) {\r\n      this.olOverlayLayer = options.layer;\r\n    } else {\r\n      this.olOverlayLayer = this.createOlInnerOverlayLayer();\r\n    }\r\n    this.olLinearRingsLayer = this.createOlLinearRingsLayer();\r\n  }\r\n\r\n  /**\r\n   * Add or remove this control to/from a map.\r\n   * @param map OL Map\r\n   */\r\n  setOlMap(olMap: OlMap | undefined) {\r\n    if (olMap === undefined) {\r\n      this.clearOlInnerOverlaySource();\r\n      this.removeOlInnerOverlayLayer();\r\n      this.removeOlModifyInteraction();\r\n      this.removeOlTranslateInteraction();\r\n      this.removeOlDrawInteraction();\r\n      this.olMap = olMap;\r\n      return;\r\n    }\r\n\r\n    this.olMap = olMap;\r\n    this.addOlInnerOverlayLayer();\r\n\r\n    // The order in which these interactions\r\n    // are added is important\r\n    if (this.modify === true) {\r\n      this.addOlDrawInteraction();\r\n    }\r\n\r\n    if (this.translate === true) {\r\n      this.addOlTranslateInteraction();\r\n      this.activateTranslateInteraction();\r\n    }\r\n\r\n    if (this.modify === true) {\r\n      this.addOlModifyInteraction();\r\n      this.activateModifyInteraction();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Return the overlay source\r\n   */\r\n  getSource(): OlVectorSource<any> {\r\n    return this.olOverlaySource;\r\n  }\r\n\r\n  /**\r\n   * Add an OL geometry to the overlay and start modifying it\r\n   * @param olGeometry Ol Geometry\r\n   */\r\n  setOlGeometry(olGeometry: OlGeometry) {\r\n    const olFeature = new OlFeature({ geometry: olGeometry });\r\n    this.olOverlaySource.clear();\r\n    this.olOverlaySource.addFeature(olFeature);\r\n  }\r\n\r\n  /**\r\n   * Create an overlay source if none is defined in the options\r\n   */\r\n  private createOlInnerOverlayLayer(): OlVectorLayer<any> {\r\n    return new OlVectorLayer({\r\n      source: this.options.source ? this.options.source : new OlVectorSource(),\r\n      style: this.options.layerStyle,\r\n      zIndex: 500\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Add the overlay layer if it wasn't defined in the options\r\n   */\r\n  private addOlInnerOverlayLayer() {\r\n    if (this.options.layer === undefined) {\r\n      this.olMap.addLayer(this.olOverlayLayer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay layer if it wasn't defined in the options\r\n   */\r\n  private removeOlInnerOverlayLayer() {\r\n    if (this.options.layer === undefined && this.olMap !== undefined) {\r\n      this.olMap.removeLayer(this.olOverlayLayer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay source if it wasn't defined in the options\r\n   */\r\n  private clearOlInnerOverlaySource() {\r\n    if (this.options.layer === undefined && this.options.source === undefined) {\r\n      this.olOverlaySource.clear(true);\r\n    }\r\n  }\r\n\r\n  private createOlLinearRingsLayer(): OlVectorLayer<any> {\r\n    return new OlVectorLayer({\r\n      source: new OlVectorSource(),\r\n      style: createDrawHoleInteractionStyle(),\r\n      zIndex: 500\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Add the linear rings layer\r\n   */\r\n  private addOlLinearRingsLayer() {\r\n    this.olMap.addLayer(this.olLinearRingsLayer);\r\n  }\r\n\r\n  /**\r\n   * Clear the linear rings layer\r\n   */\r\n  private removeOlLinearRingsLayer() {\r\n    this.olMap.removeLayer(this.olLinearRingsLayer);\r\n  }\r\n\r\n  /**\r\n   * Clear the linear rings source\r\n   */\r\n  private clearOlLinearRingsSource() {\r\n    this.olLinearRingsSource.clear(true);\r\n  }\r\n\r\n  /**\r\n   * Add a modify interaction to the map an set up some listeners\r\n   */\r\n  private addOlModifyInteraction() {\r\n    const olModifyInteraction = new OlModify({\r\n      source: this.olOverlaySource,\r\n      style: this.options.drawStyle as OlStyle.Style\r\n    });\r\n    this.olModifyInteraction = olModifyInteraction;\r\n  }\r\n\r\n  /**\r\n   * Remove the modify interaction\r\n   */\r\n  private removeOlModifyInteraction() {\r\n    if (this.olModifyInteraction === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.deactivateModifyInteraction();\r\n    this.olModifyInteraction = undefined;\r\n  }\r\n\r\n  private activateModifyInteraction() {\r\n    if (this.olModifyInteractionIsActive === true) {\r\n      return;\r\n    }\r\n\r\n    this.olModifyInteractionIsActive = true;\r\n    this.onModifyStartKey = this.olModifyInteraction.on(\r\n      'modifystart',\r\n      (event: OlModifyEvent) => this.onModifyStart(event)\r\n    );\r\n    this.onModifyEndKey = this.olModifyInteraction.on(\r\n      'modifyend',\r\n      (event: OlModifyEvent) => this.onModifyEnd(event)\r\n    );\r\n    this.olMap.addInteraction(this.olModifyInteraction);\r\n  }\r\n\r\n  private deactivateModifyInteraction() {\r\n    if (this.olModifyInteractionIsActive === false) {\r\n      return;\r\n    }\r\n\r\n    this.olModifyInteractionIsActive = false;\r\n\r\n    unByKey([this.onModifyStartKey, this.onModifyEndKey, this.onModifyKey]);\r\n    if (this.olMap !== undefined) {\r\n      this.olMap.removeInteraction(this.olModifyInteraction);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * When modifying starts, clear the overlay and start watching for changes\r\n   * @param event Modify start event\r\n   */\r\n  private onModifyStart(event: OlModifyEvent) {\r\n    const olGeometry = event.features.item(0).getGeometry() as OlGeometry;\r\n    this.start$.next(olGeometry);\r\n    this.onModifyKey = olGeometry.on(\r\n      'change',\r\n      (olGeometryEvent: BasicEvent) => {\r\n        this.mousePosition = getMousePositionFromOlGeometryEvent(\r\n          olGeometryEvent\r\n        );\r\n        this.changes$.next(olGeometryEvent.target as OlLineString | OlCircle | OlPolygon);\r\n      }\r\n    );\r\n    this.subscribeToKeyDown();\r\n  }\r\n\r\n  /**\r\n   * When modifying ends, update the geometry observable and stop watching for changes\r\n   * @param event Modify end event\r\n   */\r\n  private onModifyEnd(event: OlModifyEvent) {\r\n    unByKey(this.onModifyKey);\r\n    this.end$.next(event.features.item(0).getGeometry() as OlGeometry);\r\n    this.unsubscribeToKeyDown();\r\n  }\r\n\r\n  /**\r\n   * Subscribe to space key down to pan the map\r\n   */\r\n  private subscribeToKeyDown() {\r\n    this.keyDown$$ = fromEvent(document, 'keydown').subscribe(\r\n      (event: KeyboardEvent) => {\r\n        if (event.key === ' ') {\r\n          // On space bar, pan to the current mouse position\r\n          this.olMap.getView().animate({\r\n            center: this.mousePosition,\r\n            duration: 0\r\n          });\r\n          return;\r\n        }\r\n      }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to key down\r\n   */\r\n  private unsubscribeToKeyDown() {\r\n    if (this.keyDown$$ !== undefined) {\r\n      this.keyDown$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add a translate interaction to the map an set up some listeners\r\n   */\r\n  private addOlTranslateInteraction() {\r\n    const olTranslateInteraction = new OlTranslate({\r\n      layers: [this.olOverlayLayer]\r\n    });\r\n    this.olTranslateInteraction = olTranslateInteraction;\r\n  }\r\n\r\n  /**\r\n   * Remove the translate interaction\r\n   */\r\n  private removeOlTranslateInteraction() {\r\n    if (this.olTranslateInteraction === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.deactivateTranslateInteraction();\r\n    this.olTranslateInteraction = undefined;\r\n  }\r\n\r\n  private activateTranslateInteraction() {\r\n    if (this.olTranslateInteractionIsActive === true) {\r\n      return;\r\n    }\r\n\r\n    this.olTranslateInteractionIsActive = true;\r\n    this.onTranslateStartKey = this.olTranslateInteraction.on(\r\n      'translatestart',\r\n      (event: OlTranslateEvent) => this.onTranslateStart(event)\r\n    );\r\n    this.onTranslateEndKey = this.olTranslateInteraction.on(\r\n      'translateend',\r\n      (event: OlTranslateEvent) => this.onTranslateEnd(event)\r\n    );\r\n    this.olMap.addInteraction(this.olTranslateInteraction);\r\n  }\r\n\r\n  private deactivateTranslateInteraction() {\r\n    if (this.olTranslateInteractionIsActive === false) {\r\n      return;\r\n    }\r\n\r\n    this.olTranslateInteractionIsActive = false;\r\n    unByKey([\r\n      this.onTranslateStartKey,\r\n      this.onTranslateEndKey,\r\n      this.onTranslateKey\r\n    ]);\r\n    if (this.olMap !== undefined) {\r\n      this.olMap.removeInteraction(this.olTranslateInteraction);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * When translation starts, clear the overlay and start watching for changes\r\n   * @param event Translate start event\r\n   */\r\n  private onTranslateStart(event: OlTranslateEvent) {\r\n    const olGeometry = event.features.item(0).getGeometry() as OlGeometry;\r\n    this.start$.next(olGeometry);\r\n    this.onTranslateKey = olGeometry.on(\r\n      'change',\r\n      (olGeometryEvent: BasicEvent) => {\r\n        // this.changes$.next(olGeometryEvent.target);\r\n      }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * When translation ends, update the geometry observable and stop watchign for changes\r\n   * @param event Translate end event\r\n   */\r\n  private onTranslateEnd(event: OlTranslateEvent) {\r\n    unByKey(this.onTranslateKey);\r\n    this.end$.next(event.features.item(0).getGeometry() as OlGeometry);\r\n  }\r\n\r\n  /**\r\n   * Add a draw interaction to the map an set up some listeners\r\n   */\r\n  private addOlDrawInteraction() {\r\n    const olDrawInteraction = new OlDraw({\r\n      type: 'Polygon',\r\n      source: this.olLinearRingsSource,\r\n      stopClick: true,\r\n      style: createDrawHoleInteractionStyle(),\r\n      condition: (event: MapBrowserEvent<any>) => {\r\n        const olOuterGeometry = this.olOuterGeometry || this.getOlGeometry();\r\n        const intersects = olOuterGeometry.intersectsCoordinate(\r\n          event.coordinate\r\n        );\r\n        return intersects;\r\n      }\r\n    });\r\n\r\n    this.olDrawInteraction = olDrawInteraction;\r\n    this.subscribeToDrawKeyDown();\r\n  }\r\n\r\n  /**\r\n   * Subscribe to CTRL key down to activate the draw control\r\n   */\r\n  private subscribeToDrawKeyDown() {\r\n    this.drawKeyDown$$ = fromEvent(document, 'keydown').subscribe(\r\n      (event: KeyboardEvent) => {\r\n        if (event.key !== 'Control') {\r\n          return;\r\n        }\r\n\r\n        this.unsubscribeToDrawKeyDown();\r\n\r\n        const olGeometry = this.getOlGeometry();\r\n        if (!olGeometry || !(olGeometry instanceof OlPolygon)) {\r\n          return;\r\n        }\r\n\r\n        this.subscribeToDrawKeyUp();\r\n\r\n        this.deactivateModifyInteraction();\r\n        this.deactivateTranslateInteraction();\r\n        this.activateDrawInteraction();\r\n      }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Subscribe to CTRL key up to deactivate the draw control\r\n   */\r\n  private subscribeToDrawKeyUp() {\r\n    this.drawKeyUp$$ = fromEvent(document, 'keyup').subscribe(\r\n      (event: KeyboardEvent) => {\r\n        if (event.key !== 'Control') {\r\n          return;\r\n        }\r\n\r\n        this.unsubscribeToDrawKeyUp();\r\n        this.unsubscribeToKeyDown();\r\n        this.deactivateDrawInteraction();\r\n\r\n        this.activateModifyInteraction();\r\n        if (this.translate === true) {\r\n          this.activateTranslateInteraction();\r\n        }\r\n        this.subscribeToDrawKeyDown();\r\n\r\n        this.olOuterGeometry = undefined;\r\n        this.clearOlLinearRingsSource();\r\n        this.end$.next(this.getOlGeometry());\r\n      }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to draw key down\r\n   */\r\n  private unsubscribeToDrawKeyDown() {\r\n    if (this.drawKeyDown$$ !== undefined) {\r\n      this.drawKeyDown$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to key up\r\n   */\r\n  private unsubscribeToDrawKeyUp() {\r\n    if (this.drawKeyUp$$ !== undefined) {\r\n      this.drawKeyUp$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove the draw interaction\r\n   */\r\n  private removeOlDrawInteraction() {\r\n    if (this.olDrawInteraction === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.unsubscribeToKeyDown();\r\n    this.unsubscribeToDrawKeyUp();\r\n    this.unsubscribeToDrawKeyDown();\r\n    this.deactivateDrawInteraction();\r\n    this.clearOlLinearRingsSource();\r\n    this.olDrawInteraction = undefined;\r\n  }\r\n\r\n  /**\r\n   * Activate the draw interaction\r\n   */\r\n  private activateDrawInteraction() {\r\n    if (this.olDrawInteractionIsActive === true) {\r\n      return;\r\n    }\r\n\r\n    this.clearOlLinearRingsSource();\r\n    this.addOlLinearRingsLayer();\r\n\r\n    this.olMap.getInteractions().forEach((olInteraction: OlInteraction) => {\r\n      if (olInteraction instanceof OlDragBoxInteraction) {\r\n        this.olMap.removeInteraction(olInteraction);\r\n        this.removedOlInteractions.push(olInteraction);\r\n      }\r\n    });\r\n\r\n    this.olDrawInteractionIsActive = true;\r\n    this.onDrawStartKey = this.olDrawInteraction.on(\r\n      'drawstart',\r\n      (event: OlDrawEvent) => this.onDrawStart(event)\r\n    );\r\n    this.onDrawEndKey = this.olDrawInteraction.on(\r\n      'drawend',\r\n      (event: OlDrawEvent) => this.onDrawEnd(event)\r\n    );\r\n    this.olMap.addInteraction(this.olDrawInteraction);\r\n  }\r\n\r\n  /**\r\n   * Deactivate the draw interaction\r\n   */\r\n  private deactivateDrawInteraction() {\r\n    if (this.olDrawInteractionIsActive === false) {\r\n      return;\r\n    }\r\n\r\n    this.removeOlLinearRingsLayer();\r\n\r\n    this.removedOlInteractions.forEach((olInteraction: OlInteraction) => {\r\n      this.olMap.addInteraction(olInteraction);\r\n    });\r\n    this.removedOlInteractions = [];\r\n\r\n    this.olDrawInteractionIsActive = false;\r\n    unByKey([this.onDrawStartKey, this.onDrawEndKey, this.onDrawKey]);\r\n    if (this.olMap !== undefined) {\r\n      this.olMap.removeInteraction(this.olDrawInteraction);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * When draw start, add a new linerar ring to the geometry and start watching for changes\r\n   * @param event Draw start event\r\n   */\r\n  private onDrawStart(event: OlDrawEvent) {\r\n    const olGeometry = event.feature.getGeometry();\r\n    this.olOuterGeometry = this.getOlGeometry().clone();\r\n\r\n    const linearRingCoordinates = ((olGeometry as any).getLinearRing() as any).getCoordinates();\r\n    this.addLinearRingToOlGeometry(linearRingCoordinates);\r\n    this.start$.next(this.getOlGeometry());\r\n\r\n    this.onDrawKey = olGeometry.on(\r\n      'change',\r\n      (olGeometryEvent: BasicEvent) => {\r\n        this.mousePosition = getMousePositionFromOlGeometryEvent(\r\n          olGeometryEvent\r\n        );\r\n        const olGeometryTarget = olGeometryEvent.target as OlPolygon;\r\n        const _linearRingCoordinates = olGeometryTarget\r\n          .getLinearRing(0)\r\n          .getCoordinates();\r\n        this.updateLinearRingOfOlGeometry(_linearRingCoordinates);\r\n        this.changes$.next(this.getOlGeometry());\r\n      }\r\n    );\r\n    this.subscribeToKeyDown();\r\n  }\r\n\r\n  /**\r\n   * When translation ends, update the geometry observable and stop watchign for changes\r\n   * @param event Draw end event\r\n   */\r\n  private onDrawEnd(event: OlDrawEvent) {\r\n    unByKey(this.onDrawKey);\r\n    this.olOuterGeometry = undefined;\r\n\r\n    const linearRingCoordinates = ((event.feature\r\n      .getGeometry() as any)\r\n      .getLinearRing() as any)\r\n      .getCoordinates();\r\n    this.updateLinearRingOfOlGeometry(linearRingCoordinates);\r\n    this.clearOlLinearRingsSource();\r\n    this.end$.next(this.getOlGeometry());\r\n    this.unsubscribeToKeyDown();\r\n  }\r\n\r\n  /**\r\n   * Add a linear ring to the geometry being modified\r\n   * @param coordinates Linear ring coordinates\r\n   */\r\n  private addLinearRingToOlGeometry(coordinates: number[]) {\r\n    const olGeometry = this.getOlGeometry() as OlPolygon;\r\n    const olLinearRing = new OlLinearRing(coordinates);\r\n    addLinearRingToOlPolygon(olGeometry, olLinearRing);\r\n  }\r\n\r\n  /**\r\n   * Update the last linear ring of the geometry being modified\r\n   * @param coordinates Linear ring coordinates\r\n   */\r\n  private updateLinearRingOfOlGeometry(coordinates: number[][]) {\r\n    const olGeometry = this.getOlGeometry() as OlPolygon;\r\n    // Remove the last linear ring (the one we are updating)\r\n    const olLinearRings = olGeometry.getLinearRings().slice(0, -1);\r\n    const newCoordinates = olLinearRings.map((olLinearRing: OlLinearRing) => {\r\n      return olLinearRing.getCoordinates();\r\n    });\r\n    newCoordinates.push(coordinates);\r\n    olGeometry.setCoordinates(newCoordinates);\r\n  }\r\n\r\n  /**\r\n   * Get the geometry being modified\r\n   * @returns OL Geometry\r\n   */\r\n  private getOlGeometry(): OlGeometry {\r\n    const olFeatures = this.olOverlaySource.getFeatures();\r\n    return olFeatures.length > 0 ? olFeatures[0].getGeometry() : undefined;\r\n  }\r\n}\r\n","export const LAYER = 'Layer';\r\n","<h3 mat-dialog-title>{{'igo.geo.measure.dialog.title' | translate}}</h3>\r\n\r\n<table *ngIf=\"data.length > 0\"\r\n  class=\"mat-typography\">\r\n  <thead>\r\n    <tr>\r\n      <th colspan=\"2\">{{'igo.geo.measure.dialog.length.title' | translate}}</th>\r\n    </tr>\r\n  </thead>\r\n  <tbody>\r\n    <tr>\r\n      <td>{{data.length | measureFormat: measureLengthUnit.Meters}}</td>\r\n      <td>{{'igo.geo.measure.dialog.lengthInMeters' | translate}}</td>\r\n    </tr>\r\n    <tr>\r\n      <td>{{data.length | measureFormat: measureLengthUnit.Kilometers}}</td>\r\n      <td>{{'igo.geo.measure.dialog.lengthInKilometers' | translate}}</td>\r\n    </tr>\r\n    <tr>\r\n      <td>{{data.length | measureFormat: measureLengthUnit.Miles}}</td>\r\n      <td>{{'igo.geo.measure.dialog.lengthInMiles' | translate}}</td>\r\n    </tr>\r\n    <tr>\r\n      <td>{{data.length | measureFormat: measureLengthUnit.Feet}}</td>\r\n      <td>{{'igo.geo.measure.dialog.lengthInFeet' | translate}}</td>\r\n    </tr>\r\n  </tbody>\r\n</table>\r\n\r\n<table *ngIf=\"data.area > 0\"\r\n  class=\"mat-typography\">\r\n  <thead>\r\n    <tr>\r\n      <th colspan=\"2\">{{'igo.geo.measure.dialog.area.title' | translate}}</th>\r\n    </tr>\r\n  </thead>\r\n  <tbody>\r\n    <tr>\r\n      <td>{{data.area | measureFormat: measureAreaUnit.SquareMeters}}</td>\r\n      <td>{{'igo.geo.measure.dialog.areaInSquareMeters' | translate}}</td>\r\n    </tr>\r\n    <tr>\r\n      <td>{{data.area | measureFormat:measureAreaUnit.SquareKilometers}}</td>\r\n      <td>{{'igo.geo.measure.dialog.areaInSquareKilometers' | translate}}</td>\r\n    </tr>\r\n    <tr>\r\n      <td>{{data.area | measureFormat: measureAreaUnit.SquareMiles}}</td>\r\n      <td>{{'igo.geo.measure.dialog.areaInSquareMiles' | translate}}</td>\r\n    </tr>\r\n    <tr>\r\n      <td>{{data.area | measureFormat: measureAreaUnit.Acres}}</td>\r\n      <td>{{'igo.geo.measure.dialog.areaInAcres' | translate}}</td>\r\n    </tr>\r\n    <tr>\r\n      <td>{{data.area | measureFormat: measureAreaUnit.Hectares}}</td>\r\n      <td>{{'igo.geo.measure.dialog.areaInHectares' | translate}}</td>\r\n    </tr>\r\n    <tr>\r\n      <td>{{'igo.geo.measure.dialog.perimeterInMeters' | translate}}</td>\r\n      <td>{{data.perimeter | measureFormat: measureLengthUnit.Meters}}</td>\r\n    </tr>\r\n  </tbody>\r\n</table>\r\n","import { Component, Inject } from '@angular/core';\r\nimport { MatDialogRef, MAT_DIALOG_DATA } from '@angular/material/dialog';\r\n\r\nimport { MeasurerDialogData } from '../shared/measure.interfaces';\r\n\r\nimport { MeasureAreaUnit, MeasureLengthUnit} from '../shared/measure.enum';\r\n\r\n@Component({\r\n  selector: 'igo-measurer-dialog',\r\n  templateUrl: 'measurer-dialog.component.html',\r\n  styleUrls: ['./measurer-dialog.component.scss']\r\n})\r\nexport class MeasurerDialogComponent {\r\n\r\n  measureAreaUnit = MeasureAreaUnit;\r\n\r\n  measureLengthUnit = MeasureLengthUnit;\r\n\r\n  constructor(\r\n    public dialogRef: MatDialogRef<MeasurerDialogComponent>,\r\n    @Inject(MAT_DIALOG_DATA) public data: MeasurerDialogData\r\n  ) {}\r\n\r\n  onNoClick(): void {\r\n    this.dialogRef.close();\r\n  }\r\n\r\n}\r\n","<div>\r\n  <div class=\"measure-type-toggle mat-typography\">\r\n    <mat-button-toggle-group\r\n      [value]=\"activeMeasureType\"\r\n      (change)=\"onMeasureTypeChange($event.value)\">\r\n      <mat-button-toggle [value]=\"measureType.Length\">\r\n        {{('igo.geo.measure.' + measureType.Length) | translate}}\r\n      </mat-button-toggle>\r\n      <mat-button-toggle [value]=\"measureType.Area\">\r\n        {{('igo.geo.measure.' + measureType.Area) | translate}}\r\n      </mat-button-toggle>\r\n    </mat-button-toggle-group>\r\n  </div>\r\n\r\n  <div class=\"measure-options mat-typography\">\r\n    <mat-slide-toggle\r\n      [disabled]=\"drawControlIsDisabled\"\r\n      [checked]=\"drawControlIsActive\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onToggleDrawControl($event.checked)\">\r\n      {{'igo.geo.measure.toggleActive' | translate}}\r\n    </mat-slide-toggle>\r\n\r\n    <mat-divider *ngIf=\"(hasLine$ | async)\"></mat-divider>\r\n\r\n    <mat-slide-toggle *ngIf=\"(hasLine$ | async)\"\r\n      [checked]=\"displayLines\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onToggleDisplayLines($event.checked)\">\r\n      {{'igo.geo.measure.toggleDisplayLines' | translate}}\r\n    </mat-slide-toggle>\r\n\r\n    <mat-divider *ngIf=\"(hasLine$ | async) || (hasArea$ | async)\"></mat-divider>\r\n\r\n    <mat-slide-toggle *ngIf=\"(hasArea$ | async)\"\r\n      [checked]=\"displayDistance\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onToggleDisplayDistance($event.checked)\">\r\n      {{'igo.geo.measure.toggleDisplayDistance' | translate}}\r\n    </mat-slide-toggle>\r\n\r\n    <mat-slide-toggle *ngIf=\"(hasArea$ | async)\"\r\n      [checked]=\"displayAreas\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onToggleDisplayAreas($event.checked)\">\r\n      {{'igo.geo.measure.toggleDisplayAreas' | translate}}\r\n    </mat-slide-toggle>\r\n\r\n    <mat-divider *ngIf=\"(hasArea$ | async)\"></mat-divider>\r\n\r\n    <mat-slide-toggle\r\n      [checked]=\"measureUnitsAuto\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onToggleMeasureUnitsAuto($event.checked)\">\r\n      {{'igo.geo.measure.toggleAutoUnits' | translate}}\r\n    </mat-slide-toggle>\r\n  </div>\r\n\r\n  <ng-container *ngIf=\"measure$ | async as measure\">\r\n    <igo-measurer-item *ngIf=\"activeMeasureType === measureType.Length || activeMeasureType === measureType.Area\"\r\n      [measureType]=\"measureType.Length\"\r\n      [measureUnit]=\"measureLengthUnit.Meters\"\r\n      [measure]=\"measure.length\"\r\n      [auto]=\"measureUnitsAuto\"\r\n      [placeholder]=\"(activeMeasureType === measureType.Area ? 'igo.geo.measure.perimeter' : 'igo.geo.measure.length') | translate\"\r\n      (measureUnitChange)=\"onLengthUnitChange($event)\">\r\n    </igo-measurer-item>\r\n\r\n    <igo-measurer-item *ngIf=\"activeMeasureType === measureType.Area\"\r\n      [measureType]=\"measureType.Area\"\r\n      [measureUnit]=\"measureAreaUnit.SquareMeters\"\r\n      [measure]=\"measure.area\"\r\n      [auto]=\"measureUnitsAuto\"\r\n      [placeholder]=\"'igo.geo.measure.area' | translate\"\r\n      (measureUnitChange)=\"onAreaUnitChange($event)\">\r\n    </igo-measurer-item>\r\n  </ng-container>\r\n\r\n  <mat-divider *ngIf=\"(hasLine$ | async) || (hasArea$ | async)\"></mat-divider>\r\n\r\n  <div class=\"measure-store-buttons\">\r\n    <button *ngIf=\"(hasLine$ | async) || (hasArea$ | async)\"\r\n      mat-icon-button\r\n      [matTooltip]=\"'igo.geo.measure.actionbar.calculate.tooltip' | translate\"\r\n      [disabled]=\"(selectedFeatures$ | async).length === 0\"\r\n      color=\"accent\"\r\n      (click)=\"onCalculateClick()\">\r\n      <mat-icon svgIcon=\"calculator\"></mat-icon>\r\n    </button>\r\n\r\n    <button *ngIf=\"(hasLine$ | async) || (hasArea$ | async)\"\r\n      mat-icon-button\r\n      [matTooltip]=\"'igo.geo.measure.actionbar.delete.tooltip' | translate\"\r\n      [disabled]=\"(selectedFeatures$ | async).length === 0\"\r\n      color=\"warn\"\r\n      (click)=\"onDeleteClick()\">\r\n      <mat-icon svgIcon=\"delete\"></mat-icon>\r\n    </button>\r\n\r\n    <!--button\r\n      mat-icon-button\r\n      [matTooltip]=\"'igo.geo.measure.actionbar.modify.tooltip' | translate\"\r\n      [disabled]=\"(selectedFeatures$ | async).length !== 1\"\r\n      (click)=\"onModifyClick()\">\r\n      <mat-icon svgIcon=\"edit\"></mat-icon>\r\n    </button-->\r\n  </div>\r\n\r\n  <igo-entity-table\r\n    #table\r\n    class=\"table-compact\"\r\n    [store]=\"store\"\r\n    [template]=\"tableTemplate\">\r\n  </igo-entity-table>\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy,\r\n  ViewChild\r\n} from '@angular/core';\r\nimport { MatDialog } from '@angular/material/dialog';\r\n\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport { skip } from 'rxjs/operators';\r\n\r\nimport OlStyle from 'ol/style/Style';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport OlVectorSource from 'ol/source/Vector';\r\nimport { VectorSourceEvent as OlVectorSourceEvent } from 'ol/source/Vector';\r\nimport OlLineString from 'ol/geom/LineString';\r\nimport OlPolygon from 'ol/geom/Polygon';\r\nimport OlFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport OlOverlay from 'ol/Overlay';\r\nimport { unByKey } from 'ol/Observable';\r\n\r\nimport { LanguageService, StorageScope, StorageService } from '@igo2/core';\r\nimport { EntityRecord, EntityTableTemplate } from '@igo2/common';\r\nimport type { EntityTableComponent } from '@igo2/common';\r\nimport { uuid } from '@igo2/utils';\r\n\r\nimport { FeatureDataSource } from '../../datasource';\r\nimport {\r\n  FEATURE,\r\n  FeatureStore,\r\n  FeatureStoreLoadingStrategy,\r\n  FeatureStoreSelectionStrategy,\r\n  tryBindStoreLayer,\r\n  tryAddLoadingStrategy,\r\n  tryAddSelectionStrategy\r\n} from '../../feature';\r\nimport { DrawControl, ModifyControl } from '../../geometry/shared';\r\nimport { VectorLayer } from '../../layer';\r\nimport { IgoMap } from '../../map';\r\n\r\nimport { Measure, MeasurerDialogData, FeatureWithMeasure } from '../shared/measure.interfaces';\r\nimport {\r\n  MeasureType,\r\n  MeasureAreaUnit,\r\n  MeasureLengthUnit,\r\n} from '../shared/measure.enum';\r\nimport {\r\n  measureOlGeometry,\r\n  createMeasureInteractionStyle,\r\n  createMeasureLayerStyle,\r\n  updateOlTooltipsAtMidpoints,\r\n  updateOlTooltipAtCenter,\r\n  getTooltipsOfOlGeometry,\r\n  squareMetersToUnit,\r\n  metersToUnit,\r\n  formatMeasure\r\n} from '../shared/measure.utils';\r\nimport { MeasurerDialogComponent } from './measurer-dialog.component';\r\n\r\n/**\r\n * Tool to measure lengths and areas\r\n */\r\n@Component({\r\n  selector: 'igo-measurer',\r\n  templateUrl: './measurer.component.html',\r\n  styleUrls: ['./measurer.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class MeasurerComponent implements OnInit, OnDestroy {\r\n\r\n  /**\r\n   * Table template\r\n   * @internal\r\n   */\r\n  public tableTemplate: EntityTableTemplate = {\r\n    selection: true,\r\n    selectMany: true,\r\n    selectionCheckbox: true,\r\n    sort: true,\r\n    columns: [\r\n      {\r\n        name: 'length',\r\n        title: this.languageService.translate.instant('igo.geo.measure.lengthHeader'),\r\n        valueAccessor: (localFeature: FeatureWithMeasure) => {\r\n          const unit = this.activeLengthUnit;\r\n          const measure = metersToUnit(localFeature.properties.measure.length, unit);\r\n          return formatMeasure(measure, {\r\n            decimal: 1,\r\n            unit,\r\n            unitAbbr: false,\r\n            locale: 'fr'\r\n          });\r\n        }\r\n      },\r\n      {\r\n        name: 'area',\r\n        title: this.languageService.translate.instant('igo.geo.measure.areaHeader'),\r\n        valueAccessor: (localFeature: FeatureWithMeasure) => {\r\n          const unit = this.activeAreaUnit;\r\n          const measure = squareMetersToUnit(localFeature.properties.measure.area, unit);\r\n          return measure ? formatMeasure(measure, {\r\n            decimal: 1,\r\n            unit,\r\n            unitAbbr: false,\r\n            locale: 'fr'\r\n          }) : '';\r\n        }\r\n      }\r\n    ]\r\n  };\r\n\r\n  private subscriptions$$: Subscription[] = [];\r\n\r\n  /**\r\n   * Reference to the MeasureType enum\r\n   * @internal\r\n   */\r\n  public measureType = MeasureType;\r\n\r\n  /**\r\n   * Reference to the AreaMeasureUnit enum\r\n   * @internal\r\n   */\r\n  public measureAreaUnit = MeasureAreaUnit;\r\n\r\n  /**\r\n   * Reference to the LengthMeasureUnit enum\r\n   * @internal\r\n   */\r\n  public measureLengthUnit = MeasureLengthUnit;\r\n\r\n  /**\r\n   * Whether measure units should be automatically determined\r\n   * @internal\r\n   */\r\n  public measureUnitsAuto: boolean = false;\r\n\r\n  /**\r\n   * Whether display of distances of areas\r\n   * @internal\r\n   */\r\n  public displayDistance: boolean = true;\r\n\r\n  /**\r\n   * Whether display of distances of lines\r\n   * @internal\r\n   */\r\n  public displayLines: boolean = true;\r\n\r\n  /**\r\n   * Whether display of areas\r\n   * @internal\r\n   */\r\n  public displayAreas: boolean = true;\r\n\r\n  /**\r\n   * Observable of line boolean\r\n   * @internal\r\n   */\r\n   public hasLine$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  /**\r\n   * Observable of area boolean\r\n   * @internal\r\n   */\r\n  public hasArea$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  /**\r\n   * Observable of area\r\n   * @internal\r\n   */\r\n  public measure$: BehaviorSubject<Measure> = new BehaviorSubject({});\r\n\r\n  /**\r\n   * Observable of selected features\r\n   * @internal\r\n   */\r\n  public selectedFeatures$: BehaviorSubject<FeatureWithMeasure[]> = new BehaviorSubject([]);\r\n\r\n  /**\r\n   * OL draw source\r\n   * @internal\r\n   */\r\n  public showTooltips: boolean = true;\r\n\r\n  /**\r\n   * Whether draw control toggle is disabled or not\r\n   * @internal\r\n   */\r\n  public drawControlIsDisabled: boolean = true;\r\n\r\n  /**\r\n   * Draw line control\r\n   */\r\n  private drawLineControl: DrawControl;\r\n\r\n  /**\r\n   * Draw polygon control\r\n   */\r\n  private drawPolygonControl: DrawControl;\r\n\r\n  /**\r\n   * Modify control\r\n   */\r\n  private modifyControl: ModifyControl;\r\n\r\n  /**\r\n   * Active OL geometry\r\n   */\r\n  private activeOlGeometry: OlLineString | OlPolygon;\r\n\r\n  /**\r\n   * Active mlength unit\r\n   */\r\n  private activeLengthUnit: MeasureLengthUnit = MeasureLengthUnit.Meters;\r\n\r\n  /**\r\n   * Active area unit\r\n   */\r\n  private activeAreaUnit: MeasureAreaUnit = MeasureAreaUnit.SquareMeters;\r\n\r\n  /**\r\n   * Feature added listener key\r\n   */\r\n  private onFeatureAddedKey;\r\n\r\n  /**\r\n   * Feature removed listener key\r\n   */\r\n  private onFeatureRemovedKey;\r\n\r\n  /**\r\n   * Active draw control\r\n   * @internal\r\n   */\r\n  private activeDrawControl: DrawControl;\r\n\r\n  /**\r\n   * Subscription to draw start\r\n   */\r\n  private drawStart$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to draw end\r\n   */\r\n  private drawEnd$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to controls changes\r\n   */\r\n  private drawChanges$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to modify start\r\n   */\r\n  private modifyStart$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to modify end\r\n   */\r\n  private modifyEnd$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to controls changes\r\n   */\r\n  private modifyChanges$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to measures selection\r\n   */\r\n  private selectedFeatures$$: Subscription;\r\n\r\n  /**\r\n   * OL draw source\r\n   */\r\n  private olDrawSource = new OlVectorSource();\r\n\r\n  /**\r\n   * The map to measure on\r\n   */\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * The measures store\r\n   */\r\n  @Input() store: FeatureStore<FeatureWithMeasure>;\r\n\r\n  /**\r\n   * Measure type\r\n   * @internal\r\n   */\r\n  @Input()\r\n  set activeMeasureType(value: MeasureType) { this.setActiveMeasureType(value); }\r\n  get activeMeasureType(): MeasureType { return this._activeMeasureType; }\r\n  private _activeMeasureType: MeasureType;\r\n\r\n  /**\r\n   * The minimum length a segment must have to display a tooltip.\r\n   * It also applies to area tooltips.\r\n   */\r\n  @Input() minSegmentLength: number = 10;\r\n\r\n  @ViewChild('table', { static: true }) table: EntityTableComponent;\r\n\r\n  /**\r\n   * Wheter one of the draw control is active\r\n   * @internal\r\n   */\r\n  get drawControlIsActive(): boolean {\r\n    return this.activeDrawControl !== undefined;\r\n  }\r\n\r\n  get projection(): string {\r\n    return this.map.ol.getView().getProjection().getCode();\r\n  }\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dialog: MatDialog,\r\n    private storageService: StorageService\r\n  ) {}\r\n\r\n  /**\r\n   * Add draw controls and activate one\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.initStore();\r\n    this.createDrawLineControl();\r\n    this.createDrawPolygonControl();\r\n    this.createModifyControl();\r\n    this.toggleDrawControl();\r\n    this.updateTooltipsOfOlSource(this.store.source.ol);\r\n    this.checkDistanceAreaToggle();\r\n    this.setActiveMeasureType(MeasureType.Length);\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay layer and any interaction added by this component.\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.setActiveMeasureType(undefined);\r\n    this.deactivateModifyControl();\r\n    this.freezeStore();\r\n    this.subscriptions$$.map(s => s.unsubscribe());\r\n  }\r\n\r\n  /**\r\n   * Set the measure type\r\n   * @internal\r\n   */\r\n  onMeasureTypeChange(measureType: MeasureType) {\r\n    this.activeMeasureType = measureType;\r\n  }\r\n\r\n  /**\r\n   * Activate or deactivate the current draw control\r\n   * @internal\r\n   */\r\n  onToggleDrawControl(toggle: boolean) {\r\n    if (toggle === true) {\r\n      this.toggleDrawControl();\r\n    } else {\r\n      this.deactivateDrawControl();\r\n    }\r\n  }\r\n\r\n\r\n  /**\r\n   * Activate or deactivate the current draw control\r\n   * @internal\r\n   */\r\n   onToggleMeasureUnitsAuto(toggle: boolean) {\r\n    this.measureUnitsAuto = toggle;\r\n  }\r\n\r\n  /**\r\n   * Activate or deactivate the current display of distances of the areas\r\n   * @internal\r\n   */\r\n  onToggleDisplayDistance(toggle: boolean) {\r\n    this.displayDistance = toggle;\r\n    this.onDisplayDistance();\r\n    toggle ? (this.storageService.set('distanceToggle', true, StorageScope.SESSION)) :\r\n     (this.storageService.set('distanceToggle', false, StorageScope.SESSION));\r\n  }\r\n\r\n  /**\r\n   * Activate or deactivate the current display of distances of the lines\r\n   * @internal\r\n   */\r\n  onToggleDisplayLines(toggle: boolean) {\r\n    this.displayLines = toggle;\r\n    this.onDisplayLines();\r\n    toggle ? (this.storageService.set('linesToggle', true, StorageScope.SESSION)) :\r\n     (this.storageService.set('linesToggle', false, StorageScope.SESSION));\r\n  }\r\n\r\n  /**\r\n   * Activate or deactivate the current display of areas\r\n   * @internal\r\n   */\r\n  onToggleDisplayAreas(toggle: boolean) {\r\n    this.displayAreas = toggle;\r\n    this.onDisplayAreas();\r\n    toggle ? (this.storageService.set('areasToggle', true, StorageScope.SESSION)) :\r\n     (this.storageService.set('areasToggle', false, StorageScope.SESSION));\r\n  }\r\n\r\n  /**\r\n   * Set display parametres in current values\r\n   * @internal\r\n   */\r\n  checkDistanceAreaToggle(){\r\n    if (this.storageService.get('distanceToggle') === false){\r\n      this.displayDistance = false;\r\n    }\r\n    if (this.storageService.get('linesToggle') === false){\r\n      this.displayLines = false;\r\n    }\r\n    if (this.storageService.get('areasToggle') === false){\r\n      this.displayAreas = false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Activate or deactivate the current display of distances of areas\r\n   * @internal\r\n   */\r\n  onDisplayDistance() {\r\n    if (this.displayDistance) {\r\n      Array.from(document.getElementsByClassName('igo-map-tooltip-measure-polygone-segments')).map((value: Element) =>\r\n        value.classList.remove('igo-map-tooltip-hidden'));\r\n    } else {\r\n      Array.from(document.getElementsByClassName('igo-map-tooltip-measure-polygone-segments')).map((value: Element) =>\r\n        value.classList.add('igo-map-tooltip-hidden'));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Activate or deactivate the current display of distances of lines\r\n   * @internal\r\n   */\r\n  onDisplayLines() {\r\n    if (this.displayLines) {\r\n      Array.from(document.getElementsByClassName('igo-map-tooltip-measure-line-segments')).map((value: Element) =>\r\n        value.classList.remove('igo-map-tooltip-hidden'));\r\n    } else {\r\n      Array.from(document.getElementsByClassName('igo-map-tooltip-measure-line-segments')).map((value: Element) =>\r\n        value.classList.add('igo-map-tooltip-hidden'));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Activate or deactivate the current display of areas\r\n   * @internal\r\n   */\r\n  onDisplayAreas() {\r\n    if (this.displayAreas) {\r\n      Array.from(document.getElementsByClassName('igo-map-tooltip-measure-area')).map((value: Element) =>\r\n        value.classList.remove('igo-map-tooltip-hidden'));\r\n    } else {\r\n      Array.from(document.getElementsByClassName('igo-map-tooltip-measure-area')).map((value: Element) =>\r\n        value.classList.add('igo-map-tooltip-hidden'));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set the measure type\r\n   * @internal\r\n   */\r\n  onLengthUnitChange(unit: MeasureLengthUnit) {\r\n    this.activeLengthUnit = unit;\r\n    this.table.refresh();\r\n    this.updateTooltipsOfOlSource(this.store.source.ol);\r\n    if (this.activeOlGeometry !== undefined) {\r\n      this.updateTooltipsOfOlGeometry(this.activeOlGeometry);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set the measure type\r\n   * @internal\r\n   */\r\n  onAreaUnitChange(unit: MeasureAreaUnit) {\r\n    this.activeAreaUnit = unit;\r\n    this.table.refresh();\r\n    this.updateTooltipsOfOlSource(this.store.source.ol);\r\n    if (this.activeOlGeometry !== undefined) {\r\n      this.updateTooltipsOfOlGeometry(this.activeOlGeometry);\r\n    }\r\n  }\r\n\r\n  onCalculateClick() {\r\n    const features = this.selectedFeatures$.value;\r\n    const area = features.reduce((sum: number, localFeature: FeatureWithMeasure) => {\r\n      return sum + localFeature.properties.measure.area || 0;\r\n    }, 0);\r\n    const length = features.reduce((sum: number, localFeature: FeatureWithMeasure) => {\r\n      if (localFeature.geometry.type === 'Polygon') {\r\n        return sum;\r\n      }\r\n      return sum + localFeature.properties.measure.length || 0;\r\n    }, 0);\r\n    const perimeter = features.reduce((sum: number, localFeature: FeatureWithMeasure) => {\r\n      if (localFeature.geometry.type === 'LineString') {\r\n        return sum;\r\n      }\r\n      return sum + localFeature.properties.measure.length || 0;\r\n    }, 0);\r\n\r\n    this.openDialog({\r\n      area,\r\n      length,\r\n      perimeter\r\n    });\r\n  }\r\n\r\n  onDeleteClick() {\r\n    this.store.deleteMany(this.selectedFeatures$.value);\r\n    this.selectedFeatures$.value.forEach(selectedFeature => {\r\n      this.olDrawSource.getFeatures().forEach(drawingLayerFeature => {\r\n        const geometry = drawingLayerFeature.getGeometry() as any;\r\n        if (selectedFeature.properties.id === geometry.ol_uid) {\r\n          this.olDrawSource.removeFeature(drawingLayerFeature);\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  onModifyClick() {\r\n    if (this.selectedFeatures$.value.length !== 1) { return; }\r\n\r\n    if (this.modifyControl.active === true) {\r\n      this.deactivateModifyControl();\r\n      this.toggleDrawControl();\r\n    } else {\r\n      const localFeature = this.selectedFeatures$.value[0];\r\n      const olFeatures = this.store.layer.ol.getSource().getFeatures();\r\n      const olFeature = olFeatures.find((_olFeature: OlFeature<OlGeometry>) => {\r\n        return _olFeature.get('id') === localFeature.properties.id;\r\n      });\r\n\r\n      if (olFeature !== undefined) {\r\n        this.deactivateDrawControl();\r\n        this.activateModifyControl();\r\n\r\n        const olGeometry = olFeature.getGeometry();\r\n        this.clearTooltipsOfOlGeometry(olGeometry as (OlLineString | OlPolygon));\r\n        this.modifyControl.setOlGeometry(olGeometry);\r\n      }\r\n    }\r\n  }\r\n\r\n  private openDialog(data: MeasurerDialogData): void {\r\n    this.dialog.open(MeasurerDialogComponent, {data});\r\n  }\r\n\r\n  /**\r\n   * Initialize the measure store and set up some listeners\r\n   * @internal\r\n   */\r\n  private initStore() {\r\n    const store = this.store;\r\n\r\n    const layer = new VectorLayer({\r\n      title: this.languageService.translate.instant('igo.geo.measure.layerTitle'),\r\n      isIgoInternalLayer: true,\r\n      id: `igo-measures-${uuid()}`,\r\n      zIndex: 200,\r\n      source: new FeatureDataSource(),\r\n      style: createMeasureLayerStyle(),\r\n      showInLayerList: true,\r\n      exportable: true,\r\n      browsable: false,\r\n      workspace: { enabled: false }\r\n    });\r\n    tryBindStoreLayer(store, layer);\r\n    store.layer.visible = true;\r\n    layer.visible$.subscribe(visible => {\r\n      if (visible) {\r\n        Array.from(document.getElementsByClassName('igo-map-tooltip-measure')).map((value: Element) =>\r\n        value.classList.remove('igo-map-tooltip-measure-by-display'));\r\n      }\r\n      else {\r\n        Array.from(document.getElementsByClassName('igo-map-tooltip-measure')).map((value: Element) =>\r\n        value.classList.add('igo-map-tooltip-measure-by-display'));\r\n      }\r\n    });\r\n\r\n    tryAddLoadingStrategy(store);\r\n\r\n    tryAddSelectionStrategy(store, new FeatureStoreSelectionStrategy({\r\n      map: this.map,\r\n      many: true\r\n    }));\r\n\r\n    this.onFeatureAddedKey = store.source.ol.on('addfeature', (event: OlVectorSourceEvent<OlGeometry>) => {\r\n      const localFeature = event.feature;\r\n      const olGeometry = localFeature.getGeometry() as any;\r\n      this.updateMeasureOfOlGeometry(olGeometry, localFeature.get('measure'));\r\n      this.onDisplayDistance();\r\n    });\r\n\r\n    this.onFeatureRemovedKey = store.source.ol.on('removefeature', (event: OlVectorSourceEvent<OlGeometry>) => {\r\n      const olGeometry = event.feature.getGeometry() as any;\r\n      this.clearTooltipsOfOlGeometry(olGeometry);\r\n    });\r\n\r\n    this.selectedFeatures$$ = store.stateView.manyBy$((record: EntityRecord<FeatureWithMeasure>) => {\r\n      return record.state.selected === true;\r\n    }).pipe(\r\n      skip(1) // Skip initial emission\r\n    )\r\n    .subscribe((records: EntityRecord<FeatureWithMeasure>[]) => {\r\n      if (this.modifyControl.active === true) {\r\n        this.deactivateModifyControl();\r\n      }\r\n      this.selectedFeatures$.next(records.map(record => record.entity));\r\n    });\r\n\r\n    this.subscriptions$$.push(this.store.entities$.subscribe(objectsExists => {\r\n      if (objectsExists.find(objectExist => objectExist.geometry.type === 'Polygon')){\r\n        this.hasArea$.next(true);\r\n      } else {\r\n        this.hasArea$.next(false);\r\n      }\r\n\r\n      if (objectsExists.find(objectExist => objectExist.geometry.type === 'LineString')){\r\n        this.hasLine$.next(true);\r\n      } else {\r\n        this.hasLine$.next(false);\r\n      }\r\n    }));\r\n\r\n    this.subscriptions$$.push(this.store.count$.subscribe(cnt => {\r\n      cnt >= 1 ?\r\n        this.store.layer.options.showInLayerList = true :\r\n        this.store.layer.options.showInLayerList = false;\r\n    }));\r\n  }\r\n\r\n  /**\r\n   * Freeze any store, meaning the layer is removed, strategies are deactivated\r\n   * and some listener removed\r\n   * @internal\r\n   */\r\n  private freezeStore() {\r\n    const store = this.store;\r\n    this.selectedFeatures$$.unsubscribe();\r\n    unByKey(this.onFeatureAddedKey);\r\n    unByKey(this.onFeatureRemovedKey);\r\n    store.deactivateStrategyOfType(FeatureStoreLoadingStrategy);\r\n    store.deactivateStrategyOfType(FeatureStoreSelectionStrategy);\r\n  }\r\n\r\n  /**\r\n   * Create a draw line control\r\n   */\r\n  private createDrawLineControl() {\r\n    this.drawLineControl = new DrawControl({\r\n      geometryType: 'LineString',\r\n      drawingLayerSource: this.olDrawSource,\r\n      interactionStyle: createMeasureInteractionStyle(),\r\n      drawingLayerStyle: new OlStyle({})\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create a draw polygon control\r\n   */\r\n  private createDrawPolygonControl() {\r\n    this.drawPolygonControl = new DrawControl({\r\n      geometryType: 'Polygon',\r\n      drawingLayerSource: this.olDrawSource,\r\n      interactionStyle: createMeasureInteractionStyle(),\r\n      drawingLayerStyle: new OlStyle({})\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create a draw polygon control\r\n   */\r\n  private createModifyControl() {\r\n    this.modifyControl = new ModifyControl({\r\n      source: this.olDrawSource,\r\n      drawStyle: createMeasureInteractionStyle(),\r\n      layerStyle: new OlStyle({})\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Activate the right control\r\n   */\r\n  private toggleDrawControl() {\r\n    this.deactivateDrawControl();\r\n    // this.deactivateModifyControl();\r\n    if (this.activeMeasureType === MeasureType.Length) {\r\n      this.activateDrawControl(this.drawLineControl);\r\n    } else if (this.activeMeasureType === MeasureType.Area) {\r\n      this.activateDrawControl(this.drawPolygonControl);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Activate a given control\r\n   * @param drawControl Draw control\r\n   */\r\n  private activateDrawControl(drawControl: DrawControl) {\r\n    this.drawControlIsDisabled = false;\r\n    this.activeDrawControl = drawControl;\r\n    this.drawStart$$ = drawControl.start$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => this.onDrawStart(olGeometry));\r\n    this.drawEnd$$ = drawControl.end$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => this.onDrawEnd(olGeometry));\r\n    this.drawChanges$$ = drawControl.changes$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => this.onDrawChanges(olGeometry));\r\n    this.drawChanges$$ = drawControl.abort$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => {\r\n        this.clearTooltipsOfOlGeometry(olGeometry);\r\n        this.clearMeasures();\r\n      });\r\n    drawControl.setOlMap(this.map.ol, false);\r\n  }\r\n\r\n  /**\r\n   * Deactivate the active draw control\r\n   */\r\n  private deactivateDrawControl() {\r\n    if (this.activeDrawControl === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.olDrawSource.clear();\r\n    if (this.drawStart$$ !== undefined ) { this.drawStart$$.unsubscribe(); }\r\n    if (this.drawEnd$$ !== undefined ) { this.drawEnd$$.unsubscribe(); }\r\n    if (this.drawChanges$$ !== undefined ) { this.drawChanges$$.unsubscribe(); }\r\n\r\n    this.clearTooltipsOfOlSource(this.olDrawSource);\r\n    if (this.activeOlGeometry !== undefined) {\r\n      this.clearTooltipsOfOlGeometry(this.activeOlGeometry);\r\n    }\r\n    this.activeDrawControl.setOlMap(undefined);\r\n    this.activeDrawControl = undefined;\r\n    this.activeOlGeometry = undefined;\r\n  }\r\n\r\n  private setActiveMeasureType(measureType: MeasureType) {\r\n    this._activeMeasureType = measureType;\r\n    this.clearMeasures();\r\n    this.toggleDrawControl();\r\n  }\r\n\r\n  /**\r\n   * Clear the draw source and track the geometry being drawn\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onDrawStart(olGeometry: OlLineString | OlPolygon) {\r\n    this.activeOlGeometry = olGeometry;\r\n  }\r\n\r\n  /**\r\n   * Clear the draw source and track the geometry being draw\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onDrawEnd(olGeometry: OlLineString | OlPolygon) {\r\n    this.activeOlGeometry = undefined;\r\n    this.finalizeMeasureOfOlGeometry(olGeometry);\r\n    this.addFeatureToStore(olGeometry);\r\n    this.clearTooltipsOfOlGeometry(olGeometry);\r\n    this.olDrawSource.clear(true);\r\n  }\r\n\r\n  /**\r\n   * Update measures observables and map tooltips\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onDrawChanges(olGeometry: OlLineString | OlPolygon) {\r\n    const measure = measureOlGeometry(olGeometry, this.projection);\r\n    this.updateMeasureOfOlGeometry(olGeometry, Object.assign({}, measure, {\r\n      area: undefined // We don't want to display an area tooltip while drawing.\r\n    }));\r\n    this.measure$.next(measure);\r\n  }\r\n\r\n  /**\r\n   * Activate a given control\r\n   * @param modifyControl Modify control\r\n   */\r\n  private activateModifyControl() {\r\n    const selection = this.store.getStrategyOfType(FeatureStoreSelectionStrategy) as FeatureStoreSelectionStrategy;\r\n    selection.deactivate();\r\n    selection.clear();\r\n\r\n    this.modifyStart$$ = this.modifyControl.start$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => this.onModifyStart(olGeometry));\r\n    this.modifyEnd$$ = this.modifyControl.end$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => this.onModifyEnd(olGeometry));\r\n    this.modifyChanges$$ = this.modifyControl.changes$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => this.onModifyChanges(olGeometry));\r\n    this.modifyControl.setOlMap(this.map.ol);\r\n  }\r\n\r\n  /**\r\n   * Deactivate the active modify control\r\n   */\r\n  private deactivateModifyControl() {\r\n    if (this.modifyStart$$ !== undefined ) { this.modifyStart$$.unsubscribe(); }\r\n    if (this.modifyEnd$$ !== undefined ) { this.modifyEnd$$.unsubscribe(); }\r\n    if (this.modifyChanges$$ !== undefined ) { this.modifyChanges$$.unsubscribe(); }\r\n\r\n    if (this.activeOlGeometry !== undefined) {\r\n      if (this.selectedFeatures$.value.length === 1) {\r\n        const localFeature = this.selectedFeatures$.value[0];\r\n        this.addFeatureToStore(this.activeOlGeometry, localFeature);\r\n      }\r\n      this.finalizeMeasureOfOlGeometry(this.activeOlGeometry);\r\n    }\r\n\r\n    this.olDrawSource.clear();\r\n\r\n    this.store.activateStrategyOfType(FeatureStoreSelectionStrategy);\r\n\r\n    this.activeOlGeometry = undefined;\r\n    this.modifyControl.setOlMap(undefined);\r\n  }\r\n\r\n  /**\r\n   * Clear the draw source and track the geometry being drawn\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onModifyStart(olGeometry: OlLineString | OlPolygon) {\r\n    this.onDrawStart(olGeometry);\r\n  }\r\n\r\n  /**\r\n   * Update measures observables and map tooltips\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onModifyChanges(olGeometry: OlLineString | OlPolygon) {\r\n    this.onDrawChanges(olGeometry);\r\n  }\r\n\r\n  /**\r\n   * Clear the draw source and track the geometry being draw\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onModifyEnd(olGeometry: OlLineString | OlPolygon) {\r\n    this.finalizeMeasureOfOlGeometry(olGeometry);\r\n  }\r\n\r\n  private finalizeMeasureOfOlGeometry(olGeometry: OlLineString | OlPolygon) {\r\n    const measure = measureOlGeometry(olGeometry, this.projection);\r\n    this.updateMeasureOfOlGeometry(olGeometry, measure);\r\n  }\r\n\r\n  /**\r\n   * Update measures observables\r\n   * @param olGeometry Ol linestring or polygon\r\n   * @param measure Measure\r\n   */\r\n  private updateMeasureOfOlGeometry(olGeometry: OlLineString | OlPolygon, measure: Measure) {\r\n    olGeometry.setProperties({_measure: measure}, true);\r\n    this.updateTooltipsOfOlGeometry(olGeometry);\r\n  }\r\n\r\n  /**\r\n   * Clear the measures observables\r\n   */\r\n  private clearMeasures() {\r\n    this.measure$.next({});\r\n  }\r\n\r\n  /**\r\n   * Add a feature with measures to the store. The loading stragegy of the store\r\n   * will trigger and add the feature to the map.\r\n   * @internal\r\n   */\r\n  private addFeatureToStore(olGeometry, localFeature?: FeatureWithMeasure) {\r\n    const featureId = localFeature ? localFeature.properties.id : olGeometry.ol_uid;\r\n    const projection = this.map.ol.getView().getProjection();\r\n    const geometry = new OlGeoJSON().writeGeometryObject(olGeometry, {\r\n      featureProjection: projection,\r\n      dataProjection: projection\r\n    }) as any;\r\n    this.store.update({\r\n      type: FEATURE,\r\n      geometry,\r\n      projection: projection.getCode(),\r\n      properties: {\r\n        id: featureId,\r\n        measure: olGeometry.get('_measure')\r\n      },\r\n      meta: {\r\n        id: featureId\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Update all the tooltips of an OL geometry\r\n   * @param olGeometry OL Geometry\r\n   * @param lengths Lengths of the OL geometry's segments\r\n   * @param measureUnit Display tooltip measure in those units\r\n   */\r\n  private updateTooltipsOfOlGeometry(olGeometry: OlLineString | OlPolygon) {\r\n    const measure = olGeometry.get('_measure');\r\n    const lengths = measure.lengths;\r\n    const area = measure.area;\r\n\r\n    const olMidpointsTooltips = updateOlTooltipsAtMidpoints(olGeometry);\r\n    if (lengths.length === olMidpointsTooltips.length) {\r\n      for (let i = 0; i < olMidpointsTooltips.length; i++) {\r\n        const length = lengths[i];\r\n        if (length !== undefined) {\r\n          this.updateOlTooltip(\r\n            olMidpointsTooltips[i],\r\n            metersToUnit(length, this.activeLengthUnit),\r\n            this.activeLengthUnit,\r\n            MeasureType.Length\r\n          );\r\n        }\r\n      }\r\n    }\r\n\r\n    if (area !== undefined) {\r\n      this.updateOlTooltip(\r\n        updateOlTooltipAtCenter(olGeometry),\r\n        squareMetersToUnit(area, this.activeAreaUnit),\r\n        this.activeAreaUnit,\r\n        MeasureType.Area\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Show the map tooltips of a geoemtry\r\n   */\r\n  private showTooltipsOfOlGeometry(olGeometry: OlLineString | OlPolygon) {\r\n    getTooltipsOfOlGeometry(olGeometry).forEach((olTooltip: OlOverlay | undefined) => {\r\n      if (this.shouldShowTooltip(olTooltip)) {\r\n        this.map.ol.addOverlay(olTooltip);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Clear the tooltips of an OL geometrys\r\n   * @param olGeometry OL geometry with tooltips\r\n   */\r\n  private clearTooltipsOfOlGeometry(olGeometry: OlLineString | OlPolygon) {\r\n    getTooltipsOfOlGeometry(olGeometry).forEach((olTooltip: OlOverlay | undefined) => {\r\n      if (olTooltip !== undefined && olTooltip.getMap() !== undefined) {\r\n        this.map.ol.removeOverlay(olTooltip);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Show the map tooltips of all the geometries of a source\r\n   */\r\n  private updateTooltipsOfOlSource(olSource: OlVectorSource<OlGeometry>) {\r\n    olSource.forEachFeature((olFeature: OlFeature<OlGeometry>) => {\r\n      this.updateTooltipsOfOlGeometry(olFeature.getGeometry() as any);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Show the map tooltips of all the geometries of a source\r\n   */\r\n  private showTooltipsOfOlSource(olSource: OlVectorSource<OlGeometry>) {\r\n    olSource.forEachFeature((olFeature: OlFeature<OlGeometry>) => {\r\n      this.showTooltipsOfOlGeometry(olFeature.getGeometry() as any);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Clear the map tooltips\r\n   * @param olDrawSource OL vector source\r\n   */\r\n  private clearTooltipsOfOlSource(olSource: OlVectorSource<OlGeometry>) {\r\n    olSource.forEachFeature((olFeature: OlFeature<OlGeometry>) => {\r\n      const olGeometry = olFeature.getGeometry();\r\n      if (olGeometry !== undefined) {\r\n        this.clearTooltipsOfOlGeometry(olFeature.getGeometry() as any);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Update an OL tooltip properties and inner HTML and add it to the map if possible\r\n   * @param olTooltip OL tooltip\r\n   * @param measure The measure valeu ti display\r\n   * @param measureUnit Display tooltip measure in those units\r\n   */\r\n  private updateOlTooltip(\r\n    olTooltip: OlOverlay,\r\n    measure: number,\r\n    unit: MeasureAreaUnit | MeasureLengthUnit,\r\n    type: MeasureType\r\n  ) {\r\n    olTooltip.setProperties({_measure: measure, _unit: unit, _type: type}, true);\r\n    olTooltip.getElement().innerHTML = this.computeTooltipInnerHTML(olTooltip);\r\n    if (this.shouldShowTooltip(olTooltip)) {\r\n      this.map.ol.addOverlay(olTooltip);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Compute a tooltip's content\r\n   * @param olTooltip OL overlay\r\n   * @returns Inner HTML\r\n   */\r\n  private computeTooltipInnerHTML(olTooltip: OlOverlay): string {\r\n    const properties = olTooltip.getProperties() as any;\r\n    return formatMeasure(properties._measure, {\r\n      decimal: 1,\r\n      unit: properties._unit,\r\n      unitAbbr: true,\r\n      locale: 'fr'\r\n    }, this.languageService);\r\n  }\r\n\r\n  /**\r\n   * Whether a tooltip should be showned based on the length\r\n   * of the segment it is bound to.\r\n   * @param olTooltip OL overlay\r\n   * @returns True if the tooltip should be shown\r\n   */\r\n  private shouldShowTooltip(olTooltip: OlOverlay): boolean {\r\n    if (this.showTooltips === false) {\r\n      return false;\r\n    }\r\n\r\n    const properties = olTooltip.getProperties() as any;\r\n    const measure = properties._measure;\r\n    if (measure === undefined) {\r\n      return false;\r\n    }\r\n\r\n    if (properties._unit === MeasureType.Length) {\r\n      const minSegmentLength = metersToUnit(this.minSegmentLength, properties._unit) || 0;\r\n      return measure > Math.max(minSegmentLength, 0);\r\n    }\r\n\r\n    return true;\r\n  }\r\n}\r\n","import { Pipe, PipeTransform } from '@angular/core';\r\n\r\nimport { MeasureAreaUnit, MeasureLengthUnit } from '../shared/measure.enum';\r\nimport { metersToUnit, squareMetersToUnit, formatMeasure } from '../shared/measure.utils';\r\n\r\n/**\r\n * This pipe returns a measure converted from meters (or square meters)\r\n * to the specified unit. It also keeps a certain number of decimals.\r\n */\r\n@Pipe({\r\n  name: 'measureFormat'\r\n})\r\nexport class MeasureFormatPipe implements PipeTransform {\r\n\r\n  /**\r\n   * @ignore\r\n   */\r\n  transform(\r\n    value: number, unit: MeasureAreaUnit | MeasureLengthUnit,\r\n    unitAbbr: boolean = false,\r\n    decimal: number = 1\r\n  ): number {\r\n    let out;\r\n    if (Object.values(MeasureAreaUnit).indexOf(unit as MeasureAreaUnit) >= 0) {\r\n      out = squareMetersToUnit(value, unit as MeasureAreaUnit);\r\n    } else if (Object.values(MeasureLengthUnit).indexOf(unit as MeasureLengthUnit) >= 0) {\r\n      out = metersToUnit(value, unit as MeasureLengthUnit);\r\n    }\r\n\r\n    return out ? formatMeasure(out, {\r\n      decimal: 1,\r\n      unit,\r\n      unitAbbr,\r\n      locale: 'fr'\r\n    }) : out;\r\n  }\r\n}\r\n","import { DrawControlOptions } from './../shared/controls/draw';\r\nimport {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  OnDestroy,\r\n  Optional,\r\n  Self,\r\n  ChangeDetectorRef,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\nimport { NgControl, ControlValueAccessor } from '@angular/forms';\r\n\r\nimport { Subscription } from 'rxjs';\r\n\r\nimport * as OlStyle from 'ol/style';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport OlGeometry from 'ol/geom/Geometry';\r\nimport type { Type } from 'ol/geom/Geometry';\r\nimport OlFeature from 'ol/Feature';\r\nimport OlVectorSource from 'ol/source/Vector';\r\nimport OlVectorLayer from 'ol/layer/Vector';\r\nimport OlOverlay from 'ol/Overlay';\r\nimport * as olproj from 'ol/proj';\r\nimport Point from 'ol/geom/Point';\r\n\r\nimport { IgoMap } from '../../map';\r\nimport {\r\n  MeasureLengthUnit,\r\n  updateOlGeometryMidpoints,\r\n  formatMeasure,\r\n  measureOlGeometry\r\n} from '../../measure';\r\nimport { DrawControl, ModifyControl, ModifyControlOptions } from '../shared/controls';\r\nimport { createDrawInteractionStyle } from '../shared/geometry.utils';\r\nimport { GeoJSONGeometry } from '../shared/geometry.interfaces';\r\nimport OlCircle from 'ol/geom/Circle';\r\nimport OlLineString from 'ol/geom/LineString';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport OlPolygon from 'ol/geom/Polygon';\r\n\r\n/**\r\n * This input allows a user to draw a new geometry or to edit\r\n * an existing one on a map. A text input is also displayed in the\r\n * form with some instructions.\r\n * This is still WIP.\r\n */\r\n@Component({\r\n  selector: 'igo-geometry-form-field-input',\r\n  templateUrl: './geometry-form-field-input.component.html',\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class GeometryFormFieldInputComponent implements OnInit, OnDestroy, ControlValueAccessor {\r\n\r\n  private olOverlayLayer: OlVectorLayer<OlVectorSource<OlGeometry>>;\r\n  private olGeoJSON = new OlGeoJSON();\r\n  private ready = false;\r\n\r\n  private drawControl: DrawControl;\r\n  private modifyControl: ModifyControl;\r\n  private defaultDrawStyleRadius: number;\r\n  private olGeometryEnds$$: Subscription;\r\n  private olGeometryChanges$$: Subscription;\r\n  private olTooltip = this.createMeasureTooltip();\r\n\r\n  /**\r\n   * Active control\r\n   * @internal\r\n   */\r\n  public activeControl: DrawControl | ModifyControl;\r\n\r\n  /**\r\n   * The map to draw the geometry on\r\n   */\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * The geometry type\r\n   */\r\n  @Input()\r\n  set geometryType(value: Type) {\r\n    this._geometryType = value;\r\n    if (this.ready === false) {\r\n      return;\r\n    }\r\n\r\n    this.deactivateControl();\r\n    this.createDrawControl();\r\n    this.drawControl.freehand$.next(this.freehandDrawIsActive);\r\n    this.toggleControl();\r\n  }\r\n  get geometryType(): Type { return this._geometryType; }\r\n  private _geometryType: Type;\r\n\r\n  /**\r\n   * The drawGuide around the mouse pointer to help drawing\r\n   */\r\n  @Input() drawGuide: number = null;\r\n\r\n  /**\r\n   * Whether a measure tooltip should be displayed\r\n   */\r\n  @Input() measure: boolean = false;\r\n\r\n  /**\r\n   * Whether draw control should be active or not\r\n   */\r\n  @Input()\r\n  get drawControlIsActive(): boolean { return this._drawControlIsActive; }\r\n  set drawControlIsActive(value: boolean) {\r\n    this._drawControlIsActive = value;\r\n    if (this.ready === false) {\r\n      return;\r\n    }\r\n    this.deactivateControl();\r\n    if (!this._drawControlIsActive) {\r\n      return;\r\n    } else {\r\n      this.toggleControl();\r\n    }\r\n  }\r\n  private _drawControlIsActive: boolean = true;\r\n\r\n  /**\r\n   * Whether freehand draw control should be active or not\r\n   */\r\n  @Input()\r\n  get freehandDrawIsActive(): boolean { return this._freehandDrawIsActive; }\r\n  set freehandDrawIsActive(value: boolean) {\r\n    this._freehandDrawIsActive = value;\r\n    this.deactivateControl();\r\n\r\n    this.createDrawControl();\r\n    this.createModifyControl();\r\n\r\n    this.drawControl.freehand$.next(this.freehandDrawIsActive);\r\n\r\n    if (this.ready === false) {\r\n      return;\r\n    }\r\n\r\n    if (!this.drawControlIsActive) {\r\n      return;\r\n    }\r\n    this.toggleControl();\r\n  }\r\n  private _freehandDrawIsActive: boolean;\r\n\r\n  /**\r\n   * Control options\r\n   */\r\n  @Input() controlOptions: {[key: string]: any} = {};\r\n\r\n  /**\r\n   * Style for the draw control (applies while the geometry is being drawn)\r\n   */\r\n  @Input()\r\n  set drawStyle(value: OlStyle.Style | ((feature, resolution) => OlStyle.Style) | OlStyle.Circle) {\r\n    if (value === undefined) {\r\n      value = createDrawInteractionStyle();\r\n    }\r\n    this._drawStyle = value;\r\n\r\n    const olGuideStyle = this.getGuideStyleFromDrawStyle(value) as OlStyle.Circle;\r\n    if (olGuideStyle !== undefined) {\r\n      this.defaultDrawStyleRadius = olGuideStyle.getRadius();\r\n    } else {\r\n      this.defaultDrawStyleRadius = null;\r\n    }\r\n\r\n    if (this.ready === false) {\r\n      return;\r\n    }\r\n\r\n    this.deactivateControl();\r\n    this.createDrawControl();\r\n    this.createModifyControl();\r\n\r\n    this.drawControl.freehand$.next(this.freehandDrawIsActive);\r\n    this.toggleControl();\r\n  }\r\n  get drawStyle(): OlStyle.Style | ((feature, resolution) => OlStyle.Style) | OlStyle.Circle { return this._drawStyle; }\r\n  private _drawStyle: OlStyle.Style | ((feature, resolution) => OlStyle.Style) | OlStyle.Circle;\r\n\r\n  /**\r\n   * Style for the overlay layer (applies once the geometry is added to the map)\r\n   * If not specified, drawStyle applies\r\n   */\r\n  @Input()\r\n  set overlayStyle(value: OlStyle.Style | ((feature, resolution) => OlStyle.Style) | OlStyle.Circle) { this._overlayStyle = value; }\r\n  get overlayStyle(): OlStyle.Style | ((feature, resolution) => OlStyle.Style) | OlStyle.Circle { return this._overlayStyle; }\r\n  private _overlayStyle: OlStyle.Style | ((feature, resolution) => OlStyle.Style) | OlStyle.Circle;\r\n\r\n  /**\r\n   * The geometry value (GeoJSON)\r\n   * Implemented as part of ControlValueAccessor.\r\n   */\r\n  @Input()\r\n  set value(value: GeoJSONGeometry) {\r\n    this._value = value;\r\n    if (this.ready === false) {\r\n      return;\r\n    }\r\n\r\n    if (value) {\r\n      this.addGeoJSONToOverlay(value);\r\n    } else {\r\n      this.olOverlaySource.clear(true);\r\n    }\r\n    this.onChange(value);\r\n    this.toggleControl();\r\n    this.cdRef.detectChanges();\r\n  }\r\n  get value(): GeoJSONGeometry { return this._value; }\r\n  private _value: GeoJSONGeometry;\r\n\r\n  /**\r\n   * The vector source to add the geometry to\r\n   * @internal\r\n   */\r\n  get olOverlaySource(): OlVectorSource<OlGeometry> {\r\n    return this.olOverlayLayer.getSource();\r\n  }\r\n\r\n  @Input()\r\n  set radius(value: any) {\r\n    if (this.ready === false) {\r\n      return;\r\n    }\r\n    if (this.modifyControl.getSource()) {\r\n      this.modifyControl.getSource().refresh();\r\n    }\r\n    if (this.freehandDrawIsActive) {\r\n      let olModify;\r\n      setTimeout(() => {\r\n        olModify = this.modifyControl.olModifyInteraction;\r\n        if (olModify) {\r\n          if (olModify.features_) {\r\n            olModify.features_.clear();\r\n            this.addGeoJSONToOverlay(this.value);\r\n          }\r\n        }\r\n      }, 0);\r\n    }\r\n  }\r\n\r\n  constructor(\r\n    private cdRef: ChangeDetectorRef,\r\n    @Optional() @Self() public ngControl: NgControl\r\n  ) {\r\n    if (this.ngControl !== undefined) {\r\n      // Setting the value accessor directly (instead of using\r\n      // the providers) to avoid running into a circular import.\r\n      this.ngControl.valueAccessor = this;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create an overlay layer, add the initial geometry to it (if any)\r\n   * and toggle the right interaction.\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    if (this.drawStyle === undefined) {\r\n      this.drawStyle = createDrawInteractionStyle();\r\n    }\r\n\r\n    if (this.overlayStyle === undefined) {\r\n      this.overlayStyle = this.drawStyle;\r\n    }\r\n\r\n    this.addOlOverlayLayer();\r\n    this.createDrawControl();\r\n    this.createModifyControl();\r\n\r\n    if (this.value) {\r\n      this.addGeoJSONToOverlay(this.value);\r\n    }\r\n    this.toggleControl();\r\n\r\n    this.ready = true;\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay layer and any interaction added by this component.\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    // This is mandatory when the form control is reused after\r\n    // this component has been destroyed. It seems like the control\r\n    // keeps a reference to this component even after it's destroyed\r\n    // and it attempts to set it's value\r\n    this.ready = false;\r\n\r\n    this.deactivateControl();\r\n    this.olOverlaySource.clear();\r\n    this.map.ol.removeLayer(this.olOverlayLayer);\r\n  }\r\n\r\n  /**\r\n   * Implemented as part of ControlValueAccessor.\r\n   */\r\n  // eslint-disable-next-line @typescript-eslint/ban-types\r\n  registerOnChange(fn: Function) {\r\n    this.onChange = fn;\r\n  }\r\n  private onChange: any = () => {};\r\n\r\n  /**\r\n   * Implemented as part of ControlValueAccessor.\r\n   */\r\n  // eslint-disable-next-line @typescript-eslint/ban-types\r\n  registerOnTouched(fn: Function) {\r\n    this.onTouched = fn;\r\n  }\r\n  private onTouched: any = () => {};\r\n\r\n  /**\r\n   * Implemented as part of ControlValueAccessor.\r\n   */\r\n  writeValue(value: GeoJSONGeometry) {\r\n    this.value = value;\r\n  }\r\n\r\n  /**\r\n   * Add an overlay layer to the map\r\n   */\r\n  private addOlOverlayLayer() {\r\n    this.olOverlayLayer = new OlVectorLayer({\r\n      source: new OlVectorSource(),\r\n      zIndex: 500,\r\n      style: null\r\n    });\r\n    this.map.ol.addLayer(this.olOverlayLayer);\r\n  }\r\n\r\n  /**\r\n   * Create a draw control and subscribe to it's geometry\r\n   */\r\n  private createDrawControl() {\r\n    const controlOptions = Object.assign({}, this.controlOptions, {\r\n      geometryType: this.geometryType || 'Point',\r\n      drawingLayer: this.olOverlayLayer,\r\n      interactionStyle: typeof this.drawStyle === 'function' ? this.drawStyle : (olFeature: OlFeature<OlGeometry>, resolution: number) => {\r\n        const style = this.drawStyle;\r\n        this.updateDrawStyleWithDrawGuide(style, resolution);\r\n        return style;\r\n      }\r\n    }) as DrawControlOptions;\r\n    this.drawControl = new DrawControl(controlOptions);\r\n  }\r\n\r\n  /**\r\n   * Create a modify control and subscribe to it's geometry\r\n   */\r\n  private createModifyControl() {\r\n    const controlOptions = Object.assign({}, this.controlOptions, {\r\n      layer: this.olOverlayLayer,\r\n      drawStyle: typeof this.drawStyle === 'function' ? this.drawStyle : (olFeature: OlFeature<OlGeometry>, resolution: number) => {\r\n        const style = this.drawStyle;\r\n        this.updateDrawStyleWithDrawGuide(style, resolution);\r\n        return style;\r\n      }\r\n    }) as ModifyControlOptions;\r\n    this.modifyControl = new ModifyControl(controlOptions);\r\n  }\r\n\r\n  /**\r\n   * Toggle the proper control (draw or modify)\r\n   */\r\n  private toggleControl() {\r\n    let activate;\r\n    if (!this.value && this.geometryType) {\r\n      activate = this.drawControl;\r\n    } else {\r\n      activate = this.modifyControl;\r\n    }\r\n\r\n    // If the control that should be activated\r\n    // is not the same as the current active control,\r\n    // deactivate the current control and activate the new one\r\n    // Otherwise, do nothing and keep the current control active\r\n    if (activate !== this.activeControl) {\r\n      this.deactivateControl();\r\n      this.activateControl(activate);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Activate a given control\r\n   * @param control Control\r\n   */\r\n  private activateControl(control: DrawControl | ModifyControl) {\r\n    this.activeControl = control;\r\n    this.olGeometryEnds$$ = control.end$\r\n      .subscribe((olGeometry: OlGeometry) => this.onOlGeometryEnds(olGeometry));\r\n    if (this.measure === true && control === this.drawControl) {\r\n      this.olGeometryChanges$$ = control.changes$\r\n        .subscribe((olGeometry: OlPolygon | OlPoint | OlLineString | OlCircle) => this.onOlGeometryChanges(olGeometry));\r\n    }\r\n    control.setOlMap(this.map.ol, false);\r\n  }\r\n\r\n  /**\r\n   * Deactivate the active control\r\n   */\r\n  private deactivateControl() {\r\n    this.removeMeasureTooltip();\r\n    if (this.activeControl !== undefined) {\r\n      this.activeControl.setOlMap(undefined);\r\n    }\r\n    if (this.olGeometryEnds$$ !== undefined) {\r\n      this.olGeometryEnds$$.unsubscribe();\r\n    }\r\n    if (this.olGeometryChanges$$ !== undefined) {\r\n      this.olGeometryChanges$$.unsubscribe();\r\n    }\r\n    this.activeControl = undefined;\r\n  }\r\n\r\n  /**\r\n   * Update measures observables and map tooltips\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onOlGeometryEnds(olGeometry: OlGeometry | undefined) {\r\n    this.removeMeasureTooltip();\r\n    this.setOlGeometry(olGeometry);\r\n  }\r\n\r\n  /**\r\n   * Update measures observables and map tooltips\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onOlGeometryChanges(olGeometry: OlPolygon | OlPoint | OlLineString | OlCircle) {\r\n    if (olGeometry.getType() !== 'Point') {\r\n      this.updateMeasureTooltip(olGeometry);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * When drawing ends, convert the output value to GeoJSON and keep it.\r\n   * Restore the double click interaction.\r\n   * @param olGeometry OL geometry\r\n   */\r\n  private setOlGeometry(olGeometry: OlGeometry | undefined) {\r\n    let value;\r\n    if (olGeometry === undefined) {\r\n      return;\r\n    }\r\n\r\n    if (olGeometry.getType() === 'Circle') { // Because Circle doesn't exist as a GeoJSON object\r\n      olGeometry = this.circleToPoint(olGeometry);\r\n    }\r\n\r\n    value = this.olGeoJSON.writeGeometryObject(olGeometry, {\r\n      featureProjection: this.map.projection,\r\n      dataProjection: 'EPSG:4326'\r\n    });\r\n    if (olGeometry.get('radius')) {\r\n      value.radius = olGeometry.get('radius');\r\n      olGeometry.set('radius', value.radius);\r\n    }\r\n    this.writeValue(value);\r\n  }\r\n\r\n  private circleToPoint(olGeometry) {\r\n    const center = olGeometry.getCenter();\r\n    const coordinates = olproj.transform(center, this.map.projection, 'EPSG:4326');\r\n    const radius = Math.round(olGeometry.getRadius() * (Math.cos((Math.PI / 180) * coordinates[1])));\r\n\r\n    // Convert it to a point object\r\n    olGeometry = new Point(center);\r\n    olGeometry.set('radius', radius, true);\r\n    return olGeometry;\r\n  }\r\n\r\n  /**\r\n   * Add a GeoJSON geometry to the overlay\r\n   * @param geometry GeoJSON geometry\r\n   */\r\n  private addGeoJSONToOverlay(geometry: GeoJSONGeometry) {\r\n    const olGeometry = this.olGeoJSON.readGeometry(geometry, {\r\n      dataProjection: 'EPSG:4326',\r\n      featureProjection: this.map.projection\r\n    });\r\n    const olFeature = new OlFeature({\r\n      geometry: olGeometry\r\n    });\r\n    olFeature.setStyle(this.overlayStyle as OlStyle.Style);\r\n    this.olOverlaySource.clear();\r\n    this.olOverlaySource.addFeature(olFeature);\r\n  }\r\n\r\n  /**\r\n   * Create the measure tooltip\r\n   */\r\n  private createMeasureTooltip() {\r\n    return new OlOverlay({\r\n      element: document.createElement('div'),\r\n      offset: [-30, -10],\r\n      className: [\r\n        'igo-map-tooltip',\r\n        'igo-map-tooltip-measure'\r\n      ].join(' '),\r\n      stopEvent: false\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Update the measure tooltip of an OL geometry\r\n   * @param olGeometry OL Geometry\r\n   */\r\n  private updateMeasureTooltip(olGeometry: OlPolygon | OlPoint | OlLineString | OlCircle) {\r\n    const measure = measureOlGeometry(olGeometry, this.map.projection);\r\n    const lengths = measure.lengths;\r\n    const lastIndex = olGeometry.getType() === 'Polygon' ? lengths.length - 2 : lengths.length - 1;\r\n    const lastLength = lengths[lastIndex];\r\n\r\n    const olMidpoints = updateOlGeometryMidpoints(olGeometry);\r\n    const olLastMidpoint = olMidpoints[lastIndex];\r\n    if (olMidpoints.length === 0 || olLastMidpoint === undefined) {\r\n      this.removeMeasureTooltip();\r\n      return;\r\n    }\r\n\r\n    this.olTooltip.setPosition(olLastMidpoint.getFlatCoordinates());\r\n\r\n    const innerHtml = formatMeasure(lastLength, {\r\n      decimal: 1,\r\n      unit: MeasureLengthUnit.Meters,\r\n      unitAbbr: true,\r\n      locale: 'fr'\r\n    });\r\n    this.olTooltip.getElement().innerHTML = innerHtml;\r\n    if (this.olTooltip.getMap() === undefined) {\r\n      this.map.ol.addOverlay(this.olTooltip);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove the measure tooltip from the map\r\n   */\r\n  private removeMeasureTooltip() {\r\n    if (this.olTooltip.getMap && this.olTooltip.getMap() !== undefined) {\r\n      this.map.ol.removeOverlay(this.olTooltip);\r\n      this.olTooltip.setMap(undefined);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Adjust the draw style with the specified draw guide distance, if possible\r\n   * @param olStyle Draw style to update\r\n   * @param resolution Resolution (to make the screen size of symbol fit the drawGuide value)\r\n   */\r\n  private updateDrawStyleWithDrawGuide(\r\n    olStyle: OlStyle.Style |\r\n    ((feature, resolution) => OlStyle.Style) |\r\n    OlStyle.Circle,\r\n    resolution: number) {\r\n    const olGuideStyle = this.getGuideStyleFromDrawStyle(olStyle) as OlStyle.Circle;\r\n    if (olGuideStyle === undefined) {\r\n      return;\r\n    }\r\n\r\n    const drawGuide = this.drawGuide;\r\n    let radius;\r\n    if (!drawGuide || drawGuide < 0) {\r\n      radius = this.defaultDrawStyleRadius;\r\n    } else {\r\n      radius = drawGuide > 0 ? drawGuide / resolution : drawGuide;\r\n    }\r\n    olGuideStyle.setRadius(radius);\r\n  }\r\n\r\n  /**\r\n   * Returns wether a given Open Layers style has a radius property that can be set (used to set draw guide)\r\n   * @param olStyle The style on which to perform the check\r\n   */\r\n  private isStyleWithRadius(olStyle) {\r\n    return typeof olStyle !== 'function' && olStyle.setRadius;\r\n  }\r\n\r\n  /**\r\n   * Returns wether a given Open Layers style has a radius property that can be set (used to set draw guide)\r\n   * @param olStyle The style on which to perform the check\r\n   */\r\n  private getGuideStyleFromDrawStyle(\r\n    olStyle: OlStyle.Style | ((feature, resolution) => OlStyle.Style) | OlStyle.Circle |\r\n    OlStyle.Style[] | ((feature, resolution) => OlStyle.Style)[] | OlStyle.Circle[]\r\n  ) {\r\n    if (Array.isArray(olStyle)) {\r\n      olStyle = olStyle[0];\r\n    }\r\n    if (this.isStyleWithRadius(olStyle)) {\r\n      return olStyle;\r\n    }\r\n    return undefined;\r\n  }\r\n}\r\n","<ng-template></ng-template>","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatButtonToggleModule } from '@angular/material/button-toggle';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { GeometryFormFieldComponent } from './geometry-form-field.component';\r\nimport { GeometryFormFieldInputComponent } from './geometry-form-field-input.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    MatIconModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatButtonModule,\r\n    MatButtonToggleModule,\r\n    IgoLanguageModule\r\n  ],\r\n  exports: [\r\n    GeometryFormFieldComponent,\r\n    GeometryFormFieldInputComponent\r\n  ],\r\n  declarations: [\r\n    GeometryFormFieldComponent,\r\n    GeometryFormFieldInputComponent\r\n  ]\r\n})\r\nexport class IgoGeometryFormFieldModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoGeometryFormFieldModule } from './geometry-form-field/geometry-form-field.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoGeometryFormFieldModule\r\n  ],\r\n  exports: [\r\n    IgoGeometryFormFieldModule\r\n  ],\r\n  declarations: [],\r\n  providers: []\r\n})\r\nexport class IgoGeometryModule {}\r\n","<button *ngIf=\"header && options.timeFilterable && options.timeFilter\"\r\n  mat-icon-button\r\n  collapsibleButton\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.filter.filterBy' | translate\"\r\n  [color]=\"color\">\r\n  <mat-icon [matBadge]=\"badge\" matBadgeColor=\"warn\" matBadgeSize=\"medium\" svgIcon=\"history\"></mat-icon>\r\n</button>\r\n\r\n<div #ogcFilter class=\"igo-layer-actions-container\"\r\n*ngIf=\"header && options.timeFilterable && options.timeFilter\">\r\n  <igo-time-filter-item\r\n    *ngIf=\"timeFilterCollapse && options.timeFilter\"\r\n    igoListItem\r\n    [header]=\"false\"\r\n    [layer]=\"layer\">\r\n  </igo-time-filter-item>\r\n</div>\r\n","import { Component, Input, ChangeDetectionStrategy, OnInit } from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { IgoMap } from '../../map';\r\nimport { TimeFilterableDataSourceOptions } from '../shared/time-filter.interface';\r\nimport { WMSDataSourceOptions } from '../../datasource/shared/datasources/wms-datasource.interface';\r\n\r\n@Component({\r\n  selector: 'igo-time-filter-button',\r\n  templateUrl: './time-filter-button.component.html',\r\n  styleUrls: ['./time-filter-button.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class TimeFilterButtonComponent implements OnInit {\r\n\r\n  public options: TimeFilterableDataSourceOptions;\r\n\r\n  get badge() {\r\n    const filter = this.options.timeFilter as any;\r\n    if (filter && filter.enabled) {\r\n      return 1;\r\n    } else {\r\n      return;\r\n    }\r\n  }\r\n\r\n  @Input()\r\n  get layer(): Layer {\r\n    return this._layer;\r\n  }\r\n  set layer(value: Layer) {\r\n    this._layer = value;\r\n    if (value) {\r\n      this.options = this.layer.dataSource.options as WMSDataSourceOptions;\r\n    }\r\n  }\r\n  private _layer;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() color: string = 'primary';\r\n\r\n  @Input() header: boolean = true;\r\n\r\n  public timeFilterCollapse = false;\r\n\r\n  constructor() {}\r\n\r\n  ngOnInit() {\r\n    this.options = this.layer.dataSource.options as WMSDataSourceOptions;\r\n  }\r\n}\r\n","<div *ngIf=\"style === 'calendar' && type !=='year'\">\r\n  <div *ngIf=\"!isRange\" class=\"igo-col igo-col-100 igo-col-100-m\">\r\n    <mat-form-field>\r\n      <mat-datetimepicker-toggle class=\"time-filter-mat-datetimepicker-toggle\" [for]=\"datetimePicker\" matSuffix></mat-datetimepicker-toggle>\r\n      <mat-datetimepicker #datetimePicker type=\"{{type}}\" openOnFocus=\"true\" timeInterval=\"5\"></mat-datetimepicker>\r\n      <input matInput autocomplete=\"false\"\r\n        placeholder=\"{{'igo.geo.timeFilter.date' | translate}}\"\r\n        [matDatetimepicker]=\"datetimePicker\"\r\n        [(ngModel)]=\"date\"\r\n        [min]=\"min\"\r\n        [max]=\"max\"\r\n        readonly=\"readonly\"\r\n        (dateChange)=\"handleDateChange($event)\">\r\n    </mat-form-field>\r\n\r\n  </div>\r\n\r\n  <div *ngIf=\"isRange\">\r\n    <div class=\"igo-col igo-col-100\">\r\n      <mat-form-field>\r\n        <mat-datetimepicker-toggle class=\"time-filter-mat-datetimepicker-toggle\" [for]=\"minDatetimePicker\" matSuffix></mat-datetimepicker-toggle>\r\n        <mat-datetimepicker #minDatetimePicker type=\"{{type}}\" openOnFocus=\"true\" timeInterval=\"5\"></mat-datetimepicker>\r\n        <input matInput autocomplete=\"false\"\r\n          placeholder=\"{{'igo.geo.timeFilter.startDate' | translate}}\"\r\n          [matDatetimepicker]=\"minDatetimePicker\"\r\n          [(ngModel)]=\"startDate\"\r\n          [min]=\"min\"\r\n          [max]=\"getRangeMaxDate()\"\r\n          readonly=\"readonly\"\r\n          (input)=\"startDate\"\r\n          (dateChange)=\"handleDateChange($event)\">\r\n      </mat-form-field>\r\n    </div>\r\n\r\n    <div class=\"igo-col igo-col-100\">\r\n      <mat-form-field>\r\n        <mat-datetimepicker-toggle class=\"time-filter-mat-datetimepicker-toggle\" [for]=\"maxDatetimePicker\" matSuffix></mat-datetimepicker-toggle>\r\n        <mat-datetimepicker #maxDatetimePicker type=\"{{type}}\" openOnFocus=\"true\" timeInterval=\"5\"></mat-datetimepicker>\r\n        <input matInput autocomplete=\"false\"\r\n          placeholder=\"{{'igo.geo.timeFilter.endDate' | translate}}\"\r\n          [matDatetimepicker]=\"maxDatetimePicker\"\r\n          [(ngModel)]=\"endDate\"\r\n          [min]=\"getRangeMinDate()\"\r\n          [max]=\"max\"\r\n          readonly=\"readonly\"\r\n          (dateChange)=\"handleDateChange($event)\">\r\n      </mat-form-field>\r\n    </div>\r\n  </div>\r\n</div>\r\n\r\n<div *ngIf=\"style === 'calendar' && type ==='year'\">\r\n\r\n  <div *ngIf=\"!isRange\" class=\"igo-col igo-col-100 igo-col-100-m\">\r\n        <mat-form-field>\r\n            <mat-select placeholder=\"{{'igo.geo.timeFilter.date' | translate}}\" [(ngModel)]=\"year\" (selectionChange)=\"handleYearChange($event)\">\r\n                  <mat-option [value]=\"year\" *ngFor=\"let year of listYears\">{{year}}</mat-option>\r\n            </mat-select>\r\n        </mat-form-field>\r\n  </div>\r\n\r\n  <div *ngIf=\"isRange\">\r\n    <div class=\"igo-col igo-col-100\">\r\n        <mat-form-field>\r\n            <mat-select placeholder=\"{{'igo.geo.timeFilter.startDate' | translate}}\" [(ngModel)]=\"startYear\" (selectionChange)=\"handleYearChange($event)\">\r\n              <mat-option [value]=\"startYear\" *ngFor=\"let startYear of startListYears\">{{startYear}}</mat-option>\r\n            </mat-select>\r\n      </mat-form-field>\r\n    </div>\r\n\r\n    <div class=\"igo-col igo-col-100\">\r\n    <mat-form-field>\r\n        <mat-select placeholder=\"{{'igo.geo.timeFilter.endDate' | translate}}\" [(ngModel)]=\"endYear\" (selectionChange)=\"handleYearChange($event)\">\r\n              <mat-option [value]=\"endYear\" *ngFor=\"let endYear of endListYears\">{{endYear}}</mat-option>\r\n        </mat-select>\r\n      </mat-form-field>\r\n    </div>\r\n  </div>\r\n\r\n</div>\r\n\r\n\r\n  <br>\r\n  <div *ngIf=\"!isRange && style === 'slider' && type === 'year'\" class=\"igo-col igo-col-100 igo-col-100-m mat-typography\">\r\n    <span>{{startYear}}</span>\r\n    <mat-slider\r\n        id=\"time-slider\"\r\n        tickInterval=\"auto\"\r\n        step=\"{{step}}\"\r\n        [min]=\"startYear\"\r\n        [max]=\"endYear\"\r\n        [value]=\"handleSliderValue()\"\r\n        [color]=\"color\"\r\n        thumbLabel\r\n        (input)=\"handleSliderYearChange($event)\"\r\n        (change)=\"handleSliderYearChange($event)\"\r\n        [disabled]= \"!options.enabled || !layer.visible\">\r\n    </mat-slider>\r\n    <span>{{endYear}}</span>\r\n    <p *ngIf= \"options.enabled\" class=\"date-below\">{{year}}</p>\r\n    <div #actions class=\"igo-layer-actions-container\">\r\n      <mat-slide-toggle (change)=\"toggleFilterState()\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.geo.filter.toggleFilterState' | translate\" [color]=\"color\" [checked]=\"options.enabled\"\r\n        [disabled]=\"!layer.visible\">\r\n      </mat-slide-toggle>\r\n      <button [disabled]= \"!options.enabled  || !layer.visible\" mat-icon-button color=\"primary\" (click)=\"playYear($event)\">\r\n        <mat-icon svgIcon=\"{{playIcon}}\"></mat-icon>\r\n       </button>\r\n      <button [disabled]=\"!options.enabled  || !layer.visible\" mat-icon-button color=\"primary\" (click)=\"resetFilter($event)\">\r\n        <mat-icon svgIcon=\"{{resetIcon}}\"></mat-icon>\r\n      </button>\r\n    </div>\r\n  </div>\r\n\r\n<div *ngIf=\"style === 'slider' && type !== 'year'\" class=\"igo-col igo-col-100 igo-col-100-m\">\r\n  <mat-slider\r\n      id=\"time-slider\"\r\n      tickInterval=\"auto\"\r\n      step=\"{{step}}\"\r\n      [min]=\"dateToNumber(min)\"\r\n      [max]=\"dateToNumber(max)\"\r\n      [value]=\"handleSliderValue()\"\r\n      thumbLabel\r\n      (input)=\"handleSliderDateChange($event)\"\r\n      (selectionChange)=\"handleSliderDateChange($event)\">\r\n  </mat-slider>\r\n  <p class=\"date-below\">{{handleSliderTooltip()}}</p>\r\n  <button mat-icon-button color=\"primary\" (click)=\"playFilter($event)\">\r\n   <mat-icon svgIcon=\"{{playIcon}}\"></mat-icon>\r\n  </button>\r\n</div>\r\n","import {\r\n  Component,\r\n  OnInit,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ViewChild\r\n} from '@angular/core';\r\nimport { DateAdapter } from '@angular/material/core';\r\nimport { MatSlider } from '@angular/material/slider';\r\nimport { default as moment } from 'moment';\r\nimport olSourceImageWMS from 'ol/source/ImageWMS';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { TimeFilterOptions } from '../shared/time-filter.interface';\r\nimport { TimeFilterType, TimeFilterStyle } from '../shared/time-filter.enum';\r\n\r\n@Component({\r\n  selector: 'igo-time-filter-form',\r\n  templateUrl: './time-filter-form.component.html',\r\n  styleUrls: ['./time-filter-form.component.scss']\r\n})\r\nexport class TimeFilterFormComponent implements OnInit {\r\n  @Input() layer: Layer;\r\n\r\n  @Input() options: TimeFilterOptions;\r\n\r\n  public color = 'primary';\r\n  public date: Date;\r\n  public startDate: Date;\r\n  public endDate: Date;\r\n  public year: any;\r\n  public startYear: any;\r\n  public endYear: any;\r\n  public initStartYear: any;\r\n  public initEndYear: any;\r\n  public listYears: Array<string> = [];\r\n  public startListYears: Array<string> = [];\r\n  public endListYears: Array<string> = [];\r\n\r\n  @Input()\r\n  set currentValue(value: string) {\r\n    if (value) {\r\n      if (this.type !== TimeFilterType.YEAR) {\r\n        const valueArray = value.split('/');\r\n        if (valueArray.length > 0) {\r\n          const startDate = new Date(valueArray[0]);\r\n          const endDate = new Date(valueArray[1]);\r\n          if (!isNaN(startDate.valueOf())) {\r\n            this.startDate = startDate;\r\n          }\r\n          if (!isNaN(endDate.valueOf())) {\r\n            this.endDate = endDate;\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  public interval: any;\r\n  public playIcon = 'play-circle';\r\n  public resetIcon = 'replay';\r\n\r\n  @Output() change: EventEmitter<Date | [Date, Date]> = new EventEmitter();\r\n  @Output()\r\n  yearChange: EventEmitter<string | [string, string]> = new EventEmitter();\r\n  @ViewChild(MatSlider) mySlider;\r\n\r\n  get type(): TimeFilterType {\r\n    return this.options.type === undefined\r\n      ? TimeFilterType.DATE\r\n      : this.options.type;\r\n  }\r\n\r\n  get isRange(): boolean {\r\n    return this.options.range === undefined ||\r\n      this.options.style === TimeFilterStyle.SLIDER\r\n      ? false\r\n      : this.options.range;\r\n  }\r\n\r\n  get style(): TimeFilterStyle {\r\n    return this.options.style === undefined\r\n      ? TimeFilterStyle.SLIDER\r\n      : this.options.style;\r\n  }\r\n\r\n  get step(): number {\r\n    let step = 10800000;\r\n    if (this.options.step === undefined) {\r\n      switch (this.type) {\r\n        case TimeFilterType.DATE:\r\n        case TimeFilterType.DATETIME:\r\n          step = 10800000;\r\n          break;\r\n        case TimeFilterType.TIME:\r\n          step = 3600000;\r\n          break;\r\n        case TimeFilterType.YEAR:\r\n          step = 31536000000;\r\n          break;\r\n        default:\r\n          step = 10800000;\r\n      }\r\n    } else {\r\n      step = this.getStepDefinition(this.options.step);\r\n    }\r\n\r\n    return step;\r\n  }\r\n\r\n  get timeInterval(): number {\r\n    return this.options.timeInterval === undefined\r\n      ? 2000\r\n      : this.options.timeInterval;\r\n  }\r\n\r\n  get min(): Date {\r\n    if (this.options.min) {\r\n      const min = new Date(this.options.min);\r\n      return new Date(min.getTime() + min.getTimezoneOffset() * 60000);\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  get max(): Date {\r\n    if (this.options.max) {\r\n      const max = new Date(this.options.max);\r\n      return new Date(max.getTime() + max.getTimezoneOffset() * 60000);\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  get is(): boolean {\r\n    return this.options.range === undefined ? false : this.options.range;\r\n  }\r\n\r\n  constructor(private dateAdapter: DateAdapter<Date>) {\r\n    this.dateAdapter.setLocale('fr');\r\n  }\r\n\r\n  ngOnInit() {\r\n    if (this.startDate === undefined) {\r\n      this.startDate = new Date(this.min);\r\n    }\r\n    if (this.endDate === undefined) {\r\n      this.endDate = new Date(this.max);\r\n    }\r\n    if (this.startYear === undefined) {\r\n      this.startYear = new Date(this.startDate).getFullYear();\r\n      this.initStartYear = this.startYear;\r\n    }\r\n    if (this.endYear === undefined) {\r\n      this.endYear = new Date(this.endDate).getFullYear();\r\n      this.initEndYear = this.endYear;\r\n    }\r\n\r\n    if (!this.isRange) {\r\n      for (let i = this.startYear; i <= this.endYear + 1; i++) {\r\n        this.listYears.push(i);\r\n      }\r\n    } else {\r\n      for (let i = this.startYear; i < this.endYear; i++) {\r\n        this.startListYears.push(i);\r\n      }\r\n      for (let i = this.startYear + 1; i <= this.endYear; i++) {\r\n        this.endListYears.push(i);\r\n      }\r\n    }\r\n    this.options.enabled =\r\n      this.options.enabled === undefined ? true : this.options.enabled;\r\n    this.checkFilterValue();\r\n    if (this.options.enabled) {\r\n      if (!this.isRange && this.style === 'slider' && this.type === 'year') {\r\n        this.yearChange.emit(this.year);\r\n      }\r\n    } else {\r\n      this.storeCurrentFilterValue();\r\n      this.yearChange.emit(undefined); // TODO: FIX THIS for ALL OTHER TYPES STYLES OR RANGE.\r\n    }\r\n  }\r\n\r\n  storeCurrentFilterValue() {\r\n    // TODO: FIX THIS for ALL OTHER TYPES STYLES OR RANGE.\r\n    if (\r\n      !this.isRange &&\r\n      this.style === TimeFilterStyle.SLIDER &&\r\n      this.type === TimeFilterType.YEAR\r\n    ) {\r\n      this.options.value = this.year.toString();\r\n    }\r\n  }\r\n\r\n  checkFilterValue() {\r\n    const olSource = this.layer.dataSource.ol as olSourceImageWMS;\r\n    const timeFromWms = olSource.getParams().TIME;\r\n    if (\r\n      !this.isRange &&\r\n      this.style === TimeFilterStyle.SLIDER &&\r\n      this.type === TimeFilterType.YEAR\r\n    ) {\r\n      if (timeFromWms) {\r\n        this.year = new Date(timeFromWms.toString()).getFullYear() + 1;\r\n      } else if (this.options.value) {\r\n        this.year = new Date(this.options.value.toString()).getFullYear() + 1;\r\n      } else {\r\n        this.year = new Date(this.min).getFullYear() + 1;\r\n      }\r\n    } else if (\r\n      this.isRange &&\r\n      this.style === TimeFilterStyle.CALENDAR &&\r\n      this.type === TimeFilterType.YEAR\r\n    ) {\r\n      if (timeFromWms) {\r\n        this.startYear = parseInt(timeFromWms.substr(0, 4), 10);\r\n        this.endYear = parseInt(timeFromWms.substr(5, 4), 10);\r\n        const newStartListYears: any[] = [];\r\n        const newEndListYears: any[] = [];\r\n        for (let i = this.initStartYear; i < this.endYear; i++) {\r\n          newStartListYears.push(i);\r\n        }\r\n        for (let i = this.startYear + 1; i <= this.initEndYear; i++) {\r\n          newEndListYears.push(i);\r\n        }\r\n        this.startListYears = newStartListYears;\r\n        this.endListYears = newEndListYears;\r\n      }\r\n    }\r\n    // TODO: FIX THIS for ALL OTHER TYPES STYLES OR RANGE.\r\n  }\r\n\r\n  handleDateChange(event: any) {\r\n    this.setupDateOutput();\r\n    this.applyTypeChange();\r\n\r\n    // Only if is range, use 2 dates to make the range\r\n    if (this.isRange) {\r\n      this.change.emit([this.startDate, this.endDate]);\r\n    } else {\r\n      this.change.emit(this.startDate);\r\n    }\r\n  }\r\n\r\n  handleYearChange(event: any) {\r\n    if (this.isRange) {\r\n      this.endListYears = [];\r\n      for (let i = this.startYear + 1; i <= this.initEndYear; i++) {\r\n        this.endListYears.push(i);\r\n      }\r\n      this.startListYears = [];\r\n      for (let i = this.initStartYear + 1; i < this.endYear; i++) {\r\n        this.startListYears.push(i);\r\n      }\r\n      this.yearChange.emit([this.startYear, this.endYear]);\r\n    } else {\r\n      this.yearChange.emit(this.year);\r\n    }\r\n  }\r\n\r\n  handleListYearChange(event: any) {\r\n    this.handleYearChange([this.startYear, this.endYear]);\r\n  }\r\n\r\n  handleListYearStartChange(event: any) {\r\n    this.change.emit([this.startDate, this.endDate]);\r\n  }\r\n\r\n  dateToNumber(date: Date): number {\r\n    let newDate;\r\n    if (date) {\r\n      newDate = new Date(date);\r\n    } else {\r\n      newDate = new Date(this.min);\r\n    }\r\n\r\n    return newDate.getTime();\r\n  }\r\n\r\n  setSliderThumbLabel(label: string) {\r\n    const thumbLabel = this.findThumbLabel(\r\n      this.mySlider._elementRef.nativeElement.childNodes\r\n    );\r\n    if (thumbLabel) {\r\n      thumbLabel.textContent = label;\r\n    }\r\n  }\r\n\r\n  findThumbLabel(test: any[]): any {\r\n    let thumbLabel;\r\n\r\n    test.forEach(value => {\r\n      if (value.className === 'mat-slider-thumb-label-text') {\r\n        thumbLabel = value;\r\n      }\r\n\r\n      if (value.children.length > 0 && !thumbLabel) {\r\n        thumbLabel = this.findThumbLabel(value.childNodes);\r\n      }\r\n    }, this);\r\n    return thumbLabel;\r\n  }\r\n\r\n  toggleFilterState() {\r\n    this.options.enabled = !this.options.enabled;\r\n\r\n    if (this.options.enabled) {\r\n      if (\r\n        !this.isRange &&\r\n        TimeFilterStyle.SLIDER &&\r\n        this.type === TimeFilterType.YEAR\r\n      ) {\r\n        this.yearChange.emit(this.year);\r\n      }\r\n    } else {\r\n      this.stopFilter();\r\n      this.storeCurrentFilterValue();\r\n      this.change.emit(undefined); // TODO: FIX THIS for ALL OTHER TYPES STYLES OR RANGE.\r\n    }\r\n  }\r\n\r\n  resetFilter(event: any) {\r\n    this.date = new Date(this.min);\r\n    this.year = this.date.getFullYear();\r\n    if (\r\n      !this.isRange &&\r\n      TimeFilterStyle.SLIDER &&\r\n      this.type === TimeFilterType.YEAR\r\n    ) {\r\n      this.yearChange.emit(this.year);\r\n    } else {\r\n      this.setupDateOutput();\r\n      this.change.emit(undefined); // TODO: FIX THIS for ALL OTHER TYPES STYLES OR RANGE.\r\n    }\r\n  }\r\n\r\n  playFilter(event: any) {\r\n    if (this.interval) {\r\n      this.stopFilter();\r\n    } else {\r\n      this.playIcon = 'pause-circle';\r\n      this.interval = setInterval(\r\n        that => {\r\n          let newMinDateNumber;\r\n          const maxDateNumber = new Date(that.max);\r\n\r\n          newMinDateNumber =\r\n            that.date === undefined ? that.min.getTime() : that.date.getTime();\r\n          newMinDateNumber += that.mySlider.step;\r\n          that.date = new Date(newMinDateNumber);\r\n\r\n          if (newMinDateNumber > maxDateNumber.getTime()) {\r\n            that.stopFilter();\r\n          }\r\n\r\n          that.handleDateChange({ value: that.date, date: that.date });\r\n        },\r\n        this.timeInterval,\r\n        this\r\n      );\r\n    }\r\n  }\r\n\r\n  playYear(event: any) {\r\n    if (\r\n      this.year + this.mySlider.step >\r\n      this.max.getFullYear() + this.mySlider.step\r\n    ) {\r\n      this.stopFilter();\r\n      this.resetFilter(event);\r\n    }\r\n    if (this.interval) {\r\n      this.stopFilter();\r\n    } else {\r\n      this.playIcon = 'pause-circle';\r\n      this.interval = setInterval(() => {\r\n        if (\r\n          (this.year + this.mySlider.step) > this.max.getFullYear()) {\r\n          this.stopFilter();\r\n        } else {\r\n          this.year = this.year + this.mySlider.step;\r\n        }\r\n        this.yearChange.emit(this.year);\r\n\r\n      }, this.timeInterval, this);\r\n    }\r\n  }\r\n\r\n  stopFilter() {\r\n    if (this.interval) {\r\n      clearInterval(this.interval);\r\n    }\r\n    this.interval = undefined;\r\n    this.playIcon = 'play-circle';\r\n  }\r\n\r\n  handleSliderDateChange(event: any) {\r\n    this.date = new Date(event.value);\r\n    this.setSliderThumbLabel(this.handleSliderTooltip());\r\n    this.handleDateChange(event);\r\n  }\r\n\r\n  handleSliderYearChange(event: any) {\r\n    this.year = event.value;\r\n    this.yearChange.emit(this.year);\r\n  }\r\n\r\n  handleSliderValue(): number {\r\n    if (this.options.current === true || !this.min) {\r\n      const currentDate = new Date();\r\n      this.date = this.getRoundedDate(currentDate);\r\n    }\r\n    if (this.type === TimeFilterType.YEAR) {\r\n      return this.year;\r\n    } else {\r\n      return this.date === undefined ? this.min.getTime() : this.date.getTime();\r\n    }\r\n  }\r\n\r\n  handleSliderTooltip() {\r\n    let label: string;\r\n\r\n    switch (this.type) {\r\n      case TimeFilterType.DATE:\r\n        label =\r\n          this.date === undefined\r\n            ? this.min.toDateString()\r\n            : this.date.toDateString();\r\n        break;\r\n      case TimeFilterType.TIME:\r\n        label =\r\n          this.date === undefined\r\n            ? this.min.toTimeString()\r\n            : this.date.toTimeString();\r\n        break;\r\n      // datetime\r\n      default:\r\n        label =\r\n          this.date === undefined\r\n            ? this.min.toUTCString()\r\n            : this.date.toUTCString();\r\n        break;\r\n    }\r\n\r\n    return label;\r\n  }\r\n\r\n  setupDateOutput() {\r\n    if (this.style === TimeFilterStyle.SLIDER) {\r\n      this.startDate = new Date(this.date);\r\n      this.startDate.setSeconds(-(this.step / 1000));\r\n      this.endDate = new Date(this.startDate);\r\n      this.endDate.setSeconds(this.step / 1000);\r\n    } else if (!this.isRange && !!this.date) {\r\n      this.endDate = new Date(this.date);\r\n      this.startDate = new Date(this.date);\r\n    } else if (this.isRange && (!!this.date || !this.date)) {\r\n      this.startDate =\r\n        this.startDate === undefined ? new Date(this.min) : this.startDate;\r\n      this.endDate =\r\n        this.endDate === undefined ? new Date(this.max) : this.endDate;\r\n    } else if (!this.date) {\r\n      this.startDate =\r\n        this.startDate === undefined ? new Date(this.min) : this.startDate;\r\n      this.endDate =\r\n        this.endDate === undefined ? new Date(this.max) : this.endDate;\r\n    }\r\n  }\r\n\r\n  applyTypeChange() {\r\n    switch (this.type) {\r\n      case TimeFilterType.DATE:\r\n        if (this.startDate !== undefined || this.endDate !== undefined) {\r\n          this.startDate.setHours(0);\r\n          this.startDate.setMinutes(0);\r\n          this.startDate.setSeconds(0);\r\n          this.endDate.setHours(23);\r\n          this.endDate.setMinutes(59);\r\n          this.endDate.setSeconds(59);\r\n        }\r\n        break;\r\n      case TimeFilterType.TIME:\r\n        if (this.style === TimeFilterStyle.CALENDAR) {\r\n          if (this.startDate.getDay() !== this.min.getDay()) {\r\n            const selectedHour = this.startDate.getHours();\r\n            const selectedMinute = this.startDate.getMinutes();\r\n            this.startDate = this.min;\r\n            this.startDate.setHours(selectedHour);\r\n            this.startDate.setMinutes(selectedMinute);\r\n          }\r\n\r\n          if (this.endDate.getDay() !== this.min.getDay()) {\r\n            const selectedHour = this.endDate.getHours();\r\n            const selectedMinute = this.endDate.getMinutes();\r\n            this.endDate = this.min;\r\n            this.endDate.setHours(selectedHour);\r\n            this.endDate.setMinutes(selectedMinute);\r\n          }\r\n        }\r\n\r\n        if (!this.isRange && this.step > 60 * 60 * 1000) {\r\n          this.startDate.setMinutes(0);\r\n          this.startDate.setSeconds(0);\r\n          this.endDate.setMinutes(59);\r\n          this.endDate.setSeconds(59);\r\n        }\r\n        break;\r\n      // datetime\r\n      default:\r\n      // do nothing\r\n    }\r\n  }\r\n\r\n  getRangeMinDate(): Date {\r\n    return this.startDate === undefined ? this.min : this.startDate;\r\n  }\r\n\r\n  getRangeMaxDate(): Date {\r\n    return this.endDate === undefined ? this.max : this.endDate;\r\n  }\r\n\r\n  /**\r\n   * Round date at a certain time, 10 minutes by Default\r\n   * @param date - Date to Round\r\n   * @param atMinute - round to closest 'atMinute' minute, rounded 10 by default\r\n   * @return the rounded date\r\n   */\r\n  getRoundedDate(date, atMinute = 10) {\r\n    const coeff = 1000 * 60 * atMinute;\r\n    return new Date(Math.round(date.getTime() / coeff) * coeff);\r\n  }\r\n\r\n  /**\r\n   * Get the step (period) definition from the layer dimension tag\r\n   * @param step The step as ISO 8601 example: PT10M for 10 Minutes\r\n   * @return the duration in milliseconds\r\n   */\r\n  getStepDefinition(step) {\r\n    return moment.duration(step).asMilliseconds();\r\n  }\r\n}\r\n","<mat-list-item *ngIf=\"header\">\r\n  <mat-icon\r\n    class=\"igo-chevron\"\r\n    mat-list-avatar\r\n    igoCollapse\r\n    [target]=\"filters\"\r\n    [collapsed]=\"filtersCollapsed\"\r\n    (click)=\"toggleFiltersCollapsed()\"\r\n    svgIcon=\"chevron-up\" >\r\n  </mat-icon>\r\n  <h4 (click)=\"toggleLegendOnClick()\" [ngStyle]=\"{'cursor': filtersCollapsed ? 'default' : 'pointer'}\"  matLine>{{layer.title}}</h4>\r\n  \r\n  <button *ngIf=\"header\"\r\n    mat-icon-button\r\n    [color]=\"layer.visible ? 'primary' : 'default'\"\r\n    collapsibleButton\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"layer.visible ?\r\n                  ('igo.geo.layer.hideLayer' | translate) :\r\n                  ('igo.geo.layer.showLayer' | translate)\"\r\n    (click)=\"layer.visible = !layer.visible\">\r\n    <mat-icon\r\n      [ngClass]=\"{disabled: (inResolutionRange$ | async)===false}\"\r\n      [svgIcon]=\"layer.visible ? 'eye' : 'eye-off'\">\r\n    </mat-icon>\r\n  </button>\r\n\r\n</mat-list-item>\r\n\r\n<div #filters class=\"igo-datasource-filters-container\">\r\n  <div #legend class=\"igo-layer-legend-container\">\r\n    <igo-layer-legend *ngIf=\"showLegend$ | async\" [layer]=\"layer\">\r\n    </igo-layer-legend>\r\n  </div>\r\n  <igo-time-filter-form\r\n    [layer]= \"layer\"\r\n    [options]=\"datasource.options.timeFilter\"\r\n    [currentValue]=\"datasource.options.params.TIME\"\r\n    (change)=\"handleDateChange($event)\"\r\n    (yearChange)=\"handleYearChange($event)\">\r\n  </igo-time-filter-form>\r\n</div>\r\n","import { Component, Input, OnDestroy, OnInit } from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { TimeFilterableDataSource } from '../shared/time-filter.interface';\r\nimport { TimeFilterService } from '../shared/time-filter.service';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'igo-time-filter-item',\r\n  templateUrl: './time-filter-item.component.html',\r\n  styleUrls: ['./time-filter-item.component.scss']\r\n})\r\nexport class TimeFilterItemComponent implements OnInit, OnDestroy {\r\n  public color = 'primary';\r\n  showLegend$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  inResolutionRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n  private resolution$$: Subscription;\r\n\r\n  filtersCollapsed: boolean = false;\r\n\r\n  @Input() header: boolean = true;\r\n\r\n  @Input() layer: Layer;\r\n\r\n  get datasource(): TimeFilterableDataSource {\r\n    return this.layer.dataSource as TimeFilterableDataSource;\r\n  }\r\n  constructor(private timeFilterService: TimeFilterService) {}\r\n\r\n  ngOnInit(): void {\r\n    const resolution$ = this.layer.map.viewController.resolution$;\r\n    this.resolution$$ = resolution$.subscribe(() => {\r\n      this.inResolutionRange$.next(this.layer.isInResolutionsRange);\r\n    });\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this.resolution$$.unsubscribe();\r\n  }\r\n\r\n  handleYearChange(year: string | [string, string]) {\r\n    this.timeFilterService.filterByYear(this.datasource, year);\r\n  }\r\n\r\n  handleDateChange(date: Date | [Date, Date]) {\r\n    this.timeFilterService.filterByDate(this.datasource, date);\r\n  }\r\n\r\n  private toggleLegend(collapsed: boolean) {\r\n    this.layer.legendCollapsed = collapsed;\r\n    this.showLegend$.next(!collapsed);\r\n  }\r\n\r\n  toggleLegendOnClick() {\r\n    if (!this.filtersCollapsed) {\r\n      this.toggleLegend(this.showLegend$.value);\r\n    }\r\n  }\r\n\r\n  public setVisible() {\r\n    this.layer.visible = true;\r\n  }\r\n\r\n  toggleFiltersCollapsed() {\r\n    this.filtersCollapsed = !this.filtersCollapsed;\r\n  }\r\n}\r\n","<igo-list [navigation]=\"false\" [selection]=\"false\">\r\n  <ng-template ngFor let-layer [ngForOf]=\"layers | filterableDataSource: 'time'\">\r\n    <igo-time-filter-item [header]=\"true\" igoListItem [layer]=\"layer\"></igo-time-filter-item>\r\n  </ng-template>\r\n</igo-list>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\n\r\n@Component({\r\n  selector: 'igo-time-filter-list',\r\n  templateUrl: './time-filter-list.component.html',\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class TimeFilterListComponent {\r\n  @Input()\r\n  get layers(): Layer[] {\r\n    return this._layers;\r\n  }\r\n  set layers(value: Layer[]) {\r\n    this._layers = value;\r\n    this.cdRef.detectChanges();\r\n  }\r\n  private _layers: Layer[] = [];\r\n\r\n  constructor(private cdRef: ChangeDetectorRef) {}\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport * as olproj from 'ol/proj';\r\nimport olWKT from 'ol/format/WKT';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class WktService {\r\n  constructor() {}\r\n\r\n  public wktToFeature(wkt, wktProj, featureProj) {\r\n    return new olWKT().readFeature(wkt, {\r\n      dataProjection: wktProj,\r\n      featureProjection: featureProj\r\n    });\r\n  }\r\n  public extentToWkt(epsgTO, extent, extentProj) {\r\n    let currentExtent = olproj.transformExtent(extent, extentProj, epsgTO);\r\n    currentExtent = this.roundCoordinateArray(currentExtent, epsgTO, 0);\r\n    const wktPoly = `POLYGON((\r\n      ${extent[0]} ${extent[1]},\r\n      ${extent[0]} ${extent[3]},\r\n      ${extent[2]} ${extent[3]},\r\n      ${extent[2]} ${extent[1]},\r\n      ${extent[0]} ${extent[1]}))`;\r\n    const wktLine = `LINESTRING(\r\n      ${extent[0]} ${extent[1]},\r\n      ${extent[0]} ${extent[3]},\r\n      ${extent[2]} ${extent[3]},\r\n      ${extent[2]} ${extent[1]},\r\n      ${extent[0]} ${extent[1]})`;\r\n    const wktMultiPoints = `MULTIPOINT(\r\n        ${extent[0]} ${extent[1]},\r\n        ${extent[0]} ${extent[3]},\r\n        ${extent[2]} ${extent[3]},\r\n        ${extent[2]} ${extent[1]})`;\r\n    return {\r\n      wktPoly,\r\n      wktLine,\r\n      wktMultiPoints\r\n    };\r\n  }\r\n\r\n  private roundCoordinateArray(coordinateArray, projection, decimal = 0) {\r\n    const lproj = olproj.get(projection);\r\n    const units = lproj.getUnits();\r\n    const olUnits = ['ft', 'm', 'us-ft'];\r\n    if (olUnits.indexOf(units) !== -1) {\r\n      coordinateArray = this.roundArray(coordinateArray, decimal);\r\n    }\r\n    return coordinateArray;\r\n  }\r\n\r\n  private roundArray(array, decimal = 0) {\r\n    let x = 0;\r\n    while (x < array.length) {\r\n      array[x] = array[x].toFixed(decimal);\r\n      x++;\r\n    }\r\n    return array;\r\n  }\r\n\r\n  public snrcToWkt(snrc, epsgTO) {\r\n    snrc = snrc.toLowerCase();\r\n    let wktPoly;\r\n    const ew = {\r\n      1: { from: -56, to: -64 },\r\n      2: { from: -64, to: -72 },\r\n      3: { from: -72, to: -80 },\r\n      4: { from: -80, to: -88 },\r\n      5: { from: -88, to: -96 },\r\n      6: { from: -96, to: -104 },\r\n      7: { from: -104, to: -112 },\r\n      8: { from: -112, to: -120 },\r\n      9: { from: -120, to: -128 },\r\n      10: { from: -128, to: -136 }\r\n    };\r\n    const sn = {\r\n      1: { from: 44, to: 48 },\r\n      2: { from: 48, to: 52 },\r\n      3: { from: 52, to: 56 },\r\n      4: { from: 56, to: 60 },\r\n      5: { from: 60, to: 64 },\r\n      6: { from: 64, to: 68 },\r\n      7: { from: 68, to: 72 },\r\n      8: { from: 72, to: 76 },\r\n      9: { from: 76, to: -128 }\r\n    };\r\n    const snrc250kIndex = [\r\n      ['m', 'n', 'o', 'p'],\r\n      ['l', 'k', 'j', 'i'],\r\n      ['e', 'f', 'g', 'h'],\r\n      ['d', 'c', 'b', 'a']\r\n    ];\r\n\r\n    const snrc50kIndex = [\r\n      ['13', '14', '15', '16'],\r\n      ['12', '11', '10', '09'],\r\n      ['05', '06', '07', '08'],\r\n      ['04', '03', '02', '01']\r\n    ];\r\n    const checkSNRC50k = /\\d{2,3}[a-p][0,1][0-9]/gi;\r\n    const checkSNRC250k = /\\d{2,3}[a-p]/gi;\r\n    const checkSNRC1m = /\\d{2,3}/gi;\r\n\r\n    let snrc1m = false;\r\n    let snrc250k = false;\r\n    let snrc50k = false;\r\n\r\n    if (checkSNRC50k.test(snrc)) {\r\n      snrc50k = true;\r\n    } else {\r\n      if (checkSNRC250k.test(snrc)) {\r\n        snrc250k = true;\r\n      } else {\r\n        if (checkSNRC1m.test(snrc)) {\r\n          snrc1m = true;\r\n        }\r\n      }\r\n    }\r\n\r\n    if (snrc1m) {\r\n      snrc += 'a01';\r\n    } else if (snrc250k) {\r\n      snrc += '01';\r\n    }\r\n    if (/\\d{2,3}[a-p][0,1][0-9]/gi.test(snrc)) {\r\n      const regex1m = /(?=[a-p])/gi;\r\n      const ar1m = snrc.split(regex1m);\r\n      const part1m = ar1m[0];\r\n      const part250k = ar1m[1][0];\r\n      const part50k = ar1m[1].split(part250k)[1];\r\n      let separator = 1;\r\n      if (part1m.length === 3) {\r\n        separator = 2;\r\n      }\r\n      const partEW = part1m.substring(0, separator);\r\n      const partSN = part1m.substring(separator);\r\n      const unit1mEW = 8;\r\n      const unit1mSN = 4;\r\n      const unit250kEW = 2;\r\n      const unit250kSN = 1;\r\n      const unit50kEW = 0.5;\r\n      const unit50kSN = 0.25;\r\n      let index250kEW = 0;\r\n      let index250kSN = 0;\r\n      let index50kEW = 0;\r\n      let index50kSN = 0;\r\n      snrc250kIndex.forEach(element => {\r\n        if (element.indexOf(part250k) !== -1) {\r\n          index250kSN = snrc250kIndex.indexOf(element);\r\n          index250kEW = element.indexOf(part250k);\r\n        }\r\n      });\r\n      snrc50kIndex.forEach(element => {\r\n        if (element.indexOf(part50k) !== -1) {\r\n          index50kSN = snrc50kIndex.indexOf(element);\r\n          index50kEW = element.indexOf(part50k);\r\n        }\r\n      });\r\n\r\n      let increment250kEW = 0;\r\n      let increment250kSN = 0;\r\n      let increment50kEW = 0;\r\n      let increment50kSN = 0;\r\n      let unitPerTypeEW = unit1mEW;\r\n      let unitPerTypeSN = unit1mSN;\r\n      if (snrc250k) {\r\n        increment250kEW = index250kEW * unit250kEW;\r\n        increment250kSN = index250kSN * unit250kSN;\r\n        increment50kEW = 0;\r\n        increment50kSN = 0;\r\n        unitPerTypeEW = unit250kEW;\r\n        unitPerTypeSN = unit250kSN;\r\n      } else if (snrc50k) {\r\n        increment250kEW = index250kEW * unit250kEW;\r\n        increment250kSN = index250kSN * unit250kSN;\r\n        increment50kEW = index50kEW * unit50kEW;\r\n        increment50kSN = index50kSN * unit50kSN;\r\n        unitPerTypeEW = unit50kEW;\r\n        unitPerTypeSN = unit50kSN;\r\n      }\r\n\r\n      const coord: {ul?: any, lr?: any, ur?: any, ll?: any} = {\r\n        ul: [\r\n          ew[partEW].to + increment250kEW + increment50kEW,\r\n          sn[partSN].to - increment250kSN - increment50kSN\r\n        ]\r\n      };\r\n\r\n      coord.lr = [\r\n        coord.ul[0] + unitPerTypeEW,\r\n        coord.ul[1] - unitPerTypeSN\r\n      ];\r\n      coord.ur = [coord.ul[0], coord.ul[1] - unitPerTypeSN];\r\n      coord.ll = [coord.ul[0] + unitPerTypeEW, coord.ul[1]];\r\n\r\n      coord.ul = olproj.transform(\r\n        [coord.ul[0], coord.ul[1]],\r\n        'EPSG:4326',\r\n        epsgTO\r\n      );\r\n      coord.lr = olproj.transform(\r\n        [coord.lr[0], coord.lr[1]],\r\n        'EPSG:4326',\r\n        epsgTO\r\n      );\r\n      coord.ur = olproj.transform(\r\n        [coord.ur[0], coord.ur[1]],\r\n        'EPSG:4326',\r\n        epsgTO\r\n      );\r\n      coord.ll = olproj.transform(\r\n        [coord.ll[0], coord.ll[1]],\r\n        'EPSG:4326',\r\n        epsgTO\r\n      );\r\n\r\n      // Rounded coordinate to shorten url in get\r\n      coord.ul = this.roundCoordinateArray(coord.ul, epsgTO, 0);\r\n      coord.lr = this.roundCoordinateArray(coord.lr, epsgTO, 0);\r\n      coord.ur = this.roundCoordinateArray(coord.ur, epsgTO, 0);\r\n      coord.ll = this.roundCoordinateArray(coord.ll, epsgTO, 0);\r\n\r\n      wktPoly =\r\n        'POLYGON((' +\r\n        [\r\n          coord.ul.join(' '),\r\n          coord.ur.join(' '),\r\n          coord.lr.join(' '),\r\n          coord.ll.join(' '),\r\n          coord.ul.join(' ')\r\n        ].join(',') +\r\n        '))';\r\n      const wktLine =\r\n        'LINESTRING(' +\r\n        [\r\n          coord.ul.join(' '),\r\n          coord.ur.join(' '),\r\n          coord.lr.join(' '),\r\n          coord.ll.join(' '),\r\n          coord.ul.join(' ')\r\n        ].join(',') +\r\n        ')';\r\n\r\n      const wktMultiPoints =\r\n        'MULTIPOINT(' +\r\n        [\r\n          coord.ul.join(' '),\r\n          coord.ur.join(' '),\r\n          coord.lr.join(' '),\r\n          coord.ll.join(' ')\r\n        ].join(',') +\r\n        ')';\r\n      return {\r\n        wktPoly,\r\n        wktLine,\r\n        wktMultiPoints\r\n      };\r\n    }\r\n  }\r\n}\r\n","<mat-checkbox\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.filter.toggleFilterState' | translate\"\r\n  (click)=\"$event.stopPropagation()\"\r\n  (change)=\"toggleFilterState($event)\"\r\n  [checked]=\"currentFilter.active\">\r\n</mat-checkbox>\r\n\r\n<mat-form-field\r\n  [ngClass]=\"{'logical': activeFilters.indexOf(currentFilter) !== 0 && currentFilter.active===true, 'logicalHidden': activeFilters.indexOf(currentFilter) === 0 || currentFilter.active!==true}\">\r\n  <mat-select\r\n    [disabled]=\"!currentFilter.active\"\r\n    [value]=\"currentFilter.parentLogical\"\r\n    tooltip-position=\"above\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"currentFilter.parentLogical ? (('igo.geo.operators.tooltip.'+ currentFilter.parentLogical) | translate) : ''\"\r\n    (selectionChange)=\"changeLogical($event.value)\">\r\n      <mat-option\r\n        [value]=ogcFilterOperator.And\r\n        tooltip-position=\"above\"\r\n        matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.geo.operators.tooltip.And' | translate\">\r\n          {{'igo.geo.operators.And' | translate}}\r\n      </mat-option>\r\n      <mat-option\r\n        [value]=ogcFilterOperator.Or\r\n        tooltip-position=\"above\"\r\n        matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.geo.operators.tooltip.Or' | translate\">\r\n          {{'igo.geo.operators.Or' | translate}}\r\n      </mat-option>\r\n  </mat-select>\r\n</mat-form-field>\r\n\r\n<mat-form-field\r\n  class=\"field\"\r\n  *ngIf=\"(currentFilterIsSpatial$ | async)===false && (fields$ | async) && (fields$| async).length > 0 && (fields$| async)[0].name !== ''\"\r\n  (mouseenter)=\"inputClearable = 'selectField'\"\r\n  (mouseleave)=\"inputClearable = undefined\"\r\n  [floatLabel]=\"floatLabel\">\r\n  <input\r\n  matInput\r\n  [placeholder]=\"'igo.geo.sourceFields.selectField' | translate\"\r\n  [disabled]=\"!currentFilter.active\"\r\n  [matAutocomplete]=\"autoCompleteField\"\r\n  [value]=\"(selectedField$ | async) ? (selectedField$ | async).alias : ''\"\r\n  tooltip-position=\"above\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"(selectedField$ | async) ? (selectedField$ | async).alias : ('igo.geo.sourceFields.selectField' | translate)\"\r\n  (input)=\"updateFieldsList($event.target.value)\">\r\n  <mat-autocomplete #autoCompleteField=\"matAutocomplete\"\r\n  (optionSelected)='changeField($event.option.id)'>\r\n    <mat-option\r\n      *ngFor=\"let field of filteredFields$ | async\"\r\n      matTooltipShowDelay=\"500\"\r\n      [value]=\"field.alias\"\r\n      [id]=\"field.name\"\r\n      [matTooltip]=\"field.alias\">\r\n      {{field.alias}}\r\n    </mat-option>\r\n  </mat-autocomplete>\r\n  <button mat-button\r\n    *ngIf=\"currentFilter.propertyName && inputClearable === 'selectField' && currentFilter.active\"\r\n    matSuffix\r\n    mat-icon-button\r\n    aria-label=\"Clear\"\r\n    [disabled]=\"!currentFilter.active\"\r\n    (click)=\"clearSelectedField()\">\r\n        <mat-icon svgIcon=\"close\"></mat-icon>\r\n  </button>\r\n</mat-form-field>\r\n\r\n\r\n<mat-form-field\r\n  [ngClass]=\"{'operator': (currentFilterIsSpatial$ | async)===false , 'dualInput': (currentFilterIsSpatial$ | async)}\"\r\n  [floatLabel]=\"floatLabel\">\r\n  <mat-select\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"currentFilter.operator ? (('igo.geo.operators.tooltip.'+ currentFilter.operator) | translate) : ('igo.geo.filter.selectOperator' | translate)\"\r\n    [disabled]=\"!currentFilter.active\"\r\n    [value]=\"currentFilter.operator\"\r\n    (selectionChange)=\"changeOperator($event.value)\">\r\n      <mat-option\r\n        *ngFor=\"let operator of (ogcFilterOperators$ | async) | keyvalue\"\r\n        tooltip-position=\"above\"\r\n        matTooltipShowDelay=\"500\"\r\n        [value]=\"operator.key\"\r\n        [matTooltip]=\"('igo.geo.operators.tooltip.'+ operator.key) | translate\">\r\n          {{('igo.geo.operators.'+ operator.key) | translate}}\r\n      </mat-option>\r\n  </mat-select>\r\n</mat-form-field>\r\n\r\n<mat-form-field\r\nclass=\"spatialSelector\"\r\n*ngIf=\"currentFilterIsSpatial$ | async\">\r\n  <mat-select\r\n    [disabled]=\"!currentFilter.active\"\r\n    [value]=\"currentFilter.igoSpatialSelector\"\r\n    (selectionChange)=\"changeSpatialSelector($event.value)\">\r\n      <mat-option\r\n        *ngFor=\"let igoSpatialSelector of igoSpatialSelectors\"\r\n        [value]=\"igoSpatialSelector.type\">\r\n          {{('igo.geo.spatialSelector.'+ igoSpatialSelector.type) | translate}}\r\n      </mat-option>\r\n  </mat-select>\r\n</mat-form-field>\r\n\r\n<mat-form-field\r\nclass=\"singleInput\"\r\n*ngIf=\"['expression','pattern'].indexOf(detectProperty()) !== -1\"\r\n(mouseenter)=\"inputClearable = 'selectProperty'\"\r\n(mouseleave)=\"inputClearable = undefined\"\r\n[floatLabel]=\"floatLabel\">\r\n  <input\r\n    matInput\r\n    [placeholder]=\"'igo.geo.filter.placeholder' | translate\"\r\n    [disabled]=\"!currentFilter.active\"\r\n    [matAutocomplete]=\"autoCompleteValues\"\r\n    [value]=\"detectProperty() === 'expression' ? currentFilter.expression : currentFilter.pattern\"\r\n    tooltip-position=\"above\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"detectProperty() === 'expression' ? currentFilter.expression || '' : currentFilter.pattern || ''\"\r\n    (input)=\"updateValuesList($event.target.value)\">\r\n  <mat-autocomplete #autoCompleteValues=\"matAutocomplete\"\r\n    (optionSelected)=\"changeProperty($event.option.value)\">\r\n    <mat-option\r\n      *ngFor=\"let value of filteredValues$ | async\"\r\n      matTooltipShowDelay=\"500\"\r\n      [value]=\"value\"\r\n      [matTooltip]=\"value\">\r\n      {{value}}\r\n    </mat-option>\r\n  </mat-autocomplete>\r\n  <button mat-button\r\n    *ngIf=\"isClearable() && inputClearable === 'selectProperty' && currentFilter.active\"\r\n    matSuffix\r\n    mat-icon-button\r\n    aria-label=\"Clear\"\r\n    [disabled]=\"!currentFilter.active\"\r\n    (click)=\"clearProperty()\">\r\n        <mat-icon svgIcon=\"close\"></mat-icon>\r\n  </button>\r\n</mat-form-field>\r\n\r\n<div class=\"igo-layer-button-group\">\r\n  <button\r\n    mat-icon-button\r\n    collapsibleButton\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"'igo.geo.filter.removeFilter' | translate\"\r\n    color=\"warn\"\r\n    (click)=\"deleteFilter()\">\r\n    <mat-icon svgIcon=\"delete\"></mat-icon>\r\n  </button>\r\n</div>\r\n\r\n<mat-form-field\r\nclass=\"snrc\"\r\n*ngIf=\"(currentFilterIsSpatial$ | async) && currentFilter.igoSpatialSelector === 'snrc'\"\r\n(mouseenter)=\"inputClearable = 'selectSNRC'\"\r\n(mouseleave)=\"inputClearable = undefined\"\r\n[floatLabel]=\"floatLabel\">\r\n  <input\r\n    matInput\r\n    [placeholder]=\"'igo.geo.filter.placeholderSnrc' | translate\"\r\n    [value]=\"currentFilter.igoSNRC\"\r\n    tooltip-position=\"above\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"currentFilter.igoSNRC ? currentFilter.igoSNRC : ''\"\r\n    (input)=\"changeSNRC($event.target.value)\">\r\n  <button\r\n    mat-button\r\n    *ngIf=\"currentFilter.igoSNRC\"\r\n    matSuffix\r\n    mat-icon-button\r\n    aria-label=\"Clear\"\r\n    [disabled]=\"!currentFilter.active && inputClearable === 'selectSNRC' && currentFilter.active\"\r\n    (click)=\"currentFilter.igoSNRC=''\">\r\n      <mat-icon svgIcon=\"close\"></mat-icon>\r\n  </button>\r\n  </mat-form-field>\r\n\r\n  <ng-container *ngIf=\"(currentFilterIsSpatial$ | async) && currentFilter.igoSpatialSelector === 'fixedExtent'\">\r\n    <button\r\n    mat-button\r\n    [disabled]=\"!currentFilter.active\"\r\n    *ngIf=\"currentFilter.igoSpatialSelector === 'fixedExtent'\"\r\n    matSuffix\r\n    mat-icon-button\r\n    [disabled]=\"!currentFilter.active\"\r\n    (click)=\"changeMapExtentGeometry()\"\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"'igo.geo.spatialSelector.btnSetExtent' | translate\">\r\n      <mat-icon svgIcon=\"arrow-expand-all\"></mat-icon>\r\n  </button>\r\n</ng-container>\r\n\r\n<br/>\r\n\r\n<mat-form-field\r\nclass=\"dualInput\"\r\n*ngIf=\"!isTemporalOperator() && ['lowerBoundary','begin'].indexOf(detectProperty(1)) !== -1\"\r\n(mouseenter)=\"inputClearable = 'selectProperty1'\"\r\n(mouseleave)=\"inputClearable = undefined\"\r\n[floatLabel]=\"floatLabel\">\r\n    <input\r\n      matInput\r\n      [placeholder]=\"'igo.geo.filter.placeholder' | translate\"\r\n      [disabled]=\"!currentFilter.active\"\r\n      [matAutocomplete]=\"autoDualValueOperator1\"\r\n      type=\"number\"\r\n      [value]=\"detectProperty(1) === 'lowerBoundary' ? currentFilter.lowerBoundary : currentFilter.begin\"\r\n      (input)=\"updateValuesList($event.target.value,1)\">\r\n    <mat-autocomplete #autoDualValueOperator1=\"matAutocomplete\"\r\n      (optionSelected)=\"changeNumericProperty($event.option.value,1)\">\r\n      <mat-option\r\n        *ngFor=\"let value of filteredValues$ | async\"\r\n        matTooltipShowDelay=\"500\"\r\n        [value]=\"value\"\r\n        [matTooltip]=\"value\">\r\n        {{value}}\r\n      </mat-option>\r\n    </mat-autocomplete>\r\n    <button mat-button\r\n      *ngIf=\"isClearable(1) && inputClearable === 'selectProperty1' && currentFilter.active\"\r\n      matSuffix\r\n      mat-icon-button\r\n      aria-label=\"Clear\"\r\n    [disabled]=\"!currentFilter.active\"\r\n      (click)=\"clearProperty(1)\">\r\n          <mat-icon svgIcon=\"close\"></mat-icon>\r\n    </button>\r\n</mat-form-field>\r\n\r\n<mat-form-field\r\n  class=\"dualInput\"\r\n  *ngIf=\"!isTemporalOperator() && ['upperBoundary','end'].indexOf(detectProperty(2)) !== -1\"\r\n  (mouseenter)=\"inputClearable = 'selectProperty2'\"\r\n  (mouseleave)=\"inputClearable = undefined\"\r\n  [floatLabel]=\"floatLabel\">\r\n    <input\r\n      matInput\r\n      [placeholder]=\"'igo.geo.filter.placeholder' | translate\"\r\n      [disabled]=\"!currentFilter.active\"\r\n      [matAutocomplete]=\"autoDualValueOperator2\"\r\n      type=\"number\"\r\n      [value]=\"detectProperty(2) === 'upperBoundary' ? currentFilter.upperBoundary : currentFilter.end\"\r\n      (input)=\"updateValuesList($event.target.value,2)\">\r\n    <mat-autocomplete #autoDualValueOperator2=\"matAutocomplete\"\r\n      (optionSelected)=\"changeNumericProperty($event.option.value,2)\">\r\n      <mat-option\r\n        *ngFor=\"let value of filteredValues$ | async\"\r\n        matTooltipShowDelay=\"500\"\r\n        [value]=\"value\"\r\n        [matTooltip]=\"value\">\r\n        {{value}}\r\n      </mat-option>\r\n    </mat-autocomplete>\r\n    <button mat-button\r\n      *ngIf=\"isClearable(2) && inputClearable === 'selectProperty2' && currentFilter.active\"\r\n      matSuffix\r\n      mat-icon-button\r\n      aria-label=\"Clear\"\r\n      [disabled]=\"!currentFilter.active\"\r\n      (click)=\"clearProperty(2)\">\r\n          <mat-icon svgIcon=\"close\"></mat-icon>\r\n    </button>\r\n</mat-form-field>\r\n\r\n<igo-ogc-filter-time *ngIf=\"isTemporalOperator()\"\r\n  [(datasource)]=\"datasource\"\r\n  [(currentFilter)]=\"currentFilter\"\r\n  (changeProperty)=\"changeProperty($event.value, $event.pos)\">\r\n</igo-ogc-filter-time>\r\n\r\n<!--\r\nTODO C'EST PERTINENT je crois\r\n<mat-form-field class=\"field\" *ngIf=\"!(currentFilterIsSpatial$ | async) && (fields$| async) && (fields$| async).length === 1 &&  (fields$| async)[0].name === ''\">\r\n<input [disabled]=\"!currentFilter.active\" matInput #fieldPerUser (keyup)=\"changeProperty(currentFilter,'propertyName',fieldPerUser.value)\"\r\n  (blur)=\"changeProperty(currentFilter,'propertyName',fieldPerUser.value)\" [(ngModel)]=\"currentFilter.propertyName\">\r\n<button mat-button *ngIf=\"currentFilter.propertyName\" matSuffix mat-icon-button aria-label=\"Clear\" (click)=\"currentFilter.propertyName=''\">\r\n  <mat-icon svgIcon=\"close\"></mat-icon>\r\n</button>\r\n</mat-form-field>\r\n\r\n\r\n\r\n<mat-checkbox labelPosition='before' (change)=\"changeCaseSensitive($event)\" [(ngModel)]=\"currentFilter.matchCase\">\r\n  {{('igo.geo.operators.caseSensitive') | translate}}\r\n</mat-checkbox>\r\n\r\n</mat-list-item> -->\r\n","import { Component, Input, OnInit } from '@angular/core';\r\nimport { FloatLabelType } from '@angular/material/form-field';\r\nimport { BehaviorSubject, Observable, of } from 'rxjs';\r\n\r\nimport {\r\n  OgcFilterableDataSource,\r\n  OgcFiltersOptions\r\n} from '../../filter/shared/ogc-filter.interface';\r\nimport { OgcFilterWriter } from '../../filter/shared/ogc-filter';\r\nimport { WktService } from '../../wkt/shared/wkt.service';\r\nimport { IgoMap } from '../../map';\r\nimport { SourceFieldsOptionsParams } from '../../datasource/shared/datasources/datasource.interface';\r\nimport { OgcFilterOperator } from '../../filter/shared/ogc-filter.enum';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filter-form',\r\n  templateUrl: './ogc-filter-form.component.html',\r\n  styleUrls: ['./ogc-filter-form.component.scss']\r\n})\r\nexport class OgcFilterFormComponent implements OnInit {\r\n  ogcFilterOperator = OgcFilterOperator;\r\n  filteredValues$: Observable<string[]>;\r\n  filteredFields$: Observable<SourceFieldsOptionsParams[]>;\r\n  public allOgcFilterOperators;\r\n  public ogcFilterOperators$ = new BehaviorSubject<{ [key: string]: any }>(\r\n    undefined\r\n  );\r\n  public igoSpatialSelectors;\r\n  public value = '';\r\n  public inputOperator;\r\n  public selectedField$ = new BehaviorSubject<SourceFieldsOptionsParams>(\r\n    undefined\r\n  );\r\n  public fields$ = new BehaviorSubject<SourceFieldsOptionsParams[]>([]);\r\n  public color = 'primary';\r\n  public disabled;\r\n  public currentFilterIsSpatial$ = new BehaviorSubject<boolean>(false);\r\n  public defaultStepMillisecond = 6000;\r\n  public inputClearable: string;\r\n\r\n  @Input() refreshFilters: () => void;\r\n\r\n  @Input() datasource: OgcFilterableDataSource;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() currentFilter: any;\r\n\r\n  set snrc(value: any) {\r\n    const checkSNRC50k = /^\\d{2}[a-l][0,1][0-9]$/gi;\r\n    const checkSNRC250k = /^\\d{2}[a-p]$/gi;\r\n    const checkSNRC1m = /^\\d{2}$/gi;\r\n    if (\r\n      checkSNRC1m.test(value) ||\r\n      checkSNRC250k.test(value) ||\r\n      checkSNRC50k.test(value)\r\n    ) {\r\n      this._snrc = value;\r\n      this.currentFilter.igoSNRC = value;\r\n    }\r\n  }\r\n\r\n  get snrc(): any {\r\n    return this._snrc;\r\n  }\r\n\r\n  private _snrc = '';\r\n\r\n  @Input() floatLabel: FloatLabelType = 'never';\r\n\r\n  get activeFilters() {\r\n    return this.datasource.options.ogcFilters.interfaceOgcFilters.filter(\r\n      (f) => f.active === true\r\n    );\r\n  }\r\n\r\n  get allowedOperators() {\r\n    return new OgcFilterWriter().computeAllowedOperators(\r\n      this.fields$.value,\r\n      this.currentFilter.propertyName,\r\n      this.datasource.options.ogcFilters.allowedOperatorsType\r\n    );\r\n  }\r\n\r\n  constructor(private wktService: WktService) {\r\n    // TODO: Filter permitted operator based on wfscapabilities\r\n    // Need to work on regex on XML capabilities because\r\n    // comaparison operator's name varies between WFS servers...\r\n    // Ex: IsNull vs PropertyIsNull vs IsNil ...\r\n    this.allOgcFilterOperators = new OgcFilterWriter().operators;\r\n    this.ogcFilterOperators$.next(this.allOgcFilterOperators);\r\n    this.igoSpatialSelectors = [\r\n      {\r\n        type: 'fixedExtent'\r\n      },\r\n      {\r\n        type: 'snrc'\r\n      }\r\n    ];\r\n    // TODO: selectFeature & drawFeature\r\n  }\r\n\r\n  ngOnInit() {\r\n\r\n    if ( this.datasource.options.sourceFields) {\r\n      const sFields = this.datasource.options.sourceFields.filter(\r\n        (sf) =>\r\n          sf.excludeFromOgcFilters === undefined || !sf.excludeFromOgcFilters\r\n      );\r\n      sFields.map((sfs) => {\r\n        if (sfs.values) {\r\n          sfs.values.sort();\r\n        }\r\n      });\r\n      this.fields$.next(sFields);\r\n    }\r\n\r\n    this.updateFieldsList();\r\n    this.selectedField$.next(\r\n      this.fields$.value.find((f) => f.name === this.currentFilter.propertyName)\r\n    );\r\n    this.updateValuesList();\r\n    this.selectedField$.subscribe((f) => {\r\n      this.ogcFilterOperators$.next(this.allowedOperators);\r\n      if (\r\n        Object.keys(this.allowedOperators).indexOf(\r\n          this.currentFilter.operator\r\n        ) === -1\r\n      ) {\r\n        this.currentFilter.operator = Object.keys(this.allowedOperators)[0];\r\n        this.currentFilter.operator = Object.keys(this.allowedOperators)[0];\r\n      }\r\n      this.updateValuesList();\r\n    });\r\n    this.currentFilterIsSpatial();\r\n  }\r\n\r\n  updateFieldsList(value?: string) {\r\n    this.filteredFields$ =\r\n      value && value.length > 0 ? of(this._filterFields(value)) : this.fields$;\r\n    if (this.fields$.value.find((f) => f.name === value)) {\r\n      this.changeField(value);\r\n    }\r\n  }\r\n\r\n  updateValuesList(value?: string, pos?: number) {\r\n    this.filteredValues$ =\r\n      value && value.length > 0\r\n        ? of(this._filterValues(value))\r\n        : this.selectedField$.value\r\n        ? of(this.selectedField$.value.values)\r\n        : of([]);\r\n    if (value && value.length >= 1) {\r\n      this.changeProperty(value, pos);\r\n    }\r\n  }\r\n\r\n  private _filterFields(value: string): SourceFieldsOptionsParams[] {\r\n    const keywordRegex = new RegExp(\r\n      value.normalize('NFD').replace(/[\\u0300-\\u036f]/g, ''),\r\n      'gi'\r\n    );\r\n    return this.fields$.value.filter((val) =>\r\n      keywordRegex.test(\r\n        val.alias.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '')\r\n      )\r\n    );\r\n  }\r\n\r\n  private _filterValues(value: string): string[] {\r\n    const keywordRegex = new RegExp(\r\n      value\r\n        .toString()\r\n        .normalize('NFD')\r\n        .replace(/[\\u0300-\\u036f]/g, ''),\r\n      'gi'\r\n    );\r\n    return this.selectedField$.value.values.filter((val) =>\r\n      val && keywordRegex.test(\r\n        val\r\n          .toString()\r\n          .normalize('NFD')\r\n          .replace(/[\\u0300-\\u036f]/g, '')\r\n      )\r\n    );\r\n  }\r\n\r\n  clearSelectedField() {\r\n    this.currentFilter.propertyName = '';\r\n    this.selectedField$.next(undefined);\r\n    this.clearProperty();\r\n  }\r\n\r\n  isClearable(pos?: number) {\r\n    const detectedProperty = this.detectProperty(pos);\r\n    if (detectedProperty) {\r\n      return this.currentFilter[detectedProperty];\r\n    }\r\n  }\r\n  clearProperty(pos?: number) {\r\n    // this.autoCompleteInputValues.closePanel();\r\n    const detectedProperty = this.detectProperty(pos);\r\n    if (detectedProperty) {\r\n      return (this.currentFilter[detectedProperty] = '');\r\n    }\r\n  }\r\n\r\n  toggleFilterState(event) {\r\n    this.datasource.options.ogcFilters.interfaceOgcFilters.find(\r\n      (f) => f.filterid === this.currentFilter.filterid\r\n    ).active = event.checked;\r\n    this.refreshFilters();\r\n  }\r\n\r\n  deleteFilter() {\r\n    const ogcFilters: OgcFiltersOptions = this.datasource.options.ogcFilters;\r\n    ogcFilters.interfaceOgcFilters = ogcFilters.interfaceOgcFilters.filter(\r\n      (f) => f.filterid !== this.currentFilter.filterid\r\n    );\r\n    this.refreshFilters();\r\n  }\r\n\r\n  changeLogical(logical: string) {\r\n    this.currentFilter.parentLogical = logical;\r\n    this.refreshFilters();\r\n  }\r\n\r\n  changeOperator(operator: string) {\r\n    this.currentFilter.operator = operator;\r\n    this.currentFilterIsSpatial();\r\n\r\n    if (\r\n      this.currentFilterIsSpatial$.value &&\r\n      this.currentFilter.wkt_geometry.length === 0\r\n    ) {\r\n      this.changeSpatialSelector(this.currentFilter.igoSpatialSelector);\r\n    } else {\r\n      this.refreshFilters();\r\n    }\r\n  }\r\n\r\n  changeField(field: string) {\r\n    this.currentFilter.propertyName = field;\r\n    this.selectedField$.next(\r\n      this.fields$.value.find((f) => f.name === this.currentFilter.propertyName)\r\n    );\r\n    this.refreshFilters();\r\n  }\r\n\r\n  // Issue with mapserver 7.2 and Postgis layers. Fixed in 7.4\r\n  // Due to this issue, the checkbox is hide.\r\n  changeCaseSensitive(matchCase) {\r\n    this.currentFilter.matchCase = matchCase.checked;\r\n    this.refreshFilters();\r\n  }\r\n\r\n  changeProperty(value: any, pos?: number, refreshFilter = true) {\r\n    const detectedProperty = this.detectProperty(pos);\r\n    if (detectedProperty) {\r\n      this.datasource.options.ogcFilters.interfaceOgcFilters.find(\r\n        (f) => f.filterid === this.currentFilter.filterid\r\n      )[detectedProperty] = value;\r\n\r\n      if ( refreshFilter ) {\r\n        this.refreshFilters();\r\n      }\r\n    }\r\n  }\r\n\r\n  changeNumericProperty(value, pos: number) {\r\n    this.changeProperty(parseFloat(value), pos);\r\n  }\r\n\r\n  changeSpatialSelector(value: any) {\r\n    this.currentFilter.igoSpatialSelector = value;\r\n\r\n    if (value === 'fixedExtent') {\r\n      this.changeMapExtentGeometry(false);\r\n    }\r\n    this.currentFilterIsSpatial();\r\n    this.refreshFilters();\r\n  }\r\n\r\n  changeSNRC(value: any) {\r\n    this.snrc = value;\r\n    this.changeSNRCGeometry();\r\n  }\r\n\r\n  changeSNRCGeometry() {\r\n    const interfaceOgcFilter = this.datasource.options.ogcFilters.interfaceOgcFilters.find(\r\n      (f) => f.filterid === this.currentFilter.filterid\r\n    );\r\n    if (!interfaceOgcFilter) {\r\n      return;\r\n    }\r\n\r\n    if (this.snrc && this.currentFilter.igoSpatialSelector === 'snrc') {\r\n      this.currentFilter.wkt_geometry = this.wktService.snrcToWkt(\r\n        this.snrc,\r\n        this.map.projection\r\n      ).wktPoly;\r\n    }\r\n    this.refreshFilters();\r\n  }\r\n\r\n  changeMapExtentGeometry(refresh: boolean = true) {\r\n    const interfaceOgcFilter = this.datasource.options.ogcFilters.interfaceOgcFilters.find(\r\n      (f) => f.filterid === this.currentFilter.filterid\r\n    );\r\n    if (!interfaceOgcFilter) {\r\n      return;\r\n    }\r\n\r\n    if (this.currentFilter.igoSpatialSelector === 'fixedExtent') {\r\n      this.currentFilter.wkt_geometry = this.wktService.extentToWkt(\r\n        this.map.projection,\r\n        this.map.viewController.getExtent(),\r\n        this.map.projection\r\n      ).wktPoly;\r\n    }\r\n    if (refresh) {\r\n      this.refreshFilters();\r\n    }\r\n  }\r\n\r\n  detectProperty(pos?: number): string {\r\n    switch (this.currentFilter.operator) {\r\n      case OgcFilterOperator.PropertyIsNotEqualTo:\r\n      case OgcFilterOperator.PropertyIsEqualTo:\r\n      case OgcFilterOperator.PropertyIsGreaterThan:\r\n      case OgcFilterOperator.PropertyIsGreaterThanOrEqualTo:\r\n      case OgcFilterOperator.PropertyIsLessThan:\r\n      case OgcFilterOperator.PropertyIsLessThanOrEqualTo:\r\n        return 'expression';\r\n      case OgcFilterOperator.PropertyIsLike:\r\n        return 'pattern';\r\n      case OgcFilterOperator.PropertyIsBetween:\r\n        return pos && pos === 1\r\n          ? 'lowerBoundary'\r\n          : pos && pos === 2\r\n          ? 'upperBoundary'\r\n          : undefined;\r\n      case OgcFilterOperator.During:\r\n        return pos && pos === 1\r\n          ? 'begin'\r\n          : pos && pos === 2\r\n          ? 'end'\r\n          : undefined;\r\n      default:\r\n        return;\r\n    }\r\n  }\r\n\r\n  private currentFilterIsSpatial() {\r\n    let isSpatial = false;\r\n    if (this.currentFilter) {\r\n      isSpatial =\r\n        [\r\n          OgcFilterOperator.Contains,\r\n          OgcFilterOperator.Intersects,\r\n          OgcFilterOperator.Within\r\n        ].indexOf(this.currentFilter.operator) !== -1;\r\n    }\r\n    this.currentFilterIsSpatial$.next(isSpatial);\r\n  }\r\n\r\n  isTemporalOperator() {\r\n    return (\r\n      this.currentFilter.operator.toLowerCase() ===\r\n      this.ogcFilterOperator.During.toLowerCase()\r\n    );\r\n  }\r\n}\r\n","<igo-ogc-filter-selection\r\n  *ngIf=\"!advancedOgcFilters\"\r\n  igoListItem\r\n  [refreshFilters]=\"refreshFunc\"\r\n  [datasource]=\"datasource\"\r\n  [map]=\"map\"\r\n  [currentFilter]=\"currentFilter\">\r\n</igo-ogc-filter-selection>\r\n\r\n<ng-template \r\n*ngIf=\"advancedOgcFilters && datasource.options.ogcFilters.editable\"\r\nngFor let-currentFilter \r\n[ngForOf]=\"datasource.options.ogcFilters.interfaceOgcFilters\">\r\n<igo-ogc-filter-form\r\n  [currentFilter]=\"currentFilter\"\r\n  [refreshFilters]=\"refreshFunc\"\r\n  [datasource]=\"datasource\"\r\n  [map]=\"map\">\r\n</igo-ogc-filter-form>\r\n</ng-template>","import { Component, Input } from '@angular/core';\r\nimport { OgcFilterableDataSource } from '../shared/ogc-filter.interface';\r\nimport { IgoMap } from '../../map';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filterable-form',\r\n  templateUrl: './ogc-filterable-form.component.html'\r\n})\r\nexport class OgcFilterableFormComponent {\r\n\r\n  @Input() datasource: OgcFilterableDataSource;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() refreshFilters: () => void;\r\n\r\n  get refreshFunc() {\r\n    return this.refreshFilters;\r\n  }\r\n\r\n  get advancedOgcFilters(): boolean {\r\n    if (this.datasource.options.ogcFilters) {\r\n      return this.datasource.options.ogcFilters.advancedOgcFilters;\r\n    }\r\n    return;\r\n  }\r\n\r\n  get currentFilter(): any {\r\n    return this.datasource.options.ogcFilters.interfaceOgcFilters ?\r\n    this.datasource.options.ogcFilters.interfaceOgcFilters[0] : undefined;\r\n  }\r\n\r\n  public color = 'primary';\r\n\r\n  constructor() {}\r\n}\r\n","<div [ngClass]=\"{'separate-item' : header === true}\" >\r\n  <mat-list-item>\r\n    <mat-icon\r\n      *ngIf=\"header\"\r\n      class=\"igo-chevron\"\r\n      mat-list-avatar\r\n      igoCollapse [target]=\"ogcFilters\"\r\n      [collapsed]=\"filtersCollapsed\"\r\n      (click)=\"toggleFiltersCollapsed()\"\r\n      svgIcon=\"chevron-up\">\r\n    </mat-icon>\r\n    <h4 (click)=\"toggleLegendOnClick()\" *ngIf=\"header\" [ngStyle]=\"{'cursor': filtersCollapsed ? 'default' : 'pointer'}\" matLine [matTooltip]=\"layer.title\" matTooltipShowDelay=\"500\">{{layer.title}}</h4>\r\n      <button *ngIf=\"isAdvancedOgcFilters() && filtersAreEditable\" [disabled]=\"addFilterDisabled()\" mat-icon-button tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.geo.filter.addFilter' | translate\" [color]=\"color\" (click)=\"addFilterToSequence()\">\r\n        <mat-icon svgIcon=\"plus\"></mat-icon>\r\n      </button>\r\n      <button *ngIf=\"header\"\r\n        mat-icon-button\r\n        [color]=\"layer.visible ? 'primary' : 'default'\"\r\n        collapsibleButton\r\n        tooltip-position=\"below\"\r\n        matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"layer.visible ?\r\n                      ('igo.geo.layer.hideLayer' | translate) :\r\n                      ('igo.geo.layer.showLayer' | translate)\"\r\n        (click)=\"layer.visible = !layer.visible\">\r\n        <mat-icon\r\n          [ngClass]=\"{disabled: (inResolutionRange$ | async)===false}\"\r\n          [svgIcon]=\"layer.visible ? 'eye' : 'eye-off'\">\r\n        </mat-icon>\r\n      </button>\r\n  </mat-list-item>\r\n\r\n  <div #ogcFilters>\r\n      <div *ngIf=\"header\" #legend class=\"igo-layer-legend-container\">\r\n        <igo-layer-legend *ngIf=\"showLegend$ | async\" [layer]=\"layer\">\r\n        </igo-layer-legend>\r\n      </div>\r\n    <igo-ogc-filterable-form [datasource]=\"datasource\" [map]=\"map\" [refreshFilters]=\"refreshFunc\">\r\n    </igo-ogc-filterable-form>\r\n\r\n    <section *ngIf=\"hasSelector && filtersAreEditable\" class=\"mat-typography advancedOgcFilters\">\r\n      <mat-divider></mat-divider>\r\n      <mat-checkbox labelPosition='before' (change)=\"changeOgcFilterType($event)\"\r\n        [(ngModel)]=\"datasource.options.ogcFilters.advancedOgcFilters\">\r\n        {{'igo.geo.filter.advancedOgcFilters' | translate}}\r\n      </mat-checkbox>\r\n    </section>\r\n  </div>\r\n</div>","import { Component, Input, OnDestroy, OnInit } from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { WMSDataSource } from '../../datasource/shared/datasources/wms-datasource';\r\nimport { WFSDataSourceOptionsParams } from '../../datasource/shared/datasources/wfs-datasource.interface';\r\nimport { OgcFilterOperator } from '../../filter/shared/ogc-filter.enum';\r\n\r\nimport {\r\n  OgcFilterableDataSource,\r\n  OgcFiltersOptions,\r\n  OgcInterfaceFilterOptions\r\n} from '../shared/ogc-filter.interface';\r\nimport { OGCFilterService } from '../shared/ogc-filter.service';\r\nimport { IgoMap } from '../../map';\r\nimport { OgcFilterWriter } from '../shared/ogc-filter';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filterable-item',\r\n  templateUrl: './ogc-filterable-item.component.html',\r\n  styleUrls: ['./ogc-filterable-item.component.scss']\r\n})\r\nexport class OgcFilterableItemComponent implements OnInit, OnDestroy {\r\n  public color = 'primary';\r\n  private lastRunOgcFilter;\r\n  private defaultLogicalParent = OgcFilterOperator.And;\r\n  public hasActiveSpatialFilter = false;\r\n  public filtersAreEditable = true;\r\n  public filtersCollapsed = true;\r\n  public hasSelector: boolean = false;\r\n  showLegend$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  inResolutionRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n  private resolution$$: Subscription;\r\n  private ogcFilterWriter;\r\n\r\n  @Input() layer: Layer;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() header: boolean = true;\r\n\r\n  get refreshFunc() {\r\n    return this.refreshFilters.bind(this);\r\n  }\r\n\r\n  get datasource(): OgcFilterableDataSource {\r\n    return this.layer.dataSource as OgcFilterableDataSource;\r\n  }\r\n\r\n  constructor(private ogcFilterService: OGCFilterService) {\r\n    this.ogcFilterWriter = new OgcFilterWriter();\r\n  }\r\n\r\n  ngOnInit() {\r\n    if (this.layer.visible) {\r\n      this.filtersCollapsed = false;\r\n    }\r\n\r\n    const ogcFilters = this.datasource.options.ogcFilters;\r\n    if (\r\n      (ogcFilters.pushButtons && ogcFilters.pushButtons.bundles.length > 0) ||\r\n      (ogcFilters.checkboxes && ogcFilters.checkboxes.bundles.length > 0) ||\r\n      (ogcFilters.radioButtons && ogcFilters.radioButtons.bundles.length > 0) ||\r\n      (ogcFilters.select && ogcFilters.select.bundles.length > 0) ||\r\n      (ogcFilters.autocomplete && ogcFilters.autocomplete.bundles.length > 0)) {\r\n      if (ogcFilters.advancedOgcFilters === undefined) {\r\n        ogcFilters.advancedOgcFilters = false;\r\n      }\r\n      this.hasSelector = true;\r\n    }\r\n\r\n    switch (this.datasource.options.type) {\r\n      case 'wms':\r\n        this.ogcFilterService.setOgcWMSFiltersOptions(this.datasource);\r\n        break;\r\n      case 'wfs':\r\n        this.ogcFilterService.setOgcWFSFiltersOptions(this.datasource);\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n\r\n    if (ogcFilters) {\r\n      if (ogcFilters.interfaceOgcFilters) {\r\n        this.lastRunOgcFilter = JSON.parse(\r\n          JSON.stringify(ogcFilters.interfaceOgcFilters)\r\n        );\r\n        if (\r\n          ogcFilters.interfaceOgcFilters.filter(f => f.wkt_geometry).length >= 1\r\n        ) {\r\n          this.hasActiveSpatialFilter = true;\r\n        }\r\n      }\r\n\r\n      this.filtersAreEditable = ogcFilters.editable\r\n        ? ogcFilters.editable\r\n        : false;\r\n    }\r\n\r\n    const resolution$ = this.layer.map.viewController.resolution$;\r\n    this.resolution$$ = resolution$.subscribe(() => {\r\n      this.inResolutionRange$.next(this.layer.isInResolutionsRange);\r\n    });\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this.resolution$$.unsubscribe();\r\n  }\r\n\r\n  addFilterToSequence() {\r\n    this.filtersCollapsed = false;\r\n    const interfaceOgcFilters: OgcInterfaceFilterOptions[] = this.datasource\r\n      .options.ogcFilters.interfaceOgcFilters;\r\n    const arr = interfaceOgcFilters || [];\r\n    const lastLevel = arr.length === 0 ? 0 : arr[arr.length - 1].level;\r\n    let firstFieldName = '';\r\n    const includedFields = this.datasource.options.sourceFields.filter(f => !f.excludeFromOgcFilters);\r\n    if (includedFields.length > 0) {\r\n      firstFieldName =\r\n        includedFields[0].name === undefined ? '' : includedFields[0].name;\r\n    }\r\n    let fieldNameGeometry;\r\n    const datasourceOptions = this.datasource\r\n      .options as WFSDataSourceOptionsParams;\r\n    if (datasourceOptions.fieldNameGeometry) {\r\n      fieldNameGeometry = datasourceOptions.fieldNameGeometry;\r\n    } else if (\r\n      (this.datasource.options as any).paramsWFS &&\r\n      (this.datasource.options as any).paramsWFS.fieldNameGeometry\r\n    ) {\r\n      fieldNameGeometry = (this.datasource.options as any).paramsWFS\r\n        .fieldNameGeometry;\r\n    }\r\n    const allowedOperators = this.ogcFilterWriter.computeAllowedOperators(\r\n      this.datasource.options.sourceFields,\r\n      firstFieldName,\r\n      this.datasource.options.ogcFilters.allowedOperatorsType);\r\n    const firstOperatorName = Object.keys(allowedOperators)[0];\r\n\r\n    arr.push(\r\n      this.ogcFilterWriter.addInterfaceFilter(\r\n        {\r\n          propertyName: firstFieldName,\r\n          operator: firstOperatorName,\r\n          active: true,\r\n          igoSpatialSelector: 'fixedExtent',\r\n          srsName: this.map.projection,\r\n        } as OgcInterfaceFilterOptions,\r\n        fieldNameGeometry,\r\n        lastLevel,\r\n        this.defaultLogicalParent\r\n      )\r\n    );\r\n    this.datasource.options.ogcFilters.interfaceOgcFilters = arr;\r\n  }\r\n\r\n  refreshFilters(force?: boolean) {\r\n    if (force === true) {\r\n      this.lastRunOgcFilter = undefined;\r\n    }\r\n    const ogcFilters: OgcFiltersOptions = this.datasource.options.ogcFilters;\r\n    const activeFilters = ogcFilters.interfaceOgcFilters ?\r\n      ogcFilters.interfaceOgcFilters.filter(f => f.active === true) : [];\r\n    if (activeFilters.length === 0) {\r\n      ogcFilters.filters = undefined;\r\n      ogcFilters.filtered = false;\r\n    }\r\n    if (activeFilters.length > 1) {\r\n      activeFilters[0].parentLogical = activeFilters[1].parentLogical;\r\n    }\r\n    if (\r\n      activeFilters.filter(\r\n        af => ['Contains', 'Intersects', 'Within'].indexOf(af.operator) !== -1\r\n      ).length === 0\r\n    ) {\r\n      this.hasActiveSpatialFilter = false;\r\n    } else {\r\n      this.hasActiveSpatialFilter = true;\r\n    }\r\n\r\n    if (\r\n      !(JSON.stringify(this.lastRunOgcFilter) === JSON.stringify(activeFilters))\r\n    ) {\r\n      if (this.layer.dataSource.options.type === 'wfs') {\r\n        const ogcDataSource: any = this.layer.dataSource;\r\n        const ogcLayer: OgcFiltersOptions = ogcDataSource.options.ogcFilters;\r\n        ogcLayer.filters = this.ogcFilterWriter.rebuiltIgoOgcFilterObjectFromSequence(\r\n          activeFilters\r\n        );\r\n        this.layer.dataSource.ol.refresh();\r\n      } else if (\r\n        this.layer.dataSource.options.type === 'wms' &&\r\n        ogcFilters.enabled\r\n      ) {\r\n        let rebuildFilter = '';\r\n        if (activeFilters.length >= 1) {\r\n          const ogcDataSource: any = this.layer.dataSource;\r\n          const ogcLayer: OgcFiltersOptions = ogcDataSource.options.ogcFilters;\r\n          ogcLayer.filters = this.ogcFilterWriter.rebuiltIgoOgcFilterObjectFromSequence(\r\n            activeFilters\r\n          );\r\n          rebuildFilter = this.ogcFilterWriter.buildFilter(\r\n            ogcLayer.filters,\r\n            undefined,\r\n            undefined,\r\n            (this.layer.dataSource.options as any).fieldNameGeometry,\r\n            ogcDataSource.options\r\n          );\r\n        }\r\n        this.ogcFilterService.filterByOgc(\r\n          this.datasource as WMSDataSource,\r\n          rebuildFilter\r\n        );\r\n        this.datasource.options.ogcFilters.filtered =\r\n          activeFilters.length === 0 ? false : true;\r\n      }\r\n\r\n      this.lastRunOgcFilter = JSON.parse(JSON.stringify(activeFilters));\r\n    } else {\r\n      // identical filter. Nothing triggered\r\n    }\r\n    (this.layer.dataSource as OgcFilterableDataSource).setOgcFilters(ogcFilters, true);\r\n  }\r\n\r\n  public setVisible() {\r\n    this.layer.visible = true;\r\n  }\r\n\r\n  public isAdvancedOgcFilters(): boolean {\r\n    return this.datasource.options.ogcFilters.advancedOgcFilters;\r\n  }\r\n\r\n  public addFilterDisabled(): boolean {\r\n    return (\r\n      !this.datasource.options.sourceFields ||\r\n      this.datasource.options.sourceFields.length === 0\r\n    );\r\n  }\r\n\r\n  private changeOgcFiltersAdvancedOgcFilters(value: boolean) {\r\n    this.datasource.options.ogcFilters.advancedOgcFilters = value;\r\n  }\r\n\r\n  changeOgcFilterType(isAdvancedOgcFilters) {\r\n    this.changeOgcFiltersAdvancedOgcFilters(isAdvancedOgcFilters.checked);\r\n    if (isAdvancedOgcFilters.checked) {\r\n      this.refreshFilters(true);\r\n    }\r\n  }\r\n\r\n  private toggleLegend(collapsed: boolean) {\r\n    this.layer.legendCollapsed = collapsed;\r\n    this.showLegend$.next(!collapsed);\r\n  }\r\n\r\n  toggleLegendOnClick() {\r\n    if (!this.filtersCollapsed) {\r\n      this.toggleLegend(this.showLegend$.value);\r\n    }\r\n  }\r\n\r\n  toggleFiltersCollapsed() {\r\n    this.filtersCollapsed = !this.filtersCollapsed;\r\n  }\r\n}\r\n","\r\n<igo-list [navigation]=\"false\" [selection]=\"false\">\r\n  <div  id=\"no-layer-message\" *ngIf=\"(layers | filterableDataSource : 'ogc').length === 0\">{{'igo.geo.filter.noFilterableLayer' | translate}}</div>\r\n  <ng-template ngFor let-layer [ngForOf]=\"layers | filterableDataSource: 'ogc'\">\r\n    <igo-ogc-filterable-item igoListItem [header]=\"true\" [layer]=\"layer\" \r\n    [map]=\"layer.map\" ></igo-ogc-filterable-item>\r\n  </ng-template>\r\n</igo-list>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { IgoMap } from '../../map';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filterable-list',\r\n  templateUrl: './ogc-filterable-list.component.html',\r\n  styleUrls: ['./ogc-filterable-list.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class OgcFilterableListComponent {\r\n\r\n  @Input() layers: Layer[];\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  constructor() {}\r\n}\r\n","<button\r\n  *ngIf=\"header && options.ogcFilters && options.ogcFilters.enabled &&\r\n  (options.ogcFilters.pushButtons || options.ogcFilters.checkboxes || options.ogcFilters.radioButtons || options.ogcFilters.select || options.ogcFilters.autocomplete\r\n    || options.ogcFilters.editable)\"\r\n  mat-icon-button\r\n  collapsibleButton\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.filter.filterBy' | translate\"\r\n  [color]=\"color\">\r\n  <mat-icon [matBadge]=\"badge\" matBadgeColor=\"warn\" matBadgeSize=\"medium\" svgIcon=\"filter\"></mat-icon>\r\n</button>\r\n\r\n<div #ogcFilter class=\"igo-layer-actions-container\"\r\n*ngIf=\"options.ogcFilters && options.ogcFilters.enabled &&\r\n(options.ogcFilters.pushButtons || options.ogcFilters.checkboxes || options.ogcFilters.radioButtons || options.ogcFilters.select || options.ogcFilters.autocomplete\r\n  || options.ogcFilters.editable)\">\r\n  <igo-ogc-filterable-item\r\n    *ngIf=\"ogcFilterCollapse && options.ogcFilters.enabled\"\r\n    igoListItem\r\n    [header]=\"false\"\r\n    [map]=\"layer.map\"\r\n    [layer]=\"layer\">\r\n  </igo-ogc-filterable-item>\r\n</div>\r\n","import { Component, Input, ChangeDetectionStrategy, OnInit } from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { IgoMap } from '../../map';\r\nimport { OgcFilterableDataSourceOptions, IgoOgcSelector } from '../shared/ogc-filter.interface';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filter-button',\r\n  templateUrl: './ogc-filter-button.component.html',\r\n  styleUrls: ['./ogc-filter-button.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class OgcFilterButtonComponent implements OnInit {\r\n\r\n  public options: OgcFilterableDataSourceOptions;\r\n\r\n  get badge() {\r\n    const filter = this.options.ogcFilters as any;\r\n    let cnt = 0;\r\n    if (filter && !filter.advancedOgcFilters) {\r\n      if (filter.pushButtons) {\r\n        const pushButtons = filter.pushButtons as IgoOgcSelector;\r\n        const currentPushButtonGroup = pushButtons.groups.find(gr => gr.enabled);\r\n        let cntPushButtons = 0;\r\n        if (currentPushButtonGroup) {\r\n          currentPushButtonGroup.computedSelectors?.map(cb => cntPushButtons += (cb.selectors as any)?.filter(\r\n            button => button.enabled).length);\r\n        }\r\n        cnt += cntPushButtons;\r\n      }\r\n      if (filter.checkboxes) {\r\n        const checkboxes = filter.checkboxes as IgoOgcSelector;\r\n        const currentCheckboxGroup = checkboxes.groups.find(gr => gr.enabled);\r\n        let cntCheckboxes = 0;\r\n        if (currentCheckboxGroup) {\r\n          currentCheckboxGroup.computedSelectors?.map(cb => cntCheckboxes += (cb.selectors as any)?.filter(\r\n            checkbox => checkbox.enabled).length);\r\n        }\r\n        cnt += cntCheckboxes;\r\n      }\r\n      if (filter.radioButtons) {\r\n        const radioButtons = filter.radioButtons as IgoOgcSelector;\r\n        const currentRadioButtonsGroup = radioButtons.groups.find(gr => gr.enabled);\r\n        let cntRadioButtons = 0;\r\n        if (currentRadioButtonsGroup) {\r\n          currentRadioButtonsGroup.computedSelectors?.map(cb => cntRadioButtons += (cb.selectors as any)?.filter(\r\n            radio => radio.enabled).length);\r\n        }\r\n        cnt += cntRadioButtons;\r\n      }\r\n      if (filter.select) {\r\n        const select = filter.select as IgoOgcSelector;\r\n        const currentSelectGroup = select.groups.find(gr => gr.enabled);\r\n        let cntSelect = 0;\r\n        if (currentSelectGroup) {\r\n          currentSelectGroup.computedSelectors?.map(cb => cntSelect += (cb.selectors as any)?.filter(\r\n            multi => multi.enabled).length);\r\n        }\r\n        cnt += cntSelect;\r\n      }\r\n      if (filter.autocomplete) {\r\n        const autocomplete = filter.autocomplete as IgoOgcSelector;\r\n        const currentAutocompleteGroup = autocomplete.groups.find(gr => gr.enabled);\r\n        let cntAutocomplete = 0;\r\n        if (currentAutocompleteGroup) {\r\n          currentAutocompleteGroup.computedSelectors?.map(cb => cntAutocomplete += (cb.selectors as any)?.filter(\r\n            autocomplete => autocomplete.enabled).length);\r\n        }\r\n        cnt += cntAutocomplete;\r\n      }\r\n    } else if (filter && filter.filters && !filter.filters.filters) {\r\n      return 1;\r\n    } else if (filter && filter.filters && filter.filters.filters) {\r\n      return filter.filters.filters.length;\r\n    }\r\n    if (filter.filters && filter.filters.operator === 'During' && filter.filters.active &&\r\n      filter.interfaceOgcFilters && filter.interfaceOgcFilters[0].active) {\r\n      const filterActiveValue = filter.interfaceOgcFilters[0];\r\n      if (filter.filters.calendarModeYear) {\r\n        // year mode check just year\r\n        if ((filterActiveValue.begin.substring(0,4) !== this.options.minDate.substring(0,4) ) ||\r\n        (filterActiveValue.end.substring(0,4) !== this.options.maxDate.substring(0,4) )) {\r\n          cnt += 1;\r\n        }\r\n      } else if ((filterActiveValue.begin !== this.options.minDate) || (filterActiveValue.end !== this.options.maxDate)) {\r\n        cnt += 1;\r\n      }\r\n    }\r\n    return cnt > 0 ? cnt : undefined;\r\n  }\r\n\r\n  @Input()\r\n  get layer(): Layer {\r\n    return this._layer;\r\n  }\r\n  set layer(value: Layer) {\r\n    this._layer = value;\r\n    if (value) {\r\n      this.options = this.layer.dataSource.options as OgcFilterableDataSourceOptions;\r\n    }\r\n  }\r\n  private _layer;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() color: string = 'primary';\r\n\r\n  @Input() header: boolean;\r\n\r\n  public ogcFilterCollapse = false;\r\n\r\n  constructor() {}\r\n\r\n  ngOnInit() {\r\n    this.options = this.layer.dataSource.options as OgcFilterableDataSourceOptions;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { default as moment } from 'moment';\r\n\r\nimport {\r\n    OgcFilterableDataSource\r\n  } from './ogc-filter.interface';\r\n\r\n@Injectable()\r\nexport class OGCFilterTimeService {\r\n\r\n    readonly defaultStepMillisecond = 60000;\r\n\r\n    constructor() {}\r\n\r\n    step(datasource: OgcFilterableDataSource, currentFilter): string {\r\n    return datasource.options.stepDate\r\n      ? datasource.options.stepDate\r\n      : currentFilter.step;\r\n    }\r\n\r\n    stepMillisecond(dataSource: OgcFilterableDataSource, currentFilter): number {\r\n        const step = moment.duration(this.step(dataSource, currentFilter)).asMilliseconds();\r\n        return step === 0 ? this.defaultStepMillisecond : step;\r\n    }\r\n\r\n    stepIsYearDuration(step: string) {\r\n        const year = moment.duration(step);\r\n        return (\r\n            year.years() !== 0 &&\r\n            year.months() === 0 &&\r\n            year.weeks() === 0 &&\r\n            year.days() === 0 &&\r\n            year.hours() === 0 &&\r\n            year.minutes() === 0\r\n        );\r\n    }\r\n\r\n    stepIsMonthDuration(step: string) {\r\n        const month = moment.duration(step);\r\n        return (\r\n            month.months() !== 0 &&\r\n            month.weeks() === 0 &&\r\n            month.days() === 0 &&\r\n            month.hours() === 0 &&\r\n            month.minutes() === 0\r\n        );\r\n    }\r\n\r\n    stepIsWeekDuration(step: string) {\r\n        const week = moment.duration(step);\r\n        return (\r\n            week.weeks() !== 0 &&\r\n            week.days() === 7 &&\r\n            week.hours() === 0 &&\r\n            week.minutes() === 0\r\n        );\r\n    }\r\n\r\n    stepIsDayDuration(step: string) {\r\n        const day = moment.duration(step);\r\n        return day.days() !== 0 && day.hours() === 0 && day.minutes() === 0;\r\n    }\r\n\r\n    stepIsHourDuration(step: string) {\r\n        const hour = moment.duration(step);\r\n        return hour.hours() !== 0 && hour.minutes() === 0;\r\n    }\r\n\r\n    stepIsMinuteDuration(step: string) {\r\n        const minute = moment.duration(step);\r\n        return minute.minutes() !== 0;\r\n    }\r\n\r\n    dateToNumber(date: Date): number {\r\n        let newDate = new Date();\r\n        if (date) {\r\n          newDate = new Date(date);\r\n        }\r\n        return newDate.getTime();\r\n    }\r\n\r\n    public addStep(value, stepMillisecond) {\r\n        return moment(value).add(stepMillisecond, 'milliseconds').toDate();\r\n    }\r\n\r\n    public subtractStep(value, stepMillisecond) {\r\n        return moment(value).subtract(stepMillisecond, 'milliseconds').toDate();\r\n    }\r\n}\r\n","<form [formGroup]=\"form\">\r\n  <div *ngFor=\"let selector of ogcFiltersSelectors\">\r\n    <div class=\"pushButtonGroups\" *ngIf=\"selector.selectorType === 'pushButton'\">\r\n      <mat-divider></mat-divider>\r\n      <div class=\"groupsSelector\" *ngIf=\"getPushButtonsGroups().length > 1\">\r\n        <mat-form-field>\r\n          <mat-select\r\n            formControlName=\"pushButtonsGroup\"\r\n            [matTooltip]=\"'igo.geo.layer.legend.selectStyle' | translate\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n            [(value)]=\"currentPushButtonsGroup\">\r\n            <mat-option *ngFor=\"let selectorGroup of getPushButtonsGroups()\"\r\n              [value]=\"selectorGroup\">{{selectorGroup.title}}\r\n            </mat-option>\r\n          </mat-select>\r\n        </mat-form-field>\r\n      </div>\r\n      <ng-container *ngFor=\"let bundle of currentPushButtonsGroup.computedSelectors\">\r\n        <h4>{{bundle.title}}</h4>\r\n        <mat-button-toggle-group\r\n          formControlName=\"pushButtons\" class=\"mat-typography\" appearance=\"legacy\" vertical={{bundleIsVertical(bundle)}} multiple=\"true\">\r\n          <mat-button-toggle *ngFor=\"let ogcPushButton of bundle.selectors\"\r\n            [matTooltip]=\"getToolTip(ogcPushButton)\" tooltip-position=\"below\" matTooltipShowDelay=\"500\" matTooltipClass=\"material-tooltip\"\r\n            [ngStyle]=\"getButtonColor(ogcPushButton)\"\r\n            [checked]=\"ogcPushButton.enabled\" (change)=\"onSelectionChange(ogcPushButton, selector.selectorType)\"\r\n            [value]=\"ogcPushButton\">{{ogcPushButton.title}}\r\n          </mat-button-toggle>\r\n        </mat-button-toggle-group>\r\n      </ng-container>\r\n    </div>\r\n\r\n    <div class=\"checkboxGroups\" *ngIf=\"selector.selectorType === 'checkbox'\">\r\n      <mat-divider></mat-divider>\r\n      <div class=\"groupsSelector\" *ngIf=\"getCheckboxesGroups().length > 1\">\r\n        <mat-form-field>\r\n          <mat-select\r\n            formControlName=\"checkboxesGroup\"\r\n            [matTooltip]=\"'igo.geo.layer.legend.selectStyle' | translate\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n            [(value)]=\"currentCheckboxesGroup\">\r\n            <mat-option *ngFor=\"let selectorGroup of getCheckboxesGroups()\"\r\n              [value]=\"selectorGroup\">{{selectorGroup.title}}\r\n            </mat-option>\r\n          </mat-select>\r\n        </mat-form-field>\r\n      </div>\r\n      <ng-container *ngFor=\"let bundle of currentCheckboxesGroup.computedSelectors\">\r\n        <h4>{{bundle.title}}</h4>\r\n        <div class=\"checkboxes mat-typography\">\r\n          <mat-checkbox *ngFor=\"let ogcCheckbox of bundle.selectors\"\r\n            [matTooltip]=\"getToolTip(ogcCheckbox)\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"  matTooltipClass=\"material-tooltip\"\r\n            [checked]=\"ogcCheckbox.enabled\" (change)=\"onSelectionChange(ogcCheckbox, selector.selectorType)\"\r\n            [value]=\"ogcCheckbox\">{{ogcCheckbox.title}}\r\n          </mat-checkbox>\r\n        </div>\r\n        <p *ngIf=\"isLessResults(bundle, 'checkbox') || isMoreResults(bundle, 'checkbox')\">\r\n          <u *ngIf=\"isLessResults(bundle, 'checkbox')\"\r\n            class=\"lessResults mat-typography\"\r\n            (click)=\"displayLessResults('checkbox')\">{{ 'igo.geo.filter.displayLessResults' | translate }}\r\n          </u>\r\n          <u *ngIf=\"isMoreResults(bundle, 'checkbox')\"\r\n            class=\"moreResults mat-typography\"\r\n            (click)=\"displayMoreResults('checkbox')\">{{ 'igo.geo.filter.displayMoreResults' | translate }}\r\n          </u>\r\n        </p>\r\n      </ng-container>\r\n    </div>\r\n\r\n    <div class=\"radioButtonGroups\" *ngIf=\"selector.selectorType === 'radioButton'\">\r\n      <mat-divider></mat-divider>\r\n      <div class=\"groupsSelector\" *ngIf=\"getRadioButtonsGroups().length > 1\">\r\n        <mat-form-field>\r\n          <mat-select\r\n            formControlName=\"radioButtonsGroup\"\r\n            [matTooltip]=\"'igo.geo.layer.legend.selectStyle' | translate\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n            [(value)]=\"currentRadioButtonsGroup\">\r\n            <mat-option *ngFor=\"let selectorGroup of getRadioButtonsGroups()\"\r\n              [value]=\"selectorGroup\">{{selectorGroup.title}}\r\n            </mat-option>\r\n          </mat-select>\r\n        </mat-form-field>\r\n      </div>\r\n      <ng-container *ngFor=\"let bundle of currentRadioButtonsGroup.computedSelectors\">\r\n        <h4>{{bundle.title}}</h4>\r\n        <mat-radio-group\r\n          formControlName=\"radioButtons\" class=\"mat-typography\">\r\n          <mat-radio-button *ngIf=\"bundle.unfiltered\"\r\n            [matTooltip]=\"'igo.geo.filter.resetFilters' | translate\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"  matTooltipClass=\"material-tooltip\"\r\n            (change)=\"emptyRadioButtons()\">{{ 'igo.geo.filter.resetFilters' | translate }}\r\n          </mat-radio-button>\r\n          <mat-radio-button *ngFor=\"let ogcRadioButton of bundle.selectors\"\r\n            [matTooltip]=\"getToolTip(ogcRadioButton)\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"  matTooltipClass=\"material-tooltip\"\r\n            [checked]=\"ogcRadioButton.enabled\" (change)=\"onSelectionChange(ogcRadioButton, selector.selectorType)\"\r\n            [value]=\"ogcRadioButton\">{{ogcRadioButton.title}}\r\n          </mat-radio-button>\r\n          <p *ngIf=\"isLessResults(bundle, 'radio') || isMoreResults(bundle, 'radio')\">\r\n            <u *ngIf=\"isLessResults(bundle, 'radio')\"\r\n              class=\"lessResults mat-typography\"\r\n              (click)=\"displayLessResults('radio')\">{{ 'igo.geo.filter.displayLessResults' | translate }}\r\n            </u>\r\n            <u *ngIf=\"isMoreResults(bundle, 'radio')\"\r\n              class=\"moreResults mat-typography\"\r\n              (click)=\"displayMoreResults('radio')\">{{ 'igo.geo.filter.displayMoreResults' | translate }}\r\n            </u>\r\n          </p>\r\n        </mat-radio-group>\r\n      </ng-container>\r\n    </div>\r\n\r\n    <div class=\"selectGroups\" *ngIf=\"selector.selectorType === 'select'\">\r\n      <mat-divider></mat-divider>\r\n      <div class=\"groupsSelector\" *ngIf=\"getSelectGroups().length > 1\">\r\n        <mat-form-field>\r\n          <mat-select\r\n            formControlName=\"selectGroup\"\r\n            [matTooltip]=\"'igo.geo.layer.legend.selectStyle' | translate\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n            [(value)]=\"currentSelectGroup\">\r\n            <mat-option *ngFor=\"let selectorGroup of getSelectGroups()\"\r\n              [value]=\"selectorGroup\">{{selectorGroup.title}}\r\n            </mat-option>\r\n          </mat-select>\r\n        </mat-form-field>\r\n      </div>\r\n      <ng-container *ngFor=\"let bundle of currentSelectGroup.computedSelectors\">\r\n        <h4>{{bundle.title}}</h4>\r\n        <div class=\"groupsSelector\">\r\n          <mat-button *ngIf=\"bundle.unfiltered && !bundle.multiple\"\r\n            mat-icon-button\r\n            color=\"warn\"\r\n            [matTooltip]=\"'igo.geo.filter.resetFilters' | translate\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"  matTooltipClass=\"material-tooltip\"\r\n            (click)=\"emptySelect()\">\r\n            <mat-icon svgIcon=\"filter-remove\"></mat-icon>\r\n          </mat-button>\r\n          <mat-form-field [style.width.%]=\"bundle.width ? bundle.width : undefined\">\r\n            <div *ngIf=\"bundle.multiple; else notMulti\">\r\n              <mat-select\r\n                #selection [multiple]=\"bundle.multiple\" [placeholder]=\"bundle.title\" formControlName=\"selectMulti\">\r\n                <div class=\"checkboxes mat-typography\">\r\n                  <mat-checkbox *ngIf=\"bundle.multiple\"\r\n                    [(ngModel)]=\"selectAllSelected\" [ngModelOptions]=\"{standalone: true}\"\r\n                    (change)=\"toggleAllSelection()\">Tous\r\n                  </mat-checkbox>\r\n                </div>\r\n                <mat-option *ngFor=\"let ogcSelect of bundle.selectors\"\r\n                  [matTooltip]=\"getToolTip(ogcSelect)\" tooltip-position=\"below\" matTooltipDelay=\"500\" matTooltipClass=\"material-tooltip\"\r\n                  (onSelectionChange)=\"selectOptionClick($event.source.value, bundle, $event)\"\r\n                  [value]=\"ogcSelect\">{{ogcSelect.title}}\r\n                </mat-option>\r\n              </mat-select>\r\n            </div>\r\n            <ng-template #notMulti>\r\n              <mat-select\r\n                [placeholder]=\"bundle.title\" formControlName=\"select\">\r\n                <mat-option *ngFor=\"let ogcSelect of bundle.selectors\"\r\n                  [matTooltip]=\"getToolTip(ogcSelect)\" tooltip-position=\"below\" matTooltipDelay=\"500\" matTooltipClass=\"material-tooltip\"\r\n                  [value]=\"ogcSelect\" (onSelectionChange)=\"selectOptionClick($event.source.value, bundle)\">{{ogcSelect.title}}\r\n                </mat-option>\r\n              </mat-select>\r\n            </ng-template>\r\n          </mat-form-field>\r\n        </div>\r\n      </ng-container>\r\n    </div>\r\n\r\n    <div class=\"autocompleteGroups\" *ngIf=\"selector.selectorType === 'autocomplete'\">\r\n      <mat-divider></mat-divider>\r\n      <div class=\"groupsSelector\" *ngIf=\"getAutocompleteGroups().length > 1\">\r\n        <mat-form-field>\r\n          <mat-select\r\n            formControlName=\"autocompleteGroup\"\r\n            [matTooltip]=\"'igo.geo.layer.legend.selectStyle' | translate\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n            [(value)]=\"currentAutocompleteGroup\">\r\n            <mat-option *ngFor=\"let autocompleteGroup of getAutocompleteGroups()\"\r\n              [value]=\"autocompleteGroup\">{{autocompleteGroup.title}}\r\n            </mat-option>\r\n          </mat-select>\r\n        </mat-form-field>\r\n      </div>\r\n      <ng-container *ngFor=\"let bundle of currentAutocompleteGroup.computedSelectors\">\r\n        <h4>{{bundle.title}}</h4>\r\n        <div class=\"groupsSelector\">\r\n          <mat-button *ngIf=\"bundle.unfiltered\"\r\n            mat-icon-button\r\n            color=\"warn\"\r\n            [matTooltip]=\"'igo.geo.filter.resetFilters' | translate\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"  matTooltipClass=\"material-tooltip\"\r\n            (click)=\"emptyAutocomplete()\">\r\n            <mat-icon svgIcon=\"filter-remove\"></mat-icon>\r\n          </mat-button>\r\n          <mat-form-field *ngIf=\"filteredOgcAutocomplete[bundle.id]\" [style.width.%]=\"bundle.width ? bundle.width : undefined\">\r\n            <input matInput type=\"text\" formControlName=\"autocomplete\" #autocomplete class=\"autocomplete\"\r\n              [matAutocomplete]=\"auto\" [placeholder]=\"bundle.title\">\r\n              <mat-autocomplete #auto=\"matAutocomplete\" #autocomplete (optionSelected)=\"autocompleteOptionClick($event.option.value)\"\r\n              [displayWith]=\"displayFn\">\r\n                <mat-option *ngFor=\"let ogcAutocomplete of filteredOgcAutocomplete[bundle.id] | async\" [value]=\"ogcAutocomplete\">\r\n                  {{ ogcAutocomplete.value }}\r\n                </mat-option>\r\n              </mat-autocomplete>\r\n          </mat-form-field>\r\n        </div>\r\n      </ng-container>\r\n    </div>\r\n  </div>\r\n</form>\r\n\r\n<div *ngIf=\"isTemporalOperator()\">\r\n  <mat-divider></mat-divider>\r\n  <h4 *ngIf=\"!currentFilter.title\">{{ 'igo.geo.filter.reportingDate' | translate }}</h4>\r\n  <h4 *ngIf=\"currentFilter.title\">{{ currentFilter.title }}</h4>\r\n  <igo-ogc-filter-time\r\n    [(datasource)]=\"datasource\"\r\n    [(currentFilter)]=\"currentFilter\"\r\n    (changeProperty)=\"changeProperty($event.value, $event.pos)\">\r\n  </igo-ogc-filter-time>\r\n</div>","import {\r\n  ChangeDetectorRef,\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  ViewChild\r\n} from '@angular/core';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { DOMService, DOMValue } from '@igo2/common';\r\n\r\nimport {\r\n  OgcFilterableDataSource,\r\n  IgoOgcFilterObject,\r\n  OgcPushButton,\r\n  OgcSelectorBundle,\r\n  SelectorGroup\r\n\r\n} from '../../filter/shared/ogc-filter.interface';\r\nimport { OgcFilterWriter } from '../../filter/shared/ogc-filter';\r\nimport { IgoMap } from '../../map';\r\nimport { OGCFilterService } from '../shared/ogc-filter.service';\r\nimport { WMSDataSource } from '../../datasource/shared/datasources/wms-datasource';\r\nimport { UntypedFormBuilder, UntypedFormGroup, Validators } from '@angular/forms';\r\nimport { debounceTime, map } from 'rxjs/operators';\r\nimport { OgcFilterOperator } from '../shared/ogc-filter.enum';\r\nimport { MatSelect } from '@angular/material/select';\r\nimport { MatOption } from '@angular/material/core';\r\nimport { BehaviorSubject, Observable } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filter-selection',\r\n  templateUrl: './ogc-filter-selection.component.html',\r\n  styleUrls: ['./ogc-filter-selection.component.scss'],\r\n  providers: [ DOMService ]\r\n})\r\nexport class OgcFilterSelectionComponent implements OnInit {\r\n\r\n  @ViewChild('selection') sel: MatSelect;\r\n\r\n  @Input() refreshFilters: () => void;\r\n\r\n  @Input() datasource: OgcFilterableDataSource;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() checkboxesIndex = 5;\r\n  @Input() radioButtonsIndex = 5;\r\n  @Input() baseIndex = 5;\r\n\r\n  @Input()\r\n  get currentFilter(): any {\r\n    return this._currentFilter;\r\n  }\r\n  set currentFilter(value) {\r\n    this._currentFilter = value;\r\n    if (this._currentFilter?.sliderOptions) {\r\n      this._currentFilter.sliderOptions.enabled = false; // remove slider toggle (animation temporelle)\r\n    }\r\n  }\r\n  private _currentFilter: any;\r\n\r\n  public ogcFilterOperator = OgcFilterOperator;\r\n\r\n  public form: UntypedFormGroup;\r\n  private ogcFilterWriter: OgcFilterWriter;\r\n  public color = 'primary';\r\n  public selectAllSelected = false;\r\n  public selectEnabled$ = new BehaviorSubject(undefined);\r\n  public selectEnableds$ = new BehaviorSubject([]);\r\n  public autocompleteEnabled$ = new BehaviorSubject(undefined);\r\n  public filteredOgcAutocomplete = {};\r\n\r\n  public applyFiltersTimeout;\r\n\r\n  get ogcFiltersSelectors() {\r\n    const ogcSelector = [];\r\n    if (this.datasource?.options?.ogcFilters?.pushButtons) {\r\n      ogcSelector.push(this.datasource?.options?.ogcFilters?.pushButtons);\r\n    }\r\n    if (this.datasource?.options?.ogcFilters?.checkboxes) {\r\n      ogcSelector.push(this.datasource?.options?.ogcFilters?.checkboxes);\r\n    }\r\n    if (this.datasource?.options?.ogcFilters?.radioButtons) {\r\n      ogcSelector.push(this.datasource?.options?.ogcFilters?.radioButtons);\r\n    }\r\n    if (this.datasource?.options?.ogcFilters?.select) {\r\n      ogcSelector.push(this.datasource?.options?.ogcFilters?.select);\r\n    }\r\n    if (this.datasource?.options?.ogcFilters?.autocomplete) {\r\n      ogcSelector.push(this.datasource?.options?.ogcFilters?.autocomplete);\r\n    }\r\n    ogcSelector.sort((a, b) => {\r\n      if (a.order < b.order) {\r\n        return -1;\r\n      }\r\n      if (a.order > b.order) {\r\n        return 1;\r\n      }\r\n      return 0;\r\n    });\r\n    return ogcSelector;\r\n  }\r\n\r\n  get currentPushButtonsGroup() {\r\n    return this.form.get('pushButtonsGroup').value;\r\n  }\r\n  set currentPushButtonsGroup(value) {\r\n    this.form.patchValue({ pushButtonsGroup: value });\r\n  }\r\n\r\n  get currentCheckboxesGroup() {\r\n    return this.form.get('checkboxesGroup').value;\r\n  }\r\n  set currentCheckboxesGroup(value) {\r\n    this.form.patchValue({ checkboxesGroup: value });\r\n  }\r\n\r\n  get currentRadioButtonsGroup() {\r\n    return this.form.get('radioButtonsGroup').value;\r\n  }\r\n  set currentRadioButtonsGroup(value) {\r\n    this.form.patchValue({ radioButtonsGroup: value });\r\n  }\r\n\r\n  get currentSelectGroup() {\r\n    return this.form.get('selectGroup').value;\r\n  }\r\n  set currentSelectGroup(value) {\r\n    this.form.patchValue({ selectGroup: value });\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n  get currentAutocompleteGroup() {\r\n    return this.form.get('autocompleteGroup').value;\r\n  }\r\n  set currentAutocompleteGroup(value) {\r\n    this.form.patchValue({ autocompleteGroup: value });\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n  get selectEnabled() {\r\n    return this.selectEnabled$.value;\r\n  }\r\n\r\n  set selectEnabled(value) {\r\n    this.selectEnabled$.next(value);\r\n    clearTimeout(this.applyFiltersTimeout);\r\n    this.currentSelectGroup.computedSelectors.forEach(compSelect => {\r\n      compSelect.selectors?.forEach(selector => {\r\n        value === selector ? selector.enabled = true : selector.enabled = false;\r\n      });\r\n    });\r\n\r\n    this.applyFiltersTimeout = setTimeout(() => {\r\n      this.applyFilters();\r\n    }, 750);\r\n  }\r\n\r\n  get selectEnableds() {\r\n    return this.selectEnableds$.value;\r\n  }\r\n\r\n  set selectEnableds(value) {\r\n    this.selectEnableds$.next(value);\r\n    clearTimeout(this.applyFiltersTimeout);\r\n    this.currentSelectGroup.computedSelectors.forEach(compSelect => {\r\n      compSelect.selectors?.forEach(selector => {\r\n        value.includes(selector) ? selector.enabled = true : selector.enabled = false;\r\n      });\r\n    });\r\n\r\n    this.applyFiltersTimeout = setTimeout(() => {\r\n      this.applyFilters();\r\n    }, 750);\r\n  }\r\n\r\n  get autocompleteEnabled() {\r\n    return this.autocompleteEnabled$.value;\r\n  }\r\n\r\n  set autocompleteEnabled(value) {\r\n    this.autocompleteEnabled$.next(value);\r\n    clearTimeout(this.applyFiltersTimeout);\r\n    this.currentAutocompleteGroup.computedSelectors.forEach(compSelect => {\r\n      compSelect.selectors?.forEach(selector => {\r\n        value === selector.title ? selector.enabled = true : selector.enabled = false;\r\n      });\r\n    });\r\n\r\n    this.applyFiltersTimeout = setTimeout(() => {\r\n      this.applyFilters();\r\n    }, 750);\r\n  }\r\n\r\n  constructor(\r\n    private ogcFilterService: OGCFilterService,\r\n    private formBuilder: UntypedFormBuilder,\r\n    private domService: DOMService,\r\n    private configService: ConfigService,\r\n    private cdRef: ChangeDetectorRef\r\n  ) {\r\n    this.ogcFilterWriter = new OgcFilterWriter();\r\n    this.buildForm();\r\n  }\r\n\r\n  private buildForm() {\r\n    this.form = this.formBuilder.group({\r\n      pushButtons: ['', [Validators.required]],\r\n      radioButtons: ['', [Validators.required]],\r\n      pushButtonsGroup: ['', [Validators.required]],\r\n      checkboxesGroup: ['', [Validators.required]],\r\n      radioButtonsGroup: ['', [Validators.required]],\r\n      selectGroup: ['', [Validators.required]],\r\n      select: ['', [Validators.required]],\r\n      selectMulti: ['', [Validators.required]],\r\n      autocompleteGroup: ['', [Validators.required]],\r\n      autocomplete: ['', [Validators.required]]\r\n    });\r\n  }\r\n\r\n  getPushButtonsGroups(): SelectorGroup[] {\r\n    if (this.datasource?.options?.ogcFilters?.pushButtons) {\r\n      return this.datasource.options.ogcFilters.pushButtons.groups;\r\n    }\r\n  }\r\n\r\n  getCheckboxesGroups(): SelectorGroup[] {\r\n    if (this.datasource?.options?.ogcFilters?.checkboxes) {\r\n      return this.datasource.options.ogcFilters.checkboxes.groups;\r\n    }\r\n  }\r\n\r\n  getRadioButtonsGroups(): SelectorGroup[] {\r\n    if (this.datasource?.options?.ogcFilters?.radioButtons) {\r\n      return this.datasource.options.ogcFilters.radioButtons.groups;\r\n    }\r\n  }\r\n\r\n  getSelectGroups(): SelectorGroup[] {\r\n    if (this.datasource?.options?.ogcFilters?.select) {\r\n      return this.datasource.options.ogcFilters.select.groups;\r\n    }\r\n  }\r\n\r\n  getAutocompleteGroups(): SelectorGroup[] {\r\n    if (this.datasource?.options?.ogcFilters?.autocomplete) {\r\n      return this.datasource.options.ogcFilters.autocomplete.groups;\r\n    }\r\n  }\r\n\r\n  async ngOnInit() {\r\n    if (this.datasource.options.ogcFilters) {\r\n      if (this.datasource.options.ogcFilters.pushButtons) {\r\n        this.currentPushButtonsGroup =\r\n          this.datasource.options.ogcFilters.pushButtons.groups.find(group => group.enabled) ||\r\n          this.datasource.options.ogcFilters.pushButtons.groups[0];\r\n      }\r\n      if (this.datasource.options.ogcFilters.checkboxes) {\r\n        this.currentCheckboxesGroup =\r\n          this.datasource.options.ogcFilters.checkboxes.groups.find(group => group.enabled) ||\r\n          this.datasource.options.ogcFilters.checkboxes.groups[0];\r\n      }\r\n      if (this.datasource.options.ogcFilters.radioButtons) {\r\n        this.currentRadioButtonsGroup =\r\n          this.datasource.options.ogcFilters.radioButtons.groups.find(group => group.enabled) ||\r\n          this.datasource.options.ogcFilters.radioButtons.groups[0];\r\n      }\r\n      if (this.datasource.options.ogcFilters.select) {\r\n        this.currentSelectGroup =\r\n          this.datasource.options.ogcFilters.select.groups.find(group => group.enabled) ||\r\n          this.datasource.options.ogcFilters.select.groups[0];\r\n        this.getSelectEnabled();\r\n        await this.getSelectDomValues();\r\n      }\r\n      if (this.datasource.options.ogcFilters.autocomplete) {\r\n        this.currentAutocompleteGroup =\r\n          this.datasource.options.ogcFilters.autocomplete.groups.find(group => group.enabled) ||\r\n          this.datasource.options.ogcFilters.autocomplete.groups[0];\r\n        this.getAutocompleteEnabled();\r\n        await this.getAutocompleteDomValues();\r\n      }\r\n      this.applyFilters();\r\n    }\r\n\r\n    this.form\r\n    .get('pushButtonsGroup')\r\n    .valueChanges\r\n    .pipe(debounceTime(750))\r\n    .subscribe(() => {\r\n      this.onPushButtonsChangeGroup();\r\n      this.applyFilters();\r\n      });\r\n    this.form\r\n    .get('checkboxesGroup')\r\n    .valueChanges\r\n    .pipe(debounceTime(750))\r\n    .subscribe(() => {\r\n      this.onCheckboxesChangeGroup();\r\n      this.applyFilters();\r\n      });\r\n    this.form\r\n      .get('radioButtonsGroup')\r\n      .valueChanges\r\n      .pipe(debounceTime(750))\r\n      .subscribe(() => {\r\n        this.onRadioButtonsChangeGroup();\r\n        this.applyFilters();\r\n      });\r\n    this.form\r\n      .get('selectGroup')\r\n      .valueChanges\r\n      .pipe(debounceTime(750))\r\n      .subscribe(() => {\r\n        this.onSelectChangeGroup();\r\n        this.applyFilters();\r\n      });\r\n    this.form\r\n      .get('autocompleteGroup')\r\n      .valueChanges\r\n      .pipe(debounceTime(750))\r\n      .subscribe(() => {\r\n        this.onAutocompleteChangeGroup();\r\n        this.applyFilters();\r\n      });\r\n    this.form\r\n      .get('pushButtons')\r\n      .valueChanges\r\n      .pipe(debounceTime(750))\r\n      .subscribe(() => {\r\n        this.applyFilters();\r\n      });\r\n    this.form\r\n      .get('radioButtons')\r\n      .valueChanges\r\n      .pipe(debounceTime(750))\r\n      .subscribe(() => {\r\n        this.applyFilters();\r\n      });\r\n  }\r\n\r\n  private getSelectEnabled() {\r\n    const enableds = [];\r\n    let enabled;\r\n    this.currentSelectGroup.computedSelectors.forEach(compSelect => {\r\n      if (compSelect.multiple) {\r\n        compSelect.selectors?.forEach(selector => {\r\n          if (selector.enabled) {\r\n            enableds.push(selector);\r\n          }\r\n        });\r\n        this.selectEnableds = enableds;\r\n        this.form.controls['selectMulti'].setValue(enableds);\r\n      } else {\r\n        compSelect.selectors?.forEach(selector => {\r\n          if (selector.enabled) {\r\n            enabled = selector;\r\n          }\r\n        });\r\n        this.form.controls['select'].reset(enabled);\r\n        this.selectEnabled$.subscribe((value) => {\r\n          if (this.form.controls['select'].value !== value) {\r\n            this.form.controls['select'].setValue(value);\r\n          }\r\n        });\r\n        this.selectEnabled = enabled;\r\n      }\r\n    });\r\n  }\r\n\r\n  private getAutocompleteEnabled() {\r\n    let enabled;\r\n    this.currentAutocompleteGroup.computedSelectors.forEach(compSelect => {\r\n      compSelect.selectors?.forEach(selector => {\r\n        if (selector.enabled) {\r\n          const dom = {\r\n            id: selector.filters.expression,\r\n            value: selector.title\r\n          };\r\n          enabled = selector.title;\r\n          this.form.controls['autocomplete'].setValue(dom);\r\n        }\r\n      });\r\n      this.autocompleteEnabled = enabled;\r\n    });\r\n  }\r\n\r\n  getToolTip(selector): string {\r\n    let toolTip;\r\n    if (selector.tooltip) {\r\n      if (Array.isArray(selector.tooltip)) {\r\n        toolTip = selector.tooltip.join('\\n');\r\n      } else {\r\n        toolTip = selector.tooltip;\r\n      }\r\n    }\r\n    return toolTip || '';\r\n  }\r\n\r\n  async getSelectDomValues() {\r\n    for (const bundle of this.datasource.options.ogcFilters.select.bundles) {\r\n      if (bundle.domSelectors) {\r\n        let domValues;\r\n        for (const domSelector of bundle.domSelectors) {\r\n          let filterDOM;\r\n          for (const domOptions of this.configService.getConfig('dom')) {\r\n            if (domSelector.id === domOptions.id || domSelector.name === domOptions.name) {\r\n              filterDOM = {\r\n                id: domOptions.id,\r\n                url: domOptions.url,\r\n                name: domOptions.name,\r\n                values: domOptions.values\r\n              };\r\n            }\r\n          }\r\n          filterDOM.url ? domValues = await this.domService.getDom(filterDOM) as DOMValue[] :\r\n            domValues = filterDOM.values;\r\n\r\n          if (domValues) {\r\n            let newBundle = bundle;\r\n            newBundle.selectors = [];\r\n            let selector;\r\n            for (const value of domValues) {\r\n              if (bundle.multiple) {\r\n                let enabled;\r\n                this.selectEnableds?.find(sel => sel.title === value.value) ? enabled = true : enabled = false;\r\n                selector = {\r\n                  title: value.value,\r\n                  enabled,\r\n                  filters: {\r\n                    operator: domSelector.operator,\r\n                    propertyName: domSelector.propertyName,\r\n                    expression: value.id,\r\n                  }\r\n                };\r\n              } else {\r\n                selector = {\r\n                  title: value.value,\r\n                  enabled: this.selectEnabled?.title === value.value ?\r\n                    true : false,\r\n                  filters: {\r\n                    operator: domSelector.operator,\r\n                    propertyName: domSelector.propertyName,\r\n                    expression: value.id,\r\n                  }\r\n                };\r\n              }\r\n              newBundle.selectors.push(selector);\r\n            }\r\n            this.getSelectGroups().find(group => group.ids.includes(newBundle.id)).computedSelectors\r\n              .find(comp => comp.title === newBundle.title).selectors = newBundle.selectors;\r\n          }\r\n        }\r\n        this.getSelectEnabled();\r\n      }\r\n    }\r\n  }\r\n\r\n  async getAutocompleteDomValues() {\r\n    for (const bundle of this.datasource.options.ogcFilters.autocomplete.bundles) {\r\n      if (bundle.domSelectors) {\r\n        let domValues;\r\n        for (const domSelector of bundle.domSelectors) {\r\n          let filterDOM;\r\n          for (const domOptions of this.configService.getConfig('dom')) {\r\n            if (domSelector.id === domOptions.id || domSelector.name === domOptions.name) {\r\n              filterDOM = {\r\n                id: domOptions.id,\r\n                url: domOptions.url,\r\n                name: domOptions.name,\r\n                values: domOptions.values\r\n              };\r\n            }\r\n          }\r\n          filterDOM.url ? domValues = await this.domService.getDom(filterDOM) as DOMValue[] :\r\n            domValues = filterDOM.values;\r\n\r\n          if (domValues) {\r\n            let newBundle = bundle;\r\n            newBundle.selectors = [];\r\n            let selector;\r\n            for (const value of domValues) {\r\n              selector = {\r\n                title: value.value,\r\n                enabled: this.autocompleteEnabled && this.autocompleteEnabled === value.value ?\r\n                  true : false,\r\n                filters: {\r\n                  operator: domSelector.operator,\r\n                  propertyName: domSelector.propertyName,\r\n                  expression: value.id,\r\n                }\r\n              };\r\n              newBundle.selectors.push(selector);\r\n            }\r\n            this.getAutocompleteGroups().find(group => group.ids.includes(newBundle.id)).computedSelectors\r\n              .find(comp => comp.title === newBundle.title).selectors = newBundle.selectors;\r\n          }\r\n        }\r\n\r\n        this.filteredOgcAutocomplete[bundle.id] = new Observable<any[]>();\r\n        this.cdRef.detectChanges();\r\n        this.filteredOgcAutocomplete[bundle.id] = this.form.controls['autocomplete'].valueChanges.pipe(\r\n          map(value => {\r\n            if (value.length) {\r\n              return domValues?.filter((option) => {\r\n                const filterNormalized = value ? value.toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g, '') : '';\r\n                const featureNameNormalized = option.value.toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n                return featureNameNormalized.includes(filterNormalized);\r\n              });\r\n            }\r\n          })\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  // getButtonStyle(pb: OgcPushButton): {} {\r\n\r\n  //   let styles;\r\n  //   if (pb.color) {\r\n  //     styles = {\r\n  //       'background-color': pb.enabled ? `rgba(${pb.color})` : `rgba(255,255,255,0)`\r\n  //     };\r\n  //   } else {\r\n  //     styles = {\r\n  //       'background-color': pb.enabled ? 'accent': `rgba(255,255,255,0)`,\r\n  //       'color': pb.enabled ? `rgba(0,0,0,0.9)` : `rgba(33,33,33,0.38)`\r\n  //     }\r\n  //   }\r\n  //   return styles;\r\n  // }\r\n\r\n  getButtonColor(pushButton: OgcPushButton): {} {\r\n    let styles;\r\n    if (pushButton.color && pushButton.enabled) {\r\n      styles = {\r\n        'background-color': `rgba(${pushButton.color})`\r\n      };\r\n    }\r\n    return styles;\r\n  }\r\n\r\n  bundleIsVertical(bundle: OgcSelectorBundle): boolean {\r\n    return bundle.vertical ? bundle.vertical : false;\r\n  }\r\n\r\n  private onPushButtonsChangeGroup() {\r\n    this.getPushButtonsGroups().map(group => group.enabled = false);\r\n    this.getPushButtonsGroups().find(group => group === this.currentPushButtonsGroup).enabled = true;\r\n  }\r\n\r\n  private onCheckboxesChangeGroup() {\r\n    this.getCheckboxesGroups().map(group => group.enabled = false);\r\n    this.getCheckboxesGroups().find(group => group === this.currentCheckboxesGroup).enabled = true;\r\n  }\r\n\r\n  private onRadioButtonsChangeGroup() {\r\n    this.getRadioButtonsGroups().map(group => group.enabled = false);\r\n    this.getRadioButtonsGroups().find(group => group === this.currentRadioButtonsGroup).enabled = true;\r\n  }\r\n\r\n  private onSelectChangeGroup() {\r\n    this.getSelectGroups().map(group => group.enabled = false);\r\n    this.getSelectGroups().find(group => group === this.currentSelectGroup).enabled = true;\r\n  }\r\n\r\n  private onAutocompleteChangeGroup() {\r\n    this.getAutocompleteGroups().map(group => group.enabled = false);\r\n    this.getAutocompleteGroups().find(group => group === this.currentAutocompleteGroup).enabled = true;\r\n  }\r\n\r\n  onSelectionChange(currentOgcSelection?, selectorType?) {\r\n    clearTimeout(this.applyFiltersTimeout);\r\n    if (selectorType === 'radioButton') {\r\n      this.emptyRadioButtons();\r\n    }\r\n\r\n    if (currentOgcSelection) {\r\n      currentOgcSelection.enabled = !currentOgcSelection.enabled;\r\n    }\r\n    this.applyFiltersTimeout = setTimeout(() => {\r\n      this.applyFilters();\r\n    }, 750);\r\n  }\r\n\r\n  emptyRadioButtons() {\r\n    this.currentRadioButtonsGroup.computedSelectors.forEach(compSelect => {\r\n      compSelect.selectors.map(selector => selector.enabled = false);\r\n\r\n      this.applyFiltersTimeout = setTimeout(() => {\r\n        this.applyFilters();\r\n      }, 750);\r\n   });\r\n  }\r\n\r\n  emptySelect() {\r\n    this.selectEnabled = undefined;\r\n  }\r\n\r\n  emptyAutocomplete() {\r\n    this.autocompleteEnabled = undefined;\r\n    this.form.controls['autocomplete'].setValue('');\r\n    this.form.controls['autocomplete'].markAsUntouched();\r\n  }\r\n\r\n  toggleAllSelection() {\r\n    if (this.selectAllSelected) {\r\n      const enableds = [];\r\n      this.currentSelectGroup.computedSelectors.forEach(compSelect => {\r\n        compSelect.selectors?.forEach(selector => {\r\n          enableds.push(selector);\r\n        });\r\n      });\r\n      this.sel.options.forEach((item: MatOption) => item.select());\r\n      this.selectEnableds = enableds;\r\n    } else {\r\n      this.sel.options.forEach((item: MatOption) => item.deselect());\r\n      this.selectEnableds = [];\r\n    }\r\n  }\r\n\r\n  selectOptionClick(value, bundle, event?) {\r\n    if (bundle.multiple) {\r\n      const enableds = this.selectEnableds;\r\n      let newStatus = true;\r\n      this.sel.options.forEach((item: MatOption) => {\r\n        if (!item.selected) {\r\n          newStatus = false;\r\n        }\r\n      });\r\n      this.selectAllSelected = newStatus;\r\n      if (event.isUserInput) {\r\n        if (enableds.length) {\r\n          for (const enabled of enableds) {\r\n            if (enabled.title === value.title) {\r\n              if (enabled.enabled && value.enabled) {\r\n                enableds.splice(enableds.indexOf(enabled), 1);\r\n                this.selectEnableds = enableds;\r\n                break;\r\n              }\r\n            } else if (enableds.indexOf(enabled) === enableds.length - 1) {\r\n              enableds.push(value);\r\n              this.selectEnableds = enableds;\r\n              break;\r\n            }\r\n          }\r\n        } else {\r\n          enableds.push(value);\r\n          this.selectEnableds = enableds;\r\n        }\r\n      }\r\n    } else {\r\n      this.selectEnabled = value;\r\n    }\r\n  }\r\n\r\n  autocompleteOptionClick(value) {\r\n    this.autocompleteEnabled = value.value;\r\n  }\r\n\r\n  displayFn(dom): string {\r\n    return dom ? dom.value : undefined;\r\n  }\r\n\r\n  private applyFilters() {\r\n    let filterQueryString = '';\r\n    const conditions = [];\r\n    const currentGroups = [this.currentPushButtonsGroup, this.currentCheckboxesGroup,\r\n      this.currentRadioButtonsGroup, this.currentSelectGroup, this.currentAutocompleteGroup];\r\n    for (const currentGroup of currentGroups) {\r\n      if (currentGroup.computedSelectors) {\r\n        currentGroup.computedSelectors.map(selectorBundle => {\r\n          const bundleCondition = [];\r\n          selectorBundle.selectors?.filter(ogcSelector => ogcSelector.enabled === true)\r\n          .forEach(enabledSelector => bundleCondition.push(enabledSelector.filters));\r\n          if (bundleCondition.length >= 1 ) {\r\n            if (bundleCondition.length === 1) {\r\n              conditions.push(bundleCondition[0]);\r\n            } else {\r\n              conditions.push({logical: selectorBundle.logical, filters: bundleCondition});\r\n            }\r\n          }\r\n        });\r\n      }\r\n    }\r\n    if (this.isTemporalOperator() && this._currentFilter.active) {\r\n      conditions.push(this.datasource.options.ogcFilters.interfaceOgcFilters[0]);\r\n    }\r\n    if (conditions.length >= 1) {\r\n      filterQueryString = this.ogcFilterWriter\r\n        .buildFilter(conditions.length === 1 ?\r\n          conditions[0] : {logical: 'And', filters: conditions } as IgoOgcFilterObject);\r\n    }\r\n    if (this.datasource.options.type === 'wms') {\r\n      this.ogcFilterService.filterByOgc(this.datasource as WMSDataSource, filterQueryString );\r\n    }\r\n    if (this.datasource.options.type === 'wfs') {\r\n      // TODO: Check how to prevent wfs to refresh when filter icon is pushed...\r\n      this.datasource.ol.refresh();\r\n    }\r\n    this.datasource.setOgcFilters(this.datasource.options.ogcFilters, true);\r\n  }\r\n\r\n  isMoreResults(bundle, type) {\r\n    let selectorsLength = 0;\r\n    for (const selectors of bundle.selectors) {\r\n      selectorsLength++;\r\n    }\r\n    const index = type === 'radio' ? this.radioButtonsIndex : this.checkboxesIndex;\r\n    return selectorsLength > index;\r\n  }\r\n\r\n  displayMoreResults(type) {\r\n    type === 'radio' ? this.radioButtonsIndex += 5 : this.checkboxesIndex += 5;\r\n    return;\r\n  }\r\n\r\n  isLessResults(bundle, type) {\r\n    let selectorsLength = 0;\r\n    for (const selectors of bundle.selectors) {\r\n      selectorsLength++;\r\n    }\r\n    const index = type === 'radio' ? this.radioButtonsIndex : this.checkboxesIndex;\r\n    return this.baseIndex !== index && selectorsLength > this.baseIndex;\r\n  }\r\n\r\n  displayLessResults(type) {\r\n    type === 'radio' ? this.radioButtonsIndex = this.baseIndex : this.checkboxesIndex = this.baseIndex;\r\n    return;\r\n  }\r\n\r\n  isTemporalOperator() {\r\n    return (\r\n      this.currentFilter?.operator?.toLowerCase() ===\r\n      this.ogcFilterOperator.During.toLowerCase()\r\n    );\r\n  }\r\n\r\n  changeProperty(value: any, pos?: number, refreshFilter = true) {\r\n    const detectedProperty = this.detectProperty(pos);\r\n    if (detectedProperty) {\r\n      this.datasource.options.ogcFilters.interfaceOgcFilters.find(\r\n        filter => filter.filterid === this.currentFilter.filterid\r\n      )[detectedProperty] = value;\r\n\r\n      if ( refreshFilter ) {\r\n        this.applyFilters();\r\n      }\r\n    }\r\n  }\r\n\r\n  detectProperty(pos?: number): string {\r\n    switch (this.currentFilter.operator) {\r\n      case OgcFilterOperator.PropertyIsNotEqualTo:\r\n      case OgcFilterOperator.PropertyIsEqualTo:\r\n      case OgcFilterOperator.PropertyIsGreaterThan:\r\n      case OgcFilterOperator.PropertyIsGreaterThanOrEqualTo:\r\n      case OgcFilterOperator.PropertyIsLessThan:\r\n      case OgcFilterOperator.PropertyIsLessThanOrEqualTo:\r\n        return 'expression';\r\n      case OgcFilterOperator.PropertyIsLike:\r\n        return 'pattern';\r\n      case OgcFilterOperator.PropertyIsBetween:\r\n        return pos && pos === 1\r\n          ? 'lowerBoundary'\r\n          : pos && pos === 2\r\n          ? 'upperBoundary'\r\n          : undefined;\r\n      case OgcFilterOperator.During:\r\n        return pos && pos === 1\r\n          ? 'begin'\r\n          : pos && pos === 2\r\n          ? 'end'\r\n          : undefined;\r\n      default:\r\n        return;\r\n    }\r\n  }\r\n}\r\n","<mat-tab-group\r\n  [selectedIndex]=\"selectedTypeIndex.value\"\r\n  (selectedIndexChange)=\"selectedTypeIndex.setValue($event)\"\r\n  (selectedTabChange)=\"onTypeChange($event)\">\r\n\r\n  <mat-tab [label]=\"'igo.geo.spatialFilter.predefined' |translate\">\r\n    <mat-form-field>\r\n      <mat-label>{{'igo.geo.spatialFilter.searchLabel' | translate}}</mat-label>\r\n      <mat-select (selectionChange)=\"onSelectionChange()\" [(value)]=\"selectedQueryType\">\r\n        <mat-option *ngFor=\"let queryType of queryType\" [value]=\"queryType\">\r\n          {{('igo.geo.terrapi.' + queryType) | translate}}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n    <igo-spatial-filter-list\r\n      [store]=\"store\"\r\n      [queryType]=\"selectedQueryType\"\r\n      [zone]=\"zone\"\r\n      [layers]=\"layers\"\r\n      (zoneChange)=\"zoneChange.emit($event)\"\r\n      (zoneWithBufferChange)=\"zoneWithBufferChange.emit($event)\"\r\n      (bufferChange)=\"bufferChange.emit($event)\"\r\n      (measureUnitChange)=\"measureUnitChange.emit($event)\">\r\n    </igo-spatial-filter-list>\r\n  </mat-tab>\r\n\r\n  <mat-tab [label]=\"'igo.geo.spatialFilter.draw' |translate\">\r\n    <div class=\"spatial-type-toggle\">\r\n      <mat-button-toggle-group\r\n        [value]=\"activeDrawType\"\r\n        (change)=\"onDrawTypeChange($event.value)\">\r\n        <mat-button-toggle [value]=\"spatialType.Polygon\" [matTooltip]=\"'igo.geo.spatialFilter.drawPolygon' |translate\">\r\n            <mat-icon svgIcon=\"pentagon-outline\"></mat-icon>\r\n        </mat-button-toggle>\r\n        <mat-button-toggle [value]=\"spatialType.Point\" [matTooltip]=\"'igo.geo.spatialFilter.drawCircle' |translate\">\r\n            <mat-icon svgIcon=\"record-circle-outline\"></mat-icon>\r\n        </mat-button-toggle>\r\n      </mat-button-toggle-group>\r\n    </div>\r\n  </mat-tab>\r\n\r\n</mat-tab-group>\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  ChangeDetectionStrategy,\r\n  Output,\r\n  EventEmitter\r\n} from '@angular/core';\r\nimport { SpatialFilterQueryType, SpatialFilterType } from '../../shared/spatial-filter.enum';\r\nimport { UntypedFormControl } from '@angular/forms';\r\nimport { EntityStore } from '@igo2/common';\r\nimport { Feature } from '../../../feature';\r\nimport { MeasureLengthUnit } from '../../../measure';\r\nimport { Layer } from '../../../layer';\r\n\r\n/**\r\n * Spatial Filter Type\r\n */\r\n@Component({\r\n  selector: 'igo-spatial-filter-type',\r\n  templateUrl: './spatial-filter-type.component.html',\r\n  styleUrls: ['./spatial-filter-type.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SpatialFilterTypeComponent implements OnInit {\r\n\r\n  @Input()\r\n  get store(): EntityStore<Feature> {\r\n    return this._store;\r\n  }\r\n  set store(store: EntityStore<Feature>) {\r\n    this._store = store;\r\n  }\r\n  private _store: EntityStore<Feature>;\r\n\r\n  public queryType: string[] = ['Arrond', 'CircFed', 'CircProv', 'DirReg', 'Mun', 'MRC', 'AdmRegion', 'RegTour'];\r\n  public selectedTypeIndex = new UntypedFormControl(0);\r\n\r\n  /**\r\n   * Reference to the SpatialFIlterType enum\r\n   * @internal\r\n   */\r\n  public spatialType = SpatialFilterType;\r\n\r\n  public activeDrawType: SpatialFilterType = this.spatialType.Polygon;\r\n\r\n  @Input() selectedQueryType: SpatialFilterQueryType;\r\n\r\n  @Input() zone: Feature;\r\n\r\n  @Input() layers: Layer[] = [];\r\n\r\n  public type: SpatialFilterType;\r\n\r\n  @Output() eventType = new EventEmitter<SpatialFilterType>();\r\n\r\n  @Output() eventQueryType = new EventEmitter<SpatialFilterQueryType>();\r\n\r\n  @Output() zoneChange = new EventEmitter<Feature>();\r\n  @Output() zoneWithBufferChange = new EventEmitter<Feature>();\r\n\r\n  @Output() bufferChange = new EventEmitter<number>();\r\n  @Output() measureUnitChange = new EventEmitter<MeasureLengthUnit>();\r\n\r\n  constructor() {}\r\n\r\n  ngOnInit() {\r\n    if (this.selectedTypeIndex.value === 0) {\r\n      this.type = this.spatialType.Predefined;\r\n    }\r\n    if (this.selectedTypeIndex.value === 1) {\r\n      this.type = this.activeDrawType;\r\n    }\r\n    this.eventType.emit(this.type);\r\n  }\r\n\r\n  onTypeChange(event) {\r\n    if (this.selectedTypeIndex.value === 0) {\r\n      this.type = SpatialFilterType.Predefined;\r\n    }\r\n    if (this.selectedTypeIndex.value === 1) {\r\n      this.type = this.activeDrawType;\r\n    }\r\n    this.eventType.emit(this.type);\r\n  }\r\n\r\n  onDrawTypeChange(spatialType: SpatialFilterType) {\r\n    this.activeDrawType = spatialType;\r\n    this.eventType.emit(this.activeDrawType);\r\n  }\r\n\r\n  onSelectionChange() {\r\n    this.eventQueryType.emit(this.selectedQueryType);\r\n    this.zoneChange.emit(undefined);\r\n  }\r\n}\r\n","<form class=\"form-list\">\r\n    <mat-form-field class=\"zone-list\">\r\n        <input #input type=\"text\" placeholder=\"{{'igo.geo.spatialFilter.listLabel' |translate}}\" matInput\r\n        [formControl]=\"formControl\" [matAutocomplete]=\"auto\">\r\n        <mat-autocomplete #auto=\"matAutocomplete\" (optionSelected)=\"onZoneChange($event.option.value)\"\r\n        [displayWith]=\"displayFn\">\r\n            <mat-option *ngFor=\"let entities of this.store.view.all$() | async\" [value]=\"entities\">\r\n                {{entities.properties.nom}}\r\n            </mat-option>\r\n        </mat-autocomplete>\r\n    </mat-form-field>\r\n<form>\r\n\r\n<div class=\"buffer-div\">\r\n    <form class=\"buffer-form\">\r\n        <mat-form-field class=\"buffer\">\r\n            <input type=\"number\" matInput placeholder=\"{{'igo.geo.spatialFilter.buffer' | translate}}\" [formControl]=\"bufferFormControl\"\r\n            [value]=\"0\" [readonly]=\"!zone\">\r\n        </mat-form-field>\r\n    </form>\r\n\r\n    <mat-form-field class=\"unit-field\">\r\n        <mat-select\r\n        [value]=\"measureUnit\"\r\n        (selectionChange)=\"onMeasureUnitChange($event.value)\">\r\n        <mat-option *ngFor=\"let measureUnit of measureUnits\" [value]=\"measureUnit\">\r\n            {{('igo.geo.measure.' + measureUnit) | translate}}\r\n        </mat-option>\r\n        </mat-select>\r\n    </mat-form-field>\r\n</div>\r\n","import { debounceTime, distinctUntilChanged } from 'rxjs/operators';\r\nimport { EntityStore } from '@igo2/common';\r\nimport { SpatialFilterService } from './../../shared/spatial-filter.service';\r\nimport { SpatialFilterQueryType, SpatialFilterType } from './../../shared/spatial-filter.enum';\r\nimport {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy,\r\n  Output,\r\n  EventEmitter\r\n} from '@angular/core';\r\nimport { Subscription } from 'rxjs';\r\nimport { UntypedFormControl } from '@angular/forms';\r\nimport { Feature } from '../../../feature';\r\nimport { MeasureLengthUnit } from '../../../measure/shared';\r\nimport { LanguageService, MessageService } from '@igo2/core';\r\nimport { Layer } from '../../../layer';\r\n\r\n@Component({\r\n  selector: 'igo-spatial-filter-list',\r\n  templateUrl: './spatial-filter-list.component.html',\r\n  styleUrls: ['./spatial-filter-list.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SpatialFilterListComponent implements OnInit, OnDestroy {\r\n\r\n  @Input()\r\n  get store(): EntityStore<Feature> {\r\n    return this._store;\r\n  }\r\n  set store(store: EntityStore<Feature>) {\r\n    this._store = store;\r\n  }\r\n  private _store: EntityStore<Feature>;\r\n\r\n  @Input()\r\n  get queryType(): SpatialFilterQueryType {\r\n    return this._queryType;\r\n  }\r\n  set queryType(queryType: SpatialFilterQueryType) {\r\n    this.formControl.setValue('');\r\n    this._queryType = queryType;\r\n  }\r\n  private _queryType: SpatialFilterQueryType;\r\n\r\n  @Input()\r\n  get zone() {\r\n    return this._zone;\r\n  }\r\n  set zone(value) {\r\n    this._zone = value;\r\n    if (!value) {\r\n      this.zoneWithBuffer = undefined;\r\n      this.bufferFormControl.setValue(0);\r\n    }\r\n  }\r\n  private _zone;\r\n\r\n  @Input() layers: Layer[] = [];\r\n\r\n  public zoneWithBuffer;\r\n  public selectedZone: any;\r\n\r\n  public measureUnit: MeasureLengthUnit = MeasureLengthUnit.Meters;\r\n\r\n  public formControl = new UntypedFormControl();\r\n\r\n  public bufferFormControl = new UntypedFormControl();\r\n\r\n  /**\r\n   * Available measure units for the measure type given\r\n   * @internal\r\n   */\r\n  get measureUnits(): string[] {\r\n    return [MeasureLengthUnit.Meters, MeasureLengthUnit.Kilometers];\r\n  }\r\n\r\n  @Output() zoneChange = new EventEmitter<Feature>();\r\n  @Output() zoneWithBufferChange = new EventEmitter<Feature>();\r\n  @Output() bufferChange = new EventEmitter<number>();\r\n  @Output() measureUnitChange = new EventEmitter<MeasureLengthUnit>();\r\n\r\n  formValueChanges$$: Subscription;\r\n  bufferValueChanges$$: Subscription;\r\n\r\n  constructor(\r\n    private spatialFilterService: SpatialFilterService,\r\n    private messageService: MessageService,\r\n    private languageService: LanguageService) {}\r\n\r\n  ngOnInit() {\r\n    this.formValueChanges$$ = this.formControl.valueChanges.subscribe((value) => {\r\n      if (value.length) {\r\n        this.store.view.filter((feature) => {\r\n          const filterNormalized = value.toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n          const featureNameNormalized = feature.properties.nom.toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n          return featureNameNormalized.includes(filterNormalized);\r\n        });\r\n      }\r\n    });\r\n\r\n    this.bufferValueChanges$$ = this.bufferFormControl.valueChanges\r\n      .pipe(\r\n        debounceTime(500),\r\n        distinctUntilChanged()\r\n      )\r\n      .subscribe((value) => {\r\n        if (this.measureUnit === MeasureLengthUnit.Meters && value > 0 && value <= 100000) {\r\n          this.bufferChange.emit(value);\r\n          this.spatialFilterService.loadBufferGeometry(\r\n            this.selectedZone,\r\n            SpatialFilterType.Predefined,\r\n            value,\r\n            this.queryType\r\n          ).subscribe((featureGeom: Feature) => {\r\n            this.zoneWithBuffer = featureGeom;\r\n            this.zoneWithBufferChange.emit(this.zoneWithBuffer);\r\n          });\r\n        } else if (this.measureUnit === MeasureLengthUnit.Kilometers && value > 0 && value <= 100) {\r\n          this.bufferChange.emit(value);\r\n          this.spatialFilterService.loadBufferGeometry(\r\n            this.selectedZone,\r\n            SpatialFilterType.Predefined,\r\n            value * 1000,\r\n            this.queryType\r\n          ).subscribe((featureGeom: Feature) => {\r\n            this.zoneWithBuffer = featureGeom;\r\n            this.zoneWithBufferChange.emit(this.zoneWithBuffer);\r\n          });\r\n        } else if (value === 0 && this.layers.length > 0) {\r\n          this.bufferChange.emit(value);\r\n          this.zoneWithBufferChange.emit(this.selectedZone);\r\n        } else if (\r\n            value < 0 ||\r\n            (this.measureUnit === MeasureLengthUnit.Meters && value > 100000) ||\r\n            (this.measureUnit === MeasureLengthUnit.Kilometers && value > 100)) {\r\n            this.bufferFormControl.setValue(0);\r\n            this.messageService.alert(this.languageService.translate.instant('igo.geo.spatialFilter.bufferAlert'),\r\n              this.languageService.translate.instant('igo.geo.spatialFilter.warning'));\r\n        }\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.formValueChanges$$.unsubscribe();\r\n  }\r\n\r\n  displayFn(feature?: Feature): string | undefined {\r\n    return feature ? feature.properties.nom : undefined;\r\n  }\r\n\r\n  onZoneChange(feature) {\r\n    if (feature && this.queryType) {\r\n      this.spatialFilterService.loadItemById(feature, this.queryType)\r\n      .subscribe((featureGeom: Feature) => {\r\n        this.selectedZone = featureGeom;\r\n        this.zoneChange.emit(featureGeom);\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set the measure unit\r\n   * @internal\r\n   */\r\n  onMeasureUnitChange(unit: MeasureLengthUnit) {\r\n    if (unit === this.measureUnit) {\r\n      return;\r\n    } else {\r\n      this.measureUnit = unit;\r\n      this.measureUnitChange.emit(this.measureUnit);\r\n      this.measureUnit === MeasureLengthUnit.Meters ?\r\n        this.bufferFormControl.setValue(this.bufferFormControl.value * 1000) :\r\n        this.bufferFormControl.setValue(this.bufferFormControl.value / 1000);\r\n    }\r\n  }\r\n}\r\n","<igo-geometry-form-field-input\r\n  [formControl]=\"formControl\"\r\n  [map]=\"map\"\r\n  [geometryType]=\"geometryType\"\r\n  [drawGuide]=\"drawGuide$ | async\"\r\n  [measure]=\"measure\"\r\n  [drawControlIsActive]=\"drawControlIsActive\"\r\n  [freehandDrawIsActive]=\"freehandDrawIsActive\"\r\n  [drawStyle]=\"drawStyle$ | async\"\r\n  [overlayStyle]=\"overlayStyle$ | async\"\r\n  [radius]=\"radius\">\r\n</igo-geometry-form-field-input>\r\n\r\n<div class=\"header\">\r\n    <mat-slide-toggle *ngIf=\"!isPredefined()\"\r\n      [checked]=\"drawControlIsActive\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onDrawControlChange()\">\r\n      {{'igo.geo.spatialFilter.drawControl' | translate}}\r\n    </mat-slide-toggle>\r\n    <mat-slide-toggle *ngIf=\"!isPredefined()\"\r\n      [checked]=\"freehandDrawIsActive\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onfreehandControlChange()\">\r\n      {{'igo.geo.spatialFilter.freehandControl' | translate}}\r\n    </mat-slide-toggle>\r\n</div>\r\n\r\n<div class=\"buffer-unit\" *ngIf=\"isPolygon()\">\r\n  <form class=\"buffer-form\">\r\n    <mat-form-field class=\"buffer\">\r\n      <input type=\"number\" matInput placeholder=\"{{'igo.geo.spatialFilter.buffer' | translate}}\" [formControl]=\"bufferFormControl\"\r\n      [value]=\"0\" [readonly]=\"this.formControl.value === null\">\r\n    </mat-form-field>\r\n  </form>\r\n\r\n  <mat-form-field class=\"unit-field\">\r\n    <mat-select\r\n    [value]=\"measureUnit\"\r\n    (selectionChange)=\"onMeasureUnitChange($event.value)\">\r\n    <mat-option *ngFor=\"let measureUnit of measureUnits\" [value]=\"measureUnit\">\r\n        {{('igo.geo.measure.' + measureUnit) | translate}}\r\n    </mat-option>\r\n    </mat-select>\r\n  </mat-form-field>\r\n</div>\r\n\r\n<div class=\"radius-unit\" *ngIf=\"isPoint()\">\r\n  <form class=\"radius-form\">\r\n    <mat-form-field class=\"radius\">\r\n      <input type=\"number\" matInput placeholder=\"{{'igo.geo.spatialFilter.radius' | translate}}\" [formControl]=\"radiusFormControl\"\r\n      [value]=\"1000\" (input)=\"getRadius()\" [readonly]=\"this.freehandDrawIsActive && this.formControl.value === null\">\r\n    </mat-form-field>\r\n  </form>\r\n\r\n  <mat-form-field class=\"unit-field\">\r\n    <mat-select\r\n    [value]=\"measureUnit\"\r\n    (selectionChange)=\"onMeasureUnitChange($event.value)\">\r\n    <mat-option *ngFor=\"let measureUnit of measureUnits\" [value]=\"measureUnit\">\r\n        {{('igo.geo.measure.' + measureUnit) | translate}}\r\n    </mat-option>\r\n    </mat-select>\r\n  </mat-form-field>\r\n</div>\r\n\r\n<mat-label class=\"title mat-typography\">{{'igo.geo.spatialFilter.search' | translate}} : </mat-label>\r\n<mat-radio-group [value]=\"selectedItemType\">\r\n    <mat-radio-button *ngFor=\"let item of itemType\"\r\n      [value]=\"item\"\r\n      (change)=\"onItemTypeChange($event)\">\r\n      {{'igo.geo.spatialFilter.' + item | translate}}\r\n    </mat-radio-button>\r\n</mat-radio-group>\r\n\r\n<div class=\"thematics\" *ngIf=\"(selectedItemType==='Thematics' && !tableTemplate) || (selectedItemType==='Thematics' && tableTemplate && !listIsVisible)\">\r\n  <mat-table>\r\n      <!-- Name Column -->\r\n      <ng-container matColumnDef=\"name\">\r\n        <mat-header-cell *matHeaderCellDef class=\"thematics-header\">{{'igo.geo.spatialFilter.Thematics' | translate}}</mat-header-cell>\r\n      </ng-container>\r\n\r\n      <!-- Select Column -->\r\n      <ng-container matColumnDef=\"select\">\r\n        <mat-header-cell *matHeaderCellDef class=\"checks-header\">\r\n          <mat-checkbox (change)=\"$event ? masterToggle() : null\"\r\n                        [checked]=\"isAllSelected()\"\r\n                        [indeterminate]=\"selectedThematics.hasValue() && !isAllSelected()\">\r\n          </mat-checkbox>\r\n        </mat-header-cell>\r\n    </ng-container>\r\n\r\n    <mat-header-row *matHeaderRowDef=\"displayedColumns\"></mat-header-row>\r\n    <mat-row *matRowDef=\"let row; columns: displayedColumns;\"></mat-row>\r\n\r\n  </mat-table>\r\n\r\n  <mat-tree [dataSource]=\"dataSource\" [treeControl]=\"treeControl\">\r\n    <!-- This is the tree node template for leaf nodes -->\r\n    <mat-tree-node *matTreeNodeDef=\"let node\" matTreeNodeToggle>\r\n      <li class=\"mat-tree-node\">\r\n        <!-- use a disabled button to provide padding for tree leaf -->\r\n        <button mat-icon-button disabled></button>\r\n        {{node.name}}\r\n        <mat-checkbox class=\"tree-check\" (click)=\"$event.stopPropagation()\"\r\n                      (change)=\"$event ? onToggleChange(node) : null\"\r\n                      [checked]=\"selectedThematics.isSelected(node)\">\r\n        </mat-checkbox>\r\n      </li>\r\n    </mat-tree-node>\r\n\r\n    <!-- This is the tree node template for expandable nodes -->\r\n    <mat-nested-tree-node *matTreeNodeDef=\"let node; when: hasChild\">\r\n        <div class=\"mat-tree-node\">\r\n          <button mat-icon-button\r\n            (click)=\"onToggleClick(node)\">\r\n            <mat-icon [svgIcon]=\"treeControl.isExpanded(node) ? 'chevron-down' : 'chevron-right'\"></mat-icon>\r\n          </button>\r\n          {{node.name}}\r\n          <mat-checkbox class=\"tree-check-2\" (change)=\"$event ? childrensToggle(node) : null\"\r\n                        [checked]=\"isAllSelected(node)\"\r\n                        [indeterminate]=\"hasChildrenSelected(node) && !isAllSelected(node)\">\r\n          </mat-checkbox>\r\n        </div>\r\n        <ul class=\"tree-ul\" [class.example-tree-invisible]=\"!treeControl.isExpanded(node)\">\r\n          <ng-container matTreeNodeOutlet></ng-container>\r\n        </ul>\r\n    </mat-nested-tree-node>\r\n\r\n  </mat-tree>\r\n</div>\r\n\r\n<div class=\"buttons\">\r\n\r\n  <button *ngIf=\"isPredefined()\" mat-raised-button class=\"clear-search-button\" [disabled]=\"disabledClearSearch()\"\r\n    (click)=\"clearSearch()\">\r\n      {{'igo.geo.spatialFilter.clearSearch' | translate}}\r\n  </button>\r\n\r\n  <button *ngIf=\"isPolygon() || isPoint()\" mat-raised-button class=\"clear-form-button\" [disabled]=\"this.formControl.value === null\"\r\n    (click)=\"clearDrawZone()\">\r\n    {{'igo.geo.spatialFilter.clearForm' | translate}}\r\n  </button>\r\n\r\n  <button mat-raised-button class=\"search-button\" [disabled]=\"disableSearchButton()\" color=\"primary\"\r\n    (click)=\"toggleSearchButton()\">\r\n    {{'igo.geo.spatialFilter.goSearch' | translate}}\r\n  </button>\r\n\r\n  <button mat-raised-button class=\"remove-button\" [disabled]=\"allLayers.length === 0\" (click)=\"clearButton()\">\r\n    {{'igo.geo.spatialFilter.removeLayer' | translate}}\r\n  </button>\r\n\r\n  <button mat-raised-button class=\"export-button\" [disabled]=\"!store.entities$.getValue().length\" (click)=\"export.emit()\">\r\n    {{'igo.geo.spatialFilter.exportLayer' | translate}}\r\n  </button>\r\n\r\n</div>\r\n\r\n<button\r\n  class=\"chevron-down\"\r\n  *ngIf=\"store.all().length && tableTemplate && !listIsVisible\"\r\n  mat-icon-button\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.spatialFilter.showSearchResults' | translate\"\r\n  (click)=\"toggleVisibleList()\">\r\n  <mat-icon svgIcon=\"chevron-down\"></mat-icon>\r\n</button>\r\n\r\n<div class=\"results\" *ngIf=\"store.all().length && tableTemplate && listIsVisible\">\r\n  <button\r\n    *ngIf=\"listIsVisible\"\r\n    mat-icon-button\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"'igo.geo.spatialFilter.hideSearchResults' | translate\"\r\n    (click)=\"toggleVisibleList()\">\r\n  <mat-icon svgIcon=\"chevron-up\"></mat-icon>\r\n  </button>\r\n  <igo-entity-table\r\n    class=\"results-list\"\r\n    [template]=\"tableTemplate\"\r\n    [store]=\"store\"\r\n    (entitySelectChange)=\"entityChange.emit($event)\">\r\n  </igo-entity-table>\r\n</div>\r\n","import OlFeature from 'ol/Feature';\r\nimport {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef,\r\n  Output,\r\n  EventEmitter,\r\n  OnDestroy,\r\n  OnInit\r\n} from '@angular/core';\r\nimport { SpatialFilterQueryType, SpatialFilterType } from '../../shared/spatial-filter.enum';\r\nimport { SelectionModel } from '@angular/cdk/collections';\r\nimport { IgoMap } from '../../../map';\r\nimport { SpatialFilterItemType } from './../../shared/spatial-filter.enum';\r\nimport { Feature } from './../../../feature/shared/feature.interfaces';\r\nimport { UntypedFormControl } from '@angular/forms';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport type { Type } from 'ol/geom/Geometry';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport { GeoJSONGeometry } from '../../../geometry/shared/geometry.interfaces';\r\nimport * as olStyle from 'ol/style';\r\nimport * as olproj from 'ol/proj';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport { MatTreeNestedDataSource } from '@angular/material/tree';\r\nimport { SpatialFilterService } from '../../shared/spatial-filter.service';\r\nimport { MeasureLengthUnit } from '../../../measure';\r\nimport { EntityStore, EntityStoreFilterSelectionStrategy, EntityTableColumnRenderer, EntityTableTemplate } from '@igo2/common';\r\nimport { Layer, VectorLayer } from '../../../layer/shared';\r\nimport { NestedTreeControl } from '@angular/cdk/tree';\r\nimport { SpatialFilterThematic } from './../../shared/spatial-filter.interface';\r\nimport { MessageService, LanguageService } from '@igo2/core';\r\nimport { debounceTime } from 'rxjs/operators';\r\n\r\nimport { FeatureMotion, FeatureStoreSelectionStrategy } from '../../../feature';\r\nimport { FeatureDataSource } from '../../../datasource/shared';\r\n\r\n/**\r\n * Spatial-Filter-Item (search parameters)\r\n */\r\n@Component({\r\n  selector: 'igo-spatial-filter-item',\r\n  templateUrl: './spatial-filter-item.component.html',\r\n  styleUrls: ['./spatial-filter-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SpatialFilterItemComponent implements OnDestroy, OnInit {\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input()\r\n  get type(): SpatialFilterType {\r\n    return this._type;\r\n  }\r\n  set type(type: SpatialFilterType) {\r\n    this._type = type;\r\n    const index = this.geometryTypes.findIndex(geom => geom === this.type);\r\n    this.geometryType = this.geometryTypes[index];\r\n    this.formControl.reset();\r\n    this.radius = undefined;\r\n    this.drawGuide$.next(null);\r\n    this.drawStyle$.next(undefined);\r\n\r\n    // Necessary to keep reference to the geometry form field input\r\n    if (this.type === SpatialFilterType.Predefined) {\r\n      const geojson: GeoJSONGeometry = {\r\n        type: 'Point',\r\n        coordinates: ''\r\n      };\r\n      this.formControl.setValue(geojson);\r\n    }\r\n\r\n    // Necessary to apply the right style when geometry type is Point\r\n    if (this.type === SpatialFilterType.Point) {\r\n      this.radius = 1000; // Base radius\r\n      this.radiusFormControl.setValue(this.radius);\r\n      this.PointStyle = (feature: OlFeature<OlGeometry>, resolution: number) => {\r\n        const geom = feature.getGeometry() as OlPoint;\r\n        const coordinates = olproj.transform(geom.getCoordinates(), this.map.projection, 'EPSG:4326');\r\n        return new olStyle.Style ({\r\n          image: new olStyle.Circle ({\r\n            radius: this.radius / (Math.cos((Math.PI / 180) * coordinates[1])) / resolution, // Latitude correction\r\n            stroke: new olStyle.Stroke({\r\n              width: 2,\r\n              color: 'rgba(0, 153, 255)'\r\n            }),\r\n            fill: new olStyle.Fill({\r\n              color: 'rgba(0, 153, 255, 0.2)'\r\n            })\r\n          })\r\n        });\r\n      };\r\n      this.overlayStyle = this.PointStyle;\r\n      this.drawStyle$.next(this.overlayStyle);\r\n    } else {\r\n      // If geometry types is Polygon\r\n      this.radius = undefined;\r\n      this.PolyStyle = () => {\r\n        return new olStyle.Style ({\r\n          stroke: new olStyle.Stroke({\r\n            width: 2,\r\n            color: 'rgba(0, 153, 255)'\r\n          }),\r\n          fill: new olStyle.Fill({\r\n            color: 'rgba(0, 153, 255, 0.2)'\r\n          })\r\n        });\r\n      };\r\n      const color = [0, 153, 255];\r\n      const drawStyle = () => {\r\n        return new olStyle.Style({\r\n          image: new olStyle.Circle ({\r\n            radius: 8,\r\n            stroke: new olStyle.Stroke({\r\n              width: 2,\r\n              color: 'rgba(0, 153, 255)'\r\n            }),\r\n            fill: new olStyle.Fill({\r\n              color: 'rgba(0, 153, 255, 0.2)'\r\n            })\r\n          }),\r\n          stroke: new olStyle.Stroke({\r\n            color: color.concat([1]),\r\n            width: 2\r\n          }),\r\n          fill:  new olStyle.Fill({\r\n            color: color.concat([0.2])\r\n          })\r\n        });\r\n      };\r\n      this.overlayStyle = this.PolyStyle;\r\n      this.drawStyle$.next(drawStyle);\r\n    }\r\n    this.overlayStyle$.next(this.overlayStyle);\r\n  }\r\n  private _type: SpatialFilterType;\r\n\r\n  @Input() queryType: SpatialFilterQueryType;\r\n\r\n  @Input() zone: Feature;\r\n\r\n  @Input() loading;\r\n\r\n  @Input()\r\n  get store(): EntityStore<Feature> {\r\n    return this._store;\r\n  }\r\n  set store(store: EntityStore<Feature>) {\r\n    this._store = store;\r\n    this._store.entities$.subscribe(() => { this.cdRef.detectChanges(); });\r\n  }\r\n  private _store: EntityStore<Feature>;\r\n\r\n  /**\r\n   * Available measure units for the measure type given\r\n   * @internal\r\n   */\r\n  get measureUnits(): string[] {\r\n    return [MeasureLengthUnit.Meters, MeasureLengthUnit.Kilometers];\r\n  }\r\n\r\n  @Input() layers: Layer[] = [];\r\n\r\n  @Input() allLayers: Layer[] = [];\r\n\r\n  @Input()\r\n  get thematicLength(): number {\r\n    return this._thematicLength;\r\n  }\r\n  set thematicLength(value: number) {\r\n    this._thematicLength = value;\r\n  }\r\n  private _thematicLength: number;\r\n\r\n  @Output() toggleSearch = new EventEmitter();\r\n\r\n  @Output() itemTypeChange = new EventEmitter<SpatialFilterItemType>();\r\n\r\n  @Output() thematicChange = new EventEmitter<SpatialFilterThematic[]>();\r\n\r\n  @Output() drawZoneEvent = new EventEmitter<Feature>();\r\n\r\n  @Output() bufferEvent = new EventEmitter<number>();\r\n  @Output() zoneWithBufferChange = new EventEmitter<Feature>();\r\n  @Output() measureUnitChange = new EventEmitter<MeasureLengthUnit>();\r\n\r\n  @Output() radiusEvent = new EventEmitter<number>();\r\n  @Output() freehandControl = new EventEmitter<boolean>();\r\n\r\n  @Output() clearButtonEvent = new EventEmitter();\r\n\r\n  @Output() clearSearchEvent = new EventEmitter();\r\n\r\n  @Output() export = new EventEmitter();\r\n\r\n  @Output() openWorkspace = new EventEmitter();\r\n  @Output() entityChange = new EventEmitter<any>();\r\n\r\n  public itemType: SpatialFilterItemType[] = [SpatialFilterItemType.Address, SpatialFilterItemType.Thematics];\r\n  public selectedItemType: SpatialFilterItemType = SpatialFilterItemType.Address;\r\n  public selectedSourceAddress;\r\n\r\n  treeControl: NestedTreeControl<SpatialFilterThematic> = new NestedTreeControl<SpatialFilterThematic>(node => node.children);\r\n\r\n  // For thematics and results tables\r\n  public displayedColumns: string[] = ['name', 'select'];\r\n  public childrens: SpatialFilterThematic[] = [];\r\n  public groups: string[] = [];\r\n  public thematics: SpatialFilterThematic[] = [];\r\n  public dataSource = new MatTreeNestedDataSource<SpatialFilterThematic>();\r\n  public selectedThematics = new SelectionModel<SpatialFilterThematic>(true, []);\r\n\r\n  // For geometry form field input\r\n  value$: BehaviorSubject<GeoJSONGeometry> = new BehaviorSubject(undefined);\r\n  drawGuide$: BehaviorSubject<number> = new BehaviorSubject(null);\r\n  overlayStyle$: BehaviorSubject<olStyle.Style | ((feature, resolution) => olStyle.Style)> = new BehaviorSubject(undefined);\r\n  drawStyle$: BehaviorSubject<olStyle.Style | ((feature, resolution) => olStyle.Style)> = new BehaviorSubject(undefined);\r\n\r\n  private value$$: Subscription;\r\n  private radiusChanges$$: Subscription;\r\n  private bufferChanges$$: Subscription;\r\n\r\n  public formControl = new UntypedFormControl();\r\n  public geometryType: Type | string;\r\n  public geometryTypeField = false;\r\n  public geometryTypes: string[] = ['Point', 'Polygon'];\r\n  public drawGuideField = false;\r\n  public drawGuide: number = null;\r\n  public drawGuidePlaceholder = '';\r\n  public measure = false;\r\n  public drawControlIsActive = true;\r\n  public freehandDrawIsActive = false;\r\n  public drawStyle: olStyle.Style | ((feature, resolution) => olStyle.Style);\r\n  public drawZone;\r\n  public overlayStyle: olStyle.Style | ((feature, resolution) => olStyle.Style);\r\n  public PointStyle: olStyle.Style | ((feature, resolution) => olStyle.Style);\r\n  public PolyStyle: olStyle.Style | ((feature, resolution) => olStyle.Style);\r\n\r\n  public radius: number;\r\n  public buffer: number = 0;\r\n  public radiusFormControl = new UntypedFormControl();\r\n  public bufferFormControl = new UntypedFormControl();\r\n\r\n  public measureUnit: MeasureLengthUnit = MeasureLengthUnit.Meters;\r\n  public zoneWithBuffer;\r\n\r\n  public listIsVisible = true;\r\n  public tableTemplate: EntityTableTemplate;\r\n\r\n  constructor(\r\n    private cdRef: ChangeDetectorRef,\r\n    private spatialFilterService: SpatialFilterService,\r\n    private messageService: MessageService,\r\n    private languageService: LanguageService) {}\r\n\r\n  ngOnInit() {\r\n    this.spatialFilterService.loadThematicsList()\r\n    .subscribe((items: SpatialFilterThematic[]) => {\r\n      for (const item of items) {\r\n        this.childrens.push(item);\r\n        this.childrens.sort((a, b) => {\r\n          return a.name.localeCompare(b.name);\r\n        });\r\n      }\r\n      this.groups.push(this.languageService.translate.instant('igo.geo.terrapi.limites'));\r\n      const limits: SpatialFilterThematic = {\r\n        name: this.groups[0],\r\n        children: []\r\n      };\r\n      this.thematics.push(limits);\r\n      this.childrens.forEach(child => {\r\n        if (child.group && (this.groups.indexOf(child.group) === -1)) {\r\n          this.groups.push(child.group);\r\n          const thematic: SpatialFilterThematic = {\r\n            name: child.group,\r\n            children: []\r\n          };\r\n          this.thematics.push(thematic);\r\n        }\r\n\r\n        if (!child.group) {\r\n          if (\r\n            child.name === this.languageService.translate.instant('igo.geo.terrapi.AdmRegion') ||\r\n            child.name === this.languageService.translate.instant('igo.geo.terrapi.Mun') ||\r\n            child.name === this.languageService.translate.instant('igo.geo.terrapi.Arrond') ||\r\n            child.name === this.languageService.translate.instant('igo.geo.terrapi.CircFed') ||\r\n            child.name === this.languageService.translate.instant('igo.geo.terrapi.CircProv') ||\r\n            child.name === this.languageService.translate.instant('igo.geo.terrapi.DirReg') ||\r\n            child.name === this.languageService.translate.instant('igo.geo.terrapi.MRC') ||\r\n            child.name === this.languageService.translate.instant('igo.geo.terrapi.RegTour')) {\r\n              child.group = limits.name;\r\n          } else if (child.name === this.languageService.translate.instant('igo.geo.terrapi.routes')) {\r\n            child.group = this.languageService.translate.instant('igo.geo.spatialFilter.group.transport');\r\n          } else {\r\n            const thematic: SpatialFilterThematic = {\r\n              name: child.name,\r\n              children: [],\r\n              source: child.source\r\n            };\r\n            this.thematics.push(thematic);\r\n          }\r\n        }\r\n        this.thematics.sort((a, b) => {\r\n          return a.name.localeCompare(b.name);\r\n        });\r\n      });\r\n      this.thematics.forEach(thematic => {\r\n        for (const child of this.childrens) {\r\n          if (child.group === thematic.name) {\r\n            thematic.children.push(child);\r\n          }\r\n        }\r\n      });\r\n    });\r\n\r\n    this.dataSource.data = this.thematics;\r\n\r\n    this.drawGuide$.next(null);\r\n    this.value$.next(this.formControl.value ? this.formControl.value : undefined);\r\n    this.value$$ = this.formControl.valueChanges.subscribe((value: GeoJSONGeometry) => {\r\n      if (value) {\r\n        this.value$.next(value);\r\n        this.drawZone = this.formControl.value as Feature;\r\n        if (this.buffer !== 0) {\r\n          this.drawZoneEvent.emit(this.drawZone);\r\n          this.bufferFormControl.setValue(this.buffer);\r\n        }\r\n      } else {\r\n        this.value$.next(undefined);\r\n        this.drawZone = undefined;\r\n      }\r\n    });\r\n\r\n    this.value$.subscribe(() => {\r\n      this.getRadius();\r\n      this.cdRef.detectChanges();\r\n    });\r\n\r\n    this.radiusChanges$$ = this.radiusFormControl.valueChanges.subscribe(() => {\r\n      this.getRadius();\r\n      this.cdRef.detectChanges();\r\n    });\r\n\r\n    this.bufferChanges$$ = this.bufferFormControl.valueChanges\r\n      .pipe(\r\n        debounceTime(500)\r\n      )\r\n      .subscribe((value) => {\r\n        if (this.measureUnit === MeasureLengthUnit.Meters && value > 0 && value <= 100000) {\r\n          this.buffer = value;\r\n          this.bufferEvent.emit(value);\r\n          this.spatialFilterService.loadBufferGeometry(\r\n            this.drawZone,\r\n            SpatialFilterType.Polygon,\r\n            value\r\n          ).subscribe((featureGeom: Feature) => {\r\n            this.zoneWithBuffer = featureGeom;\r\n            this.zoneWithBufferChange.emit(this.zoneWithBuffer);\r\n          });\r\n        } else if (this.measureUnit === MeasureLengthUnit.Kilometers && value > 0 && value <= 100) {\r\n          this.buffer = value;\r\n          this.bufferEvent.emit(value);\r\n          this.spatialFilterService.loadBufferGeometry(\r\n            this.drawZone,\r\n            SpatialFilterType.Polygon,\r\n            value * 1000\r\n          ).subscribe((featureGeom: Feature) => {\r\n            this.zoneWithBuffer = featureGeom;\r\n            this.zoneWithBufferChange.emit(this.zoneWithBuffer);\r\n          });\r\n        } else if (value === 0) {\r\n          this.buffer = value;\r\n          this.bufferEvent.emit(value);\r\n          this.drawZoneEvent.emit(this.drawZone);\r\n        } else if (\r\n          value < 0 ||\r\n          (this.measureUnit === MeasureLengthUnit.Meters && value > 100000) ||\r\n          (this.measureUnit === MeasureLengthUnit.Kilometers && value > 100)) {\r\n            this.bufferFormControl.setValue(0);\r\n            this.buffer = 0;\r\n            this.messageService.alert(this.languageService.translate.instant('igo.geo.spatialFilter.bufferAlert'),\r\n              this.languageService.translate.instant('igo.geo.spatialFilter.warning'));\r\n        }\r\n    });\r\n\r\n    const selectedRecordStrategy = new EntityStoreFilterSelectionStrategy({});\r\n    const selectionStrategy = new FeatureStoreSelectionStrategy({\r\n      layer: new VectorLayer({\r\n        zIndex: 300,\r\n        source: new FeatureDataSource(),\r\n        style: undefined,\r\n        showInLayerList: false,\r\n        exportable: false,\r\n        browsable: false\r\n      }),\r\n      map: this.map,\r\n      hitTolerance: 15,\r\n      motion: FeatureMotion.Default,\r\n      many: true,\r\n      dragBox: true\r\n    });\r\n\r\n    this.store.addStrategy(selectionStrategy, true);\r\n    this.store.addStrategy(selectedRecordStrategy, false);\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to the value stream\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.value$$.unsubscribe();\r\n    this.radiusChanges$$.unsubscribe();\r\n    this.bufferChanges$$.unsubscribe();\r\n    this.cdRef.detach();\r\n    if (this.radiusChanges$$) {\r\n      this.radiusChanges$$.unsubscribe();\r\n    }\r\n    if (this.value$$) {\r\n      this.value$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  onItemTypeChange(event) {\r\n    this.selectedItemType = event.value;\r\n    this.itemTypeChange.emit(this.selectedItemType);\r\n  }\r\n\r\n  /**\r\n   * Set the measure unit\r\n   * @internal\r\n   */\r\n  onMeasureUnitChange(unit: MeasureLengthUnit) {\r\n    if (unit === this.measureUnit) {\r\n      return;\r\n    } else {\r\n      this.measureUnit = unit;\r\n      this.measureUnitChange.emit(this.measureUnit);\r\n      if (this.isPolygon()) {\r\n        this.measureUnit === MeasureLengthUnit.Meters ?\r\n          this.bufferFormControl.setValue(this.bufferFormControl.value * 1000) :\r\n          this.bufferFormControl.setValue(this.bufferFormControl.value / 1000);\r\n      } else if (this.isPoint()) {\r\n        this.measureUnit === MeasureLengthUnit.Meters ?\r\n          this.radiusFormControl.setValue(this.radiusFormControl.value * 1000) :\r\n          this.radiusFormControl.setValue(this.radiusFormControl.value / 1000);\r\n      }\r\n    }\r\n  }\r\n\r\n  isPredefined() {\r\n    return this.type === SpatialFilterType.Predefined;\r\n  }\r\n\r\n  isPolygon() {\r\n    return this.type === SpatialFilterType.Polygon;\r\n  }\r\n\r\n  isPoint() {\r\n    return this.type === SpatialFilterType.Point;\r\n  }\r\n\r\n  hasChild(_: number, node: SpatialFilterThematic) {\r\n    if (node.children) {\r\n      return node.children.length;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  onToggleClick(node: SpatialFilterThematic) {\r\n    this.treeControl.isExpanded(node) ? this.treeControl.collapse(node) : this.treeControl.expand(node);\r\n  }\r\n\r\n  isAllSelected(node?: SpatialFilterThematic) {\r\n    let numSelected;\r\n    let numNodes = 0;\r\n    if (!node) {\r\n      numSelected = this.selectedThematics.selected.length;\r\n      this.thematics.forEach(thematic => {\r\n        if (this.groups.indexOf(thematic.name) === -1) {\r\n          numNodes++;\r\n        }\r\n      });\r\n      this.childrens.forEach(children => {\r\n        if (!this.thematics.find(thematic => thematic.source === children.source)) {\r\n          numNodes++;\r\n        }\r\n      });\r\n    } else {\r\n      numSelected = node.children.length;\r\n      node.children.forEach(children => {\r\n        if (this.selectedThematics.selected.find(thematic => thematic === children)) {\r\n          numNodes++;\r\n        }\r\n      });\r\n    }\r\n\r\n    if (numNodes >= 1) {\r\n      return numSelected === numNodes;\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  hasChildrenSelected(node: SpatialFilterThematic) {\r\n    let bool = false;\r\n    node.children.forEach(child => {\r\n      if (this.selectedThematics.selected.find(thematic => thematic.source === child.source)) {\r\n        bool = true;\r\n      }\r\n    });\r\n    return bool;\r\n  }\r\n\r\n  /**\r\n   * Apply header checkbox\r\n   */\r\n  masterToggle() {\r\n    this.isAllSelected() ?\r\n      this.selectedThematics.clear() :\r\n      this.selectAll();\r\n\r\n    const selectedThematicsName: SpatialFilterThematic[] = [];\r\n    for (const thematic of this.selectedThematics.selected) {\r\n      selectedThematicsName.push(thematic);\r\n    }\r\n\r\n    if (this.isAllSelected()) {\r\n      this.thematics.forEach(thematic => {\r\n        if (this.hasChild(0, thematic)) {\r\n          this.treeControl.expand(thematic);\r\n        }\r\n      });\r\n    } else {\r\n      this.thematics.forEach(thematic => {\r\n        if (this.hasChild(0, thematic)) {\r\n          this.treeControl.collapse(thematic);\r\n        }\r\n      });\r\n    }\r\n    this.thematicChange.emit(selectedThematicsName);\r\n  }\r\n\r\n  selectAll(node?: SpatialFilterThematic) {\r\n    if (!node) {\r\n      this.thematics.forEach(thematic => {\r\n        if (this.groups.indexOf(thematic.name) === -1) {\r\n          this.selectedThematics.select(thematic);\r\n        }\r\n      });\r\n      this.childrens.forEach(children => {\r\n        if (!this.selectedThematics.selected.find(thematic => thematic.source === children.source)) {\r\n          this.selectedThematics.select(children);\r\n        }\r\n      });\r\n    } else {\r\n      if (this.hasChild(0, node)) {\r\n        node.children.forEach(children => this.selectedThematics.select(children));\r\n      }\r\n    }\r\n  }\r\n\r\n  childrensToggle(node: SpatialFilterThematic) {\r\n    this.isAllSelected(node) ?\r\n    node.children.forEach(child => this.selectedThematics.deselect(child)) :\r\n    this.selectAll(node);\r\n\r\n    const selectedThematicsName: SpatialFilterThematic[] = [];\r\n    for (const thematic of this.selectedThematics.selected) {\r\n      selectedThematicsName.push(thematic);\r\n    }\r\n    this.treeControl.expand(node);\r\n    this.thematicChange.emit(selectedThematicsName);\r\n  }\r\n\r\n  /**\r\n   * Apply changes to the thematics selected tree and emit event\r\n   */\r\n  onToggleChange(nodeSelected: SpatialFilterThematic) {\r\n    let selected = false;\r\n    if (this.selectedThematics.selected.find(thematic => thematic.source === nodeSelected.source) !== undefined) {\r\n      selected = true;\r\n    }\r\n\r\n    this.childrens.forEach(children => {\r\n      if (children === nodeSelected && selected === false) {\r\n        this.selectedThematics.select(children);\r\n      }\r\n      if (children === nodeSelected && selected === true) {\r\n        this.selectedThematics.deselect(children);\r\n      }\r\n    });\r\n    this.thematics.forEach(thematic => {\r\n      if (thematic === nodeSelected && selected === false) {\r\n        this.selectedThematics.select(thematic);\r\n      }\r\n      if (thematic === nodeSelected && selected === true) {\r\n        this.selectedThematics.deselect(thematic);\r\n      }\r\n    });\r\n\r\n    const selectedThematicsName: SpatialFilterThematic[] = [];\r\n    for (const thematic of this.selectedThematics.selected) {\r\n      selectedThematicsName.push(thematic);\r\n    }\r\n    this.thematicChange.emit(selectedThematicsName);\r\n  }\r\n\r\n  onDrawControlChange() {\r\n    this.drawControlIsActive = !this.drawControlIsActive;\r\n  }\r\n\r\n  onfreehandControlChange() {\r\n    this.freehandDrawIsActive = !this.freehandDrawIsActive;\r\n    this.freehandControl.emit(this.freehandDrawIsActive);\r\n  }\r\n\r\n  /**\r\n   * Launch search button\r\n   */\r\n  toggleSearchButton() {\r\n    if (!this.isPredefined()) {\r\n      if (this.buffer > 0) {\r\n        this.zoneWithBuffer.meta = {\r\n          id: undefined,\r\n          title: 'Zone'\r\n        };\r\n        this.zoneWithBuffer.properties = {\r\n          nom: 'Zone',\r\n          type: this.type as string\r\n        };\r\n        this.drawZoneEvent.emit(this.zoneWithBuffer);\r\n      } else {\r\n        this.drawZone.meta = {\r\n          id: undefined,\r\n          title: 'Zone'\r\n        };\r\n        this.drawZone.properties = {\r\n          nom: 'Zone',\r\n          type: this.type as string\r\n        };\r\n        this.drawZoneEvent.emit(this.drawZone);\r\n      }\r\n    }\r\n    if (this.isPoint()) {\r\n      this.radiusEvent.emit(this.radius);\r\n    } else if (this.isPolygon()) {\r\n      this.bufferEvent.emit(this.buffer);\r\n    }\r\n    this.toggleSearch.emit();\r\n    this.store.entities$.pipe(\r\n      debounceTime(500)\r\n    ).subscribe((value) => {\r\n      if (value.length && this.layers.length === this.thematicLength + 1) {\r\n        this.openWorkspace.emit();\r\n        this.createTableTemplate();\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Launch clear button (clear store and map layers)\r\n   */\r\n  clearButton() {\r\n    this.loading = true;\r\n    if (this.store) {\r\n      this.store.clear();\r\n    }\r\n    if (this.isPoint() || this.isPolygon()) {\r\n      this.drawZone = undefined;\r\n      this.formControl.reset();\r\n    }\r\n    this.bufferFormControl.setValue(0);\r\n    this.buffer = 0;\r\n    this.bufferEvent.emit(0);\r\n    this.clearButtonEvent.emit();\r\n    this.loading = false;\r\n    this.tableTemplate = undefined;\r\n  }\r\n\r\n  clearDrawZone() {\r\n    this.formControl.reset();\r\n    this.bufferFormControl.setValue(0);\r\n    this.buffer = 0;\r\n  }\r\n\r\n  /**\r\n   * Launch clear search (clear field if type is predefined)\r\n   */\r\n  clearSearch() {\r\n    this.selectedThematics.clear();\r\n    this.bufferFormControl.setValue(0);\r\n    this.buffer = 0;\r\n    this.bufferEvent.emit(0);\r\n    this.thematicChange.emit([]);\r\n    this.clearSearchEvent.emit();\r\n  }\r\n\r\n  /**\r\n   * Verify conditions of incomplete fields or busy service\r\n   */\r\n  disableSearchButton(): boolean {\r\n    if (this.type === SpatialFilterType.Predefined) {\r\n      if (this.selectedItemType === SpatialFilterItemType.Address) {\r\n        if (this.queryType !== undefined && this.zone !== undefined) {\r\n          return this.loading;\r\n        }\r\n      }\r\n      if (this.selectedItemType === SpatialFilterItemType.Thematics) {\r\n        if (this.queryType !== undefined && this.zone !== undefined && this.selectedThematics.selected.length > 0) {\r\n          return this.loading;\r\n        }\r\n      }\r\n    }\r\n    if (this.type === SpatialFilterType.Polygon || this.type === SpatialFilterType.Point) {\r\n      if (this.selectedItemType === SpatialFilterItemType.Address && this.formControl.value !== null) {\r\n        return this.loading;\r\n      }\r\n      if (this.selectedItemType === SpatialFilterItemType.Thematics) {\r\n        if (this.selectedThematics.selected.length > 0 && this.formControl.value !== null) {\r\n          return this.loading;\r\n        }\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n\r\n  disabledClearSearch() {\r\n    let disable = true;\r\n    this.selectedItemType === SpatialFilterItemType.Address ?\r\n      disable = this.queryType === undefined :\r\n      disable = this.queryType === undefined && this.selectedThematics.selected.length === 0;\r\n\r\n    return disable;\r\n  }\r\n\r\n  /**\r\n   * Manage radius value at user change\r\n   */\r\n  getRadius() {\r\n    let formValue;\r\n    if (this.formControl.value !== null) {\r\n      this.measureUnit === MeasureLengthUnit.Meters ?\r\n        formValue = this.formControl.value.radius :\r\n        formValue = this.formControl.value.radius / 1000;\r\n    } else {\r\n      formValue = undefined;\r\n    }\r\n\r\n    if (this.type === SpatialFilterType.Point) {\r\n      if (!this.freehandDrawIsActive) {\r\n        if (\r\n          this.radiusFormControl.value < 0 ||\r\n          (this.measureUnit === MeasureLengthUnit.Meters && this.radiusFormControl.value >= 100000) ||\r\n          (this.measureUnit === MeasureLengthUnit.Kilometers && this.radiusFormControl.value >= 100)) {\r\n          this.messageService.alert(this.languageService.translate.instant('igo.geo.spatialFilter.radiusAlert'),\r\n            this.languageService.translate.instant('igo.geo.spatialFilter.warning'));\r\n          this.radius = 1000;\r\n          this.measureUnit === MeasureLengthUnit.Meters ?\r\n            this.radiusFormControl.setValue(this.radius) :\r\n            this.radiusFormControl.setValue(this.radius / 1000);\r\n          this.drawGuide$.next(this.radius);\r\n          return;\r\n        }\r\n      } else {\r\n        if (formValue) {\r\n          if (formValue >= 100000) {\r\n            this.messageService.alert(this.languageService.translate.instant('igo.geo.spatialFilter.radiusAlert'),\r\n              this.languageService.translate.instant('igo.geo.spatialFilter.warning'));\r\n            this.formControl.reset();\r\n            return;\r\n          }\r\n          if (formValue !== this.radiusFormControl.value) {\r\n            this.radiusFormControl.setValue(formValue);\r\n            return;\r\n          }\r\n        }\r\n      }\r\n      if (this.measureUnit === MeasureLengthUnit.Meters) {\r\n        this.radius = this.radiusFormControl.value;\r\n        this.drawGuide$.next(this.radius);\r\n      } else {\r\n        this.radius = this.radiusFormControl.value * 1000;\r\n        this.drawGuide$.next(this.radius * 1000);\r\n      }\r\n      this.overlayStyle$.next(this.PointStyle);\r\n      this.drawStyle$.next(this.PointStyle);\r\n    }\r\n  }\r\n\r\n  toggleVisibleList() {\r\n    this.listIsVisible = !this.listIsVisible;\r\n  }\r\n\r\n  private createTableTemplate() {\r\n    const typeColumn = {\r\n      name: 'meta.title',\r\n      title: this.languageService.translate.instant('igo.geo.spatialFilter.type'),\r\n      renderer: EntityTableColumnRenderer.UnsanitizedHTML\r\n    };\r\n    const nameColumn = {\r\n      name: 'properties.nom',\r\n      title: this.languageService.translate.instant('igo.geo.spatialFilter.searchResults'),\r\n      renderer: EntityTableColumnRenderer.UnsanitizedHTML\r\n    };\r\n    const columns = [typeColumn, nameColumn];\r\n\r\n    this.tableTemplate = {\r\n      selection: true,\r\n      sort: true,\r\n      columns\r\n    };\r\n  }\r\n}\r\n","<div class=\"datetime-container\">\r\n  <mat-slide-toggle \r\n    *ngIf=\"this.currentFilter.sliderOptions?.enabled\"\r\n    [(ngModel)]=\"sliderMode\"\r\n    (change)=\"modeChange($event)\">\r\n    {{'igo.geo.filter.sliderModeTitle' | translate}}\r\n  </mat-slide-toggle>\r\n\r\n  <div class=\"slider-container\" *ngIf=\"sliderMode\">\r\n    <igo-ogc-filter-time-slider\r\n      [begin]=\"beginValue\"\r\n      [max]=\"this.restrictedToStep() ? this.maxDate : this.endValue\"\r\n      [currentFilter]=\"currentFilter\" \r\n      [datasource]=\"datasource\"\r\n      (changeProperty)=\"changePropertyByPass($event)\"\r\n    >\r\n    </igo-ogc-filter-time-slider>\r\n    \r\n  </div>\r\n\r\n  <div *ngIf=\"!sliderMode\">\r\n\r\n    <div class=\"year-input-container\" *ngIf=\"calendarTypeYear\">\r\n      <!-- to emulate a year-picker, 2 input: first input to show user just year and second input hiden and bind \r\n        with the datepicker  -->\r\n      <mat-form-field  class=\"year-input\">\r\n        <mat-label>{{'igo.geo.timeFilter.startYear'| translate}}</mat-label>\r\n        <input\r\n          matInput\r\n          class=\"year-input-only-year\"\r\n          value=\"{{onlyYearBegin}}\"\r\n          (change)= \"yearOnlyInputChange($event, beginDatepicker, 'begin')\"\r\n          [disabled]= \"filterStateDisable\"\r\n          >\r\n        <mat-datepicker-toggle matSuffix [for]=\"beginDatepicker\" [disabled]=\"filterStateDisable\"></mat-datepicker-toggle>\r\n  \r\n        <mat-datepicker\r\n          panelClass=\"datepicker-year\"\r\n          #beginDatepicker\r\n          [startView]=\"calendarView()\"\r\n          [startAt]=\"beginValue\"\r\n          (yearSelected)=\"yearSelected($event, beginDatepicker, 'begin')\"\r\n          >\r\n        </mat-datepicker>\r\n\r\n        <input #beginYear\r\n          class= \"year-input-hide\"\r\n          matInput\r\n          [matDatepicker]=\"beginDatepicker\"\r\n          enabled= false\r\n          readonly= true\r\n          [value]=\"beginValue?beginValue:handleDate(datasource.options.minDate)\"\r\n          [min]=\"handleDate(datasource.options.minDate)\"\r\n          [max]=\"(endValue && (!restrictedToStep()))?endValue:handleDate(datasource.options.maxDate)\"\r\n          >\r\n      </mat-form-field>\r\n\r\n      <mat-form-field  class=\"year-input\">\r\n        <mat-label>{{'igo.geo.timeFilter.endYear'| translate}}</mat-label>\r\n        <input\r\n          matInput\r\n          class=\"year-input-only-year\"\r\n          value=\"{{onlyYearEnd}}\"\r\n          (change)= \"yearOnlyInputChange($event, endDatepicker, 'end')\"\r\n          [disabled] = \"filterStateDisable\">\r\n        <mat-datepicker-toggle matSuffix [for]=\"endDatepicker\" [disabled]=\"filterStateDisable\"></mat-datepicker-toggle>\r\n        <mat-datepicker\r\n          panelClass=\"datepicker-year\"\r\n          #endDatepicker\r\n          [startView]=\"calendarView()\"\r\n          [startAt]=\"endValue\"\r\n          (yearSelected)=\"yearSelected($event, endDatepicker, 'end')\"\r\n          >\r\n        </mat-datepicker>\r\n\r\n        <input #endYear\r\n          class= \"year-input-hide\"\r\n          matInput\r\n          [matDatepicker]=\"endDatepicker\"\r\n          enabled= false\r\n          readonly= true\r\n          [value]=\"endValue?endValue:handleDate(datasource.options.maxDate)\"\r\n          [min]=\"beginValue?beginValue:handleDate(datasource.options.minDate)\"\r\n          [max]=\"handleDate(datasource.options.maxDate)\"\r\n          >\r\n      </mat-form-field>\r\n      <button class=\"reset-button\" \r\n        mat-icon-button\r\n        color=\"primary\" \r\n        (click)=\"resetFilter()\" \r\n        [matTooltip]=\"'igo.geo.filter.resetFilters' | translate\" \r\n        [disabled]= \"filterStateDisable\">\r\n        <mat-icon svgIcon=\"{{resetIcon}}\"></mat-icon>\r\n      </button>\r\n      <mat-slide-toggle \r\n        class='toggle-filter-state' \r\n        (change)=\"toggleFilterState()\" \r\n        [matTooltip]=\"'igo.geo.filter.toggleFilterState' | translate\" \r\n        tooltip-position=\"below\" \r\n        matTooltipShowDelay=\"500\"\r\n        [checked]=\"!filterStateDisable\">\r\n      </mat-slide-toggle>\r\n\r\n    </div>\r\n\r\n    <div class=\"datetime-input-container\" *ngIf=\"calendarType()!=='year'\">\r\n      <div class=\"datetime-input\">\r\n        <mat-form-field class=\"date-input\">\r\n          <mat-datepicker-toggle matSuffix [for]=\"beginDatepicker\" [disabled]= \"filterStateDisable\"></mat-datepicker-toggle>\r\n          <input #begin\r\n            matInput\r\n            [matDatepicker]=\"beginDatepicker\"\r\n            [placeholder]=\"'igo.geo.timeFilter.startDate' | translate\"\r\n            [attr.disabled]=\"!currentFilter.active\"\r\n            (dateChange)=\"changeTemporalProperty(begin.value, 1)\"\r\n            [matDatepickerFilter]=\"dateFilter.bind(this, 'begin')\"\r\n            [value]=\"beginValue?beginValue:handleDate(datasource.options.minDate)\"\r\n            [min]=\"handleDate(datasource.options.minDate)\"\r\n            [max]=\"(endValue && (!restrictedToStep()))?endValue:handleDate(datasource.options.maxDate)\" \r\n            [disabled]= \"filterStateDisable\">\r\n          <span class=\"filler\"></span>\r\n          <mat-datepicker\r\n            #beginDatepicker\r\n            [startView]=\"calendarView()\"\r\n            [startAt]=\"beginValue\"\r\n            (yearSelected)=\"yearSelected($event, beginDatepicker, 'begin')\"\r\n            (monthSelected)=\"monthSelected($event, beginDatepicker, 'begin')\">\r\n          </mat-datepicker>\r\n        </mat-form-field>\r\n\r\n        <div class=\"time-input\">\r\n          <mat-form-field class=\"hour-input\" *ngIf=\"calendarType()==='datetime'\">\r\n            <mat-label>{{'igo.geo.timeFilter.hour' | translate}}</mat-label>\r\n            <mat-select\r\n              [formControl]=\"beginHourFormControl\"\r\n              [attr.disabled]=\"!currentFilter.active\"\r\n              (selectionChange)=\"changeTemporalProperty(begin.value, 1)\">\r\n              <mat-option *ngFor=\"let hour of beginHours\" [value]=\"hour\">{{hour}}</mat-option>\r\n            </mat-select>\r\n          </mat-form-field>\r\n          <mat-form-field class=\"minute-input\" *ngIf=\"calendarType()==='datetime'\">\r\n            <mat-label>{{'igo.geo.timeFilter.minute' | translate}}</mat-label>\r\n            <mat-select\r\n              [formControl]=\"beginMinuteFormControl\"\r\n              [attr.disabled]=\"!currentFilter.active\"\r\n              (selectionChange)=\"changeTemporalProperty(begin.value, 1)\">\r\n              <mat-option *ngFor=\"let minute of beginMinutes\" [value]=\"minute\">{{minute}}</mat-option>\r\n            </mat-select>\r\n          </mat-form-field>\r\n        </div>\r\n      </div>\r\n\r\n      <div class=\"datetime-input\" *ngIf=\"!restrictedToStep()\">\r\n        <mat-form-field class=\"date-input\">\r\n          <mat-datepicker-toggle matSuffix [for]=\"endDatepicker\" [disabled]= \"filterStateDisable\"></mat-datepicker-toggle>\r\n            <input #end\r\n              matInput\r\n              [matDatepicker]=\"endDatepicker\"\r\n              [placeholder]=\"'igo.geo.timeFilter.endDate' | translate\"\r\n              [attr.disabled]=\"!currentFilter.active\"\r\n              (dateChange)=\"changeTemporalProperty(end.value, 2)\"\r\n              [matDatepickerFilter]=\"dateFilter.bind(this, 'end')\"\r\n              [value]=\"endValue?endValue:handleDate(datasource.options.maxDate)\"\r\n              [min]=\"beginValue?beginValue:handleDate(datasource.options.minDate)\"\r\n              [max]=\"handleDate(datasource.options.maxDate)\" \r\n              [disabled]= \"filterStateDisable\">\r\n            <span class=\"filler\"></span>\r\n            <mat-datepicker #endDatepicker\r\n              [startView]=\"calendarView()\"\r\n              [startAt]=\"endValue\"\r\n              (yearSelected)=\"yearSelected($event, endDatepicker, 'end')\"\r\n              (monthSelected)=\"monthSelected($event, endDatepicker, 'end')\">\r\n          </mat-datepicker>\r\n        </mat-form-field>\r\n\r\n        <div class=\"time-input\">\r\n          <mat-form-field class=\"hour-input\" *ngIf=\"calendarType()==='datetime'\" >\r\n            <mat-label>{{'igo.geo.timeFilter.hour' | translate}}</mat-label>\r\n            <mat-select\r\n              [formControl]=\"endHourFormControl\"\r\n              [attr.disabled]=\"!currentFilter.active\"\r\n              (selectionChange)=\"changeTemporalProperty(end.value, 2)\">\r\n              <mat-option *ngFor=\"let hour of endHours\" [value]=\"hour\">{{hour}}</mat-option>\r\n            </mat-select>\r\n          </mat-form-field>\r\n          <mat-form-field class=\"minute-input\" *ngIf=\"calendarType()==='datetime'\">\r\n            <mat-label>{{'igo.geo.timeFilter.minute' | translate}}</mat-label>\r\n            <mat-select\r\n              [formControl]=\"endMinuteFormControl\"\r\n              [attr.disabled]=\"!currentFilter.active\"\r\n              (selectionChange)=\"changeTemporalProperty(end.value, 2)\">\r\n              <mat-option *ngFor=\"let minute of endMinutes\" [value]=\"minute\">{{minute}}</mat-option>\r\n            </mat-select>\r\n          </mat-form-field>\r\n        </div>\r\n      </div>\r\n\r\n      <button class=\"reset-button\" \r\n        mat-icon-button color=\"primary\"\r\n        (click)=\"resetFilter()\" \r\n        [matTooltip]=\"'igo.geo.filter.resetFilters' | translate\" \r\n        [disabled]= \"filterStateDisable\">\r\n        <mat-icon svgIcon=\"{{resetIcon}}\"></mat-icon>\r\n      </button>\r\n      <mat-slide-toggle \r\n        class=\"toggle-filter-state\" \r\n        (change)=\"toggleFilterState()\" \r\n        tooltip-position=\"below\" \r\n        matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.geo.filter.toggleFilterState' | translate\" \r\n        [checked]= \"!filterStateDisable\">\r\n      </mat-slide-toggle>\r\n    </div>\r\n  </div>\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ViewChild,\r\n  ElementRef,\r\n  Output,\r\n  EventEmitter,\r\n  OnInit\r\n} from '@angular/core';\r\nimport { UntypedFormControl } from '@angular/forms';\r\nimport { OgcFilterOperator } from '../../filter/shared/ogc-filter.enum';\r\nimport { OGCFilterTimeService } from '../shared/ogc-filter-time.service';\r\nimport {\r\n  OgcFilterableDataSourceOptions,\r\n  OgcFilterableDataSource,\r\n  OgcFilterDuringOptions\r\n} from '../shared/ogc-filter.interface';\r\n\r\nimport { default as moment } from 'moment';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filter-time',\r\n  templateUrl: './ogc-filter-time.component.html',\r\n  styleUrls: ['./ogc-filter-time.component.scss']\r\n})\r\nexport class OgcFilterTimeComponent implements OnInit {\r\n  @Input() datasource: OgcFilterableDataSource;\r\n  @Input() currentFilter: any;\r\n  @Output() changeProperty: EventEmitter<{\r\n    value: string;\r\n    pos: number;\r\n    refreshFilter: boolean;\r\n  }> = new EventEmitter<any>();\r\n\r\n  beginHours: number[];\r\n  endHours: number[];\r\n  beginMinutes: number[];\r\n  endMinutes: number[];\r\n  beginHourFormControl = new UntypedFormControl();\r\n  beginMinuteFormControl = new UntypedFormControl();\r\n  endHourFormControl = new UntypedFormControl();\r\n  endMinuteFormControl = new UntypedFormControl();\r\n  _beginValue: Date;\r\n  _endValue: Date;\r\n  readonly _defaultMin: string = '1900-01-01';\r\n  readonly _defaultMax: string = '2052-01-06';\r\n  readonly _defaultDisplayFormat: string = 'DD/MM/YYYY HH:mm A';\r\n  readonly _defaultSliderModeEnabled: boolean = true;\r\n  ogcFilterOperator = OgcFilterOperator;\r\n  public sliderMode = false;\r\n\r\n  readonly defaultStepMillisecond = 60000;\r\n  public options: OgcFilterableDataSourceOptions;\r\n\r\n  public onlyYearBegin: number;\r\n  public onlyYearEnd: number;\r\n  public calendarTypeYear = false;\r\n  public resetIcon = 'replay';\r\n  public filterStateDisable: boolean;\r\n\r\n  @ViewChild('endDatepickerTime') endDatepickerTime: ElementRef;\r\n  @ViewChild('beginDatepickerTime') beginDatepickerTime: ElementRef;\r\n  @ViewChild('beginTime') beginTime: HTMLInputElement;\r\n  @ViewChild('endTime') endTime: HTMLInputElement;\r\n\r\n  get step(): string {\r\n    return this.datasource.options.stepDate\r\n      ? this.datasource.options.stepDate\r\n      : this.currentFilter.step;\r\n  }\r\n\r\n  get stepMilliseconds(): number {\r\n    const step = moment.duration(this.step).asMilliseconds();\r\n    return step === 0 ? this.defaultStepMillisecond : step;\r\n  }\r\n\r\n  set beginValue(begin: Date) {\r\n    this._beginValue = begin;\r\n  }\r\n\r\n  get beginValue(): Date {\r\n    return this._beginValue;\r\n  }\r\n\r\n  set endValue(end: Date) {\r\n    this._endValue = end;\r\n  }\r\n\r\n  get endValue(): Date {\r\n    return this._endValue;\r\n  }\r\n\r\n  get sliderInterval(): number {\r\n    return this.currentFilter.sliderInterval === undefined\r\n      ? 2000\r\n      : this.currentFilter.sliderInterval;\r\n  }\r\n\r\n  get maxDate(): string {\r\n    return this.datasource.options.maxDate ? this.datasource.options.maxDate : this._defaultMax;\r\n  }\r\n\r\n  get displayFormat(): string {\r\n    return this.currentFilter.displayFormat ? this.currentFilter.displayFormat : this._defaultDisplayFormat;\r\n  }\r\n\r\n  constructor(public ogcFilterTimeService: OGCFilterTimeService) {}\r\n\r\n  ngOnInit(){\r\n    if (this.currentFilter.sliderOptions) {\r\n      this.currentFilter.sliderOptions.enabled = this.currentFilter.sliderOptions.enabled !== undefined ?\r\n        this.currentFilter.sliderOptions.enabled : this._defaultSliderModeEnabled;\r\n    }\r\n    this.beginValue = this.parseFilter(this.handleMin());\r\n    this.endValue = this.parseFilter(this.handleMax());\r\n\r\n    this.onlyYearBegin = this.beginValue.getUTCFullYear();\r\n    this.onlyYearEnd = this.endValue.getUTCFullYear();\r\n    this.calendarTypeYear = this.isCalendarYearMode();\r\n    this.setFilterStateDisable();\r\n    this.updateHoursMinutesArray();\r\n    // update value for now value\r\n    this.updateValues();\r\n  }\r\n\r\n  parseFilter(filter): Date {\r\n    if (!filter){\r\n      return new Date();\r\n    } else if ( isNaN( new Date(filter).getTime() ) ){\r\n      if (filter.search('now') >= 0 ){\r\n        const interval = filter.match(/years|months|weeks|days|hours|seconds/);\r\n        if (filter.match(/\\+/)) {\r\n          const intervalInt = parseInt(\r\n            filter.substring(filter.search('+') + 1, interval.index),\r\n            10\r\n          );\r\n          return moment().add(intervalInt, interval[0]).toDate();\r\n        }\r\n        if (filter.match(/\\-/)) {\r\n          const intervalInt = parseInt(\r\n            filter.substring(filter.search('-') + 1, interval.index),\r\n            10\r\n          );\r\n          return moment().subtract(intervalInt, interval[0]).toDate();\r\n        }\r\n        return new Date();\r\n      }\r\n      if (filter.search('today') >= 0){\r\n        const _now = moment().endOf('day').toDate();\r\n        const interval = filter.match(/years|months|weeks|days|hours|seconds/);\r\n        if ( filter.match(/\\+/) ) {\r\n          const intervalInt = parseInt( filter.substring(filter.search('+') + 1, interval.index), 10 );\r\n          return moment(_now).add(intervalInt, interval[0]).toDate();\r\n        }\r\n        if ( filter.match(/\\-/) ) {\r\n          const intervalInt = parseInt(filter.substring(filter.search('-') + 1, interval.index), 10);\r\n          return moment(_now).subtract(intervalInt, interval[0]).toDate();\r\n        }\r\n        return _now;\r\n      }\r\n      return new Date();\r\n    }\r\n    if (this.currentFilter.calendarModeYear) {\r\n      const date = this.getDateFromStringWithoutTime(filter);\r\n      return date;\r\n    } else {\r\n      return filter ? new Date(filter) : new Date();\r\n    }\r\n  }\r\n\r\n  changeTemporalProperty(value, position?, refreshFilter = true) {\r\n    let valueTmp = this.getDateTime(value, position);\r\n    if (this.isCalendarYearMode()) {\r\n      let dateStringFromYearNotime;\r\n      if (position === 1) {\r\n        this.beginValue = value;\r\n        this.onlyYearBegin = this.beginValue.getFullYear();\r\n        dateStringFromYearNotime = `${this.onlyYearBegin}-01-01`;\r\n      } else {\r\n        this.endValue = value;\r\n        this.onlyYearEnd = this.endValue.getFullYear();\r\n        dateStringFromYearNotime = `${this.onlyYearEnd}-01-01`;\r\n      }\r\n      // call service with string date without time\r\n      this.changeProperty.next({ value: dateStringFromYearNotime, pos: position, refreshFilter });\r\n      return;\r\n    }\r\n    if (position === 2 && this.calendarType() === 'date' && !this.sliderMode) {\r\n      /* Above month: see yearSelected or monthSelected */\r\n      valueTmp = moment(valueTmp).endOf('day').toDate();\r\n    }\r\n\r\n    if (position === 1) {\r\n      this.beginValue = valueTmp;\r\n      if (this.restrictedToStep()) {\r\n        this.changeTemporalProperty(this.ogcFilterTimeService.addStep(valueTmp, this.stepMilliseconds), 2, refreshFilter);\r\n      }\r\n    } else {\r\n      this.endValue = valueTmp;\r\n    }\r\n    this.updateHoursMinutesArray();\r\n    this.changeProperty.next({ value: valueTmp.toISOString(), pos: position, refreshFilter });\r\n  }\r\n\r\n  handleDate(value): Date {\r\n    if (!value || value === '') {\r\n      return undefined;\r\n    }\r\n    if (typeof(value) === 'string' && this.currentFilter.calendarModeYear) {\r\n      return this.getDateFromStringWithoutTime(value);\r\n    }\r\n    return new Date(value);\r\n  }\r\n\r\n  calendarType() {\r\n    if (this.currentFilter.calendarModeYear) {\r\n      return 'year';\r\n    }\r\n    if (this.stepMilliseconds < 86400000) {\r\n      return 'datetime';\r\n    }\r\n    return 'date';\r\n  }\r\n\r\n  isCalendarYearMode(): boolean {\r\n    if (this.calendarType() === 'year') {\r\n      return true;\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  yearOnlyInputChange(changeEvent, datePicker?: any, property?: string) {\r\n    const year = changeEvent.target.value;\r\n    const date = this.getDateFromStringWithoutTime(year);\r\n    this.yearSelected(date, datePicker, property);\r\n  }\r\n\r\n  yearSelected(year, datePicker?: any, property?: string, refreshFilter = true) {\r\n    if (this.ogcFilterTimeService.stepIsYearDuration(this.step)) {\r\n      if (datePicker) {\r\n        datePicker.close();\r\n      }\r\n      if (property === 'end') {\r\n        // change value 01 jan to 31 dec same year\r\n        year = moment(year).endOf('year').toDate();\r\n      } else if (property === 'begin' && this.restrictedToStep() && !this.calendarTypeYear) {\r\n        this.yearSelected(year, undefined, 'end');\r\n      }\r\n      this.changeTemporalProperty(year, property === 'begin' ? 1 : 2, refreshFilter);\r\n    }\r\n  }\r\n\r\n  monthSelected(month, datePicker?: any, property?: string, refreshFilter = true) {\r\n    if (this.ogcFilterTimeService.stepIsMonthDuration(this.step)) {\r\n      if (datePicker) {\r\n        datePicker.close();\r\n      }\r\n      if (property === 'end') {\r\n        month = moment(month).endOf('month').toDate();\r\n      } else if (property === 'begin' && this.restrictedToStep()) {\r\n        this.monthSelected(month, undefined, 'end');\r\n      }\r\n      this.changeTemporalProperty(month, property === 'begin' ? 1 : 2, refreshFilter);\r\n    }\r\n  }\r\n\r\n  calendarView() {\r\n    const test = this.stepMilliseconds;\r\n    const diff = Math.abs(\r\n      this.parseFilter(this.currentFilter.end).getTime() -\r\n        this.parseFilter(this.currentFilter.begin).getTime()\r\n    );\r\n    if (this.ogcFilterTimeService.stepIsYearDuration(this.step)) {\r\n      return 'multi-year';\r\n    } else if (this.ogcFilterTimeService.stepIsMonthDuration(this.step)) {\r\n      return 'year';\r\n    } else if (test < 86400000 && diff < 86400000) {\r\n      return 'clock';\r\n    } else {\r\n      return 'month';\r\n    }\r\n  }\r\n\r\n  dateFilter(type: string, date: string): boolean {\r\n    const dateValue = new Date(date);\r\n    const diff = dateValue.getTime() - new Date(this.handleMin()).getTime();\r\n\r\n    if (this.ogcFilterTimeService.stepIsYearDuration(this.step)) {\r\n      const monthDiff = moment(dateValue).diff(moment(this.handleMin()), 'years', true);\r\n      if ( type === 'end' ) {\r\n        const dateValuePlus1 = moment(dateValue).add(1, 'd');\r\n        const monthDiffPlus1 = moment(dateValuePlus1).diff(moment(this.handleMin()), 'years', true);\r\n        return (monthDiffPlus1 % moment.duration(this.step).asYears()) === 0;\r\n      } else if ( type === 'begin' ) {\r\n        return (monthDiff % moment.duration(this.step).asYears()) === 0;\r\n      }\r\n    }\r\n    else if (this.ogcFilterTimeService.stepIsMonthDuration(this.step)) {\r\n      const monthDiff = moment(dateValue).diff(moment(this.handleMin()), 'months', true);\r\n      if ( type === 'end' ) {\r\n        const dateValuePlus1 = moment(dateValue).add(1, 'd');\r\n        const monthDiffPlus1 = moment(dateValuePlus1).diff(moment(this.handleMin()), 'months', true);\r\n        return (monthDiffPlus1 % moment.duration(this.step).asMonths()) === 0;\r\n      } else if ( type === 'begin' ) {\r\n        return (monthDiff % moment.duration(this.step).asMonths()) === 0;\r\n      }\r\n    } else if (this.ogcFilterTimeService.stepIsWeekDuration(this.step)) {\r\n      const weekDiff = moment(dateValue).diff(moment(this.handleMin()), 'weeks', true);\r\n      if ( type === 'end' ) {\r\n        const dateValuePlus1 = moment(dateValue).add(1, 'd');\r\n        const weekDiffPlus1 = moment(dateValuePlus1).diff(moment(this.handleMin()), 'weeks', true);\r\n        return (weekDiffPlus1 % moment.duration(this.step).asWeeks()) === 0;\r\n      } else if ( type === 'begin' ) {\r\n        return (weekDiff % moment.duration(this.step).asWeeks()) === 0;\r\n      }\r\n    } else if (this.ogcFilterTimeService.stepIsDayDuration(this.step)) {\r\n      const dayDiff = moment(dateValue).diff(moment(this.handleMin()), 'days', true);\r\n      if ( type === 'end' ) {\r\n        const dateValuePlus1 = moment(dateValue).add(1, 'd');\r\n        const dayDiffPlus1 = moment(dateValuePlus1).diff(moment(this.handleMin()), 'days', true);\r\n        const _mod = (dayDiffPlus1 % moment.duration(this.step).asDays());\r\n        return (_mod < 0.0000001 && _mod > -0.0000001) || _mod === 0 ; // 1 millisecond = 1.1574074074074076e-8\r\n      } else if ( type === 'begin' ) {\r\n        const _mod = ((dayDiff % moment.duration(this.step).asDays()) + 1);\r\n        return (_mod < 0.0000001 && _mod > -0.0000001 && _mod !== 0) || _mod === 1 ; // 1 millisecond = 1.1574074074074076e-8\r\n      }\r\n    } else if ( this.ogcFilterTimeService.stepIsHourDuration(this.step) ) {\r\n      const hourDiff = moment(dateValue).diff(moment(this.handleMin()), 'hours', true);\r\n      return (hourDiff % moment.duration(this.step).asHours()) === 0;\r\n\r\n    } else if ( this.ogcFilterTimeService.stepIsMinuteDuration(this.step) ) {\r\n      return true;\r\n    }\r\n\r\n    return diff % this.stepMilliseconds === 0;\r\n  }\r\n\r\n  getDateTime(date, pos) {\r\n    const valuetmp = new Date(date);\r\n    let valuetmp2;\r\n    if (!this.sliderMode) {\r\n      switch (pos) {\r\n        case 1: {\r\n          if (this.currentFilter.calendarModeYear) {\r\n            valuetmp2 = valuetmp.setHours(0, 0);\r\n            break;\r\n          } else {\r\n            valuetmp2 = valuetmp.setHours(\r\n            this.beginHourFormControl.value,\r\n            this.beginMinuteFormControl.value\r\n            );\r\n            break;\r\n          }\r\n        }\r\n        case 2: {\r\n          if (this.currentFilter.calendarModeYear) {\r\n            valuetmp2 = valuetmp.setHours(0, 0);\r\n            break;\r\n          } else {\r\n            valuetmp2 = valuetmp.setHours(\r\n              this.endHourFormControl.value,\r\n              this.endMinuteFormControl.value\r\n            );\r\n            break;\r\n          }\r\n        }\r\n      }\r\n    }\r\n    return new Date(valuetmp2 ? valuetmp2 : valuetmp);\r\n  }\r\n\r\n  handleMinuteIncrement() {\r\n    if (this.ogcFilterTimeService.stepIsMinuteDuration(this.step)) {\r\n      if (this.stepMilliseconds < 3600000) {\r\n        return this.stepMilliseconds / 1000 === 60 ? 1 : this.stepMilliseconds / 1000;\r\n      } else {\r\n        return (this.stepMilliseconds % 3600000) / 60;\r\n      }\r\n    } else if (this.ogcFilterTimeService.stepIsHourDuration(this.step)) {\r\n      return 60;\r\n    }\r\n    return 1;\r\n  }\r\n\r\n  handleHourIncrement() {\r\n    if (this.ogcFilterTimeService.stepIsHourDuration(this.step)) {\r\n      return this.stepMilliseconds / 1000 / 60 / 60;\r\n    }\r\n    return 1;\r\n  }\r\n\r\n  fullBeginHoursArray(checkEndValue?) {\r\n    if (checkEndValue) {\r\n      this.beginHours = Array.from(\r\n        {\r\n          length:\r\n            (this.endHourFormControl.value - 0) / this.handleHourIncrement() + 1\r\n        },\r\n        (_, i) => 0 + i * this.handleHourIncrement()\r\n      );\r\n    } else {\r\n      this.beginHours = Array.from(\r\n        { length: (23 - 0) / this.handleHourIncrement() + 1 },\r\n        (_, i) => 0 + i * this.handleHourIncrement()\r\n      );\r\n    }\r\n    this.beginHourFormControl.setValue(this.beginValue.getHours());\r\n  }\r\n\r\n  fullEndHoursArray(checkEndValue?) {\r\n    if (checkEndValue) {\r\n      this.endHours = Array.from(\r\n        {\r\n          length:\r\n            (23 - this.beginHourFormControl.value) /\r\n              this.handleHourIncrement() +\r\n            1\r\n        },\r\n        (_, i) =>\r\n          this.beginHourFormControl.value + i * this.handleHourIncrement()\r\n      );\r\n    } else {\r\n      this.endHours = Array.from(\r\n        { length: (23 - 0) / this.handleHourIncrement() + 1 },\r\n        (_, i) => 0 + i * this.handleHourIncrement()\r\n      );\r\n    }\r\n    this.endHourFormControl.setValue(this.endValue.getHours());\r\n  }\r\n\r\n  fullBeginMinutesArray(checkEndValue?) {\r\n    if (checkEndValue) {\r\n      this.beginMinutes = Array.from(\r\n        {\r\n          length:\r\n            (this.endMinuteFormControl.value - 0) /\r\n              this.handleMinuteIncrement() +\r\n            1\r\n        },\r\n        (_, i) => 0 + i * this.handleMinuteIncrement()\r\n      );\r\n    } else {\r\n      this.beginMinutes = Array.from(\r\n        { length: (59 - 0) / this.handleMinuteIncrement() + 1 },\r\n        (_, i) => 0 + i * this.handleMinuteIncrement()\r\n      );\r\n    }\r\n    this.beginMinuteFormControl.setValue(this.beginValue.getMinutes());\r\n  }\r\n\r\n  fullEndMinutesArray(checkEndValue?) {\r\n    if (checkEndValue) {\r\n      this.endMinutes = Array.from(\r\n        {\r\n          length:\r\n            (59 - this.beginMinuteFormControl.value) /\r\n              this.handleMinuteIncrement() +\r\n            1\r\n        },\r\n        (_, i) =>\r\n          this.beginMinuteFormControl.value + i * this.handleMinuteIncrement()\r\n      );\r\n    } else {\r\n      this.endMinutes = Array.from(\r\n        { length: (59 - 0) / this.handleMinuteIncrement() + 1 },\r\n        (_, i) => 0 + i * this.handleMinuteIncrement()\r\n      );\r\n    }\r\n    this.endMinuteFormControl.setValue(this.endValue.getMinutes());\r\n  }\r\n\r\n  updateHoursMinutesArray() {\r\n    const beginTmp = new Date(this.beginValue);\r\n    const endTmp = new Date(this.endValue);\r\n    if (beginTmp.setHours(0, 0) === endTmp.setHours(0, 0)) {\r\n      this.fullBeginHoursArray(true);\r\n      this.fullEndHoursArray(true);\r\n      if (this.beginValue.getHours() === this.endValue.getHours()) {\r\n        this.fullBeginMinutesArray(true);\r\n        this.fullEndMinutesArray(true);\r\n      }\r\n    } else {\r\n      this.fullBeginHoursArray();\r\n      this.fullEndHoursArray();\r\n      this.fullBeginMinutesArray();\r\n      this.fullEndMinutesArray();\r\n    }\r\n  }\r\n\r\n  private updateValues() {\r\n    this.changeTemporalProperty(this.beginValue, 1, false);\r\n    this.changeTemporalProperty(this.endValue, 2, true);\r\n  }\r\n\r\n  public restrictedToStep(): boolean {\r\n    return this.currentFilter.restrictToStep\r\n      ? this.currentFilter.restrictToStep : false;\r\n  }\r\n\r\n  public handleMin() {\r\n    return this.currentFilter.begin ? this.currentFilter.begin :\r\n              (this.datasource.options.minDate ? this.datasource.options.minDate : this._defaultMin);\r\n  }\r\n\r\n  public handleMax() {\r\n    return this.currentFilter.end ? this.currentFilter.end :\r\n              (this.datasource.options.maxDate ? this.datasource.options.maxDate : this._defaultMax);\r\n  }\r\n\r\n  changePropertyByPass(event) {\r\n    this.changeProperty.next(event);\r\n  }\r\n\r\n  modeChange(event) {\r\n    if (!event.checked) {\r\n      this.updateValues();\r\n    }\r\n  }\r\n\r\n  setFilterStateDisable() {\r\n    if (this.currentFilter) {\r\n      this.filterStateDisable = !this.currentFilter.active;\r\n    } else {\r\n      this.filterStateDisable = false;\r\n    }\r\n    if(this.calendarType() === 'datetime') {\r\n      if (this.filterStateDisable === true) {\r\n        this.beginHourFormControl.disable();\r\n        this.beginMinuteFormControl.disable();\r\n        this.endHourFormControl.disable();\r\n        this.endMinuteFormControl.disable();\r\n      } else {\r\n        this.beginHourFormControl.enable();\r\n        this.beginMinuteFormControl.enable();\r\n        this.endHourFormControl.enable();\r\n        this.endMinuteFormControl.enable();\r\n      }\r\n    }\r\n  }\r\n  getDateFromStringWithoutTime(stringDate: string): Date {\r\n    // warning create date with no time make a date UTC with TZ and the date create maybe not the same year, month and day\r\n    // exemple:\r\n    // new Date('2022-01-01') -> Fri Dec 31 2021 19:00:00 GMT-0500 (heure normale de lEst nord-amricain)\r\n    // to create same date as string, add time 00 in the creation\r\n    // new Date('2022-01-01 00:00:00') -> Sat Jan 01 2022 00:00:00 GMT-0500 (heure normale de lEst nord-amricain)\r\n    let year;\r\n    let month = '01';\r\n    let day = '01';\r\n    if (stringDate.length === 10) {\r\n       const dateItems = stringDate.split('-');\r\n        if (dateItems.length !== 3) {\r\n          throw new Error('Error in config date begin-end for ogcFilter: Date without time format need to be YYYY-MM-DD or YYYY');\r\n        } else {\r\n          year = dateItems[0];\r\n          month = dateItems[1];\r\n          day = dateItems[2];\r\n        }\r\n    } else if (stringDate.length === 4) {\r\n      year = stringDate;\r\n    } else {\r\n      return new Date(stringDate);\r\n    }\r\n    return new Date(`${year}-${month}-${day} 00:00:00`);\r\n  }\r\n\r\n  resetFilter() {\r\n    let filterOriginConfig = this.datasource.options.ogcFilters.filters as OgcFilterDuringOptions;\r\n\r\n    let minDefaultDate;\r\n    let maxDefaultDate;\r\n    let minDefaultISOString;\r\n    let maxDefaultISOString;\r\n\r\n    if (this.calendarTypeYear) {\r\n      if (filterOriginConfig.end === 'today') {\r\n        let todayDateStringNoTime = new Date().toLocaleDateString('en-CA'); // '2022-02-13'\r\n        maxDefaultISOString = `${todayDateStringNoTime.substring(0,4)}-01-01`;\r\n      } else {\r\n        maxDefaultISOString = `${filterOriginConfig.end.substring(0,4)}-01-01`;\r\n      }\r\n      minDefaultISOString = `${filterOriginConfig.begin.substring(0,4)}-01-01`;\r\n      minDefaultDate = this.getDateFromStringWithoutTime(minDefaultISOString);\r\n      maxDefaultDate = this.getDateFromStringWithoutTime(maxDefaultISOString);\r\n    } else {\r\n      minDefaultDate = this.parseFilter(filterOriginConfig.begin);\r\n      maxDefaultDate = this.parseFilter(filterOriginConfig.end);\r\n      minDefaultISOString = minDefaultDate.toISOString();\r\n      maxDefaultISOString = maxDefaultDate.toISOString();\r\n    }\r\n\r\n    if ((this.currentFilter.begin !== minDefaultISOString ) ||\r\n    (this.currentFilter.end !== maxDefaultISOString)) {\r\n      this.beginValue = minDefaultDate;\r\n      this.endValue = maxDefaultDate;\r\n      this.updateValues();\r\n    }\r\n  }\r\n\r\n  toggleFilterState() {\r\n    if (this.currentFilter.active === true) {\r\n      this.currentFilter.active = false;\r\n    } else {\r\n      this.currentFilter.active = true;\r\n    }\r\n    this.setFilterStateDisable();\r\n    this.updateValues();\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  ViewChild,\r\n  Output,\r\n  EventEmitter,\r\n  OnInit\r\n} from '@angular/core';\r\nimport { OGCFilterTimeService } from '../shared/ogc-filter-time.service';\r\n\r\nimport { default as moment } from 'moment';\r\nimport { MatSlider } from '@angular/material/slider';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filter-time-slider',\r\n  templateUrl: './ogc-filter-time-slider.component.html',\r\n  styleUrls: ['./ogc-filter-time-slider.component.scss']\r\n})\r\nexport class OgcFilterTimeSliderComponent implements OnInit {\r\n  @Input() currentFilter: any;\r\n  @Input() begin: any;\r\n  @Input() max: any;\r\n  @Input() datasource: any;\r\n  @Output() changeProperty: EventEmitter<{\r\n    value: any;\r\n    pos: number;\r\n    refreshFilter: boolean;\r\n  }> = new EventEmitter<any>();\r\n  @ViewChild(MatSlider) slider: MatSlider;\r\n\r\n  interval;\r\n  sliderValue: number = 1;\r\n  calculatedStep: number = 0;\r\n  readonly _defaultDisplayFormat: string = 'DD/MM/YYYY HH:mm A';\r\n  readonly _defaultSliderInterval: number = 2000;\r\n  public playIcon = 'play-circle';\r\n  public resetIcon = 'replay';\r\n\r\n  get sliderInterval(): number {\r\n    return this.currentFilter.sliderInterval === undefined\r\n      ? this._defaultSliderInterval\r\n      : this.currentFilter.sliderInterval;\r\n  }\r\n\r\n  get displayFormat(): string {\r\n    if (this.currentFilter.sliderOptions?.displayFormat){\r\n      return this.currentFilter.sliderOptions.displayFormat;\r\n    }\r\n    if (this.currentFilter.displayFormat) {\r\n      return this.currentFilter.displayFormat;\r\n    }\r\n    return this._defaultDisplayFormat;\r\n  }\r\n\r\n  get beginMillisecond(): number {\r\n    return this.ogcFilterTimeService.dateToNumber(this.begin);\r\n  }\r\n\r\n  get maxMillisecond(): number {\r\n    return this.ogcFilterTimeService.dateToNumber(this.max);\r\n  }\r\n\r\n  get stepMillisecond(): number {\r\n    return this.ogcFilterTimeService.stepMillisecond(this.datasource, this.currentFilter);\r\n  }\r\n\r\n  constructor(public ogcFilterTimeService: OGCFilterTimeService) {\r\n    this.sliderDisplayWith = this.sliderDisplayWith.bind(this);\r\n  }\r\n\r\n  ngOnInit(){\r\n    this.calculateStep();\r\n    this.handleSliderInput({value: 1});\r\n  }\r\n\r\n  sliderDisplayWith(value) {\r\n    let dateTmp = new Date(this.beginMillisecond + ((value - 1) * this.stepMillisecond));\r\n\r\n    if (this.ogcFilterTimeService.stepIsYearDuration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter))) {\r\n      const toAdd = moment.duration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)).years();\r\n      dateTmp = moment(this.beginMillisecond).add((value - 1) * toAdd, 'year').toDate();\r\n    } else if ( this.ogcFilterTimeService.stepIsMonthDuration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter))) {\r\n      const toAdd = moment.duration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)).months();\r\n      dateTmp = moment(this.beginMillisecond).add((value - 1) * toAdd, 'month').toDate();\r\n    }\r\n\r\n    return moment(dateTmp).format(this.displayFormat);\r\n  }\r\n\r\n  playFilter(event: any) {\r\n    if (this.interval) {\r\n      this.stopFilter();\r\n    } else {\r\n      this.playIcon = 'pause-circle';\r\n      this.interval = setInterval(\r\n        that => {\r\n\r\n          if (this.slider.value < this.calculatedStep) {\r\n            const _increment = '_increment';\r\n            const _emitInputEvent = '_emitInputEvent';\r\n            this.slider[_increment](1);\r\n            this.slider[_emitInputEvent]();\r\n          } else {\r\n            this.stopFilter();\r\n          }\r\n        },\r\n        this.sliderInterval,\r\n        this\r\n      );\r\n    }\r\n  }\r\n\r\n  stopFilter() {\r\n    if (this.interval) {\r\n      clearInterval(this.interval);\r\n    }\r\n    this.interval = undefined;\r\n    this.playIcon = 'play-circle';\r\n  }\r\n\r\n  resetFilter(event: any) {\r\n    if (this.interval) {\r\n      clearInterval(this.interval);\r\n    }\r\n    this.interval = undefined;\r\n    this.playIcon = 'play-circle';\r\n    this.slider.value = 1;\r\n    const _increment = '_increment';\r\n    const _emitInputEvent = '_emitInputEvent';\r\n    this.slider[_emitInputEvent]();\r\n  }\r\n\r\n  handleSliderInput(matSliderChange) {\r\n    if (matSliderChange) {\r\n\r\n      if ( this.ogcFilterTimeService.stepIsYearDuration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)) ) {\r\n        const toAdd = moment.duration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)).years();\r\n        const dateBeginTmp = moment(this.beginMillisecond).add((matSliderChange.value - 1) * toAdd, 'year').toDate();\r\n        const dateEndTmp = moment(dateBeginTmp).add(toAdd, 'year').toDate();\r\n        this.changeProperty.next({value: moment(dateBeginTmp).toDate().toISOString(),\r\n                                    pos: 1, refreshFilter: false});\r\n        this.changeProperty.next({value: moment(dateEndTmp).toDate().toISOString(),\r\n                                    pos: 2, refreshFilter: true});\r\n\r\n      } else if ( this.ogcFilterTimeService.stepIsMonthDuration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)) ) {\r\n        const toAdd = moment.duration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)).months();\r\n        const dateBeginTmp = moment(this.beginMillisecond).add((matSliderChange.value - 1) * toAdd, 'month').toDate();\r\n        const dateEndTmp = moment(dateBeginTmp).add(toAdd, 'month').toDate();\r\n        this.changeProperty.next({value: moment(dateBeginTmp).startOf('month').toDate().toISOString(),\r\n                                    pos: 1, refreshFilter: false});\r\n        this.changeProperty.next({value: moment(dateEndTmp).toDate().toISOString(),\r\n                                    pos: 2, refreshFilter: true});\r\n\r\n      } else if ( this.ogcFilterTimeService.stepIsDayDuration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)) ||\r\n          this.ogcFilterTimeService.stepIsHourDuration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)) ||\r\n          this.ogcFilterTimeService.stepIsMinuteDuration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)) ) {\r\n            const dateTmp = new Date(this.beginMillisecond + (this.stepMillisecond * (matSliderChange.value - 1)));\r\n            this.changeProperty.next({value: dateTmp.toISOString(), pos: 1, refreshFilter: false});\r\n            this.changeProperty.next({value: new Date(this.ogcFilterTimeService.addStep(dateTmp.toISOString(),\r\n                                        this.stepMillisecond)).toISOString(),\r\n                                        pos: 2, refreshFilter: true});\r\n      }\r\n    }\r\n  }\r\n\r\n  calculateStep(){\r\n    for (let i = 1; (this.maxMillisecond - (this.beginMillisecond + (i * this.stepMillisecond))) >= -1; i++) {\r\n      this.calculatedStep = i;\r\n    }\r\n  }\r\n\r\n}\r\n","<div class=\"slider-container\">\r\n  <mat-slider\r\n    id=\"time-slider\"\r\n    [step]=\"1\"\r\n    [min]=\"1\"\r\n    [max]=\"calculatedStep\"\r\n    [(ngModel)]=\"sliderValue\"\r\n    [displayWith]=\"sliderDisplayWith\"\r\n    (input)=\"handleSliderInput($event)\"\r\n    thumbLabel\r\n    >\r\n  </mat-slider>\r\n  <button mat-icon-button color=\"primary\" (click)=\"playFilter($event)\">\r\n    <mat-icon [svgIcon]=\"playIcon\"></mat-icon>\r\n  </button>\r\n  <button mat-icon-button color=\"primary\" (click)=\"resetFilter($event)\">\r\n    <mat-icon svgIcon=\"{{resetIcon}}\"></mat-icon>\r\n  </button>\r\n  \r\n</div>","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { MatAutocompleteModule } from '@angular/material/autocomplete';\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatButtonToggleModule } from '@angular/material/button-toggle';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatOptionModule, MatNativeDateModule, MAT_DATE_LOCALE } from '@angular/material/core';\r\nimport { MatDatepickerModule } from '@angular/material/datepicker';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatMenuModule } from '@angular/material/menu';\r\nimport { MatRadioModule } from '@angular/material/radio';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatSlideToggleModule } from '@angular/material/slide-toggle';\r\nimport { MatSliderModule } from '@angular/material/slider';\r\nimport { MatTableModule } from '@angular/material/table';\r\nimport { MatTabsModule } from '@angular/material/tabs';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\nimport { MatTreeModule } from '@angular/material/tree';\r\n\r\nimport {\r\n  MatDatetimepickerModule,\r\n  MatNativeDatetimeModule\r\n} from '@mat-datetimepicker/core';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport {\r\n  IgoCollapsibleModule,\r\n  IgoListModule,\r\n  IgoKeyValueModule,\r\n  IgoEntityModule,\r\n  IgoDOMModule\r\n} from '@igo2/common';\r\nimport { IgoGeometryModule } from './../geometry/geometry.module';\r\n\r\nimport { FilterableDataSourcePipe } from './shared/filterable-datasource.pipe';\r\nimport { IgoLayerModule } from '../layer/layer.module';\r\nimport { TimeFilterButtonComponent } from './time-filter-button/time-filter-button.component';\r\nimport { TimeFilterFormComponent } from './time-filter-form/time-filter-form.component';\r\nimport { TimeFilterItemComponent } from './time-filter-item/time-filter-item.component';\r\nimport { TimeFilterListBindingDirective } from './time-filter-list/time-filter-list-binding.directive';\r\nimport { TimeFilterListComponent } from './time-filter-list/time-filter-list.component';\r\nimport { TimeFilterService } from './shared/time-filter.service';\r\n\r\nimport { OgcFilterFormComponent } from './ogc-filter-form/ogc-filter-form.component';\r\nimport { OgcFilterableFormComponent } from './ogc-filterable-form/ogc-filterable-form.component';\r\nimport { OgcFilterableItemComponent } from './ogc-filterable-item/ogc-filterable-item.component';\r\nimport { OgcFilterableListBindingDirective } from './ogc-filterable-list/ogc-filterable-list-binding.directive';\r\nimport { OgcFilterableListComponent } from './ogc-filterable-list/ogc-filterable-list.component';\r\nimport { OgcFilterButtonComponent } from './ogc-filter-button/ogc-filter-button.component';\r\nimport { OGCFilterService } from './shared/ogc-filter.service';\r\nimport { OGCFilterTimeService } from './shared/ogc-filter-time.service';\r\nimport { OgcFilterSelectionComponent } from './ogc-filter-selection/ogc-filter-selection.component';\r\n\r\nimport { SpatialFilterTypeComponent } from './spatial-filter/spatial-filter-type/spatial-filter-type.component';\r\nimport { SpatialFilterListComponent } from './spatial-filter/spatial-filter-list/spatial-filter-list.component';\r\nimport { SpatialFilterItemComponent } from './spatial-filter/spatial-filter-item/spatial-filter-item.component';\r\nimport { SpatialFilterService } from './shared/spatial-filter.service';\r\nimport { OgcFilterTimeComponent } from './ogc-filter-time/ogc-filter-time.component';\r\nimport { OgcFilterTimeSliderComponent } from './ogc-filter-time/ogc-filter-time-slider.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    MatAutocompleteModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatTabsModule,\r\n    MatRadioModule,\r\n    MatMenuModule,\r\n    MatTableModule,\r\n    MatTreeModule,\r\n    MatButtonToggleModule,\r\n    MatCheckboxModule,\r\n    MatSliderModule,\r\n    MatSlideToggleModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatOptionModule,\r\n    MatSelectModule,\r\n    MatListModule,\r\n    MatTooltipModule,\r\n    MatDatepickerModule,\r\n    MatNativeDateModule,\r\n    MatDatetimepickerModule,\r\n    MatNativeDatetimeModule,\r\n    IgoLanguageModule,\r\n    IgoLayerModule,\r\n    IgoCollapsibleModule,\r\n    IgoListModule,\r\n    IgoEntityModule,\r\n    IgoDOMModule,\r\n    IgoKeyValueModule,\r\n    IgoGeometryModule,\r\n    MatBadgeModule\r\n  ],\r\n  exports: [\r\n    FilterableDataSourcePipe,\r\n    TimeFilterButtonComponent,\r\n    TimeFilterFormComponent,\r\n    TimeFilterItemComponent,\r\n    TimeFilterListComponent,\r\n    TimeFilterListBindingDirective,\r\n    OgcFilterFormComponent,\r\n    OgcFilterButtonComponent,\r\n    OgcFilterSelectionComponent,\r\n    OgcFilterableFormComponent,\r\n    OgcFilterableItemComponent,\r\n    OgcFilterableListComponent,\r\n    OgcFilterableListBindingDirective,\r\n    SpatialFilterTypeComponent,\r\n    SpatialFilterListComponent,\r\n    SpatialFilterItemComponent,\r\n    OgcFilterTimeComponent,\r\n    OgcFilterTimeSliderComponent\r\n  ],\r\n  declarations: [\r\n    FilterableDataSourcePipe,\r\n    TimeFilterButtonComponent,\r\n    TimeFilterFormComponent,\r\n    TimeFilterItemComponent,\r\n    TimeFilterListComponent,\r\n    TimeFilterListBindingDirective,\r\n    OgcFilterFormComponent,\r\n    OgcFilterButtonComponent,\r\n    OgcFilterSelectionComponent,\r\n    OgcFilterableFormComponent,\r\n    OgcFilterableItemComponent,\r\n    OgcFilterableListComponent,\r\n    OgcFilterableListBindingDirective,\r\n    SpatialFilterTypeComponent,\r\n    SpatialFilterListComponent,\r\n    SpatialFilterItemComponent,\r\n    OgcFilterTimeComponent,\r\n    OgcFilterTimeSliderComponent\r\n  ],\r\n  providers: [TimeFilterService, OGCFilterService, OGCFilterTimeService, SpatialFilterService]\r\n})\r\nexport class IgoFilterModule {\r\n  static forRoot(): ModuleWithProviders<IgoFilterModule> {\r\n    return {\r\n      ngModule: IgoFilterModule,\r\n      providers: [\r\n        {\r\n          provide: MAT_DATE_LOCALE,\r\n          useValue: 'fr-FR'\r\n        }\r\n      ]\r\n    };\r\n  }\r\n}\r\n","export class ExportError extends Error {}\r\n\r\nexport class ExportInvalidFileError extends ExportError {\r\n  constructor() {\r\n    super('Invalid file');\r\n    Object.setPrototypeOf(this, ExportInvalidFileError.prototype);\r\n  }\r\n}\r\n\r\nexport class ExportNothingToExportError extends ExportError {\r\n  constructor() {\r\n    super('Nothing to export');\r\n    Object.setPrototypeOf(this, ExportNothingToExportError.prototype);\r\n  }\r\n}\r\n","import { strEnum } from '@igo2/utils';\r\n\r\nexport const ExportFormat = strEnum(['URL', 'GeoJSON', 'GML', 'GPX', 'KML', 'Shapefile', 'CSVcomma', 'CSVsemicolon']);\r\nexport type ExportFormat = keyof typeof ExportFormat;\r\n\r\nexport const EncodingFormat = strEnum(['UTF8', 'LATIN1']);\r\nexport type EncodingFormat = keyof typeof EncodingFormat;\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { downloadContent } from '@igo2/utils';\r\n\r\nimport { Observable, Observer } from 'rxjs';\r\n\r\nimport * as olformat from 'ol/format';\r\nimport OlFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport {encode} from 'windows-1252';\r\n\r\nimport { ExportFormat, EncodingFormat } from './export.type';\r\n\r\nimport {\r\n  ExportInvalidFileError,\r\n  ExportNothingToExportError\r\n} from './export.errors';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ExportService {\r\n  static ogreFormats = {\r\n    GML: 'gml',\r\n    GPX: 'gpx',\r\n    KML: 'kml',\r\n    Shapefile: 'ESRI Shapefile',\r\n    CSVcomma: 'CSVcomma',\r\n    CSVsemicolon: 'CSVsemicolon'\r\n  };\r\n\r\n  static noOgreFallbacks = ['GML', 'GPX', 'KML'];\r\n\r\n  private ogreUrl: string;\r\n  private aggregateInComment: boolean = true;\r\n\r\n  constructor(private config: ConfigService) {\r\n    this.ogreUrl = this.config.getConfig('importExport.url');\r\n    const gpxAggregateInComment = this.config.getConfig(\r\n      'importExport.gpxAggregateInComment'\r\n    );\r\n    if (gpxAggregateInComment !== undefined) {\r\n      this.aggregateInComment = gpxAggregateInComment;\r\n    }\r\n  }\r\n\r\n  export(\r\n    olFeatures: OlFeature<OlGeometry>[],\r\n    format: ExportFormat,\r\n    title: string,\r\n    encoding: EncodingFormat,\r\n    projectionIn = 'EPSG:4326',\r\n    projectionOut = 'EPSG:4326'\r\n  ): Observable<void> {\r\n    const exportOlFeatures = this.generateFeature(olFeatures, format);\r\n\r\n    return this.exportAsync(exportOlFeatures, format, title, encoding, projectionIn, projectionOut);\r\n  }\r\n\r\n  private generateFeature(\r\n    olFeatures: OlFeature<OlGeometry>[],\r\n    format: ExportFormat\r\n  ): OlFeature<OlGeometry>[] {\r\n    if (format === ExportFormat.GPX && this.aggregateInComment) {\r\n      return this.generateAggregatedFeature(olFeatures);\r\n    }\r\n\r\n    return olFeatures.map((olFeature: OlFeature<OlGeometry>) => {\r\n      const keys = olFeature\r\n        .getKeys()\r\n        .filter((key: string) => !key.startsWith('_'));\r\n      const properties = keys.reduce(\r\n        (acc: object, key: string) => {\r\n          acc[key] = olFeature.get(key);\r\n          return acc;\r\n        },\r\n        { geometry: olFeature.getGeometry() }\r\n      );\r\n      return new OlFeature(properties);\r\n    });\r\n  }\r\n\r\n  private generateAggregatedFeature(olFeatures: OlFeature<OlGeometry>[]): OlFeature<OlGeometry>[] {\r\n    return olFeatures.map((olFeature: OlFeature<OlGeometry>) => {\r\n      const keys = olFeature.getKeys().filter((key: string) => !key.startsWith('_'));\r\n      let comment: string = '';\r\n      const properties = keys.reduce((acc: object, key: string) => {\r\n        if (key && key !== 'geometry') {\r\n          key === 'id' && olFeature.get('draw') ? comment += key + ':' + olFeature.get('draw') + '   \\r\\n'\r\n          : comment += key + ':' + olFeature.get(key) + '   \\r\\n';\r\n        }\r\n        acc[key] = olFeature.get(key);\r\n        return acc;\r\n      },\r\n      {\r\n        geometry: olFeature.getGeometry()\r\n      });\r\n      const newFeature = new OlFeature(properties);\r\n      newFeature.set('name', olFeature.getId());\r\n      newFeature.set('cmt', comment);\r\n\r\n      return newFeature;\r\n    });\r\n  }\r\n\r\n  private exportAsync(\r\n    olFeatures: OlFeature<OlGeometry>[],\r\n    format: ExportFormat,\r\n    title: string,\r\n    encoding: EncodingFormat,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ): Observable<void> {\r\n    const doExport = (observer: Observer<void>) => {\r\n      const nothingToExport = this.nothingToExport(olFeatures, format);\r\n      if (nothingToExport) {\r\n        observer.error(new ExportNothingToExportError());\r\n        return;\r\n      }\r\n\r\n      const ogreFormats = Object.keys(ExportService.ogreFormats);\r\n      if (ogreFormats.indexOf(format) >= 0) {\r\n        if (!this.ogreUrl) {\r\n          if (ExportService.noOgreFallbacks.indexOf(format) >= 0) {\r\n            this.exportToFile(olFeatures, observer, format, title, projectionIn, projectionOut);\r\n          } else {\r\n            observer.error(new ExportInvalidFileError());\r\n          }\r\n          return;\r\n        }\r\n        this.exportWithOgre(olFeatures, observer, format, title, encoding, projectionIn, projectionOut);\r\n      } else {\r\n        this.exportToFile(olFeatures, observer, format, title, projectionIn, projectionOut);\r\n      }\r\n    };\r\n\r\n    return new Observable(doExport);\r\n  }\r\n\r\n  protected exportToFile(\r\n    olFeatures: OlFeature<OlGeometry>[],\r\n    observer: Observer<void>,\r\n    format: ExportFormat,\r\n    title: string,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ) {\r\n    const olFormat = new olformat[format]();\r\n    const featuresText = olFormat.writeFeatures(olFeatures, {\r\n      dataProjection: projectionOut,\r\n      featureProjection: projectionIn,\r\n      featureType: 'feature',\r\n      featureNS: 'http://example.com/feature'\r\n    });\r\n\r\n    const fileName = `${title}.${format.toLowerCase()}`;\r\n\r\n    downloadContent(featuresText, 'text/plain;charset=utf-8', fileName);\r\n    observer.complete();\r\n  }\r\n\r\n  private exportWithOgre(\r\n    olFeatures: OlFeature<OlGeometry>[],\r\n    observer: Observer<void>,\r\n    format: string,\r\n    title: string,\r\n    encodingType: EncodingFormat,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ) {\r\n    let featuresText: string = new olformat.GeoJSON().writeFeatures(\r\n      olFeatures,\r\n      {\r\n        dataProjection: projectionOut,\r\n        featureProjection: projectionIn\r\n      }\r\n    );\r\n\r\n    const url = `${this.ogreUrl}/convertJson`;\r\n    const form = document.createElement('form');\r\n    form.style.display = 'none';\r\n    document.body.appendChild(form);\r\n    form.setAttribute('method', 'post');\r\n    form.setAttribute('target', '_blank');\r\n    form.setAttribute('action', url);\r\n\r\n    if (encodingType === EncodingFormat.UTF8) {\r\n      form.acceptCharset = 'UTF-8';\r\n      form.enctype = 'application/x-www-form-urlencoded; charset=utf-8;';\r\n    } else if (encodingType === EncodingFormat.LATIN1) {\r\n      const enctype = 'ISO-8859-1';\r\n      const featuresJson = JSON.parse(featuresText);\r\n      featuresJson.features.map(f => {\r\n        const encodedProperties = String.fromCharCode\r\n          .apply(null, encode(JSON.stringify(f.properties), { mode: 'replacement' }));\r\n        f.properties = JSON.parse(encodedProperties);\r\n      });\r\n      featuresText = JSON.stringify(featuresJson);\r\n      const encoding = document.createElement('input');\r\n      encoding.setAttribute('type', 'hidden');\r\n      encoding.setAttribute('name', 'encoding');\r\n      encoding.setAttribute('value', enctype);\r\n      form.appendChild(encoding);\r\n    }\r\n\r\n    if (format === 'CSVsemicolon') {\r\n      const options = document.createElement('input');\r\n      options.setAttribute('type', 'hidden');\r\n      options.setAttribute('name', 'lco');\r\n      options.setAttribute('value', 'SEPARATOR=SEMICOLON');\r\n      form.appendChild(options);\r\n    }\r\n\r\n    const geojsonField = document.createElement('input');\r\n    geojsonField.setAttribute('type', 'hidden');\r\n    geojsonField.setAttribute('name', 'json');\r\n    geojsonField.setAttribute('value', featuresText);\r\n    form.appendChild(geojsonField);\r\n\r\n    const outputNameField = document.createElement('input');\r\n    let outputName = format === 'Shapefile' ? `${title}.zip` : `${title}.${format.toLowerCase()}`;\r\n    if (format === 'CSVcomma' || format === 'CSVsemicolon') {\r\n      outputName = `${title}.csv`;\r\n    }\r\n    outputName = outputName.replace(' ', '_');\r\n    outputName = outputName.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n    outputNameField.setAttribute('type', 'hidden');\r\n    outputNameField.setAttribute('name', 'outputName');\r\n    outputNameField.setAttribute('value', outputName);\r\n    form.appendChild(outputNameField);\r\n\r\n    let ogreFormat = ExportService.ogreFormats[format];\r\n    if (format === 'CSVcomma' || format === 'CSVsemicolon') {\r\n      ogreFormat = 'CSV';\r\n    }\r\n    const outputFormatField = document.createElement('input');\r\n    outputFormatField.setAttribute('type', 'hidden');\r\n    outputFormatField.setAttribute('name', 'format');\r\n    outputFormatField.setAttribute('value', ogreFormat);\r\n    form.appendChild(outputFormatField);\r\n\r\n    form.submit();\r\n    document.body.removeChild(form);\r\n\r\n    observer.complete();\r\n  }\r\n\r\n  private nothingToExport(olFeatures: OlFeature<OlGeometry>[], format: string): boolean {\r\n    if (olFeatures.length === 0) {\r\n      return true;\r\n    }\r\n    if (format === 'GPX') {\r\n      const pointOrLine = olFeatures.find(olFeature => {\r\n        return (\r\n          ['Point', 'LineString', 'MultiLineString'].indexOf(olFeature.getGeometry().getType()) >= 0\r\n        );\r\n      });\r\n      return pointOrLine === undefined;\r\n    }\r\n    return false;\r\n  }\r\n}\r\n","/**\r\n * Trigger download of a file\r\n *\r\n * @param content File content\r\n * @param mimeType File mime type\r\n * @param fileName File name\r\n */\r\nexport function downloadContent(content: string, mimeType: string, fileName: string) {\r\n  const uri = `data:${mimeType},${encodeURIComponent(content)}`;\r\n  downloadFromUri(uri, fileName);\r\n}\r\n\r\n/**\r\n * Trigger download of a file\r\n *\r\n * @param content File content\r\n * @param mimeType File mime type\r\n * @param fileName File name\r\n */\r\nexport function downloadFromUri(uri: string, fileName: string) {\r\n  const element = document.createElement('a');\r\n  element.setAttribute('href', uri);\r\n  element.setAttribute('download', fileName);\r\n  element.style.display = 'none';\r\n  document.body.appendChild(element);\r\n\r\n  element.click();\r\n\r\n  document.body.removeChild(element);\r\n}\r\n","import * as olStyle from 'ol/style';\r\nimport OlFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport { MessageService, LanguageService } from '@igo2/core';\r\n\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { FeatureDataSourceOptions } from '../../datasource/shared/datasources/feature-datasource.interface';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport {\r\n  featureToOl,\r\n  moveToOlFeatures,\r\n  computeOlFeaturesExtent\r\n} from '../../feature/shared/feature.utils';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { QueryableDataSourceOptions } from '../../query/shared/query.interfaces';\r\nimport { StyleService } from '../../layer/shared/style.service';\r\nimport { StyleByAttribute } from '../../layer/shared/vector-style.interface';\r\nimport { StyleListService } from '../style-list/style-list.service';\r\nimport { ClusterParam } from '../../layer/shared/clusterParam';\r\nimport { ClusterDataSource } from '../../datasource/shared/datasources/cluster-datasource';\r\nimport { ClusterDataSourceOptions } from '../../datasource/shared/datasources/cluster-datasource.interface';\r\nimport { uuid } from '@igo2/utils';\r\n\r\nexport function addLayerAndFeaturesToMap(\r\n  features: Feature[],\r\n  map: IgoMap,\r\n  layerTitle: string\r\n): VectorLayer {\r\n  const olFeatures = features.map((feature: Feature) =>\r\n    featureToOl(feature, map.projection)\r\n  );\r\n\r\n  const sourceOptions: FeatureDataSourceOptions & QueryableDataSourceOptions = {\r\n    type: 'vector',\r\n    queryable: true\r\n  };\r\n  const source = new FeatureDataSource(sourceOptions);\r\n  source.ol.addFeatures(olFeatures);\r\n  const layer = new VectorLayer({\r\n    title: layerTitle,\r\n    isIgoInternalLayer: true,\r\n    source,\r\n    style: createImportedLayerRandomStyle()\r\n  });\r\n  layer.setExtent(computeOlFeaturesExtent(map, olFeatures));\r\n  map.addLayer(layer);\r\n  moveToOlFeatures(map, olFeatures);\r\n\r\n  return layer;\r\n}\r\n\r\nexport function addLayerAndFeaturesStyledToMap(\r\n  features: Feature[],\r\n  map: IgoMap,\r\n  layerTitle: string,\r\n  styleListService: StyleListService,\r\n  styleService: StyleService,\r\n  layerId?: string,\r\n  imposedSourceOptions?,\r\n  imposedLayerOptions?,\r\n  zoomTo: boolean = true\r\n\r\n): VectorLayer {\r\n  const olFeatures = features.map((feature: Feature) =>\r\n    featureToOl(feature, map.projection)\r\n  );\r\n  let style;\r\n  let distance: number;\r\n\r\n  if (\r\n    styleListService.getStyleList(layerTitle.toString() + '.styleByAttribute')\r\n  ) {\r\n    const styleByAttribute: StyleByAttribute = styleListService.getStyleList(\r\n      layerTitle.toString() + '.styleByAttribute'\r\n    );\r\n\r\n    style = (feature, resolution) => {\r\n      return styleService.createStyleByAttribute(feature, styleByAttribute, resolution);\r\n    };\r\n  } else if (\r\n    styleListService.getStyleList(layerTitle.toString() + '.clusterStyle')\r\n  ) {\r\n    const clusterParam: ClusterParam = styleListService.getStyleList(\r\n      layerTitle.toString() + '.clusterParam'\r\n    );\r\n    distance = styleListService.getStyleList(\r\n      layerTitle.toString() + '.distance'\r\n    );\r\n\r\n    style = (feature, resolution) => {\r\n      const baseStyle = styleService.createStyle(\r\n        styleListService.getStyleList(layerTitle.toString() + '.clusterStyle'), feature, resolution\r\n      );\r\n      return styleService.createClusterStyle(feature, resolution, clusterParam, baseStyle);\r\n    };\r\n  } else if (styleListService.getStyleList(layerTitle.toString() + '.style')) {\r\n    style = (feature, resolution) => styleService.createStyle(\r\n      styleListService.getStyleList(layerTitle.toString() + '.style'), feature, resolution\r\n    );\r\n  } else if (\r\n    styleListService.getStyleList('default.clusterStyle') &&\r\n    features[0].geometry.type === 'Point'\r\n  ) {\r\n    const clusterParam: ClusterParam = styleListService.getStyleList(\r\n      'default.clusterParam'\r\n    );\r\n    distance = styleListService.getStyleList('default.distance');\r\n\r\n    style = (feature, resolution) => {\r\n      const baseStyle = styleService.createStyle(\r\n        styleListService.getStyleList('default.clusterStyle'), feature, resolution\r\n      );\r\n      return styleService.createClusterStyle(feature, resolution, clusterParam, baseStyle);\r\n    };\r\n  } else {\r\n    style = (feature, resolution) => styleService.createStyle(\r\n      styleListService.getStyleList('default.style'), feature, resolution\r\n    );\r\n  }\r\n\r\n  let source;\r\n  if (styleListService.getStyleList(layerTitle.toString() + '.clusterStyle')) {\r\n    const sourceOptions: ClusterDataSourceOptions &\r\n      QueryableDataSourceOptions = {\r\n      distance,\r\n      type: 'cluster',\r\n      queryable: true\r\n    };\r\n    source = new ClusterDataSource(Object.assign(sourceOptions, imposedSourceOptions));\r\n    source.ol.source.addFeatures(olFeatures);\r\n  } else if (styleListService.getStyleList(layerTitle.toString())) {\r\n    const sourceOptions: FeatureDataSourceOptions & QueryableDataSourceOptions = {\r\n      type: 'vector',\r\n      queryable: true\r\n    };\r\n    source = new FeatureDataSource(Object.assign(sourceOptions, imposedSourceOptions));\r\n    source.ol.addFeatures(olFeatures);\r\n  } else if (\r\n    styleListService.getStyleList('default.clusterStyle') &&\r\n    features[0].geometry.type === 'Point'\r\n  ) {\r\n    const sourceOptions: ClusterDataSourceOptions &\r\n      QueryableDataSourceOptions = {\r\n      distance,\r\n      type: 'cluster',\r\n      queryable: true\r\n    };\r\n    source = new ClusterDataSource(Object.assign(sourceOptions, imposedSourceOptions));\r\n    source.ol.source.addFeatures(olFeatures);\r\n  } else {\r\n    const sourceOptions: FeatureDataSourceOptions & QueryableDataSourceOptions = {\r\n      type: 'vector',\r\n      queryable: true\r\n    };\r\n    source = new FeatureDataSource(Object.assign(sourceOptions, imposedSourceOptions));\r\n    source.ol.addFeatures(olFeatures);\r\n  }\r\n\r\n  const layer = new VectorLayer(\r\n    Object.assign({\r\n      title: layerTitle,\r\n      id: layerId || uuid(),\r\n      isIgoInternalLayer: true,\r\n      source,\r\n      style\r\n    }, imposedLayerOptions));\r\n  map.addLayer(layer);\r\n  if (zoomTo){\r\n    moveToOlFeatures(map, olFeatures);\r\n  }\r\n  return layer;\r\n}\r\n\r\nexport function handleFileImportSuccess(\r\n  file: File,\r\n  features: Feature[],\r\n  map: IgoMap,\r\n  messageService: MessageService,\r\n  languageService: LanguageService,\r\n  styleListService?: StyleListService,\r\n  styleService?: StyleService\r\n) {\r\n  if (features.length === 0) {\r\n    handleNothingToImportError(file, messageService, languageService);\r\n    return;\r\n  }\r\n\r\n  const layerTitle = computeLayerTitleFromFile(file);\r\n\r\n  if (!styleListService) {\r\n    addLayerAndFeaturesToMap(features, map, layerTitle);\r\n  } else {\r\n    addLayerAndFeaturesStyledToMap(\r\n      features,\r\n      map,\r\n      layerTitle,\r\n      styleListService,\r\n      styleService\r\n    );\r\n  }\r\n\r\n  const translate = languageService.translate;\r\n  const messageTitle = translate.instant('igo.geo.dropGeoFile.success.title');\r\n  const message = translate.instant('igo.geo.dropGeoFile.success.text', {\r\n    value: layerTitle\r\n  });\r\n  messageService.success(message, messageTitle);\r\n}\r\n\r\nexport function handleFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService,\r\n  sizeMb?: number\r\n) {\r\n  sizeMb = sizeMb ? sizeMb : 30;\r\n  const errMapping = {\r\n    'Invalid file': handleInvalidFileImportError,\r\n    'File is too large': handleSizeFileImportError,\r\n    'Failed to read file': handleUnreadbleFileImportError,\r\n    'Invalid SRS definition': handleSRSImportError,\r\n    'Error 500 with OGRE': handleOgreServerImportError\r\n  };\r\n  errMapping[error.message](\r\n    file,\r\n    error,\r\n    messageService,\r\n    languageService,\r\n    sizeMb\r\n  );\r\n}\r\n\r\nexport function handleInvalidFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant('igo.geo.dropGeoFile.invalid.title');\r\n  const message = translate.instant('igo.geo.dropGeoFile.invalid.text', {\r\n    value: file.name,\r\n    mimeType: file.type\r\n  });\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function handleUnreadbleFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant('igo.geo.dropGeoFile.unreadable.title');\r\n  const message = translate.instant('igo.geo.dropGeoFile.unreadable.text', {\r\n    value: file.name\r\n  });\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function handleSizeFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService,\r\n  sizeMb: number\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant('igo.geo.dropGeoFile.tooLarge.title');\r\n  const message = translate.instant('igo.geo.dropGeoFile.tooLarge.text', {\r\n    value: file.name,\r\n    size: sizeMb\r\n  });\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function handleNothingToImportError(\r\n  file: File,\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant('igo.geo.dropGeoFile.empty.title');\r\n  const message = translate.instant('igo.geo.dropGeoFile.empty.text', {\r\n    value: file.name,\r\n    mimeType: file.type\r\n  });\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function handleSRSImportError(\r\n  file: File,\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant('igo.geo.dropGeoFile.invalidSRS.title');\r\n  const message = translate.instant('igo.geo.dropGeoFile.invalidSRS.text', {\r\n    value: file.name,\r\n    mimeType: file.type\r\n  });\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function handleOgreServerImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const title = languageService.translate.instant('igo.geo.dropGeoFile.ogreServer.title');\r\n  const message = languageService.translate.instant('igo.geo.dropGeoFile.ogreServer.text');\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function getFileExtension(file: File): string {\r\n  return file.name\r\n    .split('.')\r\n    .pop()\r\n    .toLowerCase();\r\n}\r\n\r\nexport function computeLayerTitleFromFile(file: File): string {\r\n  return file.name.substr(0, file.name.lastIndexOf('.'));\r\n}\r\nfunction createImportedLayerRandomStyle(): (olFeature: OlFeature<OlGeometry>) => olStyle.Style {\r\n  const r = Math.floor(Math.random() * 255);\r\n  const g = Math.floor(Math.random() * 255);\r\n  const b = Math.floor(Math.random() * 255);\r\n  const stroke = new olStyle.Stroke({\r\n    color: [r, g, b, 1],\r\n    width: 2\r\n  });\r\n  const fill = new olStyle.Fill({\r\n    color: [r, g, b, 0.4]\r\n  });\r\n\r\n  return (olFeature: OlFeature<OlGeometry>) => {\r\n      const customStyle = olFeature.get('_style');\r\n      if (customStyle) {\r\n        const styleService = new StyleService();\r\n        return styleService.createStyle(customStyle);\r\n      }\r\n\r\n      const style = new olStyle.Style({\r\n        stroke,\r\n        fill,\r\n        image: new olStyle.Circle({\r\n          radius: 5,\r\n          stroke,\r\n          fill\r\n        }),\r\n        text: olFeature.get('_mapTitle') ? new olStyle.Text({\r\n          text: olFeature.get('_mapTitle').toString(),\r\n          offsetX: 5,\r\n          offsetY: -5,\r\n          font: '12px Calibri,sans-serif',\r\n          fill: new olStyle.Fill({ color: '#000' }),\r\n          stroke: new olStyle.Stroke({ color: '#fff', width: 3 }),\r\n          overflow: true\r\n        }): undefined\r\n      });\r\n      return style;\r\n  };\r\n}\r\n\r\n","export class ImportError extends Error {}\r\n\r\nexport class ImportInvalidFileError extends ImportError {\r\n  constructor() {\r\n    super('Invalid file');\r\n    Object.setPrototypeOf(this, ImportInvalidFileError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportUnreadableFileError extends ImportError {\r\n  constructor() {\r\n      super('Failed to read file');\r\n      Object.setPrototypeOf(this, ImportUnreadableFileError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportNothingToImportError extends ImportError {\r\n  constructor() {\r\n      super('Nothing to import');\r\n      Object.setPrototypeOf(this, ImportNothingToImportError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportSizeError extends ImportError {\r\n  constructor() {\r\n      super('File is too large');\r\n      Object.setPrototypeOf(this, ImportNothingToImportError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportSRSError extends ImportError {\r\n  constructor() {\r\n      super('Invalid SRS definition');\r\n      Object.setPrototypeOf(this, ImportNothingToImportError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportOgreServerError extends ImportError {\r\n  constructor() {\r\n      super('Error 500 with OGRE');\r\n      Object.setPrototypeOf(this, ImportOgreServerError.prototype);\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient, HttpHeaders } from '@angular/common/http';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { uuid } from '@igo2/utils';\r\n\r\nimport { Observable, Observer } from 'rxjs';\r\n\r\nimport * as olformat from 'ol/format';\r\nimport OlFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport {\r\n  ImportInvalidFileError,\r\n  ImportUnreadableFileError,\r\n  ImportSizeError,\r\n  ImportSRSError,\r\n  ImportOgreServerError\r\n} from './import.errors';\r\nimport { computeLayerTitleFromFile, getFileExtension } from './import.utils';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ImportService {\r\n  static allowedMimeTypes = [\r\n    'application/gml+xml',\r\n    'application/vnd.google-earth.kml+xml',\r\n    'application/gpx+xml',\r\n    'application/json'\r\n  ];\r\n\r\n  static allowedZipMimeTypes = [\r\n    'application/zip',\r\n    'application/x-zip-compressed',\r\n    'application/x-zip'\r\n  ];\r\n\r\n  static allowedExtensions = ['geojson', 'kml', 'gpx', 'json', 'gml'];\r\n\r\n  private ogreUrl: string;\r\n  private clientSideFileSizeMax: number;\r\n\r\n  constructor(private http: HttpClient, private config: ConfigService) {\r\n    this.ogreUrl = this.config.getConfig('importExport.url');\r\n    const configFileSizeMb = this.config.getConfig('importExport.clientSideFileSizeMaxMb');\r\n    this.clientSideFileSizeMax = (configFileSizeMb ? configFileSizeMb : 30) * Math.pow(1024, 2);\r\n  }\r\n\r\n  import(\r\n    file: File,\r\n    projectionIn = 'EPSG:4326',\r\n    projectionOut = 'EPSG:4326'\r\n  ): Observable<Feature[]> {\r\n    return this.importAsync(file, projectionIn, projectionOut);\r\n  }\r\n\r\n  private getFileImporter(\r\n    file: File\r\n  ): (\r\n    file: File,\r\n    observer: Observer<Feature[]>,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ) => void {\r\n    const extension = getFileExtension(file);\r\n    const mimeType = file.type;\r\n    const allowedMimeTypes = [\r\n      ...ImportService.allowedMimeTypes,\r\n      ...ImportService.allowedZipMimeTypes\r\n    ];\r\n    const allowedExtensions = ImportService.allowedExtensions;\r\n\r\n    if (\r\n      allowedMimeTypes.indexOf(mimeType) < 0 &&\r\n      allowedExtensions.indexOf(extension) < 0\r\n    ) {\r\n      return undefined;\r\n    } else if (\r\n      mimeType === 'application/json' ||\r\n      ['json', 'geojson', 'kml', 'gpx'].indexOf(extension) >= 0\r\n    ) {\r\n      return this.importFile;\r\n    } else if (this.ogreUrl !== undefined) {\r\n      return this.importFileWithOgre;\r\n    }\r\n\r\n    return undefined;\r\n  }\r\n\r\n  private importAsync(\r\n    file: File,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ): Observable<Feature[]> {\r\n    const doImport = (observer: Observer<Feature[]>) => {\r\n      if (file.size >= this.clientSideFileSizeMax) {\r\n        observer.error(new ImportSizeError());\r\n        return;\r\n      }\r\n      const importer = this.getFileImporter(file);\r\n      if (importer === undefined) {\r\n        observer.error(new ImportInvalidFileError());\r\n        return;\r\n      }\r\n\r\n      importer.call(this, file, observer, projectionIn, projectionOut);\r\n    };\r\n\r\n    return new Observable(doImport);\r\n  }\r\n\r\n  private importFile(\r\n    file: File,\r\n    observer: Observer<Feature[]>,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ) {\r\n    const reader = new FileReader();\r\n\r\n    reader.onload = (event: any) => {\r\n      try {\r\n        const features = this.parseFeaturesFromFile(\r\n          file,\r\n          event.target.result,\r\n          projectionIn,\r\n          projectionOut\r\n        );\r\n        observer.next(features);\r\n      } catch (e) {\r\n        observer.error(new ImportUnreadableFileError());\r\n      }\r\n\r\n      observer.complete();\r\n    };\r\n\r\n    reader.onerror = evt => {\r\n      observer.error(new ImportUnreadableFileError());\r\n    };\r\n\r\n    reader.readAsText(file, 'UTF-8');\r\n  }\r\n\r\n  private importFileWithOgre(\r\n    file: File,\r\n    observer: Observer<Feature[]>,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ) {\r\n    const url = `${this.ogreUrl}/convert`;\r\n    const formData = new FormData();\r\n    formData.append('upload', file);\r\n    formData.append('sourceSrs', projectionIn);\r\n    formData.append('targetSrs', projectionOut);\r\n    formData.append('formatOutput', 'GEOJSON');\r\n    formData.append('skipFailures', '');\r\n\r\n    this.http.post(url, formData, { headers: new HttpHeaders() })\r\n    .subscribe(\r\n      (response: { errors?: string[] } | object | null) => {\r\n        if (response === null) {\r\n          observer.error(new ImportUnreadableFileError());\r\n          return;\r\n        }\r\n\r\n        const errors = (response as any).errors || [];\r\n        if (errors.length > 0) {\r\n          observer.error(new ImportUnreadableFileError());\r\n        } else {\r\n          const features = this.parseFeaturesFromGeoJSON(\r\n            file,\r\n            response,\r\n            projectionOut\r\n          );\r\n          observer.next(features);\r\n          observer.complete();\r\n        }\r\n      },\r\n      (error: any) => {\r\n        error.error.caught = true;\r\n        const errMsg = error.error.msg || '';\r\n        if (errMsg === 'No valid files found') {\r\n          observer.error(new ImportInvalidFileError());\r\n        } else if (errMsg && errMsg.startWith('ERROR 1: Failed to process SRS definition')\r\n        ) {\r\n          observer.error(new ImportSRSError());\r\n        } else if (error.status === 500) {\r\n          observer.error(new ImportOgreServerError());\r\n        } else {\r\n          observer.error(new ImportUnreadableFileError());\r\n        }\r\n      }\r\n    );\r\n  }\r\n\r\n  private parseFeaturesFromFile(\r\n    file: File,\r\n    data: string,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ): Feature[] {\r\n    const extension = getFileExtension(file);\r\n    const mimeType = file.type;\r\n\r\n    const GeoJSON = new olformat.GeoJSON();\r\n\r\n    let format;\r\n    if (mimeType === 'application/vnd.google-earth.kml+xml') {\r\n      format = new olformat.KML();\r\n    } else if (mimeType === 'application/gml+xml') {\r\n      format = new olformat.GML();\r\n    } else if (mimeType === 'application/gpx+xml') {\r\n      format = new olformat.GPX();\r\n    } else {\r\n      switch (extension) {\r\n        case 'kml':\r\n          format = new olformat.KML();\r\n          break;\r\n        case 'gpx':\r\n          format = new olformat.GPX();\r\n          break;\r\n        case 'gml':\r\n          format = new olformat.GML();\r\n          break;\r\n        default:\r\n          format = GeoJSON;\r\n          break;\r\n      }\r\n    }\r\n\r\n    const olFeatures = format.readFeatures(data, {\r\n      dataProjection: projectionIn,\r\n      featureProjection: projectionOut\r\n    });\r\n    const features = olFeatures.map((olFeature: OlFeature<OlGeometry>) => {\r\n      return Object.assign(GeoJSON.writeFeatureObject(olFeature), {\r\n        projection: projectionOut,\r\n        meta: {\r\n          id: uuid(),\r\n          title: computeLayerTitleFromFile(file)\r\n        }\r\n      });\r\n    });\r\n\r\n    return features;\r\n  }\r\n\r\n  private parseFeaturesFromGeoJSON(\r\n    file: File,\r\n    data: object,\r\n    projectionOut: string\r\n  ): Feature[] {\r\n    const olFormat = new olformat.GeoJSON();\r\n    const olFeatures = olFormat.readFeatures(data);\r\n    const features = olFeatures.map((olFeature: OlFeature<OlGeometry>) => {\r\n      return Object.assign(olFormat.writeFeatureObject(olFeature), {\r\n        projection: projectionOut,\r\n        meta: {\r\n          id: uuid(),\r\n          title: computeLayerTitleFromFile(file)\r\n        }\r\n      });\r\n    });\r\n\r\n    return features as Feature[];\r\n  }\r\n}\r\n","import { Injectable, Injector } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { throwError } from 'rxjs';\r\nimport { catchError } from 'rxjs/operators';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport { StyleListOptions } from './style-list.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class StyleListService {\r\n  private styleList: object = {};\r\n\r\n  constructor(private injector: Injector) {}\r\n\r\n  /**\r\n   * Use to get the data found in styleList file\r\n   */\r\n  public getStyleList(key: string): any {\r\n    return ObjectUtils.resolve(this.styleList, key);\r\n  }\r\n\r\n  /**\r\n   * This method loads \"[path]\" to get all styleList's variables\r\n   */\r\n  public load(options: StyleListOptions) {\r\n    const baseStyleList = options.default || {};\r\n    if (!options.path) {\r\n      this.styleList = baseStyleList;\r\n      return true;\r\n    }\r\n\r\n    const http = this.injector.get(HttpClient);\r\n\r\n    return new Promise((resolve, _reject) => {\r\n      http\r\n        .get(options.path)\r\n        .pipe(\r\n          catchError((error: any): any => {\r\n            console.log(`StyleList file ${options.path} could not be read`);\r\n            resolve(true);\r\n            return throwError(error.error || 'Server error');\r\n          })\r\n        )\r\n        .subscribe((styleListResponse: object) => {\r\n          this.styleList = ObjectUtils.mergeDeep(baseStyleList, styleListResponse);\r\n          resolve(true);\r\n        });\r\n    });\r\n  }\r\n}\r\n","<div class=\"import-export-toggle mat-typography\">\r\n  <mat-button-toggle-group\r\n        [value]=\"selectedMode\"\r\n        (change)=\"onImportExportChange($event)\">\r\n        <mat-button-toggle [value]=\"'import'\">\r\n          {{'igo.geo.importExportForm.importTabTitle' | translate}}\r\n        </mat-button-toggle>\r\n        <mat-button-toggle [value]=\"'export'\">\r\n          {{'igo.geo.importExportForm.exportTabTitle' | translate}}\r\n        </mat-button-toggle>\r\n  </mat-button-toggle-group>\r\n</div>\r\n\r\n<form class=\"igo-form\" [formGroup]=\"importForm\" *ngIf=\"selectedMode === 'import'\">\r\n  <div class=\"igo-input-container\">\r\n    <mat-form-field>\r\n      <mat-label>{{'igo.geo.importExportForm.importProjPlaceholder' | translate}}</mat-label>\r\n      <mat-select\r\n        [(value)]=\"inputProj\">\r\n        <mat-option\r\n          *ngFor=\"let projection of (projections$ | async)\"\r\n          [value]=\"projection\"\r\n          (click)=\"$event.stopPropagation()\">\r\n          <p mat-line *ngIf=\"projection.translateKey\">{{('igo.geo.importExportForm.projections.' + projection.translateKey) | translate: projection}}</p>\r\n          <p mat-line *ngIf=\"!projection.translateKey\">{{projection.alias}}</p>\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"importForm.invalid ? ('igo.geo.importExportForm.projections.choose' | translate) : ('igo.geo.importExportForm.importButton' | translate)\"\r\n    class=\"igo-form-button-group\">\r\n    <button\r\n      [disabled]=\"importForm.invalid || (loading$ | async)\"\r\n      mat-raised-button\r\n      type=\"button\"\r\n      (click)=\"fileInput.click()\">\r\n        {{'igo.geo.importExportForm.importButton' | translate}}\r\n    </button>\r\n    <igo-spinner [shown]=\"loading$ | async\"></igo-spinner>\r\n    <input\r\n      hidden\r\n      #fileInput\r\n      type=\"file\"\r\n      [style.display]=\"'none'\"\r\n      (click)=\"fileInput.value = null\"\r\n      (change)=\"importFiles($event.target.files)\">\r\n  </div>\r\n</form>\r\n<section class=\"mat-typography\" *ngIf=\"selectedMode === 'import'\">\r\n  <div *ngIf=\"importHtmlClarifications === ''\">\r\n    <h4>{{'igo.geo.importExportForm.importClarifications' | translate}}</h4>\r\n    <ul>\r\n      <li>{{'igo.geo.importExportForm.importSizeMax' | translate: {size: fileSizeMb} }}</li>\r\n      <li>{{'igo.geo.importExportForm.importFormatAuthorized' | translate}}</li>\r\n      <li>{{'igo.geo.importExportForm.importShpZip' | translate}}</li>\r\n    </ul>\r\n  </div>\r\n  <igo-custom-html *ngIf=\"importHtmlClarifications !== ''\" class=\"mat-typography\"\r\n    [html]=\"importHtmlClarifications\">\r\n  </igo-custom-html>\r\n</section>\r\n\r\n<section class=\"mat-typography\" *ngIf=\"(exportableLayers$ | async).length === 0 && selectedMode === 'export'\">\r\n  <h4>{{'igo.geo.importExportForm.exportNoLayersExportable' | translate}}</h4>\r\n</section>\r\n\r\n<form class=\"igo-form\" [formGroup]=\"form\" *ngIf=\"(exportableLayers$ | async).length > 0 && selectedMode === 'export'\">\r\n  <div class=\"igo-input-container\">\r\n    <mat-form-field>\r\n      <mat-label>{{'igo.geo.importExportForm.exportLayerPlaceholder' | translate}}</mat-label>\r\n      <mat-select\r\n        [(value)]=\"layers\" multiple>\r\n        <mat-select-trigger>\r\n          {{layers.length ? getLayerTitleById(layers[0]) : ''}}\r\n          <span *ngIf=\"layers.length > 1\" class=\"export-select-trigger\">\r\n            (+{{layers.length - 1}} {{(layers?.length === 2 ? 'igo.geo.importExportForm.other' : 'igo.geo.importExportForm.others') | translate }})\r\n          </span>\r\n        </mat-select-trigger>\r\n        <mat-option\r\n          *ngFor=\"let layer of (exportableLayers$ | async)\"\r\n          [ngClass]=\"{'igo-export-layer-mat-option': layerHasSelectedFeatures(layer)}\"\r\n          [value]=\"layer.id\"\r\n          (click)=\"$event.stopPropagation()\">\r\n          <p mat-line>{{layer.title}}</p>\r\n          <p mat-line>\r\n            <mat-slide-toggle *ngIf=\"layerHasSelectedFeatures(layer)\"\r\n              [labelPosition]=\"'after'\"\r\n              (click)=\"onlySelectedClick($event,layer.id)\"\r\n              (checked)=\"inLayersIdToExportSelectionOnly(layer)\"\r\n              (change)=\"onlySelected($event,layer.id)\">\r\n              <small>{{'igo.geo.importExportForm.exportSelectedFeature' | translate}}</small>\r\n            </mat-slide-toggle>\r\n          </p>\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\">\r\n    <mat-form-field>\r\n      <mat-label>{{'igo.geo.importExportForm.exportFormatPlaceholder' | translate}}</mat-label>\r\n      <mat-select\r\n        formControlName=\"format\">\r\n        <ng-container *ngIf=\"(formats$ | async).length !== 0\">\r\n          <mat-option *ngFor=\"let format of (formats$ | async) | keyvalue\" [value]=\"format.key\">\r\n            {{'igo.geo.export.format.' + format.value | translate}}\r\n          </mat-option>\r\n        </ng-container>\r\n        <mat-option *ngIf=\"(formats$ | async).length === 0\" disabled=\"true\">\r\n          {{'igo.geo.export.noFormat.title' | translate}}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\" *ngIf=\"forceNaming && form.value.format !== 'URL'\">\r\n    <mat-form-field>\r\n        <input matInput formControlName=\"name\" placeholder=\"{{'igo.geo.importExportForm.exportFileNamePlaceholder' | translate}}\">\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\" *ngIf=\"form.value.format === 'CSVcomma' || form.value.format === 'CSVsemicolon'\">\r\n    <mat-form-field>\r\n      <mat-label>{{'igo.geo.importExportForm.encodingPlaceholder' | translate}}</mat-label>\r\n      <mat-select\r\n        formControlName=\"encoding\">\r\n        <ng-container *ngIf=\"(encodings$ | async).length !== 0\">\r\n          <mat-option *ngFor=\"let encoding of (encodings$ | async) | keyvalue\" [value]=\"encoding.key\">\r\n            {{'igo.geo.export.encoding.' + encoding.value | translate}}\r\n          </mat-option>\r\n        </ng-container>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"export-combine-layers mat-typography\" *ngIf=\"layers.length > 1 && (form.value.format === 'CSVcomma' || form.value.format === 'CSVsemicolon')\">\r\n    <mat-slide-toggle\r\n        formControlName=\"combineLayers\"\r\n        [labelPosition]=\"'before'\">\r\n          {{'igo.geo.importExportForm.exportCombineResults' | translate}}\r\n    </mat-slide-toggle>\r\n  </div>\r\n\r\n  <div class=\"export-separator mat-typography\" *ngIf=\"layers.length > 1 && (form.value.format === 'CSVcomma' || form.value.format === 'CSVsemicolon') && form.value.combineLayers\">\r\n    <mat-slide-toggle\r\n        formControlName=\"separator\"\r\n        [labelPosition]=\"'before'\">\r\n          {{'igo.geo.importExportForm.exportSeparator' | translate}}\r\n    </mat-slide-toggle>\r\n  </div>\r\n\r\n  <div class=\"export-options mat-typography\" *ngIf=\"form.value.format !== 'URL'\">\r\n    <mat-slide-toggle\r\n        formControlName=\"featureInMapExtent\"\r\n        [labelPosition]=\"'before'\">\r\n          {{'igo.geo.importExportForm.exportFeatureInExtent' | translate}}\r\n    </mat-slide-toggle>\r\n  </div>\r\n\r\n  <div class=\"igo-form-button-group\">\r\n    <button\r\n      mat-raised-button\r\n      type=\"button\"\r\n      [disabled]=\"!form.valid || (loading$ | async)\"\r\n      (click)=\"handleExportFormSubmit(form.value)\">\r\n      {{form.value.format !== 'URL'  ? ('igo.geo.importExportForm.exportButton' | translate): (form.value.layers.length > 1  ? ('igo.geo.importExportForm.exportButtonLinks' | translate): ('igo.geo.importExportForm.exportButtonLink' | translate))}}\r\n    </button>\r\n    <igo-spinner [shown]=\"loading$ | async\"></igo-spinner>\r\n  </div>\r\n\r\n  <igo-custom-html *ngIf=\"exportHtmlClarifications !== ''\" class=\"mat-typography\"\r\n    [html]=\"exportHtmlClarifications\">\r\n  </igo-custom-html>\r\n\r\n</form>\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnDestroy,\r\n  OnInit,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\nimport { UntypedFormGroup, UntypedFormBuilder, Validators } from '@angular/forms';\r\nimport { Subscription, BehaviorSubject } from 'rxjs';\r\n\r\nimport {\r\n  MessageService,\r\n  LanguageService,\r\n  ConfigService,\r\n  StorageService\r\n} from '@igo2/core';\r\nimport { strEnum } from '@igo2/utils';\r\n\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { ClusterDataSource } from '../../datasource/shared/datasources/cluster-datasource';\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { AnyLayer } from '../../layer/shared/layers/any-layer';\r\nimport { DataSourceOptions } from '../../datasource/shared/datasources/datasource.interface';\r\nimport olPoint from 'ol/geom/Point';\r\nimport { circular } from 'ol/geom/Polygon';\r\n\r\nimport {\r\n  handleFileExportError,\r\n  handleFileExportSuccess\r\n} from '../shared/export.utils';\r\nimport { ExportOptions } from '../shared/export.interface';\r\nimport { ExportFormat, EncodingFormat } from '../shared/export.type';\r\nimport { ExportService } from '../shared/export.service';\r\nimport { ImportService } from '../shared/import.service';\r\nimport {\r\n  handleFileImportSuccess,\r\n  handleFileImportError\r\n} from '../shared/import.utils';\r\nimport { StyleService } from '../../layer/shared/style.service';\r\nimport { StyleListService } from '../style-list/style-list.service';\r\nimport { skipWhile } from 'rxjs/operators';\r\nimport { EntityRecord, Workspace } from '@igo2/common';\r\nimport type { WorkspaceStore } from '@igo2/common';\r\nimport { WfsWorkspace } from '../../workspace/shared/wfs-workspace';\r\nimport { EditionWorkspace } from '../../workspace/shared/edition-workspace';\r\nimport { FeatureWorkspace } from '../../workspace/shared/feature-workspace';\r\nimport { MatSlideToggleChange } from '@angular/material/slide-toggle';\r\nimport { InputProjections, ProjectionsLimitationsOptions } from '../../map/';\r\nimport { DownloadService } from '../../download/shared/download.service';\r\nimport { computeProjectionsConstraints } from '../../map';\r\n\r\nimport olVectorSource from 'ol/source/Vector';\r\nimport olClusterSource from 'ol/source/Cluster';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\n@Component({\r\n  selector: 'igo-import-export',\r\n  templateUrl: './import-export.component.html',\r\n  styleUrls: ['./import-export.component.scss']\r\n})\r\nexport class ImportExportComponent implements OnDestroy, OnInit {\r\n  public form: UntypedFormGroup;\r\n  public importForm: UntypedFormGroup;\r\n  public formats$ = new BehaviorSubject(undefined);\r\n  public encodings$ = new BehaviorSubject(undefined);\r\n  public exportableLayers$: BehaviorSubject<AnyLayer[]> = new BehaviorSubject(\r\n    []\r\n  );\r\n  public loading$ = new BehaviorSubject(false);\r\n  public forceNaming = false;\r\n  public controlFormat = 'format';\r\n\r\n  private layers$$: Subscription;\r\n  private exportableLayers$$: Subscription;\r\n  private formats$$: Subscription;\r\n  private encodings$$: Subscription;\r\n  private formLayer$$: Subscription;\r\n  private exportOptions$$: Subscription;\r\n\r\n  public importHtmlClarifications: string;\r\n  public exportHtmlClarifications: string;\r\n\r\n  private espgCodeRegex = new RegExp('^\\\\d{4,6}');\r\n  private clientSideFileSizeMax: number;\r\n  public fileSizeMb: number;\r\n\r\n  public projections$: BehaviorSubject<InputProjections[]> = new BehaviorSubject([]);\r\n  private projectionsConstraints: ProjectionsLimitationsOptions;\r\n\r\n  public popupChecked: boolean = false;\r\n\r\n  private previousLayerSpecs$: BehaviorSubject<\r\n    {\r\n      id: string;\r\n      visible: boolean;\r\n      opacity: number;\r\n      queryable: boolean;\r\n    }[]\r\n  > = new BehaviorSubject(undefined);\r\n\r\n  @Input() selectFirstProj: boolean = false;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  private _projectionsLimitations: ProjectionsLimitationsOptions = {};\r\n  @Input()\r\n  set projectionsLimitations(value: ProjectionsLimitationsOptions) {\r\n    this._projectionsLimitations = value;\r\n    this.computeProjections();\r\n  }\r\n  get projectionsLimitations(): ProjectionsLimitationsOptions {\r\n    return this._projectionsLimitations || {};\r\n  }\r\n\r\n  /**\r\n   * Store that holds the available workspaces.\r\n   */\r\n  @Input() store: WorkspaceStore;\r\n\r\n  @Input() selectedMode = 'import';\r\n\r\n  @Output() selectMode = new EventEmitter<string>();\r\n\r\n  @Input() exportOptions$: BehaviorSubject<ExportOptions> = new BehaviorSubject(\r\n    undefined\r\n  );\r\n\r\n  @Output() exportOptionsChange = new EventEmitter<ExportOptions>();\r\n\r\n  get layers() {\r\n    return this.form.get('layers').value;\r\n  }\r\n  set layers(value) {\r\n    this.form.patchValue({ layers: value });\r\n  }\r\n\r\n  get inputProj() {\r\n    return this.importForm.get('inputProj').value;\r\n  }\r\n  set inputProj(value) {\r\n    this.importForm.patchValue({ inputProj: value });\r\n  }\r\n\r\n  get popupAllowed(): boolean {\r\n    return this.storageService.get('importExportPopupAllowed') as boolean || false;\r\n  }\r\n\r\n  set popupAllowed(value: boolean) {\r\n    this.storageService.set('importExportPopupAllowed', value);\r\n  }\r\n\r\n  constructor(\r\n    private importService: ImportService,\r\n    private exportService: ExportService,\r\n    private languageService: LanguageService,\r\n    private messageService: MessageService,\r\n    private styleListService: StyleListService,\r\n    private styleService: StyleService,\r\n    private formBuilder: UntypedFormBuilder,\r\n    private config: ConfigService,\r\n    private cdRef: ChangeDetectorRef,\r\n    private storageService: StorageService,\r\n    private downloadService: DownloadService\r\n  ) {\r\n    this.loadConfig();\r\n    this.buildForm();\r\n    this.computeProjections();\r\n    this.importHtmlClarifications = this.languageService.translate.instant('igo.geo.importExportForm.importHtmlClarifications');\r\n    this.exportHtmlClarifications = this.languageService.translate.instant('igo.geo.importExportForm.exportHtmlClarifications');\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.layers$$ = this.map.layers$.subscribe((layers) => {\r\n      this.exportableLayers$.next(\r\n        layers.filter((layer: Layer) => {\r\n          return (\r\n            (layer instanceof VectorLayer && layer.exportable === true) ||\r\n            (layer.dataSource.options.download &&\r\n              layer.dataSource.options.download.url)\r\n          );\r\n        }) as AnyLayer[]\r\n      );\r\n    });\r\n    const configFileSizeMb = this.config.getConfig(\r\n      'importExport.clientSideFileSizeMaxMb'\r\n    );\r\n    this.clientSideFileSizeMax =\r\n      (configFileSizeMb ? configFileSizeMb : 30) * Math.pow(1024, 2);\r\n    this.fileSizeMb = this.clientSideFileSizeMax / Math.pow(1024, 2);\r\n\r\n    this.exportOptions$$ = this.exportOptions$\r\n      .pipe(skipWhile((exportOptions) => !exportOptions))\r\n      .subscribe((exportOptions) => {\r\n        this.form.patchValue(exportOptions, { emitEvent: true });\r\n        if (exportOptions.layers) {\r\n          this.computeFormats(\r\n            exportOptions.layers.map((l) => this.map.getLayerById(l))\r\n          );\r\n        }\r\n      });\r\n    this.formLayer$$ = this.form\r\n      .get('format')\r\n      .valueChanges\r\n      .subscribe((format) => {\r\n        const ogreFormats = Object.keys(ExportService.ogreFormats);\r\n        if (\r\n          !this.popupChecked &&\r\n          this.form.get('layers').value?.length > 1 &&\r\n          (ogreFormats.indexOf(format) >= 0 || format === ExportFormat.URL)) {\r\n          if (!this.handlePopup(true)) {\r\n            this.form.patchValue({ format: undefined }, { emitEvent: false });\r\n          }\r\n        }\r\n      });\r\n\r\n    this.formLayer$$ = this.form\r\n      .get('layers')\r\n      .valueChanges.subscribe((layersId) => {\r\n        this.handlePreviousLayerSpecs();\r\n        const selectedLayers = layersId instanceof Array ? layersId : [layersId];\r\n        this.form.patchValue({ layers: selectedLayers }, { emitEvent: false });\r\n        const layers = selectedLayers.map((l) => this.map.getLayerById(l));\r\n        this.computeFormats(layers);\r\n\r\n        if (\r\n          Object.keys(this.formats$.value).indexOf(this.form.value.format) ===\r\n          -1\r\n        ) {\r\n          this.form.patchValue({ format: undefined });\r\n        }\r\n\r\n        this.loading$.next(true);\r\n        const previousSpecs: {\r\n          id: string;\r\n          visible: boolean;\r\n          opacity: number;\r\n          queryable: boolean;\r\n        }[] = [];\r\n        layers.forEach((layer) => {\r\n          if (\r\n            layer instanceof VectorLayer &&\r\n            layer.dataSource.ol.getFeatures().length === 0\r\n          ) {\r\n            previousSpecs.push({\r\n              id: layer.id,\r\n              visible: layer.visible,\r\n              opacity: layer.opacity,\r\n              queryable: (layer as any).queryable\r\n            });\r\n            layer.opacity = 0;\r\n            layer.visible = true;\r\n          }\r\n        });\r\n\r\n        this.previousLayerSpecs$.next(previousSpecs);\r\n        setTimeout(() => {\r\n          this.loading$.next(false);\r\n        }, 500);\r\n      });\r\n\r\n    this.formats$$ = this.formats$\r\n      .pipe(skipWhile((formats) => !formats))\r\n      .subscribe((formats) => {\r\n        if (Object.keys(formats).length === 1) {\r\n          this.form.patchValue({ format: formats[Object.keys(formats)[0]] });\r\n        }\r\n      });\r\n\r\n    this.encodings$$ = this.encodings$\r\n      .pipe(skipWhile((encodings) => !encodings))\r\n      .subscribe((encodings) => {\r\n        if (Object.keys(encodings).length === 1) {\r\n          this.form.patchValue({ encoding: encodings[Object.keys(encodings)[0]] });\r\n        }\r\n      });\r\n\r\n    this.exportableLayers$$ = this.exportableLayers$\r\n      .pipe(skipWhile((layers) => !layers))\r\n      .subscribe((layers) => {\r\n        if (layers.length === 1) {\r\n          this.form.patchValue({ layers: layers[0].id });\r\n        }\r\n      });\r\n\r\n    this.form.controls[this.controlFormat].valueChanges.subscribe((format) => {\r\n      if (format === ExportFormat.CSVcomma || format === ExportFormat.CSVsemicolon) {\r\n        this.form.patchValue({ encoding: EncodingFormat.LATIN1 });\r\n      } else {\r\n        this.form.patchValue({ encoding: EncodingFormat.UTF8 });\r\n      }\r\n      this.cdRef.detectChanges();\r\n    });\r\n\r\n    if (this.selectFirstProj) {\r\n      if (this.projections$.value.length === 0) {\r\n        this.importForm.patchValue({ inputProj: { translateKey: 'nad83', alias: 'NAD83', code: 'EPSG:4326', zone: '' } });\r\n      } else {\r\n        this.importForm.patchValue({ inputProj: this.projections$.value[0] });\r\n      }\r\n    } else {\r\n      this.importForm.patchValue({ inputProj: undefined });\r\n    }\r\n  }\r\n\r\n  private computeProjections() {\r\n    this.projectionsConstraints = computeProjectionsConstraints(this.projectionsLimitations);\r\n    const projections: InputProjections[] = [];\r\n\r\n    if (this.projectionsConstraints.nad83) {\r\n      projections.push({ translateKey: 'nad83', alias: 'NAD83', code: 'EPSG:4269', zone: '' });\r\n    }\r\n    if (this.projectionsConstraints.wgs84) {\r\n      projections.push({ translateKey: 'wgs84', alias: 'WGS84', code: 'EPSG:4326', zone: '' });\r\n    }\r\n    if (this.projectionsConstraints.webMercator) {\r\n      projections.push({ translateKey: 'webMercator', alias: 'Web Mercator', code: 'EPSG:3857', zone: '' });\r\n    }\r\n\r\n    if (this.projectionsConstraints.mtm) {\r\n      // all mtm zones\r\n      const minZone = this.projectionsConstraints.mtmZone.minZone;\r\n      const maxZone = this.projectionsConstraints.mtmZone.maxZone;\r\n\r\n      for (let mtmZone = minZone; mtmZone <= maxZone; mtmZone++) {\r\n        const code = mtmZone < 10 ? `EPSG:3218${mtmZone}` : `EPSG:321${80 + mtmZone}`;\r\n        projections.push({ translateKey: 'mtm', alias: `MTM ${mtmZone}`, code, zone: `${mtmZone}` });\r\n      }\r\n    }\r\n\r\n    if (this.projectionsConstraints.utm) {\r\n      // all utm zones\r\n      const minZone = this.projectionsConstraints.utmZone.minZone;\r\n      const maxZone = this.projectionsConstraints.utmZone.maxZone;\r\n\r\n      for (let utmZone = minZone; utmZone <= maxZone; utmZone++) {\r\n        const code = utmZone < 10 ? `EPSG:3260${utmZone}` : `EPSG:326${utmZone}`;\r\n        projections.push({ translateKey: 'utm', alias: `UTM ${utmZone}`, code, zone: `${utmZone}` });\r\n      }\r\n    }\r\n\r\n    let configProjection = [];\r\n    if (this.projectionsConstraints.projFromConfig) {\r\n      configProjection = this.config.getConfig('projections') || [];\r\n    }\r\n\r\n    this.projections$.next(configProjection.concat(projections));\r\n  }\r\n\r\n  private getWorkspaceByLayerId(id: string): Workspace {\r\n    const wksFromLayerId = this.store\r\n      .all()\r\n      .find(workspace => (workspace as WfsWorkspace | FeatureWorkspace | EditionWorkspace).layer.id === id);\r\n    if (wksFromLayerId) {\r\n      return wksFromLayerId;\r\n    }\r\n    return;\r\n  }\r\n\r\n  public getLayerTitleById(id): string {\r\n    return this.map.getLayerById(id)?.title;\r\n  }\r\n\r\n\r\n  layerHasSelectedFeatures(layer: Layer): boolean {\r\n    const wksFromLayer = this.getWorkspaceByLayerId(layer.id);\r\n    if (wksFromLayer) {\r\n      const recs = wksFromLayer.entityStore.stateView\r\n        .firstBy((record: EntityRecord<Feature>) => {\r\n          return record.state.selected === true;\r\n        });\r\n      return recs ? true : false;\r\n    }\r\n  }\r\n\r\n  public onlySelected(event: MatSlideToggleChange, id: string) {\r\n    let layersWithSelection = this.form.value.layersWithSelection;\r\n    if (event.checked) {\r\n      layersWithSelection.push(id);\r\n    } else {\r\n      layersWithSelection = layersWithSelection.filter(layerId => layerId !== id);\r\n    }\r\n    this.form.patchValue({ layersWithSelection });\r\n  }\r\n\r\n  public onlySelectedClick(event, id: string) {\r\n    if (this.form.value.layers.find(layerId => layerId === id)) {\r\n      event.stopPropagation();\r\n    }\r\n  }\r\n\r\n  public inLayersIdToExportSelectionOnly(layer: Layer): boolean {\r\n    return this.form.value.layersWithSelection.find(layerId => layerId === layer.id) ? true : false;\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.layers$$.unsubscribe();\r\n    this.exportableLayers$$.unsubscribe();\r\n    this.formats$$.unsubscribe();\r\n    this.encodings$$.unsubscribe();\r\n    this.formLayer$$.unsubscribe();\r\n    if (this.exportOptions$$) {\r\n      this.exportOptions$$.unsubscribe();\r\n    }\r\n    this.exportOptionsChange.emit(this.form.value);\r\n    this.handlePreviousLayerSpecs();\r\n  }\r\n\r\n  private handlePreviousLayerSpecs() {\r\n    const previousSpecs = this.previousLayerSpecs$.value;\r\n    if (previousSpecs && previousSpecs.length) {\r\n      previousSpecs.forEach((specs) => {\r\n        const previousLayer = this.map.getLayerById(specs.id);\r\n        previousLayer.visible = specs.visible;\r\n        previousLayer.opacity = specs.opacity;\r\n        (previousLayer as any).queryable = specs.queryable;\r\n      });\r\n    }\r\n    this.previousLayerSpecs$.next(undefined);\r\n  }\r\n\r\n  importFiles(files: File[]) {\r\n    let inputProj = this.inputProj.code;\r\n    if (this.espgCodeRegex.test(inputProj)) {\r\n      inputProj = `EPSG:${inputProj}`;\r\n    }\r\n\r\n    this.loading$.next(true);\r\n    for (const file of files) {\r\n      this.importService.import(file, inputProj).subscribe(\r\n        (features: Feature[]) => this.onFileImportSuccess(file, features),\r\n        (error: Error) => this.onFileImportError(file, error),\r\n        () => {\r\n          this.loading$.next(false);\r\n        }\r\n      );\r\n    }\r\n  }\r\n\r\n  handlePopup(preCheck: boolean = true): boolean {\r\n    const p1 = window.open('', 'popup', 'width=1, height=1');\r\n    p1.close();\r\n    const p2 = window.open('', 'popup', 'width=1, height=1');\r\n    if (!p2 || p2.closed || typeof p2.closed === 'undefined' || p2 === null) {\r\n      this.onPopupBlockedError(preCheck);\r\n      this.popupAllowed = false;\r\n    } else {\r\n      p2.close();\r\n      this.popupAllowed = true;\r\n      this.popupChecked = true;\r\n    }\r\n    return this.popupAllowed;\r\n  }\r\n\r\n  handleExportFormSubmit(data: ExportOptions) {\r\n    this.loading$.next(true);\r\n\r\n    const ogreFormats = Object.keys(ExportService.ogreFormats);\r\n    if (!this.popupChecked && data.layers.length > 1 &&\r\n      (ogreFormats.indexOf(data.format) >= 0 || data.format === ExportFormat.URL) && !this.popupAllowed) {\r\n      this.handlePopup();\r\n    }\r\n\r\n    let geomTypesCSV: { geometryType: string, features: any[] }[] = [];\r\n    let featuresCSV: any[] = [];\r\n    let filename: string = \"\";\r\n\r\n    for (const [layerIndex, layer] of data.layers.entries()) {\r\n      const lay = this.map.getLayerById(layer);\r\n      if (!(data.format === ExportFormat.CSVsemicolon || data.format === ExportFormat.CSVcomma)\r\n      || !data.combineLayers || data.layers.length === 1) {\r\n        filename = lay.title;\r\n        if (data.name) {\r\n          filename = data.name;\r\n        }\r\n      } else {\r\n        filename = this.languageService.translate.instant('igo.geo.export.combinedLayers');\r\n      }\r\n      const dSOptions: DataSourceOptions = lay.dataSource.options;\r\n      if (data.format === ExportFormat.URL && dSOptions.download && (dSOptions.download.url || dSOptions.download.dynamicUrl)) {\r\n        setTimeout(() => {\r\n          // better look an feel\r\n          const url = dSOptions.download.url || dSOptions.download.dynamicUrl;\r\n          url.match(/service=wfs/gi) ? this.downloadService.open(lay) : window.open(url , '_blank');\r\n          this.loading$.next(false);\r\n        }, 500);\r\n        return;\r\n      }\r\n      const wks = this.getWorkspaceByLayerId(layer);\r\n      let olFeatures;\r\n      if (wks && wks.entityStore && wks.entityStore.stateView.all().length) {\r\n\r\n        if (data.layersWithSelection.indexOf(layer) !== -1 && data.featureInMapExtent) {\r\n          // Only export selected feature && into map extent\r\n          olFeatures = wks.entityStore.stateView.all()\r\n            .filter((e: EntityRecord<object>) => e.state.inMapExtent && e.state.selected).map(e => (e.entity as Feature).ol);\r\n        } else if (data.layersWithSelection.indexOf(layer) !== -1 && !data.featureInMapExtent) {\r\n          // Only export selected feature &&  (into map extent OR not)\r\n          olFeatures = wks.entityStore.stateView.all()\r\n            .filter((e: EntityRecord<object>) => e.state.selected).map(e => (e.entity as Feature).ol);\r\n        } else if (data.featureInMapExtent) {\r\n          // Only into map extent\r\n          olFeatures = wks.entityStore.stateView.all()\r\n            .filter((e: EntityRecord<object>) => e.state.inMapExtent).map(e => (e.entity as Feature).ol);\r\n        } else {\r\n          // All features\r\n          olFeatures = wks.entityStore.stateView.all().map(e => (e.entity as Feature).ol);\r\n        }\r\n      }\r\n      else {\r\n        const ol = lay.dataSource.ol as olVectorSource<OlGeometry> | olClusterSource ;\r\n        if (data.featureInMapExtent) {\r\n          olFeatures = ol.getFeaturesInExtent(\r\n            lay.map.viewController.getExtent()\r\n          );\r\n        } else {\r\n          olFeatures = ol.getFeatures();\r\n        }\r\n        if (lay.dataSource instanceof ClusterDataSource) {\r\n          olFeatures = olFeatures.flatMap((cluster: any) =>\r\n            cluster.get('features')\r\n          );\r\n        }\r\n      }\r\n\r\n      const translate = this.languageService.translate;\r\n      let geomTypes: { geometryType: string, features: any[] }[] = [];\r\n      if (data.format === ExportFormat.Shapefile || data.format === ExportFormat.GPX) {\r\n        olFeatures.forEach((olFeature) => {\r\n          const featureGeomType = olFeature.getGeometry().getType();\r\n          const currentGeomType = geomTypes.find(geomType => geomType.geometryType === featureGeomType);\r\n          if (currentGeomType) {\r\n            currentGeomType.features.push(olFeature);\r\n          } else {\r\n            geomTypes.push({ geometryType: featureGeomType, features: [olFeature] });\r\n          }\r\n        });\r\n      } else {\r\n        geomTypes = [{ geometryType: '', features: olFeatures }];\r\n      }\r\n\r\n      geomTypes.forEach(geomType => {\r\n        geomType.features.forEach(feature => {\r\n          const radius: number = feature.get('rad');\r\n          if (radius) {\r\n            const center4326: Array<number> = [feature.get('longitude'), feature.get('latitude')];\r\n            const circle = circular(center4326, radius, 500);\r\n            circle.transform('EPSG:4326', feature.get('_projection'));\r\n            feature.setGeometry(circle);\r\n          }\r\n        });\r\n      });\r\n\r\n      if (data.format === ExportFormat.GPX) {\r\n        const gpxFeatureCnt = geomTypes.length;\r\n        geomTypes = geomTypes.filter(geomType => ['LineString', 'Point'].includes(geomType.geometryType));\r\n        const gpxFeatureCntPointOrPoly = geomTypes.length;\r\n        if (gpxFeatureCnt > gpxFeatureCntPointOrPoly) {\r\n          const title = translate.instant('igo.geo.export.gpx.error.poly.title');\r\n          const message = translate.instant('igo.geo.export.gpx.error.poly.text');\r\n          this.messageService.error(message, title, { timeOut: 20000 });\r\n        }\r\n      } else if ((data.format === ExportFormat.CSVsemicolon || data.format === ExportFormat.CSVcomma) && data.combineLayers) {\r\n        geomTypes.forEach(geomType => geomTypesCSV.push(geomType));\r\n\r\n        if (layerIndex !== data.layers.length - 1) {\r\n          continue;\r\n        } else {\r\n          let previousFeature = undefined;\r\n          geomTypesCSV.forEach(geomType => {\r\n            geomType.features.forEach(currentFeature => {\r\n              if (data.separator) {\r\n                if (previousFeature) {\r\n                  if (currentFeature.get('_featureStore').layer.options.title !==\r\n                  previousFeature.get('_featureStore').layer.options.title) {\r\n                    const titleEmptyRows = this.createTitleEmptyRows(previousFeature, currentFeature);\r\n                    featuresCSV.push(titleEmptyRows[2]);\r\n                    featuresCSV.push(titleEmptyRows[0]);\r\n                    featuresCSV.push(titleEmptyRows[1]);\r\n                  }\r\n                } else {\r\n                  const titleEmptyRows = this.createTitleEmptyRows(currentFeature, currentFeature);\r\n                  featuresCSV.push(titleEmptyRows[0]);\r\n                }\r\n              }\r\n              featuresCSV.push(currentFeature);\r\n              previousFeature = currentFeature;\r\n            });\r\n          });\r\n        }\r\n      }\r\n\r\n      if (geomTypes.length === 0) {\r\n        this.loading$.next(false);\r\n        const title = translate.instant('igo.geo.export.nothing.title');\r\n        const message = translate.instant('igo.geo.export.nothing.text');\r\n        this.messageService.error(message, title, { timeOut: 20000 });\r\n\r\n      } else {\r\n        if (!(data.format === ExportFormat.CSVsemicolon || data.format === ExportFormat.CSVcomma) || !data.combineLayers) {\r\n          geomTypes.map(geomType =>\r\n            this.exportService.export(geomType.features, data.format, filename + geomType.geometryType, data.encoding, this.map.projection)\r\n            .subscribe(\r\n              () => {},\r\n              (error: Error) => this.onFileExportError(error),\r\n              () => {\r\n                this.onFileExportSuccess();\r\n\r\n                geomType.features.forEach(feature => {\r\n                  this.circleToPoint(feature);\r\n                });\r\n\r\n                this.loading$.next(false);\r\n            }\r\n          ));\r\n        }\r\n      }\r\n    };\r\n    if ((data.format === ExportFormat.CSVsemicolon || data.format === ExportFormat.CSVcomma) && data.combineLayers) {\r\n      this.exportService.export(featuresCSV, data.format, filename, data.encoding, this.map.projection)\r\n      .subscribe(\r\n        () => {},\r\n        (error: Error) => this.onFileExportError(error),\r\n        () => {\r\n          this.onFileExportSuccess();\r\n\r\n          featuresCSV.forEach(feature => {\r\n            this.circleToPoint(feature);\r\n          });\r\n\r\n          this.loading$.next(false);\r\n        }\r\n      );\r\n    }\r\n  }\r\n\r\n  private createTitleEmptyRows(previousFeature, currentFeature) {\r\n    const titleRow = currentFeature.clone();\r\n    const headerRow = currentFeature.clone();\r\n    const emptyRow = currentFeature.clone();\r\n    const previousFeatureKeys: Array<string> = previousFeature.getKeys();\r\n    let firstKeyPrevious: string = '';\r\n    for (const key in previousFeatureKeys) {\r\n      if (previousFeatureKeys[key] !== 'geometry') {\r\n        firstKeyPrevious = previousFeatureKeys[key];\r\n        break;\r\n      }\r\n    }\r\n\r\n    const currentFeatureKeys: Array<string> = currentFeature.getKeys();\r\n    let firstKeyCurrent: string = '';\r\n    for (const key in currentFeatureKeys) {\r\n      if (currentFeatureKeys[key] !== 'geometry') {\r\n        firstKeyCurrent = currentFeatureKeys[key];\r\n        break;\r\n      }\r\n    }\r\n    const allKeys: Array<string> = currentFeature.getKeys();\r\n    previousFeatureKeys.forEach(previousKey => {\r\n      if (allKeys.includes(previousKey) && previousKey !== firstKeyPrevious) {\r\n        allKeys.push(previousKey);\r\n      }\r\n    });\r\n    allKeys.unshift(firstKeyPrevious);\r\n\r\n    let firstKeyAll: string = '';\r\n    for (const key in allKeys) {\r\n      if (allKeys[key] !== 'geometry') {\r\n        firstKeyAll = allKeys[key];\r\n        break;\r\n      }\r\n    }\r\n    allKeys.forEach(key => {\r\n      const sameKeys: boolean = previousFeatureKeys.length === currentFeatureKeys.length &&\r\n      previousFeatureKeys.every((value, index) => value === currentFeatureKeys[index]);\r\n      if (key === firstKeyAll && !sameKeys) {\r\n        titleRow.set(key, currentFeature.get('_featureStore').layer.options.title + \" ===============>\", true);\r\n        headerRow.set(key, key, true);\r\n        emptyRow.unset(key, true);\r\n      } else if (key === firstKeyAll && sameKeys) {\r\n        titleRow.set(key, currentFeature.get('_featureStore').layer.options.title, true);\r\n        headerRow.set(key, key, true);\r\n        emptyRow.unset(key, true);\r\n      } else if (key === firstKeyCurrent) {\r\n        titleRow.set(key, currentFeature.get('_featureStore').layer.options.title, true);\r\n        headerRow.set(key, key, true);\r\n        emptyRow.unset(key, true);\r\n      } else if (key !== 'geometry') {\r\n        titleRow.unset(key, true);\r\n        headerRow.set(key, key, true);\r\n        emptyRow.unset(key, true);\r\n      } else {\r\n        titleRow.unset(key, true);\r\n        emptyRow.unset(key, true);\r\n      }\r\n\r\n      if (!(currentFeatureKeys.includes(key))) {\r\n        headerRow.unset(key, true);\r\n      }\r\n    });\r\n    const titleEmptyRows = [titleRow, headerRow, emptyRow];\r\n    return titleEmptyRows;\r\n  }\r\n\r\n  private circleToPoint(feature) {\r\n    const radius: number = feature.get('rad');\r\n\r\n    if (radius) {\r\n      const point = new olPoint([feature.get('longitude'), feature.get('latitude')]);\r\n      point.transform('EPSG:4326', feature.get('_projection'));\r\n      feature.setGeometry(point);\r\n    }\r\n  }\r\n\r\n  private buildForm() {\r\n    this.importForm = this.formBuilder.group({\r\n      inputProj: ['', [Validators.required]]\r\n    });\r\n\r\n    if (this.forceNaming) {\r\n      this.form = this.formBuilder.group({\r\n        format: ['', [Validators.required]],\r\n        layers: [[], [Validators.required]],\r\n        layersWithSelection: [[]],\r\n        encoding: [EncodingFormat.UTF8, [Validators.required]],\r\n        combineLayers: [true, [Validators.required]],\r\n        separator: [false, [Validators.required]],\r\n        featureInMapExtent: [false, [Validators.required]],\r\n        name: ['', [Validators.required]]\r\n      });\r\n    } else {\r\n      this.form = this.formBuilder.group({\r\n        format: ['', [Validators.required]],\r\n        layers: [[], [Validators.required]],\r\n        layersWithSelection: [[]],\r\n        encoding: [EncodingFormat.UTF8, [Validators.required]],\r\n        combineLayers: [true, [Validators.required]],\r\n        separator: [false, [Validators.required]],\r\n        featureInMapExtent: [false, [Validators.required]],\r\n      });\r\n    }\r\n  }\r\n\r\n  private onFileImportSuccess(file: File, features: Feature[]) {\r\n    if (!this.config.getConfig('importWithStyle')) {\r\n      handleFileImportSuccess(\r\n        file,\r\n        features,\r\n        this.map,\r\n        this.messageService,\r\n        this.languageService\r\n      );\r\n    } else {\r\n      handleFileImportSuccess(\r\n        file,\r\n        features,\r\n        this.map,\r\n        this.messageService,\r\n        this.languageService,\r\n        this.styleListService,\r\n        this.styleService\r\n      );\r\n    }\r\n  }\r\n\r\n  private onFileImportError(file: File, error: Error) {\r\n    this.loading$.next(false);\r\n    handleFileImportError(\r\n      file,\r\n      error,\r\n      this.messageService,\r\n      this.languageService,\r\n      this.fileSizeMb\r\n    );\r\n  }\r\n\r\n  private onPopupBlockedError(preCheck: boolean = true) {\r\n    this.loading$.next(false);\r\n    const translate = this.languageService.translate;\r\n    const title = translate.instant('igo.geo.export.popupBlocked.title');\r\n    const extraMessage = preCheck ?\r\n      translate.instant('igo.geo.export.popupBlocked.selectAgain') :\r\n      translate.instant('igo.geo.export.popupBlocked.retry');\r\n    const message = translate.instant('igo.geo.export.popupBlocked.text', { extraMessage });\r\n    this.messageService.error(message, title, { timeOut: 20000 });\r\n  }\r\n\r\n  private onFileExportError(error: Error) {\r\n    this.loading$.next(false);\r\n    handleFileExportError(error, this.messageService, this.languageService);\r\n  }\r\n\r\n  private loadConfig() {\r\n    if (this.config.getConfig('importExport.forceNaming') !== undefined) {\r\n      this.forceNaming = this.config.getConfig('importExport.forceNaming');\r\n    }\r\n    this.computeFormats();\r\n    this.loadEncodings();\r\n  }\r\n\r\n  public encodingDefaultValue(format: ExportFormat) {\r\n    if (format === ExportFormat.CSVcomma || format === ExportFormat.CSVsemicolon) {\r\n      this.form.patchValue({ encoding: EncodingFormat.LATIN1 });\r\n      return EncodingFormat.LATIN1;\r\n    } else {\r\n      this.form.patchValue({ encoding: EncodingFormat.UTF8 });\r\n      return EncodingFormat.UTF8;\r\n    }\r\n  }\r\n\r\n  private loadEncodings() {\r\n    this.encodings$.next(EncodingFormat);\r\n  }\r\n\r\n  private computeFormats(layers?: AnyLayer[]) {\r\n    let appliedformats: string[] = Object.keys(ExportFormat);\r\n    const formatsType = {\r\n      onlyUrl: false,\r\n      onlyVector: false,\r\n      vectorAndUrl: false,\r\n      customList: false\r\n    };\r\n    const customList = [];\r\n    if (layers && layers.length) {\r\n      layers.forEach((layer) => {\r\n        if (!layer) {\r\n          return;\r\n        }\r\n        if (layer.dataSource.options.download?.allowedFormats) {\r\n          formatsType.customList = true;\r\n          customList.push({layer: layer.title, formats: this.validateListFormat(layer.dataSource.options.download.allowedFormats)});\r\n        } else if (\r\n          !(layer instanceof VectorLayer) &&\r\n          layer.dataSource.options.download &&\r\n          layer.dataSource.options.download.url\r\n        ) {\r\n          formatsType.onlyUrl = true;\r\n        } else if (\r\n          layer.dataSource.options.download &&\r\n          (layer.dataSource.options.download.url || layer.dataSource.options.download.dynamicUrl)\r\n        ) {\r\n          formatsType.vectorAndUrl = true;\r\n        } else if (layer instanceof VectorLayer) {\r\n          formatsType.onlyVector = true;\r\n        }\r\n      });\r\n\r\n      if (formatsType.onlyUrl === true && formatsType.onlyVector === false) {\r\n        appliedformats = ['URL'];\r\n      } else if (\r\n        formatsType.onlyVector === true &&\r\n        formatsType.onlyUrl === false\r\n      ) {\r\n        this.computeFormats(); // reset\r\n        if (ExportFormat.URL in this.formats$.value) {\r\n          const keys = Object.keys(this.formats$.value).filter(\r\n            (key) => key !== 'URL'\r\n          );\r\n          appliedformats = keys;\r\n        }\r\n      } else if (\r\n        formatsType.vectorAndUrl === true &&\r\n        formatsType.onlyUrl === false &&\r\n        formatsType.onlyVector === false\r\n      ) {\r\n        this.computeFormats(); // reset\r\n        if (!(ExportFormat.URL in this.formats$.value)) {\r\n          const keys = Object.keys(this.formats$.value);\r\n          keys.push('URL');\r\n          appliedformats = keys;\r\n        }\r\n      }\r\n    }\r\n    if (this.config.getConfig('importExport.formats') !== undefined) {\r\n      const validatedListFormat = this.validateListFormat(\r\n        this.config.getConfig('importExport.formats')\r\n      );\r\n      appliedformats = validatedListFormat;\r\n    }\r\n    if (formatsType.customList) {\r\n      let commonFormats;\r\n      const layersWithCustomFormats = [];\r\n      let previousCustomListFormats = customList[0].formats;\r\n      customList.map(list => {\r\n        layersWithCustomFormats.push(list.layer);\r\n        commonFormats = list.formats.filter(value => previousCustomListFormats.includes(value));\r\n        previousCustomListFormats = list.formats;\r\n      });\r\n      const finalFormats = commonFormats.filter(value => appliedformats.includes(value));\r\n      if (finalFormats.length > 0) {\r\n        this.formats$.next(strEnum(finalFormats));\r\n\r\n        if (layers && layers.length) {\r\n          if (layers.length > 1) {\r\n            this.messageService.alert(\r\n              this.languageService.translate.instant('igo.geo.export.customList.text', { value: layersWithCustomFormats.join() }),\r\n              this.languageService.translate.instant('igo.geo.export.customList.title')\r\n            );\r\n          }\r\n        }\r\n      } else {\r\n        this.formats$.next([]);\r\n        this.messageService.alert(\r\n          this.languageService.translate.instant('igo.geo.export.noFormat.text'),\r\n          this.languageService.translate.instant('igo.geo.export.noFormat.title')\r\n        );\r\n      }\r\n      return;\r\n    } else {\r\n      this.formats$.next(strEnum(appliedformats));\r\n    }\r\n  }\r\n\r\n  private validateListFormat(formats: string[]): string[] {\r\n    return formats\r\n      .filter((format) => {\r\n        if (\r\n          format.toUpperCase() === ExportFormat.CSVcomma.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.CSVsemicolon.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.GML.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.GPX.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.GeoJSON.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.KML.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.Shapefile.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.URL.toUpperCase()\r\n        ) {\r\n          return format;\r\n        }\r\n      })\r\n      .map((format) => {\r\n        if (format.toUpperCase() === ExportFormat.CSVcomma.toUpperCase()) {\r\n          format = ExportFormat.CSVcomma;\r\n          return format;\r\n        }\r\n        if (format.toUpperCase() === ExportFormat.CSVsemicolon.toUpperCase()) {\r\n          format = ExportFormat.CSVsemicolon;\r\n          return format;\r\n        }\r\n        if (format.toUpperCase() === ExportFormat.GML.toUpperCase()) {\r\n          format = ExportFormat.GML;\r\n          return format;\r\n        }\r\n        if (format.toUpperCase() === ExportFormat.GPX.toUpperCase()) {\r\n          format = ExportFormat.GPX;\r\n          return format;\r\n        }\r\n        if (format.toUpperCase() === ExportFormat.GeoJSON.toUpperCase()) {\r\n          format = ExportFormat.GeoJSON;\r\n          return format;\r\n        }\r\n        if (format.toUpperCase() === ExportFormat.KML.toUpperCase()) {\r\n          format = ExportFormat.KML;\r\n          return format;\r\n        }\r\n        if (format.toUpperCase() === ExportFormat.Shapefile.toUpperCase()) {\r\n          format = ExportFormat.Shapefile;\r\n          return format;\r\n        }\r\n\r\n        if (format.toUpperCase() === ExportFormat.URL.toUpperCase()) {\r\n          format = ExportFormat.URL;\r\n          return format;\r\n        }\r\n      });\r\n  }\r\n\r\n  public modeChanged(mode) {\r\n    this.selectMode.emit(mode);\r\n  }\r\n\r\n  private onFileExportSuccess() {\r\n    handleFileExportSuccess(this.messageService, this.languageService);\r\n  }\r\n\r\n  onImportExportChange(event) {\r\n    this.selectedMode = event.value;\r\n  }\r\n}\r\n","import { ProjectionsLimitationsOptions } from './projection.interfaces';\r\n\r\n/**\r\n * Return a number of zone MTM for a longitude for province of Quebec only\r\n * @param lon number\r\n * @returns zone\r\n */\r\nexport function zoneMtm(lon: number): number {\r\n    let lonMin = -54;\r\n    const lonMax = -81;\r\n    if (lon < lonMax || lon > lonMin) {\r\n      return 0;\r\n    }\r\n    else {\r\n      const deltaLon = 3;\r\n      let zone = 2;\r\n      while (Math.abs(lon - lonMin) > deltaLon) {\r\n        lonMin = lonMin - deltaLon;\r\n        zone++;\r\n      }\r\n      return zone;\r\n    }\r\n  }\r\n/**\r\n * Return a number of zone UTM for a longitude\r\n * @param lon number\r\n * @returns zone\r\n */\r\nexport function zoneUtm(lon: number): number {\r\n  let lonMin = -180;\r\n  const lonMax = 180;\r\n  const deltaLon = 6;\r\n  let zone = 1;\r\n  while (Math.abs(lon - lonMin) > deltaLon) {\r\n    lonMin = lonMin + deltaLon;\r\n    zone++;\r\n  }\r\n  return zone;\r\n}\r\n\r\n/**\r\n * Compute the contraints of projections\r\n * @param projectionsLimitations: ProjectionsLimitationsOptions\r\n * @returns projectionsContraints: ProjectionsLimitationsOptions\r\n */\r\nexport function computeProjectionsConstraints(\r\n    projectionsLimitations: ProjectionsLimitationsOptions):\r\n    ProjectionsLimitationsOptions {\r\n    const mtmZone = projectionsLimitations.mtmZone;\r\n    const utmZone = projectionsLimitations.utmZone;\r\n    const projectionsConstraints = {\r\n        projFromConfig: projectionsLimitations.projFromConfig === false ? false : true,\r\n        nad83: projectionsLimitations.nad83 === false ? false : true,\r\n        wgs84: projectionsLimitations.wgs84 === false ? false : true,\r\n        webMercator: projectionsLimitations.webMercator === false ? false : true,\r\n        utm: projectionsLimitations.utm === false ? false : true,\r\n        mtm: projectionsLimitations.mtm === false ? false : true,\r\n        utmZone: {\r\n        minZone: utmZone && utmZone.minZone ? utmZone.minZone : 17,\r\n        maxZone: utmZone && utmZone.maxZone ? utmZone.maxZone : 21,\r\n        },\r\n        mtmZone: {\r\n        minZone: mtmZone && mtmZone.minZone ? mtmZone.minZone : 2,\r\n        maxZone: mtmZone && mtmZone.maxZone ? mtmZone.maxZone : 10,\r\n        }\r\n    };\r\n    return projectionsConstraints;\r\n  }\r\n","import {\r\n  getEntityProperty,\r\n  EntityTableColumn,\r\n  EntityTableColumnRenderer\r\n} from '@igo2/common';\r\nimport { MessageService, LanguageService } from '@igo2/core';\r\nimport { downloadContent } from '@igo2/utils';\r\n\r\nimport { ExportNothingToExportError } from './export.errors';\r\n\r\nexport function handleFileExportError(\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  if (error instanceof ExportNothingToExportError) {\r\n    handleNothingToExportError(messageService, languageService);\r\n    return;\r\n  }\r\n  const translate = languageService.translate;\r\n  const title = translate.instant('igo.geo.export.failed.title');\r\n  const message = translate.instant('igo.geo.export.failed.text');\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function handleFileExportSuccess(\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant('igo.geo.export.success.title');\r\n  const message = translate.instant('igo.geo.export.success.text');\r\n  messageService.success(message, title);\r\n}\r\n\r\nexport function handleNothingToExportError(\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant('igo.geo.export.nothing.title');\r\n  const message = translate.instant('igo.geo.export.nothing.text');\r\n  messageService.error(message, title);\r\n}\r\n\r\n/**\r\n * Export array to CSV\r\n *\r\n * @param rows Array of arrays to export as CSV\r\n * @param separator Cell separator\r\n */\r\nexport function exportToCSV(rows: any[][], fileName: string, separator: string = ';') {\r\n  const lines = rows.map((row: any[][], index: number) => row.join(separator));\r\n  const csvContent = lines.join('\\n');\r\n  downloadContent(csvContent, 'text/csv;charset=utf-8', fileName);\r\n}\r\n\r\n/**\r\n * Return an array of values from an array of entities.\r\n *\r\n * @param entities Array of entities\r\n * @param scolumns Columns definition of the output data\r\n */\r\nexport function entitiesToRowData(entities: object[], columns: EntityTableColumn[]) {\r\n  return entities.map((entity: object) => {\r\n    return columns.map((column: EntityTableColumn) => {\r\n      let valueAccessor;\r\n      if (column.renderer === undefined || column.renderer === EntityTableColumnRenderer.Default) {\r\n        valueAccessor = column.valueAccessor;\r\n      }\r\n      valueAccessor = valueAccessor ? valueAccessor : getEntityProperty;\r\n      return valueAccessor(entity, column.name);\r\n    });\r\n  });\r\n}\r\n","import { APP_INITIALIZER, InjectionToken } from '@angular/core';\r\n\r\nimport { StyleListService } from './style-list.service';\r\nimport { StyleListOptions } from './style-list.interface';\r\n\r\nexport let STYLELIST_OPTIONS = new InjectionToken<StyleListOptions>('styleListOptions');\r\n\r\nexport function provideStyleListOptions(options: StyleListOptions) {\r\n  return {\r\n    provide: STYLELIST_OPTIONS,\r\n    useValue: options\r\n  };\r\n}\r\n\r\nexport function styleListFactory(\r\n  styleListService: StyleListService,\r\n  options: StyleListOptions\r\n) {\r\n  return () => styleListService.load(options);\r\n}\r\n\r\nexport function provideStyleListLoader() {\r\n  return {\r\n    provide: APP_INITIALIZER,\r\n    useFactory: styleListFactory,\r\n    multi: true,\r\n    deps: [StyleListService, STYLELIST_OPTIONS]\r\n  };\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { provideStyleListOptions, provideStyleListLoader } from './style-list.provider';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [],\r\n  exports: []\r\n})\r\nexport class IgoStyleListModule {\r\n  static forRoot(): ModuleWithProviders<IgoStyleListModule> {\r\n    return {\r\n      ngModule: IgoStyleListModule,\r\n      providers: [provideStyleListOptions({}), provideStyleListLoader()]\r\n    };\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatButtonToggleModule } from '@angular/material/button-toggle';\r\nimport { MatOptionModule } from '@angular/material/core';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatSlideToggleModule } from '@angular/material/slide-toggle';\r\nimport { MatTabsModule } from '@angular/material/tabs';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoKeyValueModule, IgoDrapDropModule, IgoSpinnerModule, IgoCustomHtmlModule } from '@igo2/common';\r\n\r\nimport { ExportButtonComponent } from './export-button/export-button.component';\r\nimport { ImportExportComponent } from './import-export/import-export.component';\r\nimport { DropGeoFileDirective } from './shared/drop-geo-file.directive';\r\nimport { IgoStyleListModule } from './style-list/style-list.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    MatIconModule,\r\n    MatTooltipModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    CommonModule,\r\n    MatButtonModule,\r\n    MatButtonToggleModule,\r\n    MatTabsModule,\r\n    MatSelectModule,\r\n    MatOptionModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatSlideToggleModule,\r\n    IgoLanguageModule,\r\n    IgoSpinnerModule,\r\n    IgoKeyValueModule,\r\n    IgoDrapDropModule,\r\n    IgoCustomHtmlModule,\r\n    IgoStyleListModule.forRoot()\r\n  ],\r\n  exports: [ImportExportComponent, DropGeoFileDirective, IgoStyleListModule, ExportButtonComponent],\r\n  declarations: [ImportExportComponent, DropGeoFileDirective, ExportButtonComponent]\r\n})\r\nexport class IgoImportExportModule {\r\n  static forRoot(): ModuleWithProviders<IgoImportExportModule> {\r\n    return {\r\n      ngModule: IgoImportExportModule\r\n    };\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoConfirmDialogModule } from '@igo2/common';\r\nimport { MapBrowserComponent } from './map-browser/map-browser.component';\r\nimport { ZoomButtonComponent } from './zoom-button/zoom-button.component';\r\nimport { GeolocateButtonComponent } from './geolocate-button/geolocate-button.component';\r\nimport { HomeExtentButtonComponent } from './home-extent-button/home-extent-button.component';\r\nimport { RotationButtonComponent } from './rotation-button/rotation-button.component';\r\nimport { BaseLayersSwitcherComponent } from './baselayers-switcher/baselayers-switcher.component';\r\nimport { MiniBaseMapComponent } from './baselayers-switcher/mini-basemap.component';\r\nimport { MapOfflineDirective } from './shared/mapOffline.directive';\r\nimport { OfflineButtonComponent } from './offline-button/offline-button.component';\r\nimport { WakeLockButtonComponent } from './wake-lock-button/wake-lock-button.component';\r\nimport { PointerPositionDirective } from './shared/map-pointer-position.directive';\r\nimport { HoverFeatureDirective } from './shared/hover-feature.directive';\r\nimport { SwipeControlComponent } from './swipe-control/swipe-control.component';\r\nimport { MapCenterComponent } from './map-center/map-center.component';\r\nimport { MenuButtonComponent } from './menu-button/menu-button.component';\r\nimport { InfoSectionComponent } from './info-section/info-section.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoLanguageModule,\r\n    IgoConfirmDialogModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatTooltipModule\r\n  ],\r\n  exports: [\r\n    MapBrowserComponent,\r\n    ZoomButtonComponent,\r\n    GeolocateButtonComponent,\r\n    HomeExtentButtonComponent,\r\n    RotationButtonComponent,\r\n    InfoSectionComponent,\r\n    BaseLayersSwitcherComponent,\r\n    MiniBaseMapComponent,\r\n    MapOfflineDirective,\r\n    OfflineButtonComponent,\r\n    WakeLockButtonComponent,\r\n    PointerPositionDirective,\r\n    HoverFeatureDirective,\r\n    SwipeControlComponent,\r\n    MapCenterComponent,\r\n    MenuButtonComponent\r\n  ],\r\n  declarations: [\r\n    MapBrowserComponent,\r\n    ZoomButtonComponent,\r\n    GeolocateButtonComponent,\r\n    HomeExtentButtonComponent,\r\n    RotationButtonComponent,\r\n    InfoSectionComponent,\r\n    BaseLayersSwitcherComponent,\r\n    MiniBaseMapComponent,\r\n    MapOfflineDirective,\r\n    OfflineButtonComponent,\r\n    WakeLockButtonComponent,\r\n    PointerPositionDirective,\r\n    HoverFeatureDirective,\r\n    SwipeControlComponent,\r\n    MapCenterComponent,\r\n    MenuButtonComponent\r\n  ]\r\n})\r\nexport class IgoMapModule {}\r\n","<mat-form-field\r\n  class=\"measure-field\"\r\n  appearance=\"outline\"\r\n  floatLabel=\"always\">\r\n  <mat-label>{{placeholder}}</mat-label>\r\n  <input\r\n    matInput\r\n    [readonly]=\"true\"\r\n    [value]=\"((measure$ | async) || 0) | measureFormat: measureUnit\">\r\n</mat-form-field>\r\n<mat-form-field class=\"unit-field\">\r\n  <mat-select\r\n    [value]=\"measureUnit\"\r\n    [disabled]=\"auto\"\r\n    (selectionChange)=\"onMeasureUnitChange($event.value)\">\r\n    <mat-option *ngFor=\"let measureUnit of measureUnits\" [value]=\"measureUnit\">\r\n      {{('igo.geo.measure.' + measureUnit) | translate}}\r\n    </mat-option>\r\n  </mat-select>\r\n</mat-form-field>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\nimport {\r\n  MeasureType,\r\n  MeasureAreaUnit,\r\n  MeasureLengthUnit\r\n} from '../shared/measure.enum';\r\nimport { computeBestAreaUnit, computeBestLengthUnit } from '../shared/measure.utils';\r\n\r\n/**\r\n * Measurer item\r\n */\r\n@Component({\r\n  selector: 'igo-measurer-item',\r\n  templateUrl: './measurer-item.component.html',\r\n  styleUrls: ['./measurer-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class MeasurerItemComponent implements OnDestroy {\r\n\r\n  /**\r\n   * Measure observable\r\n   * @internal\r\n   */\r\n  public measure$: BehaviorSubject<number> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Subscription to the measure observable when the auto mode is on\r\n   * @internal\r\n   */\r\n  public measure$$: Subscription;\r\n\r\n  /**\r\n   * Measure type\r\n   */\r\n  @Input() measureType: MeasureType;\r\n\r\n  /**\r\n   * Measure unit\r\n   */\r\n  @Input() measureUnit: MeasureAreaUnit | MeasureLengthUnit;\r\n\r\n  /**\r\n   * Measure\r\n   */\r\n  @Input()\r\n  set measure(value: number) {\r\n    this.measure$.next(value);\r\n  }\r\n  get measure(): number { return this.measure$.value; }\r\n\r\n  /**\r\n   * Whther measure units should be automatically determined\r\n   */\r\n  @Input()\r\n  set auto(value: boolean) { this.toggleAutoUnit(value); }\r\n  get auto(): boolean { return this._auto; }\r\n  private _auto: boolean = false;\r\n\r\n  /**\r\n   * Placeholder\r\n   */\r\n  @Input() placeholder: string;\r\n\r\n  /**\r\n   * Event emitted when the measure unit changes\r\n   */\r\n  @Output() measureUnitChange = new EventEmitter<MeasureAreaUnit | MeasureLengthUnit>();\r\n\r\n  /**\r\n   * Available measure units for the measure type given\r\n   * @internal\r\n   */\r\n  get measureUnits(): string[] {\r\n    if (this.measureType === MeasureType.Area) {\r\n      return Object.values(MeasureAreaUnit);\r\n    }\r\n    return Object.values(MeasureLengthUnit);\r\n  }\r\n\r\n  constructor() {}\r\n\r\n  /**\r\n   * Toggle the auto unit off\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.toggleAutoUnit(false);\r\n  }\r\n\r\n  /**\r\n   * Set the measure unit\r\n   * @internal\r\n   */\r\n  onMeasureUnitChange(unit: MeasureAreaUnit | MeasureLengthUnit) {\r\n    this.measureUnit = unit;\r\n    this.measureUnitChange.emit(unit);\r\n  }\r\n\r\n  private toggleAutoUnit(toggle: boolean) {\r\n    if (this.measure$$ !== undefined) {\r\n      this.measure$$.unsubscribe();\r\n    }\r\n    if (toggle === true) {\r\n      this.measure$$ = this.measure$.subscribe((measure: number) => {\r\n        this.computeBestMeasureUnit(measure);\r\n      });\r\n    }\r\n    this._auto = toggle;\r\n  }\r\n\r\n  private computeBestMeasureUnit(measure: number) {\r\n    let measureUnit = this.measureUnit;\r\n    if (this.measureType === MeasureType.Area) {\r\n      measureUnit = computeBestAreaUnit(measure);\r\n    } else if (this.measureType === MeasureType.Length) {\r\n      measureUnit = computeBestLengthUnit(measure);\r\n    }\r\n    if (measureUnit !== this.measureUnit) {\r\n      this.onMeasureUnitChange(measureUnit);\r\n    }\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatButtonToggleModule } from '@angular/material/button-toggle';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatSlideToggleModule } from '@angular/material/slide-toggle';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\nimport { MatDividerModule } from '@angular/material/divider';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoEntityTableModule } from '@igo2/common';\r\n\r\nimport { MeasureFormatPipe } from './measure-format.pipe';\r\nimport { MeasurerItemComponent } from './measurer-item.component';\r\nimport { MeasurerComponent } from './measurer.component';\r\nimport { MeasurerDialogComponent } from './measurer-dialog.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatButtonModule,\r\n    MatButtonToggleModule,\r\n    MatIconModule,\r\n    MatTooltipModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatSelectModule,\r\n    MatSlideToggleModule,\r\n    MatDividerModule,\r\n    IgoLanguageModule,\r\n    IgoEntityTableModule\r\n  ],\r\n  declarations: [\r\n    MeasureFormatPipe,\r\n    MeasurerItemComponent,\r\n    MeasurerComponent,\r\n    MeasurerDialogComponent\r\n  ],\r\n  exports: [\r\n    MeasureFormatPipe,\r\n    MeasurerComponent\r\n  ]\r\n})\r\nexport class IgoMeasurerModule {}\r\n","import { NgModule } from '@angular/core';\r\n\r\nimport { IgoMeasurerModule } from './measurer/measurer.module';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [],\r\n  exports: [\r\n    IgoMeasurerModule\r\n  ]\r\n})\r\nexport class IgoMeasureModule {}\r\n","export enum OverlayAction {\r\n    None,\r\n    Move,\r\n    Zoom,\r\n    ZoomIfOutMapExtent\r\n  }\r\n","import { Injectable } from '@angular/core';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\n\r\nimport { OverlayAction } from './overlay.enum';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class OverlayService {\r\n  public features$ = new BehaviorSubject<[Feature[], OverlayAction]>([\r\n    [],\r\n    undefined\r\n  ]);\r\n\r\n  constructor() {}\r\n\r\n  setFeatures(features: Feature[], action: OverlayAction = OverlayAction.None) {\r\n    this.features$.next([features, action]);\r\n  }\r\n\r\n  clear() {\r\n    this.features$.next([[], OverlayAction.None]);\r\n  }\r\n}\r\n","import { Directive, Self, OnInit, OnDestroy } from '@angular/core';\r\nimport { Subscription } from 'rxjs';\r\n\r\nimport olFormatGeoJSON from 'ol/format/GeoJSON';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { MapBrowserComponent } from '../../map/map-browser/map-browser.component';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\n\r\nimport { OverlayService } from '../shared/overlay.service';\r\nimport { OverlayAction } from '../shared/overlay.enum';\r\n\r\n@Directive({\r\n  selector: '[igoOverlay]'\r\n})\r\nexport class OverlayDirective implements OnInit, OnDestroy {\r\n  private features$$: Subscription;\r\n  private format = new olFormatGeoJSON();\r\n\r\n  get map(): IgoMap {\r\n    return this.component.map;\r\n  }\r\n\r\n  constructor(\r\n    @Self() private component: MapBrowserComponent,\r\n    private overlayService: OverlayService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.features$$ = this.overlayService.features$.subscribe(res =>\r\n      this.handleFeatures(res[0], res[1])\r\n    );\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.features$$.unsubscribe();\r\n  }\r\n\r\n  private handleFeatures(features: Feature[], action: OverlayAction) {}\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\n\r\nimport { OverlayDirective } from './shared/overlay.directive';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  exports: [OverlayDirective],\r\n  declarations: [OverlayDirective]\r\n})\r\nexport class IgoOverlayModule {\r\n  static forRoot(): ModuleWithProviders<IgoOverlayModule> {\r\n    return {\r\n      ngModule: IgoOverlayModule\r\n    };\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\n\r\nimport { Observable, Subject, forkJoin } from 'rxjs';\r\nimport { map as rxMap } from 'rxjs/operators';\r\n\r\nimport { saveAs } from 'file-saver';\r\nimport jspdf from 'jspdf';\r\nimport html2canvas from 'html2canvas';\r\nimport { default as JSZip } from 'jszip';\r\n\r\nimport { SubjectStatus } from '@igo2/utils';\r\nimport { SecureImagePipe } from '@igo2/common';\r\nimport { MessageService, ActivityService, LanguageService, ConfigService } from '@igo2/core';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { formatScale } from '../../map/shared/map.utils';\r\nimport { LegendMapViewOptions } from '../../layer/shared/layers/layer.interface';\r\nimport { getLayersLegends } from '../../layer/utils/outputLegend';\r\n\r\nimport { PrintOptions } from './print.interface';\r\n\r\ndeclare global {\r\n  interface Navigator {\r\n    msSaveBlob?: (blob: any, defaultName?: string) => boolean\r\n  }\r\n}\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class PrintService {\r\n  zipFile: JSZip;\r\n  nbFileToProcess: number;\r\n  activityId: string;\r\n  constructor(\r\n    private http: HttpClient,\r\n    private messageService: MessageService,\r\n    private activityService: ActivityService,\r\n    private languageService: LanguageService,\r\n    private configService: ConfigService\r\n  ) {}\r\n\r\n  print(map: IgoMap, options: PrintOptions): Subject<any> {\r\n    const status$ = new Subject();\r\n\r\n    const paperFormat: string = options.paperFormat;\r\n    const resolution = +options.resolution; // Default is 96\r\n    const orientation = options.orientation;\r\n    const legendPostion = options.legendPosition;\r\n\r\n    this.activityId = this.activityService.register();\r\n    const doc = new jspdf({\r\n      orientation,\r\n      format: paperFormat.toLowerCase()\r\n    });\r\n\r\n    const dimensions = [\r\n      doc.internal.pageSize.width,\r\n      doc.internal.pageSize.height\r\n    ];\r\n\r\n    const margins = [10, 10, 10, 10];\r\n    const width = dimensions[0] - margins[3] - margins[1];\r\n    const height = dimensions[1] - margins[0] - margins[2];\r\n    const size = [width, height];\r\n    let titleSizeResults = [0, 0];\r\n\r\n    if (options.title !== undefined) {\r\n      titleSizeResults = this.getTitleSize(options.title, width, height, doc); // return : size(pt) and left margin (mm)\r\n      this.addTitle(doc, options.title, titleSizeResults[0], margins[3] + titleSizeResults[1], titleSizeResults[0] * (25.4 / 72));\r\n    }\r\n    if (options.subtitle !== undefined) {\r\n      let subtitleSizeResult = 0;\r\n      const titleH = titleSizeResults[0];\r\n      subtitleSizeResult = this.getSubTitleSize(options.subtitle, width, height, doc); // return : size(pt) and left margin (mm)\r\n      this.addSubTitle(doc, options.subtitle, titleH * 0.7, margins[3] + subtitleSizeResult, titleH * 1.7 * (25.4 / 72));\r\n      margins[0] = margins[0] + titleSizeResults[0] * 0.7 * (25.4 / 72);\r\n    }\r\n    if (options.showProjection === true || options.showScale === true) {\r\n      this.addProjScale(\r\n        doc,\r\n        map,\r\n        resolution,\r\n        options.showProjection,\r\n        options.showScale\r\n        );\r\n    }\r\n    if (options.comment !== '') {\r\n      this.addComment(doc, options.comment);\r\n    }\r\n\r\n    this.addMap(doc, map, resolution, size, margins).subscribe(\r\n      async (status: SubjectStatus) => {\r\n        if (status === SubjectStatus.Done) {\r\n          await this.addScale(doc, map, margins);\r\n          await this.handleMeasureLayer(doc, map, margins);\r\n          if (options.legendPosition !== 'none') {\r\n            if (['topleft', 'topright', 'bottomleft', 'bottomright'].indexOf(options.legendPosition) > -1 ) {\r\n              await this.addLegendSamePage(doc, map, margins, resolution, options.legendPosition);\r\n            } else if (options.legendPosition === 'newpage') {\r\n              await this.addLegend(doc, map, margins, resolution);\r\n            }\r\n          } else {\r\n            await this.saveDoc(doc);\r\n          }\r\n        }\r\n\r\n        if (status === SubjectStatus.Done || status === SubjectStatus.Error) {\r\n          this.activityService.unregister(this.activityId);\r\n          status$.next(SubjectStatus.Done);\r\n        }\r\n      }\r\n    );\r\n\r\n    return status$;\r\n  }\r\n\r\n  /**\r\n   * Add measure overlay on the map on the document when the measure layer is present\r\n   * @param  doc - Pdf document where measure tooltip will be added\r\n   * @param  map - Map of the app\r\n   * @param  margins - Page margins\r\n   */\r\n  private async handleMeasureLayer(\r\n    doc: jspdf,\r\n    map: IgoMap,\r\n    margins: Array<number>\r\n  ) {\r\n    if (map.layers.find(layer => layer.visible && layer.id.startsWith('igo-measures-'))) {\r\n      let canvasOverlayHTMLMeasures;\r\n      const mapOverlayMeasuresHTML = map.ol.getOverlayContainer();\r\n      await html2canvas(mapOverlayMeasuresHTML, {\r\n        scale: 1,\r\n        backgroundColor: null\r\n      }).then(e => {\r\n        canvasOverlayHTMLMeasures = e;\r\n      });\r\n      this.addCanvas(doc, canvasOverlayHTMLMeasures, margins); // this adds measure overlays\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get html code for all layers legend\r\n   * @param  map IgoMap\r\n   * @param  width The width that the legend need to be\r\n   * @return Html code for the legend\r\n   */\r\n  getLayersLegendHtml(\r\n    map: IgoMap,\r\n    width: number,\r\n    resolution: number\r\n  ): Observable<string> {\r\n    return new Observable((observer) => {\r\n      let html = '';\r\n      const legends = getLayersLegends(\r\n        map.layers,\r\n        {\r\n          resolution: map.viewController.getResolution(),\r\n          extent: map.viewController.getExtent(),\r\n          projection: map.viewController.getOlProjection().getCode(),\r\n          // scale: map.viewController.getScale(resolution),\r\n          size: map.ol.getSize()\r\n        } as LegendMapViewOptions\r\n      );\r\n      if (legends.filter(l => l.display === true).length === 0) {\r\n        observer.next(html);\r\n        observer.complete();\r\n        return;\r\n      }\r\n      // Define important style to be sure that all container is convert\r\n      // to image not just visible part\r\n      html += '<style media=\"screen\" type=\"text/css\">';\r\n      html += '.html2canvas-container { width: ' + width + 'mm !important; height: 2000px !important; }';\r\n      html += 'table.tableLegend {table-layout: auto;}';\r\n      html += 'div.styleLegend {padding-top: 5px; padding-right:5px;padding-left:5px;padding-bottom:5px;}';\r\n      html += '</style>';\r\n      // The font size will also be lowered afterwards (globally along the legend size)\r\n      // this allows having a good relative font size here and to keep ajusting the legend size\r\n      // while keeping good relative font size\r\n      html += '<font size=\"3\" face=\"Times\" >';\r\n      html += '<div class=\"styleLegend\">';\r\n      html += '<table class=\"tableLegend\" >';\r\n\r\n      // For each legend, define an html table cell\r\n      const images$ = legends.filter(l => l.display).map((legend) =>\r\n        this.getDataImage(legend.url).pipe(\r\n          rxMap((dataImage) => {\r\n            let htmlImg = '<tr><td>' + legend.title.toUpperCase() + '</td></tr>';\r\n            htmlImg += '<tr><td><img src=\"' + dataImage + '\"></td></tr>';\r\n            return htmlImg;\r\n          })\r\n        )\r\n      );\r\n      forkJoin(images$).subscribe((dataImages) => {\r\n        html = dataImages.reduce((acc, current) => (acc += current), html);\r\n        html += '</table>';\r\n        html += '</div>';\r\n        observer.next(html);\r\n        observer.complete();\r\n      });\r\n    });\r\n  }\r\n\r\n  getDataImage(url: string): Observable<string> {\r\n    const secureIMG = new SecureImagePipe(this.http, this.configService);\r\n    return secureIMG.transform(url);\r\n  }\r\n\r\n  /**\r\n   * Get all the legend in a single image\r\n   * * @param  format - Image format. default value to \"png\"\r\n   * @return The image of the legend\r\n   */\r\n  async getLayersLegendImage(\r\n    map,\r\n    format: string = 'png',\r\n    doZipFile: boolean,\r\n    resolution: number\r\n  ) {\r\n    const status$ = new Subject();\r\n    // Get html code for the legend\r\n    const width = 200; // milimeters unit, originally define for document pdf\r\n    let html = await this.getLayersLegendHtml(\r\n      map,\r\n      width,\r\n      resolution\r\n    ).toPromise();\r\n    format = format.toLowerCase();\r\n\r\n    // If no legend show No LEGEND in an image\r\n    if (html.length === 0) {\r\n      html = '<font size=\"12\" face=\"Courier New\" >';\r\n      html += '<div align=\"center\"><b>NO LEGEND</b></div>';\r\n    }\r\n    // Create div to contain html code for legend\r\n    const div = window.document.createElement('div');\r\n    div.style.position = 'absolute';\r\n    div.style.top = '0';\r\n\r\n    // Add html code to convert in the new window\r\n    window.document.body.appendChild(div);\r\n    div.innerHTML = html;\r\n\r\n    await this.timeout(1);\r\n    const canvas = await html2canvas(div, { useCORS: true }).catch((e) => {\r\n      console.log(e);\r\n    });\r\n\r\n    if (canvas) {\r\n      let status = SubjectStatus.Done;\r\n      try {\r\n        if (!doZipFile) {\r\n          // Save the canvas as file\r\n          this.saveCanvasImageAsFile(canvas, 'legendImage', format);\r\n        } else {\r\n          // Add the canvas to zip\r\n          this.generateCanvaFileToZip(canvas, 'legendImage' + '.' + format);\r\n        }\r\n        div.parentNode.removeChild(div); // remove temp div (IE)\r\n      } catch (err) {\r\n        status = SubjectStatus.Error;\r\n      }\r\n      status$.next(status);\r\n    }\r\n\r\n    return status$;\r\n  }\r\n\r\n  getTitleSize(title: string, pageWidth: number, pageHeight: number, doc: jspdf) {\r\n    const pdfResolution = 96;\r\n    const titleSize = Math.round(2 * (pageHeight + 145) * 0.05) / 2;\r\n    doc.setFont('Times', 'bold');\r\n    const width = doc.getTextWidth(title);\r\n\r\n    const titleWidth = doc.getStringUnitWidth(title) * titleSize / doc.internal.scaleFactor;\r\n    const titleTailleMinimale = Math.round( 2 * (pageHeight + 150 ) * 0.037) / 2;\r\n    let titleFontSize = 0;\r\n\r\n    let titleMarginLeft;\r\n    if (titleWidth >= (pageWidth)) {\r\n      titleMarginLeft = 0;\r\n      titleFontSize = Math.round(((pageWidth / title.length) * pdfResolution) / 25.4);\r\n      // If the formula to find the font size gives below the defined minimum size\r\n      if (titleFontSize < titleTailleMinimale) {\r\n        titleFontSize = titleTailleMinimale;\r\n      }\r\n    } else {\r\n      titleMarginLeft = (pageWidth - titleWidth) / 2 ;\r\n      titleFontSize = titleSize;\r\n    }\r\n    return [titleFontSize, titleMarginLeft];\r\n  }\r\n\r\n  getSubTitleSize(subtitle: string, pageWidth: number, pageHeight: number, doc: jspdf) {\r\n    const subtitleSize = 0.7 * Math.round(2 * (pageHeight + 145) * 0.05) / 2; // 70% of the title's font size\r\n\r\n    doc.setFont('Times', 'bold');\r\n\r\n    const subtitleWidth = doc.getStringUnitWidth(subtitle) * subtitleSize / doc.internal.scaleFactor;\r\n\r\n    let subtitleMarginLeft;\r\n    if (subtitleWidth >= (pageWidth)) {\r\n      subtitleMarginLeft = 0;\r\n    } else {\r\n      subtitleMarginLeft = (pageWidth - subtitleWidth) / 2 ;\r\n    }\r\n    return subtitleMarginLeft;\r\n  }\r\n\r\n  private addTitle(doc: jspdf, title: string, titleFontSize: number, titleMarginLeft: number, titleMarginTop: number) {\r\n    doc.setFont('Times', 'bold');\r\n    doc.setFontSize(titleFontSize);\r\n    doc.text(title, titleMarginLeft, titleMarginTop);\r\n  }\r\n\r\n  private addSubTitle(doc: jspdf, subtitle: string, subtitleFontSize: number, subtitleMarginLeft: number, subtitleMarginTop: number) {\r\n    doc.setFont('Times', 'bold');\r\n    doc.setFontSize(subtitleFontSize);\r\n    doc.text(subtitle, subtitleMarginLeft, subtitleMarginTop);\r\n  }\r\n  /**\r\n   * Add comment to the document\r\n   * * @param  doc - pdf document\r\n   * * @param  comment - Comment to add in the document\r\n   * * @param  size - Size of the document\r\n   */\r\n  private addComment(doc: jspdf, comment: string) {\r\n    const commentSize = 16;\r\n    const commentMarginLeft = 20;\r\n    const marginBottom = 5;\r\n    const heightPixels = doc.internal.pageSize.height - marginBottom;\r\n\r\n    doc.setFont('courier');\r\n    doc.setFontSize(commentSize);\r\n    doc.text(comment, commentMarginLeft, heightPixels);\r\n  }\r\n  /**\r\n   * Add projection and/or scale to the document\r\n   * @param  doc - pdf document\r\n   * @param  map - Map of the app\r\n   * @param  dpi - DPI resolution of the document\r\n   * @param  projection - Bool to indicate if projection need to be added\r\n   * @param  scale - Bool to indicate if scale need to be added\r\n   */\r\n  private addProjScale(\r\n    doc: jspdf,\r\n    map: IgoMap,\r\n    dpi: number,\r\n    projection: boolean,\r\n    scale: boolean\r\n  ) {\r\n    const translate = this.languageService.translate;\r\n    const projScaleSize = 16;\r\n    const projScaleMarginLeft = 20;\r\n    const marginBottom = 15;\r\n    const heightPixels = doc.internal.pageSize.height - marginBottom;\r\n\r\n    let textProjScale: string = '';\r\n    if (projection === true) {\r\n      const projText = translate.instant('igo.geo.printForm.projection');\r\n      textProjScale += projText + ': ' + map.projection;\r\n    }\r\n    if (scale === true) {\r\n      if (projection === true) {\r\n        textProjScale += '   ';\r\n      }\r\n      const scaleText = translate.instant('igo.geo.printForm.scale');\r\n      const mapScale = map.viewController.getScale(dpi);\r\n      textProjScale += scaleText + ': ~ 1 / ' + formatScale(mapScale);\r\n    }\r\n    doc.setFont('courier');\r\n    doc.setFontSize(projScaleSize);\r\n    doc.text(textProjScale, projScaleMarginLeft, heightPixels);\r\n  }\r\n\r\n  /**\r\n   * Add the legend to the document\r\n   * @param  doc - Pdf document where legend will be added\r\n   * @param  map - Map of the app\r\n   * @param  margins - Page margins\r\n   */\r\n  private async addLegend(\r\n    doc: jspdf,\r\n    map: IgoMap,\r\n    margins: Array<number>,\r\n    resolution: number\r\n  ) {\r\n    // Get html code for the legend\r\n    const width = doc.internal.pageSize.width;\r\n    const html = await this.getLayersLegendHtml(\r\n      map,\r\n      width,\r\n      resolution\r\n    ).toPromise();\r\n    // If no legend, save the map directly\r\n    if (html === '') {\r\n      await this.saveDoc(doc);\r\n      return true;\r\n    }\r\n    // Create div to contain html code for legend\r\n    const div = window.document.createElement('div');\r\n    div.style.position = 'absolute';\r\n    div.style.top = '0';\r\n\r\n    // Add html code to convert in the new window\r\n    window.document.body.appendChild(div);\r\n    div.innerHTML = html;\r\n\r\n    await this.timeout(1);\r\n    const canvas = await html2canvas(div, { useCORS: true }).catch((e) => {\r\n      console.log(e);\r\n    });\r\n\r\n    if (canvas) {\r\n      const pourcentageReduction = 0.85;\r\n      const imageSize = [pourcentageReduction * (25.4 * canvas.width) / resolution, pourcentageReduction\r\n        * (25.4 * canvas.height) / resolution];\r\n      let imgData;\r\n      doc.addPage();\r\n      imgData = canvas.toDataURL('image/png');\r\n      doc.addImage(imgData, 'PNG', 10, 10, imageSize[0], imageSize[1]);\r\n      div.parentNode.removeChild(div); // remove temp div (IE style)\r\n    }\r\n\r\n    await this.saveDoc(doc);\r\n\r\n  }\r\n\r\n  /**\r\n   * Add the legend to the document\r\n   * @param  doc - Pdf document where legend will be added\r\n   * @param  map - Map of the app\r\n   * @param  margins - Page margins\r\n   */\r\n     private async addLegendSamePage(\r\n      doc: jspdf,\r\n      map: IgoMap,\r\n      margins: Array<number>,\r\n      resolution: number,\r\n      legendPosition: string\r\n    ) {\r\n      // Get html code for the legend\r\n      const width = doc.internal.pageSize.width;\r\n      const html = await this.getLayersLegendHtml(\r\n        map,\r\n        width,\r\n        resolution\r\n      ).toPromise();\r\n      // If no legend, save the map directly\r\n      if (html === '') {\r\n        await this.saveDoc(doc);\r\n        return true;\r\n      }\r\n      // Create div to contain html code for legend\r\n      const div = window.document.createElement('div');\r\n      div.style.position = 'absolute';\r\n      div.style.top = '0';\r\n      // Add html code to convert in the new window\r\n      window.document.body.appendChild(div);\r\n      div.innerHTML = html;\r\n      await this.timeout(1);\r\n      const canvas = await html2canvas(div, { useCORS: true }).catch((e) => {\r\n        console.log(e);\r\n      });\r\n      let marginsLegend;\r\n      if (canvas) {\r\n        const pourcentageReduction = 0.85;\r\n        const imageSize = [pourcentageReduction * (25.4 * canvas.width) / resolution,\r\n           pourcentageReduction * (25.4 * canvas.height) / resolution];\r\n        // Move the legend to the correct position on the page\r\n        if ( legendPosition === 'bottomright') {\r\n          marginsLegend = [doc.internal.pageSize.height - margins[2] - imageSize[1], margins[1],\r\n           margins[2], doc.internal.pageSize.width - margins[1] - imageSize[0]];\r\n        } else if (legendPosition === 'topright') {\r\n          marginsLegend = [margins[0], margins[1], doc.internal.pageSize.height - margins[0] - imageSize[1],\r\n          doc.internal.pageSize.width - margins[1] - imageSize[0] ];\r\n        } else if (legendPosition === 'bottomleft') {\r\n          // When the legend is in the bottom left, raise the legend slightly upward so that attributions are visible\r\n          marginsLegend = [doc.internal.pageSize.height - margins[2] - imageSize[1] - 15,\r\n          doc.internal.pageSize.width - margins[3] - imageSize[0], margins[2] + 15, margins[3] ];\r\n        } else if (legendPosition === 'topleft') {\r\n          marginsLegend = [margins[0], doc.internal.pageSize.width - margins[3] - imageSize[0],\r\n           doc.internal.pageSize.height - margins[0] - imageSize[1], margins[3] ];\r\n        }\r\n        this.addCanvas(doc, canvas, marginsLegend); // this adds the legend\r\n        div.parentNode.removeChild(div); // remove temp div (IE style)\r\n        await this.saveDoc(doc);\r\n      }\r\n    }\r\n\r\n  /**\r\n   * Add scale and attributions on the map on the document\r\n   * @param  doc - Pdf document where legend will be added\r\n   * @param  map - Map of the app\r\n   * @param  margins - Page margins\r\n   */\r\n  private async addScale(\r\n    doc: jspdf,\r\n    map: IgoMap,\r\n    margins: Array<number>\r\n    ) {\r\n      const mapSize = map.ol.getSize();\r\n      const extent = map.ol.getView().calculateExtent(mapSize);\r\n      // Get the scale and attribution\r\n      // we use cloneNode to modify the nodes to print without modifying it on the page, using deep:true to get children\r\n      let canvasOverlayHTML;\r\n      const mapOverlayHTML = map.ol.getOverlayContainerStopEvent();\r\n      // Remove the UI buttons from the nodes\r\n      const OverlayHTMLButtons = mapOverlayHTML.getElementsByTagName('button');\r\n      const OverlayHTMLButtonsarr = Array.from(OverlayHTMLButtons);\r\n      for (const OverlayHTMLButton of OverlayHTMLButtonsarr) {\r\n        OverlayHTMLButton.setAttribute('data-html2canvas-ignore', 'true');\r\n      }\r\n      // Change the styles of hyperlink in the printed version\r\n      // Transform the Overlay into a canvas\r\n      // scale is necessary to make it in google chrome\r\n      // background as null because otherwise it is white and cover the map\r\n      // allowtaint is to allow rendering images in the attributions\r\n      // useCORS: true pour permettre de renderer les images (ne marche pas en local)\r\n      const canvas = await html2canvas(mapOverlayHTML, {\r\n        scale: 1,\r\n        backgroundColor: null,\r\n        allowTaint: true,\r\n        useCORS: true,\r\n      }).then( e => {\r\n        canvasOverlayHTML = e;\r\n      });\r\n      this.addCanvas(doc, canvasOverlayHTML, margins); // this adds scales and attributions\r\n }\r\n\r\n  defineNbFileToProcess(nbFileToProcess) {\r\n    this.nbFileToProcess = nbFileToProcess;\r\n  }\r\n\r\n  private timeout(ms) {\r\n    return new Promise((resolve) => setTimeout(resolve, ms));\r\n  }\r\n\r\n  private addCanvas(\r\n    doc: jspdf,\r\n    canvas: HTMLCanvasElement,\r\n    margins: Array<number>\r\n  ) {\r\n    let image;\r\n    if (canvas) {\r\n      image = canvas.toDataURL('image/png');\r\n    }\r\n\r\n    if (image !== undefined) {\r\n      const imageSize = this.getImageSizeToFitPdf(doc, canvas, margins);\r\n      doc.addImage(\r\n        image,\r\n        'PNG',\r\n        margins[3],\r\n        margins[0],\r\n        imageSize[0],\r\n        imageSize[1]\r\n      );\r\n      doc.rect(margins[3], margins[0], imageSize[0], imageSize[1]);\r\n    }\r\n  }\r\n\r\n  // TODO fix printing with image resolution\r\n  private addMap(\r\n    doc: jspdf,\r\n    map: IgoMap,\r\n    resolution: number,\r\n    size: Array<number>,\r\n    margins: Array<number>\r\n  ) {\r\n    const status$ = new Subject();\r\n\r\n    const mapSize = map.ol.getSize();\r\n    const extent = map.ol.getView().calculateExtent(mapSize);\r\n\r\n    const widthPixels = Math.round((size[0] * resolution) / 25.4);\r\n    const heightPixels = Math.round((size[1] * resolution) / 25.4);\r\n\r\n    let timeout;\r\n\r\n    map.ol.once('rendercomplete', (event: any) => {\r\n      const canvases = event.target.getViewport().getElementsByTagName('canvas');\r\n      const mapStatus$$ = map.status$.subscribe((mapStatus: SubjectStatus) => {\r\n        clearTimeout(timeout);\r\n\r\n        if (mapStatus !== SubjectStatus.Done) {\r\n          return;\r\n        }\r\n\r\n        mapStatus$$.unsubscribe();\r\n\r\n        let status = SubjectStatus.Done;\r\n        try {\r\n          for (const canvas of canvases) {\r\n            if (canvas.width !== 0) {\r\n              this.addCanvas(doc, canvas, margins);\r\n            }\r\n          }\r\n        } catch (err) {\r\n          status = SubjectStatus.Error;\r\n          this.messageService.error(\r\n            this.languageService.translate.instant(\r\n              'igo.geo.printForm.corsErrorMessageBody'\r\n            ),\r\n            this.languageService.translate.instant(\r\n              'igo.geo.printForm.corsErrorMessageHeader'\r\n            )\r\n          );\r\n        }\r\n        this.renderMap(map, mapSize, extent);\r\n        status$.next(status);\r\n      });\r\n\r\n      // If no loading as started after 200ms, then probably no loading\r\n      // is required.\r\n      timeout = window.setTimeout(() => {\r\n        mapStatus$$.unsubscribe();\r\n\r\n        let status = SubjectStatus.Done;\r\n        try {\r\n          for (const canvas of canvases) {\r\n            if (canvas.width !== 0) {\r\n              this.addCanvas(doc, canvas, margins);\r\n            }\r\n          }\r\n        } catch (err) {\r\n          status = SubjectStatus.Error;\r\n          this.messageService.error(\r\n            this.languageService.translate.instant(\r\n              'igo.geo.printForm.corsErrorMessageBody'\r\n            ),\r\n            this.languageService.translate.instant(\r\n              'igo.geo.printForm.corsErrorMessageHeader'\r\n            )\r\n          );\r\n        }\r\n        this.renderMap(map, mapSize, extent);\r\n        status$.next(status);\r\n      }, 200);\r\n    });\r\n\r\n    this.renderMap(map, [widthPixels, heightPixels], extent);\r\n\r\n    return status$;\r\n  }\r\n\r\n  /**\r\n   * Download an image of the map with addition of informations\r\n   * @param  map - Map of the app\r\n   * @param  format - Image format. default value to \"png\"\r\n   * @param  projection - Indicate if projection need to be add. Default to false\r\n   * @param  scale - Indicate if scale need to be add. Default to false\r\n   * @param  legend - Indicate if the legend of layers need to be download. Default to false\r\n   * @param  title - Title to add for the map - Default to blank\r\n   * @param  subtitle - Subtitle to add for the map - Default to blank\r\n   * @param  comment - Comment to add for the map - Default to blank\r\n   * @param  doZipFile - Indicate if we do a zip with the file\r\n   * @return Image file of the map with extension format given as parameter\r\n   */\r\n  downloadMapImage(\r\n    map: IgoMap,\r\n    resolution: number,\r\n    format = 'png',\r\n    projection = false,\r\n    scale = false,\r\n    legend = false,\r\n    title = '',\r\n    subtitle = '',\r\n    comment = '',\r\n    doZipFile = true\r\n  ) {\r\n    const status$ = new Subject();\r\n    // const resolution = map.ol.getView().getResolution();\r\n    this.activityId = this.activityService.register();\r\n    const translate = this.languageService.translate;\r\n    map.ol.once('rendercomplete', (event: any) => {\r\n      format = format.toLowerCase();\r\n      const oldCanvas = event.target\r\n        .getViewport()\r\n        .getElementsByTagName('canvas')[0];\r\n      const newCanvas = document.createElement('canvas');\r\n      const newContext = newCanvas.getContext('2d');\r\n      // Postion in height to set the canvas in new canvas\r\n      let positionHCanvas = 0;\r\n      // Position in width to set the Proj/Scale in new canvas\r\n      let positionWProjScale = 10;\r\n      // Get height/width of map canvas\r\n      const width = oldCanvas.width;\r\n      let height = oldCanvas.height;\r\n      // Set Font to calculate comment width\r\n      newContext.font = '20px Calibri';\r\n      const commentWidth = newContext.measureText(comment).width;\r\n      // Add height for title if defined\r\n      height = title !== '' ? height + 30 : height;\r\n      // Add height for title if defined\r\n      height = subtitle !== '' ? height + 30 : height;\r\n      // Add height for projection or scale (same line) if defined\r\n      height = projection !== false || scale !== false ? height + 30 : height;\r\n      const positionHProjScale = height - 10;\r\n      // Define number of line depending of the comment length\r\n      const commentNbLine = Math.ceil(commentWidth / width);\r\n      // Add height for multiline comment if defined\r\n      height = comment !== '' ? height + commentNbLine * 30 : height;\r\n      let positionHComment = height - commentNbLine * 20 + 5;\r\n      // Set the new canvas with the new calculated size\r\n      newCanvas.width = width;\r\n      newCanvas.height = height;\r\n      // Patch Jpeg default black background to white\r\n      if (format === 'jpeg') {\r\n        newContext.fillStyle = '#ffffff';\r\n        newContext.fillRect(0, 0, width, height);\r\n        newContext.fillStyle = '#000000';\r\n      }\r\n      // If a title need to be added to canvas\r\n      if (title !== '') {\r\n        // Set font for title\r\n        // Adjust according to title length\r\n        newContext.font = '26px Calibri';\r\n        positionHCanvas = 30;\r\n        newContext.textAlign = 'center';\r\n        newContext.fillText(title, width / 2, 20, width * 0.9);\r\n      }\r\n      if (subtitle !== '') {\r\n        // Set font for subtitle\r\n        // Adjust according to title length\r\n        newContext.font = '26px Calibri';\r\n        positionHCanvas = 60;\r\n        newContext.textAlign = 'center';\r\n        newContext.fillText(subtitle, width / 2, 50, width * 0.9);\r\n      }\r\n      // Set font for next section\r\n      newContext.font = '20px Calibri';\r\n      // If projection need to be added to canvas\r\n      if (projection !== false) {\r\n        const projText = translate.instant('igo.geo.printForm.projection');\r\n        newContext.textAlign = 'start';\r\n        newContext.fillText(\r\n          projText + ': ' + map.projection,\r\n          positionWProjScale,\r\n          positionHProjScale\r\n        );\r\n        positionWProjScale += 200; // Width position change for scale position\r\n      }\r\n\r\n      // If scale need to be added to canvas\r\n      if (scale !== false) {\r\n        const scaleText = translate.instant('igo.geo.printForm.scale');\r\n        const mapScale = map.viewController.getScale(resolution);\r\n        newContext.textAlign = 'start';\r\n        newContext.fillText(\r\n          scaleText + ': ~ 1 / ' + formatScale(mapScale),\r\n          positionWProjScale,\r\n          positionHProjScale\r\n        );\r\n      }\r\n      // If a comment need to be added to canvas\r\n      if (comment !== '') {\r\n        newContext.textAlign = 'center';\r\n        // If only one line, no need to multiline the comment\r\n        if (commentNbLine === 1) {\r\n          newContext.fillText(comment, width / 2, positionHComment);\r\n        } else {\r\n          // Separate the setenses to be approx. the same length\r\n          const nbCommentChar = comment.length;\r\n          const CommentLengthToCut = Math.floor(nbCommentChar / commentNbLine);\r\n          let commentCurrentLine = '';\r\n          let positionFirstCutChar = 0;\r\n          let positionLastBlank;\r\n          // Loop for the number of line calculated\r\n          for (let i = 0; i < commentNbLine; i++) {\r\n            // For all line except last\r\n            if (commentNbLine - 1 > i) {\r\n              // Get comment current line to find the right place tu cut comment\r\n              commentCurrentLine = comment.substr(\r\n                positionFirstCutChar,\r\n                CommentLengthToCut\r\n              );\r\n              // Cut the setence at blank\r\n              positionLastBlank = commentCurrentLine.lastIndexOf(' ');\r\n              newContext.fillText(\r\n                commentCurrentLine.substr(0, positionLastBlank),\r\n                width / 2,\r\n                positionHComment\r\n              );\r\n              positionFirstCutChar += positionLastBlank;\r\n              // Go to next line for insertion\r\n              positionHComment += 20;\r\n            } else {\r\n              // Don't cut last part\r\n              newContext.fillText(\r\n                comment.substr(positionFirstCutChar),\r\n                width / 2,\r\n                positionHComment\r\n              );\r\n            }\r\n          }\r\n        }\r\n      }\r\n      // Add map to new canvas\r\n      newContext.drawImage(oldCanvas, 0, positionHCanvas);\r\n\r\n      let status = SubjectStatus.Done;\r\n      let fileNameWithExt = 'map.' + format;\r\n      if (format.toLowerCase() === 'tiff') {\r\n        fileNameWithExt = 'map' + map.projection.replace(':', '_') + '.' + format;\r\n      }\r\n\r\n      try {\r\n        // Save the canvas as file\r\n        if (!doZipFile) {\r\n          this.saveCanvasImageAsFile(newCanvas, fileNameWithExt, format);\r\n        } else if (format.toLowerCase() === 'tiff') {\r\n          // Add the canvas to zip\r\n          this.generateCanvaFileToZip(newCanvas, fileNameWithExt);\r\n        } else {\r\n          // Add the canvas to zip\r\n          this.generateCanvaFileToZip(newCanvas, fileNameWithExt);\r\n        }\r\n      } catch (err) {\r\n        status = SubjectStatus.Error;\r\n      }\r\n\r\n      status$.next(status);\r\n\r\n      if (format.toLowerCase() === 'tiff') {\r\n        const tfwFileNameWithExt = fileNameWithExt.substring(0, fileNameWithExt.toLowerCase().indexOf('.tiff')) + '.tfw';\r\n        const tiwContent = this.getWorldFileInformation(map);\r\n        const blob = new Blob([tiwContent], {\r\n          type: 'text/plain;charset=utf-8'\r\n        });\r\n        if (!doZipFile) {\r\n          // saveAs automaticly replace ':' for '_'\r\n          saveAs(blob, tfwFileNameWithExt);\r\n          this.saveFileProcessing();\r\n        } else {\r\n          // Add the canvas to zip\r\n          this.addFileToZip(tfwFileNameWithExt,blob);\r\n        }\r\n      }\r\n    });\r\n    map.ol.renderSync();\r\n\r\n    return status$;\r\n  }\r\n\r\n  private renderMap(map, size, extent) {\r\n    map.ol.updateSize();\r\n    map.ol.renderSync();\r\n  }\r\n\r\n  /**\r\n   * Save document\r\n   * @param  doc - Document to save\r\n   */\r\n  protected async saveDoc(doc: jspdf) {\r\n    await doc.save('map.pdf', { returnPromise: true });\r\n  }\r\n\r\n  /**\r\n   * Calculate the best Image size to fit in pdf\r\n   * @param doc - Pdf Document\r\n   * @param canvas - Canvas of image\r\n   * @param margins - Page margins\r\n   */\r\n  private getImageSizeToFitPdf(doc, canvas, margins) {\r\n    // Define variable to calculate best size to fit in one page\r\n    const pageHeight =\r\n      doc.internal.pageSize.getHeight() - (margins[0] + margins[2]);\r\n    const pageWidth =\r\n      doc.internal.pageSize.getWidth() - (margins[1] + margins[3]);\r\n    const canHeight = canvas.height;\r\n    const canWidth = canvas.width;\r\n    const heightRatio = canHeight / pageHeight;\r\n    const widthRatio = canWidth / pageWidth;\r\n    const maxRatio = heightRatio > widthRatio ? heightRatio : widthRatio;\r\n    const imgHeigh = maxRatio > 1 ? canHeight / maxRatio : canHeight;\r\n    const imgWidth = maxRatio > 1 ? canWidth / maxRatio : canWidth;\r\n\r\n    return [imgWidth, imgHeigh];\r\n  }\r\n\r\n  /**\r\n   * Get a world file information for tiff\r\n   * @param  map - Map of the app\r\n   */\r\n  private getWorldFileInformation(map) {\r\n    const currentResolution = map.viewController.getResolution();\r\n    const currentExtent = map.viewController.getExtent(); // Return [minx, miny, maxx, maxy]\r\n    return [\r\n      currentResolution,\r\n      0,\r\n      0,\r\n      -currentResolution,\r\n      currentExtent[0] + currentResolution / 0.5,\r\n      currentExtent[3] - currentResolution / 0.5\r\n    ].join('\\n');\r\n  }\r\n\r\n  /**\r\n   * Save canvas image as file\r\n   * @param canvas - Canvas to save\r\n   * @param name - Name of the file\r\n   * @param format - file format\r\n   */\r\n  private saveCanvasImageAsFile(canvas, nameWithExt, format) {\r\n    const blobFormat = 'image/' + format;\r\n    const that = this;\r\n\r\n    try {\r\n      canvas.toDataURL(); // Just to make the catch trigger wihtout toBlob Error throw not catched\r\n      // If navigator is Internet Explorer\r\n      if (navigator.msSaveBlob) {\r\n        navigator.msSaveBlob(canvas.msToBlob(), nameWithExt);\r\n        this.saveFileProcessing();\r\n      } else {\r\n        canvas.toBlob((blob) => {\r\n          // download image\r\n          saveAs(blob, nameWithExt);\r\n          that.saveFileProcessing();\r\n        }, blobFormat);\r\n      }\r\n    } catch (err) {\r\n      this.messageService.error(\r\n        this.languageService.translate.instant(\r\n          'igo.geo.printForm.corsErrorMessageBody'\r\n        ),\r\n        this.languageService.translate.instant(\r\n          'igo.geo.printForm.corsErrorMessageHeader'\r\n        )\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add file to a zip\r\n   * @param canvas - File to add to the zip\r\n   * @param  name -Name of the fileoverview\r\n   */\r\n  private generateCanvaFileToZip(canvas, name) {\r\n    const blobFormat = 'image/' + 'jpeg';\r\n    const that = this;\r\n    if (\r\n      !this.hasOwnProperty('zipFile') ||\r\n      typeof this.zipFile === 'undefined'\r\n    ) {\r\n      this.zipFile = new JSZip();\r\n    }\r\n\r\n    try {\r\n      canvas.toDataURL(); // Just to make the catch trigger wihtout toBlob Error throw not catched\r\n      if (navigator.msSaveBlob) {\r\n        this.addFileToZip(name, canvas.msToBlob());\r\n      } else {\r\n        canvas.toBlob((blob) => {\r\n          that.addFileToZip(name, blob);\r\n        }, blobFormat);\r\n      }\r\n    } catch (err) {\r\n      this.messageService.error(\r\n        this.languageService.translate.instant(\r\n          'igo.geo.printForm.corsErrorMessageBody'\r\n        ),\r\n        this.languageService.translate.instant(\r\n          'igo.geo.printForm.corsErrorMessageHeader'\r\n        )\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add file to zip, if all file are zipped, download\r\n   * @param name - Name of the files\r\n   * @param blob - Contain of file\r\n   */\r\n  private addFileToZip(name, blob) {\r\n    // add file to zip\r\n    this.zipFile.file(name, blob);\r\n    this.nbFileToProcess--;\r\n\r\n    // If all files are proccessed\r\n    if (this.nbFileToProcess === 0) {\r\n      // Download zip file\r\n      this.getZipFile();\r\n      // Stop loading\r\n      this.activityService.unregister(this.activityId);\r\n    }\r\n  }\r\n\r\n  private saveFileProcessing() {\r\n    this.nbFileToProcess--;\r\n\r\n    // If all files are proccessed\r\n    if (this.nbFileToProcess === 0) {\r\n      // Stop loading\r\n      this.activityService.unregister(this.activityId);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get the zipped file\r\n   * @return Retun a zip file\r\n   */\r\n  private getZipFile() {\r\n    const that = this;\r\n    this.zipFile.generateAsync({ type: 'blob' }).then((blob) => {\r\n      // 1) generate the zip file\r\n      saveAs(blob, 'map.zip');\r\n      delete that.zipFile;\r\n    });\r\n  }\r\n}\r\n","import { Layer } from '../shared/layers/layer';\r\nimport { LegendMapViewOptions, OutputLayerLegend } from '../shared/layers/layer.interface';\r\n\r\n/**\r\n * Get all the layers legend\r\n * @return Array of legend\r\n */\r\nexport function getLayersLegends(layers: Layer[], view?: LegendMapViewOptions): OutputLayerLegend[] {\r\n  const legends = [];\r\n\r\n  for (const layer of layers) {\r\n    const legendOptions = layer.options.legendOptions;\r\n    if (layer.visible === false) { continue; }\r\n\r\n    const legendUrls = layer.dataSource.getLegend(undefined, view) || [];\r\n    for (const legendUrl of legendUrls) {\r\n      if (legendUrl.url === undefined) { continue; }\r\n\r\n      // Add legend info to the list\r\n      legends.push({\r\n        title: layer.title || '',\r\n        url: legendUrl.url,\r\n        display: legendOptions?.display === undefined ? true : legendOptions.display\r\n      });\r\n    }\r\n  }\r\n\r\n  return legends;\r\n}\r\n","import { strEnum } from '@igo2/utils';\r\n\r\nexport const PrintOutputFormat = strEnum(['Pdf', 'Image']);\r\n\r\nexport type PrintOutputFormat = keyof typeof PrintOutputFormat;\r\n\r\nexport const PrintPaperFormat = strEnum([\r\n  'A0',\r\n  'A1',\r\n  'A2',\r\n  'A3',\r\n  'A4',\r\n  'A5',\r\n  'Letter',\r\n  'Legal'\r\n]);\r\nexport type PrintPaperFormat = keyof typeof PrintPaperFormat;\r\n\r\nexport const PrintOrientation = strEnum(['landscape', 'portrait']);\r\nexport type PrintOrientation = keyof typeof PrintOrientation;\r\n\r\nexport const PrintResolution = strEnum(['72', '96', '150', '300']);\r\nexport type PrintResolution = keyof typeof PrintResolution;\r\n\r\nexport const PrintSaveImageFormat = strEnum([\r\n  'Bmp',\r\n  'Gif',\r\n  'Jpeg',\r\n  'Png',\r\n  'Tiff'\r\n]);\r\nexport type PrintSaveImageFormat = keyof typeof PrintSaveImageFormat;\r\n\r\nexport const PrintLegendPosition = strEnum([\r\n  'none',\r\n  'topright',\r\n  'topleft',\r\n  'bottomleft',\r\n  'bottomright',\r\n  'newpage'\r\n]);\r\nexport type PrintLegendPosition = keyof typeof PrintLegendPosition;\r\n","<form class=\"igo-form\" [formGroup]=\"form\">\r\n  <div class=\"igo-input-container\">\r\n    <mat-form-field>\r\n      <input\r\n        matInput\r\n        formControlName=\"title\"\r\n        placeholder=\"{{'igo.geo.printForm.title' | translate}}\">\r\n    </mat-form-field>\r\n  </div>\r\n  <div class=\"igo-input-container\">\r\n    <mat-form-field>\r\n      <input\r\n        matInput\r\n        formControlName=\"subtitle\"\r\n        placeholder=\"{{'igo.geo.printForm.subtitle' | translate}}\">\r\n    </mat-form-field>\r\n  </div>\r\n  <div class=\"igo-input-container\">\r\n    <mat-form-field>\r\n      <input\r\n        matInput\r\n        formControlName=\"comment\"\r\n        placeholder=\"{{'igo.geo.printForm.comment' | translate}}\">\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\">\r\n    <div class=\"print-slide-toggle-container mat-typography\">\r\n      <mat-slide-toggle\r\n        class=\"print-option\"\r\n        formControlName=\"showProjection\"\r\n        [labelPosition]=\"'before'\">\r\n        {{'igo.geo.printForm.showProjection' | translate}}\r\n      </mat-slide-toggle>\r\n      <mat-slide-toggle\r\n        class=\"print-option\"\r\n        formControlName=\"showScale\"\r\n        [labelPosition]=\"'before'\">\r\n        {{'igo.geo.printForm.showScale' | translate}}\r\n      </mat-slide-toggle>\r\n      <mat-slide-toggle\r\n        class=\"print-option\"\r\n        formControlName=\"doZipFile\"\r\n        [labelPosition]=\"'before'\"\r\n        [style.display]=\"isPrintService ? 'none' : ''\">\r\n        {{'igo.geo.printForm.doZipFile' | translate}}\r\n      </mat-slide-toggle>\r\n    </div>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\">\r\n    <mat-form-field>\r\n      <mat-select\r\n        formControlName=\"legendPosition\"\r\n        placeholder=\"{{'igo.geo.printForm.legendPosition' | translate}}\">\r\n        <mat-option *ngFor=\"let legendPosition of legendPositions | keyvalue \" [value]=\"legendPosition.key\">\r\n            {{'igo.geo.printForm.legendPositions.' + legendPosition.value | translate}}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\">\r\n    <mat-form-field>\r\n      <mat-select (selectionChange)=\"toggleImageSaveProp()\"\r\n        formControlName=\"outputFormat\"\r\n        placeholder=\"{{'igo.geo.printForm.outputFormat' | translate}}\">\r\n        <mat-option *ngFor=\"let outputFormat of outputFormats | keyvalue \" [value]=\"outputFormat.key\">\r\n            {{outputFormat.value}}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\" [style.display]=\"isPrintService ? 'block' : 'none'\">\r\n    <mat-form-field>\r\n      <mat-select\r\n        formControlName=\"paperFormat\"\r\n        placeholder=\"{{'igo.geo.printForm.paperFormat' | translate}}\">\r\n        <mat-option *ngFor=\"let paperFormat of paperFormats | keyvalue \" [value]=\"paperFormat.key\">\r\n          {{('igo.geo.printForm.paperFormats.' + paperFormat.value) | translate}}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\" [style.display]=\"isPrintService ? 'none' : 'block'\">\r\n    <mat-form-field>\r\n      <mat-select\r\n        formControlName=\"imageFormat\"\r\n        placeholder=\"{{'igo.geo.printForm.imageFormat' | translate}}\">\r\n        <mat-option *ngFor=\"let imageFormat of imageFormats | keyvalue \" [value]=\"imageFormat.key\">\r\n          {{imageFormat.value}}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\" style=\"display: none;\">\r\n    <mat-form-field>\r\n      <mat-select\r\n        formControlName=\"resolution\"\r\n        placeholder=\"{{'igo.geo.printForm.resolution' | translate}}\">\r\n        <mat-option *ngFor=\"let resolution of resolutions | keyvalue \" [value]=\"resolution.key\">\r\n          {{resolution.value + ' PPI'}}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\" [style.display]=\"isPrintService ? 'block' : 'none'\">\r\n    <mat-form-field>\r\n      <mat-select\r\n        formControlName=\"orientation\"\r\n        placeholder=\"{{'igo.geo.printForm.orientation' | translate}}\">\r\n        <mat-option *ngFor=\"let orientation of orientations | keyvalue \" [value]=\"orientation.key\">\r\n          {{('igo.geo.printForm.' + orientation.value) | translate}}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-form-button-group print-button-top-padding\">\r\n    <button\r\n      mat-raised-button\r\n      type=\"button\"\r\n      [disabled]=\"!form.valid || (disabled$ | async)\"\r\n      (click)=\"handleFormSubmit(form.value, form.valid)\">\r\n      {{'igo.geo.printForm.saveBtn' | translate}}\r\n    </button>\r\n  </div>\r\n\r\n</form>\r\n","import { Component, Input, Output, EventEmitter, OnInit } from '@angular/core';\r\nimport {\r\n  UntypedFormGroup,\r\n  UntypedFormBuilder,\r\n  UntypedFormControl,\r\n  Validators\r\n} from '@angular/forms';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { PrintOptions } from '../shared/print.interface';\r\n\r\nimport {\r\n  PrintOutputFormat,\r\n  PrintPaperFormat,\r\n  PrintOrientation,\r\n  PrintResolution,\r\n  PrintSaveImageFormat,\r\n  PrintLegendPosition\r\n} from '../shared/print.type';\r\n\r\n@Component({\r\n  selector: 'igo-print-form',\r\n  templateUrl: './print-form.component.html',\r\n  styleUrls: ['./print-form.component.scss']\r\n})\r\nexport class PrintFormComponent implements OnInit {\r\n  public form: UntypedFormGroup;\r\n  public outputFormats = PrintOutputFormat;\r\n  public paperFormats = PrintPaperFormat;\r\n  public orientations = PrintOrientation;\r\n  public resolutions = PrintResolution;\r\n  public imageFormats = PrintSaveImageFormat;\r\n  public legendPositions = PrintLegendPosition;\r\n  public isPrintService = true;\r\n\r\n  @Input() disabled$: BehaviorSubject<boolean>;\r\n\r\n  @Input()\r\n  get imageFormat(): PrintSaveImageFormat {\r\n    return this.imageFormatField.value;\r\n  }\r\n  set imageFormat(value: PrintSaveImageFormat) {\r\n    this.imageFormatField.setValue(value || PrintSaveImageFormat.Jpeg, {\r\n      onlySelf: true\r\n    });\r\n  }\r\n\r\n  @Input()\r\n  get outputFormat(): PrintOutputFormat {\r\n    return this.outputFormatField.value;\r\n  }\r\n  set outputFormat(value: PrintOutputFormat) {\r\n    this.outputFormatField.setValue(value || PrintOutputFormat.Pdf, {\r\n      onlySelf: true\r\n    });\r\n  }\r\n\r\n  @Input()\r\n  get paperFormat(): PrintPaperFormat {\r\n    return this.paperFormatField.value;\r\n  }\r\n  set paperFormat(value: PrintPaperFormat) {\r\n    this.paperFormatField.setValue(value || PrintPaperFormat.Letter, {\r\n      onlySelf: true\r\n    });\r\n  }\r\n\r\n  @Input()\r\n  get orientation(): PrintOrientation {\r\n    return this.orientationField.value;\r\n  }\r\n  set orientation(value: PrintOrientation) {\r\n    this.orientationField.setValue(value || PrintOrientation.landscape, {\r\n      onlySelf: true\r\n    });\r\n  }\r\n\r\n  @Input()\r\n  get resolution(): PrintResolution {\r\n    return this.resolutionField.value;\r\n  }\r\n  set resolution(value: PrintResolution) {\r\n    this.resolutionField.setValue(value || PrintResolution['96'], {\r\n      onlySelf: true\r\n    });\r\n  }\r\n\r\n  @Input()\r\n  get legendPosition(): PrintLegendPosition {\r\n    return this.legendPositionField.value;\r\n  }\r\n  set legendPosition(value: PrintLegendPosition) {\r\n    this.legendPositionField.setValue(value || PrintLegendPosition.none, {\r\n      onlySelf: true\r\n    });\r\n  }\r\n\r\n  @Input()\r\n  get title(): string {\r\n    return this.titleField.value;\r\n  }\r\n  set title(value: string) {\r\n    this.titleField.setValue(value, { onlySelf: true });\r\n  }\r\n  @Input()\r\n  get subtitle(): string {\r\n    return this.subtitleField.value;\r\n  }\r\n  set subtitle(value: string) {\r\n    this.subtitleField.setValue(value, { onlySelf: true });\r\n  }\r\n  @Input()\r\n  get comment(): string {\r\n    return this.commentField.value;\r\n  }\r\n  set comment(value: string) {\r\n    this.commentField.setValue(value, { onlySelf: true });\r\n  }\r\n  @Input()\r\n  get showProjection(): boolean {\r\n    return this.showProjectionField.value;\r\n  }\r\n  set showProjection(value: boolean) {\r\n    this.showProjectionField.setValue(value, { onlySelf: true });\r\n  }\r\n  @Input()\r\n  get showScale(): boolean {\r\n    return this.showScaleField.value;\r\n  }\r\n  set showScale(value: boolean) {\r\n    this.showScaleField.setValue(value, { onlySelf: true });\r\n  }\r\n  @Input()\r\n  get showLegend(): boolean {\r\n    return this.showLegendField.value;\r\n  }\r\n  set showLegend(value: boolean) {\r\n    this.showLegendField.setValue(value, { onlySelf: true });\r\n  }\r\n\r\n  @Input()\r\n  get doZipFile(): boolean {\r\n    return this.doZipFileField.value;\r\n  }\r\n  set doZipFile(value: boolean) {\r\n    this.doZipFileField.setValue(value, { onlySelf: true });\r\n  }\r\n\r\n  get outputFormatField() {\r\n    return (this.form.controls as any).outputFormat as UntypedFormControl;\r\n  }\r\n\r\n  get paperFormatField() {\r\n    return (this.form.controls as any).paperFormat as UntypedFormControl;\r\n  }\r\n\r\n  get imageFormatField() {\r\n    return (this.form.controls as any).imageFormat as UntypedFormControl;\r\n  }\r\n\r\n  get orientationField() {\r\n    return (this.form.controls as any).orientation as UntypedFormControl;\r\n  }\r\n\r\n  get resolutionField() {\r\n    return (this.form.controls as any).resolution as UntypedFormControl;\r\n  }\r\n\r\n  get commentField() {\r\n    return (this.form.controls as any).comment as UntypedFormControl;\r\n  }\r\n\r\n  get showProjectionField() {\r\n    return (this.form.controls as any).showProjection as UntypedFormControl;\r\n  }\r\n\r\n  get showScaleField() {\r\n    return (this.form.controls as any).showScale as UntypedFormControl;\r\n  }\r\n\r\n  get showLegendField() {\r\n    return (this.form.controls as any).showLegend as UntypedFormControl;\r\n  }\r\n\r\n  get doZipFileField() {\r\n    return (this.form.controls as any).doZipFile as UntypedFormControl;\r\n  }\r\n\r\n  get titleField() {\r\n    return (this.form.controls as any).title as UntypedFormControl;\r\n  }\r\n\r\n  get subtitleField() {\r\n    return (this.form.controls as any).subtitle as UntypedFormControl;\r\n  }\r\n\r\n  get legendPositionField() {\r\n    return (this.form.controls as any).legendPosition as UntypedFormControl;\r\n  }\r\n\r\n  @Output() submit: EventEmitter<PrintOptions> = new EventEmitter();\r\n\r\n  constructor(private formBuilder: UntypedFormBuilder) {\r\n    this.form = this.formBuilder.group({\r\n      title: ['', []],\r\n      subtitle: ['', []],\r\n      comment: ['', []],\r\n      outputFormat: ['', [Validators.required]],\r\n      paperFormat: ['', [Validators.required]],\r\n      imageFormat: [ '', [Validators.required]],\r\n      resolution: ['', [Validators.required]],\r\n      orientation: ['', [Validators.required]],\r\n      legendPosition: ['', [Validators.required]],\r\n      showProjection: false,\r\n      showScale: false,\r\n      showLegend: false,\r\n      doZipFile: [{hidden: this.isPrintService }]\r\n    });\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.doZipFileField.setValue(false);\r\n  }\r\n\r\n  handleFormSubmit(data: PrintOptions, isValid: boolean) {\r\n    data.isPrintService = this.isPrintService;\r\n    if (isValid) {\r\n      this.submit.emit(data);\r\n    }\r\n  }\r\n\r\n  toggleImageSaveProp() {\r\n    if (this.outputFormatField.value === 'Image') {\r\n      this.isPrintService = false;\r\n    } else {\r\n      this.isPrintService = true;\r\n    }\r\n  }\r\n}\r\n","import { Component, Input } from '@angular/core';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport { take } from 'rxjs/operators';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { PrintOptions } from '../shared/print.interface';\r\n\r\nimport {\r\n  PrintOutputFormat,\r\n  PrintPaperFormat,\r\n  PrintOrientation,\r\n  PrintResolution,\r\n  PrintSaveImageFormat,\r\n  PrintLegendPosition\r\n} from '../shared/print.type';\r\n\r\nimport { PrintService } from '../shared/print.service';\r\n\r\n@Component({\r\n  selector: 'igo-print',\r\n  templateUrl: './print.component.html'\r\n})\r\nexport class PrintComponent {\r\n  public disabled$ = new BehaviorSubject(false);\r\n\r\n  @Input()\r\n  get map(): IgoMap {\r\n    return this._map;\r\n  }\r\n  set map(value: IgoMap) {\r\n    this._map = value;\r\n  }\r\n  private _map: IgoMap;\r\n\r\n  @Input()\r\n  get outputFormat(): PrintOutputFormat {\r\n    return this._outputFormat;\r\n  }\r\n  set outputFormat(value: PrintOutputFormat) {\r\n    this._outputFormat = value;\r\n  }\r\n  private _outputFormat: PrintOutputFormat;\r\n\r\n  @Input()\r\n  get paperFormat(): PrintPaperFormat {\r\n    return this._paperFormat;\r\n  }\r\n  set paperFormat(value: PrintPaperFormat) {\r\n    this._paperFormat = value;\r\n  }\r\n  private _paperFormat: PrintPaperFormat;\r\n\r\n  @Input()\r\n  get orientation(): PrintOrientation {\r\n    return this._orientation;\r\n  }\r\n  set orientation(value: PrintOrientation) {\r\n    this._orientation = value;\r\n  }\r\n  private _orientation: PrintOrientation;\r\n\r\n  @Input()\r\n  get imageFormat(): PrintSaveImageFormat {\r\n    return this._imageFormat;\r\n  }\r\n  set imageFormat(value: PrintSaveImageFormat) {\r\n    this._imageFormat = value;\r\n  }\r\n  private _imageFormat: PrintSaveImageFormat;\r\n\r\n  @Input()\r\n  get legendPosition(): PrintLegendPosition {\r\n    return this._legendPosition;\r\n  }\r\n  set legendPosition(value: PrintLegendPosition) {\r\n    this._legendPosition = value;\r\n  }\r\n  private _legendPosition: PrintLegendPosition;\r\n\r\n  @Input()\r\n  get resolution(): PrintResolution {\r\n    return this._resolution;\r\n  }\r\n  set resolution(value: PrintResolution) {\r\n    this._resolution = value;\r\n  }\r\n  private _resolution: PrintResolution;\r\n\r\n  constructor(private printService: PrintService) {}\r\n\r\n  handleFormSubmit(data: PrintOptions) {\r\n\r\n    this.disabled$.next(true);\r\n\r\n    if (data.isPrintService === true) {\r\n      this.printService\r\n        .print(this.map, data)\r\n        .pipe(take(1))\r\n        .subscribe(() => {\r\n          this.disabled$.next(false);\r\n        });\r\n    } else {\r\n      let nbFileToProcess = 1;\r\n\r\n      if (data.showLegend) {\r\n        nbFileToProcess++;\r\n      }\r\n      if (data.imageFormat.toLowerCase() === 'tiff') {\r\n        nbFileToProcess++;\r\n      }\r\n\r\n      this.printService.defineNbFileToProcess(nbFileToProcess);\r\n\r\n      const resolution = +data.resolution;\r\n\r\n      let nbRequests = data.showLegend ? 2 : 1;\r\n      this.printService\r\n        .downloadMapImage(\r\n          this.map,\r\n          resolution,\r\n          data.imageFormat,\r\n          data.showProjection,\r\n          data.showScale,\r\n          data.showLegend,\r\n          data.title,\r\n          data.subtitle,\r\n          data.comment,\r\n          data.doZipFile\r\n        )\r\n        .pipe(take(1))\r\n        .subscribe(() => {\r\n          nbRequests--;\r\n          if (!nbRequests) {\r\n            this.disabled$.next(false);\r\n          }\r\n        });\r\n      if (data.showLegend) {\r\n        this.printService\r\n          .getLayersLegendImage(\r\n            this.map,\r\n            data.imageFormat,\r\n            data.doZipFile,\r\n            +resolution\r\n          )\r\n          .then(() => {\r\n            nbRequests--;\r\n            if (!nbRequests) {\r\n              this.disabled$.next(false);\r\n            }\r\n          });\r\n      }\r\n    }\r\n  }\r\n}\r\n","<igo-print-form\r\n  [outputFormat]=\"outputFormat\"\r\n  [paperFormat]=\"paperFormat\"\r\n  [orientation]=\"orientation\"\r\n  [imageFormat]=\"imageFormat\"\r\n  [resolution]=\"resolution\"\r\n  [legendPosition]=\"legendPosition\"\r\n  [disabled$]=\"disabled$\"\r\n  (submit)=\"handleFormSubmit($event)\">\r\n</igo-print-form>\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatOptionModule } from '@angular/material/core';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatSlideToggleModule } from '@angular/material/slide-toggle';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoKeyValueModule } from '@igo2/common';\r\n\r\nimport { PrintComponent } from './print/print.component';\r\nimport { PrintFormComponent } from './print-form/print-form.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatSelectModule,\r\n    MatOptionModule,\r\n    MatInputModule,\r\n    MatFormFieldModule,\r\n    MatSlideToggleModule,\r\n    IgoLanguageModule,\r\n    IgoKeyValueModule\r\n  ],\r\n  exports: [PrintComponent, PrintFormComponent],\r\n  declarations: [PrintComponent, PrintFormComponent]\r\n})\r\nexport class IgoPrintModule {}\r\n","import { ConfigService } from '@igo2/core';\r\n\r\nimport { SearchSource } from '../../search/shared/sources/source';\r\n\r\nimport { QuerySearchSource } from './query-search-source';\r\n\r\n/**\r\n * Map search source factory\r\n * @ignore\r\n */\r\nexport function querySearchSourceFactory(config: ConfigService) {\r\n  return new QuerySearchSource(\r\n    config.getConfig(`searchSources.${QuerySearchSource.id}`) || {}\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the map search source\r\n */\r\nexport function provideQuerySearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: querySearchSourceFactory,\r\n    multi: true,\r\n    deps: [ConfigService]\r\n  };\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoLanguageModule, IgoMessageModule } from '@igo2/core';\r\n\r\nimport { QueryDirective } from './shared/query.directive';\r\nimport { QueryService } from './shared/query.service';\r\nimport { provideQuerySearchSource } from './shared/query-search-source.providers';\r\n\r\n@NgModule({\r\n  imports: [CommonModule, IgoLanguageModule, IgoMessageModule],\r\n  exports: [QueryDirective],\r\n  declarations: [QueryDirective],\r\n  providers: [QueryService]\r\n})\r\nexport class IgoQueryModule {\r\n  static forRoot(): ModuleWithProviders<IgoQueryModule> {\r\n    return {\r\n      ngModule: IgoQueryModule,\r\n      providers: [provideQuerySearchSource()]\r\n    };\r\n  }\r\n}\r\n","import { Observable } from 'rxjs';\r\n\r\n\r\nimport { Direction, DirectionOptions } from '../shared/directions.interface';\r\n\r\nexport abstract class DirectionsSource {\r\n  abstract enabled: boolean;\r\n  abstract getName(): string;\r\n  abstract route(coordinates: [number, number][], directionsOptions: DirectionOptions): Observable<Direction[]>;\r\n}\r\n","import { DirectionsSource } from '../directions-sources/directions-source';\r\n\r\nexport class DirectionsSourceService {\r\n  constructor(public sources: DirectionsSource[]) {}\r\n}\r\n\r\nexport function directionsSourceServiceFactory(sources: DirectionsSource[]) {\r\n  return new DirectionsSourceService(sources);\r\n}\r\n\r\nexport function provideDirectionsSourceService() {\r\n  return {\r\n    provide: DirectionsSourceService,\r\n    useFactory: directionsSourceServiceFactory,\r\n    deps: [DirectionsSource]\r\n  };\r\n}\r\n","export enum DirectionsFormat {\r\n  GeoJSON,\r\n  JSON\r\n}\r\nexport enum SourceDirectionsType {\r\n  Route = 'route',\r\n  Trip = 'trip'\r\n}\r\n\r\nexport enum ProposalType {\r\n  Coord = 'coord',\r\n  Text = 'text'\r\n}\r\n\r\nexport enum DirectionType {\r\n  Stop = 'stop',\r\n  Route = 'route',\r\n  Vertex = 'vertex'\r\n}\r\n\r\nexport enum DirectionRelativePositionType {\r\n  Start = 'start',\r\n  Intermediate = 'intermediate',\r\n  End = 'end'\r\n}\r\n","import olFeature from 'ol/Feature';\r\nimport * as olStyle from 'ol/style';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport * as olGeom from 'ol/geom';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport * as olProj from 'ol/proj';\r\n\r\nimport { uuid, NumberUtils } from '@igo2/utils';\r\n\r\nimport { Direction, FeatureWithDirection, FeatureWithStop, Stop } from './directions.interface';\r\nimport { createOverlayMarkerStyle } from '../../overlay/shared/overlay-marker-style.utils';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { tryBindStoreLayer } from '../../feature/shared/feature.utils';\r\nimport { tryAddLoadingStrategy } from '../../feature/shared/strategies.utils';\r\nimport { FeatureStoreLoadingStrategy } from '../../feature/shared/strategies/loading';\r\nimport { FEATURE, FeatureMotion } from '../../feature/shared/feature.enums';\r\nimport { LanguageService } from '@igo2/core';\r\nimport { FeatureGeometry } from '../../feature/shared/feature.interfaces';\r\nimport { DirectionRelativePositionType, DirectionType } from './directions.enum';\r\nimport { RoutesFeatureStore, StepFeatureStore, StopsFeatureStore, StopsStore } from './store';\r\n\r\n/**\r\n * Function that updat the sort of the list base on the provided field.\r\n * @param source stop store\r\n * @param direction asc / desc sort order\r\n * @param field the field to use to sort the view\r\n */\r\nexport function updateStoreSorting(stopsStore: StopsStore, direction: 'asc' | 'desc' = 'asc', field = 'position') {\r\n  stopsStore.view.sort({\r\n    direction,\r\n    valueAccessor: (entity: Stop) => entity[field]\r\n  });\r\n}\r\n\r\nexport function computeRelativePosition(index: number, totalLength): DirectionRelativePositionType {\r\n  let relativePosition = DirectionRelativePositionType.Intermediate;\r\n  if (index === 0) {\r\n    relativePosition = DirectionRelativePositionType.Start;\r\n  } else if (index === totalLength - 1) {\r\n    relativePosition = DirectionRelativePositionType.End;\r\n  }\r\n  return relativePosition;\r\n}\r\n\r\nexport function computeStopsPosition(stopsStore: StopsStore) {\r\n\r\n  const stopsToComputePosition = [...stopsStore.all()];\r\n  stopsToComputePosition.sort((a, b) => a.position - b.position);\r\n  stopsToComputePosition.map((stop, i) => {\r\n    stop.position = i;\r\n    stop.relativePosition = computeRelativePosition(stop.position, stopsToComputePosition.length);\r\n  });\r\n  if (stopsToComputePosition) {\r\n    stopsStore.updateMany(stopsToComputePosition);\r\n  }\r\n}\r\n\r\n/**\r\n * Function that add a stop to the stop store. Stop are always added before the last stop.\r\n * @param stopsStore stop store as an EntityStore\r\n */\r\nexport function addStopToStore(stopsStore: StopsStore): Stop {\r\n\r\n  const id = uuid();\r\n  const stops = stopsStore.all();\r\n  let positions: number[];\r\n  if (stopsStore.count === 0) {\r\n    positions = [0];\r\n  } else {\r\n    positions = stops.map(stop => stop.position);\r\n  }\r\n  const maxPosition: number = Math.max(...positions);\r\n  const insertPosition: number = maxPosition;\r\n  const lastPosition: number = maxPosition + 1;\r\n\r\n  const stopToUpdate = stopsStore.all().find(stop => stop.position === maxPosition);\r\n  if (stopToUpdate) {\r\n    stopToUpdate.position = lastPosition;\r\n    stopToUpdate.relativePosition = computeRelativePosition(lastPosition, stopsStore.count + 1);\r\n  }\r\n\r\n  stopsStore.insert({ id, position: insertPosition, relativePosition: computeRelativePosition(insertPosition, stopsStore.count + 1) });\r\n\r\n  updateStoreSorting(stopsStore);\r\n  return stopsStore.get(id);\r\n}\r\n\r\nexport function removeStopFromStore(stopsStore: StopsStore, stop: Stop) {\r\n  stopsStore.delete(stop);\r\n  computeStopsPosition(stopsStore);\r\n}\r\n\r\n/**\r\n * Create a style for the directions stops and routes\r\n * @param feature OlFeature\r\n * @returns OL style function\r\n */\r\nexport function directionsStyle(\r\n  feature: olFeature<OlGeometry>,\r\n  resolution: number\r\n): olStyle.Style | olStyle.Style[] {\r\n  const vertexStyle = [\r\n    new olStyle.Style({\r\n      geometry: feature.getGeometry(),\r\n      image: new olStyle.Circle({\r\n        radius: 7,\r\n        stroke: new olStyle.Stroke({ color: '#FF0000', width: 3 })\r\n      })\r\n    })\r\n  ];\r\n\r\n  const stopStyle = createOverlayMarkerStyle({\r\n    text: feature.get('stopText'),\r\n    opacity: feature.get('stopOpacity'),\r\n    markerColor: feature.get('stopColor'),\r\n    markerOutlineColor: [255, 255, 255]\r\n  });\r\n\r\n  const routeStyle = [\r\n    new olStyle.Style({\r\n      stroke: new olStyle.Stroke({ color: `rgba(106, 121, 130, ${feature.get('active') ? 0.75 : 0})`, width: 10 })\r\n    }),\r\n    new olStyle.Style({\r\n      stroke: new olStyle.Stroke({ color: `rgba(79, 169, 221, ${feature.get('active') ? 0.75 : 0})`, width: 6 })\r\n    })\r\n  ];\r\n\r\n  if (feature.get('type') === DirectionType.Stop) {\r\n    return stopStyle;\r\n  }\r\n  if (feature.get('type') === 'vertex') {\r\n    return vertexStyle;\r\n  }\r\n  if (feature.get('type') === DirectionType.Route) {\r\n    return routeStyle;\r\n  }\r\n}\r\n\r\nexport function initStopsFeatureStore(stopsFeatureStore: StopsFeatureStore, languageService: LanguageService) {\r\n  const loadingStrategy = new FeatureStoreLoadingStrategy({\r\n    motion: FeatureMotion.None\r\n  });\r\n\r\n  const stopsLayer = new VectorLayer({\r\n    isIgoInternalLayer: true,\r\n    id: 'igo-direction-stops-layer',\r\n    title: languageService.translate.instant('igo.geo.directionsForm.stopLayer'),\r\n    zIndex: 911,\r\n    source: new FeatureDataSource(),\r\n    showInLayerList: true,\r\n    workspace: {\r\n      enabled: false,\r\n    },\r\n    linkedLayers: {\r\n      linkId: 'igo-direction-stops-layer',\r\n      links: [\r\n        {\r\n          syncedDelete: true,\r\n          linkedIds: ['igo-direction-route-layer'],\r\n          properties: []\r\n        }\r\n      ]\r\n    },\r\n    exportable: true,\r\n    browsable: false,\r\n    style: directionsStyle\r\n  });\r\n  tryBindStoreLayer(stopsFeatureStore, stopsLayer);\r\n  stopsFeatureStore.layer.visible = true;\r\n  tryAddLoadingStrategy(stopsFeatureStore, loadingStrategy);\r\n}\r\n\r\nexport function initRoutesFeatureStore(routesFeatureStore: RoutesFeatureStore, languageService: LanguageService) {\r\n  const loadingStrategy = new FeatureStoreLoadingStrategy({\r\n    motion: FeatureMotion.None\r\n  });\r\n\r\n  const routeLayer = new VectorLayer({\r\n    isIgoInternalLayer: true,\r\n    id: 'igo-direction-route-layer',\r\n    title: languageService.translate.instant('igo.geo.directionsForm.routeLayer'),\r\n    zIndex: 910,\r\n    source: new FeatureDataSource(),\r\n    showInLayerList: true,\r\n    workspace: {\r\n      enabled: false,\r\n    },\r\n    linkedLayers: {\r\n      linkId: 'igo-direction-route-layer'\r\n    },\r\n    exportable: true,\r\n    browsable: false,\r\n    style: directionsStyle\r\n  });\r\n  tryBindStoreLayer(routesFeatureStore, routeLayer);\r\n  routesFeatureStore.layer.visible = true;\r\n  tryAddLoadingStrategy(routesFeatureStore, loadingStrategy);\r\n}\r\n\r\nexport function initStepFeatureStore(stepFeatureStore: StepFeatureStore) {\r\n  const loadingStrategy = new FeatureStoreLoadingStrategy({\r\n    motion: FeatureMotion.None\r\n  });\r\n\r\n  const stepLayer = new VectorLayer({\r\n    isIgoInternalLayer: true,\r\n    id: 'igo-direction-step-layer',\r\n    title: '',\r\n    zIndex: 910,\r\n    source: new FeatureDataSource(),\r\n    showInLayerList: false,\r\n    workspace: {\r\n      enabled: false,\r\n    },\r\n    linkedLayers: {\r\n      linkId: 'igo-direction-route-layer'\r\n    },\r\n    exportable: false,\r\n    browsable: false,\r\n    style: directionsStyle\r\n  });\r\n  tryBindStoreLayer(stepFeatureStore, stepLayer);\r\n  stepFeatureStore.layer.visible = true;\r\n  tryAddLoadingStrategy(stepFeatureStore, loadingStrategy);\r\n}\r\n\r\n\r\nexport function addStopToStopsFeatureStore(\r\n  stop: Stop,\r\n  stopsStore: StopsStore,\r\n  stopsFeatureStore: StopsFeatureStore,\r\n  projection: string,\r\n  languageService: LanguageService) {\r\n  let stopColor;\r\n  let stopText;\r\n\r\n\r\n  switch (stop.relativePosition) {\r\n    case DirectionRelativePositionType.Start:\r\n      stopColor = '#008000';\r\n      stopText = languageService.translate.instant('igo.geo.directionsForm.start');\r\n      break;\r\n    case DirectionRelativePositionType.End:\r\n      stopColor = '#f64139';\r\n      stopText = languageService.translate.instant('igo.geo.directionsForm.end');\r\n      break;\r\n    default:\r\n      stopColor = '#ffd700';\r\n      stopText = languageService.translate.instant('igo.geo.directionsForm.intermediate') + ' #' + stop.position;\r\n      break;\r\n  }\r\n\r\n  const geometry = new olGeom.Point(\r\n    olProj.transform(stop.coordinates, projection, stopsFeatureStore.map.projection)\r\n  );\r\n\r\n  const geojsonGeom = new OlGeoJSON().writeGeometryObject(geometry, {\r\n    featureProjection: stopsFeatureStore.map.projection,\r\n    dataProjection: stopsFeatureStore.map.projection\r\n  }) as FeatureGeometry;\r\n\r\n  const previousStop = stopsFeatureStore.get(stop.id);\r\n  const previousStopRevision = previousStop ? previousStop.meta.revision : 0;\r\n\r\n  const stopFeatureStore: FeatureWithStop = {\r\n    type: FEATURE,\r\n    geometry: geojsonGeom,\r\n    projection: stopsFeatureStore.map.projection,\r\n    properties: {\r\n      id: stop.id,\r\n      type: DirectionType.Stop,\r\n      stopText,\r\n      stopColor,\r\n      stopOpacity: 1,\r\n      stop\r\n    },\r\n    meta: {\r\n      id: stop.id,\r\n      revision: previousStopRevision + 1\r\n    },\r\n    ol: new olFeature({ geometry })\r\n  };\r\n  stopsFeatureStore.update(stopFeatureStore);\r\n}\r\n\r\nexport function addDirectionToRoutesFeatureStore(\r\n  routesFeatureStore: RoutesFeatureStore,\r\n  direction: Direction,\r\n  projection: string,\r\n  active: boolean = false,\r\n  moveToExtent = false) {\r\n  const geom = direction.geometry.coordinates;\r\n  const geometry4326 = new olGeom.LineString(geom);\r\n  const geometry = geometry4326.transform(\r\n    projection,\r\n    routesFeatureStore.map.projection\r\n  );\r\n\r\n  const geojsonGeom = new OlGeoJSON().writeGeometryObject(geometry, {\r\n    featureProjection: routesFeatureStore.map.projection,\r\n    dataProjection: routesFeatureStore.map.projection\r\n  }) as FeatureGeometry;\r\n\r\n\r\n  const previousRoute = routesFeatureStore.get(direction.id);\r\n  const previousRouteRevision = previousRoute\r\n    ? previousRoute.meta.revision\r\n    : 0;\r\n\r\n  const routeFeatureStore: FeatureWithDirection = {\r\n    type: FEATURE,\r\n    geometry: geojsonGeom,\r\n    projection: routesFeatureStore.map.projection,\r\n    properties: {\r\n      id: direction.id,\r\n      type: DirectionType.Route,\r\n      active,\r\n      direction\r\n    },\r\n    meta: {\r\n      id: direction.id,\r\n      revision: previousRouteRevision + 1\r\n    },\r\n    ol: new olFeature({ geometry })\r\n  };\r\n  routesFeatureStore.update(routeFeatureStore);\r\n}\r\n\r\nexport function formatDistance(distance: number): string {\r\n  if (distance === 0) {\r\n    return;\r\n  }\r\n  if (distance >= 100000) {\r\n    return NumberUtils.roundToNDecimal(Math.round(distance) / 1000, 1) + ' km';\r\n  }\r\n  if (distance >= 10000) {\r\n    return NumberUtils.roundToNDecimal(Math.round(distance) / 100 / 10, 1) + ' km';\r\n  }\r\n  if (distance >= 1000) {\r\n    return NumberUtils.roundToNDecimal(Math.round(distance) / 100 / 10, 1) + ' km';\r\n  }\r\n  return NumberUtils.roundToNDecimal(distance, 0) + ' m';\r\n}\r\n\r\nexport function formatDuration(duration: number): string {\r\n  if (duration >= 3600) {\r\n    const hour = Math.floor(duration / 3600);\r\n    const minute = Math.round((duration / 3600 - hour) * 60);\r\n    if (minute === 60) {\r\n      return hour + 1 + ' h';\r\n    }\r\n    return hour + ' h ' + minute + ' min';\r\n  }\r\n\r\n  if (duration >= 60) {\r\n    return Math.round(duration / 60) + ' min';\r\n  }\r\n  return duration + ' s';\r\n}\r\n\r\nexport function formatInstruction(\r\n  type,\r\n  modifier,\r\n  route,\r\n  direction,\r\n  stepPosition,\r\n  exit,\r\n  languageService: LanguageService,\r\n  lastStep = false\r\n) {\r\n  const translate = languageService.translate;\r\n  let directive;\r\n  let image = 'forward';\r\n  let cssClass = 'rotate-270';\r\n  const translatedDirection = translateBearing(direction, languageService);\r\n  const translatedModifier = translateModifier(modifier, languageService);\r\n  const prefix = modifier === 'straight' ? '' : translate.instant('igo.geo.directions.modifier.prefix');\r\n\r\n  let aggregatedDirection = prefix + translatedModifier;\r\n\r\n\r\n  if (modifier?.search('slight') >= 0) {\r\n    aggregatedDirection = translatedModifier;\r\n  }\r\n\r\n  if (modifier === 'uturn') {\r\n    image = 'forward';\r\n    cssClass = 'rotate-90';\r\n  } else if (modifier === 'sharp right') {\r\n    image = 'subdirectory-arrow-right';\r\n    cssClass = 'icon-flipped';\r\n  } else if (modifier === 'right') {\r\n    image = 'subdirectory-arrow-right';\r\n    cssClass = 'icon-flipped';\r\n  } else if (modifier === 'slight right') {\r\n    image = 'forward';\r\n    cssClass = 'rotate-290';\r\n  } else if (modifier === 'straight') {\r\n    image = 'forward';\r\n  } else if (modifier === 'slight left') {\r\n    image = 'forward';\r\n    cssClass = 'rotate-250';\r\n  } else if (modifier === 'left') {\r\n    image = 'subdirectory-arrow-left';\r\n    cssClass = 'icon-flipped';\r\n  } else if (modifier === 'sharp left') {\r\n    image = 'subdirectory-arrow-left';\r\n    cssClass = 'icon-flipped';\r\n  }\r\n\r\n  if (type === 'turn') {\r\n    if (modifier === 'straight') {\r\n      directive = translate.instant('igo.geo.directions.turn.straight', { route });\r\n    } else if (modifier === 'uturn') {\r\n      directive = translate.instant('igo.geo.directions.turn.uturn', { route });\r\n    } else {\r\n      directive = translate.instant('igo.geo.directions.turn.else', { route, aggregatedDirection, translatedModifier });\r\n    }\r\n  } else if (type === 'new name') {\r\n    directive = translate.instant('igo.geo.directions.new name', { route, translatedDirection });\r\n    image = 'compass';\r\n    cssClass = '';\r\n  } else if (type === 'depart') {\r\n    directive = translate.instant('igo.geo.directions.depart', { route, translatedDirection });\r\n    image = 'compass';\r\n    cssClass = '';\r\n  } else if (type === 'arrive') {\r\n    if (lastStep) {\r\n      const coma = !translatedModifier ? '' : ', ';\r\n      aggregatedDirection = !translatedModifier ? '' : aggregatedDirection;\r\n      directive = translate.instant('igo.geo.directions.arrive.lastStep', { coma, aggregatedDirection });\r\n    } else {\r\n      directive = translate.instant('igo.geo.directions.arrive.intermediate', { route });\r\n      image = 'map-marker';\r\n      cssClass = '';\r\n    }\r\n  } else if (type === 'merge') {\r\n    directive = translate.instant('igo.geo.directions.merge', { route });\r\n    image = 'forward';\r\n    cssClass = 'rotate-270';\r\n  } else if (type === 'on ramp') {\r\n    directive = translate.instant('igo.geo.directions.on ramp', { aggregatedDirection });\r\n  } else if (type === 'off ramp') {\r\n    directive = translate.instant('igo.geo.directions.off ramp', { aggregatedDirection });\r\n  } else if (type === 'fork') {\r\n    if (modifier.search('left') >= 0) {\r\n      directive = translate.instant('igo.geo.directions.fork.left', { route });\r\n    } else if (modifier.search('right') >= 0) {\r\n      directive = translate.instant('igo.geo.directions.fork.right', { route });\r\n    } else {\r\n      directive = translate.instant('igo.geo.directions.fork.else', { route });\r\n    }\r\n  } else if (type === 'end of road') {\r\n    directive = translate.instant('igo.geo.directions.end of road', { translatedModifier, route });\r\n  } else if (type === 'use lane') {\r\n    directive = translate.instant('igo.geo.directions.use lane');\r\n  } else if (type === 'continue' && modifier !== 'uturn') {\r\n    directive = translate.instant('igo.geo.directions.continue.notUturn', { route });\r\n    image = 'forward';\r\n    cssClass = 'rotate-270';\r\n  } else if (type === 'roundabout') {\r\n    const cntSuffix = exit === 1 ?\r\n      translate.instant('igo.geo.directions.cntSuffix.first') :\r\n      translate.instant('igo.geo.directions.cntSuffix.secondAndMore');\r\n    directive = translate.instant('igo.geo.directions.roundabout', { exit, cntSuffix, route });\r\n    image = 'chart-donut';\r\n    cssClass = '';\r\n  } else if (type === 'rotary') {\r\n    directive = translate.instant('igo.geo.directions.rotary');\r\n    image = 'chart-donut';\r\n    cssClass = '';\r\n  } else if (type === 'roundabout turn') {\r\n    directive = translate.instant('igo.geo.directions.roundabout turn');\r\n    image = 'chart-donut';\r\n    cssClass = '';\r\n  } else if (type === 'exit roundabout') {\r\n    directive = translate.instant('igo.geo.directions.exit roundabout', { route });\r\n    image = 'forward';\r\n    cssClass = 'rotate-270';\r\n  } else if (type === 'notification') {\r\n    directive = translate.instant('igo.geo.directions.notification');\r\n  } else if (modifier === 'uturn') {\r\n    directive = translate.instant('igo.geo.directions.uturnText', { translatedDirection, route });\r\n  } else {\r\n    directive = translate.instant('igo.geo.directions.unknown');\r\n  }\r\n\r\n  image = lastStep ? 'flag-variant' : image;\r\n  cssClass = lastStep ? '' : cssClass;\r\n  image = stepPosition === 0 ? 'compass' : image;\r\n  cssClass = stepPosition === 0 ? '' : cssClass;\r\n\r\n  return { instruction: directive, image, cssClass };\r\n}\r\n\r\nexport function translateModifier(modifier, languageService: LanguageService) {\r\n  const translate = languageService.translate;\r\n  if (modifier === 'uturn') {\r\n    return translate.instant('igo.geo.directions.uturn');\r\n  } else if (modifier === 'sharp right') {\r\n    return translate.instant('igo.geo.directions.sharp right');\r\n  } else if (modifier === 'right') {\r\n    return translate.instant('igo.geo.directions.right');\r\n  } else if (modifier === 'slight right') {\r\n    return translate.instant('igo.geo.directions.slight right');\r\n  } else if (modifier === 'sharp left') {\r\n    return languageService.translate.instant('igo.geo.directions.sharp left');\r\n  } else if (modifier === 'left') {\r\n    return languageService.translate.instant('igo.geo.directions.left');\r\n  } else if (modifier === 'slight left') {\r\n    return languageService.translate.instant('igo.geo.directions.slight left');\r\n  } else if (modifier === 'straight') {\r\n    return languageService.translate.instant('igo.geo.directions.straight');\r\n  } else {\r\n    return modifier;\r\n  }\r\n}\r\n\r\nexport function translateBearing(bearing: number, languageService: LanguageService) {\r\n  const translate = languageService.translate;\r\n  if (bearing >= 337 || bearing < 23) {\r\n    return translate.instant('igo.geo.cardinalPoints.n');\r\n  } else if (bearing < 67) {\r\n    return translate.instant('igo.geo.cardinalPoints.ne');\r\n  } else if (bearing < 113) {\r\n    return translate.instant('igo.geo.cardinalPoints.e');\r\n  } else if (bearing < 157) {\r\n    return translate.instant('igo.geo.cardinalPoints.se');\r\n  } else if (bearing < 203) {\r\n    return translate.instant('igo.geo.cardinalPoints.s');\r\n  } else if (bearing < 247) {\r\n    return translate.instant('igo.geo.cardinalPoints.sw');\r\n  } else if (bearing < 293) {\r\n    return translate.instant('igo.geo.cardinalPoints.w');\r\n  } else if (bearing < 337) {\r\n    return translate.instant('igo.geo.cardinalPoints.nw');\r\n  } else {\r\n    return;\r\n  }\r\n}\r\n\r\n\r\n","<div cdkDropList class=\"stops-list\" (cdkDropListDropped)=\"drop($event)\">\r\n  <div touchleave  \r\n  (touchenter)=\"onStopEnter(stop)\"\r\n  (touchleave)=\"onStopLeave()\"\r\n  (mouseover)=\"onStopEnter(stop)\"\r\n  (mouseleave)=\"onStopLeave()\"\r\n  (cdkDragStarted)=\"stopIsDragged=true\"\r\n  (cdkDragEnded)=\"stopIsDragged=false\"\r\n  cdkDragLockAxis=\"y\" class=\"stop-box mat-typography\" *ngFor=\"let stop of stopsStore.view.all$() | async; let i = index;\" cdkDrag>\r\n    <div [ngClass]=\"getNgClass(stop)\">\r\n      <mat-form-field>\r\n        <input id=\"{{stop.id}}\" type=\"text\"\r\n            [placeholder]=\"getPlaceholder(stop)\"\r\n            matTooltipShowDelay=\"500\"\r\n            [matTooltip]=\"stop.text\"\r\n            aria-label=\"Number\"\r\n            matInput\r\n            (focus)=\"onInputFocus(stop)\"\r\n            [(ngModel)]=\"stop.text\"\r\n            (keyup)=\"setStopText($event,stop)\"\r\n            (keydown.enter)=\"$event.preventDefault()\"\r\n            [matAutocomplete]=\"auto\">\r\n        <button \r\n            mat-button \r\n            *ngIf=\"(stop.text || stop.coordinates) && stopWithHover && stop.id===stopWithHover.id\"\r\n            matTooltipShowDelay=\"500\"\r\n            [matTooltip]=\"'igo.geo.directionsForm.clearStop' | translate\"\r\n            matSuffix mat-icon-button color=\"warn\" aria-label=\"Clear\" (click)=\"clearStop(stop)\">\r\n            <mat-icon svgIcon=\"close\"></mat-icon>\r\n        </button>\r\n      \r\n        <mat-autocomplete [displayWith]=\"getOptionText\" #auto=\"matAutocomplete\" (optionSelected)=\"chooseProposal($event,stop)\">\r\n          <mat-optgroup *ngFor=\"let source of stop.searchProposals\" [label]=\"source.source.title\" [disabled]=\"source.source.enabled === false\">\r\n          <mat-option *ngFor=\"let result of source.results\" [value]=\"result\" \r\n          matTooltipShowDelay=\"500\" [matTooltip]=\"result.meta ? result.meta.title : ''\">\r\n            {{ result.meta ? result.meta.title : '' }}\r\n          </mat-option>\r\n          </mat-optgroup>\r\n        </mat-autocomplete>\r\n      </mat-form-field>\r\n    </div>\r\n\r\n\r\n\r\n\r\n    <div class=\"igo-form-button-group\" *ngIf=\"!stopIsDragged && stopWithHover && stop.id === stopWithHover.id\">\r\n      <button class=\"swipe-vertical\" cdkDragHandle mat-icon-button tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.geo.directionsForm.moveStop' | translate\" color=\"primary\">\r\n        <mat-icon svgIcon=\"gesture-swipe-vertical\"></mat-icon>\r\n      </button>\r\n\r\n      <button *ngIf=\"(stopsStore.count$ | async)> 2\" mat-icon-button tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.geo.directionsForm.removeStop' | translate\" color=\"warn\" (click)=\"removeStop(stop)\">\r\n        <mat-icon svgIcon=\"delete\"></mat-icon>\r\n      </button>\r\n      <button *ngIf=\"(stopsStore.count$ | async)<= 2\" disabled=\"true\" mat-icon-button tooltip-position=\"below\"\r\n        matTooltipShowDelay=\"500\" [matTooltip]=\"'igo.geo.directionsForm.removeStop' | translate\" color=\"warn\">\r\n        <mat-icon svgIcon=\"blank\"></mat-icon>\r\n      </button>\r\n    </div>\r\n  </div>\r\n</div>","import { Component, EventEmitter, Input, OnDestroy, Output } from '@angular/core';\r\nimport { CdkDragDrop, moveItemInArray } from '@angular/cdk/drag-drop';\r\n\r\nimport * as olProj from 'ol/proj';\r\nimport * as olObservable from 'ol/Observable';\r\n\r\nimport { Stop } from '../shared/directions.interface';\r\n\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport pointOnFeature from '@turf/point-on-feature';\r\nimport { computeRelativePosition, removeStopFromStore, updateStoreSorting } from '../shared/directions.utils';\r\nimport { MatAutocomplete } from '@angular/material/autocomplete';\r\nimport { MatOption } from '@angular/material/core';\r\nimport { StopsFeatureStore, StopsStore } from '../shared/store';\r\nimport { roundCoordTo } from '../../map/shared/map.utils';\r\nimport { LanguageService } from '@igo2/core';\r\nimport { DirectionRelativePositionType } from '../shared/directions.enum';\r\n\r\n@Component({\r\n  selector: 'igo-directions-inputs',\r\n  templateUrl: './directions-inputs.component.html',\r\n  styleUrls: ['./directions-inputs.component.scss']\r\n})\r\nexport class DirectionsInputsComponent implements OnDestroy {\r\n\r\n  private readonly invalidKeys = ['Control', 'Shift', 'Alt'];\r\n  private onMapClickEventKeys = [];\r\n  public stopWithHover: Stop;\r\n  public stopIsDragged: boolean = false;\r\n  @Input() stopsStore: StopsStore;\r\n  @Input() stopsFeatureStore: StopsFeatureStore;\r\n  @Input() projection: string;\r\n  @Input() coordRoundedDecimals: number = 6;\r\n\r\n  @Input() debounce: number = 200;\r\n  @Input() length: number = 2;\r\n\r\n  @Output() stopInputHasFocus: EventEmitter<boolean> = new EventEmitter<boolean>(false);\r\n  constructor(private languageService: LanguageService) { }\r\n\r\n  ngOnDestroy(): void {\r\n    this.unlistenMapSingleClick();\r\n  }\r\n  onStopEnter(stop: Stop) {\r\n    this.stopWithHover = stop;\r\n  }\r\n  onStopLeave() {\r\n    this.stopWithHover = undefined;\r\n  }\r\n\r\n  getOptionText(option) {\r\n    if (option instanceof Object) {\r\n      return option?.meta ? option.meta.title : '';\r\n    }\r\n    return option;\r\n  }\r\n\r\n  chooseProposal(event: { source: MatAutocomplete, option: MatOption }, stop: Stop) {\r\n    const result: Feature = event.option.value;\r\n    if (result) {\r\n      let geomCoord;\r\n      const geom = result.geometry;\r\n      if (geom.type === 'Point') {\r\n        geomCoord = geom.coordinates;\r\n      } else {\r\n        const point = pointOnFeature(result.geometry);\r\n        geomCoord = [\r\n          point.geometry.coordinates[0],\r\n          point.geometry.coordinates[1]\r\n        ];\r\n      }\r\n      if (geomCoord) {\r\n        stop.coordinates = geomCoord;\r\n        stop.text = result.meta.title;\r\n        this.stopsStore.update(stop);\r\n      }\r\n    }\r\n  }\r\n\r\n  setStopText(event: KeyboardEvent, stop: Stop) {\r\n    this.unlistenMapSingleClick();\r\n    const term = (event.target as HTMLInputElement).value;\r\n    if (term.length === 0) {\r\n      this.clearStop(stop);\r\n    } else if (this.validateTerm(term)) {\r\n      stop.text = term;\r\n      this.stopsStore.update(stop);\r\n    }\r\n  }\r\n\r\n  validateTerm(term: string) {\r\n    if (\r\n      this.keyIsValid(term) &&\r\n      (term.length >= this.length || term.length === 0)\r\n    ) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  private keyIsValid(key: string) {\r\n    return this.invalidKeys.find(value => value === key) === undefined;\r\n  }\r\n\r\n  getNgClass(stop: Stop): string {\r\n    if (!this.stopWithHover) {\r\n      return 'igo-input-container';\r\n    } else if (stop.id === this.stopWithHover.id) {\r\n      return 'igo-input-container reduce';\r\n    } else {\r\n      return 'igo-input-container';\r\n    }\r\n  }\r\n\r\n  getPlaceholder(stop: Stop): string {\r\n    let extra = '';\r\n    if (stop.relativePosition) {\r\n      if (stop.relativePosition === DirectionRelativePositionType.Intermediate) {\r\n        extra = ' #' + stop.position;\r\n      }\r\n      return this.languageService.translate.instant('igo.geo.directionsForm.' + stop.relativePosition) + extra;\r\n    } else {\r\n      return '';\r\n    }\r\n  }\r\n\r\n  removeStop(stop: Stop) {\r\n    removeStopFromStore(this.stopsStore, stop);\r\n  }\r\n\r\n  clearStop(stop: Stop) {\r\n    this.stopsStore.update({ id: stop.id, relativePosition: stop.relativePosition, position: stop.position });\r\n  }\r\n\r\n  drop(event: CdkDragDrop<string[]>) {\r\n    this.moveStops(event.previousIndex, event.currentIndex);\r\n  }\r\n\r\n  private moveStops(fromIndex, toIndex) {\r\n    if (fromIndex !== toIndex) {\r\n      const stops = [...this.stopsStore.view.all()];\r\n      moveItemInArray(stops, fromIndex, toIndex);\r\n      stops.map((stop, i) => {\r\n        stop.relativePosition = computeRelativePosition(i, stops.length);\r\n        stop.position = i;\r\n      });\r\n      this.stopsStore.updateMany(stops);\r\n      updateStoreSorting(this.stopsStore);\r\n    }\r\n  }\r\n\r\n  onInputFocus(stop: Stop) {\r\n    if (!stop.text || stop.text?.length === 0) {\r\n      this.unlistenMapSingleClick();\r\n      this.stopInputHasFocus.emit(true);\r\n      this.listenMapSingleClick(stop);\r\n    }\r\n  }\r\n\r\n  private listenMapSingleClick(stop: Stop) {\r\n    const key = this.stopsFeatureStore.layer.map.ol.once('singleclick', event => {\r\n      const clickCoordinates = olProj.transform(\r\n        event.coordinate,\r\n        this.stopsFeatureStore.layer.map.projection,\r\n        this.projection\r\n      );\r\n      const roundedCoord = roundCoordTo(clickCoordinates as [number, number], this.coordRoundedDecimals);\r\n      stop.text = roundedCoord.join(',');\r\n      stop.coordinates = roundedCoord;\r\n      this.stopsStore.update(stop);\r\n      setTimeout(() => {\r\n        this.stopInputHasFocus.emit(false);\r\n      }, 500);\r\n    });\r\n    this.onMapClickEventKeys.push(key);\r\n  }\r\n\r\n  private unlistenMapSingleClick() {\r\n    this.onMapClickEventKeys.map(key => {\r\n      olObservable.unByKey(key);\r\n    });\r\n    this.onMapClickEventKeys = [];\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { Observable } from 'rxjs';\r\n\r\n\r\nimport { Direction, DirectionOptions } from '../shared/directions.interface';\r\nimport { DirectionsSource } from '../directions-sources/directions-source';\r\nimport { DirectionsSourceService } from './directions-source.service';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class DirectionsService {\r\n  constructor(private directionsSourceService: DirectionsSourceService) {}\r\n\r\n  route(coordinates: [number, number][], directionsOptions: DirectionOptions = {}): Observable<Direction[]>[] {\r\n    if (coordinates.length === 0) {\r\n      return;\r\n    }\r\n    return this.directionsSourceService.sources\r\n      .filter((source: DirectionsSource) => source.enabled)\r\n      .map((source: DirectionsSource) => this.routeSource(source, coordinates, directionsOptions));\r\n  }\r\n\r\n  routeSource(\r\n    source: DirectionsSource,\r\n    coordinates: [number, number][],\r\n    directionsOptions: DirectionOptions = {}\r\n  ): Observable<Direction[]> {\r\n    const request = source.route(coordinates, directionsOptions );\r\n    return request;\r\n  }\r\n}\r\n","import { FEATURE } from '../../feature/shared/feature.enums';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport { SearchSource } from './sources/source';\r\nimport { SearchResult } from './search.interfaces';\r\n\r\n/**\r\n * Function that checks whether a search source implements TextSearch\r\n * @param source Search source\r\n * @returns True if the search source implements TextSearch\r\n */\r\nexport function sourceCanSearch(source: SearchSource): boolean {\r\n  return (source as any).search !== undefined;\r\n}\r\n\r\n/**\r\n * Function that checks whether a search source implements ReverseSearch\r\n * @param source Search source\r\n * @returns True if the search source implements ReverseSearch\r\n */\r\nexport function sourceCanReverseSearch(source: SearchSource): boolean {\r\n  return (source as any).reverseSearch !== undefined;\r\n}\r\n\r\n/**\r\n * Function that checks whether a search source implements ReverseSearch AND is shown in the pointer summary\r\n * @param source Search source\r\n * @returns True if the search source implements ReverseSearch AND is shown in the pointer summary\r\n */\r\nexport function sourceCanReverseSearchAsSummary(source: SearchSource): boolean {\r\n  return (source as any).reverseSearch !== undefined && source.showInPointerSummary === true;\r\n}\r\n\r\n/**\r\n * Return a search result out of an Feature. This is used to adapt\r\n * the IGO query module to the new Feature/SearchResult interfaces\r\n * @param feature feature\r\n * @param source Search source\r\n * @returns SearchResult\r\n */\r\nexport function featureToSearchResult(\r\n  feature: Feature,\r\n  source: SearchSource\r\n): SearchResult<Feature> {\r\n  if (feature.properties) {\r\n    delete feature.properties.geometry;\r\n    delete feature.properties.GEOMETRIE;\r\n    delete feature.properties.boundedBy;\r\n    delete feature.properties.shape;\r\n    delete feature.properties.SHAPE;\r\n    delete feature.properties.SHAPE_S;\r\n    delete feature.properties.SHAPE_L;\r\n    delete feature.properties.SHAPE_P;\r\n    delete feature.properties.the_geom;\r\n    delete feature.properties.geom;\r\n  }\r\n  feature.sourceId = source.getId();\r\n  return {\r\n    source,\r\n    data: feature,\r\n    meta: {\r\n      dataType: FEATURE,\r\n      id: feature.meta.id as string,\r\n      title: feature.meta.title,\r\n      icon: feature.meta.icon || 'map-marker'\r\n    }\r\n  };\r\n}\r\n\r\nexport function findDiff(str1: string, str2: string){\r\n  let diff = '';\r\n  str2.split('').forEach((val, i) => {\r\n    if (val !== str1.charAt(i)) {\r\n      diff += val;\r\n    }\r\n  });\r\n  return diff;\r\n}\r\n\r\n\r\n/**\r\n * Return a score calculation based on \"from\" term with the \"to\" term,\r\n * where the perfect match is 100 and a total difference is 0 or under.\r\n * @param from string\r\n * @param to string\r\n * @param caseSensitive boolean\r\n * @returns number\r\n */\r\nexport function computeTermSimilarity(from, to, caseSensitive: boolean = false): number {\r\n  if (!from || !to) {\r\n    return 0;\r\n  }\r\n  const termFrom = caseSensitive ? from : from.toLowerCase();\r\n  const termTo = caseSensitive ? to : to.toLowerCase();\r\n  const fromToDiff = findDiff(termFrom, termTo);\r\n  const toFromDiff = findDiff(termTo, termFrom);\r\n  const totalDiff = fromToDiff + toFromDiff;\r\n\r\n  let delta = 0;\r\n  if (totalDiff.length) {\r\n    delta = totalDiff.length / termFrom.length * 100;\r\n  }\r\n\r\n  return 100 - Math.floor(delta);\r\n}\r\n","import { SearchSource } from './sources/source';\r\nimport { SearchSourceSettings } from './sources/source.interfaces';\r\n\r\n/**\r\n * Service where all available search sources are registered.\r\n */\r\nexport class SearchSourceService {\r\n\r\n  constructor(private sources: SearchSource[]) {}\r\n\r\n  /**\r\n   * Return available search sources\r\n   * @returns Search sources\r\n   */\r\n  getSources(): SearchSource[] {\r\n    return this.sources;\r\n  }\r\n\r\n  /**\r\n   * Return enabled search sources\r\n   * @returns Search sources\r\n   */\r\n  getEnabledSources(): SearchSource[] {\r\n    return this.getSources().filter(\r\n      (source: SearchSource) => source.enabled === true\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Enable search sources of given type\r\n   * @param type Search type\r\n   * @todo It would be better to track the enabled search sources\r\n   *  without updating their 'enabled' property.\r\n   */\r\n  enableSourcesByType(type: string) {\r\n    this.getSources().forEach((source: SearchSource) => {\r\n      if ((source.constructor as typeof SearchSource).type === type) {\r\n        source.enabled = true;\r\n      } else {\r\n        source.enabled = false;\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Set Param from the selected settings\r\n   * @param source search-source\r\n   * @param setting settings\r\n   */\r\n  setParamFromSetting(source: SearchSource, setting: SearchSourceSettings) {\r\n    source.setParamFromSetting(setting);\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { stringToLonLat } from '../../map';\r\nimport { MapService } from '../../map/shared/map.service';\r\n\r\nimport { SearchSource, TextSearch, ReverseSearch } from './sources/source';\r\nimport {\r\n  TextSearchOptions,\r\n  ReverseSearchOptions\r\n} from './sources/source.interfaces';\r\nimport { SearchSourceService } from './search-source.service';\r\nimport { Research } from './search.interfaces';\r\nimport {\r\n  sourceCanSearch,\r\n  sourceCanReverseSearch,\r\n  sourceCanReverseSearchAsSummary\r\n} from './search.utils';\r\n\r\n/**\r\n * This service perform researches in all the search sources enabled.\r\n * It returns Research objects who's 'request' property needs to be\r\n * subscribed to in order to trigger the research. This services has\r\n * keeps internal state of the researches it performed\r\n * and the results they yielded.\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class SearchService {\r\n  constructor(\r\n    private searchSourceService: SearchSourceService,\r\n    private mapService: MapService\r\n  ) {}\r\n\r\n  /**\r\n   * Perform a research by text\r\n   * @param term Any text\r\n   * @returns Researches\r\n   */\r\n  search(term: string, options: TextSearchOptions = {}): Research[] {\r\n    if (!this.termIsValid(term)) {\r\n      return [];\r\n    }\r\n\r\n    const proj = this.mapService.getMap()?.projection || 'EPSG:3857';\r\n    const response = stringToLonLat(term, proj, {\r\n      forceNA: options.forceNA\r\n    });\r\n    if (response.lonLat) {\r\n      return this.reverseSearch(response.lonLat, { distance: response.radius, conf: response.conf });\r\n    } else if (response.message) {\r\n      console.log(response.message);\r\n    }\r\n\r\n    options.extent = this.mapService\r\n      .getMap()\r\n      ?.viewController.getExtent('EPSG:4326');\r\n\r\n    let sources;\r\n\r\n    if (options.getEnabledOnly || options.getEnabledOnly === undefined) {\r\n      sources = this.searchSourceService.getEnabledSources();\r\n    } else {\r\n      sources = this.searchSourceService.getSources();\r\n    }\r\n\r\n    if (options.sourceId) {\r\n      sources = sources.filter((source) => source.getId() === options.sourceId);\r\n    } else if (options.searchType) {\r\n      sources = sources.filter(\r\n        (source) => source.getType() === options.searchType\r\n      );\r\n    }\r\n\r\n    sources = sources.filter(sourceCanSearch);\r\n    return this.searchSources(sources, term, options);\r\n  }\r\n\r\n  /**\r\n   * Perform a research by lon/lat\r\n   * @param lonLat Any lon/lat coordinates\r\n   * @returns Researches\r\n   */\r\n  reverseSearch(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions,\r\n    asPointerSummary: boolean = false\r\n  ) {\r\n    const reverseSourceFonction = asPointerSummary\r\n      ? sourceCanReverseSearchAsSummary\r\n      : sourceCanReverseSearch;\r\n    const sources = this.searchSourceService\r\n      .getEnabledSources()\r\n      .filter(reverseSourceFonction);\r\n    return this.reverseSearchSources(sources, lonLat, options || {});\r\n  }\r\n\r\n  /**\r\n   * Create a text research out of all given search sources\r\n   * @param sources Search sources that implement TextSearch\r\n   * @param term Search term\r\n   * @returns Observable of Researches\r\n   */\r\n  private searchSources(\r\n    sources: SearchSource[],\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): Research[] {\r\n    return sources.map((source: SearchSource) => {\r\n      return {\r\n        request: ((source as any) as TextSearch).search(term, options),\r\n        reverse: false,\r\n        source\r\n      };\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create a reverse research out of all given search sources\r\n   * @param sources Search sources that implement ReverseSearch\r\n   * @param lonLat Any lon/lat coordinates\r\n   * @returns Observable of Researches\r\n   */\r\n  private reverseSearchSources(\r\n    sources: SearchSource[],\r\n    lonLat: [number, number],\r\n    options: ReverseSearchOptions\r\n  ): Research[] {\r\n    return sources.map((source: SearchSource) => {\r\n      return {\r\n        request: ((source as any) as ReverseSearch).reverseSearch(\r\n          lonLat,\r\n          options\r\n        ),\r\n        reverse: true,\r\n        source\r\n      };\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Validate that a search term is valid\r\n   * @param term Search term\r\n   * @returns True if the search term is valid\r\n   */\r\n  private termIsValid(term: string): boolean {\r\n    return typeof term === 'string' && term !== '';\r\n  }\r\n}\r\n","<div class=\"igo-form-button-group\">\r\n  <button mat-icon-button tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"'igo.geo.directionsForm.addStop' | translate\" color=\"primary\" (click)=\"addStop()\">\r\n    <mat-icon svgIcon=\"map-marker-plus\"></mat-icon>\r\n  </button>\r\n  <button mat-icon-button tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n    *ngIf=\"(routesFeatureStore.count$ | async)>=1 || (stopsStore.count$ | async)>=1\"\r\n    [matTooltip]=\"'igo.geo.directionsForm.resetDirectionsBtn' | translate\" color=\"warn\" (click)=\"resetStops()\">\r\n    <mat-icon svgIcon=\"file-restore\"></mat-icon>\r\n  </button>\r\n  <button mat-icon-button tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n    *ngIf=\"(routesFeatureStore.count$ | async)>=1\" (click)=\"zoomRoute()\"\r\n    [matTooltip]=\"'igo.geo.directionsForm.zoomRoute' | translate\" color=\"primary\">\r\n    <mat-icon svgIcon=\"magnify-plus-outline\"></mat-icon>\r\n  </button>\r\n  <button mat-icon-button tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n    *ngIf=\"(routesFeatureStore.count$ | async)>=1\" (click)=\"copyDirectionsToClipboard()\"\r\n    [matTooltip]=\"'igo.geo.directionsForm.copy' | translate\" color=\"primary\">\r\n    <mat-icon svgIcon=\"content-copy\"></mat-icon>\r\n  </button>\r\n  <button mat-icon-button tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n    *ngIf=\"(routesFeatureStore.count$ | async)>=1\" (click)=\"copyLinkToClipboard()\" \r\n    [matTooltip]=\"'igo.geo.directionsForm.link' | translate\" color=\"primary\">\r\n    <mat-icon svgIcon=\"link\"></mat-icon>\r\n  </button>\r\n</div>","import { Component, Input, Optional } from '@angular/core';\r\nimport { LanguageService, MessageService, RouteService } from '@igo2/core';\r\nimport { Clipboard } from '@igo2/utils';\r\nimport { Subject } from 'rxjs';\r\nimport { roundCoordTo } from '../../map/shared/map.utils';\r\nimport { FeatureWithDirection } from '../shared/directions.interface';\r\n\r\nimport { addStopToStore, formatDistance, formatDuration, formatInstruction } from '../shared/directions.utils';\r\nimport { RoutesFeatureStore, StopsStore } from '../shared/store';\r\n\r\n@Component({\r\n  selector: 'igo-directions-buttons',\r\n  templateUrl: './directions-buttons.component.html',\r\n  styleUrls: ['./directions-buttons.component.scss']\r\n})\r\nexport class DirectionsButtonsComponent {\r\n\r\n  get activeRoute() {\r\n    return this.routesFeatureStore.all().find(route => route.properties.active);\r\n  }\r\n  @Input() contextUri: string;\r\n  @Input() zoomToActiveRoute$: Subject<void> = new Subject();\r\n  @Input() stopsStore: StopsStore;\r\n  @Input() routesFeatureStore: RoutesFeatureStore;\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private messageService: MessageService,\r\n    @Optional() private route: RouteService) { }\r\n\r\n  resetStops() {\r\n    this.stopsStore.clearStops();\r\n  }\r\n\r\n  // stop are always added before the last stop.\r\n  addStop(): void {\r\n    addStopToStore(this.stopsStore);\r\n  }\r\n\r\n\r\n  copyLinkToClipboard() {\r\n    const successful = Clipboard.copy(this.getUrl());\r\n    if (successful) {\r\n      const translate = this.languageService.translate;\r\n      const title = translate.instant(\r\n        'igo.geo.directionsForm.dialog.copyTitle'\r\n      );\r\n      const msg = translate.instant(\r\n        'igo.geo.directionsForm.dialog.copyMsgLink'\r\n      );\r\n      this.messageService.success(msg, title);\r\n    }\r\n  }\r\n\r\n  zoomRoute() {\r\n    this.zoomToActiveRoute$.next();\r\n  }\r\n\r\n  copyDirectionsToClipboard() {\r\n    const directionsBody = this.directionsToText();\r\n    const successful = Clipboard.copy(directionsBody);\r\n    if (successful) {\r\n      const translate = this.languageService.translate;\r\n      const title = translate.instant(\r\n        'igo.geo.directionsForm.dialog.copyTitle'\r\n      );\r\n      const msg = translate.instant('igo.geo.directionsForm.dialog.copyMsg');\r\n      this.messageService.success(msg, title);\r\n    }\r\n  }\r\n\r\n  private directionsToText() {\r\n    const indent = '\\t';\r\n    let activeRouteDirective =\r\n      this.languageService.translate.instant(\r\n        'igo.geo.directionsForm.instructions'\r\n      ) + ':\\n';\r\n    let wayPointList = '';\r\n    const summary =\r\n      this.languageService.translate.instant('igo.geo.directionsForm.summary') +\r\n      ': \\n' +\r\n      indent +\r\n      this.activeRoute.properties.direction.title +\r\n      '\\n' +\r\n      indent +\r\n      formatDistance(this.activeRoute.properties.direction.distance) +\r\n      '\\n' +\r\n      indent +\r\n      formatDuration(this.activeRoute.properties.direction.duration) +\r\n      '\\n\\n' +\r\n      this.languageService.translate.instant(\r\n        'igo.geo.directionsForm.stopsList'\r\n      ) +\r\n      ':\\n';\r\n\r\n    const url =\r\n      this.languageService.translate.instant('igo.geo.directionsForm.link') +\r\n      ':\\n' +\r\n      indent +\r\n      this.getUrl();\r\n\r\n    let wayPointsCnt = 1;\r\n    this.stopsStore.view.all().forEach(stop => {\r\n      let coord = '';\r\n      let stopText = '';\r\n      if (stop.text !== roundCoordTo(stop.coordinates).join(',')) {\r\n        stopText = stop.text;\r\n        coord = ` ( ${roundCoordTo(stop.coordinates).join(',')} )`;\r\n      } else {\r\n        stopText = roundCoordTo(stop.coordinates).join(\r\n          ','\r\n        );\r\n      }\r\n\r\n      wayPointList =\r\n        wayPointList +\r\n        indent +\r\n        wayPointsCnt.toLocaleString() +\r\n        '. ' +\r\n        stopText +\r\n        coord +\r\n        '\\n';\r\n      wayPointsCnt++;\r\n    });\r\n\r\n    let localCnt = 0;\r\n    this.activeRoute.properties.direction.steps.forEach(step => {\r\n      const instruction = this.formatStep(step, localCnt).instruction;\r\n      const distance =\r\n        formatDistance(step.distance) === undefined\r\n          ? ''\r\n          : ' (' + formatDistance(step.distance) + ')';\r\n      activeRouteDirective =\r\n        activeRouteDirective +\r\n        indent +\r\n        (localCnt + 1).toLocaleString() +\r\n        '. ' +\r\n        instruction +\r\n        distance +\r\n        '\\n';\r\n      localCnt++;\r\n    });\r\n\r\n    const directionsBody =\r\n      summary + wayPointList + '\\n' + url + '\\n\\n' + activeRouteDirective;\r\n\r\n    return directionsBody;\r\n  }\r\n\r\n  formatStep(step, cnt) {\r\n    return formatInstruction(\r\n      step.maneuver.type,\r\n      step.maneuver.modifier,\r\n      step.name,\r\n      step.maneuver.bearing_after,\r\n      cnt,\r\n      step.maneuver.exit,\r\n      this.languageService,\r\n      cnt === this.activeRoute.properties.direction.steps.length - 1\r\n    );\r\n  }\r\n\r\n  private getUrl() {\r\n    if (!this.route) {\r\n      return;\r\n    }\r\n    let context = '';\r\n    if (this.contextUri) {\r\n      context = `context=${this.contextUri}&`;\r\n    }\r\n\r\n    const pos = this.routesFeatureStore.all()\r\n    .map((direction: FeatureWithDirection) => direction.properties.id).indexOf(this.activeRoute.properties.id);\r\n    let routingOptions = '';\r\n    if (pos !== 0) {\r\n      const routingOptionsKey = this.route.options.directionsOptionsKey;\r\n      routingOptions = `&${routingOptionsKey}=result:${pos}`;\r\n    }\r\n    const directionsKey = this.route.options.directionsCoordKey;\r\n    const stopsCoordinates = this.stopsStore.view.all().map(stop => roundCoordTo(stop.coordinates, 6));\r\n    let directionsUrl = '';\r\n    if (stopsCoordinates.length >= 2) {\r\n      directionsUrl = `${directionsKey}=${stopsCoordinates.join(';')}`;\r\n      return `${location.origin}${location.pathname}?${context}tool=directions&sidenav=1&${directionsUrl}${routingOptions}`;\r\n    }\r\n    return;\r\n  }\r\n}\r\n","<div class=\"igo-input-container\" *ngIf=\"directions && activeDirection\">\r\n    <mat-form-field *ngIf=\"directions && directions.length > 1\">\r\n        <mat-select placeholder=\"{{'igo.geo.directionsForm.drivingOptions' | translate}}\"\r\n            (selectionChange)=\"changeRoute()\" [(ngModel)]=\"activeDirection\">\r\n            <mat-option *ngFor=\"let direction of directions; let cnt = index;\" [value]=\"direction\">\r\n                Option {{cnt + 1}} : {{formatDistance(direction.distance)}}\r\n                ({{formatDuration(direction.duration)}})\r\n            </mat-option>\r\n        </mat-select>\r\n    </mat-form-field>\r\n\r\n    <mat-divider *ngIf=\"directions && directions.length === 0\"></mat-divider>\r\n\r\n    <mat-list (mouseleave)=\"onStepsListBlur()\">\r\n        <h2 mat-header class=\"igo-route-title mat-typography\">{{activeDirection.title}}</h2>\r\n        <h2 mat-subheader>{{formatDistance(activeDirection.distance)}}, {{formatDuration(activeDirection.duration)}}</h2>\r\n        <mat-list-item class=\"igo-steps\" \r\n            (mouseenter)=\"showSegment(step)\" \r\n            (click)=\"showSegment(step,true)\" \r\n            *ngFor=\"let step of activeDirection.steps; let cnt = index;\" igoListItem>\r\n            <mat-icon [ngClass]=\"formatStep(step,cnt).cssClass\" mat-list-icon svgIcon=\"{{formatStep(step,cnt).image}}\">\r\n            </mat-icon>\r\n\r\n            <h4 mat-line>{{cnt +1}}. {{formatStep(step,cnt).instruction}}</h4>\r\n            <h4 mat-line class=\"right\">{{formatDistance(step.distance)}}</h4>\r\n        </mat-list-item>\r\n\r\n        <mat-divider></mat-divider>\r\n\r\n    </mat-list>\r\n\r\n</div>","import { ChangeDetectorRef, Component, Input, OnDestroy, OnInit } from '@angular/core';\r\nimport { LanguageService } from '@igo2/core';\r\nimport { Subscription } from 'rxjs';\r\nimport { debounceTime } from 'rxjs/operators';\r\n\r\nimport { Direction, FeatureWithStep, IgoStep } from '../shared/directions.interface';\r\nimport { formatDistance, formatDuration, formatInstruction } from '../shared/directions.utils';\r\nimport { RoutesFeatureStore, StepFeatureStore } from '../shared/store';\r\n\r\nimport olFeature from 'ol/Feature';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport * as olGeom from 'ol/geom';\r\n\r\nimport { FeatureGeometry } from '../../feature/shared/feature.interfaces';\r\nimport { FEATURE } from '../../feature/shared/feature.enums';\r\nimport { DirectionType } from '../shared/directions.enum';\r\n\r\n@Component({\r\n  selector: 'igo-directions-results',\r\n  templateUrl: './directions-results.component.html',\r\n  styleUrls: ['./directions-results.component.scss']\r\n})\r\nexport class DirectionsResultsComponent implements OnInit, OnDestroy {\r\n\r\n  public activeDirection: Direction;\r\n  public directions: Direction[];\r\n\r\n  private entities$$: Subscription;\r\n\r\n  @Input() routesFeatureStore: RoutesFeatureStore;\r\n  @Input() stepFeatureStore: StepFeatureStore;\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private cdRef: ChangeDetectorRef\r\n  ) { }\r\n\r\n  ngOnInit(): void {\r\n    this.entities$$ = this.routesFeatureStore.entities$\r\n      .pipe(debounceTime(200))\r\n      .subscribe(entities => {\r\n        const activeFeatureWithDirection = entities.find(entity => entity.properties.active);\r\n        this.directions = entities.map(entity => entity.properties.direction);\r\n        if (activeFeatureWithDirection) {\r\n          this.activeDirection = activeFeatureWithDirection.properties.direction;\r\n        } else {\r\n          this.activeDirection = undefined;\r\n        }\r\n        this.cdRef.detectChanges();\r\n      });\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this.entities$$.unsubscribe();\r\n  }\r\n\r\n  changeRoute() {\r\n    this.routesFeatureStore.entities$.value.map(entity =>\r\n      entity.properties.active = !entity.properties.active\r\n    );\r\n    this.routesFeatureStore.layer.ol.getSource().getFeatures().map(feature =>\r\n      feature.set('active', !feature.get('active'))\r\n    );\r\n  }\r\n\r\n  formatDistance(distance: number): string {\r\n    return formatDistance(distance);\r\n  }\r\n\r\n  formatDuration(duration: number): string {\r\n    return formatDuration(duration);\r\n  }\r\n\r\n  formatStep(step, cnt) {\r\n    return formatInstruction(\r\n      step.maneuver.type,\r\n      step.maneuver.modifier,\r\n      step.name,\r\n      step.maneuver.bearing_after,\r\n      cnt,\r\n      step.maneuver.exit,\r\n      this.languageService,\r\n      cnt === this.activeDirection.steps.length - 1\r\n    );\r\n  }\r\n\r\n  onStepsListBlur() {\r\n    this.stepFeatureStore.clear();\r\n  }\r\n\r\n  showSegment(step: IgoStep, zoomToExtent = false) {\r\n    this.showRouteSegmentGeometry(step, zoomToExtent);\r\n  }\r\n\r\n  showRouteSegmentGeometry(step: IgoStep, zoomToExtent = false) {\r\n\r\n    const coordinates = step.geometry.coordinates;\r\n    const vertexId = 'vertex';\r\n    const geometry4326 = new olGeom.LineString(coordinates);\r\n    const geometryMapProjection = geometry4326.transform(\r\n      'EPSG:4326',\r\n      this.stepFeatureStore.layer.map.projection\r\n    );\r\n    const routeSegmentCoordinates = (geometryMapProjection as any).getCoordinates();\r\n    const lastPoint = routeSegmentCoordinates[0];\r\n\r\n    const geometry = new olGeom.Point(lastPoint);\r\n    const feature = new olFeature({ geometry });\r\n\r\n    const geojsonGeom = new OlGeoJSON().writeGeometryObject(geometry, {\r\n      featureProjection: this.stepFeatureStore.layer.map.projection,\r\n      dataProjection: this.stepFeatureStore.layer.map.projection\r\n    }) as FeatureGeometry;\r\n\r\n    const previousVertex = this.stepFeatureStore.get(vertexId);\r\n    const previousVertexRevision = previousVertex\r\n      ? previousVertex.meta.revision\r\n      : 0;\r\n\r\n    const stepFeature: FeatureWithStep = {\r\n      type: FEATURE,\r\n      geometry: geojsonGeom,\r\n      projection: this.stepFeatureStore.layer.map.projection,\r\n      properties: {\r\n        id: vertexId,\r\n        step,\r\n        type: DirectionType.Vertex\r\n      },\r\n      meta: {\r\n        id: vertexId,\r\n        revision: previousVertexRevision + 1\r\n      },\r\n      ol: feature\r\n    };\r\n    this.stepFeatureStore.update(stepFeature);\r\n    if (zoomToExtent) {\r\n      this.stepFeatureStore.layer.map.viewController.zoomToExtent(feature.getGeometry().getExtent() as [number, number, number, number]);\r\n    }\r\n  }\r\n\r\n}\r\n","import { ChangeDetectorRef, Component, Input, OnDestroy, OnInit } from '@angular/core';\r\n\r\nimport { debounceTime, distinctUntilChanged, map } from 'rxjs/operators';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { EntityStoreWatcher } from '@igo2/common';\r\n\r\nimport * as olCondition from 'ol/events/condition';\r\nimport * as olInteraction from 'ol/interaction';\r\nimport * as olProj from 'ol/proj';\r\nimport { TranslateEvent } from 'ol/interaction/Translate';\r\nimport Collection from 'ol/Collection';\r\nimport { SelectEvent } from 'ol/interaction/Select';\r\n\r\nimport { DirectionOptions, FeatureWithStopProperties, Stop } from './shared/directions.interface';\r\nimport { Subject, Subscription } from 'rxjs';\r\nimport { addDirectionToRoutesFeatureStore, addStopToStopsFeatureStore, addStopToStore,\r\n  initRoutesFeatureStore, initStepFeatureStore, initStopsFeatureStore, updateStoreSorting } from './shared/directions.utils';\r\nimport { Feature } from '../feature/shared/feature.interfaces';\r\nimport { DirectionsService } from './shared/directions.service';\r\nimport { DirectionType, ProposalType } from './shared/directions.enum';\r\nimport { roundCoordTo, stringToLonLat } from '../map';\r\nimport { SearchService } from '../search/shared/search.service';\r\nimport { ChangeUtils, ObjectUtils } from '@igo2/utils';\r\nimport { RoutesFeatureStore, StepFeatureStore, StopsFeatureStore, StopsStore } from './shared/store';\r\nimport { FeatureStoreLoadingStrategy } from '../feature/shared/strategies/loading';\r\nimport { Research, SearchResult } from '../search/shared/search.interfaces';\r\nimport { QueryService } from '../query/shared/query.service';\r\n\r\n@Component({\r\n  selector: 'igo-directions',\r\n  templateUrl: './directions.component.html',\r\n  styleUrls: ['./directions.component.scss']\r\n})\r\nexport class DirectionsComponent implements OnInit, OnDestroy {\r\n\r\n  private watcher: EntityStoreWatcher<Stop>;\r\n\r\n  public projection: string = 'EPSG:4326';\r\n\r\n  private zoomRoute$$: Subscription;\r\n  private storeEmpty$$: Subscription;\r\n  private storeChange$$: Subscription;\r\n  private routesQueries$$: Subscription[] = [];\r\n\r\n  private selectStopInteraction: olInteraction.Select;\r\n  private translateStop: olInteraction.Translate;\r\n  private selectedRoute;\r\n  private focusOnStop: boolean = false;\r\n  private isTranslating: boolean = false;\r\n\r\n  public previousStops: Stop[] = [];\r\n\r\n  private searchs$$: Subscription[] = [];\r\n\r\n  @Input() contextUri: string;\r\n  @Input() stopsStore: StopsStore;\r\n  @Input() stopsFeatureStore: StopsFeatureStore;\r\n  @Input() routesFeatureStore: RoutesFeatureStore;\r\n  @Input() stepFeatureStore: StepFeatureStore;\r\n  @Input() debounce: number = 200;\r\n  @Input() length: number = 2;\r\n  @Input() coordRoundedDecimals: number = 6;\r\n  @Input() zoomToActiveRoute$: Subject<void> = new Subject();\r\n\r\n  constructor(\r\n    private cdRef: ChangeDetectorRef,\r\n    private languageService: LanguageService,\r\n    private directionsService: DirectionsService,\r\n    private searchService: SearchService,\r\n    private queryService: QueryService\r\n  ) { }\r\n\r\n\r\n  ngOnInit(): void {\r\n    this.queryService.queryEnabled = false;\r\n    this.initEntityStores();\r\n    setTimeout(() => {\r\n      initStopsFeatureStore(this.stopsFeatureStore, this.languageService);\r\n      initRoutesFeatureStore(this.routesFeatureStore, this.languageService);\r\n      initStepFeatureStore(this.stepFeatureStore);\r\n      this.initOlInteraction();\r\n    }, 1);\r\n\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this.queryService.queryEnabled = true;\r\n    this.storeEmpty$$.unsubscribe();\r\n    this.storeChange$$.unsubscribe();\r\n    this.routesQueries$$.map((u) => u.unsubscribe());\r\n    this.zoomRoute$$.unsubscribe();\r\n    this.freezeStores();\r\n  }\r\n\r\n  private freezeStores() {\r\n    this.stopsFeatureStore.layer.map.ol.removeInteraction(this.selectStopInteraction);\r\n    this.stopsFeatureStore.layer.map.ol.removeInteraction(this.translateStop);\r\n    this.routesFeatureStore.layer.map.ol.removeInteraction(this.selectedRoute);\r\n    this.stopsFeatureStore.deactivateStrategyOfType(FeatureStoreLoadingStrategy);\r\n    this.routesFeatureStore.deactivateStrategyOfType(FeatureStoreLoadingStrategy);\r\n    this.stepFeatureStore.deactivateStrategyOfType(FeatureStoreLoadingStrategy);\r\n  }\r\n\r\n  private initEntityStores() {\r\n    this.watcher = new EntityStoreWatcher(this.stopsStore, this.cdRef);\r\n    this.monitorEmptyEntityStore();\r\n    this.monitorEntityStoreChange();\r\n    this.monitorActiveRouteZoom();\r\n  }\r\n\r\n  private monitorActiveRouteZoom() {\r\n    this.zoomRoute$$ = this.zoomToActiveRoute$.subscribe(() => {\r\n      if (this.routesFeatureStore.count >= 1) {\r\n        const activeRoute = this.routesFeatureStore.all().find(route => route.properties.active);\r\n\r\n        if (activeRoute) {\r\n          activeRoute.ol.getGeometry();\r\n          const routeExtent = activeRoute.ol.getGeometry().getExtent();\r\n          this.routesFeatureStore.layer.map.viewController.zoomToExtent(routeExtent as [number, number, number, number]);\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  private initOlInteraction() {\r\n    this.selectStopInteraction = new olInteraction.Select({\r\n      layers: [this.stopsFeatureStore.layer.ol],\r\n      hitTolerance: 7,\r\n      condition: (event) => {\r\n        return event.type === 'pointermove' && !event.dragging;\r\n      }\r\n    });\r\n\r\n    this.translateStop = new olInteraction.Translate({\r\n      features: this.selectStopInteraction.getFeatures()\r\n    });\r\n    this.translateStop.on('translating', (evt: TranslateEvent) => {\r\n      this.isTranslating = true;\r\n      this.executeStopTranslation(evt.features);\r\n    });\r\n    this.translateStop.on('translateend', (evt: TranslateEvent) => {\r\n      this.isTranslating = false;\r\n      this.executeStopTranslation(evt.features);\r\n    });\r\n\r\n    this.selectedRoute = new olInteraction.Select({\r\n      layers: [this.routesFeatureStore.layer.ol],\r\n      condition: olCondition.click,\r\n      hitTolerance: 7,\r\n      filter: feature => {\r\n        return feature.get('type') === DirectionType.Route &&\r\n          feature.get('active') &&\r\n          !this.isTranslating;\r\n      }\r\n    });\r\n    this.selectedRoute.on('select', (evt: SelectEvent) => {\r\n      if (this.focusOnStop === false) {\r\n        const selectCoordinates = roundCoordTo(\r\n          olProj.transform(\r\n            (evt as any).mapBrowserEvent.coordinate,\r\n            this.routesFeatureStore.layer.map.projection,\r\n            this.projection\r\n          ) as [number, number], this.coordRoundedDecimals);\r\n        const addedStop = addStopToStore(this.stopsStore);\r\n        addedStop.text = selectCoordinates.join(',');\r\n        addedStop.coordinates = [selectCoordinates[0], selectCoordinates[1]];\r\n      }\r\n    });\r\n\r\n    this.stopsFeatureStore.layer.map.ol.addInteraction(this.selectStopInteraction);\r\n    this.stopsFeatureStore.layer.map.ol.addInteraction(this.translateStop);\r\n    this.routesFeatureStore.layer.map.ol.addInteraction(this.selectedRoute);\r\n  }\r\n\r\n  onStopInputHasFocusChange(stopInputHasFocus: boolean) {\r\n    stopInputHasFocus ?\r\n      this.routesFeatureStore.layer.map.ol.removeInteraction(this.selectedRoute) :\r\n      this.routesFeatureStore.layer.map.ol.addInteraction(this.selectedRoute);\r\n  }\r\n\r\n  private executeStopTranslation(\r\n    features: Collection<any>\r\n  ) {\r\n    if (features.getLength() === 0) {\r\n      return;\r\n    }\r\n    const firstFeature = features.getArray()[0];\r\n    const translatedStopId = firstFeature.getId();\r\n\r\n    const translationCoordinates = olProj.transform(\r\n      firstFeature.getGeometry().getCoordinates(),\r\n      this.stopsFeatureStore.layer.map.projection,\r\n      this.projection\r\n    );\r\n    const translatedStop = this.stopsStore.get(translatedStopId);\r\n    const roundedCoord = roundCoordTo(translationCoordinates as [number, number], this.coordRoundedDecimals);\r\n    translatedStop.coordinates = roundedCoord;\r\n    translatedStop.text = roundedCoord.join(',');\r\n    this.stopsStore.update(translatedStop);\r\n  }\r\n\r\n\r\n  private monitorEmptyEntityStore() {\r\n    // Watch if the store is empty to reset it\r\n    this.storeEmpty$$ = this.stopsStore.count$\r\n      .pipe(\r\n        distinctUntilChanged()\r\n      ).subscribe((count) => {\r\n        if (count < 2) {\r\n          addStopToStore(this.stopsStore);\r\n          if (this.stopsStore.count === 2) {\r\n            this.stopsStore.storeInitialized$.next(true);\r\n            return;\r\n          }\r\n          this.stopsStore.storeInitialized$.next(false);\r\n        }\r\n        this.routesQueries$$.map((u) => u.unsubscribe());\r\n      });\r\n  }\r\n\r\n  private monitorEntityStoreChange() {\r\n    this.storeChange$$ = this.stopsStore.entities$\r\n      .pipe(debounceTime(this.debounce))\r\n      .subscribe((stops: Stop[]) => {\r\n        this.handleStopDiff(stops);\r\n        updateStoreSorting(this.stopsStore);\r\n        this.handleStopsFeature();\r\n        this.getRoutes(this.isTranslating);\r\n      });\r\n  }\r\n\r\n  cancelSearch() {\r\n    this.searchs$$.map(s => s.unsubscribe());\r\n  }\r\n\r\n  private handleStopDiff(stops: Stop[]) {\r\n    const simplifiedStops = stops.map((stop: Stop) => {\r\n      return ObjectUtils.removeUndefined({ ...{ id: stop.id, text: stop.text, coordinates: stop.coordinates } });\r\n    });\r\n    const diff = ChangeUtils.findChanges(this.previousStops, simplifiedStops, ['coordinates']);\r\n    const stopIdToProcess = diff.added.concat(diff.modified);\r\n    if (stopIdToProcess) {\r\n      stopIdToProcess.map((change) => {\r\n        const changedStop = (change.newValue as Stop);\r\n        if (changedStop) {\r\n          const stop: Stop = this.stopsStore.get(changedStop.id);\r\n          const term = stop.text;\r\n          if (!term || term.length === 0) {\r\n            return;\r\n          }\r\n          const response = stringToLonLat(term, this.stopsFeatureStore.layer.map.projection);\r\n          let researches: Research[];\r\n          let isCoord = false;\r\n          if (response.lonLat) {\r\n            isCoord = true;\r\n          }\r\n          researches = this.searchService.search(term, { searchType: 'Feature' });\r\n          this.cancelSearch();\r\n          const requests$ = researches.map(res => res.request\r\n            .pipe(map((results: SearchResult[]) => results.filter(r =>\r\n              isCoord ? r.data.geometry.type === 'Point' && r.data.geometry : r.data.geometry)))\r\n\r\n          );\r\n          this.searchs$$ = requests$.map((request) => {\r\n            return request.pipe(map((results: SearchResult[]) => results.filter(r =>\r\n              isCoord ? r.data.geometry.type === 'Point' && r.data.geometry : r.data.geometry)))\r\n              .subscribe((res: SearchResult[]) => {\r\n                if (res.length > 0) {\r\n                  const source = res[0].source;\r\n                  const meta = res[0].meta;\r\n                  const results = res.map(r => r.data);\r\n                  if (!stop.searchProposals) {\r\n                    stop.searchProposals = [];\r\n                  }\r\n                  stop.searchProposals = stop.searchProposals.filter(sp => sp.type === (isCoord ? ProposalType.Coord : ProposalType.Text));\r\n                  let storedSource = stop.searchProposals.find(sp => sp.source === source);\r\n                  if (storedSource) {\r\n                    storedSource.results = results;\r\n                  } else {\r\n                    stop.searchProposals.push({\r\n                      type: isCoord ? ProposalType.Coord : ProposalType.Text,\r\n                      source,\r\n                      meta,\r\n                      results\r\n                    });\r\n                  }\r\n                }\r\n                this.cdRef.detectChanges();\r\n              });\r\n          });\r\n        }\r\n      });\r\n    }\r\n    this.previousStops = simplifiedStops;\r\n  }\r\n\r\n  private handleStopsFeature() {\r\n    const stops = this.stopsStore.all();\r\n    const stopsWithCoordinates = stops.filter(stop => stop.coordinates);\r\n    stopsWithCoordinates.map(stop => this.addStopOverlay(stop));\r\n    this.stopsFeatureStore.all().map(\r\n      (stopFeature: Feature<FeatureWithStopProperties>) => {\r\n        if (!this.stopsStore.get(stopFeature.properties.id)) {\r\n          this.stopsFeatureStore.delete(stopFeature);\r\n        }\r\n      });\r\n    const stopsWithoutCoordinates = stops.filter(stop => !stop.coordinates);\r\n    stopsWithoutCoordinates.map(stop => {\r\n      const stopFeature = this.stopsFeatureStore.get(stop.id);\r\n      if (stopFeature) {\r\n        this.stopsFeatureStore.delete(stopFeature);\r\n      }\r\n    });\r\n  }\r\n\r\n  private getRoutes(isOverview: boolean = false) {\r\n    const stopsWithCoordinates = this.stopsStore.view\r\n      .all()\r\n      .filter(stop => stop.coordinates);\r\n    if (stopsWithCoordinates.length < 2) {\r\n      this.routesFeatureStore.deleteMany(this.routesFeatureStore.all());\r\n      return;\r\n    }\r\n\r\n    const roundedCoordinates = stopsWithCoordinates.map((stop) => {\r\n      const roundedCoord = roundCoordTo(stop.coordinates, this.coordRoundedDecimals);\r\n      return roundedCoord;\r\n    });\r\n    const overviewDirectionsOptions: DirectionOptions = {\r\n      overview: true,\r\n      steps: false,\r\n      alternatives: false,\r\n      continue_straight: false\r\n    };\r\n    this.routesQueries$$.map((u) => u.unsubscribe());\r\n    const routeResponse = this.directionsService.route(\r\n      roundedCoordinates,\r\n      isOverview ? overviewDirectionsOptions : undefined\r\n    );\r\n    if (routeResponse) {\r\n      routeResponse.map(res =>\r\n        this.routesQueries$$.push(\r\n          res.subscribe(directions => {\r\n            this.routesFeatureStore.deleteMany(this.routesFeatureStore.all());\r\n            directions.map(direction =>\r\n              addDirectionToRoutesFeatureStore(\r\n                this.routesFeatureStore,\r\n                direction,\r\n                this.projection,\r\n                direction === directions[0] ? true : false)\r\n            );\r\n          })\r\n        )\r\n      );\r\n    }\r\n  }\r\n\r\n  public addStopOverlay(stop: Stop) {\r\n    addStopToStopsFeatureStore(stop, this.stopsStore, this.stopsFeatureStore, this.projection, this.languageService);\r\n  }\r\n}\r\n","<igo-directions-buttons [contextUri]=\"contextUri\" [zoomToActiveRoute$]=\"zoomToActiveRoute$\" [routesFeatureStore]=\"routesFeatureStore\" [stopsStore]=\"stopsStore\"></igo-directions-buttons>\r\n\r\n<igo-directions-inputs (stopInputHasFocus)=\"onStopInputHasFocusChange($event)\" [coordRoundedDecimals]=\"coordRoundedDecimals\" [projection]=\"projection\" [stopsFeatureStore]=\"stopsFeatureStore\" [stopsStore]=\"stopsStore\" [debounce]=\"debounce\" [length]=\"length\"></igo-directions-inputs>\r\n<br>\r\n<igo-directions-results [stepFeatureStore]=\"stepFeatureStore\" [routesFeatureStore]=\"routesFeatureStore\"></igo-directions-results>","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\n\r\nimport { MatAutocompleteModule } from '@angular/material/autocomplete';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatOptionModule } from '@angular/material/core';\r\nimport { MatDividerModule } from '@angular/material/divider';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { provideDirectionsSourceService } from './shared/directions-source.service';\r\nimport { DragDropModule } from '@angular/cdk/drag-drop';\r\nimport { DirectionsInputsComponent } from './directions-inputs/directions-inputs.component';\r\nimport { DirectionsComponent } from './directions.component';\r\nimport { DirectionsButtonsComponent } from './directions-buttons/directions-buttons.component';\r\nimport { DirectionsResultsComponent } from './directions-results/directions-results.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    DragDropModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatListModule,\r\n    MatDividerModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatOptionModule,\r\n    MatSelectModule,\r\n    MatTooltipModule,\r\n    MatAutocompleteModule,\r\n    IgoLanguageModule\r\n  ],\r\n  exports: [\r\n    DirectionsComponent,\r\n    DirectionsInputsComponent,\r\n    DirectionsButtonsComponent,\r\n    DirectionsResultsComponent\r\n  ],\r\n  declarations: [\r\n     DirectionsComponent,\r\n    DirectionsInputsComponent,\r\n    DirectionsButtonsComponent,\r\n    DirectionsResultsComponent\r\n  ],\r\n  providers: [provideDirectionsSourceService()]\r\n})\r\nexport class IgoDirectionsModule {\r\n  static forRoot(): ModuleWithProviders<IgoDirectionsModule> {\r\n    return {\r\n      ngModule: IgoDirectionsModule\r\n    };\r\n  }\r\n}\r\n","import { SearchSource } from './sources/source';\r\nimport { SearchSourceService } from './search-source.service';\r\n\r\n/**\r\n * Search source factory\r\n * @ignore\r\n */\r\nexport function searchSourceServiceFactory(sources: SearchSource[]) {\r\n  return new SearchSourceService(sources);\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the SearchSource service\r\n */\r\nexport function provideSearchSourceService() {\r\n  return {\r\n    provide: SearchSourceService,\r\n    useFactory: searchSourceServiceFactory,\r\n    deps: [SearchSource]\r\n  };\r\n}\r\n","import { Injectable, Inject, Injector } from '@angular/core';\r\nimport { HttpClient, HttpParams, HttpParameterCodec } from '@angular/common/http';\r\n\r\nimport { Observable, of, BehaviorSubject } from 'rxjs';\r\nimport { map, catchError } from 'rxjs/operators';\r\n\r\nimport { AuthService } from '@igo2/auth';\r\nimport { LanguageService, StorageService } from '@igo2/core';\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport pointOnFeature from '@turf/point-on-feature';\r\n\r\nimport { FEATURE, Feature } from '../../../feature';\r\nimport { GoogleLinks } from './../../../utils/googleLinks';\r\n\r\nimport { SearchResult } from '../search.interfaces';\r\nimport { SearchSource, TextSearch, ReverseSearch } from './source';\r\nimport {\r\n  SearchSourceOptions,\r\n  TextSearchOptions,\r\n  ReverseSearchOptions\r\n} from './source.interfaces';\r\nimport {\r\n  IChercheData,\r\n  IChercheResponse,\r\n  IChercheReverseData,\r\n  IChercheReverseResponse\r\n} from './icherche.interfaces';\r\nimport { computeTermSimilarity } from '../search.utils';\r\nimport { Cacheable } from 'ts-cacheable';\r\n\r\n@Injectable()\r\nexport class IChercheSearchResultFormatter {\r\n  constructor(private languageService: LanguageService) {}\r\n\r\n  formatResult(result: SearchResult<Feature>): SearchResult<Feature> {\r\n    return result;\r\n  }\r\n}\r\n\r\n// Fix the \"+\" is replaced with space \" \" in a query string\r\n// https://github.com/angular/angular/issues/11058\r\nexport class IgoHttpParameterCodec implements HttpParameterCodec {\r\n  encodeKey(key: string): string {\r\n    return encodeURIComponent(key);\r\n  }\r\n\r\n  encodeValue(value: string): string {\r\n    return encodeURIComponent(value);\r\n  }\r\n\r\n  decodeKey(key: string): string {\r\n    return decodeURIComponent(key);\r\n  }\r\n\r\n  decodeValue(value: string): string {\r\n    return decodeURIComponent(value);\r\n  }\r\n}\r\n\r\n/**\r\n * ICherche search source\r\n */\r\n@Injectable()\r\nexport class IChercheSearchSource extends SearchSource implements TextSearch {\r\n  static id = 'icherche';\r\n  static type = FEATURE;\r\n  static propertiesBlacklist: string[] = [];\r\n  title$: BehaviorSubject<string> = new BehaviorSubject<string>('');\r\n\r\n  private hashtagsLieuxToKeep = [];\r\n\r\n  get title(): string {\r\n    return this.title$.getValue();\r\n  }\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private languageService: LanguageService,\r\n    storageService: StorageService,\r\n    @Inject('options') options: SearchSourceOptions,\r\n    @Inject(IChercheSearchResultFormatter)\r\n    private formatter: IChercheSearchResultFormatter,\r\n    injector: Injector\r\n  ) {\r\n    super(options, storageService);\r\n\r\n    this.languageService.translate\r\n      .get(this.options.title)\r\n      .subscribe((title) => this.title$.next(title));\r\n\r\n    const authService = injector.get(AuthService);\r\n    if (this.settings.length) {\r\n      if (!authService) {\r\n        this.getAllowedTypes();\r\n      } else {\r\n        authService.authenticate$.subscribe(() => {\r\n          this.getAllowedTypes();\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  getId(): string {\r\n    return IChercheSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return IChercheSearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    const limit =\r\n      this.options.params && this.options.params.limit\r\n        ? Number(this.options.params.limit)\r\n        : undefined;\r\n    const ecmax =\r\n      this.options.params && this.options.params.ecmax\r\n        ? Number(this.options.params.ecmax)\r\n        : undefined;\r\n\r\n    const types = this.options.params?.type\r\n        ? this.options.params.type.replace(/\\s/g, '').toLowerCase().split(',')\r\n        : [\r\n            'adresses',\r\n            'codes-postaux',\r\n            'routes',\r\n            'intersections',\r\n            'municipalites',\r\n            'mrc',\r\n            'regadmin',\r\n            'lieux'\r\n          ];\r\n\r\n    return {\r\n      title: 'igo.geo.search.icherche.name',\r\n      searchUrl: 'https://geoegl.msp.gouv.qc.ca/apis/icherche',\r\n      settings: [\r\n        {\r\n          type: 'checkbox',\r\n          title: 'results type',\r\n          name: 'type',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.icherche.type.address',\r\n              value: 'adresses',\r\n              enabled: types.indexOf('adresses') !== -1,\r\n              hashtags: ['adresse']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.oldAddress',\r\n              value: 'anciennes-adresses',\r\n              enabled: types.indexOf('anciennes-adresses') !== -1,\r\n              hashtags: ['anciennes-adresses']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.postalCode',\r\n              value: 'codes-postaux',\r\n              enabled: types.indexOf('codes-postaux') !== -1,\r\n              hashtags: ['code-postal']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.road',\r\n              value: 'routes',\r\n              enabled: types.indexOf('routes') !== -1,\r\n              hashtags: ['route']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.intersection',\r\n              value: 'intersections',\r\n              enabled: types.indexOf('intersections') !== -1,\r\n              hashtags: ['intersection', '+']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.city',\r\n              value: 'municipalites',\r\n              enabled: types.indexOf('municipalites') !== -1,\r\n              hashtags: ['municipalit', 'mun']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.oldCity',\r\n              value: 'anciennes-municipalites',\r\n              enabled: types.indexOf('anciennes-municipalites') !== -1,\r\n              hashtags: ['anciennes-municipalites']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.mrc',\r\n              value: 'mrc',\r\n              enabled: types.indexOf('mrc') !== -1,\r\n              hashtags: ['mrc']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.regadmin',\r\n              value: 'regadmin',\r\n              enabled: types.indexOf('regadmin') !== -1,\r\n              hashtags: ['rgion-administrative', 'regadmin']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.entreprise',\r\n              value: 'entreprises',\r\n              enabled: types.indexOf('entreprises') !== -1,\r\n              available: false,\r\n              hashtags: ['entreprise']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.place',\r\n              value: 'lieux',\r\n              enabled: types.indexOf('lieux') !== -1,\r\n              hashtags: ['lieu']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.exit',\r\n              value: 'sorties-autoroute',\r\n              enabled: types.indexOf('sorties-autoroute') !== -1,\r\n              hashtags: ['sortie', 'sorties', 'exit']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.km',\r\n              value: 'bornes-km',\r\n              enabled: types.indexOf('bornes-km') !== -1,\r\n              hashtags: ['borne', 'bornes', 'repre', 'km']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.gcc',\r\n              value: 'bornes-gcc',\r\n              enabled: types.indexOf('bornes-gcc') !== -1,\r\n              hashtags: ['borne', 'bornes', 'repre', 'gcc', 'ccg']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.cn',\r\n              value: 'bornes-cn',\r\n              enabled: types.indexOf('bornes-cn') !== -1,\r\n              hashtags: ['borne', 'bornes', 'cn']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.sumi',\r\n              value: 'bornes-sumi',\r\n              enabled: types.indexOf('bornes-sumi') !== -1,\r\n              hashtags: ['borne', 'bornes', 'sumi']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.hq',\r\n              value: 'hq',\r\n              enabled: types.indexOf('hq') !== -1,\r\n              hashtags: ['hq']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.cadastre',\r\n              value: 'cadastre',\r\n              enabled: types.indexOf('cadastre') !== -1,\r\n              hashtags: ['cadastre']\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'results limit',\r\n          name: 'limit',\r\n          values: [\r\n            {\r\n              title: '1',\r\n              value: 1,\r\n              enabled: limit === 1\r\n            },\r\n            {\r\n              title: '5',\r\n              value: 5,\r\n              enabled: limit === 5 || !limit\r\n            },\r\n            {\r\n              title: '10',\r\n              value: 10,\r\n              enabled: limit === 10\r\n            },\r\n            {\r\n              title: '25',\r\n              value: 25,\r\n              enabled: limit === 25\r\n            },\r\n            {\r\n              title: '50',\r\n              value: 50,\r\n              enabled: limit === 50\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'ecmax',\r\n          name: 'ecmax',\r\n          values: [\r\n            {\r\n              title: '10 %',\r\n              value: 10,\r\n              enabled: ecmax === 10\r\n            },\r\n            {\r\n              title: '30 %',\r\n              value: 30,\r\n              enabled: ecmax === 30 || !ecmax\r\n            },\r\n            {\r\n              title: '50 %',\r\n              value: 50,\r\n              enabled: ecmax === 50\r\n            },\r\n            {\r\n              title: '75 %',\r\n              value: 75,\r\n              enabled: ecmax === 75\r\n            },\r\n            {\r\n              title: '100 %',\r\n              value: 100,\r\n              enabled: ecmax === 100\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'restrictExtent',\r\n          name: 'loc',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.icherche.restrictExtent.map',\r\n              value: 'true',\r\n              enabled: false\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.restrictExtent.quebec',\r\n              value: 'false',\r\n              enabled: true\r\n            }\r\n          ]\r\n        }\r\n      ]\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a location by name or keyword\r\n   * @param term Location name or keyword\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  search(\r\n    term: string,\r\n    options?: TextSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    const params = this.computeRequestParams(term, options || {});\r\n    if (!params.get('type').length) {\r\n      return of([]);\r\n    }\r\n    this.options.params.page = params.get('page') || '1';\r\n\r\n    return this.http.get(`${this.searchUrl}/geocode`, { params }).pipe(\r\n      map((response: IChercheResponse) => this.extractResults(response, term)),\r\n      catchError((err) => {\r\n        err.error.toDisplay = true;\r\n        err.error.title = this.languageService.translate.instant(\r\n          this.getDefaultOptions().title\r\n        );\r\n        throw err;\r\n      })\r\n    );\r\n  }\r\n\r\n  private getAllowedTypes() {\r\n    return this.http\r\n      .get(`${this.searchUrl}/types`)\r\n      .subscribe((types: string[]) => {\r\n        const typeSetting = this.settings.find((s) => s.name === 'type');\r\n        typeSetting.values.forEach((v) => {\r\n          const regex = new RegExp(`^${v.value}(\\\\.|$)`);\r\n          const typesMatched = types.filter((value) => regex.test(value));\r\n          v.available = typesMatched.length > 0;\r\n          if (v.value === 'lieux') {\r\n            this.hashtagsLieuxToKeep = [\r\n              ...(new Set(\r\n                typesMatched\r\n                  .map((t) => t.split('.'))\r\n                  .reduce((a, b) => a.concat(b))\r\n                  .filter((t) => t !== 'lieux')\r\n              ) as any)\r\n            ];\r\n          }\r\n        });\r\n        this.setParamFromSetting(typeSetting, false);\r\n      });\r\n  }\r\n\r\n  private computeRequestParams(\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): HttpParams {\r\n    const queryParams: any = Object.assign(\r\n      {\r\n        geometry: true,\r\n        bbox: true,\r\n        icon: true,\r\n        type:\r\n          'adresses,codes-postaux,municipalites,mrc,regadmin,lieux,entreprises,bornes-sumi'\r\n      },\r\n      this.params,\r\n      this.computeOptionsParam(term, options || {}).params,\r\n      {\r\n        q: this.computeTerm(term),\r\n        page: options.page\r\n      }\r\n    );\r\n\r\n    if (queryParams.loc === 'true') {\r\n      const [xMin, yMin, xMax, yMax] = options.extent;\r\n      queryParams.loc = `${xMin},${yMin};${xMax},${yMin};${xMax},${yMax};${xMin},${yMax};${xMin},${yMin}`;\r\n    } else if (queryParams.loc === 'false') {\r\n      delete queryParams.loc;\r\n    }\r\n\r\n    if (/#[A-Za-z]+/.test(queryParams.q)) {\r\n      queryParams.type = 'lieux';\r\n    }\r\n\r\n    return new HttpParams({\r\n      fromObject: ObjectUtils.removeUndefined(queryParams),\r\n      encoder: new IgoHttpParameterCodec()\r\n    });\r\n  }\r\n\r\n  private extractResults(response: IChercheResponse, term: string): SearchResult<Feature>[] {\r\n    return response.features.map((data: IChercheData) => {\r\n      return this.formatter.formatResult(this.dataToResult(data, term, response));\r\n    });\r\n  }\r\n\r\n  private dataToResult(\r\n    data: IChercheData,\r\n    term: string,\r\n    response?: IChercheResponse\r\n  ): SearchResult<Feature> {\r\n    const properties = this.computeProperties(data);\r\n    const id = [this.getId(), properties.type, properties.code].join('.');\r\n\r\n    const titleHtml = data.highlight.title || data.properties.nom;\r\n    const subtitleHtml = data.highlight.title2\r\n      ? ' <small> ' + data.highlight.title2 + '</small>'\r\n      : '';\r\n    const subtitleHtml2 = data.highlight.title3\r\n      ? '<br><small> ' + data.highlight.title3 + '</small>'\r\n      : '';\r\n\r\n    return {\r\n      source: this,\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry: data.geometry,\r\n        extent: data.bbox,\r\n        properties,\r\n        meta: {\r\n          id,\r\n          title: data.properties.nom\r\n        }\r\n      },\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id,\r\n        title: data.properties.nom,\r\n        titleHtml: titleHtml + subtitleHtml + subtitleHtml2,\r\n        icon: data.icon || 'map-marker',\r\n        score: data.score || computeTermSimilarity(term.trim(), data.properties.nom),\r\n        nextPage:\r\n          response.features.length % +this.options.params.limit === 0 &&\r\n          +this.options.params.page < 10\r\n      }\r\n    };\r\n  }\r\n\r\n  private computeProperties(data: IChercheData): { [key: string]: any } {\r\n    const properties = ObjectUtils.removeKeys(\r\n      data.properties,\r\n      IChercheSearchSource.propertiesBlacklist\r\n    );\r\n\r\n    if (!data.geometry) {\r\n      return Object.assign({ type: data.index }, properties);\r\n    }\r\n\r\n    const googleLinksProperties: {\r\n      GoogleMaps: string;\r\n      GoogleStreetView?: string;\r\n    } = {\r\n      GoogleMaps: ''\r\n    };\r\n\r\n    let googleMaps;\r\n    if (data.geometry.type === 'Point') {\r\n      googleMaps = GoogleLinks.getGoogleMapsCoordLink(\r\n        data.geometry.coordinates[0],\r\n        data.geometry.coordinates[1]\r\n      );\r\n    } else {\r\n      const point = pointOnFeature(data.geometry);\r\n      googleMaps = GoogleLinks.getGoogleMapsCoordLink(\r\n        point.geometry.coordinates[0],\r\n        point.geometry.coordinates[1]\r\n      );\r\n    }\r\n\r\n    let googleMapsNom;\r\n    if (data.index === 'routes') {\r\n      googleMapsNom = GoogleLinks.getGoogleMapsNameLink(\r\n        data.properties.nom + ', ' + data.properties.municipalite\r\n      );\r\n    } else if (data.index === 'municipalites') {\r\n      googleMapsNom = GoogleLinks.getGoogleMapsNameLink(\r\n        data.properties.nom + ', ' + 'ville'\r\n      );\r\n    } else if (data.index === 'mrc') {\r\n      googleMapsNom = GoogleLinks.getGoogleMapsNameLink(\r\n        'mrc+' + data.properties.nom\r\n      );\r\n    } else if (data.index === 'regadmin') {\r\n      googleMapsNom = GoogleLinks.getGoogleMapsNameLink(\r\n        data.properties.nom + ',+QC'\r\n      );\r\n    } else {\r\n      googleMapsNom = GoogleLinks.getGoogleMapsNameLink(\r\n        data.properties.nom || data.highlight.title\r\n      );\r\n    }\r\n\r\n    googleLinksProperties.GoogleMaps =\r\n      '<a href=' +\r\n      googleMaps +\r\n      ' target=\"_blank\">' +\r\n      this.languageService.translate.instant('igo.geo.searchByCoord') +\r\n      '</a> <br /> <a href=' +\r\n      googleMapsNom +\r\n      ' target=\"_blank\">' +\r\n      this.languageService.translate.instant('igo.geo.searchByName') +\r\n      '</a>';\r\n\r\n    if (data.geometry.type === 'Point') {\r\n      googleLinksProperties.GoogleStreetView = GoogleLinks.getGoogleStreetViewLink(\r\n        data.geometry.coordinates[0],\r\n        data.geometry.coordinates[1]\r\n      );\r\n    }\r\n\r\n    const routing: {\r\n      Route: string;\r\n    } = {\r\n      Route:\r\n        '<span class=\"routing\"> <u>' +\r\n        this.languageService.translate.instant('igo.geo.seeRouting') +\r\n        '</u> </span>'\r\n    };\r\n\r\n    return Object.assign(\r\n      { type: data.index },\r\n      properties,\r\n      googleLinksProperties,\r\n      routing\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Remove hashtag from query\r\n   * @param term Query with hashtag\r\n   */\r\n  private computeTerm(term: string): string {\r\n    // Keep hashtags for \"lieux\"\r\n    const hashtags = term.match(/(#[A-Za-z]+)/g) || [];\r\n    let keep = false;\r\n    keep = hashtags.some((hashtag) => {\r\n      const hashtagKey = hashtag.substring(1);\r\n      return this.hashtagsLieuxToKeep.some(\r\n        (h) =>\r\n          h\r\n            .toLowerCase()\r\n            .normalize('NFD')\r\n            .replace(/[\\u0300-\\u036f]/g, '') ===\r\n          hashtagKey\r\n            .toLowerCase()\r\n            .normalize('NFD')\r\n            .replace(/[\\u0300-\\u036f]/g, '')\r\n      );\r\n    });\r\n\r\n    if (!keep) {\r\n      term = term.replace(/(#[A-Za-z]+)/g, '');\r\n    }\r\n\r\n    return term.replace(/[^\\w- !\\-\\+\\(\\)\\.\\/,'#]+/g, '');\r\n  }\r\n\r\n  /**\r\n   * Add hashtag to param if valid\r\n   * @param term Query with hashtag\r\n   * @param options TextSearchOptions\r\n   */\r\n  private computeOptionsParam(\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): TextSearchOptions {\r\n    const hashtags = super.getHashtagsValid(term, 'type');\r\n    if (hashtags) {\r\n      options.params = Object.assign(options.params || {}, {\r\n        type: hashtags.join(',')\r\n      });\r\n    }\r\n\r\n    return options;\r\n  }\r\n}\r\n\r\n/**\r\n * IChercheReverse search source\r\n */\r\n@Injectable()\r\nexport class IChercheReverseSearchSource extends SearchSource\r\n  implements ReverseSearch {\r\n  static id = 'icherchereverse';\r\n  static type = FEATURE;\r\n  static propertiesBlacklist: string[] = [];\r\n\r\n  title$: BehaviorSubject<string> = new BehaviorSubject<string>('');\r\n\r\n  get title(): string {\r\n    return this.title$.getValue();\r\n  }\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private languageService: LanguageService,\r\n    storageService: StorageService,\r\n    @Inject('options') options: SearchSourceOptions,\r\n    injector: Injector,\r\n  ) {\r\n    super(options, storageService);\r\n\r\n    this.languageService.translate\r\n      .get(this.options.title)\r\n      .subscribe((title) => this.title$.next(title));\r\n\r\n    const authService = injector.get(AuthService);\r\n    if (this.settings.length) {\r\n      if (!authService) {\r\n        this.getAllowedTypes();\r\n      } else {\r\n        authService.authenticate$.subscribe(() => {\r\n          this.getAllowedTypes();\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  getId(): string {\r\n    return IChercheReverseSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return IChercheReverseSearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    const types =\r\n      this.options.params && this.options.params.type\r\n        ? this.options.params.type.replace(/\\s/g, '').toLowerCase().split(',')\r\n        : ['adresses', 'municipalites', 'mrc', 'regadmin'];\r\n\r\n    return {\r\n      title: 'igo.geo.search.ichercheReverse.name',\r\n      searchUrl: 'https://geoegl.msp.gouv.qc.ca/apis/terrapi',\r\n      settings: [\r\n        {\r\n          type: 'checkbox',\r\n          title: 'results type',\r\n          name: 'type',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.icherche.type.address',\r\n              value: 'adresses',\r\n              enabled: types.indexOf('adresses') !== -1\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.road',\r\n              value: 'routes',\r\n              enabled: types.indexOf('routes') !== -1,\r\n              available: false\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.district',\r\n              value: 'arrondissements',\r\n              enabled: types.indexOf('arrondissements') !== -1\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.city',\r\n              value: 'municipalites',\r\n              enabled: types.indexOf('municipalites') !== -1\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.mrc',\r\n              value: 'mrc',\r\n              enabled: types.indexOf('mrc') !== -1\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.regadmin',\r\n              value: 'regadmin',\r\n              enabled: types.indexOf('regadmin') !== -1\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'radius',\r\n          name: 'bufferInput',\r\n          values: [\r\n            {\r\n              title: '100 m',\r\n              value: 100,\r\n              enabled: !this.options.distance || this.options.distance === 100\r\n            },\r\n            {\r\n              title: '500 m',\r\n              value: 500,\r\n              enabled: this.options.distance === 500\r\n            },\r\n            {\r\n              title: '1 km',\r\n              value: 1000,\r\n              enabled: this.options.distance === 1000\r\n            },\r\n            {\r\n              title: '2 km',\r\n              value: 2000,\r\n              enabled: this.options.distance === 2000\r\n            },\r\n            {\r\n              title: '5 km',\r\n              value: 5000,\r\n              enabled: this.options.distance === 5000\r\n            }\r\n          ]\r\n        }\r\n      ]\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a location by coordinates\r\n   * @param lonLat Location coordinates\r\n   * @param distance Search raidus around lonLat\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  reverseSearch(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    const params = this.computeRequestParams(lonLat, options || {});\r\n    if (!params.get('type').length) {\r\n      return of([]);\r\n    }\r\n    return this.http.get(`${this.searchUrl}/locate`, { params }).pipe(\r\n      map((response: IChercheReverseResponse) => {\r\n        return this.extractResults(response);\r\n      })\r\n    );\r\n  }\r\n\r\n  private getAllowedTypes() {\r\n    return this.http\r\n      .get(`${this.searchUrl}/types`)\r\n      .subscribe((types: string[]) => {\r\n        const typeSetting = this.settings.find((s) => s.name === 'type');\r\n        typeSetting.values.forEach((v) => {\r\n          v.available = types.indexOf(v.value as string) > -1;\r\n        });\r\n        this.setParamFromSetting(typeSetting, false);\r\n      });\r\n  }\r\n\r\n  private computeRequestParams(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions\r\n  ): HttpParams {\r\n    if (options.distance || this.options.distance) {\r\n      options.params = Object.assign(options.params || {}, {\r\n        bufferInput: options.distance || this.options.distance\r\n      });\r\n    }\r\n\r\n    return new HttpParams({\r\n      fromObject: Object.assign(\r\n        {\r\n          loc: lonLat.join(','),\r\n          sort: 'distance',\r\n          geometry: true,\r\n          icon: true\r\n        },\r\n        options.params || {},\r\n        this.params\r\n      )\r\n    });\r\n  }\r\n\r\n  private extractResults(\r\n    response: IChercheReverseResponse\r\n  ): SearchResult<Feature>[] {\r\n    return response.features.map((data: IChercheReverseData) => {\r\n      return this.dataToResult(data);\r\n    });\r\n  }\r\n\r\n  private getSubtitle(data: IChercheReverseData) {\r\n    if (!this.settings.length) {\r\n      return '';\r\n    }\r\n    let subtitle = '';\r\n    switch (data.properties.type) {\r\n      case 'arrondissements':\r\n        subtitle = data.properties.municipalite + ' (Arrondissement)';\r\n        break;\r\n      default:\r\n        const typeSetting = this.settings.find((s) => s.name === 'type');\r\n        const type = typeSetting.values.find(\r\n          (t) => t.value === data.properties.type\r\n        );\r\n        if (type) {\r\n          subtitle = this.languageService.translate.instant(type.title);\r\n        }\r\n    }\r\n    return subtitle;\r\n  }\r\n\r\n  private dataToResult(data: IChercheReverseData): SearchResult<Feature> {\r\n    const properties = this.computeProperties(data);\r\n    const extent = this.computeExtent(data);\r\n    const id = [this.getId(), properties.type, properties.code].join('.');\r\n\r\n    const titleHtml = data.properties.nom;\r\n    const subtitleHtml = ' <small> ' + this.getSubtitle(data) + '</small>';\r\n\r\n    return {\r\n      source: this,\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry: data.geometry,\r\n        extent,\r\n        properties,\r\n        meta: {\r\n          id,\r\n          title: data.properties.nom\r\n        }\r\n      },\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id,\r\n        title: data.properties.nom,\r\n        titleHtml: titleHtml + subtitleHtml,\r\n        icon: data.icon || 'map-marker',\r\n        pointerSummaryTitle: this.getSubtitle(data)+ ': ' + data.properties.nom\r\n      }\r\n    };\r\n  }\r\n\r\n  private computeProperties(data: IChercheReverseData): { [key: string]: any } {\r\n    const properties = ObjectUtils.removeKeys(\r\n      data.properties,\r\n      IChercheReverseSearchSource.propertiesBlacklist\r\n    );\r\n\r\n    const routing: {\r\n      Route: string;\r\n    } = {\r\n      Route:\r\n        '<span class=\"routing\"> <u>' +\r\n        this.languageService.translate.instant('igo.geo.seeRouting') +\r\n        '</u> </span>'\r\n    };\r\n\r\n    return Object.assign(properties, routing);\r\n  }\r\n\r\n  private computeExtent(\r\n    data: IChercheReverseData\r\n  ): [number, number, number, number] | undefined {\r\n    return data.bbox\r\n      ? [data.bbox[0], data.bbox[2], data.bbox[1], data.bbox[3]]\r\n      : undefined;\r\n  }\r\n}\r\n","import { Injector } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\n\r\nimport { ConfigService, LanguageService, StorageService } from '@igo2/core';\r\n\r\nimport { SearchSource } from './source';\r\nimport {\r\n  IChercheSearchSource,\r\n  IChercheSearchResultFormatter,\r\n  IChercheReverseSearchSource\r\n} from './icherche';\r\n\r\n/**\r\n * ICherche search result formatter factory\r\n * @ignore\r\n */\r\nexport function defaultIChercheSearchResultFormatterFactory(\r\n  languageService: LanguageService\r\n) {\r\n  return new IChercheSearchResultFormatter(languageService);\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the ICherche search result formatter\r\n */\r\nexport function provideDefaultIChercheSearchResultFormatter() {\r\n  return {\r\n    provide: IChercheSearchResultFormatter,\r\n    useFactory: defaultIChercheSearchResultFormatterFactory,\r\n    deps: [LanguageService]\r\n  };\r\n}\r\n\r\n/**\r\n * ICherche search source factory\r\n * @ignore\r\n */\r\nexport function ichercheSearchSourceFactory(\r\n  http: HttpClient,\r\n  languageService: LanguageService,\r\n  storageService: StorageService,\r\n  config: ConfigService,\r\n  formatter: IChercheSearchResultFormatter,\r\n  injector: Injector\r\n) {\r\n  return new IChercheSearchSource(\r\n    http,\r\n    languageService,\r\n    storageService,\r\n    config.getConfig(`searchSources.${IChercheSearchSource.id}`),\r\n    formatter,\r\n    injector\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the ICherche search source\r\n */\r\nexport function provideIChercheSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: ichercheSearchSourceFactory,\r\n    multi: true,\r\n    deps: [\r\n      HttpClient,\r\n      LanguageService,\r\n      StorageService,\r\n      ConfigService,\r\n      IChercheSearchResultFormatter,\r\n      Injector\r\n    ]\r\n  };\r\n}\r\n\r\n/**\r\n * IChercheReverse search source factory\r\n * @ignore\r\n */\r\nexport function ichercheReverseSearchSourceFactory(\r\n  http: HttpClient,\r\n  languageService: LanguageService,\r\n  storageService: StorageService,\r\n  config: ConfigService,\r\n  injector: Injector\r\n) {\r\n  return new IChercheReverseSearchSource(\r\n    http,\r\n    languageService,\r\n    storageService,\r\n    config.getConfig(`searchSources.${IChercheReverseSearchSource.id}`),\r\n    injector\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the IChercheReverse search source\r\n */\r\nexport function provideIChercheReverseSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: ichercheReverseSearchSourceFactory,\r\n    multi: true,\r\n    deps: [HttpClient, LanguageService, StorageService, ConfigService, Injector]\r\n  };\r\n}\r\n","import { Injectable, Inject } from '@angular/core';\r\nimport { Observable, BehaviorSubject, of } from 'rxjs';\r\nimport * as olproj from 'ol/proj';\r\nimport { fromCircle } from 'ol/geom/Polygon';\r\nimport OlCircle from 'ol/geom/Circle';\r\nimport * as olformat from 'ol/format';\r\n\r\nimport { FEATURE, Feature, FeatureGeometry } from '../../../feature';\r\n\r\nimport { SearchResult } from '../search.interfaces';\r\nimport { SearchSource, ReverseSearch } from './source';\r\nimport { SearchSourceOptions, ReverseSearchOptions } from './source.interfaces';\r\n\r\nimport { LanguageService, StorageService } from '@igo2/core';\r\nimport { GoogleLinks } from '../../../utils/googleLinks';\r\nimport { Projection } from '../../../map/shared/projection.interfaces';\r\nimport { lonLatConversion, roundCoordTo, convertDDToDMS } from '../../../map/shared/map.utils';\r\nimport { OsmLinks } from '../../../utils';\r\nimport { Cacheable } from 'ts-cacheable';\r\n\r\n@Injectable()\r\nexport class CoordinatesSearchResultFormatter {\r\n  constructor(private languageService: LanguageService) {}\r\n\r\n  formatResult(result: SearchResult<Feature>): SearchResult<Feature> {\r\n    return result;\r\n  }\r\n}\r\n/**\r\n * CoordinatesReverse search source\r\n */\r\n@Injectable()\r\nexport class CoordinatesReverseSearchSource extends SearchSource\r\n  implements ReverseSearch {\r\n  static id = 'coordinatesreverse';\r\n  static type = FEATURE;\r\n\r\n  private projections;\r\n\r\n  title$: BehaviorSubject<string> = new BehaviorSubject<string>('');\r\n\r\n  get title(): string {\r\n    return this.title$.getValue();\r\n  }\r\n\r\n  constructor(\r\n    @Inject('options') options: SearchSourceOptions,\r\n    private languageService: LanguageService,\r\n    storageService: StorageService,\r\n    @Inject('projections') projections: Projection[],\r\n  ) {\r\n    super(options, storageService);\r\n    this.projections = projections;\r\n    this.languageService.translate\r\n      .get(this.options.title)\r\n      .subscribe(title => this.title$.next(title));\r\n  }\r\n\r\n  getId(): string {\r\n    return CoordinatesReverseSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return CoordinatesReverseSearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    return {\r\n      title: 'igo.geo.search.coordinates.name',\r\n      order: 1,\r\n      showInSettings: false\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a location by coordinates\r\n   * @param lonLat Location coordinates\r\n   * @param options options of ReverseSearchOptions (distance, conf, zoom, params)\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  reverseSearch(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    return of([this.dataToResult(lonLat, options)]);\r\n  }\r\n\r\n  private dataToResult(data: [number, number], options: ReverseSearchOptions): SearchResult<Feature> {\r\n    const dataDMS = convertDDToDMS(data);\r\n    const convertedCoord = lonLatConversion(data, this.projections);\r\n    const coords = convertedCoord.reduce((obj, item) => (\r\n      obj[item.alias] = item.igo2CoordFormat, obj), {});\r\n\r\n    const roundedCoordString = roundCoordTo(data, 6).join(', ');\r\n    const roundedCoordStringDMS = dataDMS.join(', ');\r\n\r\n    let geometry: FeatureGeometry = {\r\n      type: 'Point',\r\n      coordinates: [data[0], data[1]]\r\n    };\r\n\r\n    const properties = {};\r\n    let subtitleHtml = '';\r\n    if (options.distance) {\r\n      const radiusKey = this.languageService.translate.instant('igo.geo.search.coordinates.radius');\r\n      properties[radiusKey] = options.distance;\r\n      subtitleHtml = '<br><small>Rayon: ' + options.distance + ' m</small>';\r\n\r\n      // Create polygon\r\n      const center = olproj.transform([data[0], data[1]], 'EPSG:4326', 'EPSG:3857');\r\n      const circleGeometry = new OlCircle(center, options.distance);\r\n      const polygonGeometry = fromCircle(circleGeometry);\r\n      const writer = new olformat.GeoJSON();\r\n      geometry = JSON.parse(writer.writeGeometry(polygonGeometry.transform('EPSG:3857', 'EPSG:4326')));\r\n    }\r\n\r\n    if (options.conf) {\r\n      const confKey = this.languageService.translate.instant('igo.geo.search.coordinates.conf');\r\n      properties[confKey] = options.conf;\r\n      subtitleHtml += subtitleHtml === '' ? '<br>' : '<small> - </small>';\r\n      subtitleHtml += '<small>Confiance: ' + options.conf + '%</small>';\r\n    }\r\n\r\n    const coordKey = this.languageService.translate.instant('igo.geo.search.coordinates.coord');\r\n    properties[coordKey] = roundedCoordString;\r\n\r\n    const coordKeyDMS = this.languageService.translate.instant('igo.geo.search.coordinates.coordDMS');\r\n    properties[coordKeyDMS] = roundedCoordStringDMS;\r\n\r\n    return {\r\n      source: this,\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry,\r\n        extent: undefined,\r\n        properties: Object.assign(\r\n          properties,\r\n          coords,\r\n          {\r\n            GoogleMaps: GoogleLinks.getGoogleMapsCoordLink(data[0], data[1]),\r\n            GoogleStreetView: GoogleLinks.getGoogleStreetViewLink(\r\n              data[0],\r\n              data[1]\r\n            ),\r\n            OpenStreetMap: OsmLinks.getOpenStreetMapLink(data[0], data[1], 14),\r\n            Route: '<span class=\"routing\"> <u>' + this.languageService.translate.instant('igo.geo.seeRouting') + '</u> </span>'\r\n          }\r\n        ),\r\n        meta: {\r\n          id: data[0].toString() + ',' + data[1].toString(),\r\n          title: roundedCoordString\r\n        }\r\n      },\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id: data[0].toString() + ',' + data[1].toString(),\r\n        title: roundedCoordString,\r\n        titleHtml: roundedCoordString + subtitleHtml,\r\n        icon: 'map-marker',\r\n        score: 100, // every coord exists\r\n      }\r\n    };\r\n  }\r\n}\r\n","import { ConfigService, LanguageService, StorageService } from '@igo2/core';\r\n\r\nimport { SearchSource } from './source';\r\nimport {\r\n  CoordinatesReverseSearchSource,\r\n  CoordinatesSearchResultFormatter\r\n} from './coordinates';\r\nimport { Projection } from '../../../map/shared/projection.interfaces';\r\nimport { ProjectionService } from '../../../map/shared/projection.service';\r\n\r\n/**\r\n * ICherche search result formatter factory\r\n * @ignore\r\n */\r\nexport function defaultCoordinatesSearchResultFormatterFactory(\r\n  languageService: LanguageService\r\n) {\r\n  return new CoordinatesSearchResultFormatter(languageService);\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the ICherche search result formatter\r\n */\r\nexport function provideDefaultCoordinatesSearchResultFormatter() {\r\n  return {\r\n    provide: CoordinatesSearchResultFormatter,\r\n    useFactory: defaultCoordinatesSearchResultFormatterFactory,\r\n    deps: [LanguageService]\r\n  };\r\n}\r\n\r\n/**\r\n * CoordinatesReverse search source factory\r\n * @ignore\r\n */\r\nexport function CoordinatesReverseSearchSourceFactory(\r\n  config: ConfigService,\r\n  languageService: LanguageService,\r\n  storageService: StorageService,\r\n  _projectionService: ProjectionService\r\n) {\r\n  return new CoordinatesReverseSearchSource(\r\n    config.getConfig(`searchSources.${CoordinatesReverseSearchSource.id}`),\r\n    languageService,\r\n    storageService,\r\n    (config.getConfig('projections') as Projection[]) || []\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the IChercheReverse search source\r\n */\r\nexport function provideCoordinatesReverseSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: CoordinatesReverseSearchSourceFactory,\r\n    multi: true,\r\n    deps: [ConfigService, LanguageService, StorageService, ProjectionService]\r\n  };\r\n}\r\n","import { Injectable, Inject } from '@angular/core';\r\nimport { HttpClient, HttpParams } from '@angular/common/http';\r\n\r\nimport { Observable, BehaviorSubject, of } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { LanguageService, StorageService } from '@igo2/core';\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport { getResolutionFromScale } from '../../../map/shared/map.utils';\r\nimport { LAYER } from '../../../layer';\r\nimport { QueryableDataSourceOptions, QueryFormat } from '../../../query';\r\nimport { QueryHtmlTarget } from './../../../query/shared/query.enums';\r\n\r\nimport { SearchResult } from '../search.interfaces';\r\nimport { SearchSource, TextSearch } from './source';\r\nimport { TextSearchOptions } from './source.interfaces';\r\nimport {\r\n  ILayerSearchSourceOptions,\r\n  ILayerData,\r\n  ILayerItemResponse,\r\n  ILayerServiceResponse,\r\n  ILayerDataSource\r\n} from './ilayer.interfaces';\r\nimport { computeTermSimilarity } from '../search.utils';\r\nimport { Cacheable } from 'ts-cacheable';\r\n\r\n@Injectable()\r\nexport class ILayerSearchResultFormatter {\r\n  constructor(private languageService: LanguageService) {}\r\n\r\n  formatResult(data: ILayerData): ILayerData {\r\n    const allowedKey = [\r\n      'title',\r\n      'abstract',\r\n      'groupTitle',\r\n      'metadataUrl',\r\n      'downloadUrl',\r\n      'urlInfo',\r\n      'name'\r\n    ];\r\n\r\n    const property = Object.entries(data.properties)\r\n      .filter(([key]) => allowedKey.indexOf(key) !== -1)\r\n      .reduce((out: { [key: string]: any }, entries: [string, any]) => {\r\n        const [key, value] = entries;\r\n        let newKey;\r\n        try {\r\n          newKey = this.languageService.translate.instant(\r\n            'igo.geo.search.ilayer.properties.' + key\r\n          );\r\n        } catch (e) {\r\n          newKey = key;\r\n        }\r\n        out[newKey] = value ? value : '';\r\n        return out;\r\n      }, {});\r\n\r\n    const dataR = Object.assign({}, data);\r\n    dataR.properties = property as ILayerDataSource;\r\n\r\n    return dataR;\r\n  }\r\n}\r\n\r\n/**\r\n * ILayer search source\r\n */\r\n@Injectable()\r\nexport class ILayerSearchSource extends SearchSource implements TextSearch {\r\n  static id = 'ilayer';\r\n  static type = LAYER;\r\n\r\n  title$: BehaviorSubject<string> = new BehaviorSubject<string>('');\r\n\r\n  get title(): string {\r\n    return this.title$.getValue();\r\n  }\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private languageService: LanguageService,\r\n    storageService: StorageService,\r\n    @Inject('options') options: ILayerSearchSourceOptions,\r\n    @Inject(ILayerSearchResultFormatter)\r\n    private formatter: ILayerSearchResultFormatter\r\n  ) {\r\n    super(options, storageService);\r\n    this.languageService.translate\r\n      .get(this.options.title)\r\n      .subscribe(title => this.title$.next(title));\r\n  }\r\n\r\n  getId(): string {\r\n    return ILayerSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return ILayerSearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): ILayerSearchSourceOptions {\r\n    const limit =\r\n      this.options.params && this.options.params.limit\r\n        ? Number(this.options.params.limit)\r\n        : undefined;\r\n    const ecmax =\r\n      this.options.params && this.options.params.ecmax\r\n        ? Number(this.options.params.ecmax)\r\n        : undefined;\r\n    return {\r\n      title: 'igo.geo.search.ilayer.name',\r\n      searchUrl: 'https://geoegl.msp.gouv.qc.ca/apis/layers/search',\r\n      settings: [\r\n        {\r\n          type: 'checkbox',\r\n          title: 'results type',\r\n          name: 'type',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.ilayer.type.layer',\r\n              value: 'layer',\r\n              enabled: true,\r\n              hashtags: ['layer', 'layers', 'couche', 'couches']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.ilayer.type.groupLayer',\r\n              value: 'group',\r\n              enabled: false,\r\n              hashtags: ['gr-layer', 'gr-layers', 'gr-couche', 'gr-couches']\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'results limit',\r\n          name: 'limit',\r\n          values: [\r\n            {\r\n              title: '1',\r\n              value: 1,\r\n              enabled: limit === 1\r\n            },\r\n            {\r\n              title: '5',\r\n              value: 5,\r\n              enabled: limit === 5 || !limit\r\n            },\r\n            {\r\n              title: '10',\r\n              value: 10,\r\n              enabled: limit === 10\r\n            },\r\n            {\r\n              title: '25',\r\n              value: 25,\r\n              enabled: limit === 25\r\n            },\r\n            {\r\n              title: '50',\r\n              value: 50,\r\n              enabled: limit === 50\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'ecmax',\r\n          name: 'ecmax',\r\n          values: [\r\n            {\r\n              title: '10 %',\r\n              value: 10,\r\n              enabled: ecmax === 10\r\n            },\r\n            {\r\n              title: '30 %',\r\n              value: 30,\r\n              enabled: ecmax === 30\r\n            },\r\n            {\r\n              title: '50 %',\r\n              value: 50,\r\n              enabled: ecmax === 50 || !ecmax\r\n            },\r\n            {\r\n              title: '75 %',\r\n              value: 75,\r\n              enabled: ecmax === 75\r\n            },\r\n            {\r\n              title: '100 %',\r\n              value: 100,\r\n              enabled: ecmax === 100\r\n            }\r\n          ]\r\n        }\r\n      ]\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a layer by name or keyword\r\n   * @param term Layer name or keyword\r\n   * @returns Observable of <SearchResult<LayerOptions>[]\r\n   */\r\n\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  search(\r\n    term: string | undefined,\r\n    options?: TextSearchOptions\r\n  ): Observable<SearchResult<ILayerItemResponse>[]> {\r\n    const params = this.computeSearchRequestParams(term, options || {});\r\n    if (!params.get('q') || !params.get('type')) {\r\n      return of([]);\r\n    }\r\n    this.options.params.page = params.get('page') || '1';\r\n\r\n    return this.http\r\n      .get(this.searchUrl, { params })\r\n      .pipe(\r\n        map((response: ILayerServiceResponse) => this.extractResults(response, term))\r\n      );\r\n  }\r\n\r\n  private computeSearchRequestParams(\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): HttpParams {\r\n    return new HttpParams({\r\n      fromObject: ObjectUtils.removeUndefined(\r\n        Object.assign(\r\n          {\r\n            q: this.computeTerm(term)\r\n          },\r\n          this.params,\r\n          this.computeOptionsParam(term, options || {}).params,\r\n          {\r\n            page: options.page\r\n          }\r\n        )\r\n      )\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Remove hashtag from query\r\n   * @param term Query with hashtag\r\n   */\r\n  private computeTerm(term: string): string {\r\n    return term.replace(/(#[^\\s]*)/g, '').replace(/[^\\w- !\\-\\(\\),'#]+/g, '');\r\n  }\r\n\r\n  /**\r\n   * Add hashtag to param if valid\r\n   * @param term Query with hashtag\r\n   * @param options TextSearchOptions\r\n   */\r\n  private computeOptionsParam(\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): TextSearchOptions {\r\n    const hashtags = super.getHashtagsValid(term, 'type');\r\n    if (hashtags) {\r\n      options.params = Object.assign(options.params || {}, {\r\n        type: hashtags.join(',')\r\n      });\r\n    }\r\n\r\n    return options;\r\n  }\r\n\r\n  private extractResults(\r\n    response: ILayerServiceResponse, term: string\r\n  ): SearchResult<ILayerItemResponse>[] {\r\n    return response.items.map((data: ILayerData) =>\r\n    this.dataToResult(data, term, response)\r\n    );\r\n  }\r\n\r\n  private dataToResult(\r\n    data: ILayerData,\r\n    term: string,\r\n    response?: ILayerServiceResponse\r\n  ): SearchResult<ILayerItemResponse> {\r\n    const layerOptions = this.computeLayerOptions(data);\r\n\r\n    const titleHtml = data.highlight.title || data.properties.title;\r\n    const groupTitle = data.highlight.groupTitle || data.properties.groupTitle;\r\n    const subtitleHtml = groupTitle\r\n      ? ' <small style=\"color: #6f6969\"> ' + groupTitle + '</small>'\r\n      : '';\r\n\r\n    return {\r\n      source: this,\r\n      meta: {\r\n        dataType: LAYER,\r\n        id: [this.getId(), data.properties.id].join('.'),\r\n        title: data.properties.title,\r\n        titleHtml: titleHtml + subtitleHtml,\r\n        icon: data.properties.type === 'Layer' ? 'layers' : 'map',\r\n        score: data.score || computeTermSimilarity(term.trim(), data.properties.name),\r\n        nextPage:\r\n          response.items.length % +this.options.params.limit === 0 &&\r\n          +this.options.params.page < 10\r\n      },\r\n      data: layerOptions\r\n    };\r\n  }\r\n\r\n  private computeLayerOptions(data: ILayerData): ILayerItemResponse {\r\n    const url = data.properties.url;\r\n    const queryParams: QueryableDataSourceOptions = this.extractQueryParamsFromSourceUrl(\r\n      url\r\n    );\r\n    return ObjectUtils.removeUndefined({\r\n      sourceOptions: {\r\n        id: data.properties.id,\r\n        type: data.properties.format,\r\n        url,\r\n        queryFormat: queryParams.queryFormat,\r\n        queryHtmlTarget: queryParams.queryHtmlTarget,\r\n        params: data.properties.format === 'wms' ? {LAYERS: data.properties.name} : undefined,\r\n        layer: data.properties.format === 'wms' ? undefined : data.properties.name,\r\n        optionsFromCapabilities: true,\r\n        crossOrigin: 'anonymous'\r\n      },\r\n      title: data.properties.title,\r\n      maxResolution: getResolutionFromScale(\r\n        Number(data.properties.maxScaleDenom)\r\n      ),\r\n      minResolution: getResolutionFromScale(\r\n        Number(data.properties.minScaleDenom)\r\n      ),\r\n      metadata: {\r\n        url: data.properties.metadataUrl,\r\n        extern: data.properties.metadataUrl ? true : undefined,\r\n        abstract: data.properties.abstract || undefined\r\n      },\r\n      properties: this.formatter.formatResult(data).properties\r\n    });\r\n  }\r\n\r\n  private extractQueryParamsFromSourceUrl(\r\n    url: string\r\n  ): { queryFormat: QueryFormat; queryHtmlTarget: QueryHtmlTarget } {\r\n    let queryFormat;\r\n    let queryHtmlTarget;\r\n    const formatOpt = (this.options as ILayerSearchSourceOptions).queryFormat;\r\n    if (formatOpt) {\r\n      for (const key of Object.keys(formatOpt)) {\r\n        const value = formatOpt[key];\r\n        if (value === '*') {\r\n          queryFormat = QueryFormat[key.toUpperCase()];\r\n          break;\r\n        }\r\n\r\n        const urls = ((value as any) as { urls: string[] }).urls;\r\n        if (Array.isArray(urls)) {\r\n          urls.forEach(urlOpt => {\r\n            if (url.indexOf(urlOpt) !== -1) {\r\n              queryFormat = QueryFormat[key.toUpperCase()];\r\n            }\r\n          });\r\n          break;\r\n        }\r\n      }\r\n\r\n      if (\r\n        queryFormat === QueryFormat.HTML ||\r\n        queryFormat === QueryFormat.HTMLGML2\r\n      ) {\r\n        queryHtmlTarget = 'iframe';\r\n      }\r\n    }\r\n\r\n    return {\r\n      queryFormat,\r\n      queryHtmlTarget\r\n    };\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\n\r\nimport { ConfigService, LanguageService, StorageService } from '@igo2/core';\r\n\r\nimport { SearchSource } from './source';\r\nimport { ILayerSearchSource, ILayerSearchResultFormatter } from './ilayer';\r\n\r\n/**\r\n * ILayer search result formatter factory\r\n * @ignore\r\n */\r\nexport function ilayerSearchResultFormatterFactory(\r\n  languageService: LanguageService\r\n) {\r\n  return new ILayerSearchResultFormatter(languageService);\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the ILayer search result formatter\r\n */\r\nexport function provideILayerSearchResultFormatter() {\r\n  return {\r\n    provide: ILayerSearchResultFormatter,\r\n    useFactory: ilayerSearchResultFormatterFactory,\r\n    deps: [LanguageService]\r\n  };\r\n}\r\n\r\n/**\r\n * ILayer search source factory\r\n * @ignore\r\n */\r\nexport function ilayerSearchSourceFactory(\r\n  http: HttpClient,\r\n  languageService: LanguageService,\r\n  storageService: StorageService,\r\n  config: ConfigService,\r\n  formatter: ILayerSearchResultFormatter\r\n) {\r\n  return new ILayerSearchSource(\r\n    http,\r\n    languageService,\r\n    storageService,\r\n    config.getConfig(`searchSources.${ILayerSearchSource.id}`),\r\n    formatter\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the ILayer search source\r\n */\r\nexport function provideILayerSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: ilayerSearchSourceFactory,\r\n    multi: true,\r\n    deps: [HttpClient, LanguageService, StorageService, ConfigService, ILayerSearchResultFormatter]\r\n  };\r\n}\r\n","import { FEATURE } from '../../feature';\r\nimport { LAYER } from '../../layer';\r\n\r\nexport const SEARCH_TYPES = [FEATURE, LAYER];\r\n","<div class=\"igo-search-selector\">\r\n  <button\r\n    mat-icon-button\r\n    class=\"igo-search-selector-button\"\r\n    color=\"primary\"\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"'igo.geo.search.menu.tooltip' | translate\"\r\n    [matMenuTriggerFor]=\"searchSelectorMenu\">\r\n    <mat-icon svgIcon=\"menu-down\"></mat-icon>\r\n  </button>\r\n\r\n  <mat-menu\r\n    #searchSelectorMenu=\"matMenu\"\r\n    class=\"no-border-radius\"\r\n    xPosition=\"before\"\r\n    yPosition=\"above\">\r\n    <mat-radio-group\r\n      class=\"igo-search-selector-radio-group\"\r\n      [value]=\"searchType$ | async\"\r\n      (change)=\"onSearchTypeChange($event.value)\">\r\n      <mat-radio-button *ngFor=\"let searchType of searchTypes\" [value]=\"searchType\">\r\n        {{getSearchTypeTitle(searchType) | translate}}\r\n      </mat-radio-button>\r\n    </mat-radio-group>\r\n  </mat-menu>\r\n\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport { distinctUntilChanged } from 'rxjs/operators';\r\n\r\nimport { SEARCH_TYPES } from '../shared/search.enums';\r\nimport { SearchSourceService } from '../shared/search-source.service';\r\n\r\n/**\r\n * This component allows a user to select a search type yo enable. In it's\r\n * current version, only one search type can be selected at once (radio). If\r\n * this component were to support more than one search source enabled (checkbox),\r\n * the searchbar component would require a small change to it's\r\n * placeholder getter. The search source service already supports having\r\n * more than one search source enabled.\r\n */\r\n@Component({\r\n  selector: 'igo-search-selector',\r\n  templateUrl: './search-selector.component.html',\r\n  styleUrls: ['./search-selector.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SearchSelectorComponent implements OnInit, OnDestroy {\r\n\r\n  readonly searchType$: BehaviorSubject<string> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Subscription to the search type\r\n   */\r\n  private searchType$$: Subscription;\r\n\r\n  /**\r\n   * List of available search types\r\n   */\r\n  @Input() searchTypes: string[] = SEARCH_TYPES;\r\n\r\n  /**\r\n   * The search type enabled\r\n   */\r\n  @Input()\r\n  set searchType(value: string) { this.setSearchType(value); }\r\n  get searchType(): string { return this.searchType$.value; }\r\n\r\n  /**\r\n   * Event emitted when the enabled search type changes\r\n   */\r\n  @Output() searchTypeChange = new EventEmitter<string>();\r\n\r\n  constructor(private searchSourceService: SearchSourceService) {}\r\n\r\n  ngOnInit() {\r\n    this.searchType$$ = this.searchType$\r\n      .pipe(distinctUntilChanged())\r\n      .subscribe((searchType: string) => this.onSetSearchType(searchType));\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.searchType$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * Enable the selected search type\r\n   * @param searchType Search type\r\n   * @internal\r\n   */\r\n  onSearchTypeChange(searchType: string) {\r\n    this.setSearchType(searchType);\r\n  }\r\n\r\n  /**\r\n   * Get a search type's title. The title\r\n   * for all availables search typers needs to be defined in the locale\r\n   * files or an error will be thrown.\r\n   * @param searchType Search type\r\n   * @internal\r\n   */\r\n  getSearchTypeTitle(searchType: string) {\r\n    return `igo.geo.search.${searchType.toLowerCase()}.title`;\r\n  }\r\n\r\n  /**\r\n   * Emit an event and enable the search sources of the given type.\r\n   * @param searchType Search type\r\n   */\r\n  private setSearchType(searchType: string | undefined) {\r\n    this.searchType$.next(searchType);\r\n  }\r\n\r\n  private onSetSearchType(searchType: string) {\r\n    if (searchType === undefined || searchType === null) {\r\n      return;\r\n    }\r\n\r\n    this.searchSourceService.enableSourcesByType(searchType);\r\n    this.searchTypeChange.emit(searchType);\r\n  }\r\n\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatMenuModule } from '@angular/material/menu';\r\nimport { MatRadioModule } from '@angular/material/radio';\r\nimport { MatTabsModule } from '@angular/material/tabs';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { SearchSelectorComponent } from './search-selector.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatTooltipModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatMenuModule,\r\n    MatRadioModule,\r\n    MatTabsModule,\r\n    MatCheckboxModule,\r\n    IgoLanguageModule\r\n  ],\r\n  exports: [SearchSelectorComponent],\r\n  declarations: [SearchSelectorComponent]\r\n})\r\nexport class IgoSearchSelectorModule {}\r\n","<div class=\"igo-search-settings\">\r\n\r\n  <button\r\n    mat-icon-button\r\n    class=\"igo-search-settings-button\"\r\n    color=\"primary\"\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"'igo.geo.search.menu.tooltip' | translate\"\r\n    [matMenuTriggerFor]=\"searchSettingsMenu\">\r\n    <mat-icon svgIcon=\"chevron-down\"></mat-icon>\r\n  </button>\r\n  <mat-menu\r\n    #searchSettingsMenu=\"matMenu\"\r\n    class=\"no-border-radius\">\r\n    <div class=\"checkAllButton\" *ngIf=\"getSearchSources().length>4\">\r\n      <button mat-raised-button\r\n        (click)=\"checkUncheckAllSources($event)\">{{!searchSourcesAllEnabled  ? ('igo.geo.search.searchSources.unselectAll' | translate): ('igo.geo.search.searchSources.selectAll' | translate)}}</button>\r\n    </div>\r\n      <ng-container *ngFor=\"let source of getSearchSources()\">\r\n        <span class=\"igo-search-settings-search-source\">\r\n          <mat-checkbox\r\n            class=\"igo-search-settings-checkbox\"\r\n            [checked]=\"source.enabled\"\r\n            [value]=\"source\"\r\n            (click)=\"$event.stopPropagation()\"\r\n            (change)=\"onCheckSearchSource($event, source)\">\r\n          </mat-checkbox>\r\n          <button *ngIf=\"source.settings.length>0\"\r\n            [matMenuTriggerFor]=\"sub_menu\"\r\n            mat-menu-item>{{source.title}}\r\n          </button>\r\n          <button\r\n            mat-menu-item\r\n            *ngIf=\"source.settings.length===0\">\r\n            {{source.title}}\r\n          </button>\r\n        </span>\r\n          <mat-menu #sub_menu=\"matMenu\">\r\n            <ng-container *ngFor=\"let setting of source.settings\">\r\n              <button\r\n                  mat-menu-item\r\n                  [matMenuTriggerFor]=\"test_sub_menu\">\r\n                {{'igo.geo.search.searchSources.settings.'+ setting.title | translate}}\r\n              </button>\r\n              <mat-menu #test_sub_menu=\"matMenu\"\r\n                [ngSwitch]=\"setting.type\"\r\n                yPosition=\"above\">\r\n                <span *ngSwitchCase=\"'radiobutton'\">\r\n                  <mat-radio-group\r\n                    class=\"igo-search-settings-radio-group\"\r\n                    [value]=\"setting\">\r\n                    <mat-radio-button *ngFor=\"let settingValue of setting.values\"\r\n                      class=\"mat-typography\"\r\n                      [value]=\"settingValue\"\r\n                      [matTooltip]=\"getAvailableHashtagsValues(settingValue)\"\r\n                      [checked]=\"settingValue.enabled\"\r\n                      (click)=\"$event.stopPropagation()\"\r\n                      (change)=\"settingsValueCheckedRadioButton($event, source, setting, settingValue)\">\r\n                      {{settingValue.title | translate}}\r\n                    </mat-radio-button>\r\n                  </mat-radio-group>\r\n                </span>\r\n                <span *ngSwitchCase=\"'checkbox'\">\r\n                  <div class=\"checkAllButton\" *ngIf=\"setting.values.length>3\">\r\n                    <button mat-raised-button\r\n                      (click)=\"checkUncheckAll($event, source, setting)\">{{setting.allEnabled || setting.allEnabled === undefined  ? ('igo.geo.search.searchSources.settings.unselectAll' | translate): ('igo.geo.search.searchSources.settings.selectAll' | translate)}}</button>\r\n                  </div>\r\n                  <mat-checkbox *ngFor=\"let settingValue of getAvailableValues(setting)\"\r\n                    class=\"mat-menu-item\"\r\n                    [style.display]=\"displayBlock\"\r\n                    [checked]=\"settingValue.enabled\"\r\n                    [value]=\"setting\"\r\n                    [matTooltip]=\"getAvailableHashtagsValues(settingValue)\"\r\n                    (click)=\"$event.stopPropagation()\"\r\n                    (change)=\"settingsValueCheckedCheckbox($event, source, setting, settingValue)\">\r\n                    {{settingValue.title | translate}}\r\n                  </mat-checkbox>\r\n                </span>\r\n              </mat-menu>\r\n            </ng-container>\r\n          </mat-menu>\r\n      </ng-container>\r\n      <span *ngIf=\"hasPointerReverseSearchSource && !isTouchScreen\">\r\n        <mat-divider></mat-divider>\r\n        <span class=\"pointer-summary-slide-toggle-container mat-typography\">\r\n          <mat-slide-toggle class=\"pointer-summary-option\" (change)=\"changePointerReverseSearch($event)\" tooltip-position=\"below\"\r\n            matTooltipShowDelay=\"500\" [matTooltip]=\"'igo.geo.search.pointerSearchSummary.tooltip' | translate\"\r\n            (click)=\"$event.stopPropagation()\" [checked]=\"pointerSummaryEnabled\" [labelPosition]=\"'after'\">\r\n            {{'igo.geo.search.pointerSearchSummary.title' | translate}}\r\n          </mat-slide-toggle>\r\n          <mat-slide-toggle class=\"pointer-summary-option\" (change)=\"changeSearchResultsGeometry($event)\" tooltip-position=\"below\"\r\n            matTooltipShowDelay=\"500\" [matTooltip]=\"'igo.geo.search.searchResultsGeometry.tooltip' | translate\"\r\n            (click)=\"$event.stopPropagation()\" [checked]=\"searchResultsGeometryEnabled\" [labelPosition]=\"'after'\">\r\n            {{'igo.geo.search.searchResultsGeometry.title' | translate}}\r\n          </mat-slide-toggle>\r\n        </span>\r\n      </span>\r\n  </mat-menu>\r\n</div>\r\n","import { MatCheckboxChange } from '@angular/material/checkbox';\r\nimport { MatRadioChange } from '@angular/material/radio';\r\n\r\nimport {\r\n  Component,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  HostListener,\r\n  Input\r\n} from '@angular/core';\r\n\r\nimport { SearchSourceService } from '../shared/search-source.service';\r\nimport { SearchSource } from '../shared/sources/source';\r\nimport {\r\n  SearchSourceSettings,\r\n  SettingOptions\r\n} from '../shared/sources/source.interfaces';\r\nimport {\r\n  sourceCanReverseSearchAsSummary,\r\n  sourceCanSearch,\r\n  sourceCanReverseSearch\r\n} from '../shared/search.utils';\r\nimport { MediaService, StorageService } from '@igo2/core';\r\n\r\n/**\r\n * This component allows a user to select a search type yo enable. In it's\r\n * current version, only one search type can be selected at once (radio). If\r\n * this component were to support more than one search source enabled (checkbox),\r\n * the searchbar component would require a small change to it's\r\n * placeholder getter. The search source service already supports having\r\n * more than one search source enabled.\r\n */\r\n@Component({\r\n  selector: 'igo-search-settings',\r\n  templateUrl: './search-settings.component.html',\r\n  styleUrls: ['./search-settings.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SearchSettingsComponent implements OnInit {\r\n  public hasPointerReverseSearchSource: boolean = false;\r\n  public searchSourcesAllEnabled: boolean = false;\r\n\r\n  public buffer = [];\r\n  public lastKeyTime = Date.now();\r\n\r\n  public displayBlock = 'block';\r\n\r\n  get isTouchScreen(): boolean {\r\n    return this.mediaService.isTouchScreen();\r\n  }\r\n\r\n  @Input() pointerSummaryEnabled: boolean = false;\r\n  @Input() searchResultsGeometryEnabled: boolean = false;\r\n\r\n  /**\r\n   * Event emitted when the enabled search source changes\r\n   */\r\n  @Output() searchSourceChange = new EventEmitter<SearchSource>();\r\n\r\n  /**\r\n   * Event emitted when the pointer summary is activated\r\n   */\r\n  @Output() pointerSummaryStatus = new EventEmitter<boolean>();\r\n\r\n  /**\r\n   * Event emitted when the show geometry summary is changed\r\n   */\r\n  @Output() searchResultsGeometryStatus = new EventEmitter<boolean>();\r\n\r\n  @HostListener('document:keydown', ['$event'])\r\n  handleKeyboardEvent(event: KeyboardEvent) {\r\n    if (event.key === 'F2') {\r\n      this.pointerSummaryEnabled = !this.pointerSummaryEnabled;\r\n      this.pointerSummaryStatus.emit(this.pointerSummaryEnabled);\r\n    }\r\n  }\r\n\r\n  constructor(\r\n    private searchSourceService: SearchSourceService,\r\n    private mediaService: MediaService,\r\n    private storageService: StorageService\r\n  ) {}\r\n\r\n  ngOnInit(): void {\r\n    this.hasPointerReverseSearchSource = this.hasReverseSearchSourcesForPointerSummary();\r\n  }\r\n\r\n  /**\r\n   * Get all search sources\r\n   * @internal\r\n   */\r\n  getSearchSources(): SearchSource[] {\r\n    const textSearchSources = this.searchSourceService\r\n      .getSources()\r\n      .filter(sourceCanSearch)\r\n      .filter((s) => s.available && s.getId() !== 'map' && s.showInSettings);\r\n\r\n    const reverseSearchSources = this.searchSourceService\r\n      .getSources()\r\n      .filter(sourceCanReverseSearch)\r\n      .filter((s) => s.available && s.getId() !== 'map' && s.showInSettings);\r\n    const sources = textSearchSources.concat(reverseSearchSources);\r\n    this.computeSourcesCheckAllBehavior(sources);\r\n    return sources;\r\n  }\r\n\r\n  /**\r\n   * Get all search sources usable for pointer summary\r\n   * @internal\r\n   */\r\n  hasReverseSearchSourcesForPointerSummary(): boolean {\r\n    if (\r\n      this.searchSourceService\r\n        .getEnabledSources()\r\n        .filter(sourceCanReverseSearchAsSummary).length\r\n    ) {\r\n      return true;\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Triggered when a setting is checked (checkbox style)\r\n   * @internal\r\n   */\r\n  settingsValueCheckedCheckbox(\r\n    event: MatCheckboxChange,\r\n    source: SearchSource,\r\n    setting: SearchSourceSettings,\r\n    settingValue: SettingOptions\r\n  ) {\r\n    settingValue.enabled = event.checked;\r\n    source.setParamFromSetting(setting);\r\n    this.searchSourceChange.emit(source);\r\n  }\r\n\r\n  /**\r\n   * Defining the action to do for check/uncheck checkboxes (settings)\r\n   * return true if all checkbox must be checked\r\n   * return false if all checkbox must be unchecked\r\n   * @internal\r\n   */\r\n  computeSettingCheckAllBehavior(setting: SearchSourceSettings) {\r\n    if (setting.allEnabled === undefined) {\r\n      if (setting.values.find((settingValue) => settingValue.enabled)) {\r\n        setting.allEnabled = false;\r\n      } else {\r\n        setting.allEnabled = true;\r\n      }\r\n    } else {\r\n      setting.allEnabled = !setting.allEnabled;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Defining the action to do for check/uncheck checkboxes (sources)\r\n   * return true if all checkbox must be checked\r\n   * return false if all checkbox must be unchecked\r\n   * @internal\r\n   */\r\n  computeSourcesCheckAllBehavior(sources: SearchSource[]) {\r\n    const enabledSourcesCnt = sources.filter((source) => source.enabled).length;\r\n    const disabledSourcesCnt = sources.filter((source) => !source.enabled)\r\n      .length;\r\n    this.searchSourcesAllEnabled =\r\n      enabledSourcesCnt >= disabledSourcesCnt ? false : true;\r\n  }\r\n\r\n  /**\r\n   * Triggered when the check all / uncheck all type is clicked,\r\n   * @internal\r\n   */\r\n  checkUncheckAll(event, source: SearchSource, setting: SearchSourceSettings) {\r\n    event.stopPropagation();\r\n    this.computeSettingCheckAllBehavior(setting);\r\n    setting.values.forEach((settingValue) => {\r\n      settingValue.enabled = setting.allEnabled;\r\n    });\r\n    source.setParamFromSetting(setting);\r\n    this.searchSourceChange.emit(source);\r\n  }\r\n\r\n  /**\r\n   * Triggered when the check all / uncheck all type is clicked,\r\n   * @internal\r\n   */\r\n  checkUncheckAllSources(event) {\r\n    event.stopPropagation();\r\n    this.getSearchSources().map((source) => {\r\n      source.enabled = this.searchSourcesAllEnabled;\r\n      this.searchSourceChange.emit(source);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Triggered when a setting is checked (radiobutton style)\r\n   * @internal\r\n   */\r\n  settingsValueCheckedRadioButton(\r\n    event: MatRadioChange,\r\n    source: SearchSource,\r\n    setting: SearchSourceSettings,\r\n    settingValue: SettingOptions\r\n  ) {\r\n    setting.values.forEach((conf) => {\r\n      if (conf.value !== settingValue.value) {\r\n        conf.enabled = !event.source.checked;\r\n      } else {\r\n        conf.enabled = event.source.checked;\r\n      }\r\n    });\r\n    source.setParamFromSetting(setting);\r\n    this.searchSourceChange.emit(source);\r\n  }\r\n\r\n  onCheckSearchSource(event: MatCheckboxChange, source: SearchSource) {\r\n    source.enabled = event.checked;\r\n    const storage = (this.storageService.get(source.getId() + '.options') || {}) as SettingOptions;\r\n    storage.enabled = source.enabled;\r\n    this.storageService.set(\r\n      source.getId() + '.options',\r\n      storage\r\n    );\r\n    this.searchSourceChange.emit(source);\r\n  }\r\n\r\n  getAvailableValues(setting: SearchSourceSettings) {\r\n    return setting.values.filter((s) => s.available !== false);\r\n  }\r\n\r\n  getAvailableHashtagsValues(setting: SettingOptions) {\r\n    if (setting.hashtags) {\r\n      return setting.hashtags.map((h) => '#' + h).join(', ');\r\n    }\r\n    return;\r\n  }\r\n\r\n  stopPropagation(event) {\r\n    event.stopPropagation();\r\n  }\r\n\r\n  changePointerReverseSearch(event) {\r\n    this.pointerSummaryEnabled = event.checked;\r\n    this.pointerSummaryStatus.emit(this.pointerSummaryEnabled);\r\n  }\r\n\r\n  changeSearchResultsGeometry(event) {\r\n    this.searchResultsGeometryEnabled = event.checked;\r\n    this.searchResultsGeometryStatus.emit(this.searchResultsGeometryEnabled);\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { SearchSettingsComponent } from './search-settings.component';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatDividerModule } from '@angular/material/divider';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatMenuModule } from '@angular/material/menu';\r\nimport { MatRadioModule } from '@angular/material/radio';\r\nimport { MatSlideToggleModule } from '@angular/material/slide-toggle';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  declarations: [SearchSettingsComponent],\r\n  imports: [\r\n    CommonModule,\r\n    MatTooltipModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatMenuModule,\r\n    MatRadioModule,\r\n    MatCheckboxModule,\r\n    MatDividerModule,\r\n    MatSlideToggleModule,\r\n    IgoLanguageModule\r\n  ],\r\n  exports: [SearchSettingsComponent]\r\n})\r\nexport class IgoSearchSettingsModule { }\r\n","<div class=\"igo-search-bar-container\" [ngClass]=\"{empty: empty$ | async}\">\r\n  <mat-form-field [floatLabel]=\"floatLabel\" [appearance]=\"appearance\">\r\n    <mat-label *ngIf=\"label\">{{label}}</mat-label>\r\n    <input\r\n      #input\r\n      matInput\r\n      autocomplete=\"off\"\r\n      [ngClass]=\"{'hasSearchIcon': searchIcon}\"\r\n      [disabled]=\"disabled$ | async\"\r\n      [placeholder]=\"placeholder ? placeholder : (placeholder$ | async) ? (placeholder$.value | translate) : undefined\"\r\n      [value]=\"term$ | async\"\r\n      (keyup)=\"onKeyup($event)\"\r\n      (touchend)=\"onKeyup($event)\">\r\n  </mat-form-field>\r\n\r\n  <div class=\"search-bar-buttons\">\r\n    <button\r\n      mat-icon-button\r\n      [color]=\"color\"\r\n      *ngIf=\"searchIcon !== undefined\">\r\n      <mat-icon svgIcon=\"{{searchIcon}}\"></mat-icon>\r\n    </button>\r\n\r\n    <button\r\n      *ngIf=\"(empty$ | async)===false\"\r\n      mat-icon-button\r\n      [color]=\"color\"\r\n      (click)=\"onClearButtonClick()\"\r\n      [matTooltip]=\"'igo.geo.search.clearSearch' | translate\">\r\n      <mat-icon svgIcon=\"close\"></mat-icon>\r\n    </button>\r\n\r\n    <igo-search-selector\r\n      *ngIf=\"searchSelector\"\r\n      [searchTypes]=\"searchTypes\"\r\n      [searchType]=\"searchType$ | async\"\r\n      (searchTypeChange)=\"onSearchTypeChange($event)\">\r\n    </igo-search-selector>\r\n\r\n    <igo-search-settings\r\n      *ngIf=\"searchSettings\"\r\n      [pointerSummaryEnabled]=\"pointerSummaryEnabled\"\r\n      (pointerSummaryStatus)=\"pointerSummaryStatus.emit($event)\"\r\n      [searchResultsGeometryEnabled]=\"searchResultsGeometryEnabled\"\r\n      (searchResultsGeometryStatus)=\"searchResultsGeometryStatus.emit($event)\"\r\n      (searchSourceChange)=\"onSearchSettingsChange()\">\r\n    </igo-search-settings>\r\n  </div>\r\n</div>\r\n","import {\r\n  Component,\r\n  OnInit,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ViewChild,\r\n  ElementRef\r\n} from '@angular/core';\r\nimport {\r\n  FloatLabelType,\r\n  MatFormFieldAppearance\r\n} from '@angular/material/form-field';\r\nimport { BehaviorSubject, Subscription, EMPTY, timer } from 'rxjs';\r\nimport { debounce, distinctUntilChanged } from 'rxjs/operators';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { EntityStore } from '@igo2/common';\r\n\r\nimport { SEARCH_TYPES } from '../shared/search.enums';\r\nimport { SearchResult, Research } from '../shared/search.interfaces';\r\nimport { SearchService } from '../shared/search.service';\r\nimport { SearchSourceService } from '../shared/search-source.service';\r\n\r\n/**\r\n * Searchbar that triggers a research in all search sources enabled.\r\n * If the store input is defined, the search results will be loaded\r\n * into that store. An event is always emitted when a research is completed.\r\n */\r\n@Component({\r\n  selector: 'igo-search-bar',\r\n  templateUrl: './search-bar.component.html',\r\n  styleUrls: ['./search-bar.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SearchBarComponent implements OnInit, OnDestroy {\r\n  /**\r\n   * Invalid keys\r\n   */\r\n  static invalidKeys = [\r\n    'Control',\r\n    'Shift',\r\n    'Alt',\r\n    'ArrowDown',\r\n    'ArrowUp',\r\n    'ArrowRight',\r\n    'ArrowLeft'\r\n  ];\r\n\r\n  readonly placeholder$: BehaviorSubject<string> = new BehaviorSubject(\r\n    'igo.geo.search.placeholder'\r\n  );\r\n\r\n  readonly empty$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  /**\r\n   * Subscription to the ssearch bar term\r\n   */\r\n  private term$$: Subscription;\r\n\r\n  /**\r\n   * Search term stream\r\n   */\r\n  private stream$: BehaviorSubject<string> = new BehaviorSubject('');\r\n\r\n  /**\r\n   * Subscription to the search term stream\r\n   */\r\n  private stream$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to the search type\r\n   */\r\n  private searchType$$: Subscription;\r\n\r\n  private researches$$: Subscription[];\r\n\r\n  /**\r\n   * List of available search types\r\n   */\r\n  @Input() searchTypes: string[] = SEARCH_TYPES;\r\n\r\n  /**\r\n   * Search term\r\n   */\r\n  @Input()\r\n  set searchType(value: string) {\r\n    this.setSearchType(value);\r\n  }\r\n  get searchType(): string {\r\n    return this.searchType$.value;\r\n  }\r\n  readonly searchType$: BehaviorSubject<string> = new BehaviorSubject(\r\n    undefined\r\n  );\r\n\r\n  /**\r\n   * Event emitted when the pointer summary is activated by the searchbar setting\r\n   */\r\n  @Output() pointerSummaryStatus = new EventEmitter<boolean>();\r\n\r\n  /**\r\n   * Event emitted when the show geometry setting is changed\r\n   */\r\n   @Output() searchResultsGeometryStatus = new EventEmitter<boolean>();\r\n\r\n  /**\r\n   * Search term\r\n   */\r\n  @Input()\r\n  set term(value: string) {\r\n    this.setTerm(value);\r\n  }\r\n  get term(): string {\r\n    return this.term$.value;\r\n  }\r\n  readonly term$: BehaviorSubject<string> = new BehaviorSubject('');\r\n\r\n  /**\r\n   * Whether this component is disabled\r\n   */\r\n  @Input()\r\n  set disabled(value: boolean) {\r\n    this.disabled$.next(value);\r\n  }\r\n  get disabled(): boolean {\r\n    return this.disabled$.value;\r\n  }\r\n  readonly disabled$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  @Input() pointerSummaryEnabled: boolean = false;\r\n  @Input() searchResultsGeometryEnabled: boolean = false;\r\n  /**\r\n   * Whether a float label should be displayed\r\n   */\r\n  @Input() floatLabel: FloatLabelType = 'never';\r\n\r\n  @Input() appearance: MatFormFieldAppearance = 'legacy';\r\n\r\n  @Input() placeholder: string;\r\n\r\n  @Input() label: string;\r\n\r\n  /**\r\n   * Icons color (search and clear)\r\n   */\r\n  @Input() color = 'primary';\r\n\r\n  @Input() termSplitter: string = '|';\r\n\r\n  /**\r\n   * Debounce time between each keystroke\r\n   */\r\n  @Input() debounce = 200;\r\n\r\n  /**\r\n   * Minimum term length required to trigger a research\r\n   */\r\n  @Input() minLength = 2;\r\n\r\n  /**\r\n   * Search icon\r\n   */\r\n  @Input() searchIcon: string;\r\n\r\n  /**\r\n   * Search Selector\r\n   */\r\n  @Input() searchSelector = false;\r\n\r\n  /**\r\n   * Search Settings\r\n   */\r\n  @Input() searchSettings = false;\r\n\r\n  /**\r\n   * Force coordinates in north america\r\n   */\r\n  @Input() forceNA = false;\r\n\r\n  /**\r\n   * Search results store\r\n   */\r\n  @Input() store: EntityStore<SearchResult>;\r\n\r\n  /**\r\n   * Event emitted when the search term changes\r\n   */\r\n  @Output() searchTermChange = new EventEmitter<string>();\r\n\r\n  /**\r\n   * Event emitted when a research is completed\r\n   */\r\n  @Output() search = new EventEmitter<{\r\n    research: Research;\r\n    results: SearchResult[];\r\n  }>();\r\n\r\n  /**\r\n   * Event emitted when the search type changes\r\n   */\r\n  @Output() searchTypeChange = new EventEmitter<string>();\r\n\r\n  /**\r\n   * Event emitted when the search type changes\r\n   */\r\n  @Output() clearFeature = new EventEmitter();\r\n\r\n  /**\r\n   * Event emitted when the search settings changes\r\n   */\r\n  @Output() searchSettingsChange = new EventEmitter();\r\n\r\n  /**\r\n   * Input element\r\n   * @internal\r\n   */\r\n  @ViewChild('input', { static: true }) input: ElementRef;\r\n\r\n  /**\r\n   * Whether the search bar is empty\r\n   * @internal\r\n   */\r\n  get empty(): boolean {\r\n    return this.term.length === 0;\r\n  }\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private searchService: SearchService,\r\n    private searchSourceService: SearchSourceService\r\n  ) {}\r\n\r\n  /**\r\n   * Subscribe to the search term stream and trigger researches\r\n   * @internal\r\n   */\r\n  ngOnInit(): void {\r\n    this.term$$ = this.term$.subscribe((term: string) => {\r\n      this.empty$.next(term === undefined || term.length === 0);\r\n    });\r\n\r\n    this.stream$$ = this.stream$\r\n      .pipe(\r\n        debounce((term: string) => (term === '' ? EMPTY : timer(this.debounce)))\r\n      )\r\n      .subscribe((term: string) => this.onSetTerm(term));\r\n\r\n    this.handlePlaceholder();\r\n\r\n    this.searchType$$ = this.searchType$\r\n      .pipe(distinctUntilChanged())\r\n      .subscribe((searchType: string) => this.onSetSearchType(searchType));\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to the search term stream\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.term$$.unsubscribe();\r\n    this.stream$$.unsubscribe();\r\n    this.searchType$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * When a user types, validates the key and send it into the\r\n   * stream if it's valid\r\n   * @param event Keyboard event\r\n   * @internal\r\n   */\r\n  onKeyup(event: KeyboardEvent) {\r\n    const key = event.key;\r\n    if (!this.keyIsValid(key)) {\r\n      return;\r\n    }\r\n    const term = (event.target as HTMLInputElement).value;\r\n    this.setTerm(term);\r\n  }\r\n\r\n  /**\r\n   * Clear the stream and the input\r\n   * @internal\r\n   */\r\n  onClearButtonClick() {\r\n    this.clear();\r\n    this.clearFeature.emit();\r\n  }\r\n\r\n  /**\r\n   * Update search type\r\n   * @param searchType Enabled search type\r\n   * @internal\r\n   */\r\n  onSearchTypeChange(searchType: string) {\r\n    this.setSearchType(searchType);\r\n  }\r\n\r\n  /**\r\n   * Update the placeholder with the enabled search type. The placeholder\r\n   * for all availables search typers needs to be defined in the locale\r\n   * files or an error will be thrown.\r\n   * @param searchType Enabled search type\r\n   * @internal\r\n   */\r\n  setSearchType(searchType: string) {\r\n    this.searchType$.next(searchType);\r\n  }\r\n\r\n  onSearchSettingsChange() {\r\n    this.doSearch(this.term);\r\n    this.searchSettingsChange.emit();\r\n    this.handlePlaceholder();\r\n  }\r\n\r\n  /**\r\n   * Send the term into the stream only if this component is not disabled\r\n   * @param term Search term\r\n   */\r\n  setTerm(term: string) {\r\n    if (this.disabled) {\r\n      return;\r\n    }\r\n\r\n    term = term || '';\r\n\r\n    if (term !== this.term) {\r\n      this.term$.next(term);\r\n    }\r\n\r\n    const slug = term.replace(/(#[^\\s]*)/g, '').trim();\r\n    if (slug.length >= this.minLength || slug.length === 0) {\r\n      this.stream$.next(term);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the stream and the input\r\n   */\r\n  private clear() {\r\n    this.term$.next('');\r\n    this.stream$.next('');\r\n    this.input.nativeElement.focus();\r\n  }\r\n\r\n  /**\r\n   * Validate if a given key stroke is a valid input\r\n   */\r\n  private keyIsValid(key: string) {\r\n    return SearchBarComponent.invalidKeys.indexOf(key) === -1;\r\n  }\r\n\r\n  /**\r\n   * When the search term changes, emit an event and trigger a\r\n   * research in every enabled search sources.\r\n   * @param term Search term\r\n   */\r\n  private onSetTerm(term: string | undefined) {\r\n    this.searchTermChange.emit(term);\r\n    this.doSearch(term);\r\n  }\r\n\r\n  private handlePlaceholder() {\r\n    const searchTypes = [\r\n      ...new Set(\r\n        this.searchSourceService\r\n          .getEnabledSources()\r\n          .filter((ss) => !['map', 'coordinatesreverse'].includes(ss.getId()))\r\n          .map((ss) => ss.getType())\r\n      )\r\n    ];\r\n\r\n    let placeholder = `igo.geo.search.placeholder`;\r\n    if (searchTypes.length === 1) {\r\n      placeholder = `igo.geo.search.${searchTypes[0].toLowerCase()}.placeholder`;\r\n    } else if (searchTypes.length === 0) {\r\n      placeholder = `igo.geo.search.emptyType.placeholder`;\r\n    }\r\n    this.placeholder$.next(placeholder);\r\n  }\r\n\r\n  private onSetSearchType(searchType: string) {\r\n    if (searchType === undefined || searchType === null) {\r\n      return;\r\n    }\r\n\r\n    this.searchTypeChange.emit(searchType);\r\n\r\n    const placeholder = `igo.geo.search.${searchType.toLowerCase()}.placeholder`;\r\n    this.placeholder$.next(placeholder);\r\n\r\n    this.setTerm(this.term);\r\n  }\r\n\r\n  /**\r\n   * Execute the search\r\n   * @param term Search term\r\n   */\r\n  private doSearch(rawTerm: string | undefined) {\r\n    if (this.researches$$) {\r\n      this.researches$$.map((research) => research.unsubscribe());\r\n      this.researches$$ = undefined;\r\n    }\r\n\r\n    let terms;\r\n    if (this.termSplitter && rawTerm.match(new RegExp(this.termSplitter, 'g'))) {\r\n      terms = rawTerm.split(this.termSplitter).filter((t) => t.length >= this.minLength);\r\n      if (this.store) {\r\n        this.store.clear();\r\n      }\r\n    } else {\r\n      terms = [rawTerm];\r\n    }\r\n\r\n    let researches: Research[] = [];\r\n    terms.map((term: string) => {\r\n      const slug = term ? term.replace(/(#[^\\s]*)/g, '').trim() : '';\r\n      if (slug === '') {\r\n        if (this.store !== undefined) {\r\n          this.store.clear();\r\n        }\r\n        return;\r\n      }\r\n\r\n      researches = researches.concat(this.searchService.search(term, {\r\n        forceNA: this.forceNA\r\n      }));\r\n    });\r\n    this.researches$$ = researches.map((research) => {\r\n      return research.request.subscribe((results: SearchResult[]) => {\r\n        this.onResearchCompleted(research, results);\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * When a research  is completed, emit an event and update\r\n   * the store's items.\r\n   * @param research Research\r\n   * @param results Research results\r\n   */\r\n  private onResearchCompleted(research: Research, results: SearchResult[]) {\r\n    this.search.emit({ research, results });\r\n\r\n    if (this.store !== undefined) {\r\n      const newResults = this.store\r\n        .all()\r\n        .filter((result) => result.source !== research.source)\r\n        .concat(results);\r\n      this.store.updateMany(newResults);\r\n    }\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatMenuModule } from '@angular/material/menu';\r\nimport { MatRadioModule } from '@angular/material/radio';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { IgoSearchSelectorModule } from '../search-selector/search-selector.module';\r\nimport { IgoSearchSettingsModule } from '../search-settings/search-settings.module';\r\nimport { SearchBarComponent } from './search-bar.component';\r\nimport { SearchUrlParamDirective } from './search-url-param.directive';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    MatTooltipModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatMenuModule,\r\n    MatRadioModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    IgoLanguageModule,\r\n    IgoSearchSelectorModule,\r\n    IgoSearchSettingsModule\r\n  ],\r\n  exports: [\r\n    SearchBarComponent,\r\n  ],\r\n  declarations: [\r\n    SearchBarComponent,\r\n    SearchUrlParamDirective\r\n  ]\r\n})\r\nexport class IgoSearchBarModule {}\r\n","<mat-list-item>\r\n  <mat-icon *ngIf=\"icon\" mat-list-avatar svgIcon=\"{{showIcons ? icon : 'blank'}}\"></mat-icon>\r\n\r\n  <h4 matLine *ngIf=\"titleHtml\" [innerHtml]=\"titleHtml\" matTooltipShowDelay=\"500\" [matTooltip]=\"tooltipHtml\" matTooltipClass=\"search-result-tooltip\"></h4>\r\n  <h4 matLine *ngIf=\"!titleHtml\" matTooltipShowDelay=\"500\" [matTooltip]=\"title\">{{title}}</h4>\r\n\r\n  <button *ngIf=\"withZoomButton\"\r\n    igoStopPropagation\r\n    mat-icon-button\r\n    (click)=\"onZoomHandler()\">\r\n    <mat-icon svgIcon=\"magnify\"></mat-icon>\r\n  </button>\r\n\r\n  <ng-content\r\n    select=[igoSearchItemToolbar]>\r\n  </ng-content>\r\n\r\n</mat-list-item>\r\n","import { Component, Input, ChangeDetectionStrategy, EventEmitter, Output } from '@angular/core';\r\nimport olFormatGeoJSON from 'ol/format/GeoJSON';\r\n\r\nimport {\r\n  getEntityTitle,\r\n  getEntityTitleHtml,\r\n  getEntityIcon\r\n} from '@igo2/common';\r\n\r\nimport { SearchResult } from '../shared/search.interfaces';\r\nimport { FeatureMotion, moveToOlFeatures } from '../../feature';\r\nimport { IgoMap } from '../../map';\r\n\r\n/**\r\n * Search results list item\r\n */\r\n@Component({\r\n  selector: 'igo-search-results-item',\r\n  templateUrl: './search-results-item.component.html',\r\n  styleUrls: ['./search-results-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SearchResultsItemComponent {\r\n  /**\r\n   * Search result item\r\n   */\r\n  @Input() result: SearchResult;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * Search result title\r\n   * @internal\r\n   */\r\n\r\n  /**\r\n   * to show hide results icons\r\n   */\r\n  @Input() showIcons: boolean;\r\n\r\n  /**\r\n   * Whether there should be a zoom button\r\n   */\r\n  @Input() withZoomButton = false;\r\n\r\n  @Output() zoomEvent = new EventEmitter<boolean>();\r\n\r\n  private format = new olFormatGeoJSON();\r\n\r\n  get title(): string {\r\n    return getEntityTitle(this.result);\r\n  }\r\n\r\n  /**\r\n   * Search result HTML title\r\n   * @internal\r\n   */\r\n  get titleHtml(): string {\r\n    return getEntityTitleHtml(this.result);\r\n  }\r\n\r\n  /**\r\n   * Search result tooltip\r\n   * @internal\r\n   */\r\n  get tooltipHtml(): string {\r\n    return this.titleHtml\r\n      .replace(/<small?[^>]+(>|$)/g, '\\n')\r\n      .replace(/<\\/?[^>]+(>|$)/g, '');\r\n  }\r\n\r\n  /**\r\n   * Search result icon\r\n   * @internal\r\n   */\r\n  get icon(): string {\r\n    return getEntityIcon(this.result);\r\n  }\r\n\r\n  constructor() {}\r\n\r\n  onZoomHandler() {\r\n    const olFeature = this.format.readFeature(this.result.data, {\r\n      dataProjection: this.result.data.projection,\r\n      featureProjection: this.map.projection\r\n    });\r\n    moveToOlFeatures(this.map, [olFeature], FeatureMotion.Default);\r\n  }\r\n}\r\n","<igo-list [navigation]=\"true\">\r\n  <ng-template\r\n    #groupTemplate\r\n    ngFor let-group\r\n    [ngForOf]=\"results$ | async\">\r\n\r\n    <igo-collapsible [class]=\"group.source.getId()\"\r\n      *ngIf=\"mode === searchResultMode.Grouped; else flatTemplate\"\r\n      [title]=\"computeGroupTitle(group)\"\r\n      [collapsed]=\"collapsed[group.source.title]\"\r\n      (toggle)=\"collapsed[group.source.title] = $event\">\r\n      <ng-container *ngTemplateOutlet=\"storeItemTemplate; context: {results: group.results}\"></ng-container>\r\n    </igo-collapsible>\r\n\r\n    <ng-template #flatTemplate>\r\n      <ng-container *ngTemplateOutlet=\"storeItemTemplate; context: {results: group.results}\"></ng-container>\r\n    </ng-template>\r\n\r\n    <ng-template #storeItemTemplate let-results=\"results\">\r\n      <ng-template ngFor let-result [ngForOf]=\"results\">\r\n        <igo-search-results-item\r\n          igoListItem\r\n          color=\"accent\"\r\n          [map]=\"map\"\r\n          [result]=\"result\"\r\n          [showIcons]=\"showIcons\"\r\n          [withZoomButton]=\"withZoomButton\"\r\n          [focused]=\"store.state.get(result).focused\"\r\n          [selected]=\"store.state.get(result).selected\"\r\n          (focus)=\"resultFocus.emit(result)\"\r\n          (unfocus)=\"resultUnfocus.emit(result)\"\r\n          (select)=\"onResultSelect(result)\"\r\n          (mouseenter)=\"resultFocus.emit(result)\"\r\n          (mouseleave)=\"resultUnfocus.emit(result)\">\r\n\r\n          <ng-container igoSearchItemToolbar\r\n            [ngTemplateOutlet]=\"templateSearchToolbar\"\r\n            [ngTemplateOutletContext]=\"{result: result}\">\r\n          </ng-container>\r\n\r\n        </igo-search-results-item>\r\n      </ng-template>\r\n      <span class=\"moreResults mat-typography\" *ngIf=\"isMoreResults(group)\" (click)=\"displayMoreResults(group)\">\r\n        <u>{{ 'igo.geo.search.displayMoreResults' | translate }}</u>\r\n      </span>\r\n    </ng-template>\r\n\r\n  </ng-template>\r\n\r\n</igo-list>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ContentChild,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\nimport type { TemplateRef } from '@angular/core';\r\n\r\nimport { Observable, EMPTY, timer, BehaviorSubject, Subscription } from 'rxjs';\r\nimport { debounce, map } from 'rxjs/operators';\r\n\r\nimport { EntityState, EntityStore, EntityStoreFilterCustomFuncStrategy, EntityStoreWatcher } from '@igo2/common';\r\n\r\nimport { IgoMap } from '../../map';\r\n\r\nimport { TextSearchOptions } from '../shared/sources/source.interfaces';\r\nimport { SearchService } from '../shared/search.service';\r\nimport { SearchResult, Research } from '../shared/search.interfaces';\r\nimport { SearchSource } from '../shared/sources/source';\r\n\r\nexport enum SearchResultMode {\r\n  Grouped = 'grouped',\r\n  Flat = 'flat'\r\n}\r\n\r\n/**\r\n * List of search results with focus and selection capabilities.\r\n * This component is dumb and only emits events.\r\n */\r\n@Component({\r\n  selector: 'igo-search-results',\r\n  templateUrl: './search-results.component.html',\r\n  styleUrls: ['./search-results.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SearchResultsComponent implements OnInit, OnDestroy {\r\n  /**\r\n   * Reference to the SearchResultMode enum\r\n   * @internal\r\n   */\r\n  public searchResultMode = SearchResultMode;\r\n\r\n  /**\r\n   * Search results store watcher\r\n   */\r\n  private watcher: EntityStoreWatcher<SearchResult>;\r\n\r\n  private settingsChange$$: Subscription;\r\n\r\n  public pageIterator: {sourceId: string}[] = [];\r\n\r\n  public collapsed: {sourceId: string}[] = [];\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * Search results store\r\n   */\r\n  @Input() store: EntityStore<SearchResult>;\r\n\r\n  /**\r\n   * to show hide results icons\r\n   */\r\n  @Input() showIcons: boolean;\r\n\r\n  /**\r\n   * Search results display mode\r\n   */\r\n  @Input() mode: SearchResultMode = SearchResultMode.Grouped;\r\n\r\n  /**\r\n   * Whether there should be a zoom button\r\n   */\r\n  @Input() withZoomButton = false;\r\n\r\n  /**\r\n   * Search term\r\n   */\r\n  @Input()\r\n  get term(): string {\r\n    return this._term;\r\n  }\r\n  set term(value: string) {\r\n    this._term = value;\r\n    this.pageIterator = [];\r\n  }\r\n  public _term: string;\r\n\r\n  @Input() settingsChange$ = new BehaviorSubject<boolean>(undefined);\r\n\r\n  @Input() termSplitter: string = '|';\r\n\r\n  /**\r\n   * Event emitted when a result is focused\r\n   */\r\n  @Output() resultFocus = new EventEmitter<SearchResult>();\r\n\r\n  /**\r\n   * Event emitted when a result is unfocused\r\n   */\r\n  @Output() resultUnfocus = new EventEmitter<SearchResult>();\r\n\r\n  /**\r\n   * Event emitted when a result is selected\r\n   */\r\n  @Output() resultSelect = new EventEmitter<SearchResult>();\r\n\r\n  /**\r\n   * Event emitted when a research is completed after displaying more results is clicked\r\n   */\r\n  @Output() moreResults = new EventEmitter<{\r\n    research: Research;\r\n    results: SearchResult[];\r\n  }>();\r\n\r\n  /**\r\n   * Events emitted when a result is focus or unfocus by mouse event\r\n   */\r\n  @Output() resultMouseenter = new EventEmitter<SearchResult>();\r\n  @Output() resultMouseleave = new EventEmitter<SearchResult>();\r\n\r\n  @ContentChild('igoSearchItemToolbar', /* TODO: add static flag */ {}) templateSearchToolbar: TemplateRef<any>;\r\n\r\n  get results$(): Observable<{source: SearchSource; results: SearchResult[]}[]> {\r\n    if (this._results$ === undefined) {\r\n      this._results$ = this.liftResults();\r\n    }\r\n    return this._results$;\r\n  }\r\n  private _results$: Observable<\r\n    {source: SearchSource; results: SearchResult[]}[]\r\n  >;\r\n\r\n  constructor(private cdRef: ChangeDetectorRef,\r\n              private searchService: SearchService) {}\r\n\r\n  /**\r\n   * Bind the search results store to the watcher\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.watcher = new EntityStoreWatcher(this.store, this.cdRef);\r\n\r\n    this.settingsChange$$ = this.settingsChange$.subscribe(() => {\r\n      this.pageIterator = [];\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Unbind the search results store from the watcher\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.watcher.destroy();\r\n    this.settingsChange$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * Compute a group title\r\n   * @param group Search results group\r\n   * @returns Group title\r\n   * @internal\r\n   */\r\n  computeGroupTitle(group: {source: SearchSource; results: SearchResult[]}): string {\r\n    const parts = [group.source.title];\r\n    const count = group.results.length;\r\n    if (count > 1) {\r\n      parts.push(`(${count})`);\r\n    }\r\n    return parts.join(' ');\r\n  }\r\n\r\n  /**\r\n   * When a result is selected, update it's state in the store and emit\r\n   * an event. A selected result is also considered focused\r\n   * @param result Search result\r\n   * @internal\r\n   */\r\n  onResultSelect(result: SearchResult) {\r\n    if (this.store.state.get(result)) {\r\n      if (this.store.state.get(result).selected === true) {\r\n        return;\r\n      }\r\n    }\r\n    this.store.state.update(result, {focused: true, selected: true}, true);\r\n    this.resultSelect.emit(result);\r\n  }\r\n\r\n  /**\r\n   * Return an observable of the search results, grouped by search source\r\n   * @returns Observable of grouped search results\r\n   * @internal\r\n   */\r\n   private liftResults(): Observable<{source: SearchSource; results: SearchResult[]}[]> {\r\n    return this.store.stateView.all$().pipe(\r\n      debounce((results: {entity: SearchResult, state: EntityState}[]) => {\r\n        return results.length === 0 ? EMPTY : timer(200);\r\n      }),\r\n      map((results: {entity: SearchResult, state: EntityState}[]) => {\r\n        return this.groupResults(results.map(r => r.entity).sort(this.sortByOrder));\r\n      })\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Sort the results by display order.\r\n   * @param r1 First result\r\n   * @param r2 Second result\r\n   */\r\n  private sortByOrder(r1: SearchResult, r2: SearchResult) {\r\n    return r1.source.displayOrder - r2.source.displayOrder;\r\n  }\r\n\r\n  /**\r\n   * Group results by search source\r\n   * @param results Search results from all sources\r\n   * @returns Search results grouped by source\r\n   */\r\n  private groupResults(results: SearchResult[]): {source: SearchSource; results: SearchResult[]}[] {\r\n    const grouped = new Map<SearchSource, SearchResult[]>();\r\n    results.forEach((result: SearchResult) => {\r\n      const source = result.source;\r\n      let sourceResults = grouped.get(source);\r\n      if (sourceResults === undefined) {\r\n        sourceResults = [];\r\n        grouped.set(source, sourceResults);\r\n      }\r\n      sourceResults.push(result);\r\n    });\r\n\r\n    return Array.from(grouped.keys()).map((source: SearchSource) => {\r\n      if (this.pageIterator[source.getId()] === undefined) {\r\n        this.pageIterator[source.getId()] = 1;\r\n      }\r\n      return {source, results: grouped.get(source)};\r\n    });\r\n  }\r\n\r\n  isMoreResults(group: { source: SearchSource; results: SearchResult[] }) {\r\n    // getStrategyOfType is to avoid display more result based on a filtered state\r\n    const stategy = this.store.getStrategyOfType(EntityStoreFilterCustomFuncStrategy);\r\n    const active = stategy?.active || false;\r\n    return !active && group.results &&\r\n      group.results[group.results.length - 1].meta.nextPage === true;\r\n  }\r\n\r\n  displayMoreResults(group: {source: SearchSource; results: SearchResult[]}) {\r\n    const options: TextSearchOptions = {\r\n      sourceId: group.source.getId(),\r\n      page: ++this.pageIterator[group.source.getId()]\r\n    };\r\n\r\n    let terms;\r\n    if (this.termSplitter && this.term.match(new RegExp(this.termSplitter, 'g'))) {\r\n      terms = this.term.split(this.termSplitter);\r\n    } else {\r\n      terms = [this.term];\r\n    }\r\n\r\n    let researches: Research[] = [];\r\n    terms.map((term: string) => {\r\n      researches = researches.concat(this.searchService.search(term, options));\r\n    });\r\n\r\n    researches.map(research => {\r\n      research.request.subscribe((results: SearchResult[]) => {\r\n        const newResults = group.results.concat(results);\r\n        if (!results.length) {\r\n          newResults[newResults.length - 1].meta.nextPage = false;\r\n        }\r\n        this.moreResults.emit({research, results: newResults});\r\n      });\r\n    });\r\n    return;\r\n  }\r\n}\r\n","<button\r\nigoStopPropagation\r\n(mouseenter)=\"onMouseEvent($event)\" (mouseleave)=\"onMouseEvent($event)\"\r\n*ngIf=\"layer.meta.dataType === 'Layer'\"\r\nmat-icon-button\r\ntooltip-position=\"below\"\r\nmatTooltipShowDelay=\"500\"\r\n[matTooltip]=\"(tooltip$ | async) | translate\"\r\n[color]=\"(isPreview$ | async) ? '' : added ? 'warn' : ''\"\r\n(click)=\"onToggleClick($event)\">\r\n<mat-icon\r\n  matBadge=\"icon\"\r\n  igoMatBadgeIcon=\"eye-off\"\r\n  igoMatBadgeInverseColor=\"true\"\r\n  [matBadgeHidden]=\"(inRange$ | async)\"\r\n  matBadgeDisabled=\"true\"\r\n  matBadgeSize=\"small\"\r\n  matBadgePosition=\"after\"\r\n  [svgIcon]=\"(isPreview$ | async) ? 'plus' : added ? 'delete' : 'plus'\">\r\n</mat-icon>\r\n</button>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { SearchResult } from '../shared/search.interfaces';\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { LayerOptions } from '../../layer/shared/layers/layer.interface';\r\nimport { LayerService } from '../../layer/shared/layer.service';\r\nimport { LAYER } from '../../layer/shared/layer.enums';\r\nimport { Subscription, BehaviorSubject } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'igo-search-add-button',\r\n  templateUrl: './search-results-add-button.component.html',\r\n  styleUrls: ['./search-results-add-button.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SearchResultAddButtonComponent implements OnInit, OnDestroy {\r\n  public tooltip$: BehaviorSubject<string> = new BehaviorSubject(\r\n    'igo.geo.catalog.layer.addToMap'\r\n  );\r\n\r\n  private resolution$$: Subscription;\r\n\r\n  public inRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  public isPreview$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  private layersSubcriptions = [];\r\n\r\n  private lastTimeoutRequest;\r\n\r\n  private mouseInsideAdd: boolean = false;\r\n\r\n  @Input() layer: SearchResult;\r\n\r\n  /**\r\n   * Whether the layer is already added to the map\r\n   */\r\n  @Input() added: boolean;\r\n\r\n  /**\r\n   * The map to add the search result layer to\r\n   */\r\n  @Input() map: IgoMap;\r\n\r\n  @Input()\r\n  get color() {\r\n    return this._color;\r\n  }\r\n  set color(value: string) {\r\n    this._color = value;\r\n  }\r\n  private _color = 'primary';\r\n\r\n  constructor(private layerService: LayerService) {}\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnInit(): void {\r\n    if (this.layer.meta.dataType === 'Layer') {\r\n      this.added =\r\n        this.map.layers.findIndex(\r\n          lay => lay.id === this.layer.data.sourceOptions.id\r\n        ) !== -1;\r\n    }\r\n    this.resolution$$ = this.map.viewController.resolution$.subscribe(value => {\r\n      this.isInResolutionsRange(value);\r\n      this.tooltip$.next(this.computeTooltip());\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.resolution$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * On mouse event, mouseenter /mouseleave\r\n   * @internal\r\n   */\r\n  onMouseEvent(event) {\r\n    this.onToggleClick(event);\r\n  }\r\n\r\n  /**\r\n   * On toggle button click, emit the added change event\r\n   * @internal\r\n   */\r\n  onToggleClick(event) {\r\n    if (typeof this.lastTimeoutRequest !== 'undefined') {\r\n      clearTimeout(this.lastTimeoutRequest);\r\n    }\r\n\r\n    if (event.type === 'mouseenter' && this.mouseInsideAdd ) {\r\n      return;\r\n    }\r\n    switch (event.type) {\r\n      case 'click':\r\n        if (!this.isPreview$.value) {\r\n          if (this.added) {\r\n            this.remove();\r\n          } else {\r\n            this.add();\r\n          }\r\n        }\r\n        this.isPreview$.next(false);\r\n        break;\r\n      case 'mouseenter':\r\n        if (!this.isPreview$.value && !this.added) {\r\n          this.lastTimeoutRequest = setTimeout(() => {\r\n            this.add();\r\n            this.isPreview$.next(true);\r\n          }, 500);\r\n        }\r\n        this.mouseInsideAdd = true;\r\n        break;\r\n      case 'mouseleave':\r\n        if (this.isPreview$.value) {\r\n          this.remove();\r\n          this.isPreview$.next(false);\r\n        }\r\n        this.mouseInsideAdd = false;\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n  }\r\n\r\n  private add() {\r\n    if (!this.added) {\r\n      this.added = true;\r\n      this.addLayerToMap();\r\n    }\r\n  }\r\n\r\n  private remove() {\r\n    if (this.added) {\r\n      this.added = false;\r\n      this.removeLayerFromMap();\r\n      this.layersSubcriptions.map(s => s.unsubscribe());\r\n      this.layersSubcriptions = [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Emit added change event with added = true\r\n   */\r\n  private addLayerToMap() {\r\n    if (this.map === undefined) {\r\n      return;\r\n    }\r\n\r\n    if (this.layer.meta.dataType !== LAYER) {\r\n      return undefined;\r\n    }\r\n\r\n    const layerOptions = (this.layer as SearchResult<LayerOptions>).data;\r\n    if (layerOptions.sourceOptions.optionsFromApi === undefined) {\r\n      layerOptions.sourceOptions.optionsFromApi = true;\r\n    }\r\n    this.layersSubcriptions.push(\r\n      this.layerService\r\n        .createAsyncLayer(layerOptions)\r\n        .subscribe(layer => this.map.addLayer(layer))\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Emit added change event with added = false\r\n   */\r\n  private removeLayerFromMap() {\r\n    if (this.map === undefined) {\r\n      return;\r\n    }\r\n\r\n    if (this.layer.meta.dataType !== LAYER) {\r\n      return undefined;\r\n    }\r\n\r\n    const oLayer = this.map.getLayerById(this.layer.data.sourceOptions.id);\r\n    this.map.removeLayer(oLayer);\r\n  }\r\n\r\n  isInResolutionsRange(resolution: number) {\r\n    const minResolution = this.layer.data.minResolution || 0;\r\n    const maxResolution = this.layer.data.maxResolution || Infinity;\r\n    this.inRange$.next(\r\n      resolution >= minResolution && resolution <= maxResolution\r\n    );\r\n  }\r\n\r\n  computeTooltip(): string {\r\n    if (this.added) {\r\n      return this.inRange$.value\r\n        ? 'igo.geo.catalog.layer.removeFromMap'\r\n        : 'igo.geo.catalog.layer.removeFromMapOutRange';\r\n    } else {\r\n      return this.inRange$.value\r\n        ? 'igo.geo.catalog.layer.addToMap'\r\n        : 'igo.geo.catalog.layer.addToMapOutRange';\r\n    }\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport {\r\n  IgoCollapsibleModule,\r\n  IgoListModule,\r\n  IgoMatBadgeIconModule,\r\n  IgoStopPropagationModule\r\n} from '@igo2/common';\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { IgoMetadataModule } from './../../metadata/metadata.module';\r\nimport { SearchResultsComponent } from './search-results.component';\r\nimport { SearchResultsItemComponent } from './search-results-item.component';\r\nimport { SearchResultAddButtonComponent } from './search-results-add-button.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatBadgeModule,\r\n    MatTooltipModule,\r\n    MatIconModule,\r\n    MatListModule,\r\n    MatButtonModule,\r\n    IgoCollapsibleModule,\r\n    IgoListModule,\r\n    IgoStopPropagationModule,\r\n    IgoLanguageModule,\r\n    IgoMatBadgeIconModule,\r\n    IgoMetadataModule,\r\n  ],\r\n  exports: [\r\n    SearchResultsComponent,\r\n    SearchResultAddButtonComponent\r\n  ],\r\n  declarations: [\r\n    SearchResultsComponent,\r\n    SearchResultsItemComponent,\r\n    SearchResultAddButtonComponent\r\n  ]\r\n})\r\nexport class IgoSearchResultsModule {}\r\n","import { FeatureGeometry } from './../../feature/shared/feature.interfaces';\r\nimport {\r\n  Directive,\r\n  Input,\r\n  OnDestroy,\r\n  Self,\r\n  OnInit,\r\n  AfterContentChecked\r\n} from '@angular/core';\r\n\r\nimport { Subscription } from 'rxjs';\r\n\r\nimport MapBrowserPointerEvent from 'ol/MapBrowserEvent';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { MapBrowserComponent } from '../../map/map-browser/map-browser.component';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport { SearchService } from './search.service';\r\n\r\nimport olFeature from 'ol/Feature';\r\nimport { transform } from 'ol/proj';\r\nimport * as olstyle from 'ol/style';\r\nimport * as olgeom from 'ol/geom';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport { SearchResult, Research } from './search.interfaces';\r\nimport { EntityStore } from '@igo2/common';\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { take } from 'rxjs/operators';\r\nimport { tryBindStoreLayer } from '../../feature/shared/feature.utils';\r\nimport { FeatureStore } from '../../feature/shared/store';\r\nimport { FeatureMotion, FEATURE } from '../../feature/shared/feature.enums';\r\nimport { SearchSourceService } from './search-source.service';\r\nimport { sourceCanReverseSearchAsSummary } from './search.utils';\r\nimport { MediaService } from '@igo2/core';\r\nimport { unByKey } from 'ol/Observable';\r\n\r\n/**\r\n * This directive makes the mouse coordinate trigger a reverse search on available search sources.\r\n * The search results are placed into a label, on a cross icon, representing the mouse coordinate.\r\n * By default, no search sources. Config in config file must be defined.\r\n * the layer level.\r\n */\r\n@Directive({\r\n  selector: '[igoSearchPointerSummary]'\r\n})\r\nexport class SearchPointerSummaryDirective implements OnInit, OnDestroy, AfterContentChecked {\r\n\r\n  public store: FeatureStore<Feature>;\r\n  private lonLat: [number, number];\r\n  private pointerSearchStore: EntityStore<SearchResult> = new EntityStore<SearchResult>([]);\r\n  private lastTimeoutRequest;\r\n  private store$$: Subscription;\r\n  private layers$$: Subscription;\r\n  private reverseSearch$$: Subscription[] = [];\r\n  private hasPointerReverseSearchSource: boolean = false;\r\n\r\n  /**\r\n   * Listener to the pointer move event\r\n   */\r\n  private pointerMoveListener;\r\n\r\n  private searchPointerSummaryFeatureId: string = 'searchPointerSummaryFeatureId';\r\n  /**\r\n   * The delay where the mouse must be motionless before trigger the reverse search\r\n   */\r\n  @Input() igoSearchPointerSummaryDelay: number = 1000;\r\n\r\n  /**\r\n   * If the user has enabled or not the directive\r\n   */\r\n  @Input() igoSearchPointerSummaryEnabled: boolean = false;\r\n\r\n  /**\r\n   * IGO map\r\n   * @internal\r\n   */\r\n  get map(): IgoMap {\r\n    return this.component.map;\r\n  }\r\n\r\n  get mapProjection(): string {\r\n    return (this.component.map as IgoMap).projection;\r\n  }\r\n\r\n  constructor(\r\n    @Self() private component: MapBrowserComponent,\r\n    private searchService: SearchService,\r\n    private searchSourceService: SearchSourceService,\r\n    private mediaService: MediaService\r\n  ) { }\r\n\r\n  /**\r\n   * Start listening to pointermove and reverse search results.\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.listenToMapPointerMove();\r\n    this.subscribeToPointerStore();\r\n\r\n    this.map.status$.pipe(take(1)).subscribe(() => {\r\n      this.store = new FeatureStore<Feature>([], {map: this.map});\r\n      this.initStore();\r\n    });\r\n\r\n    // To handle context change without using the contextService.\r\n    this.layers$$ = this.map.layers$.subscribe((layers) => {\r\n      if (this.store && !layers.find(l => l.id === 'searchPointerSummaryId')) {\r\n        this.initStore();\r\n      }\r\n    });\r\n\r\n  }\r\n\r\n  /**\r\n   * Initialize the pointer position store\r\n   * @internal\r\n   */\r\n  private initStore() {\r\n    const store = this.store;\r\n\r\n    const layer = new VectorLayer({\r\n      isIgoInternalLayer: true,\r\n      id : 'searchPointerSummaryId',\r\n      title: 'searchPointerSummary',\r\n      zIndex: 900,\r\n      source: new FeatureDataSource(),\r\n      showInLayerList: false,\r\n      exportable: false,\r\n      browsable: false,\r\n      style: pointerPositionSummaryMarker\r\n    });\r\n    tryBindStoreLayer(store, layer);\r\n  }\r\n\r\n  ngAfterContentChecked(): void {\r\n      if (!this.searchSourceService.getEnabledSources().filter(sourceCanReverseSearchAsSummary).length) {\r\n        this.hasPointerReverseSearchSource = false;\r\n      } else {\r\n        this.hasPointerReverseSearchSource = true;\r\n      }\r\n    }\r\n\r\n  /**\r\n   * Stop listening to pointermove and reverse search results.\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.unlistenToMapPointerMove();\r\n    this.unsubscribeToPointerStore();\r\n    this.unsubscribeReverseSearch();\r\n    this.layers$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * Subscribe to pointermove result store\r\n   * @internal\r\n   */\r\n  subscribeToPointerStore() {\r\n    this.store$$ = this.pointerSearchStore.entities$.subscribe(resultsUnderPointerPosition => {\r\n      this.entitiesToPointerOverlay(resultsUnderPointerPosition);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Build an object based on the closest feature by type (base on type and distance properties )\r\n   * @param results SearchResult[]\r\n   * @returns OL style function\r\n   */\r\n  private computeSummaryClosestFeature(results: SearchResult[]): {} {\r\n    const closestResultByType = {};\r\n\r\n    results.map(result => {\r\n      if (result.data.properties.type && result.data.properties.distance >= 0) {\r\n        if (closestResultByType.hasOwnProperty(result.data.properties.type)) {\r\n          const prevDistance = closestResultByType[result.data.properties.type].distance;\r\n          if (result.data.properties.distance < prevDistance) {\r\n            const title = result.meta.pointerSummaryTitle || result.meta.title;\r\n            closestResultByType[result.data.properties.type] = { distance: result.data.properties.distance, title };\r\n          }\r\n        } else {\r\n          const title = result.meta.pointerSummaryTitle || result.meta.title;\r\n          closestResultByType[result.data.properties.type] = { distance: result.data.properties.distance, title };\r\n        }\r\n      }\r\n    });\r\n\r\n    return closestResultByType;\r\n  }\r\n\r\n  /**\r\n   * convert store entities to a pointer position overlay with label summary on.\r\n   * @param event OL map browser pointer event\r\n   */\r\n  private entitiesToPointerOverlay(resultsUnderPointerPosition: SearchResult[]) {\r\n    const closestResultByType = this.computeSummaryClosestFeature(resultsUnderPointerPosition);\r\n    const summarizedClosestType = Object.keys(closestResultByType);\r\n    const processedSummarizedClosestType = [];\r\n    const summary = [];\r\n    resultsUnderPointerPosition.map(result => {\r\n      const typeIndex = summarizedClosestType.indexOf(result.data.properties.type);\r\n      if (typeIndex !== -1) {\r\n        summary.push(closestResultByType[result.data.properties.type].title);\r\n        summarizedClosestType.splice(typeIndex, 1);\r\n        processedSummarizedClosestType.push(result.data.properties.type);\r\n      } else {\r\n        if (processedSummarizedClosestType.indexOf(result.data.properties.type) === -1) {\r\n          summary.push(result.meta.pointerSummaryTitle || result.meta.title);\r\n        }\r\n      }\r\n    });\r\n    if (summary.length) {\r\n      this.addPointerOverlay(summary.join('\\n'));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * On map pointermove\r\n   */\r\n  private listenToMapPointerMove() {\r\n    this.pointerMoveListener = this.map.ol.on(\r\n      'pointermove',\r\n      (event: MapBrowserPointerEvent<any>) => this.onMapEvent(event)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to pointer store.\r\n   * @internal\r\n   */\r\n  unsubscribeToPointerStore() {\r\n    this.store$$.unsubscribe();\r\n  }\r\n  /**\r\n   * Unsubscribe to reverse seatch store.\r\n   * @internal\r\n   */\r\n  unsubscribeReverseSearch() {\r\n    this.reverseSearch$$.map(s => s.unsubscribe());\r\n    this.reverseSearch$$ = [];\r\n  }\r\n\r\n  /**\r\n   * Stop listening for map pointermove\r\n   * @internal\r\n   */\r\n  private unlistenToMapPointerMove() {\r\n    unByKey(this.pointerMoveListener);\r\n    this.pointerMoveListener = undefined;\r\n  }\r\n\r\n  /**\r\n   * Trigger reverse search when the mouse is motionless during the defined delay (pointerMoveDelay).\r\n   * @param event OL map browser pointer event\r\n   */\r\n  private onMapEvent(event: MapBrowserPointerEvent<any>) {\r\n    if (\r\n      event.dragging || !this.igoSearchPointerSummaryEnabled ||\r\n      !this.hasPointerReverseSearchSource || this.mediaService.isTouchScreen()) {\r\n      this.clearLayer();\r\n      return;\r\n    }\r\n    if (typeof this.lastTimeoutRequest !== 'undefined') { // cancel timeout when the mouse moves\r\n      clearTimeout(this.lastTimeoutRequest);\r\n      this.clearLayer();\r\n      this.unsubscribeReverseSearch();\r\n    }\r\n\r\n    this.lonLat = transform(event.coordinate, this.mapProjection, 'EPSG:4326') as [number, number];\r\n\r\n    this.lastTimeoutRequest = setTimeout(() => {\r\n      this.onSearchCoordinate();\r\n    }, this.igoSearchPointerSummaryDelay);\r\n  }\r\n\r\n    /**\r\n   * Sort the results by display order.\r\n   * @param r1 First result\r\n   * @param r2 Second result\r\n   */\r\n     private sortByOrder(r1: SearchResult, r2: SearchResult) {\r\n      return r1.source.displayOrder - r2.source.displayOrder;\r\n    }\r\n\r\n  private onSearchCoordinate() {\r\n    this.pointerSearchStore.clear();\r\n    const results = this.searchService.reverseSearch(this.lonLat, { params: { geometry: 'false', icon: 'false' } }, true);\r\n\r\n    for (const i in results) {\r\n      if (results.length > 0) {\r\n        this.reverseSearch$$.push(\r\n          results[i].request.subscribe((_results: SearchResult<Feature>[]) => {\r\n            this.onSearch({ research: results[i], results: _results });\r\n          }));\r\n      }\r\n    }\r\n  }\r\n\r\n  private onSearch(event: { research: Research; results: SearchResult[] }) {\r\n    const results = event.results;\r\n    const newResults = this.pointerSearchStore.all()\r\n      .filter((result: SearchResult) => result.source !== event.research.source)\r\n      .concat(results);\r\n    this.pointerSearchStore.load(newResults.sort(this.sortByOrder));\r\n  }\r\n\r\n  /**\r\n   * Add a feature to the pointer store\r\n   * @param text string\r\n   */\r\n  private addPointerOverlay(text: string) {\r\n    this.clearLayer();\r\n\r\n    const geometry = new olgeom.Point(\r\n      transform(this.lonLat, 'EPSG:4326', this.mapProjection)\r\n    );\r\n    const feature = new olFeature({ geometry });\r\n    const geojsonGeom = new OlGeoJSON().writeGeometryObject(geometry, {\r\n      featureProjection: this.mapProjection,\r\n      dataProjection: this.mapProjection\r\n    }) as FeatureGeometry;\r\n\r\n    const f: Feature = {\r\n      type: FEATURE,\r\n      geometry: geojsonGeom,\r\n      projection: this.mapProjection,\r\n      properties: {\r\n        id: this.searchPointerSummaryFeatureId,\r\n        pointerSummary: text\r\n      },\r\n      meta: {\r\n        id: this.searchPointerSummaryFeatureId\r\n      },\r\n      ol: feature\r\n    };\r\n    this.store.setLayerFeatures([f], FeatureMotion.None);\r\n  }\r\n\r\n/**\r\n * Clear the pointer store features\r\n */\r\nprivate clearLayer() {\r\n  if (this.store) {\r\n    this.store.clearLayer();\r\n  }\r\n}\r\n\r\n}\r\n\r\n/**\r\n * Create a default style for the pointer position and it's label summary.\r\n * @param feature OlFeature\r\n * @returns OL style function\r\n */\r\nexport function pointerPositionSummaryMarker(feature: olFeature<OlGeometry>, resolution: number): olstyle.Style {\r\n  return new olstyle.Style({\r\n    image: new olstyle.Icon({\r\n      src: './assets/igo2/geo/icons/cross_black_18px.svg',\r\n      imgSize: [18, 18], // for ie\r\n    }),\r\n\r\n    text: new olstyle.Text({\r\n      text: feature.get('pointerSummary'),\r\n      textAlign: 'left',\r\n      textBaseline: 'bottom',\r\n      font: '12px Calibri,sans-serif',\r\n      fill: new olstyle.Fill({ color: '#000' }),\r\n      backgroundFill: new olstyle.Fill({ color: 'rgba(255, 255, 255, 0.5)' }),\r\n      backgroundStroke: new olstyle.Stroke({ color: 'rgba(200, 200, 200, 0.75)', width: 2 }),\r\n      stroke: new olstyle.Stroke({ color: '#fff', width: 3 }),\r\n      overflow: true,\r\n      offsetX: 10,\r\n      offsetY: -10,\r\n      padding: [2.5, 2.5, 2.5, 2.5]\r\n    })\r\n  });\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { SearchService } from './shared/search.service';\r\nimport { provideSearchSourceService } from './shared/search-source-service.providers';\r\nimport { provideDefaultIChercheSearchResultFormatter } from './shared/sources/icherche.providers';\r\nimport { provideDefaultCoordinatesSearchResultFormatter } from './shared/sources/coordinates.providers';\r\nimport { provideILayerSearchResultFormatter } from './shared/sources/ilayer.providers';\r\n\r\nimport { IgoSearchBarModule } from './search-bar/search-bar.module';\r\nimport { IgoSearchSelectorModule } from './search-selector/search-selector.module';\r\nimport { IgoSearchResultsModule } from './search-results/search-results.module';\r\nimport { IgoSearchSettingsModule } from './search-settings/search-settings.module';\r\nimport { SearchPointerSummaryDirective } from './shared/search-pointer-summary.directive';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoSearchBarModule,\r\n    IgoSearchSelectorModule,\r\n    IgoSearchResultsModule,\r\n    IgoSearchSettingsModule\r\n  ],\r\n  exports: [\r\n    IgoSearchBarModule,\r\n    IgoSearchSelectorModule,\r\n    IgoSearchResultsModule,\r\n    IgoSearchSettingsModule,\r\n    SearchPointerSummaryDirective\r\n  ],\r\n  declarations: [SearchPointerSummaryDirective]\r\n})\r\nexport class IgoSearchModule {\r\n  static forRoot(): ModuleWithProviders<IgoSearchModule> {\r\n    return {\r\n      ngModule: IgoSearchModule,\r\n      providers: [\r\n        SearchService,\r\n        provideSearchSourceService(),\r\n        provideDefaultIChercheSearchResultFormatter(),\r\n        provideDefaultCoordinatesSearchResultFormatter(),\r\n        provideILayerSearchResultFormatter()\r\n      ]\r\n    };\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\n\r\nimport { OnUpdateInputs, WidgetComponent } from '@igo2/common';\r\n\r\nimport { Layer } from '../../../layer/shared/layers/layer';\r\nimport { IgoMap } from '../../../map/shared/map';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filter',\r\n  templateUrl: './ogc-filter.component.html',\r\n  styleUrls: ['./ogc-filter.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class OgcFilterComponent implements OnUpdateInputs, WidgetComponent {\r\n\r\n  @Input() layer: Layer;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * Event emitted on complete\r\n   */\r\n  @Output() complete = new EventEmitter<void>();\r\n\r\n  /**\r\n   * Event emitted on cancel\r\n   */\r\n  @Output() cancel = new EventEmitter<void>();\r\n\r\n  constructor(private cdRef: ChangeDetectorRef) {}\r\n\r\n  /**\r\n   * Implemented as part of OnUpdateInputs\r\n   */\r\n  onUpdateInputs() {\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n  /**\r\n   * On close, emit the cancel event\r\n   */\r\n  onClose() {\r\n    this.cancel.emit();\r\n  }\r\n\r\n}\r\n","<igo-ogc-filterable-item\r\n  igoListItem\r\n  [layer]=\"layer\"\r\n  [header]=\"false\" \r\n  [map]=\"map\" >\r\n</igo-ogc-filterable-item>","import { InjectionToken } from '@angular/core';\r\n\r\nimport { Widget, WidgetService } from '@igo2/common';\r\n\r\nimport { OgcFilterComponent } from './ogc-filter/ogc-filter.component';\r\n\r\nexport const OgcFilterWidget = new InjectionToken<Widget>('OgcFilterWidget');\r\n\r\nexport function ogcFilterWidgetFactory(widgetService: WidgetService): Widget {\r\n  return widgetService.create(OgcFilterComponent);\r\n}\r\n\r\nexport function provideOgcFilterWidget() {\r\n  return {\r\n    provide: OgcFilterWidget,\r\n    useFactory: ogcFilterWidgetFactory,\r\n    deps: [WidgetService]\r\n  };\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { IgoFilterModule } from '../../../filter/filter.module';\r\nimport { OgcFilterComponent } from './ogc-filter.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatButtonModule,\r\n    IgoLanguageModule,\r\n    IgoFilterModule\r\n  ],\r\n  exports: [OgcFilterComponent],\r\n  declarations: [OgcFilterComponent]\r\n})\r\nexport class IgoOgcFilterModule {}\r\n","import {\r\n  Workspace,\r\n  WorkspaceOptions\r\n} from '@igo2/common';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { VectorLayer } from '../../layer';\r\nimport { IgoMap } from '../../map';\r\n\r\nexport interface WfsWorkspaceOptions extends WorkspaceOptions {\r\n  layer: VectorLayer;\r\n  map: IgoMap;\r\n}\r\n\r\nexport class WfsWorkspace extends Workspace {\r\n\r\n  readonly inResolutionRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  get layer(): VectorLayer { return this.options.layer; }\r\n\r\n  get map(): IgoMap { return this.options.map; }\r\n\r\n  constructor(protected options: WfsWorkspaceOptions) {\r\n    super(options);\r\n    this.map.viewController.resolution$.subscribe((mapResolution) => {\r\n      if (mapResolution > this.layer.minResolution && mapResolution < this.layer.maxResolution) {\r\n        this.inResolutionRange$.next(true);\r\n      } else {\r\n        this.inResolutionRange$.next(false);\r\n      }\r\n    });\r\n  }\r\n\r\n  public getLayerWksOptionTabQuery(): boolean {\r\n    if (this.layer.options.workspace.queryOptions?.tabQuery !== undefined) {\r\n      return this.layer.options.workspace.queryOptions.tabQuery;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  public getLayerWksOptionMapQuery(): boolean {\r\n    if (this.layer.options.workspace.queryOptions?.mapQueryOnOpenTab !== undefined) {\r\n      return this.layer.options.workspace.queryOptions.mapQueryOnOpenTab;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  private getInResolutionRange(): boolean {\r\n    return this.inResolutionRange$.value;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport {\r\n  ActionStore,\r\n  EntityTableTemplate,\r\n  EntityStoreFilterCustomFuncStrategy,\r\n  EntityRecord,\r\n  EntityStoreStrategyFuncOptions,\r\n  EntityStoreFilterSelectionStrategy,\r\n  EntityTableColumnRenderer\r\n} from '@igo2/common';\r\n\r\nimport {\r\n  FeatureStore,\r\n  FeatureStoreLoadingLayerStrategy,\r\n  FeatureStoreSelectionStrategy,\r\n  FeatureStoreInMapExtentStrategy,\r\n  Feature,\r\n  FeatureMotion,\r\n  FeatureStoreInMapResolutionStrategy\r\n} from '../../feature';\r\nimport { VectorLayer } from '../../layer';\r\nimport { GeoWorkspaceOptions } from '../../layer/shared/layers/layer.interface';\r\nimport { IgoMap } from '../../map';\r\nimport { SourceFieldsOptionsParams, FeatureDataSource, RelationOptions } from '../../datasource';\r\nimport { getCommonVectorSelectedStyle} from '../../utils';\r\n\r\nimport { WfsWorkspace } from './wfs-workspace';\r\nimport { skipWhile, take } from 'rxjs/operators';\r\nimport { StorageService, ConfigService } from '@igo2/core';\r\nimport olFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class WfsWorkspaceService {\r\n\r\n  get zoomAuto(): boolean {\r\n    return this.storageService.get('zoomAuto') as boolean;\r\n  }\r\n\r\n  public ws$ = new BehaviorSubject<string>(undefined);\r\n\r\n  constructor(private storageService: StorageService, private configService: ConfigService) {}\r\n\r\n  createWorkspace(layer: VectorLayer, map: IgoMap): WfsWorkspace {\r\n    if (layer.options.workspace?.enabled === false || layer.dataSource.options.edition) {\r\n      return;\r\n    }\r\n\r\n    layer.options.workspace = Object.assign({}, layer.options.workspace,\r\n      {\r\n        srcId: layer.id,\r\n        workspaceId: layer.id,\r\n        enabled: true\r\n      } as GeoWorkspaceOptions);\r\n\r\n    const wks = new WfsWorkspace({\r\n      id: layer.id,\r\n      title: layer.title,\r\n      layer,\r\n      map,\r\n      entityStore: this.createFeatureStore(layer, map),\r\n      actionStore: new ActionStore([]),\r\n      meta: {\r\n        tableTemplate: undefined\r\n      }\r\n    });\r\n    this.createTableTemplate(wks, layer);\r\n    return wks;\r\n  }\r\n\r\n  private createFeatureStore(layer: VectorLayer, map: IgoMap): FeatureStore {\r\n    const store = new FeatureStore([], {map});\r\n    store.bindLayer(layer);\r\n\r\n    const loadingStrategy = new FeatureStoreLoadingLayerStrategy({});\r\n    const inMapExtentStrategy = new FeatureStoreInMapExtentStrategy({});\r\n    const inMapResolutionStrategy = new FeatureStoreInMapResolutionStrategy({});\r\n    const selectedRecordStrategy = new EntityStoreFilterSelectionStrategy({});\r\n    const confQueryOverlayStyle= this.configService.getConfig('queryOverlayStyle');\r\n\r\n    const selectionStrategy = new FeatureStoreSelectionStrategy({\r\n      layer: new VectorLayer({\r\n        zIndex: 300,\r\n        source: new FeatureDataSource(),\r\n        style: (feature) => {\r\n          return getCommonVectorSelectedStyle(Object.assign({}, {feature}, confQueryOverlayStyle.selection || {}));\r\n        },\r\n        showInLayerList: false,\r\n        exportable: false,\r\n        browsable: false\r\n      }),\r\n      map,\r\n      hitTolerance: 15,\r\n      motion: this.zoomAuto ? FeatureMotion.Default : FeatureMotion.None,\r\n      many: true,\r\n      dragBox: true\r\n    });\r\n    store.addStrategy(loadingStrategy, true);\r\n    store.addStrategy(inMapExtentStrategy, true);\r\n    store.addStrategy(inMapResolutionStrategy, true);\r\n    store.addStrategy(selectionStrategy, true);\r\n    store.addStrategy(selectedRecordStrategy, false);\r\n    store.addStrategy(this.createFilterInMapExtentOrResolutionStrategy(), true);\r\n    return store;\r\n  }\r\n\r\n  private createTableTemplate(workspace: WfsWorkspace, layer: VectorLayer): EntityTableTemplate {\r\n    const fields = layer.dataSource.options.sourceFields || [];\r\n\r\n    const relations = layer.dataSource.options.relations || [];\r\n\r\n    if (fields.length === 0) {\r\n      workspace.entityStore.entities$.pipe(\r\n        skipWhile(val => val.length === 0),\r\n        take(1)\r\n      ).subscribe(entities => {\r\n        const ol = (entities[0] as Feature).ol as olFeature<OlGeometry>;\r\n        const columnsFromFeatures = ol.getKeys()\r\n        .filter(\r\n          col => !col.startsWith('_') &&\r\n          col !== 'geometry' &&\r\n          col !== ol.getGeometryName() &&\r\n          !col.match(/boundedby/gi))\r\n        .map(key => {\r\n          return {\r\n            name: `properties.${key}`,\r\n            title: key,\r\n            renderer: EntityTableColumnRenderer.UnsanitizedHTML\r\n          };\r\n        });\r\n        workspace.meta.tableTemplate = {\r\n          selection: true,\r\n          sort: true,\r\n          columns: columnsFromFeatures\r\n        };\r\n      });\r\n      return;\r\n    }\r\n    const columns = fields.map((field: SourceFieldsOptionsParams) => {\r\n      return {\r\n        name: `properties.${field.name}`,\r\n        title: field.alias ? field.alias : field.name,\r\n        renderer: EntityTableColumnRenderer.UnsanitizedHTML,\r\n        tooltip: field.tooltip\r\n      };\r\n    });\r\n\r\n    const relationsColumn = relations.map((relation: RelationOptions) => {\r\n      return {\r\n        name: `properties.${relation.name}`,\r\n        title: relation.alias ? relation.alias : relation.name,\r\n        renderer: EntityTableColumnRenderer.Icon,\r\n        icon: relation.icon,\r\n        parent: relation.parent,\r\n        type: 'relation',\r\n        tooltip: relation.tooltip,\r\n        onClick: () => {\r\n            this.ws$.next(relation.title);\r\n        },\r\n        cellClassFunc: () => {\r\n          return { 'class_icon': true };\r\n        }\r\n      };\r\n    });\r\n\r\n    columns.push(...relationsColumn);\r\n    workspace.meta.tableTemplate = {\r\n      selection: true,\r\n      sort: true,\r\n      columns\r\n    };\r\n  }\r\n  private createFilterInMapExtentOrResolutionStrategy(): EntityStoreFilterCustomFuncStrategy {\r\n    const filterClauseFunc = (record: EntityRecord<object>) => {\r\n      return record.state.inMapExtent === true && record.state.inMapResolution === true;\r\n    };\r\n    return new EntityStoreFilterCustomFuncStrategy({filterClauseFunc} as EntityStoreStrategyFuncOptions);\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport {\r\n  ActionStore,\r\n  EntityRecord,\r\n  EntityStoreFilterCustomFuncStrategy,\r\n  EntityStoreFilterSelectionStrategy,\r\n  EntityStoreStrategyFuncOptions,\r\n  EntityTableColumnRenderer,\r\n  EntityTableTemplate } from '@igo2/common';\r\nimport { StorageService, ConfigService } from '@igo2/core';\r\nimport { skipWhile, take } from 'rxjs/operators';\r\nimport { RelationOptions, SourceFieldsOptionsParams, WMSDataSource } from '../../datasource';\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { WFSDataSourceOptions } from '../../datasource/shared/datasources/wfs-datasource.interface';\r\nimport {\r\n  Feature,\r\n  FeatureMotion,\r\n  FeatureStore,\r\n  FeatureStoreInMapExtentStrategy,\r\n  FeatureStoreInMapResolutionStrategy,\r\n  FeatureStoreLoadingLayerStrategy,\r\n  FeatureStoreSelectionStrategy } from '../../feature';\r\n\r\nimport { OgcFilterableDataSourceOptions } from '../../filter/shared/ogc-filter.interface';\r\nimport { ImageLayer, LayerService, LayersLinkProperties, LinkedProperties, VectorLayer } from '../../layer';\r\nimport { StyleService } from '../../layer/shared/style.service';\r\nimport { GeoWorkspaceOptions } from '../../layer/shared/layers/layer.interface';\r\nimport { IgoMap } from '../../map';\r\nimport { QueryableDataSourceOptions } from '../../query/shared/query.interfaces';\r\nimport { WfsWorkspace } from './wfs-workspace';\r\nimport { getCommonVectorSelectedStyle} from '../../utils';\r\n\r\nimport olFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class WmsWorkspaceService {\r\n\r\n  get zoomAuto(): boolean {\r\n    return this.storageService.get('zoomAuto') as boolean;\r\n  }\r\n\r\n  public ws$ = new BehaviorSubject<string>(undefined);\r\n\r\n  constructor(\r\n    private layerService: LayerService,\r\n    private storageService: StorageService,\r\n    private styleService: StyleService,\r\n    private configService: ConfigService) { }\r\n\r\n  createWorkspace(layer: ImageLayer, map: IgoMap): WfsWorkspace {\r\n    if (\r\n      !layer.options.workspace ||\r\n      map.layers.find(lay => lay.id === layer.id + '.WfsWorkspaceTableDest') ||\r\n      layer.dataSource.options.edition) {\r\n      return;\r\n    }\r\n    const dataSource: WMSDataSource = layer.dataSource as WMSDataSource ;\r\n    const wmsLinkId = layer.id + '.WmsWorkspaceTableSrc';\r\n    const wfsLinkId = layer.id + '.WfsWorkspaceTableDest';\r\n    if (!layer.options.linkedLayers) {\r\n      layer.options.linkedLayers = { linkId: wmsLinkId, links: [] };\r\n    }\r\n    const linkProperties = {\r\n      syncedDelete: true,\r\n      linkedIds: [wfsLinkId],\r\n      properties: [\r\n        LinkedProperties.ZINDEX,\r\n        LinkedProperties.VISIBLE]\r\n    } as LayersLinkProperties;\r\n\r\n    if (!layer.options.workspace?.minResolution) {\r\n       linkProperties.properties.push(LinkedProperties.MINRESOLUTION);\r\n    }\r\n    let hasOgcFilters = false;\r\n    if ((dataSource.options as OgcFilterableDataSourceOptions).ogcFilters?.enabled) {\r\n      linkProperties.properties.push(LinkedProperties.OGCFILTERS);\r\n      hasOgcFilters = true;\r\n    }\r\n    if (!layer.options.workspace?.maxResolution) {\r\n      linkProperties.properties.push(LinkedProperties.MAXRESOLUTION);\r\n    }\r\n\r\n    let clonedLinks: LayersLinkProperties[] = [];\r\n    if (layer.options.linkedLayers.links) {\r\n      clonedLinks = JSON.parse(JSON.stringify(layer.options.linkedLayers.links));\r\n    }\r\n    clonedLinks.push(linkProperties);\r\n\r\n    layer.options.linkedLayers.linkId = layer.options.linkedLayers.linkId ? layer.options.linkedLayers.linkId : wmsLinkId,\r\n      layer.options.linkedLayers.links = clonedLinks;\r\n    interface WFSoptions extends WFSDataSourceOptions, OgcFilterableDataSourceOptions { }\r\n\r\n    let wks;\r\n    let wksLayerOption = {\r\n      srcId: layer.id,\r\n      workspaceId: undefined,\r\n      enabled: false,\r\n      queryOptions: {\r\n        mapQueryOnOpenTab: layer.options.workspace?.queryOptions?.mapQueryOnOpenTab,\r\n        tabQuery: layer.options.workspace?.queryOptions?.tabQuery\r\n      },\r\n      pageSize: layer.options.workspace?.pageSize,\r\n      pageSizeOptions: layer.options.workspace?.pageSizeOptions\r\n    };\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        isIgoInternalLayer: true,\r\n        id: wfsLinkId,\r\n        linkedLayers: {\r\n          linkId: wfsLinkId\r\n        },\r\n        workspace: wksLayerOption,\r\n        showInLayerList: false,\r\n        opacity: 0,\r\n        title: layer.title,\r\n        minResolution: layer.options.workspace?.minResolution || layer.minResolution || 0,\r\n        maxResolution: layer.options.workspace?.maxResolution || layer.maxResolution || Infinity,\r\n        style: this.styleService.createStyle(\r\n          {\r\n            fill: {\r\n              \"color\": \"rgba(255, 255, 255, 0.01)\"\r\n            },\r\n            stroke: {\r\n              \"color\": \"rgba(255, 255, 255, 0.01)\"\r\n            },\r\n            circle: {\r\n              fill: {\r\n                color: \"rgba(255, 255, 255, 0.01)\"\r\n              },\r\n              stroke: {\r\n                color: \"rgba(255, 255, 255, 0.01)\"\r\n              },\r\n              radius: 5\r\n            }\r\n          }),\r\n        sourceOptions: {\r\n          download: dataSource.options.download,\r\n          type: 'wfs',\r\n          url: dataSource.options.urlWfs || dataSource.options.url,\r\n          queryable: true,\r\n          relations: dataSource.options.relations,\r\n          queryTitle: (dataSource.options as QueryableDataSourceOptions).queryTitle,\r\n          queryFormatAsWms: layer.options.workspace?.enabled ? (dataSource.options as QueryableDataSourceOptions).queryFormatAsWms : true,\r\n          params: dataSource.options.paramsWFS,\r\n          ogcFilters: Object.assign({}, dataSource.ogcFilters, {enabled: hasOgcFilters}),\r\n          sourceFields: dataSource.options.sourceFields || undefined\r\n        } as WFSoptions\r\n      })\r\n      .subscribe((workspaceLayer: VectorLayer) => {\r\n        map.addLayer(workspaceLayer);\r\n        layer.ol.setProperties({ linkedLayers: { linkId: layer.options.linkedLayers.linkId, links: clonedLinks } }, false);\r\n        workspaceLayer.dataSource.ol.refresh();\r\n\r\n        if (!layer.options.workspace?.enabled) {\r\n          return;\r\n        }\r\n        wks = new WfsWorkspace({\r\n          id: layer.id,\r\n          title: layer.title,\r\n          layer: workspaceLayer,\r\n          map,\r\n          entityStore: this.createFeatureStore(workspaceLayer, map),\r\n          actionStore: new ActionStore([]),\r\n          meta: {\r\n            tableTemplate: undefined\r\n          }\r\n        });\r\n        this.createTableTemplate(wks, workspaceLayer);\r\n\r\n        workspaceLayer.options.workspace.workspaceId = workspaceLayer.id;\r\n        layer.options.workspace = Object.assign({}, layer.options.workspace,\r\n          {\r\n            enabled: true,\r\n            srcId: layer.id,\r\n            workspaceId: workspaceLayer.id,\r\n            queryOptions: {\r\n              mapQueryOnOpenTab: layer.options.workspace?.queryOptions?.mapQueryOnOpenTab,\r\n              tabQuery: layer.options.workspace?.queryOptions?.tabQuery\r\n            },\r\n            pageSize: layer.options.workspace?.pageSize,\r\n            pageSizeOptions: layer.options.workspace?.pageSizeOptions\r\n          } as GeoWorkspaceOptions);\r\n\r\n        delete dataSource.options.download;\r\n        return wks;\r\n\r\n      });\r\n\r\n    return wks;\r\n  }\r\n\r\n  private createFeatureStore(layer: VectorLayer, map: IgoMap): FeatureStore {\r\n    const store = new FeatureStore([], { map });\r\n    store.bindLayer(layer);\r\n\r\n    const loadingStrategy = new FeatureStoreLoadingLayerStrategy({});\r\n    const inMapExtentStrategy = new FeatureStoreInMapExtentStrategy({});\r\n    const inMapResolutionStrategy = new FeatureStoreInMapResolutionStrategy({});\r\n    const selectedRecordStrategy = new EntityStoreFilterSelectionStrategy({});\r\n    const confQueryOverlayStyle= this.configService.getConfig('queryOverlayStyle');\r\n\r\n    const selectionStrategy = new FeatureStoreSelectionStrategy({\r\n      layer: new VectorLayer({\r\n        zIndex: 300,\r\n        source: new FeatureDataSource(),\r\n        style: (feature) => {\r\n          return getCommonVectorSelectedStyle(Object.assign({}, {feature}, confQueryOverlayStyle.selection || {}));\r\n        },\r\n        showInLayerList: false,\r\n        exportable: false,\r\n        browsable: false\r\n      }),\r\n      map,\r\n      hitTolerance: 15,\r\n      motion: this.zoomAuto ? FeatureMotion.Default : FeatureMotion.None,\r\n      many: true,\r\n      dragBox: true\r\n    });\r\n    store.addStrategy(loadingStrategy, true);\r\n    store.addStrategy(inMapExtentStrategy, true);\r\n    store.addStrategy(inMapResolutionStrategy, true);\r\n    store.addStrategy(selectionStrategy, true);\r\n    store.addStrategy(selectedRecordStrategy, false);\r\n    store.addStrategy(this.createFilterInMapExtentOrResolutionStrategy(), true);\r\n    return store;\r\n  }\r\n\r\n  private createTableTemplate(workspace: WfsWorkspace, layer: VectorLayer): EntityTableTemplate {\r\n    const fields = layer.dataSource.options.sourceFields || [];\r\n\r\n    const relations = layer.dataSource.options.relations || [];\r\n\r\n    if (fields.length === 0) {\r\n      workspace.entityStore.entities$.pipe(\r\n        skipWhile(val => val.length === 0),\r\n        take(1)\r\n      ).subscribe(entities => {\r\n        const ol = (entities[0] as Feature).ol as olFeature<OlGeometry>;\r\n        const columnsFromFeatures = ol.getKeys()\r\n          .filter(\r\n            col => !col.startsWith('_') &&\r\n              col !== 'geometry' &&\r\n              col !== ol.getGeometryName() &&\r\n              !col.match(/boundedby/gi))\r\n          .map(key => {\r\n            return {\r\n              name: `properties.${key}`,\r\n              title: key,\r\n              renderer: EntityTableColumnRenderer.UnsanitizedHTML\r\n            };\r\n          });\r\n        workspace.meta.tableTemplate = {\r\n          selection: true,\r\n          sort: true,\r\n          columns: columnsFromFeatures\r\n        };\r\n      });\r\n      return;\r\n    }\r\n    const columns = fields.map((field: SourceFieldsOptionsParams) => {\r\n      return {\r\n        name: `properties.${field.name}`,\r\n        title: field.alias ? field.alias : field.name,\r\n        renderer: EntityTableColumnRenderer.UnsanitizedHTML,\r\n        tooltip: field.tooltip\r\n      };\r\n    });\r\n\r\n    const relationsColumn = relations.map((relation: RelationOptions) => {\r\n      return {\r\n        name: `properties.${relation.name}`,\r\n        title: relation.alias ? relation.alias : relation.name,\r\n        renderer: EntityTableColumnRenderer.Icon,\r\n        icon: relation.icon,\r\n        parent: relation.parent,\r\n        type: 'relation',\r\n        tooltip: relation.tooltip,\r\n        onClick: () => {\r\n            this.ws$.next(relation.title);\r\n        },\r\n        cellClassFunc: () => {\r\n          return { 'class_icon': true };\r\n        }\r\n      };\r\n    });\r\n\r\n    columns.push(...relationsColumn);\r\n    workspace.meta.tableTemplate = {\r\n      selection: true,\r\n      sort: true,\r\n      columns\r\n    };\r\n  }\r\n\r\n  private createFilterInMapExtentOrResolutionStrategy(): EntityStoreFilterCustomFuncStrategy {\r\n    const filterClauseFunc = (record: EntityRecord<object>) => {\r\n      return record.state.inMapExtent === true && record.state.inMapResolution === true;\r\n    };\r\n    return new EntityStoreFilterCustomFuncStrategy({filterClauseFunc} as EntityStoreStrategyFuncOptions);\r\n  }\r\n}\r\n","import { LanguageService } from '@igo2/core';\r\nimport { Component, Inject } from '@angular/core';\r\nimport { MatDialogRef, MAT_DIALOG_DATA } from '@angular/material/dialog';\r\n\r\nexport interface DialogData {\r\n  type: string;\r\n  cancel: boolean;\r\n}\r\n\r\n@Component({\r\n    selector: 'igo-confirmation-popup-component',\r\n    templateUrl: './confirmation-popup.component.html',\r\n    styleUrls: ['./confirmation-popup.component.scss']\r\n  })\r\n  export class ConfirmationPopupComponent {\r\n\r\n    constructor(\r\n      public dialogRef: MatDialogRef<ConfirmationPopupComponent>,\r\n      public languageService: LanguageService,\r\n      @Inject(MAT_DIALOG_DATA) public data: {type: string, cancel: boolean}) {}\r\n\r\n    cancelAction() {\r\n      this.data.cancel = true;\r\n      this.dialogRef.close(this.data.cancel);\r\n    }\r\n\r\n    confirmedAction() {\r\n      this.data.cancel = false;\r\n      this.dialogRef.close(this.data.cancel);\r\n    }\r\n  }\r\n","<div mat-dialog-content>\r\n  <p class=\"mat-typography\">{{data.type === 'add' ?\r\n    languageService.translate.instant('igo.geo.workspace.addConfirmation') :\r\n    languageService.translate.instant('igo.geo.workspace.deleteConfirmation')}}</p>\r\n</div>\r\n<div mat-dialog-actions>\r\n  <button\r\n    mat-raised-button\r\n    color=\"primary\"\r\n    (click)=\"confirmedAction()\">Ok\r\n  </button>\r\n  <button\r\n    mat-raised-button\r\n    (click)=\"cancelAction()\">{{languageService.translate.instant('igo.geo.workspace.cancel')}}\r\n  </button>\r\n</div>","import { MatDialog } from '@angular/material/dialog';\r\nimport {\r\n  Workspace,\r\n  WorkspaceOptions,\r\n  EntityRecord\r\n} from '@igo2/common';\r\nimport { ConfigService } from '@igo2/core';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\nimport { ImageLayer, VectorLayer } from '../../layer';\r\nimport { IgoMap } from '../../map';\r\nimport { EditionWorkspaceService } from './edition-workspace.service';\r\nimport { ConfirmationPopupComponent } from '../confirmation-popup/confirmation-popup.component';\r\nimport { DrawControl } from '../../geometry';\r\nimport { createInteractionStyle, GeometryType } from '../../draw';\r\nimport { featureToOl } from '../../feature';\r\n\r\nimport type { Type } from 'ol/geom/Geometry';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport OlVectorSource from 'ol/source/Vector';\r\nimport * as OlStyle from 'ol/style';\r\nimport OlModify from 'ol/interaction/Modify';\r\nimport Collection from 'ol/Collection';\r\nimport OlFeature from 'ol/Feature';\r\nimport { FeatureDataSource } from '../../datasource/shared';\r\n\r\nexport interface EditionWorkspaceOptions extends WorkspaceOptions {\r\n  layer: ImageLayer | VectorLayer;\r\n  map: IgoMap;\r\n}\r\n\r\nexport class EditionWorkspace extends Workspace {\r\n\r\n  readonly inResolutionRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  get layer(): ImageLayer | VectorLayer { return this.options.layer; }\r\n\r\n  get map(): IgoMap { return this.options.map; }\r\n\r\n  private drawControl: DrawControl;\r\n  private drawEnd$$: Subscription;\r\n  private olDrawingLayerSource = new OlVectorSource();\r\n  private olDrawingLayer: VectorLayer;\r\n  public geometryType = GeometryType; // Reference to the GeometryType enum\r\n  public modify; // Reference to the ol interaction\r\n\r\n  public modifyStyle = new OlStyle.Style({\r\n    stroke: new OlStyle.Stroke({\r\n      color: 'rgba(255,255,255,1)',\r\n      width: 1\r\n    }),\r\n    fill: new OlStyle.Fill({\r\n      color: 'rgba(0,161,222,1)'\r\n    }),\r\n    image: new OlStyle.Circle({\r\n      radius: 7,\r\n      stroke: new OlStyle.Stroke({\r\n        color: 'rgba(255,255,255,1)',\r\n        width: 1\r\n      }),\r\n      fill: new OlStyle.Fill({\r\n        color: 'rgba(0,161,222,1)'\r\n      })\r\n    })\r\n  });\r\n\r\n  private newFeaturefilterClauseFunc = (record: EntityRecord<object>) => {\r\n    return record.state.newFeature === true;\r\n  };\r\n\r\n  private editFeaturefilterClauseFunc = (record: EntityRecord<object>) => {\r\n    return record.state.edit === true;\r\n  };\r\n\r\n  public fillColor: string;\r\n  public strokeColor: string;\r\n  public strokeWidth: number;\r\n\r\n  constructor(\r\n    protected options: EditionWorkspaceOptions,\r\n    private editionWorkspaceService: EditionWorkspaceService,\r\n    private dialog: MatDialog,\r\n    private configService: ConfigService) {\r\n    super(options);\r\n    this.map.viewController.resolution$.subscribe((mapResolution) => {\r\n      if (mapResolution > this.layer.minResolution && mapResolution < this.layer.maxResolution) {\r\n        this.inResolutionRange$.next(true);\r\n      } else {\r\n        this.inResolutionRange$.next(false);\r\n      }\r\n    });\r\n\r\n    this.drawControl = this.createDrawControl();\r\n    this.drawControl.setGeometryType(this.geometryType.Point as any);\r\n\r\n    this.map.removeLayer(this.olDrawingLayer);\r\n\r\n    this.olDrawingLayer = new VectorLayer({\r\n      id: 'igo-draw-layer',\r\n      title: 'edition',\r\n      zIndex: 300,\r\n      source: new FeatureDataSource(),\r\n      showInLayerList: false,\r\n      exportable: false,\r\n      browsable: false,\r\n      workspace: {\r\n        enabled: false\r\n      },\r\n    });\r\n  }\r\n\r\n  private getInResolutionRange(): boolean {\r\n    return this.inResolutionRange$.value;\r\n  }\r\n\r\n  deleteFeature(feature, workspace) {\r\n    setTimeout(() => {\r\n      const dialogRef = this.dialog.open(ConfirmationPopupComponent, {\r\n        disableClose: false,\r\n        data: {type: 'delete'}\r\n    });\r\n\r\n      dialogRef.afterClosed().subscribe(result => {\r\n        if (result === false) {\r\n          let id, url;\r\n          const baseUrl = workspace.layer.dataSource.options.edition.baseUrl;\r\n          const deleteUrl = workspace.layer.dataSource.options.edition.deleteUrl;\r\n          if (baseUrl.length) {\r\n            url = this.configService.getConfig('edition.url') ?\r\n              this.configService.getConfig('edition.url') + baseUrl + '?' + deleteUrl :\r\n              baseUrl + '?' + deleteUrl;\r\n          } else {\r\n            url = this.configService.getConfig('edition.url') ?\r\n              this.configService.getConfig('edition.url') + deleteUrl : deleteUrl;\r\n          }\r\n\r\n          for (const column of workspace.meta.tableTemplate.columns) {\r\n            for (const property in feature.properties) {\r\n              let columnName = column.name;\r\n              if (columnName.includes('properties.')) {\r\n                columnName = columnName.split('.')[1];\r\n              }\r\n              if (columnName === property && column.primary === true) {\r\n                id = feature.properties[property];\r\n              }\r\n            }\r\n          }\r\n          if (url) {\r\n            url += id;\r\n            this.editionWorkspaceService.deleteFeature(workspace, url);\r\n          }\r\n        }\r\n      });\r\n    }, 250);\r\n  }\r\n\r\n  editFeature(feature, workspace: EditionWorkspace) {\r\n    feature.edition = true;\r\n    let id;\r\n    let find = false;\r\n    const editionOpt = workspace.layer.dataSource.options.edition;\r\n    for (const column of workspace.meta.tableTemplate.columns ) {\r\n\r\n      // Update domain list\r\n      if (column.type === 'list' || column.type === 'autocomplete') {\r\n        this.editionWorkspaceService.getDomainValues(column.relation).subscribe(result => {\r\n          column.domainValues = result;\r\n        });\r\n      }\r\n      if (find === false) {\r\n        for (const property in feature.properties) {\r\n          let columnName = column.name;\r\n          if (columnName.includes('properties.')) {\r\n            columnName = columnName.split('.')[1];\r\n          }\r\n          if (columnName === property && column.primary === true) {\r\n            id = feature.properties[property];\r\n            find = true;\r\n            break;\r\n          }\r\n        }\r\n      }\r\n    }\r\n    if (id) {\r\n      feature.original_properties = JSON.parse(JSON.stringify(feature.properties));\r\n      feature.original_geometry = feature.geometry;\r\n      feature.idkey = id;\r\n      workspace.entityStore.state.updateAll({ edit: false });\r\n      workspace.entityStore.stateView.filter(this.editFeaturefilterClauseFunc);\r\n      this.addFeatureToStore(feature, workspace);\r\n    } else {\r\n      // Only for edition with it's own geometry\r\n      if (!feature.newFeature && editionOpt.geomType) {\r\n        feature.newFeature = true;\r\n        this.editionWorkspaceService.adding$.next(true);\r\n        workspace.entityStore.state.updateAll({ newFeature: false });\r\n        workspace.entityStore.stateView.filter(this.newFeaturefilterClauseFunc);\r\n        if (editionOpt.addWithDraw) {\r\n          const geometryType = editionOpt.geomType;\r\n          this.onGeometryTypeChange(geometryType, feature, workspace);\r\n        } else {\r\n          workspace.entityStore.insert(feature);\r\n          workspace.entityStore.state.update(feature, { newFeature: true }, true);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create a Draw Control\r\n   * @param fillColor the fill color\r\n   * @param strokeColor the stroke color\r\n   * @param strokeWidth the stroke width\r\n   * @returns a Draw Control\r\n   */\r\n  createDrawControl(fillColor?: string, strokeColor?: string, strokeWidth?: number) {\r\n    const drawControl = new DrawControl({\r\n      geometryType: undefined,\r\n      drawingLayerSource: this.olDrawingLayerSource,\r\n      drawingLayerStyle: new OlStyle.Style({}),\r\n      interactionStyle: createInteractionStyle(fillColor, strokeColor, strokeWidth),\r\n    });\r\n\r\n    return drawControl;\r\n  }\r\n\r\n  /**\r\n   * Called when the user selects a new geometry type\r\n   * @param geometryType the geometry type selected by the user\r\n   */\r\n  onGeometryTypeChange(geometryType: Type, feature, workspace: EditionWorkspace) {\r\n      this.drawControl.setGeometryType(geometryType);\r\n      this.toggleDrawControl(feature, workspace);\r\n    }\r\n\r\n  /**\r\n   * Activate the correct control\r\n   */\r\n  private toggleDrawControl(feature, workspace: EditionWorkspace) {\r\n    this.deactivateDrawControl();\r\n    this.activateDrawControl(feature, workspace);\r\n  }\r\n\r\n  /**\r\n   * Deactivate the active draw control\r\n   */\r\n  public deactivateDrawControl() {\r\n    if (!this.drawControl) {\r\n      return;\r\n    }\r\n\r\n    if (this.drawEnd$$) {\r\n      this.drawEnd$$.unsubscribe();\r\n    }\r\n\r\n    this.drawControl.setOlMap(undefined);\r\n  }\r\n\r\n  /**\r\n   * Activate a given control\r\n   */\r\n  private activateDrawControl(feature, workspace: EditionWorkspace) {\r\n    this.drawEnd$$ = this.drawControl.end$.subscribe((olGeometry: OlGeometry) => {\r\n      this.addFeatureToStore(feature, workspace, olGeometry);\r\n    });\r\n\r\n    this.drawControl.setOlMap(this.map.ol, true);\r\n  }\r\n\r\n  /**\r\n   * Add a feature to layer. The loading strategy of the layer\r\n   * will trigger and add the feature to the workspace store.\r\n   * @internal\r\n   */\r\n  private addFeatureToStore(feature, workspace: EditionWorkspace, olGeometry?: OlGeometry) {\r\n    const projection = this.map.ol.getView().getProjection();\r\n    let geometry = feature.geometry;\r\n\r\n    // If an olGeometry is passed, it means that it is a new feature\r\n    if (olGeometry) {\r\n      workspace.entityStore.insert(feature);\r\n      workspace.entityStore.state.update(feature, { newFeature: true }, true);\r\n      geometry = new OlGeoJSON().writeGeometryObject(olGeometry, {\r\n        featureProjection: projection,\r\n        dataProjection: 'EPSG:4326'\r\n      }) as any;\r\n\r\n      feature.geometry = geometry;\r\n    } else {\r\n      workspace.entityStore.state.update(feature, { edit: true }, true);\r\n    }\r\n\r\n    feature.projection = 'EPSG:4326';\r\n\r\n    const featureOl = featureToOl(feature, projection.getCode());\r\n\r\n    this.olDrawingLayer.dataSource.ol.clear();\r\n    this.olDrawingLayer.dataSource.ol.addFeature(featureOl);\r\n    this.map.addLayer(this.olDrawingLayer);\r\n\r\n    this.deactivateDrawControl();\r\n    this.createModifyInteraction(featureOl, feature, workspace);\r\n  }\r\n\r\n  /**\r\n   * Delete drawings layer and source from the map AND feature from the entity store.\r\n   * Layer refresh will automatically add the new feature into the store.\r\n   */\r\n  deleteDrawings() {\r\n    this.map.removeLayer(this.olDrawingLayer);\r\n    this.olDrawingLayerSource.clear();\r\n    this.map.ol.removeInteraction(this.modify);\r\n  }\r\n\r\n  /**\r\n   * Create a modify interaction to allow a geometry change one feature at the time (drag and drop)\r\n   */\r\n  createModifyInteraction(olFeature: OlFeature<OlGeometry>, feature, workspace: EditionWorkspace) {\r\n    this.map.ol.removeInteraction(this.modify);\r\n    const olCollection = new Collection([olFeature], { unique: true });\r\n    this.modify = new OlModify({\r\n      features: olCollection\r\n    });\r\n\r\n    this.map.ol.addInteraction(this.modify);\r\n    olCollection.forEach(feature => {\r\n      feature.setStyle(this.modifyStyle);\r\n    });\r\n\r\n    this.modify.on('modifyend', (event) => {\r\n      const olGeometry = event.features.getArray()[0]?.getGeometry();\r\n      if (olGeometry) {\r\n        this.addFeatureToStore(feature, workspace, olGeometry);\r\n      }\r\n    });\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient, HttpErrorResponse, HttpHeaders } from '@angular/common/http';\r\nimport { MatDialog } from '@angular/material/dialog';\r\n\r\nimport {\r\n  ActionStore,\r\n  EntityRecord,\r\n  EntityStoreFilterCustomFuncStrategy,\r\n  EntityStoreFilterSelectionStrategy,\r\n  EntityStoreStrategyFuncOptions,\r\n  EntityTableColumnRenderer,\r\n  EntityTableTemplate,\r\n  EntityTableButton} from '@igo2/common';\r\nimport { ConfigService, LanguageService, MessageService, StorageService } from '@igo2/core';\r\nimport { AuthInterceptor } from '@igo2/auth';\r\nimport { catchError, map, skipWhile, take } from 'rxjs/operators';\r\nimport { RelationOptions, SourceFieldsOptionsParams, WMSDataSource } from '../../datasource';\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { WFSDataSourceOptions } from '../../datasource/shared/datasources/wfs-datasource.interface';\r\nimport {\r\n  Feature,\r\n  FeatureMotion,\r\n  FeatureStore,\r\n  FeatureStoreInMapExtentStrategy,\r\n  FeatureStoreInMapResolutionStrategy,\r\n  FeatureStoreLoadingLayerStrategy,\r\n  FeatureStoreSelectionStrategy} from '../../feature';\r\n\r\nimport { OgcFilterableDataSourceOptions } from '../../filter/shared/ogc-filter.interface';\r\nimport { ImageLayer, LayerService, LayersLinkProperties, LinkedProperties, VectorLayer } from '../../layer';\r\nimport { StyleService } from '../../layer/shared/style.service';\r\nimport { GeoWorkspaceOptions } from '../../layer/shared/layers/layer.interface';\r\nimport { IgoMap } from '../../map';\r\nimport { QueryableDataSourceOptions } from '../../query/shared/query.interfaces';\r\nimport { EditionWorkspace } from './edition-workspace';\r\n\r\nimport olFeature from 'ol/Feature';\r\nimport olSourceImageWMS from 'ol/source/ImageWMS';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport { BehaviorSubject, Observable, throwError } from 'rxjs';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class EditionWorkspaceService {\r\n\r\n  public ws$ = new BehaviorSubject<string>(undefined);\r\n  public adding$ = new BehaviorSubject<boolean>(false);\r\n  public relationLayers$ = new BehaviorSubject<ImageLayer[] | VectorLayer[]>(undefined);\r\n  public rowsInMapExtentCheckCondition$ = new BehaviorSubject<boolean>(true);\r\n  public loading = false;\r\n\r\n  get zoomAuto(): boolean {\r\n    return this.storageService.get('zoomAuto') as boolean;\r\n  }\r\n\r\n  constructor(\r\n    private layerService: LayerService,\r\n    private storageService: StorageService,\r\n    private configService: ConfigService,\r\n    private messageService: MessageService,\r\n    private languageService: LanguageService,\r\n    private http: HttpClient,\r\n    private dialog: MatDialog,\r\n    private styleService: StyleService,\r\n    public authInterceptor?: AuthInterceptor) { }\r\n\r\n  createWorkspace(layer: ImageLayer, map: IgoMap): EditionWorkspace {\r\n    if (layer.options.workspace?.enabled !== true || layer.dataSource.options.edition.enabled !== true) {\r\n      return;\r\n    }\r\n    let wksConfig;\r\n    if (layer.options.workspace) {\r\n      wksConfig = layer.options.workspace;\r\n    } else {\r\n      wksConfig = {};\r\n    }\r\n    wksConfig.srcId = layer.id;\r\n    wksConfig.workspaceId = layer.id;\r\n    wksConfig.enabled = true;\r\n    wksConfig.pageSize = layer.options.workspace?.pageSize;\r\n    wksConfig.pageSizeOptions = layer.options.workspace?.pageSizeOptions;\r\n\r\n    const dataSource: WMSDataSource = layer.dataSource as WMSDataSource ;\r\n    const wmsLinkId = layer.id + '.WmsWorkspaceTableSrc';\r\n    const wfsLinkId = layer.id + '.WfsWorkspaceTableDest';\r\n    if (!layer.options.linkedLayers) {\r\n      layer.options.linkedLayers = { linkId: wmsLinkId, links: [] };\r\n    }\r\n    const linkProperties = {\r\n      syncedDelete: true,\r\n      linkedIds: [wfsLinkId],\r\n      properties: [\r\n        LinkedProperties.ZINDEX,\r\n        LinkedProperties.VISIBLE]\r\n    } as LayersLinkProperties;\r\n\r\n    if (!layer.options.workspace?.minResolution) {\r\n       linkProperties.properties.push(LinkedProperties.MINRESOLUTION);\r\n    }\r\n    let hasOgcFilters = false;\r\n    if ((dataSource.options as OgcFilterableDataSourceOptions).ogcFilters?.enabled) {\r\n      linkProperties.properties.push(LinkedProperties.OGCFILTERS);\r\n      hasOgcFilters = true;\r\n    }\r\n    if (!layer.options.workspace?.maxResolution) {\r\n      linkProperties.properties.push(LinkedProperties.MAXRESOLUTION);\r\n    }\r\n\r\n    let clonedLinks: LayersLinkProperties[] = [];\r\n    if (layer.options.linkedLayers.links) {\r\n      clonedLinks = JSON.parse(JSON.stringify(layer.options.linkedLayers.links));\r\n    }\r\n    clonedLinks.push(linkProperties);\r\n\r\n    layer.options.linkedLayers.linkId = layer.options.linkedLayers.linkId ? layer.options.linkedLayers.linkId : wmsLinkId,\r\n      layer.options.linkedLayers.links = clonedLinks;\r\n    interface WFSoptions extends WFSDataSourceOptions, OgcFilterableDataSourceOptions { }\r\n    let wks;\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        id: wfsLinkId,\r\n        linkedLayers: {\r\n          linkId: wfsLinkId\r\n        },\r\n        workspace: {\r\n          srcId: layer.id,\r\n          workspaceId: undefined,\r\n          enabled: false,\r\n          queryOptions: {\r\n            mapQueryOnOpenTab: layer.options.workspace?.queryOptions?.mapQueryOnOpenTab,\r\n            tabQuery: false\r\n          },\r\n          pageSize: layer.options.workspace?.pageSize,\r\n          pageSizeOptions: layer.options.workspace?.pageSizeOptions\r\n        },\r\n        showInLayerList: false,\r\n        opacity: 0,\r\n        title: layer.title,\r\n        minResolution: layer.options.workspace?.minResolution || layer.minResolution || 0,\r\n        maxResolution: layer.options.workspace?.maxResolution || layer.maxResolution || Infinity,\r\n        style: this.styleService.createStyle(\r\n          {\r\n            fill: {\r\n              \"color\": \"rgba(255, 255, 255, 0.01)\"\r\n            },\r\n            stroke: {\r\n              \"color\": \"rgba(255, 255, 255, 0.01)\"\r\n            },\r\n            circle: {\r\n              fill: {\r\n                color: \"rgba(255, 255, 255, 0.01)\"\r\n              },\r\n              stroke: {\r\n                color: \"rgba(255, 255, 255, 0.01)\"\r\n              },\r\n              radius: 5\r\n            }\r\n          }),\r\n          sourceOptions: {\r\n          download: dataSource.options.download,\r\n          type: 'wfs',\r\n          url: dataSource.options.urlWfs || dataSource.options.url,\r\n          queryable: true,\r\n          relations: dataSource.options.relations,\r\n          queryTitle: (dataSource.options as QueryableDataSourceOptions).queryTitle,\r\n          params: dataSource.options.paramsWFS,\r\n          ogcFilters: Object.assign({}, dataSource.ogcFilters, {enabled: hasOgcFilters}),\r\n          sourceFields: dataSource.options.sourceFields || undefined,\r\n          edition: dataSource.options.edition\r\n        } as WFSoptions\r\n      })\r\n      .subscribe((workspaceLayer: VectorLayer) => {\r\n        map.addLayer(workspaceLayer);\r\n        layer.ol.setProperties({ linkedLayers: { linkId: layer.options.linkedLayers.linkId, links: clonedLinks } }, false);\r\n        workspaceLayer.dataSource.ol.refresh();\r\n\r\n        wks = new EditionWorkspace({\r\n          id: layer.id,\r\n          title: layer.title,\r\n          layer: workspaceLayer,\r\n          map,\r\n          entityStore: this.createFeatureStore(workspaceLayer, map),\r\n          actionStore: new ActionStore([]),\r\n          meta: {\r\n            tableTemplate: undefined\r\n          }\r\n        }, this, this.dialog, this.configService);\r\n        this.createTableTemplate(wks, workspaceLayer);\r\n\r\n        workspaceLayer.options.workspace.workspaceId = workspaceLayer.id;\r\n        layer.options.workspace = Object.assign({}, layer.options.workspace,\r\n          {\r\n            wksConfig\r\n          } as GeoWorkspaceOptions);\r\n\r\n        delete dataSource.options.download;\r\n        return wks;\r\n\r\n      });\r\n\r\n    return wks;\r\n  }\r\n\r\n  private createFeatureStore(layer: VectorLayer, map: IgoMap): FeatureStore {\r\n    const store = new FeatureStore([], { map });\r\n    store.bindLayer(layer);\r\n\r\n    const loadingStrategy = new FeatureStoreLoadingLayerStrategy({});\r\n    const inMapExtentStrategy = new FeatureStoreInMapExtentStrategy({});\r\n    const inMapResolutionStrategy = new FeatureStoreInMapResolutionStrategy({});\r\n    const selectedRecordStrategy = new EntityStoreFilterSelectionStrategy({});\r\n    const selectionStrategy = new FeatureStoreSelectionStrategy({\r\n      layer: new VectorLayer({\r\n        zIndex: 300,\r\n        source: new FeatureDataSource(),\r\n        style: undefined,\r\n        showInLayerList: false,\r\n        exportable: false,\r\n        browsable: false\r\n      }),\r\n      map,\r\n      hitTolerance: 15,\r\n      motion: this.zoomAuto ? FeatureMotion.Default : FeatureMotion.None,\r\n      many: true,\r\n      dragBox: true\r\n    });\r\n    store.addStrategy(loadingStrategy, true);\r\n    store.addStrategy(inMapExtentStrategy, true);\r\n    store.addStrategy(inMapResolutionStrategy, true);\r\n    store.addStrategy(selectionStrategy, true);\r\n    store.addStrategy(selectedRecordStrategy, false);\r\n    store.addStrategy(this.createFilterInMapExtentOrResolutionStrategy(), true);\r\n    return store;\r\n  }\r\n\r\n  private createTableTemplate(workspace: EditionWorkspace, layer: VectorLayer): EntityTableTemplate {\r\n    const fields = layer.dataSource.options.sourceFields || [];\r\n\r\n    const relations = layer.dataSource.options.relations || [];\r\n\r\n    let rendererType = EntityTableColumnRenderer.UnsanitizedHTML;\r\n    let buttons = [];\r\n    let columns = [];\r\n    let relationsColumn = [];\r\n\r\n    buttons = [{\r\n      name: 'edition',\r\n      title: undefined,\r\n      renderer: EntityTableColumnRenderer.ButtonGroup,\r\n      primary: false,\r\n      valueAccessor: () => {\r\n        return [{\r\n          editMode: false,\r\n          icon: 'pencil',\r\n          color: 'primary',\r\n          disabled: layer.dataSource.options.edition.modifyButton === false ? true : false,\r\n          click: (feature) => { workspace.editFeature(feature, workspace); }\r\n        },\r\n        {\r\n          editMode: false,\r\n          icon: 'delete',\r\n          color: 'warn',\r\n          disabled: layer.dataSource.options.edition.deleteButton === false ? true : false,\r\n          click: (feature) => { workspace.deleteFeature(feature, workspace); }\r\n        },\r\n        {\r\n          editMode: true,\r\n          icon: 'check',\r\n          color: 'primary',\r\n          disabled: this.loading,\r\n          click: (feature) => { this.saveFeature(feature, workspace); }\r\n        },\r\n        {\r\n          editMode: true,\r\n          icon: 'alpha-x',\r\n          color: 'primary',\r\n          disabled: this.loading,\r\n          click: (feature) => { this.cancelEdit(workspace, feature); }\r\n        }] as EntityTableButton[];\r\n      }\r\n    }];\r\n\r\n\r\n    if (fields.length === 0) {\r\n      workspace.entityStore.entities$.pipe(\r\n        skipWhile(val => val.length === 0),\r\n        take(1)\r\n      ).subscribe(entities => {\r\n        const ol = (entities[0] as Feature).ol as olFeature<OlGeometry>;\r\n        const columnsFromFeatures = ol.getKeys()\r\n          .filter(\r\n            col => !col.startsWith('_') &&\r\n              col !== 'geometry' &&\r\n              col !== ol.getGeometryName() &&\r\n              !col.match(/boundedby/gi))\r\n          .map(key => {\r\n            return {\r\n              name: `properties.${key}`,\r\n              title: key,\r\n              renderer: rendererType,\r\n            };\r\n          });\r\n        workspace.meta.tableTemplate = {\r\n          selection: false,\r\n          sort: true,\r\n          columns: columnsFromFeatures\r\n        };\r\n      });\r\n      return;\r\n    }\r\n\r\n    columns = fields.map((field: SourceFieldsOptionsParams) => {\r\n\r\n      let column = {\r\n        name: `properties.${field.name}`,\r\n        title: field.alias ? field.alias : field.name,\r\n        renderer: rendererType,\r\n        valueAccessor: undefined,\r\n        cellClassFunc: () => {\r\n          const cellClass = {};\r\n          if (field.type) {\r\n            cellClass[`class_${field.type}`] = true;\r\n            return cellClass;\r\n          }\r\n        },\r\n        primary: field.primary === true ? true : false,\r\n        visible: field.visible,\r\n        validation: field.validation,\r\n        linkColumnForce: field.linkColumnForce,\r\n        type: field.type,\r\n        domainValues: undefined,\r\n        relation: undefined,\r\n        multiple: field.multiple,\r\n        step: field.step,\r\n        tooltip: field.tooltip\r\n      };\r\n\r\n      if (field.type === 'list' || field.type === 'autocomplete') {\r\n        this.getDomainValues(field.relation).subscribe(result => {\r\n          column.domainValues = result;\r\n          column.relation = field.relation;\r\n        });\r\n      }\r\n      return column;\r\n    });\r\n\r\n    relationsColumn = relations.map((relation: RelationOptions) => {\r\n      return {\r\n        name: `properties.${relation.name}`,\r\n        title: relation.alias ? relation.alias : relation.name,\r\n        renderer: EntityTableColumnRenderer.Icon,\r\n        icon: relation.icon,\r\n        parent: relation.parent,\r\n        type: 'relation',\r\n        tooltip: relation.tooltip,\r\n        onClick: () => {\r\n          if (this.adding$.getValue() === false) {\r\n            this.ws$.next(relation.title);\r\n          }\r\n        },\r\n        cellClassFunc: () => {\r\n          return { 'class_icon': true };\r\n        }\r\n      };\r\n    });\r\n\r\n    columns.push(...relationsColumn);\r\n    columns.push(...buttons);\r\n\r\n    workspace.meta.tableTemplate = {\r\n      selection: false,\r\n      sort: true,\r\n      columns\r\n    };\r\n  }\r\n\r\n  private createFilterInMapExtentOrResolutionStrategy(): EntityStoreFilterCustomFuncStrategy {\r\n    const filterClauseFunc = (record: EntityRecord<object>) => {\r\n      return record.state.inMapExtent === true && record.state.inMapResolution === true;\r\n    };\r\n    return new EntityStoreFilterCustomFuncStrategy({filterClauseFunc} as EntityStoreStrategyFuncOptions);\r\n  }\r\n\r\n  public saveFeature(feature, workspace: EditionWorkspace) {\r\n    if (!this.validateFeature(feature, workspace)){\r\n      return false;\r\n    }\r\n\r\n    this.sanitizeParameter(feature, workspace);\r\n\r\n    const baseUrl = workspace.layer.dataSource.options.edition.baseUrl;\r\n    let url = this.configService.getConfig('edition.url');\r\n\r\n    if (!url) {\r\n      url = baseUrl;\r\n    } else {\r\n      url += baseUrl ? baseUrl : '';\r\n    }\r\n\r\n    if (feature.newFeature) {\r\n      url += workspace.layer.dataSource.options.edition.addUrl;\r\n\r\n      const addHeaders = workspace.layer.dataSource.options.edition.addHeaders;\r\n      const headers = new HttpHeaders(addHeaders);\r\n\r\n      this.addFeature(feature, workspace, url, headers);\r\n    } else {\r\n      if (workspace.layer.dataSource.options.edition.modifyProtocol !== \"post\") {\r\n        url += '?' + workspace.layer.dataSource.options.edition.modifyUrl + feature.idkey;\r\n      }\r\n      else {\r\n        url += workspace.layer.dataSource.options.edition.modifyUrl;\r\n      }\r\n\r\n      const protocole = workspace.layer.dataSource.options.edition.modifyProtocol;\r\n      const modifyHeaders = workspace.layer.dataSource.options.edition.modifyHeaders;\r\n      const headers = new HttpHeaders(modifyHeaders);\r\n\r\n      this.modifyFeature(feature, workspace, url, headers, protocole);\r\n    }\r\n  }\r\n\r\n  public addFeature(feature, workspace: EditionWorkspace, url: string, headers: {[key: string]: any}) {\r\n    // TODO: adapt to any kind of geometry\r\n    if (workspace.layer.dataSource.options.edition.hasGeometry) {\r\n      //feature.properties[geom] = feature.geometry;\r\n      feature.properties[\"longitude\"] = feature.geometry.coordinates[0];\r\n      feature.properties[\"latitude\"] = feature.geometry.coordinates[1];\r\n    }\r\n\r\n    for (const property in feature.properties) {\r\n      for (const sf of workspace.layer.dataSource.options.sourceFields) {\r\n        if ((sf.name === property && sf.validation?.readonly) || (sf.name === property && sf.validation?.send === false)) {\r\n          delete feature.properties[property];\r\n        }\r\n      }\r\n    }\r\n\r\n    this.loading = true;\r\n    this.http.post(`${url}`, feature.properties, { headers: headers }).subscribe(\r\n      () => {\r\n        this.loading = false;\r\n        workspace.entityStore.stateView.clear();\r\n        workspace.deleteDrawings();\r\n        workspace.entityStore.delete(feature);\r\n\r\n        const message = this.languageService.translate.instant(\r\n          'igo.geo.workspace.addSuccess'\r\n        );\r\n        this.messageService.success(message);\r\n\r\n        this.refreshMap(workspace.layer as VectorLayer, workspace.layer.map);\r\n        this.adding$.next(false);\r\n        this.rowsInMapExtentCheckCondition$.next(true);\r\n      },\r\n      error => {\r\n        this.loading = false;\r\n        error.error.caught = true;\r\n        const genericErrorMessage = this.languageService.translate.instant(\r\n          'igo.geo.workspace.addError'\r\n        );\r\n        const messages = workspace.layer.dataSource.options.edition.messages;\r\n        if (messages) {\r\n          let text;\r\n          messages.forEach(message => {\r\n            const key = Object.keys(message)[0];\r\n            if (error.error.message.includes(key)) {\r\n              text = message[key];\r\n              this.messageService.error(text);\r\n            }\r\n          });\r\n          if (!text) {\r\n            this.messageService.error(genericErrorMessage);\r\n          }\r\n        } else {\r\n          this.messageService.error(genericErrorMessage);\r\n        }\r\n      }\r\n    );\r\n  }\r\n\r\n  public deleteFeature(workspace: EditionWorkspace, url: string) {\r\n    this.loading = true;\r\n    this.http.delete(`${url}`, {}).subscribe(\r\n      () => {\r\n        this.loading = false;\r\n        const message = this.languageService.translate.instant(\r\n          'igo.geo.workspace.deleteSuccess'\r\n        );\r\n        this.messageService.success(message);\r\n\r\n        this.refreshMap(workspace.layer as VectorLayer, workspace.layer.map);\r\n        for (const relation of workspace.layer.options.sourceOptions.relations) {\r\n          workspace.map.layers.forEach((layer) => {\r\n            if (layer.title === relation.title) {\r\n              layer.dataSource.ol.refresh();\r\n            }\r\n          });\r\n        }\r\n      },\r\n      error => {\r\n        this.loading = false;\r\n        error.error.caught = true;\r\n          const genericErrorMessage = this.languageService.translate.instant(\r\n            'igo.geo.workspace.addError'\r\n          );\r\n          const messages = workspace.layer.dataSource.options.edition.messages;\r\n          if (messages) {\r\n            let text;\r\n            messages.forEach(message => {\r\n              const key = Object.keys(message)[0];\r\n              if (error.error.message.includes(key)) {\r\n                text = message[key];\r\n                this.messageService.error(text);\r\n              }\r\n            });\r\n            if (!text) {\r\n              this.messageService.error(genericErrorMessage);\r\n            }\r\n          } else {\r\n            this.messageService.error(genericErrorMessage);\r\n          }\r\n      }\r\n    );\r\n  }\r\n\r\n  public modifyFeature(feature, workspace: EditionWorkspace, url: string, headers: {[key: string]: any}, protocole = 'patch' ) {\r\n    //TODO: adapt to any kind of geometry\r\n    if (workspace.layer.dataSource.options.edition.hasGeometry) {\r\n      //feature.properties[geom] = feature.geometry;\r\n      feature.properties[\"longitude\"] = feature.geometry.coordinates[0];\r\n      feature.properties[\"latitude\"] = feature.geometry.coordinates[1];\r\n    }\r\n\r\n    for (const property in feature.properties) {\r\n      for (const sf of workspace.layer.dataSource.options.sourceFields) {\r\n        if ((sf.name === property && sf.validation?.readonly) || (sf.name === property && sf.validation?.send === false)\r\n          || property === 'boundedBy') {\r\n          delete feature.properties[property];\r\n        }\r\n      }\r\n    }\r\n\r\n    this.loading = true;\r\n    this.http[protocole](`${url}`, feature.properties, { headers: headers }).subscribe(\r\n      () => {\r\n        this.loading = false;\r\n        this.cancelEdit(workspace, feature, true);\r\n\r\n        const message = this.languageService.translate.instant(\r\n          'igo.geo.workspace.modifySuccess'\r\n        );\r\n        this.messageService.success(message);\r\n\r\n        this.refreshMap(workspace.layer as VectorLayer, workspace.layer.map);\r\n\r\n        let relationLayers = [];\r\n        for (const relation of workspace.layer.options.sourceOptions.relations) {\r\n          workspace.map.layers.forEach((layer) => {\r\n            if (layer.title === relation.title) {\r\n              relationLayers.push(layer);\r\n              layer.dataSource.ol.refresh();\r\n            }\r\n          });\r\n        }\r\n        this.relationLayers$.next(relationLayers);\r\n      },\r\n      error => {\r\n        this.loading = false;\r\n        error.error.caught = true;\r\n        const genericErrorMessage = this.languageService.translate.instant(\r\n          'igo.geo.workspace.addError'\r\n        );\r\n        const messages = workspace.layer.dataSource.options.edition.messages;\r\n        if (messages) {\r\n          let text;\r\n          messages.forEach(message => {\r\n            const key = Object.keys(message)[0];\r\n            if (error.error.message.includes(key)) {\r\n              text = message[key];\r\n              this.messageService.error(text);\r\n            }\r\n          });\r\n          if (!text) {\r\n            this.messageService.error(genericErrorMessage);\r\n          }\r\n        } else {\r\n          this.messageService.error(genericErrorMessage);\r\n        }\r\n      }\r\n    );\r\n  }\r\n\r\n  cancelEdit(workspace: EditionWorkspace, feature, fromSave = false) {\r\n    feature.edition = false;\r\n    this.adding$.next(false);\r\n    workspace.deleteDrawings();\r\n    workspace.entityStore.stateView.clear();\r\n\r\n    if (feature.newFeature) {\r\n      workspace.entityStore.delete(feature);\r\n      workspace.deactivateDrawControl();\r\n\r\n      this.rowsInMapExtentCheckCondition$.next(true);\r\n    } else {\r\n      if (!fromSave) {\r\n        feature.properties = feature.original_properties;\r\n        feature.geometry = feature.original_geometry;\r\n      }\r\n      delete feature.original_properties;\r\n      delete feature.original_geometry;\r\n    }\r\n  }\r\n\r\n  getDomainValues(relation: RelationOptions): Observable<any> {\r\n    let url = relation.url;\r\n    if (!url) {\r\n      url = this.configService.getConfig('edition.url') ?\r\n        this.configService.getConfig('edition.url') + relation.table : relation.table;\r\n    }\r\n\r\n    return this.http.get<any>(url).pipe(\r\n      map(result => {\r\n        return result;\r\n      }),\r\n      catchError((err: HttpErrorResponse) => {\r\n        err.error.caught = true;\r\n        return throwError(err);\r\n      })\r\n    );\r\n  }\r\n\r\n  /*\r\n   * Refresh both wms and wfs layer\r\n   * A new wfs loader is used to ensure cache is not retrieving old data\r\n   * WMS params are updated to ensure layer is correctly refreshed\r\n   */\r\n  refreshMap(layer: VectorLayer, map: IgoMap) {\r\n    const wfsOlLayer = layer.dataSource.ol;\r\n    const loader = (extent, resolution, proj, success, failure) => {\r\n      layer.customWFSLoader(\r\n        layer.ol.getSource(),\r\n        layer.options.sourceOptions,\r\n        this.authInterceptor,\r\n        extent,\r\n        resolution,\r\n        proj,\r\n        success,\r\n        failure,\r\n        true\r\n      );\r\n    };\r\n    wfsOlLayer.setLoader(loader);\r\n    wfsOlLayer.refresh();\r\n\r\n    for (const lay of map.layers) {\r\n      if (\r\n        lay.id !== layer.id &&\r\n        lay.options.linkedLayers?.linkId.includes(layer.id.substr(0, layer.id.indexOf('.') - 1)) &&\r\n        lay.options.linkedLayers?.linkId.includes('WmsWorkspaceTableSrc')\r\n      )\r\n        {\r\n          const wmsOlLayer = lay.dataSource.ol as olSourceImageWMS;\r\n          let params = wmsOlLayer.getParams();\r\n          params._t = new Date().getTime();\r\n          wmsOlLayer.updateParams(params);\r\n        }\r\n    }\r\n  }\r\n\r\n  validateFeature(feature, workspace: EditionWorkspace) {\r\n    const translate = this.languageService.translate;\r\n    let message ;\r\n    let key;\r\n    let valid = true;\r\n    workspace.meta.tableTemplate.columns.forEach(column => {\r\n      if (column.hasOwnProperty('validation') && column.validation) {\r\n        key = getColumnKeyWithoutPropertiesTag(column.name);\r\n        Object.keys( column.validation).forEach((type) => {\r\n          switch (type) {\r\n            case 'mandatory': {\r\n              if (column.validation[type] && (!feature.properties.hasOwnProperty(key) || !feature.properties[key])) {\r\n                valid = false;\r\n                  message = translate.instant('igo.geo.formValidation.mandatory',\r\n                  {\r\n                    column: column.title\r\n                  }\r\n                );\r\n                this.messageService.error(message);\r\n              }\r\n              break;\r\n            }\r\n            case 'minValue': {\r\n              if (feature.properties.hasOwnProperty(key) && feature.properties[key] && feature.properties[key] < column.validation[type]) {\r\n                valid = false;\r\n                message = translate.instant('igo.geo.formValidation.minValue',\r\n                  {\r\n                    column: column.title,\r\n                    value: column.validation[type]\r\n                  }\r\n                );\r\n                this.messageService.error(message);\r\n              }\r\n              break;\r\n            }\r\n            case 'maxValue': {\r\n              if (feature.properties.hasOwnProperty(key) && feature.properties[key] && feature.properties[key] > column.validation[type]) {\r\n                valid = false;\r\n                message = translate.instant('igo.geo.formValidation.maxValue',\r\n                  {\r\n                    column: column.title,\r\n                    value: column.validation[type]\r\n                  }\r\n                );\r\n                this.messageService.error(message);\r\n              }\r\n              break;\r\n            }\r\n            case 'minLength': {\r\n              if (\r\n                feature.properties.hasOwnProperty(key) && feature.properties[key] &&\r\n                feature.properties[key].length < column.validation[type])\r\n              {\r\n                valid = false;\r\n                message = translate.instant('igo.geo.formValidation.minLength',\r\n                  {\r\n                    column: column.title,\r\n                    value: column.validation[type]\r\n                  }\r\n                );\r\n                this.messageService.error(message);\r\n              }\r\n              break;\r\n            }\r\n            case 'maxLength': {\r\n              if (\r\n                feature.properties.hasOwnProperty(key) && feature.properties[key] &&\r\n                feature.properties[key].length > column.validation[type])\r\n              {\r\n                valid = false;\r\n                message = translate.instant('igo.geo.formValidation.maxLength',\r\n                  {\r\n                    column: column.title,\r\n                    value: column.validation[type]\r\n                  }\r\n                );\r\n                this.messageService.error(message);\r\n              }\r\n              break;\r\n            }\r\n            }\r\n          });\r\n      }\r\n    });\r\n    return valid;\r\n  }\r\n\r\n  sanitizeParameter(feature, workspace: EditionWorkspace) {\r\n    workspace.meta.tableTemplate.columns.forEach(column => {\r\n      if (column.type === 'list' && feature.properties[getColumnKeyWithoutPropertiesTag(column.name)]) {\r\n        feature.properties[getColumnKeyWithoutPropertiesTag(column.name)] =\r\n          feature.properties[getColumnKeyWithoutPropertiesTag(column.name)].toString();\r\n      }\r\n\r\n    });\r\n  }\r\n\r\n}\r\n\r\nfunction getColumnKeyWithoutPropertiesTag(column: string) {\r\n  if (column.includes('properties.')) {\r\n    return column.split('.')[1];\r\n  }\r\n  return column;\r\n}\r\n","import {\r\n  Workspace,\r\n  WorkspaceOptions\r\n} from '@igo2/common';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { VectorLayer } from '../../layer';\r\nimport { IgoMap } from '../../map';\r\n\r\nexport interface FeatureWorkspaceOptions extends WorkspaceOptions {\r\n  layer: VectorLayer;\r\n  map: IgoMap;\r\n}\r\n\r\nexport class FeatureWorkspace extends Workspace {\r\n\r\n  readonly inResolutionRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  get layer(): VectorLayer { return this.options.layer; }\r\n\r\n  get map(): IgoMap { return this.options.map; }\r\n\r\n  constructor(protected options: FeatureWorkspaceOptions) {\r\n    super(options);\r\n    this.map.viewController.resolution$.subscribe((mapResolution) => {\r\n      if (mapResolution > this.layer.minResolution && mapResolution < this.layer.maxResolution) {\r\n        this.inResolutionRange$.next(true);\r\n      } else {\r\n        this.inResolutionRange$.next(false);\r\n      }\r\n    });\r\n  }\r\n\r\n  public getLayerWksOptionTabQuery(): boolean {\r\n    if (this.layer.options.workspace.queryOptions?.tabQuery !== undefined) {\r\n      return this.layer.options.workspace.queryOptions.tabQuery;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  public getLayerWksOptionMapQuery(): boolean {\r\n    if (this.layer.options.workspace.queryOptions?.mapQueryOnOpenTab !== undefined) {\r\n      return this.layer.options.workspace.queryOptions.mapQueryOnOpenTab;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  private getInResolutionRange(): boolean {\r\n    return this.inResolutionRange$.value;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport {\r\n  ActionStore,\r\n  EntityTableTemplate,\r\n  EntityStoreFilterCustomFuncStrategy,\r\n  EntityRecord,\r\n  EntityStoreStrategyFuncOptions,\r\n  EntityStoreFilterSelectionStrategy,\r\n  EntityTableColumnRenderer\r\n} from '@igo2/common';\r\n\r\nimport {\r\n  FeatureStore,\r\n  FeatureStoreLoadingLayerStrategy,\r\n  FeatureStoreSelectionStrategy,\r\n  FeatureStoreInMapExtentStrategy,\r\n  Feature,\r\n  FeatureMotion,\r\n  FeatureStoreInMapResolutionStrategy\r\n} from '../../feature';\r\nimport { VectorLayer } from '../../layer';\r\nimport { GeoWorkspaceOptions } from '../../layer/shared/layers/layer.interface';\r\nimport { IgoMap } from '../../map';\r\nimport { SourceFieldsOptionsParams, FeatureDataSource, RelationOptions } from '../../datasource';\r\nimport { getCommonVectorSelectedStyle} from '../../utils';\r\n\r\nimport { FeatureWorkspace } from './feature-workspace';\r\nimport { skipWhile, take } from 'rxjs/operators';\r\nimport { ConfigService, StorageService } from '@igo2/core';\r\n\r\nimport olFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class FeatureWorkspaceService {\r\n\r\n  get zoomAuto(): boolean {\r\n    return this.storageService.get('zoomAuto') as boolean;\r\n  }\r\n\r\n  public ws$ = new BehaviorSubject<string>(undefined);\r\n\r\n  constructor(private storageService: StorageService, private configService: ConfigService) {}\r\n\r\n  createWorkspace(layer: VectorLayer, map: IgoMap): FeatureWorkspace {\r\n    if (layer.options.workspace?.enabled === false || layer.dataSource.options.edition) {\r\n      return;\r\n    }\r\n\r\n    layer.options.workspace = Object.assign({}, layer.options.workspace,\r\n      {\r\n        srcId: layer.id,\r\n        workspaceId: layer.id,\r\n        enabled: true\r\n      } as GeoWorkspaceOptions);\r\n\r\n\r\n    const wks = new FeatureWorkspace({\r\n      id: layer.id,\r\n      title: layer.title,\r\n      layer,\r\n      map,\r\n      entityStore: this.createFeatureStore(layer, map),\r\n      actionStore: new ActionStore([]),\r\n      meta: {\r\n        tableTemplate: undefined\r\n      }\r\n    });\r\n    this.createTableTemplate(wks, layer);\r\n    return wks;\r\n\r\n  }\r\n\r\n  private createFeatureStore(layer: VectorLayer, map: IgoMap): FeatureStore {\r\n    const store = new FeatureStore([], {map});\r\n    store.bindLayer(layer);\r\n\r\n    const loadingStrategy = new FeatureStoreLoadingLayerStrategy({});\r\n    const inMapExtentStrategy = new FeatureStoreInMapExtentStrategy({});\r\n    const inMapResolutionStrategy = new FeatureStoreInMapResolutionStrategy({});\r\n    const selectedRecordStrategy = new EntityStoreFilterSelectionStrategy({});\r\n    const confQueryOverlayStyle= this.configService.getConfig('queryOverlayStyle');\r\n\r\n    const selectionStrategy = new FeatureStoreSelectionStrategy({\r\n      layer: new VectorLayer({\r\n        zIndex: 300,\r\n        source: new FeatureDataSource(),\r\n        style: (feature) => {\r\n          return getCommonVectorSelectedStyle(Object.assign({}, {feature}, confQueryOverlayStyle.selection || {}));\r\n        },\r\n        showInLayerList: false,\r\n        exportable: false,\r\n        browsable: false\r\n      }),\r\n      map,\r\n      hitTolerance: 15,\r\n      motion: this.zoomAuto ? FeatureMotion.Default : FeatureMotion.None,\r\n      many: true,\r\n      dragBox: true\r\n    });\r\n    store.addStrategy(loadingStrategy, true);\r\n    store.addStrategy(inMapExtentStrategy, true);\r\n    store.addStrategy(inMapResolutionStrategy, true);\r\n    store.addStrategy(selectionStrategy, true);\r\n    store.addStrategy(selectedRecordStrategy, false);\r\n    store.addStrategy(this.createFilterInMapExtentOrResolutionStrategy(), true);\r\n    return store;\r\n  }\r\n\r\n  private createTableTemplate(workspace: FeatureWorkspace, layer: VectorLayer): EntityTableTemplate {\r\n    const fields = layer.dataSource.options.sourceFields || [];\r\n\r\n    const relations = layer.dataSource.options.relations || [];\r\n\r\n    if (fields.length === 0) {\r\n      workspace.entityStore.entities$.pipe(\r\n        skipWhile(val => val.length === 0),\r\n        take(1)\r\n      ).subscribe(entities => {\r\n        const ol = (entities[0] as Feature).ol as olFeature<OlGeometry>;\r\n        const columnsFromFeatures = ol.getKeys()\r\n        .filter(\r\n          col => !col.startsWith('_') &&\r\n          col !== 'geometry' &&\r\n          col !== ol.getGeometryName() &&\r\n          !col.match(/boundedby/gi))\r\n        .map(key => {\r\n          return {\r\n            name: `properties.${key}`,\r\n            title: key,\r\n            renderer: EntityTableColumnRenderer.UnsanitizedHTML\r\n          };\r\n        });\r\n        workspace.meta.tableTemplate = {\r\n          selection: true,\r\n          sort: true,\r\n          columns: columnsFromFeatures\r\n        };\r\n      });\r\n      return;\r\n    }\r\n    const columns = fields.map((field: SourceFieldsOptionsParams) => {\r\n      return {\r\n        name: `properties.${field.name}`,\r\n        title: field.alias ? field.alias : field.name,\r\n        renderer: EntityTableColumnRenderer.UnsanitizedHTML,\r\n        tooltip: field.tooltip\r\n      };\r\n    });\r\n\r\n    const relationsColumn = relations.map((relation: RelationOptions) => {\r\n      return {\r\n        name: `properties.${relation.name}`,\r\n        title: relation.alias ? relation.alias : relation.name,\r\n        renderer: EntityTableColumnRenderer.Icon,\r\n        icon: relation.icon,\r\n        parent: relation.parent,\r\n        type: 'relation',\r\n        tooltip: relation.tooltip,\r\n        onClick: () => {\r\n            this.ws$.next(relation.title);\r\n        },\r\n        cellClassFunc: () => {\r\n          return { 'class_icon': true };\r\n        }\r\n      };\r\n    });\r\n\r\n    columns.push(...relationsColumn);\r\n    workspace.meta.tableTemplate = {\r\n      selection: true,\r\n      sort: true,\r\n      columns\r\n    };\r\n  }\r\n\r\n  private createFilterInMapExtentOrResolutionStrategy(): EntityStoreFilterCustomFuncStrategy {\r\n    const filterClauseFunc = (record: EntityRecord<object>) => {\r\n      return record.state.inMapExtent === true && record.state.inMapResolution === true;\r\n    };\r\n    return new EntityStoreFilterCustomFuncStrategy({filterClauseFunc} as EntityStoreStrategyFuncOptions);\r\n  }\r\n}\r\n","import { Directive, Input, OnInit, OnDestroy, Output, EventEmitter } from '@angular/core';\r\n\r\nimport { Subscription } from 'rxjs';\r\nimport { debounceTime } from 'rxjs/operators';\r\n\r\nimport { Workspace, WorkspaceStore, WorkspaceSelectorComponent } from '@igo2/common';\r\n\r\nimport { Layer, ImageLayer, VectorLayer } from '../../layer';\r\nimport { IgoMap } from '../../map';\r\nimport { WFSDataSource, WMSDataSource, FeatureDataSource } from '../../datasource';\r\nimport { OgcFilterableDataSourceOptions } from '../../filter';\r\n\r\nimport { WfsWorkspaceService } from '../shared/wfs-workspace.service';\r\nimport { WmsWorkspaceService } from '../shared/wms-workspace.service';\r\nimport { EditionWorkspaceService } from '../shared/edition-workspace.service';\r\nimport { FeatureWorkspaceService } from '../shared/feature-workspace.service';\r\nimport { FeatureStoreInMapExtentStrategy } from '../../feature/shared/strategies/in-map-extent';\r\nimport { QueryableDataSourceOptions } from '../../query/shared/query.interfaces';\r\n\r\n@Directive({\r\n  selector: '[igoWorkspaceSelector]'\r\n})\r\nexport class WorkspaceSelectorDirective implements OnInit, OnDestroy {\r\n\r\n  private layers$$: Subscription;\r\n  private entities$$: Subscription[] = [];\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Output() changeWorkspace = new EventEmitter<string>();\r\n  @Output() disableSwitch = new EventEmitter<boolean>();\r\n  @Output() relationLayers = new EventEmitter<ImageLayer[] | VectorLayer[]>();\r\n  @Output() rowsInMapExtentCheckCondition = new EventEmitter<boolean>();\r\n\r\n  get workspaceStore(): WorkspaceStore {\r\n    return this.component.store;\r\n  }\r\n\r\n  constructor(\r\n    private component: WorkspaceSelectorComponent,\r\n    private wfsWorkspaceService: WfsWorkspaceService,\r\n    private wmsWorkspaceService: WmsWorkspaceService,\r\n    private editionWorkspaceService: EditionWorkspaceService,\r\n    private featureWorkspaceService: FeatureWorkspaceService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.layers$$ = this.map.layers$\r\n      .pipe(debounceTime(50))\r\n      .subscribe((layers: Layer[]) =>\r\n        this.onLayersChange(layers)\r\n      );\r\n\r\n    this.featureWorkspaceService.ws$.subscribe((ws) => { this.changeWorkspace.emit(ws); });\r\n    this.wmsWorkspaceService.ws$.subscribe((ws) => { this.changeWorkspace.emit(ws); });\r\n    this.wfsWorkspaceService.ws$.subscribe((ws) => { this.changeWorkspace.emit(ws); });\r\n    this.editionWorkspaceService.ws$.subscribe((ws) => { this.changeWorkspace.emit(ws); });\r\n    this.editionWorkspaceService.adding$.subscribe((adding) => { this.disableSwitch.emit(adding); });\r\n    this.editionWorkspaceService.relationLayers$.subscribe((layers) => { this.relationLayers.emit(layers); });\r\n    this.editionWorkspaceService.rowsInMapExtentCheckCondition$.subscribe((condition) => {\r\n      this.rowsInMapExtentCheckCondition.emit(condition);\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.layers$$.unsubscribe();\r\n    this.entities$$.map(entities => entities.unsubscribe());\r\n  }\r\n\r\n  private onLayersChange(layers: Layer[]) {\r\n    const editableLayers = layers.filter((layer: Layer) =>\r\n      this.layerIsEditable(layer)\r\n    );\r\n    const editableLayersIds = editableLayers.map((layer: Layer) => layer.id);\r\n\r\n    const workspacesToAdd = editableLayers\r\n      .map((layer: VectorLayer) => this.getOrCreateWorkspace(layer))\r\n      .filter((workspace: Workspace | undefined) => workspace !== undefined);\r\n\r\n    const workspacesToRemove = this.workspaceStore.all()\r\n      .filter((workspace: Workspace) => {\r\n        return editableLayersIds.indexOf(workspace.id) < 0;\r\n      });\r\n\r\n    if (workspacesToRemove.length > 0) {\r\n      workspacesToRemove.forEach((workspace: Workspace) => {\r\n        workspace.entityStore.deactivateStrategyOfType(FeatureStoreInMapExtentStrategy);\r\n        workspace.deactivate();\r\n      });\r\n      this.workspaceStore.state.updateMany(workspacesToRemove, {active: false, selected: false});\r\n      this.workspaceStore.deleteMany(workspacesToRemove);\r\n    }\r\n\r\n    if (workspacesToAdd.length > 0) {\r\n      this.workspaceStore.insertMany(workspacesToAdd);\r\n    }\r\n  }\r\n\r\n  private getOrCreateWorkspace(layer: VectorLayer | ImageLayer): Workspace | undefined {\r\n    const workspace = this.workspaceStore.get(layer.id);\r\n    if (workspace !== undefined) {\r\n      return;\r\n    }\r\n    if (layer.dataSource instanceof WFSDataSource && layer.dataSource.options.edition?.enabled !== true) {\r\n      const wfsWks = this.wfsWorkspaceService.createWorkspace(layer as VectorLayer, this.map);\r\n      return wfsWks;\r\n    } else if (layer.dataSource instanceof WMSDataSource && layer.dataSource.options.edition?.enabled !== true) {\r\n      if (!layer.dataSource.options.paramsWFS) { return; }\r\n      const wmsWks = this.wmsWorkspaceService.createWorkspace(layer as ImageLayer, this.map);\r\n      wmsWks?.inResolutionRange$.subscribe((inResolutionRange) => {\r\n        (layer.dataSource.options as QueryableDataSourceOptions).queryable = !inResolutionRange;\r\n        (wmsWks.layer.dataSource.options as QueryableDataSourceOptions).queryable = inResolutionRange;\r\n      });\r\n      return wmsWks;\r\n    } else if (\r\n        layer.dataSource instanceof FeatureDataSource &&\r\n        (layer as VectorLayer).exportable === true &&\r\n        layer.dataSource.options.edition?.enabled !== true) {\r\n      const featureWks = this.featureWorkspaceService.createWorkspace(layer as VectorLayer, this.map);\r\n      return featureWks;\r\n    } else if (layer.dataSource instanceof WMSDataSource && layer.dataSource.options.edition?.enabled === true) {\r\n      const editionWks = this.editionWorkspaceService.createWorkspace(layer as ImageLayer, this.map);\r\n      return editionWks;\r\n    }\r\n\r\n    return;\r\n  }\r\n\r\n  private layerIsEditable(layer: Layer): boolean {\r\n    const dataSource = layer.dataSource;\r\n    if (dataSource instanceof WFSDataSource) {\r\n      return true;\r\n    }\r\n    if (dataSource instanceof FeatureDataSource) {\r\n      return true;\r\n    }\r\n    if (dataSource instanceof WMSDataSource) {\r\n      const dataSourceOptions = (dataSource.options ||\r\n        {}) as OgcFilterableDataSourceOptions;\r\n      return (dataSourceOptions.ogcFilters?.enabled || dataSource.options.paramsWFS?.featureTypes !== undefined);\r\n    }\r\n\r\n    return false;\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { WorkspaceSelectorDirective } from './workspace-selector.directive';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule\r\n  ],\r\n  exports: [\r\n   WorkspaceSelectorDirective\r\n  ],\r\n  declarations: [\r\n    WorkspaceSelectorDirective\r\n  ]\r\n})\r\nexport class IgoWorkspaceSelectorModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { WorkspaceUpdatorDirective } from './workspace-updator.directive';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule\r\n  ],\r\n  exports: [\r\n   WorkspaceUpdatorDirective\r\n  ],\r\n  declarations: [\r\n    WorkspaceUpdatorDirective\r\n  ]\r\n})\r\nexport class IgoWorkspaceUpdatorModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatButtonToggleModule } from '@angular/material/button-toggle';\r\nimport { MatDialogModule } from '@angular/material/dialog';\r\n\r\nimport { ConfirmationPopupComponent } from './confirmation-popup.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatButtonModule,\r\n    MatDialogModule,\r\n    MatButtonToggleModule\r\n  ],\r\n  exports: [ConfirmationPopupComponent],\r\n  declarations: [ConfirmationPopupComponent]\r\n})\r\nexport class IgoConfirmationPopupModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatDialogModule } from '@angular/material/dialog';\r\nimport { IgoWidgetModule } from '@igo2/common';\r\n\r\nimport { provideOgcFilterWidget } from './widgets/widgets';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoOgcFilterModule } from './widgets/ogc-filter/ogc-filter.module';\r\nimport { IgoWorkspaceSelectorModule } from './workspace-selector/workspace-selector.module';\r\nimport { IgoWorkspaceUpdatorModule } from './workspace-updator/workspace-updator.module';\r\nimport { IgoConfirmationPopupModule } from './confirmation-popup/confirmation-popup.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoLanguageModule,\r\n    IgoWidgetModule,\r\n    IgoWorkspaceSelectorModule,\r\n    IgoWorkspaceUpdatorModule,\r\n    IgoOgcFilterModule,\r\n    MatDialogModule\r\n  ],\r\n  exports: [\r\n    IgoWorkspaceSelectorModule,\r\n    IgoWorkspaceUpdatorModule,\r\n    IgoOgcFilterModule,\r\n    IgoConfirmationPopupModule\r\n  ],\r\n  declarations: [],\r\n  providers: [\r\n    provideOgcFilterWidget()\r\n  ]\r\n})\r\nexport class IgoGeoWorkspaceModule {}\r\n","import { EntityStore } from '@igo2/common';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport { FeatureStore } from '../../feature/shared/store';\r\nimport { FeatureWithDirection, FeatureWithStep, FeatureWithStop, Stop } from './directions.interface';\r\n\r\n/**\r\n * The class is a specialized version of an EntityStore that stores\r\n * stops.\r\n */\r\nexport class StopsStore extends EntityStore<Stop> {\r\n\r\n    public storeInitialized$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n    public clearStops() {\r\n        this.storeInitialized$.next(false);\r\n        this.clear();\r\n    }\r\n\r\n}\r\n\r\nexport class StopsFeatureStore extends FeatureStore<FeatureWithStop> {\r\n\r\n}\r\nexport class RoutesFeatureStore extends FeatureStore<FeatureWithDirection> {\r\n\r\n}\r\nexport class StepFeatureStore extends FeatureStore<FeatureWithStep> {\r\n\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient, HttpParams } from '@angular/common/http';\r\nimport { Observable } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { Cacheable } from 'ts-cacheable';\r\n\r\nimport { uuid } from '@igo2/utils';\r\nimport { ConfigService } from '@igo2/core';\r\n\r\nimport { Direction, DirectionOptions } from '../shared/directions.interface';\r\nimport { DirectionsFormat, SourceDirectionsType } from '../shared/directions.enum';\r\n\r\nimport { DirectionsSource } from './directions-source';\r\nimport { DirectionsSourceOptions } from './directions-source.interface';\r\n\r\n@Injectable()\r\nexport class OsrmDirectionsSource extends DirectionsSource {\r\n  get enabled(): boolean {\r\n    return this.options.enabled !== false;\r\n  }\r\n  set enabled(value: boolean) {\r\n    this.options.enabled = value;\r\n  }\r\n  static _name = 'OSRM Qubec';\r\n  private directionsUrl =\r\n    'https://geoegl.msp.gouv.qc.ca/services/itineraire/route/v1/driving/';\r\n  private options: DirectionsSourceOptions;\r\n\r\n  constructor(private http: HttpClient, private config: ConfigService) {\r\n    super();\r\n    this.options = this.config.getConfig('directionsSources.osrm') || {};\r\n    this.directionsUrl = this.options.url || this.directionsUrl;\r\n  }\r\n\r\n  getName(): string {\r\n    return OsrmDirectionsSource._name;\r\n  }\r\n\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  route(coordinates: [number, number][], directionsOptions: DirectionOptions = {}): Observable<Direction[]> {\r\n    const directionsParams = this.getRouteParams(directionsOptions);\r\n    return this.http\r\n      .get<JSON[]>(this.directionsUrl + coordinates.join(';'), {\r\n        params: directionsParams\r\n      })\r\n      .pipe(map(res => this.extractRoutesData(res)));\r\n  }\r\n\r\n  private extractRoutesData(response): Direction[] {\r\n    const routeResponse = [];\r\n    response.routes.forEach(route => {\r\n      routeResponse.push(this.formatRoute(route, response.waypoints));\r\n    });\r\n    return routeResponse;\r\n  }\r\n\r\n  private getRouteParams(directionsOptions: DirectionOptions = {}): HttpParams {\r\n\r\n    directionsOptions.alternatives = directionsOptions.alternatives !== undefined ? directionsOptions.alternatives : true;\r\n    directionsOptions.steps = directionsOptions.steps !== undefined ? directionsOptions.steps : true;\r\n    directionsOptions.geometries = directionsOptions.geometries !== undefined ? directionsOptions.geometries : 'geojson';\r\n    directionsOptions.overview = directionsOptions.overview !== undefined ? directionsOptions.overview : false;\r\n    directionsOptions.continue_straight = directionsOptions.continue_straight !== undefined ? directionsOptions.continue_straight : false;\r\n\r\n    return new HttpParams({\r\n      fromObject: {\r\n        alternatives: directionsOptions.alternatives ? 'true' : 'false',\r\n        overview: directionsOptions.overview ? 'simplified' : 'full',\r\n        steps: directionsOptions.steps ? 'true' : 'false',\r\n        geometries: directionsOptions.geometries ? directionsOptions.geometries : 'geojson',\r\n        continue_straight: directionsOptions.continue_straight ? 'true' : 'false',\r\n      }\r\n    });\r\n  }\r\n\r\n  private formatRoute(roadNetworkRoute: any, waypoints: any): Direction {\r\n    const stepsUI = [];\r\n    roadNetworkRoute.legs.forEach(leg => {\r\n      leg.steps.forEach(step => {\r\n        stepsUI.push(step);\r\n      });\r\n    });\r\n    return {\r\n      id: uuid(),\r\n      title: roadNetworkRoute.legs[0].summary,\r\n      source: OsrmDirectionsSource._name,\r\n      sourceType: SourceDirectionsType.Route,\r\n      order: 1,\r\n      format: DirectionsFormat.GeoJSON,\r\n      icon: 'directions',\r\n      projection: 'EPSG:4326',\r\n      waypoints,\r\n      distance: roadNetworkRoute.distance,\r\n      duration: roadNetworkRoute.duration,\r\n      geometry: roadNetworkRoute.geometry,\r\n      legs: roadNetworkRoute.legs,\r\n      steps: stepsUI,\r\n      weight: roadNetworkRoute.weight,\r\n      weight_name: roadNetworkRoute.weight_name\r\n    };\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\n\r\nimport { DirectionsSource } from './directions-source';\r\nimport { OsrmDirectionsSource } from './osrm-directions-source';\r\n\r\nexport function osrmDirectionsSourcesFactory(\r\n  http: HttpClient,\r\n  config: ConfigService\r\n) {\r\n  return new OsrmDirectionsSource(http, config);\r\n}\r\n\r\nexport function provideOsrmDirectionsSource() {\r\n  return {\r\n    provide: DirectionsSource,\r\n    useFactory: osrmDirectionsSourcesFactory,\r\n    multi: true,\r\n    deps: [HttpClient, ConfigService]\r\n  };\r\n}\r\n","import { Injectable, Inject } from '@angular/core';\r\nimport { HttpClient, HttpParams } from '@angular/common/http';\r\n\r\nimport { Observable, of } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport olWKT from 'ol/format/WKT';\r\n\r\nimport { FEATURE, Feature, FeatureGeometry } from '../../../feature';\r\n\r\nimport { SearchResult } from '../search.interfaces';\r\nimport { SearchSource, TextSearch } from './source';\r\nimport { SearchSourceOptions, TextSearchOptions } from './source.interfaces';\r\n\r\nimport { LanguageService, StorageService } from '@igo2/core';\r\nimport { computeTermSimilarity } from '../search.utils';\r\nimport { Cacheable } from 'ts-cacheable';\r\nimport { GeoJsonGeometryTypes } from 'geojson';\r\n\r\n/**\r\n * Cadastre search source\r\n */\r\n@Injectable()\r\nexport class CadastreSearchSource extends SearchSource implements TextSearch {\r\n  static id = 'cadastre';\r\n  static type = FEATURE;\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private languageService: LanguageService,\r\n    storageService: StorageService,\r\n    @Inject('options') options: SearchSourceOptions\r\n  ) {\r\n    super(options, storageService);\r\n  }\r\n\r\n  getId(): string {\r\n    return CadastreSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return CadastreSearchSource.type;\r\n  }\r\n\r\n  /*\r\n   * Source : https://wiki.openstreetmap.org/wiki/Key:amenity\r\n   */\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    return {\r\n      title: 'Cadastre (Qubec)',\r\n      searchUrl: 'https://carto.cptaq.gouv.qc.ca/php/find_lot_v1.php?'\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a place by name\r\n   * @param term Place name\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  search(\r\n    term: string | undefined,\r\n    options?: TextSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    term = term.endsWith(',') ? term.slice(0, -1) : term;\r\n    term = term.startsWith(',') ? term.substr(1) : term;\r\n    term = term.replace(/ /g, '');\r\n\r\n    const params = this.computeSearchRequestParams(term, options || {});\r\n    if (!params.get('numero') || !params.get('numero').match(/^[0-9,]+$/g)) {\r\n      return of([]);\r\n    }\r\n    return this.http\r\n      .get(this.searchUrl, { params, responseType: 'text' })\r\n      .pipe(map((response: string) => this.extractResults(response, term)));\r\n  }\r\n\r\n  private computeSearchRequestParams(\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): HttpParams {\r\n    return new HttpParams({\r\n      fromObject: Object.assign(\r\n        {\r\n          numero: term,\r\n          epsg: '4326'\r\n        },\r\n        this.params,\r\n        options.params || {}\r\n      )\r\n    });\r\n  }\r\n\r\n  private extractResults(response: string, term: string): SearchResult<Feature>[] {\r\n    return response\r\n      .split('<br />')\r\n      .filter((lot: string) => lot.length > 0)\r\n      .map((lot: string) => this.dataToResult(lot, term));\r\n  }\r\n\r\n  private dataToResult(data: string, term: string): SearchResult<Feature> {\r\n    const lot = data.split(';');\r\n    const numero = lot[0];\r\n    const wkt = lot[7];\r\n    const geometry = this.computeGeometry(wkt);\r\n\r\n    const properties = {\r\n      NoLot: numero,\r\n      Route: '<span class=\"routing\"> <u>' + this.languageService.translate.instant('igo.geo.seeRouting') + '</u> </span>'\r\n    };\r\n    const id = [this.getId(), 'cadastre', numero].join('.');\r\n\r\n    return {\r\n      source: this,\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id,\r\n        title: numero,\r\n        score: computeTermSimilarity(term.trim(), numero),\r\n        icon: 'map-marker'\r\n      },\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry,\r\n        properties,\r\n        meta: {\r\n          id,\r\n          title: numero\r\n        }\r\n      }\r\n    };\r\n  }\r\n\r\n  private computeGeometry(wkt: string): FeatureGeometry {\r\n    const feature = new olWKT().readFeature(wkt, {\r\n      dataProjection: 'EPSG:4326',\r\n      featureProjection: 'EPSG:4326'\r\n    });\r\n    return {\r\n      type: feature.getGeometry().getType() as GeoJsonGeometryTypes,\r\n      coordinates: (feature.getGeometry() as any).getCoordinates()\r\n    };\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\n\r\nimport { ConfigService, LanguageService, StorageService } from '@igo2/core';\r\n\r\nimport { SearchSource } from './source';\r\nimport { CadastreSearchSource } from './cadastre';\r\n\r\n/**\r\n * Cadastre search source factory\r\n * @ignore\r\n */\r\nexport function cadastreSearchSourceFactory(\r\n  http: HttpClient,\r\n  languageService: LanguageService,\r\n  storageService: StorageService,\r\n  config: ConfigService\r\n) {\r\n  return new CadastreSearchSource(\r\n    http,\r\n    languageService,\r\n    storageService,\r\n    config.getConfig(`searchSources.${CadastreSearchSource.id}`),\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the Cadastre search source\r\n */\r\nexport function provideCadastreSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: cadastreSearchSourceFactory,\r\n    multi: true,\r\n    deps: [HttpClient, LanguageService, StorageService, ConfigService]\r\n  };\r\n}\r\n","import { Injectable, Inject } from '@angular/core';\r\nimport { HttpClient, HttpParams } from '@angular/common/http';\r\n\r\nimport { Observable, of } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { FEATURE, Feature, FeatureGeometry } from '../../../feature';\r\n\r\nimport { StorageService } from '@igo2/core';\r\nimport { SearchResult } from '../search.interfaces';\r\nimport { SearchSource, TextSearch } from './source';\r\nimport { SearchSourceOptions, TextSearchOptions } from './source.interfaces';\r\nimport { NominatimData } from './nominatim.interfaces';\r\nimport { computeTermSimilarity } from '../search.utils';\r\nimport { Cacheable } from 'ts-cacheable';\r\n\r\n/**\r\n * Nominatim search source\r\n */\r\n@Injectable()\r\nexport class NominatimSearchSource extends SearchSource implements TextSearch {\r\n  static id = 'nominatim';\r\n  static type = FEATURE;\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    @Inject('options') options: SearchSourceOptions,\r\n    storageService: StorageService\r\n  ) {\r\n    super(options, storageService);\r\n  }\r\n\r\n  getId(): string {\r\n    return NominatimSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return NominatimSearchSource.type;\r\n  }\r\n\r\n  /*\r\n   * Source : https://wiki.openstreetmap.org/wiki/Key:amenity\r\n   */\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    return {\r\n      title: 'Nominatim (OSM)',\r\n      searchUrl: 'https://nominatim.openstreetmap.org/search',\r\n      settings: [\r\n        {\r\n          type: 'checkbox',\r\n          title: 'results type',\r\n          name: 'amenity',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.nominatim.type.food',\r\n              value:\r\n                'bar,bbq,biergaten,cafe,drinking_water,fast_food,food_court,ice_cream,pub,restaurant',\r\n              enabled: false\r\n            },\r\n            {\r\n              title: 'igo.geo.search.nominatim.type.health',\r\n              value:\r\n                'baby_hatch,clinic,dentist,doctors,hospital,nursing_home,pharmacy,social_facility,veterinary',\r\n              enabled: false\r\n            },\r\n            {\r\n              title: 'igo.geo.search.nominatim.type.entertainment',\r\n              value:\r\n                'arts_centre,brothel,casino,cinema,community_center_fountain,gambling,nightclub,planetarium \\\r\n                          ,public_bookcase,social_centre,stripclub,studio,swingerclub,theatre,internet_cafe',\r\n              enabled: false\r\n            },\r\n            {\r\n              title: 'igo.geo.search.nominatim.type.finance',\r\n              value: 'atm,bank,bureau_de_change',\r\n              enabled: false\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'results limit',\r\n          name: 'limit',\r\n          values: [\r\n            {\r\n              title: '10',\r\n              value: 10,\r\n              enabled: true\r\n            },\r\n            {\r\n              title: '20',\r\n              value: 20,\r\n              enabled: false\r\n            },\r\n            {\r\n              title: '50',\r\n              value: 50,\r\n              enabled: false\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'restrictExtent',\r\n          name: 'countrycodes',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.nominatim.country.canada',\r\n              value: 'CA',\r\n              enabled: true\r\n            },\r\n            {\r\n              title: 'igo.geo.search.nominatim.country.all',\r\n              value: null,\r\n              enabled: false\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'multiple object',\r\n          name: 'dedupe',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.searchSources.settings.true',\r\n              value: 0,\r\n              enabled: false\r\n            },\r\n            {\r\n              title: 'igo.geo.search.searchSources.settings.false',\r\n              value: 1,\r\n              enabled: true\r\n            }\r\n          ]\r\n        }\r\n      ]\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a place by name\r\n   * @param term Place name\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  search(\r\n    term: string | undefined,\r\n    options?: TextSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    const params = this.computeSearchRequestParams(term, options || {});\r\n    if (!params.get('q')) {\r\n      return of([]);\r\n    }\r\n    return this.http\r\n      .get(this.searchUrl, { params })\r\n      .pipe(map((response: NominatimData[]) => this.extractResults(response, term)));\r\n  }\r\n\r\n  private computeSearchRequestParams(\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): HttpParams {\r\n    return new HttpParams({\r\n      fromObject: Object.assign(\r\n        {\r\n          q: this.computeTerm(term),\r\n          format: 'json'\r\n        },\r\n        this.params,\r\n        options.params || {}\r\n      )\r\n    });\r\n  }\r\n\r\n  private extractResults(response: NominatimData[], term: string): SearchResult<Feature>[] {\r\n    return response.map((data: NominatimData) => this.dataToResult(data, term));\r\n  }\r\n\r\n  private dataToResult(data: NominatimData, term: string): SearchResult<Feature> {\r\n    const properties = this.computeProperties(data);\r\n    const geometry = this.computeGeometry(data);\r\n    const extent = this.computeExtent(data);\r\n    const id = [this.getId(), 'place', data.place_id].join('.');\r\n\r\n    return {\r\n      source: this,\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id,\r\n        title: data.display_name,\r\n        icon: 'map-marker',\r\n        score: computeTermSimilarity(term.trim(), data.display_name)\r\n      },\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry,\r\n        extent,\r\n        properties,\r\n        meta: {\r\n          id,\r\n          title: data.display_name\r\n        }\r\n      }\r\n    };\r\n  }\r\n\r\n  private computeProperties(data: NominatimData): { [key: string]: any } {\r\n    return {\r\n      display_name: data.display_name,\r\n      place_id: data.place_id,\r\n      osm_type: data.osm_type,\r\n      class: data.class,\r\n      type: data.type\r\n    };\r\n  }\r\n\r\n  private computeGeometry(data: NominatimData): FeatureGeometry {\r\n    return {\r\n      type: 'Point',\r\n      coordinates: [parseFloat(data.lon), parseFloat(data.lat)]\r\n    };\r\n  }\r\n\r\n  private computeExtent(data: NominatimData): [number, number, number, number] {\r\n    return [\r\n      parseFloat(data.boundingbox[2]),\r\n      parseFloat(data.boundingbox[0]),\r\n      parseFloat(data.boundingbox[3]),\r\n      parseFloat(data.boundingbox[1])\r\n    ];\r\n  }\r\n\r\n  private computeTerm(term: string): string {\r\n    return this.computeTermTags(term);\r\n  }\r\n\r\n  /**\r\n   * Add hashtag from query in Nominatim's format (+[])\r\n   * @param term Query with hashtag\r\n   */\r\n  private computeTermTags(term: string): string {\r\n    const hashtags = super.getHashtagsValid(term, 'amenity');\r\n    if (!hashtags) {\r\n      return this.computeTermSettings(term);\r\n    }\r\n\r\n    if (!hashtags.length) {\r\n      return null;\r\n    }\r\n\r\n    term = term.replace(/(#[^\\s]*)/g, '');\r\n    hashtags.forEach(tag => {\r\n      term += '+[' + tag + ']';\r\n    });\r\n\r\n    return term;\r\n  }\r\n\r\n  /**\r\n   * Add hashtag from settings in Nominatim's format (+[])\r\n   * @param term Query\r\n   */\r\n  private computeTermSettings(term: string): string {\r\n    this.options.settings.forEach(settings => {\r\n      if (settings.name === 'amenity') {\r\n        settings.values.forEach(conf => {\r\n          if (conf.enabled && typeof conf.value === 'string') {\r\n            const splitted = conf.value.split(',');\r\n            splitted.forEach(value => {\r\n              term += '+[' + value + ']';\r\n            });\r\n          }\r\n        });\r\n      }\r\n    });\r\n    return term;\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\n\r\nimport { ConfigService, StorageService } from '@igo2/core';\r\n\r\nimport { SearchSource } from './source';\r\nimport { NominatimSearchSource } from './nominatim';\r\n\r\n/**\r\n * Nominatim search source factory\r\n * @ignore\r\n */\r\nexport function nominatimSearchSourceFactory(\r\n  http: HttpClient,\r\n  config: ConfigService,\r\n  storageService: StorageService\r\n) {\r\n  return new NominatimSearchSource(\r\n    http,\r\n    config.getConfig(`searchSources.${NominatimSearchSource.id}`),\r\n    storageService\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the Nominatim search source\r\n */\r\nexport function provideNominatimSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: nominatimSearchSourceFactory,\r\n    multi: true,\r\n    deps: [HttpClient, ConfigService, StorageService]\r\n  };\r\n}\r\n","import { Injectable, Inject } from '@angular/core';\r\nimport { HttpClient, HttpParams } from '@angular/common/http';\r\n\r\nimport { Observable } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\nimport { FEATURE, Feature } from '../../../feature';\r\n\r\nimport { SearchResult } from '../search.interfaces';\r\nimport { SearchSource, TextSearch, ReverseSearch } from './source';\r\nimport {\r\n  SearchSourceOptions,\r\n  TextSearchOptions,\r\n  ReverseSearchOptions\r\n} from './source.interfaces';\r\nimport {\r\n  StoredQueriesData,\r\n  StoredQueriesResponse,\r\n  StoredQueriesReverseData,\r\n  StoredQueriesReverseResponse,\r\n  StoredQueriesSearchSourceOptions,\r\n  StoredQueriesFields,\r\n  StoredQueriesReverseSearchSourceOptions\r\n} from './storedqueries.interfaces';\r\n\r\nimport * as olformat from 'ol/format';\r\nimport { LanguageService, StorageService } from '@igo2/core';\r\nimport { computeTermSimilarity } from '../search.utils';\r\nimport { Cacheable } from 'ts-cacheable';\r\n\r\n/**\r\n * StoredQueries search source\r\n */\r\n@Injectable()\r\nexport class StoredQueriesSearchSource extends SearchSource\r\n  implements TextSearch {\r\n  static id = 'storedqueries';\r\n  static type = FEATURE;\r\n  static propertiesBlacklist: string[] = [\r\n    'boundedBy',\r\n    'id',\r\n    'coord_x',\r\n    'coord_y'\r\n  ];\r\n  public resultTitle: 'title';\r\n  public storedQueriesOptions: StoredQueriesSearchSourceOptions;\r\n  public multipleFieldsQuery: boolean;\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private languageService: LanguageService,\r\n    storageService: StorageService,\r\n    @Inject('options') options: SearchSourceOptions\r\n  ) {\r\n    super(options, storageService);\r\n    this.storedQueriesOptions = options as StoredQueriesSearchSourceOptions;\r\n    if (this.storedQueriesOptions && !this.storedQueriesOptions.available) {\r\n      return;\r\n    }\r\n\r\n    const defaultStoredqueryId = 'rtss';\r\n    const defaultFieldSplitter: StoredQueriesFields[] = [\r\n      { name: 'rtss', defaultValue: '-99' },\r\n      { name: 'chainage', defaultValue: '0', splitPrefix: '\\\\+' }\r\n    ];\r\n    const defaultOutputformat = 'text/xml; subtype=gml/3.1.1';\r\n    const defaultSrsname = 'EPSG:4326';\r\n    const defaultResultTitle = 'title';\r\n\r\n    if (!this.storedQueriesOptions) {\r\n      console.log(\r\n        ' No configuration for this search source (storedqueries). You will use the default values'\r\n      );\r\n      this.storedQueriesOptions = {\r\n        storedquery_id: defaultStoredqueryId,\r\n        fields: defaultFieldSplitter,\r\n        outputformat: defaultOutputformat,\r\n        srsname: defaultSrsname,\r\n        resultTitle: defaultResultTitle\r\n      };\r\n      this.resultTitle = defaultResultTitle;\r\n      console.log('Default values', this.storedQueriesOptions);\r\n    }\r\n\r\n    if (!this.storedQueriesOptions.storedquery_id) {\r\n      const err =\r\n        'Stored Queries :You have to set \"storedquery_id\" into StoredQueries options. ex: storedquery_id: \"nameofstoredquerie\"';\r\n      throw new Error(err);\r\n    }\r\n    if (!this.storedQueriesOptions.fields) {\r\n      throw new Error(\r\n        'Stored Queries :You have to set \"fields\" into options. ex: fields: {\"name\": \"rtss\", \"defaultValue\": \"-99\"}'\r\n      );\r\n    }\r\n\r\n    this.storedQueriesOptions.outputformat =\r\n      this.storedQueriesOptions.outputformat || 'text/xml; subtype=gml/3.1.1';\r\n    this.storedQueriesOptions.srsname =\r\n      this.storedQueriesOptions.srsname || 'EPSG:4326';\r\n\r\n    const storedQueryId = this.storedQueriesOptions.storedquery_id.toLowerCase();\r\n    if (\r\n      storedQueryId.includes('getfeaturebyid') &&\r\n      this.storedQueriesOptions.outputformat\r\n        .toLowerCase()\r\n        .includes('getfeaturebyid')\r\n    ) {\r\n      let err =\r\n        'You must set a geojson format for your stored query. This is due to an openlayers issue)';\r\n      err += ' (wfs 1.1.0 & gml 3.1.1 limitation)';\r\n      throw new Error(err);\r\n    }\r\n\r\n    if (!(this.storedQueriesOptions.fields instanceof Array)) {\r\n      this.storedQueriesOptions.fields = [this.storedQueriesOptions.fields];\r\n    }\r\n\r\n    this.multipleFieldsQuery =\r\n      this.storedQueriesOptions.fields.length > 1 ? true : false;\r\n\r\n    this.storedQueriesOptions.fields.forEach((field, index) => {\r\n      if (this.multipleFieldsQuery && !field.splitPrefix && index !== 0) {\r\n        throw new Error(\r\n          'Stored Queries :You must set a field spliter into your field definition (optional for the first one!)'\r\n        );\r\n      }\r\n      if (!field.defaultValue) {\r\n        throw new Error(\r\n          'Stored Queries :You must set a field default value into your field definition'\r\n        );\r\n      }\r\n    });\r\n\r\n    this.storedQueriesOptions.resultTitle =\r\n      this.storedQueriesOptions.resultTitle || this.resultTitle;\r\n  }\r\n\r\n  getId(): string {\r\n    return StoredQueriesSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return StoredQueriesSearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    return {\r\n      title: 'Stored Queries',\r\n      searchUrl: 'https://ws.mapserver.transports.gouv.qc.ca/swtq'\r\n    };\r\n  }\r\n\r\n  // URL CALL EXAMPLES:\r\n  //  GetFeatureById (mandatory storedquery for wfs server) (outputformat must be in geojson)\r\n /* eslint-disable max-len */\r\n  //  https://ws.mapserver.transports.gouv.qc.ca/swtq?service=wfs&version=2.0.0&request=GetFeature&storedquery_id=urn:ogc:def:query:OGC-WFS::GetFeatureById&srsname=epsg:4326&outputformat=geojson&ID=a_num_route.132\r\n  //  Custom StoredQuery\r\n /* eslint-disable max-len */\r\n  //  https://ws.mapserver.transports.gouv.qc.ca/swtq?service=wfs&version=1.1.0&request=GetFeature&storedquery_id=rtss&srsname=epsg:4326&outputformat=text/xml;%20subtype=gml/3.1.1&rtss=0013801110000c&chainage=12\r\n\r\n  /**\r\n   * Search a location by name or keyword\r\n   * @param term Location name or keyword\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  search(\r\n    term: string,\r\n    options?: TextSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    const storedqueriesParams = this.termSplitter(\r\n      term,\r\n      this.storedQueriesOptions.fields\r\n    );\r\n    const params = this.computeRequestParams(\r\n      options || {},\r\n      storedqueriesParams\r\n    );\r\n    this.options.params = this.options.params ? this.options.params : {};\r\n    this.options.params.page = options.page ? String(options.page) : '1';\r\n\r\n    if (\r\n      new RegExp('.*?gml.*?', 'i').test(this.storedQueriesOptions.outputformat)\r\n    ) {\r\n      return this.http\r\n        .get(this.searchUrl, { params, responseType: 'text' })\r\n        .pipe(\r\n          map(response => {\r\n            let resultArray = this.extractResults(this.extractWFSData(response), term);\r\n            resultArray.sort((a, b) =>\r\n              (a.meta.score > b.meta.score) ? 1 :\r\n              (a.meta.score === b.meta.score) ? ((a.meta.titleHtml < b.meta.titleHtml) ? 1 : -1) : -1);\r\n            resultArray.reverse();\r\n            if (resultArray.length > Number(this.options.params.limit)) {\r\n              const idxEnd = Number(this.options.params.limit) * Number(this.options.params.page);\r\n              const resultTotLenght = resultArray.length;\r\n              resultArray = resultArray.slice(0, idxEnd);\r\n              if (idxEnd < resultTotLenght) {\r\n                resultArray[resultArray.length - 1 ].meta.nextPage = true;\r\n              } else {\r\n                resultArray[resultArray.length - 1 ].meta.nextPage = false;\r\n              }\r\n            }\r\n            return resultArray;\r\n          })\r\n        );\r\n    } else {\r\n      return this.http.get(this.searchUrl, { params }).pipe(\r\n        map(response => {\r\n          return this.extractResults(this.extractWFSData(response), term);\r\n        })\r\n      );\r\n    }\r\n  }\r\n\r\n  private getFormatFromOptions() {\r\n    let olFormatCls;\r\n\r\n    const outputFormat = this.storedQueriesOptions.outputformat;\r\n    const patternGml3 = new RegExp('.*?gml.*?', 'i');\r\n    const patternGeojson = new RegExp('.*?json.*?', 'i');\r\n\r\n    if (patternGeojson.test(outputFormat)) {\r\n      olFormatCls = olformat.GeoJSON;\r\n    }\r\n    if (patternGml3.test(outputFormat)) {\r\n      olFormatCls = olformat.WFS;\r\n    }\r\n\r\n    return new olFormatCls();\r\n  }\r\n\r\n  private extractWFSData(res) {\r\n    const olFormat = this.getFormatFromOptions();\r\n    const geojson = olformat.GeoJSON;\r\n    const wfsfeatures = olFormat.readFeatures(res);\r\n    const features = JSON.parse(new geojson().writeFeatures(wfsfeatures));\r\n    return features;\r\n  }\r\n\r\n  private termSplitter(term: string, fields: StoredQueriesFields[]): {} {\r\n    const splittedTerm = {};\r\n    let remainingTerm = term;\r\n    let cnt = 0;\r\n\r\n    // Used to build the default values\r\n    fields.forEach(field => {\r\n      splittedTerm[field.name] = field.defaultValue;\r\n      const splitterRegex = new RegExp(field.splitPrefix + '(.+)', 'i');\r\n      if (splitterRegex.test(remainingTerm)) {\r\n        cnt = field.splitPrefix ? (cnt += 1) : cnt;\r\n        remainingTerm = remainingTerm.split(splitterRegex)[1];\r\n      }\r\n    });\r\n    if (cnt === 0) {\r\n      splittedTerm[fields[0].name] = term;\r\n      return splittedTerm;\r\n    }\r\n    remainingTerm = term;\r\n    const localFields = [...fields].reverse();\r\n    localFields.forEach(field => {\r\n      const splitterRegex = new RegExp(field.splitPrefix || '' + '(.+)', 'i');\r\n      if (remainingTerm || remainingTerm !== '') {\r\n        const values = remainingTerm.split(splitterRegex);\r\n        remainingTerm = values[0];\r\n        if (values[1]) {\r\n          splittedTerm[field.name] = values[1].trim();\r\n        }\r\n      }\r\n    });\r\n    return splittedTerm;\r\n  }\r\n\r\n  private computeRequestParams(\r\n    options: TextSearchOptions,\r\n    queryParams\r\n  ): HttpParams {\r\n    const wfsversion = this.storedQueriesOptions.storedquery_id\r\n      .toLowerCase()\r\n      .includes('getfeaturebyid')\r\n      ? '2.0.0'\r\n      : '1.1.0';\r\n    return new HttpParams({\r\n      fromObject: Object.assign(\r\n        {\r\n          service: 'wfs',\r\n          version: wfsversion,\r\n          request: 'GetFeature',\r\n          storedquery_id: this.storedQueriesOptions.storedquery_id,\r\n          srsname: this.storedQueriesOptions.srsname,\r\n          outputformat: this.storedQueriesOptions.outputformat\r\n        },\r\n        queryParams,\r\n        this.params,\r\n        options.params || {}\r\n      )\r\n    });\r\n  }\r\n\r\n  private extractResults(\r\n    response: StoredQueriesResponse, term: string\r\n  ): SearchResult<Feature>[] {\r\n    return response.features.map((data: StoredQueriesData) => {\r\n      return this.dataToResult(data, term);\r\n    });\r\n  }\r\n\r\n  private dataToResult(data: StoredQueriesData, term: string): SearchResult<Feature> {\r\n    const properties = this.computeProperties(data);\r\n    const id = [this.getId(), properties.type, data.id].join('.');\r\n    const title = data.properties[this.storedQueriesOptions.resultTitle]\r\n      ? this.storedQueriesOptions.resultTitle\r\n      : this.resultTitle;\r\n    return {\r\n      source: this,\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry: data.geometry,\r\n        // extent: data.bbox,\r\n        properties,\r\n        meta: {\r\n          id,\r\n          title: data.properties[title]\r\n        }\r\n      },\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id,\r\n        title: data.properties.title,\r\n        titleHtml: data.properties[title],\r\n        icon: 'map-marker',\r\n        score: (data.properties.title) ?\r\n        computeTermSimilarity(term.trim(), data.properties.title) :\r\n        computeTermSimilarity(term.trim(), data.properties[title]),\r\n\r\n      }\r\n    };\r\n  }\r\n\r\n  private computeProperties(data: StoredQueriesData): { [key: string]: any } {\r\n    const properties = Object.assign(\r\n      {},\r\n      ObjectUtils.removeKeys(\r\n        data.properties,\r\n        StoredQueriesSearchSource.propertiesBlacklist\r\n      ),\r\n      { Route: '<span class=\"routing\"> <u>' + this.languageService.translate.instant('igo.geo.seeRouting') + '</u> </span>' }\r\n    );\r\n    return properties;\r\n  }\r\n}\r\n\r\n/**\r\n * StoredQueriesReverse search source\r\n */\r\n\r\n// EXAMPLE CALLS\r\n /* eslint-disable max-len */\r\n// https://ws.mapserver.transports.gouv.qc.ca/swtq?service=wfs&version=1.1.0&request=GetFeature&storedquery_id=lim_adm&srsname=epsg:4326&outputformat=text/xml;%20subtype=gml/3.1.1&long=-71.292469&lat=46.748107\r\n//\r\n\r\n@Injectable()\r\nexport class StoredQueriesReverseSearchSource extends SearchSource\r\n  implements ReverseSearch {\r\n  static id = 'storedqueriesreverse';\r\n  static type = FEATURE;\r\n  static propertiesBlacklist: string[] = [];\r\n  public resultTitle: 'title';\r\n  public storedQueriesOptions: StoredQueriesReverseSearchSourceOptions;\r\n  public multipleFieldsQuery: boolean;\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private languageService: LanguageService,\r\n    storageService: StorageService,\r\n    @Inject('options') options: SearchSourceOptions\r\n  ) {\r\n    super(options, storageService);\r\n    this.storedQueriesOptions = options as StoredQueriesReverseSearchSourceOptions;\r\n\r\n    if (!this.storedQueriesOptions || (this.storedQueriesOptions && !this.storedQueriesOptions.available) ) {\r\n      return;\r\n    }\r\n\r\n    if (!this.storedQueriesOptions.storedquery_id) {\r\n      const err =\r\n        'Stored Queries :You have to set \"storedquery_id\" into StoredQueries options. ex: storedquery_id: \"nameofstoredquerie\"';\r\n      throw new Error(err);\r\n    }\r\n    if (!this.storedQueriesOptions.longField) {\r\n      throw new Error(\r\n        'Stored Queries :You have to set \"longField\" to map the longitude coordinate to the query params.'\r\n      );\r\n    }\r\n    if (!this.storedQueriesOptions.latField) {\r\n      throw new Error(\r\n        'Stored Queries :You have to set \"latField\" to map the latitude coordinate to the query params.'\r\n      );\r\n    }\r\n\r\n    this.storedQueriesOptions.outputformat =\r\n      this.storedQueriesOptions.outputformat || 'text/xml; subtype=gml/3.1.1';\r\n    this.storedQueriesOptions.srsname =\r\n      this.storedQueriesOptions.srsname || 'EPSG:4326';\r\n    this.storedQueriesOptions.resultTitle =\r\n      this.storedQueriesOptions.resultTitle || this.resultTitle;\r\n  }\r\n\r\n  getId(): string {\r\n    return StoredQueriesReverseSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return StoredQueriesReverseSearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    return {\r\n      title: 'Stored Queries (reverse)',\r\n      searchUrl: 'https://ws.mapserver.transports.gouv.qc.ca/swtq'\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a location by coordinates\r\n   * @param lonLat Location coordinates\r\n   * @param distance Search raidus around lonLat\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  reverseSearch(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    const params = this.computeRequestParams(lonLat, options || {});\r\n\r\n    if (\r\n      new RegExp('.*?gml.*?', 'i').test(this.storedQueriesOptions.outputformat)\r\n    ) {\r\n      return this.http\r\n        .get(this.searchUrl, { params, responseType: 'text' })\r\n        .pipe(\r\n          map(response => {\r\n            return this.extractResults(this.extractWFSData(response));\r\n          })\r\n        );\r\n    } else {\r\n      return this.http.get(this.searchUrl, { params }).pipe(\r\n        map(response => {\r\n          return this.extractResults(this.extractWFSData(response));\r\n        })\r\n      );\r\n    }\r\n  }\r\n\r\n  private getFormatFromOptions() {\r\n    let olFormatCls;\r\n\r\n    const outputFormat = this.storedQueriesOptions.outputformat;\r\n    const patternGml3 = new RegExp('.*?gml.*?', 'i');\r\n    const patternGeojson = new RegExp('.*?json.*?', 'i');\r\n\r\n    if (patternGeojson.test(outputFormat)) {\r\n      olFormatCls = olformat.GeoJSON;\r\n    }\r\n    if (patternGml3.test(outputFormat)) {\r\n      olFormatCls = olformat.WFS;\r\n    }\r\n\r\n    return new olFormatCls();\r\n  }\r\n\r\n  private extractWFSData(res) {\r\n    const olFormat = this.getFormatFromOptions();\r\n    const geojson = olformat.GeoJSON;\r\n    const wfsfeatures = olFormat.readFeatures(res);\r\n    const features = JSON.parse(new geojson().writeFeatures(wfsfeatures));\r\n    return features;\r\n  }\r\n\r\n  private computeRequestParams(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions\r\n  ): HttpParams {\r\n    const longLatParams = {};\r\n    longLatParams[this.storedQueriesOptions.longField] = lonLat[0];\r\n    longLatParams[this.storedQueriesOptions.latField] = lonLat[1];\r\n\r\n    return new HttpParams({\r\n      fromObject: Object.assign(\r\n        {\r\n          service: 'WFS',\r\n          version: '1.1.0',\r\n          request: 'GetFeature',\r\n          storedquery_id: this.storedQueriesOptions.storedquery_id,\r\n          srsname: this.storedQueriesOptions.srsname,\r\n          outputformat: this.storedQueriesOptions.outputformat\r\n        },\r\n        longLatParams,\r\n        this.params,\r\n        options.params || {}\r\n      )\r\n    });\r\n  }\r\n\r\n  private extractResults(\r\n    response: StoredQueriesReverseResponse\r\n  ): SearchResult<Feature>[] {\r\n    return response.features.map((data: StoredQueriesReverseData) => {\r\n      return this.dataToResult(data);\r\n    });\r\n  }\r\n\r\n  private dataToResult(data: StoredQueriesReverseData): SearchResult<Feature> {\r\n    const properties = this.computeProperties(data);\r\n    const id = [this.getId(), properties.type, data.id].join('.');\r\n    const title = data.properties[this.storedQueriesOptions.resultTitle]\r\n      ? this.storedQueriesOptions.resultTitle\r\n      : this.resultTitle;\r\n\r\n    return {\r\n      source: this,\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry: data.geometry,\r\n        properties,\r\n        meta: {\r\n          id,\r\n          title: data.properties[title]\r\n        }\r\n      },\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id,\r\n        title: data.properties[title],\r\n        icon: 'map-marker'\r\n      }\r\n    };\r\n  }\r\n\r\n  private computeProperties(\r\n    data: StoredQueriesReverseData\r\n  ): { [key: string]: any } {\r\n    const properties = ObjectUtils.removeKeys(\r\n      data.properties,\r\n      StoredQueriesReverseSearchSource.propertiesBlacklist\r\n    );\r\n    const routing = {\r\n      Route: '<span class=\"routing\"> <u>' + this.languageService.translate.instant('igo.geo.seeRouting') + '</u> </span>'\r\n    };\r\n    return Object.assign(properties, { type: data.properties.doc_type }, routing);\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\n\r\nimport { ConfigService, LanguageService, StorageService } from '@igo2/core';\r\n\r\nimport { SearchSource } from './source';\r\nimport {\r\n  StoredQueriesSearchSource,\r\n  StoredQueriesReverseSearchSource\r\n} from './storedqueries';\r\n\r\n/**\r\n * StoredQueries search source factory\r\n * @ignore\r\n */\r\nexport function storedqueriesSearchSourceFactory(\r\n  http: HttpClient,\r\n  languageService: LanguageService,\r\n  storageService: StorageService,\r\n  config: ConfigService\r\n) {\r\n  return new StoredQueriesSearchSource(\r\n    http,\r\n    languageService,\r\n    storageService,\r\n    config.getConfig(`searchSources.${StoredQueriesSearchSource.id}`)\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the StoredQueries search source\r\n */\r\nexport function provideStoredQueriesSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: storedqueriesSearchSourceFactory,\r\n    multi: true,\r\n    deps: [HttpClient, LanguageService, StorageService, ConfigService]\r\n  };\r\n}\r\n\r\n/**\r\n * StoredQueriesReverse search source factory\r\n * @ignore\r\n */\r\n\r\nexport function storedqueriesReverseSearchSourceFactory(\r\n  http: HttpClient,\r\n  languageService: LanguageService,\r\n  storageService: StorageService,\r\n  config: ConfigService\r\n) {\r\n  return new StoredQueriesReverseSearchSource(\r\n    http,\r\n    languageService,\r\n    storageService,\r\n    config.getConfig(`searchSources.${StoredQueriesReverseSearchSource.id}`)\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the StoredQueriesReverse search source\r\n */\r\nexport function provideStoredQueriesReverseSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: storedqueriesReverseSearchSourceFactory,\r\n    multi: true,\r\n    deps: [HttpClient, LanguageService, StorageService, ConfigService]\r\n  };\r\n}\r\n","import { WfsWorkspace } from './wfs-workspace';\r\nimport { FeatureWorkspace } from './feature-workspace';\r\nimport { EditionWorkspace } from './edition-workspace';\r\nimport { Observable } from 'rxjs';\r\nimport { EntityStoreFilterCustomFuncStrategy, EntityRecord } from '@igo2/common';\r\nimport { map } from 'rxjs/operators';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport { StorageScope } from '@igo2/core';\r\n\r\n\r\nexport function getRowsInMapExtent(layerId, storageService): boolean {\r\n  return storageService.get(`workspace.rowsInMapExtent.${layerId}`) as boolean || true;\r\n}\r\n\r\nexport function setRowsInMapExtent(value, layerId, storageService) {\r\n  storageService.set(`workspace.rowsInMapExtent.${layerId}`, value, StorageScope.SESSION);\r\n}\r\n\r\nexport function getSelectedOnly(layerId, storageService): boolean {\r\n  return storageService.get(`workspace.selectedOnly.${layerId}`) as boolean || false;\r\n}\r\n\r\nexport function setSelectedOnly(value, layerId, storageService) {\r\n  storageService.set(`workspace.selectedOnly.${layerId}`, value, StorageScope.SESSION);\r\n}\r\n\r\nexport function mapExtentStrategyActiveToolTip(ws: WfsWorkspace | FeatureWorkspace | EditionWorkspace): Observable<string> {\r\n  return ws.entityStore.getStrategyOfType(EntityStoreFilterCustomFuncStrategy).active$.pipe(\r\n    map((active: boolean) => active ? 'igo.geo.workspace.inMapExtent.active.tooltip' : 'igo.geo.workspace.inMapExtent.inactive.tooltip')\r\n  );\r\n}\r\n\r\nexport function noElementSelected(ws: WfsWorkspace | FeatureWorkspace | EditionWorkspace): Observable<boolean> {\r\n  return ws.entityStore.stateView.manyBy$((record: EntityRecord<Feature>) => {\r\n    return record.state.selected === true;\r\n  }).pipe(\r\n    map((entities: EntityRecord<Feature>[]) => entities.length >= 1)\r\n  );\r\n}\r\n\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Simple Map</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/simple-map\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\"\r\n  igoPointerPosition\r\n  [pointerPositionDelay]=\"pointerCoordDelay\"\r\n  (pointerPositionCoord)=\"onPointerMove($event)\">\r\n    <igo-info-section [infoContent]=\"pointerCoord\"></igo-info-section>\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n    <igo-geolocate-button [map]=\"map\" color=\"primary\"></igo-geolocate-button>\r\n    <igo-home-extent-button [map]=\"map\" color=\"primary\"></igo-home-extent-button>\r\n    <igo-rotation-button [map]=\"map\" [showIfNoRotation]=\"true\" color=\"primary\"></igo-rotation-button>\r\n    <igo-wake-lock-button [map]=\"map\" color=\"primary\"></igo-wake-lock-button>\r\n  </igo-map-browser>\r\n\r\n</mat-card>\r\n\r\n<p *ngIf=\"!isTouchScreen\">{{pointerCoord}}</p>","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppSimpleMapComponent } from './simple-map.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'simple-map',\r\n    component: AppSimpleMapComponent\r\n  }\r\n];\r\n\r\nexport const AppSimpleMapRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService, MediaService } from '@igo2/core';\r\nimport { IgoMap, DataSourceService, LayerService } from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-simple-map',\r\n  templateUrl: './simple-map.component.html',\r\n  styleUrls: ['./simple-map.component.scss']\r\n})\r\nexport class AppSimpleMapComponent {\r\n  public pointerCoord;\r\n  public pointerCoordDelay: number = 0;\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      },\r\n      scaleLine: true\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 6,\r\n    rotation: 0.75\r\n  };\r\n\r\n  get media() {\r\n    return this.mediaService.getMedia();\r\n  }\r\n\r\n  get isTouchScreen() {\r\n    return this.mediaService.isTouchScreen();\r\n  }\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService,\r\n    private mediaService: MediaService\r\n  ) {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n  }\r\n\r\n  onPointerMove(event) {\r\n    this.pointerCoord = event;\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMapModule } from '@igo2/geo';\r\n\r\nimport { AppSimpleMapComponent } from './simple-map.component';\r\nimport { AppSimpleMapRoutingModule } from './simple-map-routing.module';\r\nimport { CommonModule } from '@angular/common';\r\n\r\n@NgModule({\r\n  declarations: [AppSimpleMapComponent],\r\n  imports: [\r\n    CommonModule,\r\n    AppSimpleMapRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoMapModule\r\n  ],\r\n  exports: [AppSimpleMapComponent]\r\n})\r\nexport class AppSimpleMapModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Simple Map</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/layer\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Layers\">\r\n    <igo-layer-list\r\n    [map]=\"map\"\r\n    [layers]=\"map.layers\"\r\n    [expandLegendOfVisibleLayers]=\"false\"\r\n    floatLabel=\"never\"\r\n    [queryBadge]=\"true\">\r\n\r\n      <ng-template #igoLayerItemToolbar let-layer=\"layer\">\r\n        <igo-metadata-button [layer]=\"layer\"></igo-metadata-button>\r\n        <igo-download-button [layer]=\"layer\"></igo-download-button>\r\n        <igo-ogc-filter-button [header]=\"true\" [layer]=\"layer\"></igo-ogc-filter-button>\r\n        <igo-time-filter-button [header]=\"true\" [layer]=\"layer\"></igo-time-filter-button>\r\n        <igo-track-feature-button [layer]=\"layer\" [trackFeature]=\"true\"></igo-track-feature-button>\r\n      </ng-template>\r\n\r\n    </igo-layer-list>\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppLayerComponent } from './layer.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'layer',\r\n    component: AppLayerComponent\r\n  }\r\n];\r\n\r\nexport const AppLayerRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  WMSDataSourceOptions,\r\n  LayerOptions,\r\n  WFSDataSourceOptions,\r\n  OgcFilterableDataSourceOptions,\r\n  MetadataLayerOptions\r\n} from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-layer',\r\n  templateUrl: './layer.component.html',\r\n  styleUrls: ['./layer.component.scss']\r\n})\r\nexport class AppLayerComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    maxLayerZoomExtent: [-11000000, 4500000, -4500000, 10000000],\r\n    zoom: 7\r\n  };\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService\r\n  ) {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            visible: true,\r\n            baseLayer: true,\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    interface WFSoptions\r\n      extends WFSDataSourceOptions,\r\n        OgcFilterableDataSourceOptions {}\r\n\r\n    const wfsDatasource: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'shp'\r\n      },\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        filters: {\r\n          operator: 'PropertyIsEqualTo',\r\n          propertyName: 'code_municipalite',\r\n          expression: '10043'\r\n        }\r\n      }\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(wfsDatasource)\r\n      .subscribe(dataSource => {\r\n        const layer: LayerOptions = {\r\n          title: 'WFS ',\r\n          visible: true,\r\n          source: dataSource\r\n        };\r\n        this.map.addLayer(this.layerService.createLayer(layer));\r\n      });\r\n\r\n    const wfsDatasourceCustomEPSG: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: 'geojson_utf8',\r\n        srsName: 'EPSG:32198',\r\n        outputFormatDownload: 'shp'\r\n      },\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        filters: {\r\n          operator: 'PropertyIsEqualTo',\r\n          propertyName: 'code_municipalite',\r\n          expression: '12072'\r\n        }\r\n      },\r\n      formatOptions: {\r\n        dataProjection: 'EPSG:32198'\r\n      }\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(wfsDatasourceCustomEPSG)\r\n      .subscribe(dataSource => {\r\n        const layer: LayerOptions = {\r\n          title: 'WFS (Custom EPSG)',\r\n          visible: true,\r\n          source: dataSource,\r\n          removable: false\r\n        };\r\n        this.map.addLayer(this.layerService.createLayer(layer));\r\n      });\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          optionsFromCapabilities: true,\r\n          params: {\r\n            LAYERS: 'parc_routier',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'Rseau routier',\r\n        visible: false,\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          params: {\r\n            LAYERS: 'bgr_v_sous_route_res_sup_act',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'lieu habit',\r\n        visible: false,\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          optionsFromCapabilities: true,\r\n          params: {\r\n            LAYERS: 'lieuhabite',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'sh_dis_eco',\r\n        visible: false,\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/mffpecofor.fcgi',\r\n          optionsFromCapabilities: true,\r\n          params: {\r\n            LAYERS: 'sh_dis_eco',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'nurc:Arc_Sample_Parent',\r\n        visible: false,\r\n        legendOptions: {\r\n          // collapsed: false,\r\n          display: true,\r\n          // url: 'https://v.seloger.com/s/width/1144/visuels/0/m/l/4/0ml42xbt1n3itaboek3qec5dtskdgw6nlscu7j69k.jpg',\r\n          stylesAvailable: [\r\n            { name: 'rain', title: 'Pluie' },\r\n            { name: 'raster', title: 'Dfaut' }\r\n          ] //\r\n        },\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://demo.geo-solutions.it/geoserver/ows',\r\n          optionsFromCapabilities: true,\r\n          params: {\r\n            LAYERS: 'nurc:Arc_Sample', // , test:Linea_costa\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'Avertissements routier',\r\n        visible: false,\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          params: {\r\n            LAYERS: 'evenements',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    const datasource: WMSDataSourceOptions = {\r\n      type: 'wms',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      refreshIntervalSec: 15,\r\n      params: {\r\n        LAYERS: 'vg_observation_v_inondation_embacle_wmst',\r\n        VERSION: '1.3.0'\r\n      }\r\n    };\r\n\r\n    interface LayerOptionsWithMetadata\r\n      extends LayerOptions,\r\n        MetadataLayerOptions {}\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasource)\r\n      .subscribe(dataSource => {\r\n        const layer: LayerOptionsWithMetadata = {\r\n          title: 'Embcle',\r\n          source: dataSource,\r\n          metadata: {\r\n            url:\r\n              'https://www.donneesquebec.ca/recherche/fr/dataset/historique-publique-d-embacles-repertories-au-msp',\r\n            extern: true\r\n          }\r\n        };\r\n        this.map.addLayer(this.layerService.createLayer(layer));\r\n      });\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoPanelModule } from '@igo2/common';\r\nimport {\r\n  IgoMapModule,\r\n  IgoLayerModule,\r\n  IgoFilterModule,\r\n  IgoMetadataModule,\r\n  IgoDownloadModule\r\n} from '@igo2/geo';\r\n\r\nimport { AppLayerComponent } from './layer.component';\r\nimport { AppLayerRoutingModule } from './layer-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppLayerComponent],\r\n  imports: [\r\n    AppLayerRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoLayerModule,\r\n    IgoFilterModule,\r\n    IgoMetadataModule,\r\n    IgoDownloadModule\r\n  ],\r\n  exports: [AppLayerComponent]\r\n})\r\nexport class AppLayerModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppLegendComponent } from './legend.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'legend',\r\n    component: AppLegendComponent\r\n  }\r\n];\r\n\r\nexport const AppLegendRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  WMSDataSourceOptions,\r\n  LayerOptions,\r\n  WFSDataSourceOptions,\r\n  OgcFilterableDataSourceOptions,\r\n  MetadataLayerOptions\r\n} from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-legend',\r\n  templateUrl: './legend.component.html',\r\n  styleUrls: ['./legend.component.scss']\r\n})\r\nexport class AppLegendComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 7\r\n  };\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService\r\n  ) {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            visible: true,\r\n            baseLayer: true,\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    interface WFSoptions\r\n      extends WFSDataSourceOptions,\r\n        OgcFilterableDataSourceOptions {}\r\n\r\n    const wfsDatasource: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'shp'\r\n      },\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        filters: {\r\n          operator: 'PropertyIsEqualTo',\r\n          propertyName: 'code_municipalite',\r\n          expression: '10043'\r\n        }\r\n      }\r\n    };\r\n\r\n    this.layerService\r\n    .createAsyncLayer({\r\n      title: 'legend with display:false',\r\n      visible: true,\r\n      legendOptions: {\r\n        display: false,\r\n        html: 'test html'\r\n      },\r\n      sourceOptions: {\r\n        type: 'wms',\r\n        url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/mffpecofor.fcgi',\r\n        optionsFromCapabilities: true,\r\n        params: {\r\n          LAYERS: 'sh_dis_eco',\r\n          VERSION: '1.3.0'\r\n        }\r\n      }\r\n    })\r\n    .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n    .createAsyncLayer({\r\n      title: 'legend in html',\r\n      visible: true,\r\n      legendOptions: {\r\n        display: true,\r\n        html: '<h2 style=\"background-color: blue;\">HTML lgende</h2>'\r\n      },\r\n      sourceOptions: {\r\n        type: 'wms',\r\n        url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/mffpecofor.fcgi',\r\n        optionsFromCapabilities: false,\r\n        params: {\r\n          LAYERS: 'sh_sreg_eco',\r\n          VERSION: '1.3.0'\r\n        }\r\n      }\r\n    })\r\n    .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n    .createAsyncLayer({\r\n      title: 'legend with url param',\r\n      visible: true,\r\n      legendOptions: {\r\n        url: `data:image/jpeg;base64,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`\r\n\r\n      },\r\n      sourceOptions: {\r\n        type: 'wms',\r\n        url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/mffpecofor.fcgi',\r\n        optionsFromCapabilities: true,\r\n        params: {\r\n          LAYERS: 'sh_reg_eco',\r\n          VERSION: '1.3.0'\r\n        }\r\n      }\r\n    })\r\n    .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(wfsDatasource)\r\n      .subscribe(dataSource => {\r\n        const layer: LayerOptions = {\r\n          title: 'WFS ',\r\n          visible: true,\r\n          source: dataSource\r\n        };\r\n        this.map.addLayer(this.layerService.createLayer(layer));\r\n      });\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'Commission scolaire anglophone',\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://geoegl.msp.gouv.qc.ca/apis/wss/all.fcgi',\r\n          params: {\r\n            LAYERS: 'WMS_MEQ_CS_ANGLO',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'Rseau routier',\r\n        visible: false,\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          params: {\r\n            LAYERS: 'bgr_v_sous_route_res_sup_act',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'lieu habit',\r\n        visible: false,\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          optionsFromCapabilities: true,\r\n          params: {\r\n            LAYERS: 'lieuhabite',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'Avertissements routier',\r\n        visible: false,\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          params: {\r\n            LAYERS: 'evenements',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    const datasource: WMSDataSourceOptions = {\r\n      type: 'wms',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      refreshIntervalSec: 15,\r\n      params: {\r\n        LAYERS: 'vg_observation_v_inondation_embacle_wmst',\r\n        VERSION: '1.3.0'\r\n      }\r\n    };\r\n\r\n    interface LayerOptionsWithMetadata\r\n      extends LayerOptions,\r\n        MetadataLayerOptions {}\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasource)\r\n      .subscribe(dataSource => {\r\n        const layer: LayerOptionsWithMetadata = {\r\n          title: 'Embcle',\r\n          visible: true,\r\n          source: dataSource,\r\n          metadata: {\r\n            url:\r\n              'https://www.donneesquebec.ca/recherche/fr/dataset/historique-publique-d-embacles-repertories-au-msp',\r\n            extern: true\r\n          }\r\n        };\r\n        this.map.addLayer(this.layerService.createLayer(layer));\r\n      });\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Simple Map with a legend list</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/layer\">code of this\r\n      example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Legends\">\r\n    <igo-layer-legend-list [layers]=\"map.layers\"\r\n    [excludeBaseLayers]=\"true\"\r\n    [allowShowAllLegends]=\"true\"\r\n    [updateLegendOnResolutionChange]=\"false\"\r\n    [showAllLegendsValue]=\"false\">\r\n  </igo-layer-legend-list>\r\n\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoPanelModule } from '@igo2/common';\r\nimport {\r\n  IgoMapModule,\r\n  IgoLayerModule,\r\n  IgoFilterModule,\r\n  IgoMetadataModule,\r\n  IgoDownloadModule\r\n} from '@igo2/geo';\r\n\r\nimport { AppLegendComponent } from './legend.component';\r\nimport { AppLegendRoutingModule } from './legend-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppLegendComponent],\r\n  imports: [\r\n    AppLegendRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoLayerModule,\r\n    IgoFilterModule,\r\n    IgoMetadataModule,\r\n    IgoDownloadModule\r\n  ],\r\n  exports: [AppLegendComponent]\r\n})\r\nexport class AppLegendModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppOverlayComponent } from './overlay.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'overlay',\r\n    component: AppOverlayComponent\r\n  }\r\n];\r\n\r\nexport const AppOverlayRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit, AfterViewInit } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  FEATURE,\r\n  Feature,\r\n  FeatureMotion\r\n} from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-overlay',\r\n  templateUrl: './overlay.component.html',\r\n  styleUrls: ['./overlay.component.scss']\r\n})\r\nexport class AppOverlayComponent implements OnInit, AfterViewInit {\r\n  public map = new IgoMap({\r\n    overlay: true,\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 6\r\n  };\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n  }\r\n\r\n  ngAfterViewInit() {\r\n    const feature1: Feature = {\r\n      type: FEATURE,\r\n      projection: 'EPSG:4326',\r\n      meta: {\r\n        id: 1\r\n      },\r\n      properties: {},\r\n      geometry: {\r\n        type: 'Point',\r\n        coordinates: [-73, 46.6]\r\n      }\r\n    };\r\n\r\n    const feature2: Feature = {\r\n      type: FEATURE,\r\n      projection: 'EPSG:4326',\r\n      meta: {\r\n        id: 2\r\n      },\r\n      properties: {},\r\n      geometry: {\r\n        type: 'LineString',\r\n        coordinates: [[-72, 47.8], [-73.5, 47.4], [-72.4, 48.6]]\r\n      }\r\n    };\r\n\r\n    const feature3: Feature = {\r\n      type: FEATURE,\r\n      projection: 'EPSG:4326',\r\n      meta: {\r\n        id: 3\r\n      },\r\n      properties: {},\r\n      geometry: {\r\n        type: 'Polygon',\r\n        coordinates: [[[-71, 46.8], [-73, 47], [-71.2, 46.6]]]\r\n      }\r\n    };\r\n\r\n    this.map.overlay.setFeatures(\r\n      [feature1, feature2, feature3],\r\n      FeatureMotion.None\r\n    );\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Overlay</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/overlay\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMapModule, IgoOverlayModule } from '@igo2/geo';\r\n\r\nimport { AppOverlayComponent } from './overlay.component';\r\nimport { AppOverlayRoutingModule } from './overlay-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppOverlayComponent],\r\n  imports: [\r\n    AppOverlayRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoMapModule,\r\n    IgoOverlayModule\r\n  ],\r\n  exports: [AppOverlayComponent]\r\n})\r\nexport class AppOverlayModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Geometry Form</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/form\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-form\r\n    *ngIf=\"form$ | async as form\"\r\n    [form]=\"form\"\r\n    [formData]=\"data$ | async\"\r\n    (submitForm)=\"onSubmit($event)\">\r\n\r\n    <igo-form-group [group]=\"form.groups[0]\"></igo-form-group>\r\n\r\n    <div formButtons>\r\n      <button\r\n        mat-stroked-button\r\n        type=\"button\"\r\n        color=\"primary\"\r\n        (click)=\"fillForm()\">\r\n        Fill Form\r\n      </button>\r\n      <button\r\n        mat-stroked-button\r\n        type=\"button\"\r\n        color=\"primary\"\r\n        (click)=\"clearForm()\">\r\n        Clear Form\r\n      </button>\r\n      <button\r\n        mat-flat-button\r\n        type=\"submit\"\r\n        color=\"primary\"\r\n        [disabled]=\"submitDisabled\">\r\n        Submit\r\n      </button>\r\n    </div>\r\n  </igo-form>\r\n</mat-card>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppGeometryComponent } from './geometry.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'geometry',\r\n    component: AppGeometryComponent\r\n  }\r\n];\r\n\r\nexport const AppGeometryRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit, OnDestroy } from '@angular/core';\r\nimport { Validators } from '@angular/forms';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport * as olstyle from 'ol/style';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { Form, FormService } from '@igo2/common';\r\nimport { IgoMap, DataSourceService, LayerService } from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-geometry',\r\n  templateUrl: './geometry.component.html',\r\n  styleUrls: ['./geometry.component.scss']\r\n})\r\nexport class AppGeometryComponent implements OnInit, OnDestroy {\r\n\r\n  map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      },\r\n      scaleLine: true\r\n    }\r\n  });\r\n\r\n  view = {\r\n    center: [-73, 47.2],\r\n    zoom: 15\r\n  };\r\n\r\n  form$ = new BehaviorSubject<Form>(undefined);\r\n\r\n  data$ = new BehaviorSubject<{[key: string]: any}>(undefined);\r\n\r\n  submitDisabled = true;\r\n\r\n  private valueChanges$$: Subscription;\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private formService: FormService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    const fieldConfigs = [\r\n      {\r\n        name: 'geometry',\r\n        title: 'Geometry',\r\n        options: {\r\n          validator: Validators.required\r\n        },\r\n        type: 'geometry',\r\n        inputs: {\r\n          map: this.map,\r\n          geometryTypeField: true,\r\n          geometryType: 'Polygon',\r\n          drawGuideField: true,\r\n          drawGuide: 50,\r\n          drawGuidePlaceholder: 'Draw Guide',\r\n          drawStyle: new olstyle.Style({\r\n            stroke: new olstyle.Stroke({\r\n              color: [255, 0, 0, 1],\r\n              width: 2\r\n            }),\r\n            fill:  new olstyle.Fill({\r\n              color: [255, 0, 0, 0.2]\r\n            }),\r\n            image: new olstyle.Circle({\r\n              radius: 8,\r\n              stroke: new olstyle.Stroke({\r\n                color: [255, 0, 0, 1]\r\n              }),\r\n              fill: new olstyle.Fill({\r\n                color: [255, 0, 0, 0.2]\r\n              })\r\n            })\r\n          })\r\n        }\r\n      },\r\n      {\r\n        name: 'name',\r\n        title: 'Name',\r\n        options: {\r\n          validator: Validators.required\r\n        }\r\n      }\r\n    ];\r\n\r\n    const fields = fieldConfigs.map((config) => this.formService.field(config));\r\n    const form = this.formService.form([], [this.formService.group({name: 'info'}, fields)]);\r\n\r\n    this.valueChanges$$ = form.control.valueChanges.subscribe(() => {\r\n      this.submitDisabled = !form.control.valid;\r\n    });\r\n\r\n    this.form$.next(form);\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.valueChanges$$.unsubscribe();\r\n  }\r\n\r\n  fillForm() {\r\n    this.data$.next({\r\n      name: 'Place',\r\n      geometry: JSON.stringify({type: 'Polygon', coordinates: [[\r\n        [-106, 42],\r\n        [-107, 31],\r\n        [-81, 32],\r\n        [-82, 42],\r\n        [-106, 42]\r\n      ]]})\r\n    });\r\n  }\r\n\r\n  clearForm() {\r\n    this.form$.value.control.reset();\r\n  }\r\n\r\n  onSubmit(data: {[key: string]: any}) {\r\n    alert(JSON.stringify(data));\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoFormModule } from '@igo2/common';\r\nimport { IgoGeometryModule, IgoMapModule } from '@igo2/geo';\r\n\r\nimport { AppGeometryComponent } from './geometry.component';\r\nimport { AppGeometryRoutingModule } from './geometry-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppGeometryComponent],\r\n  imports: [\r\n    CommonModule,\r\n    AppGeometryRoutingModule,\r\n    MatButtonModule,\r\n    MatCardModule,\r\n    IgoFormModule,\r\n    IgoGeometryModule,\r\n    IgoMapModule\r\n  ],\r\n  exports: [AppGeometryComponent]\r\n})\r\nexport class AppGeometryModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppFeatureComponent } from './feature.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'feature',\r\n    component: AppFeatureComponent\r\n  }\r\n];\r\n\r\nexport const AppFeatureRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit, OnDestroy } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  VectorLayer,\r\n  FeatureStore,\r\n  FeatureStoreLoadingStrategy,\r\n  FeatureStoreSelectionStrategy,\r\n  FeatureMotion\r\n} from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-feature',\r\n  templateUrl: './feature.component.html',\r\n  styleUrls: ['./feature.component.scss']\r\n})\r\nexport class AppFeatureComponent implements OnInit, OnDestroy {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 6\r\n  };\r\n\r\n  public tableTemplate = {\r\n    selection: true,\r\n    selectMany: true,\r\n    sort: true,\r\n    columns: [\r\n      {\r\n        name: 'properties.id',\r\n        title: 'ID'\r\n      },\r\n      {\r\n        name: 'properties.name',\r\n        title: 'Name'\r\n      },\r\n      {\r\n        name: 'properties.description',\r\n        title: 'Description'\r\n      }\r\n    ]\r\n  };\r\n\r\n  public store = new FeatureStore([], { map: this.map });\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    const loadingStrategy = new FeatureStoreLoadingStrategy({});\r\n    this.store.addStrategy(loadingStrategy);\r\n\r\n    const selectionStrategy = new FeatureStoreSelectionStrategy({\r\n      map: this.map,\r\n      motion: FeatureMotion.Default\r\n    });\r\n    this.store.addStrategy(selectionStrategy);\r\n\r\n    this.store.load([\r\n      {\r\n        meta: { id: 1 },\r\n        type: 'Feature',\r\n        geometry: {\r\n          type: 'Point',\r\n          coordinates: [-72, 47.8]\r\n        },\r\n        projection: 'EPSG:4326',\r\n        properties: {\r\n          id: 1,\r\n          name: 'Name 1',\r\n          description: 'Description 1'\r\n        }\r\n      },\r\n      {\r\n        meta: { id: 4 },\r\n        type: 'Feature',\r\n        geometry: {\r\n          type: 'Point',\r\n          coordinates: [-71, 46.8]\r\n        },\r\n        projection: 'EPSG:4326',\r\n        properties: {\r\n          id: 4,\r\n          name: 'Name 4',\r\n          description: 'Description 4'\r\n        }\r\n      },{\r\n        meta: { id: 5 },\r\n        type: 'Feature',\r\n        geometry: {\r\n          type: 'Point',\r\n          coordinates: [-73, 45.8]\r\n        },\r\n        projection: 'EPSG:4326',\r\n        properties: {\r\n          id: 5,\r\n          name: 'Name 5',\r\n          description: 'Description 5'\r\n        }\r\n      },\r\n      {\r\n        meta: { id: 2 },\r\n        type: 'Feature',\r\n        geometry: {\r\n          type: 'LineString',\r\n          coordinates: [[-72, 47.8], [-73.5, 47.4], [-72.4, 48.6]]\r\n        },\r\n        projection: 'EPSG:4326',\r\n        properties: {\r\n          id: 2,\r\n          name: 'Name 2',\r\n          description: 'Description 2'\r\n        }\r\n      },\r\n      {\r\n        meta: { id: 3 },\r\n        type: 'Feature',\r\n        geometry: {\r\n          type: 'Polygon',\r\n          coordinates: [[[-71, 46.8], [-73, 47], [-71.2, 46.6]]]\r\n        },\r\n        projection: 'EPSG:4326',\r\n        properties: {\r\n          id: 3,\r\n          name: 'Name 3',\r\n          description: 'Description 3'\r\n        }\r\n      }\r\n    ]);\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'MVT test',\r\n        visible: true,\r\n        sourceOptions: {\r\n          type: 'mvt',\r\n          url:\r\n            'https://ahocevar.com/geoserver/gwc/service/tms/1.0.0/ne:ne_10m_admin_0_countries@EPSG:900913@pbf/{z}/{x}/{-y}.pbf',\r\n          queryable: true\r\n        },\r\n        mapboxStyle: {\r\n          url: 'assets/mapboxStyleExample-vectortile.json',\r\n          source: 'ahocevar'\r\n        }\r\n      } as any)\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'vector'\r\n      })\r\n      .subscribe(dataSource => {\r\n        const layer = this.layerService.createLayer({\r\n          title: 'Vector Layer',\r\n          source: dataSource,\r\n          animation: {\r\n            duration: 2000\r\n          },\r\n          mapboxStyle: {\r\n            url: 'assets/mapboxStyleExample-feature.json',\r\n            source: 'source_nameX'\r\n          }\r\n        }) as VectorLayer;\r\n        this.map.addLayer(layer);\r\n        this.store.bindLayer(layer);\r\n        loadingStrategy.activate();\r\n        selectionStrategy.activate();\r\n      });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.store.destroy();\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Feature</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geom/feature\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-entity-table\r\n    [store]=\"store\"\r\n    [template]=\"tableTemplate\">\r\n  </igo-entity-table>\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoPanelModule, IgoEntityTableModule } from '@igo2/common';\r\nimport { IgoMapModule, IgoFeatureModule } from '@igo2/geo';\r\n\r\nimport { AppFeatureComponent } from './feature.component';\r\nimport { AppFeatureRoutingModule } from './feature-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppFeatureComponent],\r\n  imports: [\r\n    AppFeatureRoutingModule,\r\n    CommonModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoPanelModule,\r\n    IgoEntityTableModule,\r\n    IgoMapModule,\r\n    IgoFeatureModule\r\n  ],\r\n  exports: [AppFeatureComponent]\r\n})\r\nexport class AppFeatureModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\nimport { AppHoverComponent } from './hover.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'hover',\r\n    component: AppHoverComponent\r\n  }\r\n];\r\n\r\nexport const AppHoverRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService, MediaService } from '@igo2/core';\r\nimport { IgoMap, DataSourceService, LayerService, WFSDataSourceOptions, VectorLayerOptions, WFSDataSource } from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-hover',\r\n  templateUrl: './hover.component.html',\r\n  styleUrls: ['./hover.component.scss']\r\n})\r\nexport class AppHoverComponent {\r\n  public selected;\r\n  public pointerCoord;\r\n  public pointerCoordDelay: number = 0;\r\n  public pointerHoverFeatureDelay: number = 0;\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      },\r\n      scaleLine: true\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 8,\r\n    projection: 'EPSG:3857'\r\n  };\r\n\r\n\r\n  get media() {\r\n    return this.mediaService.getMedia();\r\n  }\r\n\r\n  get isTouchScreen() {\r\n    return this.mediaService.isTouchScreen();\r\n  }\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService,\r\n    private mediaService: MediaService\r\n  ) {\r\n\r\n    this.dataSourceService\r\n    .createAsyncDataSource({\r\n      type: 'wmts',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/carto/wmts/1.0.0/wmts',\r\n      layer: 'carte_gouv_qc_public',\r\n      matrixSet: 'EPSG_3857',\r\n      version: '1.3.0'\r\n    })\r\n    .subscribe(dataSource => {\r\n      this.map.addLayer(\r\n        this.layerService.createLayer({\r\n          title: 'Quebec',\r\n          visible: true,\r\n          baseLayer: true,\r\n          source: dataSource\r\n        })\r\n      );\r\n    });\r\n\r\n    interface WFSDataOptions\r\n      extends WFSDataSourceOptions {}\r\n\r\n    const wfsDatasourcePolygon: WFSDataOptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'adn_bassin_n1_public_v',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '3.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'shp'\r\n      }\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(wfsDatasourcePolygon)\r\n      .subscribe((dataSource: WFSDataSource) => {\r\n        const layer: VectorLayerOptions = {\r\n          title: 'WFS (polygon)',\r\n          visible: true,\r\n          source: dataSource\r\n        };\r\n        this.map.addLayer(this.layerService.createLayer(layer));\r\n      });\r\n\r\n    const wfsDatasourcePoint: WFSDataOptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/wss/all.fcgi',\r\n      params: {\r\n        featureTypes: 'MSP_CASERNE_PUBLIC',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'shp'\r\n      }\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(wfsDatasourcePoint)\r\n      .subscribe((dataSource: WFSDataSource) => {\r\n        const layer: VectorLayerOptions = {\r\n          title: 'WFS (point)',\r\n          visible: true,\r\n          source: dataSource,\r\n          styleByAttribute: {\r\n            attribute: 'en_caserne',\r\n            data: ['true', 'false'],\r\n            stroke: ['red', 'blue'],\r\n            fill: ['#ffffff', '#ffffff'],\r\n            radius: [7, 7],\r\n            width: [2, 2]\r\n          },\r\n          hoverStyle: {\r\n            label: {\r\n              attribute: 'Caserne: ${no_caserne}\\n Mun: ${nom_ssi}',\r\n              style: {\r\n                textAlign: 'left',\r\n                textBaseline: 'top',\r\n                font: '12px Calibri,sans-serif',\r\n                fill: { color: '#000' },\r\n                backgroundFill: { color: 'rgba(255, 255, 255, 0.5)' },\r\n                backgroundStroke: { color: 'rgba(200, 200, 200, 0.75)', width: 2 },\r\n                stroke: { color: '#fff', width: 3 },\r\n                overflow: true,\r\n                offsetX: 20,\r\n                offsetY: 10,\r\n                padding: [2.5, 2.5, 2.5, 2.5]\r\n              }\r\n            },\r\n            baseStyle: {\r\n              circle: {\r\n                stroke: {\r\n                  color: 'orange',\r\n                  width: 5\r\n                },\r\n                width: [5],\r\n                radius: 15\r\n              }\r\n            }\r\n          }\r\n        };\r\n        this.map.addLayer(this.layerService.createLayer(layer));\r\n      });\r\n\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Hover</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/hover\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\"\r\n  igoHoverFeature\r\n  [igoHoverFeatureDelay]=\"pointerHoverFeatureDelay\"\r\n  [igoHoverFeatureEnabled]=\"true\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n    <igo-geolocate-button [map]=\"map\" color=\"primary\"></igo-geolocate-button>\r\n    <igo-home-extent-button [map]=\"map\" color=\"primary\"></igo-home-extent-button>\r\n    <igo-rotation-button [map]=\"map\" [showIfNoRotation]=\"true\" color=\"primary\"></igo-rotation-button>\r\n  </igo-map-browser>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMapModule } from '@igo2/geo';\r\n\r\nimport { AppHoverComponent } from './hover.component';\r\nimport { AppHoverRoutingModule } from './hover-routing.module';\r\nimport { CommonModule } from '@angular/common';\r\n\r\n@NgModule({\r\n  declarations: [AppHoverComponent],\r\n  imports: [\r\n    CommonModule,\r\n    AppHoverRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoMapModule\r\n  ],\r\n  exports: [AppHoverComponent]\r\n})\r\nexport class AppHoverModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppMeasureComponent } from './measure.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'measure',\r\n    component: AppMeasureComponent\r\n  }\r\n];\r\n\r\nexport const AppMeasureRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  FeatureStore,\r\n  FeatureWithMeasure\r\n} from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-measure',\r\n  templateUrl: './measure.component.html',\r\n  styleUrls: ['./measure.component.scss']\r\n})\r\nexport class AppMeasureComponent {\r\n\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      },\r\n      scaleLine: true\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 6,\r\n    projection: 'EPSG:3857'\r\n  };\r\n\r\n  public store = new FeatureStore<FeatureWithMeasure>([], {map: this.map});\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService\r\n  ) {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Simple Map</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/measure\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-measurer [store]=\"store\" [map]=\"map\"></igo-measurer>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMapModule, IgoMeasureModule } from '@igo2/geo';\r\n\r\nimport { AppMeasureComponent } from './measure.component';\r\nimport { AppMeasureRoutingModule } from './measure-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppMeasureComponent],\r\n  imports: [\r\n    AppMeasureRoutingModule,\r\n    MatCardModule,\r\n    IgoMapModule,\r\n    IgoMeasureModule\r\n  ],\r\n  exports: [AppMeasureComponent]\r\n})\r\nexport class AppMeasureModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\nimport { AppDrawComponent } from './draw.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'draw',\r\n    component: AppDrawComponent\r\n  }\r\n];\r\n\r\nexport const AppDrawRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  FeatureStore,\r\n  FeatureWithDraw,\r\n  MapService\r\n} from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-draw',\r\n  templateUrl: './draw.component.html',\r\n  styleUrls: ['./draw.component.scss']\r\n})\r\nexport class AppDrawComponent {\r\n\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      },\r\n      scaleLine: true\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 6,\r\n    projection: 'EPSG:3857'\r\n  };\r\n\r\n  public stores: FeatureStore<FeatureWithDraw>[] = [];\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService,\r\n    private mapService: MapService\r\n  ) {\r\n    this.mapService.setMap(this.map);\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Simple Map</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/draw\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-draw [stores]=\"stores\" [map]=\"map\"></igo-draw>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMapModule, IgoDrawModule } from '@igo2/geo';\r\n\r\nimport { AppDrawComponent } from './draw.component';\r\nimport { AppDrawRoutingModule } from './draw-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppDrawComponent],\r\n  imports: [\r\n    AppDrawRoutingModule,\r\n    MatCardModule,\r\n    IgoMapModule,\r\n    IgoDrawModule\r\n  ],\r\n  exports: [AppDrawComponent]\r\n})\r\nexport class AppDrawModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Query</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/query\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser\r\n    [map]=\"map\"\r\n    [view]=\"view\"\r\n    igoOverlay\r\n    igoQuery\r\n    [queryFeatures]=\"true\"\r\n    (query)=\"handleQueryResults($event)\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Details\">\r\n    <ng-container *ngIf=\"feature$ | async as feature\">\r\n      <h1>Query Title : <span style=\"background-color: #e0e0e0;\">{{getTitle(feature)}}</span></h1>\r\n      <igo-feature-details [feature]=\"feature\"></igo-feature-details>\r\n    </ng-container>\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppQueryComponent } from './query.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'query',\r\n    component: AppQueryComponent\r\n  }\r\n];\r\n\r\nexport const AppQueryRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport olFeature from 'ol/Feature';\r\nimport olPoint from 'ol/geom/Point';\r\nimport olPolygon from 'ol/geom/Polygon';\r\nimport olLineString from 'ol/geom/LineString';\r\nimport * as olproj from 'ol/proj';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  FeatureDataSource,\r\n  DataSourceService,\r\n  LayerService,\r\n  OverlayService,\r\n  Feature,\r\n  QueryableDataSourceOptions,\r\n  QueryFormat,\r\n  QueryHtmlTarget,\r\n  SearchResult,\r\n  FeatureMotion\r\n} from '@igo2/geo';\r\n\r\nimport { getEntityTitle } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'app-query',\r\n  templateUrl: './query.component.html',\r\n  styleUrls: ['./query.component.scss']\r\n})\r\nexport class AppQueryComponent {\r\n  public feature$ = new BehaviorSubject<Feature>(undefined);\r\n\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 6\r\n  };\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService,\r\n    private overlayService: OverlayService\r\n  ) {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'wms',\r\n        url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n        queryable: true,\r\n        queryTitle: 'num_rts',\r\n        params: {\r\n          layers: 'bgr_v_sous_route_res_sup_act',\r\n          version: '1.3.0'\r\n        }\r\n      } as QueryableDataSourceOptions)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'WMS',\r\n            source: dataSource,\r\n            sourceOptions: dataSource.options\r\n          })\r\n        );\r\n      });\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'wms',\r\n        url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n        queryable: true,\r\n        queryFormat: QueryFormat.HTMLGML2,\r\n        queryHtmlTarget: QueryHtmlTarget.IFRAME,\r\n        params: {\r\n          layers: 'bgr_v_sous_route_res_sup_act',\r\n          version: '1.3.0'\r\n        }\r\n      } as QueryableDataSourceOptions)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'WMS html with a pre call in GML',\r\n            source: dataSource,\r\n            sourceOptions: dataSource.options\r\n          })\r\n        );\r\n      });\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'vector',\r\n        queryable: true,\r\n        queryTitle: 'So beautiful ${name}',\r\n        sourceFields: [\r\n          { name: 'name', alias: 'Alias name' },\r\n          { name: 'description', alias: 'Alias description' }\r\n        ]\r\n      } as QueryableDataSourceOptions)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Vector Layer',\r\n            source: dataSource,\r\n            sourceOptions: dataSource.options\r\n          })\r\n        );\r\n        this.addFeatures(dataSource as FeatureDataSource);\r\n      });\r\n  }\r\n\r\n  addFeatures(dataSource: FeatureDataSource) {\r\n    const feature1 = new olFeature({\r\n      name: 'feature1',\r\n      geometry: new olLineString([\r\n        olproj.transform([-72, 47.8], 'EPSG:4326', 'EPSG:3857'),\r\n        olproj.transform([-73.5, 47.4], 'EPSG:4326', 'EPSG:3857'),\r\n        olproj.transform([-72.4, 48.6], 'EPSG:4326', 'EPSG:3857')\r\n      ]),\r\n    });\r\n\r\n    const feature2 = new olFeature({\r\n      name: 'feature2',\r\n      geometry: new olPoint(\r\n        olproj.transform([-73, 46.6], 'EPSG:4326', 'EPSG:3857')\r\n      ),\r\n    });\r\n\r\n    const feature3 = new olFeature({\r\n      name: 'feature3',\r\n      geometry: new olPolygon([\r\n        [\r\n          olproj.transform([-71, 46.8], 'EPSG:4326', 'EPSG:3857'),\r\n          olproj.transform([-73, 47], 'EPSG:4326', 'EPSG:3857'),\r\n          olproj.transform([-71.2, 46.6], 'EPSG:4326', 'EPSG:3857')\r\n        ]\r\n      ]),\r\n    });\r\n\r\n    dataSource.ol.addFeatures([feature1, feature2, feature3]);\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'Vector tile with custom getfeatureinfo url',\r\n        visible: true,\r\n        sourceOptions: {\r\n          type: 'mvt',\r\n          url:\r\n            'https://ahocevar.com/geoserver/gwc/service/tms/1.0.0/ne:ne_10m_admin_0_countries@EPSG:900913@pbf/{z}/{x}/{-y}.pbf',\r\n          queryable: true,\r\n          queryUrl: 'https://geoegl.msp.gouv.qc.ca/apis/wss/amenagement.fcgi?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetFeatureInfo&FORMAT=image%2Fpng&TRANSPARENT=true&QUERY_LAYERS=wms_mern_reg_admin&LAYERS=wms_mern_reg_admin&DPI=96&MAP_RESOLUTION=96&FORMAT_OPTIONS=dpi%3A96&INFO_FORMAT=geojson&FEATURE_COUNT=5&I=50&J=50&CRS=EPSG:{srid}&STYLES=&WIDTH=101&HEIGHT=101&BBOX={xmin},{ymin},{xmax},{ymax}',\r\n          queryLayerFeatures: false,\r\n          queryFormat: 'geojson'\r\n        },\r\n        mapboxStyle: {\r\n          url: 'assets/mapboxStyleExample-vectortile.json',\r\n          source: 'ahocevar'\r\n        }\r\n      } as any)\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n\r\n      this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'wms',\r\n        url: 'https://geoegl.msp.gouv.qc.ca/apis/wss/incendie.fcgi',\r\n        queryable: true,\r\n        queryUrl: 'https://geoegl.msp.gouv.qc.ca/apis/wss/amenagement.fcgi?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetFeatureInfo&FORMAT=image%2Fpng&TRANSPARENT=true&QUERY_LAYERS=SDA_MUNIC_S_20K&LAYERS=SDA_MUNIC_S_20K&DPI=96&MAP_RESOLUTION=96&FORMAT_OPTIONS=dpi%3A96&INFO_FORMAT=geojson&FEATURE_COUNT=5&I=50&J=50&CRS=EPSG:{srid}&STYLES=&WIDTH=101&HEIGHT=101&BBOX={xmin},{ymin},{xmax},{ymax}',\r\n        queryFormat: 'geojson',\r\n        params: {\r\n          layers: 'caserne',\r\n          version: '1.3.0'\r\n        }\r\n      } as QueryableDataSourceOptions)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'WMS with custom getfeatureinfo url',\r\n            source: dataSource,\r\n            sourceOptions: dataSource.options\r\n          })\r\n        );\r\n      });\r\n\r\n  }\r\n\r\n  handleQueryResults(results) {\r\n    const features: Feature[] = results.features;\r\n    let feature: Feature;\r\n    if (features.length && features[0]) {\r\n      feature = features[0];\r\n      this.feature$.next(feature);\r\n      this.map.queryResultsOverlay.setFeatures([feature], FeatureMotion.None);\r\n    }\r\n\r\n  }\r\n\r\n  getTitle(result: SearchResult) {\r\n    return getEntityTitle(result);\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoPanelModule } from '@igo2/common';\r\nimport {\r\n  IgoMapModule,\r\n  IgoOverlayModule,\r\n  IgoQueryModule,\r\n  IgoFeatureModule\r\n} from '@igo2/geo';\r\n\r\nimport { AppQueryComponent } from './query.component';\r\nimport { AppQueryRoutingModule } from './query-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppQueryComponent],\r\n  imports: [\r\n    AppQueryRoutingModule,\r\n    CommonModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoOverlayModule,\r\n    IgoQueryModule,\r\n    IgoFeatureModule\r\n  ],\r\n  exports: [AppQueryComponent]\r\n})\r\nexport class AppQueryModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppCatalogComponent } from './catalog.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'catalog',\r\n    component: AppCatalogComponent\r\n  }\r\n];\r\n\r\nexport const AppCatalogRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit } from '@angular/core';\r\n\r\nimport { LanguageService, ConfigService, StorageService } from '@igo2/core';\r\nimport { IgoMap, LayerService, Catalog, CatalogItem, CatalogService } from '@igo2/geo';\r\nimport { EntityStore } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'app-catalog',\r\n  templateUrl: './catalog.component.html',\r\n  styleUrls: ['./catalog.component.scss']\r\n})\r\nexport class AppCatalogComponent implements OnInit {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 7\r\n  };\r\n\r\n  public catalogStore = new EntityStore<Catalog>([]);\r\n\r\n  public catalogItemStore = new EntityStore<CatalogItem>([]);\r\n\r\n  constructor(\r\n    private configService: ConfigService,\r\n    private languageService: LanguageService,\r\n    private layerService: LayerService,\r\n    private catalogService: CatalogService,\r\n    private storageService: StorageService\r\n  ) {}\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'OSM',\r\n        sourceOptions: {\r\n          type: 'osm'\r\n        }\r\n      })\r\n      .subscribe(layer => this.map.addLayer(layer));\r\n\r\n    this.loadCatalogs();\r\n  }\r\n\r\n  /**\r\n   * When the selected catalog changes, toggle the the CatalogBrowser tool.\r\n   * @internal\r\n   * @param event Select event\r\n   */\r\n  onCatalogSelectChange(event: {selected: boolean; catalog: Catalog}) {\r\n    this.loadCatalogItems(event.catalog);\r\n  }\r\n\r\n  /**\r\n   * Get all the available catalogs from the CatalogService and\r\n   * load them into the store.\r\n   */\r\n  private loadCatalogs() {\r\n    this.catalogService.loadCatalogs()\r\n      .subscribe((catalogs: Catalog[]) => {\r\n        this.catalogStore.clear();\r\n        this.catalogStore.load(catalogs.concat((this.storageService.get('addedCatalogs') || []) as Catalog[]));\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Get the selected catalog's items from the CatalogService and\r\n   * load them into the store.\r\n   * @param catalog Selected catalog\r\n   */\r\n  private loadCatalogItems(catalog: Catalog) {\r\n    this.catalogService.loadCatalogItems(catalog)\r\n      .subscribe((items: CatalogItem[]) => {\r\n        this.catalogItemStore.clear();\r\n        this.catalogItemStore.load(items);\r\n      });\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Catalog</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: ConfigService, LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/catalog\">code of this example</a><br>\r\n    See catalog section of the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/environments\"> environment config</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Catalog Library\">\r\n    <igo-catalog-library\r\n      [store]=\"catalogStore\"\r\n      (catalogSelectChange)=\"onCatalogSelectChange($event)\">\r\n    </igo-catalog-library>\r\n  </igo-panel>\r\n\r\n  <igo-panel title=\"Catalog Browser\">\r\n    <igo-catalog-browser\r\n      [store]=\"catalogItemStore\"\r\n      [map]=\"map\">\r\n    </igo-catalog-browser>\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoConfigModule, provideConfigOptions } from '@igo2/core';\r\nimport { IgoPanelModule } from '@igo2/common';\r\nimport { IgoMapModule, IgoCatalogModule } from '@igo2/geo';\r\n\r\nimport { environment } from '../../../environments/environment';\r\nimport { AppCatalogComponent } from './catalog.component';\r\nimport { AppCatalogRoutingModule } from './catalog-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppCatalogComponent],\r\n  imports: [\r\n    CommonModule,\r\n    AppCatalogRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    MatTooltipModule,\r\n    IgoConfigModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoCatalogModule\r\n  ],\r\n  exports: [AppCatalogComponent],\r\n  providers: [\r\n    provideConfigOptions({\r\n      default: environment.igo\r\n    })\r\n  ]\r\n})\r\nexport class AppCatalogModule {}\r\n","export class ExportError extends Error {}\r\n\r\nexport class ExportInvalidFileError extends ExportError {\r\n  constructor() {\r\n    super('Invalid context');\r\n    Object.setPrototypeOf(this, ExportInvalidFileError.prototype);\r\n  }\r\n}\r\n\r\nexport class ExportNothingToExportError extends ExportError {\r\n  constructor() {\r\n    super('Nothing to export');\r\n    Object.setPrototypeOf(this, ExportNothingToExportError.prototype);\r\n  }\r\n}\r\n","export class ImportError extends Error {}\r\n\r\nexport class ImportInvalidFileError extends ImportError {\r\n  constructor() {\r\n    super('Invalid file');\r\n    Object.setPrototypeOf(this, ImportInvalidFileError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportUnreadableFileError extends ImportError {\r\n  constructor() {\r\n      super('Failed to read file');\r\n      Object.setPrototypeOf(this, ImportUnreadableFileError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportNothingToImportError extends ImportError {\r\n  constructor() {\r\n      super('Nothing to import');\r\n      Object.setPrototypeOf(this, ImportNothingToImportError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportSizeError extends ImportError {\r\n  constructor() {\r\n      super('File is too large');\r\n      Object.setPrototypeOf(this, ImportNothingToImportError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportSRSError extends ImportError {\r\n  constructor() {\r\n      super('Invalid SRS definition');\r\n      Object.setPrototypeOf(this, ImportNothingToImportError.prototype);\r\n  }\r\n}\r\n","export enum TypePermission {\r\n  null,\r\n  read,\r\n  write\r\n}\r\n\r\nexport enum Scope {\r\n  public,\r\n  protected,\r\n  private\r\n}\r\n","import { Injectable, Optional } from '@angular/core';\r\nimport { HttpClient, HttpErrorResponse } from '@angular/common/http';\r\n\r\nimport { BehaviorSubject, Observable, of, Subject } from 'rxjs';\r\nimport {\r\n  map,\r\n  tap,\r\n  catchError,\r\n  debounceTime,\r\n  mergeMap,\r\n  first,\r\n  skip\r\n} from 'rxjs/operators';\r\n\r\nimport olPoint from 'ol/geom/Point';\r\nimport GeoJSON from 'ol/format/GeoJSON';\r\nimport Cluster from 'ol/source/Cluster';\r\nimport olVectorSource from 'ol/source/Vector';\r\n\r\nimport { Tool } from '@igo2/common';\r\nimport { uuid, ObjectUtils } from '@igo2/utils';\r\nimport {\r\n  ConfigService,\r\n  RouteService,\r\n  Message,\r\n  MessageService,\r\n  LanguageService,\r\n  StorageService\r\n} from '@igo2/core';\r\n\r\nimport { AuthService } from '@igo2/auth';\r\nimport type { IgoMap, Layer } from '@igo2/geo';\r\n\r\nimport { TypePermission } from './context.enum';\r\nimport {\r\n  ContextsList,\r\n  ContextServiceOptions,\r\n  Context,\r\n  DetailedContext,\r\n  ContextMapView,\r\n  ContextPermission,\r\n  ContextProfils\r\n} from './context.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ContextService {\r\n  public context$ = new BehaviorSubject<DetailedContext>(undefined);\r\n  public contexts$ = new BehaviorSubject<ContextsList>({ ours: [] });\r\n  public defaultContextId$ = new BehaviorSubject<string>(undefined);\r\n  public editedContext$ = new BehaviorSubject<DetailedContext>(undefined);\r\n  public importedContext: Array<DetailedContext> = [];\r\n  public toolsChanged$ = new Subject<DetailedContext>();\r\n  private mapViewFromRoute: ContextMapView = {};\r\n  private options: ContextServiceOptions;\r\n  private baseUrl: string;\r\n\r\n  // Until the ContextService is completely refactored, this is needed\r\n  // to track the current tools\r\n  private tools: Tool[];\r\n  private toolbar: string[];\r\n\r\n  get defaultContextUri(): string {\r\n    return this.storageService.get('favorite.context.uri') as string || this._defaultContextUri || this.options.defaultContextUri;\r\n  }\r\n  set defaultContextUri(uri: string) {\r\n    this._defaultContextUri = uri;\r\n  }\r\n  private _defaultContextUri: string;\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private authService: AuthService,\r\n    private languageService: LanguageService,\r\n    private config: ConfigService,\r\n    private messageService: MessageService,\r\n    private storageService: StorageService,\r\n    @Optional() private route: RouteService\r\n  ) {\r\n    this.options = Object.assign(\r\n      {\r\n        basePath: 'contexts',\r\n        contextListFile: '_contexts.json',\r\n        defaultContextUri: '_default'\r\n      },\r\n      this.config.getConfig('context')\r\n    );\r\n\r\n    this.baseUrl = this.options.url;\r\n\r\n    this.readParamsFromRoute();\r\n\r\n    if (this.authService.hasAuthService) {\r\n      this.authService.logged$.subscribe((logged) => {\r\n        if (logged) {\r\n          this.contexts$.pipe(skip(1), first()).subscribe((c) => {\r\n            this.handleContextsChange();\r\n          });\r\n          this.loadContexts();\r\n        }\r\n      });\r\n    } else {\r\n      this.loadContexts();\r\n      this.handleContextsChange(false);\r\n    }\r\n  }\r\n\r\n  get(permissions?: string[], hidden?: boolean): Observable<ContextsList> {\r\n    let url = this.baseUrl + '/contexts';\r\n    if (permissions && this.authService.authenticated) {\r\n      url += '?permission=' + permissions.join();\r\n      if (hidden) {\r\n        url += '&hidden=true';\r\n      }\r\n    }\r\n    return this.http.get<ContextsList>(url);\r\n  }\r\n\r\n  getById(id: string): Observable<Context> {\r\n    const url = this.baseUrl + '/contexts/' + id;\r\n    return this.http.get<Context>(url);\r\n  }\r\n\r\n  getDetails(id: string): Observable<DetailedContext> {\r\n    const url = `${this.baseUrl}/contexts/${id}/details`;\r\n    return this.http.get<DetailedContext>(url).pipe(\r\n      catchError((res) => {\r\n        this.handleError(res, id);\r\n        throw res;\r\n      })\r\n    );\r\n  }\r\n\r\n  getDefault(): Observable<DetailedContext> {\r\n    if (this.authService.authenticated) {\r\n      const url = this.baseUrl + '/contexts/default';\r\n      return this.http.get<DetailedContext>(url).pipe(\r\n        tap((context) => {\r\n          this.defaultContextId$.next(context.id);\r\n        })\r\n      );\r\n    } else {\r\n      const uri = this.storageService.get('favorite.context.uri') as string;\r\n      this.defaultContextId$.next(uri);\r\n      return this.getContextByUri(uri);\r\n    }\r\n\r\n  }\r\n\r\n  getProfilByUser(): Observable<ContextProfils[]> {\r\n    if (this.baseUrl) {\r\n      const url = this.baseUrl + '/profils?';\r\n      return this.http.get<ContextProfils[]>(url);\r\n    }\r\n    return of([]);\r\n  }\r\n\r\n  setDefault(id: string): Observable<any> {\r\n    if (this.authService.authenticated) {\r\n      const url = this.baseUrl + '/contexts/default';\r\n      return this.http.post(url, { defaultContextId: id });\r\n    } else {\r\n      this.storageService.set('favorite.context.uri', id);\r\n      return of(undefined);\r\n    }\r\n  }\r\n\r\n  hideContext(id: string) {\r\n    const url = this.baseUrl + '/contexts/' + id + '/hide';\r\n    return this.http.post(url, {});\r\n  }\r\n\r\n  showContext(id: string) {\r\n    const url = this.baseUrl + '/contexts/' + id + '/show';\r\n    return this.http.post(url, {});\r\n  }\r\n\r\n  delete(id: string, imported = false): Observable<void> {\r\n    const contexts: ContextsList = { ours: [] };\r\n    Object.keys(this.contexts$.value).forEach(\r\n      (key) =>\r\n        (contexts[key] = this.contexts$.value[key].filter((c) => c.id !== id))\r\n    );\r\n\r\n    if (imported) {\r\n      this.importedContext = this.importedContext.filter((c) => c.id !== id);\r\n      return of(this.contexts$.next(contexts));\r\n    }\r\n\r\n    const url = this.baseUrl + '/contexts/' + id;\r\n    return this.http.delete<void>(url).pipe(\r\n      tap((res) => {\r\n        this.contexts$.next(contexts);\r\n      })\r\n    );\r\n  }\r\n\r\n  create(context: DetailedContext): Observable<Context> {\r\n    const url = this.baseUrl + '/contexts';\r\n    return this.http.post<Context>(url, context).pipe(\r\n      map((contextCreated) => {\r\n        if (this.authService.authenticated) {\r\n          contextCreated.permission = TypePermission[TypePermission.write];\r\n        } else {\r\n          contextCreated.permission = TypePermission[TypePermission.read];\r\n        }\r\n        this.contexts$.value.ours.unshift(contextCreated);\r\n        this.contexts$.next(this.contexts$.value);\r\n        return contextCreated;\r\n      })\r\n    );\r\n  }\r\n\r\n  clone(id: string, properties = {}): Observable<Context> {\r\n    const url = this.baseUrl + '/contexts/' + id + '/clone';\r\n    return this.http.post<Context>(url, properties).pipe(\r\n      map((contextCloned) => {\r\n        contextCloned.permission = TypePermission[TypePermission.write];\r\n        this.contexts$.value.ours.unshift(contextCloned);\r\n        this.contexts$.next(this.contexts$.value);\r\n        return contextCloned;\r\n      })\r\n    );\r\n  }\r\n\r\n  update(id: string, context: Context): Observable<Context> {\r\n    const url = this.baseUrl + '/contexts/' + id;\r\n    return this.http.patch<Context>(url, context);\r\n  }\r\n\r\n  // =================================================================\r\n\r\n  addToolAssociation(contextId: string, toolId: string): Observable<void> {\r\n    const url = `${this.baseUrl}/contexts/${contextId}/tools`;\r\n    const association = {\r\n      toolId\r\n    };\r\n    return this.http.post<void>(url, association);\r\n  }\r\n\r\n  deleteToolAssociation(contextId: string, toolId: string): Observable<any> {\r\n    const url = `${this.baseUrl}/contexts/${contextId}/tools/${toolId}`;\r\n    return this.http.delete(url);\r\n  }\r\n\r\n  getPermissions(id: string): Observable<ContextPermission[]> {\r\n    const url = this.baseUrl + '/contexts/' + id + '/permissions';\r\n    return this.http.get<ContextPermission[]>(url);\r\n  }\r\n\r\n  addPermissionAssociation(\r\n    contextId: string,\r\n    profil: string,\r\n    type: TypePermission\r\n  ): Observable<ContextPermission[]> {\r\n    const url = `${this.baseUrl}/contexts/${contextId}/permissions`;\r\n    const association = {\r\n      profil,\r\n      typePermission: type\r\n    };\r\n\r\n    return this.http.post<ContextPermission[]>(url, association).pipe(\r\n      catchError((res) => {\r\n        this.handleError(res, undefined, true);\r\n        throw [res]; // TODO Not sure about this.\r\n      })\r\n    );\r\n  }\r\n\r\n  deletePermissionAssociation(\r\n    contextId: string,\r\n    permissionId: string\r\n  ): Observable<void> {\r\n    const url = `${this.baseUrl}/contexts/${contextId}/permissions/${permissionId}`;\r\n    return this.http.delete<void>(url);\r\n  }\r\n\r\n  // ======================================================================\r\n\r\n  getLocalContexts(): Observable<ContextsList> {\r\n    const url = this.getPath(this.options.contextListFile);\r\n    return this.http.get<ContextsList>(url).pipe(\r\n      map((res: any) => {\r\n        return { ours: res };\r\n      })\r\n    );\r\n  }\r\n\r\n  getLocalContext(uri: string): Observable<DetailedContext> {\r\n    const url = this.getPath(`${uri}.json`);\r\n    return this.http.get<DetailedContext>(url).pipe(\r\n      mergeMap((res) => {\r\n        if (!res.base) {\r\n          return of(res);\r\n        }\r\n        const urlBase = this.getPath(`${res.base}.json`);\r\n        return this.http.get<DetailedContext>(urlBase).pipe(\r\n          map((resBase: DetailedContext) => {\r\n            const resMerge = res;\r\n            resMerge.map = ObjectUtils.mergeDeep(resBase.map, res.map);\r\n            resMerge.layers = (resBase.layers || [])\r\n              .concat(res.layers || [])\r\n              .reverse()\r\n              .filter(\r\n                (l, index, self) =>\r\n                  !l.id || self.findIndex((l2) => l2.id === l.id) === index\r\n              )\r\n              .reverse();\r\n            resMerge.toolbar = res.toolbar || resBase.toolbar;\r\n            resMerge.message = res.message || resBase.message;\r\n            resMerge.messages = res.messages || resBase.messages;\r\n            resMerge.tools = (res.tools || [])\r\n              .concat(resBase.tools || [])\r\n              .filter(\r\n                (t, index, self) =>\r\n                  self.findIndex((t2) => t2.name === t.name) === index\r\n              );\r\n            return resMerge;\r\n          }),\r\n          catchError((err) => {\r\n            this.handleError(err, uri);\r\n            throw err;\r\n          })\r\n        );\r\n      }),\r\n      catchError((err2) => {\r\n        this.handleError(err2, uri);\r\n        throw err2;\r\n      })\r\n    );\r\n  }\r\n\r\n  loadContexts(permissions?: string[], hidden?: boolean) {\r\n    let request;\r\n    if (this.baseUrl) {\r\n      request = this.get(permissions, hidden);\r\n    } else {\r\n      request = this.getLocalContexts();\r\n    }\r\n    request.subscribe((contexts) => {\r\n      contexts.ours = this.importedContext.concat(contexts.ours);\r\n      this.contexts$.next(contexts);\r\n    });\r\n  }\r\n\r\n  loadDefaultContext() {\r\n    const loadFct = (direct = false) => {\r\n      if (!direct && this.baseUrl && this.authService.authenticated) {\r\n        this.getDefault().subscribe(\r\n          (_context: DetailedContext) => {\r\n            this.defaultContextUri = _context.uri;\r\n            this.addContextToList(_context);\r\n            this.setContext(_context);\r\n          },\r\n          () => {\r\n            this.defaultContextId$.next(undefined);\r\n            this.loadContext(this.defaultContextUri);\r\n          }\r\n        );\r\n      } else {\r\n        this.loadContext(this.defaultContextUri);\r\n      }\r\n    };\r\n\r\n    if (this.route && this.route.options.contextKey) {\r\n      this.route.queryParams.pipe(debounceTime(100)).subscribe((params) => {\r\n        const contextParam = params[this.route.options.contextKey as string];\r\n        let direct = false;\r\n        if (contextParam) {\r\n          this.defaultContextUri = contextParam;\r\n          direct = true;\r\n        }\r\n        loadFct(direct);\r\n      });\r\n    } else {\r\n      loadFct();\r\n    }\r\n  }\r\n\r\n  loadContext(uri: string) {\r\n    const context = this.context$.value;\r\n\r\n    if (context && context.uri === uri) {\r\n      return;\r\n    }\r\n\r\n    this.getContextByUri(uri)\r\n      .pipe(first())\r\n      .subscribe(\r\n        (_context: DetailedContext) => {\r\n          this.addContextToList(_context);\r\n          this.setContext(_context);\r\n        },\r\n        (err) => {\r\n          if (uri !== this.options.defaultContextUri) {\r\n            this.loadContext(this.options.defaultContextUri);\r\n          }\r\n        }\r\n      );\r\n  }\r\n\r\n  setContext(context: DetailedContext) {\r\n    this.handleContextMessage(context);\r\n    const currentContext = this.context$.value;\r\n    if (currentContext && context && context.id === currentContext.id) {\r\n      if (context.map.view.keepCurrentView === undefined) {\r\n        context.map.view.keepCurrentView = true;\r\n      }\r\n      this.context$.next(context);\r\n      return;\r\n    }\r\n\r\n    if (!context.map) {\r\n      context.map = { view: {} };\r\n    }\r\n\r\n    Object.assign(context.map.view, this.mapViewFromRoute);\r\n\r\n    this.context$.next(context);\r\n  }\r\n\r\n  loadEditedContext(uri: string) {\r\n    this.getContextByUri(uri).subscribe((_context: DetailedContext) => {\r\n      this.setEditedContext(_context);\r\n    });\r\n  }\r\n\r\n  setEditedContext(context: DetailedContext) {\r\n    this.editedContext$.next(context);\r\n  }\r\n\r\n  getContextFromMap(igoMap: IgoMap, empty?: boolean): DetailedContext {\r\n    const view = igoMap.ol.getView();\r\n    const proj = view.getProjection().getCode();\r\n    const center: any = new olPoint(view.getCenter()).transform(\r\n      proj,\r\n      'EPSG:4326'\r\n    );\r\n\r\n    const context = {\r\n      uri: uuid(),\r\n      title: '',\r\n      scope: 'private',\r\n      map: {\r\n        view: {\r\n          center: center.getCoordinates(),\r\n          zoom: view.getZoom(),\r\n          projection: proj,\r\n          maxZoomOnExtent: igoMap.viewController.maxZoomOnExtent\r\n        }\r\n      },\r\n      layers: [],\r\n      tools: []\r\n    };\r\n\r\n    let layers = [];\r\n    if (empty === true) {\r\n      layers = igoMap.layers$\r\n        .getValue()\r\n        .filter(\r\n          (lay) =>\r\n            lay.baseLayer === true ||\r\n            lay.options.id === 'searchPointerSummaryId'\r\n        )\r\n        .sort((a, b) => a.zIndex - b.zIndex);\r\n    } else {\r\n      layers = igoMap.layers$.getValue().filter(lay => !lay.id.includes('WfsWorkspaceTableDest')).sort((a, b) => a.zIndex - b.zIndex);\r\n    }\r\n\r\n    let i = 0;\r\n    for (const l of layers) {\r\n      const layer: any = l;\r\n      const opts = {\r\n        id: layer.options.id ? String(layer.options.id) : undefined,\r\n        layerOptions: {\r\n          title: layer.options.title,\r\n          zIndex: ++i,\r\n          visible: layer.visible\r\n        },\r\n        sourceOptions: {\r\n          type: layer.dataSource.options.type,\r\n          params: layer.dataSource.options.params,\r\n          url: layer.dataSource.options.url,\r\n          queryable: layer.queryable\r\n        }\r\n      };\r\n      if (opts.sourceOptions.type) {\r\n        context.layers.push(opts);\r\n      }\r\n    }\r\n\r\n    context.tools = this.tools.map((tool) => {\r\n      return { id: String(tool.id), global: tool.global };\r\n    });\r\n\r\n    return context;\r\n  }\r\n\r\n  getContextFromLayers(\r\n    igoMap: IgoMap,\r\n    layers: Layer[],\r\n    name: string\r\n  ): DetailedContext {\r\n    const currentContext = this.context$.getValue();\r\n    const view = igoMap.ol.getView();\r\n    const proj = view.getProjection().getCode();\r\n    const center: any = new olPoint(view.getCenter()).transform(\r\n      proj,\r\n      'EPSG:4326'\r\n    );\r\n\r\n    const context = {\r\n      uri: name,\r\n      title: name,\r\n      map: {\r\n        view: {\r\n          center: center.getCoordinates(),\r\n          zoom: view.getZoom(),\r\n          projection: proj\r\n        }\r\n      },\r\n      layers: [],\r\n      toolbar: [],\r\n      tools: [],\r\n      extraFeatures: []\r\n    };\r\n\r\n    const currentLayers = igoMap.layers$.getValue();\r\n    context.layers = currentLayers\r\n      .filter((l) => l.baseLayer)\r\n      .map((l) => {\r\n        return {\r\n          baseLayer: true,\r\n          sourceOptions: l.options.sourceOptions,\r\n          title: l.options.title,\r\n          visible: l.visible\r\n        };\r\n      });\r\n\r\n    layers.forEach((layer) => {\r\n      const layerFound = currentContext.layers.find(\r\n        (contextLayer) => {\r\n          const source = contextLayer.source;\r\n          return source && layer.id === source.id && !contextLayer.baseLayer;\r\n        });\r\n\r\n      if (layerFound) {\r\n        let layerStyle = layerFound[`style`];\r\n        if (layerFound[`styleByAttribute`]) {\r\n          layerStyle = undefined;\r\n        } else if (layerFound[`clusterBaseStyle`]) {\r\n          layerStyle = undefined;\r\n          delete layerFound.sourceOptions[`source`];\r\n          delete layerFound.sourceOptions[`format`];\r\n        }\r\n        const opts = {\r\n          baseLayer: layerFound.baseLayer,\r\n          title: layer.options.title,\r\n          zIndex: layer.zIndex,\r\n          styleByAttribute: layerFound[`styleByAttribute`],\r\n          clusterBaseStyle: layerFound[`clusterBaseStyle`],\r\n          style: layerStyle,\r\n          clusterParam: layerFound[`clusterParam`],\r\n          visible: layer.visible,\r\n          opacity: layer.opacity,\r\n          sourceOptions: layerFound.sourceOptions\r\n        };\r\n        context.layers.push(opts);\r\n      } else {\r\n        if (!(layer.ol.getSource() instanceof olVectorSource)) {\r\n          const catalogLayer = layer.options;\r\n          catalogLayer.zIndex = layer.zIndex;\r\n          delete catalogLayer.source;\r\n          context.layers.push(catalogLayer);\r\n        } else {\r\n          let features;\r\n          const writer = new GeoJSON();\r\n          if (layer.ol.getSource() instanceof Cluster) {\r\n            const clusterSource = layer.ol.getSource() as Cluster;\r\n            features = writer.writeFeatures(\r\n              clusterSource.getFeatures(),\r\n              {\r\n                dataProjection: 'EPSG:4326',\r\n                featureProjection: 'EPSG:3857'\r\n              }\r\n            );\r\n          } else {\r\n            const source = layer.ol.getSource() as any;\r\n            features = writer.writeFeatures(\r\n              source.getFeatures(),\r\n              {\r\n                dataProjection: 'EPSG:4326',\r\n                featureProjection: 'EPSG:3857'\r\n              }\r\n            );\r\n          }\r\n          features = JSON.parse(features);\r\n          features.name = layer.options.title;\r\n          context.extraFeatures.push(features);\r\n        }\r\n      }\r\n    });\r\n\r\n    context.toolbar = this.toolbar;\r\n    context.tools = this.tools;\r\n\r\n    return context;\r\n  }\r\n\r\n  setTools(tools: Tool[]) {\r\n    this.tools = tools;\r\n  }\r\n\r\n  setToolbar(toolbar: string[]) {\r\n    this.toolbar = toolbar;\r\n  }\r\n\r\n  private handleContextMessage(context: DetailedContext) {\r\n    if (this.context$.value && context.uri && this.context$.value.uri !== context.uri) {\r\n      this.messageService.removeAllAreNotError();\r\n    }\r\n\r\n    context.messages = context.messages ? context.messages : [];\r\n    context.messages.push(context.message);\r\n    context.messages.map(message => {\r\n      if (message) {\r\n        this.messageService.message(message as Message);\r\n      }\r\n    });\r\n  }\r\n\r\n  private getContextByUri(uri: string): Observable<DetailedContext> {\r\n    if (this.baseUrl) {\r\n      let contextToLoad;\r\n      for (const key of Object.keys(this.contexts$.value)) {\r\n        contextToLoad = this.contexts$.value[key].find((c) => {\r\n          return c.uri === uri;\r\n        });\r\n        if (contextToLoad) {\r\n          break;\r\n        }\r\n      }\r\n\r\n      if (contextToLoad && contextToLoad.imported) {\r\n        return of(contextToLoad);\r\n      }\r\n\r\n      // TODO : use always id or uri\r\n      const id = contextToLoad ? contextToLoad.id : uri;\r\n      return this.getDetails(id);\r\n    }\r\n\r\n    const importedContext = this.contexts$.value.ours.find((currentContext) => {\r\n      return currentContext.uri === uri && currentContext.imported === true;\r\n    });\r\n\r\n    if (importedContext) {\r\n      return of(importedContext);\r\n    } else {\r\n      return this.getLocalContext(uri);\r\n    }\r\n  }\r\n\r\n  getContextLayers(igoMap: IgoMap) {\r\n    const layers: Layer[] = [];\r\n    const mapLayers = igoMap.layers$.getValue();\r\n    mapLayers.forEach((layer) => {\r\n      if (!layer.baseLayer && layer.options.id !== 'searchPointerSummaryId') {\r\n        layers.push(layer);\r\n      }\r\n    });\r\n    return layers;\r\n  }\r\n\r\n  private readParamsFromRoute() {\r\n    if (!this.route) {\r\n      return;\r\n    }\r\n\r\n    this.route.queryParams.subscribe((params) => {\r\n      const centerKey = this.route.options.centerKey;\r\n      if (centerKey && params[centerKey as string]) {\r\n        const centerParams = params[centerKey as string];\r\n        this.mapViewFromRoute.center = centerParams.split(',').map(Number);\r\n      }\r\n\r\n      const projectionKey = this.route.options.projectionKey;\r\n      if (projectionKey && params[projectionKey as string]) {\r\n        const projectionParam = params[projectionKey as string];\r\n        this.mapViewFromRoute.projection = projectionParam;\r\n      }\r\n\r\n      const zoomKey = this.route.options.zoomKey;\r\n      if (zoomKey && params[zoomKey as string]) {\r\n        const zoomParam = params[zoomKey as string];\r\n        this.mapViewFromRoute.zoom = Number(zoomParam);\r\n      }\r\n    });\r\n  }\r\n\r\n  private getPath(file: string) {\r\n    const basePath = this.options.basePath.replace(/\\/$/, '');\r\n\r\n    return `${basePath}/${file}`;\r\n  }\r\n\r\n  private handleError(\r\n    error: HttpErrorResponse,\r\n    uri: string,\r\n    permissionError?: boolean\r\n  ) {\r\n    const context = this.contexts$.value.ours.find((obj) => obj.uri === uri);\r\n    const titleContext = context ? context.title : uri;\r\n    error.error.title = this.languageService.translate.instant(\r\n      'igo.context.contextManager.invalid.title'\r\n    );\r\n\r\n    error.error.message = this.languageService.translate.instant(\r\n      'igo.context.contextManager.invalid.text',\r\n      { value: titleContext }\r\n    );\r\n\r\n    error.error.toDisplay = true;\r\n\r\n    if (permissionError) {\r\n      error.error.title = this.languageService.translate.instant(\r\n        'igo.context.contextManager.errors.addPermissionTitle'\r\n      );\r\n      error.error.message = this.languageService.translate.instant(\r\n        'igo.context.contextManager.errors.addPermission'\r\n      );\r\n    }\r\n    this.messageService.error(error.error.message, error.error.title);\r\n  }\r\n\r\n  private handleContextsChange(\r\n    keepCurrentContext = true\r\n  ) {\r\n    const context = this.context$.value;\r\n    const editedContext = this.editedContext$.value;\r\n    if (!context || context.uri === this.options.defaultContextUri) {\r\n      keepCurrentContext = false;\r\n    }\r\n    if (!keepCurrentContext || !this.findContext(context)) {\r\n      this.defaultContextUri = undefined;\r\n      this.loadDefaultContext();\r\n    } else {\r\n      this.getContextByUri(context.uri)\r\n        .pipe(first())\r\n        .subscribe(\r\n          (newContext: DetailedContext) => {\r\n            this.toolsChanged$.next(newContext);\r\n          }\r\n        );\r\n\r\n      if (this.baseUrl && this.authService.authenticated) {\r\n        this.getDefault().subscribe();\r\n      }\r\n    }\r\n    const editedFound = this.findContext(editedContext);\r\n    if (!editedFound || editedFound.permission !== 'write') {\r\n      this.setEditedContext(undefined);\r\n    }\r\n  }\r\n\r\n  private addContextToList(context: Context) {\r\n    const contextFound = this.findContext(context);\r\n    if (!contextFound) {\r\n      const contextSimplifie = {\r\n        id: context.id,\r\n        uri: context.uri,\r\n        title: context.title,\r\n        scope: context.scope,\r\n        permission: TypePermission[TypePermission.read]\r\n      };\r\n\r\n      if (this.contexts$.value && this.contexts$.value.public) {\r\n        this.contexts$.value.public.push(contextSimplifie);\r\n        this.contexts$.next(this.contexts$.value);\r\n      }\r\n    }\r\n  }\r\n\r\n  private findContext(context: Context) {\r\n    if (!context) {\r\n      return false;\r\n    }\r\n\r\n    const contexts = this.contexts$.value;\r\n    let found;\r\n    for (const key of Object.keys(contexts)) {\r\n      const value = contexts[key];\r\n      found = value.find(\r\n        (c) =>\r\n          (context.id && c.id === context.id) ||\r\n          (context.uri && c.uri === context.uri)\r\n      );\r\n      if (found) {\r\n        break;\r\n      }\r\n    }\r\n\r\n    return found;\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatButtonToggleModule } from '@angular/material/button-toggle';\r\nimport { MatOptionModule } from '@angular/material/core';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatDividerModule } from '@angular/material/divider';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatTabsModule } from '@angular/material/tabs';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { ContextImportExportComponent } from './context-import-export/context-import-export.component';\r\nimport { IgoSpinnerModule } from '@igo2/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\n\r\n@NgModule({\r\n  imports: [\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    CommonModule,\r\n    MatButtonModule,\r\n    MatButtonToggleModule,\r\n    MatDividerModule,\r\n    MatTabsModule,\r\n    MatSelectModule,\r\n    MatOptionModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatCheckboxModule,\r\n    IgoLanguageModule,\r\n    IgoSpinnerModule,\r\n    MatTooltipModule,\r\n  ],\r\n  exports: [\r\n    ContextImportExportComponent\r\n  ],\r\n  declarations: [\r\n    ContextImportExportComponent\r\n  ]\r\n})\r\nexport class IgoContextImportExportModule {\r\n  static forRoot(): ModuleWithProviders<IgoContextImportExportModule> {\r\n    return {\r\n      ngModule: IgoContextImportExportModule\r\n    };\r\n  }\r\n}\r\n","import { Directive, OnInit, OnDestroy } from '@angular/core';\r\n\r\nimport { Subscription } from 'rxjs';\r\nimport { filter } from 'rxjs/operators';\r\n\r\nimport { MapViewOptions, MapBrowserComponent, MapControlsOptions, MapScaleLineOptions } from '@igo2/geo';\r\nimport type { IgoMap } from '@igo2/geo';\r\n\r\nimport { ContextService } from './context.service';\r\nimport { DetailedContext, ContextMapView } from './context.interface';\r\nimport { MediaService } from '@igo2/core';\r\n\r\n@Directive({\r\n  selector: '[igoMapContext]'\r\n})\r\nexport class MapContextDirective implements OnInit, OnDestroy {\r\n  private component: MapBrowserComponent;\r\n  private context$$: Subscription;\r\n\r\n  get map(): IgoMap {\r\n    return this.component.map;\r\n  }\r\n\r\n  constructor(\r\n    component: MapBrowserComponent,\r\n    private contextService: ContextService,\r\n    private mediaService: MediaService\r\n  ) {\r\n    this.component = component;\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.context$$ = this.contextService.context$\r\n      .pipe(filter(context => context !== undefined))\r\n      .subscribe(context => this.handleContextChange(context));\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.context$$.unsubscribe();\r\n  }\r\n\r\n  private handleContextChange(context: DetailedContext) {\r\n    if (context.map === undefined) {\r\n      return;\r\n    }\r\n\r\n    // This creates a new ol.Map when the context changes. Doing that\r\n    // allows the print tool to work properly even when the map's canvas\r\n    // has been tainted (CORS) with the layers of another context. This could\r\n    // have some side effects such as unbinding all listeners on the first map.\r\n    // A better solution would be to create a new map (preview) before\r\n    // printing and avoid the tainted canvas issue. This will come later so\r\n    // this snippet of code is kept here in case it takes too long becomes\r\n    // an issue\r\n\r\n    // const target = this.component.map.ol.getTarget();\r\n    // this.component.map.ol.setTarget(undefined);\r\n    // this.component.map.init();\r\n    // this.component.map.ol.setTarget(target);\r\n\r\n    const viewContext: ContextMapView = context.map.view;\r\n    if (!this.component.view || viewContext.keepCurrentView !== true) {\r\n      this.component.view = viewContext as MapViewOptions;\r\n    }\r\n    if (this.component.map.geolocationController) {\r\n      this.component.map.geolocationController.updateGeolocationOptions(viewContext);\r\n    }\r\n\r\n    const controlsContext: MapControlsOptions = context.map.controls;\r\n    if (!this.component.controls && controlsContext) {\r\n      if (this.mediaService.isMobile()) {\r\n        if (typeof(controlsContext.scaleLine) !== 'boolean') {\r\n          const scaleLineOption = controlsContext.scaleLine as MapScaleLineOptions;\r\n          if (!scaleLineOption.minWidth) {\r\n            scaleLineOption.minWidth = Math.min(64, scaleLineOption.minWidth);\r\n            controlsContext.scaleLine = scaleLineOption;\r\n          }\r\n        }\r\n      }\r\n      this.component.controls = controlsContext;\r\n    }\r\n  }\r\n}\r\n","import { Directive, OnInit, OnDestroy, Optional, Input } from '@angular/core';\r\n\r\nimport { Subscription, merge } from 'rxjs';\r\nimport { buffer, debounceTime, filter } from 'rxjs/operators';\r\n\r\nimport { RouteService, ConfigService } from '@igo2/core';\r\nimport {\r\n  MapBrowserComponent,\r\n  Layer,\r\n  LayerService,\r\n  LayerOptions,\r\n  StyleListService,\r\n  StyleService\r\n} from '@igo2/geo';\r\nimport type { IgoMap } from '@igo2/geo';\r\n\r\nimport { ContextService } from './context.service';\r\nimport { DetailedContext } from './context.interface';\r\nimport {\r\n  addImportedFeaturesToMap,\r\n  addImportedFeaturesStyledToMap\r\n} from '../../context-import-export/shared/context-import.utils';\r\nimport GeoJSON from 'ol/format/GeoJSON';\r\n\r\n@Directive({\r\n  selector: '[igoLayerContext]'\r\n})\r\nexport class LayerContextDirective implements OnInit, OnDestroy {\r\n  private context$$: Subscription;\r\n  private queryParams: any;\r\n\r\n  private contextLayers: Layer[] = [];\r\n\r\n  @Input() removeLayersOnContextChange: boolean = true;\r\n\r\n  get map(): IgoMap {\r\n    return this.component.map;\r\n  }\r\n\r\n  constructor(\r\n    private component: MapBrowserComponent,\r\n    private contextService: ContextService,\r\n    private layerService: LayerService,\r\n    private configService: ConfigService,\r\n    private styleListService: StyleListService,\r\n    private styleService: StyleService,\r\n    @Optional() private route: RouteService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.context$$ = this.contextService.context$\r\n      .pipe(filter((context) => context !== undefined))\r\n      .subscribe((context) => this.handleContextChange(context));\r\n\r\n    if (\r\n      this.route &&\r\n      this.route.options.visibleOnLayersKey &&\r\n      this.route.options.visibleOffLayersKey &&\r\n      this.route.options.contextKey\r\n    ) {\r\n      const queryParams$$ = this.route.queryParams.subscribe((params) => {\r\n        if (Object.keys(params).length > 0) {\r\n          this.queryParams = params;\r\n          queryParams$$.unsubscribe();\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.context$$.unsubscribe();\r\n  }\r\n\r\n  private handleContextChange(context: DetailedContext) {\r\n    if (context.layers === undefined) {\r\n      return;\r\n    }\r\n    if (this.removeLayersOnContextChange === true) {\r\n      this.map.removeAllLayers();\r\n    } else {\r\n      this.map.removeLayers(this.contextLayers);\r\n    }\r\n    this.contextLayers = [];\r\n\r\n    const layersAndIndex$ = merge(\r\n      ...context.layers.map((layerOptions: LayerOptions, index: number) => {\r\n        return this.layerService.createAsyncLayer(layerOptions, context.uri);\r\n      })\r\n    );\r\n\r\n    layersAndIndex$\r\n      .pipe(buffer(layersAndIndex$.pipe(debounceTime(500))))\r\n      .subscribe((layers: Layer[]) => {\r\n        layers = layers\r\n          .filter((layer: Layer) => layer !== undefined)\r\n          .map((layer) => {\r\n            layer.visible = this.computeLayerVisibilityFromUrl(layer);\r\n            layer.zIndex = layer.zIndex;\r\n\r\n            return layer;\r\n          });\r\n\r\n        this.contextLayers.concat(layers);\r\n        this.map.addLayers(layers);\r\n\r\n        if (context.extraFeatures) {\r\n          context.extraFeatures.forEach((featureCollection) => {\r\n            const format = new GeoJSON();\r\n            const title = featureCollection.name;\r\n            featureCollection = JSON.stringify(featureCollection);\r\n            featureCollection = format.readFeatures(featureCollection, {\r\n              dataProjection: 'EPSG:4326',\r\n              featureProjection: 'EPSG:3857'\r\n            });\r\n            if (!this.configService.getConfig('importWithStyle')) {\r\n              addImportedFeaturesToMap(featureCollection, this.map, title);\r\n            } else {\r\n              addImportedFeaturesStyledToMap(\r\n                featureCollection,\r\n                this.map,\r\n                title,\r\n                this.styleListService,\r\n                this.styleService\r\n              );\r\n            }\r\n          });\r\n        }\r\n      });\r\n  }\r\n\r\n  private computeLayerVisibilityFromUrl(layer: Layer): boolean {\r\n    const params = this.queryParams;\r\n    const currentContext = this.contextService.context$.value.uri;\r\n    const currentLayerid: string = layer.id;\r\n\r\n    let visible = layer.visible;\r\n    if (!params || !currentLayerid) {\r\n      return visible;\r\n    }\r\n\r\n    const contextParams = params[this.route.options.contextKey as string];\r\n    if (contextParams === currentContext || !contextParams) {\r\n      let visibleOnLayersParams = '';\r\n      let visibleOffLayersParams = '';\r\n      let visiblelayers: string[] = [];\r\n      let invisiblelayers: string[] = [];\r\n\r\n      if (\r\n        this.route.options.visibleOnLayersKey &&\r\n        params[this.route.options.visibleOnLayersKey as string]\r\n      ) {\r\n        visibleOnLayersParams =\r\n          params[this.route.options.visibleOnLayersKey as string];\r\n      }\r\n      if (\r\n        this.route.options.visibleOffLayersKey &&\r\n        params[this.route.options.visibleOffLayersKey as string]\r\n      ) {\r\n        visibleOffLayersParams =\r\n          params[this.route.options.visibleOffLayersKey as string];\r\n      }\r\n\r\n      /* This order is important because to control whichever\r\n       the order of * param. First whe open and close everything.*/\r\n      if (visibleOnLayersParams === '*') {\r\n        visible = true;\r\n      }\r\n      if (visibleOffLayersParams === '*') {\r\n        visible = false;\r\n      }\r\n\r\n      // After, managing named layer by id (context.json OR id from datasource)\r\n      visiblelayers = visibleOnLayersParams.split(',');\r\n      invisiblelayers = visibleOffLayersParams.split(',');\r\n      if (visiblelayers.indexOf(currentLayerid) > -1 || visiblelayers.indexOf(currentLayerid.toString()) > -1) {\r\n        visible = true;\r\n      }\r\n      if (invisiblelayers.indexOf(currentLayerid) > -1 || invisiblelayers.indexOf(currentLayerid.toString()) > -1) {\r\n        visible = false;\r\n      }\r\n    }\r\n\r\n    return visible;\r\n  }\r\n}\r\n","import * as olStyle from 'ol/style';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport {\r\n  FeatureDataSource,\r\n  FeatureDataSourceOptions,\r\n  IgoMap,\r\n  VectorLayer,\r\n  QueryableDataSourceOptions,\r\n  StyleService,\r\n  StyleListService,\r\n  StyleByAttribute,\r\n  ClusterParam,\r\n  ClusterDataSourceOptions,\r\n  ClusterDataSource\r\n} from '@igo2/geo';\r\nimport { MessageService, LanguageService } from '@igo2/core';\r\nimport { DetailedContext } from '../../context-manager/shared/context.interface';\r\nimport { ContextService } from '../../context-manager/shared/context.service';\r\nimport OlFeature from 'ol/Feature';\r\n\r\nexport function handleFileImportSuccess(\r\n  file: File,\r\n  context: DetailedContext,\r\n  messageService: MessageService,\r\n  languageService: LanguageService,\r\n  contextService: ContextService\r\n) {\r\n  if (Object.keys(context).length <= 0) {\r\n    handleNothingToImportError(file, messageService, languageService);\r\n    return;\r\n  }\r\n\r\n  const contextTitle = computeLayerTitleFromFile(file);\r\n\r\n  addContextToContextList(context, contextTitle, contextService);\r\n\r\n  const translate = languageService.translate;\r\n  const messageTitle = translate.instant(\r\n    'igo.context.contextImportExport.import.success.title'\r\n  );\r\n  const message = translate.instant(\r\n    'igo.context.contextImportExport.import.success.text',\r\n    {\r\n      value: contextTitle\r\n    }\r\n  );\r\n  messageService.success(message, messageTitle);\r\n}\r\n\r\nexport function handleFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService,\r\n  sizeMb?: number\r\n) {\r\n  sizeMb = sizeMb ? sizeMb : 30;\r\n  const errMapping = {\r\n    'Invalid file': handleInvalidFileImportError,\r\n    'File is too large': handleSizeFileImportError,\r\n    'Failed to read file': handleUnreadbleFileImportError\r\n  };\r\n  errMapping[error.message](\r\n    file,\r\n    error,\r\n    messageService,\r\n    languageService,\r\n    sizeMb\r\n  );\r\n}\r\n\r\nexport function handleInvalidFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant(\r\n    'igo.context.contextImportExport.import.invalid.title'\r\n  );\r\n  const message = translate.instant(\r\n    'igo.context.contextImportExport.import.invalid.text',\r\n    {\r\n      value: file.name,\r\n      mimeType: file.type\r\n    }\r\n  );\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function handleSizeFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService,\r\n  sizeMb: number\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant(\r\n    'igo.context.contextImportExport.import.tooLarge.title'\r\n  );\r\n  const message = translate.instant(\r\n    'igo.context.contextImportExport.import.tooLarge.text',\r\n    {\r\n      value: file.name,\r\n      size: sizeMb\r\n    }\r\n  );\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function handleUnreadbleFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant(\r\n    'igo.context.contextImportExport.import.unreadable.title'\r\n  );\r\n  const message = translate.instant(\r\n    'igo.context.contextImportExport.import.unreadable.text',\r\n    {\r\n      value: file.name\r\n    }\r\n  );\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function handleNothingToImportError(\r\n  file: File,\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant(\r\n    'igo.context.contextImportExport.import.empty.title'\r\n  );\r\n  const message = translate.instant(\r\n    'igo.context.contextImportExport.import.empty.text',\r\n    {\r\n      value: file.name\r\n    }\r\n  );\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function addContextToContextList(\r\n  context: DetailedContext,\r\n  contextTitle: string,\r\n  contextService: ContextService\r\n) {\r\n  context.title = contextTitle;\r\n  context.imported = true;\r\n  contextService.contexts$.value.ours.unshift(context);\r\n  contextService.contexts$.next(contextService.contexts$.value);\r\n  contextService.importedContext.unshift(context);\r\n  contextService.loadContext(context.uri);\r\n}\r\n\r\nexport function getFileExtension(file: File): string {\r\n  return file.name.split('.').pop().toLowerCase();\r\n}\r\n\r\nexport function computeLayerTitleFromFile(file: File): string {\r\n  return file.name.substr(0, file.name.lastIndexOf('.'));\r\n}\r\n\r\nexport function addImportedFeaturesToMap(\r\n  olFeatures: OlFeature<OlGeometry>[],\r\n  map: IgoMap,\r\n  layerTitle: string\r\n): VectorLayer {\r\n  const r = Math.floor(Math.random() * 255);\r\n  const g = Math.floor(Math.random() * 255);\r\n  const b = Math.floor(Math.random() * 255);\r\n  const stroke = new olStyle.Stroke({\r\n    color: [r, g, b, 1],\r\n    width: 2\r\n  });\r\n\r\n  const fill = new olStyle.Fill({\r\n    color: [r, g, b, 0.4]\r\n  });\r\n  const sourceOptions: FeatureDataSourceOptions & QueryableDataSourceOptions = {\r\n    type: 'vector',\r\n    queryable: true\r\n  };\r\n  const source = new FeatureDataSource(sourceOptions);\r\n  source.ol.addFeatures(olFeatures);\r\n  const layer = new VectorLayer({\r\n    title: layerTitle,\r\n    isIgoInternalLayer: true,\r\n    source,\r\n    style: new olStyle.Style({\r\n      stroke,\r\n      fill,\r\n      image: new olStyle.Circle({\r\n        radius: 5,\r\n        stroke,\r\n        fill\r\n      })\r\n    })\r\n  });\r\n  map.addLayer(layer);\r\n\r\n  return layer;\r\n}\r\n\r\nexport function addImportedFeaturesStyledToMap(\r\n  olFeatures: OlFeature<OlGeometry>[],\r\n  map: IgoMap,\r\n  layerTitle: string,\r\n  styleListService: StyleListService,\r\n  styleService: StyleService\r\n): VectorLayer {\r\n  let style;\r\n  let distance: number;\r\n\r\n  if (\r\n    styleListService.getStyleList(layerTitle.toString() + '.styleByAttribute')\r\n  ) {\r\n    const styleByAttribute: StyleByAttribute = styleListService.getStyleList(\r\n      layerTitle.toString() + '.styleByAttribute'\r\n    );\r\n\r\n    style = (feature, resolution) => {\r\n      return styleService.createStyleByAttribute(feature, styleByAttribute, resolution);\r\n    };\r\n  } else if (\r\n    styleListService.getStyleList(layerTitle.toString() + '.clusterStyle')\r\n  ) {\r\n    const clusterParam: ClusterParam = styleListService.getStyleList(\r\n      layerTitle.toString() + '.clusterParam'\r\n    );\r\n    distance = styleListService.getStyleList(\r\n      layerTitle.toString() + '.distance'\r\n    );\r\n\r\n    style = (feature, resolution) => {\r\n      const baseStyle = styleService.createStyle(\r\n        styleListService.getStyleList(layerTitle.toString() + '.clusterStyle'), feature, resolution\r\n      );\r\n      return styleService.createClusterStyle(feature, resolution, clusterParam, baseStyle);\r\n    };\r\n  } else if (styleListService.getStyleList(layerTitle.toString() + '.style')) {\r\n    style = (feature, resolution) => styleService.createStyle(\r\n      styleListService.getStyleList(layerTitle.toString() + '.style'), feature, resolution\r\n    );\r\n  } else {\r\n    style = (feature, resolution) => styleService.createStyle(\r\n      styleListService.getStyleList('default.style'), feature, resolution\r\n    );\r\n  }\r\n  let source;\r\n\r\n  if (styleListService.getStyleList(layerTitle.toString() + '.clusterStyle')) {\r\n    const sourceOptions: ClusterDataSourceOptions &\r\n      QueryableDataSourceOptions = {\r\n      distance,\r\n      type: 'cluster',\r\n      queryable: true\r\n    };\r\n    source = new ClusterDataSource(sourceOptions);\r\n    source.ol.source.addFeatures(olFeatures);\r\n  } else {\r\n    const sourceOptions: FeatureDataSourceOptions &\r\n      QueryableDataSourceOptions = {\r\n      type: 'vector',\r\n      queryable: true\r\n    };\r\n    source = new FeatureDataSource(sourceOptions);\r\n    source.ol.addFeatures(olFeatures);\r\n  }\r\n\r\n  const layer = new VectorLayer({\r\n    title: layerTitle,\r\n    isIgoInternalLayer: true,\r\n    source,\r\n    style\r\n  });\r\n  map.addLayer(layer);\r\n\r\n  return layer;\r\n}\r\n","export enum ContextListControlsEnum {\r\n  always = 'always',\r\n  never = 'never',\r\n  default = 'default'\r\n}\r\n","import { Component } from '@angular/core';\r\nimport { MatDialogRef } from '@angular/material/dialog';\r\n\r\n@Component({\r\n  selector: 'igo-bookmark-dialog',\r\n  templateUrl: './bookmark-dialog.component.html'\r\n})\r\nexport class BookmarkDialogComponent {\r\n  public title: string;\r\n\r\n  constructor(public dialogRef: MatDialogRef<BookmarkDialogComponent>) {}\r\n}\r\n","<h1 mat-dialog-title class=\"mat-typography\">{{ 'igo.context.bookmarkButton.dialog.title' |translate }}</h1>\r\n<div mat-dialog-content class=\"mat-typography\">\r\n  <mat-form-field>\r\n    <input matInput required autocomplete=\"off\"\r\n      maxlength=\"128\"\r\n      [placeholder]=\"'igo.context.bookmarkButton.dialog.placeholder' |translate\"\r\n      [(ngModel)]=\"title\">\r\n  </mat-form-field>\r\n</div>\r\n<div mat-dialog-actions>\r\n  <button mat-button color=\"primary\"\r\n         [disabled]=\"!title\"\r\n         (click)=\"dialogRef.close(title)\">\r\n    {{'igo.common.confirmDialog.confirmBtn' | translate}}\r\n  </button>\r\n  <button mat-button\r\n          (click)=\"dialogRef.close(false)\">\r\n    {{'igo.common.confirmDialog.cancelBtn' |translate}}\r\n  </button>\r\n</div>\r\n","<mat-list-item\r\n  class=\"mat-list-item\"\r\n  [ngClass]=\"{'mat-list-item-light': hidden}\">\r\n  <button mat-list-avatar\r\n    *ngIf=\"auth.authenticated\"\r\n    mat-icon-button\r\n    igoStopPropagation\r\n    [matTooltip]=\"auth.authenticated ? ('igo.context.contextManager.favorite' | translate) : ''\"\r\n    matTooltipShowDelay=\"500\"\r\n    [color]=\"default ? 'primary' : 'default'\"\r\n    (click)=\"favoriteClick(context)\">\r\n    <mat-icon *ngIf=\"!context.iconImage\" svgIcon=\"{{context.icon ? context.icon : context.scope === 'public' ? 'earth' : 'star'}}\"></mat-icon>\r\n    <img *ngIf=\"context.iconImage\" [src]=\"context.iconImage\">\r\n  </button>\r\n  <button mat-list-avatar\r\n    *ngIf=\"!auth.authenticated && showFavorite\"\r\n    mat-icon-button\r\n    igoStopPropagation\r\n    [matTooltip]=\"'igo.context.contextManager.favorite' | translate\"\r\n    matTooltipShowDelay=\"500\"\r\n    [color]=\"default ? 'primary' : 'default'\"\r\n    (click)=\"favoriteClick(context)\">\r\n    <mat-icon svgIcon=\"star\"></mat-icon>\r\n  </button>\r\n  <h4 matLine>{{context.title}}</h4>\r\n\r\n  <div *ngIf=\"auth.authenticated\"\r\n       igoStopPropagation\r\n       class=\"igo-actions-container\">\r\n\r\n     <button *ngIf=\"collapsed && selected && (context.permission === typePermission[typePermission.write] || context.imported)\"\r\n       class=\"save-button\"\r\n       mat-icon-button\r\n       [matTooltip]=\"'igo.context.contextManager.save' | translate\"\r\n       matTooltipShowDelay=\"500\"\r\n       [color]=\"color\"\r\n       (click)=\"save.emit(context)\">\r\n       <mat-icon svgIcon=\"content-save\"></mat-icon>\r\n     </button>\r\n\r\n    <div #actions class=\"igo-actions-expand-container\">\r\n\r\n      <button *ngIf=\"canShare && !context.imported\"\r\n        mat-icon-button\r\n        [matTooltip]=\"'igo.context.contextManager.managePermissions' | translate\"\r\n        matTooltipShowDelay=\"500\"\r\n        [color]=\"color\"\r\n        (click)=\"managePermissions.emit(context)\">\r\n        <mat-icon svgIcon=\"account-arrow-right\"></mat-icon>\r\n      </button>\r\n\r\n      <!--button\r\n        mat-icon-button\r\n        [matTooltip]=\"'igo.context.contextManager.manageTools' | translate\"\r\n        [color]=\"color\"\r\n        (click)=\"manageTools.emit(context)\">\r\n        <mat-icon svgIcon=\"widgets\"></mat-icon>\r\n      </button-->\r\n\r\n      <button *ngIf=\"!context.imported\"\r\n        class=\"clone-button\"\r\n        mat-icon-button\r\n        [matTooltip]=\"'igo.context.contextManager.clone' | translate\"\r\n        matTooltipShowDelay=\"500\"\r\n        [color]=\"color\"\r\n        (click)=\"clone.emit(context)\">\r\n        <mat-icon svgIcon=\"content-copy\"></mat-icon>\r\n      </button>\r\n\r\n      <button *ngIf=\"context.permission === typePermission[typePermission.write] && !context.imported\"\r\n        class=\"edit-button\"\r\n        mat-icon-button\r\n        [color]=\"color\"\r\n        [matTooltip]=\"'igo.context.contextManager.edit' | translate\"\r\n        matTooltipShowDelay=\"500\"\r\n        (click)=\"edit.emit(context)\">\r\n        <mat-icon svgIcon=\"pencil\"></mat-icon>\r\n      </button>\r\n\r\n      <button *ngIf=\"!context.hidden && !context.imported\"\r\n        class=\"hide-button\"\r\n        mat-icon-button\r\n        [color]=\"color\"\r\n        [matTooltip]=\"'igo.context.contextManager.hide' | translate\"\r\n        matTooltipShowDelay=\"500\"\r\n        (click)=\"hide.emit(context)\">\r\n        <mat-icon svgIcon=\"eye\"></mat-icon>\r\n      </button>\r\n\r\n      <button *ngIf=\"context.hidden && !context.imported\"\r\n        class=\"hide-button\"\r\n        mat-icon-button\r\n        [color]=\"color\"\r\n        [matTooltip]=\"'igo.context.contextManager.show' | translate\"\r\n        matTooltipShowDelay=\"500\"\r\n        (click)=\"show.emit(context)\">\r\n        <mat-icon svgIcon=\"eye-off\"></mat-icon>\r\n      </button>\r\n\r\n      <button *ngIf=\"context.permission === typePermission[typePermission.write] || context.imported\"\r\n        class=\"delete-button\"\r\n        mat-icon-button\r\n        color=\"warn\"\r\n        [matTooltip]=\"'igo.context.contextManager.delete' | translate\"\r\n        matTooltipShowDelay=\"500\"\r\n        (click)=\"delete.emit(context)\">\r\n        <mat-icon svgIcon=\"delete\"></mat-icon>\r\n      </button>\r\n    </div>\r\n\r\n    <button\r\n      class=\"actions-button\"\r\n      mat-icon-button\r\n      igoCollapse\r\n      [color]=\"color\"\r\n      [target]=\"actions\"\r\n      [collapsed]=collapsed\r\n      (click)=\"collapsed = !collapsed\">\r\n      <mat-icon svgIcon=\"dots-horizontal\"></mat-icon>\r\n    </button>\r\n\r\n  </div>\r\n\r\n</mat-list-item>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\n\r\nimport { StorageService } from '@igo2/core';\r\nimport { AuthService } from '@igo2/auth';\r\nimport { TypePermission } from '../shared/context.enum';\r\nimport { DetailedContext } from '../shared/context.interface';\r\n\r\n@Component({\r\n  selector: 'igo-context-item',\r\n  templateUrl: './context-item.component.html',\r\n  styleUrls: ['./context-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class ContextItemComponent {\r\n  public typePermission = TypePermission;\r\n  public color = 'primary';\r\n  public collapsed = true;\r\n\r\n  @Input() showFavorite: boolean = true;\r\n  @Input() context: DetailedContext;\r\n  @Input() default: boolean;\r\n  @Input() selected: boolean;\r\n\r\n  @Output() edit = new EventEmitter<DetailedContext>();\r\n  @Output() delete = new EventEmitter<DetailedContext>();\r\n  @Output() save = new EventEmitter<DetailedContext>();\r\n  @Output() clone = new EventEmitter<DetailedContext>();\r\n  @Output() hide = new EventEmitter<DetailedContext>();\r\n  @Output() show = new EventEmitter<DetailedContext>();\r\n  @Output() favorite = new EventEmitter<DetailedContext>();\r\n  @Output() managePermissions = new EventEmitter<DetailedContext>();\r\n  @Output() manageTools = new EventEmitter<DetailedContext>();\r\n\r\n  get hidden(): boolean {\r\n    return this.context.hidden;\r\n  }\r\n\r\n  get canShare(): boolean {\r\n    return this.storageService.get('canShare') === true;\r\n  }\r\n\r\n  constructor(\r\n    public auth: AuthService,\r\n    private storageService: StorageService\r\n  ) {}\r\n\r\n  favoriteClick(context: DetailedContext) {\r\n    this.favorite.emit(context);\r\n  }\r\n}\r\n","<igo-list [navigation]=\"true\">\r\n  <mat-form-field *ngIf=\"showFilter()\" [ngClass]=\"auth.authenticated && configService.getConfig('context') ? 'context-filter-min-width' : 'context-filter-max-width'\">\r\n    <input\r\n      matInput\r\n      type=\"text\"\r\n      [placeholder]=\"'igo.context.contextManager.filterPlaceHolder' | translate\"\r\n      [(ngModel)]=\"term\">\r\n    <button\r\n      mat-button\r\n      mat-icon-button\r\n      matSuffix\r\n      class=\"clear-button\"\r\n      *ngIf=\"term.length\"\r\n      aria-label=\"Clear\"\r\n      color=\"warn\"\r\n      (click)=\"clearFilter()\">\r\n      <mat-icon svgIcon=\"close\"></mat-icon>\r\n    </button>\r\n  </mat-form-field>\r\n\r\n  <button\r\n  *ngIf=\"!sortedAlpha\"\r\n  class=\"sort-alpha\"\r\n  mat-icon-button\r\n  [matTooltip]=\"'igo.context.contextManager.sortAlphabetically' | translate\"\r\n  matTooltipShowDelay=\"500\"\r\n  (click)=\"toggleSort(true)\">\r\n  <mat-icon color=\"primary\" svgIcon=\"sort-alphabetical-variant\"></mat-icon>\r\n  </button>\r\n  <button\r\n    *ngIf=\"sortedAlpha\"\r\n    class=\"sort-alpha\"\r\n    mat-icon-button\r\n    [matTooltip]=\"'igo.context.contextManager.sortContextOrder' | translate\"\r\n    matTooltipShowDelay=\"500\"\r\n    (click)=\"toggleSort(false)\">\r\n    <mat-icon color=\"warn\" svgIcon=\"sort-variant-remove\"></mat-icon>\r\n  </button>\r\n\r\n  <igo-actionbar *ngIf=\"auth.authenticated && configService.getConfig('context')\"\r\n    class=\"add-context-button\"\r\n    [iconColor]=\"color\"\r\n    [store]=\"actionStore\"\r\n    [withIcon]=\"true\"\r\n    icon=\"plus\"\r\n    [withTitle]=\"actionbarMode === 'overlay'\"\r\n    [horizontal]=\"false\"\r\n    [mode]=\"actionbarMode\">\r\n  </igo-actionbar>\r\n\r\n  <button *ngIf=\"auth.authenticated && configService.getConfig('context')\"\r\n    class=\"users-filter\"\r\n    mat-icon-button\r\n    [matTooltip]=\"'igo.context.contextManager.filterUser' | translate\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matMenuTriggerFor]=\"accountMenu\">\r\n    <mat-icon color=\"primary\" svgIcon=\"filter-menu\"></mat-icon>\r\n  </button>\r\n\r\n  <mat-menu #accountMenu=\"matMenu\">\r\n    <ng-container *ngFor=\"let user of users\">\r\n      <span class=\"profilsMenu\">\r\n        <mat-checkbox\r\n          class=\"mat-menu-item\"\r\n          [checked]=\"getPermission(user).checked\"\r\n          [indeterminate]=\"getPermission(user).indeterminate\"\r\n          (click)=\"$event.stopPropagation()\"\r\n          (change)=\"userSelection(user)\">\r\n        </mat-checkbox>\r\n        <button *ngIf=\"user.childs\"\r\n          [matMenuTriggerFor]=\"subAccountMenu\"\r\n          mat-menu-item>\r\n          {{user.title}}\r\n        </button>\r\n        <button\r\n          mat-menu-item\r\n          *ngIf=\"!user.childs\">\r\n          {{user.title}}\r\n        </button>\r\n      </span>\r\n\r\n      <mat-menu #subAccountMenu=\"matMenu\">\r\n        <mat-checkbox *ngFor=\"let child of user.childs\"\r\n          class=\"mat-menu-item\"\r\n          [checked]=\"getPermission(child).checked\"\r\n          (click)=\"$event.stopPropagation()\"\r\n          (change)=\"userSelection(child, user)\">\r\n          {{child.title}}\r\n        </mat-checkbox>\r\n      </mat-menu>\r\n    </ng-container>\r\n\r\n    <span class=\"profilsMenu\">\r\n      <mat-checkbox\r\n        class=\"mat-menu-item\"\r\n        [checked]=\"showHidden\"\r\n        (click)=\"$event.stopPropagation()\"\r\n        (change)=\"showHiddenContexts.emit()\">\r\n      </mat-checkbox>\r\n      <button mat-menu-item>\r\n        {{ 'igo.context.contextManager.showHidden' | translate }}\r\n      </button>\r\n    </span>\r\n  </mat-menu>\r\n\r\n  <ng-template ngFor let-groupContexts [ngForOf]=\"contexts$ | async | keyvalue\">\r\n\r\n    <igo-collapsible *ngIf=\"groupContexts.value.length && auth.authenticated\" [title]=\"titleMapping[groupContexts.key] | translate\"\r\n      [collapsed]=\"collapsed[titleMapping[groupContexts.key]]\" (toggle)=\"collapsed[titleMapping[groupContexts.key]] = $event\">\r\n\r\n      <ng-template ngFor let-context [ngForOf]=\"groupContexts.value\">\r\n        <igo-context-item\r\n          igoListItem\r\n          color=\"accent\"\r\n          [selected]=\"selectedContext && selectedContext.uri === context.uri\"\r\n          [context]=\"context\"\r\n          [default]=\"context.id && this.defaultContextId && this.defaultContextId === context.id\"\r\n          (edit)=\"edit.emit(context)\"\r\n          (delete)=\"delete.emit(context)\"\r\n          (clone)=\"clone.emit(context)\"\r\n          (save)=\"save.emit(context)\"\r\n          (hide)=\"hideContext(context)\"\r\n          (show)=\"showContext(context)\"\r\n          (favorite)=\"favorite.emit(context)\"\r\n          (manageTools)=\"manageTools.emit(context)\"\r\n          (managePermissions)=\"managePermissions.emit(context)\"\r\n          (select)=\"select.emit(context)\"\r\n          (unselect)=\"unselect.emit(context)\">\r\n        </igo-context-item>\r\n      </ng-template>\r\n\r\n    </igo-collapsible>\r\n\r\n    <ng-template *ngIf=\"groupContexts.value.length && !auth.authenticated\" ngFor let-context [ngForOf]=\"groupContexts.value\">\r\n      <igo-context-item\r\n        igoListItem\r\n        color=\"accent\"\r\n        [showFavorite]=\"configService.getConfig('favoriteContext4NonAuthenticated')\"\r\n        [selected]=\"selectedContext && selectedContext.uri === context.uri\"\r\n        [context]=\"context\"\r\n        [default]=\"configService.getConfig('context') ? defaultContextId === context.id : defaultContextId === context.uri\"\r\n        (favorite)=\"favorite.emit(context)\"\r\n        (select)=\"select.emit(context)\"\r\n        (unselect)=\"unselect.emit(context)\">\r\n      </igo-context-item>\r\n    </ng-template>\r\n\r\n  </ng-template>\r\n</igo-list>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectorRef,\r\n  OnInit,\r\n  ChangeDetectionStrategy,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { AuthService } from '@igo2/auth';\r\nimport { ConfigService, LanguageService, StorageService } from '@igo2/core';\r\nimport type { IgoMap } from '@igo2/geo';\r\n\r\nimport {\r\n  DetailedContext,\r\n  ContextsList,\r\n  ContextUserPermission,\r\n  ContextProfils\r\n} from '../shared/context.interface';\r\nimport { ContextListControlsEnum } from './context-list.enum';\r\nimport {\r\n  Subscription,\r\n  BehaviorSubject,\r\n  ReplaySubject,\r\n  EMPTY,\r\n  timer\r\n} from 'rxjs';\r\nimport { take } from 'rxjs/operators';\r\n\r\nimport { MatDialog } from '@angular/material/dialog';\r\nimport { BookmarkDialogComponent } from '../../context-map-button/bookmark-button/bookmark-dialog.component';\r\nimport { debounce } from 'rxjs/operators';\r\nimport { ActionStore, ActionbarMode } from '@igo2/common';\r\nimport { ContextService } from '../shared/context.service';\r\n\r\n@Component({\r\n  selector: 'igo-context-list',\r\n  templateUrl: './context-list.component.html',\r\n  styleUrls: ['./context-list.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class ContextListComponent implements OnInit, OnDestroy {\r\n  private contextsInitial: ContextsList = { ours: [] };\r\n  contexts$: BehaviorSubject<ContextsList> = new BehaviorSubject(\r\n    this.contextsInitial\r\n  );\r\n\r\n  change$ = new ReplaySubject<void>(1);\r\n\r\n  private change$$: Subscription;\r\n\r\n  @Input()\r\n  get contexts(): ContextsList {\r\n    return this._contexts;\r\n  }\r\n  set contexts(value: ContextsList) {\r\n    this._contexts = value;\r\n    this.cdRef.detectChanges();\r\n    this.next();\r\n  }\r\n  private _contexts: ContextsList = { ours: [] };\r\n\r\n  @Input()\r\n  get selectedContext(): DetailedContext {\r\n    return this._selectedContext;\r\n  }\r\n  set selectedContext(value: DetailedContext) {\r\n    this._selectedContext = value;\r\n    this.cdRef.detectChanges();\r\n  }\r\n  private _selectedContext: DetailedContext;\r\n\r\n  @Input()\r\n  get map(): IgoMap {\r\n    return this._map;\r\n  }\r\n  set map(value: IgoMap) {\r\n    this._map = value;\r\n  }\r\n  private _map: IgoMap;\r\n\r\n  @Input()\r\n  get defaultContextId(): string {\r\n    return this.configService.getConfig('context') ? this._defaultContextId :\r\n      this.storageService.get('favorite.context.uri') as string || this._defaultContextId;\r\n  }\r\n  set defaultContextId(value: string) {\r\n    this._defaultContextId = value;\r\n  }\r\n  private _defaultContextId: string;\r\n\r\n  public collapsed: { contextScope }[] = [];\r\n\r\n  @Output() select = new EventEmitter<DetailedContext>();\r\n  @Output() unselect = new EventEmitter<DetailedContext>();\r\n  @Output() edit = new EventEmitter<DetailedContext>();\r\n  @Output() delete = new EventEmitter<DetailedContext>();\r\n  @Output() save = new EventEmitter<DetailedContext>();\r\n  @Output() clone = new EventEmitter<DetailedContext>();\r\n  @Output() create = new EventEmitter<{ title: string; empty: boolean }>();\r\n  @Output() hide = new EventEmitter<DetailedContext>();\r\n  @Output() show = new EventEmitter<DetailedContext>();\r\n  @Output() showHiddenContexts = new EventEmitter<boolean>();\r\n  @Output() favorite = new EventEmitter<DetailedContext>();\r\n  @Output() managePermissions = new EventEmitter<DetailedContext>();\r\n  @Output() manageTools = new EventEmitter<DetailedContext>();\r\n  @Output() filterPermissionsChanged = new EventEmitter<\r\n    ContextUserPermission[]\r\n  >();\r\n\r\n  public titleMapping = {\r\n    ours: 'igo.context.contextManager.ourContexts',\r\n    shared: 'igo.context.contextManager.sharedContexts',\r\n    public: 'igo.context.contextManager.publicContexts'\r\n  };\r\n\r\n  public users: ContextProfils[];\r\n  public permissions: ContextUserPermission[] = [];\r\n\r\n  public actionStore = new ActionStore([]);\r\n  public actionbarMode = ActionbarMode.Overlay;\r\n\r\n  public color = 'primary';\r\n\r\n  public showHidden = false;\r\n\r\n  /**\r\n   * Context filter term\r\n   */\r\n  @Input()\r\n  set term(value: string) {\r\n    this._term = value;\r\n    this.next();\r\n  }\r\n  get term(): string {\r\n    return this._term;\r\n  }\r\n  public _term: string = '';\r\n\r\n  get sortedAlpha(): boolean {\r\n    return this._sortedAlpha;\r\n  }\r\n  set sortedAlpha(value: boolean) {\r\n    this._sortedAlpha = value;\r\n    this.next();\r\n  }\r\n  private _sortedAlpha: boolean = undefined;\r\n\r\n  public showContextFilter = ContextListControlsEnum.always;\r\n\r\n  public thresholdToFilter = 5;\r\n\r\n  constructor(\r\n    private cdRef: ChangeDetectorRef,\r\n    private contextService: ContextService,\r\n    public configService: ConfigService,\r\n    public auth: AuthService,\r\n    private dialog: MatDialog,\r\n    private languageService: LanguageService,\r\n    private storageService: StorageService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.change$$ = this.change$\r\n      .pipe(\r\n        debounce(() => {\r\n          return this.contexts.ours.length === 0 ? EMPTY : timer(50);\r\n        })\r\n      )\r\n      .subscribe(() => {\r\n        this.contexts$.next(this.filterContextsList(this.contexts));\r\n      });\r\n\r\n    this.actionStore.load([\r\n      {\r\n        id: 'emptyContext',\r\n        title: this.languageService.translate.instant(\r\n          'igo.context.contextManager.emptyContext'\r\n        ),\r\n        icon: 'map-outline',\r\n        tooltip: this.languageService.translate.instant(\r\n          'igo.context.contextManager.emptyContextTooltip'\r\n        ),\r\n        handler: () => {\r\n          this.createContext(true);\r\n        }\r\n      },\r\n      {\r\n        id: 'contextFromMap',\r\n        title: this.languageService.translate.instant(\r\n          'igo.context.contextManager.contextMap'\r\n        ),\r\n        icon: 'map-check',\r\n        tooltip: this.languageService.translate.instant(\r\n          'igo.context.contextManager.contextMapTooltip'\r\n        ),\r\n        handler: () => {\r\n          this.createContext(false);\r\n        }\r\n      }\r\n    ]);\r\n  }\r\n\r\n  private next() {\r\n    this.change$.next();\r\n  }\r\n\r\n  private filterContextsList(contexts: ContextsList) {\r\n    if (this.term === '') {\r\n      if (this.sortedAlpha) {\r\n        contexts = this.sortContextsList(contexts);\r\n      }\r\n      return contexts;\r\n    } else {\r\n      const ours = contexts.ours.filter((context) => {\r\n        const filterNormalized = this.term\r\n          .toLowerCase()\r\n          .normalize('NFD')\r\n          .replace(/[\\u0300-\\u036f]/g, '');\r\n        const contextTitleNormalized = context.title\r\n          .toLowerCase()\r\n          .normalize('NFD')\r\n          .replace(/[\\u0300-\\u036f]/g, '');\r\n        return contextTitleNormalized.includes(filterNormalized);\r\n      });\r\n\r\n      let updateContexts: ContextsList = {\r\n        ours\r\n      };\r\n\r\n      if (this.contexts.public) {\r\n        const publics = contexts.public.filter((context) => {\r\n          const filterNormalized = this.term\r\n            .toLowerCase()\r\n            .normalize('NFD')\r\n            .replace(/[\\u0300-\\u036f]/g, '');\r\n          const contextTitleNormalized = context.title\r\n            .toLowerCase()\r\n            .normalize('NFD')\r\n            .replace(/[\\u0300-\\u036f]/g, '');\r\n          return contextTitleNormalized.includes(filterNormalized);\r\n        });\r\n        updateContexts.public = publics;\r\n      }\r\n\r\n      if (this.contexts.shared) {\r\n        const shared = contexts.shared.filter((context) => {\r\n          const filterNormalized = this.term\r\n            .toLowerCase()\r\n            .normalize('NFD')\r\n            .replace(/[\\u0300-\\u036f]/g, '');\r\n          const contextTitleNormalized = context.title\r\n            .toLowerCase()\r\n            .normalize('NFD')\r\n            .replace(/[\\u0300-\\u036f]/g, '');\r\n          return contextTitleNormalized.includes(filterNormalized);\r\n        });\r\n        updateContexts.shared = shared;\r\n      }\r\n\r\n      if (this.sortedAlpha) {\r\n        updateContexts = this.sortContextsList(updateContexts);\r\n      }\r\n      return updateContexts;\r\n    }\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.change$$.unsubscribe();\r\n  }\r\n\r\n  public showFilter() {\r\n    switch (this.showContextFilter) {\r\n      case ContextListControlsEnum.always:\r\n        return true;\r\n      case ContextListControlsEnum.never:\r\n        return false;\r\n      default:\r\n        let totalLength = this.contexts.ours.length;\r\n        this.contexts.public\r\n          ? (totalLength += this.contexts.public.length)\r\n          : (totalLength += 0);\r\n        this.contexts.shared\r\n          ? (totalLength += this.contexts.shared.length)\r\n          : (totalLength += 0);\r\n        if (totalLength >= this.thresholdToFilter) {\r\n          return true;\r\n        }\r\n        return false;\r\n    }\r\n  }\r\n\r\n  sortContextsList(contexts: ContextsList) {\r\n    if (contexts) {\r\n      const contextsList = JSON.parse(JSON.stringify(contexts));\r\n      contextsList.ours.sort((a, b) => {\r\n        if (this.normalize(a.title) < this.normalize(b.title)) {\r\n          return -1;\r\n        }\r\n        if (this.normalize(a.title) > this.normalize(b.title)) {\r\n          return 1;\r\n        }\r\n        return 0;\r\n      });\r\n\r\n      if (contextsList.shared) {\r\n        contextsList.shared.sort((a, b) => {\r\n          if (this.normalize(a.title) < this.normalize(b.title)) {\r\n            return -1;\r\n          }\r\n          if (this.normalize(a.title) > this.normalize(b.title)) {\r\n            return 1;\r\n          }\r\n          return 0;\r\n        });\r\n      } else if (contextsList.public) {\r\n        contextsList.public.sort((a, b) => {\r\n          if (this.normalize(a.title) < this.normalize(b.title)) {\r\n            return -1;\r\n          }\r\n          if (this.normalize(a.title) > this.normalize(b.title)) {\r\n            return 1;\r\n          }\r\n          return 0;\r\n        });\r\n      }\r\n      return contextsList;\r\n    }\r\n  }\r\n\r\n  normalize(str: string) {\r\n    return str\r\n      .normalize('NFD')\r\n      .replace(/[\\u0300-\\u036f]/g, '')\r\n      .toLowerCase();\r\n  }\r\n\r\n  toggleSort(sortAlpha: boolean) {\r\n    this.sortedAlpha = sortAlpha;\r\n  }\r\n\r\n  clearFilter() {\r\n    this.term = '';\r\n  }\r\n\r\n  createContext(empty?: boolean) {\r\n    this.dialog\r\n      .open(BookmarkDialogComponent, { disableClose: false })\r\n      .afterClosed()\r\n      .pipe(take(1))\r\n      .subscribe((title: string) => {\r\n        if (title) {\r\n          this.create.emit({ title, empty });\r\n        }\r\n      });\r\n  }\r\n\r\n  getPermission(user?): ContextUserPermission {\r\n    if (user) {\r\n      const permission = this.permissions.find((p) => p.name === user.name);\r\n      return permission;\r\n    }\r\n  }\r\n\r\n  userSelection(user, parent?) {\r\n    const permission = this.getPermission(user);\r\n    if (permission) {\r\n      permission.checked = !permission.checked;\r\n      this.storageService.set(\r\n        'contexts.permissions.' + permission.name,\r\n        permission.checked\r\n      );\r\n      permission.indeterminate = false;\r\n    }\r\n\r\n    if (parent) {\r\n      let indeterminate = false;\r\n\r\n      for (const c of parent.childs) {\r\n        const cPermission = this.getPermission(c);\r\n        if (cPermission.checked !== permission.checked) {\r\n          indeterminate = true;\r\n          break;\r\n        }\r\n      }\r\n      const parentPermission = this.getPermission(parent);\r\n      if (parentPermission) {\r\n        parentPermission.checked = permission.checked;\r\n        this.storageService.set(\r\n          'contexts.permissions.' + parentPermission.name,\r\n          permission.checked\r\n        );\r\n        parentPermission.indeterminate = indeterminate;\r\n      }\r\n    }\r\n\r\n    if (user.childs) {\r\n      for (const c of user.childs) {\r\n        const childrenPermission = this.getPermission(c);\r\n        if (\r\n          childrenPermission &&\r\n          childrenPermission.checked !== permission.checked\r\n        ) {\r\n          childrenPermission.checked = permission.checked;\r\n          this.storageService.set(\r\n            'contexts.permissions.' + childrenPermission.name,\r\n            permission.checked\r\n          );\r\n        }\r\n      }\r\n    }\r\n\r\n    this.filterPermissionsChanged.emit(this.permissions);\r\n  }\r\n\r\n  hideContext(context: DetailedContext) {\r\n    context.hidden = true;\r\n    if (!this.showHidden) {\r\n      const contexts: ContextsList = { ours: [], shared: [], public: [] };\r\n      contexts.ours = this.contexts.ours.filter((c) => c.id !== context.id);\r\n      contexts.shared = this.contexts.shared.filter((c) => c.id !== context.id);\r\n      contexts.public = this.contexts.public.filter((c) => c.id !== context.id);\r\n      this.contexts = contexts;\r\n    }\r\n    this.hide.emit(context);\r\n  }\r\n\r\n  showContext(context: DetailedContext) {\r\n    context.hidden = false;\r\n    this.show.emit(context);\r\n  }\r\n}\r\n","import {\r\n  Directive,\r\n  Self,\r\n  OnInit,\r\n  OnDestroy,\r\n  HostListener,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\nimport { Subscription } from 'rxjs';\r\nimport { debounceTime } from 'rxjs/operators';\r\n\r\nimport { MessageService, LanguageService, StorageService } from '@igo2/core';\r\nimport { AuthService } from '@igo2/auth';\r\nimport { ConfirmDialogService } from '@igo2/common';\r\nimport { MapService } from '@igo2/geo';\r\n\r\nimport {\r\n  Context,\r\n  DetailedContext,\r\n  ContextsList,\r\n  ContextUserPermission\r\n} from '../shared/context.interface';\r\nimport { ContextService } from '../shared/context.service';\r\nimport { ContextListComponent } from './context-list.component';\r\n\r\n@Directive({\r\n  selector: '[igoContextListBinding]'\r\n})\r\nexport class ContextListBindingDirective implements OnInit, OnDestroy {\r\n  private component: ContextListComponent;\r\n  private contexts$$: Subscription;\r\n  private selectedContext$$: Subscription;\r\n  private defaultContextId$$: Subscription;\r\n  private previousMessageId;\r\n\r\n  @HostListener('select', ['$event'])\r\n  onSelect(context: Context) {\r\n    this.contextService.loadContext(context.uri);\r\n  }\r\n\r\n  @HostListener('edit', ['$event'])\r\n  onEdit(context: Context) {\r\n    this.contextService.loadEditedContext(context.uri);\r\n  }\r\n\r\n  @HostListener('save', ['$event'])\r\n  onSave(context: Context) {\r\n    const map = this.mapService.getMap();\r\n    const contextFromMap = this.contextService.getContextFromMap(map);\r\n\r\n    const msgSuccess = () => {\r\n      const translate = this.languageService.translate;\r\n      const message = translate.instant(\r\n        'igo.context.contextManager.dialog.saveMsg',\r\n        {\r\n          value: context.title\r\n        }\r\n      );\r\n      const title = translate.instant(\r\n        'igo.context.contextManager.dialog.saveTitle'\r\n      );\r\n      this.messageService.success(message, title);\r\n    };\r\n\r\n    if (context.imported) {\r\n      contextFromMap.title = context.title;\r\n      this.contextService.delete(context.id, true);\r\n      this.contextService.create(contextFromMap).subscribe((contextCreated) => {\r\n        this.contextService.loadContext(contextCreated.uri);\r\n        msgSuccess();\r\n      });\r\n      return;\r\n    }\r\n\r\n    const changes: any = {\r\n      layers: contextFromMap.layers,\r\n      map: {\r\n        view: contextFromMap.map.view\r\n      }\r\n    };\r\n\r\n    this.contextService.update(context.id, changes).subscribe(() => {\r\n      msgSuccess();\r\n    });\r\n  }\r\n\r\n  @HostListener('favorite', ['$event'])\r\n  onFavorite(context: Context) {\r\n    if (!context.id) {\r\n      context.id = context.uri;\r\n    }\r\n    this.contextService.setDefault(context.id).subscribe(() => {\r\n      if (this.previousMessageId) {\r\n        this.messageService.remove(this.previousMessageId);\r\n      }\r\n      this.contextService.defaultContextId$.next(context.id);\r\n      const translate = this.languageService.translate;\r\n      const message = translate.instant(\r\n        'igo.context.contextManager.dialog.favoriteMsg',\r\n        {\r\n          value: context.title\r\n        }\r\n      );\r\n      const title = translate.instant(\r\n        'igo.context.contextManager.dialog.favoriteTitle'\r\n      );\r\n      const messageObj = this.messageService.success(message, title);\r\n      this.previousMessageId = messageObj.toastId;\r\n      this.cdRef.detectChanges();\r\n    });\r\n  }\r\n\r\n  @HostListener('manageTools', ['$event'])\r\n  onManageTools(context: Context) {\r\n    this.contextService.loadEditedContext(context.uri);\r\n  }\r\n\r\n  @HostListener('managePermissions', ['$event'])\r\n  onManagePermissions(context: Context) {\r\n    this.contextService.loadEditedContext(context.uri);\r\n  }\r\n\r\n  @HostListener('delete', ['$event'])\r\n  onDelete(context: Context) {\r\n    const translate = this.languageService.translate;\r\n    this.confirmDialogService\r\n      .open(\r\n        translate.instant('igo.context.contextManager.dialog.confirmDelete')\r\n      )\r\n      .subscribe((confirm) => {\r\n        if (confirm) {\r\n          this.contextService\r\n            .delete(context.id, context.imported)\r\n            .subscribe(() => {\r\n              const message = translate.instant(\r\n                'igo.context.contextManager.dialog.deleteMsg',\r\n                {\r\n                  value: context.title\r\n                }\r\n              );\r\n              const title = translate.instant(\r\n                'igo.context.contextManager.dialog.deleteTitle'\r\n              );\r\n              this.messageService.info(message, title);\r\n            });\r\n        }\r\n      });\r\n  }\r\n\r\n  @HostListener('clone', ['$event'])\r\n  onClone(context: DetailedContext) {\r\n    const properties = {\r\n      title: context.title + '-copy',\r\n      uri: context.uri + '-copy'\r\n    };\r\n    this.contextService.clone(context.id, properties).subscribe(() => {\r\n      const translate = this.languageService.translate;\r\n      const message = translate.instant(\r\n        'igo.context.contextManager.dialog.cloneMsg',\r\n        {\r\n          value: context.title\r\n        }\r\n      );\r\n      const title = translate.instant(\r\n        'igo.context.contextManager.dialog.cloneTitle'\r\n      );\r\n      this.messageService.success(message, title);\r\n    });\r\n  }\r\n\r\n  @HostListener('create', ['$event'])\r\n  onCreate(opts: { title: string; empty: boolean }) {\r\n    const { title, empty } = opts;\r\n    const context = this.contextService.getContextFromMap(\r\n      this.component.map,\r\n      empty\r\n    );\r\n    context.title = title;\r\n    this.contextService.create(context).subscribe(() => {\r\n      const translate = this.languageService.translate;\r\n      const titleD = translate.instant(\r\n        'igo.context.bookmarkButton.dialog.createTitle'\r\n      );\r\n      const message = translate.instant(\r\n        'igo.context.bookmarkButton.dialog.createMsg',\r\n        {\r\n          value: context.title\r\n        }\r\n      );\r\n      this.messageService.success(message, titleD);\r\n      this.contextService.loadContext(context.uri);\r\n    });\r\n  }\r\n\r\n  @HostListener('filterPermissionsChanged')\r\n  loadContexts() {\r\n    const permissions = ['none'];\r\n    for (const p of this.component.permissions) {\r\n      if (p.checked === true || p.indeterminate === true) {\r\n        permissions.push(p.name);\r\n      }\r\n    }\r\n    this.component.showHidden\r\n      ? this.contextService.loadContexts(permissions, true)\r\n      : this.contextService.loadContexts(permissions, false);\r\n  }\r\n\r\n  @HostListener('showHiddenContexts')\r\n  showHiddenContexts() {\r\n    this.component.showHidden = !this.component.showHidden;\r\n    this.storageService.set('contexts.showHidden', this.component.showHidden);\r\n    this.loadContexts();\r\n  }\r\n\r\n  @HostListener('show', ['$event'])\r\n  onShowContext(context: DetailedContext) {\r\n    this.contextService.showContext(context.id).subscribe();\r\n  }\r\n\r\n  @HostListener('hide', ['$event'])\r\n  onHideContext(context: DetailedContext) {\r\n    this.contextService.hideContext(context.id).subscribe();\r\n  }\r\n\r\n  constructor(\r\n    @Self() component: ContextListComponent,\r\n    private contextService: ContextService,\r\n    private mapService: MapService,\r\n    private languageService: LanguageService,\r\n    private confirmDialogService: ConfirmDialogService,\r\n    private messageService: MessageService,\r\n    private auth: AuthService,\r\n    private storageService: StorageService,\r\n    private cdRef: ChangeDetectorRef\r\n  ) {\r\n    this.component = component;\r\n  }\r\n\r\n  ngOnInit() {\r\n    // Override input contexts\r\n    this.component.contexts = { ours: [] };\r\n    this.component.showHidden = this.storageService.get(\r\n      'contexts.showHidden'\r\n    ) as boolean;\r\n\r\n    this.contexts$$ = this.contextService.contexts$.subscribe((contexts) =>\r\n      this.handleContextsChange(contexts)\r\n    );\r\n\r\n    this.defaultContextId$$ = this.contextService.defaultContextId$.subscribe(\r\n      (id) => {\r\n        this.component.defaultContextId = id;\r\n      }\r\n    );\r\n    const storedContextUri = this.storageService.get('favorite.context.uri') as string;\r\n    if (storedContextUri && !this.auth.authenticated) {\r\n      this.contextService.defaultContextId$.next(storedContextUri);\r\n    }\r\n\r\n    // See feature-list.component for an explanation about the debounce time\r\n    this.selectedContext$$ = this.contextService.context$\r\n      .pipe(debounceTime(100))\r\n      .subscribe((context) => (this.component.selectedContext = context));\r\n\r\n    this.auth.authenticate$.subscribe((authenticate) => {\r\n      if (authenticate) {\r\n        this.contextService.getProfilByUser().subscribe((profils) => {\r\n          this.component.users = profils;\r\n          this.component.permissions = [];\r\n          const profilsAcc = this.component.users.reduce((acc, cur) => {\r\n            acc = acc.concat(cur);\r\n            acc = cur.childs ? acc.concat(cur.childs) : acc;\r\n            return acc;\r\n          }, []);\r\n\r\n          for (const user of profilsAcc) {\r\n            const permission: ContextUserPermission = {\r\n              name: user.name,\r\n              checked: this.storageService.get(\r\n                'contexts.permissions.' + user.name\r\n              ) as boolean\r\n            };\r\n            if (permission.checked === null) {\r\n              permission.checked = true;\r\n            }\r\n            this.component.permissions.push(permission);\r\n          }\r\n\r\n          const permissions = ['none'];\r\n          for (const p of this.component.permissions) {\r\n            if (p.checked === true || p.indeterminate === true) {\r\n              permissions.push(p.name);\r\n            }\r\n          }\r\n\r\n          this.component.showHidden\r\n            ? this.contextService.loadContexts(permissions, true)\r\n            : this.contextService.loadContexts(permissions, false);\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.contexts$$.unsubscribe();\r\n    this.selectedContext$$.unsubscribe();\r\n    this.defaultContextId$$.unsubscribe();\r\n  }\r\n\r\n  private handleContextsChange(contexts: ContextsList) {\r\n    this.component.contexts = contexts;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { Observable, EMPTY } from 'rxjs';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { Poi } from './poi.interface';\r\n\r\n@Injectable()\r\nexport class PoiService {\r\n  private baseUrl: string;\r\n\r\n  constructor(private http: HttpClient, private config: ConfigService) {\r\n    this.baseUrl = this.config.getConfig('context.url');\r\n  }\r\n\r\n  get(): Observable<Poi[]> {\r\n    if (!this.baseUrl) {\r\n      return EMPTY;\r\n    }\r\n\r\n    const url = this.baseUrl + '/pois';\r\n    return this.http.get<Poi[]>(url);\r\n  }\r\n\r\n  delete(id: string): Observable<void> {\r\n    const url = this.baseUrl + '/pois/' + id;\r\n    return this.http.delete<void>(url);\r\n  }\r\n\r\n  create(context: Poi): Observable<Poi> {\r\n    const url = this.baseUrl + '/pois';\r\n    return this.http.post<Poi>(url, context);\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatOptionModule } from '@angular/material/core';\r\nimport { MatDialogModule } from '@angular/material/dialog';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoConfirmDialogModule, IgoStopPropagationModule } from '@igo2/common';\r\nimport { IgoAuthModule } from '@igo2/auth';\r\n\r\nimport { BookmarkButtonComponent } from './bookmark-button/bookmark-button.component';\r\nimport { BookmarkDialogComponent } from './bookmark-button/bookmark-dialog.component';\r\nimport { PoiButtonComponent } from './poi-button/poi-button.component';\r\nimport { PoiDialogComponent } from './poi-button/poi-dialog.component';\r\nimport { PoiService } from './poi-button/shared/poi.service';\r\nimport { UserDialogComponent } from './user-button/user-dialog.component';\r\nimport { UserButtonComponent } from './user-button/user-button.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoLanguageModule,\r\n    IgoConfirmDialogModule,\r\n    IgoStopPropagationModule,\r\n    IgoAuthModule,\r\n    FormsModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatSelectModule,\r\n    MatOptionModule,\r\n    MatTooltipModule,\r\n    MatFormFieldModule,\r\n    MatDialogModule,\r\n    MatInputModule\r\n  ],\r\n  exports: [BookmarkButtonComponent, PoiButtonComponent, UserButtonComponent, BookmarkDialogComponent],\r\n  declarations: [\r\n    BookmarkButtonComponent,\r\n    BookmarkDialogComponent,\r\n    PoiButtonComponent,\r\n    PoiDialogComponent,\r\n    UserButtonComponent,\r\n    UserDialogComponent\r\n  ],\r\n  providers: [PoiService]\r\n})\r\nexport class IgoContextMapButtonModule {\r\n  static forRoot(): ModuleWithProviders<IgoContextMapButtonModule> {\r\n    return {\r\n      ngModule: IgoContextMapButtonModule\r\n    };\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { MatAutocompleteModule } from '@angular/material/autocomplete';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatOptionModule } from '@angular/material/core';\r\nimport { MatDialogModule } from '@angular/material/dialog';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatMenuModule } from '@angular/material/menu';\r\nimport { MatRadioModule } from '@angular/material/radio';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoAuthModule } from '@igo2/auth';\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport {\r\n  IgoListModule,\r\n  IgoKeyValueModule,\r\n  IgoCollapsibleModule,\r\n  IgoStopPropagationModule,\r\n  IgoActionbarModule\r\n} from '@igo2/common';\r\n\r\nimport { MapContextDirective } from './shared/map-context.directive';\r\nimport { LayerContextDirective } from './shared/layer-context.directive';\r\nimport { ContextListComponent } from './context-list/context-list.component';\r\nimport { ContextListBindingDirective } from './context-list/context-list-binding.directive';\r\nimport { ContextItemComponent } from './context-item/context-item.component';\r\nimport { ContextFormComponent } from './context-form/context-form.component';\r\nimport { ContextEditComponent } from './context-edit/context-edit.component';\r\nimport { ContextEditBindingDirective } from './context-edit/context-edit-binding.directive';\r\nimport { ContextPermissionsComponent } from './context-permissions/context-permissions.component';\r\nimport { ContextPermissionsBindingDirective } from './context-permissions/context-permissions-binding.directive';\r\nimport { IgoContextMapButtonModule } from '../context-map-button/context-map-button.module';\r\nimport { IgoContextImportExportModule } from '../context-import-export/context-import-export.module';\r\n\r\nconst CONTEXT_DIRECTIVES = [\r\n  MapContextDirective,\r\n  LayerContextDirective\r\n];\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatTooltipModule,\r\n    MatListModule,\r\n    MatCheckboxModule,\r\n    MatRadioModule,\r\n    MatDialogModule,\r\n    MatMenuModule,\r\n    MatOptionModule,\r\n    MatAutocompleteModule,\r\n    IgoAuthModule,\r\n    IgoListModule,\r\n    IgoKeyValueModule,\r\n    IgoCollapsibleModule,\r\n    IgoStopPropagationModule,\r\n    IgoLanguageModule,\r\n    IgoContextImportExportModule,\r\n    IgoContextMapButtonModule,\r\n    IgoActionbarModule\r\n  ],\r\n  exports: [\r\n    ContextListComponent,\r\n    ContextListBindingDirective,\r\n    ContextItemComponent,\r\n    ContextFormComponent,\r\n    ContextEditComponent,\r\n    ContextEditBindingDirective,\r\n    ContextPermissionsComponent,\r\n    ContextPermissionsBindingDirective,\r\n\r\n    ...CONTEXT_DIRECTIVES\r\n  ],\r\n  declarations: [\r\n    ContextListComponent,\r\n    ContextListBindingDirective,\r\n    ContextItemComponent,\r\n    ContextFormComponent,\r\n    ContextEditComponent,\r\n    ContextEditBindingDirective,\r\n    ContextPermissionsComponent,\r\n    ContextPermissionsBindingDirective,\r\n\r\n    ...CONTEXT_DIRECTIVES\r\n  ]\r\n})\r\nexport class IgoContextManagerModule {\r\n  static forRoot(): ModuleWithProviders<IgoContextManagerModule> {\r\n    return {\r\n      ngModule: IgoContextManagerModule\r\n    };\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport { ExportOptions } from '@igo2/geo';\r\n\r\nexport enum ImportExportType {\r\n  layer = 'layer',\r\n  context = 'context'\r\n}\r\n\r\nexport enum ImportExportMode {\r\n  import = 'import',\r\n  export = 'export'\r\n}\r\n\r\n/**\r\n * Service that holds the state of the importExport module\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ImportExportState {\r\n\r\n  readonly importExportType$: BehaviorSubject<ImportExportType> = new BehaviorSubject(ImportExportType.layer);\r\n  readonly selectedMode$: BehaviorSubject<ImportExportMode> = new BehaviorSubject(ImportExportMode.import);\r\n  readonly exportOptions$: BehaviorSubject<ExportOptions> = new BehaviorSubject(undefined);\r\n\r\n  setImportExportType(type: ImportExportType) {\r\n    this.importExportType$.next(type);\r\n  }\r\n\r\n  setMode(mode: ImportExportMode) {\r\n    this.selectedMode$.next(mode);\r\n  }\r\n\r\n  setsExportOptions(exportOptions: ExportOptions) {\r\n      this.exportOptions$.next(exportOptions);\r\n    }\r\n\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { Toolbox, ToolService } from '@igo2/common';\r\n\r\nimport { ExportOptions } from '@igo2/geo';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport { ImportExportMode, ImportExportState } from '../import-export/import-export.state';\r\n\r\n/**\r\n * Service that holds the state of the search module\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ToolState {\r\n  get toolbox(): Toolbox {\r\n    return this.toolService.toolbox;\r\n  }\r\n\r\n  public openSidenav$: BehaviorSubject<boolean> = new BehaviorSubject(undefined);\r\n\r\n  constructor(\r\n    private toolService: ToolService,\r\n    private importExportState: ImportExportState\r\n    ) {}\r\n\r\n    toolToActivateFromOptions(toolToActivate: { tool: string; options: {[key: string]: any} }) {\r\n    if (!toolToActivate) { return; }\r\n    if (toolToActivate.tool === 'importExport') {\r\n      let exportOptions: ExportOptions = this.importExportState.exportOptions$.value;\r\n      if (!exportOptions) {\r\n        exportOptions = {\r\n          layers: toolToActivate.options.layers,\r\n          featureInMapExtent: toolToActivate.options.featureInMapExtent\r\n        };\r\n      } else {\r\n        exportOptions.layers = toolToActivate.options.layers;\r\n        exportOptions.featureInMapExtent = toolToActivate.options.featureInMapExtent;\r\n      }\r\n      this.importExportState.setsExportOptions(exportOptions);\r\n      this.importExportState.setMode(ImportExportMode.export);\r\n    }\r\n\r\n    if (this.toolbox.getTool(toolToActivate.tool)) {\r\n      this.toolbox.activateTool(toolToActivate.tool);\r\n      this.openSidenav$.next(true);\r\n    }\r\n  }\r\n}\r\n","import {\r\n    FeatureMotion,\r\n    FeatureStoreSelectionStrategy,\r\n    FeatureWorkspace,\r\n    WfsWorkspace,\r\n    EditionWorkspace\r\n} from '@igo2/geo';\r\n\r\n\r\nexport function handleZoomAuto(workspace: FeatureWorkspace | WfsWorkspace | EditionWorkspace, storageService) {\r\n    const zoomStrategy = workspace.entityStore\r\n        .getStrategyOfType(FeatureStoreSelectionStrategy) as FeatureStoreSelectionStrategy;\r\n    zoomStrategy.setMotion(storageService.get('zoomAuto') as boolean ? FeatureMotion.Default : FeatureMotion.None);\r\n}\r\n\r\n\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { StorageService } from '@igo2/core';\r\n\r\n/**\r\n * Service that holds the state of storage service\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class StorageState {\r\n  get storageService(): StorageService {\r\n    return this.igoStorageService;\r\n  }\r\n\r\n  constructor(private igoStorageService: StorageService) {}\r\n}\r\n","import { Injectable, OnDestroy } from '@angular/core';\r\n\r\nimport {\r\n  Action,\r\n  EntityStoreFilterCustomFuncStrategy,\r\n  EntityStoreFilterSelectionStrategy\r\n} from '@igo2/common';\r\n\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport {\r\n  FeatureWorkspace,\r\n  mapExtentStrategyActiveToolTip,\r\n  noElementSelected,\r\n  ExportOptions\r\n} from '@igo2/geo';\r\nimport { StorageService, StorageServiceEvent, StorageServiceEventEnum, LanguageService, MediaService} from '@igo2/core';\r\nimport { StorageState } from '../../storage/storage.state';\r\nimport { map, skipWhile } from 'rxjs/operators';\r\nimport { ToolState } from '../../tool/tool.state';\r\nimport { handleZoomAuto } from './workspace.utils';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class FeatureActionsService implements OnDestroy {\r\n\r\n  public maximize$: BehaviorSubject<boolean> = new BehaviorSubject(\r\n    this.storageService.get('workspaceMaximize') as boolean\r\n  );\r\n\r\n  zoomAuto$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  private storageChange$$: Subscription;\r\n\r\n  get storageService(): StorageService {\r\n    return this.storageState.storageService;\r\n  }\r\n\r\n  get zoomAuto(): boolean {\r\n    return this.storageService.get('zoomAuto') as boolean;\r\n  }\r\n\r\n  constructor(\r\n    private storageState: StorageState,\r\n    public languageService: LanguageService,\r\n    private toolState: ToolState,\r\n    private mediaService: MediaService\r\n  ) {}\r\n\r\n  ngOnDestroy(): void {\r\n    if (this.storageChange$$) {\r\n      this.storageChange$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  loadActions(\r\n    workspace: FeatureWorkspace,\r\n    rowsInMapExtentCheckCondition$: BehaviorSubject<boolean>,\r\n    selectOnlyCheckCondition$: BehaviorSubject<boolean>\r\n    ) {\r\n    const actions = this.buildActions(\r\n      workspace,\r\n      rowsInMapExtentCheckCondition$,\r\n      selectOnlyCheckCondition$\r\n      );\r\n    workspace.actionStore.load(actions);\r\n  }\r\n\r\n  buildActions(\r\n    workspace: FeatureWorkspace,\r\n    rowsInMapExtentCheckCondition$: BehaviorSubject<boolean>,\r\n    selectOnlyCheckCondition$: BehaviorSubject<boolean>\r\n    ): Action[] {\r\n    this.zoomAuto$.next(this.zoomAuto);\r\n    this.storageChange$$ = this.storageService.storageChange$\r\n      .pipe(\r\n        skipWhile(\r\n          (storageChange: StorageServiceEvent) =>\r\n            storageChange.key !== 'zoomAuto' || storageChange.event === StorageServiceEventEnum.CLEARED\r\n        )\r\n      )\r\n      .subscribe(() => {\r\n        this.zoomAuto$.next(this.zoomAuto);\r\n        handleZoomAuto(workspace, this.storageService);\r\n      });\r\n    return [\r\n      {\r\n        id: 'zoomAuto',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.zoomAuto.title',\r\n        tooltip: 'igo.integration.workspace.zoomAuto.tooltip',\r\n        checkCondition: this.zoomAuto$,\r\n        handler: () => {\r\n          handleZoomAuto(workspace, this.storageService);\r\n          this.storageService.set(\r\n            'zoomAuto',\r\n            !this.storageService.get('zoomAuto') as boolean\r\n          );\r\n        }\r\n      },\r\n      {\r\n        id: 'filterInMapExtent',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.inMapExtent.title',\r\n        tooltip: mapExtentStrategyActiveToolTip(workspace),\r\n        checkCondition: rowsInMapExtentCheckCondition$,\r\n        handler: () => rowsInMapExtentCheckCondition$.next(!rowsInMapExtentCheckCondition$.value)\r\n      },\r\n      {\r\n        id: 'selectedOnly',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.selected.title',\r\n        tooltip: 'igo.integration.workspace.selected.tooltip',\r\n        checkCondition: selectOnlyCheckCondition$,\r\n        handler: () => selectOnlyCheckCondition$.next(!selectOnlyCheckCondition$.value)\r\n      },\r\n      {\r\n        id: 'clearselection',\r\n        icon: 'select-off',\r\n        title: 'igo.integration.workspace.clearSelection.title',\r\n        tooltip: 'igo.integration.workspace.clearSelection.tooltip',\r\n        handler: (ws: FeatureWorkspace) => {\r\n          ws.entityStore.state.updateMany(ws.entityStore.view.all(), {\r\n            selected: false\r\n          });\r\n        },\r\n        args: [workspace],\r\n        availability: (ws: FeatureWorkspace) => noElementSelected(ws)\r\n      },\r\n      {\r\n        id: 'featureDownload',\r\n        icon: 'file-export',\r\n        title: 'igo.integration.workspace.download.title',\r\n        tooltip: 'igo.integration.workspace.download.tooltip',\r\n        handler: (ws: FeatureWorkspace) => {\r\n          const filterStrategy = ws.entityStore.getStrategyOfType(\r\n            EntityStoreFilterCustomFuncStrategy\r\n          );\r\n          const filterSelectionStrategy = ws.entityStore.getStrategyOfType(\r\n            EntityStoreFilterSelectionStrategy\r\n          );\r\n          const layersWithSelection = filterSelectionStrategy.active\r\n            ? [ws.layer.id]\r\n            : [];\r\n          this.toolState.toolToActivateFromOptions({\r\n            tool: 'importExport',\r\n            options: {\r\n              layers: [ws.layer.id],\r\n              featureInMapExtent: filterStrategy.active,\r\n              layersWithSelection\r\n            } as ExportOptions\r\n          });\r\n        },\r\n        args: [workspace]\r\n      },\r\n      {\r\n        id: 'maximize',\r\n        title: this.languageService.translate.instant('igo.integration.workspace.maximize'),\r\n        tooltip: this.languageService.translate.instant(\r\n          'igo.integration.workspace.maximizeTooltip'\r\n        ),\r\n        icon: 'resize',\r\n        display: () => {\r\n          return this.maximize$.pipe(map((v) => !v && !this.mediaService.isMobile()));\r\n        },\r\n        handler: () => {\r\n          if (!this.mediaService.isMobile()) {\r\n            this.maximize$.next(true);\r\n          }\r\n        },\r\n      },\r\n      {\r\n        id: 'standardExtent',\r\n        title: this.languageService.translate.instant(\r\n          'igo.integration.workspace.standardExtent'\r\n        ),\r\n        tooltip: this.languageService.translate.instant(\r\n          'igo.integration.workspace.standardExtentTooltip'\r\n        ),\r\n        icon: 'resize',\r\n        display: () => {\r\n          return this.maximize$.pipe(map((v) => v && !this.mediaService.isMobile()));\r\n        },\r\n        handler: () => {\r\n          this.maximize$.next(false);\r\n        }\r\n      }\r\n    ];\r\n  }\r\n}\r\n","import { Inject, Injectable, OnDestroy } from '@angular/core';\r\n\r\nimport {\r\n  Action,\r\n  EntityStoreFilterCustomFuncStrategy,\r\n  EntityStoreFilterSelectionStrategy,\r\n  Widget\r\n} from '@igo2/common';\r\n\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport {\r\n  WfsWorkspace,\r\n  mapExtentStrategyActiveToolTip,\r\n  noElementSelected,\r\n  ExportOptions,\r\n  OgcFilterWidget,\r\n  OgcFilterableDataSource,\r\n} from '@igo2/geo';\r\nimport { StorageService, StorageServiceEvent, StorageServiceEventEnum, LanguageService, MediaService} from '@igo2/core';\r\nimport { StorageState } from '../../storage/storage.state';\r\nimport { map, skipWhile } from 'rxjs/operators';\r\nimport { ToolState } from '../../tool/tool.state';\r\nimport { handleZoomAuto } from './workspace.utils';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class WfsActionsService implements OnDestroy {\r\n\r\n  public maximize$: BehaviorSubject<boolean> = new BehaviorSubject(\r\n    this.storageService.get('workspaceMaximize') as boolean\r\n  );\r\n\r\n  selectOnlyCheckCondition$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  // rowsInMapExtentCheckCondition$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n  zoomAuto$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  private storageChange$$: Subscription;\r\n\r\n  get storageService(): StorageService {\r\n    return this.storageState.storageService;\r\n  }\r\n\r\n  get zoomAuto(): boolean {\r\n    return this.storageService.get('zoomAuto') as boolean;\r\n  }\r\n\r\n  constructor(\r\n    @Inject(OgcFilterWidget) private ogcFilterWidget: Widget,\r\n    private storageState: StorageState,\r\n    public languageService: LanguageService,\r\n    private mediaService: MediaService,\r\n    private toolState: ToolState) {}\r\n\r\n  ngOnDestroy(): void {\r\n    if (this.storageChange$$) {\r\n      this.storageChange$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  loadActions(\r\n    workspace: WfsWorkspace,\r\n    rowsInMapExtentCheckCondition$: BehaviorSubject<boolean>,\r\n    selectOnlyCheckCondition$: BehaviorSubject<boolean>\r\n    ) {\r\n    const actions = this.buildActions(\r\n      workspace,\r\n      rowsInMapExtentCheckCondition$,\r\n      selectOnlyCheckCondition$\r\n      );\r\n    workspace.actionStore.load(actions);\r\n  }\r\n\r\n  buildActions(\r\n    workspace: WfsWorkspace,\r\n    rowsInMapExtentCheckCondition$: BehaviorSubject<boolean>,\r\n    selectOnlyCheckCondition$: BehaviorSubject<boolean>\r\n    ): Action[] {\r\n    this.zoomAuto$.next(this.zoomAuto);\r\n    this.storageChange$$ = this.storageService.storageChange$\r\n      .pipe(skipWhile((storageChange: StorageServiceEvent) =>\r\n        storageChange?.key !== 'zoomAuto' || storageChange?.event === StorageServiceEventEnum.CLEARED))\r\n      .subscribe(() => {\r\n        this.zoomAuto$.next(this.zoomAuto);\r\n        handleZoomAuto(workspace, this.storageService);\r\n      });\r\n    const actions = [\r\n      {\r\n        id: 'zoomAuto',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.zoomAuto.title',\r\n        tooltip: 'igo.integration.workspace.zoomAuto.tooltip',\r\n        checkCondition: this.zoomAuto$,\r\n        handler: () => {\r\n          handleZoomAuto(workspace, this.storageService);\r\n          this.storageService.set('zoomAuto', !this.storageService.get('zoomAuto') as boolean);\r\n        }\r\n      },\r\n      {\r\n        id: 'filterInMapExtent',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.inMapExtent.title',\r\n        tooltip: mapExtentStrategyActiveToolTip(workspace),\r\n        checkCondition: rowsInMapExtentCheckCondition$,\r\n        handler: () => rowsInMapExtentCheckCondition$.next(!rowsInMapExtentCheckCondition$.value)\r\n      },\r\n      {\r\n        id: 'selectedOnly',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.selected.title',\r\n        tooltip: 'igo.integration.workspace.selected.title',\r\n        checkCondition: selectOnlyCheckCondition$,\r\n        handler: () => selectOnlyCheckCondition$.next(!selectOnlyCheckCondition$.value)\r\n      },\r\n      {\r\n        id: 'clearselection',\r\n        icon: 'select-off',\r\n        title: 'igo.integration.workspace.clearSelection.title',\r\n        tooltip: 'igo.integration.workspace.clearSelection.tooltip',\r\n        handler: (ws: WfsWorkspace) => {\r\n          ws.entityStore.state.updateMany(ws.entityStore.view.all(), { selected: false });\r\n        },\r\n        args: [workspace],\r\n        availability: (ws: WfsWorkspace) => noElementSelected(ws)\r\n      },\r\n      {\r\n        id: 'wfsDownload',\r\n        icon: 'file-export',\r\n        title: 'igo.integration.workspace.download.title',\r\n        tooltip: 'igo.integration.workspace.download.tooltip',\r\n        handler: (ws: WfsWorkspace) => {\r\n          const filterStrategy = ws.entityStore.getStrategyOfType(EntityStoreFilterCustomFuncStrategy);\r\n          const filterSelectionStrategy = ws.entityStore.getStrategyOfType(EntityStoreFilterSelectionStrategy);\r\n          const layersWithSelection = filterSelectionStrategy.active ? [ws.layer.id] : [];\r\n          this.toolState.toolToActivateFromOptions({\r\n            tool: 'importExport',\r\n            options: { layers: [ws.layer.id], featureInMapExtent: filterStrategy.active, layersWithSelection } as ExportOptions\r\n          });\r\n        },\r\n        args: [workspace]\r\n      },\r\n      {\r\n        id: 'ogcFilter',\r\n        icon: 'filter',\r\n        title: 'igo.integration.workspace.ogcFilter.title',\r\n        tooltip: 'igo.integration.workspace.ogcFilter.tooltip',\r\n        handler: (widget: Widget, ws: WfsWorkspace) => {\r\n          ws.activateWidget(widget, {\r\n            map: ws.map,\r\n            layer: ws.layer\r\n          });\r\n        },\r\n        args: [this.ogcFilterWidget, workspace]\r\n      },\r\n      {\r\n        id: 'maximize',\r\n        title: this.languageService.translate.instant('igo.integration.workspace.maximize'),\r\n        tooltip: this.languageService.translate.instant(\r\n          'igo.integration.workspace.maximizeTooltip'\r\n        ),\r\n        icon: 'resize',\r\n        display: () => {\r\n          return this.maximize$.pipe(map((v) => !v && !this.mediaService.isMobile()));\r\n        },\r\n        handler: () => {\r\n          if (!this.mediaService.isMobile()) {\r\n            this.maximize$.next(true);\r\n          }\r\n        },\r\n      },\r\n      {\r\n        id: 'standardExtent',\r\n        title: this.languageService.translate.instant(\r\n          'igo.integration.workspace.standardExtent'\r\n        ),\r\n        tooltip: this.languageService.translate.instant(\r\n          'igo.integration.workspace.standardExtentTooltip'\r\n        ),\r\n        icon: 'resize',\r\n        display: () => {\r\n          return this.maximize$.pipe(map((v) => v && !this.mediaService.isMobile()));\r\n        },\r\n        handler: () => {\r\n          this.maximize$.next(false);\r\n        }\r\n      }\r\n    ];\r\n    return (workspace.layer.dataSource as OgcFilterableDataSource).options.ogcFilters?.enabled ?\r\n    actions : actions.filter(action => action.id !== 'ogcFilter');\r\n  }\r\n}\r\n","import { Inject, Injectable, OnDestroy } from '@angular/core';\r\n\r\nimport {\r\n  Action,\r\n  EntityStoreFilterCustomFuncStrategy,\r\n  EntityStoreFilterSelectionStrategy,\r\n  Widget\r\n} from '@igo2/common';\r\n\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport {\r\n  EditionWorkspace,\r\n  mapExtentStrategyActiveToolTip,\r\n  noElementSelected,\r\n  ExportOptions,\r\n  OgcFilterWidget,\r\n  OgcFilterableDataSource,\r\n} from '@igo2/geo';\r\nimport { StorageService, StorageServiceEvent, StorageServiceEventEnum, LanguageService, MediaService} from '@igo2/core';\r\nimport { StorageState } from '../../storage/storage.state';\r\nimport { map, skipWhile } from 'rxjs/operators';\r\nimport { ToolState } from '../../tool/tool.state';\r\nimport { handleZoomAuto } from './workspace.utils';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class EditionActionsService implements OnDestroy {\r\n\r\n  public maximize$: BehaviorSubject<boolean> = new BehaviorSubject(\r\n    this.storageService.get('workspaceMaximize') as boolean\r\n  );\r\n\r\n  zoomAuto$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  private storageChange$$: Subscription;\r\n\r\n  get storageService(): StorageService {\r\n    return this.storageState.storageService;\r\n  }\r\n\r\n  get zoomAuto(): boolean {\r\n    return this.storageService.get('zoomAuto') as boolean;\r\n  }\r\n\r\n  constructor(\r\n    @Inject(OgcFilterWidget) private ogcFilterWidget: Widget,\r\n    private storageState: StorageState,\r\n    public languageService: LanguageService,\r\n    private mediaService: MediaService,\r\n    private toolState: ToolState) {}\r\n\r\n  ngOnDestroy(): void {\r\n    if (this.storageChange$$) {\r\n      this.storageChange$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  loadActions(\r\n    workspace: EditionWorkspace,\r\n    rowsInMapExtentCheckCondition$: BehaviorSubject<boolean>,\r\n    selectOnlyCheckCondition$: BehaviorSubject<boolean>\r\n    ) {\r\n    const actions = this.buildActions(\r\n      workspace,\r\n      rowsInMapExtentCheckCondition$,\r\n      selectOnlyCheckCondition$\r\n      );\r\n    workspace.actionStore.load(actions);\r\n  }\r\n\r\n  buildActions(\r\n    workspace: EditionWorkspace,\r\n    rowsInMapExtentCheckCondition$: BehaviorSubject<boolean>,\r\n    selectOnlyCheckCondition$: BehaviorSubject<boolean>\r\n    ): Action[] {\r\n    this.zoomAuto$.next(this.zoomAuto);\r\n    this.storageChange$$ = this.storageService.storageChange$\r\n      .pipe(skipWhile((storageChange: StorageServiceEvent) =>\r\n        storageChange?.key !== 'zoomAuto' || storageChange?.event === StorageServiceEventEnum.CLEARED))\r\n      .subscribe(() => {\r\n        this.zoomAuto$.next(this.zoomAuto);\r\n        handleZoomAuto(workspace, this.storageService);\r\n      });\r\n    const actions = [\r\n      {\r\n        id: 'zoomAuto',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.zoomAuto.title',\r\n        tooltip: 'igo.integration.workspace.zoomAuto.tooltip',\r\n        checkCondition: this.zoomAuto$,\r\n        handler: () => {\r\n          handleZoomAuto(workspace, this.storageService);\r\n          this.storageService.set('zoomAuto', !this.storageService.get('zoomAuto') as boolean);\r\n        }\r\n      },\r\n      {\r\n        id: 'filterInMapExtent',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.inMapExtent.title',\r\n        tooltip: mapExtentStrategyActiveToolTip(workspace),\r\n        checkCondition: rowsInMapExtentCheckCondition$,\r\n        handler: () => rowsInMapExtentCheckCondition$.next(!rowsInMapExtentCheckCondition$.value)\r\n      },\r\n      {\r\n        id: 'selectedOnly',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.selected.title',\r\n        tooltip: 'igo.integration.workspace.selected.title',\r\n        checkCondition: selectOnlyCheckCondition$,\r\n        handler: () => selectOnlyCheckCondition$.next(!selectOnlyCheckCondition$.value)\r\n      },\r\n      {\r\n        id: 'clearselection',\r\n        icon: 'select-off',\r\n        title: 'igo.integration.workspace.clearSelection.title',\r\n        tooltip: 'igo.integration.workspace.clearSelection.tooltip',\r\n        handler: (ws: EditionWorkspace) => {\r\n          ws.entityStore.state.updateMany(ws.entityStore.view.all(), { selected: false });\r\n        },\r\n        args: [workspace],\r\n        availability: (ws: EditionWorkspace) => noElementSelected(ws)\r\n      },\r\n      {\r\n        id: 'wfsDownload',\r\n        icon: 'file-export',\r\n        title: 'igo.integration.workspace.download.title',\r\n        tooltip: 'igo.integration.workspace.download.tooltip',\r\n        handler: (ws: EditionWorkspace) => {\r\n          const filterStrategy = ws.entityStore.getStrategyOfType(EntityStoreFilterCustomFuncStrategy);\r\n          const filterSelectionStrategy = ws.entityStore.getStrategyOfType(EntityStoreFilterSelectionStrategy);\r\n          const layersWithSelection = filterSelectionStrategy.active ? [ws.layer.id] : [];\r\n          this.toolState.toolToActivateFromOptions({\r\n            tool: 'importExport',\r\n            options: { layers: [ws.layer.id], featureInMapExtent: filterStrategy.active, layersWithSelection } as ExportOptions\r\n          });\r\n        },\r\n        args: [workspace]\r\n      },\r\n      {\r\n        id: 'ogcFilter',\r\n        icon: 'filter',\r\n        title: 'igo.integration.workspace.ogcFilter.title',\r\n        tooltip: 'igo.integration.workspace.ogcFilter.tooltip',\r\n        handler: (widget: Widget, ws: EditionWorkspace) => {\r\n          ws.activateWidget(widget, {\r\n            map: ws.map,\r\n            layer: ws.layer\r\n          });\r\n        },\r\n        args: [this.ogcFilterWidget, workspace]\r\n      },\r\n      {\r\n        id: 'maximize',\r\n        title: this.languageService.translate.instant('igo.integration.workspace.maximize'),\r\n        tooltip: this.languageService.translate.instant(\r\n          'igo.integration.workspace.maximizeTooltip'\r\n        ),\r\n        icon: 'resize',\r\n        display: () => {\r\n          return this.maximize$.pipe(map((v) => !v && !this.mediaService.isMobile()));\r\n        },\r\n        handler: () => {\r\n          if (!this.mediaService.isMobile()) {\r\n            this.maximize$.next(true);\r\n          }\r\n        },\r\n      },\r\n      {\r\n        id: 'standardExtent',\r\n        title: this.languageService.translate.instant(\r\n          'igo.integration.workspace.standardExtent'\r\n        ),\r\n        tooltip: this.languageService.translate.instant(\r\n          'igo.integration.workspace.standardExtentTooltip'\r\n        ),\r\n        icon: 'resize',\r\n        display: () => {\r\n          return this.maximize$.pipe(map((v) => v && !this.mediaService.isMobile()));\r\n        },\r\n        handler: () => {\r\n          this.maximize$.next(false);\r\n        }\r\n      }\r\n    ];\r\n    return (workspace.layer.dataSource as OgcFilterableDataSource).options.ogcFilters?.enabled ?\r\n    actions : actions.filter(action => action.id !== 'ogcFilter');\r\n  }\r\n}\r\n","import { Injectable, OnDestroy } from '@angular/core';\r\n\r\nimport { BehaviorSubject, Subscription, Observable, of } from 'rxjs';\r\n\r\nimport {\r\n  EntityRecord,\r\n  Workspace,\r\n  WorkspaceStore,\r\n  Widget,\r\n  EntityStoreFilterCustomFuncStrategy,\r\n  EntityStoreFilterSelectionStrategy,\r\n  EntityState } from '@igo2/common';\r\nimport { WfsWorkspace, FeatureWorkspace, EditionWorkspace } from '@igo2/geo';\r\nimport { FeatureActionsService } from './shared/feature-actions.service';\r\nimport { WfsActionsService } from './shared/wfs-actions.service';\r\nimport { StorageService } from '@igo2/core';\r\nimport { EditionActionsService } from './shared/edition-actions.service';\r\n\r\n/**\r\n * Service that holds the state of the workspace module\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class WorkspaceState implements OnDestroy {\r\n\r\n  public workspacePanelExpanded: boolean = false;\r\n\r\n  readonly workspaceEnabled$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(false);\r\n  readonly rowsInMapExtentCheckCondition$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(true);\r\n  readonly selectOnlyCheckCondition$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(false);\r\n\r\n  readonly workspaceMaximize$: BehaviorSubject<boolean> = new BehaviorSubject(\r\n    this.storageService.get('workspaceMaximize') as boolean\r\n  );\r\n  private actionMaximize$$: Subscription[] = [];\r\n\r\n  private rowsInMapExtentCheckCondition$$: Subscription;\r\n  private selectOnlyCheckCondition$$: Subscription;\r\n\r\n  /** Subscription to the active workspace */\r\n  private activeWorkspace$$: Subscription;\r\n\r\n  /** Subscription to the active workspace widget */\r\n  private activeWorkspaceWidget$$: Subscription;\r\n\r\n  /** Active widget observable. Only one may be active for all available workspaces */\r\n  readonly activeWorkspaceWidget$: BehaviorSubject<Widget> = new BehaviorSubject<Widget>(undefined);\r\n\r\n  /**\r\n   * Observable of the active workspace\r\n   */\r\n  public workspace$ = new BehaviorSubject<Workspace>(undefined);\r\n\r\n  /**\r\n   * Store that holds all the available workspaces\r\n   */\r\n  get store(): WorkspaceStore { return this._store; }\r\n  private _store: WorkspaceStore;\r\n\r\n  get workspaceSelection() {\r\n    if (this.workspace$.value) {\r\n    return this.workspace$.value?.entityStore.stateView.manyBy((r) => r.state.selected === true);\r\n    } else {\r\n      return [];\r\n    }\r\n  }\r\n\r\n  get workspaceSelection$(): Observable<EntityRecord<object, EntityState>[]> {\r\n    if (this.workspace$.value) {\r\n      return this.workspace$.value?.entityStore?.stateView.manyBy$((r) => r.state.selected === true);\r\n    } else {\r\n      return of([]);\r\n    }\r\n  }\r\n\r\n  constructor(\r\n    private featureActionsService: FeatureActionsService,\r\n    private wfsActionsService: WfsActionsService,\r\n    private editionActionsService: EditionActionsService,\r\n    private storageService: StorageService\r\n  ) {\r\n    this.initWorkspaces();\r\n  }\r\n\r\n  /**\r\n   * Initialize the workspace store. Each time a workspace is activated,\r\n   * subscribe to it's active widget. Tracking the active widget is useful\r\n   * to make sure only one widget is active at a time.\r\n   */\r\n  private initWorkspaces() {\r\n    this._store = new WorkspaceStore([]);\r\n    this._store.stateView\r\n      .firstBy$((record: EntityRecord<Workspace>) => record.state.active === true)\r\n      .subscribe((record: EntityRecord<Workspace>) => {\r\n        const workspace = record ? record.entity : undefined;\r\n        this.workspace$.next(workspace);\r\n      });\r\n\r\n    this._store.stateView.all$()\r\n    .subscribe((workspaces: EntityRecord<Workspace>[]) => {\r\n      workspaces.map((wks: EntityRecord<Workspace>) => {\r\n        if (wks.entity.actionStore.empty) {\r\n          if (wks.entity instanceof WfsWorkspace) {\r\n            this.wfsActionsService.loadActions(\r\n              wks.entity,\r\n              this.rowsInMapExtentCheckCondition$,\r\n              this.selectOnlyCheckCondition$);\r\n          } else if (wks.entity instanceof FeatureWorkspace) {\r\n            this.featureActionsService.loadActions(\r\n              wks.entity,\r\n              this.rowsInMapExtentCheckCondition$,\r\n              this.selectOnlyCheckCondition$);\r\n          } else if (wks.entity instanceof EditionWorkspace) {\r\n            this.editionActionsService.loadActions(\r\n              wks.entity,\r\n              this.rowsInMapExtentCheckCondition$,\r\n              this.selectOnlyCheckCondition$);\r\n          }\r\n        }\r\n\r\n      });\r\n    });\r\n\r\n    this.actionMaximize$$.push(this.featureActionsService.maximize$.subscribe(maximized => {\r\n      this.setWorkspaceIsMaximized(maximized);\r\n    }));\r\n\r\n    this.actionMaximize$$.push(this.wfsActionsService.maximize$.subscribe(maximized => {\r\n      this.setWorkspaceIsMaximized(maximized);\r\n    }));\r\n\r\n    this.actionMaximize$$.push(this.editionActionsService.maximize$.subscribe(maximized => {\r\n      this.setWorkspaceIsMaximized(maximized);\r\n    }));\r\n\r\n    this.activeWorkspace$$ = this.workspace$\r\n      .subscribe((workspace: Workspace) => {\r\n        if (this.activeWorkspaceWidget$$ !== undefined) {\r\n          this.activeWorkspaceWidget$$.unsubscribe();\r\n          this.activeWorkspaceWidget$$ = undefined;\r\n        }\r\n\r\n        if (workspace !== undefined) {\r\n          this.activeWorkspaceWidget$$ = workspace.widget$\r\n            .subscribe((widget: Widget) => this.activeWorkspaceWidget$.next(widget));\r\n        }\r\n      });\r\n\r\n    this.rowsInMapExtentCheckCondition$$ = this.rowsInMapExtentCheckCondition$.subscribe((rowsInMapExtent) => {\r\n      this._store.stateView.all().map((wks: EntityRecord<Workspace>) => {\r\n        if (!wks.entity.actionStore.empty) {\r\n          const filterStrategy = wks.entity.entityStore.getStrategyOfType(EntityStoreFilterCustomFuncStrategy);\r\n          if (filterStrategy) {\r\n            if (rowsInMapExtent) {\r\n              filterStrategy.activate();\r\n            } else {\r\n              filterStrategy.deactivate();\r\n            }\r\n          }\r\n        }\r\n      });\r\n    });\r\n\r\n    this.selectOnlyCheckCondition$$ = this.selectOnlyCheckCondition$.subscribe((selectOnly) => {\r\n      this._store.stateView.all().map((wks: EntityRecord<Workspace>) => {\r\n        if (!wks.entity.actionStore.empty) {\r\n          const filterStrategy = wks.entity.entityStore.getStrategyOfType(EntityStoreFilterSelectionStrategy);\r\n          if (filterStrategy) {\r\n            if (selectOnly) {\r\n              filterStrategy.activate();\r\n            } else {\r\n              filterStrategy.deactivate();\r\n            }\r\n          }\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  private setWorkspaceIsMaximized(maximized: boolean) {\r\n    this.storageService.set('workspaceMaximize', maximized);\r\n    this.workspaceMaximize$.next(maximized);\r\n  }\r\n\r\n  public setActiveWorkspaceById(id: string) {\r\n    const wksFromId = this.store\r\n    .all()\r\n    .find(workspace => workspace.id === id);\r\n    if (wksFromId) {\r\n      this.store.activateWorkspace(wksFromId);\r\n    }\r\n  }\r\n\r\n  public setActiveWorkspaceByTitle(title: string) {\r\n    const wksFromTitle = this.store\r\n      .all()\r\n      .find(workspace => workspace.title === title);\r\n    if (wksFromTitle) {\r\n      this.store.activateWorkspace(wksFromTitle);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Teardown all the workspaces\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.teardownWorkspaces();\r\n    this.actionMaximize$$.map(a => a.unsubscribe());\r\n    if (this.rowsInMapExtentCheckCondition$$) {\r\n      this.selectOnlyCheckCondition$$.unsubscribe();\r\n    }\r\n    if (this.selectOnlyCheckCondition$$) {\r\n      this.selectOnlyCheckCondition$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Teardown the workspace store and any subscribers\r\n   */\r\n  private teardownWorkspaces() {\r\n    this.store.clear();\r\n    if (this.activeWorkspaceWidget$$ !== undefined) {\r\n      this.activeWorkspaceWidget$$.unsubscribe();\r\n    }\r\n    if (this.activeWorkspace$$ !== undefined) {\r\n      this.activeWorkspace$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { EntityRecord, EntityStore, EntityStoreFilterCustomFuncStrategy, EntityStoreStrategyFuncOptions } from '@igo2/common';\r\nimport { ConfigService, StorageService } from '@igo2/core';\r\nimport { SearchResult, SearchSourceService, SearchSource, CommonVectorStyleOptions } from '@igo2/geo';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\n/**\r\n * Service that holds the state of the search module\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class SearchState {\r\n  public searchOverlayStyle: CommonVectorStyleOptions = {};\r\n  public searchOverlayStyleSelection: CommonVectorStyleOptions = {};\r\n  public searchOverlayStyleFocus: CommonVectorStyleOptions = {};\r\n\r\n  public focusedOrResolution$$: Subscription;\r\n  public selectedOrResolution$$: Subscription;\r\n\r\n  readonly searchTermSplitter$: BehaviorSubject<string> = new BehaviorSubject('|');\r\n\r\n  readonly searchTerm$: BehaviorSubject<string> = new BehaviorSubject(undefined);\r\n\r\n  readonly searchType$: BehaviorSubject<string> = new BehaviorSubject(undefined);\r\n\r\n  readonly searchDisabled$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  readonly searchResultsGeometryEnabled$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  readonly searchSettingsChange$: BehaviorSubject<boolean> = new BehaviorSubject(undefined);\r\n\r\n  readonly selectedResult$: BehaviorSubject<SearchResult> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Store that holds the search results\r\n   */\r\n  readonly store: EntityStore<SearchResult> = new EntityStore<SearchResult>([]);\r\n\r\n  /**\r\n   * Search types currently enabled in the search source service\r\n   */\r\n  get searchTypes(): string[] {\r\n    return this.searchSourceService\r\n      .getEnabledSources()\r\n      .map((source: SearchSource) => (source.constructor as any).type);\r\n  }\r\n\r\n  constructor(\r\n    private searchSourceService: SearchSourceService,\r\n    private storageService: StorageService,\r\n    private configService: ConfigService) {\r\n    const searchOverlayStyle = this.configService.getConfig('searchOverlayStyle') as {\r\n      base?: CommonVectorStyleOptions,\r\n      selection?: CommonVectorStyleOptions,\r\n      focus?: CommonVectorStyleOptions\r\n    };\r\n    if (searchOverlayStyle) {\r\n      this.searchOverlayStyle = searchOverlayStyle.base;\r\n      this.searchOverlayStyleSelection = searchOverlayStyle.selection;\r\n      this.searchOverlayStyleFocus = searchOverlayStyle.focus;\r\n    }\r\n\r\n    const searchResultsGeometryEnabled = this.storageService.get('searchResultsGeometryEnabled') as boolean;\r\n    if (searchResultsGeometryEnabled) {\r\n      this.searchResultsGeometryEnabled$.next(searchResultsGeometryEnabled);\r\n    }\r\n    this.store.addStrategy(this.createCustomFilterTermStrategy(), false);\r\n  }\r\n\r\n  private createCustomFilterTermStrategy(): EntityStoreFilterCustomFuncStrategy {\r\n    const filterClauseFunc = (record: EntityRecord<SearchResult>) => {\r\n      return record.entity.meta.score === 100;\r\n    };\r\n    return new EntityStoreFilterCustomFuncStrategy({filterClauseFunc} as EntityStoreStrategyFuncOptions);\r\n  }\r\n\r\n  /**\r\n   * Activate custom strategy\r\n   *\r\n   */\r\n  activateCustomFilterTermStrategy() {\r\n    const strategy = this.store.getStrategyOfType(EntityStoreFilterCustomFuncStrategy);\r\n    if (strategy !== undefined) {\r\n      strategy.activate();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Deactivate custom strategy\r\n   *\r\n   */\r\n  deactivateCustomFilterTermStrategy() {\r\n    const strategy = this.store.getStrategyOfType(EntityStoreFilterCustomFuncStrategy);\r\n    if (strategy !== undefined) {\r\n      strategy.deactivate();\r\n    }\r\n  }\r\n\r\n  enableSearch() {\r\n    this.searchDisabled$.next(false);\r\n  }\r\n\r\n  disableSearch() {\r\n    this.searchDisabled$.next(true);\r\n  }\r\n\r\n  setSearchTerm(searchTerm: string) {\r\n    this.searchTerm$.next(searchTerm);\r\n  }\r\n\r\n  setSearchType(searchType: string) {\r\n    this.searchSourceService.enableSourcesByType(searchType);\r\n    this.searchType$.next(searchType);\r\n  }\r\n\r\n  setSearchSettingsChange() {\r\n    this.searchSettingsChange$.next(true);\r\n  }\r\n\r\n  setSelectedResult(result: SearchResult) {\r\n    this.selectedResult$.next(result);\r\n  }\r\n\r\n  setSearchResultsGeometryStatus(value) {\r\n    this.storageService.set('searchResultsGeometryEnabled', value);\r\n    this.searchResultsGeometryEnabled$.next(value);\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\n\r\nimport { IgoSearchModule } from '@igo2/geo';\r\n\r\nimport { SearchBarBindingDirective } from './search-bar-binding.directive';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [IgoSearchModule],\r\n  declarations: [SearchBarBindingDirective],\r\n  exports: [SearchBarBindingDirective],\r\n})\r\nexport class IgoAppSearchBarModule {}\r\n","import { NgModule, CUSTOM_ELEMENTS_SCHEMA } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoFlexibleModule, IgoCustomHtmlModule, IgoPanelModule } from '@igo2/common';\r\nimport {\r\n  IgoFeatureModule,\r\n  IgoSearchModule,\r\n  IgoFeatureDetailsModule\r\n} from '@igo2/geo';\r\n\r\nimport { SearchResultsToolComponent } from './search-results-tool.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatIconModule,\r\n    MatBadgeModule,\r\n    MatTooltipModule,\r\n    MatButtonModule,\r\n    IgoLanguageModule,\r\n    IgoFeatureModule,\r\n    IgoSearchModule,\r\n    IgoFlexibleModule,\r\n    IgoPanelModule,\r\n    IgoFeatureDetailsModule,\r\n    IgoCustomHtmlModule\r\n  ],\r\n  declarations: [SearchResultsToolComponent],\r\n  exports: [SearchResultsToolComponent],\r\n  schemas: [CUSTOM_ELEMENTS_SCHEMA]\r\n})\r\nexport class IgoAppSearchResultsToolModule {}\r\n","import { NgModule } from '@angular/core';\r\n\r\nimport { IgoAppSearchBarModule } from './search-bar/search-bar.module';\r\nimport { IgoAppSearchResultsToolModule } from './search-results-tool/search-results-tool.module';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [],\r\n  exports: [\r\n   IgoAppSearchBarModule,\r\n   IgoAppSearchResultsToolModule\r\n  ],\r\n})\r\nexport class IgoAppSearchModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Search</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: ConfigService, LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/search\">code of this example</a><br>\r\n    See search section of the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/environments\"> environment config</a>\r\n    <hr>\r\n    <br>\r\n    <span *ngIf=\"!isTouchScreen\" title=\"Details\">\r\n      F2 activate/deactivate the pointer location.\r\n    </span>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser #mapBrowser [map]=\"map\" [view]=\"view\" igoOverlay [igoContextMenu]=actionbarMenu igoLongPress\r\n\r\n    igoSearchPointerSummary\r\n    [igoSearchPointerSummaryDelay]=\"500\"\r\n    [igoSearchPointerSummaryEnabled]=\"igoSearchPointerSummaryEnabled\"\r\n    (menuPosition)=\"onContextMenuOpen($event)\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Search\">\r\n    <igo-search-bar\r\n      [term]=\"term\"\r\n      (pointerSummaryStatus)=\"onPointerSummaryStatusChange($event)\"\r\n      [searchSettings]=\"true\"\r\n      [store]=\"searchStore\"\r\n      [termSplitter]=\"termSplitter\"\r\n      (searchTermChange)=\"onSearchTermChange($event)\"\r\n      (search)=\"onSearch($event)\"\r\n      (clearFeature)=\"removeFeatureFromMap()\"\r\n      (searchSettingsChange)=\"onSearchSettingsChange()\">\r\n    </igo-search-bar>\r\n\r\n    <igo-search-results\r\n      [store]=\"searchStore\"\r\n      [term]=\"term\"\r\n      [termSplitter]=\"termSplitter\"\r\n      placeholder=\"false\"\r\n      [settingsChange$]=\"settingsChange$\"\r\n      (resultFocus)=\"onResultFocus($event)\"\r\n      (resultSelect)=\"onResultFocus($event)\"\r\n      (moreResults)=\"onSearch($event)\">\r\n        <ng-template #igoSearchItemToolbar let-result=\"result\">\r\n          <igo-search-add-button\r\n            [map]=\"map\"\r\n            [layer]=\"result\">\r\n          </igo-search-add-button>\r\n        </ng-template>\r\n    </igo-search-results>\r\n\r\n  </igo-panel>\r\n\r\n  <igo-panel *ngIf=\"selectedFeature\" title=\"Details\">\r\n    <igo-feature-details [feature]=\"selectedFeature\"></igo-feature-details>\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n\r\n<ng-template #actionbarMenu>\r\n  <igo-actionbar\r\n    [store]=\"store\"\r\n    [withIcon]=\"false\"\r\n    [horizontal]=\"true\"\r\n    [mode]=\"'context'\">\r\n  </igo-actionbar>\r\n</ng-template>\r\n\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppSearchComponent } from './search.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'search',\r\n    component: AppSearchComponent\r\n  }\r\n];\r\n\r\nexport const AppSearchRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { BehaviorSubject } from 'rxjs';\r\nimport {\r\n  Component,\r\n  ElementRef,\r\n  OnDestroy,\r\n  OnInit,\r\n  ViewChild\r\n} from '@angular/core';\r\nimport * as proj from 'ol/proj';\r\n\r\nimport { LanguageService, MediaService } from '@igo2/core';\r\nimport { EntityStore, ActionStore } from '@igo2/common';\r\nimport {\r\n  FEATURE,\r\n  Feature,\r\n  FeatureMotion,\r\n  GoogleLinks,\r\n  IgoMap,\r\n  LayerService,\r\n  MapService,\r\n  Layer,\r\n  ProjectionService,\r\n  Research,\r\n  SearchResult\r\n} from '@igo2/geo';\r\n\r\nimport { SearchState } from '@igo2/integration';\r\n\r\n@Component({\r\n  selector: 'app-search',\r\n  templateUrl: './search.component.html',\r\n  styleUrls: ['./search.component.scss']\r\n})\r\nexport class AppSearchComponent implements OnInit, OnDestroy {\r\n  public store = new ActionStore([]);\r\n\r\n  public igoSearchPointerSummaryEnabled: boolean = false;\r\n\r\n  public termSplitter: string = '|';\r\n\r\n  public map = new IgoMap({\r\n    overlay: true,\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 7\r\n  };\r\n\r\n  public osmLayer: Layer;\r\n\r\n  @ViewChild('mapBrowser', { read: ElementRef, static: true }) mapBrowser: ElementRef;\r\n\r\n  public lonlat;\r\n  public mapProjection: string;\r\n  public term: string;\r\n\r\n  public settingsChange$ = new BehaviorSubject<boolean>(undefined);\r\n\r\n  get searchStore(): EntityStore<SearchResult> {\r\n    return this.searchState.store;\r\n  }\r\n\r\n  get isTouchScreen(): boolean {\r\n    return this.mediaService.isTouchScreen();\r\n  }\r\n\r\n  public selectedFeature: Feature;\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private projectionService: ProjectionService,\r\n    private mapService: MapService,\r\n    private layerService: LayerService,\r\n    private searchState: SearchState,\r\n    private mediaService: MediaService\r\n  ) {\r\n    this.mapService.setMap(this.map);\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'OSM',\r\n        sourceOptions: {\r\n          type: 'osm'\r\n        }\r\n      })\r\n      .subscribe(layer => {\r\n        this.osmLayer = layer;\r\n        this.map.addLayer(layer);\r\n      });\r\n  }\r\n\r\n  onPointerSummaryStatusChange(value) {\r\n    this.igoSearchPointerSummaryEnabled = value;\r\n  }\r\n\r\n  onSearchTermChange(term = '') {\r\n    this.term = term;\r\n    const termWithoutHashtag = term.replace(/(#[^\\s]*)/g, '').trim();\r\n    if (termWithoutHashtag.length < 2) {\r\n      this.searchStore.clear();\r\n      this.selectedFeature = undefined;\r\n    }\r\n  }\r\n\r\n  onSearch(event: { research: Research; results: SearchResult[] }) {\r\n    const results = event.results;\r\n    this.searchStore.state.updateAll({ focused: false, selected: false });\r\n    const newResults = this.searchStore.entities$.value\r\n      .filter((result: SearchResult) => result.source !== event.research.source)\r\n      .concat(results);\r\n    this.searchStore.updateMany(newResults);\r\n  }\r\n\r\n  onSearchSettingsChange() {\r\n    this.settingsChange$.next(true);\r\n  }\r\n\r\n  /**\r\n   * Try to add a feature to the map when it's being focused\r\n   * @internal\r\n   * @param result A search result that could be a feature\r\n   */\r\n  onResultFocus(result: SearchResult) {\r\n    this.tryAddFeatureToMap(result);\r\n    this.selectedFeature = (result as SearchResult<Feature>).data;\r\n  }\r\n\r\n  /**\r\n   * Try to add a feature to the map overlay\r\n   * @param layer A search result that could be a feature\r\n   */\r\n  private tryAddFeatureToMap(layer: SearchResult) {\r\n    if (layer.meta.dataType !== FEATURE) {\r\n      return undefined;\r\n    }\r\n\r\n    // Somethimes features have no geometry. It happens with some GetFeatureInfo\r\n    if (layer.data.geometry === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.map.searchResultsOverlay.setFeatures(\r\n      [layer.data] as Feature[],\r\n      FeatureMotion.Default\r\n    );\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.store.load([\r\n      {\r\n        id: 'coordinates',\r\n        title: 'coordinates',\r\n        handler: () => this.searchCoordinate(this.lonlat)\r\n      },\r\n      {\r\n        id: 'googleMaps',\r\n        title: 'googleMap',\r\n        handler: () => this.openGoogleMaps(this.lonlat),\r\n      },\r\n      {\r\n        id: 'googleStreetView',\r\n        title: 'googleStreetView',\r\n        handler: () => this.openGoogleStreetView(this.lonlat)\r\n      }\r\n    ]);\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.store.destroy();\r\n  }\r\n\r\n  /*\r\n   * Remove a feature to the map overlay\r\n   */\r\n  removeFeatureFromMap() {\r\n    this.map.searchResultsOverlay.clear();\r\n  }\r\n\r\n  onContextMenuOpen(event: { x: number; y: number }) {\r\n    const position = this.mapPosition(event);\r\n    const coord = this.mapService.getMap().ol.getCoordinateFromPixel(position);\r\n    this.mapProjection = this.mapService.getMap().projection;\r\n    this.lonlat = proj.transform(coord, this.mapProjection, 'EPSG:4326');\r\n  }\r\n\r\n  mapPosition(event: { x: number; y: number }) {\r\n    const contextmenuPoint = event;\r\n    contextmenuPoint.y =\r\n      contextmenuPoint.y -\r\n      this.mapBrowser.nativeElement.getBoundingClientRect().top +\r\n      window.scrollY;\r\n    contextmenuPoint.x =\r\n      contextmenuPoint.x -\r\n      this.mapBrowser.nativeElement.getBoundingClientRect().left +\r\n      window.scrollX;\r\n    const position = [contextmenuPoint.x, contextmenuPoint.y];\r\n    return position;\r\n  }\r\n\r\n  searchCoordinate(lonlat) {\r\n    this.searchStore.clear();\r\n    this.term = lonlat.map((c) => c.toFixed(6)).join(', ');\r\n  }\r\n\r\n  openGoogleMaps(lonlat) {\r\n    window.open(GoogleLinks.getGoogleMapsCoordLink(lonlat[0], lonlat[1]));\r\n  }\r\n\r\n  openGoogleStreetView(lonlat) {\r\n    window.open(\r\n      GoogleLinks.getGoogleStreetViewLink(lonlat[0], lonlat[1])\r\n    );\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoMessageModule } from '@igo2/core';\r\n\r\nimport {\r\n  IgoPanelModule,\r\n  IgoActionbarModule,\r\n  IgoContextMenuModule\r\n} from '@igo2/common';\r\n\r\nimport {\r\n  IgoFeatureModule,\r\n  IgoMapModule,\r\n  IgoSearchModule,\r\n  provideIChercheSearchSource,\r\n  provideILayerSearchSource,\r\n  provideNominatimSearchSource,\r\n  provideIChercheReverseSearchSource,\r\n  provideCoordinatesReverseSearchSource,\r\n  provideCadastreSearchSource,\r\n  provideStoredQueriesSearchSource,\r\n  provideStoredQueriesReverseSearchSource\r\n} from '@igo2/geo';\r\n\r\nimport { IgoAppSearchModule } from '@igo2/integration';\r\n\r\nimport { AppSearchComponent } from './search.component';\r\nimport { AppSearchRoutingModule } from './search-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppSearchComponent],\r\n  imports: [\r\n    CommonModule,\r\n    AppSearchRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    MatTooltipModule,\r\n    IgoMessageModule.forRoot(),\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoSearchModule.forRoot(),\r\n    IgoAppSearchModule,\r\n    IgoActionbarModule,\r\n    IgoContextMenuModule,\r\n    IgoFeatureModule\r\n  ],\r\n  exports: [AppSearchComponent],\r\n  providers: [\r\n    provideCoordinatesReverseSearchSource(),\r\n    provideCadastreSearchSource(),\r\n    provideIChercheSearchSource(),\r\n    provideILayerSearchSource(),\r\n    provideNominatimSearchSource(),\r\n    provideIChercheReverseSearchSource(),\r\n    provideStoredQueriesSearchSource(),\r\n    provideStoredQueriesReverseSearchSource()\r\n  ]\r\n})\r\nexport class AppSearchModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppPrintComponent } from './print.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'print',\r\n    component: AppPrintComponent\r\n  }\r\n];\r\n\r\nexport const AppPrintRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { IgoMap, LayerService } from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-print',\r\n  templateUrl: './print.component.html',\r\n  styleUrls: ['./print.component.scss']\r\n})\r\nexport class AppPrintComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: false\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 9\r\n  };\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private layerService: LayerService\r\n  ) {\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'Quebec Base Map',\r\n        sourceOptions: {\r\n          type: 'wmts',\r\n          url: 'https://geoegl.msp.gouv.qc.ca/apis/carto/wmts/1.0.0/wmts',\r\n          layer: 'carte_gouv_qc_ro',\r\n          matrixSet: 'EPSG_3857',\r\n          version: '1.3.0',\r\n          crossOrigin: 'anonymous',\r\n          attributions: \" <a href='http://www.droitauteur.gouv.qc.ca/copyright.php' target='_blank'><img src='https://geoegl.msp.gouv.qc.ca/gouvouvert/public/images/quebec/gouv_qc_logo.png' width='64' height='14'>Gouvernement du Qubec</a> / <a href='https://www.igouverte.org/' target='_blank'>IGO2</a>\"\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'School board',\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n          params: {\r\n            LAYERS: 'MELS_CS_ANGLO_S',\r\n            VERSION: '1.3.0'\r\n          },\r\n          crossOrigin: 'anonymous'\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n    //\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'Embacle',\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n          params: {\r\n            LAYERS: 'vg_observation_v_inondation_embacle_wmst',\r\n            VERSION: '1.3.0'\r\n          },\r\n          crossOrigin: 'anonymous'\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    // this.layerService\r\n    //   .createAsyncLayer({\r\n    //     title: 'Geomet',\r\n    //     sourceOptions: {\r\n    //       type: 'wms',\r\n    //       url: 'http://geo.weather.gc.ca/geomet/?lang=fr',\r\n    //       params: {\r\n    //         LAYERS: 'RADAR_1KM_RDBR',\r\n    //         VERSION: '1.3.0'\r\n    //       },\r\n    //       crossOrigin: 'anonymous'\r\n    //     }\r\n    //   })\r\n    //   .subscribe(l => this.map.addLayer(l));\r\n\r\n    /*\r\n        //CORS error if activate (for test)\r\n        this.layerService\r\n          .createAsyncLayer({\r\n            title: 'Geomet',\r\n            sourceOptions: {\r\n              type: 'wms',\r\n              url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq?service=wms',\r\n              params: {\r\n                layers: 'swtq',\r\n                version: '1.3.0',\r\n              }\r\n            }\r\n          })\r\n          .subscribe(l => this.map.addLayer(l));\r\n    */\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Print</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/print\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n    <igo-geolocate-button [map]=\"map\" color=\"primary\"></igo-geolocate-button>\r\n    <igo-home-extent-button [map]=\"map\" color=\"primary\"></igo-home-extent-button>\r\n    <igo-rotation-button [map]=\"map\" [showIfNoRotation]=\"false\" color=\"primary\"></igo-rotation-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-print [map]=\"map\"></igo-print>\r\n\r\n</mat-card>\r\n\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMessageModule } from '@igo2/core';\r\nimport { IgoMapModule, IgoPrintModule } from '@igo2/geo';\r\n\r\nimport { AppPrintComponent } from './print.component';\r\nimport { AppPrintRoutingModule } from './print-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppPrintComponent],\r\n  imports: [\r\n    AppPrintRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoMessageModule,\r\n    IgoMapModule,\r\n    IgoPrintModule\r\n  ],\r\n  exports: [AppPrintComponent]\r\n})\r\nexport class AppPrintModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppImportExportComponent } from './import-export.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'import-export',\r\n    component: AppImportExportComponent\r\n  }\r\n];\r\n\r\nexport const AppImportExportRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { IgoMap, LayerService } from '@igo2/geo';\r\nimport { WorkspaceStore } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'app-import-export',\r\n  templateUrl: './import-export.component.html',\r\n  styleUrls: ['./import-export.component.scss']\r\n})\r\nexport class AppImportExportComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 9\r\n  };\r\n\r\n  public store = new WorkspaceStore([]);\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private layerService: LayerService\r\n  ) {\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'OSM',\r\n        sourceOptions: {\r\n          type: 'osm'\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Import / Export</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/import-export\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-import-export [store]=\"store\" [map]=\"map\"></igo-import-export>\r\n\r\n</mat-card>\r\n\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMessageModule } from '@igo2/core';\r\nimport {\r\n  IgoMapModule,\r\n  IgoImportExportModule,\r\n  provideStyleListOptions\r\n} from '@igo2/geo';\r\n\r\nimport { AppImportExportComponent } from './import-export.component';\r\nimport { AppImportExportRoutingModule } from './import-export-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppImportExportComponent],\r\n  imports: [\r\n    AppImportExportRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoMessageModule,\r\n    IgoMapModule,\r\n    IgoImportExportModule\r\n  ],\r\n  exports: [AppImportExportComponent],\r\n  providers: [\r\n    provideStyleListOptions({\r\n      path: './assets/import-style.json'\r\n    })\r\n  ]\r\n})\r\nexport class AppImportExport {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppDirectionsComponent } from './directions.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'directions',\r\n    component: AppDirectionsComponent\r\n  }\r\n];\r\n\r\nexport const AppDirectionsRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  LayerService,\r\n  MapService,\r\n  ProjectionService,\r\n  StopsStore,\r\n  StopsFeatureStore,\r\n  RoutesFeatureStore,\r\n  StepFeatureStore\r\n} from '@igo2/geo';\r\nimport { Subject } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'app-directions',\r\n  templateUrl: './directions.component.html',\r\n  styleUrls: ['./directions.component.scss']\r\n})\r\nexport class AppDirectionsComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 9,\r\n    geolocate: false\r\n  };\r\n\r\n  public stopsStore: StopsStore = new StopsStore([]);\r\n  public stopsFeatureStore: StopsFeatureStore = new StopsFeatureStore([], { map: this.map });\r\n  public stepFeatureStore: StepFeatureStore = new StepFeatureStore([], { map: this.map });\r\n  public routesFeatureStore: RoutesFeatureStore = new RoutesFeatureStore([], { map: this.map });\r\n  public zoomToActiveRoute$: Subject<void> = new Subject();\r\n\r\n  constructor(\r\n    private projectionService: ProjectionService,\r\n    private languageService: LanguageService,\r\n    private layerService: LayerService,\r\n    private mapService: MapService\r\n  ) {\r\n    this.mapService.setMap(this.map);\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'OSM',\r\n        sourceOptions: {\r\n          type: 'osm'\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Directions</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/directions\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n    <igo-geolocate-button [map]=\"map\" color=\"primary\"></igo-geolocate-button>\r\n    <igo-home-extent-button [map]=\"map\" color=\"primary\"></igo-home-extent-button>\r\n    <igo-rotation-button [map]=\"map\" [showIfNoRotation]=\"false\" color=\"primary\"></igo-rotation-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-directions\r\n    [stopsStore]=\"stopsStore\"\r\n    [stopsFeatureStore]=\"stopsFeatureStore\"\r\n    [stepFeatureStore]=\"stepFeatureStore\"\r\n    [routesFeatureStore]=\"routesFeatureStore\"\r\n    [zoomToActiveRoute$]=\"zoomToActiveRoute$\">  \r\n  </igo-directions>\r\n\r\n\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMessageModule } from '@igo2/core';\r\nimport {\r\n  IgoMapModule,\r\n  IgoDirectionsModule,\r\n  provideOsrmDirectionsSource\r\n} from '@igo2/geo';\r\n\r\nimport { AppDirectionsComponent } from './directions.component';\r\nimport { AppDirectionsRoutingModule } from './directions-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppDirectionsComponent],\r\n  imports: [\r\n    AppDirectionsRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoMessageModule,\r\n    IgoMapModule,\r\n    IgoDirectionsModule\r\n  ],\r\n  exports: [AppDirectionsComponent],\r\n  providers: [provideOsrmDirectionsSource()]\r\n})\r\nexport class AppDirectionsModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppTimeFilterComponent } from './time-filter.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'time-filter',\r\n    component: AppTimeFilterComponent\r\n  }\r\n];\r\n\r\nexport const AppTimeFilterRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  TimeFilterableDataSourceOptions,\r\n  TimeFilterType,\r\n  TimeFilterStyle\r\n} from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-time-filter',\r\n  templateUrl: './time-filter.component.html',\r\n  styleUrls: ['./time-filter.component.scss']\r\n})\r\nexport class AppTimeFilterComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 7\r\n  };\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService\r\n  ) {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    // const datasource: TimeFilterableDataSourceOptions = {\r\n    //   type: 'wms',\r\n    //   url: 'https://geoegl.msp.gouv.qc.ca/ws/igo_gouvouvert.fcgi',\r\n    //   params: {\r\n    //     layers: 'vg_observation_v_inondation_embacle_wmst',\r\n    //     version: '1.3.0'\r\n    //   },\r\n    //   timeFilterable: true,\r\n    //   timeFilter: {\r\n    //     min: '2017-01-01',\r\n    //     max: '2018-01-01',\r\n    //     range: true,\r\n    //     type: TimeFilterType.DATETIME,\r\n    //     style: TimeFilterStyle.SLIDER,\r\n    //     step: 86400000,\r\n    //     timeInterval: 2000\r\n    //   }\r\n    // };\r\n\r\n    const datasourceYear: TimeFilterableDataSourceOptions = {\r\n      type: 'wms',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        LAYERS: 'vg_observation_v_inondation_embacle_wmst',\r\n        VERSION: '1.3.0'\r\n      },\r\n      timeFilterable: true,\r\n      timeFilter: {\r\n        min: '2013',\r\n        max: '2019',\r\n        range: false,\r\n        type: TimeFilterType.YEAR,\r\n        style: TimeFilterStyle.SLIDER,\r\n        step: 1,\r\n        timeInterval: 2000\r\n      }\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasourceYear)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Embcle YEAR',\r\n            visible: true,\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Time filter</mat-card-title>\r\n  <mat-card-content>\r\n    <li>npm install --save moment@2.22.2</li>\r\n    <li>npm install --save @mat-datetimepicker/core@3.0.0-beta.0</li>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/time-filter\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Layers\">\r\n    <igo-time-filter-list [layers]=\"map.layers\"></igo-time-filter-list>\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoPanelModule } from '@igo2/common';\r\nimport { IgoMapModule, IgoFilterModule } from '@igo2/geo';\r\n\r\nimport { AppTimeFilterComponent } from './time-filter.component';\r\nimport { AppTimeFilterRoutingModule } from './time-filter-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppTimeFilterComponent],\r\n  imports: [\r\n    AppTimeFilterRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoFilterModule\r\n  ],\r\n  exports: [AppTimeFilterComponent]\r\n})\r\nexport class AppTimeFilterModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppOgcFilterComponent } from './ogc-filter.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'ogc-filter',\r\n    component: AppOgcFilterComponent\r\n  }\r\n];\r\n\r\nexport const AppOgcFilterRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  WMSDataSourceOptions,\r\n  WFSDataSourceOptions,\r\n  WFSDataSourceOptionsParams,\r\n  OgcFilterableDataSourceOptions,\r\n  AnyBaseOgcFilterOptions,\r\n  OgcFilterOperatorType,\r\n  OgcFilterDuringOptions\r\n} from '@igo2/geo';\r\n\r\nimport {Fill, Stroke, Circle, Style} from 'ol/style';\r\n\r\n@Component({\r\n  selector: 'app-ogc-filter',\r\n  templateUrl: './ogc-filter.component.html',\r\n  styleUrls: ['./ogc-filter.component.scss']\r\n})\r\nexport class AppOgcFilterComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 7\r\n  };\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService\r\n  ) {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    interface WFSoptions\r\n      extends WFSDataSourceOptions,\r\n        OgcFilterableDataSourceOptions {}\r\n\r\n    const datasource: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'SHP' // based on service capabilities\r\n      },\r\n      sourceFields: [\r\n        { name: 'code_municipalite', alias: '# de la municipalite' },\r\n        { name: 'date_observation', excludeFromOgcFilters: true },\r\n        { name: 'urgence', values: ['immdiate', 'inconnue'] }\r\n      ],\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        allowedOperatorsType: OgcFilterOperatorType.All,\r\n        filters: {\r\n          logical: 'Or',\r\n          filters: [\r\n            {\r\n              operator: 'PropertyIsEqualTo',\r\n              propertyName: 'code_municipalite',\r\n              expression: '10043'\r\n            },\r\n            {\r\n              operator: 'Intersects',\r\n              geometryName: 'the_geom',\r\n              wkt_geometry: `MULTIPOLYGON(((\r\n              -8379441.158019895 5844447.897707146,\r\n              -8379441.158019895 5936172.331649357,\r\n              -8134842.66750733 5936172.331649357,\r\n              -8134842.66750733 5844447.897707146,\r\n              -8379441.158019895 5844447.897707146\r\n            ), (\r\n              -8015003 5942074,\r\n              -8015003 5780349,\r\n              -7792364 5780349,\r\n              -7792364 5942074,\r\n              -8015003 5942074\r\n            )))`\r\n            }\r\n          ] as AnyBaseOgcFilterOptions[]\r\n        }\r\n      }\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasource)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Embcle (PropertyIsEqualTo OR Intersects)',\r\n            source: dataSource,\r\n            style: new Style({\r\n              image: new Circle({\r\n                radius: 5,\r\n                fill: new Fill({\r\n                  color: 'white'\r\n                }),\r\n                stroke: new Stroke({\r\n                  color: 'orange',\r\n                  width: 1\r\n                })\r\n              })\r\n            })\r\n          })\r\n        );\r\n      });\r\n\r\n    const datasourceDuringFilter: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'SHP' // based on service capabilities\r\n      },\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        allowedOperatorsType: OgcFilterOperatorType.All,\r\n        filters:\r\n          {\r\n            operator: 'During',\r\n            propertyName: 'date_observation',\r\n            begin: '2016-01-21T00:00:00-05:00',\r\n            end: '2016-01-26T00:00:00-05:00'\r\n          } as OgcFilterDuringOptions\r\n      },\r\n      minDate: '2016-01-01T00:00:00-05:00',\r\n      maxDate: '2016-02-10T00:00:00-05:00',\r\n      stepDate: 'P2D'\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasourceDuringFilter)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Embcle (During, Step: P2D)',\r\n            id: '1',\r\n            source: dataSource,\r\n            style: new Style({\r\n              image: new Circle({\r\n                radius: 5,\r\n                fill: new Fill({\r\n                  color: 'white'\r\n                }),\r\n                stroke: new Stroke({\r\n                  color: 'red',\r\n                  width: 1\r\n                })\r\n              })\r\n            })\r\n          })\r\n        );\r\n      });\r\n\r\n\r\n    const datasourceDuringFilterTime: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'SHP' // based on service capabilities\r\n      },\r\n      sourceFields: [\r\n        { name: 'date_observation', alias: 'Date de l\\'observation', allowedOperatorsType: 'Time' as OgcFilterOperatorType }\r\n      ],\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        allowedOperatorsType: OgcFilterOperatorType.All,\r\n        filters:\r\n          {\r\n            operator: 'During',\r\n            propertyName: 'date_observation',\r\n            begin: '2016-01-01T04:00:00-05:00',\r\n            end: '2016-01-12T16:00:00-05:00'\r\n          } as OgcFilterDuringOptions\r\n      },\r\n      minDate: '2016-01-01T00:00:00-05:00',\r\n      maxDate: '2016-02-14T20:00:00-05:00',\r\n      stepDate: 'PT4H'\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasourceDuringFilterTime)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Embcle (During, Step: PT4H)',\r\n            id: '2',\r\n            source: dataSource,\r\n            style: new Style({\r\n              image: new Circle({\r\n                radius: 5,\r\n                fill: new Fill({\r\n                  color: 'white'\r\n                }),\r\n                stroke: new Stroke({\r\n                  color: 'blue',\r\n                  width: 1\r\n                })\r\n              })\r\n            })\r\n          })\r\n        );\r\n      });\r\n\r\n    const datasourceDuringFilterTimeMonth: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'SHP' // based on service capabilities\r\n      },\r\n      sourceFields: [\r\n        { name: 'date_observation', alias: 'Date de l\\'observation', allowedOperatorsType: 'Time' as OgcFilterOperatorType }\r\n      ],\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        allowedOperatorsType: OgcFilterOperatorType.All,\r\n        filters:\r\n          {\r\n            operator: 'During',\r\n            propertyName: 'date_observation',\r\n            begin: '2016-01-01T00:00:00-05:00',\r\n            end: '2016-03-31T00:00:00-05:00',\r\n            displayFormat: 'MMMM'\r\n          } as OgcFilterDuringOptions\r\n      },\r\n      minDate: '2016-01-01T00:00:00-05:00',\r\n      maxDate: '2018-12-31T00:00:00-05:00',\r\n      stepDate: 'P1M'\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasourceDuringFilterTimeMonth)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Embcle (During, Step: P1M)',\r\n            id: '3',\r\n            source: dataSource,\r\n            style: new Style({\r\n              image: new Circle({\r\n                radius: 5,\r\n                fill: new Fill({\r\n                  color: 'white'\r\n                }),\r\n                stroke: new Stroke({\r\n                  color: 'yellow',\r\n                  width: 1\r\n                })\r\n              })\r\n            })\r\n          })\r\n        );\r\n      });\r\n\r\n    const datasourceDuringFilterTimeYear: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'SHP' // based on service capabilities\r\n      },\r\n      sourceFields: [\r\n        { name: 'date_observation', alias: 'Date de l\\'observation', allowedOperatorsType: 'Time' as OgcFilterOperatorType }\r\n      ],\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        allowedOperatorsType: OgcFilterOperatorType.All,\r\n        filters:\r\n          {\r\n            operator: 'During',\r\n            propertyName: 'date_observation',\r\n            begin: '2014-01-01T00:00:00-05:00',\r\n            end: '2019-12-31T00:00:00-05:00',\r\n            sliderOptions: {\r\n              interval: 2000,\r\n              displayFormat: 'YY'\r\n            },\r\n            displayFormat: 'YYYY'\r\n          } as OgcFilterDuringOptions\r\n      },\r\n      minDate: '2014-01-01T00:00:00-05:00',\r\n      maxDate: '2019-12-31T00:00:00-05:00',\r\n      stepDate: 'P1Y'\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasourceDuringFilterTimeYear)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Embcle (During, Step: P1Y)',\r\n            id: '4',\r\n            source: dataSource,\r\n            style: new Style({\r\n              image: new Circle({\r\n                radius: 5,\r\n                fill: new Fill({\r\n                  color: 'white'\r\n                }),\r\n                stroke: new Stroke({\r\n                  color: 'green',\r\n                  width: 1\r\n                })\r\n              })\r\n            })\r\n          })\r\n        );\r\n      });\r\n\r\n    const datasourceDuringFilterTimeInterval: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'SHP' // based on service capabilities\r\n      },\r\n      sourceFields: [\r\n        { name: 'date_observation', alias: 'Date de l\\'observation', allowedOperatorsType: 'Time' as OgcFilterOperatorType }\r\n      ],\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        allowedOperatorsType: OgcFilterOperatorType.All,\r\n        filters:\r\n          {\r\n            operator: 'During',\r\n            propertyName: 'date_observation',\r\n            begin: 'today - 2 days', // \"now\" can also be used. Instead of midnight, the current time will be used\r\n            end: 'today', // \"now\" can also be used. Instead of midnight, the current time will be used\r\n          } as OgcFilterDuringOptions\r\n      },\r\n      minDate: '2016-01-01T00:00:00-05:00',\r\n      maxDate: '2025-12-31T00:00:00-05:00',\r\n      stepDate: 'P1D'\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasourceDuringFilterTimeInterval)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Embcle (During, Interval from Now, Step: P1D)',\r\n            id: '5',\r\n            source: dataSource,\r\n            style: new Style({\r\n              image: new Circle({\r\n                radius: 5,\r\n                fill: new Fill({\r\n                  color: 'white'\r\n                }),\r\n                stroke: new Stroke({\r\n                  color: 'black',\r\n                  width: 1\r\n                })\r\n              })\r\n            })\r\n          })\r\n        );\r\n      });\r\n\r\n    const datasourceDuringFilterTimeRestrictedToStep: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'SHP' // based on service capabilities\r\n      },\r\n      sourceFields: [\r\n        { name: 'date_observation', alias: 'Date de l\\'observation', allowedOperatorsType: 'Time' as OgcFilterOperatorType }\r\n      ],\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        allowedOperatorsType: OgcFilterOperatorType.All,\r\n        filters:\r\n          {\r\n            operator: 'During',\r\n            propertyName: 'date_observation',\r\n            begin: '2019-01-01 00:00:00',\r\n            restrictToStep: true\r\n          } as OgcFilterDuringOptions\r\n      },\r\n      minDate: '2016-01-01T00:00:00-05:00',\r\n      maxDate: '2025-12-31T00:00:00-05:00',\r\n      stepDate: 'P1M'\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasourceDuringFilterTimeRestrictedToStep)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Embcle (During, RestrictToStep, Step: P1M)',\r\n            id: '6',\r\n            source: dataSource,\r\n            style: new Style({\r\n              image: new Circle({\r\n                radius: 5,\r\n                fill: new Fill({\r\n                  color: 'black'\r\n                }),\r\n                stroke: new Stroke({\r\n                  color: 'red',\r\n                  width: 1\r\n                })\r\n              })\r\n            })\r\n          })\r\n        );\r\n      });\r\n\r\n    const wmsOgcFilterOptions: WMSoptions = {\r\n        type: 'wms',\r\n        url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n        optionsFromCapabilities: true,\r\n        params: {\r\n          LAYERS: 'vg_observation_v_inondation23avril2017_wmst',\r\n          VERSION: '1.3.0'\r\n        },\r\n        sourceFields: [\r\n          { name: 'date_observation', alias: 'Date de l\\'observation', allowedOperatorsType: 'Time' as OgcFilterOperatorType }\r\n        ],\r\n        ogcFilters: {\r\n          enabled: true,\r\n          editable: true,\r\n          filters:\r\n          {\r\n            operator: 'During',\r\n            propertyName: 'date_observation'\r\n          } as OgcFilterDuringOptions,\r\n          allowedOperatorsType: OgcFilterOperatorType.Time\r\n        }\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(wmsOgcFilterOptions)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Inondation (During, optionsFromCapabilities)',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    interface WMSoptions\r\n      extends WMSDataSourceOptions,\r\n        OgcFilterableDataSourceOptions {}\r\n\r\n    const filterableWMSwithPushButtons: WMSoptions = {\r\n      type: 'wms',\r\n      url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n      urlWfs: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n      params: {\r\n        LAYERS: 'radars_photos',\r\n        VERSION: '1.3.0'\r\n      },\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        pushButtons: {\r\n          selectorType: 'pushButton',\r\n          order: 2,\r\n          groups : [\r\n            {title: 'Nom du group1 - push', name: '1 - push', ids : ['id1']},\r\n          ],\r\n          bundles: [\r\n            {\r\n              id: 'id1',\r\n              title: 'Rgions',\r\n              logical: 'Or',\r\n              vertical: true,\r\n              selectors: [\r\n                {\r\n                  title: 'Montral & Laval',\r\n                  enabled: false,\r\n                  tooltip: 'Here a tooltip explaning ...',\r\n                  filters: {\r\n                    logical: 'Or',\r\n                    filters: [\r\n                      {\r\n                        operator: 'PropertyIsEqualTo',\r\n                        propertyName: 'region',\r\n                        expression: 'Montral'\r\n                      },\r\n                      {\r\n                        operator: 'PropertyIsEqualTo',\r\n                        propertyName: 'region',\r\n                        expression: 'Laval'\r\n                      }\r\n                    ]\r\n                  }\r\n                },\r\n                {\r\n                  title: 'Outside Montral & Laval',\r\n                  enabled: false,\r\n                  tooltip: 'Here a tooltip explaning ...',\r\n                  filters: {\r\n                    logical: 'And',\r\n                    filters: [\r\n                      {\r\n                        operator: 'PropertyIsNotEqualTo',\r\n                        propertyName: 'region',\r\n                        expression: 'Montral'\r\n                      },\r\n                      {\r\n                        operator: 'PropertyIsNotEqualTo',\r\n                        propertyName: 'region',\r\n                        expression: 'Laval'\r\n                      }\r\n                    ]\r\n                  }\r\n                }\r\n              ]\r\n            }\r\n          ]\r\n        },\r\n        checkboxes: {\r\n          selectorType: 'checkbox',\r\n          order: 1,\r\n          groups : [\r\n            {title: 'Nom du group1 - checkbox', name: '1 - checkbox', ids : ['id1']},\r\n          ],\r\n          bundles: [\r\n            {\r\n              id: 'id1',\r\n              title: 'Type de radar photo',\r\n              logical: 'Or',\r\n              selectors: [\r\n                {\r\n                  title: 'Radar photo fixe',\r\n                  enabled: true,\r\n                  tooltip: 'Here a tooltip explaning ...',\r\n                  filters: {\r\n                    operator: 'PropertyIsEqualTo',\r\n                    propertyName: 'typeAppareil',\r\n                    expression: 'Radar photo fixe'\r\n                  }\r\n                },\r\n                {\r\n                  title: 'Radar photo mobile',\r\n                  enabled: false,\r\n                  tooltip: 'Here a tooltip explaning ...',\r\n                  filters: {\r\n                    operator: 'PropertyIsEqualTo',\r\n                    propertyName: 'typeAppareil',\r\n                    expression: 'Radar photo mobile'\r\n                  }\r\n                },\r\n                {\r\n                  title: 'Radar photo fixe + feu rouge',\r\n                  enabled: false,\r\n                  color: '0,200,0',\r\n                  tooltip: 'Here a tooltip explaning ...',\r\n                  filters: {\r\n                    operator: 'PropertyIsEqualTo',\r\n                    propertyName: 'typeAppareil',\r\n                    expression: 'Radar photo fixe et surveillance au feu rouge'\r\n                  }\r\n                },\r\n                {\r\n                  title: 'Radar feu rouge',\r\n                  enabled: false,\r\n                  color: '255,0,0',\r\n                  tooltip: 'Here a tooltip explaning ...',\r\n                  filters: {\r\n                    operator: 'PropertyIsEqualTo',\r\n                    propertyName: 'typeAppareil',\r\n                    expression: 'Appareil de surveillance au feu rouge'\r\n                  }\r\n                }\r\n              ]\r\n            }\r\n          ]\r\n        },\r\n        allowedOperatorsType: OgcFilterOperatorType.Basic\r\n        },\r\n      paramsWFS: {\r\n        featureTypes: 'radars_photos',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '1.1.0',\r\n        outputFormat: 'geojson',\r\n        outputFormatDownload: 'shp'\r\n      } as WFSDataSourceOptionsParams\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(filterableWMSwithPushButtons)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Filterable WMS layers with predefined filters (push buttons)',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    // const datasourceWmsWith2Layers: WMSoptions = {\r\n    //   type: 'wms',\r\n    //   url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n    //   urlWfs: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n    //   params: {\r\n    //     layers: 'stations_meteoroutieres,histo_stations_meteoroutieres',\r\n    //     version: '1.3.0'\r\n    //   },\r\n    //   ogcFilters: {\r\n    //     enabled: true,\r\n    //     editable: true\r\n    //   },\r\n    //   paramsWFS: {\r\n    //     featureTypes: 'histo_stations_meteoroutieres',\r\n    //     fieldNameGeometry: 'geometry',\r\n    //     maxFeatures: 10000,\r\n    //     version: '1.1.0',\r\n    //     outputFormat: 'geojson',\r\n    //     outputFormatDownload: 'shp'\r\n    //   } as WFSDataSourceOptionsParams\r\n    // };\r\n    //\r\n    // this.dataSourceService\r\n    //   .createAsyncDataSource(datasourceWmsWith2Layers)\r\n    //   .subscribe(dataSource => {\r\n    //     this.map.addLayer(\r\n    //       this.layerService.createLayer({\r\n    //         title: 'Layer build from 2 WMS layers',\r\n    //         source: dataSource\r\n    //       })\r\n    //     );\r\n    //   });\r\n\r\n    // const datasourceWms: WMSoptions = {\r\n    //   type: 'wms',\r\n    //   url: '/geoserver/wms',\r\n    //   urlWfs: '/geoserver/wfs',\r\n    //   params: {\r\n    //     LAYERS: 'water_areas',\r\n    //     VERSION: '1.3.0'\r\n    //   },\r\n    //   ogcFilters: {\r\n    //     enabled: true,\r\n    //     editable: true,\r\n    //     filters: {\r\n    //       operator: 'PropertyIsEqualTo',\r\n    //       propertyName: 'waterway',\r\n    //       expression: 'riverbank'\r\n    //     }\r\n    //   },\r\n    //   sourceFields: [\r\n    //     { name: 'waterway', alias: 'Chemin d eau' },\r\n    //     { name: 'osm_id' },\r\n    //     { name: 'landuse', values: ['yes', 'no'] }\r\n    //   ],\r\n    //   paramsWFS: {\r\n    //     featureTypes: 'water_areas',\r\n    //     fieldNameGeometry: 'the_geom',\r\n    //     maxFeatures: 10000,\r\n    //     version: '1.1.0',\r\n    //     outputFormat: 'application/json',\r\n    //     outputFormatDownload: 'application/vnd.google-earth.kml+xml'\r\n    //   } as WFSDataSourceOptionsParams\r\n    // };\r\n    //\r\n    // this.dataSourceService\r\n    //   .createAsyncDataSource(datasourceWms)\r\n    //   .subscribe(dataSource => {\r\n    //     this.map.addLayer(\r\n    //       this.layerService.createLayer({\r\n    //         title: 'Geoserver water_areas',\r\n    //         source: dataSource\r\n    //       })\r\n    //     );\r\n    //   });\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Ogc filter</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/ogc-filter\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Layers\">\r\n    <igo-ogc-filterable-list [map]=\"map\" [layers]=\"map.layers\">\r\n\r\n    </igo-ogc-filterable-list>\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoPanelModule } from '@igo2/common';\r\nimport { IgoMapModule, IgoFilterModule } from '@igo2/geo';\r\n\r\nimport { AppOgcFilterComponent } from './ogc-filter.component';\r\nimport { AppOgcFilterRoutingModule } from './ogc-filter-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppOgcFilterComponent],\r\n  imports: [\r\n    AppOgcFilterRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoFilterModule\r\n  ],\r\n  exports: [AppOgcFilterComponent]\r\n})\r\nexport class AppOgcFilterModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Query</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/query\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser\r\n    [map]=\"map\"\r\n    [view]=\"view\"\r\n    igoOverlay\r\n    igoQuery\r\n    [queryFeatures]=\"true\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel>\r\n    <igo-spatial-filter-type\r\n      [store]=\"spatialListStore\"\r\n      [selectedQueryType]=\"queryType\"\r\n      [zone]=\"zone\"\r\n      [layers]=\"activeLayers\"\r\n      (eventType)=\"getOutputType($event)\"\r\n      (eventQueryType)=\"getOutputQueryType($event)\"\r\n      (zoneChange)=\"onZoneChange($event)\"\r\n      (zoneWithBufferChange)=\"onZoneChange($event, true)\"\r\n      (bufferChange)=\"buffer = $event\"\r\n      (measureUnitChange)=\"measureUnit = $event\">\r\n    </igo-spatial-filter-type>\r\n\r\n    <igo-spatial-filter-item\r\n      [type]=\"type\"\r\n      [queryType]=\"queryType\"\r\n      [map]=\"map\"\r\n      [zone]=\"zone\"\r\n      [loading]=\"loading\"\r\n      [store]=\"store\"\r\n      [layers]=\"activeLayers\"\r\n      [allLayers]=\"layers\"\r\n      [thematicLength]=\"thematicLength\"\r\n      (radiusEvent)=\"buffer = $event\"\r\n      (bufferEvent)=\"buffer = $event\"\r\n      (measureUnitChange)=\"measureUnit = $event\"\r\n      (freehandControl)=\"freehandDrawIsActive = $event\"\r\n      (drawZoneEvent)=\"zone = $event\"\r\n      (zoneWithBufferChange)=\"onZoneChange($event, true)\"\r\n      (itemTypeChange)=\"itemType = $event\"\r\n      (thematicChange)=\"thematics = $event\"\r\n      (toggleSearch)=\"getOutputToggleSearch()\"\r\n      (clearButtonEvent)=\"clearMap()\"\r\n      (clearSearchEvent)=\"getOutputClearSearch()\">\r\n    </igo-spatial-filter-item>\r\n  </igo-panel>\r\n\r\n  <igo-panel>\r\n    <ng-container *ngIf=\"selectedFeature$ | async as feature\">\r\n      <igo-feature-details [feature]=\"feature\"></igo-feature-details>\r\n    </ng-container>\r\n  </igo-panel>\r\n</mat-card>","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppSpatialFilterComponent } from './spatial-filter.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'spatial-filter',\r\n    component: AppSpatialFilterComponent\r\n  }\r\n];\r\n\r\nexport const AppSpatialFilterRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, Input, ChangeDetectionStrategy, ChangeDetectorRef, OnDestroy, OnInit } from '@angular/core';\r\nimport { MatIconRegistry } from '@angular/material/icon';\r\nimport { Observable, forkJoin, Subject } from 'rxjs';\r\nimport { tap, take, takeUntil } from 'rxjs/operators';\r\n\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  Feature,\r\n  moveToOlFeatures,\r\n  FeatureMotion,\r\n  ClusterDataSource,\r\n  featureToOl,\r\n  DataSource,\r\n  QueryableDataSourceOptions,\r\n  SpatialFilterService,\r\n  SpatialFilterType,\r\n  SpatialFilterItemType,\r\n  SpatialFilterQueryType,\r\n  SpatialFilterThematic,\r\n  Layer,\r\n  VectorLayer,\r\n  createOverlayMarkerStyle,\r\n  MeasureLengthUnit\r\n} from '@igo2/geo';\r\nimport { EntityStore } from '@igo2/common';\r\nimport olFormatGeoJSON from 'ol/format/GeoJSON';\r\nimport olSourceVector from 'ol/source/Vector';\r\nimport olSourceCluster from 'ol/source/Cluster';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport * as olstyle from 'ol/style';\r\nimport { MessageService, LanguageService } from '@igo2/core';\r\n\r\n/**\r\n * Spatial Filter Type\r\n */\r\n@Component({\r\n  selector: 'app-spatial-filter',\r\n  templateUrl: './spatial-filter.component.html',\r\n  styleUrls: ['./spatial-filter.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AppSpatialFilterComponent implements OnInit, OnDestroy {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 6\r\n  };\r\n\r\n  @Input() type: SpatialFilterType;\r\n  @Input() itemType: SpatialFilterItemType = SpatialFilterItemType.Address;\r\n  @Input() freehandDrawIsActive: boolean;\r\n\r\n  public layers: Layer[] = [];\r\n  public activeLayers: Layer[] = [];\r\n\r\n  public queryType: SpatialFilterQueryType;\r\n  public thematics: SpatialFilterThematic[];\r\n  public zone: Feature;\r\n  public zoneWithBuffer: Feature;\r\n  public buffer = 0;\r\n\r\n  public iterator = 1;\r\n\r\n  public selectedFeature$: BehaviorSubject<Feature> = new BehaviorSubject(\r\n    undefined\r\n  );\r\n\r\n  private format = new olFormatGeoJSON();\r\n\r\n  public store: EntityStore<Feature> = new EntityStore<Feature>([]); // Store to print results at the end\r\n\r\n  public spatialListStore: EntityStore<Feature> = new EntityStore<Feature>([]);\r\n\r\n  public loading = false;\r\n\r\n  public thematicLength = 0;\r\n\r\n  public measureUnit: MeasureLengthUnit = MeasureLengthUnit.Meters;\r\n  private unsubscribe$ = new Subject<void>();\r\n\r\n  public defaultStyle: olstyle.Style | ((feature, resolution) => olstyle.Style);\r\n\r\n  constructor(\r\n    private matIconRegistry: MatIconRegistry,\r\n    private spatialFilterService: SpatialFilterService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService,\r\n    private messageService: MessageService,\r\n    private languageService: LanguageService,\r\n    private cdRef: ChangeDetectorRef\r\n  ) {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n  }\r\n\r\n  ngOnInit() {\r\n    for (const layer of this.map.layers) {\r\n      if (layer.title && layer.title.includes(this.languageService.translate.instant('igo.geo.spatialFilter.spatialFilter'))) {\r\n        this.layers.push(layer);\r\n      }\r\n    }\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.unsubscribe$.next();\r\n    this.unsubscribe$.complete();\r\n  }\r\n\r\n  getOutputType(event: SpatialFilterType) {\r\n    this.type = event;\r\n    this.queryType = undefined;\r\n  }\r\n\r\n  getOutputQueryType(event: SpatialFilterQueryType) {\r\n    this.queryType = event;\r\n    if (this.queryType) {\r\n      this.loadFilterList();\r\n    }\r\n  }\r\n\r\n  private loadFilterList() {\r\n    this.spatialFilterService\r\n      .loadFilterList(this.queryType)\r\n      .pipe(takeUntil(this.unsubscribe$))\r\n      .subscribe((features: Feature[]) => {\r\n        features.sort((a, b) => {\r\n          if (a.properties.nom < b.properties.nom) {\r\n            return -1;\r\n          }\r\n          if (a.properties.nom > b.properties.nom) {\r\n            return 1;\r\n          }\r\n          return 0;\r\n        });\r\n        this.spatialListStore.clear();\r\n        this.spatialListStore.load(features);\r\n      });\r\n  }\r\n\r\n  getOutputToggleSearch() {\r\n    this.loadThematics();\r\n  }\r\n\r\n  getOutputClearSearch() {\r\n    this.zone = undefined;\r\n    this.queryType = undefined;\r\n  }\r\n\r\n  clearMap() {\r\n    this.map.removeLayers(this.layers);\r\n    this.layers = [];\r\n    this.activeLayers = [];\r\n    this.thematicLength = 0;\r\n    this.iterator = 1;\r\n    if (this.type === SpatialFilterType.Predefined) {\r\n      this.zone = undefined;\r\n      this.queryType = undefined;\r\n    }\r\n  }\r\n\r\n  private loadThematics() {\r\n    this.loading = true;\r\n    let zeroResults = true;\r\n    let thematics;\r\n    if (this.buffer === 0 || this.type === SpatialFilterType.Point) {\r\n      this.tryAddFeaturesToMap([this.zone]);\r\n    }\r\n    if (this.itemType !== SpatialFilterItemType.Thematics) {\r\n      const theme: SpatialFilterThematic = {\r\n        name: ''\r\n      };\r\n      thematics = [theme];\r\n    } else {\r\n      thematics = this.thematics;\r\n    }\r\n    if (this.measureUnit === MeasureLengthUnit.Kilometers && this.type !== SpatialFilterType.Point) {\r\n      this.buffer = this.buffer * 1000;\r\n    }\r\n    if (this.type === SpatialFilterType.Polygon) {\r\n      this.buffer = 0; // to avoid buffer enter a second time in terrAPI\r\n    }\r\n\r\n    const observables$: Observable<Feature[]>[] = [];\r\n    thematics.forEach(thematic => {\r\n      observables$.push(\r\n        this.spatialFilterService\r\n          .loadFilterItem(\r\n            this.zone,\r\n            this.itemType,\r\n            this.queryType,\r\n            thematic,\r\n            this.buffer\r\n          )\r\n          .pipe(\r\n            tap((features: Feature[]) => {\r\n              this.store.insertMany(features);\r\n              const featuresPoint: Feature[] = [];\r\n              const featuresLinePoly: Feature[] = [];\r\n              let idPoint;\r\n              let idLinePoly;\r\n              features.forEach(feature => {\r\n                if (feature.geometry.type === 'Point') {\r\n                  feature.properties.longitude = feature.geometry.coordinates[0];\r\n                  feature.properties.latitude = feature.geometry.coordinates[1];\r\n                  featuresPoint.push(feature);\r\n                  idPoint = feature.meta.id;\r\n                } else {\r\n                  featuresLinePoly.push(feature);\r\n                  idLinePoly = feature.meta.id;\r\n                }\r\n              });\r\n\r\n              this.tryAddPointToMap(featuresPoint, idPoint);\r\n              this.tryAddLayerToMap(featuresLinePoly, idLinePoly);\r\n              if (features.length) {\r\n                zeroResults = false;\r\n                this.thematicLength += 1;\r\n                thematic.zeroResults = false;\r\n                this.cdRef.detectChanges();\r\n              } else {\r\n                thematic.zeroResults = true;\r\n              }\r\n\r\n              if (features.length >= 10000) {\r\n                this.messageService.alert(\r\n                  this.languageService.translate.instant(\r\n                    'igo.geo.spatialFilter.maxSizeAlert'\r\n                  ),\r\n                  this.languageService.translate.instant(\r\n                    'igo.geo.spatialFilter.warning'\r\n                  ),\r\n                  { timeOut: 10000 }\r\n                );\r\n              }\r\n            })\r\n          )\r\n      );\r\n    });\r\n\r\n    forkJoin(observables$).pipe(takeUntil(this.unsubscribe$)).subscribe(() => {\r\n      this.loading = false;\r\n      if (zeroResults) {\r\n        this.messageService.alert(\r\n          this.languageService.translate.instant(\r\n            'igo.geo.spatialFilter.zeroResults'\r\n          ),\r\n          this.languageService.translate.instant(\r\n            'igo.geo.spatialFilter.warning'\r\n          ),\r\n          { timeOut: 10000 }\r\n        );\r\n      }\r\n    });\r\n  }\r\n\r\n  onZoneChange(feature: Feature, buffer?: boolean) {\r\n    this.zone = feature;\r\n    if (feature) {\r\n      buffer ? this.tryAddFeaturesToMap([feature], true) : this.tryAddFeaturesToMap([feature]);\r\n      this.zoomToFeatureExtent(feature);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Try to add zone feature to the map overlay\r\n   */\r\n  public tryAddFeaturesToMap(features: Feature[], buffer?: boolean) {\r\n    let i = 1;\r\n    for (const feature of features) {\r\n      if (this.type === SpatialFilterType.Predefined) {\r\n        for (const layer of this.layers) {\r\n          if (\r\n            layer.options._internal &&\r\n            layer.options._internal.code === feature.properties.code &&\r\n            !buffer\r\n          ) {\r\n            if (!layer.title?.startsWith('Zone')) {\r\n              const index = this.layers.indexOf(layer);\r\n              this.layers.splice(index, 1);\r\n            }\r\n            return;\r\n          }\r\n          if (layer.title?.startsWith('Zone')) {\r\n            this.activeLayers = [];\r\n            const index = this.layers.indexOf(layer);\r\n            this.layers.splice(index, 1);\r\n            this.map.removeLayer(layer);\r\n          }\r\n        }\r\n      } else {\r\n        if (buffer) {\r\n          for (const layer of this.activeLayers) {\r\n            if (this.activeLayers.length === 1 && layer.title?.startsWith('Zone')) {\r\n              const index = this.layers.indexOf(layer);\r\n              this.layers.splice(index, 1);\r\n              this.map.removeLayer(layer);\r\n            }\r\n          }\r\n        }\r\n        this.activeLayers = [];\r\n      }\r\n      for (const layer of this.layers) {\r\n        if (layer.title?.startsWith('Zone')) {\r\n          i++;\r\n        }\r\n      }\r\n      this.defaultStyle = (_feature, resolution) => {\r\n        const coordinates = (features[0] as any).coordinates;\r\n        return new olstyle.Style({\r\n          image: new olstyle.Circle({\r\n            radius: coordinates\r\n              ? this.buffer /\r\n                Math.cos((Math.PI / 180) * coordinates[1]) /\r\n                resolution\r\n              : undefined,\r\n            fill: new olstyle.Fill({\r\n              color: 'rgba(200, 200, 20, 0.2)'\r\n            }),\r\n            stroke: new olstyle.Stroke({\r\n              width: 1,\r\n              color: 'orange'\r\n            })\r\n          }),\r\n          stroke: new olstyle.Stroke({\r\n            width: 1,\r\n            color: 'orange'\r\n          }),\r\n          fill: new olstyle.Fill({\r\n            color: 'rgba(200, 200, 20, 0.2)'\r\n          })\r\n        });\r\n      };\r\n      this.dataSourceService\r\n        .createAsyncDataSource({\r\n          type: 'vector',\r\n          queryable: true\r\n        } as QueryableDataSourceOptions)\r\n        .pipe(take(1))\r\n        .subscribe((dataSource: DataSource) => {\r\n          const olLayer = this.layerService.createLayer({\r\n            isIgoInternalLayer: true,\r\n            title: ('Zone ' + i + ' - ' + this.languageService.translate.instant(\r\n              'igo.geo.spatialFilter.spatialFilter'\r\n            )) as string,\r\n            workspace: { enabled: true },\r\n            _internal: {\r\n              code:\r\n                this.type === SpatialFilterType.Predefined\r\n                  ? feature.properties.code\r\n                  : undefined\r\n            },\r\n            source: dataSource,\r\n            visible: true\r\n          }) as VectorLayer;\r\n          const featuresOl = features.map(f => {\r\n            return featureToOl(f, this.map.projection);\r\n          });\r\n          if (this.type !== SpatialFilterType.Predefined) {\r\n            const type = this.type === SpatialFilterType.Point ? 'Cercle' : 'Polygone';\r\n            featuresOl[0].set('nom', 'Zone', true);\r\n            featuresOl[0].set('type', type, true);\r\n          }\r\n          const ol = dataSource.ol as olSourceVector<OlGeometry> | olSourceCluster;\r\n          ol.addFeatures(featuresOl);\r\n          olLayer.ol.setStyle(this.defaultStyle);\r\n          this.map.addLayer(olLayer);\r\n          this.layers.push(olLayer);\r\n          this.activeLayers.push(olLayer);\r\n          this.cdRef.detectChanges();\r\n        });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Try to add point features to the map\r\n   * Necessary to create clusters\r\n   */\r\n  private tryAddPointToMap(features: Feature[], id) {\r\n    let i = 1;\r\n    if (features.length) {\r\n      if (this.map === undefined) {\r\n        return;\r\n      }\r\n      for (const layer of this.layers) {\r\n        if (layer.title?.startsWith(features[0].meta.title)) {\r\n          i++;\r\n        }\r\n      }\r\n      this.dataSourceService\r\n        .createAsyncDataSource({\r\n          type: 'cluster',\r\n          id,\r\n          queryable: true,\r\n          distance: 120,\r\n          meta: {\r\n            title: 'Cluster'\r\n          }\r\n        } as QueryableDataSourceOptions)\r\n        .pipe(take(1))\r\n        .subscribe((dataSource: ClusterDataSource) => {\r\n          const icon = features[0].meta.icon;\r\n          let style: olstyle.Style;\r\n          if (!icon) {\r\n            style = createOverlayMarkerStyle();\r\n          } else {\r\n            style = this.createSvgIcon(icon) || createOverlayMarkerStyle();\r\n          }\r\n\r\n          const olLayer = this.layerService.createLayer({\r\n            isIgoInternalLayer: true,\r\n            title: (features[0].meta.title + ' ' + i + ' - ' + this.languageService.translate.instant(\r\n              'igo.geo.spatialFilter.spatialFilter'\r\n            )) as string,\r\n            source: dataSource,\r\n            visible: true,\r\n            style\r\n          });\r\n\r\n          const featuresOl = features.map(feature => {\r\n            return featureToOl(feature, this.map.projection);\r\n          });\r\n          const ol = dataSource.ol as olSourceCluster;\r\n          ol.getSource().addFeatures(featuresOl);\r\n          if (this.layers.find(layer => layer.id === olLayer.id)) {\r\n            this.map.removeLayer(\r\n              this.layers.find(layer => layer.id === olLayer.id)\r\n            );\r\n            i = i - 1;\r\n            olLayer.title = (features[0].meta.title + ' ' + i + ' - ' + this.languageService.translate.instant(\r\n              'igo.geo.spatialFilter.spatialFilter'\r\n            )) as string;\r\n            olLayer.options.title = olLayer.title;\r\n          }\r\n          this.iterator = i;\r\n          this.map.addLayer(olLayer);\r\n          this.layers.push(olLayer);\r\n          this.pushLayer(olLayer);\r\n          this.cdRef.detectChanges();\r\n        });\r\n    }\r\n  }\r\n\r\n  private createSvgIcon(icon): olstyle.Style {\r\n    let style: olstyle.Style;\r\n    this.matIconRegistry.getNamedSvgIcon(icon).subscribe(svgObj => {\r\n      const xmlSerializer = new XMLSerializer();\r\n      svgObj.setAttribute('width', '30');\r\n      svgObj.setAttribute('height', '30');\r\n      svgObj.setAttribute('fill', 'rgba(0, 128, 255)');\r\n      svgObj.setAttribute('stroke', 'white');\r\n      const svg = xmlSerializer.serializeToString(svgObj);\r\n      style = new olstyle.Style({\r\n        image: new olstyle.Icon({\r\n          src: 'data:image/svg+xml;utf8,' + svg\r\n        })\r\n      });\r\n    });\r\n    return style;\r\n  }\r\n  /**\r\n   * Try to add line or polygon features to the map\r\n   */\r\n  private tryAddLayerToMap(features: Feature[], id) {\r\n    let i = 1;\r\n    if (features.length) {\r\n      if (this.map === undefined) {\r\n        return;\r\n      }\r\n      for (const layer of this.layers) {\r\n        if (layer.title?.startsWith(features[0].meta.title)) {\r\n          i++;\r\n        }\r\n      }\r\n      this.dataSourceService\r\n        .createAsyncDataSource({\r\n          type: 'vector',\r\n          id,\r\n          queryable: true\r\n        } as QueryableDataSourceOptions)\r\n        .pipe(take(1))\r\n        .subscribe((dataSource: DataSource) => {\r\n          const olLayer = this.layerService.createLayer({\r\n            isIgoInternalLayer: true,\r\n            title: (features[0].meta.title + ' ' + i + ' - ' + this.languageService.translate.instant(\r\n              'igo.geo.spatialFilter.spatialFilter'\r\n            )) as string,\r\n            source: dataSource,\r\n            visible: true\r\n          });\r\n          const featuresOl = features.map(feature => {\r\n            return featureToOl(feature, this.map.projection);\r\n          });\r\n          const ol = dataSource.ol as olSourceVector<OlGeometry>;\r\n          ol.addFeatures(featuresOl);\r\n          if (this.layers.find(layer => layer.id === olLayer.id)) {\r\n            this.map.removeLayer(\r\n              this.layers.find(layer => layer.id === olLayer.id)\r\n            );\r\n            i = i - 1;\r\n            olLayer.title = (features[0].meta.title + ' ' + i + ' - ' + this.languageService.translate.instant(\r\n              'igo.geo.spatialFilter.spatialFilter'\r\n            )) as string;\r\n            olLayer.options.title = olLayer.title;\r\n          }\r\n          this.map.addLayer(olLayer);\r\n          this.layers.push(olLayer);\r\n          this.pushLayer(olLayer);\r\n          this.cdRef.detectChanges();\r\n        });\r\n    }\r\n  }\r\n\r\n  zoomToFeatureExtent(feature) {\r\n    if (feature) {\r\n      const olFeature = this.format.readFeature(feature, {\r\n        dataProjection: feature.projection,\r\n        featureProjection: this.map.projection\r\n      });\r\n      moveToOlFeatures(this.map, [olFeature], FeatureMotion.Zoom);\r\n    }\r\n  }\r\n\r\n  pushLayer(layer) {\r\n    for (const lay of this.activeLayers) {\r\n      if (lay.id === layer.id) {\r\n        return;\r\n      }\r\n    }\r\n\r\n    this.activeLayers.push(layer);\r\n  }\r\n}\r\n","import { CommonModule } from '@angular/common';\r\nimport { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoPanelModule, IgoFormModule } from '@igo2/common';\r\nimport { IgoMapModule, IgoFilterModule, IgoQueryModule, IgoFeatureModule, IgoFeatureDetailsModule } from '@igo2/geo';\r\nimport { IgoMessageModule } from '@igo2/core';\r\n\r\nimport { AppSpatialFilterComponent } from './spatial-filter.component';\r\nimport { AppSpatialFilterRoutingModule } from './spatial-filter-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppSpatialFilterComponent],\r\n  imports: [\r\n    AppSpatialFilterRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoMessageModule,\r\n    IgoQueryModule,\r\n    IgoFeatureModule,\r\n    IgoFeatureDetailsModule,\r\n    IgoFilterModule,\r\n    IgoFormModule,\r\n    CommonModule\r\n  ],\r\n  exports: [AppSpatialFilterComponent]\r\n})\r\nexport class AppSpatialFilterModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Workspace</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/workspace\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-workspace-selector\r\n    igoWorkspaceSelector\r\n    [store]=\"workspaceStore\"\r\n    [map]=\"map\">\r\n  </igo-workspace-selector>\r\n\r\n  <ng-container *ngIf=\"selectedWorkspace$ | async as workspace\">\r\n    <igo-entity-table-paginator\r\n      *ngIf=\"workspace.inResolutionRange$ | async\"\r\n      [store]=\"workspace.entityStore\"\r\n      [paginatorOptions]=\"paginatorOptions\"\r\n      [entitySortChange$]=\"entitySortChange$\"\r\n      (paginatorChange)=\"paginatorChange($event)\">\r\n    </igo-entity-table-paginator>\r\n  </ng-container>\r\n\r\n  <ng-container *ngIf=\"selectedWorkspace$ | async as workspace\">\r\n    <igo-actionbar\r\n      *ngIf=\"workspace.actionStore\"\r\n      [store]=\"workspace.actionStore\"\r\n      [horizontal]=\"true\"\r\n      [withToggleButton]=\"true\"\r\n      [withTitle]=\"true\"\r\n      [mode]=\"actionbarMode\">\r\n    </igo-actionbar>\r\n\r\n    <igo-entity-table\r\n      *ngIf=\"workspace.entityStore && workspace.meta && workspace.meta.tableTemplate && (workspace.inResolutionRange$ | async)\"\r\n      class=\"table-compact table-centered\"\r\n      [paginator]=\"workspacePaginator\"\r\n      [scrollBehavior]=\"scrollBehavior\"\r\n      [store]=\"workspace.entityStore\"\r\n      [template]=\"workspace.meta.tableTemplate\">\r\n    </igo-entity-table>\r\n    <mat-card-content\r\n    *ngIf=\"(workspace.inResolutionRange$ | async) === false\">\r\n      No data available at this scale. Please zoom in. \r\n    </mat-card-content>\r\n\r\n    <igo-workspace-widget-outlet [workspace]=\"workspace\"></igo-workspace-widget-outlet>\r\n\r\n  </ng-container>\r\n\r\n</mat-card>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppWorkspaceComponent } from './workspace.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'workspace',\r\n    component: AppWorkspaceComponent\r\n  }\r\n];\r\n\r\nexport const AppWorkspaceRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit } from '@angular/core';\r\n\r\nimport { Observable, BehaviorSubject } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  ActionbarMode,\r\n  EntityRecord,\r\n  EntityTableScrollBehavior,\r\n  Workspace,\r\n  WorkspaceStore,\r\n  EntityTablePaginatorOptions\r\n} from '@igo2/common';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  WFSDataSourceOptions\r\n} from '@igo2/geo';\r\nimport { MatPaginator } from '@angular/material/paginator';\r\nimport { WorkspaceState } from '@igo2/integration';\r\n\r\n@Component({\r\n  selector: 'app-workspace',\r\n  templateUrl: './workspace.component.html',\r\n  styleUrls: ['./workspace.component.scss']\r\n})\r\nexport class AppWorkspaceComponent implements OnInit {\r\n\r\n  public workspacePaginator: MatPaginator;\r\n  entitySortChange$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  public paginatorOptions: EntityTablePaginatorOptions = {\r\n    pageSize: 5, // Number of items to display on a page.\r\n    pageSizeOptions: [1, 5, 10, 15, 30, 50, 100], // The set of provided page size options to display to the user.\r\n    showFirstLastButtons: true // Whether to show the first/last buttons UI to the user.\r\n  };\r\n\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-72, 47.2],\r\n    zoom: 5\r\n  };\r\n\r\n  get workspaceStore(): WorkspaceStore {\r\n    return this.workspaceState.store;\r\n  }\r\n\r\n  public selectedWorkspace$: Observable<Workspace>;\r\n\r\n  public actionbarMode = ActionbarMode.Overlay;\r\n\r\n  public scrollBehavior = EntityTableScrollBehavior.Instant;\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService,\r\n    public workspaceState: WorkspaceState,\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.selectedWorkspace$ = this.workspaceStore.stateView\r\n      .firstBy$(\r\n        (record: EntityRecord<Workspace>) => record.state.selected === true\r\n      )\r\n      .pipe(\r\n        map((record: EntityRecord<Workspace>) => {\r\n          const entity = record === undefined ? undefined : record.entity;\r\n          if (entity) {\r\n            // In fact, the download action is not fully functionnal into the igo2-lib demo\r\n            // The reason why it's has been remove is that this button trigger a tool (importExport)\r\n            // and this tool is not available in the igo2-lib demo.\r\n            // This is why it's has been removed frome the actions's list.\r\n            // Refer to the igo2 demo at https://infra-geo-ouverte.github.io/igo2/\r\n            entity.actionStore.view.filter((action) => {\r\n              return action.id !== 'wfsDownload';\r\n            });\r\n          }\r\n          return entity;\r\n\r\n        })\r\n      );\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    // const wmsDataSourceOptions = {\r\n    //   type: 'wms',\r\n    //   url: 'https://ahocevar.com/geoserver/wms',\r\n    //   urlWfs: 'https://ahocevar.com/geoserver/wfs',\r\n    //   params: {\r\n    //     LAYERS: 'water_areas',\r\n    //     VERSION: '1.3.0'\r\n    //   },\r\n    //   paramsWFS: {\r\n    //     featureTypes: 'water_areas',\r\n    //     fieldNameGeometry: 'the_geom',\r\n    //     maxFeatures: 10000,\r\n    //     version: '1.1.0',\r\n    //     outputFormat: 'application/json',\r\n    //     outputFormatDownload: 'application/vnd.google-earth.kml+xml'\r\n    //   },\r\n    //   sourceFields: [\r\n    //     {name: 'waterway', alias: 'Chemin d eau'},\r\n    //     {name: 'osm_id'},\r\n    //     {name: 'landuse'}\r\n    //   ],\r\n    //   ogcFilters: {\r\n    //     enabled: true,\r\n    //     editable: true\r\n    //   },\r\n    //   serverType: 'geoserver'\r\n    // };\r\n    //\r\n    // this.dataSourceService\r\n    //   .createAsyncDataSource(wmsDataSourceOptions as OgcFilterableDataSourceOptions)\r\n    //   .subscribe(dataSource => {\r\n    //     const layer = {\r\n    //       optionsFromCapabilities: true,\r\n    //       title: 'WMS Geoserver filterable ',\r\n    //       visible: true,\r\n    //       source: dataSource\r\n    //     };\r\n    //     this.map.addLayer(this.layerService.createLayer(layer));\r\n    //   });\r\n\r\n    const wfsDataSourceOptions: WFSDataSourceOptions = {\r\n      type: 'wfs',\r\n      url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n      params: {\r\n        featureTypes: 'etablissement_mtq',\r\n        fieldNameGeometry: 'geometry',\r\n        version: '2.0.0',\r\n        outputFormat: 'geojson'\r\n      },\r\n      sourceFields: [\r\n        { name: 'idetablis', alias: 'ID' },\r\n        { name: 'nometablis', alias: 'Name' },\r\n        { name: 'typetablis', alias: 'Type' }\r\n      ]\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(wfsDataSourceOptions)\r\n      .subscribe(dataSource => {\r\n        const layer = {\r\n          title: 'Simple WFS ',\r\n          maxResolution: 3000,\r\n          visible: true,\r\n          source: dataSource\r\n        };\r\n        this.map.addLayer(this.layerService.createLayer(layer));\r\n      });\r\n  }\r\n\r\n  paginatorChange(event: MatPaginator) {\r\n    this.workspacePaginator = event;\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport {\r\n  IgoActionModule,\r\n  IgoEntityModule,\r\n  IgoWorkspaceModule,\r\n  IgoPanelModule\r\n} from '@igo2/common';\r\nimport {\r\n  IgoMapModule,\r\n  IgoGeoWorkspaceModule\r\n} from '@igo2/geo';\r\n\r\nimport { AppWorkspaceComponent } from './workspace.component';\r\nimport { AppWorkspaceRoutingModule } from './workspace-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppWorkspaceComponent],\r\n  imports: [\r\n    CommonModule,\r\n    AppWorkspaceRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoActionModule,\r\n    IgoEntityModule,\r\n    IgoWorkspaceModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoGeoWorkspaceModule\r\n  ],\r\n  exports: [AppWorkspaceComponent]\r\n})\r\nexport class AppWorkspaceModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Context</mat-card-title>\r\n  <mat-card-content>\r\n    <p>* Dependencies: LanguageService</p>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/context/context\">code of this example</a><br>\r\n    See <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/contexts\"> contexts</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser\r\n    igoMapContext\r\n    igoLayerContext\r\n    [map]=\"map\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n    <igo-geolocate-button [map]=\"map\" color=\"primary\"></igo-geolocate-button>\r\n    <igo-home-extent-button [map]=\"map\" color=\"primary\"></igo-home-extent-button>\r\n    <igo-rotation-button [map]=\"map\" [showIfNoRotation]=\"true\" color=\"primary\"></igo-rotation-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Contexts list\">\r\n    <igo-context-list igoContextListBinding [map]=\"map\"></igo-context-list>\r\n  </igo-panel>\r\n\r\n  <igo-panel title=\"Layers\">\r\n    <igo-layer-list igoLayerListBinding [map]=\"map\">\r\n      <ng-template #igoLayerItemToolbar let-layer=\"layer\">\r\n        <igo-metadata-button [layer]=\"layer\"></igo-metadata-button>\r\n      </ng-template>\r\n    </igo-layer-list>\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppContextComponent } from './context.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'context',\r\n    component: AppContextComponent\r\n  }\r\n];\r\n\r\nexport const AppContextRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { IgoMap, OverlayService, MapService } from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-context',\r\n  templateUrl: './context.component.html',\r\n  styleUrls: ['./context.component.scss']\r\n})\r\nexport class AppContextComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 6\r\n  };\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private mapService: MapService,\r\n    private overlayService: OverlayService\r\n  ) {\r\n    this.mapService.setMap(this.map);\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { HttpClientJsonpModule } from '@angular/common/http';\r\nimport { IgoPanelModule } from '@igo2/common';\r\nimport {\r\n  IgoMapModule,\r\n  IgoLayerModule,\r\n  IgoMetadataModule,\r\n  IgoOverlayModule,\r\n  IgoQueryModule,\r\n  IgoFeatureModule\r\n} from '@igo2/geo';\r\nimport { IgoContextManagerModule } from '@igo2/context';\r\n\r\nimport { AppContextComponent } from './context.component';\r\nimport { AppContextRoutingModule } from './context-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppContextComponent],\r\n  imports: [\r\n    HttpClientJsonpModule,\r\n    AppContextRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoLayerModule,\r\n    IgoMetadataModule,\r\n    IgoOverlayModule,\r\n    IgoQueryModule,\r\n    IgoFeatureModule,\r\n    IgoContextManagerModule\r\n  ],\r\n  exports: [AppContextComponent]\r\n})\r\nexport class AppContextModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { RouterModule, Routes } from '@angular/router';\r\n\r\nconst routes: Routes = [\r\n  { path: '', redirectTo: '/home', pathMatch: 'full' },\r\n  { path: '**', redirectTo: '/home' }\r\n];\r\n\r\n@NgModule({\r\n  imports: [RouterModule.forRoot(routes, { useHash: true })],\r\n  exports: [RouterModule]\r\n})\r\nexport class AppRoutingModule {}\r\n","import { MediaMatcher } from '@angular/cdk/layout';\r\nimport {\r\n  ChangeDetectorRef,\r\n  Component,\r\n  OnDestroy,\r\n  Renderer2\r\n} from '@angular/core';\r\n\r\nimport { userAgent } from '@igo2/utils';\r\nimport { version } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'app-root',\r\n  templateUrl: './app.component.html',\r\n  styleUrls: ['./app.component.scss']\r\n})\r\nexport class AppComponent implements OnDestroy {\r\n  mobileQuery: MediaQueryList;\r\n\r\n  public title = 'IGO';\r\n  public version = version;\r\n  private themeClass = 'deeppurple-theme';\r\n  private _mobileQueryListener: () => void;\r\n\r\n  constructor(\r\n    private changeDetectorRef: ChangeDetectorRef,\r\n    private media: MediaMatcher,\r\n    private renderer: Renderer2\r\n  ) {\r\n    this.mobileQuery = media.matchMedia('(max-width: 600px)');\r\n    this._mobileQueryListener = () => changeDetectorRef.detectChanges();\r\n    this.mobileQuery.addEventListener('change', this._mobileQueryListener);\r\n\r\n    this.renderer.addClass(document.body, this.themeClass);\r\n\r\n    this.detectOldBrowser();\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this.mobileQuery.removeEventListener('change', this._mobileQueryListener);\r\n  }\r\n\r\n  private detectOldBrowser() {\r\n    const oldBrowser = userAgent.satisfies({\r\n      ie: '<11',\r\n      chrome: '<64',\r\n      firefox: '<60'\r\n    });\r\n\r\n    if (oldBrowser) {\r\n      console.log('Very old browser ! ', userAgent.getBrowser());\r\n    }\r\n  }\r\n}\r\n","<div class=\"example-container\" [class.example-is-mobile]=\"mobileQuery.matches\">\r\n  <mat-toolbar color=\"primary\" class=\"example-toolbar\">\r\n    <button mat-icon-button (click)=\"snav.toggle()\"><mat-icon svgIcon=\"menu\"></mat-icon></button>\r\n    <h1>{{title}}</h1>\r\n    <h5>{{version.lib}}</h5>\r\n  </mat-toolbar>\r\n\r\n  <mat-sidenav-container class=\"example-sidenav-container\" [style.marginTop.px]=\"mobileQuery.matches ? 56 : 0\">\r\n    <mat-sidenav #snav opened=\"true\" [mode]=\"mobileQuery.matches ? 'over' : 'side'\" [fixedInViewport]=\"mobileQuery.matches\" fixedTopGap=\"56\">\r\n      <mat-nav-list>\r\n        <a mat-list-item routerLink=\".\">Home</a>\r\n\r\n        <hr>\r\n\r\n        <a mat-list-item routerLink=\"activity\">Activity</a>\r\n        <a mat-list-item routerLink=\"config\">Config</a>\r\n        <a mat-list-item routerLink=\"language\">Language</a>\r\n        <a mat-list-item routerLink=\"media\">Media</a>\r\n        <a mat-list-item routerLink=\"message\">Message</a>\r\n        <a mat-list-item routerLink=\"request\">Request</a>\r\n\r\n        <hr>\r\n\r\n        <a mat-list-item routerLink=\"auth-form\">Authentification</a>\r\n\r\n        <hr>\r\n\r\n        <a mat-list-item routerLink=\"action\">Action</a>\r\n        <a mat-list-item routerLink=\"dynamic-component\">Dynamic Component</a>\r\n        <a mat-list-item routerLink=\"entity-table\">Entity Table</a>\r\n        <a mat-list-item routerLink=\"entity-selector\">Entity Selector</a>\r\n        <a mat-list-item routerLink=\"form\">Form</a>\r\n        <a mat-list-item routerLink=\"table\">Table</a>\r\n        <a mat-list-item routerLink=\"tool\">Tool</a>\r\n        <a mat-list-item routerLink=\"widget\">Widget</a>\r\n\r\n        <hr>\r\n\r\n        <a mat-list-item routerLink=\"simple-map\">Simple map</a>\r\n        <a mat-list-item routerLink=\"layer\">Layer</a>\r\n        <a mat-list-item routerLink=\"legend\">Legend</a>\r\n        <a mat-list-item routerLink=\"overlay\">Overlay</a>\r\n        <a mat-list-item routerLink=\"geometry\">Geometry</a>\r\n        <a mat-list-item routerLink=\"feature\">Feature</a>\r\n        <a mat-list-item routerLink=\"hover\">Hover</a>\r\n        <a mat-list-item routerLink=\"measure\">Measure</a>\r\n        <a mat-list-item routerLink=\"draw\">Draw</a>\r\n        <a mat-list-item routerLink=\"query\">Query</a>\r\n        <a mat-list-item routerLink=\"catalog\">Catalog</a>\r\n        <a mat-list-item routerLink=\"search\">Search</a>\r\n        <a mat-list-item routerLink=\"print\">Print</a>\r\n        <a mat-list-item routerLink=\"import-export\">Import/Export</a>\r\n        <a mat-list-item routerLink=\"directions\">Directions</a>\r\n        <a mat-list-item routerLink=\"time-filter\">Time filter</a>\r\n        <a mat-list-item routerLink=\"ogc-filter\">OGC filter</a>\r\n        <a mat-list-item routerLink=\"spatial-filter\">Spatial filter</a>\r\n        <a mat-list-item routerLink=\"workspace\">Workspace</a>\r\n\r\n        <hr>\r\n\r\n        <a mat-list-item routerLink=\"context\">Context</a>\r\n\r\n      </mat-nav-list>\r\n    </mat-sidenav>\r\n\r\n    <mat-sidenav-content>\r\n      <router-outlet></router-outlet>\r\n    </mat-sidenav-content>\r\n\r\n  </mat-sidenav-container>\r\n</div>\r\n","import { BrowserModule, DomSanitizer } from '@angular/platform-browser';\r\nimport { BrowserAnimationsModule } from '@angular/platform-browser/animations';\r\nimport { APP_INITIALIZER, NgModule } from '@angular/core';\r\nimport { HammerModule } from '@angular/platform-browser';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconRegistry, MatIconModule } from '@angular/material/icon';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatSidenavModule } from '@angular/material/sidenav';\r\nimport { MatToolbarModule } from '@angular/material/toolbar';\r\nimport { AppHomeModule } from './core/home/home.module';\r\nimport { AppActivityModule } from './core/activity/activity.module';\r\nimport { AppConfigModule } from './core/config/config.module';\r\nimport { AppLanguageModule } from './core/language/language.module';\r\nimport { AppMediaModule } from './core/media/media.module';\r\nimport { AppMessageModule } from './core/message/message.module';\r\nimport { AppRequestModule } from './core/request/request.module';\r\n\r\nimport { AppActionModule } from './common/action/action.module';\r\nimport { AppDynamicComponentModule } from './common/dynamic-component/dynamic-component.module';\r\nimport { AppEntityTableModule } from './common/entity-table/entity-table.module';\r\nimport { AppEntitySelectorModule } from './common/entity-selector/entity-selector.module';\r\nimport { AppFormModule } from './common/form/form.module';\r\nimport { AppTableModule } from './common/table/table.module';\r\nimport { AppToolModule } from './common/tool/tool.module';\r\nimport { AppWidgetModule } from './common/widget/widget.module';\r\n\r\nimport { AppAuthFormModule } from './auth/auth-form/auth-form.module';\r\n\r\nimport { AppSimpleMapModule } from './geo/simple-map/simple-map.module';\r\nimport { AppLayerModule } from './geo/layer/layer.module';\r\nimport { AppLegendModule } from './geo/legend/legend.module';\r\nimport { AppOverlayModule } from './geo/overlay/overlay.module';\r\nimport { AppGeometryModule } from './geo/geometry/geometry.module';\r\nimport { AppFeatureModule } from './geo/feature/feature.module';\r\nimport { AppHoverModule } from './geo/hover/hover.module';\r\nimport { AppMeasureModule } from './geo/measure/measure.module';\r\nimport { AppDrawModule } from './geo/draw/draw.module';\r\nimport { AppQueryModule } from './geo/query/query.module';\r\nimport { AppCatalogModule } from './geo/catalog/catalog.module';\r\nimport { AppSearchModule } from './geo/search/search.module';\r\nimport { AppPrintModule } from './geo/print/print.module';\r\nimport { AppImportExport } from './geo/import-export/import-export.module';\r\nimport { AppDirectionsModule } from './geo/directions/directions.module';\r\nimport { AppTimeFilterModule } from './geo/time-filter/time-filter.module';\r\nimport { AppOgcFilterModule } from './geo/ogc-filter/ogc-filter.module';\r\nimport { AppSpatialFilterModule } from './geo/spatial-filter/spatial-filter.module';\r\nimport { AppWorkspaceModule } from './geo/workspace/workspace.module';\r\n\r\nimport { AppContextModule } from './context/context/context.module';\r\n\r\nimport { AppRoutingModule } from './app-routing.module';\r\nimport { AppComponent } from './app.component';\r\nimport { IgoCoreModule, LanguageService } from '@igo2/core';\r\nimport { MatTooltipDefaultOptions, MAT_TOOLTIP_DEFAULT_OPTIONS } from '@angular/material/tooltip';\r\n\r\nexport const defaultTooltipOptions: MatTooltipDefaultOptions = {\r\n  showDelay: 500,\r\n  hideDelay: 0,\r\n  touchendHideDelay: 0,\r\n  disableTooltipInteractivity: true\r\n};\r\n\r\n@NgModule({\r\n  declarations: [AppComponent],\r\n  imports: [\r\n    IgoCoreModule,\r\n    BrowserModule,\r\n    BrowserAnimationsModule,\r\n    MatSidenavModule,\r\n    MatToolbarModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    MatListModule,\r\n\r\n    AppHomeModule,\r\n    AppActivityModule,\r\n    AppConfigModule,\r\n    AppLanguageModule,\r\n    AppMediaModule,\r\n    AppMessageModule,\r\n    AppRequestModule,\r\n\r\n    AppActionModule,\r\n    AppDynamicComponentModule,\r\n    AppEntityTableModule,\r\n    AppEntitySelectorModule,\r\n    AppFormModule,\r\n    AppTableModule,\r\n    AppToolModule,\r\n    AppWidgetModule,\r\n\r\n    AppAuthFormModule,\r\n\r\n    AppSimpleMapModule,\r\n    AppLayerModule,\r\n    AppLegendModule,\r\n    AppOverlayModule,\r\n    AppGeometryModule,\r\n    AppFeatureModule,\r\n    AppHoverModule,\r\n    AppMeasureModule,\r\n    AppDrawModule,\r\n    AppQueryModule,\r\n    AppCatalogModule,\r\n    AppSearchModule,\r\n    AppPrintModule,\r\n    AppImportExport,\r\n    AppDirectionsModule,\r\n    AppTimeFilterModule,\r\n    AppOgcFilterModule,\r\n    AppSpatialFilterModule,\r\n    AppWorkspaceModule,\r\n\r\n    AppContextModule,\r\n\r\n    AppRoutingModule,\r\n\r\n    HammerModule\r\n  ],\r\n  providers: [\r\n    {provide: APP_INITIALIZER, useFactory: appInitializerFactory, deps: [LanguageService], multi: true},\r\n    { provide: MAT_TOOLTIP_DEFAULT_OPTIONS, useValue: defaultTooltipOptions }\r\n  ],\r\n  bootstrap: [AppComponent]\r\n})\r\nexport class AppModule {\r\n  constructor(matIconRegistry: MatIconRegistry, domSanitizer: DomSanitizer) {\r\n    matIconRegistry.addSvgIconSet(\r\n      domSanitizer.bypassSecurityTrustResourceUrl(\r\n        './assets/igo2/core/icons/mdi.svg'\r\n      )\r\n    );\r\n  }\r\n}\r\n\r\nexport function appInitializerFactory(languageService: LanguageService) {\r\n  return () => new Promise<any>((resolve: any) => {\r\n      languageService.translate.getTranslation(languageService.getLanguage()).subscribe(() => {\r\n        console.info(`Successfully initialized '${languageService.getLanguage()}' language.'`);\r\n      }, err => {\r\n        console.error(`Problem with '${languageService.getLanguage()}' language initialization.'`);\r\n      }, () => {\r\n        resolve(null);\r\n      });\r\n  });\r\n}\r\n","import { enableProdMode } from '@angular/core';\r\nimport { platformBrowserDynamic } from '@angular/platform-browser-dynamic';\r\n\r\nimport { AppModule } from './app/app.module';\r\nimport { environment } from './environments/environment';\r\n\r\nimport 'hammerjs';\r\n\r\nif (environment.production) {\r\n  enableProdMode();\r\n}\r\n\r\nplatformBrowserDynamic()\r\n  .bootstrapModule(AppModule)\r\n  .catch(err => console.log(err));\r\n","var map = {\n\t\"./af\": 58685,\n\t\"./af.js\": 58685,\n\t\"./ar\": 254,\n\t\"./ar-dz\": 4312,\n\t\"./ar-dz.js\": 4312,\n\t\"./ar-kw\": 32614,\n\t\"./ar-kw.js\": 32614,\n\t\"./ar-ly\": 18630,\n\t\"./ar-ly.js\": 18630,\n\t\"./ar-ma\": 28674,\n\t\"./ar-ma.js\": 28674,\n\t\"./ar-sa\": 49032,\n\t\"./ar-sa.js\": 49032,\n\t\"./ar-tn\": 24730,\n\t\"./ar-tn.js\": 24730,\n\t\"./ar.js\": 254,\n\t\"./az\": 53052,\n\t\"./az.js\": 53052,\n\t\"./be\": 60150,\n\t\"./be.js\": 60150,\n\t\"./bg\": 63069,\n\t\"./bg.js\": 63069,\n\t\"./bm\": 13466,\n\t\"./bm.js\": 13466,\n\t\"./bn\": 18516,\n\t\"./bn-bd\": 90557,\n\t\"./bn-bd.js\": 90557,\n\t\"./bn.js\": 18516,\n\t\"./bo\": 26273,\n\t\"./bo.js\": 26273,\n\t\"./br\": 9588,\n\t\"./br.js\": 9588,\n\t\"./bs\": 19815,\n\t\"./bs.js\": 19815,\n\t\"./ca\": 83331,\n\t\"./ca.js\": 83331,\n\t\"./cs\": 21320,\n\t\"./cs.js\": 21320,\n\t\"./cv\": 72219,\n\t\"./cv.js\": 72219,\n\t\"./cy\": 68266,\n\t\"./cy.js\": 68266,\n\t\"./da\": 66427,\n\t\"./da.js\": 66427,\n\t\"./de\": 67435,\n\t\"./de-at\": 52871,\n\t\"./de-at.js\": 52871,\n\t\"./de-ch\": 12994,\n\t\"./de-ch.js\": 12994,\n\t\"./de.js\": 67435,\n\t\"./dv\": 82357,\n\t\"./dv.js\": 82357,\n\t\"./el\": 95649,\n\t\"./el.js\": 95649,\n\t\"./en-au\": 59961,\n\t\"./en-au.js\": 59961,\n\t\"./en-ca\": 19878,\n\t\"./en-ca.js\": 19878,\n\t\"./en-gb\": 3924,\n\t\"./en-gb.js\": 3924,\n\t\"./en-ie\": 70864,\n\t\"./en-ie.js\": 70864,\n\t\"./en-il\": 91579,\n\t\"./en-il.js\": 91579,\n\t\"./en-in\": 30940,\n\t\"./en-in.js\": 30940,\n\t\"./en-nz\": 16181,\n\t\"./en-nz.js\": 16181,\n\t\"./en-sg\": 44301,\n\t\"./en-sg.js\": 44301,\n\t\"./eo\": 85291,\n\t\"./eo.js\": 85291,\n\t\"./es\": 54529,\n\t\"./es-do\": 53764,\n\t\"./es-do.js\": 53764,\n\t\"./es-mx\": 12584,\n\t\"./es-mx.js\": 12584,\n\t\"./es-us\": 63425,\n\t\"./es-us.js\": 63425,\n\t\"./es.js\": 54529,\n\t\"./et\": 35203,\n\t\"./et.js\": 35203,\n\t\"./eu\": 70678,\n\t\"./eu.js\": 70678,\n\t\"./fa\": 83483,\n\t\"./fa.js\": 83483,\n\t\"./fi\": 96262,\n\t\"./fi.js\": 96262,\n\t\"./fil\": 52521,\n\t\"./fil.js\": 52521,\n\t\"./fo\": 34555,\n\t\"./fo.js\": 34555,\n\t\"./fr\": 63131,\n\t\"./fr-ca\": 88239,\n\t\"./fr-ca.js\": 88239,\n\t\"./fr-ch\": 21702,\n\t\"./fr-ch.js\": 21702,\n\t\"./fr.js\": 63131,\n\t\"./fy\": 267,\n\t\"./fy.js\": 267,\n\t\"./ga\": 23821,\n\t\"./ga.js\": 23821,\n\t\"./gd\": 71753,\n\t\"./gd.js\": 71753,\n\t\"./gl\": 4074,\n\t\"./gl.js\": 4074,\n\t\"./gom-deva\": 92762,\n\t\"./gom-deva.js\": 92762,\n\t\"./gom-latn\": 5969,\n\t\"./gom-latn.js\": 5969,\n\t\"./gu\": 82809,\n\t\"./gu.js\": 82809,\n\t\"./he\": 45402,\n\t\"./he.js\": 45402,\n\t\"./hi\": 315,\n\t\"./hi.js\": 315,\n\t\"./hr\": 10410,\n\t\"./hr.js\": 10410,\n\t\"./hu\": 38288,\n\t\"./hu.js\": 38288,\n\t\"./hy-am\": 67928,\n\t\"./hy-am.js\": 67928,\n\t\"./id\": 71334,\n\t\"./id.js\": 71334,\n\t\"./is\": 86959,\n\t\"./is.js\": 86959,\n\t\"./it\": 34864,\n\t\"./it-ch\": 51124,\n\t\"./it-ch.js\": 51124,\n\t\"./it.js\": 34864,\n\t\"./ja\": 36141,\n\t\"./ja.js\": 36141,\n\t\"./jv\": 29187,\n\t\"./jv.js\": 29187,\n\t\"./ka\": 42136,\n\t\"./ka.js\": 42136,\n\t\"./kk\": 94332,\n\t\"./kk.js\": 94332,\n\t\"./km\": 18607,\n\t\"./km.js\": 18607,\n\t\"./kn\": 84305,\n\t\"./kn.js\": 84305,\n\t\"./ko\": 70234,\n\t\"./ko.js\": 70234,\n\t\"./ku\": 16003,\n\t\"./ku.js\": 16003,\n\t\"./ky\": 75061,\n\t\"./ky.js\": 75061,\n\t\"./lb\": 32786,\n\t\"./lb.js\": 32786,\n\t\"./lo\": 66183,\n\t\"./lo.js\": 66183,\n\t\"./lt\": 50029,\n\t\"./lt.js\": 50029,\n\t\"./lv\": 24169,\n\t\"./lv.js\": 24169,\n\t\"./me\": 68577,\n\t\"./me.js\": 68577,\n\t\"./mi\": 68177,\n\t\"./mi.js\": 68177,\n\t\"./mk\": 50337,\n\t\"./mk.js\": 50337,\n\t\"./ml\": 65260,\n\t\"./ml.js\": 65260,\n\t\"./mn\": 52325,\n\t\"./mn.js\": 52325,\n\t\"./mr\": 14695,\n\t\"./mr.js\": 14695,\n\t\"./ms\": 75334,\n\t\"./ms-my\": 37151,\n\t\"./ms-my.js\": 37151,\n\t\"./ms.js\": 75334,\n\t\"./mt\": 63570,\n\t\"./mt.js\": 63570,\n\t\"./my\": 97963,\n\t\"./my.js\": 97963,\n\t\"./nb\": 88028,\n\t\"./nb.js\": 88028,\n\t\"./ne\": 86638,\n\t\"./ne.js\": 86638,\n\t\"./nl\": 50302,\n\t\"./nl-be\": 66782,\n\t\"./nl-be.js\": 66782,\n\t\"./nl.js\": 50302,\n\t\"./nn\": 33501,\n\t\"./nn.js\": 33501,\n\t\"./oc-lnc\": 50563,\n\t\"./oc-lnc.js\": 50563,\n\t\"./pa-in\": 50869,\n\t\"./pa-in.js\": 50869,\n\t\"./pl\": 65302,\n\t\"./pl.js\": 65302,\n\t\"./pt\": 49687,\n\t\"./pt-br\": 74884,\n\t\"./pt-br.js\": 74884,\n\t\"./pt.js\": 49687,\n\t\"./ro\": 79107,\n\t\"./ro.js\": 79107,\n\t\"./ru\": 33627,\n\t\"./ru.js\": 33627,\n\t\"./sd\": 30355,\n\t\"./sd.js\": 30355,\n\t\"./se\": 83427,\n\t\"./se.js\": 83427,\n\t\"./si\": 11848,\n\t\"./si.js\": 11848,\n\t\"./sk\": 54590,\n\t\"./sk.js\": 54590,\n\t\"./sl\": 20184,\n\t\"./sl.js\": 20184,\n\t\"./sq\": 56361,\n\t\"./sq.js\": 56361,\n\t\"./sr\": 78965,\n\t\"./sr-cyrl\": 81287,\n\t\"./sr-cyrl.js\": 81287,\n\t\"./sr.js\": 78965,\n\t\"./ss\": 25456,\n\t\"./ss.js\": 25456,\n\t\"./sv\": 70451,\n\t\"./sv.js\": 70451,\n\t\"./sw\": 77558,\n\t\"./sw.js\": 77558,\n\t\"./ta\": 51356,\n\t\"./ta.js\": 51356,\n\t\"./te\": 73693,\n\t\"./te.js\": 73693,\n\t\"./tet\": 21243,\n\t\"./tet.js\": 21243,\n\t\"./tg\": 42500,\n\t\"./tg.js\": 42500,\n\t\"./th\": 55768,\n\t\"./th.js\": 55768,\n\t\"./tk\": 77761,\n\t\"./tk.js\": 77761,\n\t\"./tl-ph\": 35780,\n\t\"./tl-ph.js\": 35780,\n\t\"./tlh\": 29590,\n\t\"./tlh.js\": 29590,\n\t\"./tr\": 33807,\n\t\"./tr.js\": 33807,\n\t\"./tzl\": 93857,\n\t\"./tzl.js\": 93857,\n\t\"./tzm\": 60654,\n\t\"./tzm-latn\": 8806,\n\t\"./tzm-latn.js\": 8806,\n\t\"./tzm.js\": 60654,\n\t\"./ug-cn\": 30845,\n\t\"./ug-cn.js\": 30845,\n\t\"./uk\": 19232,\n\t\"./uk.js\": 19232,\n\t\"./ur\": 47052,\n\t\"./ur.js\": 47052,\n\t\"./uz\": 77967,\n\t\"./uz-latn\": 32233,\n\t\"./uz-latn.js\": 32233,\n\t\"./uz.js\": 77967,\n\t\"./vi\": 98615,\n\t\"./vi.js\": 98615,\n\t\"./x-pseudo\": 12320,\n\t\"./x-pseudo.js\": 12320,\n\t\"./yo\": 31313,\n\t\"./yo.js\": 31313,\n\t\"./zh-cn\": 64490,\n\t\"./zh-cn.js\": 64490,\n\t\"./zh-hk\": 55910,\n\t\"./zh-hk.js\": 55910,\n\t\"./zh-mo\": 98262,\n\t\"./zh-mo.js\": 98262,\n\t\"./zh-tw\": 44223,\n\t\"./zh-tw.js\": 44223\n};\n\n\nfunction webpackContext(req) {\n\tvar id = webpackContextResolve(req);\n\treturn __webpack_require__(id);\n}\nfunction webpackContextResolve(req) {\n\tif(!__webpack_require__.o(map, req)) {\n\t\tvar e = new Error(\"Cannot find module '\" + req + \"'\");\n\t\te.code = 'MODULE_NOT_FOUND';\n\t\tthrow e;\n\t}\n\treturn map[req];\n}\nwebpackContext.keys = function webpackContextKeys() {\n\treturn Object.keys(map);\n};\nwebpackContext.resolve = webpackContextResolve;\nmodule.exports = webpackContext;\nwebpackContext.id = 46700;"],"x_google_ignoreList":[676]}