{"version":3,"mappings":"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gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,mBACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,YACA,eACA,aACA,gBACA,mBACA,gBACA,mBACA,gBACA,aACA,gBACA,YACA,eACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,aACA,gBACA,aACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,cACA,iBACA,aACA,gBACA,aACA,gBACA,mBACA,gBACA,mBACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,mBACA,sBACA,mBACA,sBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,gBACA,mBACA,aACA,gBACA,aACA,gBACA,aACA,eACA,kBACA,gBACA,aACA,gBACA,WACA,cACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,mBACA,gBACA,YACA,eACA,YACA,eACA,YACA,eACA,aACA,gBACA,aACA,gBACA,mBACA,gBACA,aACA,gBACA,iBACA,oBACA,gBACA,mBACA,aACA,gBACA,aACA,gBACA,mBACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,aACA,kBACA,qBACA,gBACA,aACA,gBACA,aACA,gBACA,YACA,eACA,aACA,gBACA,aACA,gBACA,cACA,iBACA,aACA,gBACA,aACA,gBACA,aACA,gBACA,gBACA,mBACA,cACA,iBACA,aACA,gBACA,cACA,iBACA,cACA,mBACA,sBACA,iBACA,gBACA,mBACA,aACA,gBACA,aACA,gBACA,aACA,kBACA,qBACA,gBACA,aACA,gBACA,mBACA,sBACA,aACA,gBACA,gBACA,mBACA,gBACA,mBACA,gBACA,mBACA,gBACA,oBAIA,cACA,WACA,YAEA,cACA,cACA,8CACA,gCACAtB,EAEA,YAEAC,kBACA,uBAEAA,YACAF,YACAE","names":["Ee","io","le","T","e","Ap","getByte","t","o","charCodeAt","this","ALPHA","indexOf","charAt","n","s","a","length","l","String","PADCHAR","getByte64","push","fromCharCode","join","i","Go","Tp","window","navigator","userAgent","copy","r","Mt","createTextArea","selectText","copyTextToClipboard","destroyTextArea","document","createElement","value","body","appendChild","removeChild","getOSName","contentEditable","readOnly","createRange","getSelection","contenteditable","readonly","selectNodeContents","removeAllRanges","addRange","setSelectionRange","select","compareVersion","execCommand","Yo","diff","arguments","toString","getChanges","slice","mtc","ins","sbs","del","fis","_ref2","c","split","u","p","fil","d","g","getMatchingSubstring","rotateArray","_ref4","Array","hi","ADDED","findChanges","added","deleted","modified","_step","_iterator","findIndex","m","id","change","type","DELETED","splice","JSON","parse","stringify","ts","compareObject","MODIFIED","keysChanged","oldValue","newValue","_loop","map","Set","Object","keys","_toConsumableArray","forEach","isArray","concat","key","resolve","replace","shift","Date","assign","E","isObject","filter","mergeDeep","hasOwnProperty","copyDeep","toUpperCase","count","toLowerCase","reduce","y","_loop2","removeUndefined","removeNull","localeCompare","getOwnPropertyNames","_step2","zo","roundToNDecimal","Math","pow","round","create","random","substring","Fo","fe","constructor","Ae","_status","status$","next","subscribe","watch","status$$","pipe","Qo","handleStatusChange","call","unsubscribe","unwatch","status","Waiting","on","v","register","Ze","ids","counter$","unregister","factory","fac","Fp","intercept","headers","get","clone","handle","activityService","rl","is","forRoot","ngModule","providers","provide","q","useClass","multi","ll","lib","releaseDate","$","getConfig","config","load","path","injector","Promise","ge","console","log","en","error","version","cl","useValue","Gn","ns","useFactory","Ip","deps","getTranslation","x","W","prefix","http","suffix","Ke","I","Op","L","ul","translateService","langs","Error","substr","K","kp","missingTranslationHandler","Dp","ho","h","al","positionClass","timeOut","extendedTimeOut","messageClass","closeButton","progressBar","enableHtml","tapToDismiss","maxOpened","preventDuplicates","resetTimeoutOnDuplicate","countDuplicates","includeTitleDuplicates","M","translate","getBrowserLang","getLanguage","setDefaultLang","language","match","setLanguage","use","reloadLang","fo","ERROR","me","options","configService","showError","caught","message","title","messages$","from","to","handleTemplate","text","SUCCESS","success","INFO","info","ALERT","WARNING","alert","toastId","languageService","instant","toastr","warning","remove","removeAllAreNotError","_step3","template","html","Pp","httpError","handleError","handleCaughtError","handleUncaughtError","statusText","url","toDisplay","messageService","rs","$p","name","objectStoresMeta","store","storeConfig","keyPath","autoIncrement","storeSchema","keypath","unique","Ep","addSvgIconSet","bypassSecurityTrustResourceUrl","os","pl","fi","centerKey","zoomKey","projectionKey","contextKey","searchKey","visibleOnLayersKey","visibleOffLayersKey","directionsCoordKey","directionsOptionsKey","toolKey","wmsUrlKey","wmsLayersKey","wmtsUrlKey","wmtsLayersKey","arcgisUrlKey","arcgisLayersKey","iarcgisUrlKey","iarcgisLayersKey","tarcgisUrlKey","tarcgisLayersKey","vectorKey","decodeURIComponent","location","search","includes","_s$map2","router","navigate","queryParams","route","qt","Mobile","ro","Portrait","pt","observe","Io","matches","media$","orientation$","Landscape","Tablet","Desktop","getMedia","getOrientation","isTouchScreen","documentElement","isMobile","isDesktop","Fe","SESSION","so","se","sessionStorage","getItem","LOCAL","localStorage","set","setItem","storageChange$","scope","event","previousValue","currentValue","removeItem","REMOVED","clear","CLEARED","Rp","Map","generateBase64Index","base64Index","indexBase64","compressBlob","et","FileReader","readAsDataURL","onload","result","valueOf","compressStringBase64","object","decompressBlob","decompressStringBase64","atob","Uint8Array","Blob","_step4","ss","nn","connection","onLine","checkNetworkState","onlineSubscription","mo","previousMessageId","state","emitEvent","offlineSubscription","stateChangeEventEmitter","emit","ngOnDestroy","currentState","ve","wp","Ge","Default","vi","Auto","sn","None","as","safeObject","meta","Wo","idProperty","titleProperty","icon","iconProperty","Gp","rn","getKey","an","index","size","setMany","setAll","update","updateMany","updateManyExclusive","reverse","reverseMany","reverseChanges","updateAll","getAllKeys","some","entries","_o2","change$","getKey$","count$","empty$","_index","all","values$","all$","firstBy","find","firstBy$","manyBy","manyBy$","sort","destroy","values$$","createIndex","lifted","joins","filter$","addFilter","filterIndex","filters$","values","removeFilter","sort$","lift","liftJoinedSource","liftSource","_i","_o3","processValues","setValues","source$","source","_t4","computeJoinedValue","filterValues","sortValues","every","valueAccessor","direction","nullsFirst","generateIndex","getProperty","createStateManager","view","createDataView","stateView","createStateView","_pristine","entities$","softClear","updateCount","insert","insertMany","delete","deleteMany","addStrategy","strategies","bindStore","activate","removeStrategy","unbindStore","getStrategyOfType","activateStrategyOfType","deactivateStrategyOfType","deactivate","hl","entity","statesAreTheSame","revision","ref","setChangeDetector","setStore","teardownObservers","innerStateIndex","setupObservers","detectChanges","cdRef","entities$$","onEntitiesChange","state$$","onStateChange","_i2","Xo","active$","active","doDeactivate","doActivate","stores","super","filterStore","unfilterStore","filterAll","unfilterAll","filters","filterClauseFunc","has","selected","fl","Jt","ngOnInit","watcher","ln","selected$$","onSelectFromStore","onSelectionChange","multiSelectValue","emptyValue","selectedChange","selected$","updateMultiToggleWithEntities","multiText$","multiNoneText","multiAllText","selectors","bi","onClick","stopPropagation","Vp","scroll","_selected","selection","toggleSelected","selectOnClick","addCls","selectedCls","highlightSelection","highlightedCls","removeCls","Jp","el","nativeElement","scrollMode","behavior","block","inline","renderer","addClass","removeClass","_l","paginationLabelTranslation$$","max","min","ngOnChanges","unsubscribeAll","count$$","emitPaginator","entitySortChange$$","entitySortChange$","paginator","firstPage","initPaginatorOptions","translateLabels","disabled","paginatorOptions","pageIndex","pageSize","pageSizeOptions","mediaService","showFirstLastButtons","hidePageSize","_intl","firstPageLabel","getRangeLabel","rangeLabel","itemsPerPageLabel","lastPageLabel","nextPageLabel","previousPageLabel","paginatorChange","Yn","Hn","transform","activityInterceptor","RegExp","test","responseType","dl","onloadend","complete","pure","G","Rt","maxCacheCount","Vn","_sanitizer","bypassSecurityTrustHtml","oxw","onFocus","onChange","onBlur","ds","yi","Ko","_","be","dateAdapter","setLocale","_paginator","dataSource","columns","visible","selectionCheckbox","selectMany","fixedHeader","handleDatasource","onValueChange","getColumnKeyWithoutPropertiesTag","properties","target","onBooleanValueChange","checked","onSelectValueChange","onAutocompleteValueChange","formGroup","controls","setValue","option","viewValue","onDateChange","format","enableEdit","validation","mandatory","setControl","formBuilder","control","multiple","parseInt","filteredOptions","valueChanges","domainValues","normalize","isEdition","linkColumnForce","utc","getValidationAttributeValue","disable","unsubscribeStore","selection$$","floor","selectionState$","computeSelectionState","dataSource$$","data","getTrackByFunction","refresh","onSort","getValue","sortNullsFirst","entitySortChange","column","onRowClick","lastRecordCheckedKey","entityClick","onRowSelect","entitySelectChange","onToggleRows","onToggleRow","onShiftToggleRow","selectNode","stopImmediatePropagation","All","Some","columnIsSortable","rowIsSelected","isImg","isUrl","pop","Boolean","Number","edition","getColumnRenderer","getTableClass","getHeaderClass","headerClassFunc","Function","getRowClass","rowClassFunc","getCellClass","cellClassFunc","onButtonClick","O","useExisting","yo","Dock","action","Kd","disabled$","noDisplay$","args","ngClass","ngClass$$","updateNgClass","ls","icon$$","updateIcon","checkCondition","checkCondition$$","updateCheckCondition","tooltip","tooltip$$","updateTooltip","availability","availability$$","disabled$$","display","display$$","noDisplay","noDisplay$$","trigger","ngClass$","tooltip$","checkCondition$","icon$","cn","handler","collapsed","_overlayClass","withTitle","withIcon","horizontal","elRef","scrollActive","clientHeight","scrollHeight","scrollTop","positionConditionLow","onTriggerAction","scrollDown","scrollBy","scrollUp","Wn","S","Z","De","J","C","Xe","gs","imports","ms","matIconRegistry","getNamedSvgIcon","svg","updateSvg","hidden","updateHidden","updateDisabled","inverseColor","updateColor","inheritColor","querySelector","badge","style","alignItems","justifyContent","innerHTML","color","background","getComputedStyle","getPropertyValue","originalColor","Xn","ht","pg","handleMouseClick","contains","clickout","dg","xi","_target","_collapsed","collapseTarget","expandTarget","toggle","click","hs","_title","Ci","mg","fs","open","dialog","disableClose","componentInstance","confirmMessage","afterClosed","yl","R","vl","onContextMenu","close","preventDefault","menuPosition","overlayRef","overlay","position","flexibleConnectedTo","withPositions","originX","originY","overlayX","overlayY","positionStrategy","scrollStrategy","scrollStrategies","attach","Up","menuContext","viewContainerRef","$implicit","sub","Ho","overlayElement","tt","elementRef","dispose","bl","Kn","H","er","getDom","toPromise","fg","yg","setTarget","componentRef","createComponent","componentFactory","updateInputs","inputs","updateSubscribers","subscribers","unobserveAllInputs","instance","propName","unobserveInput","observeInput","setInputValue","onUpdateInputs","getPrototypeOf","getOwnPropertyDescriptor","outputs","subscriptions","inputs$$","_s","resolver","resolveComponentFactory","xl","tr","component","dynamicComponent","dynamicComponentService","renderComponent","ys","vs","bs","xs","buttons","children","formData","setData","onSubmit","submitForm","getData","groups","fields","form","updateDataWithFormField","reset","Fg","Cs","group","addControl","validator","getValidators","setValidators","field","extendFieldConfig","getValidator","Ss","getFieldByType","Zg","getFieldComponent","formFieldService","getFieldInputs","fieldInputs","fieldOptions","errors","placeholder","disableSwitch","formControl","required","getFieldSubscribers","fieldSubscribers","ws","ue","Sl","getFieldColSpan","cols","getFieldNgClass","getErrorMessage","wl","un","Ts","sr","Ms","As","Si","lt","Vo","Zo","Tl","Ml","jsonURL","getPathToConfigFile","loadConfigTour","getJSON","allToursOptions","getTourOptionData","Ls","isAppHaveTour","interactiveTourLoader","isToolHaveTourConfig","disabledTourButton","conditions","_step5","isTourDisplayInMobile","getButtons","classes","getAction","addProgress","setInterval","getCurrentStep","attachTo","element","cancel","clearInterval","getElement","querySelectorAll","classList","add","steps","className","innerText","insertBefore","checkNext","_setupModal","show","executeAction","condition","executeActionPromise","waitFor","maxWait","getShepherdSteps","popperOptions","modifiers","offset","beforeShowPromise","previousStep","beforeChange","beforeShow","noBackButton","highlightClass","scrollTo","scrollToElement","canClickTarget","disableInteraction","when","onShow","hide","onHide","startTour","shepherdService","defaultStepOptions","cancelIcon","enabled","modal","confirmCancel","addSteps","tourObject","start","ot","setToolbar","toolbar","initStore","activeTool$$","getTool","getTools","setTools","getToolbar","toolbar$","activateTool","activatePreviousTool","activeToolHistory","deactivateTool","_this$activeToolHisto2","clearActiveToolHistory","setActiveTool","activeTool$","wi","Al","toolbox","tools","Ll","getClass","styleButton","toolService","getTourToStart","tourToStart","activeToolName","isActiveTool","isToolHaveTour","interactiveTourService","startInteractiveTour","Fl","ei","Ti","kt","_color","_focused","beforeFocus","beforeUnfocus","toggleFocusedClass","focus","unfocus","beforeSelect","beforeUnselect","toggleSelectedClass","unselect","_disabled","beforeDisable","beforeEnable","toggleDisabledClass","enable","getOffsetTop","offsetTop","focused","focusedCls","disabledCls","vo","_navigation","_selection","_selectedItem","focusedItem","_focusedItem","handleKeyboardEvent","navigationEnabled","enableNavigation","ngAfterViewInit","listItems","init","listItems$$","changes","focusNext","toArray","getFocusedIndex","isScrolledIntoView","offsetHeight","focusPrevious","selectedItem","navigation","disableNavigation","scrollToItem","findSelectedItem","findFocusedItem","handleItemBeforeSelect","handleItemSelect","handleItemBeforeFocus","handleItemFocus","ti","At","_withHeader","vt","ar","shown$","shown","am","counter$$","spinner","lr","gl","_filterChange","connect","_database","cs","dataChange","_sort","sortChange","getFilteredData","getSortedData","disconnect","_model","filterable","ps","pn","Mm","_hasFIlterInput","Il","database","model","displayedColumns","displayed","unshift","actions","changed","getActionColor","isAllSelected","masterToggle","handleClickAction","Am","jp","Mi","White","he","Om","Oo","Grey","Primary","toolbar$$","onToolbarChange","onActiveToolChange","actionStore","onAnimationStart","animating$","onAnimationComplete","getToolInputs","animate","onAnimate","animation$","parent","unAnimate","animating$$","Lm","changeDetection","km","Dm","Zl","onCancel","onComplete","destroyWidget","getEffectiveSubscribers","baseSubscribers","widget","Is","Zs","Ol","kl","getWorkspaceTitle","onSelectedChange","activateWorkspace","$m","qm","workspace","widget$","widgetInputs$","widgetSubscribers$","onWidgetCancel","deactivateWidget","onWidgetComplete","Rm","Bm","activeWorkspace$","deactivateWorkspace","Os","entityStore","activateWidget","Nm","X","jm","Gm","idsActivity","Ym","ks","production","igo","projections","code","alias","def","extent","auth","intern","allowAnonymous","interactiveTour","tourInMobile","importExport","catalog","sources","queryFormat","queryHtmlTarget","regFilters","tooltipType","searchSources","nominatim","icherche","searchUrl","order","params","limit","coordinatesreverse","showInPointerSummary","icherchereverse","ilayer","Hm","configLanguage","Vm","default","Xm","changeLanguage","Km","th","oh","nh","rh","ah","callHttp","callHttpError","lh","ph","added$","dh","Ds","gh","hh","toggleComponent","fh","yh","description","image","vh","Ch","getTitle","Sh","Mh","choices","formService","valueChanges$$","submitDisabled","valid","form$","fillForm","data$","clearForm","Ah","Fh","sortable","showName","Jm","handleSelect","Ih","Ai","Oe","Li","Dh","activateSalutationTool","Ph","$h","qh","widgetService","Rh","Ps","tokenKey","decode","Jh","isExpired","getTime","exp","Be","authenticate$","authenticated","logged$","login","username","password","encodePassword","loginCall","loginWithToken","token","typeConnection","infosUser","loginAnonymous","anonymous","post","dn","tokenService","logout","isAuthenticated","getToken","decodeToken","goToRedirectUrl","redirectUrl","loginRoute","navigateByUrl","homeRoute","getUserInfo","getProfils","updateUser","patch","isAnonymous","user","isAdmin","locale","Nh","apiKey","clientId","loadSDKGoogle","loadPlatform","warn","handleSignInClick","gapi","auth2","getAuthInstance","signIn","handleSignOutClick","signOut","handleClientLoad","initClient","client","discoveryDocs","then","updateTextButton","isSignedIn","listen","updateSigninStatus","loginGoogle","access_token","authService","appRef","tick","getElementsByTagName","src","parentNode","jh","msalService","cr","cache","cacheLocation","broadcastService","Ut","inProgress$","Fi","oi","_destroying$","checkAccount","loginMicrosoft","loginPopup","getConf","authRequest","setActiveAccount","account","acquireTokenSilent","accessToken","tokenId","idToken","Pl","acquireTokenPopup","msalGuardConfig","$s","redirectHash","initializeWrapperLibrary","ao","acquireTokenRedirect","handleRedirectObservable","handleRedirectPromise","loginRedirect","logoutRedirect","logoutPopup","ssoSilent","getLogger","logger","setLogger","Qh","_msalSubject","msalSubject$","asObservable","_inProgress","msalInstance","addEventCallback","Uh","verbose","eventType","Gh","browserAuthOptions","loginMicrosoftb2c","Yh","appId","loadSDKFacebook","subscribeEvents","FB","Event","statusChangeCallback","loginFacebook","authResponse","getElementById","Vh","_allowAnonymous","loginUser","loading","Es","backgroundDisable","isLogoutRoute","_backgroundDisable","hasAlreadyConnectedDiv","_hasAlreadyConnectedDiv","hasLogoutDiv","_hasLogoutDiv","showAlreadyConnectedDiv","_showAlreadyConnectedDiv","showLogoutDiv","_showLogoutDiv","showLoginDiv","analyzeRoute","getName","onLogin","logoutRoute","home","firstName","sourceId","events","isLoginRoute","ur","hostname","handleHostsWithCredentials","handleHostsAuthByKey","withCredentials","refreshToken","href","host","trustHosts","lo","interceptXhr","setRequestHeader","alterUrlWithKeyAuth","hostsWithCredentials","_step7","domainRegFilters","hostsWithAuthByKey","_step8","keyProperty","keyValue","refreshInProgress","redirectUri","authority","interactionType","scopes","loginHint","pf","gf","uf","df","mf","preference","_i3","mergePreference","_i4","qs","$l","_f","yf","Xf","extern","Di","_layer","openMetadata","metadataService","o_","layerTitle","layer","abstract","si","oe","V","ol","handleLoadStart","handleLoadEnd","handleLoadError","__watchers__","loaded","params_","LAYERS","tn","sourceOptions","styleByAttribute","hoverStyle","featureClass","$e","OPACITY","Nt","TITLE","wms","n_","wmts","r_","xyz","s_","feature","a_","wfs","l_","arcgisrest","Hs","imagearcgisrest","tilearcgisrest","osm","tiledebug","Vs","qo","featureTypes","origin","generateId","createOlSource","xn","getLegend","legend","setLegend","Ne","BasicNumericOperator","P","BBOX","moment","PropertyIsEqualTo","spatial","fieldRestrict","PropertyIsNotEqualTo","PropertyIsLike","PropertyIsGreaterThan","PropertyIsGreaterThanOrEqualTo","PropertyIsLessThan","PropertyIsLessThanOrEqualTo","PropertyIsBetween","During","PropertyIsNull","Intersects","Within","Contains","defineOgcFiltersDefaultOptions","editable","geometryName","advancedOgcFilters","pushButtons","checkboxes","radioButtons","autocomplete","buildFilter","ct","getCode","checkIgoFiltersProperties","srsName","featureNS","featurePrefix","bundleFilter","outputFormat","ni","writeGetFeature","XMLSerializer","serializeToString","createFilter","operator","logical","logicalArray","F","propertyName","pattern","matchCase","wildCard","singleChar","escapeChar","lowerBoundary","upperBoundary","f","wkt_geometry","b","w","parseFilterOptionDate","begin","minDate","A","end","maxDate","D","expression","olFormatWKT","readGeometry","dataProjection","featureProjection","And","Or","Not","defineInterfaceFilterSequence","filterSequence","addInterfaceFilter","computeAllowedOperators","allowedOperatorsType","Spatial","BasicAndSpatial","operators","Basic","Time","filterid","step","sliderOptions","igoSpatialSelector","igoSNRC","geometry","parentLogical","level","addFilterProperties","rebuiltIgoOgcFilterObjectFromSequence","computeIgoSelector","computedSelectors","bundles","selectorType","handleOgcFiltersAppliedValue","ogcFilters","_step9","formatGroupAndFilter","_step10","_step11","verifyMultipleEnableds","_iterator11","_step12","_iterator12","_step13","formatProcessedOgcFilter","isValid","qe","GML2","Qt","Wt","IFRAME","nc","Pi","Ws","sc","paramsWFS","Xs","Pt","xmlFilter","download","dynamicUrl","urlWfs","maxFeatures","k","sourceFields","ye","Me","fieldNameGeometry","ce","N","re","OlFormat","formatOptions","gmlFormat","js","Af","jl","Lf","DPI","MAP_RESOLUTION","FORMAT_OPTIONS","refreshIntervalSec","lc","buildDynamicDownloadUrlFromParamsWFS","calendarModeYear","wfsService","getSourceFieldsFromWFS","FILTER","setOgcFilters","timeFilterable","timeFilter","setTimeFilter","queryTitle","mapLabel","BLANK","updateParams","igoRefresh","Sf","ratio","ogcFilters$","timeFilter$","scale","projection","contentDependentLegend","VERSION","currentStyle","onUnwatch","jt","ogcFilterWriter","transferCommonProperties","ogcFilters$$","transferOgcFiltersProperties","timeFilter$$","transferTimeFilterProperties","syncChildLayers","ko","layers","linkedLayers","links","VISIBLE","opacity","MINRESOLUTION","minResolution","MAXRESOLUTION","OGCFILTERS","TIMEFILTER","getProperties","linkId","linkedIds","visible$","bidirectionnal","getSource","viewController","getOlProjection","getParams","Lt","TIME","cc","tile","Ce","getSourceFormatFromOptions","olSourceVector","formatType","gr","xe","Xt","Ql","getUrl","ie","z","ke","de","Qe","zt","Lo","Qn","Xi","mi","Ki","te","Kr","il","go","QL","Cp","Sp","GL","es","toLocaleUpperCase","trim","Uo","parseFloat","Ro","_Y$vs","Y","_Y$vs2","_Y$vs3","_Y$vs4","lonLat","radius","conf","forceNA","YL","C3","abs","originalEvent","altKey","Ff","metaKey","ctrlKey","shiftKey","isInResolutionsRange$","createOlLayer","zIndex","baseLayer","maxResolution","mt","maxScaleDenom","minScaleDenom","legendOptions","legendCollapsed","isIgoInternalLayer","getZIndex","setZIndex","setOpacity","updateInResolutionsRange","getMaxResolution","setMaxResolution","getMinResolution","setMinResolution","setVisible","hasBeenVisible$","messages","showOnEachLayerVisibility","showMessage","isInResolutionsRange","showInLayerList","setMap","unobserveResolution","observeResolution","layerSyncWatcher","u_","hasBeenVisible$$","resolution$$","resolution$","getResolution","Se","d_","_assertThisInitialized","browsable","exportable","animation","flash","bind","trackFeature","enableTrackFeature","olLayerVector","customWFSLoader","authInterceptor","customLoader","setLoader","hn","frameState","getGeometry","time","duration","Oi","ColorAsArray","getStyleFunction","getImage","getType","getRadius","setRadius","getStroke","setColor","setWidth","getWidth","getFill","setText","setStyle","drawGeometry","ze","render","stopAnimation","trackFeatureListenerId","centerMapOnFeature","getFeatureById","getView","setCenter","getCoordinates","getId","disableTrackFeature","ki","ac","getFeatures","mostRecentIdCallOGCFilter","XMLHttpRequest","removeLoadedExtent","onerror","responseText","getFormat","readFeatures","addFeatures","send","geoNetworkService","geoDBService","Do","xo","DOMParser","parseFromString","readProjection","responseXML","response","yr","If","Zf","Ks","strategy","Gl","b_","defineFieldAndValuefromWFS","wfsGetFeature","getKeys","getGeometryName","built_properties_value","boundedBy","_loop4","getExtent","extentGetWidth","Of","extentGetTopLeft","resolutions","matrixIds","tileGrid","x_","Yl","crossOrigin","kf","items","_i5","cartocss","layer_name","mr","attributions","overlaps","encodeURIComponent","customParams","olloadingstrategy","legendInfo","_step14","htmlImgSrc","contentType","imageData","label","uniqueValueInfos","_step15","symbol","createSVG","width","outline","renderingRule","Df","_step16","layerId","Pf","_step17","Ef","$f","createWebSocket","_get","WebSocket","onmessage","onMessage","onclose","onClose","onError","onopen","onOpen","readFeature","removeFeature","addFeature","Hl","zl","_converters","esriPMS","je","_convertEsriPMS","esriSFS","_convertEsriSFS","esriSLS","_convertEsriSLS","esriSMS","_convertEsriSMS","esriTS","_convertEsriTS","_renderers","uniqueValue","_renderUniqueValue","simple","_renderSimple","classBreaks","_renderClassBreaks","_convertLabelingInfo","labelExpression","maxScale","minScale","_getResolutionForScale","getText","defaultSymbol","classBreakInfos","classMinValue","minValue","classMaxValue","field1","generateStyle","drawingInfo","labelingInfo","_transformAngle","angle","U","ft","fill","j","_transformColor","font","weight","family","textBaseline","verticalAlignment","textAlign","horizontalAlignment","offsetX","_convertPointToPixel","xoffset","offsetY","yoffset","rotation","Ii","_convertOutline","stroke","B","lineDash","PI","Le","Zi","points","radius2","He","DATE","St","CALENDAR","$t","getMap","Ei","br","Tf","Mf","esriJSON","getWMSOptions","getCapabilities","parseWMSOptions","getWMTSOptions","parseWMTSOptions","getCartoOptions","jsonp","mapId","parseCartoOptions","getArcgisOptions","bo","parseArcgisOptions","getImageArcgisOptions","parseTileOrImageArcgisOptions","getTileArcgisOptions","fromObject","request","service","parsers","read","findDataSourceInCapabilities","Capability","Layer","DataURL","Abstract","KeywordList","queryable","getTimeFilter","Style","getStyle","EX_GeographicBoundingBox","mapService","GEOJSON","GEOJSON2","GML3","HTML","Request","GetFeatureInfo","Format","_i6","_layerOptionsFromSource","Title","MaxScaleDenominator","MinScaleDenominator","metadata","OnlineResource","keywordList","stepDate","Contents","Identifier","layer_definition","layerName","units","dr","copyrightText","timeInfo","timeExtent","setTime","toUTCString","range","DATETIME","serviceDescription","displayField","Name","Dimension","stylesAvailable","Sn","registerProjection","Bs","Bl","setExtent","bt","createAsyncDataSource","createOSMDataSource","createFeatureDataSource","createWFSDataSource","createWMSDataSource","createWMTSDataSource","createXYZDataSource","createTileDebugDataSource","createCartoDataSource","createArcGISRestDataSource","createArcGISRestImageDataSource","createWebSocketDataSource","createMVTDataSource","createTileArcGISRestDataSource","createClusterDataSource","datasources$","pc","gc","$i","wfsDataSourceService","optionsFromCapabilities","capabilitiesService","optionsService","optionsFromApi","oa","ta","dc","vr","getArcgisRestOptions","ia","na","Cn","ra","OlFormatGeoJSON","setId","zn","startsWith","writeGeometryObject","excludeAttribute","excludeAttributeOffline","idColumn","mapTitle","getRevision","Ye","_Ye$ap2","fc","Zoom","zoomToExtent","Move","moveToExtent","getZoom","bindLayer","addLayer","setLayerFeatures","checkLayer","Ft","setLayerOlFeatures","setStoreOlFeatures","ai","clearLayer","removeOlFeaturesFromLayer","addOlFeaturesToLayer","Kt","watchStore","empty$$","Dt","updateEntitiesInExtent","unwatchStore","unwatchAll","stores$$","states$$","state$","inMapExtent","_step18","_iterator18","updateEntitiesInResolution","inMapResolution","setMotion","motion","onFeaturesChange","selectMotion","viewScale","areaRatio","getFeatureId","pristine","onSourceChanges","flatMap","Vl","_overlayStore","createOverlayStore","unselectAll","overlayStore","deactivateSelection","unlistenToMapClick","removeDragBoxInteraction","addOverlayLayer","listenToMapClick","dragBox","addDragBoxInteraction","watchAll","removeOverlayLayer","mapClickListener","onMapClick","_r","getFeaturesAtPixel","pixel","hitTolerance","layerFilter","onSelectFromMap","getInteractions","getArray","_step19","Sr","addInteraction","olDragSelectInteraction","olDragSelectInteractionEndKey","onDragBoxEnd","removeInteraction","mapBrowserEvent","apply","getFeaturesInExtent","groupFeaturesByStore","unselectAllFeaturesFromStore","selectFeaturesFromStore","createOverlayLayer","xt","removeLayer","Gt","wt","_ref8","_ref8$opacity","markerColor","_ref8$markerColor","markerOutlineColor","_ref8$markerOutlineCo","imgSize","anchor","overflow","uo","createStyle","Ri","parseStyle","attribute","getLabel","getOlCls","getOlKey","Cf","createStyleByAttribute","guessTypeFeature","pe","baseStyle","Je","createClusterStyle","clusterRanges","_step20","minRadius","maxRadius","showRange","dynamicRadius","image_","radiusCalc","matchAll","bc","_ref9","_ref9$strokeWidth","strokeWidth","fillColor","_ref9$fillColor","strokeColor","_ref9$strokeColor","wr","L_","setFeatures","_step21","removeOlFeature","addOlFeatures","addOlFeature","removeFeatures","unwatchLayer","watchLayer","Bi","getOlMap","olMap","setOlMap","observerKeys","Z_","stateHistory","olView","setPadding","top","padding","right","bottom","left","onMoveEnd","extent$$","extent$","getProjection","getCenter","calculateExtent","getSize","getScale","getUnits","zoomIn","zoomTo","zoomOut","cancelAnimations","zoom","easing","getRotation","resetRotation","hasPreviousState","states","stateIndex","hasNextState","previousState","setStateIndex","nextState","clearStateHistory","setInitialState","sqrt","maxZoomOnExtent","fit","maxZoom","callback","setState","resolution","center","trunc","xc","Co","Position","buffer","accuracyThreshold","followPosition","geolocationOverlay","_buffer","handleFeatureCreation","position$","_accuracyThreshold","geolocation","getTracking","setTracking","tracking$","storageService","_followPosition","followPosition$","deleteGeolocationFeatures","deleteFeatureByType","Accuracy","Buffer","onPositionChange","qf","trackingOptions","enableHighAccuracy","maximumAge","timeout","subscriptions$$","emissionIntervalSeconds$","El","updateGeolocationOptions","geolocate","alwaysTracking","tracking","accuracy","altitude","altitudeAccuracy","heading","speed","timestamp","Pe","co","_n","olFeature","positionFeatureStyle","accuracyFeatureStyle","bufferRadius","bufferStroke","bufferFill","showBufferRadius","attribution","defaultOptions","layerWatcher","I_","layers$","olControlAttribution","scaleLine","Rl","interactions","altShiftDragRotate","doubleClickZoom","keyboard","mouseWheelZoom","shiftDragZoom","dragPan","pinchRotate","pinchZoom","vf","olinteraction","setView","queryResultsOverlay","searchResultsOverlay","once","geolocationController","O_","mapViewOptions","updateView","constrainResolution","bf","maxLayerZoomExtent","updateControls","getControls","removeControl","changeBaseLayer","getBaseLayers","setMinZoom","minZoom","setMaxZoom","getLayerById","getLayerByAlias","getLayerByOlUId","ol_uid","addLayers","doAddLayer","setLayers","removeLayers","handleLinkedLayersDeletion","doRemoveLayer","syncedDelete","removeAllLayers","raiseLayer","getLayerIndex","moveLayer","raiseLayers","_step23","lowerLayer","lowerLayers","_step24","sortLayersByZIndex","onOfflineToggle","offlineButtonToggle$","we","_view","_controls","activityId","D_","listenToMapPointerMove","unlistenToMapPointerMove","pointerMoveListener","onPointerEvent","pointerPositionDelay","dragging","lastTimeoutRequest","clearTimeout","coordinate","mapProjection","setTimeout","pointerPositionCoord","i_","olLoadingProblem","Bf","setImageLoadFunction","abort","TextDecoder","URL","createObjectURL","Jf","setTileLoadFunction","hr","onLoad","E_","mouseout","subscribeToPointerStore","layers$$","li","q_","selectionLayer","renderMode","declutter","olVectorTileSource","mvtStyleOptions","selectionMVT","createHoverStyle","backgroundFill","backgroundStroke","styleService","unsubscribeToPointerStore","unlistenToMapSingleClick","store$$","pointerHoverFeatureStore","entitiesToPointerOverlay","addFeatureOverlay","onMapEvent","singleClickMapListener","onMapSingleClickEvent","igoHoverFeatureEnabled","getPixelFromCoordinate","forEachFeatureAtPixel","canProcessHover","handleRenderFeature","setLayerStyleFromOptions","setProperties","OlGeom","setGeometry","setSource","igoHoverFeatureDelay","Xl","hoverFeatureId","hoverSummary","getHoverSummary","_i7","_Object$entries$_i","getOrientedFlatCoordinates","OlStyle","st","getMinZoom","getMaxZoom","Mn","_map","ngAfterContentInit","tracking$$","onGeolocationClick","An","computeHomeExtent","homeExtentButtonExtent","extentOverride","homeExtentButtonCenter","centerOverride","homeExtentButtonZoom","zoomOverride","onToggleClick","U_","noSleep","Nf","edge","chrome","firefox","opera","safari","disableWakeLock","onblur","enableWakeLock","toggleWakeLock","z_","useStaticIcon","_baseLayers","collapseOrExpand","expand","baseLayers","height","H_","compression","regionID","compressed","insertSource","insertEvent","ngxIndexedDBService","getByID","dbName","collisionsMap","customUpdate","_newTiles","deleteByKey","getRegionTileCountByID","getRegionByID","IDBKeyRange","only","getAllByIndex","deleteByRegionID","openCursor","lowerBound","openCursorByIndex","resetCounters","resetCollisionsMap","revertCollisions","_step26","getByKey","V_","networkService","networkOnline","getOnline","getOffline","isOnline","Ie","createLayer","createTileLayer","createVectorLayer","createImageLayer","ic","createVectorTileLayer","createAsyncLayer","dataSourceService","P_","$_","geoNetwork","clusterBaseStyle","clusterParam","applyMapboxStyle","Cc","mapboxStyle","getStuff","sprite","getAbsoluteUrl","Kl","Mc","Ve","_baseLayer","handleBaseLayerChanged","handleMainMapViewChange","basemap","setResolution","setRotation","layerService","handleLinkedBaseLayer","Ln","_showIfNoRotation","rotationStyle","oy","at","_e","catalogService","iy","collectCatalogItems","loadCatalogWMSLayerItems","Ui","ny","loadCatalogWMTSLayerItems","ry","baselayers","loadCatalogBaseLayerItems","sy","loadCatalogArcGISRestItems","Ac","composite","loadCatalogCompositeLayerItems","createInstanceCatalog","ay","sa","query","previousMessageIds","queryLayer","getQueryUrl","HTMLGML2","ql","mergeGML","extractData","Ul","Rf","Wl","getQueryParams","bbox","appendLineString","Ht","appendPolygon","coordinates","convexHull","cross","_step27","getAllowedFieldsAndAlias","extractGML3Data","extractGeoJSONData","ESRIJSON","extractEsriJSONData","TEXT","extractTextData","extractHtmlData","extractGML2Data","_step28","createGeometryFromUrlClick","_iterator28","FEATURE_COUNT","featureCount","defaultFeatureCount","getQueryTitle","sourceTitle","fn","featureToResult","features","crs","srs","lastIndexOf","jf","GEOMETRIE","shape","SHAPE","the_geom","geom","queryUrl","getCustomQueryUrl","INFO_FORMAT","getMimeInfoFormat","QUERY_LAYERS","getFeatureInfoUrl","sql","queryPrecision","getLabelMatch","Fn","queryLayerFeatures","Fc","cancelOngoingQueries","queryService","queryEnabled","queryFeatures","doQueryFeatures","waitForAllQueries","queries$$","pr","_ref10","values_","queryFormatAsWms","_step29","nom","id_","_icon","OlRenderFeature","getEnds","getFlatCoordinates","Js","queryFeaturesHitTolerance","queryFeaturesCondition","cy","forEachFeatureIntersectingExtent","_step30","ut","getDefaultOptions","settings","setParamFromSetting","available","showInSettings","getHashtagsValid","getSettingsValues","hashtags","Ic","getGoogleMapsCoordLink","encodeURI","_ref11","_ref11$markerColor","markerOpacity","_ref11$markerOpacity","_ref11$markerOutlineC","_ref11$fillOpacity","fillOpacity","_ref11$strokeColor","strokeOpacity","_ref11$strokeOpacity","_ref12","_ref12$markerColor","_ref12$markerOpacity","_ref12$fillColor","_ref12$fillOpacity","_ref12$strokeColor","_ref12$strokeOpacity","getOpenStreetMapLink","la","loadCatalogs","ii","loadCatalogItems","Lc","getCatalogBaseLayersOptions","externalProvider","Group","getCatalogCapabilities","Service","flattenWmsCapabilities","groupSeparator","includeRecursiveItems","_step31","getWMTSItems","getArcGISRESTItems","sortDirection","groupImpose","address","_ref13","newMetadataUrl","_ref14","computeForcedProperties","metadataUrl","metadataAbstract","metadataAbstractAll","metadataUrlAll","prepareCatalogItemLayer","retrieveLayerInfoFormat","showLegend","setCrossOriginAnonymous","forcedProperties","prepareCatalogItemGroup","testLayerRegexes","_step32","findCatalogInfoFormat","ServiceIdentification","matrixSet","requestEncoding","ca","catalogAllowLegend","isGroup","isLayer","onLayerAddedChange","addLayerToMap","removeLayerFromMap","onGroupAddedChange","addGroupToMap","removeGroupFromMap","addLayersToMap","removeLayersFromMap","sortCatalogItemsByTitle","In","styles","listStyles","STYLES","updateLegendOnResolutionChange","onViewControllerStateChange","legendItems$","_step33","getLegendGraphic","imgGraphValue","toggleLegendItem","transfertToggleLegendItem","computeItemTitle","updateLegend","_step34","onChangeStyle","onLoadImage","renderedLegends","first","imagesHeight","Zc","isPreview$$","isPreview$","addedLayerIsPreview","computeTitleTooltip","ABSTRACT","CUSTOM","onMouseEvent","askForLegend","layerLegendShown$","igoLayer$","mouseInsideAdd","addedChange","haveGroup","inRange$","computeTooltip","By","evaluateAdded","evaluateDisabled","onToggleCollapsed","layerAddedChange","tryToggleGroup","onLayerPreview","preview$","toggleCollapsed","onTitleClick","Jy","kc","_activeLayer","selectionMode","layerTool$","_selectAll","layerCheck","inResolutionRange$","expandLegendIfVisible","firstLoadComponent","toggleLegend","updateQueryBadge","onResolutionChange","tooltipText","network$$","showLegend$","toggleLegendOnClick","toggleVisibility","toggleLegendOnVisibilityChange","queryBadge","queryBadgeHidden$","toggleLayerTool","check","checkbox","it","always","Jo","ALL_VISIBLE","Ni","Raise","ci","_layers","removeProblemLayerInList","activeLayer$","_keyword","_onlyVisible","_sortedAlpha","orderable","activeLayer","getUpperLayer","isUpperBaselayer","getLowerLayer","isLowerBaselayer","layersChecked","raisableLayers","selectAllCheck","lowerDisabledSelection","lowerableLayers","checkOpacity","layersCheckedOpacity","change$$","mn","gn","showToolbar$","computeShowToolbar","computeLayers","appliedFilterAndSort","keyword","sortAlpha","onlyVisible","selectAllCheck$$","selectAllCheck$","_step36","_iterator36","layerTool","excludeBaseLayers","activeLayerIsValid","activeLayersAreValid","_step37","zoomLayerExtents","zoomLayersExtents","_step38","changeOpacity","clearKeyword","moveActiveLayer","getLinkedLayers","Lower","ZINDEX","_loop8","raisableLayer","_iterator40","_step40","_loop9","computeElementRef","offsetParent","_loop10","lowerableLayer","_iterator42","_step42","_loop11","filterLayers","sortLayersByTitle","sortLayersByZindex","onKeywordChange","onAppliedFilterAndSortChange","layerFilterAndSortOptions","showToolbar","never","thresholdToFilterAndSort","toggleOpacity","_step44","removable","hideSelectedLayers","layerItemChangeDetection$","isLayerRemovable","isAllLayersRemovable","NULL","MIXED","_step46","ALL_HIDDEN","layersCheck","_step47","_iterator47","toggleSelectionMode","_step48","_step49","_iterator49","selectAll","_step51","getElementsByClassName","_step52","cv","onlyVisible$","sortAlpha$","term$","term$$","onlyVisible$$","term","sortAlpha$$","clearTerm","toggleSortAlpha","toggleOnlyVisible","Tr","layersOrResolutionChange$$","setLayersVisibilityStatus","layersVisibility$$","layersAreAllVisible","Zn","computeShownLayers","hasVisibleOrInRangeLayers$","hasVisibleAndNotInRangeLayers$","layersInUi$","showAllLegendsValue","toggleShowAllLegends","allLegendsShown","Mr","toggleTrackFeature","Pc","ui","dt","rt","ri","$c","Mv","predefinedCatalogs","addedCatalog","defaultAddedCatalogType","typeCapabilities","addedCatalogType$$","updateValueAndValidity","computePredefinedCatalogList","storeViewAll$$","emailAddress","changeUrlOrTitle","patchValue","predefinedCatalogsList$","addCatalog","dialogRef","ua","getCatalogs","onCatalogSelect","catalogSelectChange","unsubscribeAddingCatalog","addingCatalog$$","addCatalogDialog","mapName","ServiceType","addedCatalogs","onCatalogRemove","Ov","removeCatalogFromLibrary","catalogRemove","Ec","qc","Rc","isTimeFilterable","isOgcFilterable","Bc","filterByDate","reformatDateTime","filterByYear","getFullYear","getMonth","getUTCDate","getUTCHours","getUTCMinutes","pa","filterByOgc","setOgcWFSFiltersOptions","interfaceOgcFilters","setOgcWMSFiltersOptions","filtered","Te","Predefined","yt","Address","On","AdmRegion","Arrond","CircFed","CircProv","DirReg","MRC","Mun","RegTour","bornes","hydro","routes","baseUrl","getKeyByValue","loadFilterList","urlFilterList","loadThematicsList","loadFilterItem","bufferInput","simplified","loc","loadItemById","loadBufferGeometry","bufferOutput","Jc","outputFormatDownload","Pv","openDownload","downloadService","Ar","pi","unsubscribe$","_source","_feature","selectFeature","ready","urlSanitizer","sanitizer","isHtmlDisplay","htmlDisplayEvent","htmlSanitizer","openSecureUrl","isDoc","isEmbeddedLink","getEmbeddedLinkText","filterFeatureProperties","Route","kn","Point","Dn","Arial","olDrawingLayer","drawingLayer","createOlInnerOverlayLayer","olGeometryType","geometryType","olDrawingLayerSource","clearOlInnerOverlaySource","removeOlInnerOverlayLayer","removeOlInteractions","addOlInnerOverlayLayer","addOlInteractions","setGeometryType","Po","drawingLayerSource","Vt","drawingLayerStyle","freehand$","fr","maxPoints","freehand","stopClick","interactionStyle","freehandCondition","olDrawInteraction","onDrawStartKey","onDrawStart","onDrawEndKey","onDrawEnd","onDrawAbortKey","abort$","Qs","olModifyInteraction","olSelectInteraction","Rs","tc","onSelect","unsubscribeKeyDown","onDrawKey","start$","mousePosition","ha","changes$","subscribeKeyDown","modify$","end$","select$","keyDown$$","removeLastPoint","finishDrawing","abortDrawing","t1","cancelDrawing","confirm","confirmFlag","o1","Et","Length","ne","Meters","fa","Kilometers","Miles","Feet","We","SquareMeters","Qc","SquareKilometers","SquareMiles","SquareFeet","Hectares","Acres","i1","r1","n1","s1","a1","l1","c1","u1","decimal","toLocaleString","minimumFractionDigits","maximumFractionDigits","toFixed","unit","unitAbbr","olGetLength","ya","olGetArea","area","lengths","Gc","getCoordinateAt","setCoordinates","Yc","removeOverlay","oc","stopEvent","setPosition","Olstyle","v1","getFillColor","setFillColor","getStrokeColor","setStrokeColor","getStrokeWidth","getLabelsAreShown","labelsAreShown","toggleLabelsAreShown","setIcon","getIcon","getFontSize","fontSize","setFontSize","getFontStyle","fontStyle","setFontStyle","createDrawingLayerStyle","flatCoordinates","cos","b1","getIconsList","getIcons","icons","getPath","Xc","draw","buildForm","drawStyleService","drawIconService","drawControl","createDrawControl","toggleDrawControl","ji","Vc","onGeometryTypeChange","wn","vc","many","clearLabelsOfOlGeometry","selectedFeatures$","onColorChange","strokeForm","onToggleDrawControl","deactivateDrawControl","activateDrawControl","openDialog","currentLabel","updateLabelOfOlGeometry","onSelectDraw","drawControlIsDisabled","drawControlIsActive","drawEnd$$","onModifyDraw","drawSelect$$","addFeatureToStore","replaceFeatureInStore","rad","Gs","longitude","latitude","deleteDrawings","xa","onToggleLabels","_label","onIconChange","openShorcutsDialog","editLabelDrawing","onFontChange","Kc","Ue","ec","Ca","A1","So","modify","olOverlayLayer","olLinearRingsLayer","createOlLinearRingsLayer","olOverlaySource","removeOlModifyInteraction","removeOlTranslateInteraction","removeOlDrawInteraction","addOlDrawInteraction","addOlTranslateInteraction","activateTranslateInteraction","addOlModifyInteraction","activateModifyInteraction","setOlGeometry","layerStyle","jc","addOlLinearRingsLayer","removeOlLinearRingsLayer","clearOlLinearRingsSource","olLinearRingsSource","drawStyle","deactivateModifyInteraction","olModifyInteractionIsActive","onModifyStartKey","onModifyStart","onModifyEndKey","onModifyEnd","onModifyKey","item","subscribeToKeyDown","unsubscribeToKeyDown","Jl","olTranslateInteraction","deactivateTranslateInteraction","olTranslateInteractionIsActive","onTranslateStartKey","onTranslateStart","onTranslateEndKey","onTranslateEnd","onTranslateKey","olOuterGeometry","getOlGeometry","intersectsCoordinate","subscribeToDrawKeyDown","drawKeyDown$$","unsubscribeToDrawKeyDown","subscribeToDrawKeyUp","activateDrawInteraction","drawKeyUp$$","unsubscribeToDrawKeyUp","deactivateDrawInteraction","olDrawInteractionIsActive","removedOlInteractions","getLinearRing","addLinearRingToOlGeometry","updateLinearRingOfOlGeometry","appendLinearRing","Qf","getLinearRings","En","ou","onNoClick","Sa","activeLengthUnit","$n","Pn","measure","activeAreaUnit","Lr","_activeMeasureType","setActiveMeasureType","activeDrawControl","createDrawLineControl","createDrawPolygonControl","createModifyControl","updateTooltipsOfOlSource","checkDistanceAreaToggle","deactivateModifyControl","freezeStore","onMeasureTypeChange","activeMeasureType","onToggleMeasureUnitsAuto","measureUnitsAuto","onToggleDisplayDistance","displayDistance","onDisplayDistance","onToggleDisplayLines","displayLines","onDisplayLines","onToggleDisplayAreas","displayAreas","onDisplayAreas","onLengthUnitChange","table","activeOlGeometry","updateTooltipsOfOlGeometry","onAreaUnitChange","onCalculateClick","perimeter","onDeleteClick","olDrawSource","onModifyClick","modifyControl","activateModifyControl","clearTooltipsOfOlGeometry","onFeatureAddedKey","updateMeasureOfOlGeometry","onFeatureRemovedKey","selectedFeatures$$","hasArea$","hasLine$","drawLineControl","_a","drawPolygonControl","tu","Area","drawStart$$","drawChanges$$","onDrawChanges","clearMeasures","clearTooltipsOfOlSource","finalizeMeasureOfOlGeometry","va","measure$","modifyStart$$","modifyEnd$$","modifyChanges$$","onModifyChanges","_measure","ba","Hc","updateOlTooltip","olGetCenter","showTooltipsOfOlGeometry","shouldShowTooltip","addOverlay","forEachFeature","showTooltipsOfOlSource","_unit","_type","computeTooltipInnerHTML","showTooltips","minSegmentLength","iu","nu","createMeasureTooltip","ngControl","toggleControl","_geometryType","deactivateControl","freehandDrawIsActive","_drawControlIsActive","_freehandDrawIsActive","_drawStyle","Nc","getGuideStyleFromDrawStyle","defaultDrawStyleRadius","_overlayStyle","_value","addGeoJSONToOverlay","features_","overlayStyle","addOlOverlayLayer","registerOnChange","registerOnTouched","onTouched","writeValue","controlOptions","updateDrawStyleWithDrawGuide","activeControl","activateControl","olGeometryEnds$$","onOlGeometryEnds","olGeometryChanges$$","onOlGeometryChanges","removeMeasureTooltip","updateMeasureTooltip","circleToPoint","olGeoJSON","olTooltip","drawGuide","isStyleWithRadius","ru","wa","qn","ab","YEAR","isNaN","startDate","endDate","SLIDER","getStepDefinition","timeInterval","getTimezoneOffset","startYear","initStartYear","endYear","initEndYear","isRange","startListYears","endListYears","listYears","checkFilterValue","yearChange","year","storeCurrentFilterValue","handleDateChange","setupDateOutput","applyTypeChange","handleYearChange","handleListYearChange","handleListYearStartChange","dateToNumber","setSliderThumbLabel","findThumbLabel","mySlider","_elementRef","childNodes","textContent","toggleFilterState","stopFilter","resetFilter","date","playFilter","interval","playIcon","playYear","handleSliderDateChange","handleSliderTooltip","handleSliderYearChange","handleSliderValue","current","getRoundedDate","toDateString","toTimeString","setSeconds","setHours","setMinutes","getDay","getHours","getMinutes","getRangeMinDate","getRangeMaxDate","asMilliseconds","Fr","timeFilterService","datasource","filtersCollapsed","toggleFiltersCollapsed","Ir","hb","wktToFeature","extentToWkt","roundCoordinateArray","wktPoly","wktLine","wktMultiPoints","roundArray","snrcToWkt","su","allOgcFilterOperators","ogcFilterOperators$","igoSpatialSelectors","_snrc","currentFilter","allowedOperators","fields$","excludeFromOgcFilters","updateFieldsList","selectedField$","updateValuesList","currentFilterIsSpatial","filteredFields$","_filterFields","changeField","filteredValues$","_filterValues","changeProperty","clearSelectedField","clearProperty","isClearable","detectProperty","refreshFilters","deleteFilter","changeLogical","changeOperator","currentFilterIsSpatial$","changeSpatialSelector","changeCaseSensitive","changeNumericProperty","changeMapExtentGeometry","changeSNRC","snrc","changeSNRCGeometry","wktService","isTemporalOperator","ogcFilterOperator","au","Rn","hasSelector","ogcFilterService","lastRunOgcFilter","hasActiveSpatialFilter","filtersAreEditable","addFilterToSequence","defaultLogicalParent","isAdvancedOgcFilters","addFilterDisabled","changeOgcFiltersAdvancedOgcFilters","changeOgcFilterType","Zr","Bn","Ta","stepMillisecond","defaultStepMillisecond","stepIsYearDuration","years","months","weeks","days","hours","minutes","stepIsMonthDuration","stepIsWeekDuration","stepIsDayDuration","stepIsHourDuration","stepIsMinuteDuration","wo","addStep","toDate","subtractStep","subtract","lu","_currentFilter","pushButtonsGroup","checkboxesGroup","radioButtonsGroup","selectGroup","autocompleteGroup","selectEnabled$","applyFiltersTimeout","currentSelectGroup","applyFilters","selectEnableds$","autocompleteEnabled$","currentAutocompleteGroup","selectMulti","getPushButtonsGroups","getCheckboxesGroups","getRadioButtonsGroups","getSelectGroups","getAutocompleteGroups","currentPushButtonsGroup","currentCheckboxesGroup","currentRadioButtonsGroup","getSelectEnabled","getSelectDomValues","getAutocompleteEnabled","getAutocompleteDomValues","onPushButtonsChangeGroup","onCheckboxesChangeGroup","onRadioButtonsChangeGroup","onSelectChangeGroup","onAutocompleteChangeGroup","selectEnableds","selectEnabled","autocompleteEnabled","getToolTip","domSelectors","_step55","domService","_loop13","_step59","_step60","filteredOgcAutocomplete","getButtonColor","bundleIsVertical","vertical","emptyRadioButtons","emptySelect","emptyAutocomplete","markAsUntouched","toggleAllSelection","selectAllSelected","sel","deselect","selectOptionClick","isUserInput","_step61","autocompleteOptionClick","displayFn","_i8","isMoreResults","radioButtonsIndex","checkboxesIndex","displayMoreResults","isLessResults","baseIndex","displayLessResults","decls","Ma","spatialType","Polygon","_store","selectedTypeIndex","activeDrawType","onTypeChange","onDrawTypeChange","eventQueryType","selectedQueryType","zoneChange","K0","_queryType","_zone","zoneWithBuffer","bufferFormControl","formValueChanges$$","bufferValueChanges$$","measureUnit","bufferChange","spatialFilterService","selectedZone","queryType","zoneWithBufferChange","onZoneChange","onMeasureUnitChange","measureUnitChange","entityChange","Aa","Thematics","Gf","Eo","geometryTypes","drawGuide$","drawStyle$","radiusFormControl","PointStyle","olStyle","PolyStyle","overlayStyle$","_thematicLength","_step64","childrens","thematics","_step65","value$","value$$","drawZone","drawZoneEvent","radiusChanges$$","bufferChanges$$","bufferEvent","_o","detach","onItemTypeChange","selectedItemType","itemTypeChange","isPolygon","isPoint","isPredefined","hasChild","treeControl","isExpanded","collapse","selectedThematics","hasChildrenSelected","_step66","thematicChange","childrensToggle","_step67","onToggleChange","_step68","onDrawControlChange","onfreehandControlChange","freehandControl","toggleSearchButton","radiusEvent","toggleSearch","thematicLength","openWorkspace","createTableTemplate","clearButton","clearButtonEvent","tableTemplate","clearDrawZone","clearSearch","clearSearchEvent","disableSearchButton","zone","disabledClearSearch","toggleVisibleList","listIsVisible","La","_beginValue","_endValue","sliderInterval","_defaultMax","displayFormat","_defaultDisplayFormat","_defaultSliderModeEnabled","beginValue","parseFilter","handleMin","endValue","handleMax","onlyYearBegin","getUTCFullYear","onlyYearEnd","calendarTypeYear","isCalendarYearMode","setFilterStateDisable","updateHoursMinutesArray","updateValues","endOf","getDateFromStringWithoutTime","changeTemporalProperty","getDateTime","pos","refreshFilter","calendarType","sliderMode","restrictedToStep","ogcFilterTimeService","stepMilliseconds","toISOString","handleDate","yearOnlyInputChange","yearSelected","monthSelected","calendarView","dateFilter","ae","asYears","asMonths","asWeeks","asDays","asHours","beginHourFormControl","beginMinuteFormControl","endHourFormControl","endMinuteFormControl","handleMinuteIncrement","handleHourIncrement","fullBeginHoursArray","beginHours","fullEndHoursArray","endHours","fullBeginMinutesArray","beginMinutes","fullEndMinutesArray","endMinutes","restrictToStep","_defaultMin","changePropertyByPass","modeChange","filterStateDisable","toLocaleDateString","Tt","Ex","sliderDisplayWith","_defaultSliderInterval","calculateStep","handleSliderInput","beginMillisecond","slider","calculatedStep","_increment","_emitInputEvent","startOf","maxMillisecond","To","Q","_t","gt","yn","setPrototypeOf","Ia","prototype","cu","ee","no","eo","Za","ogreUrl","aggregateInComment","export","generateFeature","exportAsync","GPX","generateAggregatedFeature","nothingToExport","ogreFormats","noOgreFallbacks","exportToFile","exportWithOgre","setAttribute","writeFeatures","featureType","UTF8","acceptCharset","enctype","LATIN1","Yf","mode","submit","GML","KML","Shapefile","CSVcomma","CSVsemicolon","Oa","getStyleList","distance","Vx","mimeType","Qi","Dr","di","Pr","ka","du","clientSideFileSizeMax","import","importAsync","getFileImporter","pu","allowedMimeTypes","allowedZipMimeTypes","allowedExtensions","importFile","importFileWithOgre","Wx","parseFeaturesFromFile","readAsText","FormData","append","parseFeaturesFromGeoJSON","msg","startWith","Xx","Ns","Nl","Us","writeFeatureObject","$r","styleList","gu","loadConfig","computeProjections","_projectionsLimitations","importForm","inputProj","exportableLayers$","fileSizeMb","exportOptions$$","exportOptions$","computeFormats","formLayer$$","popupChecked","handlePopup","handlePreviousLayerSpecs","formats$","loading$","previousLayerSpecs$","formats$$","encodings$$","encodings$","encoding","exportableLayers$$","controlFormat","selectFirstProj","projections$","translateKey","projectionsConstraints","mtmZone","utmZone","projFromConfig","nad83","wgs84","webMercator","utm","mtm","minZone","maxZone","projectionsLimitations","getWorkspaceByLayerId","getLayerTitleById","layerHasSelectedFeatures","onlySelected","layersWithSelection","onlySelectedClick","inLayersIdToExportSelectionOnly","exportOptionsChange","importFiles","espgCodeRegex","importService","onFileImportSuccess","onFileImportError","closed","onPopupBlockedError","popupAllowed","handleExportFormSubmit","combineLayers","featureInMapExtent","separator","createTitleEmptyRows","exportService","onFileExportError","onFileExportSuccess","unset","olPoint","forceNaming","kr","styleListService","jx","Gx","Qx","zx","Hx","extraMessage","loadEncodings","encodingDefaultValue","onlyUrl","onlyVector","vectorAndUrl","customList","allowedFormats","formats","validateListFormat","GeoJSON","modeChanged","selectMode","onImportExportChange","selectedMode","mu","fu","hu","xC","Er","nt","wC","_auto","toggleAutoUnit","measureType","measure$$","computeBestMeasureUnit","_u","yu","Jn","Da","features$","TC","olFormatGeoJSON","features$$","overlayService","handleFeatures","qr","MC","print","paperFormat","orientation","zf","internal","getTitleSize","addTitle","subtitle","getSubTitleSize","addSubTitle","showProjection","showScale","addProjScale","comment","addComment","addMap","_context8","addScale","handleMeasureLayer","legendPosition","addLegendSamePage","addLegend","saveDoc","getOverlayContainer","vn","backgroundColor","addCanvas","getLayersLegendHtml","_step71","_step72","getDataImage","rxMap","getLayersLegendImage","useCORS","generateCanvaFileToZip","saveCanvasImageAsFile","setFont","getTextWidth","getStringUnitWidth","scaleFactor","ea","addPage","toDataURL","addImage","getOverlayContainerStopEvent","_i9","allowTaint","defineNbFileToProcess","nbFileToProcess","getImageSizeToFitPdf","rect","getViewport","_step73","renderMap","_step74","downloadMapImage","getContext","measureText","ceil","fillStyle","fillRect","fillText","drawImage","getWorldFileInformation","addFileToZip","Ys","saveFileProcessing","renderSync","updateSize","save","returnPromise","getHeight","msSaveBlob","msToBlob","toBlob","zipFile","Vf","file","getZipFile","generateAsync","vu","bu","xu","Cu","Su","wu","kC","imageFormat","doZipFile","isPrintService","imageFormatField","Jpeg","onlySelf","outputFormatField","Pdf","paperFormatField","Letter","orientationField","landscape","resolutionField","legendPositionField","none","titleField","subtitleField","commentField","showProjectionField","showScaleField","showLegendField","doZipFileField","handleFormSubmit","toggleImageSaveProp","Tu","_outputFormat","_paperFormat","_orientation","_imageFormat","_legendPosition","_resolution","printService","Pa","Un","DC","Ea","Rr","Br","gi","Coord","Mo","Stop","Ao","Start","Intermediate","End","relativePosition","Jr","qa","aggregatedDirection","translatedModifier","translatedDirection","coma","exit","cntSuffix","instruction","cssClass","eS","unlistenMapSingleClick","onStopEnter","stopWithHover","onStopLeave","getOptionText","chooseProposal","zs","stopsStore","setStopText","clearStop","validateTerm","keyIsValid","invalidKeys","getNgClass","getPlaceholder","removeStop","drop","moveStops","previousIndex","currentIndex","bn","onInputFocus","stopInputHasFocus","listenMapSingleClick","stopsFeatureStore","Ct","olProj","coordRoundedDecimals","onMapClickEventKeys","tS","directionsSourceService","routeSource","reverseSearch","Fu","getSources","getEnabledSources","enableSourcesByType","Yi","termIsValid","uc","getEnabledOnly","searchSourceService","searchType","Nn","Ja","Lu","reverseSearchSources","sS","routesFeatureStore","resetStops","clearStops","addStop","Ra","copyLinkToClipboard","zoomRoute","zoomToActiveRoute$","copyDirectionsToClipboard","directionsToText","activeRoute","Ur","Mu","formatStep","Au","maneuver","modifier","bearing_after","contextUri","pathname","dS","directions","activeDirection","changeRoute","formatDistance","formatDuration","onStepsListBlur","stepFeatureStore","showSegment","showRouteSegmentGeometry","olGeom","Vertex","Iu","initEntityStores","Ba","initOlInteraction","storeEmpty$$","storeChange$$","routesQueries$$","zoomRoute$$","freezeStores","selectStopInteraction","translateStop","selectedRoute","monitorEmptyEntityStore","monitorEntityStoreChange","monitorActiveRouteZoom","isTranslating","executeStopTranslation","focusOnStop","onStopInputHasFocusChange","getLength","storeInitialized$","debounce","handleStopDiff","handleStopsFeature","getRoutes","cancelSearch","searchs$$","previousStops","searchService","searchProposals","Text","results","addStopOverlay","directionsService","overview","alternatives","continue_straight","stopText","stopColor","stopOpacity","stop","Ua","$C","$a","Nr","formatResult","encodeKey","encodeValue","decodeKey","decodeValue","Zu","title$","getAllowedTypes","ecmax","computeRequestParams","page","extractResults","hashtagsLieuxToKeep","computeOptionsParam","computeTerm","_o$extent","encoder","hS","formatter","dataToResult","computeProperties","dataType","titleHtml","highlight","title2","title3","score","Gi","nextPage","propertiesBlacklist","GoogleMaps","Yt","getGoogleMapsNameLink","municipalite","GoogleStreetView","getGoogleStreetViewLink","Ou","getSubtitle","computeExtent","pointerSummaryTitle","ku","Du","coord","igo2CoordFormat","writeGeometry","OpenStreetMap","uy","jr","_slicedToArray","_l14","Pu","computeSearchRequestParams","computeLayerOptions","groupTitle","extractQueryParamsFromSourceUrl","urls","_i10","$u","ZS","searchType$","setSearchType","searchType$$","onSetSearchType","onSearchTypeChange","getSearchTypeTitle","searchTypeChange","Na","NS","now","pointerSummaryEnabled","pointerSummaryStatus","hasPointerReverseSearchSource","hasReverseSearchSourcesForPointerSummary","getSearchSources","computeSourcesCheckAllBehavior","settingsValueCheckedCheckbox","searchSourceChange","computeSettingCheckAllBehavior","allEnabled","searchSourcesAllEnabled","checkUncheckAll","checkUncheckAllSources","settingsValueCheckedRadioButton","onCheckSearchSource","getAvailableValues","getAvailableHashtagsValues","changePointerReverseSearch","changeSearchResultsGeometry","searchResultsGeometryEnabled","searchResultsGeometryStatus","ja","Qa","setTerm","stream$$","stream$","onSetTerm","handlePlaceholder","onKeyup","onClearButtonClick","clearFeature","onSearchSettingsChange","doSearch","searchSettingsChange","minLength","input","searchTermChange","placeholder$","researches$$","termSplitter","onResearchCompleted","research","Eu","nw","titleHtmlProperty","onZoomHandler","resultFocus","resultUnfocus","jn","Grouped","Ru","_term","pageIterator","_results$","liftResults","settingsChange$$","settingsChange$","computeGroupTitle","onResultSelect","resultSelect","groupResults","sortByOrder","displayOrder","Ot","moreResults","Bu","layersSubcriptions","Ju","fw","_w","ngAfterContentChecked","unsubscribeReverseSearch","pointerSearchStore","computeSummaryClosestFeature","addPointerOverlay","reverseSearch$$","igoSearchPointerSummaryEnabled","onSearchCoordinate","igoSearchPointerSummaryDelay","onSearch","_loop17","searchPointerSummaryFeatureId","pointerSummary","Qr","gS","fS","CS","MS","xw","Ga","Uu","getLayerWksOptionTabQuery","queryOptions","tabQuery","getLayerWksOptionMapQuery","mapQueryOnOpenTab","getInResolutionRange","Nu","createWorkspace","srcId","workspaceId","Ya","createFeatureStore","Cr","qi","xr","Bo","zoomAuto","createFilterInMapExtentOrResolutionStrategy","relations","ws$","class_icon","ju","circle","ww","cancelAction","confirmedAction","newFeature","edit","deleteFeature","deleteUrl","_step75","primary","editionWorkspaceService","editFeature","getDomainValues","relation","original_properties","original_geometry","idkey","editFeaturefilterClauseFunc","geomType","adding$","newFeaturefilterClauseFunc","addWithDraw","createModifyInteraction","Wf","modifyStyle","Gu","Qu","wksConfig","editMode","modifyButton","deleteButton","saveFeature","cancelEdit","validateFeature","sanitizeParameter","addUrl","addHeaders","modifyProtocol","modifyUrl","modifyHeaders","modifyFeature","hasGeometry","_step77","refreshMap","rowsInMapExtentCheckCondition$","_step78","_step79","_step80","_iterator80","relationLayers$","_step81","Gr","zu","Yu","Tw","onLayersChange","featureWorkspaceService","changeWorkspace","wmsWorkspaceService","wfsWorkspaceService","relationLayers","rowsInMapExtentCheckCondition","layerIsEditable","getOrCreateWorkspace","workspaceStore","Hu","Vu","Mw","Wu","Cw","Lw","directionsUrl","_name","getRouteParams","extractRoutesData","formatRoute","waypoints","geometries","legs","summary","sourceType","weight_name","op","endsWith","numero","epsg","computeGeometry","NoLot","ip","place_id","display_name","osm_type","class","lon","lat","boundingbox","computeTermTags","computeTermSettings","np","storedQueriesOptions","storedquery_id","defaultValue","splitPrefix","outputformat","srsname","resultTitle","multipleFieldsQuery","extractWFSData","getFormatFromOptions","rp","longField","latField","doc_type","Jw","onPointerMove","pointerCoord","Uw","Qw","Gw","zw","Hw","Ww","Xw","tT","geometryTypeField","drawGuideField","drawGuidePlaceholder","oT","nT","rT","aT","media","lT","uT","pT","gT","mT","_T","handleQueryResults","feature$","yT","bT","onCatalogSelectChange","catalogStore","catalogItemStore","xT","It","oo","ours","basePath","contextListFile","defaultContextUri","readParamsFromRoute","hasAuthService","contexts$","handleContextsChange","loadContexts","_defaultContextUri","getById","getDetails","getDefault","defaultContextId$","getContextByUri","getProfilByUser","setDefault","defaultContextId","hideContext","showContext","importedContext","permission","write","addToolAssociation","toolId","deleteToolAssociation","getPermissions","addPermissionAssociation","profil","typePermission","deletePermissionAssociation","getLocalContexts","getLocalContext","base","loadDefaultContext","uri","addContextToList","setContext","loadContext","context$","handleContextMessage","keepCurrentView","mapViewFromRoute","loadEditedContext","setEditedContext","editedContext$","getContextFromMap","_step82","layerOptions","global","getContextFromLayers","extraFeatures","_i11","imported","getContextLayers","findContext","toolsChanged$","_i12","Wa","ap","context$$","contextService","handleContextChange","minWidth","lp","removeLayersOnContextChange","contextLayers","CT","computeLayerVisibilityFromUrl","zi","cp","r2","context","favoriteClick","favorite","manageTools","managePermissions","Wr","contextsInitial","shared","public","_contexts","_selectedContext","_defaultContextId","contexts","filterContextsList","createContext","sortedAlpha","sortContextsList","showFilter","showContextFilter","thresholdToFilter","toggleSort","clearFilter","empty","getPermission","permissions","userSelection","indeterminate","_step83","_iterator83","childs","_step84","filterPermissionsChanged","showHidden","Xa","onEdit","onSave","onFavorite","onManageTools","onManagePermissions","onDelete","confirmDialogService","onClone","onCreate","_step85","showHiddenContexts","onShowContext","onHideContext","contexts$$","defaultContextId$$","selectedContext$$","selectedContext","users","_step86","_step87","dp","gp","Ka","Hi","po","Vi","setImportExportType","importExportType$","setMode","selectedMode$","setsExportOptions","Zt","toolToActivateFromOptions","tool","importExportState","openSidenav$","igoStorageService","AM","storageState","storageChange$$","loadActions","buildActions","zoomAuto$","Wi","za","Ha","toolState","maximize$","LM","ogcFilterWidget","FM","Xr","initWorkspaces","workspace$","Dl","wfsActionsService","selectOnlyCheckCondition$","featureActionsService","editionActionsService","actionMaximize$$","setWorkspaceIsMaximized","activeWorkspace$$","activeWorkspaceWidget$$","activeWorkspaceWidget$","rowsInMapExtentCheckCondition$$","selectOnlyCheckCondition$$","workspaceMaximize$","setActiveWorkspaceById","setActiveWorkspaceByTitle","teardownWorkspaces","searchOverlayStyle","searchOverlayStyleSelection","searchOverlayStyleFocus","searchResultsGeometryEnabled$","createCustomFilterTermStrategy","activateCustomFilterTermStrategy","deactivateCustomFilterTermStrategy","enableSearch","searchDisabled$","disableSearch","setSearchTerm","searchTerm$","setSearchSettingsChange","searchSettingsChange$","setSelectedResult","selectedResult$","setSearchResultsGeometryStatus","$A","UA","xp","sL","osmLayer","searchState","onPointerSummaryStatusChange","onSearchTermChange","searchStore","selectedFeature","onResultFocus","tryAddFeatureToMap","onOpenGoogleMaps","onOpenGoogleStreetView","removeFeatureFromMap","onContextMenuOpen","mapPosition","getCoordinateFromPixel","lonlat","mapBrowser","getBoundingClientRect","scrollY","scrollX","onPointerSearch","_loop21","aL","wS","Zw","yS","LS","kw","bS","Pw","Ew","cL","uL","dL","gL","hL","Xu","Ku","tp","ep","fL","Fw","yL","vL","xL","CL","TL","getOutputType","getOutputQueryType","spatialListStore","getOutputToggleSearch","loadThematics","getOutputClearSearch","tryAddFeaturesToMap","itemType","tryAddPointToMap","tryAddLayerToMap","zoomToFeatureExtent","_step89","_internal","selectedFeature$","ML","DL","workspaceState","selectedWorkspace$","workspacePaginator","PL","qL","RL","BL","redirectTo","pathMatch","JL","useHash","UL","mobileQuery","matchMedia","_mobileQueryListener","addEventListener","themeClass","detectOldBrowser","removeEventListener","NL","bootstrap","jL","No","jo","nl","bootstrapModule"],"sources":["webpack:///$_lazy_route_resources|lazy|groupOptions:%20%7B%7D|namespace%20object","webpack:///dist/core/locale|sync|/^/.*/.json$","webpack:///packages/utils/src/lib/base64.ts","webpack:///packages/utils/src/lib/user-agent.ts","webpack:///packages/utils/src/lib/clipboard.ts","webpack:///packages/utils/src/lib/string-utils.ts","webpack:///packages/utils/src/lib/change.interface.ts","webpack:///packages/utils/src/lib/change.ts","webpack:///packages/utils/src/lib/object-utils.ts","webpack:///packages/utils/src/lib/number-utils.ts","webpack:///packages/utils/src/lib/strenum.ts","webpack:///packages/utils/src/lib/uuid.ts","webpack:///packages/utils/src/lib/watcher.ts","webpack:///packages/core/src/lib/activity/activity.service.ts","webpack:///packages/core/src/lib/activity/activity.interceptor.ts","webpack:///packages/core/src/lib/activity/activity.module.ts","webpack:///packages/core/src/lib/config/version.ts","webpack:///packages/core/src/lib/config/config.service.ts","webpack:///packages/core/src/lib/config/config.provider.ts","webpack:///packages/core/src/lib/config/config.module.ts","webpack:///packages/core/src/lib/language/shared/language.loader.ts","webpack:///packages/core/src/lib/language/shared/language.provider.ts","webpack:///packages/core/src/lib/language/shared/missing-translation.guard.ts","webpack:///packages/core/src/lib/language/language.module.ts","webpack:///packages/core/src/lib/message/message.module.ts","webpack:///packages/core/src/lib/language/shared/language.service.ts","webpack:///packages/core/src/lib/message/shared/message.enum.ts","webpack:///packages/core/src/lib/message/shared/message.service.ts","webpack:///packages/core/src/lib/request/error.interceptor.ts","webpack:///packages/core/src/lib/request/error.module.ts","webpack:///packages/core/src/lib/core.module.ts","webpack:///packages/core/src/lib/route/route.service.ts","webpack:///packages/core/src/lib/media/media.enum.ts","webpack:///packages/core/src/lib/media/media.service.ts","webpack:///packages/core/src/lib/storage/storage.interface.ts","webpack:///packages/core/src/lib/storage/storage.service.ts","webpack:///packages/core/src/lib/compression/compression.service.ts","webpack:///packages/core/src/lib/network/network.service.ts","webpack:///packages/common/src/lib/entity/shared/entity.enums.ts","webpack:///packages/common/src/lib/entity/shared/entity.utils.ts","webpack:///packages/common/src/lib/entity/shared/state.ts","webpack:///packages/common/src/lib/entity/shared/view.ts","webpack:///packages/common/src/lib/entity/shared/store.ts","webpack:///packages/common/src/lib/entity/shared/watcher.ts","webpack:///packages/common/src/lib/entity/shared/strategies/strategy.ts","webpack:///packages/common/src/lib/entity/shared/strategies/filter-custom-function.ts","webpack:///packages/common/src/lib/entity/shared/strategies/filter-selection.ts","webpack:///packages/common/src/lib/entity/entity-selector/entity-selector.component.html","webpack:///packages/common/src/lib/entity/entity-selector/entity-selector.component.ts","webpack:///packages/common/src/lib/stop-propagation/stop-propagation.directive.ts","webpack:///packages/common/src/lib/entity/entity-table/entity-table-row.directive.ts","webpack:///packages/common/src/lib/entity/entity-table-paginator/entity-table-paginator.component.ts","webpack:///packages/common/src/lib/entity/entity-table-paginator/entity-table-paginator.component.html","webpack:///packages/common/src/lib/image/secure-image.pipe.ts","webpack:///packages/common/src/lib/custom-html/custom-html.pipe.ts","webpack:///packages/common/src/lib/entity/entity-table/entity-table.component.html","webpack:///packages/common/src/lib/entity/entity-table/entity-table.component.ts","webpack:///packages/common/src/lib/action/shared/action.enums.ts","webpack:///packages/common/src/lib/action/actionbar/actionbar-item.component.html","webpack:///packages/common/src/lib/action/actionbar/actionbar-item.component.ts","webpack:///packages/common/src/lib/action/actionbar/actionbar.component.html","webpack:///packages/common/src/lib/action/actionbar/actionbar.component.ts","webpack:///packages/common/src/lib/action/actionbar/actionbar.module.ts","webpack:///packages/common/src/lib/action/action.module.ts","webpack:///packages/common/src/lib/badge-icon/badge-icon.directive.ts","webpack:///packages/common/src/lib/badge-icon/badge-icon.module.ts","webpack:///packages/common/src/lib/clickout/clickout.directive.ts","webpack:///packages/common/src/lib/clickout/clickout.module.ts","webpack:///packages/common/src/lib/collapsible/collapse.directive.ts","webpack:///packages/common/src/lib/collapsible/collapsible.component.ts","webpack:///packages/common/src/lib/collapsible/collapsible.component.html","webpack:///packages/common/src/lib/collapsible/collapsible.module.ts","webpack:///packages/common/src/lib/confirm-dialog/confirm-dialog.component.ts","webpack:///packages/common/src/lib/confirm-dialog/confirm-dialog.component.html","webpack:///packages/common/src/lib/confirm-dialog/confirm-dialog.service.ts","webpack:///packages/common/src/lib/confirm-dialog/confirm-dialog.module.ts","webpack:///packages/common/src/lib/context-menu/context-menu.directive.ts","webpack:///packages/common/src/lib/context-menu/context-menu.module.ts","webpack:///packages/common/src/lib/custom-html/custom-html.module.ts","webpack:///packages/common/src/lib/dom/dom.service.ts","webpack:///packages/common/src/lib/dom/dom.module.ts","webpack:///packages/common/src/lib/drag-drop/drag-drop.module.ts","webpack:///packages/common/src/lib/dynamic-component/shared/dynamic-component.ts","webpack:///packages/common/src/lib/dynamic-component/shared/dynamic-component.service.ts","webpack:///packages/common/src/lib/dynamic-component/dynamic-outlet/dynamic-outlet.component.ts","webpack:///packages/common/src/lib/dynamic-component/dynamic-outlet/dynamic-outlet.component.html","webpack:///packages/common/src/lib/dynamic-component/dynamic-outlet/dynamic-outlet.module.ts","webpack:///packages/common/src/lib/dynamic-component/dynamic-component.module.ts","webpack:///packages/common/src/lib/flexible/flexible.module.ts","webpack:///packages/common/src/lib/form/form/form.component.ts","webpack:///packages/common/src/lib/form/shared/form.utils.ts","webpack:///packages/common/src/lib/form/form/form.component.html","webpack:///packages/common/src/lib/form/form/form.module.ts","webpack:///packages/common/src/lib/form/shared/form.service.ts","webpack:///packages/common/src/lib/form/shared/form-field.service.ts","webpack:///packages/common/src/lib/form/form-field/form-field.component.html","webpack:///packages/common/src/lib/form/form-field/form-field.component.ts","webpack:///packages/common/src/lib/form/form-field/form-field.module.ts","webpack:///packages/common/src/lib/form/form-group/form-group.component.html","webpack:///packages/common/src/lib/form/form-group/form-group.component.ts","webpack:///packages/common/src/lib/form/form-group/form-group.module.ts","webpack:///packages/common/src/lib/form/form.module.ts","webpack:///packages/common/src/lib/entity/entity-selector/entity-selector.module.ts","webpack:///packages/common/src/lib/stop-propagation/stop-propagation.module.ts","webpack:///packages/common/src/lib/entity/entity-table-paginator/entity-table-paginator.module.ts","webpack:///packages/common/src/lib/image/image.module.ts","webpack:///packages/common/src/lib/entity/entity-table/entity-table.module.ts","webpack:///packages/common/src/lib/entity/entity.module.ts","webpack:///packages/common/src/lib/interactive-tour/interactive-tour.loader.ts","webpack:///packages/common/src/lib/interactive-tour/interactive-tour.service.ts","webpack:///packages/common/src/lib/tool/shared/toolbox.ts","webpack:///packages/common/src/lib/tool/shared/tool.service.ts","webpack:///packages/common/src/lib/interactive-tour/interactive-tour.component.html","webpack:///packages/common/src/lib/interactive-tour/interactive-tour.component.ts","webpack:///packages/common/src/lib/interactive-tour/interactive-tour.module.ts","webpack:///packages/common/src/lib/keyvalue/keyvalue.pipe.ts","webpack:///packages/common/src/lib/keyvalue/keyvalue.module.ts","webpack:///packages/common/src/lib/list/list-item.directive.ts","webpack:///packages/common/src/lib/list/list.component.ts","webpack:///packages/common/src/lib/list/list.component.html","webpack:///packages/common/src/lib/list/list.module.ts","webpack:///packages/common/src/lib/panel/panel.component.html","webpack:///packages/common/src/lib/panel/panel.component.ts","webpack:///packages/common/src/lib/panel/panel.module.ts","webpack:///packages/common/src/lib/spinner/spinner.component.ts","webpack:///packages/common/src/lib/spinner/spinner.component.html","webpack:///packages/common/src/lib/spinner/spinner-activity.directive.ts","webpack:///packages/common/src/lib/spinner/spinner.module.ts","webpack:///packages/common/src/lib/table/table-datasource.ts","webpack:///packages/common/src/lib/table/table-action-color.enum.ts","webpack:///packages/common/src/lib/table/table.component.html","webpack:///packages/common/src/lib/table/table.component.ts","webpack:///packages/common/src/lib/table/table.module.ts","webpack:///packages/common/src/lib/action/shared/store.ts","webpack:///packages/common/src/lib/tool/shared/toolbox.enums.ts","webpack:///packages/common/src/lib/tool/toolbox/toolbox.animation.ts","webpack:///packages/common/src/lib/tool/toolbox/toolbox.component.html","webpack:///packages/common/src/lib/tool/toolbox/toolbox.component.ts","webpack:///packages/common/src/lib/tool/toolbox/toolbox.module.ts","webpack:///packages/common/src/lib/tool/tool.module.ts","webpack:///packages/common/src/lib/widget/widget-outlet/widget-outlet.component.html","webpack:///packages/common/src/lib/widget/widget-outlet/widget-outlet.component.ts","webpack:///packages/common/src/lib/widget/widget-outlet/widget-outlet.module.ts","webpack:///packages/common/src/lib/widget/shared/widget.service.ts","webpack:///packages/common/src/lib/widget/widget.module.ts","webpack:///packages/common/src/lib/workspace/workspace-selector/workspace-selector.component.ts","webpack:///packages/common/src/lib/workspace/workspace-selector/workspace-selector.component.html","webpack:///packages/common/src/lib/workspace/workspace-selector/workspace-selector.module.ts","webpack:///packages/common/src/lib/workspace/workspace-widget-outlet/workspace-widget-outlet.component.html","webpack:///packages/common/src/lib/workspace/workspace-widget-outlet/workspace-widget-outlet.component.ts","webpack:///packages/common/src/lib/workspace/workspace-widget-outlet/workspace-widget-outlet.module.ts","webpack:///packages/common/src/lib/workspace/workspace.module.ts","webpack:///packages/common/src/lib/table/table-database.ts","webpack:///packages/common/src/lib/tool/shared/tool-component.ts","webpack:///packages/common/src/lib/workspace/shared/store.ts","webpack:///packages/common/src/lib/workspace/shared/workspace.ts","webpack:///demo/src/app/core/home/home-routing.module.ts","webpack:///demo/src/app/core/home/home.component.ts","webpack:///demo/src/app/core/home/home.component.html","webpack:///demo/src/app/core/home/home.module.ts","webpack:///demo/src/app/core/activity/activity-routing.module.ts","webpack:///demo/src/app/core/activity/activity.component.ts","webpack:///demo/src/app/core/activity/activity.component.html","webpack:///demo/src/app/core/activity/activity.module.ts","webpack:///demo/src/environments/environment.prod.ts","webpack:///demo/src/app/core/config/config-routing.module.ts","webpack:///demo/src/app/core/config/config.component.ts","webpack:///demo/src/app/core/config/config.component.html","webpack:///demo/src/app/core/config/config.module.ts","webpack:///demo/src/app/core/language/language-routing.module.ts","webpack:///demo/src/app/core/language/language.component.ts","webpack:///demo/src/app/core/language/language.component.html","webpack:///demo/src/app/core/language/language.module.ts","webpack:///demo/src/app/core/media/media-routing.module.ts","webpack:///demo/src/app/core/media/media.component.ts","webpack:///demo/src/app/core/media/media.component.html","webpack:///demo/src/app/core/media/media.module.ts","webpack:///demo/src/app/core/message/message-routing.module.ts","webpack:///demo/src/app/core/message/message.component.ts","webpack:///demo/src/app/core/message/message.component.html","webpack:///demo/src/app/core/message/message.module.ts","webpack:///demo/src/app/core/request/request-routing.module.ts","webpack:///demo/src/app/core/request/request.component.ts","webpack:///demo/src/app/core/request/request.component.html","webpack:///demo/src/app/core/request/request.module.ts","webpack:///demo/src/app/common/action/action.component.html","webpack:///demo/src/app/common/action/action-routing.module.ts","webpack:///demo/src/app/common/action/action.component.ts","webpack:///demo/src/app/common/action/action.module.ts","webpack:///demo/src/app/common/dynamic-component/dynamic-component.component.ts","webpack:///demo/src/app/common/dynamic-component/dynamic-component-routing.module.ts","webpack:///demo/src/app/common/dynamic-component/dynamic-component.component.html","webpack:///demo/src/app/common/dynamic-component/dynamic-component.module.ts","webpack:///demo/src/app/common/entity-table/entity-table-routing.module.ts","webpack:///demo/src/app/common/entity-table/entity-table.component.ts","webpack:///demo/src/app/common/entity-table/entity-table.component.html","webpack:///demo/src/app/common/entity-table/entity-table.module.ts","webpack:///demo/src/app/common/entity-selector/entity-selector.component.html","webpack:///demo/src/app/common/entity-selector/entity-selector-routing.module.ts","webpack:///demo/src/app/common/entity-selector/entity-selector.component.ts","webpack:///demo/src/app/common/entity-selector/entity-selector.module.ts","webpack:///demo/src/app/common/form/form.component.html","webpack:///demo/src/app/common/form/form-routing.module.ts","webpack:///demo/src/app/common/form/form.component.ts","webpack:///demo/src/app/common/form/form.module.ts","webpack:///demo/src/app/common/table/table-routing.module.ts","webpack:///demo/src/app/common/table/table.component.ts","webpack:///demo/src/app/common/table/table.component.html","webpack:///demo/src/app/common/table/table.module.ts","webpack:///demo/src/app/common/tool/tool.component.html","webpack:///demo/src/app/common/tool/tool.component.ts","webpack:///demo/src/app/common/tool/tool-routing.module.ts","webpack:///demo/src/app/common/tool/tool.module.ts","webpack:///demo/src/app/common/widget/widget.component.ts","webpack:///demo/src/app/common/widget/widget-routing.module.ts","webpack:///demo/src/app/common/widget/widget.component.html","webpack:///demo/src/app/common/widget/widget.module.ts","webpack:///packages/auth/src/lib/shared/token.service.ts","webpack:///packages/auth/src/lib/shared/auth.service.ts","webpack:///packages/auth/src/lib/auth-form/auth-google.component.ts","webpack:///packages/auth/src/lib/auth-form/auth-google.component.html","webpack:///packages/auth/src/lib/auth-form/auth-microsoft.component.ts","webpack:///packages/auth/src/lib/auth-form/auth-microsoft.component.html","webpack:///packages/auth/src/lib/shared/auth-msalServiceb2c.service..ts","webpack:///packages/auth/src/lib/shared/auth-msalBroadcastServiceb2c.service.ts","webpack:///packages/auth/src/lib/auth-form/auth-microsoftb2c.component.ts","webpack:///packages/auth/src/lib/auth-form/auth-microsoftb2c.component.html","webpack:///packages/auth/src/lib/auth-form/auth-facebook.component.ts","webpack:///packages/auth/src/lib/auth-form/auth-facebook.component.html","webpack:///packages/auth/src/lib/auth-form/auth-intern.component.html","webpack:///packages/auth/src/lib/auth-form/auth-intern.component.ts","webpack:///packages/auth/src/lib/auth-form/auth-form.component.html","webpack:///packages/auth/src/lib/auth-form/auth-form.component.ts","webpack:///packages/auth/src/lib/shared/auth.interceptor.ts","webpack:///packages/auth/src/lib/shared/auth-microsoft.provider.ts","webpack:///packages/auth/src/lib/shared/storage.service.ts","webpack:///packages/auth/src/lib/auth.module.ts","webpack:///demo/src/app/auth/auth-form/auth-form-routing.module.ts","webpack:///demo/src/app/auth/auth-form/auth-form.component.ts","webpack:///demo/src/app/auth/auth-form/auth-form.component.html","webpack:///demo/src/app/auth/auth-form/auth-form.module.ts","webpack:///packages/geo/src/lib/metadata/shared/metadata.service.ts","webpack:///packages/geo/src/lib/metadata/metadata-button/metadata-button.component.html","webpack:///packages/geo/src/lib/metadata/metadata-button/metadata-abstract.component.html","webpack:///packages/geo/src/lib/metadata/metadata-button/metadata-button.component.ts","webpack:///packages/geo/src/lib/metadata/metadata.module.ts","webpack:///packages/geo/src/lib/feature/shared/feature.enums.ts","webpack:///packages/geo/src/lib/layer/utils/image-watcher.ts","webpack:///packages/geo/src/lib/layer/utils/layer.utils.ts","webpack:///packages/geo/src/lib/layer/shared/layers/layer.interface.ts","webpack:///packages/geo/src/lib/utils/id-generator.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/datasource.ts","webpack:///packages/geo/src/lib/filter/shared/ogc-filter.enum.ts","webpack:///packages/geo/src/lib/filter/shared/ogc-filter.ts","webpack:///packages/geo/src/lib/query/shared/query.enums.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/wms-wfs.utils.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/wms-datasource.ts","webpack:///packages/geo/src/lib/layer/utils/layerSync-watcher.ts","webpack:///packages/geo/src/lib/layer/utils/tile-watcher.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/feature-datasource.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/cluster-datasource.ts","webpack:///packages/geo/src/lib/layer/utils/vector-watcher.ts","webpack:///packages/geo/src/lib/map/shared/map.utils.ts","webpack:///packages/geo/src/lib/layer/shared/layers/layer.ts","webpack:///packages/geo/src/lib/layer/shared/layers/vector-layer.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/osm-datasource.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/xyz-datasource.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/wfs-datasource.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/wfs.service.ts","webpack:///packages/geo/src/lib/datasource/utils/tilegrid.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/wmts-datasource.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/carto-datasource.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/arcgisrest-datasource.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/imagearcgisrest-datasource.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/tilearcgisrest-datasource.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/tiledebug-datasource.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/websocket-datasource.ts","webpack:///packages/geo/src/lib/datasource/shared/datasources/mvt-datasource.ts","webpack:///packages/geo/src/lib/datasource/utils/esri-style-generator.ts","webpack:///packages/geo/src/lib/filter/shared/time-filter.enum.ts","webpack:///packages/geo/src/lib/map/shared/map.service.ts","webpack:///packages/geo/src/lib/datasource/shared/capabilities.service.ts","webpack:///packages/geo/src/lib/map/shared/projection.service.ts","webpack:///packages/geo/src/lib/datasource/shared/datasource.service.ts","webpack:///packages/geo/src/lib/feature/shared/feature.utils.ts","webpack:///packages/geo/src/lib/feature/shared/store.ts","webpack:///packages/geo/src/lib/feature/shared/strategies/in-map-extent.ts","webpack:///packages/geo/src/lib/feature/shared/strategies/in-map-resolution.ts","webpack:///packages/geo/src/lib/feature/shared/strategies/loading.ts","webpack:///packages/geo/src/lib/feature/shared/strategies/loading-layer.ts","webpack:///packages/geo/src/lib/feature/shared/strategies/selection.ts","webpack:///packages/geo/src/lib/feature/shared/strategies.utils.ts","webpack:///packages/geo/src/lib/overlay/shared/overlay-marker-style.utils.ts","webpack:///packages/geo/src/lib/layer/shared/style.service.ts","webpack:///packages/geo/src/lib/overlay/shared/overlay.utils.ts","webpack:///packages/geo/src/lib/overlay/shared/overlay.ts","webpack:///packages/geo/src/lib/map/utils/layer-watcher.ts","webpack:///packages/geo/src/lib/map/shared/map.enums.ts","webpack:///packages/geo/src/lib/map/shared/controllers/controller.ts","webpack:///packages/geo/src/lib/map/shared/controllers/view.ts","webpack:///packages/geo/src/lib/map/shared/controllers/geolocation.ts","webpack:///packages/geo/src/lib/map/shared/map.ts","webpack:///packages/geo/src/lib/map/map-browser/map-browser.component.ts","webpack:///packages/geo/src/lib/map/map-browser/map-browser.component.html","webpack:///packages/geo/src/lib/map/shared/map-pointer-position.directive.ts","webpack:///packages/geo/src/lib/layer/shared/layers/image-layer.ts","webpack:///packages/geo/src/lib/layer/shared/layers/tile-layer.ts","webpack:///packages/geo/src/lib/layer/shared/layers/vectortile-layer.ts","webpack:///packages/geo/src/lib/map/shared/hover-feature.directive.ts","webpack:///packages/geo/src/lib/map/zoom-button/zoom-button.component.ts","webpack:///packages/geo/src/lib/map/zoom-button/zoom-button.component.html","webpack:///packages/geo/src/lib/map/geolocate-button/geolocate-button.component.html","webpack:///packages/geo/src/lib/map/geolocate-button/geolocate-button.component.ts","webpack:///packages/geo/src/lib/map/home-extent-button/home-extent-button.component.ts","webpack:///packages/geo/src/lib/map/home-extent-button/home-extent-button.component.html","webpack:///packages/geo/src/lib/map/wake-lock-button/wake-lock-button.component.html","webpack:///packages/geo/src/lib/map/wake-lock-button/wake-lock-button.component.ts","webpack:///packages/geo/src/lib/map/baselayers-switcher/baselayers-switcher.component.html","webpack:///packages/geo/src/lib/map/baselayers-switcher/baselayers-switcher.component.ts","webpack:///packages/geo/src/lib/map/baselayers-switcher/baselayers-switcher.animation.ts","webpack:///packages/geo/src/lib/offline/geoDB/geoDB.service.ts","webpack:///packages/geo/src/lib/offline/shared/geo-network.service.ts","webpack:///packages/geo/src/lib/layer/shared/layer.service.ts","webpack:///packages/geo/src/lib/map/baselayers-switcher/mini-basemap.component.html","webpack:///packages/geo/src/lib/map/baselayers-switcher/mini-basemap.component.ts","webpack:///packages/geo/src/lib/map/rotation-button/rotation-button.component.html","webpack:///packages/geo/src/lib/map/rotation-button/rotation-button.component.ts","webpack:///packages/geo/src/lib/map/info-section/info-section.component.html","webpack:///packages/geo/src/lib/map/info-section/info-section.component.ts","webpack:///packages/geo/src/lib/catalog/shared/catalog.enum.ts","webpack:///packages/geo/src/lib/catalog/shared/catalog.abstract.ts","webpack:///packages/geo/src/lib/query/shared/query.service.ts","webpack:///packages/geo/src/lib/query/shared/query.utils.ts","webpack:///packages/geo/src/lib/query/shared/query.directive.ts","webpack:///packages/geo/src/lib/search/shared/sources/source.ts","webpack:///packages/geo/src/lib/query/shared/query-search-source.ts","webpack:///packages/geo/src/lib/utils/googleLinks.ts","webpack:///packages/geo/src/lib/utils/commonVectorStyle.ts","webpack:///packages/geo/src/lib/utils/osmLinks.ts","webpack:///packages/geo/src/lib/catalog/shared/catalog.service.ts","webpack:///packages/geo/src/lib/catalog/catalog-browser/catalog-browser.component.html","webpack:///packages/geo/src/lib/catalog/catalog-browser/catalog-browser.component.ts","webpack:///packages/geo/src/lib/layer/layer-legend/layer-legend.component.html","webpack:///packages/geo/src/lib/layer/layer-legend/layer-legend.component.ts","webpack:///packages/geo/src/lib/catalog/catalog-browser/catalog-browser-layer.component.html","webpack:///packages/geo/src/lib/catalog/catalog-browser/catalog-browser-layer.component.ts","webpack:///packages/geo/src/lib/catalog/catalog-browser/catalog-browser-group.component.html","webpack:///packages/geo/src/lib/catalog/catalog-browser/catalog-browser-group.component.ts","webpack:///packages/geo/src/lib/layer/layer-list-tool/layer-list-tool.service.ts","webpack:///packages/geo/src/lib/layer/layer-item/layer-item.component.html","webpack:///packages/geo/src/lib/layer/layer-item/layer-item.component.ts","webpack:///packages/geo/src/lib/layer/layer-list/layer-list.enum.ts","webpack:///packages/geo/src/lib/layer/layer-list/layer-list.component.html","webpack:///packages/geo/src/lib/layer/layer-list/layer-list.component.ts","webpack:///packages/geo/src/lib/layer/layer-list-tool/layer-list-tool.component.html","webpack:///packages/geo/src/lib/layer/layer-list-tool/layer-list-tool.component.ts","webpack:///packages/geo/src/lib/layer/layer-list/layer-list-binding.directive.ts","webpack:///packages/geo/src/lib/layer/layer-legend-list/layer-legend-list.component.html","webpack:///packages/geo/src/lib/layer/layer-legend-list/layer-legend-list.component.ts","webpack:///packages/geo/src/lib/layer/track-feature-button/track-feature-button.component.html","webpack:///packages/geo/src/lib/layer/track-feature-button/track-feature-button.component.ts","webpack:///packages/geo/src/lib/layer/layer-legend-item/layer-legend-item.component.ts","webpack:///packages/geo/src/lib/layer/layer-legend-item/layer-legend-item.component.html","webpack:///packages/geo/src/lib/layer/layer.module.ts","webpack:///packages/geo/src/lib/catalog/catalog-browser/catalog-browser.module.ts","webpack:///packages/geo/src/lib/catalog/catalog-library/add-catalog-dialog.component.html","webpack:///packages/geo/src/lib/catalog/catalog-library/add-catalog-dialog.component.ts","webpack:///packages/geo/src/lib/catalog/catalog-library/catalog-library.component.html","webpack:///packages/geo/src/lib/catalog/catalog-library/catalog-library.component.ts","webpack:///packages/geo/src/lib/catalog/catalog-library/catalog-library-item.component.html","webpack:///packages/geo/src/lib/catalog/catalog-library/catalog-library-item.component.ts","webpack:///packages/geo/src/lib/catalog/catalog-library/catalog-library.module.ts","webpack:///packages/geo/src/lib/catalog/catalog.module.ts","webpack:///packages/geo/src/lib/filter/shared/filterable-datasource.pipe.ts","webpack:///packages/geo/src/lib/filter/shared/time-filter.service.ts","webpack:///packages/geo/src/lib/filter/shared/ogc-filter.service.ts","webpack:///packages/geo/src/lib/filter/shared/spatial-filter.enum.ts","webpack:///packages/geo/src/lib/filter/shared/spatial-filter.service.ts","webpack:///packages/geo/src/lib/download/shared/download.service.ts","webpack:///packages/geo/src/lib/download/download-button/download-button.component.html","webpack:///packages/geo/src/lib/download/download-button/download-button.component.ts","webpack:///packages/geo/src/lib/download/download.module.ts","webpack:///packages/geo/src/lib/feature/feature-details/feature-details.component.html","webpack:///packages/geo/src/lib/feature/feature-details/feature-details.component.ts","webpack:///packages/geo/src/lib/draw/shared/draw.enum.ts","webpack:///packages/geo/src/lib/geometry/shared/geometry.utils.ts","webpack:///packages/geo/src/lib/geometry/shared/geometry.errors.ts","webpack:///packages/geo/src/lib/geometry/shared/controls/draw.ts","webpack:///packages/geo/src/lib/draw/draw/draw-popup.component.ts","webpack:///packages/geo/src/lib/draw/draw/draw-popup.component.html","webpack:///packages/geo/src/lib/draw/draw/draw-shorcuts.component.ts","webpack:///packages/geo/src/lib/draw/draw/draw-shorcuts.component.html","webpack:///packages/geo/src/lib/measure/shared/measure.enum.ts","webpack:///packages/geo/src/lib/measure/shared/measure.utils.ts","webpack:///packages/geo/src/lib/draw/shared/draw.utils.ts","webpack:///packages/geo/src/lib/draw/shared/draw-style.service.ts","webpack:///packages/geo/src/lib/draw/shared/draw-icon.service.ts","webpack:///packages/geo/src/lib/draw/draw/draw.component.html","webpack:///packages/geo/src/lib/draw/draw/draw.component.ts","webpack:///packages/geo/src/lib/draw/draw/draw.module.ts","webpack:///packages/geo/src/lib/feature/feature-details/feature-details.module.ts","webpack:///packages/geo/src/lib/feature/feature-form/feature-form.module.ts","webpack:///packages/geo/src/lib/feature/feature.module.ts","webpack:///packages/geo/src/lib/geometry/shared/controls/modify.ts","webpack:///packages/geo/src/lib/layer/shared/layer.enums.ts","webpack:///packages/geo/src/lib/measure/measurer/measurer-dialog.component.html","webpack:///packages/geo/src/lib/measure/measurer/measurer-dialog.component.ts","webpack:///packages/geo/src/lib/measure/measurer/measurer.component.html","webpack:///packages/geo/src/lib/measure/measurer/measurer.component.ts","webpack:///packages/geo/src/lib/measure/measurer/measure-format.pipe.ts","webpack:///packages/geo/src/lib/geometry/geometry-form-field/geometry-form-field-input.component.ts","webpack:///packages/geo/src/lib/geometry/geometry-form-field/geometry-form-field-input.component.html","webpack:///packages/geo/src/lib/geometry/geometry-form-field/geometry-form-field.module.ts","webpack:///packages/geo/src/lib/geometry/geometry.module.ts","webpack:///packages/geo/src/lib/filter/time-filter-button/time-filter-button.component.html","webpack:///packages/geo/src/lib/filter/time-filter-button/time-filter-button.component.ts","webpack:///packages/geo/src/lib/filter/time-filter-form/time-filter-form.component.html","webpack:///packages/geo/src/lib/filter/time-filter-form/time-filter-form.component.ts","webpack:///packages/geo/src/lib/filter/time-filter-item/time-filter-item.component.html","webpack:///packages/geo/src/lib/filter/time-filter-item/time-filter-item.component.ts","webpack:///packages/geo/src/lib/filter/time-filter-list/time-filter-list.component.html","webpack:///packages/geo/src/lib/filter/time-filter-list/time-filter-list.component.ts","webpack:///packages/geo/src/lib/wkt/shared/wkt.service.ts","webpack:///packages/geo/src/lib/filter/ogc-filter-form/ogc-filter-form.component.html","webpack:///packages/geo/src/lib/filter/ogc-filter-form/ogc-filter-form.component.ts","webpack:///packages/geo/src/lib/filter/ogc-filterable-form/ogc-filterable-form.component.html","webpack:///packages/geo/src/lib/filter/ogc-filterable-form/ogc-filterable-form.component.ts","webpack:///packages/geo/src/lib/filter/ogc-filterable-item/ogc-filterable-item.component.html","webpack:///packages/geo/src/lib/filter/ogc-filterable-item/ogc-filterable-item.component.ts","webpack:///packages/geo/src/lib/filter/ogc-filterable-list/ogc-filterable-list.component.html","webpack:///packages/geo/src/lib/filter/ogc-filterable-list/ogc-filterable-list.component.ts","webpack:///packages/geo/src/lib/filter/ogc-filter-button/ogc-filter-button.component.html","webpack:///packages/geo/src/lib/filter/ogc-filter-button/ogc-filter-button.component.ts","webpack:///packages/geo/src/lib/filter/shared/ogc-filter-time.service.ts","webpack:///packages/geo/src/lib/filter/ogc-filter-selection/ogc-filter-selection.component.html","webpack:///packages/geo/src/lib/filter/ogc-filter-selection/ogc-filter-selection.component.ts","webpack:///packages/geo/src/lib/filter/spatial-filter/spatial-filter-type/spatial-filter-type.component.html","webpack:///packages/geo/src/lib/filter/spatial-filter/spatial-filter-type/spatial-filter-type.component.ts","webpack:///packages/geo/src/lib/filter/spatial-filter/spatial-filter-list/spatial-filter-list.component.html","webpack:///packages/geo/src/lib/filter/spatial-filter/spatial-filter-list/spatial-filter-list.component.ts","webpack:///packages/geo/src/lib/filter/spatial-filter/spatial-filter-item/spatial-filter-item.component.html","webpack:///packages/geo/src/lib/filter/spatial-filter/spatial-filter-item/spatial-filter-item.component.ts","webpack:///packages/geo/src/lib/filter/ogc-filter-time/ogc-filter-time.component.html","webpack:///packages/geo/src/lib/filter/ogc-filter-time/ogc-filter-time.component.ts","webpack:///packages/geo/src/lib/filter/ogc-filter-time/ogc-filter-time-slider.component.ts","webpack:///packages/geo/src/lib/filter/ogc-filter-time/ogc-filter-time-slider.component.html","webpack:///packages/geo/src/lib/filter/filter.module.ts","webpack:///packages/geo/src/lib/import-export/shared/export.errors.ts","webpack:///packages/geo/src/lib/import-export/shared/export.type.ts","webpack:///packages/geo/src/lib/import-export/shared/export.service.ts","webpack:///packages/utils/src/lib/file.ts","webpack:///packages/geo/src/lib/import-export/shared/import.utils.ts","webpack:///packages/geo/src/lib/import-export/shared/import.errors.ts","webpack:///packages/geo/src/lib/import-export/shared/import.service.ts","webpack:///packages/geo/src/lib/import-export/style-list/style-list.service.ts","webpack:///packages/geo/src/lib/import-export/import-export/import-export.component.html","webpack:///packages/geo/src/lib/import-export/import-export/import-export.component.ts","webpack:///packages/geo/src/lib/map/shared/projection.utils.ts","webpack:///packages/geo/src/lib/import-export/shared/export.utils.ts","webpack:///packages/geo/src/lib/import-export/style-list/style-list.provider.ts","webpack:///packages/geo/src/lib/import-export/style-list/style-list.module.ts","webpack:///packages/geo/src/lib/import-export/import-export.module.ts","webpack:///packages/geo/src/lib/map/map.module.ts","webpack:///packages/geo/src/lib/measure/measurer/measurer-item.component.html","webpack:///packages/geo/src/lib/measure/measurer/measurer-item.component.ts","webpack:///packages/geo/src/lib/measure/measurer/measurer.module.ts","webpack:///packages/geo/src/lib/measure/measure.module.ts","webpack:///packages/geo/src/lib/overlay/shared/overlay.enum.ts","webpack:///packages/geo/src/lib/overlay/shared/overlay.service.ts","webpack:///packages/geo/src/lib/overlay/shared/overlay.directive.ts","webpack:///packages/geo/src/lib/overlay/overlay.module.ts","webpack:///packages/geo/src/lib/print/shared/print.service.ts","webpack:///packages/geo/src/lib/layer/utils/outputLegend.ts","webpack:///packages/geo/src/lib/print/shared/print.type.ts","webpack:///packages/geo/src/lib/print/print-form/print-form.component.html","webpack:///packages/geo/src/lib/print/print-form/print-form.component.ts","webpack:///packages/geo/src/lib/print/print/print.component.ts","webpack:///packages/geo/src/lib/print/print/print.component.html","webpack:///packages/geo/src/lib/print/print.module.ts","webpack:///packages/geo/src/lib/query/shared/query-search-source.providers.ts","webpack:///packages/geo/src/lib/query/query.module.ts","webpack:///packages/geo/src/lib/directions/shared/directions-source.service.ts","webpack:///packages/geo/src/lib/directions/shared/directions.enum.ts","webpack:///packages/geo/src/lib/directions/shared/directions.utils.ts","webpack:///packages/geo/src/lib/directions/directions-inputs/directions-inputs.component.html","webpack:///packages/geo/src/lib/directions/directions-inputs/directions-inputs.component.ts","webpack:///packages/geo/src/lib/directions/shared/directions.service.ts","webpack:///packages/geo/src/lib/search/shared/search.utils.ts","webpack:///packages/geo/src/lib/search/shared/search-source.service.ts","webpack:///packages/geo/src/lib/search/shared/search.service.ts","webpack:///packages/geo/src/lib/directions/directions-buttons/directions-buttons.component.html","webpack:///packages/geo/src/lib/directions/directions-buttons/directions-buttons.component.ts","webpack:///packages/geo/src/lib/directions/directions-results/directions-results.component.html","webpack:///packages/geo/src/lib/directions/directions-results/directions-results.component.ts","webpack:///packages/geo/src/lib/directions/directions.component.ts","webpack:///packages/geo/src/lib/directions/directions.component.html","webpack:///packages/geo/src/lib/directions/directions.module.ts","webpack:///packages/geo/src/lib/search/shared/search-source-service.providers.ts","webpack:///packages/geo/src/lib/search/shared/sources/icherche.ts","webpack:///packages/geo/src/lib/search/shared/sources/icherche.providers.ts","webpack:///packages/geo/src/lib/search/shared/sources/coordinates.ts","webpack:///packages/geo/src/lib/search/shared/sources/coordinates.providers.ts","webpack:///packages/geo/src/lib/search/shared/sources/ilayer.ts","webpack:///packages/geo/src/lib/search/shared/sources/ilayer.providers.ts","webpack:///packages/geo/src/lib/search/shared/search.enums.ts","webpack:///packages/geo/src/lib/search/search-selector/search-selector.component.html","webpack:///packages/geo/src/lib/search/search-selector/search-selector.component.ts","webpack:///packages/geo/src/lib/search/search-selector/search-selector.module.ts","webpack:///packages/geo/src/lib/search/search-settings/search-settings.component.html","webpack:///packages/geo/src/lib/search/search-settings/search-settings.component.ts","webpack:///packages/geo/src/lib/search/search-settings/search-settings.module.ts","webpack:///packages/geo/src/lib/search/search-bar/search-bar.component.html","webpack:///packages/geo/src/lib/search/search-bar/search-bar.component.ts","webpack:///packages/geo/src/lib/search/search-bar/search-bar.module.ts","webpack:///packages/geo/src/lib/search/search-results/search-results-item.component.html","webpack:///packages/geo/src/lib/search/search-results/search-results-item.component.ts","webpack:///packages/geo/src/lib/search/search-results/search-results.component.html","webpack:///packages/geo/src/lib/search/search-results/search-results.component.ts","webpack:///packages/geo/src/lib/search/search-results/search-results-add-button.component.html","webpack:///packages/geo/src/lib/search/search-results/search-results-add-button.component.ts","webpack:///packages/geo/src/lib/search/search-results/search-results.module.ts","webpack:///packages/geo/src/lib/search/shared/search-pointer-summary.directive.ts","webpack:///packages/geo/src/lib/search/search.module.ts","webpack:///packages/geo/src/lib/workspace/widgets/ogc-filter/ogc-filter.component.ts","webpack:///packages/geo/src/lib/workspace/widgets/ogc-filter/ogc-filter.component.html","webpack:///packages/geo/src/lib/workspace/widgets/widgets.ts","webpack:///packages/geo/src/lib/workspace/widgets/ogc-filter/ogc-filter.module.ts","webpack:///packages/geo/src/lib/workspace/shared/wfs-workspace.ts","webpack:///packages/geo/src/lib/workspace/shared/wfs-workspace.service.ts","webpack:///packages/geo/src/lib/workspace/shared/wms-workspace.service.ts","webpack:///packages/geo/src/lib/workspace/confirmation-popup/confirmation-popup.component.ts","webpack:///packages/geo/src/lib/workspace/confirmation-popup/confirmation-popup.component.html","webpack:///packages/geo/src/lib/workspace/shared/edition-workspace.ts","webpack:///packages/geo/src/lib/workspace/shared/edition-workspace.service.ts","webpack:///packages/geo/src/lib/workspace/shared/feature-workspace.ts","webpack:///packages/geo/src/lib/workspace/shared/feature-workspace.service.ts","webpack:///packages/geo/src/lib/workspace/workspace-selector/workspace-selector.directive.ts","webpack:///packages/geo/src/lib/workspace/workspace-selector/workspace-selector.module.ts","webpack:///packages/geo/src/lib/workspace/workspace-updator/workspace-updator.module.ts","webpack:///packages/geo/src/lib/workspace/confirmation-popup/confirmation-popup.module.ts","webpack:///packages/geo/src/lib/workspace/workspace.module.ts","webpack:///packages/geo/src/lib/directions/shared/store.ts","webpack:///packages/geo/src/lib/directions/directions-sources/osrm-directions-source.ts","webpack:///packages/geo/src/lib/directions/directions-sources/directions-source.provider.ts","webpack:///packages/geo/src/lib/search/shared/sources/cadastre.ts","webpack:///packages/geo/src/lib/search/shared/sources/cadastre.providers.ts","webpack:///packages/geo/src/lib/search/shared/sources/nominatim.ts","webpack:///packages/geo/src/lib/search/shared/sources/nominatim.providers.ts","webpack:///packages/geo/src/lib/search/shared/sources/storedqueries.ts","webpack:///packages/geo/src/lib/search/shared/sources/storedqueries.providers.ts","webpack:///packages/geo/src/lib/workspace/shared/workspace.utils.ts","webpack:///demo/src/app/geo/simple-map/simple-map.component.html","webpack:///demo/src/app/geo/simple-map/simple-map-routing.module.ts","webpack:///demo/src/app/geo/simple-map/simple-map.component.ts","webpack:///demo/src/app/geo/simple-map/simple-map.module.ts","webpack:///demo/src/app/geo/layer/layer.component.html","webpack:///demo/src/app/geo/layer/layer-routing.module.ts","webpack:///demo/src/app/geo/layer/layer.component.ts","webpack:///demo/src/app/geo/layer/layer.module.ts","webpack:///demo/src/app/geo/legend/legend-routing.module.ts","webpack:///demo/src/app/geo/legend/legend.component.ts","webpack:///demo/src/app/geo/legend/legend.component.html","webpack:///demo/src/app/geo/legend/legend.module.ts","webpack:///demo/src/app/geo/overlay/overlay-routing.module.ts","webpack:///demo/src/app/geo/overlay/overlay.component.ts","webpack:///demo/src/app/geo/overlay/overlay.component.html","webpack:///demo/src/app/geo/overlay/overlay.module.ts","webpack:///demo/src/app/geo/geometry/geometry.component.html","webpack:///demo/src/app/geo/geometry/geometry-routing.module.ts","webpack:///demo/src/app/geo/geometry/geometry.component.ts","webpack:///demo/src/app/geo/geometry/geometry.module.ts","webpack:///demo/src/app/geo/feature/feature-routing.module.ts","webpack:///demo/src/app/geo/feature/feature.component.ts","webpack:///demo/src/app/geo/feature/feature.component.html","webpack:///demo/src/app/geo/feature/feature.module.ts","webpack:///demo/src/app/geo/hover/hover-routing.module.ts","webpack:///demo/src/app/geo/hover/hover.component.ts","webpack:///demo/src/app/geo/hover/hover.component.html","webpack:///demo/src/app/geo/hover/hover.module.ts","webpack:///demo/src/app/geo/measure/measure-routing.module.ts","webpack:///demo/src/app/geo/measure/measure.component.ts","webpack:///demo/src/app/geo/measure/measure.component.html","webpack:///demo/src/app/geo/measure/measure.module.ts","webpack:///demo/src/app/geo/draw/draw-routing.module.ts","webpack:///demo/src/app/geo/draw/draw.component.ts","webpack:///demo/src/app/geo/draw/draw.component.html","webpack:///demo/src/app/geo/draw/draw.module.ts","webpack:///demo/src/app/geo/query/query.component.html","webpack:///demo/src/app/geo/query/query-routing.module.ts","webpack:///demo/src/app/geo/query/query.component.ts","webpack:///demo/src/app/geo/query/query.module.ts","webpack:///demo/src/app/geo/catalog/catalog-routing.module.ts","webpack:///demo/src/app/geo/catalog/catalog.component.ts","webpack:///demo/src/app/geo/catalog/catalog.component.html","webpack:///demo/src/app/geo/catalog/catalog.module.ts","webpack:///packages/context/src/lib/context-import-export/shared/context-export.errors.ts","webpack:///packages/context/src/lib/context-import-export/shared/context-import.errors.ts","webpack:///packages/context/src/lib/context-manager/shared/context.enum.ts","webpack:///packages/context/src/lib/context-manager/shared/context.service.ts","webpack:///packages/context/src/lib/context-import-export/context-import-export.module.ts","webpack:///packages/context/src/lib/context-manager/shared/map-context.directive.ts","webpack:///packages/context/src/lib/context-manager/shared/layer-context.directive.ts","webpack:///packages/context/src/lib/context-import-export/shared/context-import.utils.ts","webpack:///packages/context/src/lib/context-manager/context-list/context-list.enum.ts","webpack:///packages/context/src/lib/context-map-button/bookmark-button/bookmark-dialog.component.ts","webpack:///packages/context/src/lib/context-map-button/bookmark-button/bookmark-dialog.component.html","webpack:///packages/context/src/lib/context-manager/context-item/context-item.component.html","webpack:///packages/context/src/lib/context-manager/context-item/context-item.component.ts","webpack:///packages/context/src/lib/context-manager/context-list/context-list.component.html","webpack:///packages/context/src/lib/context-manager/context-list/context-list.component.ts","webpack:///packages/context/src/lib/context-manager/context-list/context-list-binding.directive.ts","webpack:///packages/context/src/lib/context-map-button/poi-button/shared/poi.service.ts","webpack:///packages/context/src/lib/context-map-button/context-map-button.module.ts","webpack:///packages/context/src/lib/context-manager/context-manager.module.ts","webpack:///packages/integration/src/lib/import-export/import-export.state.ts","webpack:///packages/integration/src/lib/tool/tool.state.ts","webpack:///packages/integration/src/lib/workspace/shared/workspace.utils.ts","webpack:///packages/integration/src/lib/storage/storage.state.ts","webpack:///packages/integration/src/lib/workspace/shared/feature-actions.service.ts","webpack:///packages/integration/src/lib/workspace/shared/wfs-actions.service.ts","webpack:///packages/integration/src/lib/workspace/shared/edition-actions.service.ts","webpack:///packages/integration/src/lib/workspace/workspace.state.ts","webpack:///packages/integration/src/lib/search/search.state.ts","webpack:///packages/integration/src/lib/search/search-bar/search-bar.module.ts","webpack:///packages/integration/src/lib/search/search-results-tool/search-results-tool.module.ts","webpack:///packages/integration/src/lib/search/search.module.ts","webpack:///demo/src/app/geo/search/search.component.html","webpack:///demo/src/app/geo/search/search-routing.module.ts","webpack:///demo/src/app/geo/search/search.component.ts","webpack:///demo/src/app/geo/search/search.module.ts","webpack:///demo/src/app/geo/print/print-routing.module.ts","webpack:///demo/src/app/geo/print/print.component.ts","webpack:///demo/src/app/geo/print/print.component.html","webpack:///demo/src/app/geo/print/print.module.ts","webpack:///demo/src/app/geo/import-export/import-export-routing.module.ts","webpack:///demo/src/app/geo/import-export/import-export.component.ts","webpack:///demo/src/app/geo/import-export/import-export.component.html","webpack:///demo/src/app/geo/import-export/import-export.module.ts","webpack:///demo/src/app/geo/directions/directions-routing.module.ts","webpack:///demo/src/app/geo/directions/directions.component.ts","webpack:///demo/src/app/geo/directions/directions.component.html","webpack:///demo/src/app/geo/directions/directions.module.ts","webpack:///demo/src/app/geo/time-filter/time-filter-routing.module.ts","webpack:///demo/src/app/geo/time-filter/time-filter.component.ts","webpack:///demo/src/app/geo/time-filter/time-filter.component.html","webpack:///demo/src/app/geo/time-filter/time-filter.module.ts","webpack:///demo/src/app/geo/ogc-filter/ogc-filter-routing.module.ts","webpack:///demo/src/app/geo/ogc-filter/ogc-filter.component.ts","webpack:///demo/src/app/geo/ogc-filter/ogc-filter.component.html","webpack:///demo/src/app/geo/ogc-filter/ogc-filter.module.ts","webpack:///demo/src/app/geo/spatial-filter/spatial-filter.component.html","webpack:///demo/src/app/geo/spatial-filter/spatial-filter-routing.module.ts","webpack:///demo/src/app/geo/spatial-filter/spatial-filter.component.ts","webpack:///demo/src/app/geo/spatial-filter/spatial-filter.module.ts","webpack:///demo/src/app/geo/workspace/workspace.component.html","webpack:///demo/src/app/geo/workspace/workspace-routing.module.ts","webpack:///demo/src/app/geo/workspace/workspace.component.ts","webpack:///demo/src/app/geo/workspace/workspace.module.ts","webpack:///demo/src/app/context/context/context.component.html","webpack:///demo/src/app/context/context/context-routing.module.ts","webpack:///demo/src/app/context/context/context.component.ts","webpack:///demo/src/app/context/context/context.module.ts","webpack:///demo/src/app/app-routing.module.ts","webpack:///demo/src/app/app.component.ts","webpack:///demo/src/app/app.component.html","webpack:///demo/src/app/app.module.ts","webpack:///demo/src/main.ts","webpack:///node_modules/moment/locale|sync|/^/.*$"],"sourcesContent":["function webpackEmptyAsyncContext(req) {\n\t// Here Promise.resolve().then() is used instead of new Promise() to prevent\n\t// uncaught exception popping up in devtools\n\treturn Promise.resolve().then(function() {\n\t\tvar e = new Error(\"Cannot find module '\" + req + \"'\");\n\t\te.code = 'MODULE_NOT_FOUND';\n\t\tthrow e;\n\t});\n}\nwebpackEmptyAsyncContext.keys = function() { return []; };\nwebpackEmptyAsyncContext.resolve = webpackEmptyAsyncContext;\nwebpackEmptyAsyncContext.id = 98255;\nmodule.exports = webpackEmptyAsyncContext;","var map = {\n\t\"./en.auth.json\": 50257,\n\t\"./en.common.json\": 35488,\n\t\"./en.context.json\": 88952,\n\t\"./en.core.json\": 63154,\n\t\"./en.geo.json\": 10711,\n\t\"./en.integration.json\": 32766,\n\t\"./en.json\": 10503,\n\t\"./fr.auth.json\": 8555,\n\t\"./fr.common.json\": 20551,\n\t\"./fr.context.json\": 68079,\n\t\"./fr.core.json\": 5415,\n\t\"./fr.geo.json\": 27268,\n\t\"./fr.integration.json\": 63031,\n\t\"./fr.json\": 65962\n};\n\n\nfunction webpackContext(req) {\n\tvar id = webpackContextResolve(req);\n\treturn __webpack_require__(id);\n}\nfunction webpackContextResolve(req) {\n\tif(!__webpack_require__.o(map, req)) {\n\t\tvar e = new Error(\"Cannot find module '\" + req + \"'\");\n\t\te.code = 'MODULE_NOT_FOUND';\n\t\tthrow e;\n\t}\n\treturn map[req];\n}\nwebpackContext.keys = function webpackContextKeys() {\n\treturn Object.keys(map);\n};\nwebpackContext.resolve = webpackContextResolve;\nmodule.exports = webpackContext;\nwebpackContext.id = 36438;","/* eslint-disable */\r\n\r\nconst ALPHA =\r\n  'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';\r\n\r\nexport class Base64 {\r\n  private static PADCHAR: string = '=';\r\n  private static ALPHA: string = ALPHA;\r\n\r\n  private static getByte(s: string, i: number): number {\r\n    const x = s.charCodeAt(i);\r\n    return x;\r\n  }\r\n\r\n  private static getByte64(s: string, i: number): number {\r\n    const idx = this.ALPHA.indexOf(s.charAt(i));\r\n    return idx;\r\n  }\r\n\r\n  public static decode(s: string): string {\r\n    let pads = 0,\r\n      i,\r\n      b10,\r\n      imax = s.length,\r\n      x = [];\r\n\r\n    s = String(s);\r\n\r\n    if (imax === 0) {\r\n      return s;\r\n    }\r\n\r\n    if (s.charAt(imax - 1) === this.PADCHAR) {\r\n      pads = 1;\r\n      if (s.charAt(imax - 2) === this.PADCHAR) {\r\n        pads = 2;\r\n      }\r\n      imax -= 4;\r\n    }\r\n\r\n    for (i = 0; i < imax; i += 4) {\r\n      b10 =\r\n        (this.getByte64(s, i) << 18) |\r\n        (this.getByte64(s, i + 1) << 12) |\r\n        (this.getByte64(s, i + 2) << 6) |\r\n        this.getByte64(s, i + 3);\r\n      x.push(String.fromCharCode(b10 >> 16, (b10 >> 8) & 255, b10 & 255));\r\n    }\r\n\r\n    switch (pads) {\r\n      case 1:\r\n        b10 =\r\n          (this.getByte64(s, i) << 18) |\r\n          (this.getByte64(s, i + 1) << 12) |\r\n          (this.getByte64(s, i + 2) << 6);\r\n        x.push(String.fromCharCode(b10 >> 16, (b10 >> 8) & 255));\r\n        break;\r\n      case 2:\r\n        b10 = (this.getByte64(s, i) << 18) | (this.getByte64(s, i + 1) << 12);\r\n        x.push(String.fromCharCode(b10 >> 16));\r\n        break;\r\n    }\r\n\r\n    return x.join('');\r\n  }\r\n\r\n  public static encode(s: string): string {\r\n    s = String(s);\r\n\r\n    let i,\r\n      b10,\r\n      x = [],\r\n      imax = s.length - s.length % 3;\r\n\r\n    if (s.length === 0) {\r\n      return s;\r\n    }\r\n\r\n    for (i = 0; i < imax; i += 3) {\r\n      b10 =\r\n        (this.getByte(s, i) << 16) |\r\n        (this.getByte(s, i + 1) << 8) |\r\n        this.getByte(s, i + 2);\r\n      x.push(this.ALPHA.charAt(b10 >> 18));\r\n      x.push(this.ALPHA.charAt((b10 >> 12) & 63));\r\n      x.push(this.ALPHA.charAt((b10 >> 6) & 63));\r\n      x.push(this.ALPHA.charAt(b10 & 63));\r\n    }\r\n\r\n    switch (s.length - imax) {\r\n      case 1:\r\n        b10 = this.getByte(s, i) << 16;\r\n        x.push(\r\n          this.ALPHA.charAt(b10 >> 18) +\r\n            this.ALPHA.charAt((b10 >> 12) & 63) +\r\n            this.PADCHAR +\r\n            this.PADCHAR\r\n        );\r\n        break;\r\n      case 2:\r\n        b10 = (this.getByte(s, i) << 16) | (this.getByte(s, i + 1) << 8);\r\n        x.push(\r\n          this.ALPHA.charAt(b10 >> 18) +\r\n            this.ALPHA.charAt((b10 >> 12) & 63) +\r\n            this.ALPHA.charAt((b10 >> 6) & 63) +\r\n            this.PADCHAR\r\n        );\r\n        break;\r\n    }\r\n\r\n    return x.join('');\r\n  }\r\n}\r\n","import * as Bowser from 'bowser';\r\n\r\nexport interface UserAgent extends Bowser.Parser.Parser {\r\n  compareVersion: (version: string) => boolean;\r\n}\r\n\r\nexport const userAgent = Bowser.getParser(\r\n  window.navigator.userAgent\r\n) as UserAgent;\r\n","import { userAgent } from './user-agent';\r\n\r\nexport class Clipboard {\r\n  static copy(element: HTMLTextAreaElement | string): boolean {\r\n    let successful = false;\r\n    if (typeof element === 'string') {\r\n      const textArea = Clipboard.createTextArea(element);\r\n      Clipboard.selectText(textArea);\r\n      successful = Clipboard.copyTextToClipboard();\r\n      Clipboard.destroyTextArea(textArea);\r\n    } else {\r\n      Clipboard.selectText(element);\r\n      successful = Clipboard.copyTextToClipboard();\r\n    }\r\n    return successful;\r\n  }\r\n\r\n  private static createTextArea(text: string): HTMLTextAreaElement {\r\n    const textArea = document.createElement('textArea') as HTMLTextAreaElement;\r\n    textArea.value = text;\r\n    document.body.appendChild(textArea);\r\n    return textArea;\r\n  }\r\n\r\n  private static destroyTextArea(textArea) {\r\n    document.body.removeChild(textArea);\r\n  }\r\n\r\n  private static selectText(textArea) {\r\n    if (userAgent.getOSName() === 'iOS') {\r\n      const oldContentEditable = textArea.contentEditable;\r\n      const oldReadOnly = textArea.readOnly;\r\n      const range = document.createRange();\r\n      const selection = window.getSelection();\r\n\r\n      textArea.contenteditable = true;\r\n      textArea.readonly = false;\r\n      range.selectNodeContents(textArea);\r\n      selection.removeAllRanges();\r\n      selection.addRange(range);\r\n      textArea.setSelectionRange(0, 999999);\r\n      textArea.contentEditable = oldContentEditable;\r\n      textArea.readOnly = oldReadOnly;\r\n    } else {\r\n      textArea.select();\r\n    }\r\n  }\r\n\r\n  private static copyTextToClipboard(): boolean {\r\n    if (!(userAgent.getOSName() === 'iOS' && userAgent.compareVersion('<10'))) {\r\n      return document.execCommand('copy');\r\n    }\r\n    return false;\r\n  }\r\n}\r\n","export class StringUtils {\r\n  static diff(s1: string, s2: string, p = 4): string {\r\n    if (!s1 && !s2) {\r\n      return '';\r\n    }\r\n    if (!s1) {\r\n      return '<span class=\"inserted\">' + s2 + '</span>';\r\n    }\r\n    if (!s2) {\r\n      return '<span class=\"deleted\">' + s1 + '</span>';\r\n    }\r\n    s1 = s1.toString();\r\n    s2 = s2.toString();\r\n    const changeData = StringUtils.getChanges(s1, s2, '', p);\r\n    const nextS = s2.slice(\r\n      changeData.mtc.length + changeData.ins.length + changeData.sbs.length\r\n    ); // remaining part of \"s\"\r\n    const nextThis = s1.slice(\r\n      changeData.mtc.length + changeData.del.length + changeData.sbs.length\r\n    ); // remaining part of \"this\"\r\n    let result = ''; // the glorious result\r\n    if (changeData.del.length > 0) {\r\n      changeData.del = '<span class=\"deleted\">' + changeData.del + '</span>';\r\n    }\r\n    if (changeData.ins.length > 0) {\r\n      changeData.ins = '<span class=\"inserted\">' + changeData.ins + '</span>';\r\n    }\r\n    result = changeData.mtc + changeData.del + changeData.ins + changeData.sbs;\r\n    result +=\r\n      nextThis !== '' || nextS !== ''\r\n        ? StringUtils.diff(nextThis, nextS, p)\r\n        : '';\r\n    return result;\r\n  }\r\n\r\n  private static getMatchingSubstring(s, l, m) {\r\n    // returns the first matching substring in-between the two strings\r\n    let i = 0;\r\n    let match = false;\r\n    const slen = s.length;\r\n    const o = { fis: slen, mtc: m, sbs: '' }; // temporary object used to construct the cd (change data) object\r\n\r\n    while (i < slen) {\r\n      l[i] === s[i]\r\n        ? match\r\n          ? (o.sbs += s[i]) // o.sbs holds the matching substring itsef\r\n          : ((match = true), (o.fis = i), (o.sbs = s[i]))\r\n        : match\r\n          ? (i = slen) // stop after the first found substring\r\n          : (i = i);\r\n      ++i;\r\n    }\r\n    return o;\r\n  }\r\n\r\n  private static getChanges(s1, s2, m, p) {\r\n    const isThisLonger = s1.length >= s1.length ? true : false;\r\n    let [longer, shorter] = isThisLonger ? [s1, s2] : [s2, s1]; // assignment of longer and shorter by es6 destructuring\r\n    let bi = 0; // base index designating the index of first mismacthing character in both strings\r\n\r\n    while (shorter[bi] === longer[bi] && bi < shorter.length) {\r\n      ++bi;\r\n    } // make bi the index of first mismatching character\r\n    longer = longer.split('').slice(bi); // as the longer string will be rotated it is converted into array\r\n    shorter = shorter.slice(bi); // shorter and longer now starts from the first mismatching character\r\n\r\n    const len = longer.length; // length of the longer string\r\n    let cd: any = {\r\n      fis: shorter.length, // the index of matching string in the shorter string\r\n      fil: len, // the index of matching string in the longer string\r\n      sbs: '', // the matching substring itself\r\n      mtc: m + s2.slice(0, bi)\r\n    }; // if exists mtc holds the matching string at the front\r\n    let sub: any = { sbs: '' }; // returned substring per 1 character rotation of the longer string\r\n\r\n    if (shorter !== '') {\r\n      for (let rc = 0; rc < len && sub.sbs.length < p; rc++) {\r\n        // rc -> rotate count, p -> precision factor\r\n        sub = StringUtils.getMatchingSubstring(\r\n          shorter,\r\n          StringUtils.rotateArray(longer, rc),\r\n          cd.mtc\r\n        ); // rotate longer string 1 char and get substring\r\n        sub.fil =\r\n          rc < len - sub.fis\r\n            ? sub.fis + rc // mismatch is longer than the mismatch in short\r\n            : sub.fis - len + rc; // mismatch is shorter than the mismatch in short\r\n        if (sub.sbs.length > cd.sbs.length) {\r\n          cd = sub; // only keep the one with the longest substring.\r\n        }\r\n      }\r\n    }\r\n    // insert the mismatching delete subsrt and insert substr to the cd object and attach the previous substring\r\n    [cd.del, cd.ins] = isThisLonger\r\n      ? [longer.slice(0, cd.fil).join(''), shorter.slice(0, cd.fis)]\r\n      : [shorter.slice(0, cd.fis), longer.slice(0, cd.fil).join('')];\r\n    return cd.del.indexOf(' ') === -1 ||\r\n      cd.ins.indexOf(' ') === -1 ||\r\n      cd.del === '' ||\r\n      cd.ins === '' ||\r\n      cd.sbs === ''\r\n      ? cd\r\n      : StringUtils.getChanges(cd.del, cd.ins, cd.mtc, p);\r\n  }\r\n\r\n  private static rotateArray(array, n) {\r\n    const len = array.length;\r\n    const res = new Array(array.length);\r\n    if (n % len === 0) {\r\n      return array.slice();\r\n    } else {\r\n      for (let i = 0; i < len; i++) {\r\n        res[i] = array[(i + (len + (n % len))) % len];\r\n      }\r\n    }\r\n    return res;\r\n  }\r\n}\r\n","export enum ChangeType {\r\n  ADDED = 'added',\r\n  DELETED = 'deleted',\r\n  MODIFIED = 'modified'\r\n}\r\n\r\nexport interface Change {\r\n  type: ChangeType;\r\n  keysChanged?: {\r\n    key: string;\r\n    newValue: any;\r\n    oldValue: any;\r\n  }[];\r\n}\r\n\r\nexport interface GroupingChanges {\r\n  added: ChangeItem[];\r\n  deleted: ChangeItem[];\r\n  modified: ChangeItem[];\r\n}\r\n\r\nexport interface ChangeItem {\r\n  change: Change;\r\n  value: any;\r\n  oldValue?: any;\r\n  newValue?: any;\r\n}\r\n","import { StringUtils } from './string-utils';\r\nimport { GroupingChanges, ChangeType } from './change.interface';\r\n\r\nexport class ChangeUtils {\r\n  static findChanges(\r\n    obj1: any[],\r\n    obj2: any[],\r\n    ignoreKeys: string[] = []\r\n  ): GroupingChanges {\r\n    const items: GroupingChanges = {\r\n      added: [],\r\n      deleted: [],\r\n      modified: []\r\n    };\r\n\r\n    if (!obj1 || !obj2) {\r\n      return items;\r\n    }\r\n\r\n    const obj1Clone: any = [...obj1];\r\n    const obj2Clone: any = [...obj2];\r\n\r\n    for (const fromItem of obj1Clone) {\r\n      const index = obj2Clone.findIndex(s => s.id === fromItem.id);\r\n\r\n      if (index === -1) {\r\n        items.deleted.push({\r\n          change: { type: ChangeType.DELETED },\r\n          value: fromItem\r\n        });\r\n        continue;\r\n      }\r\n\r\n      const toItem = obj2Clone.splice(index, 1)[0];\r\n      const fromItemClone = JSON.parse(JSON.stringify(fromItem));\r\n      const toItemClone = JSON.parse(JSON.stringify(toItem));\r\n\r\n      const keysChanged = ChangeUtils.compareObject(\r\n        fromItemClone,\r\n        toItemClone,\r\n        undefined,\r\n        ignoreKeys\r\n      );\r\n\r\n      if (keysChanged.length) {\r\n        items.modified.push({\r\n          change: {\r\n            type: ChangeType.MODIFIED,\r\n            keysChanged\r\n          },\r\n          value: fromItemClone,\r\n          oldValue: fromItem,\r\n          newValue: toItem\r\n        });\r\n      }\r\n    }\r\n\r\n    items.added = obj2Clone.map(itemAdded => {\r\n      return {\r\n        change: { type: ChangeType.ADDED },\r\n        value: itemAdded\r\n      };\r\n    });\r\n\r\n    return items;\r\n  }\r\n\r\n  private static compareObject(fromItem, toItem, baseKey?, ignoreKeys = []) {\r\n    const fromItemClone = JSON.parse(JSON.stringify(fromItem));\r\n    const toItemClone = JSON.parse(JSON.stringify(toItem));\r\n\r\n    const keys: any = new Set([\r\n      ...Object.keys(fromItem),\r\n      ...Object.keys(toItem)\r\n    ]);\r\n    let keysChanged = [];\r\n    keys.forEach(key => {\r\n      const keyString = baseKey ? `${baseKey}.${key}` : key;\r\n      if (ignoreKeys.indexOf(keyString) !== -1) {\r\n        return;\r\n      }\r\n\r\n      if (Array.isArray(fromItem[key])) {\r\n        fromItem[key] = fromItem[key].join(',<br>');\r\n      }\r\n      if (Array.isArray(toItem[key])) {\r\n        toItem[key] = toItem[key].join(',<br>');\r\n      }\r\n\r\n      if (\r\n        typeof fromItem[key] === 'object' &&\r\n        typeof toItem[key] === 'object' &&\r\n        fromItem[key] !== null &&\r\n        toItem[key] !== null\r\n      ) {\r\n        keysChanged = keysChanged.concat(\r\n          this.compareObject(fromItem[key], toItem[key], keyString)\r\n        );\r\n      } else {\r\n        if (fromItem[key] !== toItem[key]) {\r\n          keysChanged.push({\r\n            key: keyString,\r\n            oldValue: fromItemClone[key],\r\n            newValue: toItemClone[key]\r\n          });\r\n          fromItem[key] = StringUtils.diff(fromItem[key], toItem[key]);\r\n        }\r\n      }\r\n    });\r\n\r\n    return keysChanged;\r\n  }\r\n}\r\n","export class ObjectUtils {\r\n  static resolve(obj: object, key: string): any {\r\n    const keysArray = key\r\n      .replace(/\\[/g, '.')\r\n      .replace(/\\]/g, '')\r\n      .split('.');\r\n    let current = obj;\r\n    while (keysArray.length) {\r\n      if (typeof current !== 'object') {\r\n        return undefined;\r\n      }\r\n      current = current[keysArray.shift()];\r\n    }\r\n\r\n    return current;\r\n  }\r\n\r\n  static isObject(item: object) {\r\n    return (\r\n      item &&\r\n      typeof item === 'object' &&\r\n      !Array.isArray(item) &&\r\n      item !== null &&\r\n      !(item instanceof Date)\r\n    );\r\n  }\r\n\r\n  static mergeDeep(\r\n    target: object,\r\n    source: object,\r\n    ignoreUndefined = false\r\n  ): any {\r\n    const output = Object.assign({}, target);\r\n    if (ObjectUtils.isObject(target) && ObjectUtils.isObject(source)) {\r\n      Object.keys(source)\r\n        .filter(key => !ignoreUndefined || source[key] !== undefined)\r\n        .forEach(key => {\r\n          if (ObjectUtils.isObject(source[key])) {\r\n            if (!(key in target)) {\r\n              Object.assign(output, { [key]: source[key] });\r\n            } else {\r\n              output[key] = ObjectUtils.mergeDeep(\r\n                target[key],\r\n                source[key],\r\n                ignoreUndefined\r\n              );\r\n            }\r\n          } else {\r\n            Object.assign(output, { [key]: source[key] });\r\n          }\r\n        });\r\n    }\r\n    return output;\r\n  }\r\n\r\n  static copyDeep(src): any {\r\n    const target = Array.isArray(src) ? [] : {};\r\n    for (const prop in src) {\r\n      if (src.hasOwnProperty(prop)) {\r\n        const value = src[prop];\r\n        if (value && typeof value === 'object') {\r\n          target[prop] = this.copyDeep(value);\r\n        } else {\r\n          target[prop] = value;\r\n        }\r\n      }\r\n    }\r\n    return target;\r\n  }\r\n\r\n  static removeDuplicateCaseInsensitive(obj: object) {\r\n    const summaryCapitalizeObject = {};\r\n    const capitalizeObject = {};\r\n    const upperCaseCount = [];\r\n\r\n    for (const property in obj) {\r\n      if (obj.hasOwnProperty(property)) {\r\n        const upperCaseProperty = property.toUpperCase();\r\n        if (!summaryCapitalizeObject.hasOwnProperty(upperCaseProperty)) {\r\n          summaryCapitalizeObject[upperCaseProperty] = [\r\n            { [property]: obj[property] }\r\n          ];\r\n        } else {\r\n          summaryCapitalizeObject[upperCaseProperty].push({\r\n            [property]: obj[property]\r\n          });\r\n        }\r\n        // counting the number of uppercase lettersMna\r\n        upperCaseCount.push({\r\n          key: property,\r\n          count: property.replace(/[^A-Z]/g, '').length\r\n        });\r\n      }\r\n    }\r\n    for (const capitalizedProperty in summaryCapitalizeObject) {\r\n      if (summaryCapitalizeObject.hasOwnProperty(capitalizedProperty)) {\r\n        if (summaryCapitalizeObject.hasOwnProperty(capitalizedProperty)) {\r\n          const capitalizedPropertyObject =\r\n            summaryCapitalizeObject[capitalizedProperty];\r\n          if (capitalizedPropertyObject.length === 1) {\r\n            // for single params (no duplicates)\r\n            const singlePossibility = capitalizedPropertyObject[0];\r\n            capitalizeObject[capitalizedProperty] =\r\n              singlePossibility[Object.keys(singlePossibility)[0]];\r\n          } else if (capitalizedPropertyObject.length > 1) {\r\n            // defining the closest to lowercase property\r\n            const paramClosestToLowercase = upperCaseCount\r\n              .filter(\r\n                f => f.key.toLowerCase() === capitalizedProperty.toLowerCase()\r\n              )\r\n              .reduce((prev, current) => {\r\n                return prev.y < current.y ? prev : current;\r\n              });\r\n            capitalizeObject[paramClosestToLowercase.key.toUpperCase()] =\r\n              obj[paramClosestToLowercase.key];\r\n          }\r\n        }\r\n      }\r\n    }\r\n    for (const property in obj) {\r\n      if (obj.hasOwnProperty(property)) {\r\n        delete obj[property];\r\n      }\r\n    }\r\n\r\n    for (const property in capitalizeObject) {\r\n      if (capitalizeObject.hasOwnProperty(property)) {\r\n        obj[property] = capitalizeObject[property];\r\n      }\r\n    }\r\n  }\r\n\r\n  static removeUndefined(obj: object): any {\r\n    const output = {};\r\n    if (ObjectUtils.isObject(obj)) {\r\n      Object.keys(obj)\r\n        .filter(key => obj[key] !== undefined)\r\n        .forEach(key => {\r\n          if (ObjectUtils.isObject(obj[key]) || Array.isArray(obj[key])) {\r\n            output[key] = ObjectUtils.removeUndefined(obj[key]);\r\n          } else {\r\n            output[key] = obj[key];\r\n          }\r\n        });\r\n\r\n      return output;\r\n    }\r\n\r\n    if (Array.isArray(obj)) {\r\n      return obj.map(o => ObjectUtils.removeUndefined(o));\r\n    }\r\n\r\n    return obj;\r\n  }\r\n\r\n  static removeNull(obj: object): any {\r\n    const output = {};\r\n    if (ObjectUtils.isObject(obj)) {\r\n      Object.keys(obj)\r\n        .filter(key => obj[key] !== null)\r\n        .forEach(key => {\r\n          if (ObjectUtils.isObject(obj[key]) || Array.isArray(obj[key])) {\r\n            output[key] = ObjectUtils.removeNull(obj[key]);\r\n          } else {\r\n            output[key] = obj[key];\r\n          }\r\n        });\r\n\r\n      return output;\r\n    }\r\n\r\n    if (Array.isArray(obj)) {\r\n      return obj.map(o => ObjectUtils.removeNull(o));\r\n    }\r\n\r\n    return obj;\r\n  }\r\n\r\n  static naturalCompare(a, b, direction = 'asc', nullsFirst?: boolean) {\r\n    if (direction === 'desc') {\r\n      b = [a, (a = b)][0];\r\n    }\r\n\r\n    // nullsFirst = undefined : end if direction = 'asc', first if direction = 'desc'\r\n    // nullsFirst = true : always first\r\n    // nullsFirst = false : always end\r\n    if (\r\n      a === null ||\r\n      a === '' ||\r\n      a === undefined ||\r\n      b === null ||\r\n      b === '' ||\r\n      b === undefined\r\n    ) {\r\n      const nullScore =\r\n        a === b\r\n          ? 0\r\n          : a === undefined\r\n          ? 3\r\n          : b === undefined\r\n          ? -3\r\n          : a === null\r\n          ? 2\r\n          : b === null\r\n          ? -2\r\n          : a === ''\r\n          ? 1\r\n          : -1;\r\n      if (direction === 'desc') {\r\n        return nullsFirst !== false ? nullScore : nullScore * -1;\r\n      }\r\n      return nullsFirst === true ? nullScore * -1 : nullScore;\r\n    }\r\n\r\n    const ax = [];\r\n    const bx = [];\r\n    a = '' + a;\r\n    b = '' + b;\r\n\r\n    a.replace(/(\\d+)|(\\D+)/g, (_, $1, $2) => {\r\n      ax.push([$1 || Infinity, $2 || '']);\r\n    });\r\n\r\n    b.replace(/(\\d+)|(\\D+)/g, (_, $1, $2) => {\r\n      bx.push([$1 || Infinity, $2 || '']);\r\n    });\r\n\r\n    while (ax.length && bx.length) {\r\n      const an = ax.shift();\r\n      const bn = bx.shift();\r\n      const nn = an[0] - bn[0] || an[1].localeCompare(bn[1]);\r\n      if (nn) {\r\n        return nn;\r\n      }\r\n    }\r\n\r\n    return ax.length - bx.length;\r\n  }\r\n\r\n  /**\r\n   * Return true if two object are equivalent.\r\n   * Objects are considered equivalent if they have the same properties and\r\n   * if all of their properties (first-level only) share the same value.\r\n   * @param obj1 First object\r\n   * @param obj2 Second object\r\n   * @returns Whether two objects arer equivalent\r\n   */\r\n  static objectsAreEquivalent(obj1: object, obj2: object): boolean {\r\n    if (obj1 === obj2) {\r\n      return true;\r\n    }\r\n\r\n    const obj1Props = Object.getOwnPropertyNames(obj1);\r\n    const obj2Props = Object.getOwnPropertyNames(obj2);\r\n    if (obj1Props.length !== obj2Props.length) {\r\n      return false;\r\n    }\r\n\r\n    for (const prop of obj1Props) {\r\n      if (obj1[prop] !== obj2[prop]) {\r\n        return false;\r\n      }\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Return a new object with an array of keys removed\r\n   * @param obj Source object\r\n   * @param keys Keys to remove\r\n   * @returns A new object\r\n   */\r\n  static removeKeys(obj: object, keys: string[]): object {\r\n    const newObj = Object.keys(obj)\r\n      .filter(key => keys.indexOf(key) < 0)\r\n      .reduce((_obj, key) => {\r\n        _obj[key] = obj[key];\r\n        return _obj;\r\n      }, {});\r\n\r\n    return newObj;\r\n  }\r\n}\r\n","export class NumberUtils {\r\n    static roundToNDecimal(num: number, decimal: number = 3): number {\r\n        const roundFactor = Math.pow(10, decimal);\r\n        return Math.round((num) * roundFactor) / roundFactor;\r\n    }\r\n}\r\n","/** Utility function to create a K:V from a list of strings */\r\nexport function strEnum<T extends string>(o: Array<T>): { [K in T]: K } {\r\n  return o.reduce((res, key) => {\r\n    res[key] = key;\r\n    return res;\r\n  }, Object.create(null));\r\n}\r\n","export function S4() {\r\n  // eslint-disable-next-line no-bitwise\r\n  return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);\r\n}\r\n\r\nexport function uuid() {\r\n  const id = `${S4()}${S4()}-${S4()}-${S4()}-${S4()}-${S4()}${S4()}${S4()}`;\r\n  return id.toLowerCase();\r\n}\r\n","import { Subject, Subscription } from 'rxjs';\r\nimport { distinctUntilChanged } from 'rxjs/operators';\r\n\r\nexport enum SubjectStatus {\r\n  Error = 0,\r\n  Done = 1,\r\n  Working = 2,\r\n  Waiting = 3\r\n}\r\n\r\nexport abstract class Watcher {\r\n  public status$ = new Subject<SubjectStatus>();\r\n  protected status$$: Subscription;\r\n\r\n  get status(): SubjectStatus {\r\n    return this._status;\r\n  }\r\n  set status(value: SubjectStatus) {\r\n    this._status = value;\r\n    this.status$.next(value);\r\n  }\r\n  private _status: SubjectStatus;\r\n\r\n  protected abstract watch();\r\n\r\n  protected abstract unwatch();\r\n\r\n  // eslint-disable-next-line @typescript-eslint/ban-types\r\n  subscribe(callback: Function, scope?: any) {\r\n    this.watch();\r\n\r\n    this.status$$ = this.status$\r\n      .pipe(distinctUntilChanged())\r\n      .subscribe((status: SubjectStatus) => {\r\n        this.handleStatusChange(status);\r\n        callback.call(scope, this);\r\n      });\r\n  }\r\n\r\n  unsubscribe() {\r\n    this.unwatch();\r\n    if (this.status$$ !== undefined) {\r\n      this.status$$.unsubscribe();\r\n      this.status$$ = undefined;\r\n    }\r\n    this.status = SubjectStatus.Waiting;\r\n  }\r\n\r\n  protected handleStatusChange(status: SubjectStatus) {}\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { uuid } from '@igo2/utils';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ActivityService {\r\n  public counter$ = new BehaviorSubject<number>(0);\r\n\r\n  private ids: string[] = [];\r\n\r\n  constructor() {}\r\n\r\n  register(): string {\r\n    const id = uuid();\r\n    this.ids.push(id);\r\n    this.counter$.next(this.ids.length);\r\n\r\n    return id;\r\n  }\r\n\r\n  unregister(id: string) {\r\n    const index = this.ids.indexOf(id);\r\n    if (index === -1) {\r\n      return;\r\n    }\r\n    this.ids.splice(index, 1);\r\n\r\n    this.counter$.next(this.ids.length);\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport {\r\n  HttpEvent,\r\n  HttpHandler,\r\n  HttpInterceptor,\r\n  HttpRequest\r\n} from '@angular/common/http';\r\n\r\nimport { Observable } from 'rxjs';\r\nimport { finalize } from 'rxjs/operators';\r\n\r\nimport { ActivityService } from './activity.service';\r\n\r\n@Injectable()\r\nexport class ActivityInterceptor implements HttpInterceptor {\r\n  constructor(private activityService: ActivityService) {}\r\n\r\n  intercept(\r\n    req: HttpRequest<any>,\r\n    next: HttpHandler\r\n  ): Observable<HttpEvent<any>> {\r\n    const activity = req.headers.get('activityInterceptor');\r\n    if (activity) {\r\n      const actReq = req.clone({\r\n        headers: req.headers.delete('activityInterceptor')\r\n      });\r\n      if (activity === 'false') {\r\n        return next.handle(actReq);\r\n      }\r\n    }\r\n\r\n    const id = this.activityService.register();\r\n\r\n    return next.handle(req).pipe(\r\n      finalize(() => {\r\n        this.activityService.unregister(id);\r\n      })\r\n    );\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { HTTP_INTERCEPTORS } from '@angular/common/http';\r\n\r\nimport { ActivityInterceptor } from './activity.interceptor';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [],\r\n  exports: []\r\n})\r\nexport class IgoActivityModule {\r\n  static forRoot(): ModuleWithProviders<IgoActivityModule> {\r\n    return {\r\n      ngModule: IgoActivityModule,\r\n      providers: [\r\n        {\r\n          provide: HTTP_INTERCEPTORS,\r\n          useClass: ActivityInterceptor,\r\n          multi: true\r\n        }\r\n      ]\r\n    };\r\n  }\r\n}\r\n","export interface Version {\r\n  lib: string;\r\n  releaseDate: number;\r\n}\r\n\r\nexport const version: Version = {\r\n  lib: '1.12.0',\r\n  releaseDate: 1656013761086\r\n};\r\n","import { Injectable, Injector } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { throwError } from 'rxjs';\r\nimport { catchError } from 'rxjs/operators';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport { ConfigOptions } from './config.interface';\r\nimport { version } from './version';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ConfigService {\r\n  private config: object = {};\r\n\r\n  constructor(private injector: Injector) {}\r\n\r\n  /**\r\n   * Use to get the data found in config file\r\n   */\r\n  public getConfig(key: string): any {\r\n    return ObjectUtils.resolve(this.config, key);\r\n  }\r\n\r\n  /**\r\n   * This method loads \"[path]\" to get all config's variables\r\n   */\r\n  public load(options: ConfigOptions) {\r\n    const baseConfig = options.default || {};\r\n    if (!options.path) {\r\n      this.config = baseConfig;\r\n      return true;\r\n    }\r\n\r\n    const http = this.injector.get(HttpClient);\r\n\r\n    return new Promise((resolve, _reject) => {\r\n      http\r\n        .get(options.path)\r\n        .pipe(\r\n          catchError((error: any): any => {\r\n            console.log(`Configuration file ${options.path} could not be read`);\r\n            resolve(true);\r\n            return throwError(error.error || 'Server error');\r\n          })\r\n        )\r\n        .subscribe((configResponse: object) => {\r\n          this.config = ObjectUtils.mergeDeep(\r\n            ObjectUtils.mergeDeep({ version }, baseConfig),\r\n            configResponse\r\n          );\r\n          resolve(true);\r\n        });\r\n    });\r\n  }\r\n}\r\n","import { APP_INITIALIZER, InjectionToken } from '@angular/core';\r\n\r\nimport { ConfigService } from './config.service';\r\nimport { ConfigOptions } from './config.interface';\r\n\r\nexport let CONFIG_OPTIONS = new InjectionToken<ConfigOptions>('configOptions');\r\n\r\nexport function provideConfigOptions(options: ConfigOptions) {\r\n  return {\r\n    provide: CONFIG_OPTIONS,\r\n    useValue: options\r\n  };\r\n}\r\n\r\nexport function configFactory(\r\n  configService: ConfigService,\r\n  options: ConfigOptions\r\n) {\r\n  return () => configService.load(options);\r\n}\r\n\r\nexport function provideConfigLoader() {\r\n  return {\r\n    provide: APP_INITIALIZER,\r\n    useFactory: configFactory,\r\n    multi: true,\r\n    deps: [ConfigService, CONFIG_OPTIONS]\r\n  };\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { provideConfigOptions, provideConfigLoader } from './config.provider';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [],\r\n  exports: []\r\n})\r\nexport class IgoConfigModule {\r\n  static forRoot(): ModuleWithProviders<IgoConfigModule> {\r\n    return {\r\n      ngModule: IgoConfigModule,\r\n      providers: [provideConfigOptions({}), provideConfigLoader()]\r\n    };\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\n\r\nimport { of, combineLatest } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { TranslateLoader } from '@ngx-translate/core';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport { ConfigService } from '../../config/config.service';\r\n\r\ndeclare function require(arg: string): any;\r\n\r\nexport class LanguageLoader implements TranslateLoader {\r\n  constructor(\r\n    private http: HttpClient,\r\n    private prefix?: string | string[],\r\n    private suffix: string = '.json',\r\n    private config?: ConfigService\r\n  ) {}\r\n\r\n  public getTranslation(lang: string): any {\r\n    const translation = require(`../locale/${lang}.json`);\r\n    const igoLocale$ = of(translation);\r\n\r\n    if (this.config && !this.prefix) {\r\n      const prefix = this.config.getConfig('language.prefix');\r\n      this.prefix = !prefix || Array.isArray(prefix) ? prefix : [prefix];\r\n    }\r\n\r\n    if (!this.prefix || this.prefix.length === 0) {\r\n      return igoLocale$;\r\n    }\r\n\r\n    const appLocale$ = (this.prefix as string[]).map((prefix) =>\r\n      this.http.get(`${prefix}${lang}${this.suffix}`)\r\n    );\r\n\r\n    const locale$ = combineLatest([igoLocale$, ...appLocale$]);\r\n\r\n    return locale$.pipe(\r\n      map((translations) => {\r\n        return translations.reduce(\r\n          (acc, current) => ObjectUtils.mergeDeep(acc, current),\r\n          {}\r\n        );\r\n      })\r\n    );\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\nimport { TranslateLoader } from '@ngx-translate/core';\r\n\r\nimport { ConfigService } from '../../config/config.service';\r\nimport { LanguageLoader } from './language.loader';\r\n\r\nexport function defaultLanguageLoader(\r\n  http: HttpClient,\r\n  config?: ConfigService\r\n) {\r\n  return new LanguageLoader(http, undefined, undefined, config);\r\n}\r\n\r\nexport function provideLanguageLoader(loader?) {\r\n  return {\r\n    provide: TranslateLoader,\r\n    useFactory: loader || defaultLanguageLoader,\r\n    deps: [HttpClient]\r\n  };\r\n}\r\n\r\nexport function provideDefaultLanguageLoader(loader?) {\r\n  return {\r\n    provide: TranslateLoader,\r\n    useFactory: loader || defaultLanguageLoader,\r\n    deps: [HttpClient, ConfigService]\r\n  };\r\n}\r\n","import {\r\n  MissingTranslationHandler,\r\n  MissingTranslationHandlerParams\r\n} from '@ngx-translate/core';\r\n\r\nexport class IgoMissingTranslationHandler implements MissingTranslationHandler {\r\n  handle(params: MissingTranslationHandlerParams) {\r\n    if (!params.translateService.langs.length) {\r\n      const error =\r\n        'Translations are not yet loaded. \\\r\n         Check that the LanguageService is injected.';\r\n      throw new Error(error);\r\n    }\r\n\r\n    if (params.key.substr(0, 4) === 'igo.') {\r\n      throw new Error(`The Key \"${params.key}\" is missing in locale file.`);\r\n    } else {\r\n      return params.key;\r\n    }\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport {\r\n  TranslateModule,\r\n  MissingTranslationHandler\r\n} from '@ngx-translate/core';\r\n\r\nimport { provideDefaultLanguageLoader } from './shared/language.provider';\r\nimport { IgoMissingTranslationHandler } from './shared/missing-translation.guard';\r\n\r\n@NgModule({\r\n  imports: [\r\n    TranslateModule.forRoot({\r\n      missingTranslationHandler: {\r\n        provide: MissingTranslationHandler,\r\n        useClass: IgoMissingTranslationHandler\r\n      }\r\n    })\r\n  ],\r\n  declarations: [],\r\n  exports: [TranslateModule]\r\n})\r\nexport class IgoLanguageModule {\r\n  static forRoot(): ModuleWithProviders<IgoLanguageModule> {\r\n    return {\r\n      ngModule: IgoLanguageModule,\r\n      providers: [provideDefaultLanguageLoader()]\r\n    };\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { GlobalConfig, ToastrModule } from 'ngx-toastr';\r\n\r\n@NgModule({\r\n  imports: [CommonModule,\r\n    ToastrModule.forRoot({\r\n      positionClass: 'toast-bottom-right',\r\n      timeOut: 10000,\r\n      extendedTimeOut: 10000,\r\n      messageClass: 'toast-message mat-typography',\r\n      closeButton: true,\r\n      progressBar: true,\r\n      enableHtml: true,\r\n      tapToDismiss: true,\r\n      maxOpened: 4,\r\n      preventDuplicates: true,\r\n      resetTimeoutOnDuplicate: true,\r\n      countDuplicates: false,\r\n      includeTitleDuplicates: true\r\n    } as GlobalConfig)],\r\n  declarations: [],\r\n  exports: []\r\n})\r\nexport class IgoMessageModule {\r\n  static forRoot(): ModuleWithProviders<IgoMessageModule> {\r\n    return {\r\n      ngModule: IgoMessageModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { TranslateService } from '@ngx-translate/core';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class LanguageService {\r\n  private language: string = this.translate.getBrowserLang();\r\n\r\n  constructor(public translate: TranslateService) {\r\n    const lang = this.getLanguage();\r\n    this.translate.setDefaultLang(lang);\r\n  }\r\n\r\n  public getLanguage(): string {\r\n    return this.language.match(/en|fr/) ? this.language : 'en';\r\n  }\r\n\r\n  public setLanguage(language: string) {\r\n    this.language = language.match(/en|fr/) ? language : 'en';\r\n    this.translate.use(this.language);\r\n    this.translate.reloadLang(this.language);\r\n  }\r\n}\r\n","export enum MessageType {\r\n  ERROR = 'error',\r\n  ALERT = 'warning', // todo delete (transition to ngx-toastr)\r\n  WARNING = 'warning',\r\n  INFO = 'info',\r\n  SUCCESS = 'success'\r\n}\r\n","import { Injectable, Inject, Injector } from '@angular/core';\r\nimport { HttpErrorResponse } from '@angular/common/http';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { ConfigService } from '../../config/config.service';\r\n\r\nimport { Message, MessageOptions } from './message.interface';\r\nimport { ActiveToast, IndividualConfig, ToastrService } from 'ngx-toastr';\r\nimport { MessageType } from './message.enum';\r\nimport { LanguageService } from '../../language/shared/language.service';\r\n\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class MessageService {\r\n  public messages$ = new BehaviorSubject<Message[]>([]);\r\n  private options: MessageOptions;\r\n\r\n  constructor(\r\n    @Inject(Injector) private injector: Injector,\r\n    private configService: ConfigService,\r\n    private languageService: LanguageService\r\n  ) {\r\n    this.options = this.configService.getConfig('message') || {};\r\n  }\r\n\r\n  private get toastr(): ToastrService {\r\n    return this.injector.get(ToastrService);\r\n  }\r\n\r\n  showError(httpError: HttpErrorResponse) {\r\n    httpError.error.caught = true;\r\n    return this.error(httpError.error.message, httpError.error.title);\r\n  }\r\n\r\n  message(message: Message) {\r\n    this.messages$.next(this.messages$.value.concat([message]));\r\n\r\n    message.options = message.options || {} as MessageOptions;\r\n    const currentDate = new Date();\r\n\r\n    message.options.from = message.options.from ? message.options.from : new Date('1 jan 1900');\r\n    message.options.to = message.options.to ? message.options.to : new Date('1 jan 3000');\r\n    if (typeof message.options.from === 'string') {\r\n      message.options.from = new Date(Date.parse(message.options.from.replace(/-/g, ' ')));\r\n    }\r\n    if (typeof message.options.to === 'string') {\r\n      message.options.to = new Date(Date.parse(message.options.to.replace(/-/g, ' ')));\r\n    }\r\n    if (\r\n      currentDate > message.options.from && currentDate < message.options.to) {\r\n\r\n      message = this.handleTemplate(message);\r\n\r\n      if (message.text) {\r\n        let messageShown: ActiveToast<any>;\r\n        switch (message.type) {\r\n          case MessageType.SUCCESS:\r\n            messageShown = this.success(message.text, message.title, message.options);\r\n            break;\r\n          case MessageType.ERROR:\r\n            messageShown = this.error(message.text, message.title, message.options);\r\n            break;\r\n          case MessageType.INFO:\r\n            messageShown = this.info(message.text, message.title, message.options);\r\n            break;\r\n          case MessageType.ALERT:\r\n          case MessageType.WARNING:\r\n            messageShown = this.alert(message.text, message.title, message.options);\r\n            break;\r\n          default:\r\n            messageShown = this.info(message.text, message.title, message.options);\r\n            break;\r\n        }\r\n        message.options.id = messageShown.toastId;\r\n      }\r\n    }\r\n  }\r\n\r\n  success(text: string, title: string = 'igo.core.message.success', options: Partial<IndividualConfig> = {}): ActiveToast<any> {\r\n    const message = this.languageService.translate.instant(text);\r\n    const translatedTitle = this.languageService.translate.instant(title);\r\n    return this.toastr.success(message, translatedTitle, options);\r\n  }\r\n\r\n  error(text: string, title: string = 'igo.core.message.error', options: Partial<IndividualConfig> = {}): ActiveToast<any> {\r\n    const message = this.languageService.translate.instant(text);\r\n    const translatedTitle = this.languageService.translate.instant(title);\r\n    return this.toastr.error(message, translatedTitle, options);\r\n  }\r\n\r\n  info(text: string, title: string = 'igo.core.message.info', options: Partial<IndividualConfig> = {}): ActiveToast<any> {\r\n    const message = this.languageService.translate.instant(text);\r\n    const translatedTitle = this.languageService.translate.instant(title);\r\n    return this.toastr.info(message, translatedTitle, options);\r\n  }\r\n\r\n  alert(text: string, title: string = 'igo.core.message.alert', options: Partial<IndividualConfig> = {}): ActiveToast<any> {\r\n    const message = this.languageService.translate.instant(text);\r\n    const translatedTitle = this.languageService.translate.instant(title);\r\n    return this.toastr.warning(message, translatedTitle, options);\r\n  }\r\n\r\n  remove(id?: number) {\r\n    this.toastr.remove(id);\r\n  }\r\n\r\n  removeAllAreNotError() {\r\n    for (const mess of this.messages$.value) {\r\n      if (mess.type !== MessageType.ERROR) {\r\n        this.remove(mess.options.id);\r\n      }\r\n    }\r\n  }\r\n\r\n  private handleTemplate(message: Message): Message {\r\n    if (!this.options.template || message.html) {\r\n      return message;\r\n    }\r\n\r\n    let html = this.options.template;\r\n    html = html.replace('${text}', message.text);\r\n    html = html.replace('${title}', message.title);\r\n\r\n    message.html = undefined;\r\n    message.text = html;\r\n    message.title = undefined;\r\n    return message;\r\n  }\r\n}\r\n","import { Injectable, Injector } from '@angular/core';\r\nimport {\r\n  HttpInterceptor,\r\n  HttpHandler,\r\n  HttpRequest,\r\n  HttpEvent,\r\n  HttpErrorResponse\r\n} from '@angular/common/http';\r\n\r\nimport { Observable, throwError } from 'rxjs';\r\nimport { catchError, finalize } from 'rxjs/operators';\r\n\r\nimport { MessageService } from '../message/shared/message.service';\r\nimport { LanguageService } from '../language/shared/language.service';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ErrorInterceptor implements HttpInterceptor {\r\n  constructor(\r\n    private messageService: MessageService,\r\n    private injector: Injector\r\n  ) {}\r\n\r\n  intercept(\r\n    req: HttpRequest<any>,\r\n    next: HttpHandler\r\n  ): Observable<HttpEvent<any>> {\r\n    const errorContainer = { httpError: undefined };\r\n    return next.handle(req).pipe(\r\n      catchError(error => this.handleError(error, errorContainer)),\r\n      finalize(() => {\r\n        this.handleCaughtError(errorContainer);\r\n        this.handleUncaughtError(errorContainer);\r\n      })\r\n    );\r\n  }\r\n\r\n  private handleError(\r\n    httpError: HttpErrorResponse,\r\n    errorContainer: { httpError: HttpErrorResponse }\r\n  ) {\r\n    if (httpError instanceof HttpErrorResponse) {\r\n      const errorObj = httpError.error === 'object' ? httpError.error : {};\r\n      errorObj.message = httpError.error.message || httpError.statusText;\r\n      errorObj.caught = false;\r\n\r\n      httpError = new HttpErrorResponse({\r\n        error: errorObj,\r\n        headers: httpError.headers,\r\n        status: httpError.status,\r\n        statusText: httpError.statusText,\r\n        url: httpError.url\r\n      });\r\n    }\r\n\r\n    errorContainer.httpError = httpError;\r\n    return throwError(httpError);\r\n  }\r\n\r\n  private handleCaughtError(errorContainer: { httpError: HttpErrorResponse }) {\r\n    const httpError = errorContainer.httpError;\r\n    if (httpError && httpError.error.toDisplay) {\r\n      httpError.error.caught = true;\r\n      this.messageService.error(httpError.error.message, httpError.error.title);\r\n    }\r\n  }\r\n\r\n  private handleUncaughtError(errorContainer: {\r\n    httpError: HttpErrorResponse;\r\n  }) {\r\n    const httpError = errorContainer.httpError;\r\n    if (httpError && !httpError.error.caught) {\r\n      const translate = this.injector.get(LanguageService).translate;\r\n      const message = translate.instant('igo.core.errors.uncaught.message');\r\n      const title = translate.instant('igo.core.errors.uncaught.title');\r\n      httpError.error.caught = true;\r\n      this.messageService.error(message, title);\r\n    }\r\n  }\r\n}\r\n","import {\r\n  NgModule,\r\n  ModuleWithProviders,\r\n  Optional,\r\n  SkipSelf\r\n} from '@angular/core';\r\nimport { HTTP_INTERCEPTORS } from '@angular/common/http';\r\n\r\nimport { ErrorInterceptor } from './error.interceptor';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [],\r\n  exports: []\r\n})\r\nexport class IgoErrorModule {\r\n  static forRoot(): ModuleWithProviders<IgoErrorModule> {\r\n    return {\r\n      ngModule: IgoErrorModule,\r\n      providers: [\r\n        {\r\n          provide: HTTP_INTERCEPTORS,\r\n          useClass: ErrorInterceptor,\r\n          multi: true\r\n        }\r\n      ]\r\n    };\r\n  }\r\n\r\n  constructor(@Optional() @SkipSelf() parentModule: IgoErrorModule) {\r\n    if (parentModule) {\r\n      throw new Error(\r\n        'IgoErrorModule is already loaded. Import it in the AppModule only'\r\n      );\r\n    }\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { HttpClientModule } from '@angular/common/http';\r\nimport { DomSanitizer } from '@angular/platform-browser';\r\nimport { MatIconRegistry } from '@angular/material/icon';\r\n\r\nimport { IgoActivityModule } from './activity/activity.module';\r\nimport { IgoConfigModule } from './config/config.module';\r\nimport { IgoLanguageModule } from './language/language.module';\r\nimport { IgoMessageModule } from './message/message.module';\r\nimport { IgoErrorModule } from './request/error.module';\r\nimport { DBConfig, NgxIndexedDBModule } from 'ngx-indexed-db';\r\n\r\nconst dbConfig: DBConfig = {\r\n  name: 'igo2DB',\r\n  version: 1,\r\n  objectStoresMeta: [{\r\n    store: 'geoData',\r\n    storeConfig: { keyPath: 'url', autoIncrement: false },\r\n    storeSchema: [\r\n      { name: 'regionID', keypath: 'regionID', options: { unique: false }}\r\n    ]\r\n  }]\r\n};\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    HttpClientModule,\r\n    IgoActivityModule.forRoot(),\r\n    IgoConfigModule.forRoot(),\r\n    IgoErrorModule.forRoot(),\r\n    IgoLanguageModule.forRoot(),\r\n    IgoMessageModule.forRoot(),\r\n    NgxIndexedDBModule.forRoot(dbConfig)\r\n  ],\r\n  declarations: [],\r\n  exports: [\r\n    IgoActivityModule,\r\n    IgoConfigModule,\r\n    IgoErrorModule,\r\n    IgoLanguageModule,\r\n    IgoMessageModule\r\n  ]\r\n})\r\nexport class IgoCoreModule {\r\n  static forRoot(): ModuleWithProviders<IgoCoreModule> {\r\n    return {\r\n      ngModule: IgoCoreModule,\r\n      providers: []\r\n    };\r\n  }\r\n\r\n  constructor(matIconRegistry: MatIconRegistry, domSanitizer: DomSanitizer) {\r\n    matIconRegistry.addSvgIconSet(\r\n      domSanitizer.bypassSecurityTrustResourceUrl(\r\n        './assets/igo2/core/icons/mdi.svg'\r\n      )\r\n    );\r\n  }\r\n}\r\n","import { Injectable, Inject, InjectionToken, Optional } from '@angular/core';\r\nimport { ActivatedRoute, Params, Router } from '@angular/router';\r\nimport { Observable } from 'rxjs';\r\n\r\nimport { RouteServiceOptions } from './route.interface';\r\n\r\nexport let ROUTE_SERVICE_OPTIONS = new InjectionToken<RouteServiceOptions>(\r\n  'routeServiceOptions'\r\n);\r\n\r\nexport function provideRouteServiceOptions(options: RouteServiceOptions) {\r\n  return {\r\n    provide: ROUTE_SERVICE_OPTIONS,\r\n    useValue: options\r\n  };\r\n}\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class RouteService {\r\n  public options: RouteServiceOptions;\r\n\r\n  constructor(\r\n    private router: Router,\r\n    public route: ActivatedRoute,\r\n    @Inject(ROUTE_SERVICE_OPTIONS)\r\n    @Optional()\r\n    options: RouteServiceOptions\r\n  ) {\r\n    const defaultOptions = {\r\n      centerKey: 'center',\r\n      zoomKey: 'zoom',\r\n      projectionKey: 'projection',\r\n      contextKey: 'context',\r\n      searchKey: 'search',\r\n      visibleOnLayersKey: 'visiblelayers',\r\n      visibleOffLayersKey: 'invisiblelayers',\r\n      directionsCoordKey: 'routing',\r\n      directionsOptionsKey: 'routingOptions',\r\n      toolKey: 'tool',\r\n      wmsUrlKey: 'wmsUrl',\r\n      wmsLayersKey:  'wmsLayers',\r\n      wmtsUrlKey: 'wmtsUrl',\r\n      wmtsLayersKey:  'wmtsLayers',\r\n      arcgisUrlKey: 'arcgisUrl',\r\n      arcgisLayersKey:  'arcgisLayers',\r\n      iarcgisUrlKey: 'iarcgisUrl',\r\n      iarcgisLayersKey:  'iarcgisLayers',\r\n      tarcgisUrlKey: 'tarcgisUrl',\r\n      tarcgisLayersKey:  'tarcgisLayers',\r\n      vectorKey: 'vector'\r\n    };\r\n    this.options = Object.assign({}, defaultOptions, options);\r\n  }\r\n\r\n  get queryParams(): Observable<Params> {\r\n    let url = decodeURIComponent(location.search);\r\n    if (url.includes('er=')) {\r\n      url = url.replace('er', '&center');\r\n      const queryParams: any = url\r\n      .slice(1)\r\n      .split('&')\r\n      .map(p => p.split('='))\r\n      .reduce((obj, pair) => {\r\n        const [key, value] = pair.map(decodeURIComponent);\r\n        obj[key] = value;\r\n        return obj;\r\n      }, {});\r\n      this.router.navigate([], { queryParams });\r\n    }\r\n    return this.route.queryParams;\r\n  }\r\n}\r\n","export enum Media {\r\n  Mobile = 'mobile',\r\n  Tablet = 'tablet',\r\n  Desktop = 'desktop'\r\n}\r\n\r\nexport enum MediaOrientation {\r\n  Portrait = 'portrait',\r\n  Landscape = 'landscape'\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { Breakpoints, BreakpointObserver } from '@angular/cdk/layout';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { Media, MediaOrientation } from './media.enum';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class MediaService {\r\n  public media$ = new BehaviorSubject<Media>(undefined);\r\n  public orientation$ = new BehaviorSubject<MediaOrientation>(undefined);\r\n\r\n  constructor(breakpointObserver: BreakpointObserver) {\r\n    breakpointObserver\r\n      .observe([Breakpoints.HandsetLandscape])\r\n      .subscribe(res => {\r\n        if (res.matches) {\r\n          this.media$.next(Media.Mobile);\r\n          this.orientation$.next(MediaOrientation.Landscape);\r\n        }\r\n      });\r\n\r\n    breakpointObserver.observe([Breakpoints.HandsetPortrait]).subscribe(res => {\r\n      if (res.matches) {\r\n        this.media$.next(Media.Mobile);\r\n        this.orientation$.next(MediaOrientation.Portrait);\r\n      }\r\n    });\r\n\r\n    breakpointObserver.observe([Breakpoints.TabletLandscape]).subscribe(res => {\r\n      if (res.matches) {\r\n        this.media$.next(Media.Tablet);\r\n        this.orientation$.next(MediaOrientation.Landscape);\r\n      }\r\n    });\r\n\r\n    breakpointObserver.observe([Breakpoints.TabletPortrait]).subscribe(res => {\r\n      if (res.matches) {\r\n        this.media$.next(Media.Tablet);\r\n        this.orientation$.next(MediaOrientation.Portrait);\r\n      }\r\n    });\r\n\r\n    breakpointObserver.observe([Breakpoints.WebLandscape]).subscribe(res => {\r\n      if (res.matches) {\r\n        this.media$.next(Media.Desktop);\r\n        this.orientation$.next(MediaOrientation.Landscape);\r\n      }\r\n    });\r\n\r\n    breakpointObserver.observe([Breakpoints.WebPortrait]).subscribe(res => {\r\n      if (res.matches) {\r\n        this.media$.next(Media.Desktop);\r\n        this.orientation$.next(MediaOrientation.Portrait);\r\n      }\r\n    });\r\n  }\r\n\r\n  getMedia(): Media {\r\n    return this.media$.value;\r\n  }\r\n\r\n  getOrientation(): MediaOrientation {\r\n    return this.orientation$.value;\r\n  }\r\n\r\n  isTouchScreen(): boolean {\r\n    return 'ontouchstart' in document.documentElement ? true : false;\r\n  }\r\n\r\n  isMobile(): boolean {\r\n    const media = this.getMedia();\r\n    return media === 'mobile';\r\n  }\r\n\r\n  isDesktop(): boolean {\r\n    const media = this.getMedia();\r\n    return media === 'desktop';\r\n  }\r\n}\r\n","export enum StorageScope {\r\n  SESSION = 'Session',\r\n  LOCAL = 'Local'\r\n}\r\n\r\nexport interface StorageOptions {\r\n  key: string;\r\n}\r\n\r\nexport interface StorageServiceEvent {\r\n  key?: string;\r\n  scope: StorageScope;\r\n  event: StorageServiceEventEnum;\r\n  previousValue?: any;\r\n  currentValue?: any;\r\n}\r\n\r\nexport enum StorageServiceEventEnum {\r\n  ADDED = 'Added',\r\n  MODIFIED = 'Modified',\r\n  REMOVED = 'Removed',\r\n  CLEARED = 'Cleared'\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { ConfigService } from '../config/config.service';\r\nimport { StorageScope, StorageOptions, StorageServiceEvent, StorageServiceEventEnum } from './storage.interface';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class StorageService {\r\n  protected options: StorageOptions;\r\n\r\n  public storageChange$: BehaviorSubject<StorageServiceEvent> = new BehaviorSubject(undefined);\r\n\r\n  constructor(private config: ConfigService) {\r\n    this.options = this.config.getConfig('storage') || { key: 'igo' };\r\n  }\r\n  /**\r\n   * Use to get the data found in storage file\r\n   */\r\n  get(key: string, scope?: StorageScope): string | object | boolean | number {\r\n    let value: any;\r\n\r\n    if (!scope || scope === StorageScope.SESSION) {\r\n      value = sessionStorage.getItem(`${this.options.key}.${key}`);\r\n    }\r\n\r\n    if (scope === StorageScope.LOCAL || (!value && !scope)) {\r\n      value = localStorage.getItem(`${this.options.key}.${key}`);\r\n    }\r\n\r\n    if (value) {\r\n      try {\r\n        value = JSON.parse(value);\r\n      } catch {\r\n        value = value;\r\n      }\r\n    }\r\n\r\n    return value;\r\n  }\r\n\r\n  set(\r\n    key: string,\r\n    value: string | object | boolean | number,\r\n    scope: StorageScope = StorageScope.LOCAL\r\n  ) {\r\n    const previousValue = this.get(key, scope);\r\n    if (scope === StorageScope.SESSION) {\r\n      sessionStorage.setItem(\r\n        `${this.options.key}.${key}`,\r\n        JSON.stringify(value)\r\n      );\r\n    } else {\r\n      localStorage.setItem(`${this.options.key}.${key}`, JSON.stringify(value));\r\n    }\r\n    const currentValue = this.get(key, scope);\r\n\r\n    if (currentValue !== previousValue) {\r\n      this.storageChange$.next({\r\n        key, scope,\r\n        event: previousValue !== undefined ? StorageServiceEventEnum.MODIFIED : StorageServiceEventEnum.ADDED,\r\n        previousValue,\r\n        currentValue\r\n      });\r\n    }\r\n  }\r\n\r\n  remove(key: string, scope: StorageScope = StorageScope.LOCAL) {\r\n    const previousValue = this.get(key, scope);\r\n    if (scope === StorageScope.SESSION) {\r\n      sessionStorage.removeItem(`${this.options.key}.${key}`);\r\n    } else {\r\n      localStorage.removeItem(`${this.options.key}.${key}`);\r\n    }\r\n    this.storageChange$.next({key, scope, event: StorageServiceEventEnum.REMOVED, previousValue });\r\n  }\r\n\r\n  clear(scope: StorageScope = StorageScope.LOCAL) {\r\n    if (scope === StorageScope.SESSION) {\r\n      sessionStorage.clear();\r\n    } else {\r\n      localStorage.clear();\r\n    }\r\n    this.storageChange$.next({scope, event: StorageServiceEventEnum.CLEARED });\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { Observable, Observer } from 'rxjs';\r\nimport { CompressedData } from './compressedData.interface';\r\n\r\nfunction getNumber(v: number, endposition: number, length: number) {\r\n  /* tslint:disable:no-bitwise*/\r\n  const mask = ((1 << length) - 1);\r\n  return (v >> endposition) & mask;\r\n  /* tslint:enable:no-bitwise*/\r\n}\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class CompressionService {\r\n  private base64Index = new Map<string, number>();\r\n  private indexBase64 = new Map<number, string>();\r\n\r\n  constructor() {\r\n    this.generateBase64Index();\r\n  }\r\n\r\n  private generateBase64Index() {\r\n    // https://fr.wikipedia.org/wiki/Base64\r\n    // A-Z => [0, 25]\r\n    for (let i = 0; i < 26; i++) {\r\n      this.base64Index.set(String.fromCharCode('A'.charCodeAt(0) + i), i);\r\n      this.indexBase64.set(i, String.fromCharCode('A'.charCodeAt(0) + i));\r\n    }\r\n    // a-z => [26, 51]\r\n    for (let i = 0; i < 26; i++) {\r\n      this.base64Index.set(String.fromCharCode('a'.charCodeAt(0) + i), i + 26);\r\n      this.indexBase64.set(i + 26, String.fromCharCode('a'.charCodeAt(0) + i));\r\n    }\r\n    // 0-9 => [52, 61]\r\n    for (let i = 0; i < 10; i++) {\r\n      this.base64Index.set(String.fromCharCode('0'.charCodeAt(0) + i), i + 52);\r\n      this.indexBase64.set(i + 52, String.fromCharCode('0'.charCodeAt(0) + i));\r\n    }\r\n    // + / => [62, 63]\r\n    this.base64Index.set('+', 62);\r\n    this.base64Index.set('/', 63);\r\n    this.indexBase64.set(62, '+');\r\n    this.indexBase64.set(63, '/');\r\n  }\r\n\r\n  compressBlob(blob: Blob): Observable<CompressedData> {\r\n    if (!blob) {\r\n      return;\r\n    }\r\n\r\n    const observable = new Observable((observer: Observer<CompressedData>) => {\r\n      const reader = new FileReader();\r\n      reader.readAsDataURL(blob);\r\n      reader.onload = () => {\r\n        const base64 = reader.result.valueOf() as string;\r\n        const text64 = base64.substr(base64.indexOf(',') + 1);\r\n        const compressed = this.compressStringBase64(text64);\r\n        const compressedData: CompressedData = { length: text64.length,\r\n                                                 type: blob.type,\r\n                                                 object: compressed };\r\n        observer.next(compressedData);\r\n      };\r\n    });\r\n    return observable;\r\n  }\r\n\r\n  decompressBlob(compressedData: CompressedData): Blob {\r\n    /* tslint:disable:no-bitwise*/\r\n    const object = compressedData.object;\r\n    const length = compressedData.length;\r\n    const decompressed: string = this.decompressStringBase64(object, length);\r\n    const byteCharacters = atob(decompressed);\r\n    const byteNumbers = new Array(byteCharacters.length);\r\n    for (let i = 0; i < byteCharacters.length; i++) {\r\n        byteNumbers[i] = byteCharacters.charCodeAt(i);\r\n    }\r\n    const byteArray = new Uint8Array(byteNumbers);\r\n    const blob = new Blob([byteArray], {type: compressedData.type});\r\n    /* tslint:enable:no-bitwise*/\r\n    return blob;\r\n  }\r\n\r\n  private compressStringBase64(s: string): string {\r\n    /* tslint:disable:no-bitwise*/\r\n    let out = '';\r\n    let bits = 16;\r\n    let chr = 0;\r\n    let rem = 0;\r\n    for (const c of s) {\r\n      const value = this.base64Index.get(c);\r\n      if (bits > 6) {\r\n        bits -= 6;\r\n        chr += value << bits;\r\n      } else {\r\n        rem = 6 - bits;\r\n        chr += value >> rem;\r\n        out += String.fromCharCode(chr);\r\n        chr = (value) << (16 - rem);\r\n        bits = 16 - rem;\r\n      }\r\n    }\r\n    if (s.length % 8 !== 0) {\r\n      out += String.fromCharCode(chr);\r\n    }\r\n    /* tslint:enable:no-bitwise*/\r\n    return String.fromCharCode(9731) + out;\r\n  }\r\n\r\n  private decompressStringBase64(c: string, length: number): string {\r\n     /* tslint:disable:no-bitwise*/\r\n    if (!c) {\r\n      return;\r\n    }\r\n\r\n    if (c.charCodeAt(0) !== 9731) {\r\n      return c;\r\n    }\r\n\r\n    let chr = 0;\r\n    let rem = 0;\r\n    let bits = 16;\r\n    let out = '';\r\n    let j = 1;\r\n    let value = c.charCodeAt(j);\r\n    for (let i = 0; i < length; i++) {\r\n      if (bits > 6) {\r\n        bits -= 6;\r\n        chr = getNumber(value, bits, 6);\r\n        out += this.indexBase64.get(chr);\r\n      } else {\r\n        rem = 6 - bits;\r\n        chr = getNumber(value, 0, bits) << rem;\r\n        value = c.charCodeAt(++j);\r\n        chr += getNumber(value, 16 - rem, rem);\r\n        out += this.indexBase64.get(chr);\r\n        bits = 16 - rem;\r\n      }\r\n    }\r\n    return out;\r\n    /* tslint:enable:no-bitwise*/\r\n  }\r\n}\r\n","import { Injectable, EventEmitter, OnDestroy, Injector } from '@angular/core';\r\nimport { Observable, Subscription, fromEvent } from 'rxjs';\r\nimport { debounceTime, startWith } from 'rxjs/operators';\r\n\r\nimport { MessageService } from '../message/shared/message.service';\r\nimport { LanguageService } from '../language/shared/language.service';\r\nimport { ConnectionState } from './network.interfaces';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class NetworkService implements OnDestroy {\r\n  private stateChangeEventEmitter = new EventEmitter<ConnectionState>();\r\n  private onlineSubscription: Subscription;\r\n  private offlineSubscription: Subscription;\r\n  private previousMessageId;\r\n\r\n  private state: ConnectionState = {\r\n    connection: window.navigator.onLine\r\n  };\r\n\r\n  constructor(\r\n    private messageService: MessageService,\r\n    private injector: Injector\r\n  ) {\r\n      this.checkNetworkState();\r\n  }\r\n\r\n  private checkNetworkState() {\r\n    this.onlineSubscription = fromEvent(window, 'online').subscribe(() => {\r\n      if (this.previousMessageId) {\r\n        this.messageService.remove(this.previousMessageId);\r\n      }\r\n      const translate = this.injector.get(LanguageService).translate;\r\n      const message = translate.instant('igo.core.network.online.message');\r\n      const title = translate.instant('igo.core.network.online.title');\r\n      const messageObj = this.messageService.info(message, title);\r\n      this.previousMessageId = messageObj.toastId;\r\n      this.state.connection = true;\r\n      this.emitEvent();\r\n    });\r\n\r\n    this.offlineSubscription = fromEvent(window, 'offline').subscribe(() => {\r\n      if (this.previousMessageId) {\r\n        this.messageService.remove(this.previousMessageId);\r\n      }\r\n      const translate = this.injector.get(LanguageService).translate;\r\n      const message = translate.instant('igo.core.network.offline.message');\r\n      const title = translate.instant('igo.core.network.offline.title');\r\n      const messageObj = this.messageService.info(message, title);\r\n      this.previousMessageId = messageObj.toastId;\r\n      this.state.connection = false;\r\n      this.emitEvent();\r\n    });\r\n  }\r\n\r\n  private emitEvent() {\r\n    this.stateChangeEventEmitter.emit(this.state);\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    try {\r\n      this.offlineSubscription.unsubscribe();\r\n      this.onlineSubscription.unsubscribe();\r\n    } catch (e) {}\r\n  }\r\n\r\n  currentState(reportState = true): Observable<ConnectionState> {\r\n    return reportState\r\n      ? this.stateChangeEventEmitter.pipe(\r\n          debounceTime(300),\r\n          startWith(this.state)\r\n        )\r\n      : this.stateChangeEventEmitter.pipe(debounceTime(300));\r\n  }\r\n}\r\n","export enum EntityOperationType {\r\n  Insert = 'Insert',\r\n  Update = 'Update',\r\n  Delete = 'Delete'\r\n}\r\n\r\nexport enum EntityTableColumnRenderer {\r\n  Default = 'Default',\r\n  HTML = 'HTML',\r\n  UnsanitizedHTML = 'UnsanitizedHTML',\r\n  Editable = 'Editable',\r\n  Icon = 'Icon',\r\n  ButtonGroup = 'ButtonGroup'\r\n}\r\n\r\nexport enum EntityTableScrollBehavior {\r\n  Auto = 'auto',\r\n  Instant = 'instant',\r\n  Smooth = 'smooth'\r\n}\r\n\r\nexport enum EntityTableSelectionState {\r\n  None = 'None',\r\n  All = 'All',\r\n  Some = 'Some'\r\n}\r\n","import t from 'typy';\r\n\r\nimport { EntityKey } from './entity.interfaces';\r\n\r\n/**\r\n * Get an entity's named property. Nested properties are supported\r\n * with the dotted notation. (i.e 'author.name')\r\n *\r\n * Note: this method is a 'best attempt' at getting an entity's property.\r\n * It fits the most common cases but you might need to explicitely define\r\n * a property getter when using an EntityStore, for example.\r\n * @param entity Entity\r\n * @param property Property name\r\n * @returns Property value\r\n */\r\nexport function getEntityProperty(entity: object, property: string): any {\r\n  return t(entity, property).safeObject;\r\n}\r\n\r\n/**\r\n * Get an entity's id. An entity's id can be one of:\r\n * 'entity.meta.id', 'entity.meta.idProperty' or 'entity.id'.\r\n *\r\n * Note: See the note in the 'getEntityProperty' documentation.\r\n * @param entity Entity\r\n * @returns Entity id\r\n */\r\nexport function getEntityId(entity: object): EntityKey {\r\n  const meta = (entity as any).meta || {};\r\n  return meta.id ? meta.id : getEntityProperty(entity, meta.idProperty || 'id');\r\n}\r\n\r\n/**\r\n * Get an entity's title. An entity's title can be one of:\r\n * 'entity.meta.title', 'entity.meta.titleProperty' or 'entity.title'.\r\n * @param entity Entity\r\n * @returns Entity title\r\n */\r\nexport function getEntityTitle(entity: object): string {\r\n  const meta = (entity as any).meta || {};\r\n  return meta.title ? meta.title : getEntityProperty(entity, meta.titleProperty || 'title');\r\n}\r\n\r\n/**\r\n * Get an entity's HTML title. An entity's HTML title can be one of:\r\n * 'entity.meta.titleHtml', 'entity.meta.titleHtmlProperty' or 'entity.titleHtml'.\r\n * @param entity Entity\r\n * @returns Entity HTML title\r\n */\r\nexport function getEntityTitleHtml(entity: object): string {\r\n  const meta = (entity as any).meta || {};\r\n  return meta.titleHtml ? meta.titleHtml : getEntityProperty(entity, meta.titleHtmlProperty || 'titleHtml');\r\n}\r\n\r\n/**\r\n * Get an entity's icon. An entity's icon can be one of:\r\n * 'entity.meta.icon', 'entity.meta.iconProperty' or 'entity.icon'.\r\n * @param entity Entity\r\n * @returns Entity icon\r\n */\r\nexport function getEntityIcon(entity: object): string {\r\n  const meta = (entity as any).meta || {};\r\n  return meta.icon ? meta.icon : getEntityProperty(entity, meta.iconProperty || 'icon');\r\n}\r\n\r\n/**\r\n * Get an entity's revision.\r\n * @param entity Entity\r\n * @returns Entity revision\r\n */\r\nexport function getEntityRevision(entity: object): number {\r\n  const meta = (entity as any).meta || {};\r\n  return meta.revision || 0;\r\n}\r\n","import { ReplaySubject } from 'rxjs';\r\n\r\nimport { EntityKey, EntityState, EntityStateManagerOptions } from './entity.interfaces';\r\nimport { getEntityId } from './entity.utils';\r\nimport { EntityStore } from './store';\r\n\r\n/**\r\n * This class is used to track a store's entities state\r\n */\r\nexport class EntityStateManager<E extends object, S extends EntityState = EntityState> {\r\n\r\n  /**\r\n   * State index\r\n   */\r\n  readonly index = new Map<EntityKey, S>();\r\n\r\n  /**\r\n   * Change emitter\r\n   */\r\n  readonly change$ = new ReplaySubject<void>(1);\r\n\r\n  /**\r\n   * Method to get an entity's id\r\n   */\r\n  readonly getKey: (E) => EntityKey;\r\n\r\n  private store: EntityStore<object> | undefined;\r\n\r\n  constructor(options: EntityStateManagerOptions = {}) {\r\n    this.store = options.store ? options.store : undefined;\r\n    this.getKey = options.getKey\r\n      ? options.getKey\r\n      : (this.store ? this.store.getKey : getEntityId);\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Clear state\r\n   */\r\n  clear() {\r\n    if (this.index.size > 0) {\r\n      this.index.clear();\r\n      this.next();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get an entity's state\r\n   * @param entity Entity\r\n   * @returns State\r\n   */\r\n  get(entity: E): S {\r\n    return (this.index.get(this.getKey(entity)) || {}) as S;\r\n  }\r\n\r\n  /**\r\n   * Set an entity's state\r\n   * @param entity Entity\r\n   * @param state State\r\n   */\r\n  set(entity: E, state: S) {\r\n    this.setMany([entity], state);\r\n  }\r\n\r\n  /**\r\n   * Set many entitie's state\r\n   * @param entitie Entities\r\n   * @param state State\r\n   */\r\n  setMany(entities: E[], state: S) {\r\n    entities.forEach((entity: E) => {\r\n      this.index.set(this.getKey(entity), Object.assign({}, state));\r\n    });\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Set state of all entities that already have a state. This is not\r\n   * the same as setting the state of all the store's entities.\r\n   * @param state State\r\n   */\r\n  setAll(state: S) {\r\n    Array.from(this.index.keys()).forEach((key: EntityKey) => {\r\n      this.index.set(key, Object.assign({}, state));\r\n    });\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Update an entity's state\r\n   * @param entity Entity\r\n   * @param changes State changes\r\n   */\r\n  update(entity: E, changes: Partial<S>, exclusive = false) {\r\n    this.updateMany([entity], changes, exclusive);\r\n  }\r\n\r\n  /**\r\n   * Update many entitie's state\r\n   * @param entitie Entities\r\n   * @param changes State changes\r\n   */\r\n  updateMany(entities: E[], changes: Partial<S>, exclusive = false) {\r\n    if (exclusive === true) {\r\n      return this.updateManyExclusive(entities, changes);\r\n    }\r\n\r\n    entities.forEach((entity: E) => {\r\n      const state = Object.assign({}, this.get(entity), changes);\r\n      this.index.set(this.getKey(entity), state);\r\n    });\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Reversee an entity's state\r\n   * @param entity Entity\r\n   * @param keys State keys to reverse\r\n   */\r\n  reverse(entity: E, keys: string[]) {\r\n    this.reverseMany([entity], keys);\r\n  }\r\n\r\n  /**\r\n   * Reverse many entitie's state\r\n   * @param entitie Entities\r\n   * @param keys State keys to reverse\r\n   */\r\n  reverseMany(entities: E[], keys: string[]) {\r\n    entities.forEach((entity: E) => {\r\n      const currentState = this.get(entity);\r\n      const changes = keys.reduce((acc: {[key: string]: boolean}, key: string) => {\r\n        acc[key] = currentState[key] || false;\r\n        return acc;\r\n      }, {}) as Partial<S>;\r\n      const reversedChanges = this.reverseChanges(changes);\r\n      const state = Object.assign({}, currentState, reversedChanges);\r\n      this.index.set(this.getKey(entity), state);\r\n    });\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Update state of all entities that already have a state. This is not\r\n   * the same as updating the state of all the store's entities.\r\n   * @param changes State\r\n   */\r\n  updateAll(changes: Partial<S>) {\r\n    const allKeys = this.getAllKeys();\r\n    Array.from(allKeys).forEach((key: EntityKey) => {\r\n      const state = Object.assign({}, this.index.get(key), changes);\r\n      this.index.set(key, state);\r\n    });\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * When some state changes are flagged as 'exclusive', reverse\r\n   * the state of all other entities. Changes are reversable when\r\n   * they are boolean.\r\n   * @param entitie Entities\r\n   * @param changes State changes\r\n   */\r\n  private updateManyExclusive(entities: E[], changes: Partial<S>) {\r\n    const reverseChanges = this.reverseChanges(changes);\r\n\r\n    const keys = entities.map((entity: E) => this.getKey(entity));\r\n    const allKeys = new Set(keys.concat(Array.from(this.getAllKeys())));\r\n    allKeys.forEach((key: EntityKey) => {\r\n      const state = this.index.get(key) || {} as S;\r\n\r\n      if (keys.indexOf(key) >= 0) {\r\n        this.index.set(key, Object.assign({}, state, changes));\r\n      } else {\r\n        // Update only if the reverse changes would modify\r\n        // a key already present in the current state\r\n        const shouldUpdate = Object.keys(reverseChanges).some((changeKey: string) => {\r\n          return state[changeKey] !== undefined &&\r\n            state[changeKey] !== reverseChanges[changeKey];\r\n        });\r\n        if (shouldUpdate === true) {\r\n          this.index.set(key, Object.assign({}, state, reverseChanges));\r\n        }\r\n      }\r\n    });\r\n\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Compute a 'reversed' version of some state changes.\r\n   * Changes are reversable when they are boolean.\r\n   * @param changes State changes\r\n   * @returns Reversed state changes\r\n   */\r\n  private reverseChanges(changes: Partial<S>): Partial<S> {\r\n    return Object.entries(changes).reduce((reverseChanges: Partial<S>, bunch: [string, any]) => {\r\n      const [changeKey, value] = bunch;\r\n      if (typeof value === typeof true) {\r\n        (reverseChanges as object)[changeKey] = !value;\r\n      }\r\n      return reverseChanges;\r\n    }, {});\r\n  }\r\n\r\n  /**\r\n   * Return all the keys in that state and in the store it's bound to, if any.\r\n   * @returns Set of keys\r\n   */\r\n  private getAllKeys(): Set<EntityKey> {\r\n    const storeKeys = this.store ? Array.from(this.store.index.keys()) : [];\r\n    return new Set(Array.from(this.index.keys()).concat(storeKeys));\r\n  }\r\n\r\n  /**\r\n   * Emit 'change' event\r\n   */\r\n  private next() {\r\n    this.change$.next();\r\n  }\r\n\r\n}\r\n","import { BehaviorSubject, Observable, Subscription, combineLatest } from 'rxjs';\r\nimport { debounceTime, map, skip } from 'rxjs/operators';\r\n\r\nimport { ObjectUtils, uuid } from '@igo2/utils';\r\nimport {\r\n  EntityKey,\r\n  EntityFilterClause,\r\n  EntitySortClause,\r\n  EntityJoinClause\r\n} from './entity.interfaces';\r\n\r\n/**\r\n * An entity view streams entities from an observable source. These entities\r\n * can be filtered or sorted without affecting the source. A view can also\r\n * combine data from multiple sources, joined together.\r\n */\r\nexport class EntityView<E extends object, V extends object = E> {\r\n\r\n  /**\r\n   * Observable stream of values\r\n   */\r\n  readonly values$ = new BehaviorSubject<V[]>([]);\r\n\r\n  /**\r\n   * Subscription to the source (and joined sources) values\r\n   */\r\n  private values$$: Subscription;\r\n\r\n  /**\r\n   * Whether this view has been lifted\r\n   */\r\n  private lifted = false;\r\n\r\n  /**\r\n   * Join clauses\r\n   */\r\n  private joins: EntityJoinClause[] = [];\r\n\r\n  /**\r\n   * Observable of a filter clause\r\n   */\r\n  private filter$ = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Observable of filter clauses\r\n   */\r\n  private filters$: BehaviorSubject<EntityFilterClause[]> = new BehaviorSubject([]);\r\n\r\n  /**\r\n   * Filters index\r\n   */\r\n  private filterIndex: Map<string, EntityFilterClause> = new Map();\r\n\r\n  /**\r\n   * Observable of a sort clause\r\n   */\r\n  private sort$ = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Method for indexing\r\n   */\r\n  get getKey(): (V) => EntityKey { return this.getKey$.value; }\r\n  private getKey$: BehaviorSubject<(V) => EntityKey> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Number of entities\r\n   */\r\n  readonly count$ = new BehaviorSubject<number>(0);\r\n  get count(): number { return this.count$.value; }\r\n\r\n  /**\r\n   * Whether the store is empty\r\n   */\r\n  readonly empty$ = new BehaviorSubject<boolean>(true);\r\n  get empty(): boolean { return this.empty$.value; }\r\n\r\n  /**\r\n   * Store index\r\n   */\r\n  get index(): Map<EntityKey, V> { return this._index; }\r\n  private _index: Map<EntityKey, V>;\r\n\r\n  constructor(private source$: BehaviorSubject<E[]>) {}\r\n\r\n  /**\r\n   * Get a value from the view by key\r\n   * @param key Key\r\n   * @returns Value\r\n   */\r\n  get(key: EntityKey): V {\r\n    if (this._index === undefined) {\r\n      throw new Error('This view has no index, therefore, this method is unavailable.');\r\n    }\r\n    return this.index.get(key);\r\n  }\r\n\r\n  /**\r\n   * Get all the values\r\n   * @returns Array of values\r\n   */\r\n  all(): V[] {\r\n    return this.values$.value;\r\n  }\r\n\r\n  /**\r\n   * Observe all the values\r\n   * @returns Observable of values\r\n   */\r\n  all$(): BehaviorSubject<V[]> {\r\n    return this.values$;\r\n  }\r\n\r\n  /**\r\n   * Get the first value that respects a criteria\r\n   * @returns A value\r\n   */\r\n  firstBy(clause: EntityFilterClause<V>): V {\r\n    return this.values$.value.find(clause);\r\n  }\r\n\r\n  /**\r\n   * Observe the first value that respects a criteria\r\n   * @returns Observable of a value\r\n   */\r\n  firstBy$(clause: EntityFilterClause<V>): Observable<V> {\r\n    return this.values$.pipe(map((values: V[]) => values.find(clause)));\r\n  }\r\n\r\n  /**\r\n   * Get all the values that respect a criteria\r\n   * @returns Array of values\r\n   */\r\n  manyBy(clause: EntityFilterClause<V>): V[] {\r\n    return this.values$.value.filter(clause);\r\n  }\r\n\r\n  /**\r\n   * Observe all the values that respect a criteria\r\n   * @returns Observable of values\r\n   */\r\n  manyBy$(clause: EntityFilterClause<V>): Observable<V[]> {\r\n    return this.values$.pipe(map((values: V[]) => values.filter(clause)));\r\n  }\r\n\r\n  /**\r\n   * Clear the filter and sort and unsubscribe from the source\r\n   */\r\n  clear() {\r\n    this.filter(undefined);\r\n    this.sort(undefined);\r\n  }\r\n\r\n  destroy() {\r\n    if (this.values$$ !== undefined) {\r\n      this.values$$.unsubscribe();\r\n    }\r\n    this.clear();\r\n  }\r\n\r\n  /**\r\n   * Create an index\r\n   * @param getKey Method to get a value's id\r\n   * @returns The view\r\n   */\r\n  createIndex(getKey: (E) => EntityKey): EntityView<E, V> {\r\n    this._index = new Map();\r\n    this.getKey$.next(getKey);\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Join another source to the stream (chainable)\r\n   * @param clause Join clause\r\n   * @returns The view\r\n   */\r\n  join(clause: EntityJoinClause): EntityView<E, V> {\r\n    if (this.lifted === true) {\r\n      throw new Error('This view has already been lifted, therefore, no join is allowed.');\r\n    }\r\n    this.joins.push(clause);\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Filter values (chainable)\r\n   * @param clause Filter clause\r\n   * @returns The view\r\n   */\r\n  filter(clause: EntityFilterClause<V>): EntityView<E, V> {\r\n    this.filter$.next(clause);\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * @param clause Filter clause\r\n   * @returns The filter id\r\n   */\r\n  addFilter(clause: EntityFilterClause<V>): string {\r\n    const id = uuid();\r\n    this.filterIndex.set(id, clause);\r\n    this.filters$.next(Array.from(this.filterIndex.values()));\r\n    return id;\r\n  }\r\n\r\n  /**\r\n   * Remove a filter by id\r\n   * @param clause Filter clause\r\n   */\r\n  removeFilter(id: string) {\r\n    this.filterIndex.delete(id);\r\n    this.filters$.next(Array.from(this.filterIndex.values()));\r\n  }\r\n\r\n  /**\r\n   * Sort values (chainable)\r\n   * @param clauseSort clause\r\n   * @returns The view\r\n   */\r\n  sort(clause: EntitySortClause<V>): EntityView<E, V> {\r\n    this.sort$.next(clause);\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Create the final observable\r\n   * @returns Observable\r\n   */\r\n  lift() {\r\n    this.lifted = true;\r\n    const source$ = this.joins.length > 0 ? this.liftJoinedSource() : this.liftSource();\r\n    const observables$ = [\r\n      source$,\r\n      this.filters$,\r\n      this.filter$,\r\n      this.sort$,\r\n      this.getKey$\r\n    ];\r\n\r\n    this.values$$ = combineLatest(observables$)\r\n      .pipe(skip(1), debounceTime(5))\r\n      .subscribe((bunch: [V[], EntityFilterClause[], EntityFilterClause, EntitySortClause, (V) => EntityKey]) => {\r\n        const [_values, filters, filter, sort, getKey] = bunch;\r\n        const values = this.processValues(_values, filters, filter, sort);\r\n        const generateIndex = getKey !== undefined;\r\n        this.setValues(values, generateIndex);\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Create the source observable when no joins are defined\r\n   * @returns Observable\r\n   */\r\n  private liftSource(): Observable<V[]> {\r\n    return this.source$ as any as Observable<V[]>;\r\n  }\r\n\r\n  /**\r\n   * Create the source observable when joins are defined\r\n   * @returns Observable\r\n   */\r\n  private liftJoinedSource(): Observable<V[]> {\r\n    const sources$ = [this.source$, combineLatest(\r\n      this.joins.map((join: EntityJoinClause) => join.source)\r\n    )];\r\n\r\n    return combineLatest(sources$)\r\n      .pipe(\r\n        map((bunch: [E[], any[]]) => {\r\n          const [entities, joinData] = bunch;\r\n          return entities.reduce((values: V[], entity: E) => {\r\n            const value = this.computeJoinedValue(entity, joinData);\r\n            if (value !== undefined) {\r\n              values.push(value);\r\n            }\r\n            return values;\r\n          }, []);\r\n        })\r\n      );\r\n  }\r\n\r\n  /**\r\n   * Apply joins to a source's entity and return the final value\r\n   * @returns Final value\r\n   */\r\n  private computeJoinedValue(entity: E, joinData: any[]): V | undefined {\r\n    let value = entity as Partial<V>;\r\n    let joinIndex = 0;\r\n    while (value !== undefined && joinIndex < this.joins.length) {\r\n      value = this.joins[joinIndex].reduce(value, joinData[joinIndex]);\r\n      joinIndex += 1;\r\n    }\r\n    return value as V;\r\n  }\r\n\r\n  /**\r\n   * Filter and sort values before streaming them\r\n   * @param values Values\r\n   * @param filters Filter clauses\r\n   * @param filter Filter clause\r\n   * @param sort Sort clause\r\n   * @returns Filtered and sorted values\r\n   */\r\n  private processValues(\r\n    values: V[], filters: EntityFilterClause[], filter: EntityFilterClause, sort: EntitySortClause\r\n  ): V[] {\r\n    values = values.slice(0);\r\n    values = this.filterValues(values, filters.concat([filter]));\r\n    values = this.sortValues(values, sort);\r\n    return values;\r\n  }\r\n\r\n  /**\r\n   * Filter values\r\n   * @param values Values\r\n   * @param filters Filter clauses\r\n   * @returns Filtered values\r\n   */\r\n  private filterValues(values: V[], clauses: EntityFilterClause[]): V[] {\r\n    if (clauses.length === 0) { return values; }\r\n\r\n    return values\r\n      .filter((value: V) => {\r\n        return clauses\r\n          .filter((clause: EntityFilterClause) => clause !== undefined)\r\n          .every((clause: EntityFilterClause) => clause(value));\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Sort values\r\n   * @param values Values\r\n   * @param sort Sort clause\r\n   * @returns Sorted values\r\n   */\r\n  private sortValues(values: V[], clause: EntitySortClause): V[] {\r\n    if (clause === undefined) { return values; }\r\n    return values.sort((v1: V, v2: V) => {\r\n      return ObjectUtils.naturalCompare(\r\n        clause.valueAccessor(v1),\r\n        clause.valueAccessor(v2),\r\n        clause.direction,\r\n        clause.nullsFirst\r\n      );\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Set value and optionally generate an index\r\n   * @param values Values\r\n   * @param generateIndex boolean\r\n   */\r\n  private setValues(values: V[], generateIndex: boolean) {\r\n    if (generateIndex === true) {\r\n      this._index = this.generateIndex(values);\r\n    }\r\n\r\n    this.values$.next(values);\r\n\r\n    const count = values.length;\r\n    const empty = count === 0;\r\n    this.count$.next(count);\r\n    this.empty$.next(empty);\r\n  }\r\n\r\n  /**\r\n   * Generate a complete index of all the values\r\n   * @param entities Entities\r\n   * @returns Index\r\n   */\r\n  private generateIndex(values: V[]): Map<EntityKey, V> {\r\n    const entries = values.map((value: V) => [this.getKey(value), value]);\r\n    return new Map(entries as [EntityKey, V][]);\r\n  }\r\n}\r\n","import { BehaviorSubject } from 'rxjs';\r\n\r\nimport { EntityStateManager } from './state';\r\nimport { EntityView } from './view';\r\nimport { EntityKey, EntityState, EntityRecord, EntityStoreOptions } from './entity.interfaces';\r\nimport { getEntityId, getEntityProperty } from './entity.utils';\r\nimport { EntityStoreStrategy } from './strategies/strategy';\r\n\r\n/**\r\n * An entity store class holds any number of entities\r\n * as well as their state. It can be observed, filtered and sorted and\r\n * provides methods to insert, update or delete entities.\r\n */\r\nexport class EntityStore<E extends object = object, S extends EntityState = EntityState> {\r\n\r\n  /**\r\n   * Observable of the raw entities\r\n   */\r\n  readonly entities$ = new BehaviorSubject<E[]>([]);\r\n\r\n  /**\r\n   * Number of entities\r\n   */\r\n  readonly count$ = new BehaviorSubject<number>(0);\r\n  get count(): number { return this.count$.value; }\r\n\r\n  /**\r\n   * Whether the store is empty\r\n   */\r\n  readonly empty$ = new BehaviorSubject<boolean>(true);\r\n  get empty(): boolean { return this.empty$.value; }\r\n\r\n  /**\r\n   * Entity store state\r\n   */\r\n  readonly state: EntityStateManager<E, S>;\r\n\r\n  /**\r\n   * View of all the entities\r\n   */\r\n  readonly view: EntityView<E>;\r\n\r\n  /**\r\n   * View of all the entities and their state\r\n   */\r\n  readonly stateView: EntityView<E, EntityRecord<E, S>>;\r\n\r\n  /**\r\n   * Method to get an entity's id\r\n   */\r\n  readonly getKey: (E) => EntityKey;\r\n\r\n  /**\r\n   * Method to get an entity's named property\r\n   */\r\n  readonly getProperty: (E, prop: string) => any;\r\n\r\n  /**\r\n   * Store index\r\n   */\r\n  get index(): Map<EntityKey, E> { return this._index; }\r\n  private _index: Map<EntityKey, E>;\r\n\r\n  /**\r\n   * Store index\r\n   */\r\n  get pristine(): boolean { return this._pristine; }\r\n  private _pristine: boolean = true;\r\n\r\n  /**\r\n   * Strategies\r\n   */\r\n  private strategies: EntityStoreStrategy[] = [];\r\n\r\n  constructor(entities: E[], options: EntityStoreOptions = {}) {\r\n    this.getKey = options.getKey ? options.getKey : getEntityId;\r\n    this.getProperty = options.getProperty ? options.getProperty : getEntityProperty;\r\n\r\n    this.state = this.createStateManager();\r\n    this.view = this.createDataView();\r\n    this.stateView = this.createStateView();\r\n\r\n    this.view.lift();\r\n    this.stateView.lift();\r\n\r\n    if (entities.length > 0) {\r\n      this.load(entities);\r\n    } else {\r\n      this._index = this.generateIndex(entities);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get an entity from the store by key\r\n   * @param key Key\r\n   * @returns Entity\r\n   */\r\n  get(key: EntityKey): E {\r\n    return this.index.get(key);\r\n  }\r\n\r\n  /**\r\n   * Get all entities in the store\r\n   * @returns Array of entities\r\n   */\r\n  all(): E[] {\r\n    return this.entities$.value;\r\n  }\r\n\r\n  /**\r\n   * Set this store's entities\r\n   * @param entities Entities\r\n   */\r\n  load(entities: E[], pristine: boolean = true) {\r\n    this._index = this.generateIndex(entities);\r\n    this._pristine = pristine;\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Clear the store's entities but keep the state and views intact.\r\n   * Views won't return any data but future data will be subject to the\r\n   * current views filter and sort\r\n   */\r\n  softClear() {\r\n    if (this.index && this.index.size > 0) {\r\n      this.index.clear();\r\n      this._pristine = true;\r\n      this.next();\r\n    } else if (this.index) {\r\n      this.updateCount();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the store's entities, state and views\r\n   */\r\n  clear() {\r\n    this.stateView.clear();\r\n    this.view.clear();\r\n    this.state.clear();\r\n    this.softClear();\r\n  }\r\n\r\n  destroy() {\r\n    this.stateView.destroy();\r\n    this.view.destroy();\r\n    this.clear();\r\n  }\r\n\r\n  /**\r\n   * Insert an entity into the store\r\n   * @param entity Entity\r\n   */\r\n  insert(entity: E) {\r\n    this.insertMany([entity]);\r\n  }\r\n\r\n  /**\r\n   * Insert many entities into the store\r\n   * @param entities Entities\r\n   */\r\n  insertMany(entities: E[]) {\r\n    entities.forEach((entity: E) => this.index.set(this.getKey(entity), entity));\r\n    this._pristine = false;\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Update or insert an entity into the store\r\n   * @param entity Entity\r\n   */\r\n  update(entity: E) {\r\n    this.updateMany([entity]);\r\n  }\r\n\r\n  /**\r\n   * Update or insert many entities into the store\r\n   * @param entities Entities\r\n   */\r\n  updateMany(entities: E[]) {\r\n    entities.forEach((entity: E) => this.index.set(this.getKey(entity), entity));\r\n    this._pristine = false;\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Delete an entity from the store\r\n   * @param entity Entity\r\n   */\r\n  delete(entity: E) {\r\n    this.deleteMany([entity]);\r\n  }\r\n\r\n  /**\r\n   * Delete many entities from the store\r\n   * @param entities Entities\r\n   */\r\n  deleteMany(entities: E[]) {\r\n    entities.forEach((entity: E) => this.index.delete(this.getKey(entity)));\r\n    this._pristine = false;\r\n    this.next();\r\n  }\r\n\r\n  /**\r\n   * Add a strategy to this store\r\n   * @param strategy Entity store strategy\r\n   * @returns Entity store\r\n   */\r\n  addStrategy(strategy: EntityStoreStrategy, activate: boolean = false): EntityStore {\r\n    const existingStrategy = this.strategies.find((_strategy: EntityStoreStrategy) => {\r\n      return strategy.constructor === _strategy.constructor;\r\n    });\r\n    if (existingStrategy !== undefined) {\r\n      throw new Error('A strategy of this type already exists on that EntityStore.');\r\n    }\r\n\r\n    this.strategies.push(strategy);\r\n    strategy.bindStore(this);\r\n\r\n    if (activate === true) {\r\n      strategy.activate();\r\n    }\r\n\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Remove a strategy from this store\r\n   * @param strategy Entity store strategy\r\n   * @returns Entity store\r\n   */\r\n  removeStrategy(strategy: EntityStoreStrategy): EntityStore {\r\n    const index = this.strategies.indexOf(strategy);\r\n    if (index >= 0) {\r\n      this.strategies.splice(index, 1);\r\n      strategy.unbindStore(this);\r\n    }\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Return strategies of a given type\r\n   * @param type Entity store strategy class\r\n   * @returns Strategies\r\n   */\r\n  getStrategyOfType(type: typeof EntityStoreStrategy): EntityStoreStrategy {\r\n    return this.strategies.find((strategy: EntityStoreStrategy) => {\r\n      return strategy instanceof type;\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Activate strategies of a given type\r\n   * @param type Entity store strategy class\r\n   */\r\n  activateStrategyOfType(type: typeof EntityStoreStrategy) {\r\n    const strategy = this.getStrategyOfType(type);\r\n    if (strategy !== undefined) {\r\n      strategy.activate();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Deactivate strategies of a given type\r\n   * @param type Entity store strategy class\r\n   */\r\n  deactivateStrategyOfType(type: typeof EntityStoreStrategy) {\r\n    const strategy = this.getStrategyOfType(type);\r\n    if (strategy !== undefined) {\r\n      strategy.deactivate();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Generate a complete index of all the entities\r\n   * @param entities Entities\r\n   * @returns Index\r\n   */\r\n  private generateIndex(entities: E[]): Map<EntityKey, E> {\r\n    const entries = entities.map((entity: E) => [this.getKey(entity), entity]);\r\n    return new Map(entries as [EntityKey, E][]);\r\n  }\r\n\r\n  /**\r\n   * Push the index's entities into the entities$ observable\r\n   */\r\n  private next() {\r\n    this.entities$.next(Array.from(this.index.values()));\r\n    this.updateCount();\r\n  }\r\n\r\n  /**\r\n   * Update the store's count and empty\r\n   */\r\n  private updateCount() {\r\n    const count = this.index.size;\r\n    const empty = count === 0;\r\n    this.count$.next(count);\r\n    this.empty$.next(empty);\r\n  }\r\n\r\n  /**\r\n   * Create the entity state manager\r\n   * @returns EntityStateManager\r\n   */\r\n  private createStateManager() {\r\n    return new EntityStateManager<E, S>({store: this});\r\n  }\r\n\r\n  /**\r\n   * Create the data view\r\n   * @returns EntityView<E>\r\n   */\r\n  private createDataView() {\r\n    return new EntityView<E>(this.entities$);\r\n  }\r\n\r\n  /**\r\n   * Create the state view\r\n   * @returns EntityView<EntityRecord<E>>\r\n   */\r\n  private createStateView() {\r\n    return new EntityView<E, EntityRecord<E, S>>(this.view.all$())\r\n      .join({\r\n        source: this.state.change$,\r\n        reduce: (entity: E): EntityRecord<E, S> => {\r\n          const key = this.getKey(entity);\r\n          const state = this.state.get(entity);\r\n          const currentRecord = this.stateView.get(key);\r\n\r\n          if (\r\n            currentRecord !== undefined &&\r\n            currentRecord.entity === entity &&\r\n            this.statesAreTheSame(currentRecord.state, state)\r\n          ) {\r\n            return currentRecord;\r\n          }\r\n\r\n          const revision = currentRecord ? currentRecord.revision + 1 : 1;\r\n          const ref = `${key}-${revision}`;\r\n          return {entity, state, revision, ref};\r\n        }\r\n      })\r\n      .createIndex((record: EntityRecord<E, S>) => this.getKey(record.entity));\r\n  }\r\n\r\n  private statesAreTheSame(currentState: S, newState: S): boolean {\r\n    if (currentState === newState) {\r\n      return true;\r\n    }\r\n\r\n    const currentStateIsEmpty = Object.keys(currentState).length === 0;\r\n    const newStateIsEmpty = Object.keys(newState).length === 0;\r\n    return currentStateIsEmpty && newStateIsEmpty;\r\n  }\r\n\r\n}\r\n","import { ChangeDetectorRef } from '@angular/core';\r\n\r\nimport { Subscription } from 'rxjs';\r\nimport { skip } from 'rxjs/operators';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\nimport { EntityKey } from './entity.interfaces';\r\n\r\nimport { EntityStore } from './store';\r\n\r\n/**\r\n * This class is used to synchronize a component's changes\r\n * detection with an EntityStore changes. For example, it is frequent\r\n * to have a component subscribe to a store's selected entity and, at the same time,\r\n * this component provides a way to select an entity with, let's say, a click.\r\n *\r\n * This class automatically handles those case and triggers the compoent's\r\n * change detection when needed.\r\n *\r\n * Note: If the component observes the store's stateView, a workspace is\r\n * probably not required because the stateView catches any changes to the\r\n * entities and their state.\r\n */\r\nexport class EntityStoreWatcher<E extends object> {\r\n\r\n  /**\r\n   * Component change detector\r\n   */\r\n  private cdRef: ChangeDetectorRef;\r\n\r\n  /**\r\n   * Entity store\r\n   */\r\n  private store: EntityStore<E>;\r\n\r\n  /**\r\n   * Component inner state\r\n   */\r\n  private innerStateIndex = new Map<EntityKey, {[key: string]: any}>();\r\n\r\n  /**\r\n   * Subscription to the store's entities\r\n   */\r\n  private entities$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to the store's state\r\n   */\r\n  private state$$: Subscription;\r\n\r\n  constructor(store?: EntityStore<E>, cdRef?: ChangeDetectorRef) {\r\n    this.setChangeDetector(cdRef);\r\n    this.setStore(store);\r\n  }\r\n\r\n  destroy() {\r\n    this.setChangeDetector(undefined);\r\n    this.setStore(undefined);\r\n  }\r\n\r\n  /**\r\n   * Bind this workspace to a store and start watching for changes\r\n   * @param store Entity store\r\n   */\r\n  setStore(store?: EntityStore<E>) {\r\n    if (store === undefined) {\r\n      this.teardownObservers();\r\n      this.innerStateIndex.clear();\r\n      this.store = undefined;\r\n      return;\r\n    }\r\n\r\n    this.setStore(undefined);\r\n    this.store = store;\r\n    this.setupObservers();\r\n    this.detectChanges();\r\n  }\r\n\r\n  /**\r\n   * Bind this workspace to a component's change detector\r\n   * @param cdRef Change detector\r\n   */\r\n  setChangeDetector(cdRef?: ChangeDetectorRef) {\r\n    this.cdRef = cdRef;\r\n  }\r\n\r\n  /**\r\n   * Set up observers on a store's entities and their state\r\n   * @param store Entity store\r\n   */\r\n  private setupObservers() {\r\n    this.teardownObservers();\r\n\r\n    this.entities$$ = this.store.entities$\r\n      .subscribe((entities: E[]) => this.onEntitiesChange(entities));\r\n\r\n    this.state$$ = this.store.state.change$\r\n      .pipe(skip(1))\r\n      .subscribe(() => this.onStateChange());\r\n  }\r\n\r\n  /**\r\n   * Teardown store observers\r\n   */\r\n  private teardownObservers() {\r\n    if (this.entities$$ !== undefined) {\r\n      this.entities$$.unsubscribe();\r\n    }\r\n    if (this.state$$ !== undefined) {\r\n      this.state$$.unsubscribe();\r\n    }\r\n    this.entities$$ = undefined;\r\n    this.state$$ = undefined;\r\n  }\r\n\r\n  /**\r\n   * When the entities change, always trigger the changes detection\r\n   */\r\n  private onEntitiesChange(entities: E[]) {\r\n    this.detectChanges();\r\n  }\r\n\r\n  /**\r\n   * When the entities state change, trigger the change detection\r\n   * only if the component has not handled these changes yet. For example,\r\n   * the component might have initiated thoses changes itself.\r\n   */\r\n  private onStateChange() {\r\n    let changesDetected = false;\r\n    const storeIndex = this.store.state.index;\r\n    const innerIndex = this.innerStateIndex;\r\n\r\n    if (storeIndex.size !== innerIndex.size) {\r\n      changesDetected = this.detectChanges();\r\n    }\r\n\r\n    const storeKeys = Array.from(storeIndex.keys());\r\n    for (const key of storeKeys) {\r\n      const storeValue = storeIndex.get(key);\r\n      const innerValue = innerIndex.get(key);\r\n      if (changesDetected === false) {\r\n        if (innerValue === undefined) {\r\n          changesDetected = this.detectChanges();\r\n        } else if (!ObjectUtils.objectsAreEquivalent(storeValue, innerValue)) {\r\n          changesDetected = this.detectChanges();\r\n        }\r\n      }\r\n\r\n      this.innerStateIndex.set(key, Object.assign({}, storeValue));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Trigger the change detection of the workspace is bound to a change detector\r\n   */\r\n  private detectChanges() {\r\n    if (this.cdRef !== undefined) {\r\n      this.cdRef.detectChanges();\r\n    }\r\n    return true;\r\n  }\r\n\r\n}\r\n","import { BehaviorSubject } from 'rxjs';\r\n\r\nimport { EntityStoreStrategyOptions } from '../entity.interfaces';\r\nimport { EntityStore } from '../store';\r\n\r\n/**\r\n * Entity store strategies. They can do pretty much anything during a store's\r\n * lifetime. For example, they may act as triggers when something happens.\r\n * Sharing a strategy is a good idea when multiple strategies would have\r\n * on cancelling effect on each other.\r\n *\r\n * At creation, strategy is inactive and needs to be manually activated.\r\n */\r\nexport class EntityStoreStrategy {\r\n\r\n  /**\r\n   * Feature store\r\n   * @internal\r\n   */\r\n  protected stores: EntityStore[] = [];\r\n\r\n  /**\r\n   * Whether this strategy is active\r\n   * @internal\r\n   */\r\n  get active(): boolean { return this.active$.value; }\r\n  readonly active$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  constructor(protected options: EntityStoreStrategyOptions = {}) {\r\n    this.options = options;\r\n  }\r\n\r\n  /**\r\n   * Activate the strategy. If it's already active, it'll be deactivated\r\n   * and activated again.\r\n   */\r\n  activate() {\r\n    if (this.active === true) {\r\n      this.doDeactivate();\r\n    }\r\n    this.active$.next(true);\r\n    this.doActivate();\r\n  }\r\n\r\n  /**\r\n   * Activate the strategy. If it's already active, it'll be deactivated\r\n   * and activated again.\r\n   */\r\n  deactivate() {\r\n    this.active$.next(false);\r\n    this.doDeactivate();\r\n  }\r\n\r\n  /**\r\n   * Bind this strategy to a store\r\n   * @param store Feature store\r\n   */\r\n  bindStore(store: EntityStore) {\r\n    if (this.stores.indexOf(store) < 0) {\r\n      this.stores.push(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from store\r\n   * @param store Feature store\r\n   */\r\n  unbindStore(store: EntityStore) {\r\n    const index = this.stores.indexOf(store);\r\n    if (index >= 0) {\r\n      this.stores.splice(index, 1);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Do the stataegy activation\r\n   * @internal\r\n   */\r\n  protected doActivate() {}\r\n\r\n  /**\r\n   * Do the strategy deactivation\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {}\r\n\r\n}\r\n","import { EntityStoreStrategyFuncOptions } from '../entity.interfaces';\r\nimport { EntityStore } from '../store';\r\nimport { EntityStoreStrategy } from './strategy';\r\n\r\n/**\r\n * When active, this strategy filters a store's stateView to return\r\n * selected entities only.\r\n */\r\nexport class EntityStoreFilterCustomFuncStrategy extends EntityStoreStrategy {\r\n\r\n  constructor(protected options: EntityStoreStrategyFuncOptions) {\r\n    super(options);\r\n  }\r\n\r\n  /**\r\n   * Store / filter ids map\r\n   */\r\n  private filters: Map<EntityStore, string> = new Map();\r\n\r\n  /**\r\n   * Bind this strategy to a store and start filtering it\r\n   * @param store Entity store\r\n   */\r\n  bindStore(store: EntityStore) {\r\n    super.bindStore(store);\r\n    if (this.active === true) {\r\n      this.filterStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from a store and stop filtering it\r\n   * @param store Entity store\r\n   */\r\n  unbindStore(store: EntityStore) {\r\n    super.unbindStore(store);\r\n    if (this.active === true) {\r\n      this.unfilterStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start filtering all stores\r\n   * @internal\r\n   */\r\n  protected doActivate() {\r\n    this.filterAll();\r\n  }\r\n\r\n  /**\r\n   * Stop filtering all stores\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {\r\n    this.unfilterAll();\r\n  }\r\n\r\n  /**\r\n   * Filter all stores\r\n   */\r\n  private filterAll() {\r\n    this.stores.forEach((store: EntityStore) => this.filterStore(store));\r\n  }\r\n\r\n  /**\r\n   * Unfilter all stores\r\n   */\r\n  private unfilterAll() {\r\n    this.stores.forEach((store: EntityStore) => this.unfilterStore(store));\r\n  }\r\n\r\n  /**\r\n   * Filter a store and add it to the filters map\r\n   */\r\n  private filterStore(store: EntityStore) {\r\n    this.filters.set(store, store.stateView.addFilter(this.options.filterClauseFunc));\r\n  }\r\n\r\n  /**\r\n   * Unfilter a store and delete it from the filters map\r\n   */\r\n  private unfilterStore(store: EntityStore) {\r\n    const filterId = this.filters.get(store);\r\n    if (filterId === undefined) {\r\n      return;\r\n    }\r\n\r\n    store.stateView.removeFilter(filterId);\r\n    this.filters.delete(store);\r\n  }\r\n}\r\n","import { EntityRecord } from '../entity.interfaces';\r\nimport { EntityStore } from '../store';\r\nimport { EntityStoreStrategy } from './strategy';\r\n\r\n/**\r\n * When active, this strategy filters a store's stateView to return\r\n * selected entities only.\r\n */\r\nexport class EntityStoreFilterSelectionStrategy extends EntityStoreStrategy {\r\n\r\n  /**\r\n   * Store / filter ids map\r\n   */\r\n  private filters: Map<EntityStore, string> = new Map();\r\n\r\n  /**\r\n   * Bind this strategy to a store and start filtering it\r\n   * @param store Entity store\r\n   */\r\n  bindStore(store: EntityStore) {\r\n    super.bindStore(store);\r\n    if (this.active === true) {\r\n      this.filterStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from a store and stop filtering it\r\n   * @param store Entity store\r\n   */\r\n  unbindStore(store: EntityStore) {\r\n    super.unbindStore(store);\r\n    if (this.active === true) {\r\n      this.unfilterStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start filtering all stores\r\n   * @internal\r\n   */\r\n  protected doActivate() {\r\n    this.filterAll();\r\n  }\r\n\r\n  /**\r\n   * Stop filtering all stores\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {\r\n    this.unfilterAll();\r\n  }\r\n\r\n  /**\r\n   * Filter all stores\r\n   */\r\n  private filterAll() {\r\n    this.stores.forEach((store: EntityStore) => this.filterStore(store));\r\n  }\r\n\r\n  /**\r\n   * Unfilter all stores\r\n   */\r\n  private unfilterAll() {\r\n    this.stores.forEach((store: EntityStore) => this.unfilterStore(store));\r\n  }\r\n\r\n  /**\r\n   * Filter a store and add it to the filters map\r\n   */\r\n  private filterStore(store: EntityStore) {\r\n    if (this.filters.has(store)) {\r\n      return;\r\n    }\r\n\r\n    const filter = (record: EntityRecord<object>) => {\r\n      return record.state.selected === true;\r\n    };\r\n    this.filters.set(store, store.stateView.addFilter(filter));\r\n  }\r\n\r\n  /**\r\n   * Unfilter a store and delete it from the filters map\r\n   */\r\n  private unfilterStore(store: EntityStore) {\r\n    const filterId = this.filters.get(store);\r\n    if (filterId === undefined) {\r\n      return;\r\n    }\r\n\r\n    store.stateView.removeFilter(filterId);\r\n    this.filters.delete(store);\r\n  }\r\n}\r\n","<mat-form-field class=\"igo-entity-selector\">\r\n  <mat-select\r\n    [disabled]=\"disabled\"\r\n    [value]=\"selected$ | async\"\r\n    [multiple]=\"multi\"\r\n    [placeholder]=\"placeholder\"\r\n    (selectionChange)=\"onSelectionChange($event)\">\r\n    <mat-option *ngIf=\"emptyText !== undefined && multi === false\" [value]=\"emptyValue\">{{emptyText}}</mat-option>\r\n    <mat-option *ngIf=\"multi === true\" [value]=\"multiSelectValue\">{{multiText$ | async}}</mat-option>\r\n    <ng-template ngFor let-record [ngForOf]=\"store.stateView.all$() | async\">\r\n      <mat-option [value]=\"record.entity\">\r\n        {{titleAccessor(record.entity)}}\r\n      </mat-option>\r\n    </ng-template>\r\n  </mat-select>\r\n</mat-form-field>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\nimport { EntityRecord } from '../shared/entity.interfaces';\r\nimport { EntityStore } from '../shared/store';\r\nimport { EntityStoreWatcher } from '../shared/watcher';\r\nimport { getEntityTitle } from '../shared/entity.utils';\r\n\r\n@Component({\r\n  selector: 'igo-entity-selector',\r\n  templateUrl: './entity-selector.component.html',\r\n  styleUrls: ['./entity-selector.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class EntitySelectorComponent implements OnInit, OnDestroy {\r\n\r\n  /**\r\n   * The selected entity\r\n   * @internal\r\n   */\r\n  readonly selected$ = new BehaviorSubject<object>(undefined);\r\n\r\n  /**\r\n   * The current multi select option text\r\n   * @internal\r\n   */\r\n  readonly multiText$ = new BehaviorSubject<string>(undefined);\r\n\r\n  readonly multiSelectValue = {id: 'IGO_MULTI_SELECT'};\r\n\r\n  readonly emptyValue = {id: 'IGO_EMPTY_SELECT'};\r\n\r\n  /**\r\n   * Subscription to the selected entity\r\n   */\r\n  private selected$$: Subscription;\r\n\r\n  /**\r\n   * Store watcher\r\n   */\r\n  private watcher: EntityStoreWatcher<object>;\r\n\r\n  /**\r\n   * Entity store\r\n   */\r\n  @Input() store: EntityStore<object>;\r\n\r\n  /**\r\n   * Title accessor\r\n   */\r\n  @Input() titleAccessor: (object) => string = getEntityTitle;\r\n\r\n  /**\r\n   * Text to display when nothing is selected\r\n   */\r\n  @Input() emptyText: string = undefined;\r\n\r\n  /**\r\n   * Wheter selecting many entities is allowed\r\n   */\r\n  @Input() multi: boolean = false;\r\n\r\n  /**\r\n   * Text to display for the select all option\r\n   */\r\n  @Input() multiAllText: string = 'All';\r\n\r\n  /**\r\n   * Text to display for the select none option\r\n   */\r\n  @Input() multiNoneText: string = 'None';\r\n\r\n  /**\r\n   * Field placeholder\r\n   */\r\n  @Input() placeholder: string;\r\n\r\n  /**\r\n   * Wheter the selector is disabled or not\r\n   */\r\n  @Input() disabled: boolean = false;\r\n\r\n  /**\r\n   * Event emitted when the selection changes\r\n   */\r\n  @Output() selectedChange = new EventEmitter<{\r\n    selected: boolean;\r\n    value: object | object[];\r\n  }>();\r\n\r\n  constructor(private cdRef: ChangeDetectorRef) {}\r\n\r\n  /**\r\n   * Create a store watcher and subscribe to the selected entity\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.watcher = new EntityStoreWatcher(this.store, this.cdRef);\r\n\r\n    this.selected$$ = this.store.stateView\r\n      .manyBy$((record: EntityRecord<object>) => record.state.selected === true)\r\n      .subscribe((records: EntityRecord<object>[]) => {\r\n        const entities = records.map((record: EntityRecord<object>) => record.entity);\r\n        this.onSelectFromStore(entities);\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to the selected entity and destroy the store watcher\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.watcher.destroy();\r\n    this.selected$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * On selection change, update the store's state and emit an event\r\n   * @internal\r\n   */\r\n  onSelectionChange(event: {value: object | undefined}) {\r\n    const values = event.value instanceof Array ? event.value : [event.value];\r\n\r\n    const multiSelect = values.find((_value: object) => _value === this.multiSelectValue);\r\n    let entities = values.filter((_value: object) => _value !== this.multiSelectValue);\r\n    if (multiSelect !== undefined) {\r\n      if (entities.length === this.store.count) {\r\n        entities = [];\r\n      } else if (entities.length < this.store.count) {\r\n        entities = this.store.all();\r\n      }\r\n    }\r\n\r\n    entities = entities.filter((entity: object) => entity !== this.emptyValue);\r\n    if (entities.length === 0) {\r\n      this.store.state.updateAll({selected: false});\r\n    } else {\r\n      this.store.state.updateMany(entities, {selected: true}, true);\r\n    }\r\n\r\n    const value = this.multi ? entities : event.value;\r\n    this.selectedChange.emit({selected: true, value});\r\n  }\r\n\r\n  private onSelectFromStore(entities: object[]) {\r\n    if (this.multi === true) {\r\n      this.selected$.next(entities);\r\n    } else {\r\n      const entity = entities.length > 0 ? entities[0] : undefined;\r\n      this.selected$.next(entity);\r\n    }\r\n\r\n    this.updateMultiToggleWithEntities(entities);\r\n  }\r\n\r\n  private updateMultiToggleWithEntities(entities: object[]) {\r\n    if (entities.length === this.store.count && this.multiText$.value !== this.multiNoneText) {\r\n      this.multiText$.next(this.multiNoneText);\r\n    } else if (entities.length < this.store.count && this.multiText$.value !== this.multiAllText) {\r\n      this.multiText$.next(this.multiAllText);\r\n    }\r\n  }\r\n\r\n}\r\n","import { Directive, HostListener } from '@angular/core';\r\n\r\n@Directive({\r\n  selector: '[igoStopPropagation]'\r\n})\r\nexport class StopPropagationDirective {\r\n  @HostListener('click', ['$event'])\r\n  public onClick(event: any): void {\r\n    event.stopPropagation();\r\n  }\r\n}\r\n","import {\r\n  Directive,\r\n  Input,\r\n  ElementRef,\r\n  Renderer2,\r\n  EventEmitter,\r\n  Output,\r\n  HostListener\r\n} from '@angular/core';\r\n\r\nimport scrollIntoView from 'scroll-into-view-if-needed';\r\n\r\nimport { EntityTableScrollBehavior } from '../shared/entity.enums';\r\n\r\n/**\r\n * Directive that handles an entity table row click and selection.\r\n */\r\n@Directive({\r\n  selector: '[igoEntityTableRow]'\r\n})\r\nexport class EntityTableRowDirective {\r\n\r\n  /**\r\n   * Class added to a selected row\r\n   */\r\n  static selectedCls = 'igo-entity-table-row-selected';\r\n\r\n  /**\r\n   * Class added to a highlighted row\r\n   */\r\n  static highlightedCls = 'igo-entity-table-row-highlighted';\r\n\r\n  /**\r\n   * Whether a row supports selection\r\n   */\r\n  @Input() selection = false;\r\n\r\n  /**\r\n   * Whether clicking a row should select it (if selection is true)\r\n   */\r\n  @Input() selectOnClick: boolean = true;\r\n\r\n  /**\r\n   * Whether the selected row should be highlighted\r\n   */\r\n  @Input() highlightSelection: boolean = true;\r\n\r\n  /**\r\n   * Whether a row is selected\r\n   */\r\n  @Input()\r\n  set selected(value: boolean) {\r\n    if (this.selection === false) { return; }\r\n    if (value === this._selected) { return; }\r\n\r\n    this.toggleSelected(value);\r\n    this.scroll();\r\n  }\r\n  get selected(): boolean {\r\n    return this._selected;\r\n  }\r\n  private _selected = false;\r\n\r\n  /**\r\n   * Scroll behavior on selection\r\n   */\r\n  @Input()\r\n  scrollBehavior: EntityTableScrollBehavior = EntityTableScrollBehavior.Auto;\r\n\r\n  /**\r\n   * Event emitted when a row is selected\r\n   */\r\n  @Output() select = new EventEmitter<EntityTableRowDirective>();\r\n\r\n  /**\r\n   * When a row is clicked, select it if it's supported\r\n   * @ignore\r\n   */\r\n  @HostListener('click')\r\n  onClick() {\r\n    if (this.selection === false || this.selectOnClick === false) {\r\n      return;\r\n    }\r\n\r\n    this.toggleSelected(true);\r\n    this.select.emit(this);\r\n  }\r\n\r\n  constructor(private renderer: Renderer2, private el: ElementRef) {}\r\n\r\n  /**\r\n   * Select a row and add or remove the selected class from it\r\n   * @param selected Whether the row should be selected\r\n   */\r\n  private toggleSelected(selected: boolean) {\r\n    this._selected = selected;\r\n    if (selected === true) {\r\n      this.addCls(EntityTableRowDirective.selectedCls);\r\n      if (this.highlightSelection === true) {\r\n        this.addCls(EntityTableRowDirective.highlightedCls);\r\n      }\r\n    } else {\r\n      this.removeCls(EntityTableRowDirective.selectedCls);\r\n      this.removeCls(EntityTableRowDirective.highlightedCls);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Scroll to the selected row\r\n   */\r\n  private scroll() {\r\n    if (this._selected === true) {\r\n      scrollIntoView(this.el.nativeElement, {\r\n        scrollMode: 'if-needed',\r\n        behavior: 'smooth',\r\n        block: 'end',\r\n        inline: 'nearest'\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add the selected CSS class\r\n   */\r\n  private addCls(cls: string) {\r\n    this.renderer.addClass(this.el.nativeElement, cls);\r\n  }\r\n\r\n  /**\r\n   * Remove the selected CSS class\r\n   */\r\n  private removeCls(cls: string) {\r\n    this.renderer.removeClass(this.el.nativeElement, cls);\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  OnChanges,\r\n  ViewChild,\r\n  Output,\r\n  EventEmitter,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport {\r\n  EntityStore\r\n} from '../shared';\r\nimport { MatPaginator, PageEvent } from '@angular/material/paginator';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport { LanguageService, MediaService } from '@igo2/core';\r\nimport { EntityTablePaginatorOptions } from './entity-table-paginator.interface';\r\n\r\n@Component({\r\n  selector: 'igo-entity-table-paginator',\r\n  templateUrl: './entity-table-paginator.component.html',\r\n  styleUrls: ['./entity-table-paginator.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class EntityTablePaginatorComponent implements OnChanges, OnDestroy {\r\n\r\n  public disabled: boolean = false;\r\n  public hidePageSize: boolean = false;\r\n  public pageIndex: number = 0;\r\n  public pageSize: number = 50;\r\n  public pageSizeOptions: number[] = [5, 10, 20, 50, 100, 200];\r\n  public showFirstLastButtons: boolean = true;\r\n  private count$$: Subscription;\r\n  private entitySortChange$$: Subscription;\r\n  private paginationLabelTranslation$$: Subscription[] = [];\r\n\r\n  @Input() entitySortChange$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  /**\r\n   * Entity store\r\n   */\r\n  @Input() store: EntityStore<object>;\r\n\r\n  /**\r\n   * Paginator options\r\n   */\r\n  @Input()\r\n  paginatorOptions: EntityTablePaginatorOptions;\r\n\r\n  /**\r\n   * Event emitted when the paginator changes the page size or page index.\r\n   */\r\n  @Output() page: EventEmitter<PageEvent>;\r\n\r\n  public length: number = 0;\r\n\r\n  /**\r\n   * Paginator emitted.\r\n   */\r\n  @Output() paginatorChange: EventEmitter<MatPaginator> = new EventEmitter<MatPaginator>();\r\n\r\n  constructor(private languageService: LanguageService, private mediaService: MediaService) {}\r\n\r\n  @ViewChild(MatPaginator, { static: true }) paginator: MatPaginator;\r\n\r\n  ngOnChanges() {\r\n    this.unsubscribeAll();\r\n    this.count$$ = this.store.stateView.count$.subscribe((count) => {\r\n      this.length = count;\r\n      this.emitPaginator();\r\n    });\r\n    this.entitySortChange$$ = this.entitySortChange$.subscribe(() => {\r\n      if (this.paginator) {\r\n        this.paginator.firstPage();\r\n      }\r\n    });\r\n    this.initPaginatorOptions();\r\n    this.translateLabels();\r\n  }\r\n\r\n  initPaginatorOptions() {\r\n    this.disabled = this.paginatorOptions?.disabled || this.disabled;\r\n    this.pageIndex = this.paginatorOptions?.pageIndex || this.pageIndex;\r\n    this.pageSize = this.paginatorOptions?.pageSize || this.pageSize;\r\n    this.pageSizeOptions = this.paginatorOptions?.pageSizeOptions || this.pageSizeOptions;\r\n    if (this.mediaService.isMobile()) {\r\n      this.showFirstLastButtons = false;\r\n      this.hidePageSize = true;\r\n    } else {\r\n      this.showFirstLastButtons = this.paginatorOptions?.showFirstLastButtons || this.showFirstLastButtons;\r\n      this.hidePageSize = this.paginatorOptions?.hidePageSize || this.hidePageSize;\r\n    }\r\n  }\r\n\r\n  translateLabels() {\r\n\r\n    this.paginationLabelTranslation$$.push(\r\n      this.languageService.translate.get('igo.common.paginator.firstPageLabel').subscribe((label: string) => {\r\n        this.paginator._intl.firstPageLabel = label;\r\n      }));\r\n\r\n    this.paginator._intl.getRangeLabel = this.rangeLabel;\r\n\r\n    this.paginationLabelTranslation$$.push(\r\n      this.languageService.translate.get('igo.common.paginator.itemsPerPageLabel').subscribe((label: string) => {\r\n        this.paginator._intl.itemsPerPageLabel = label;\r\n      }));\r\n    this.paginationLabelTranslation$$.push(\r\n      this.languageService.translate.get('igo.common.paginator.lastPageLabel').subscribe((label: string) => {\r\n        this.paginator._intl.lastPageLabel = label;\r\n      }));\r\n    this.paginationLabelTranslation$$.push(\r\n      this.languageService.translate.get('igo.common.paginator.nextPageLabel').subscribe((label: string) => {\r\n        this.paginator._intl.nextPageLabel = label;\r\n      }));\r\n    this.paginationLabelTranslation$$.push(\r\n      this.languageService.translate.get('igo.common.paginator.previousPageLabel').subscribe((label: string) => {\r\n        this.paginator._intl.previousPageLabel = label;\r\n      }));\r\n  }\r\n\r\n  rangeLabel = (page: number, pageSize: number, length: number) => {\r\n    const of: BehaviorSubject<string> = new BehaviorSubject('');\r\n\r\n    this.paginationLabelTranslation$$.push(\r\n      this.languageService.translate.get('igo.common.paginator.of').subscribe((label: string) => {\r\n        of.next(label);\r\n      }));\r\n    if (length === 0 || pageSize === 0) { return `0 ${of.value} ${length}`; }\r\n    length = Math.max(length, 0);\r\n    const startIndex = page * pageSize;\r\n    const endIndex = startIndex < length ?\r\n        Math.min(startIndex + pageSize, length) :\r\n        startIndex + pageSize;\r\n    return `${startIndex + 1} - ${endIndex} ${of.value} ${length}`;\r\n  }\r\n\r\n  private unsubscribeAll() {\r\n    this.paginationLabelTranslation$$.map(sub => sub.unsubscribe());\r\n    if (this.count$$) { this.count$$.unsubscribe(); }\r\n    if (this.entitySortChange$$) { this.entitySortChange$$.unsubscribe(); }\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this.unsubscribeAll();\r\n  }\r\n\r\n  emitPaginator() {\r\n    this.paginatorChange.emit(this.paginator);\r\n  }\r\n}\r\n","<mat-paginator \r\n  [disabled]=\"disabled\"\r\n  [hidePageSize]=\"hidePageSize\"\r\n  [length]=\"length\"\r\n  [pageIndex]=\"pageIndex\"\r\n  [pageSize]=\"pageSize\"\r\n  [pageSizeOptions]=\"pageSizeOptions\"\r\n  [showFirstLastButtons]=\"showFirstLastButtons\"\r\n  (page)=\"emitPaginator()\">\r\n</mat-paginator>\r\n","import { Pipe, PipeTransform } from '@angular/core';\r\nimport { HttpClient, HttpHeaders } from '@angular/common/http';\r\n\r\nimport { Cacheable } from 'ts-cacheable';\r\nimport { Observable } from 'rxjs';\r\nimport { switchMap } from 'rxjs/operators';\r\nimport { ConfigService } from '@igo2/core';\r\n\r\n@Pipe({\r\n  name: 'secureImage'\r\n})\r\nexport class SecureImagePipe implements PipeTransform {\r\n  constructor(\r\n    private http: HttpClient,\r\n    private configService?: ConfigService) {}\r\n\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  transform(url: string): Observable<string> {\r\n    const headers = new HttpHeaders({\r\n      'Content-Type': 'text/plain',\r\n      activityInterceptor: 'false'\r\n    });\r\n\r\n    const regexDepot = new RegExp(this.configService?.getConfig('depot.url') + '.*?(?=\"|$)');\r\n    if (regexDepot.test(url)) {\r\n      url = url.match(regexDepot)[0];\r\n    }\r\n\r\n    return this.http\r\n      .get(url, {\r\n        headers,\r\n        responseType: 'blob'\r\n      })\r\n      .pipe(\r\n        switchMap((blob) => {\r\n          return new Observable((observer) => {\r\n            const reader = new FileReader();\r\n            reader.readAsDataURL(blob);\r\n            reader.onloadend = () => {\r\n              observer.next(reader.result);\r\n              observer.complete();\r\n            };\r\n          });\r\n        })\r\n      ) as Observable<string>;\r\n  }\r\n}\r\n","import { Pipe, PipeTransform } from '@angular/core';\r\nimport { DomSanitizer, SafeHtml } from '@angular/platform-browser';\r\n\r\n@Pipe({ name: 'sanitizeHtml' })\r\nexport class SanitizeHtmlPipe implements PipeTransform {\r\n  constructor(private _sanitizer: DomSanitizer) {\r\n  }\r\n  transform(v: string): SafeHtml {\r\n    return this._sanitizer.bypassSecurityTrustHtml(v);\r\n  }\r\n}\r\n","<div class=\"table-container\">\r\n  <table mat-table matSort [ngClass]=\"getTableClass()\" [dataSource]=\"dataSource\" [trackBy]=\"getTrackByFunction()\" (matSortChange)=\"onSort($event)\">\r\n      <ng-container matColumnDef=\"selectionCheckbox\" class=\"mat-cell-checkbox\">\r\n          <th mat-header-cell *matHeaderCellDef>\r\n              <ng-container *ngIf=\"selectMany\">\r\n                  <ng-container *ngIf=\"selectionState$ | async as selectionState\">\r\n                      <mat-checkbox (change)=\"onToggleRows($event.checked)\" [checked]=\"selectionState === entityTableSelectionState.All\"\r\n                      [indeterminate]=\"selectionState === entityTableSelectionState.Some\">\r\n                      </mat-checkbox>\r\n                  </ng-container>\r\n              </ng-container>\r\n          </th>\r\n          <td mat-cell *matCellDef=\"let record\">\r\n              <mat-checkbox (mousedown)=\"$event.shiftKey ? $event.preventDefault() : null\" (click)=\"$event.shiftKey ?\r\n              onShiftToggleRow(!rowIsSelected(record), record, $event) : $event.stopPropagation()\" (change)=\"onToggleRow($event.checked,record)\"\r\n              [checked]=\"rowIsSelected(record)\">\r\n              </mat-checkbox>\r\n          </td>\r\n      </ng-container>\r\n\r\n      <ng-container [matColumnDef]=\"column.name\" *ngFor=\"let column of template.columns\">\r\n          <ng-container *ngIf=\"columnIsSortable(column)\">\r\n              <th mat-header-cell *matHeaderCellDef mat-sort-header [matTooltip]=\"column.tooltip ? column.tooltip : undefined\">\r\n                  {{column.title}}\r\n              </th>\r\n          </ng-container>\r\n\r\n          <ng-container *ngIf=\"!columnIsSortable(column)\">\r\n              <th mat-header-cell *matHeaderCellDef [matTooltip]=\"column.tooltip ? column.tooltip : undefined\">\r\n                  {{column.title}}\r\n              </th>\r\n          </ng-container>\r\n\r\n          <ng-container *ngIf=\"getColumnRenderer(column) as columnRenderer\">\r\n              <ng-container *ngIf=\"columnRenderer === entityTableColumnRenderer.Default\">\r\n                  <ng-container *matCellDef=\"let record\">\r\n                      <td mat-cell class=\"mat-cell-text\" *ngIf=\"!isUrl(getValue(record, column));else isAnUrlDefault\" [ngClass]=\"getCellClass(record, column)\">\r\n                          {{getValue(record, column)}}\r\n                      </td>\r\n                      <ng-template #isAnUrlDefault>\r\n                          <td mat-cell class=\"mat-cell-text\" [ngClass]=\"getCellClass(record, column)\">\r\n                              <a href=\"{{getValue(record, column)}}\" target='_blank' rel=\"noopener noreferrer\" (click)=\"$event.stopPropagation()\">\r\n                                  <img *ngIf=\"isImg(getValue(record, column));else notImg\" src=\"{{(getValue(record, column) | secureImage) | async}}\" width=\"50\" heigth=\"auto\">\r\n                                  <ng-template #notImg><span>{{\r\n                    'igo.common.entity-table.targetHtmlUrl' | translate }}\r\n                  </span></ng-template>\r\n                              </a>\r\n                          </td>\r\n                      </ng-template>\r\n                  </ng-container>\r\n              </ng-container>\r\n              <ng-container *ngIf=\"columnRenderer === entityTableColumnRenderer.HTML\">\r\n                  <ng-container *matCellDef=\"let record\">\r\n                      <td mat-cell class=\"mat-cell-text\" *ngIf=\"!isUrl(getValue(record, column));else isAnUrlHTML\" [ngClass]=\"getCellClass(record, column)\"\r\n                      [innerHTML]=\"getValue(record, column)\">\r\n                      </td>\r\n                      <ng-template #isAnUrlHTML>\r\n                          <td mat-cell class=\"mat-cell-text\" [ngClass]=\"getCellClass(record, column)\">\r\n                              <a href=\"{{getValue(record, column)}}\" target='_blank' rel=\"noopener noreferrer\" (click)=\"$event.stopPropagation()\">\r\n                                  <img *ngIf=\"isImg(getValue(record, column));else notImg\" src=\"{{(getValue(record, column) | secureImage) | async}}\" width=\"50\" heigth=\"auto\">\r\n                                  <ng-template #notImg><span>{{ 'igo.geo.targetHtmlUrl' |\r\n                    translate }} </span></ng-template>\r\n                              </a>\r\n                          </td>\r\n                      </ng-template>\r\n                  </ng-container>\r\n              </ng-container>\r\n              <ng-container *ngIf=\"columnRenderer === entityTableColumnRenderer.UnsanitizedHTML\">\r\n                  <ng-container *matCellDef=\"let record\">\r\n                      <td mat-cell class=\"mat-cell-text edition\" [formGroup]=\"formGroup\" *ngIf=\"isEdition(record);else isUnsanitizedHTML\"\r\n                      [ngClass]=\"getCellClass(record, column)\">\r\n                          <div class=\"date-picker\" *ngIf=\"column.type === 'date'\">\r\n                              <mat-datepicker-toggle matSuffix [for]=\"picker\"></mat-datepicker-toggle>\r\n                              <input matInput [matDatepicker]=\"picker\" [formControlName]=\"column.name\" value=\"{{getValue(record, column)}}\"\r\n                              (dateChange)=\"onDateChange(column.name, record, $event)\">\r\n                              <mat-datepicker #picker></mat-datepicker>\r\n                          </div>\r\n                          <input matInput type=\"time\" *ngIf=\"column.type === 'time'\" [formControlName]=\"column.name\" step=\"900\" (focus)=\"column.onFocus($event)\"\r\n                          (keypress)=\"column.onChange($event)\" (blur)=\"column.onBlur($event)\">\r\n                          <input matInput type=\"number\" class=\"class_number_edition\" *ngIf=\"column.type === 'number'\" [formControlName]=\"column.name\" step=\"{{column.step}}\"\r\n                          value=\"{{getValue(record,column)}}\" (input)=\"onValueChange(column.name, record, $event)\"\r\n                          readonly=\"{{getValidationAttributeValue(column, 'readonly')}}\" required=\"{{getValidationAttributeValue(column, 'mandatory')}}\"\r\n                          min=\"{{getValidationAttributeValue(column, 'minValue')}}\" max=\"{{getValidationAttributeValue(column, 'maxValue')}}\">\r\n                          <input matInput type=\"text\" *ngIf=\"!column.type || column.type ==='string'\" [formControlName]=\"column.name\"\r\n                          value=\"{{getValue(record, column)}}\" (input)=\"onValueChange(column.name, record, $event)\"\r\n                          readonly=\"{{getValidationAttributeValue(column, 'readonly')}}\" required=\"{{getValidationAttributeValue(column, 'mandatory')}}\">\r\n                          <mat-checkbox *ngIf=\"column.type === 'boolean'\" [formControlName]=\"column.name\" [checked]=\"getValue(record,column)\"\r\n                          (change)=\"onBooleanValueChange(column.name, record,$event)\"></mat-checkbox>\r\n                          <mat-select *ngIf=\"column.type === 'list'\" required=\"{{getValidationAttributeValue(column, 'mandatory')}}\"\r\n                          [formControlName]=\"column.name\" [multiple]=\"column.multiple\" (selectionChange)=\"onSelectValueChange(column.name, record, $event)\"\r\n                          [value]=\"getValue(record, column)\">\r\n                              <mat-option *ngFor=\"let option of column.domainValues\" [value]=\"option.id\" [disabled]=\"option.disabled\">\r\n                                  {{ option.value }}\r\n                              </mat-option>\r\n                          </mat-select>\r\n                          <input matInput type=\"text\" [formControlName]=\"column.name\" *ngIf=\"column.type === 'autocomplete'\"\r\n                          [matAutocomplete]=\"auto\" required=\"{{getValidationAttributeValue(column, 'mandatory')}}\" value=\"{{getValue(record, column)}}\">\r\n                              <mat-autocomplete #auto=\"matAutocomplete\" (optionSelected)=\"onAutocompleteValueChange(column.name, record, $event)\"\r\n                              panelWidth=\"430px\">\r\n                                  <mat-option *ngFor=\"let option of filteredOptions | async\" [value]=\"option.id\">\r\n                                      {{ option.value }}\r\n                                  </mat-option>\r\n                              </mat-autocomplete>\r\n                      </td>\r\n                      <ng-template #isUnsanitizedHTML>\r\n                          <td mat-cell class=\"mat-cell-text\" *ngIf=\"!isUrl(getValue(record, column));else isAnUrlUnsanitizedHTML\" [ngClass]=\"getCellClass(record, column)\"\r\n                          [innerHTML]=\"getValue(record, column) | sanitizeHtml\">\r\n                          </td>\r\n                          <ng-template #isAnUrlUnsanitizedHTML>\r\n                              <td mat-cell class=\"mat-cell-text\" [ngClass]=\"getCellClass(record, column)\">\r\n                                  <a href=\"{{getValue(record, column)}}\" target='_blank' rel=\"noopener noreferrer\" (click)=\"$event.stopPropagation()\">\r\n                                      <img *ngIf=\"isImg(getValue(record, column));else notImg\" src=\"{{(getValue(record, column) | secureImage) | async}}\" width=\"50\" heigth=\"auto\">\r\n                                      <ng-template #notImg><span>{{ 'igo.geo.targetHtmlUrl' | translate }} </span></ng-template>\r\n                                  </a>\r\n                              </td>\r\n                          </ng-template>\r\n                      </ng-template>\r\n                  </ng-container>\r\n              </ng-container>\r\n              <ng-container *ngIf=\"columnRenderer === entityTableColumnRenderer.Icon\">\r\n                  <td mat-cell *matCellDef=\"let record\" class=\"mat-cell-text\" [ngClass]=\"getCellClass(record, column)\">\r\n                      <mat-icon svgIcon=\"{{getValue(record, column)|| column.icon}}\" (click)=\"column.onClick($event)\"></mat-icon>\r\n                  </td>\r\n              </ng-container>\r\n              <ng-container *ngIf=\"columnRenderer === entityTableColumnRenderer.ButtonGroup\">\r\n                  <ng-container *matCellDef=\"let record\">\r\n                      <td mat-cell class=\"mat-cell-text\" [ngClass]=\"getCellClass(record, column)\">\r\n                          <span *ngFor=\"let button of getValue(record, column)\">\r\n                              <ng-container *ngIf=\"isEdition(record) === button.editMode\">\r\n                                  <button *ngIf=\"button.style === 'mat-icon-button'\" igoStopPropagation mat-icon-button\r\n                                      [color]=\"button.color\" (mousedown)=\"onButtonClick(button.click, record)\" [disabled]=\"button.disabled\">\r\n                                      <mat-icon svgIcon=\"{{button.icon}}\"></mat-icon>\r\n                                  </button>\r\n                                  <button *ngIf=\"button.style !== 'mat-icon-button'\" igoStopPropagation mat-mini-fab\r\n                                      [color]=\"button.color\" (mousedown)=\"onButtonClick(button.click, record)\" [disabled]=\"button.disabled\">\r\n                                      <mat-icon svgIcon=\"{{button.icon}}\"></mat-icon>\r\n                                  </button>\r\n                              </ng-container>\r\n                          </span>\r\n                      </td>\r\n                  </ng-container>\r\n              </ng-container>\r\n          </ng-container>\r\n      </ng-container>\r\n\r\n      <tr mat-header-row *matHeaderRowDef=\"headers; sticky: fixedHeader;\" [ngClass]=\"getHeaderClass()\">\r\n      </tr>\r\n      <tr mat-row igoEntityTableRow *matRowDef=\"let record; columns: headers;\" [scrollBehavior]=\"scrollBehavior\" [ngClass]=\"getRowClass(record)\" [selection]=\"selection\" [selected]=\"rowIsSelected(record)\" (select)=\"onRowSelect(record)\" (click)=\"onRowClick(record)\">\r\n      </tr>\r\n  </table>\r\n  <igo-entity-table-paginator *ngIf=\"withPaginator\" [store]=\"store\" [paginatorOptions]=\"paginatorOptions\" [entitySortChange$]=\"entitySortChange$\" (paginatorChange)=\"paginatorChange($event)\">\r\n  </igo-entity-table-paginator>\r\n</div>","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef,\r\n  OnInit,\r\n  OnDestroy,\r\n  OnChanges,\r\n  SimpleChanges,\r\n  ElementRef,\r\n  Optional,\r\n  Self\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject, Observable, Subscription } from 'rxjs';\r\n\r\nimport {\r\n  EntityKey,\r\n  EntityRecord,\r\n  EntityState,\r\n  EntityStore,\r\n  EntityTableTemplate,\r\n  EntityTableColumn,\r\n  EntityTableColumnRenderer,\r\n  EntityTableSelectionState,\r\n  EntityTableScrollBehavior\r\n} from '../shared';\r\nimport { MatPaginator } from '@angular/material/paginator';\r\nimport { MatTableDataSource } from '@angular/material/table';\r\nimport { EntityTablePaginatorOptions } from '../entity-table-paginator/entity-table-paginator.interface';\r\nimport { MatFormFieldControl } from '@angular/material/form-field';\r\nimport { FormBuilder, NgControl, NgForm, FormControlName, FormGroup } from '@angular/forms';\r\nimport { FocusMonitor } from '@angular/cdk/a11y';\r\nimport { DateAdapter, ErrorStateMatcher } from '@angular/material/core';\r\nimport { map } from 'rxjs/operators';\r\nimport * as moment_ from 'moment';\r\nconst moment = moment_;\r\n\r\n@Component({\r\n  selector: 'igo-entity-table',\r\n  templateUrl: './entity-table.component.html',\r\n  styleUrls: ['./entity-table.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush,\r\n  providers: [{ provide: MatFormFieldControl, useExisting: EntityTableComponent }]\r\n})\r\nexport class EntityTableComponent implements OnInit, OnChanges, OnDestroy {\r\n\r\n  entitySortChange$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  public formGroup: FormGroup = new FormGroup({});\r\n\r\n  public filteredOptions: Observable<any[]>;\r\n\r\n  /**\r\n   * Reference to the column renderer types\r\n   * @internal\r\n   */\r\n  entityTableColumnRenderer = EntityTableColumnRenderer;\r\n\r\n  /**\r\n   * Reference to the selection's state\r\n   * @internal\r\n   */\r\n  entityTableSelectionState = EntityTableSelectionState;\r\n\r\n  /**\r\n   * Observable of the selection,s state\r\n   * @internal\r\n   */\r\n  readonly selectionState$: BehaviorSubject<EntityTableSelectionState> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Subscription to the store's selection\r\n   */\r\n  private selection$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to the dataSource\r\n   */\r\n  private dataSource$$: Subscription;\r\n\r\n  /**\r\n   * The last record checked. Useful for selecting\r\n   * multiple records by holding the shift key and checking\r\n   * checkboxes.\r\n   */\r\n  private lastRecordCheckedKey: EntityKey;\r\n\r\n  /**\r\n   * Entity store\r\n   */\r\n  @Input() store: EntityStore<object>;\r\n\r\n  /**\r\n   * Table paginator\r\n   */\r\n  @Input() set paginator(value: MatPaginator) {\r\n    this._paginator = value;\r\n    this.dataSource.paginator = value;\r\n  }\r\n\r\n  get paginator(): MatPaginator {\r\n    return this._paginator;\r\n  }\r\n  private _paginator: MatPaginator;\r\n\r\n  /**\r\n   * Table template\r\n   */\r\n  @Input() template: EntityTableTemplate;\r\n\r\n  /**\r\n   * Scroll behavior on selection\r\n   */\r\n  @Input()\r\n  scrollBehavior: EntityTableScrollBehavior = EntityTableScrollBehavior.Auto;\r\n\r\n  /**\r\n   * Whether nulls should be first when sorting\r\n   */\r\n  @Input()\r\n  sortNullsFirst: boolean = false;\r\n\r\n  /**\r\n   * Show the table paginator or not. False by default.\r\n   */\r\n  @Input()\r\n  withPaginator: boolean = false;\r\n\r\n  /**\r\n   * Paginator options\r\n   */\r\n  @Input()\r\n  paginatorOptions: EntityTablePaginatorOptions;\r\n\r\n  /**\r\n   * Event emitted when an entity (row) is clicked\r\n   */\r\n  @Output() entityClick = new EventEmitter<object>();\r\n\r\n  /**\r\n   * Event emitted when an entity (row) is selected\r\n   */\r\n  @Output() entitySelectChange = new EventEmitter<{\r\n    added: object[];\r\n  }>();\r\n\r\n  /**\r\n   * Event emitted when the table sort is changed.\r\n   */\r\n  @Output() entitySortChange: EventEmitter<{column: EntityTableColumn, direction: string}> = new EventEmitter(undefined);\r\n\r\n  /**\r\n   * Table headers\r\n   * @internal\r\n   */\r\n  get headers(): string[] {\r\n    let columns = this.template.columns\r\n      .filter((column: EntityTableColumn) => column.visible !== false)\r\n      .map((column: EntityTableColumn) => column.name);\r\n\r\n    if (this.selectionCheckbox === true) {\r\n      columns = ['selectionCheckbox'].concat(columns);\r\n    }\r\n\r\n    return columns;\r\n  }\r\n\r\n  /**\r\n   * Data source consumable by the underlying material table\r\n   * @internal\r\n   */\r\n  dataSource = new MatTableDataSource<object>();\r\n\r\n  /**\r\n   * Whether selection is supported\r\n   * @internal\r\n   */\r\n  get selection(): boolean { return this.template.selection || false; }\r\n\r\n  /**\r\n   * Whether a selection checkbox should be displayed\r\n   * @internal\r\n   */\r\n  get selectionCheckbox(): boolean { return this.template.selectionCheckbox || false; }\r\n\r\n  /**\r\n   * Whether selection many entities should eb supported\r\n   * @internal\r\n   */\r\n  get selectMany(): boolean { return this.template.selectMany || false; }\r\n\r\n  /**\r\n   * Whether selection many entities should eb supported\r\n   * @internal\r\n   */\r\n  get fixedHeader(): boolean { return this.template.fixedHeader === undefined ? true : this.template.fixedHeader; }\r\n\r\n  constructor(private cdRef: ChangeDetectorRef,\r\n    private formBuilder: FormBuilder,\r\n    protected _focusMonitor: FocusMonitor,\r\n    protected _elementRef: ElementRef<HTMLElement>,\r\n    @Optional() @Self() public ngControl: NgControl,\r\n    @Optional() protected _parentForm: NgForm,\r\n    @Optional() protected _controlName: FormControlName,\r\n    protected _defaultErrorStateMatcher: ErrorStateMatcher,\r\n    private dateAdapter: DateAdapter<Date>\r\n  ) {\r\n    this.dateAdapter.setLocale('fr-CA');\r\n  }\r\n\r\n  /**\r\n   * Track the selection state to properly display the selection checkboxes\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.handleDatasource();\r\n    this.dataSource.paginator = this.paginator;\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnChanges(changes: SimpleChanges) {\r\n    const store = changes.store;\r\n    if (store && store.currentValue !== store.previousValue) {\r\n      this.handleDatasource();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Process text or number value change (edition)\r\n   */\r\n  onValueChange(column: string, record: EntityRecord<any>, event) {\r\n    const key = this.getColumnKeyWithoutPropertiesTag(column);\r\n    record.entity.properties[key] = event.target.value;\r\n  }\r\n\r\n  /**\r\n   * Process boolean value change (edition)\r\n   */\r\n  onBooleanValueChange(column: string, record: EntityRecord<any>, event) {\r\n    const key = this.getColumnKeyWithoutPropertiesTag(column);\r\n    record.entity.properties[key] = event.checked;\r\n  }\r\n\r\n  /**\r\n   * Process select value change (edition)\r\n   */\r\n  onSelectValueChange(column: string, record: EntityRecord<any>, event) {\r\n    const key = this.getColumnKeyWithoutPropertiesTag(column);\r\n    record.entity.properties[key] = event.value;\r\n  }\r\n\r\n  /**\r\n   * Process autocomplete value change (edition)\r\n   */\r\n  onAutocompleteValueChange(column: string, record: EntityRecord<any>, event) {\r\n    this.formGroup.controls[column].setValue(event.option.viewValue);\r\n    const key = this.getColumnKeyWithoutPropertiesTag(column);\r\n    record.entity.properties[key] = event.option.value;\r\n  }\r\n\r\n  /**\r\n   * Process date value change (edition)\r\n   */\r\n  onDateChange(column: string, record: EntityRecord<any>, event) {\r\n    const format = \"YYYY-MM-DD\";\r\n    const value = moment(event.value).format(format);\r\n    const key = this.getColumnKeyWithoutPropertiesTag(column);\r\n    record.entity.properties[key] = value;\r\n  }\r\n\r\n  /**\r\n   * Enable edition mode for one row\r\n   * More than one row can be edited at the same time\r\n   */\r\n  private enableEdit(record: EntityRecord<any>) {\r\n    const item = record.entity.properties || record.entity;\r\n    this.template.columns.forEach(column => {\r\n      column.title = column.validation?.mandatory && !column.title.includes('*') ? column.title + ' *' : column.title;\r\n\r\n      const key = this.getColumnKeyWithoutPropertiesTag(column.name);\r\n      if (column.type === 'boolean') {\r\n        if (!item[key] || item[key] === null) {\r\n          item[key] = false;\r\n        } else if (typeof item[key] === 'string') {\r\n          item[key] = JSON.parse(item[key].toLowerCase());\r\n        }\r\n        this.formGroup.setControl(column.name, this.formBuilder.control(\r\n          item[key]\r\n        ));\r\n      } else if (column.type === 'list') {\r\n        if (column.multiple) {\r\n          this.formGroup.setControl(column.name, this.formBuilder.control(\r\n            [item[key]]\r\n          ));\r\n        } else {\r\n          this.formGroup.setControl(column.name, this.formBuilder.control(\r\n            item[key]\r\n          ));\r\n\r\n          typeof item[key] === 'string' ?\r\n            this.formGroup.controls[column.name].setValue(parseInt(item[key])) :\r\n            this.formGroup.controls[column.name].setValue(item[key]);\r\n        }\r\n      } else if (column.type === 'autocomplete') {\r\n        this.formGroup.setControl(column.name, this.formBuilder.control(\r\n          item[key]\r\n        ));\r\n\r\n        this.filteredOptions = this.formGroup.controls[column.name].valueChanges.pipe(\r\n          map(value => {\r\n            if (value.length) {\r\n              return column.domainValues.filter((option) => {\r\n                const filterNormalized = value ? value.toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g, '') : '';\r\n                const featureNameNormalized = option.value.toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n                return featureNameNormalized.includes(filterNormalized);\r\n              });\r\n            }\r\n          })\r\n        );\r\n\r\n        let formControlValue = item[key];\r\n        column.domainValues.forEach(option => {\r\n          if (typeof formControlValue === 'string' && /^\\d+$/.test(formControlValue)) {\r\n            formControlValue = parseInt(formControlValue);\r\n          }\r\n          if (option.value === formControlValue || option.id === formControlValue) {\r\n            formControlValue = option.value;\r\n          }\r\n        });\r\n\r\n        this.formGroup.controls[column.name].setValue(formControlValue);\r\n        if (this.isEdition(record) && column.linkColumnForce) {\r\n          const entity = record.entity as any;\r\n          this.formGroup.controls[column.name].setValue(\r\n            entity?.properties[this.getColumnKeyWithoutPropertiesTag(column.linkColumnForce)]\r\n          );\r\n        }\r\n      } else if (column.type === 'date') {\r\n        if (column.visible) {\r\n          if (item[key]) {\r\n            let date = moment(item[key]);\r\n            item[key] = date.utc().format('YYYY-MM-DD');\r\n            this.formGroup.setControl(column.name, this.formBuilder.control(\r\n              item[key]\r\n            ));\r\n          } else {\r\n            const newKey = this.getColumnKeyWithoutPropertiesTag(column.name);\r\n            record.entity.properties[newKey] = null;\r\n            this.formGroup.setControl(column.name, this.formBuilder.control(\r\n              null\r\n            ));\r\n          }\r\n        }\r\n      } else {\r\n        this.formGroup.setControl(column.name, this.formBuilder.control(\r\n          item[key]\r\n        ));\r\n      }\r\n\r\n      if (this.formGroup.controls[column.name] && this.getValidationAttributeValue(column, 'readonly')) {\r\n        this.formGroup.controls[column.name].disable();\r\n      }\r\n    });\r\n  }\r\n\r\n  private handleDatasource() {\r\n    this.unsubscribeStore();\r\n    this.selection$$ = this.store.stateView\r\n      .manyBy$((record: EntityRecord<object>) => record.state.selected === true)\r\n      .subscribe((records: EntityRecord<object>[]) => {\r\n        const firstSelected = records[0];\r\n        const firstSelectedStateviewPosition = this.store.stateView.all().indexOf(firstSelected);\r\n        const pageMax = this.paginator ? this.paginator.pageSize * (this.paginator.pageIndex + 1) : 0;\r\n        const pageMin = this.paginator ? pageMax - this.paginator.pageSize : 0;\r\n\r\n        if (\r\n          this.paginator &&\r\n          (firstSelectedStateviewPosition < pageMin ||\r\n          firstSelectedStateviewPosition >= pageMax)) {\r\n          const pageToReach = Math.floor(firstSelectedStateviewPosition / this.paginator.pageSize);\r\n          this.dataSource.paginator.pageIndex = pageToReach;\r\n        }\r\n        this.selectionState$.next(this.computeSelectionState(records));\r\n      });\r\n    this.dataSource$$ = this.store.stateView.all$().subscribe((all) => {\r\n      if (all[0]) {\r\n        this.enableEdit(all[0]);\r\n      }\r\n      this.dataSource.data = all;\r\n    });\r\n\r\n  }\r\n\r\n  /**\r\n   * Unbind the store watcher\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.unsubscribeStore();\r\n  }\r\n\r\n  private unsubscribeStore() {\r\n    if (this.selection$$) {\r\n      this.selection$$.unsubscribe();\r\n    }\r\n    if (this.dataSource$$) {\r\n      this.dataSource$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Trackby function\r\n   * @param record Record\r\n   * @param index Record index\r\n   * @internal\r\n   */\r\n  getTrackByFunction() {\r\n    return (index: number, record: EntityRecord<object, EntityState>) => {\r\n      return record.ref;\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Trigger a refresh of thre table. This can be useful when\r\n   * the data source doesn't emit a new value but for some reason\r\n   * the records need an update.\r\n   * @internal\r\n   */\r\n  refresh() {\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n  paginatorChange(event: MatPaginator) {\r\n    this.paginator = event;\r\n  }\r\n\r\n  /**\r\n   * On sort, sort the store\r\n   * @param event Sort event\r\n   * @internal\r\n   */\r\n  onSort(event: {active: string, direction: string}) {\r\n    const direction = event.direction;\r\n    const column = this.template.columns\r\n      .find((c: EntityTableColumn) => c.name === event.active);\r\n\r\n    if (direction === 'asc' || direction === 'desc') {\r\n      this.store.stateView.sort({\r\n        valueAccessor: (record: EntityRecord<object>) => this.getValue(record, column),\r\n        direction,\r\n        nullsFirst: this.sortNullsFirst\r\n      });\r\n      this.entitySortChange.emit({column, direction});\r\n      this.entitySortChange$.next(true);\r\n    } else {\r\n      this.store.stateView.sort(undefined);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * When an entity is clicked, emit an event\r\n   * @param record Record\r\n   * @internal\r\n   */\r\n  onRowClick(record: EntityRecord<object>) {\r\n    this.lastRecordCheckedKey = this.store.stateView.getKey(record);\r\n    this.entityClick.emit(record.entity);\r\n  }\r\n\r\n  /**\r\n   * When an entity is selected, select it in the store and emit an event. Even if\r\n   * \"many\" is set to true, this method always select a single, exclusive row. Selecting\r\n   * multiple rows should be achieved by using the checkboxes.\r\n   * @param record Record\r\n   * @internal\r\n   */\r\n  onRowSelect(record: EntityRecord<object>) {\r\n    if (this.selection === false) { return; }\r\n\r\n    const entity = record.entity;\r\n    this.store.state.update(entity, {selected: true}, true);\r\n    this.entitySelectChange.emit({added: [entity]});\r\n  }\r\n\r\n  /**\r\n   * Select or unselect all rows at once. On select, emit an event.\r\n   * @param toggle Select or unselect\r\n   * @internal\r\n   */\r\n  onToggleRows(toggle: boolean) {\r\n    if (this.selection === false) { return; }\r\n\r\n    this.store.state.updateAll({selected: toggle});\r\n    if (toggle === true) {\r\n      const entities = this.store.stateView\r\n        .all()\r\n        .map((record: EntityRecord<object>) => record.entity);\r\n      this.entitySelectChange.emit({added: [entities]});\r\n    }\r\n  }\r\n\r\n  /**\r\n   * When an entity is toggled, select or unselect it in the store. On select,\r\n   * emit an event.\r\n   * @param toggle Select or unselect\r\n   * @param record Record\r\n   * @internal\r\n   */\r\n  onToggleRow(toggle: boolean, record: EntityRecord<object>) {\r\n    if (this.selection === false) { return; }\r\n\r\n    const entity = record.entity;\r\n    const exclusive = toggle === true && !this.selectMany;\r\n    this.store.state.update(entity, {selected: toggle}, exclusive);\r\n    if (toggle === true) {\r\n      this.entitySelectChange.emit({added: [entity]});\r\n    }\r\n    this.lastRecordCheckedKey = this.store.stateView.getKey(record);\r\n  }\r\n\r\n  /**\r\n   * When an entity is toggled, select or unselect it in the store. On select,\r\n   * emit an event.\r\n   * @param toggle Select or unselect\r\n   * @param record Record\r\n   * @internal\r\n   */\r\n  onShiftToggleRow(toggle: boolean, record: EntityRecord<object>, event: MouseEvent) {\r\n    if (this.selection === false) { return; }\r\n\r\n    if (this.selectMany === false || this.lastRecordCheckedKey === undefined) {\r\n      this.onToggleRow(toggle, record);\r\n      return;\r\n    }\r\n\r\n    // This is a workaround mat checkbox wrong behavior\r\n    // when the shift key is held.\r\n    // See https://github.com/angular/components/issues/6232\r\n    const range = window.document.createRange();\r\n    range.selectNode(event.target as HTMLElement);\r\n    window.getSelection().removeAllRanges();\r\n    window.getSelection().addRange(range);\r\n    event.stopImmediatePropagation();\r\n\r\n    const records = this.store.stateView.all();\r\n    const recordIndex = records.indexOf(record);\r\n    const lastRecordChecked = this.store.stateView.get(this.lastRecordCheckedKey);\r\n    const lastRecordIndex = records.indexOf(lastRecordChecked);\r\n    const indexes = [recordIndex, lastRecordIndex];\r\n    const selectRecords = records.slice(Math.min(...indexes), Math.max(...indexes) + 1);\r\n\r\n    const entities = selectRecords.map((_record: EntityRecord<object>) => _record.entity);\r\n    this.store.state.updateMany(entities, {selected: toggle});\r\n    if (toggle === true) {\r\n      this.entitySelectChange.emit({added: entities});\r\n    }\r\n    this.lastRecordCheckedKey = this.store.stateView.getKey(record);\r\n  }\r\n\r\n  /**\r\n   * Compute the selection state\r\n   * @returns Whether all, some or no rows are selected\r\n   * @internal\r\n   */\r\n  private computeSelectionState(selectedRecords: EntityRecord<object>[]): EntityTableSelectionState {\r\n    const states = EntityTableSelectionState;\r\n    const selectionCount = selectedRecords.length;\r\n    return selectionCount === 0 ?\r\n      states.None :\r\n      (selectionCount === this.store.stateView.count ? states.All : states.Some);\r\n  }\r\n\r\n  /**\r\n   * Whether a column is sortable\r\n   * @param column Column\r\n   * @returns True if a column is sortable\r\n   * @internal\r\n   */\r\n  columnIsSortable(column: EntityTableColumn): boolean {\r\n    let sortable = column.sort;\r\n    if (sortable === undefined) {\r\n      sortable = this.template.sort === undefined ? false : this.template.sort;\r\n    }\r\n    return sortable;\r\n  }\r\n\r\n  /**\r\n   * Whether a row is should be selected based on the underlying entity state\r\n   * @param record Record\r\n   * @returns True if a row should be selected\r\n   * @internal\r\n   */\r\n  rowIsSelected(record: EntityRecord<object>): boolean {\r\n    const state = record.state;\r\n    return state.selected ? state.selected : false;\r\n  }\r\n\r\n  isImg(value) {\r\n    if (this.isUrl(value)) {\r\n      return (\r\n        ['jpg', 'png', 'gif'].indexOf(value.split('.').pop().toLowerCase()) !== -1\r\n      );\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  isUrl(value) {\r\n    if (typeof value === 'string') {\r\n      return (\r\n        value.slice(0, 8) === 'https://' || value.slice(0, 7) === 'http://'\r\n      );\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Method to access an entity's values\r\n   * @param record Record\r\n   * @param column Column\r\n   * @returns Any value\r\n   * @internal\r\n   */\r\n  getValue(record: EntityRecord<object>, column: EntityTableColumn): any {\r\n    const entity = record.entity;\r\n    let value;\r\n    if (column.valueAccessor !== undefined) {\r\n      return column.valueAccessor(entity, record);\r\n    }\r\n    if (this.template.valueAccessor !== undefined) {\r\n      return this.template.valueAccessor(entity, column.name, record);\r\n    }\r\n    value = this.store.getProperty(entity, column.name);\r\n\r\n    if (column.type === 'boolean') {\r\n      if (value === undefined || value === null || value === '') {\r\n        value = false;\r\n      } else if (typeof value !== 'boolean' && value !== undefined) {\r\n        if (typeof value === 'number'){\r\n          value = Boolean(value);\r\n        } else {\r\n          value = JSON.parse(value.toLowerCase());\r\n        }\r\n      }\r\n      if (!this.isEdition(record)){\r\n        value = value ? '&#10003;' : ''; // check mark\r\n      }\r\n    } else if (column.type === 'list' && value && column.domainValues) {\r\n      const entity = record.entity as any;\r\n      if (column.multiple) {\r\n        let list_id;\r\n        typeof value === 'string' ? list_id = value.match(/[\\w.-]+/g).map(Number) : list_id = value;\r\n        let list_option = [];\r\n\r\n        column.domainValues.forEach(option => {\r\n          if (list_id.includes(option.id)) {\r\n            if (record.edition) {\r\n              list_option.push(option.id);\r\n            } else {\r\n              list_option.push(option.value);\r\n            }\r\n          }\r\n        });\r\n\r\n        this.isEdition(record) ? value = list_id : value = list_option;\r\n      } else {\r\n        if (!this.isEdition(record) && column.linkColumnForce) {\r\n          value = entity?.properties[this.getColumnKeyWithoutPropertiesTag(column.linkColumnForce)];\r\n        } else {\r\n          column.domainValues.forEach(option => {\r\n            if (typeof value === 'string' && /^\\d+$/.test(value)) {\r\n              value = parseInt(value);\r\n            }\r\n            if (option.value === value || option.id === value) {\r\n              this.isEdition(record) ? value = option.id : value = option.value;\r\n            }\r\n          });\r\n        }\r\n      }\r\n    } else if (column.type === 'autocomplete' && value && column.domainValues) {\r\n      const entity = record.entity as any;\r\n      if (!this.isEdition(record) && column.linkColumnForce) {\r\n        value = entity?.properties[this.getColumnKeyWithoutPropertiesTag(column.linkColumnForce)];\r\n      } else {\r\n        column.domainValues.forEach(option => {\r\n          if (typeof value === 'string' && /^\\d+$/.test(value)) {\r\n            value = parseInt(value);\r\n          }\r\n          if (option.value === value || option.id === value) {\r\n            value = option.value;\r\n          }\r\n        });\r\n      }\r\n    } else if (column.type === 'date') {\r\n      if (this.isEdition(record)) {\r\n        if (value) {\r\n          let date = moment(value);\r\n          value = date.format();\r\n          this.formGroup.controls[column.name].setValue(value);\r\n        }\r\n      } else if (!this.isEdition(record) && value === null) {\r\n        value = \"\";\r\n      }\r\n    }\r\n\r\n    if (value === undefined) {\r\n      value = '';\r\n    }\r\n\r\n    return value;\r\n  }\r\n\r\n  /**\r\n   * Method to access an entity's validation values\r\n   * @param column Column\r\n   * @param validationType string\r\n   * @returns Any value (false if no validation or not the one concerned)\r\n   * @internal\r\n   */\r\n  getValidationAttributeValue(column: EntityTableColumn, validationType: string): any {\r\n    if (column.validation !== undefined && column.validation[validationType] !== undefined) {\r\n      return column.validation[validationType];\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  public isEdition(record) {\r\n    return record.entity.edition ? true : false;\r\n  }\r\n\r\n  /**\r\n   * Return the type of renderer of a column\r\n   * @param column Column\r\n   * @returns Renderer type\r\n   * @internal\r\n   */\r\n  getColumnRenderer(column: EntityTableColumn): EntityTableColumnRenderer {\r\n    if (column.renderer !== undefined) {\r\n      return column.renderer;\r\n    }\r\n    return EntityTableColumnRenderer.Default;\r\n  }\r\n\r\n  /**\r\n   * Return the table ngClass\r\n   * @returns ngClass\r\n   * @internal\r\n   */\r\n  getTableClass(): {[key: string]: boolean} {\r\n    return {\r\n      'igo-entity-table-with-selection': this.selection\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Return a header ngClass\r\n   * @returns ngClass\r\n   * @internal\r\n   */\r\n  getHeaderClass(): {[key: string]: boolean} {\r\n    const func = this.template.headerClassFunc;\r\n    if (func instanceof Function) {\r\n      return func();\r\n    }\r\n    return {};\r\n  }\r\n\r\n  /**\r\n   * Return a row ngClass\r\n   * @param record Record\r\n   * @returns ngClass\r\n   * @internal\r\n   */\r\n  getRowClass(record: EntityRecord<object>): {[key: string]: boolean} {\r\n    const entity = record.entity;\r\n    const func = this.template.rowClassFunc;\r\n    if (func instanceof Function) {\r\n      return func(entity, record);\r\n    }\r\n    return {};\r\n  }\r\n\r\n  /**\r\n   * Return a row ngClass\r\n   * @param record Record\r\n   * @param column Column\r\n   * @returns ngClass\r\n   * @internal\r\n   */\r\n  getCellClass(record: EntityRecord<object>, column: EntityTableColumn): {[key: string]: boolean} {\r\n    const entity = record.entity;\r\n    const cls = {};\r\n\r\n    const tableFunc = this.template.cellClassFunc;\r\n    if (tableFunc instanceof Function) {\r\n      Object.assign(cls, tableFunc(entity, column, record));\r\n    }\r\n\r\n    const columnFunc = column.cellClassFunc;\r\n    if (columnFunc instanceof Function) {\r\n      Object.assign(cls, columnFunc(entity, record));\r\n    }\r\n\r\n    return cls;\r\n  }\r\n\r\n  /**\r\n   * When a button is clicked\r\n   * @param func Function\r\n   * @param record Record\r\n   * @internal\r\n   */\r\n  onButtonClick(\r\n    clickFunc: (entity: object, record?: EntityRecord<object>) => void,\r\n    record: EntityRecord<object>\r\n  ) {\r\n    this.enableEdit(record);\r\n    if (typeof clickFunc === 'function') {\r\n      clickFunc(record.entity, record);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Retrieve column name without his \"properties\" tag (useful for edition workspace properties)\r\n   */\r\n  public getColumnKeyWithoutPropertiesTag(column: string) {\r\n    if (column.includes('properties.')) {\r\n      return column.split('.')[1];\r\n    }\r\n    return column;\r\n  }\r\n}\r\n","export enum ActionbarMode {\r\n  Dock = 'dock',\r\n  Overlay = 'overlay',\r\n  Context = 'context'\r\n}\r\n","<mat-list-item *ngIf=\"!action.checkbox\"\r\n  matTooltipClass=\"actionbarItemTooltip\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"withTooltip ? ((tooltip$ | async) || title | translate) : ''\"\r\n  [ngClass]=\"ngClass$ | async\"\r\n  (click)=\"onClick()\">\r\n  <button *ngIf=\"withIcon\"\r\n    mat-list-avatar\r\n    mat-icon-button\r\n    [color]=\"color\"\r\n    [disabled]=\"disabled$ | async\">\r\n    <mat-icon *ngIf=\"withIcon\" svgIcon=\"{{icon$ | async}}\"></mat-icon>\r\n  </button>\r\n  <h4 *ngIf=\"withTitle\" matLine>{{title | translate}}</h4>\r\n</mat-list-item>\r\n\r\n<mat-list-item class=\"item-checkbox\" *ngIf=\"action.checkbox\"\r\n  matTooltipClass=\"actionbarItemTooltip\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"withTooltip ? ((tooltip$ | async) || title | translate) : ''\"\r\n  [ngClass]=\"ngClass$ | async\">\r\n  <mat-checkbox *ngIf=\"withTitle\"\r\n      (change)=\"action.handler()\"\r\n      [checked]=\"checkCondition$ | async\">\r\n      {{title | translate}}\r\n  </mat-checkbox>\r\n</mat-list-item>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject, Subscription, isObservable } from 'rxjs';\r\n\r\nimport { Action } from '../shared/action.interfaces';\r\n\r\n /**\r\n  * An action button\r\n  */\r\n@Component({\r\n  selector: 'igo-actionbar-item',\r\n  templateUrl: './actionbar-item.component.html',\r\n  styleUrls: ['./actionbar-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class ActionbarItemComponent implements OnInit, OnDestroy {\r\n\r\n  readonly disabled$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  readonly checkCondition$: BehaviorSubject<boolean> = new BehaviorSubject(undefined);\r\n\r\n  readonly icon$: BehaviorSubject<string> = new BehaviorSubject(undefined);\r\n\r\n  readonly tooltip$: BehaviorSubject<string> = new BehaviorSubject(undefined);\r\n\r\n  readonly noDisplay$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  readonly ngClass$: BehaviorSubject<{[key: string]: boolean}> = new BehaviorSubject({});\r\n\r\n  private ngClass$$: Subscription;\r\n\r\n  private disabled$$: Subscription;\r\n\r\n  private availability$$: Subscription;\r\n\r\n  private icon$$: Subscription;\r\n\r\n  private checkCondition$$: Subscription;\r\n\r\n  private tooltip$$: Subscription;\r\n\r\n  private noDisplay$$: Subscription;\r\n\r\n  private display$$: Subscription;\r\n\r\n  /**\r\n   * Action\r\n   */\r\n  @Input() action: Action;\r\n\r\n  /**\r\n   * Color\r\n   */\r\n  @Input() color = 'default';\r\n\r\n  /**\r\n   * Whether the action title is displayed\r\n   */\r\n  @Input() withTitle = true;\r\n\r\n  /**\r\n   * Whether the action icon is displayed\r\n   */\r\n  @Input() withIcon = true;\r\n\r\n  /**\r\n   * Whether a tooltip should be shown\r\n   */\r\n  @Input() withTooltip = true;\r\n\r\n  /**\r\n   * Whether the action is disabled\r\n   */\r\n  @Input()\r\n  set disabled(value: boolean) { this.disabled$.next(value); }\r\n  get disabled(): boolean { return this.disabled$.value; }\r\n\r\n  /**\r\n   * Whether the action is display or not\r\n   */\r\n  @Input()\r\n  set noDisplay(value: boolean) { this.noDisplay$.next(value); }\r\n  get noDisplay(): boolean { return this.noDisplay$.value; }\r\n\r\n  /**\r\n   * Event emitted when the action button is clicked\r\n   */\r\n  @Output() trigger: EventEmitter<Action> = new EventEmitter();\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get title(): string { return this.action.title; }\r\n\r\n  constructor() {}\r\n\r\n  ngOnInit() {\r\n    const args = this.action.args || [];\r\n\r\n    if (this.action.ngClass !== undefined) {\r\n      this.ngClass$$ = this.action.ngClass(...args)\r\n        .subscribe((ngClass: {[key: string]: boolean}) => this.updateNgClass(ngClass));\r\n    }\r\n\r\n    if (isObservable(this.action.icon)) {\r\n      this.icon$$ = this.action.icon\r\n        .subscribe((icon: string) => this.updateIcon(icon));\r\n    } else {\r\n      this.updateIcon(this.action.icon);\r\n    }\r\n\r\n    if (isObservable(this.action.checkCondition)) {\r\n      this.checkCondition$$ = this.action.checkCondition\r\n        .subscribe((checkCondition: boolean) => this.updateCheckCondition(checkCondition));\r\n    } else {\r\n      this.updateCheckCondition(this.action.checkCondition);\r\n    }\r\n\r\n    if (isObservable(this.action.tooltip)) {\r\n      this.tooltip$$ = this.action.tooltip\r\n        .subscribe((tooltip: string) => this.updateTooltip(tooltip));\r\n    } else {\r\n      this.updateTooltip(this.action.tooltip);\r\n    }\r\n\r\n    if (this.action.availability !== undefined) {\r\n      this.availability$$ = this.action.availability(...args)\r\n        .subscribe((available: boolean) => this.disabled = !available);\r\n    }\r\n\r\n    this.disabled$$ = this.disabled$\r\n      .subscribe((disabled: boolean) => this.updateNgClass({'igo-actionbar-item-disabled': disabled}));\r\n\r\n    if (this.action.display !== undefined) {\r\n      this.display$$ = this.action.display(...args)\r\n        .subscribe((display: boolean) => this.noDisplay = !display);\r\n    }\r\n\r\n    this.noDisplay$$ = this.noDisplay$\r\n      .subscribe((noDisplay: boolean) => this.updateNgClass({'igo-actionbar-item-no-display': noDisplay}));\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    if (this.ngClass$$ !== undefined) {\r\n      this.ngClass$$.unsubscribe();\r\n      this.ngClass$$ = undefined;\r\n    }\r\n\r\n    if (this.availability$$ !== undefined) {\r\n      this.availability$$.unsubscribe();\r\n      this.availability$$ = undefined;\r\n    }\r\n\r\n    if (this.display$$ !== undefined) {\r\n      this.display$$.unsubscribe();\r\n      this.display$$ = undefined;\r\n    }\r\n\r\n    if (this.checkCondition$$ !== undefined) {\r\n      this.checkCondition$$.unsubscribe();\r\n      this.checkCondition$$ = undefined;\r\n    }\r\n\r\n    if (this.icon$$ !== undefined) {\r\n      this.icon$$.unsubscribe();\r\n      this.icon$$ = undefined;\r\n    }\r\n\r\n    if (this.tooltip$$ !== undefined) {\r\n      this.tooltip$$.unsubscribe();\r\n      this.tooltip$$ = undefined;\r\n    }\r\n\r\n    this.disabled$$.unsubscribe();\r\n    this.noDisplay$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * When the action button is clicked, emit the 'trigger' event but don't\r\n   * invoke the action handler. This is handled by the parent component.\r\n   * @internal\r\n   */\r\n  onClick() {\r\n    if (this.disabled === true) {\r\n      return;\r\n    }\r\n    this.trigger.emit(this.action);\r\n  }\r\n\r\n  private updateNgClass(ngClass: {[key: string]: boolean}) {\r\n    this.ngClass$.next(Object.assign({}, this.ngClass$.value, ngClass));\r\n  }\r\n\r\n  private updateTooltip(tooltip: string) {\r\n    this.tooltip$.next(tooltip);\r\n  }\r\n\r\n  private updateCheckCondition(checkCondition: boolean) {\r\n    this.checkCondition$.next(checkCondition);\r\n  }\r\n\r\n  private updateIcon(icon: string) {\r\n    this.icon$.next(icon);\r\n  }\r\n}\r\n","<mat-list *ngIf=\"mode === actionbarMode.Dock\">\r\n\r\n    <div *ngIf=\"heightCondition && positionConditionTop && isDesktop\"\r\n      id=\"topChevron\">\r\n      <button\r\n        mat-icon-button\r\n        tooltip-position=\"below\"\r\n        matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.common.actionbar.scrollUp' | translate\"\r\n        (click)=\"scrollUp()\">\r\n        <mat-icon svgIcon=\"chevron-up\"></mat-icon>\r\n      </button>\r\n    </div>\r\n\r\n    <igo-actionbar-item\r\n      *ngIf=\"withToggleButton\"\r\n      color=\"accent\"\r\n      [withTitle]=\"false\"\r\n      [withIcon]=\"true\"\r\n      [color]=\"color\"\r\n      [disabled]=\"store.view.empty\"\r\n      [action]=\"toggleCollapseAction\"\r\n      (trigger)=\"onTriggerAction(toggleCollapseAction)\">\r\n    </igo-actionbar-item>\r\n\r\n    <ng-template #buttonContent *ngIf=\"!collapsed\" ngFor let-action [ngForOf]=\"store.view.all$() | async\">\r\n      <igo-actionbar-item\r\n        color=\"accent\"\r\n        [withTitle]=\"withTitle\"\r\n        [withIcon]=\"withIcon\"\r\n        [withTooltip]=\"withTooltip\"\r\n        [color]=\"color\"\r\n        [disabled]=\"store.state.get(action).disabled\"\r\n        [action]=\"action\"\r\n        (trigger)=\"onTriggerAction(action)\">\r\n      </igo-actionbar-item>\r\n    </ng-template>\r\n\r\n    <div *ngIf=\"heightCondition && positionConditionLow && isDesktop\"\r\n      id=\"lowChevron\">\r\n      <button\r\n        mat-icon-button\r\n        tooltip-position=\"below\"\r\n        matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.common.actionbar.scrollDown' | translate\"\r\n        (click)=\"scrollDown()\">\r\n        <mat-icon svgIcon=\"chevron-down\"></mat-icon>\r\n      </button>\r\n    </div>\r\n\r\n</mat-list>\r\n\r\n<div *ngIf=\"mode === actionbarMode.Overlay\">\r\n  <button class=\"buttonOverlay\"\r\n    mat-icon-button\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"'igo.common.actionbar.icon' | translate\"\r\n    [matMenuTriggerFor]=\"actionbarMenu\"\r\n    [disabled]=\"store.view.empty\"\r\n    [color]=\"iconColor\">\r\n    <mat-icon [svgIcon]=\"icon\"></mat-icon>\r\n  </button>\r\n\r\n  <mat-menu\r\n    #actionbarMenu=\"matMenu\"\r\n    class=\"igo-compact-menu igo-no-min-width-menu\"\r\n    overlapTrigger=\"true\"\r\n    [xPosition]=\"xPosition\"\r\n    [yPosition]=\"yPosition\"\r\n    [class]=\"overlayClass\">\r\n\r\n    <mat-list>\r\n      <ng-template ngFor let-action [ngForOf]=\"store.view.all$() | async\">\r\n        <igo-actionbar-item\r\n          color=\"accent\"\r\n          [withTitle]=\"withTitle\"\r\n          [withIcon]=\"withIcon\"\r\n          [color]=\"color\"\r\n          [action]=\"action\"\r\n          (trigger)=\"onTriggerAction(action)\">\r\n        </igo-actionbar-item>\r\n      </ng-template>\r\n    </mat-list>\r\n  </mat-menu>\r\n</div>\r\n<mat-card *ngIf=\"mode === actionbarMode.Context\" class=\"context-menu-card mat-elevation-z4\">\r\n  <mat-list>\r\n      <ng-template ngFor let-action [ngForOf]=\"store.view.all$() | async\">\r\n          <igo-actionbar-item\r\n            color=\"accent\"\r\n            [withTitle]=\"withTitle\"\r\n            [withIcon]=\"withIcon\"\r\n            [color]=\"color\"\r\n            [action]=\"action\"\r\n            (trigger)=\"onTriggerAction(action)\">\r\n          </igo-actionbar-item>\r\n        <br/>\r\n      </ng-template>\r\n  </mat-list>\r\n</mat-card>\r\n","import {\r\n  Component,\r\n  Input,\r\n  HostBinding,\r\n  ChangeDetectorRef,\r\n  ChangeDetectionStrategy,\r\n  OnChanges,\r\n  OnDestroy,\r\n  SimpleChanges,\r\n  ElementRef\r\n} from '@angular/core';\r\n\r\nimport { MediaService, Media } from '@igo2/core';\r\nimport { EntityStoreWatcher } from '../../entity';\r\nimport { Action } from '../shared/action.interfaces';\r\nimport { ActionbarMode } from '../shared/action.enums';\r\nimport { ActionStore } from '../shared/store';\r\nimport { Overlay } from '@angular/cdk/overlay';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\n/**\r\n * A list of action buttons.\r\n * This component can be displayed in one of two way: 'dock' or 'overlay'\r\n */\r\n@Component({\r\n  selector: 'igo-actionbar',\r\n  templateUrl: './actionbar.component.html',\r\n  styleUrls: ['./actionbar.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class ActionbarComponent implements OnDestroy, OnChanges {\r\n\r\n  /**\r\n   * Reference to the ActionbarMode enum for use in the template\r\n   * @internal\r\n   */\r\n  actionbarMode = ActionbarMode;\r\n\r\n  /**\r\n   * Whether the actionbar is collapsed (Dock mode)\r\n   * @internal\r\n   */\r\n  collapsed = false;\r\n\r\n  /**\r\n   * Toggle collapse action (Dock)\r\n   * @internal\r\n   */\r\n  toggleCollapseAction = {\r\n    id: 'actionbar_toggle',\r\n    icon: 'dots-vertical',\r\n    handler: () => {\r\n      this.collapsed = !this.collapsed;\r\n    }\r\n  };\r\n\r\n  /**\r\n   * Action store watcher\r\n   * @internal\r\n   */\r\n  private watcher: EntityStoreWatcher<Action>;\r\n\r\n  /**\r\n   * Height Condition for scroll button\r\n   */\r\n  heightCondition$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(false);\r\n\r\n  /**\r\n   * Position Condition for top scroll button\r\n   */\r\n  positionConditionTop$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(true);\r\n\r\n  /**\r\n   * Position Condition for low scroll button\r\n   */\r\n  positionConditionLow$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(true);\r\n\r\n  /**\r\n   * Action store\r\n   */\r\n  @Input() store: ActionStore;\r\n\r\n  /**\r\n   * Actionbar mode\r\n   */\r\n  @Input() mode: ActionbarMode = ActionbarMode.Dock;\r\n\r\n  /**\r\n   * Whether a toggle button should be displayed (Dock mode)\r\n   */\r\n  @Input() withToggleButton = false;\r\n\r\n  /**\r\n   * Whether a the actionbar should display buttons horizontally\r\n   */\r\n  @Input() horizontal = false;\r\n\r\n  /**\r\n   * Color\r\n   */\r\n  @Input() color = 'default';\r\n\r\n  /**\r\n   * Color of the button if action mode === overlay\r\n   */\r\n  @Input() iconColor = 'default';\r\n\r\n  /**\r\n   * Whether action titles are displayed\r\n   */\r\n  @Input() withTitle = true;\r\n\r\n  /**\r\n   * Whether action tooltips are displayed\r\n   */\r\n  @Input() withTooltip = true;\r\n\r\n  /**\r\n   * Whether action titles are displayed (condition for scroll button)\r\n   */\r\n  @Input() scrollActive = true;\r\n\r\n  /**\r\n   * Whether action icons are displayed\r\n   */\r\n  @Input() withIcon = true;\r\n\r\n  /**\r\n   * Which icon want to be shown\r\n   */\r\n  @Input() icon = 'dots-horizontal';\r\n\r\n  /**\r\n   * Overlay X position\r\n   */\r\n  @Input() xPosition = 'before';\r\n\r\n  /**\r\n   * Overlay Y position\r\n   */\r\n  @Input() yPosition = 'above';\r\n\r\n  /**\r\n   * Class to add to the actionbar overlay\r\n   */\r\n  @Input()\r\n  set overlayClass(value: string) {\r\n    this._overlayClass = value;\r\n  }\r\n  get overlayClass(): string {\r\n    return [this._overlayClass, 'igo-actionbar-overlay'].join(' ');\r\n  }\r\n  private _overlayClass = '';\r\n\r\n  /**\r\n   * @ignore\r\n   */\r\n  @HostBinding('class.with-title')\r\n  get withTitleClass() {\r\n    return this.withTitle;\r\n  }\r\n\r\n  /**\r\n   * @ignore\r\n   */\r\n  @HostBinding('class.with-icon')\r\n  get withIconClass() {\r\n    return this.withIcon;\r\n  }\r\n\r\n  /**\r\n   * @ignore\r\n   */\r\n  @HostBinding('class.horizontal')\r\n  get horizontalClass() {\r\n    return this.horizontal;\r\n  }\r\n\r\n  get heightCondition(): boolean {\r\n    const el = this.elRef.nativeElement;\r\n    if (this.scrollActive === false) {\r\n      if (el.clientHeight < el.scrollHeight) {\r\n        return true;\r\n      }\r\n    }\r\n    return false;\r\n  }\r\n\r\n  get positionConditionTop(): boolean {\r\n    if (this.elRef.nativeElement.scrollTop === 0) {\r\n      return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  get positionConditionLow(): boolean {\r\n    const el = this.elRef.nativeElement;\r\n    if (el.scrollTop >= (el.scrollHeight - el.clientHeight)) {\r\n      return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  get isDesktop(): boolean {\r\n    return this.mediaService.getMedia() === Media.Desktop;\r\n  }\r\n\r\n  constructor(\r\n    public overlay: Overlay,\r\n    private elRef: ElementRef,\r\n    private cdRef: ChangeDetectorRef,\r\n    public mediaService: MediaService) {}\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnChanges(changes: SimpleChanges) {\r\n    const store = changes.store;\r\n    if (store && store.currentValue !== store.previousValue) {\r\n      if (this.watcher !== undefined) {\r\n        this.watcher.destroy();\r\n      }\r\n      this.watcher = new EntityStoreWatcher(this.store, this.cdRef);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.watcher.destroy();\r\n  }\r\n\r\n  /**\r\n   * Invoke the action handler\r\n   * @internal\r\n   */\r\n  onTriggerAction(action: Action) {\r\n    const args = action.args || [];\r\n    action.handler(...args);\r\n  }\r\n\r\n  scrollDown() {\r\n    this.elRef.nativeElement.scrollBy(0, 52);\r\n  }\r\n\r\n  scrollUp() {\r\n    this.elRef.nativeElement.scrollBy(0, -52);\r\n  }\r\n\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatMenuModule } from '@angular/material/menu';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { ActionbarComponent } from './actionbar.component';\r\nimport { ActionbarItemComponent } from './actionbar-item.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoLanguageModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    MatTooltipModule,\r\n    MatMenuModule,\r\n    MatListModule,\r\n    MatCardModule,\r\n    MatCheckboxModule\r\n  ],\r\n  exports: [ActionbarComponent],\r\n  declarations: [ActionbarComponent, ActionbarItemComponent]\r\n})\r\nexport class IgoActionbarModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoActionbarModule } from './actionbar/actionbar.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoActionbarModule\r\n  ],\r\n  exports: [\r\n    IgoActionbarModule\r\n  ],\r\n  declarations: [],\r\n  providers: []\r\n})\r\nexport class IgoActionModule {}\r\n","import { Directive, Input, ElementRef, OnInit } from '@angular/core';\r\nimport { MatIconRegistry } from '@angular/material/icon';\r\n\r\n\r\n/**\r\n * This directive allow to add an icon inside a matBadge.\r\n * A value must be set into the matBadge directive ex: matBadge=\"icon\".\r\n * The badge content will be overrided by this current directive.\r\n */\r\n@Directive({\r\n  selector: '[igoMatBadgeIcon]'\r\n})\r\nexport class IgoBadgeIconDirective implements OnInit {\r\n  @Input()\r\n  set igoMatBadgeIcon(value: string) {\r\n    this.matIconRegistry.getNamedSvgIcon(value).subscribe((svgObj) => {\r\n      this.svg = svgObj;\r\n      this.updateSvg();\r\n    });\r\n  }\r\n  private svg: SVGElement;\r\n\r\n  @Input()\r\n  set matBadgeHidden(value: boolean) {\r\n    this.hidden = value;\r\n    this.updateHidden();\r\n  }\r\n  private hidden = false;\r\n\r\n  @Input()\r\n  set matBadgeDisabled(value: boolean) {\r\n    this.disabled = value;\r\n    this.updateDisabled();\r\n  }\r\n  private disabled = false;\r\n\r\n  @Input()\r\n  set igoMatBadgeInverseColor(value: boolean) {\r\n    this.inverseColor = value;\r\n    this.updateColor();\r\n  }\r\n  private inverseColor = false;\r\n\r\n  @Input()\r\n  set igoMatBadgeInheritColor(value: boolean) {\r\n    this.inheritColor = value;\r\n    this.updateColor();\r\n  }\r\n  private inheritColor = false;\r\n\r\n  get badge() {\r\n    return this.el.nativeElement.querySelector('.mat-badge-content');\r\n  }\r\n\r\n  private originalColor: string;\r\n\r\n  constructor(\r\n    private el: ElementRef,\r\n    private matIconRegistry: MatIconRegistry\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.badge.style.alignItems = 'center';\r\n    this.badge.style.justifyContent = 'center';\r\n\r\n    this.updateHidden();\r\n    this.updateColor();\r\n    this.updateSvg();\r\n  }\r\n\r\n  private updateSvg() {\r\n    if (!this.badge) {\r\n      return;\r\n    }\r\n    this.badge.innerHTML = '';\r\n    if (this.svg) {\r\n      this.badge.appendChild(this.svg);\r\n    }\r\n  }\r\n  private updateColor() {\r\n    if (!this.badge) {\r\n      return;\r\n    }\r\n\r\n    if (this.inheritColor) {\r\n      if (this.inverseColor) {\r\n        this.badge.style.color = 'currentColor';\r\n        this.badge.style.background = 'none';\r\n      } else {\r\n        this.badge.style.color = '';\r\n        this.badge.style.background = 'currentColor';\r\n      }\r\n    } else {\r\n      if (this.inverseColor) {\r\n        this.badge.style.color = window\r\n          .getComputedStyle(this.badge, null)\r\n          .getPropertyValue('background-color');\r\n        this.badge.style.background = 'none';\r\n      } else {\r\n        this.badge.style.color = '';\r\n        this.badge.style.background = '';\r\n      }\r\n    }\r\n    this.originalColor = this.badge.style.color;\r\n    this.updateDisabled();\r\n  }\r\n\r\n  private updateHidden() {\r\n    if (!this.badge) {\r\n      return;\r\n    }\r\n    this.badge.style.display = this.hidden ? 'none' : 'flex';\r\n  }\r\n\r\n  private updateDisabled() {\r\n    if (!this.badge || !this.inverseColor) {\r\n      return;\r\n    }\r\n    if (this.disabled) {\r\n      this.originalColor = this.badge.style.color;\r\n      this.badge.style.color = '#b9b9b9';\r\n    } else {\r\n      this.badge.style.color = this.originalColor;\r\n    }\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { IgoBadgeIconDirective } from './badge-icon.directive';\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\n@NgModule({\r\n  imports: [MatBadgeModule, MatIconModule],\r\n  declarations: [IgoBadgeIconDirective],\r\n  exports: [MatBadgeModule, IgoBadgeIconDirective]\r\n})\r\nexport class IgoMatBadgeIconModule {\r\n  static forRoot(): ModuleWithProviders<IgoMatBadgeIconModule> {\r\n    return {\r\n      ngModule: IgoMatBadgeIconModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import {\r\n  Directive,\r\n  ElementRef,\r\n  EventEmitter,\r\n  HostListener,\r\n  Output\r\n} from '@angular/core';\r\n\r\n@Directive({\r\n  selector: '[igoClickout]'\r\n})\r\nexport class ClickoutDirective {\r\n  @Output() clickout = new EventEmitter<MouseEvent>();\r\n\r\n  @HostListener('document:click', ['$event', '$event.target'])\r\n  handleMouseClick(event: MouseEvent, target: HTMLElement) {\r\n    if (!target) {\r\n      return;\r\n    }\r\n\r\n    if (!this.el.nativeElement.contains(target)) {\r\n      this.clickout.emit(event);\r\n    }\r\n  }\r\n\r\n  constructor(private el: ElementRef) {}\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { ClickoutDirective } from './clickout.directive';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [ClickoutDirective],\r\n  exports: [ClickoutDirective]\r\n})\r\nexport class IgoClickoutModule {\r\n  static forRoot(): ModuleWithProviders<IgoClickoutModule> {\r\n    return {\r\n      ngModule: IgoClickoutModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import {\r\n  Directive,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  HostListener,\r\n  ElementRef,\r\n  Renderer2\r\n} from '@angular/core';\r\n\r\n@Directive({\r\n  selector: '[igoCollapse]'\r\n})\r\nexport class CollapseDirective {\r\n  @Input()\r\n  get target() {\r\n    return this._target;\r\n  }\r\n  set target(value: Element) {\r\n    this._target = value;\r\n  }\r\n  private _target: Element;\r\n\r\n  @Input()\r\n  get collapsed(): boolean {\r\n    return this._collapsed;\r\n  }\r\n  set collapsed(collapsed: boolean) {\r\n    collapsed ? this.collapseTarget() : this.expandTarget();\r\n    this._collapsed = collapsed;\r\n    this.toggle.emit(collapsed);\r\n  }\r\n  private _collapsed = false;\r\n\r\n  @Output() toggle: EventEmitter<boolean> = new EventEmitter();\r\n\r\n  @HostListener('click')\r\n  click() {\r\n    this.collapsed = !this.collapsed;\r\n  }\r\n\r\n  constructor(private renderer: Renderer2, private el: ElementRef) {}\r\n\r\n  private collapseTarget() {\r\n    this.renderer.addClass(this.target, 'igo-collapsed');\r\n    this.renderer.addClass(this.el.nativeElement, 'collapsed');\r\n  }\r\n\r\n  private expandTarget() {\r\n    this.renderer.removeClass(this.target, 'igo-collapsed');\r\n    this.renderer.removeClass(this.el.nativeElement, 'collapsed');\r\n  }\r\n}\r\n","import { Component, Input, Output, EventEmitter } from '@angular/core';\r\n\r\n@Component({\r\n  selector: 'igo-collapsible',\r\n  templateUrl: './collapsible.component.html',\r\n  styleUrls: ['./collapsible.component.scss']\r\n})\r\nexport class CollapsibleComponent {\r\n  @Input()\r\n  get title() {\r\n    return this._title;\r\n  }\r\n  set title(value: string) {\r\n    this._title = value;\r\n  }\r\n  private _title = '';\r\n\r\n  @Input()\r\n  get collapsed() {\r\n    return this._collapsed;\r\n  }\r\n  set collapsed(value: boolean) {\r\n    this._collapsed = value;\r\n    this.toggle.emit(value);\r\n  }\r\n  private _collapsed = false;\r\n\r\n  @Output() toggle: EventEmitter<boolean> = new EventEmitter();\r\n}\r\n","<mat-list-item>\r\n  <mat-icon\r\n    svgIcon=\"chevron-up\" \r\n    class=\"igo-chevron\"\r\n    mat-list-avatar\r\n    igoCollapse\r\n    [target]=\"content\"\r\n    [collapsed]=\"collapsed\"\r\n    (toggle)=\"collapsed = $event\">\r\n  </mat-icon>\r\n  <h4 matLine>{{title}}</h4>\r\n</mat-list-item>\r\n\r\n<div #content>\r\n  <ng-content></ng-content>\r\n</div>\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatListModule } from '@angular/material/list';\r\n\r\nimport { CollapseDirective } from './collapse.directive';\r\nimport { CollapsibleComponent } from './collapsible.component';\r\n\r\n@NgModule({\r\n  imports: [MatIconModule, MatListModule],\r\n  declarations: [CollapsibleComponent, CollapseDirective],\r\n  exports: [CollapsibleComponent, CollapseDirective]\r\n})\r\nexport class IgoCollapsibleModule {\r\n  static forRoot(): ModuleWithProviders<IgoCollapsibleModule> {\r\n    return {\r\n      ngModule: IgoCollapsibleModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import { Component } from '@angular/core';\r\nimport { MatDialogRef } from '@angular/material/dialog';\r\n\r\n@Component({\r\n  selector: 'igo-confirm-dialog',\r\n  templateUrl: './confirm-dialog.component.html',\r\n  styleUrls: ['./confirm-dialog.component.scss']\r\n})\r\nexport class ConfirmDialogComponent {\r\n  public confirmMessage: string;\r\n\r\n  constructor(public dialogRef: MatDialogRef<ConfirmDialogComponent>) {}\r\n}\r\n","<h2 mat-dialog-title class=\"mat-typography\">{{'igo.common.confirmDialog.title' |translate}}</h2>\r\n<div mat-dialog-content class=\"mat-typography\">{{confirmMessage}}</div>\r\n<div mat-dialog-actions>\r\n  <button mat-button color=\"primary\" (click)=\"dialogRef.close(true)\">{{'igo.common.confirmDialog.confirmBtn' | translate}}</button>\r\n  <button mat-button (click)=\"dialogRef.close(false)\">{{'igo.common.confirmDialog.cancelBtn' |translate}}</button>\r\n</div>\r\n","import { Injectable } from '@angular/core';\r\nimport { MatDialog } from '@angular/material/dialog';\r\n\r\nimport { Observable } from 'rxjs';\r\n\r\nimport { ConfirmDialogComponent } from './confirm-dialog.component';\r\n\r\n@Injectable()\r\nexport class ConfirmDialogService {\r\n  constructor(private dialog: MatDialog) {}\r\n\r\n  public open(message: string): Observable<any> {\r\n    const dialogRef = this.dialog.open(ConfirmDialogComponent, {\r\n      disableClose: false\r\n    });\r\n    dialogRef.componentInstance.confirmMessage = message;\r\n\r\n    return dialogRef.afterClosed();\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatDialogModule } from '@angular/material/dialog';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { ConfirmDialogComponent } from './confirm-dialog.component';\r\nimport { ConfirmDialogService } from './confirm-dialog.service';\r\n\r\n@NgModule({\r\n  imports: [MatButtonModule, MatDialogModule, IgoLanguageModule],\r\n  declarations: [ConfirmDialogComponent],\r\n  exports: [ConfirmDialogComponent],\r\n  providers: [ConfirmDialogService]\r\n})\r\nexport class IgoConfirmDialogModule {\r\n  static forRoot(): ModuleWithProviders<IgoConfirmDialogModule> {\r\n    return {\r\n      ngModule: IgoConfirmDialogModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import {\r\n  Directive,\r\n  ElementRef,\r\n  EventEmitter,\r\n  HostListener,\r\n  Input,\r\n  Output,\r\n  ViewContainerRef\r\n} from '@angular/core';\r\nimport type { TemplateRef } from '@angular/core';\r\n\r\nimport { TemplatePortal } from '@angular/cdk/portal';\r\nimport { fromEvent, Subscription } from 'rxjs';\r\nimport { filter, take } from 'rxjs/operators';\r\nimport { Overlay, OverlayRef } from '@angular/cdk/overlay';\r\n\r\n@Directive({\r\n  selector: '[igoContextMenu]'\r\n})\r\nexport class ContextMenuDirective {\r\n  private overlayRef: OverlayRef | null;\r\n  private sub: Subscription;\r\n\r\n  @Input('igoContextMenu') menuContext: TemplateRef<any>;\r\n  @Output() menuPosition = new EventEmitter<{ x: number; y: number }>();\r\n\r\n  constructor(\r\n    public overlay: Overlay,\r\n    public viewContainerRef: ViewContainerRef,\r\n    private elementRef: ElementRef\r\n  ) {}\r\n\r\n  @HostListener('contextmenu', ['$event'])\r\n  public onContextMenu(e: MouseEvent): void {\r\n    const {x, y} = e;\r\n    this.close();\r\n    e.preventDefault();\r\n    this.menuPosition.emit({ x, y });\r\n    this.overlayRef = null;\r\n    const positionStrategy = this.overlay\r\n      .position()\r\n      .flexibleConnectedTo({ x, y })\r\n      .withPositions([\r\n        {\r\n          originX: 'end',\r\n          originY: 'bottom',\r\n          overlayX: 'start',\r\n          overlayY: 'top'\r\n        }\r\n      ]);\r\n    this.overlayRef = this.overlay.create({\r\n      positionStrategy,\r\n      scrollStrategy: this.overlay.scrollStrategies.close()\r\n    });\r\n    this.overlayRef.attach(\r\n      new TemplatePortal(this.menuContext, this.viewContainerRef, {\r\n        $implicit: undefined\r\n      })\r\n    );\r\n\r\n    this.sub = fromEvent<MouseEvent>(document, 'click')\r\n      .pipe(\r\n        filter(event => {\r\n          const clickTarget = event.target as HTMLElement;\r\n          this.close();\r\n          return (\r\n            !!this.overlayRef &&\r\n            !this.overlayRef.overlayElement.contains(clickTarget)\r\n          );\r\n        }),\r\n        take(1)\r\n      )\r\n      .subscribe(() => this.close());\r\n\r\n    this.sub = fromEvent<MouseEvent>(document, 'contextmenu')\r\n      .pipe(\r\n        filter(event => {\r\n          const clickTarget = event.target as HTMLElement;\r\n          if (\r\n            clickTarget &&\r\n            !this.elementRef.nativeElement.contains(clickTarget) &&\r\n            !this.overlayRef.overlayElement.contains(clickTarget)\r\n          ) {\r\n            return true;\r\n          } else {\r\n            event.preventDefault();\r\n          }\r\n        }),\r\n        take(1)\r\n      )\r\n      .subscribe(() => this.close());\r\n  }\r\n\r\n  close() {\r\n    if (this.overlayRef) {\r\n      this.overlayRef.dispose();\r\n      this.overlayRef = null;\r\n    }\r\n    if (this.sub) {\r\n      this.sub.unsubscribe();\r\n    }\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { ContextMenuDirective } from './context-menu.directive';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [ContextMenuDirective],\r\n  exports: [ContextMenuDirective]\r\n})\r\nexport class IgoContextMenuModule {\r\n  static forRoot(): ModuleWithProviders<IgoContextMenuModule> {\r\n    return {\r\n      ngModule: IgoContextMenuModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { CustomHtmlComponent } from './custom-html.component';\r\nimport { SanitizeHtmlPipe } from './custom-html.pipe';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatIconModule,\r\n    MatTooltipModule,\r\n    MatInputModule,\r\n    MatButtonModule,\r\n    IgoLanguageModule\r\n  ],\r\n  exports: [SanitizeHtmlPipe, CustomHtmlComponent],\r\n  declarations: [SanitizeHtmlPipe, CustomHtmlComponent]\r\n})\r\nexport class IgoCustomHtmlModule {\r\n  static forRoot(): ModuleWithProviders<IgoCustomHtmlModule> {\r\n    return {\r\n      ngModule: IgoCustomHtmlModule\r\n    };\r\n  }\r\n}\r\n","import { HttpClient, HttpErrorResponse } from '@angular/common/http';\r\nimport { catchError, map } from 'rxjs/operators';\r\nimport { throwError } from 'rxjs';\r\n\r\nimport { DOMOptions, DOMValue } from './dom.interfaces';\r\nimport { Injectable } from '@angular/core';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class DOMService {\r\n\r\n  constructor(private http: HttpClient) {}\r\n\r\n  async getDom(dom: DOMOptions): Promise<DOMValue[]> {\r\n    const url = dom.url;\r\n    let result: DOMValue[];\r\n\r\n    await this.http.get<any>(url).pipe(\r\n      map(response => {\r\n        result = response;\r\n        return response;\r\n      }),\r\n      catchError((err: HttpErrorResponse) => {\r\n        return throwError(err);\r\n      })\r\n    ).toPromise();\r\n\r\n    return result;\r\n  }\r\n\r\n}\r\n","import { ModuleWithProviders, NgModule } from '@angular/core';\r\n\r\nimport { DOMService } from './dom.service';\r\n\r\n@NgModule({\r\n  providers: [DOMService]\r\n})\r\nexport class IgoDOMModule {\r\n  static forRoot(): ModuleWithProviders<IgoDOMModule> {\r\n    return {\r\n      ngModule: IgoDOMModule,\r\n      providers: [\r\n        DOMService\r\n      ]\r\n    };\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { DragAndDropDirective } from './drag-drop.directive';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [DragAndDropDirective],\r\n  exports: [DragAndDropDirective]\r\n})\r\nexport class IgoDrapDropModule {\r\n  static forRoot(): ModuleWithProviders<IgoDrapDropModule> {\r\n    return {\r\n      ngModule: IgoDrapDropModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import {\r\n  ComponentFactory,\r\n  ComponentRef,\r\n  ViewContainerRef\r\n} from '@angular/core';\r\n\r\nimport { Observable, Subscription } from 'rxjs';\r\n\r\n/**\r\n * This class is used in the DynamicComponentOutlet component. It holds\r\n * a reference to a component factory and can render that component\r\n * in a target element on demand. It's also possible to set inputs\r\n * and to subscribe to outputs.\r\n */\r\nexport class DynamicComponent<C> {\r\n\r\n  /**\r\n   * Component reference\r\n   */\r\n  private componentRef: ComponentRef<C>;\r\n\r\n  /**\r\n   * Subscriptions to the component's outputs. Those need\r\n   * to be unsubscribed when the component is destroyed.\r\n   */\r\n  private subscriptions: Subscription[] = [];\r\n\r\n  /**\r\n   * Component target element\r\n   */\r\n  private target: ViewContainerRef;\r\n\r\n  /**\r\n   * Component inputs\r\n   */\r\n  private inputs: {[key: string]: any} = {};\r\n\r\n  /**\r\n   * Subscriptions to the component's async inputs\r\n   */\r\n  private inputs$$: {[key: string]: Subscription} = {};\r\n\r\n  /**\r\n   * Subscribers to the component's outputs\r\n   */\r\n  private subscribers: {[key: string]: (event: any) => void} = {};\r\n\r\n  constructor(private componentFactory: ComponentFactory<C>) {}\r\n\r\n  /**\r\n   * Render the component to a target element.\r\n   * Set it's inputs and subscribe to it's outputs.\r\n   * @param target Target element\r\n   */\r\n  setTarget(target: ViewContainerRef) {\r\n    this.target = target;\r\n    this.componentRef = target.createComponent(this.componentFactory);\r\n    this.updateInputs(this.inputs);\r\n    this.updateSubscribers(this.subscribers);\r\n  }\r\n\r\n  /**\r\n   * Destroy this component. That means, removing from it's target\r\n   * element and unsubscribing to it's outputs.\r\n   */\r\n  destroy() {\r\n    if (this.target !== undefined) {\r\n      this.target.clear();\r\n    }\r\n    if (this.componentRef !== undefined) {\r\n      this.componentRef.destroy();\r\n      this.componentRef = undefined;\r\n    }\r\n    this.unobserveAllInputs();\r\n    this.unsubscribeAll();\r\n  }\r\n\r\n  /**\r\n   * Update the component inputs. This is an update so any\r\n   * key not defined won't be overwritten.\r\n   */\r\n  updateInputs(inputs: {[key: string]: any}) {\r\n    this.inputs = inputs;\r\n    if (this.componentRef === undefined) {\r\n      return;\r\n    }\r\n\r\n    const instance = this.componentRef.instance;\r\n    const allowedInputs = this.componentFactory.inputs;\r\n    allowedInputs.forEach((value: {propName: string; templateName: string; }) => {\r\n      const key = value.propName;\r\n\r\n      this.unobserveInput(key);\r\n\r\n      const inputValue = inputs[key];\r\n      if (inputs.hasOwnProperty(key)) {\r\n        if (inputValue instanceof Observable) {\r\n          this.observeInput(key, inputValue);\r\n        } else {\r\n          this.setInputValue(instance, key, inputValue);\r\n        }\r\n      }\r\n    });\r\n\r\n    if (typeof (instance as any).onUpdateInputs === 'function') {\r\n      (instance as any).onUpdateInputs();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set an instance's input value\r\n   * @param instance Component instance\r\n   * @param key Input key\r\n   * @param value Input value\r\n   */\r\n  private setInputValue(instance: C, key: string, value: any) {\r\n    const currentValue = instance[key];\r\n    if (value === currentValue) {\r\n      return;\r\n    }\r\n\r\n    const prototype = Object.getPrototypeOf(instance);\r\n    const descriptor = Object.getOwnPropertyDescriptor(prototype, key);\r\n    if (descriptor !== undefined && descriptor.set !== undefined) {\r\n      descriptor.set.call(instance, value);\r\n    } else {\r\n      instance[key] = value;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update the component subscribers. This is an update so any\r\n   * key not defined won't be overwritten.\r\n   */\r\n  updateSubscribers(subscribers: {[key: string]: (event: any) => void}) {\r\n    this.subscribers = subscribers;\r\n    if (this.componentRef === undefined) {\r\n      return;\r\n    }\r\n\r\n    const instance = this.componentRef.instance;\r\n    const allowedSubscribers = this.componentFactory.outputs;\r\n    allowedSubscribers.forEach((value: {propName: string; templateName: string; }) => {\r\n      const key = value.propName;\r\n      if (subscribers.hasOwnProperty(key)) {\r\n        const emitter = instance[key];\r\n        const subscriber = subscribers[key];\r\n        if (Array.isArray(subscriber)) {\r\n          subscriber.forEach((_subscriber) => {\r\n            this.subscriptions.push(emitter.subscribe(_subscriber));\r\n          });\r\n        } else {\r\n          this.subscriptions.push(emitter.subscribe(subscriber));\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Subscribe to an observable input and update the component's input value\r\n   * accordingly\r\n   * @param key Input key\r\n   * @param observable Observable\r\n   */\r\n  private observeInput(key: string, observable: Observable<any>) {\r\n    this.inputs$$[key] = observable.subscribe((value: any) => {\r\n      const instance = this.componentRef.instance;\r\n      this.setInputValue(instance, key, value);\r\n\r\n      if (typeof (instance as any).onUpdateInputs === 'function') {\r\n        (instance as any).onUpdateInputs();\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to an observable input\r\n   * @param key Input key\r\n   */\r\n  private unobserveInput(key: string) {\r\n    if (this.inputs$$[key] !== undefined) {\r\n      this.inputs$$[key].unsubscribe();\r\n      this.inputs$$[key] = undefined;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to all outputs.\r\n   */\r\n  private unobserveAllInputs() {\r\n    Object.values(this.inputs$$).forEach((s: Subscription | undefined) => {\r\n      if (s !== undefined) {\r\n        s.unsubscribe();\r\n      }\r\n    });\r\n    this.inputs$$ = {};\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to all outputs.\r\n   */\r\n  private unsubscribeAll() {\r\n    this.subscriptions.forEach((s: Subscription) => s.unsubscribe());\r\n    this.subscriptions = [];\r\n  }\r\n\r\n}\r\n","import {\r\n  ComponentFactoryResolver,\r\n  Injectable\r\n} from '@angular/core';\r\n\r\nimport { DynamicComponent } from './dynamic-component';\r\n\r\n/**\r\n * Service to creates DynamicComponent instances from base component classes\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class DynamicComponentService {\r\n\r\n  constructor(private resolver: ComponentFactoryResolver) {}\r\n\r\n  /**\r\n   * Creates a DynamicComponent instance from a base component class\r\n   * @param componentCls The component class\r\n   * @returns DynamicComponent instance\r\n   */\r\n  create(componentCls: any): DynamicComponent<any> {\r\n    const factory = this.resolver.resolveComponentFactory(componentCls as any);\r\n    return new DynamicComponent<typeof componentCls>(factory);\r\n  }\r\n}\r\n","import {\r\n  Input,\r\n  ChangeDetectorRef,\r\n  ChangeDetectionStrategy,\r\n  Component,\r\n  OnChanges,\r\n  OnDestroy,\r\n  SimpleChanges,\r\n  ViewContainerRef,\r\n  ViewChild\r\n} from '@angular/core';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport { DynamicComponent } from '../shared/dynamic-component';\r\nimport { DynamicComponentService } from '../shared/dynamic-component.service';\r\n\r\n@Component({\r\n  selector: 'igo-dynamic-outlet',\r\n  templateUrl: 'dynamic-outlet.component.html',\r\n  styleUrls: ['dynamic-outlet.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class DynamicOutletComponent implements OnChanges, OnDestroy {\r\n  /**\r\n   * The dynamic component base class or the dynamic component itself\r\n   */\r\n  @Input() component: DynamicComponent<any> | any;\r\n\r\n  /**\r\n   * The dynamic component inputs\r\n   */\r\n  @Input() inputs: { [key: string]: any } = {};\r\n\r\n  /**\r\n   * The subscribers to the dynamic component outputs\r\n   */\r\n  @Input() subscribers: { [key: string]: (event: any) => void } = {};\r\n\r\n  /**\r\n   * The dynamic component\r\n   */\r\n  private dynamicComponent: DynamicComponent<any>;\r\n\r\n  /**\r\n   * The view element to render the component to\r\n   * @ignore\r\n   */\r\n  @ViewChild('target', { read: ViewContainerRef, static: true })\r\n  private target: ViewContainerRef;\r\n\r\n  constructor(\r\n    private dynamicComponentService: DynamicComponentService,\r\n    private cdRef: ChangeDetectorRef\r\n  ) {}\r\n\r\n  /**\r\n   * If the dynamic component changes, create it.\r\n   * If the inputs or subscribers change, update the current component's\r\n   * inputs or subscribers.\r\n   * @internal\r\n   */\r\n  ngOnChanges(changes: SimpleChanges) {\r\n    const component = changes.component;\r\n    const inputs = changes.inputs;\r\n    const subscribers = changes.subscribers;\r\n    const eq = ObjectUtils.objectsAreEquivalent;\r\n\r\n    if (!component || !component.currentValue) {\r\n      return;\r\n    }\r\n\r\n    if (component.currentValue !== component.previousValue) {\r\n      this.createComponent(component.currentValue);\r\n    } else {\r\n      const inputsAreEquivalents =\r\n        inputs && eq(inputs.currentValue || {}, inputs.previousValue || {});\r\n      const subscribersAreEquivalents =\r\n        subscribers &&\r\n        eq(subscribers.currentValue || {}, subscribers.previousValue || {});\r\n\r\n      if (inputsAreEquivalents === false) {\r\n        this.updateInputs();\r\n      }\r\n\r\n      if (subscribersAreEquivalents === false) {\r\n        this.updateSubscribers();\r\n      }\r\n    }\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n  /**\r\n   * Destroy the dynamic component and all it's subscribers\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    if (this.dynamicComponent) {\r\n      this.dynamicComponent.destroy();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create a  DynamicComponent out of the component class and render it.\r\n   * @internal\r\n   */\r\n  private createComponent(component: DynamicComponent<any> | any) {\r\n    if (this.dynamicComponent !== undefined) {\r\n      this.dynamicComponent.destroy();\r\n    }\r\n    this.dynamicComponent =\r\n      component instanceof DynamicComponent\r\n        ? component\r\n        : this.dynamicComponentService.create(component);\r\n    this.renderComponent();\r\n  }\r\n\r\n  /**\r\n   * Create and render the dynamic component. Set it's inputs and subscribers\r\n   * @internal\r\n   */\r\n  private renderComponent() {\r\n    this.updateInputs();\r\n    this.updateSubscribers();\r\n    this.dynamicComponent.setTarget(this.target);\r\n  }\r\n\r\n  /**\r\n   * Update the dynamic component inputs. This is an update so any\r\n   * key not defined won't be overwritten.\r\n   * @internal\r\n   */\r\n  private updateInputs() {\r\n    this.dynamicComponent.updateInputs(this.inputs);\r\n  }\r\n\r\n  /**\r\n   * Update the dynamic component subscribers. This is an update so any\r\n   * key not defined won't be overwritten.\r\n   * @internal\r\n   */\r\n  private updateSubscribers() {\r\n    this.dynamicComponent.updateSubscribers(this.subscribers);\r\n  }\r\n}\r\n","<ng-template #target></ng-template>\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { DynamicOutletComponent } from './dynamic-outlet.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule\r\n  ],\r\n  exports: [\r\n    DynamicOutletComponent\r\n  ],\r\n  declarations: [\r\n    DynamicOutletComponent\r\n  ]\r\n})\r\nexport class IgoDynamicOutletModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoDynamicOutletModule } from './dynamic-outlet/dynamic-outlet.module';\r\nimport { DynamicComponentService } from './shared/dynamic-component.service';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoDynamicOutletModule\r\n  ],\r\n  exports: [\r\n    IgoDynamicOutletModule\r\n  ],\r\n  providers: [\r\n    DynamicComponentService\r\n  ]\r\n})\r\nexport class IgoDynamicComponentModule {}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { FlexibleComponent } from './flexible.component';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [FlexibleComponent],\r\n  exports: [FlexibleComponent]\r\n})\r\nexport class IgoFlexibleModule {\r\n  static forRoot(): ModuleWithProviders<IgoFlexibleModule> {\r\n    return {\r\n      ngModule: IgoFlexibleModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  OnChanges,\r\n  SimpleChanges,\r\n  ChangeDetectionStrategy,\r\n  ViewChild,\r\n  ElementRef\r\n} from '@angular/core';\r\n\r\nimport t from 'typy';\r\n\r\nimport { Form, FormField, FormFieldGroup } from '../shared/form.interfaces';\r\nimport { getAllFormFields } from '../shared/form.utils';\r\n\r\n/**\r\n * A configurable form\r\n */\r\n@Component({\r\n  selector: 'igo-form',\r\n  templateUrl: './form.component.html',\r\n  styleUrls: ['./form.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class FormComponent implements OnChanges {\r\n\r\n  /**\r\n   * Form\r\n   */\r\n  @Input() form: Form;\r\n\r\n  /**\r\n   * Input data\r\n   */\r\n  @Input() formData: { [key: string]: any};\r\n\r\n  /**\r\n   * Form autocomplete\r\n   */\r\n  @Input() autocomplete: string = 'off';\r\n\r\n  /**\r\n   * Event emitted when the form is submitted\r\n   */\r\n  @Output() submitForm = new EventEmitter<{[key: string]: any}>();\r\n\r\n  @ViewChild('buttons', { static: true }) buttons: ElementRef;\r\n\r\n  get hasButtons(): boolean {\r\n    return this.buttons.nativeElement.children.length !== 0;\r\n  }\r\n\r\n  constructor() {}\r\n\r\n  /**\r\n   * Is the entity or the template change, recreate the form or repopulate it.\r\n   * @internal\r\n   */\r\n  ngOnChanges(changes: SimpleChanges) {\r\n    const formData = changes.formData;\r\n    if (formData && formData.currentValue !== formData.previousValue) {\r\n      if (formData.currentValue === undefined) {\r\n        this.clear();\r\n      } else {\r\n        this.setData(formData.currentValue);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Transform the form data to a feature and emit an event\r\n   * @param event Form submit event\r\n   * @internal\r\n   */\r\n  onSubmit() {\r\n    this.submitForm.emit(this.getData());\r\n  }\r\n\r\n  getData(): { [key: string]: any} {\r\n    const data = {};\r\n    getAllFormFields(this.form).forEach((field: FormField) => {\r\n      this.updateDataWithFormField(data, field);\r\n    });\r\n    return data;\r\n  }\r\n\r\n  private setData(data: {[key: string]: any}) {\r\n    this.form.fields.forEach((field: FormField) => {\r\n      field.control.setValue(t(data, field.name).safeObject);\r\n    });\r\n\r\n    this.form.groups.forEach((group: FormFieldGroup) => {\r\n      group.fields.forEach((field: FormField) => {\r\n        field.control.setValue(t(data, field.name).safeObject);\r\n      });\r\n    });\r\n  }\r\n\r\n  private updateDataWithFormField(data: { [key: string]: any}, field: FormField) {\r\n    const control = field.control;\r\n    if (!control.disabled) {\r\n      data[field.name] = control.value;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear form\r\n   */\r\n  private clear() {\r\n    this.form.control.reset();\r\n  }\r\n\r\n}\r\n","import { AbstractControl } from '@angular/forms';\r\n\r\nimport { Form, FormField, FormFieldGroup } from './form.interfaces';\r\n\r\nexport function formControlIsRequired(control: AbstractControl): boolean {\r\n  if (control.validator) {\r\n    const validator = control.validator({} as AbstractControl);\r\n    if (validator && validator.required) {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  if ((control as any).controls) {\r\n    const requiredControl = Object.keys((control as any).controls).find((key: string) => {\r\n      return formControlIsRequired((control as any).controls[key]);\r\n    });\r\n    return requiredControl !== undefined;\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\nexport function getDefaultErrorMessages(): {[key: string]: string} {\r\n  return {\r\n    required: 'igo.common.form.errors.required'\r\n  };\r\n}\r\n\r\nexport function getControlErrorMessage(control: AbstractControl, messages: {[key: string]: string}): string {\r\n  const errors = control.errors || {};\r\n  const errorKeys = Object.keys(errors);\r\n  const errorMessages = errorKeys\r\n    .map((key: string) => messages[key])\r\n    .filter((message: string) => message !== undefined);\r\n  return errorMessages.length > 0 ? errorMessages[0] : '';\r\n}\r\n\r\nexport function getAllFormFields(form: Form): FormField[] {\r\n  return form.groups.reduce((acc: FormField[], group: FormFieldGroup) => {\r\n    return acc.concat(group.fields);\r\n  }, [].concat(form.fields));\r\n}\r\n\r\nexport function getFormFieldByName(form: Form, name: string): FormField {\r\n  const fields = getAllFormFields(form);\r\n  return fields.find((field: FormField) => {\r\n    return field.name === name;\r\n  });\r\n}\r\n","\r\n<form\r\n  [autocomplete]=\"autocomplete\"\r\n  [formGroup]=\"form.control\"\r\n  (ngSubmit)=\"onSubmit()\">\r\n  <div class=\"igo-form-body\" [ngClass]=\"{'igo-form-body-with-buttons': hasButtons}\">\r\n    <div class=\"igo-form-content\">\r\n      <ng-content></ng-content>\r\n    </div>\r\n    <div #buttons class=\"igo-form-buttons\">\r\n      <ng-content select=\"[formButtons]\"></ng-content>\r\n    </div>\r\n  </div>\r\n</form>\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\n\r\nimport { FormComponent } from './form.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    ReactiveFormsModule\r\n  ],\r\n  exports: [\r\n    FormComponent,\r\n    FormsModule,\r\n    ReactiveFormsModule\r\n  ],\r\n  declarations: [\r\n    FormComponent\r\n  ]\r\n})\r\nexport class IgoFormFormModule {}\r\n","import { Injectable } from '@angular/core';\r\nimport { FormBuilder, Validators, ValidatorFn } from '@angular/forms';\r\n\r\nimport {\r\n  Form,\r\n  FormField,\r\n  FormFieldConfig,\r\n  FormFieldGroup,\r\n  FormFieldGroupConfig\r\n} from './form.interfaces';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class FormService {\r\n\r\n  constructor(private formBuilder: FormBuilder) {}\r\n\r\n  form(fields: FormField[], groups: FormFieldGroup[]): Form {\r\n    const control = this.formBuilder.group({});\r\n    fields.forEach((field: FormField) => {\r\n      control.addControl(field.name, field.control);\r\n    });\r\n    groups.forEach((group: FormFieldGroup) => {\r\n      control.addControl(group.name, group.control);\r\n    });\r\n\r\n    return {fields, groups, control};\r\n  }\r\n\r\n  group(config: FormFieldGroupConfig, fields: FormField[]): FormFieldGroup {\r\n    const options = config.options || {};\r\n    const control = this.formBuilder.group({});\r\n    fields.forEach((field: FormField) => {\r\n      control.addControl(field.name, field.control);\r\n    });\r\n\r\n    if (options.validator) {\r\n      const validators = this.getValidators(options.validator); // convert string to actual validator\r\n      control.setValidators(validators);\r\n    }\r\n\r\n    return Object.assign({}, config, {fields, control}) as FormFieldGroup;\r\n  }\r\n\r\n  field(config: FormFieldConfig): FormField {\r\n    const options = config.options || {};\r\n    const state = {\r\n      value: '',\r\n      disabled: options.disabled\r\n    };\r\n    const control = this.formBuilder.control(state);\r\n\r\n    if (options.validator) {\r\n      const validators = this.getValidators(options.validator); // convert string to actual validator\r\n      control.setValidators(validators);\r\n    }\r\n\r\n    return Object.assign({type: 'text'}, config, {control}) as FormField;\r\n  }\r\n\r\n  extendFieldConfig(config: FormFieldConfig, partial: Partial<FormFieldConfig>): FormFieldConfig {\r\n    const options = Object.assign({}, config.options || {}, partial.options || {});\r\n    const inputs = Object.assign({}, config.inputs || {}, partial.inputs || {});\r\n    const subscribers = Object.assign({}, config.subscribers || {}, partial.subscribers || {});\r\n    return Object.assign({}, config, {options, inputs, subscribers});\r\n  }\r\n\r\n  private getValidators(validatorOption: string | string[] | ValidatorFn): ValidatorFn | ValidatorFn[] {\r\n    if (Array.isArray(validatorOption)) {\r\n      return validatorOption.map((validatorStr) => {\r\n        return this.getValidator(validatorStr);\r\n      });\r\n    }\r\n\r\n    return this.getValidator(validatorOption);\r\n  }\r\n\r\n  private getValidator(validatorStr: string | ValidatorFn): ValidatorFn {\r\n    if (typeof validatorStr !== 'string') {\r\n      return validatorStr;\r\n    }\r\n\r\n    // regex pattern to extract arguments from string for e.g applying on \"minLength(8)\" would extract 8\r\n    const re = /^([a-zA-Z]{3,15})\\((.{0,20})\\)$/;\r\n    const match = validatorStr.match(re);\r\n\r\n    if (!match) {\r\n      return Validators[validatorStr];\r\n    }\r\n\r\n    const name = match[1];\r\n    const args = match[2];\r\n    return Validators[name](args);\r\n  }\r\n\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\n/**\r\n * Service where all available form fields are registered.\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class FormFieldService {\r\n\r\n  static fields: {[key: string]: any} = {};\r\n\r\n  static register(type: string, component: any) {\r\n    FormFieldService.fields[type] = component;\r\n  }\r\n\r\n  constructor() {}\r\n\r\n  /**\r\n   * Return field component by type\r\n   * @param type Field type\r\n   * @returns Field component\r\n   */\r\n  getFieldByType(type: string): any {\r\n    return FormFieldService.fields[type];\r\n  }\r\n\r\n}\r\n","\r\n\r\n<ng-container *ngIf=\"field !== undefined\">\r\n  <igo-dynamic-outlet\r\n    [component]=\"getFieldComponent()\"\r\n    [inputs]=\"getFieldInputs()\"\r\n    [subscribers]=\"getFieldSubscribers()\">\r\n  </igo-dynamic-outlet>\r\n</ng-container>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\n\r\nimport { FormField, FormFieldInputs, FormFieldOptions } from '../shared/form.interfaces';\r\nimport { FormFieldService } from '../shared/form-field.service';\r\nimport { getDefaultErrorMessages } from '../shared';\r\n\r\n/**\r\n * This component renders the proper form input based on\r\n * the field configuration it receives.\r\n */\r\n@Component({\r\n  selector: 'igo-form-field',\r\n  templateUrl: './form-field.component.html',\r\n  styleUrls: ['./form-field.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class FormFieldComponent {\r\n\r\n  /**\r\n   * Field configuration\r\n   */\r\n  @Input() field: FormField;\r\n\r\n  /**\r\n   * Field inputs cache\r\n   */\r\n  private fieldInputs: FormFieldInputs = undefined;\r\n\r\n  /**\r\n   * Field subscribers cache\r\n   */\r\n  private fieldSubscribers: {[key: string]: ({field: FormField, control: FormControl}) => void } = undefined;\r\n\r\n  get fieldOptions(): FormFieldOptions {\r\n    return this.field.options || {};\r\n  }\r\n\r\n  constructor(private formFieldService: FormFieldService) {}\r\n\r\n  getFieldComponent(): any {\r\n    return this.formFieldService.getFieldByType(this.field.type || 'text');\r\n  }\r\n\r\n  getFieldInputs(): FormFieldInputs {\r\n    if (this.fieldInputs !== undefined) {\r\n      return this.fieldInputs;\r\n    }\r\n\r\n    const errors = this.fieldOptions.errors || {};\r\n    this.fieldInputs = Object.assign(\r\n      {\r\n        placeholder: this.field.title,\r\n        disableSwitch: this.fieldOptions.disableSwitch || false\r\n      },\r\n      Object.assign({}, this.field.inputs || {}),\r\n      {\r\n        formControl: this.field.control,\r\n        errors: Object.assign({}, getDefaultErrorMessages(), errors)\r\n      }\r\n    );\r\n    return this.fieldInputs;\r\n  }\r\n\r\n  getFieldSubscribers(): {[key: string]: ({field: FormField, control: FormControl}) => void } {\r\n    if (this.fieldSubscribers !== undefined) {\r\n      return this.fieldSubscribers;\r\n    }\r\n\r\n    this.fieldSubscribers = Object.assign({}, this.field.subscribers || {});\r\n    return this.fieldSubscribers;\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSelectModule } from '@angular/material/select';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoDynamicOutletModule } from '../../dynamic-component/dynamic-outlet/dynamic-outlet.module';\r\n\r\nimport { FormFieldComponent } from './form-field.component';\r\nimport { FormFieldSelectComponent } from './form-field-select.component';\r\nimport { FormFieldTextComponent } from './form-field-text.component';\r\nimport { FormFieldTextareaComponent } from './form-field-textarea.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    MatIconModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatSelectModule,\r\n    IgoLanguageModule,\r\n    IgoDynamicOutletModule\r\n  ],\r\n  exports: [\r\n    FormFieldComponent,\r\n    FormFieldSelectComponent,\r\n    FormFieldTextComponent,\r\n    FormFieldTextareaComponent\r\n  ],\r\n  declarations: [\r\n    FormFieldComponent,\r\n    FormFieldSelectComponent,\r\n    FormFieldTextComponent,\r\n    FormFieldTextareaComponent\r\n  ]\r\n})\r\nexport class IgoFormFieldModule {}\r\n","<div\r\n  *ngIf=\"group && group.fields.length > 0\"\r\n  class=\"igo-form-group-fields\">\r\n  <div\r\n    *ngFor=\"let field of group.fields\"\r\n    class=\"igo-form-field-wrapper\"\r\n    [ngClass]=\"getFieldNgClass(field)\">\r\n    <igo-form-field [field]=\"field\"></igo-form-field>\r\n  </div>\r\n</div>\r\n\r\n<div class=\"igo-form-group-extra-content\">\r\n  <ng-content></ng-content>\r\n</div>\r\n\r\n<mat-error *ngIf=\"formControl.errors\">{{getErrorMessage() | translate}}</mat-error>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\nimport { FormGroup } from '@angular/forms';\r\n\r\nimport { getControlErrorMessage } from '../shared/form.utils';\r\nimport { FormField, FormFieldGroup } from '../shared/form.interfaces';\r\n\r\n/**\r\n * A configurable form, optionnally bound to an entity\r\n * (for example in case of un update). Submitting that form\r\n * emits an event with the form data but no other operation is performed.\r\n */\r\n@Component({\r\n  selector: 'igo-form-group',\r\n  templateUrl: './form-group.component.html',\r\n  styleUrls: ['./form-group.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class FormGroupComponent {\r\n\r\n  /**\r\n   * Form field group\r\n   */\r\n  @Input() group: FormFieldGroup;\r\n\r\n  /**\r\n   * Field placeholder\r\n   */\r\n  @Input() errors: {[key: string]: string};\r\n\r\n  /**\r\n   * Form group control\r\n   */\r\n  get formControl(): FormGroup { return this.group.control; }\r\n\r\n  constructor() {}\r\n\r\n  /**\r\n   * Return the number of columns a field should occupy.\r\n   * The maximum allowed is 2, even if the field config says more.\r\n   * @param field Field\r\n   * @returns Number of columns\r\n   * @internal\r\n   */\r\n  getFieldColSpan(field: FormField): number {\r\n    let colSpan = 2;\r\n    const options = field.options || {};\r\n    if (options.cols && options.cols > 0) {\r\n      colSpan = Math.min(options.cols, 2);\r\n    }\r\n\r\n    return colSpan;\r\n  }\r\n\r\n  /**\r\n   * Return the number of columns a field should occupy.\r\n   * The maximum allowed is 2, even if the field config says more.\r\n   * @param field Field\r\n   * @returns Number of columns\r\n   * @internal\r\n   */\r\n  getFieldNgClass(field: FormField): {[key: string]: boolean} {\r\n    const colspan = this.getFieldColSpan(field);\r\n    return {[`igo-form-field-colspan-${colspan}`]: true};\r\n  }\r\n\r\n  /**\r\n   * Get error message\r\n   */\r\n  getErrorMessage(): string {\r\n    const options = this.group.options || {};\r\n    return getControlErrorMessage(this.formControl, options.errors || {});\r\n  }\r\n\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { IgoFormFieldModule } from '../form-field/form-field.module';\r\nimport { FormGroupComponent } from './form-group.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatFormFieldModule,\r\n    IgoLanguageModule,\r\n    IgoFormFieldModule\r\n  ],\r\n  exports: [\r\n    FormGroupComponent\r\n  ],\r\n  declarations: [\r\n    FormGroupComponent\r\n  ]\r\n})\r\nexport class IgoFormGroupModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoFormFormModule } from './form/form.module';\r\nimport { IgoFormGroupModule } from './form-group/form-group.module';\r\nimport { IgoFormFieldModule } from './form-field/form-field.module';\r\nimport { FormService } from './shared/form.service';\r\nimport { FormFieldService } from './shared/form-field.service';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoFormGroupModule,\r\n    IgoFormFieldModule\r\n  ],\r\n  exports: [\r\n    IgoFormFormModule,\r\n    IgoFormGroupModule,\r\n    IgoFormFieldModule\r\n  ],\r\n  declarations: [],\r\n  providers: [\r\n    FormService,\r\n    FormFieldService\r\n  ]\r\n})\r\nexport class IgoFormModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\n\r\nimport { MatSelectModule } from '@angular/material/select';\r\n\r\nimport { EntitySelectorComponent } from './entity-selector.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    MatSelectModule\r\n  ],\r\n  exports: [EntitySelectorComponent],\r\n  declarations: [EntitySelectorComponent]\r\n})\r\nexport class IgoEntitySelectorModule {}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { StopDropPropagationDirective } from './stop-drop-propagation.directive';\r\nimport { StopPropagationDirective } from './stop-propagation.directive';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [StopDropPropagationDirective, StopPropagationDirective],\r\n  exports: [StopDropPropagationDirective, StopPropagationDirective]\r\n})\r\nexport class IgoStopPropagationModule {\r\n  static forRoot(): ModuleWithProviders<IgoStopPropagationModule> {\r\n    return {\r\n      ngModule: IgoStopPropagationModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { EntityTablePaginatorComponent } from './entity-table-paginator.component';\r\nimport { MatPaginatorModule } from '@angular/material/paginator';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    MatPaginatorModule,\r\n  ],\r\n  exports: [\r\n    EntityTablePaginatorComponent\r\n  ],\r\n  declarations: [\r\n    EntityTablePaginatorComponent,\r\n  ]\r\n})\r\nexport class IgoEntityTablePaginatorModule {}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { SecureImagePipe } from './secure-image.pipe';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [SecureImagePipe],\r\n  exports: [SecureImagePipe]\r\n})\r\nexport class IgoImageModule {\r\n  static forRoot(): ModuleWithProviders<IgoImageModule> {\r\n    return {\r\n      ngModule: IgoImageModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatSortModule } from '@angular/material/sort';\r\nimport { MatTableModule } from '@angular/material/table';\r\nimport { MatAutocompleteModule } from '@angular/material/autocomplete';\r\n\r\nimport { IgoStopPropagationModule } from '../../stop-propagation/stop-propagation.module';\r\nimport { IgoCustomHtmlModule } from '../../custom-html/custom-html.module';\r\nimport { EntityTableRowDirective } from './entity-table-row.directive';\r\nimport { EntityTableComponent } from './entity-table.component';\r\nimport { MatPaginatorModule } from '@angular/material/paginator';\r\nimport { IgoEntityTablePaginatorModule } from '../entity-table-paginator/entity-table-paginator.module';\r\nimport { IgoImageModule } from '../../image/image.module';\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\nimport { MatDatepickerModule } from '@angular/material/datepicker';\r\nimport { MatSelectModule } from '@angular/material/select';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatTableModule,\r\n    MatAutocompleteModule,\r\n    MatSortModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatCheckboxModule,\r\n    MatPaginatorModule,\r\n    MatSelectModule,\r\n    IgoStopPropagationModule,\r\n    IgoCustomHtmlModule,\r\n    IgoEntityTablePaginatorModule,\r\n    IgoImageModule,\r\n    IgoLanguageModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    MatInputModule,\r\n    MatDatepickerModule,\r\n    MatTooltipModule\r\n  ],\r\n  exports: [\r\n    EntityTableComponent\r\n  ],\r\n  declarations: [\r\n    EntityTableComponent,\r\n    EntityTableRowDirective\r\n  ]\r\n})\r\nexport class IgoEntityTableModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoEntitySelectorModule } from './entity-selector/entity-selector.module';\r\nimport { IgoEntityTableModule } from './entity-table/entity-table.module';\r\nimport { IgoEntityTablePaginatorModule } from './entity-table-paginator/entity-table-paginator.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule\r\n  ],\r\n  exports: [\r\n    IgoEntitySelectorModule,\r\n    IgoEntityTableModule,\r\n    IgoEntityTablePaginatorModule\r\n  ],\r\n  declarations: []\r\n})\r\nexport class IgoEntityModule {}\r\n","import { catchError } from 'rxjs/operators';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { Observable } from 'rxjs';\r\nimport { Injectable } from '@angular/core';\r\nimport { InteractiveTourOptions } from './interactive-tour.interface';\r\nimport { ConfigService } from '@igo2/core';\r\n\r\n@Injectable()\r\nexport class InteractiveTourLoader {\r\n  private jsonURL: string;\r\n  private allToursOptions;\r\n\r\n  constructor(private http: HttpClient, private configService: ConfigService) {\r\n    this.jsonURL = this.getPathToConfigFile();\r\n  }\r\n\r\n   public loadConfigTour() {\r\n      this.getJSON()\r\n        .subscribe(\r\n          (data) => {\r\n            this.allToursOptions = data;\r\n          },\r\n          (err) => {\r\n            throw new Error(`Problem with Interactive tour configuration file: interactiveTour.json not find. Check if the file and is path is set correctly.`);\r\n          }\r\n        );\r\n   }\r\n\r\n  public getPathToConfigFile(): string {\r\n    return (\r\n      this.configService.getConfig('interactiveTour.pathToConfigFile') ||\r\n      './config/interactiveTour.json'\r\n    );\r\n  }\r\n\r\n  public getJSON(): Observable<any> {\r\n    return this.http.get(this.jsonURL).pipe(\r\n      catchError((e) => {\r\n        e.error.caught = true;\r\n        throw e;\r\n      })\r\n    );\r\n  }\r\n\r\n  public getTourOptionData(toolName): InteractiveTourOptions {\r\n    if (this.allToursOptions === undefined) {\r\n      return undefined;\r\n    }\r\n    let nameInConfigFile = toolName;\r\n    nameInConfigFile = nameInConfigFile.replace(/\\s/g, '');\r\n    return this.allToursOptions[nameInConfigFile];\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { ShepherdService } from 'angular-shepherd';\r\n\r\nimport { ConfigService, MediaService, LanguageService } from '@igo2/core';\r\nimport { InteractiveTourLoader } from './interactive-tour.loader';\r\nimport {\r\n  InteractiveTourOptions,\r\n  InteractiveTourStep,\r\n  InteractiveTourAction\r\n} from './interactive-tour.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class InteractiveTourService {\r\n  private previousStep: InteractiveTourStep;\r\n  private nextIndex = 1;\r\n\r\n  constructor(\r\n    private configService: ConfigService,\r\n    private mediaService: MediaService,\r\n    private languageService: LanguageService,\r\n    private interactiveTourLoader: InteractiveTourLoader,\r\n    private shepherdService: ShepherdService\r\n  ) {\r\n    if (this.isAppHaveTour()) {\r\n      this.interactiveTourLoader.loadConfigTour();\r\n    }\r\n  }\r\n\r\n  public isAppHaveTour() {\r\n    const haveTour = this.configService.getConfig('interactiveTour.activateInteractiveTour');\r\n    if (haveTour === undefined) {\r\n      return true;\r\n    } else {\r\n      return haveTour;\r\n    }\r\n  }\r\n\r\n  public isToolHaveTourConfig(toolName: string): boolean {\r\n    const checkTourActiveOptions = this.interactiveTourLoader.getTourOptionData(\r\n      toolName\r\n    );\r\n    if (checkTourActiveOptions === undefined) {\r\n      return false;\r\n    } else {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  public disabledTourButton(toolName: string): boolean {\r\n    const stepConfig: InteractiveTourOptions = this.interactiveTourLoader.getTourOptionData(\r\n      toolName\r\n    );\r\n\r\n    if (stepConfig?.conditions) {\r\n      for (const condition of stepConfig?.conditions) {\r\n        if (document.querySelector(condition) === null) {\r\n          return true;\r\n        }\r\n      }\r\n    }\r\n    return false;\r\n  }\r\n\r\n  public isMobile(): boolean {\r\n    return this.mediaService.isMobile();\r\n  }\r\n\r\n  public isTourDisplayInMobile(): boolean {\r\n    const showInMobile = this.configService.getConfig(\r\n      'interactiveTour.tourInMobile'\r\n    );\r\n    if (showInMobile === undefined) {\r\n      return true;\r\n    }\r\n    return this.configService.getConfig('interactiveTour.tourInMobile');\r\n  }\r\n\r\n  private getButtons(buttonKind?: 'first' | 'last' | 'noBackButton') {\r\n    if (buttonKind === 'noBackButton') {\r\n      return [\r\n        {\r\n          classes: 'shepherd-button-primary',\r\n          text: this.languageService.translate.instant(\r\n            'igo.common.interactiveTour.nextButton'\r\n          ),\r\n          type: 'next'\r\n        }\r\n      ];\r\n    }\r\n    if (buttonKind === 'first') {\r\n      return [\r\n        {\r\n          classes: 'shepherd-button-secondary',\r\n          text: this.languageService.translate.instant(\r\n            'igo.common.interactiveTour.exitButton'\r\n          ),\r\n          type: 'cancel'\r\n        },\r\n        {\r\n          classes: 'shepherd-button-primary',\r\n          text: this.languageService.translate.instant(\r\n            'igo.common.interactiveTour.nextButton'\r\n          ),\r\n          type: 'next'\r\n        }\r\n      ];\r\n    }\r\n\r\n    if (buttonKind === 'last') {\r\n      return [\r\n        {\r\n          classes: 'shepherd-button-secondary',\r\n          text: this.languageService.translate.instant(\r\n            'igo.common.interactiveTour.backButton'\r\n          ),\r\n          type: 'back'\r\n        },\r\n        {\r\n          classes: 'shepherd-button-primary',\r\n          text: this.languageService.translate.instant(\r\n            'igo.common.interactiveTour.exitButton'\r\n          ),\r\n          type: 'cancel'\r\n        }\r\n      ];\r\n    }\r\n\r\n    return [\r\n      {\r\n        classes: 'shepherd-button-secondary',\r\n        text: this.languageService.translate.instant(\r\n          'igo.common.interactiveTour.backButton'\r\n        ),\r\n        type: 'back'\r\n      },\r\n      {\r\n        classes: 'shepherd-button-primary',\r\n        text: this.languageService.translate.instant(\r\n          'igo.common.interactiveTour.nextButton'\r\n        ),\r\n        type: 'next'\r\n      }\r\n    ];\r\n  }\r\n\r\n  private getAction(actionName: string) {\r\n    const action = {\r\n      click: 'click'\r\n    };\r\n    return action[actionName.toLowerCase()];\r\n  }\r\n\r\n  private addProgress() {\r\n    const self = this as any;\r\n    let nbTry = 0;\r\n    const maxTry = 21;\r\n    const checkExist = setInterval(() => {\r\n      if (self.getCurrentStep()) {\r\n        if (self.getCurrentStep().options.attachTo.element && !document.querySelector(self.getCurrentStep().options.attachTo.element)) {\r\n          self.cancel();\r\n          clearInterval(checkExist);\r\n          return;\r\n        } else {\r\n          const currentStepElement = self.getCurrentStep().getElement();\r\n          if (currentStepElement) {\r\n            const shepherdList = currentStepElement.querySelectorAll('.shepherd-content, .shepherd-text');\r\n            shepherdList.forEach(element => {\r\n              element.classList.add('mat-typography');\r\n            });\r\n          }\r\n          const header = currentStepElement\r\n            ? currentStepElement.querySelector('.shepherd-header')\r\n            : undefined;\r\n\r\n          nbTry++;\r\n          if (header || nbTry > maxTry) {\r\n            clearInterval(checkExist);\r\n          }\r\n\r\n          if (header) {\r\n            const stepsArray = self.steps;\r\n            const progress = document.createElement('span');\r\n            progress.className = 'shepherd-progress';\r\n            progress.innerText = `${\r\n              stepsArray.indexOf(self.getCurrentStep()) + 1\r\n            }/${stepsArray.length}`;\r\n            header.insertBefore(\r\n              progress,\r\n              currentStepElement.querySelector('.shepherd-cancel-icon')\r\n            );\r\n          }\r\n        }\r\n      }\r\n    }, 100);\r\n  }\r\n\r\n  private checkNext(index, tour, service) {\r\n    if (tour.getCurrentStep()) {\r\n      if (tour.getCurrentStep().options.attachTo.element && document.querySelector(tour.getCurrentStep().options.attachTo.element)) {\r\n        tour.complete();\r\n        return;\r\n      }\r\n\r\n      if (index.index === tour.steps.length - 1) {\r\n        tour.complete();\r\n        return;\r\n      }\r\n\r\n      tour.steps.splice(index.index, 1);\r\n      const nextStep = tour.steps[index.index];\r\n      if (nextStep.options.attachTo.element && !document.querySelector(nextStep.options.attachTo.element)) {\r\n        service.checkNext(index, tour, service);\r\n      } else {\r\n        tour._setupModal();\r\n        tour.show(nextStep.id);\r\n      }\r\n    }\r\n  }\r\n\r\n  private executeAction(\r\n    step: InteractiveTourStep,\r\n    actionConfig: InteractiveTourAction\r\n  ) {\r\n    if (!actionConfig) {\r\n      return;\r\n    }\r\n\r\n    if (\r\n      actionConfig.condition &&\r\n      ((actionConfig.condition.charAt(0) === '!' &&\r\n        document.querySelector(actionConfig.condition.slice(1))) ||\r\n        (actionConfig.condition.charAt(0) !== '!' &&\r\n          !document.querySelector(actionConfig.condition)))\r\n    ) {\r\n      return;\r\n    }\r\n\r\n    const element: HTMLElement = document.querySelector(\r\n      actionConfig.element || step.element\r\n    ) as HTMLElement;\r\n    const action = this.getAction(actionConfig.action);\r\n    if (element && action) {\r\n      element[action]();\r\n    }\r\n  }\r\n\r\n  private executeActionPromise(\r\n    step: InteractiveTourStep,\r\n    actionConfig: InteractiveTourAction\r\n  ) {\r\n    return new Promise<void>((resolve) => {\r\n      this.executeAction(step, actionConfig);\r\n      if (!actionConfig || !actionConfig.waitFor) {\r\n        resolve();\r\n        return;\r\n      }\r\n      let nbTry = 0;\r\n      const maxTry = actionConfig.maxWait ? actionConfig.maxWait / 100 : 20;\r\n      const checkExist = setInterval(() => {\r\n        nbTry++;\r\n        if (nbTry > maxTry || document.querySelector(actionConfig.waitFor)) {\r\n          clearInterval(checkExist);\r\n          resolve();\r\n        }\r\n      }, 100);\r\n    });\r\n  }\r\n\r\n  private getShepherdSteps(stepConfig: InteractiveTourOptions) {\r\n    const shepherdSteps = [];\r\n\r\n    let i = 0;\r\n    for (const step of stepConfig.steps) {\r\n      shepherdSteps.push({\r\n        attachTo: {\r\n          element: step.element,\r\n          on: step.position || stepConfig.position\r\n        },\r\n        popperOptions: {\r\n          modifiers: [{ name: 'offset', options: { offset: [0, 15] } }]\r\n        },\r\n        beforeShowPromise: () => {\r\n          return Promise.all([\r\n            this.executeActionPromise(\r\n              this.previousStep,\r\n              this.previousStep ? this.previousStep.beforeChange : undefined\r\n            ),\r\n            this.executeActionPromise(step, step.beforeShow)\r\n          ]);\r\n        },\r\n        buttons: this.getButtons(\r\n          i === 0\r\n            ? 'first'\r\n            : i + 1 === stepConfig.steps.length\r\n            ? 'last'\r\n            : stepConfig.steps[i].noBackButton\r\n            ? 'noBackButton'\r\n            : undefined\r\n        ),\r\n        classes: step.class,\r\n        highlightClass: step.highlightClass,\r\n        scrollTo: step.scrollToElement || stepConfig.scrollToElement || true,\r\n        canClickTarget: step.disableInteraction\r\n          ? !step.disableInteraction\r\n          : undefined,\r\n        title: this.languageService.translate.instant(\r\n          step.title || stepConfig.title\r\n        ),\r\n        text: [this.languageService.translate.instant(step.text)],\r\n        when: {\r\n          show: () => {\r\n            this.executeAction(step, step.onShow);\r\n          },\r\n          hide: () => {\r\n            this.previousStep = step;\r\n            this.executeAction(step, step.onHide);\r\n          }\r\n        }\r\n      });\r\n      i++;\r\n    }\r\n\r\n    return shepherdSteps;\r\n  }\r\n\r\n  public startTour(toolName: string) {\r\n    const stepConfig: InteractiveTourOptions = this.interactiveTourLoader.getTourOptionData(\r\n      toolName\r\n    );\r\n\r\n    this.shepherdService.defaultStepOptions = {\r\n      classes: stepConfig.class,\r\n      highlightClass: stepConfig.highlightClass,\r\n      canClickTarget: stepConfig.disableInteraction\r\n        ? !stepConfig.disableInteraction\r\n        : true,\r\n      cancelIcon: {\r\n        enabled: true\r\n      }\r\n    };\r\n\r\n    const shepherdSteps = this.getShepherdSteps(stepConfig);\r\n\r\n    this.shepherdService.modal = true;\r\n    this.shepherdService.confirmCancel = false;\r\n    this.shepherdService.addSteps(shepherdSteps);\r\n\r\n    this.shepherdService.tourObject.on('show', this.addProgress);\r\n    this.shepherdService.tourObject.on('cancel', (index) =>{\r\n      this.checkNext(index, this.shepherdService.tourObject, this);\r\n    });\r\n\r\n    this.shepherdService.start();\r\n  }\r\n}\r\n","import { EntityRecord, EntityStore } from '../../entity';\r\nimport { Tool, ToolboxOptions } from './tool.interface';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\n/**\r\n * Service where all available tools and their component are registered.\r\n */\r\nexport class Toolbox {\r\n  /**\r\n   * Observable of the active tool\r\n   */\r\n  activeTool$: BehaviorSubject<Tool> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Ordered list of tool names to display in a toolbar\r\n   */\r\n  toolbar$: BehaviorSubject<string[]> = new BehaviorSubject([]);\r\n\r\n  /**\r\n   * Observable of the active tool\r\n   */\r\n  private activeTool$$: Subscription;\r\n\r\n  /**\r\n   * Active tool history. Useful for activating the previous tool.\r\n   */\r\n  private activeToolHistory: string[] = [];\r\n\r\n  /**\r\n   * Tool store\r\n   */\r\n  private store = new EntityStore<Tool>([], {\r\n    getKey: (tool: Tool) => tool.name\r\n  });\r\n\r\n  get tools$(): BehaviorSubject<Tool[]> {\r\n    return this.store.entities$;\r\n  }\r\n\r\n  constructor(private options: ToolboxOptions = {}) {\r\n    this.setToolbar(options.toolbar);\r\n    this.initStore();\r\n  }\r\n\r\n  /**\r\n   * Destroy the toolbox\r\n   */\r\n  destroy() {\r\n    this.activeTool$$.unsubscribe();\r\n    this.store.destroy();\r\n  }\r\n\r\n  /**\r\n   * Return a tool\r\n   * @param name Tool name\r\n   * @returns tool Tool\r\n   */\r\n  getTool(name: string): Tool {\r\n    return this.store.get(name);\r\n  }\r\n\r\n  /**\r\n   * Return all tools\r\n   * @returns Array of tools\r\n   */\r\n  getTools(): Tool[] {\r\n    return this.store.all();\r\n  }\r\n\r\n  /**\r\n   * Set tool configurations\r\n   * @param tools Tools\r\n   */\r\n  setTools(tools: Tool[]) {\r\n    this.store.load(tools);\r\n  }\r\n\r\n  /**\r\n   * Get toolbar\r\n   * @returns Toolbar value\r\n   */\r\n  getToolbar(): string[] {\r\n    return this.toolbar$.getValue();\r\n  }\r\n\r\n  /**\r\n   * Set toolbar\r\n   * @param toolbar A list of tool names\r\n   */\r\n  setToolbar(toolbar: string[]) {\r\n    this.toolbar$.next(toolbar || []);\r\n  }\r\n\r\n  /**\r\n   * Activate a tool (and deactivate other tools)\r\n   * @param name Tool name\r\n   * @param options Tool options\r\n   */\r\n  activateTool(name: string, options: { [key: string]: any } = {}) {\r\n    const tool = this.getTool(name);\r\n    if (tool === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.store.state.update(tool, { active: true, options }, true);\r\n  }\r\n\r\n  /**\r\n   * Activate the previous tool, if any\r\n   */\r\n  activatePreviousTool() {\r\n    if (this.activeToolHistory.length <= 1) {\r\n      this.deactivateTool();\r\n      return;\r\n    }\r\n    const [previous, current] = this.activeToolHistory.splice(-2, 2);\r\n    this.activateTool(previous);\r\n  }\r\n\r\n  /**\r\n   * Activate the tool below, if any\r\n   */\r\n  /* activateBelowTool() {\r\n    const arrayTools = this.getToolbar();\r\n    const index = arrayTools.findIndex(t => t === this.activeTool$.getValue().name);\r\n    if (arrayTools[index + 1] !== undefined) {\r\n      this.deactivateTool();\r\n      const below = arrayTools[index + 1];\r\n      this.activateTool(below);\r\n    } else {\r\n      this.deactivateTool();\r\n      const below = arrayTools[0];\r\n      this.activateTool(below);\r\n    }\r\n  } */\r\n\r\n  /**\r\n   * Activate the tool above, if any\r\n   */\r\n  /* activateAboveTool() {\r\n    const arrayTools = this.getToolbar();\r\n    const index = arrayTools.findIndex(t => t === this.activeTool$.getValue().name);\r\n    if (arrayTools[index - 1] !== undefined) {\r\n      this.deactivateTool();\r\n      const above = arrayTools[index - 1];\r\n      this.activateTool(above);\r\n    } else {\r\n      this.deactivateTool();\r\n      const above = arrayTools[arrayTools.length - 1];\r\n      this.activateTool(above);\r\n    }\r\n  } */\r\n\r\n  /**\r\n   * Deactivate the active tool\r\n   */\r\n  deactivateTool() {\r\n    this.clearActiveToolHistory();\r\n    this.store.state.updateAll({ active: false });\r\n  }\r\n\r\n  /**\r\n   * Initialize the tool store and start observing the active tool\r\n   */\r\n  private initStore() {\r\n    this.store = new EntityStore<Tool>([], {\r\n      getKey: (entity: Tool) => entity.name\r\n    });\r\n\r\n    this.activeTool$$ = this.store.stateView\r\n      .firstBy$((record: EntityRecord<Tool>) => record.state.active === true)\r\n      .subscribe((record: EntityRecord<Tool>) => {\r\n        if (record === undefined) {\r\n          this.setActiveTool(undefined);\r\n          return;\r\n        }\r\n\r\n        const tool = record.entity;\r\n        const options = Object.assign(\r\n          {},\r\n          tool.options || {},\r\n          record.state.options || {}\r\n        );\r\n        this.setActiveTool(Object.assign({}, tool, { options }));\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Set the active tool and update the tool history\r\n   * @param tool Tool\r\n   */\r\n  private setActiveTool(tool: Tool | undefined) {\r\n    this.activeTool$.next(tool);\r\n    if (tool === undefined) {\r\n      this.clearActiveToolHistory();\r\n    } else {\r\n      this.activeToolHistory = this.activeToolHistory\r\n        .filter((name: string) => name !== tool.name)\r\n        .concat([tool.name]);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the tool history\r\n   */\r\n  private clearActiveToolHistory() {\r\n    this.activeToolHistory = [];\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { Tool } from './tool.interface';\r\nimport { Toolbox } from './toolbox';\r\n\r\n/**\r\n * Service where runtime tool configurations are registered\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ToolService {\r\n  static tools: { [key: string]: Tool } = {};\r\n\r\n  /**\r\n   * Toolbox that holds main tools\r\n   */\r\n  public toolbox: Toolbox = new Toolbox();\r\n\r\n  static register(tool: Tool) {\r\n    ToolService.tools[tool.name] = tool;\r\n  }\r\n\r\n  constructor() {\r\n    this.toolbox.setTools(this.getTools());\r\n  }\r\n\r\n  /**\r\n   * Return a tool\r\n   * @param name Tool name\r\n   * @returns tool Tool\r\n   */\r\n  getTool(name: string): Tool {\r\n    return ToolService.tools[name];\r\n  }\r\n\r\n  /**\r\n   * Return all tools\r\n   * @returns tTols\r\n   */\r\n  getTools(): Tool[] {\r\n    return Object.values(ToolService.tools);\r\n  }\r\n}\r\n","<button *ngIf=\"showTourButton\"\r\n  (click) = \"startInteractiveTour()\"\r\n  [ngClass]=\"getClass()\"\r\n  mat-raised-button\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [disabled]=disabledTourButton>\r\n  <span class=\"interactive-tour-button-title\">{{'igo.common.interactiveTour.buttonTitle' | translate}} {{(discoverTitleInLocale$ | async) | translate}}</span>\r\n  <mat-icon\r\n    svgIcon=\"presentation-play\"\r\n    [matTooltip]=\"disabledTourButton ?\r\n    ('igo.common.interactiveTour.disaledTooltipTourToolButton' | translate) :\r\n    ('igo.common.interactiveTour.tooltipTourToolButton' | translate)\">\r\n  </mat-icon>\r\n</button>\r\n","import { Component, ViewEncapsulation, Input } from '@angular/core';\r\nimport { InteractiveTourService } from './interactive-tour.service';\r\nimport { ToolService } from '../tool/shared/tool.service';\r\nimport { Observable, of } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'igo-interactive-tour',\r\n  templateUrl: './interactive-tour.component.html',\r\n  styleUrls: ['./interactive-tour.component.scss'],\r\n  encapsulation: ViewEncapsulation.None\r\n})\r\nexport class InteractiveTourComponent {\r\n  /**\r\n   * Toolbox that holds main tools\r\n   */\r\n  @Input() tourToStart: string = '';\r\n  @Input() styleButton: string;\r\n  @Input() discoverTitleInLocale$: Observable<string> = of('IGO');\r\n\r\n  getClass() {\r\n    return {\r\n      'tour-button-tool-icon': this.styleButton === 'icon',\r\n      'tour-button-tool': this.styleButton === 'raised'\r\n    };\r\n  }\r\n\r\n  get toolbox() {\r\n    return this.toolService.toolbox;\r\n  }\r\n\r\n  getTourToStart() {\r\n    if (this.tourToStart) {\r\n      return this.tourToStart;\r\n    } else {\r\n      return this.activeToolName;\r\n    }\r\n  }\r\n\r\n  get activeToolName() {\r\n    if (this.toolbox) {\r\n      if (this.isActiveTool) {\r\n        return this.toolbox.activeTool$.getValue().name;\r\n      } else {\r\n        return 'global';\r\n      }\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  get isActiveTool(): boolean {\r\n    if (this.toolbox) {\r\n      return this.toolbox.activeTool$.getValue() !== undefined;\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  get isToolHaveTour(): boolean {\r\n    if (this.activeToolName === 'about' && !this.tourToStart) {\r\n      return false;\r\n    }\r\n    return this.interactiveTourService.isToolHaveTourConfig(\r\n      this.getTourToStart()\r\n    );\r\n  }\r\n\r\n  get showTourButton(): boolean {\r\n    // 2 conditions to show: have Tour on tool in Config file and if we are in mobile displayInMobile= true\r\n    let haveTour: boolean;\r\n    haveTour = this.isToolHaveTour;\r\n    if (haveTour === false) {\r\n      return false;\r\n    }\r\n\r\n    let inMobileAndShow: boolean;\r\n    if (this.interactiveTourService.isMobile()) {\r\n      inMobileAndShow = this.isTourDisplayInMobile;\r\n      if (inMobileAndShow === false) {\r\n        return false;\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n\r\n  get isTourDisplayInMobile(): boolean {\r\n    return this.interactiveTourService.isTourDisplayInMobile();\r\n  }\r\n\r\n  get disabledTourButton(): boolean {\r\n    return this.interactiveTourService.disabledTourButton(this.activeToolName);\r\n  }\r\n\r\n  constructor(\r\n    private interactiveTourService: InteractiveTourService,\r\n    private toolService: ToolService\r\n  ) {}\r\n\r\n  startInteractiveTour() {\r\n    const tour = this.getTourToStart();\r\n    if (tour) {\r\n      this.interactiveTourService.startTour(tour);\r\n    } else {\r\n      return;\r\n    }\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { InteractiveTourService } from './interactive-tour.service';\r\nimport { InteractiveTourComponent } from './interactive-tour.component';\r\nimport { InteractiveTourLoader } from './interactive-tour.loader';\r\n\r\n@NgModule({\r\n  declarations: [InteractiveTourComponent],\r\n  imports: [\r\n    CommonModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatTooltipModule,\r\n    IgoLanguageModule\r\n  ],\r\n  providers: [InteractiveTourService, InteractiveTourLoader],\r\n  exports: [InteractiveTourComponent]\r\n})\r\nexport class IgoInteractiveTourModule {}\r\n","import { Pipe, PipeTransform } from '@angular/core';\r\n\r\n@Pipe({\r\n  name: 'keyvalue'\r\n})\r\nexport class KeyValuePipe implements PipeTransform {\r\n  transform(value: any, args?: any): any {\r\n    const keyValues = [];\r\n    Object.getOwnPropertyNames(value).forEach((key: string) =>\r\n      keyValues.push({ key, value: value[key] })\r\n    );\r\n\r\n    return keyValues;\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { KeyValuePipe } from './keyvalue.pipe';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [KeyValuePipe],\r\n  exports: [KeyValuePipe]\r\n})\r\nexport class IgoKeyValueModule {\r\n  static forRoot(): ModuleWithProviders<IgoKeyValueModule> {\r\n    return {\r\n      ngModule: IgoKeyValueModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import {\r\n  Directive,\r\n  Input,\r\n  Output,\r\n  ElementRef,\r\n  Renderer2,\r\n  HostListener,\r\n  EventEmitter\r\n} from '@angular/core';\r\n\r\n@Directive({\r\n  selector: '[igoListItem]'\r\n})\r\nexport class ListItemDirective {\r\n\r\n  static focusedCls = 'igo-list-item-focused';\r\n  static selectedCls = 'igo-list-item-selected';\r\n  static disabledCls = 'igo-list-item-disabled';\r\n\r\n  @Input()\r\n  get color() {\r\n    return this._color;\r\n  }\r\n  set color(value: string) {\r\n    this._color = value;\r\n  }\r\n  private _color = 'primary';\r\n\r\n  @Input()\r\n  get focused() {\r\n    return this._focused;\r\n  }\r\n  set focused(value: boolean) {\r\n    if (value === this._focused) {\r\n      return;\r\n    }\r\n    if (this.disabled) {\r\n      return;\r\n    }\r\n\r\n    value ? this.beforeFocus.emit(this) : this.beforeUnfocus.emit(this);\r\n\r\n    this._focused = value;\r\n    if (this.selected !== true) {\r\n      this.toggleFocusedClass();\r\n    }\r\n\r\n    value ? this.focus.emit(this) : this.unfocus.emit(this);\r\n  }\r\n  private _focused = false;\r\n\r\n  @Input()\r\n  get selected() {\r\n    return this._selected;\r\n  }\r\n  set selected(value: boolean) {\r\n    if (value === this._selected) {\r\n      return;\r\n    }\r\n    if (this.disabled) {\r\n      return;\r\n    }\r\n\r\n    value ? this.beforeSelect.emit(this) : this.beforeUnselect.emit(this);\r\n\r\n    this._selected = value;\r\n    this._focused = value;\r\n    this.toggleSelectedClass();\r\n\r\n    value ? this.select.emit(this) : this.unselect.emit(this);\r\n  }\r\n  private _selected = false;\r\n\r\n  @Input()\r\n  get disabled() {\r\n    return this._disabled;\r\n  }\r\n  set disabled(value: boolean) {\r\n    if (value === this._disabled) {\r\n      return;\r\n    }\r\n\r\n    if (value === true) {\r\n      this.selected = false;\r\n    }\r\n\r\n    value ? this.beforeDisable.emit(this) : this.beforeEnable.emit(this);\r\n\r\n    this._disabled = value;\r\n    this.toggleDisabledClass();\r\n\r\n    value ? this.disable.emit(this) : this.enable.emit(this);\r\n  }\r\n  private _disabled = false;\r\n\r\n  @Output() beforeSelect = new EventEmitter<ListItemDirective>();\r\n  @Output() beforeFocus = new EventEmitter<ListItemDirective>();\r\n  @Output() beforeUnselect = new EventEmitter<ListItemDirective>();\r\n  @Output() beforeUnfocus = new EventEmitter<ListItemDirective>();\r\n  @Output() beforeDisable = new EventEmitter<ListItemDirective>();\r\n  @Output() beforeEnable = new EventEmitter<ListItemDirective>();\r\n  @Output() focus = new EventEmitter<ListItemDirective>();\r\n  @Output() unfocus = new EventEmitter<ListItemDirective>();\r\n  @Output() select = new EventEmitter<ListItemDirective>();\r\n  @Output() unselect = new EventEmitter<ListItemDirective>();\r\n  @Output() disable = new EventEmitter<ListItemDirective>();\r\n  @Output() enable = new EventEmitter<ListItemDirective>();\r\n\r\n  @HostListener('click')\r\n  onClick() {\r\n    this.selected = true;\r\n  }\r\n\r\n  constructor(public renderer: Renderer2, public el: ElementRef) {}\r\n\r\n  getOffsetTop(): number {\r\n    const padding = 5;\r\n\r\n    return this.el.nativeElement.offsetTop - padding;\r\n  }\r\n\r\n  private toggleFocusedClass() {\r\n    if (this.focused) {\r\n      this.addCls(ListItemDirective.focusedCls);\r\n    } else {\r\n      this.removeCls(ListItemDirective.focusedCls);\r\n    }\r\n  }\r\n\r\n  private toggleSelectedClass() {\r\n    if (this.selected) {\r\n      this.addCls(ListItemDirective.selectedCls);\r\n      this.removeCls(ListItemDirective.focusedCls);\r\n    } else {\r\n      this.removeCls(ListItemDirective.selectedCls);\r\n    }\r\n  }\r\n\r\n  private toggleDisabledClass() {\r\n    if (this.disabled) {\r\n      this.addCls(ListItemDirective.disabledCls);\r\n    } else {\r\n      this.removeCls(ListItemDirective.disabledCls);\r\n    }\r\n  }\r\n\r\n  private addCls(cls: string) {\r\n    this.renderer.addClass(this.el.nativeElement, cls);\r\n  }\r\n\r\n  private removeCls(cls: string) {\r\n    this.renderer.removeClass(this.el.nativeElement, cls);\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  AfterViewInit,\r\n  OnInit,\r\n  OnDestroy,\r\n  Input,\r\n  ContentChildren,\r\n  HostListener,\r\n  ElementRef\r\n} from '@angular/core';\r\nimport type { QueryList } from '@angular/core';\r\n\r\nimport { Subscription } from 'rxjs';\r\n\r\nimport { ListItemDirective } from './list-item.directive';\r\n\r\n@Component({\r\n  selector: 'igo-list',\r\n  templateUrl: './list.component.html',\r\n  styleUrls: ['./list.component.scss']\r\n})\r\nexport class ListComponent implements AfterViewInit, OnInit, OnDestroy {\r\n  @Input()\r\n  get navigation() {\r\n    return this._navigation;\r\n  }\r\n  set navigation(value: boolean) {\r\n    this._navigation = value;\r\n  }\r\n  private _navigation = true;\r\n\r\n  @Input()\r\n  get selection() {\r\n    return this._selection;\r\n  }\r\n  set selection(value: boolean) {\r\n    this._selection = value;\r\n  }\r\n  private _selection = true;\r\n\r\n  get selectedItem() {\r\n    return this._selectedItem;\r\n  }\r\n  set selectedItem(value: ListItemDirective) {\r\n    this.focusedItem = value;\r\n    this._selectedItem = value;\r\n  }\r\n  private _selectedItem: ListItemDirective;\r\n\r\n  get focusedItem() {\r\n    return this._focusedItem;\r\n  }\r\n  set focusedItem(value: ListItemDirective) {\r\n    this._focusedItem = value;\r\n  }\r\n  private _focusedItem: ListItemDirective;\r\n\r\n  private navigationEnabled: boolean;\r\n  private listItems$$: Subscription;\r\n  private subscriptions: Subscription[] = [];\r\n\r\n  @ContentChildren(ListItemDirective, { descendants: true })\r\n  listItems: QueryList<ListItemDirective>;\r\n\r\n  @HostListener('document:keydown', ['$event'])\r\n  @HostListener('document:enter', ['$event'])\r\n  handleKeyboardEvent(event: KeyboardEvent) {\r\n    // It would be nice to be able to unsubscribe to the event\r\n    // completely but until ES7 this won't be possible because\r\n    // document events are not observables\r\n    if (this.navigationEnabled) {\r\n      if (event.key === 'ArrowUp' || event.key === 'ArrowDown') {\r\n        event.preventDefault();\r\n        this.navigate(event.key);\r\n      } else if (event.key === 'Enter') {\r\n        this.select(this.focusedItem);\r\n      }\r\n    }\r\n  }\r\n\r\n  constructor(private el: ElementRef) {}\r\n\r\n  ngOnInit() {\r\n    this.enableNavigation();\r\n  }\r\n\r\n  ngAfterViewInit() {\r\n    if (this.listItems.length) {\r\n      this.init();\r\n    }\r\n\r\n    this.listItems$$ = this.listItems.changes.subscribe(\r\n      (items: ListItemDirective[]) => this.init()\r\n    );\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.listItems$$.unsubscribe();\r\n  }\r\n\r\n  focus(item?: ListItemDirective) {\r\n    if (!this.selection) {\r\n      return;\r\n    }\r\n\r\n    this.unfocus();\r\n\r\n    // We need to make this check because dynamic\r\n    // lists such as in the search results list may fail\r\n    if (item !== undefined) {\r\n      item.focused = true;\r\n    }\r\n  }\r\n\r\n  unfocus() {\r\n    if (this.focusedItem !== undefined) {\r\n      this.focusedItem.focused = false;\r\n    }\r\n\r\n    this.focusedItem = undefined;\r\n  }\r\n\r\n  focusNext() {\r\n    const items = this.listItems.toArray();\r\n    let item;\r\n    const igoList = this.el.nativeElement;\r\n    let disabled = true;\r\n    let index = this.getFocusedIndex();\r\n    if (index === undefined) {\r\n      index = -1;\r\n    }\r\n\r\n    while (disabled && index < items.length - 1) {\r\n      index += 1;\r\n      item = items[index];\r\n      disabled = item.disabled;\r\n    }\r\n\r\n    if (item !== undefined) {\r\n      this.focus(item);\r\n    }\r\n\r\n    if (!items[index + 1]) {\r\n      igoList.scrollTop = igoList.scrollHeight - igoList.clientHeight;\r\n      return;\r\n    }\r\n\r\n    if (item !== undefined && !this.isScrolledIntoView(item.el.nativeElement)) {\r\n      igoList.scrollTop =\r\n        item.el.nativeElement.offsetTop +\r\n        item.el.nativeElement.children[0].offsetHeight -\r\n        igoList.clientHeight;\r\n    }\r\n  }\r\n\r\n  focusPrevious() {\r\n    const items = this.listItems.toArray();\r\n    let item: ListItemDirective;\r\n    const igoList = this.el.nativeElement;\r\n    let disabled = true;\r\n    let index = this.getFocusedIndex();\r\n\r\n    while (disabled && index > 0) {\r\n      index -= 1;\r\n      item = items[index];\r\n      disabled = item.disabled;\r\n    }\r\n\r\n    if (item !== undefined) {\r\n      this.focus(item);\r\n    }\r\n\r\n    if (!items[index - 1]) {\r\n      igoList.scrollTop = 0;\r\n      return;\r\n    }\r\n\r\n    if (item !== undefined && !this.isScrolledIntoView(item.el.nativeElement)) {\r\n      const padding = 3;\r\n      igoList.scrollTop = item.el.nativeElement.offsetTop - padding;\r\n    }\r\n  }\r\n\r\n  select(item?: ListItemDirective) {\r\n    if (!this.selection) {\r\n      return;\r\n    }\r\n\r\n    this.unselect();\r\n\r\n    if (item !== undefined) {\r\n      item.selected = true;\r\n    }\r\n  }\r\n\r\n  unselect() {\r\n    this.unfocus();\r\n\r\n    if (this.selectedItem !== undefined) {\r\n      this.selectedItem.selected = false;\r\n    }\r\n\r\n    this.selectedItem = undefined;\r\n  }\r\n\r\n  enableNavigation() {\r\n    if (this.navigation) {\r\n      this.navigationEnabled = true;\r\n    }\r\n  }\r\n\r\n  disableNavigation() {\r\n    this.navigationEnabled = false;\r\n  }\r\n\r\n  scrollToItem(item: ListItemDirective) {\r\n    this.el.nativeElement.scrollTop = item.getOffsetTop();\r\n  }\r\n\r\n  isScrolledIntoView(elem) {\r\n    const docViewTop =\r\n      this.el.nativeElement.scrollTop + this.el.nativeElement.offsetTop;\r\n    const docViewBottom = docViewTop + this.el.nativeElement.clientHeight;\r\n\r\n    const elemTop = elem.offsetTop;\r\n    const elemBottom = elemTop + elem.children[0].offsetHeight;\r\n    return elemBottom <= docViewBottom && elemTop >= docViewTop;\r\n  }\r\n\r\n  private init() {\r\n    this.subscribe();\r\n\r\n    this.selectedItem = this.findSelectedItem();\r\n    this.focusedItem = this.findFocusedItem();\r\n\r\n    this.enableNavigation();\r\n  }\r\n\r\n  private subscribe() {\r\n    this.unsubscribe();\r\n\r\n    this.listItems.toArray().forEach(item => {\r\n      this.subscriptions.push(\r\n        item.beforeSelect.subscribe((item2: ListItemDirective) =>\r\n          this.handleItemBeforeSelect(item2)\r\n        )\r\n      );\r\n\r\n      this.subscriptions.push(\r\n        item.select.subscribe((item2: ListItemDirective) =>\r\n          this.handleItemSelect(item2)\r\n        )\r\n      );\r\n\r\n      this.subscriptions.push(\r\n        item.beforeFocus.subscribe((item2: ListItemDirective) =>\r\n          this.handleItemBeforeFocus(item2)\r\n        )\r\n      );\r\n\r\n      this.subscriptions.push(\r\n        item.focus.subscribe((item2: ListItemDirective) =>\r\n          this.handleItemFocus(item2)\r\n        )\r\n      );\r\n    }, this);\r\n  }\r\n\r\n  private unsubscribe() {\r\n    this.subscriptions.forEach((sub: Subscription) => sub.unsubscribe());\r\n    this.subscriptions = [];\r\n  }\r\n\r\n  private handleItemBeforeFocus(item: ListItemDirective) {\r\n    if (item !== this.focusedItem) {\r\n      this.unfocus();\r\n    }\r\n  }\r\n\r\n  private handleItemFocus(item: ListItemDirective) {\r\n    this.focusedItem = item;\r\n  }\r\n\r\n  private handleItemBeforeSelect(item: ListItemDirective) {\r\n    if (item !== this.focusedItem) {\r\n      this.unselect();\r\n    }\r\n  }\r\n\r\n  private handleItemSelect(item: ListItemDirective) {\r\n    this.selectedItem = item;\r\n  }\r\n\r\n  private findSelectedItem() {\r\n    return this.listItems.toArray().find(item => item.selected);\r\n  }\r\n\r\n  private findFocusedItem() {\r\n    return this.listItems.toArray().find(item => item.focused);\r\n  }\r\n\r\n  private getFocusedIndex() {\r\n    return this.listItems\r\n      .toArray()\r\n      .findIndex(item => item === this.focusedItem);\r\n  }\r\n\r\n  private navigate(key: string) {\r\n    switch (key) {\r\n      case 'ArrowUp':\r\n        this.focusPrevious();\r\n        break;\r\n      case 'ArrowDown':\r\n        this.focusNext();\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n  }\r\n}\r\n","<mat-list\r\n  igoClickout\r\n  [ngClass]=\"{'selectable': selection}\"\r\n  (clickout)=\"disableNavigation()\"\r\n  (click)=\"enableNavigation()\">\r\n  <ng-content></ng-content>\r\n</mat-list>\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatListModule } from '@angular/material/list';\r\n\r\nimport { IgoClickoutModule } from '../clickout/clickout.module';\r\n\r\nimport { ListItemDirective } from './list-item.directive';\r\nimport { ListComponent } from './list.component';\r\n\r\n@NgModule({\r\n  imports: [CommonModule, MatIconModule, MatListModule, IgoClickoutModule],\r\n  declarations: [ListItemDirective, ListComponent],\r\n  exports: [ListItemDirective, ListComponent]\r\n})\r\nexport class IgoListModule {\r\n  static forRoot(): ModuleWithProviders<IgoListModule> {\r\n    return {\r\n      ngModule: IgoListModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","<div *ngIf=\"withHeader\" class=\"igo-panel-header mat-typography\" title=\"\">\r\n  <h3>\r\n    <ng-content select=\"[panelLeftButton]\"></ng-content>\r\n    <div class=\"igo-panel-title\">\r\n      {{ title }}\r\n      <ng-content select=\"[panelHeader]\"></ng-content>\r\n    </div>\r\n    <ng-content select=\"[panelRightButton]\"></ng-content>\r\n  </h3>\r\n</div>\r\n<div class=\"igo-panel-content\" title=\"\">\r\n  <ng-content></ng-content>\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  HostBinding\r\n} from '@angular/core';\r\n\r\n@Component({\r\n  selector: 'igo-panel',\r\n  templateUrl: './panel.component.html',\r\n  styleUrls: ['./panel.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class PanelComponent {\r\n  @Input()\r\n  get title() {\r\n    return this._title;\r\n  }\r\n  set title(value: string) {\r\n    this._title = value;\r\n  }\r\n  private _title: string;\r\n\r\n  @Input()\r\n  @HostBinding('class.igo-panel-with-header')\r\n  get withHeader(): boolean {\r\n    return this._withHeader;\r\n  }\r\n  set withHeader(value: boolean) {\r\n    this._withHeader = value;\r\n  }\r\n  private _withHeader = true;\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { PanelComponent } from './panel.component';\r\n\r\n@NgModule({\r\n  imports: [CommonModule],\r\n  exports: [PanelComponent],\r\n  declarations: [PanelComponent]\r\n})\r\nexport class IgoPanelModule {}\r\n","import { Component, Input } from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'igo-spinner',\r\n  templateUrl: './spinner.component.html',\r\n  styleUrls: ['./spinner.component.scss']\r\n})\r\nexport class SpinnerComponent {\r\n\r\n  public shown$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  @Input()\r\n  set shown(value: boolean) { this.shown$.next(value); }\r\n  get shown(): boolean { return this.shown$.value; }\r\n\r\n  constructor() {}\r\n\r\n  show() {\r\n    this.shown = true;\r\n  }\r\n\r\n  hide() {\r\n    this.shown = false;\r\n  }\r\n}\r\n","<div\r\n  [ngClass]=\"{'igo-spinner-container': true, 'igo-spinner-shown': (shown$ | async)}\">\r\n  <div class=\"igo-spinner-background\"></div>\r\n  <mat-progress-spinner diameter=\"40\" mode=\"indeterminate\"></mat-progress-spinner>\r\n</div>\r\n","import { Directive, Self, OnInit, OnDestroy } from '@angular/core';\r\nimport { Subscription } from 'rxjs';\r\nimport { debounceTime } from 'rxjs/operators';\r\n\r\nimport { ActivityService } from '@igo2/core';\r\nimport { SpinnerComponent } from './spinner.component';\r\n\r\n/**\r\n * A directive to bind a SpinnerComponent to the activity service.\r\n * The activity service tracks any HTTP request and this directive\r\n * will display the spinner it's attached to when the activity counter\r\n * is greater than 0.\r\n */\r\n@Directive({\r\n  selector: '[igoSpinnerActivity]'\r\n})\r\nexport class SpinnerActivityDirective implements OnInit, OnDestroy {\r\n  /**\r\n   * Subscription to the activity service counter\r\n   */\r\n  private counter$$: Subscription;\r\n\r\n  constructor(\r\n    @Self() private spinner: SpinnerComponent,\r\n    private activityService: ActivityService\r\n  ) {}\r\n\r\n  /**\r\n   * Subscribe to the activity service counter and display the spinner\r\n   * when it's is greater than 0.\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.counter$$ = this.activityService.counter$\r\n      .pipe(debounceTime(50))\r\n      .subscribe((count: number) => {\r\n        count > 0 ? this.spinner.show() : this.spinner.hide();\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Unsubcribe to the activity service counter.\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.counter$$.unsubscribe();\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatProgressSpinnerModule } from '@angular/material/progress-spinner';\r\n\r\nimport { SpinnerActivityDirective } from './spinner-activity.directive';\r\nimport { SpinnerComponent } from './spinner.component';\r\n\r\n@NgModule({\r\n  imports: [CommonModule, MatProgressSpinnerModule],\r\n  declarations: [SpinnerActivityDirective, SpinnerComponent],\r\n  exports: [SpinnerActivityDirective, SpinnerComponent]\r\n})\r\nexport class IgoSpinnerModule {}\r\n","import { DataSource } from '@angular/cdk/table';\r\nimport { MatSort } from '@angular/material/sort';\r\n\r\nimport { Observable, BehaviorSubject, merge } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport { TableDatabase, TableModel } from './index';\r\n\r\nexport class TableDataSource extends DataSource<any> {\r\n  get filter(): string {\r\n    return this._filterChange.value;\r\n  }\r\n  set filter(filter: string) {\r\n    this._filterChange.next(filter);\r\n  }\r\n  private _filterChange = new BehaviorSubject('');\r\n\r\n  constructor(\r\n    private _database: TableDatabase,\r\n    private _model: TableModel,\r\n    private _sort: MatSort\r\n  ) {\r\n    super();\r\n  }\r\n\r\n  // Connect function called by the table to retrieve one stream containing\r\n  // the data to render.\r\n  connect(): Observable<any[]> {\r\n    if (!this._database) {\r\n      return merge([]);\r\n    }\r\n    const displayDataChanges = [\r\n      this._database.dataChange,\r\n      this._filterChange,\r\n      this._sort.sortChange\r\n    ];\r\n\r\n    return merge(...displayDataChanges).pipe(\r\n      map(() => {\r\n        return this.getFilteredData(this._database.data);\r\n      }),\r\n      map(data => {\r\n        return this.getSortedData(data);\r\n      })\r\n    );\r\n  }\r\n\r\n  disconnect() {}\r\n\r\n  getFilteredData(data): any[] {\r\n    if (!this.filter) {\r\n      return data;\r\n    }\r\n    return data.slice().filter((item: any) => {\r\n      const searchStr: string = this._model.columns\r\n        .filter(c => c.filterable)\r\n        .map(c => ObjectUtils.resolve(item, c.name))\r\n        .join(' ')\r\n        .toLowerCase();\r\n\r\n      return searchStr.indexOf(this.filter.toLowerCase()) !== -1;\r\n    });\r\n  }\r\n\r\n  getSortedData(data): any[] {\r\n    if (!this._sort.active || this._sort.direction === '') {\r\n      return data;\r\n    }\r\n\r\n    return data.sort((a, b) => {\r\n      const propertyA: number | string = ObjectUtils.resolve(\r\n        a,\r\n        this._sort.active\r\n      );\r\n      const propertyB: number | string = ObjectUtils.resolve(\r\n        b,\r\n        this._sort.active\r\n      );\r\n\r\n      return ObjectUtils.naturalCompare(\r\n        propertyB,\r\n        propertyA,\r\n        this._sort.direction\r\n      );\r\n    });\r\n  }\r\n}\r\n","export enum TableActionColor {\r\n  primary,\r\n  accent,\r\n  warn\r\n}\r\n","<div class='table-box'>\r\n  <div class='table-header' *ngIf=\"hasFilterInput\">\r\n    <mat-form-field floatPlaceholder='never'>\r\n      <input matInput #filter [placeholder]=\"'igo.common.table.filter' | translate\">\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class='table-container'>\r\n    <table mat-table #table [dataSource]='dataSource' matSort>\r\n\r\n      <!-- Checkbox Column -->\r\n      <ng-container matColumnDef=\"selectionCheckbox\">\r\n        <th mat-header-cell *matHeaderCellDef>\r\n          <mat-checkbox (change)=\"$event ? masterToggle() : null\"\r\n                        [checked]=\"selection.hasValue() && isAllSelected()\"\r\n                        [indeterminate]=\"selection.hasValue() && !isAllSelected()\">\r\n          </mat-checkbox>\r\n        </th>\r\n        <td mat-cell *matCellDef=\"let row\">\r\n          <mat-checkbox (click)=\"$event.stopPropagation()\"\r\n                        (change)=\"$event ? selection.toggle(row) : null\"\r\n                        [checked]=\"selection.isSelected(row)\">\r\n          </mat-checkbox>\r\n        </td>\r\n      </ng-container>\r\n\r\n      <ng-container [matColumnDef]='column.name' *ngFor='let column of model.columns'>\r\n        <ng-container *ngIf='column.sortable'>\r\n          <th mat-header-cell *matHeaderCellDef mat-sort-header> {{column.title}} </th>\r\n        </ng-container>\r\n\r\n        <ng-container *ngIf='!column.sortable'>\r\n          <th mat-header-cell *matHeaderCellDef> {{column.title}} </th>\r\n        </ng-container>\r\n\r\n        <ng-container *ngIf=\"!column.html; else cellHTML\">\r\n          <td mat-cell *matCellDef='let row' class=\"mat-cell-text\"\r\n            [ngClass]=\"model.cellClassFunc ? model.cellClassFunc(row, column) : {}\">\r\n            {{getValue(row, column.name)}}\r\n          </td>\r\n        </ng-container>\r\n\r\n        <ng-template #cellHTML>\r\n          <td mat-cell *matCellDef='let row' class=\"mat-cell-text\"\r\n            [ngClass]=\"model.cellClassFunc ? model.cellClassFunc(row, column) : {}\"\r\n            [innerHTML]=\"getValue(row, column.name)\">\r\n          </td>\r\n        </ng-template>\r\n      </ng-container>\r\n\r\n      <!-- Action Column -->\r\n      <ng-container matColumnDef='action'>\r\n        <th mat-header-cell *matHeaderCellDef></th>\r\n        <td mat-cell *matCellDef='let row'>\r\n          <button *ngFor='let action of model.actions'\r\n          mat-mini-fab\r\n          [color]='getActionColor(action.color)'\r\n          (click)='handleClickAction($event, action, row)'>\r\n            <mat-icon svgIcon=\"{{action.icon}}\"></mat-icon>\r\n          </button>\r\n        </td>\r\n      </ng-container>\r\n\r\n      <tr mat-header-row *matHeaderRowDef='displayedColumns;'></tr>\r\n      <tr mat-row\r\n        *matRowDef='let row; columns: displayedColumns;'\r\n        [ngClass]=\"model.rowClassFunc ? model.rowClassFunc(row) : {}\"\r\n        (click)=\"selection.toggle(row)\">\r\n      </tr>\r\n\r\n    </table>\r\n  </div>\r\n\r\n</div>\r\n","import {\r\n  Component,\r\n  ElementRef,\r\n  ViewChild,\r\n  Input,\r\n  Output,\r\n  OnChanges,\r\n  OnInit,\r\n  AfterViewInit,\r\n  EventEmitter\r\n} from '@angular/core';\r\nimport { MatSort } from '@angular/material/sort';\r\nimport { SelectionModel } from '@angular/cdk/collections';\r\n\r\nimport { debounceTime, distinctUntilChanged } from 'rxjs/operators';\r\nimport { fromEvent } from 'rxjs';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport { TableModel } from './table-model.interface';\r\nimport { TableDatabase } from './table-database';\r\nimport { TableDataSource } from './table-datasource';\r\nimport { TableActionColor } from './table-action-color.enum';\r\n\r\n@Component({\r\n  selector: 'igo-table',\r\n  templateUrl: './table.component.html',\r\n  styleUrls: ['./table.component.scss']\r\n})\r\nexport class TableComponent implements OnChanges, OnInit, AfterViewInit {\r\n  @Input()\r\n  get database(): TableDatabase {\r\n    return this._database;\r\n  }\r\n  set database(value: TableDatabase) {\r\n    this._database = value;\r\n  }\r\n  private _database: TableDatabase;\r\n\r\n  @Input()\r\n  get model(): TableModel {\r\n    return this._model;\r\n  }\r\n  set model(value: TableModel) {\r\n    this._model = value;\r\n  }\r\n  private _model: TableModel;\r\n\r\n  @Input()\r\n  get hasFilterInput(): boolean {\r\n    return this._hasFIlterInput;\r\n  }\r\n  set hasFilterInput(value: boolean) {\r\n    this._hasFIlterInput = value;\r\n  }\r\n  private _hasFIlterInput = true;\r\n\r\n  public displayedColumns;\r\n  public dataSource: TableDataSource | null;\r\n  public selection = new SelectionModel<any>(true, []);\r\n\r\n  @Output()\r\n  select = new EventEmitter<{\r\n    added: any[];\r\n    removed: any[];\r\n    source: SelectionModel<any>;\r\n  }>();\r\n\r\n  @ViewChild('filter') filter: ElementRef;\r\n  @ViewChild(MatSort, { static: true }) sort: MatSort;\r\n\r\n  ngOnInit() {\r\n    this.dataSource = new TableDataSource(this.database, this.model, this.sort);\r\n\r\n    if (this.model) {\r\n      this.displayedColumns = this.model.columns\r\n        .filter(c => c.displayed !== false)\r\n        .map(c => c.name);\r\n\r\n      if (this.model.selectionCheckbox) {\r\n        this.displayedColumns.unshift('selectionCheckbox');\r\n      }\r\n      if (this.model.actions && this.model.actions.length) {\r\n        this.displayedColumns.push('action');\r\n      }\r\n    }\r\n\r\n    this.selection.changed.subscribe(e => this.select.emit(e));\r\n  }\r\n\r\n  ngAfterViewInit() {\r\n    if (this.filter) {\r\n      fromEvent(this.filter.nativeElement, 'keyup')\r\n        .pipe(\r\n          debounceTime(150),\r\n          distinctUntilChanged()\r\n        )\r\n        .subscribe(() => {\r\n          if (!this.dataSource) {\r\n            return;\r\n          }\r\n          this.dataSource.filter = this.filter.nativeElement.value;\r\n        });\r\n    }\r\n  }\r\n\r\n  ngOnChanges(change) {\r\n    if (change.database) {\r\n      this.dataSource = new TableDataSource(\r\n        this.database,\r\n        this.model,\r\n        this.sort\r\n      );\r\n      this.selection.clear();\r\n    }\r\n  }\r\n\r\n  getActionColor(colorId: number): string {\r\n    return TableActionColor[colorId];\r\n  }\r\n\r\n  getValue(row, key) {\r\n    return ObjectUtils.resolve(row, key);\r\n  }\r\n\r\n  /** Whether the number of selected elements matches the total number of rows. */\r\n  isAllSelected() {\r\n    const numSelected = this.selection.selected.length;\r\n    const numRows = this.database.data.length;\r\n    return numSelected === numRows;\r\n  }\r\n\r\n  /** Selects all rows if they are not all selected; otherwise clear selection. */\r\n  masterToggle() {\r\n    this.isAllSelected()\r\n      ? this.selection.clear()\r\n      : this.database.data.forEach(row => this.selection.select(row));\r\n  }\r\n\r\n  handleClickAction(event, action, row) {\r\n    event.stopPropagation();\r\n    action.click(row);\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\nimport { CdkTableModule } from '@angular/cdk/table';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSortModule } from '@angular/material/sort';\r\nimport { MatTableModule } from '@angular/material/table';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { TableComponent } from './table.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    CdkTableModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatTableModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatSortModule,\r\n    MatCheckboxModule,\r\n    IgoLanguageModule\r\n  ],\r\n  declarations: [TableComponent],\r\n  exports: [TableComponent]\r\n})\r\nexport class IgoTableModule {\r\n  static forRoot(): ModuleWithProviders<IgoTableModule> {\r\n    return {\r\n      ngModule: IgoTableModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","import { EntityStore } from '../../entity';\r\nimport { Action } from './action.interfaces';\r\n\r\n/**\r\n * The class is a specialized version of an EntityStore that stores\r\n * actions.\r\n */\r\nexport class ActionStore extends EntityStore<Action> {\r\n\r\n}\r\n","export enum ToolboxColor {\r\n  White = 'white',\r\n  Grey = 'grey',\r\n  Primary = 'primary'\r\n}\r\n","import {\r\n  trigger,\r\n  state,\r\n  style,\r\n  transition,\r\n  animate,\r\n  AnimationTriggerMetadata\r\n} from '@angular/animations';\r\n\r\nexport function toolSlideInOut(\r\n  speed = '300ms',\r\n  type = 'ease-in-out'\r\n): AnimationTriggerMetadata {\r\n  return trigger('toolSlideInOut', [\r\n    state(\r\n      'enter',\r\n      style({\r\n        transform: 'translate3d(0, 0, 0)'\r\n      })\r\n    ),\r\n    transition('void => enter', animate(speed + ' ' + type))\r\n  ]);\r\n}\r\n","<igo-actionbar\r\n  *ngIf=\"(toolbar$ | async).length > 0\"\r\n  [store]=\"actionStore\"\r\n  [withIcon]=\"true\"\r\n  [withTitle]=\"toolbarWithTitle$ | async\"\r\n  [withTooltip]=\"(toolbarWithTitle$ | async) === false\"\r\n  [scrollActive]=\"toolbarWithTitle$ | async\"\r\n  [horizontal]=\"false\">\r\n</igo-actionbar>\r\n\r\n<div\r\n  *ngIf=\"activeTool$ | async as tool\"\r\n  class=\"igo-tool-container\"\r\n  [ngClass]=\"{'igo-tool-container-with-toolbar': !actionStore.empty, 'igo-tool-container-with-animation': animate}\"\r\n  [@toolSlideInOut]=\"animation$ | async\"\r\n  (@toolSlideInOut.start)=\"onAnimationStart()\"\r\n  (@toolSlideInOut.done)=\"onAnimationComplete()\">\r\n\r\n  <igo-dynamic-outlet\r\n    [component]=\"tool.component\"\r\n    [inputs]=\"getToolInputs(tool)\">\r\n  </igo-dynamic-outlet>\r\n\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnDestroy,\r\n  OnInit,\r\n  HostBinding,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\n\r\nimport { Subscription, BehaviorSubject, Observable } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { Action, ActionStore } from '../../action';\r\nimport { Tool } from '../shared/tool.interface';\r\nimport { ToolboxColor } from '../shared/toolbox.enums';\r\nimport { Toolbox } from '../shared/toolbox';\r\nimport { toolSlideInOut } from './toolbox.animation';\r\n\r\n@Component({\r\n  selector: 'igo-toolbox',\r\n  templateUrl: 'toolbox.component.html',\r\n  styleUrls: ['toolbox.component.scss'],\r\n  animations: [toolSlideInOut()],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class ToolboxComponent implements OnInit, OnDestroy {\r\n  /**\r\n   * Observable of the active tool\r\n   */\r\n  activeTool$: BehaviorSubject<Tool> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Store of actions that toggle tools\r\n   */\r\n  actionStore: ActionStore = new ActionStore([]);\r\n\r\n  /**\r\n   * Observable of he anmation state\r\n   */\r\n  animation$: BehaviorSubject<string> = new BehaviorSubject('none');\r\n\r\n  /**\r\n   * Observable of the toolbar\r\n   */\r\n  toolbar$: BehaviorSubject<string[]> = new BehaviorSubject([]);\r\n\r\n  /**\r\n   * Whether the Toolbar should display actions' titles\r\n   */\r\n  toolbarWithTitle$: Observable<boolean> = this.activeTool$.pipe(\r\n    map((tool: Tool | undefined) => tool === undefined)\r\n  );\r\n\r\n  /**\r\n   * Subscription to the active tool\r\n   */\r\n  private activeTool$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to the toolbar\r\n   */\r\n  private toolbar$$: Subscription;\r\n\r\n  /**\r\n   * Observable of the ongoing animation. This is useful when\r\n   * multiple animations are triggered at once i.e. when the user clicks\r\n   * too fast on different actions\r\n   */\r\n  private animating$ = new BehaviorSubject<boolean>(false);\r\n\r\n  /**\r\n   * Subscription to the ongoing animation\r\n   */\r\n  private animating$$: Subscription;\r\n\r\n  /**\r\n   * Toolbox\r\n   */\r\n  @Input() toolbox: Toolbox;\r\n\r\n  /**\r\n   * Whether the toolbox should animate the first tool entering\r\n   */\r\n  @Input() animate: boolean = false;\r\n\r\n  /**\r\n   * Color of Toolbox\r\n   */\r\n  @Input() color: ToolboxColor = ToolboxColor.White;\r\n\r\n  /**\r\n   * @ignore\r\n   */\r\n  @HostBinding('class.color-grey')\r\n  get classColorGrey() {\r\n    return this.color === ToolboxColor.Grey;\r\n  }\r\n\r\n  /**\r\n   * @ignore\r\n   */\r\n  @HostBinding('class.color-primary')\r\n  get classColorPrimary() {\r\n    return this.color === ToolboxColor.Primary;\r\n  }\r\n\r\n  /**\r\n   * Initialize the toolbar and subscribe to the active tool\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.toolbar$$ = this.toolbox.toolbar$.subscribe((toolbar: string[]) =>\r\n      this.onToolbarChange(toolbar)\r\n    );\r\n    this.activeTool$$ = this.toolbox.activeTool$.subscribe((tool: Tool) =>\r\n      this.onActiveToolChange(tool)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to the active tool and destroy the action store\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.toolbar$$.unsubscribe();\r\n    this.activeTool$$.unsubscribe();\r\n    this.actionStore.destroy();\r\n  }\r\n\r\n  /**\r\n   * Track the starting animation\r\n   * @internal\r\n   */\r\n  onAnimationStart() {\r\n    this.animating$.next(true);\r\n  }\r\n\r\n  /**\r\n   * Untrack the completed animation\r\n   * @internal\r\n   */\r\n  onAnimationComplete() {\r\n    this.animating$.next(false);\r\n  }\r\n\r\n  /**\r\n   * Return a tool's inputs\r\n   * @param tool Tool\r\n   * @returns Tool inputs\r\n   * @internal\r\n   */\r\n  getToolInputs(tool: Tool): { [key: string]: any } {\r\n    return tool.options || {};\r\n  }\r\n\r\n  /**\r\n   * Initialize an action store\r\n   * @param toolbar Toolbar\r\n   */\r\n  private onToolbarChange(toolbar: string[]) {\r\n    this.setToolbar(toolbar);\r\n  }\r\n\r\n  /**\r\n   * Activate a tool and trigger an animation or not\r\n   * @param tool Tool to activate\r\n   */\r\n  private onActiveToolChange(tool: Tool) {\r\n    if (!this.animate) {\r\n      this.setActiveTool(tool);\r\n      return;\r\n    }\r\n    this.onAnimate(() => this.setActiveTool(tool));\r\n  }\r\n\r\n  /**\r\n   * Set the active tool\r\n   * @param tool Tool to activate\r\n   */\r\n  private setActiveTool(tool: Tool | undefined) {\r\n    if (tool === undefined) {\r\n      this.actionStore.state.updateAll({ active: false });\r\n    } else {\r\n      const action = this.actionStore.get(tool.name);\r\n      if (action !== undefined) {\r\n        this.actionStore.state.update(action, { active: true }, true);\r\n      }\r\n    }\r\n\r\n    this.activeTool$.next(tool);\r\n    if (this.animate) {\r\n      this.animation$.next('enter');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Initialize the toolbar\r\n   */\r\n  private setToolbar(toolbar: string[]) {\r\n    const actions = toolbar.reduce((acc: Action[], toolName: string) => {\r\n      const tool = this.toolbox.getTool(toolName);\r\n      if (tool === undefined) {\r\n        return acc;\r\n      }\r\n\r\n      acc.push({\r\n        id: tool.name,\r\n        title: tool.title,\r\n        icon: tool.icon,\r\n        // iconImage: tool.iconImage,\r\n        tooltip: tool.tooltip,\r\n        args: [tool, this.toolbox],\r\n        handler: (_tool: Tool, _toolbox: Toolbox) => {\r\n          _toolbox.activateTool(_tool.name);\r\n        },\r\n        ngClass: (_tool: Tool, _toolbox: Toolbox) => {\r\n          return this.toolbox.activeTool$.pipe(\r\n            map((activeTool: Tool) => {\r\n              let toolActivated = false;\r\n              if (activeTool !== undefined && _tool.name === activeTool.name) {\r\n                toolActivated = true;\r\n              }\r\n\r\n              let childrenToolActivated = false;\r\n              if (\r\n                activeTool !== undefined &&\r\n                _tool.name === activeTool.parent\r\n              ) {\r\n                childrenToolActivated = true;\r\n              }\r\n\r\n              return {\r\n                'tool-activated': toolActivated,\r\n                'children-tool-activated': childrenToolActivated\r\n              };\r\n            })\r\n          );\r\n        }\r\n      });\r\n      return acc;\r\n    }, []);\r\n    this.actionStore.load(actions);\r\n    this.toolbar$.next(toolbar);\r\n  }\r\n\r\n  /**\r\n   * Observe the ongoing animation and ignore any incoming animation\r\n   * while one is still ongoing.\r\n   * @param callback Callback to execute when the animation completes\r\n   */\r\n  private onAnimate(callback: () => void) {\r\n    this.unAnimate();\r\n    this.animating$$ = this.animating$.subscribe((animation: boolean) => {\r\n      if (!animation) {\r\n        callback.call(this);\r\n        this.unAnimate();\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Stop observing an animation when it's complete\r\n   */\r\n  private unAnimate() {\r\n    if (this.animating$$) {\r\n      this.animating$$.unsubscribe();\r\n    }\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoActionModule } from '../../action/action.module';\r\nimport {\r\n    IgoDynamicComponentModule\r\n} from '../../dynamic-component/dynamic-component.module';\r\n\r\nimport { ToolboxComponent } from './toolbox.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoActionModule,\r\n    IgoDynamicComponentModule\r\n  ],\r\n  exports: [\r\n    ToolboxComponent\r\n  ],\r\n  declarations: [\r\n    ToolboxComponent\r\n  ]\r\n})\r\nexport class IgoToolboxModule {}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { ToolService } from './shared/tool.service';\r\nimport { IgoToolboxModule } from './toolbox/toolbox.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule\r\n  ],\r\n  exports: [\r\n    IgoToolboxModule\r\n  ],\r\n  declarations: []\r\n})\r\nexport class IgoToolModule {\r\n  static forRoot(): ModuleWithProviders<IgoToolModule> {\r\n    return {\r\n      ngModule: IgoToolModule,\r\n      providers: [\r\n        ToolService\r\n      ]\r\n    };\r\n  }\r\n}\r\n","<igo-dynamic-outlet\r\n  *ngIf=\"widget\"\r\n  [component]=\"widget\"\r\n  [inputs]=\"inputs\"\r\n  [subscribers]=\"getEffectiveSubscribers()\">\r\n</igo-dynamic-outlet>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { DynamicComponent } from '../../dynamic-component';\r\n\r\nimport { WidgetComponent } from '../shared/widget.interfaces';\r\n\r\n/**\r\n * This component dynamically renders a widget. It also subscribes\r\n * to the widget's 'cancel' and 'complete' events and destroys it\r\n * when any of those event is emitted.\r\n */\r\n@Component({\r\n  selector: 'igo-widget-outlet',\r\n  templateUrl: './widget-outlet.component.html',\r\n  styleUrls: ['./widget-outlet.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class WidgetOutletComponent implements OnDestroy {\r\n\r\n  /**\r\n   * Widget subscribers to 'cancel' and 'complete'\r\n   * @internal\r\n   */\r\n  private baseSubscribers = {\r\n    cancel: (event: any) => this.onCancel(event),\r\n    complete: (event: any) => this.onComplete(event)\r\n  };\r\n\r\n  /**\r\n   * Widget\r\n   */\r\n  @Input() widget: DynamicComponent<WidgetComponent>;\r\n\r\n  /**\r\n   * Widget inputs\r\n   */\r\n  @Input() inputs: {[key: string]: any};\r\n\r\n  /**\r\n   * Widget subscribers\r\n   */\r\n  @Input() subscribers: {[key: string]: (event: any) => void} = {};\r\n\r\n  /**\r\n   * Event emitted when the widget emits 'complete'\r\n   */\r\n  @Output() complete = new EventEmitter<any>();\r\n\r\n  /**\r\n   * Event emitted when the widget emits 'cancel'\r\n   */\r\n  @Output() cancel = new EventEmitter<any>();\r\n\r\n  constructor() {}\r\n\r\n  /**\r\n   * Destroy the current widget and all it's inner subscriptions\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.destroyWidget();\r\n  }\r\n\r\n  /**\r\n   * Get the effective subscribers. That means a combination of the base\r\n   * subscribers and any subscriber given as input.\r\n   * @returns Combined subscribers\r\n   * @internal\r\n   */\r\n  getEffectiveSubscribers(): {[key: string]: (event: any) => void} {\r\n    const subscribers = Object.assign({}, this.subscribers);\r\n\r\n    // Base subscribers\r\n    Object.keys(this.baseSubscribers).forEach((key: string) => {\r\n      const subscriber = subscribers[key];\r\n      const baseSubscriber = this.baseSubscribers[key];\r\n      if (subscriber !== undefined) {\r\n        subscribers[key] = (event: any) => {\r\n          subscriber(event);\r\n          baseSubscriber(event);\r\n        };\r\n      } else {\r\n        subscribers[key] = baseSubscriber;\r\n      }\r\n    });\r\n\r\n    return subscribers;\r\n  }\r\n\r\n  /**\r\n   * When the widget emits 'cancel', propagate that event and destroy\r\n   * the widget\r\n   */\r\n  private onCancel(event: any) {\r\n    this.cancel.emit(event);\r\n    this.destroyWidget();\r\n  }\r\n\r\n  /**\r\n   * When the widget emits 'complete', propagate that event and destroy\r\n   * the widget\r\n   */\r\n  private onComplete(event: any) {\r\n    this.complete.emit(event);\r\n    this.destroyWidget();\r\n  }\r\n\r\n  /**\r\n   * Destroy the current widget\r\n   */\r\n  private destroyWidget() {\r\n    if (this.widget !== undefined) {\r\n      this.widget.destroy();\r\n    }\r\n    this.widget = undefined;\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport {\r\n  IgoDynamicComponentModule\r\n} from '../../dynamic-component/dynamic-component.module';\r\n\r\nimport { WidgetOutletComponent } from './widget-outlet.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoDynamicComponentModule\r\n  ],\r\n  exports: [\r\n    WidgetOutletComponent\r\n  ],\r\n  declarations: [\r\n    WidgetOutletComponent\r\n  ]\r\n})\r\nexport class IgoWidgetOutletModule {}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { DynamicComponentService } from '../../dynamic-component/shared/dynamic-component.service';\r\n\r\nimport { Widget } from './widget';\r\nimport { WidgetComponent } from './widget.interfaces';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class WidgetService {\r\n\r\n  constructor(private dynamicComponentService: DynamicComponentService) {}\r\n\r\n  create(widgetCls: any): Widget {\r\n    return this.dynamicComponentService.create(widgetCls as WidgetComponent);\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoWidgetOutletModule } from './widget-outlet/widget-outlet.module';\r\nimport { WidgetService } from './shared/widget.service';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoWidgetOutletModule\r\n  ],\r\n  exports: [\r\n    IgoWidgetOutletModule\r\n  ],\r\n  declarations: [],\r\n  providers: [\r\n    WidgetService\r\n  ]\r\n})\r\nexport class IgoWidgetModule {}\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\n\r\nimport { getEntityTitle } from '../../entity';\r\nimport { Workspace } from '../shared/workspace';\r\nimport { WorkspaceStore } from '../shared/store';\r\n\r\n/**\r\n * Drop list that activates the selected workspace emit an event.\r\n */\r\n@Component({\r\n  selector: 'igo-workspace-selector',\r\n  templateUrl: './workspace-selector.component.html',\r\n  styleUrls: ['./workspace-selector.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class WorkspaceSelectorComponent {\r\n\r\n  /**\r\n   * Store that holds the available workspaces.\r\n   */\r\n  @Input() store: WorkspaceStore;\r\n\r\n  /**\r\n   * Wheither the selector must be disabled or not.\r\n   */\r\n  @Input() disabled: boolean;\r\n\r\n  /**\r\n   * Event emitted when an workspace is selected or unselected\r\n   */\r\n  @Output() selectedChange = new EventEmitter<{\r\n    selected: boolean;\r\n    value: Workspace;\r\n  }>();\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  getWorkspaceTitle(workspace: Workspace): string {\r\n    return getEntityTitle(workspace);\r\n  }\r\n\r\n  /**\r\n   * When an workspace is manually selected, select it into the\r\n   * store and emit an event.\r\n   * @internal\r\n   * @param event The selection change event\r\n   */\r\n  onSelectedChange(event: {value: Workspace}) {\r\n    const workspace = event.value;\r\n    this.store.activateWorkspace(workspace);\r\n    this.selectedChange.emit({selected: true, value: workspace});\r\n  }\r\n\r\n}\r\n","<igo-entity-selector\r\n  [store]=\"store\"\r\n  [multi]=\"false\"\r\n  [titleAccessor]=\"getWorkspaceTitle\"\r\n  [disabled]=\"disabled\"\r\n  (selectedChange)=\"onSelectedChange($event)\">\r\n</igo-entity-selector>\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoEntitySelectorModule } from '../../entity/entity-selector/entity-selector.module';\r\nimport { WorkspaceSelectorComponent } from './workspace-selector.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoEntitySelectorModule\r\n  ],\r\n  exports: [\r\n    WorkspaceSelectorComponent\r\n  ],\r\n  declarations: [\r\n    WorkspaceSelectorComponent\r\n  ]\r\n})\r\nexport class IgoWorkspaceSelectorModule {}\r\n","<ng-container *ngIf=\"widget$ | async as widget\">\r\n  <igo-widget-outlet\r\n    [widget]=\"widget\"\r\n    [inputs]=\"widgetInputs$ | async\"\r\n    [subscribers]=\"widgetSubscribers$ | async\"\r\n    (cancel)=\"onWidgetCancel(widget)\"\r\n    (complete)=\"onWidgetComplete(widget)\">\r\n  </igo-widget-outlet>\r\n</ng-container>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { Widget } from '../../widget';\r\nimport { Workspace } from '../shared/workspace';\r\n\r\n/**\r\n * This component dynamically render an Workspace's active widget.\r\n * It also deactivate that widget whenever the widget's component\r\n * emit the 'cancel' or 'complete' event.\r\n */\r\n@Component({\r\n  selector: 'igo-workspace-widget-outlet',\r\n  templateUrl: './workspace-widget-outlet.component.html',\r\n  styleUrls: ['./workspace-widget-outlet.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class WorkspaceWidgetOutletComponent {\r\n\r\n  /**\r\n   * Workspace\r\n   */\r\n  @Input() workspace: Workspace;\r\n\r\n  /**\r\n   * Event emitted when a widget is deactivate which happens\r\n   * when the widget's component emits the 'cancel' or 'complete' event.\r\n   */\r\n  @Output() deactivateWidget = new EventEmitter<Widget>();\r\n\r\n  /**\r\n   * Observable of the workspace's active widget\r\n   * @internal\r\n   */\r\n  get widget$(): BehaviorSubject<Widget> { return this.workspace.widget$; }\r\n\r\n  /**\r\n   * Observable of the workspace's widget inputs\r\n   * @internal\r\n   */\r\n  get widgetInputs$(): BehaviorSubject<{[key: string]: any}> {\r\n    return this.workspace.widgetInputs$;\r\n  }\r\n\r\n  /**\r\n   * Observable of the workspace's widget inputs\r\n   * @internal\r\n   */\r\n  get widgetSubscribers$(): BehaviorSubject<{[key: string]: (event: any) => void}> {\r\n    return this.workspace.widgetSubscribers$;\r\n  }\r\n\r\n  constructor() {}\r\n\r\n  /**\r\n   * When a widget's component emit the 'cancel' event,\r\n   * deactivate that widget and emit the 'deactivateWidget' event.\r\n   * @param widget Widget\r\n   * @internal\r\n   */\r\n  onWidgetCancel(widget: Widget) {\r\n    this.workspace.deactivateWidget();\r\n    this.deactivateWidget.emit(widget);\r\n  }\r\n\r\n  /**\r\n   * When a widget's component emit the 'cancel' event,\r\n   * deactivate that widget and emit the 'deactivateWidget' event.\r\n   * @param widget Widget\r\n   * @internal\r\n   */\r\n  onWidgetComplete(widget: Widget) {\r\n    this.workspace.deactivateWidget();\r\n    this.deactivateWidget.emit(widget);\r\n  }\r\n\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoWidgetOutletModule } from '../../widget/widget-outlet/widget-outlet.module';\r\n\r\nimport { WorkspaceWidgetOutletComponent } from './workspace-widget-outlet.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoWidgetOutletModule\r\n  ],\r\n  exports: [\r\n    WorkspaceWidgetOutletComponent\r\n  ],\r\n  declarations: [\r\n    WorkspaceWidgetOutletComponent\r\n  ]\r\n})\r\nexport class IgoWorkspaceWidgetOutletModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoWorkspaceSelectorModule } from './workspace-selector/workspace-selector.module';\r\nimport { IgoWorkspaceWidgetOutletModule } from './workspace-widget-outlet/workspace-widget-outlet.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule\r\n  ],\r\n  exports: [\r\n    IgoWorkspaceSelectorModule,\r\n    IgoWorkspaceWidgetOutletModule\r\n  ],\r\n  declarations: []\r\n})\r\nexport class IgoWorkspaceModule {}\r\n","import { BehaviorSubject } from 'rxjs';\r\n\r\nexport class TableDatabase {\r\n  /** Stream that emits whenever the data has been modified. */\r\n  dataChange: BehaviorSubject<any[]> = new BehaviorSubject<any[]>([]);\r\n  get data(): any[] {\r\n    return this.dataChange.value;\r\n  }\r\n\r\n  constructor(data?) {\r\n    if (data) {\r\n      this.dataChange.next(data);\r\n    }\r\n  }\r\n\r\n  set(data) {\r\n    this.dataChange.next(data);\r\n  }\r\n\r\n  add(item) {\r\n    const copiedData = this.data.slice();\r\n    copiedData.push(item);\r\n    this.set(copiedData);\r\n  }\r\n\r\n  remove(item) {\r\n    const copiedData = this.data.slice();\r\n    const index = copiedData.indexOf(item);\r\n    copiedData.splice(index, 1);\r\n    this.set(copiedData);\r\n  }\r\n}\r\n","import { Tool } from './tool.interface';\r\nimport { ToolService } from './tool.service';\r\n\r\nexport function ToolComponent(tool: Partial<Tool>): (cls: any) => any {\r\n  return (compType: any) => {\r\n    ToolService.register(Object.assign({}, tool, {\r\n      component: compType\r\n    } as Tool));\r\n  };\r\n}\r\n","import { EntityStore } from '../../entity';\r\nimport { Workspace } from './workspace';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\n/**\r\n * The class is a specialized version of an EntityStore that stores\r\n * workspaces.\r\n */\r\nexport class WorkspaceStore extends EntityStore<Workspace> {\r\n\r\n  activeWorkspace$: BehaviorSubject<Workspace> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Activate the an workspace workspace and deactivate the one currently active\r\n   * @param workspace Workspace\r\n   */\r\n  activateWorkspace(workspace: Workspace) {\r\n    const active = this.activeWorkspace$.value;\r\n    if (active !== undefined) {\r\n      active.deactivate();\r\n    }\r\n\r\n    this.deactivateWorkspace();\r\n    if (workspace !== undefined) {\r\n      this.state.update(workspace, {active: true, selected: true}, true);\r\n      this.activeWorkspace$.next(workspace);\r\n      workspace.activate();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Deactivate the current workspace\r\n   * @param workspace Workspace\r\n   */\r\n  deactivateWorkspace() {\r\n    const active = this.activeWorkspace$.value;\r\n    if (active !== undefined) {\r\n      active.deactivate();\r\n      this.activeWorkspace$.next(undefined);\r\n    }\r\n  }\r\n\r\n}\r\n","import { Subscription, BehaviorSubject, Subject } from 'rxjs';\r\n\r\nimport { ActionStore } from '../../action';\r\nimport { Widget } from '../../widget';\r\nimport { EntityStore } from '../../entity';\r\n\r\nimport { WorkspaceOptions } from './workspace.interfaces';\r\n\r\n/**\r\n * This class is responsible of managing the relations between\r\n * entities and the actions that consume them. It also defines an\r\n * entity table template that may be used by an entity table component.\r\n */\r\nexport class Workspace<E extends object = object> {\r\n\r\n  /**\r\n   * Observable of the selected widget\r\n   */\r\n  readonly widget$ = new BehaviorSubject<Widget>(undefined);\r\n\r\n  /**\r\n   * Observable of the selected widget's inputs\r\n   */\r\n  readonly widgetInputs$ = new BehaviorSubject<{[key: string]: any}>({});\r\n\r\n  /**\r\n   * Observable of the selected widget's subscribers\r\n   */\r\n  readonly widgetSubscribers$ = new BehaviorSubject<{[key: string]: (event: any) => void}>({});\r\n\r\n  /**\r\n   * Subscription to the selected entity\r\n   */\r\n  private entities$$: Subscription;\r\n\r\n  /**\r\n   * State change that trigger an update of the actions availability\r\n   */\r\n  private change: Subject<void> = new Subject();\r\n\r\n  /**\r\n   * Subscription to state changes\r\n   */\r\n  private change$: Subscription;\r\n\r\n  /**\r\n   * Workspace id\r\n   */\r\n  get id(): string { return this.options.id; }\r\n\r\n  /**\r\n   * Workspace title\r\n   */\r\n  get title(): string { return this.options.title; }\r\n\r\n  /**\r\n   * Workspace title\r\n   */\r\n  get meta(): {[key: string]: any} { return this.options.meta || {}; }\r\n\r\n  /**\r\n   * Entities store\r\n   */\r\n  get entityStore(): EntityStore<E> { return this.options.entityStore as EntityStore<E>; }\r\n\r\n  /**\r\n   * Actions store (some actions activate a widget)\r\n   */\r\n  get actionStore(): ActionStore { return this.options.actionStore; }\r\n\r\n  /**\r\n   * Selected widget\r\n   */\r\n  get widget(): Widget { return this.widget$.value; }\r\n\r\n  /**\r\n   * Whether a widget is selected\r\n   */\r\n  get hasWidget(): boolean { return this.widget !== undefined; }\r\n\r\n  constructor(protected options: WorkspaceOptions) {}\r\n\r\n  /**\r\n   * Whether this strategy is active\r\n   * @internal\r\n   */\r\n  get active(): boolean { return this.active$.value; }\r\n  readonly active$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  /**\r\n   * Activate the workspace. By doing that, the workspace will observe\r\n   * the selected entity (from the store) and update the actions availability.\r\n   * For example, some actions require an entity to be selected.\r\n   */\r\n  activate() {\r\n    if (this.active === true) {\r\n      this.deactivate();\r\n    }\r\n    this.active$.next(true);\r\n\r\n    if (this.entityStore !== undefined) {\r\n      this.entities$$ = this.entityStore.stateView.all$()\r\n        .subscribe(() => this.onStateChange());\r\n    }\r\n\r\n    this.change.next();\r\n  }\r\n\r\n  /**\r\n   * Deactivate the workspace. Unsubcribe to the selected entity.\r\n   */\r\n  deactivate() {\r\n    this.active$.next(false);\r\n    this.deactivateWidget();\r\n\r\n    if (this.entities$$ !== undefined) {\r\n      this.entities$$.unsubscribe();\r\n    }\r\n    if (this.change$ !== undefined) {\r\n      this.change$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Activate a widget. In itself, activating a widget doesn't render it but,\r\n   * if an WorkspaceWidgetOutlet component is bound to this workspace, the widget will\r\n   * show up.\r\n   * @param widget Widget\r\n   * @param inputs Inputs the widget will receive\r\n   */\r\n  activateWidget(\r\n    widget: Widget,\r\n    inputs: {[key: string]: any} = {},\r\n    subscribers: {[key: string]: (event: any) => void} = {}\r\n  ) {\r\n    this.widget$.next(widget);\r\n    this.widgetInputs$.next(inputs);\r\n    this.widgetSubscribers$.next(subscribers);\r\n    this.change.next();\r\n  }\r\n\r\n  /**\r\n   * Deactivate a widget.\r\n   */\r\n  deactivateWidget() {\r\n    this.widget$.next(undefined);\r\n    this.change.next();\r\n  }\r\n\r\n  /**\r\n   * When the state changes, update the actions availability.\r\n   */\r\n  private onStateChange() {\r\n    this.change.next();\r\n  }\r\n\r\n}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppHomeComponent } from './home.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'home',\r\n    component: AppHomeComponent\r\n  }\r\n];\r\n\r\nexport const AppHomeRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\nimport { InteractiveTourService } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'app-home',\r\n  templateUrl: './home.component.html',\r\n  styleUrls: ['./home.component.scss']\r\n})\r\nexport class AppHomeComponent {\r\n  constructor(private interactiveTourService: InteractiveTourService) {}\r\n\r\n  startTour() {\r\n    this.interactiveTourService.startTour('global');\r\n  }\r\n}\r\n","<div style=\"text-align:center\">\r\n  <h1 id=\"igo-title\">\r\n    Welcome to IGO\r\n  </h1>\r\n  <img  class=\"igo-logo\" width=\"180\" src=\"assets/igo2/core/logo.png\">\r\n</div>\r\n\r\n<p>\r\n  <igo-interactive-tour\r\n    tourToStart = \"global\"\r\n    menuIsOpen = true\r\n    styleButton = \"raised\">\r\n  </igo-interactive-tour>\r\n</p>\r\n\r\n<p>\r\n  IGO2 library contains many components and services that may benefit any web application. <br>\r\n  IGO2 library is open source project using Angular, Angular Material and OpenLayers.\r\n</p>\r\n\r\n<h3>IGO2 library is divided into several elements: </h3>\r\n<ul>\r\n  <li><b>@igo2/utils</b> : Basic utilies without dependency (ex: base64, clipboard, uuid)</li>\r\n  <li><b>@igo2/core</b> : Element affecting the core of the application (ex: config, language, message, media, request)</li>\r\n  <li><b>@igo2/common</b> : Library containing reusable components (ex: clickout, drag-drop, list, panel, spinner, table)</li>\r\n  <li><b>@igo2/auth</b> : Library grouping the authentication and security module</li>\r\n  <li><b>@igo2/geo</b> : Library containing the geomatic components. Depends on Openlayers.</li>\r\n  <li><b>@igo2/context</b> : Library of components uniting @igo2/geo and @igo2/auth</li>\r\n  <li><b>@igo2/integration</b> : Library integrate basic components</li>\r\n</ul>\r\n\r\n<h2>Here are some links to help you start: </h2>\r\n<ul>\r\n  <li>\r\n    <h2><a target=\"_blank\" rel=\"noopener\" href=\"https://github.com/infra-geo-ouverte/igo2-lib/blob/master/README.md#user-installation\">Installation</a></h2>\r\n  </li>\r\n  <li>\r\n    <h2><a target=\"_blank\" rel=\"noopener\" href=\"https://angular.io/docs\">Angular Documentation</a></h2>\r\n  </li>\r\n</ul>\r\n\r\n*** Modules in <code>@igo2/core</code> must be imported only once\r\n","import { NgModule } from '@angular/core';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { AppHomeComponent } from './home.component';\r\nimport { AppHomeRoutingModule } from './home-routing.module';\r\nimport { IgoInteractiveTourModule } from '@igo2/common';\r\n\r\n@NgModule({\r\n  declarations: [AppHomeComponent],\r\n  imports: [\r\n    AppHomeRoutingModule,\r\n    IgoInteractiveTourModule,\r\n    MatTooltipModule,\r\n    MatIconModule,\r\n    MatButtonModule\r\n  ],\r\n  exports: [AppHomeComponent]\r\n})\r\nexport class AppHomeModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\nimport { AppActivityComponent } from './activity.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'activity',\r\n    component: AppActivityComponent\r\n  }\r\n];\r\n\r\nexport const AppActivityRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { ActivityService } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'app-activity',\r\n  templateUrl: './activity.component.html',\r\n  styleUrls: ['./activity.component.scss']\r\n})\r\nexport class AppActivityComponent {\r\n  private idsActivity: string[] = [];\r\n\r\n  constructor(private activityService: ActivityService) {}\r\n\r\n  register() {\r\n    this.idsActivity.push(this.activityService.register());\r\n  }\r\n\r\n  unregister() {\r\n    this.activityService.unregister(this.idsActivity.pop());\r\n  }\r\n\r\n  get counter() {\r\n    return this.activityService.counter$.value;\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Core</mat-card-subtitle>\r\n  <mat-card-title>Activity</mat-card-title>\r\n  <mat-card-content>\r\n    <p>Register activities in service. Use to display a loading icon</p>\r\n\r\n    <li>Import <code>IgoActivityModule</code> only if you want register http calls</li>\r\n    <li>Import <code>IgoActivityModule</code> only once</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/core/activity\"> code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <mat-card-actions>\r\n    <button mat-raised-button (click)=\"register()\">Register</button>\r\n    <button mat-raised-button (click)=\"unregister()\">Unregister</button>\r\n  </mat-card-actions>\r\n  <p>Counter: {{counter}}</p>\r\n\r\n  <igo-spinner igoSpinnerActivity></igo-spinner>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoActivityModule } from '@igo2/core';\r\nimport { IgoSpinnerModule } from '@igo2/common';\r\n\r\nimport { AppActivityComponent } from './activity.component';\r\nimport { AppActivityRoutingModule } from './activity-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppActivityComponent],\r\n  imports: [\r\n    AppActivityRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoActivityModule.forRoot(), // Only if you want register http calls\r\n    IgoSpinnerModule\r\n  ],\r\n  exports: [AppActivityComponent]\r\n})\r\nexport class AppActivityModule {}\r\n","interface Environment {\r\n  production: boolean;\r\n  igo: any;\r\n}\r\n\r\nexport const environment: Environment = {\r\n  production: true,\r\n  igo: {\r\n    projections: [\r\n      {\r\n        code: 'EPSG:32198',\r\n        alias: 'Quebec Lambert',\r\n        def:\r\n          '+proj=lcc +lat_1=60 +lat_2=46 +lat_0=44 +lon_0=-68.5 +x_0=0 +y_0=0 +ellps=GRS80 +datum=NAD83 +units=m +no_defs',\r\n        extent: [-886251.0296, 180252.9126, 897177.3418, 2106143.8139]\r\n      }\r\n    ],\r\n    auth: {\r\n      intern: {\r\n        enabled: true\r\n      },\r\n      allowAnonymous: true\r\n    },\r\n    interactiveTour: {\r\n      tourInMobile: true\r\n    },\r\n    importExport: {\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ogre'\r\n    },\r\n    language: {\r\n      prefix: './locale/'\r\n    },\r\n    catalog: {\r\n      sources: [\r\n        {\r\n          id: 'Gououvert',\r\n          title: 'Gouvouvert',\r\n          url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi'\r\n        },\r\n        {\r\n          id: 'DefiningInfoFormat',\r\n          title: 'Defining info_format',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          queryFormat: {\r\n            html: '*',\r\n            'application/json': [\r\n              'stations_meteoroutieres',\r\n              'histo_stations_meteoroutieres'\r\n            ]\r\n          },\r\n          queryHtmlTarget: 'iframe',\r\n          count: 30\r\n        },\r\n        {\r\n          id: 'catalogwithregex',\r\n          title: 'Filtered catalog by regex',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          regFilters: ['zpegt']\r\n        },\r\n        {\r\n          id: 'catalogwithtooltipcontrol',\r\n          title: 'Controling tooltip format',\r\n          url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n          tooltipType: 'abstract' // or title\r\n        }\r\n      ]\r\n    },\r\n    searchSources: {\r\n      nominatim: {\r\n        enabled: false\r\n      },\r\n      icherche: {\r\n        searchUrl: 'https://geoegl.msp.gouv.qc.ca/apis/icherche',\r\n        order: 2,\r\n        enabled: true,\r\n        params: {\r\n          limit: '8'\r\n        }\r\n      },\r\n      coordinatesreverse: {\r\n        showInPointerSummary: true\r\n      },\r\n      icherchereverse: {\r\n        showInPointerSummary: true,\r\n        searchUrl: 'https://geoegl.msp.gouv.qc.ca/apis/terrapi',\r\n        order: 3,\r\n        enabled: true\r\n      },\r\n      ilayer: {\r\n        searchUrl: 'https://geoegl.msp.gouv.qc.ca/apis/layers/search',\r\n        order: 4,\r\n        enabled: true,\r\n        params: {\r\n          limit: '5'\r\n        }\r\n      }\r\n    }\r\n  }\r\n};\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppConfigComponent } from './config.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'config',\r\n    component: AppConfigComponent\r\n  }\r\n];\r\n\r\nexport const AppConfigRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\nimport { ConfigService, LanguageOptions } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'app-config',\r\n  templateUrl: './config.component.html',\r\n  styleUrls: ['./config.component.scss']\r\n})\r\nexport class AppConfigComponent {\r\n  public configLanguage: LanguageOptions;\r\n\r\n  constructor(private configService: ConfigService) {\r\n    this.configLanguage = this.configService.getConfig('language');\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Core</mat-card-subtitle>\r\n  <mat-card-title>config</mat-card-title>\r\n  <mat-card-content>\r\n    <p>Load config in your angular application</p>\r\n\r\n    <li>Import <code>IgoConfigModule</code> only once</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/core/config\"> code of this example</a> <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/environments\"> environment config</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <p>Config language: {{configLanguage | json }}<p>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoConfigModule, provideConfigOptions } from '@igo2/core';\r\n\r\nimport { environment } from '../../../environments/environment';\r\nimport { AppConfigComponent } from './config.component';\r\nimport { AppConfigRoutingModule } from './config-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppConfigComponent],\r\n  imports: [\r\n    AppConfigRoutingModule,\r\n    CommonModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoConfigModule.forRoot()\r\n  ],\r\n  exports: [AppConfigComponent],\r\n  providers: [\r\n    provideConfigOptions({\r\n      default: environment.igo\r\n    })\r\n  ]\r\n})\r\nexport class AppConfigModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppLanguageComponent } from './language.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'language',\r\n    component: AppLanguageComponent\r\n  }\r\n];\r\n\r\nexport const AppLanguageRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\nimport { LanguageService } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'app-language',\r\n  templateUrl: './language.component.html',\r\n  styleUrls: ['./language.component.scss']\r\n})\r\nexport class AppLanguageComponent {\r\n  public app = {\r\n    title: 'IGO'\r\n  };\r\n  constructor(private languageService: LanguageService) {}\r\n\r\n  changeLanguage(language: string) {\r\n    this.languageService.setLanguage(language);\r\n    console.log(this.languageService);\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Core</mat-card-subtitle>\r\n  <mat-card-title>language</mat-card-title>\r\n  <mat-card-content>\r\n    <p>Translate your angular application</p>\r\n\r\n    <li>Import <code>IgoLanguageModule</code> only once</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/core/language\">code of this example</a><br>\r\n    See language section of the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/environments\"> environment config</a><br>\r\n    See <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/locale\">locale files</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <mat-card-actions>\r\n    <button mat-raised-button (click)=\"changeLanguage('en')\">English</button>\r\n    <button mat-raised-button (click)=\"changeLanguage('fr')\">Franais</button>\r\n  </mat-card-actions>\r\n\r\n  <p>{{'welcome' | translate: app}}<p>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { AppLanguageComponent } from './language.component';\r\nimport { AppLanguageRoutingModule } from './language-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppLanguageComponent],\r\n  imports: [\r\n    AppLanguageRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoLanguageModule.forRoot()\r\n  ],\r\n  exports: [AppLanguageComponent]\r\n})\r\nexport class AppLanguageModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppMediaComponent } from './media.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'media',\r\n    component: AppMediaComponent\r\n  }\r\n];\r\n\r\nexport const AppMediaRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { MediaService } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'app-media',\r\n  templateUrl: './media.component.html',\r\n  styleUrls: ['./media.component.scss']\r\n})\r\nexport class AppMediaComponent {\r\n  constructor(private mediaService: MediaService) {}\r\n\r\n  get media() {\r\n    return this.mediaService.getMedia();\r\n  }\r\n\r\n  get orientation() {\r\n    return this.mediaService.getOrientation();\r\n  }\r\n\r\n  get isTouchScreen() {\r\n    return this.mediaService.isTouchScreen();\r\n  }\r\n\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Core</mat-card-subtitle>\r\n  <mat-card-title>Media</mat-card-title>\r\n  <mat-card-content>\r\n    <p>Detect type of media (mobile, tablet, desktop)</p>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/core/media\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <p>Current media: {{media}}</p>\r\n  <p>Current orientation: {{orientation}}</p>\r\n  <p>Device mode:  {{isTouchScreen ? 'Touch device' : 'Not a touch device '}}</p>\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { AppMediaComponent } from './media.component';\r\nimport { AppMediaRoutingModule } from './media-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppMediaComponent],\r\n  imports: [AppMediaRoutingModule, MatCardModule],\r\n  exports: [AppMediaComponent]\r\n})\r\nexport class AppMediaModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppMessageComponent } from './message.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'message',\r\n    component: AppMessageComponent\r\n  }\r\n];\r\n\r\nexport const AppMessageRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { MessageService } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'app-message',\r\n  templateUrl: './message.component.html',\r\n  styleUrls: ['./message.component.scss']\r\n})\r\nexport class AppMessageComponent {\r\n  constructor(private messageService: MessageService) {}\r\n\r\n  success() {\r\n    this.messageService.success('Congratulations', 'Success');\r\n  }\r\n\r\n  info() {\r\n    this.messageService.info('Welcome to IGO', 'Info');\r\n  }\r\n\r\n  alert() {\r\n    this.messageService.alert('Warning', 'Alert');\r\n  }\r\n  error() {\r\n    this.messageService.error('There is a bug', 'Error');\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Core</mat-card-subtitle>\r\n  <mat-card-title>Message</mat-card-title>\r\n  <mat-card-content>\r\n    <p>Show message to user.</p>\r\n\r\n    <li>Import <code>IgoMessageModule</code> only once</li>\r\n    <li>Dependencies: BrowserAnimationsModule </li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/core/message\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <mat-card-actions>\r\n    <button mat-raised-button (click)=\"success()\">Success message</button>\r\n    <button mat-raised-button color='primary' (click)=\"info()\">Info message</button>\r\n    <button mat-raised-button color='accent' (click)=\"alert()\">Alert message</button>\r\n    <button mat-raised-button color='warn' (click)=\"error()\">Error message</button>\r\n  </mat-card-actions>\r\n</mat-card>\r\n\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMessageModule } from '@igo2/core';\r\n\r\nimport { AppMessageComponent } from './message.component';\r\nimport { AppMessageRoutingModule } from './message-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppMessageComponent],\r\n  imports: [\r\n    AppMessageRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoMessageModule.forRoot()\r\n  ],\r\n  exports: [AppMessageComponent]\r\n})\r\nexport class AppMessageModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppRequestComponent } from './request.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'request',\r\n    component: AppRequestComponent\r\n  }\r\n];\r\n\r\nexport const AppRequestRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'app-request',\r\n  templateUrl: './request.component.html',\r\n  styleUrls: ['./request.component.scss']\r\n})\r\nexport class AppRequestComponent {\r\n  constructor(\r\n    private http: HttpClient,\r\n    public languageService: LanguageService\r\n  ) {}\r\n\r\n  callHttp() {\r\n    const url = 'https://geoegl.msp.gouv.qc.ca/apis/icherche/info';\r\n    this.http.get(url).subscribe(rep => {\r\n      console.log(rep);\r\n    });\r\n  }\r\n\r\n  callHttpError() {\r\n    const url = '404';\r\n    this.http.get(url).subscribe(rep => {\r\n      console.log(rep);\r\n    });\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Core</mat-card-subtitle>\r\n  <mat-card-title>Request</mat-card-title>\r\n  <mat-card-content>\r\n    <p>Register http calls in console</p>\r\n\r\n    <li>Import <code>IgoLoggingModule</code> only if you want register http calls in console</li>\r\n    <li>Import <code>IgoErrorModule</code> only if you want register errors from http call in console</li>\r\n    <li>Import modules only once</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/core/request\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <mat-card-actions>\r\n    <button mat-raised-button (click)=\"callHttp()\">Log</button>\r\n    <button mat-raised-button (click)=\"callHttpError()\">Error</button>\r\n  </mat-card-actions>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { HttpClientModule } from '@angular/common/http';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoErrorModule, IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { AppRequestComponent } from './request.component';\r\nimport { AppRequestRoutingModule } from './request-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppRequestComponent],\r\n  imports: [\r\n    AppRequestRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    HttpClientModule,\r\n    IgoLanguageModule.forRoot(),\r\n    IgoErrorModule.forRoot() // Only if you want register errors from http call in console\r\n    // IgoLoggingModule.forRoot() // Only if you want register http calls in console\r\n  ],\r\n  exports: [AppRequestComponent]\r\n})\r\nexport class AppRequestModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Action</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/action\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-actionbar\r\n    [store]=\"store\"\r\n    [withIcon]=\"true\"\r\n    [withTitle]=\"actionbarMode === 'overlay'\"\r\n    [horizontal]=\"true\"\r\n    [mode]=\"actionbarMode\">\r\n  </igo-actionbar>\r\n\r\n</mat-card>\r\n<p></p>\r\n\r\n<mat-card [igoContextMenu]= actionbarMenu>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Action context-menu</mat-card-title>\r\n  <div></div>\r\n</mat-card>\r\n\r\n\r\n\r\n<ng-template #actionbarMenu>\r\n  <igo-actionbar\r\n    [store]=\"store\"\r\n    [withIcon]=\"true\"\r\n    [horizontal]=\"true\"\r\n    [mode]=\"'context'\">\r\n  </igo-actionbar>\r\n</ng-template>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppActionComponent } from './action.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'action',\r\n    component: AppActionComponent\r\n  }\r\n];\r\n\r\nexport const AppActionRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit, OnDestroy } from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport {\r\n  Media,\r\n  MediaOrientation,\r\n  MediaService,\r\n  LanguageService\r\n} from '@igo2/core';\r\nimport { ActionStore, ActionbarMode } from '@igo2/common';\r\nimport { Overlay } from '@angular/cdk/overlay';\r\n\r\n@Component({\r\n  selector: 'app-action',\r\n  templateUrl: './action.component.html',\r\n  styleUrls: ['./action.component.scss']\r\n})\r\nexport class AppActionComponent implements OnInit, OnDestroy {\r\n  public store = new ActionStore([]);\r\n\r\n  private added$ = new BehaviorSubject(false);\r\n\r\n  get actionbarMode(): ActionbarMode {\r\n    const media = this.mediaService.media$.value;\r\n    const orientation = this.mediaService.orientation$.value;\r\n    if (media === Media.Desktop && orientation === MediaOrientation.Landscape) {\r\n      return ActionbarMode.Dock;\r\n    }\r\n    return ActionbarMode.Overlay;\r\n  }\r\n\r\n  constructor(\r\n    public overlay: Overlay,\r\n    private mediaService: MediaService,\r\n    private languageService: LanguageService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.store.load([\r\n      {\r\n        id: 'add',\r\n        title: 'Add',\r\n        icon: 'plus',\r\n        tooltip: 'Add Tooltip',\r\n        handler: () => {\r\n          alert('Add!');\r\n          this.added$.next(true);\r\n        }\r\n      },\r\n      {\r\n        id: 'edit',\r\n        title: 'Edit',\r\n        icon: 'pencil',\r\n        tooltip: 'Edit Tooltip',\r\n        args: ['1'],\r\n        handler: (item: string) => {\r\n          alert(`Edit item ${item}!`);\r\n        },\r\n        availability: () => this.added$\r\n      },\r\n      {\r\n        id: 'delete',\r\n        title: 'Delete',\r\n        tooltip: 'Delete Tooltip',\r\n        icon: 'delete',\r\n        handler: () => {\r\n          alert('Delete!');\r\n          this.added$.next(false);\r\n        },\r\n        availability: () => this.added$\r\n      }\r\n    ]);\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.store.destroy();\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoActionModule, IgoContextMenuModule } from '@igo2/common';\r\n\r\nimport { AppActionComponent } from './action.component';\r\nimport { AppActionRoutingModule } from './action-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppActionComponent],\r\n  imports: [\r\n    AppActionRoutingModule,\r\n    MatButtonModule,\r\n    MatCardModule,\r\n    IgoActionModule,\r\n    IgoContextMenuModule\r\n  ],\r\n  exports: [AppActionComponent]\r\n})\r\nexport class AppActionModule {}\r\n","import { Component, Input, ChangeDetectionStrategy, ChangeDetectorRef } from '@angular/core';\r\n\r\nimport { OnUpdateInputs } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'app-salutation-component',\r\n  template: '<p>Hello, my name is {{name}}.</p>',\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AppSalutationComponent implements OnUpdateInputs {\r\n\r\n  @Input() name: string;\r\n\r\n  constructor(private cdRef: ChangeDetectorRef) {}\r\n\r\n  onUpdateInputs() {\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n}\r\n\r\n@Component({\r\n  selector: 'app-explanation-component',\r\n  template: '<p>I am a dynamic component, rendered into an IgoDynamicOutlet.</p>',\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AppExplanationComponent implements OnUpdateInputs {\r\n\r\n  constructor(private cdRef: ChangeDetectorRef) {}\r\n\r\n  onUpdateInputs() {\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n}\r\n\r\n@Component({\r\n  selector: 'app-dynamic-component',\r\n  templateUrl: './dynamic-component.component.html',\r\n  styleUrls: ['./dynamic-component.component.scss']\r\n})\r\nexport class AppDynamicComponentComponent {\r\n\r\n  component: any = AppSalutationComponent;\r\n\r\n  inputs = {name: 'Bob'};\r\n\r\n  toggleComponent() {\r\n    this.component = this.component === AppSalutationComponent ?\r\n      AppExplanationComponent :\r\n      AppSalutationComponent;\r\n  }\r\n\r\n}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppDynamicComponentComponent } from './dynamic-component.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'dynamic-component',\r\n    component: AppDynamicComponentComponent\r\n  }\r\n];\r\n\r\nexport const AppDynamicComponentRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","<mat-card>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Dynamic Component</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/dynamic-component\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-dynamic-outlet\r\n    [component]=\"component\"\r\n    [inputs]=\"inputs\">\r\n  </igo-dynamic-outlet>\r\n\r\n  <button mat-flat-button color=\"primary\" (click)=\"toggleComponent()\">Toggle Component</button>\r\n</mat-card>\r\n\r\n\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoDynamicComponentModule } from '@igo2/common';\r\n\r\nimport {\r\n  AppSalutationComponent,\r\n  AppExplanationComponent,\r\n  AppDynamicComponentComponent\r\n} from './dynamic-component.component';\r\nimport { AppDynamicComponentRoutingModule } from './dynamic-component-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [\r\n    AppSalutationComponent,\r\n    AppDynamicComponentComponent,\r\n    AppExplanationComponent\r\n  ],\r\n  imports: [\r\n    AppDynamicComponentRoutingModule,\r\n    MatButtonModule,\r\n    MatCardModule,\r\n    IgoDynamicComponentModule\r\n  ],\r\n  exports: [AppDynamicComponentComponent],\r\n  entryComponents: [\r\n    AppSalutationComponent,\r\n    AppExplanationComponent\r\n  ]\r\n})\r\nexport class AppDynamicComponentModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppEntityTableComponent } from './entity-table.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'entity-table',\r\n    component: AppEntityTableComponent\r\n  }\r\n];\r\n\r\nexport const AppEntityTableRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit, OnDestroy } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  EntityStore,\r\n  EntityTableButton,\r\n  getEntityProperty,\r\n  EntityTableColumnRenderer,\r\n  EntityTablePaginatorOptions\r\n} from '@igo2/common';\r\nimport { MatPaginator } from '@angular/material/paginator';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'app-entity-table',\r\n  templateUrl: './entity-table.component.html',\r\n  styleUrls: ['./entity-table.component.scss']\r\n})\r\nexport class AppEntityTableComponent implements OnInit, OnDestroy {\r\n  public store = new EntityStore([]);\r\n  public paginator: MatPaginator;\r\n  entitySortChange$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  public paginatorOptions: EntityTablePaginatorOptions = {pageSize: 10};\r\n\r\n  public template = {\r\n    selection: true,\r\n    selectionCheckbox: true,\r\n    selectMany: true,\r\n    sort: true,\r\n    valueAccessor: (entity: object, name: string) => {\r\n      return getEntityProperty(entity, name);\r\n    },\r\n    columns: [\r\n      {\r\n        name: 'selected',\r\n        title: 'Selected',\r\n        valueAccessor: (entity: object) => {\r\n          return this.store.state.get(entity).selected\r\n            ? 'radiobox-marked'\r\n            : 'radiobox-blank';\r\n        },\r\n        renderer: EntityTableColumnRenderer.Icon\r\n      },\r\n      {\r\n        name: 'id',\r\n        title: 'ID'\r\n      },\r\n      {\r\n        name: 'name',\r\n        title: 'Name'\r\n      },\r\n      {\r\n        name: 'description',\r\n        title: 'Description',\r\n        renderer: EntityTableColumnRenderer.HTML\r\n      },\r\n      {\r\n        name: 'url',\r\n        title: 'Hyperlink'\r\n      },\r\n      {\r\n        name: 'image',\r\n        title: 'Image'\r\n      },\r\n      {\r\n        name: 'action',\r\n        title: '',\r\n        valueAccessor: (entity: object) => {\r\n          return [{\r\n            icon: 'home',\r\n            color: 'warn',\r\n            click: (row) => { console.log(row); }\r\n          }] as EntityTableButton[];\r\n        },\r\n        renderer: EntityTableColumnRenderer.ButtonGroup\r\n      }\r\n    ]\r\n  };\r\n\r\n  constructor(private languageService: LanguageService) {}\r\n\r\n  ngOnInit() {\r\n    const ids = [2, 1, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13];\r\n\r\n    const entities = ids.map(id => {\r\n      return { id , name: `Name ${id}`, description: `<b>Description ${id}</b>`, url: 'https://igouverte.org', image: 'https://www.igouverte.org/assets/img/Igo_logoavec.png'};\r\n    });\r\n    this.store.load(entities);\r\n  }\r\n\r\n  entitySortChange() {\r\n    this.entitySortChange$.next(true);\r\n  }\r\n\r\n  paginatorChange(event: MatPaginator) {\r\n    this.paginator = event;\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.store.destroy();\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Entity Table</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/entity-table\">code of this example</a>\r\n  </mat-card-content>\r\n  <igo-entity-table\r\n    [store]=\"store\"\r\n    [withPaginator]=\"true\"\r\n    [paginatorOptions]=\"paginatorOptions\"\r\n    [template]=\"template\"\r\n    (entitySortChange)=\"entitySortChange()\">\r\n  </igo-entity-table>\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoEntityTableModule, IgoEntityTablePaginatorModule } from '@igo2/common';\r\n\r\nimport { AppEntityTableComponent } from './entity-table.component';\r\nimport { AppEntityTableRoutingModule } from './entity-table-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppEntityTableComponent],\r\n  imports: [\r\n    AppEntityTableRoutingModule,\r\n    MatCardModule,\r\n    IgoEntityTableModule,\r\n    IgoEntityTablePaginatorModule\r\n  ],\r\n  exports: [AppEntityTableComponent]\r\n})\r\nexport class AppEntityTableModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Entity Selector</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/entity-selector\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-entity-selector\r\n    [store]=\"store\"\r\n    [titleAccessor]=\"getTitle\"\r\n    [emptyText]=\"''\"\r\n    [placeholder]=\"'Select an entity'\"\r\n    (selectedChange)=\"onSelectedChange($event)\">\r\n  </igo-entity-selector>\r\n\r\n  <div *ngIf=\"selected$ | async as selected\">\r\n    <p>ID: {{selected.id}}</p>\r\n    <p>Name: {{selected.name}}</p>\r\n    <p>Description: <span [innerHtml]=\"selected.description\"></span></p>\r\n  </div>\r\n</mat-card>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppEntitySelectorComponent } from './entity-selector.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'entity-selector',\r\n    component: AppEntitySelectorComponent\r\n  }\r\n];\r\n\r\nexport const AppEntitySelectorRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit, OnDestroy } from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { EntityStore } from '@igo2/common';\r\n\r\ninterface DemoEntity {\r\n  id: string;\r\n  name: string;\r\n  description: string;\r\n}\r\n\r\n@Component({\r\n  selector: 'app-entity-selector',\r\n  templateUrl: './entity-selector.component.html',\r\n  styleUrls: ['./entity-selector.component.scss']\r\n})\r\nexport class AppEntitySelectorComponent implements OnInit, OnDestroy {\r\n\r\n  public store = new EntityStore([]);\r\n\r\n  public selected$ = new BehaviorSubject<DemoEntity>(undefined);\r\n\r\n  constructor(private languageService: LanguageService) {}\r\n\r\n  ngOnInit() {\r\n    this.store.load([\r\n      {id: '2', name: 'Name 2', description: '<b>Description 2</b>'},\r\n      {id: '1', name: 'Name 1', description: '<b>Description 1</b>'},\r\n      {id: '3', name: 'Name 3', description: '<b>Description 3</b>'}\r\n    ]);\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.store.destroy();\r\n  }\r\n\r\n  getTitle(entity: DemoEntity): string {\r\n    return entity.name;\r\n  }\r\n\r\n  onSelectedChange(event: {selected: boolean; entity: DemoEntity}) {\r\n    this.selected$.next(event.entity);\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoEntitySelectorModule } from '@igo2/common';\r\n\r\nimport { AppEntitySelectorComponent } from './entity-selector.component';\r\nimport { AppEntitySelectorRoutingModule } from './entity-selector-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppEntitySelectorComponent],\r\n  imports: [\r\n    CommonModule,\r\n    AppEntitySelectorRoutingModule,\r\n    MatCardModule,\r\n    IgoEntitySelectorModule\r\n  ],\r\n  exports: [AppEntitySelectorComponent]\r\n})\r\nexport class AppEntitySelectorModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Form</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/form\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-form\r\n    *ngIf=\"form$ | async as form\"\r\n    [form]=\"form\"\r\n    [formData]=\"data$ | async\"\r\n    (submitForm)=\"onSubmit($event)\">\r\n\r\n    <igo-form-group [group]=\"form.groups[0]\"></igo-form-group>\r\n\r\n    <div formButtons>\r\n      <button\r\n        mat-stroked-button\r\n        type=\"button\"\r\n        color=\"primary\"\r\n        (click)=\"fillForm()\">\r\n        Fill Form\r\n      </button>\r\n      <button\r\n        mat-stroked-button\r\n        type=\"button\"\r\n        color=\"primary\"\r\n        (click)=\"clearForm()\">\r\n        Clear Form\r\n      </button>\r\n      <button\r\n        mat-flat-button\r\n        type=\"submit\"\r\n        color=\"primary\"\r\n        [disabled]=\"submitDisabled\">\r\n        Submit\r\n      </button>\r\n    </div>\r\n  </igo-form>\r\n</mat-card>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppFormComponent } from './form.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'form',\r\n    component: AppFormComponent\r\n  }\r\n];\r\n\r\nexport const AppFormRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit, OnDestroy } from '@angular/core';\r\nimport { Validators } from '@angular/forms';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { Form, FormService } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'app-form',\r\n  templateUrl: './form.component.html',\r\n  styleUrls: ['./form.component.scss']\r\n})\r\nexport class AppFormComponent implements OnInit, OnDestroy {\r\n\r\n  form$ = new BehaviorSubject<Form>(undefined);\r\n\r\n  data$ = new BehaviorSubject<{[key: string]: any}>(undefined);\r\n\r\n  submitDisabled = true;\r\n\r\n  private valueChanges$$: Subscription;\r\n\r\n  constructor(\r\n    private formService: FormService,\r\n    private languageService: LanguageService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    const fieldConfigs = [\r\n      {\r\n        name: 'id',\r\n        title: 'ID',\r\n        options: {\r\n          cols: 1,\r\n          validator: Validators.required\r\n        }\r\n      },\r\n      {\r\n        name: 'name',\r\n        title: 'Name',\r\n        options: {\r\n          cols: 1,\r\n          validator: Validators.required\r\n        }\r\n      },\r\n      {\r\n        name: 'status',\r\n        title: 'Status',\r\n        type: 'select',\r\n        options: {\r\n          cols: 2\r\n        },\r\n        inputs: {\r\n          choices: [\r\n            {value: 1, title: 'Single'},\r\n            {value: 2, title: 'Married'}\r\n          ]\r\n        }\r\n      }\r\n    ];\r\n\r\n    const fields = fieldConfigs.map((config) => this.formService.field(config));\r\n    const form = this.formService.form([], [this.formService.group({name: 'info'}, fields)]);\r\n\r\n    this.valueChanges$$ = form.control.valueChanges.subscribe(() => {\r\n      this.submitDisabled = !form.control.valid;\r\n    });\r\n\r\n    this.form$.next(form);\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.valueChanges$$.unsubscribe();\r\n  }\r\n\r\n  fillForm() {\r\n    this.data$.next({\r\n      id: 1,\r\n      name: 'Bob',\r\n      status: 2\r\n    });\r\n  }\r\n\r\n  clearForm() {\r\n    this.form$.value.control.reset();\r\n  }\r\n\r\n  onSubmit(data: {[key: string]: any}) {\r\n    alert(JSON.stringify(data));\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoFormModule } from '@igo2/common';\r\n\r\nimport { AppFormComponent } from './form.component';\r\nimport { AppFormRoutingModule } from './form-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppFormComponent],\r\n  imports: [\r\n    CommonModule,\r\n    AppFormRoutingModule,\r\n    MatButtonModule,\r\n    MatCardModule,\r\n    IgoFormModule\r\n  ],\r\n  exports: [AppFormComponent]\r\n})\r\nexport class AppFormModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppTableComponent } from './table.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'table',\r\n    component: AppTableComponent\r\n  }\r\n];\r\n\r\nexport const AppTableRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { TableDatabase, TableActionColor } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'app-table',\r\n  templateUrl: './table.component.html',\r\n  styleUrls: ['./table.component.scss']\r\n})\r\nexport class AppTableComponent implements OnInit {\r\n  public database: TableDatabase;\r\n\r\n  public model = {\r\n    columns: [\r\n      {\r\n        name: 'id',\r\n        title: 'ID',\r\n        sortable: false,\r\n        filterable: true\r\n      },\r\n      {\r\n        name: 'name',\r\n        title: 'Name',\r\n        sortable: true,\r\n        filterable: true\r\n      },\r\n      {\r\n        name: 'description',\r\n        title: 'Description',\r\n        sortable: true,\r\n        filterable: true\r\n      }\r\n    ],\r\n    actions: [\r\n      {\r\n        icon: 'file-document',\r\n        color: TableActionColor.primary,\r\n        click: row => this.showName(row.name)\r\n      }\r\n    ],\r\n    selectionCheckbox: true\r\n  };\r\n\r\n  constructor(private languageService: LanguageService) {}\r\n\r\n  ngOnInit() {\r\n    this.database = new TableDatabase([\r\n      { id: '2', name: 'Name 2', description: 'Hello 2' },\r\n      { id: '1', name: 'Name 1', description: 'Bonjour 1' },\r\n      { id: '3', name: 'Name 3', description: 'Hola 3' }\r\n    ]);\r\n  }\r\n\r\n  showName(name) {\r\n    alert(name);\r\n  }\r\n\r\n  handleSelect(rows) {\r\n    console.log(rows);\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Table</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/table\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-table\r\n    [database]=\"database\"\r\n    [model]=\"model\"\r\n    [hasFilterInput]=\"true\"\r\n    (select)=\"handleSelect($event)\">\r\n  </igo-table>\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoTableModule } from '@igo2/common';\r\n\r\nimport { AppTableComponent } from './table.component';\r\nimport { AppTableRoutingModule } from './table-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppTableComponent],\r\n  imports: [\r\n    AppTableRoutingModule,\r\n    MatCardModule,\r\n    IgoTableModule\r\n  ],\r\n  exports: [AppTableComponent]\r\n})\r\nexport class AppTableModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Tool</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/tool\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-panel [title]=\"panelTitle\">\r\n    <button\r\n      mat-icon-button\r\n      panelLeftButton\r\n      (click)=\"toolbox.activatePreviousTool()\"\r\n      *ngIf=\"activeTool$ | async\">\r\n      <mat-icon svgIcon=\"arrow-back\"></mat-icon>\r\n    </button>\r\n\r\n    <button\r\n      mat-icon-button\r\n      panelRightButton\r\n      (click)=\"toolbox.deactivateTool()\"\r\n      *ngIf=\"activeTool$ | async\">\r\n      <mat-icon svgIcon=\"menu\"></mat-icon>\r\n    </button>\r\n\r\n    <igo-toolbox [toolbox]=\"toolbox\" [animate]=\"true\"></igo-toolbox>\r\n  </igo-panel>\r\n\r\n  <button\r\n    mat-flat-button\r\n    type=\"button\"\r\n    color=\"primary\"\r\n    (click)=\"activateSalutationTool()\">\r\n    Activate Salutation Tool\r\n  </button>\r\n\r\n</mat-card>\r\n","import {\r\n  Component,\r\n  OnInit,\r\n  OnDestroy,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  OnUpdateInputs,\r\n  Tool,\r\n  Toolbox,\r\n  ToolComponent,\r\n  ToolService\r\n} from '@igo2/common';\r\n\r\n@ToolComponent({\r\n  name: 'demo-salutation',\r\n  title: 'Salutation',\r\n  icon: 'account',\r\n  options: {name: 'Jack'}\r\n})\r\n@Component({\r\n  selector: 'app-salutation-tool',\r\n  template: `\r\n    <p>Hello, my name is {{name}}.</p>\r\n  `,\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AppSalutationToolComponent implements OnUpdateInputs {\r\n\r\n  @Input() name: string;\r\n\r\n  constructor(private cdRef: ChangeDetectorRef) {}\r\n\r\n  onUpdateInputs() {\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n}\r\n\r\n@ToolComponent({\r\n  name: 'demo-about',\r\n  title: 'About',\r\n  icon: 'information'\r\n})\r\n@Component({\r\n  selector: 'app-about-tool',\r\n  template: `\r\n    <p>I'm a tool inside a toolbox.</p>\r\n  `,\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AppAboutToolComponent {}\r\n\r\n@Component({\r\n  selector: 'app-tool',\r\n  templateUrl: './tool.component.html',\r\n  styleUrls: ['./tool.component.scss']\r\n})\r\nexport class AppToolComponent implements OnInit, OnDestroy {\r\n\r\n  toolbox = new Toolbox();\r\n\r\n  get activeTool$(): BehaviorSubject<Tool> {\r\n    return this.toolbox.activeTool$;\r\n  }\r\n\r\n  get panelTitle(): string {\r\n    return this.activeTool$.value ? this.activeTool$.value.title : 'Toolbox';\r\n  }\r\n\r\n  constructor(\r\n    private toolService: ToolService,\r\n    private languageService: LanguageService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.toolbox.setToolbar(['demo-salutation', 'demo-about']);\r\n    this.toolbox.setTools(this.toolService.getTools());\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.toolbox.destroy();\r\n  }\r\n\r\n  activateSalutationTool() {\r\n    this.toolbox.activateTool('demo-salutation', {name: 'Bob'});\r\n  }\r\n\r\n}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppToolComponent } from './tool.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'tool',\r\n    component: AppToolComponent\r\n  }\r\n];\r\n\r\nexport const AppToolRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoPanelModule, IgoToolModule } from '@igo2/common';\r\n\r\nimport {\r\n  AppToolComponent,\r\n  AppSalutationToolComponent,\r\n  AppAboutToolComponent\r\n} from './tool.component';\r\nimport { AppToolRoutingModule } from './tool-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [\r\n    AppToolComponent,\r\n    AppSalutationToolComponent,\r\n    AppAboutToolComponent\r\n  ],\r\n  imports: [\r\n    CommonModule,\r\n    AppToolRoutingModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    MatCardModule,\r\n    IgoLanguageModule,\r\n    IgoPanelModule,\r\n    IgoToolModule.forRoot()\r\n  ],\r\n  exports: [AppToolComponent],\r\n  entryComponents: [\r\n    AppSalutationToolComponent,\r\n    AppAboutToolComponent\r\n  ]\r\n})\r\nexport class AppToolModule {}\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\n\r\nimport { DynamicComponent, OnUpdateInputs, WidgetComponent, WidgetService } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'app-salutation-widget',\r\n  template: `\r\n    <p>Hello, my name is {{name}}.</p>\r\n    <button mat-flat-button (click)=\"complete.emit(name)\">Nice to meet you</button>\r\n    <button mat-flat-button (click)=\"cancel.emit(name)\">Dismiss</button>\r\n  `,\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AppSalutationWidgetComponent implements OnUpdateInputs, WidgetComponent {\r\n\r\n  @Input() name: string;\r\n\r\n  @Output() complete = new EventEmitter<string>();\r\n\r\n  @Output() cancel = new EventEmitter<string>();\r\n\r\n  constructor(private cdRef: ChangeDetectorRef) {}\r\n\r\n  onUpdateInputs() {\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n}\r\n\r\n@Component({\r\n  selector: 'app-widget',\r\n  templateUrl: './widget.component.html',\r\n  styleUrls: ['./widget.component.scss']\r\n})\r\nexport class AppWidgetComponent {\r\n\r\n  widget: DynamicComponent<WidgetComponent> = this.widgetService.create(AppSalutationWidgetComponent);\r\n\r\n  inputs = {name: 'Bob'};\r\n\r\n  constructor(private widgetService: WidgetService) {}\r\n\r\n  onWidgetComplete(name: string) {\r\n    alert(`${name} emitted event 'complete' then got automatically destroyed.`);\r\n  }\r\n\r\n  onWidgetCancel() {\r\n    alert(`Widget emitted event 'cancel' then got automatically destroyed.`);\r\n  }\r\n\r\n}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppWidgetComponent } from './widget.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'widget',\r\n    component: AppWidgetComponent\r\n  }\r\n];\r\n\r\nexport const AppWidgetRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","<mat-card>\r\n  <mat-card-subtitle>Common</mat-card-subtitle>\r\n  <mat-card-title>Widget</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/widget\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-widget-outlet\r\n    [widget]=\"widget\"\r\n    [inputs]=\"inputs\"\r\n    (complete)=\"onWidgetComplete($event)\"\r\n    (cancel)=\"onWidgetCancel()\">\r\n  </igo-widget-outlet>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoWidgetModule } from '@igo2/common';\r\n\r\nimport {\r\n  AppSalutationWidgetComponent,\r\n  AppWidgetComponent\r\n} from './widget.component';\r\nimport { AppWidgetRoutingModule } from './widget-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [\r\n    AppSalutationWidgetComponent,\r\n    AppWidgetComponent\r\n  ],\r\n  imports: [\r\n    AppWidgetRoutingModule,\r\n    MatButtonModule,\r\n    MatCardModule,\r\n    IgoWidgetModule\r\n  ],\r\n  exports: [AppWidgetComponent],\r\n  entryComponents: [\r\n    AppSalutationWidgetComponent\r\n  ]\r\n})\r\nexport class AppWidgetModule {}\r\n","import { Injectable, Injector } from '@angular/core';\r\nimport jwtDecode from 'jwt-decode';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { AuthOptions } from './auth.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class TokenService {\r\n  private options: AuthOptions;\r\n\r\n  constructor(private injector: Injector) {}\r\n\r\n  set(token: string) {\r\n    localStorage.setItem(this.tokenKey, token);\r\n  }\r\n\r\n  remove() {\r\n    localStorage.removeItem(this.tokenKey);\r\n  }\r\n\r\n  get(): string {\r\n    return localStorage.getItem(this.tokenKey);\r\n  }\r\n\r\n  decode() {\r\n    const token = this.get();\r\n    if (!token) {\r\n      return;\r\n    }\r\n    return jwtDecode(token);\r\n  }\r\n\r\n  isExpired() {\r\n    const jwt = this.decode();\r\n    const currentTime = new Date().getTime() / 1000;\r\n    if (jwt && currentTime < jwt.exp) {\r\n      return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  private get tokenKey() {\r\n    const config = this.injector.get<ConfigService>(ConfigService);\r\n    this.options = config.getConfig('auth') || {};\r\n    return this.options.tokenKey;\r\n  }\r\n}\r\n","import { Injectable, Optional } from '@angular/core';\r\nimport { HttpClient, HttpHeaders } from '@angular/common/http';\r\nimport { Router } from '@angular/router';\r\n\r\nimport { Observable, BehaviorSubject, of } from 'rxjs';\r\nimport { tap, catchError } from 'rxjs/operators';\r\nimport { globalCacheBusterNotifier } from 'ts-cacheable';\r\n\r\nimport { ConfigService, LanguageService, MessageService } from '@igo2/core';\r\nimport { Base64 } from '@igo2/utils';\r\n\r\nimport { User, IInfosUser } from './auth.interface';\r\nimport { TokenService } from './token.service';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class AuthService {\r\n  public authenticate$ = new BehaviorSubject<boolean>(undefined);\r\n  public logged$ = new BehaviorSubject<boolean>(undefined);\r\n  public redirectUrl: string;\r\n  private anonymous = false;\r\n\r\n  get hasAuthService() {\r\n    return this.config.getConfig('auth.url') !== undefined;\r\n  }\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private tokenService: TokenService,\r\n    private config: ConfigService,\r\n    private languageService: LanguageService,\r\n    private messageService: MessageService,\r\n    @Optional() private router: Router\r\n  ) {\r\n    this.authenticate$.next(this.authenticated);\r\n    this.authenticate$.subscribe((authenticated) => {\r\n      this.logged$.next(authenticated);\r\n      globalCacheBusterNotifier.next();\r\n    });\r\n  }\r\n\r\n  login(username: string, password: string): Observable<void> {\r\n    const myHeader = new HttpHeaders({ 'Content-Type': 'application/json' });\r\n\r\n    const body = {\r\n      username,\r\n      password: this.encodePassword(password)\r\n    };\r\n\r\n    return this.loginCall(body, myHeader);\r\n  }\r\n\r\n  loginWithToken(token: string, type: string, infosUser?: IInfosUser): Observable<void> {\r\n    const myHeader = new HttpHeaders({ 'Content-Type': 'application/json' });\r\n\r\n    const body = {\r\n      token,\r\n      typeConnection: type,\r\n      infosUser\r\n    };\r\n\r\n    return this.loginCall(body, myHeader);\r\n  }\r\n\r\n  loginAnonymous(): Observable<boolean> {\r\n    this.anonymous = true;\r\n    this.logged$.next(true);\r\n    return of(true);\r\n  }\r\n\r\n  refresh(): Observable<void> {\r\n    const url = this.config.getConfig('auth.url');\r\n    return this.http.post(`${url}/refresh`, {}).pipe(\r\n      tap((data: any) => {\r\n        this.tokenService.set(data.token);\r\n      }),\r\n      catchError((err) => {\r\n        err.error.caught = true;\r\n        throw err;\r\n      })\r\n    );\r\n  }\r\n\r\n  logout(): Observable<boolean> {\r\n    this.anonymous = false;\r\n    this.tokenService.remove();\r\n    this.authenticate$.next(false);\r\n    return of(true);\r\n  }\r\n\r\n  isAuthenticated(): boolean {\r\n    return !this.tokenService.isExpired();\r\n  }\r\n\r\n  getToken(): string {\r\n    return this.tokenService.get();\r\n  }\r\n\r\n  decodeToken() {\r\n    if (this.isAuthenticated()) {\r\n      return this.tokenService.decode();\r\n    }\r\n    return false;\r\n  }\r\n\r\n  goToRedirectUrl() {\r\n    if (!this.router) {\r\n      return;\r\n    }\r\n    const redirectUrl = this.redirectUrl || this.router.url;\r\n\r\n    const options = this.config.getConfig('auth') || {};\r\n    if (redirectUrl === options.loginRoute) {\r\n      const homeRoute = options.homeRoute || '/';\r\n      this.router.navigateByUrl(homeRoute);\r\n    } else if (redirectUrl) {\r\n      this.router.navigateByUrl(redirectUrl);\r\n    }\r\n  }\r\n\r\n  getUserInfo(): Observable<User> {\r\n    const url = this.config.getConfig('auth.url') + '/info';\r\n    return this.http.get<User>(url);\r\n  }\r\n\r\n  getProfils(): Observable<{ profils: string[] }> {\r\n    const url = this.config.getConfig('auth.url');\r\n    return this.http.get<{ profils: string[] }>(`${url}/profils`);\r\n  }\r\n\r\n  updateUser(user: User): Observable<User> {\r\n    const url = this.config.getConfig('auth.url');\r\n    return this.http.patch<User>(url, user);\r\n  }\r\n\r\n  private encodePassword(password: string) {\r\n    return Base64.encode(password);\r\n  }\r\n\r\n  // authenticated or anonymous\r\n  get logged(): boolean {\r\n    return this.authenticated || this.isAnonymous;\r\n  }\r\n\r\n  get isAnonymous(): boolean {\r\n    return this.anonymous;\r\n  }\r\n\r\n  get authenticated(): boolean {\r\n    return this.isAuthenticated();\r\n  }\r\n\r\n  get isAdmin(): boolean {\r\n    const token = this.decodeToken();\r\n    if (token && token.user && token.user.isAdmin) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  private loginCall(body, headers) {\r\n    const url = this.config.getConfig('auth.url');\r\n    return this.http.post(`${url}/login`, body, { headers }).pipe(\r\n      tap((data: any) => {\r\n        this.tokenService.set(data.token);\r\n        const tokenDecoded = this.decodeToken();\r\n        if (tokenDecoded && tokenDecoded.user) {\r\n          if (tokenDecoded.user.locale) {\r\n            this.languageService.setLanguage(tokenDecoded.user.locale);\r\n          }\r\n          if (tokenDecoded.user.isExpired) {\r\n            this.languageService.translate\r\n              .get('igo.auth.error.Password expired')\r\n              .subscribe((expiredAlert) =>\r\n                this.messageService.alert(expiredAlert)\r\n              );\r\n          }\r\n        }\r\n        this.authenticate$.next(true);\r\n      }),\r\n      catchError((err) => {\r\n        err.error.caught = true;\r\n        throw err;\r\n      })\r\n    );\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  ChangeDetectionStrategy,\r\n  ApplicationRef,\r\n  Output,\r\n  EventEmitter\r\n} from '@angular/core';\r\n\r\nimport { ConfigService, LanguageService } from '@igo2/core';\r\nimport { AuthGoogleOptions } from '../shared/auth.interface';\r\nimport { AuthService } from '../shared/auth.service';\r\n\r\n@Component({\r\n  selector: 'igo-auth-google',\r\n  templateUrl: './auth-google.component.html',\r\n  styleUrls: ['./auth-google.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AuthGoogleComponent {\r\n  private options: AuthGoogleOptions;\r\n\r\n  @Output() login: EventEmitter<boolean> = new EventEmitter<boolean>();\r\n\r\n  constructor(\r\n    private authService: AuthService,\r\n    private config: ConfigService,\r\n    private languageService: LanguageService,\r\n    private appRef: ApplicationRef\r\n  ) {\r\n    this.options = this.config.getConfig('auth.google') || {};\r\n\r\n    if (this.options.apiKey && this.options.clientId) {\r\n      this.loadSDKGoogle();\r\n      this.loadPlatform();\r\n    } else {\r\n      console.warn('Google authentification needs \"apiKey\" and \"clientId\" options');\r\n    }\r\n  }\r\n\r\n  public handleSignInClick() {\r\n    (window as any).gapi.auth2.getAuthInstance().signIn();\r\n  }\r\n\r\n  public handleSignOutClick() {\r\n    (window as any).gapi.auth2.getAuthInstance().signOut();\r\n  }\r\n\r\n  private handleClientLoad() {\r\n    (window as any).gapi.load('client:auth2', () => this.initClient());\r\n  }\r\n\r\n  private initClient() {\r\n    (window as any).gapi.client\r\n      .init({\r\n        apiKey: this.options.apiKey,\r\n        clientId: this.options.clientId,\r\n        discoveryDocs: [\r\n          'https://people.googleapis.com/$discovery/rest?version=v1'\r\n        ],\r\n        scope: 'profile'\r\n      })\r\n      .then(() => {\r\n        this.handleSignOutClick();\r\n        this.updateTextButton();\r\n        (window as any).gapi.auth2.getAuthInstance().isSignedIn.listen(rep => {\r\n          this.updateSigninStatus(rep);\r\n        });\r\n      });\r\n  }\r\n\r\n  private updateSigninStatus(isSignedIn) {\r\n    this.updateTextButton();\r\n    if (isSignedIn) {\r\n      this.loginGoogle((window as any).gapi.client.getToken().access_token);\r\n    }\r\n  }\r\n\r\n  private updateTextButton() {\r\n    const btn = document.querySelector('span[id^=\"not_signed_\"]');\r\n    if (btn && this.languageService.getLanguage() !== 'en') {\r\n      if (btn.innerHTML === 'Sign in with Google') {\r\n        btn.innerHTML = this.languageService.translate.instant('igo.auth.google.login');\r\n      } else if (btn.innerHTML === 'Signed in with Google') {\r\n        btn.innerHTML = this.languageService.translate.instant('igo.auth.google.logged');\r\n      }\r\n    }\r\n  }\r\n\r\n  private loginGoogle(token) {\r\n    this.authService.loginWithToken(token, 'google').subscribe(() => {\r\n      this.appRef.tick();\r\n      this.login.emit(true);\r\n    });\r\n  }\r\n\r\n  private loadSDKGoogle() {\r\n    const fjs = document.getElementsByTagName('script')[0];\r\n    const js = document.createElement('script');\r\n    js.id = 'google-jssdk';\r\n    js.src = 'https://apis.google.com/js/api.js';\r\n    js.onload = () => {\r\n      this.handleClientLoad();\r\n    };\r\n    fjs.parentNode.insertBefore(js, fjs);\r\n  }\r\n\r\n  private loadPlatform() {\r\n    const fjs = document.getElementsByTagName('script')[0];\r\n    const js = document.createElement('script');\r\n    js.id = 'google-platform';\r\n    js.src = 'https://apis.google.com/js/platform.js';\r\n    fjs.parentNode.insertBefore(js, fjs);\r\n  }\r\n}\r\n","<div class=\"g-signin2 google-login-button\" data-height=\"40\" data-width=\"265\" data-longtitle=\"true\">\r\n","import {\r\n  Component,\r\n  ChangeDetectionStrategy,\r\n  ApplicationRef,\r\n  Output,\r\n  EventEmitter,\r\n  Inject\r\n} from '@angular/core';\r\nimport { MsalBroadcastService, MsalService, MSAL_GUARD_CONFIG} from '@azure/msal-angular';\r\nimport {\r\n  InteractionStatus,\r\n  AuthenticationResult,\r\n  PublicClientApplication,\r\n  PopupRequest,\r\n  SilentRequest,\r\n  InteractionRequiredAuthError\r\n} from '@azure/msal-browser';\r\nimport { ConfigService } from '@igo2/core';\r\nimport { AuthMicrosoftOptions, MSPMsalGuardConfiguration } from '../shared/auth.interface';\r\nimport { AuthService } from '../shared/auth.service';\r\nimport { filter, takeUntil } from 'rxjs/operators';\r\nimport { Subject } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'igo-auth-microsoft',\r\n  templateUrl: './auth-microsoft.component.html',\r\n  styleUrls: ['./auth-microsoft.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AuthMicrosoftComponent {\r\n  private options: AuthMicrosoftOptions;\r\n  private readonly _destroying$ = new Subject<void>();\r\n  @Output() login: EventEmitter<boolean> = new EventEmitter<boolean>();\r\n  private broadcastService: MsalBroadcastService;\r\n\r\n  constructor(\r\n    private authService: AuthService,\r\n    private config: ConfigService,\r\n    private appRef: ApplicationRef,\r\n    private msalService: MsalService,\r\n    @Inject(MSAL_GUARD_CONFIG) private msalGuardConfig: MSPMsalGuardConfiguration[],\r\n  ) {\r\n    this.options = this.config.getConfig('auth.microsoft') || {};\r\n\r\n    this.msalService.instance = new PublicClientApplication({\r\n      auth: this.options,\r\n      cache: {\r\n        cacheLocation: 'sessionStorage'\r\n      }\r\n    });\r\n\r\n    this.broadcastService = new MsalBroadcastService(this.msalService.instance, this.msalService);\r\n\r\n    if (this.options.clientId) {\r\n      this.broadcastService.inProgress$\r\n      .pipe(\r\n        filter((status: InteractionStatus) => status === InteractionStatus.None),\r\n        takeUntil(this._destroying$)\r\n      )\r\n      .subscribe(() => {\r\n        this.checkAccount();\r\n      });\r\n\r\n    } else {\r\n      console.warn('Microsoft authentification needs \"clientId\" option');\r\n    }\r\n  }\r\n\r\n  public loginMicrosoft() {\r\n    this.msalService.loginPopup({...this.getConf().authRequest} as PopupRequest)\r\n    .subscribe((response: AuthenticationResult) => {\r\n      this.msalService.instance.setActiveAccount(response.account);\r\n      this.checkAccount();\r\n    });\r\n  }\r\n\r\n  private checkAccount() {\r\n    this.msalService.instance\r\n      .acquireTokenSilent(this.getConf().authRequest as SilentRequest)\r\n      .then((response: AuthenticationResult) => {\r\n        const tokenAccess = response.accessToken;\r\n        const tokenId = response.idToken;\r\n        this.authService.loginWithToken(tokenAccess, 'microsoft', { tokenId } ).subscribe(() => {\r\n          this.appRef.tick();\r\n          this.login.emit(true);\r\n        });\r\n      })\r\n      .catch(async (error) => {\r\n        if (error instanceof InteractionRequiredAuthError) {\r\n          // fallback to interaction when silent call fails\r\n          return this.msalService.acquireTokenPopup(this.getConf().authRequest as SilentRequest);\r\n        }\r\n        console.log(error);\r\n      }).catch(error => {\r\n        console.log('Silent token fails');\r\n      });\r\n  }\r\n\r\n  private getConf(): MSPMsalGuardConfiguration {\r\n    return this.msalGuardConfig.filter(conf => conf.type === 'add')[0];\r\n  }\r\n}\r\n","<button class=\"microsoft-login-button\" mat-raised-button (click)=\"loginMicrosoft()\">\r\n  <mat-icon svgIcon=\"microsoft\"></mat-icon>\r\n  {{'igo.auth.microsoft.login' | translate}}\r\n</button>\r\n","/*\r\n * Copyright (c) Microsoft Corporation. All rights reserved.\r\n * Licensed under the MIT License.\r\n */\r\n\r\nimport { Inject, Injectable } from '@angular/core';\r\nimport { Location } from '@angular/common';\r\nimport {\r\n    IPublicClientApplication,\r\n    EndSessionRequest,\r\n    EndSessionPopupRequest,\r\n    AuthenticationResult,\r\n    RedirectRequest,\r\n    SilentRequest,\r\n    PopupRequest,\r\n    SsoSilentRequest,\r\n    Logger,\r\n    WrapperSKU\r\n} from '@azure/msal-browser';\r\nimport { MSAL_INSTANCE } from '@azure/msal-angular';\r\nimport { Observable, from } from 'rxjs';\r\nimport { IMsalService } from '@azure/msal-angular';\r\n\r\n@Injectable()\r\nexport class MsalServiceb2c implements IMsalService {\r\n    private redirectHash: string;\r\n    private logger: Logger;\r\n    private name = '@azure/msal-angular';\r\n    private version = '2.0.0-beta.2';\r\n    constructor(\r\n        @Inject(MSAL_INSTANCE) public instance: IPublicClientApplication,\r\n        private location: Location\r\n    ) {\r\n        const hash = this.location.path(true).split('#').pop();\r\n        if (hash) {\r\n            this.redirectHash = `#${hash}`;\r\n        }\r\n        this.instance.initializeWrapperLibrary(WrapperSKU.Angular, this.version);\r\n    }\r\n\r\n    acquireTokenPopup(request: PopupRequest): Observable<AuthenticationResult> {\r\n        return from(this.instance.acquireTokenPopup(request));\r\n    }\r\n    acquireTokenRedirect(request: RedirectRequest): Observable<void> {\r\n        return from(this.instance.acquireTokenRedirect(request));\r\n    }\r\n    acquireTokenSilent(silentRequest: SilentRequest): Observable<AuthenticationResult> {\r\n        return from(this.instance.acquireTokenSilent(silentRequest));\r\n    }\r\n    handleRedirectObservable(hash?: string): Observable<AuthenticationResult> {\r\n        return from(this.instance.handleRedirectPromise(hash || this.redirectHash));\r\n    }\r\n    loginPopup(request?: PopupRequest): Observable<AuthenticationResult> {\r\n        return from(this.instance.loginPopup(request));\r\n    }\r\n    loginRedirect(request?: RedirectRequest): Observable<void> {\r\n        return from(this.instance.loginRedirect(request));\r\n    }\r\n    logout(logoutRequest?: EndSessionRequest): Observable<void> {\r\n        return from(this.instance.logout(logoutRequest));\r\n    }\r\n    logoutRedirect(logoutRequest?: EndSessionRequest): Observable<void> {\r\n        return from(this.instance.logoutRedirect(logoutRequest));\r\n    }\r\n    logoutPopup(logoutRequest?: EndSessionPopupRequest): Observable<void> {\r\n        return from(this.instance.logoutPopup(logoutRequest));\r\n    }\r\n    ssoSilent(request: SsoSilentRequest): Observable<AuthenticationResult> {\r\n        return from(this.instance.ssoSilent(request));\r\n    }\r\n    /**\r\n     * Gets logger for msal-angular.\r\n     * If no logger set, returns logger instance created with same options as msal-browser\r\n     */\r\n    getLogger(): Logger {\r\n        if (!this.logger) {\r\n            this.logger = this.instance.getLogger().clone(this.name, this.version);\r\n        }\r\n        return this.logger;\r\n    }\r\n    // Create a logger instance for msal-angular with the same options as msal-browser\r\n    setLogger(logger: Logger): void {\r\n        this.logger = logger.clone(this.name, this.version);\r\n        this.instance.setLogger(logger);\r\n    }\r\n\r\n}\r\n","/*\r\n * Copyright (c) Microsoft Corporation. All rights reserved.\r\n * Licensed under the MIT License.\r\n */\r\n\r\nimport { Inject, Injectable } from '@angular/core';\r\nimport { BehaviorSubject, Observable, Subject } from 'rxjs';\r\nimport { MSAL_INSTANCE } from '@azure/msal-angular';\r\nimport { EventMessage, EventMessageUtils, IPublicClientApplication, InteractionStatus } from '@azure/msal-browser';\r\nimport { MsalServiceb2c } from './auth-msalServiceb2c.service.';\r\n\r\n@Injectable()\r\nexport class MsalBroadcastServiceb2c {\r\n    private _msalSubject: Subject<EventMessage>;\r\n    public msalSubject$: Observable<EventMessage>;\r\n    private _inProgress: BehaviorSubject<InteractionStatus>;\r\n    public inProgress$: Observable<InteractionStatus>;\r\n\r\n    constructor(\r\n        @Inject(MSAL_INSTANCE) private msalInstance: IPublicClientApplication,\r\n        private authService: MsalServiceb2c\r\n    ) {\r\n        this._msalSubject = new Subject<EventMessage>();\r\n        this.msalSubject$ = this._msalSubject.asObservable();\r\n\r\n        // InProgress as BehaviorSubject so most recent inProgress state will be available upon subscription\r\n        this._inProgress = new BehaviorSubject<InteractionStatus>(InteractionStatus.Startup);\r\n        this.inProgress$ = this._inProgress.asObservable();\r\n\r\n        this.msalInstance.addEventCallback((message: EventMessage) => {\r\n            this._msalSubject.next(message);\r\n            const status = EventMessageUtils.getInteractionStatusFromEvent(message);\r\n            if (status !== null) {\r\n                this.authService.getLogger().verbose(`BroadcastService - ${message.eventType} results in setting inProgress to ${status}`);\r\n                this._inProgress.next(status);\r\n            }\r\n        });\r\n    }\r\n}\r\n","import {\r\n  Component,\r\n  ChangeDetectionStrategy,\r\n  ApplicationRef,\r\n  Output,\r\n  EventEmitter,\r\n  Inject\r\n} from '@angular/core';\r\n\r\nimport { MSAL_GUARD_CONFIG } from '@azure/msal-angular';\r\nimport {\r\n  InteractionStatus,\r\n  AuthenticationResult,\r\n  PublicClientApplication,\r\n  PopupRequest,\r\n  SilentRequest,\r\n  InteractionRequiredAuthError\r\n} from '@azure/msal-browser';\r\nimport { ConfigService } from '@igo2/core';\r\nimport { AuthMicrosoftb2cOptions, MSPMsalGuardConfiguration } from '../shared/auth.interface';\r\nimport { AuthService } from '../shared/auth.service';\r\nimport { filter, takeUntil } from 'rxjs/operators';\r\nimport { Subject } from 'rxjs';\r\nimport { MsalBroadcastServiceb2c } from '../shared/auth-msalBroadcastServiceb2c.service';\r\nimport { MsalServiceb2c } from '../shared/auth-msalServiceb2c.service.';\r\n\r\n@Component({\r\n  selector: 'igo-auth-microsoftb2c',\r\n  templateUrl: './auth-microsoftb2c.component.html',\r\n  styleUrls: ['./auth-microsoftb2c.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AuthMicrosoftb2cComponent {\r\n  private options: AuthMicrosoftb2cOptions;\r\n  private readonly _destroying$ = new Subject<void>();\r\n  @Output() login: EventEmitter<boolean> = new EventEmitter<boolean>();\r\n  private broadcastService: MsalBroadcastServiceb2c;\r\n\r\n  constructor(\r\n    private authService: AuthService,\r\n    private config: ConfigService,\r\n    private appRef: ApplicationRef,\r\n    private msalService: MsalServiceb2c,\r\n    @Inject(MSAL_GUARD_CONFIG) private msalGuardConfig: MSPMsalGuardConfiguration[],\r\n  ) {\r\n\r\n    this.options = this.config.getConfig('auth.microsoftb2c') || {};\r\n\r\n    this.msalService.instance = new PublicClientApplication({\r\n      auth: this.options.browserAuthOptions,\r\n      cache: {\r\n        cacheLocation: 'sessionStorage'\r\n      }\r\n    });\r\n\r\n    this.broadcastService = new MsalBroadcastServiceb2c(this.msalService.instance, this.msalService);\r\n\r\n    if (this.options.browserAuthOptions.clientId) {\r\n      this.broadcastService.inProgress$\r\n      .pipe(\r\n        filter((status: InteractionStatus) => status === InteractionStatus.None),\r\n        takeUntil(this._destroying$)\r\n      )\r\n      .subscribe(() => {\r\n        this.checkAccount();\r\n      });\r\n\r\n    } else {\r\n      console.warn('Microsoft authentification needs \"clientId\" option');\r\n    }\r\n  }\r\n\r\n  public loginMicrosoftb2c() {\r\n    this.msalService.loginPopup({...this.getConf().authRequest} as PopupRequest)\r\n    .subscribe((response: AuthenticationResult) => {\r\n      this.msalService.instance.setActiveAccount(response.account);\r\n      this.checkAccount();\r\n    });\r\n  }\r\n\r\n  private checkAccount() {\r\n    this.msalService.instance\r\n      .acquireTokenSilent(this.getConf().authRequest as SilentRequest)\r\n      .then((response: AuthenticationResult) => {\r\n        const token = response.idToken;\r\n        this.authService.loginWithToken(token, 'microsoftb2c').subscribe(() => {\r\n          this.appRef.tick();\r\n          this.login.emit(true);\r\n        });\r\n      })\r\n      .catch(async (error) => {\r\n        if (error instanceof InteractionRequiredAuthError) {\r\n          // fallback to interaction when silent call fails\r\n          return this.msalService.acquireTokenPopup(this.getConf().authRequest as SilentRequest);\r\n        }\r\n        }).catch(error => {\r\n          console.log('Silent token fails');\r\n        });\r\n  }\r\n\r\n  private getConf(): MSPMsalGuardConfiguration {\r\n    return this.msalGuardConfig.filter(conf => conf.type === 'b2c')[0];\r\n  }\r\n}\r\n","<button class=\"microsoft-login-button\" mat-raised-button (click)=\"loginMicrosoftb2c()\">\r\n  <mat-icon svgIcon=\"microsoft\"></mat-icon>\r\n  {{'igo.auth.microsoftb2c.login' | translate}}\r\n</button>\r\n","import {\r\n  Component,\r\n  ChangeDetectionStrategy,\r\n  ApplicationRef,\r\n  Output,\r\n  EventEmitter\r\n} from '@angular/core';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { AuthFacebookOptions } from '../shared/auth.interface';\r\nimport { AuthService } from '../shared/auth.service';\r\n\r\n@Component({\r\n  selector: 'igo-auth-facebook',\r\n  templateUrl: './auth-facebook.component.html',\r\n  styleUrls: ['./auth-facebook.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class AuthFacebookComponent {\r\n  private options: AuthFacebookOptions;\r\n\r\n  @Output() login: EventEmitter<boolean> = new EventEmitter<boolean>();\r\n\r\n  constructor(\r\n    private authService: AuthService,\r\n    private config: ConfigService,\r\n    private appRef: ApplicationRef\r\n  ) {\r\n    this.options = this.config.getConfig('auth.facebook') || {};\r\n\r\n    if (this.options.appId) {\r\n      this.loadSDKFacebook();\r\n    } else {\r\n      console.warn('Facebook authentification needs \"appId\" option');\r\n    }\r\n  }\r\n\r\n  private subscribeEvents() {\r\n    (window as any).FB.Event.subscribe('auth.statusChange', rep => {\r\n      this.statusChangeCallback(rep);\r\n    });\r\n  }\r\n\r\n  private statusChangeCallback(response) {\r\n    if (response.status === 'connected') {\r\n      const accessToken = response.authResponse.accessToken;\r\n      this.loginFacebook(accessToken);\r\n    }\r\n  }\r\n\r\n  private loginFacebook(token) {\r\n    this.authService.loginWithToken(token, 'facebook').subscribe(() => {\r\n      this.appRef.tick();\r\n      this.login.emit(true);\r\n    });\r\n  }\r\n\r\n  private loadSDKFacebook() {\r\n    if (document.getElementById('facebook-jssdk')) {\r\n      return;\r\n    }\r\n\r\n    const urlSDK =\r\n      'https://connect.facebook.net/fr_CA/sdk.js#xfbml=1&version=v2.9';\r\n\r\n    const fjs = document.getElementsByTagName('script')[0];\r\n    const js = document.createElement('script');\r\n    js.id = 'facebook-jssdk';\r\n    js.src = `${urlSDK}&appId=${this.options.appId}`;\r\n    js.onload = () => {\r\n      this.subscribeEvents();\r\n    };\r\n    fjs.parentNode.insertBefore(js, fjs);\r\n  }\r\n}\r\n","<div scope=\"public_profile,email\"\r\n     class=\"fb-login-button\" data-max-rows=\"1\" data-size=\"large\"\r\n     data-button-type=\"login_with\" data-show-faces=\"false\"\r\n     data-auto-logout-link=\"false\" data-use-continue-as=\"false\">\r\n</div>\r\n","<form [formGroup]=\"form\" role=\"form\" (ngSubmit)=\"loginUser(form.value)\">\r\n  <div>\r\n    <mat-form-field class=\"full-width\">\r\n      <input matInput required placeholder=\"{{'igo.auth.user' | translate}}\" formControlName=\"username\">\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div>\r\n    <mat-form-field class=\"full-width\">\r\n      <input matInput required type=\"password\" placeholder=\"{{'igo.auth.password' | translate}}\" formControlName=\"password\">\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <button mat-raised-button type=\"submit\">{{'igo.auth.login' | translate}}</button>\r\n  <button *ngIf=\"allowAnonymous\" mat-raised-button class=\"anonymous\" type=\"button\" [disabled]=\"loading\" (click)=\"loginAnonymous()\">\r\n    {{'igo.auth.accessAnonymous' | translate }}\r\n  </button>\r\n  <div *ngIf=\"error\">\r\n    <br/>\r\n    <font size=\"3\" color=\"red\">{{error}}</font>\r\n  </div>\r\n</form>\r\n\r\n<!--\r\nThis part was removed from the below line to fix Angular issue 30616 : [disabled]=\"!form.valid || loading\r\n  <button mat-raised-button type=\"submit\" [disabled]=\"!form.valid || loading\">{{'igo.auth.login' | translate}}</button>*/\r\n-->\r\n","import {\r\n  Component,\r\n  ChangeDetectionStrategy,\r\n  Input,\r\n  Output,\r\n  EventEmitter\r\n} from '@angular/core';\r\nimport { Validators, FormGroup, FormBuilder } from '@angular/forms';\r\n\r\nimport { AuthService } from '../shared/auth.service';\r\nimport { LanguageService } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'igo-auth-intern',\r\n  templateUrl: './auth-intern.component.html',\r\n  styleUrls: ['./auth-intern.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.Default\r\n})\r\nexport class AuthInternComponent {\r\n  @Input()\r\n  get allowAnonymous(): boolean {\r\n    return this._allowAnonymous;\r\n  }\r\n  set allowAnonymous(value: boolean) {\r\n    this._allowAnonymous = value;\r\n  }\r\n  private _allowAnonymous = true;\r\n\r\n  public error = '';\r\n  public form: FormGroup;\r\n  public loading = false;\r\n\r\n  @Output() login: EventEmitter<boolean> = new EventEmitter<boolean>();\r\n\r\n  constructor(\r\n    public auth: AuthService,\r\n    private languageService: LanguageService,\r\n    fb: FormBuilder\r\n  ) {\r\n    this.form = fb.group({\r\n      username: ['', Validators.required],\r\n      password: ['', Validators.required]\r\n    });\r\n  }\r\n\r\n  loginUser(values: any) {\r\n    this.loading = true;\r\n    this.auth.login(values.username, values.password).subscribe(\r\n      () => {\r\n        this.login.emit(true);\r\n        this.loading = false;\r\n      },\r\n      (error: any) => {\r\n        try {\r\n          this.languageService.translate\r\n            .get('igo.auth.error.' + error.error.message)\r\n            .subscribe(errorMsg => (this.error = errorMsg));\r\n        } catch (e) {\r\n          this.error = error.error.message;\r\n        }\r\n        this.loading = false;\r\n      }\r\n    );\r\n    return false;\r\n  }\r\n\r\n  loginAnonymous() {\r\n    this.auth.loginAnonymous().subscribe(() => {\r\n      this.login.emit(true);\r\n    });\r\n  }\r\n}\r\n","<div *ngIf=\"visible\">\r\n  <div *ngIf=\"!auth.logged && backgroundDisable\" class=\"backgroundDisable\"></div>\r\n\r\n  <div *ngIf=\"!auth.logged && showLoginDiv\" class=\"login center-block\">\r\n    <h1>{{'igo.auth.connection' | translate}}</h1>\r\n\r\n    <igo-auth-google\r\n      *ngIf=\"options.google && options.google.enabled !== false\"\r\n      (login)=\"onLogin()\">\r\n    </igo-auth-google>\r\n    <igo-auth-microsoft\r\n      *ngIf=\"options.microsoft && options.microsoft.enabled !== false\"\r\n      (login)=\"onLogin()\">\r\n    </igo-auth-microsoft>\r\n    <igo-auth-microsoftb2c\r\n      *ngIf=\"options.microsoftb2c && options.microsoftb2c.enabled !== false\"\r\n      (login)=\"onLogin()\">\r\n    </igo-auth-microsoftb2c>\r\n    <igo-auth-facebook\r\n      *ngIf=\"options.facebook && options.facebook.enabled !== false\"\r\n      (login)=\"onLogin()\">\r\n    </igo-auth-facebook>\r\n    <igo-auth-intern\r\n      *ngIf=\"!options.intern || options.intern.enabled !== false\"\r\n      [allowAnonymous]=\"options.allowAnonymous\"\r\n      (login)=\"onLogin()\">\r\n    </igo-auth-intern>\r\n  </div>\r\n\r\n  <div *ngIf=\"auth.logged && showAlreadyConnectedDiv\" class=\"login center-block\">\r\n    <p>{{'igo.auth.welcome' |translate: user}}</p>\r\n    <button mat-raised-button type=\"button\" (click)=\"logout()\">{{'igo.auth.signOut' |translate}}</button>\r\n  </div>\r\n\r\n  <div *ngIf=\"showLogoutDiv\" class=\"login center-block\">\r\n    <p>{{'igo.auth.deconnection' |translate}}</p>\r\n    <button *ngIf=\"options.homeRoute\" mat-raised-button type=\"button\" (click)=\"home()\">{{'igo.auth.home' |translate}}</button>\r\n  </div>\r\n\r\n</div>\r\n","import {\r\n  Component,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  Input,\r\n  Optional,\r\n  Output,\r\n  EventEmitter\r\n} from '@angular/core';\r\nimport { Router, NavigationStart } from '@angular/router';\r\nimport { filter } from 'rxjs/operators';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { AuthOptions } from '../shared/auth.interface';\r\nimport { AuthService } from '../shared/auth.service';\r\n\r\n@Component({\r\n  selector: 'igo-auth-form',\r\n  templateUrl: './auth-form.component.html',\r\n  styleUrls: ['./auth-form.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.Default\r\n})\r\nexport class AuthFormComponent implements OnInit {\r\n  @Input()\r\n  get backgroundDisable(): boolean {\r\n    if (this.isLogoutRoute || this.isLogoutRoute) {\r\n      return false;\r\n    }\r\n    return this._backgroundDisable;\r\n  }\r\n  set backgroundDisable(value: boolean) {\r\n    this._backgroundDisable = value.toString() === 'true';\r\n  }\r\n  private _backgroundDisable = true;\r\n\r\n  @Input()\r\n  get hasAlreadyConnectedDiv(): boolean {\r\n    return this._hasAlreadyConnectedDiv;\r\n  }\r\n  set hasAlreadyConnectedDiv(value: boolean) {\r\n    this._hasAlreadyConnectedDiv = value.toString() === 'true';\r\n  }\r\n  private _hasAlreadyConnectedDiv = true;\r\n\r\n  @Input()\r\n  get hasLogoutDiv(): boolean {\r\n    return this._hasLogoutDiv;\r\n  }\r\n  set hasLogoutDiv(value: boolean) {\r\n    this._hasLogoutDiv = value.toString() === 'true';\r\n  }\r\n  private _hasLogoutDiv = true;\r\n\r\n  @Input()\r\n  get showAlreadyConnectedDiv(): boolean {\r\n    if (this.isLogoutRoute) {\r\n      return this.hasAlreadyConnectedDiv;\r\n    }\r\n    return this._showAlreadyConnectedDiv;\r\n  }\r\n  set showAlreadyConnectedDiv(value: boolean) {\r\n    this._showAlreadyConnectedDiv = value.toString() === 'true';\r\n  }\r\n  private _showAlreadyConnectedDiv = false;\r\n\r\n  @Input()\r\n  get showLogoutDiv(): boolean {\r\n    if (this.isLogoutRoute) {\r\n      return this.hasLogoutDiv;\r\n    }\r\n    return this._showLogoutDiv;\r\n  }\r\n  set showLogoutDiv(value: boolean) {\r\n    this._showLogoutDiv = value.toString() === 'true';\r\n  }\r\n  private _showLogoutDiv = false;\r\n\r\n  get showLoginDiv(): boolean {\r\n    if (!this.isLogoutRoute) {\r\n      return true;\r\n    }\r\n  }\r\n\r\n  @Output() login: EventEmitter<boolean> = new EventEmitter<boolean>();\r\n\r\n  public options: AuthOptions;\r\n  public user;\r\n\r\n  public visible = true;\r\n\r\n  private isLoginRoute: boolean;\r\n  private isLogoutRoute: boolean;\r\n\r\n  constructor(\r\n    public auth: AuthService,\r\n    private config: ConfigService,\r\n    @Optional() private router: Router\r\n  ) {\r\n    this.options = this.config.getConfig('auth') || {};\r\n    this.visible = Object.getOwnPropertyNames(this.options).length !== 0;\r\n  }\r\n\r\n  public ngOnInit() {\r\n    this.analyzeRoute();\r\n    this.getName();\r\n  }\r\n\r\n  public onLogin() {\r\n    this.auth.goToRedirectUrl();\r\n    this.getName();\r\n    this.login.emit(true);\r\n  }\r\n\r\n  public logout() {\r\n    this.auth.logout().subscribe(() => {\r\n      this.user = undefined;\r\n      if (this.router) {\r\n        if (this.options.logoutRoute) {\r\n          this.router.navigate([this.options.logoutRoute]);\r\n        } else if (this.options.homeRoute) {\r\n          this.router.navigate([this.options.homeRoute]);\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  public home() {\r\n    if (this.router && this.options.homeRoute) {\r\n      this.router.navigate([this.options.homeRoute]);\r\n    }\r\n  }\r\n\r\n  private getName() {\r\n    const tokenDecoded = this.auth.decodeToken();\r\n    if (tokenDecoded) {\r\n      this.user = {\r\n        name: tokenDecoded.user.firstName || tokenDecoded.user.sourceId\r\n      };\r\n    }\r\n  }\r\n\r\n  private analyzeRoute() {\r\n    if (!this.router) {\r\n      return;\r\n    }\r\n\r\n    this.router.events\r\n      .pipe(filter((event) => event instanceof NavigationStart))\r\n      .subscribe((changeEvent: any) => {\r\n        if (changeEvent.url) {\r\n          const currentRoute = changeEvent.url;\r\n          const logoutRoute = this.options.logoutRoute;\r\n          const loginRoute = this.options.loginRoute;\r\n\r\n          this.isLogoutRoute = currentRoute === logoutRoute;\r\n          this.isLoginRoute = currentRoute === loginRoute;\r\n\r\n          if (this.isLogoutRoute) {\r\n            this.auth.logout();\r\n          }\r\n        }\r\n      });\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport {\r\n  HttpEvent,\r\n  HttpInterceptor,\r\n  HttpHandler,\r\n  HttpRequest\r\n} from '@angular/common/http';\r\nimport { Observable } from 'rxjs';\r\nimport { Md5 } from 'ts-md5';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { TokenService } from './token.service';\r\nimport { AuthByKeyOptions, WithCredentialsOptions } from './auth.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class AuthInterceptor implements HttpInterceptor {\r\n  private refreshInProgress = false;\r\n\r\n  private get trustHosts() {\r\n    const trustHosts = this.config.getConfig('auth.trustHosts') || [];\r\n    trustHosts.push(window.location.hostname);\r\n    return trustHosts;\r\n  }\r\n\r\n  private get hostsWithCredentials(): WithCredentialsOptions[] {\r\n    return this.config.getConfig('auth.hostsWithCredentials') || [];\r\n  }\r\n\r\n  private get hostsWithAuthByKey(): AuthByKeyOptions[] {\r\n    return this.config.getConfig('auth.hostsByKey') || [];\r\n  }\r\n\r\n  constructor(\r\n    private config: ConfigService,\r\n    private tokenService: TokenService,\r\n    private http: HttpClient\r\n  ) {}\r\n\r\n  intercept(\r\n    originalReq: HttpRequest<any>,\r\n    next: HttpHandler\r\n  ): Observable<HttpEvent<any>> {\r\n    const withCredentials = this.handleHostsWithCredentials(originalReq.url);\r\n    let req = originalReq.clone();\r\n    const hostWithKey = this.handleHostsAuthByKey(originalReq.url);\r\n    if (hostWithKey) {\r\n      req = req.clone({\r\n        params: req.params.set(hostWithKey.key, hostWithKey.value)\r\n      });\r\n    }\r\n    if (withCredentials) {\r\n      req = originalReq.clone({\r\n        withCredentials\r\n      });\r\n    }\r\n    this.refreshToken();\r\n    const token = this.tokenService.get();\r\n    const element = document.createElement('a');\r\n    element.href = req.url;\r\n    if (element.host === '') {\r\n      element.href = element.href; // FIX IE11, DO NOT REMOVE\r\n    }\r\n\r\n    if (!token || this.trustHosts.indexOf(element.hostname) === -1) {\r\n      return next.handle(req);\r\n    }\r\n\r\n    const authHeader = `Bearer ${token}`;\r\n    let authReq = req.clone({\r\n      headers: req.headers.set('Authorization', authHeader)\r\n    });\r\n\r\n    const tokenDecoded: any = this.tokenService.decode();\r\n    if (\r\n      authReq.params.get('_i') === 'true' &&\r\n      tokenDecoded &&\r\n      tokenDecoded.user &&\r\n      tokenDecoded.user.sourceId\r\n    ) {\r\n      const hashUser = Md5.hashStr(tokenDecoded.user.sourceId) as string;\r\n      authReq = authReq.clone({\r\n        params: authReq.params.set('_i', hashUser)\r\n      });\r\n    } else if (authReq.params.get('_i') === 'true') {\r\n      authReq = authReq.clone({\r\n        params: authReq.params.delete('_i')\r\n      });\r\n    }\r\n\r\n    return next.handle(authReq);\r\n  }\r\n\r\n  interceptXhr(xhr, url: string): boolean {\r\n    const withCredentials = this.handleHostsWithCredentials(url);\r\n    if (withCredentials) {\r\n       xhr.withCredentials = withCredentials;\r\n       return true;\r\n    }\r\n\r\n    this.refreshToken();\r\n    const element = document.createElement('a');\r\n    element.href = url;\r\n\r\n    const token = this.tokenService.get();\r\n    if (!token || this.trustHosts.indexOf(element.hostname) === -1) {\r\n      return false;\r\n    }\r\n    xhr.setRequestHeader('Authorization', 'Bearer ' + token);\r\n    return true;\r\n  }\r\n\r\n  alterUrlWithKeyAuth(url: string): string {\r\n    const hostWithKey = this.handleHostsAuthByKey(url);\r\n    let interceptedUrl = url;\r\n    if (hostWithKey) {\r\n      const urlDecomposed = interceptedUrl.split(/[?&]/);\r\n      let urlWithKeyAdded = urlDecomposed.shift();\r\n      const paramsToKeep = urlDecomposed.filter(p => p.length !== 0);\r\n      paramsToKeep.push(`${hostWithKey.key}=${hostWithKey.value}`);\r\n      if (paramsToKeep.length) {\r\n        urlWithKeyAdded += '?' + paramsToKeep.join('&');\r\n      }\r\n      return urlWithKeyAdded;\r\n    }\r\n    return;\r\n  }\r\n\r\n  private handleHostsWithCredentials(reqUrl: string) {\r\n    let withCredentials = false;\r\n    for (const hostWithCredentials of this.hostsWithCredentials) {\r\n      const domainRegex = new RegExp(hostWithCredentials.domainRegFilters);\r\n      if (domainRegex.test(reqUrl)) {\r\n        withCredentials = hostWithCredentials.withCredentials !== undefined ? hostWithCredentials.withCredentials : undefined;\r\n        break;\r\n      }\r\n    }\r\n    return withCredentials;\r\n  }\r\n\r\n  private handleHostsAuthByKey(reqUrl: string): {key: string, value: string} {\r\n    let hostWithKey;\r\n    for (const hostWithAuthByKey of this.hostsWithAuthByKey) {\r\n      const domainRegex = new RegExp(hostWithAuthByKey.domainRegFilters);\r\n      if (domainRegex.test(reqUrl)) {\r\n        var replace = `${hostWithAuthByKey.keyProperty}=${hostWithAuthByKey.keyValue}`;\r\n        var keyAdded = new RegExp(replace,\"gm\");\r\n        if (!keyAdded.test(reqUrl)) {\r\n          hostWithKey = {key : hostWithAuthByKey.keyProperty, value: hostWithAuthByKey.keyValue};\r\n          break;\r\n        }\r\n      }\r\n    }\r\n    return hostWithKey;\r\n  }\r\n\r\n  refreshToken() {\r\n    const jwt = this.tokenService.decode();\r\n    const currentTime = new Date().getTime() / 1000;\r\n\r\n    if (\r\n      !this.refreshInProgress &&\r\n      jwt &&\r\n      currentTime < jwt.exp &&\r\n      currentTime > jwt.exp - 1800\r\n    ) {\r\n      this.refreshInProgress = true;\r\n\r\n      const url = this.config.getConfig('auth.url');\r\n      return this.http.post(`${url}/refresh`, {}).subscribe(\r\n        (data: any) => {\r\n          this.tokenService.set(data.token);\r\n          this.refreshInProgress = false;\r\n        },\r\n        err => {\r\n          err.error.caught = true;\r\n          return err;\r\n        }\r\n      );\r\n    }\r\n  }\r\n}\r\n","import {\r\n  MSAL_GUARD_CONFIG,\r\n  MSAL_INSTANCE,\r\n  MsalService,\r\n} from '@azure/msal-angular';\r\n\r\nimport {\r\n  PublicClientApplication,\r\n  InteractionType\r\n} from '@azure/msal-browser';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\n\r\nimport { BrowserAuthOptions } from '@azure/msal-browser';\r\n\r\nimport { AuthMicrosoftOptions, MSPMsalGuardConfiguration } from './auth.interface';\r\n\r\nimport { MsalServiceb2c } from './auth-msalServiceb2c.service.';\r\n\r\nexport function MSALConfigFactory(config: ConfigService): PublicClientApplication {\r\n\r\n  const msConf: BrowserAuthOptions = config.getConfig('auth.microsoft') || {};\r\n\r\n  msConf.redirectUri = msConf.redirectUri || window.location.href;\r\n  msConf.authority = msConf.authority || 'https://login.microsoftonline.com/organizations';\r\n\r\n  const myMsalObj = new PublicClientApplication({\r\n    auth: msConf,\r\n    cache: {\r\n      cacheLocation: 'sessionStorage'\r\n    }\r\n  });\r\n\r\n  return myMsalObj;\r\n}\r\n\r\nexport function MSALConfigFactoryb2c(config: ConfigService): PublicClientApplication {\r\n\r\n  const msConf: BrowserAuthOptions = config.getConfig('auth.microsoftb2c.browserAuthOptions') || {};\r\n  msConf.redirectUri = msConf.redirectUri || window.location.href;\r\n  msConf.authority = msConf.authority || 'https://login.microsoftonline.com/organizations';\r\n\r\n  const myMsalObj = new PublicClientApplication({\r\n    auth: msConf,\r\n    cache: {\r\n      cacheLocation: 'sessionStorage'\r\n    }\r\n  });\r\n\r\n  return myMsalObj;\r\n}\r\n\r\nexport function MSALAngularConfigFactory(config: ConfigService): MSPMsalGuardConfiguration {\r\n\r\n  const msConf: AuthMicrosoftOptions = config.getConfig('auth.microsoft') || {};\r\n\r\n  return {\r\n    interactionType: InteractionType.Popup,\r\n    authRequest: {\r\n      scopes: ['user.read'],\r\n      loginHint: 'todo',\r\n    },\r\n    type: 'add'\r\n  };\r\n}\r\n\r\nexport function MSALAngularConfigFactoryb2c(config: ConfigService): MSPMsalGuardConfiguration {\r\n\r\n  const msConf: BrowserAuthOptions = config.getConfig('auth.microsoftb2c.browserAuthOptions') || {};\r\n\r\n  return {\r\n    interactionType: InteractionType.Popup,\r\n    authRequest: {\r\n      scopes: [msConf.clientId]\r\n    },\r\n    type: 'b2c'\r\n  };\r\n}\r\n\r\nexport function provideAuthMicrosoft(type?: string) {\r\n  if (type === 'b2c') {\r\n    return [\r\n      {\r\n        provide: MSAL_INSTANCE,\r\n        useFactory: MSALConfigFactoryb2c,\r\n        deps: [ConfigService]\r\n      },\r\n      {\r\n        provide: MSAL_GUARD_CONFIG,\r\n        useFactory: MSALAngularConfigFactoryb2c,\r\n        deps: [ConfigService],\r\n        multi: true\r\n      },\r\n      MsalServiceb2c\r\n    ];\r\n  } else {\r\n    return [\r\n      {\r\n        provide: MSAL_INSTANCE,\r\n        useFactory: MSALConfigFactory,\r\n        deps: [ConfigService]\r\n      },\r\n      {\r\n        provide: MSAL_GUARD_CONFIG,\r\n        useFactory: MSALAngularConfigFactory,\r\n        deps: [ConfigService],\r\n        multi: true\r\n      },\r\n      MsalService\r\n    ];\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\n\r\nimport { StorageService, StorageScope, ConfigService } from '@igo2/core';\r\nimport { AuthService } from './auth.service';\r\nimport { TokenService } from './token.service';\r\nimport { AuthStorageOptions } from './storage.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class AuthStorageService extends StorageService {\r\n  protected options: AuthStorageOptions;\r\n\r\n  constructor(\r\n    config: ConfigService,\r\n    private http: HttpClient,\r\n    private authService: AuthService,\r\n    private tokenService: TokenService\r\n  ) {\r\n    super(config);\r\n\r\n    this.authService.authenticate$.subscribe(isAuthenticated => {\r\n      if (isAuthenticated && this.options.url) {\r\n        this.http\r\n          .get(this.options.url)\r\n          .subscribe((userIgo: { preference: object }) => {\r\n            if (userIgo && userIgo.preference) {\r\n              for (const key of Object.keys(userIgo.preference)) {\r\n                const value = userIgo.preference[key];\r\n                super.set(key, value);\r\n              }\r\n            }\r\n          });\r\n      }\r\n    });\r\n  }\r\n\r\n  set(\r\n    key: string,\r\n    value: string | object | boolean | number,\r\n    scope: StorageScope = StorageScope.LOCAL\r\n  ) {\r\n    if (\r\n      scope === StorageScope.LOCAL &&\r\n      this.authService.authenticated &&\r\n      this.options.url\r\n    ) {\r\n      const preference = {};\r\n      preference[key] = value;\r\n      this.http.patch(this.options.url, { preference }).subscribe();\r\n    }\r\n    super.set(key, value, scope);\r\n  }\r\n\r\n  remove(key: string, scope: StorageScope = StorageScope.LOCAL) {\r\n    if (\r\n      scope === StorageScope.LOCAL &&\r\n      this.authService.authenticated &&\r\n      this.options.url\r\n    ) {\r\n      const preference = {};\r\n      preference[key] = undefined;\r\n      this.http.patch(this.options.url, { preference }).subscribe();\r\n    }\r\n    super.remove(key, scope);\r\n  }\r\n\r\n  clear(scope: StorageScope = StorageScope.LOCAL) {\r\n    if (\r\n      scope === StorageScope.LOCAL &&\r\n      this.authService.authenticated &&\r\n      this.options.url\r\n    ) {\r\n      this.http.patch(this.options.url, { preference: {}}, {\r\n        params: {\r\n          mergePreference: 'false'\r\n        }\r\n      }).subscribe();\r\n    }\r\n\r\n    let token: string;\r\n    if (scope === StorageScope.LOCAL) {\r\n      token = this.tokenService.get();\r\n    }\r\n\r\n    super.clear(scope);\r\n\r\n    if (token) {\r\n      this.tokenService.set(token);\r\n    }\r\n\r\n    if (\r\n      scope === StorageScope.LOCAL &&\r\n      this.authService.authenticated &&\r\n      this.options.url\r\n    ) {\r\n      this.http\r\n        .get(this.options.url)\r\n        .subscribe((userIgo: { preference: object }) => {\r\n          if (userIgo && userIgo.preference) {\r\n            for (const key of Object.keys(userIgo.preference)) {\r\n              const value = userIgo.preference[key];\r\n              super.set(key, value);\r\n            }\r\n          }\r\n        });\r\n    }\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { HTTP_INTERCEPTORS } from '@angular/common/http';\r\nimport { ReactiveFormsModule } from '@angular/forms';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MsalModule } from '@azure/msal-angular';\r\n\r\nimport { StorageService, IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { AuthStorageService } from './shared/storage.service';\r\nimport { ProtectedDirective } from './shared/protected.directive';\r\nimport { AuthInterceptor } from './shared/auth.interceptor';\r\nimport { provideAuthMicrosoft } from './shared/auth-microsoft.provider';\r\n\r\nimport { AuthInternComponent } from './auth-form/auth-intern.component';\r\nimport { AuthFormComponent } from './auth-form/auth-form.component';\r\nimport { AuthGoogleComponent } from './auth-form/auth-google.component';\r\nimport { AuthFacebookComponent } from './auth-form/auth-facebook.component';\r\nimport { AuthMicrosoftComponent } from './auth-form/auth-microsoft.component';\r\nimport { AuthMicrosoftb2cComponent } from './auth-form/auth-microsoftb2c.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    ReactiveFormsModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    IgoLanguageModule,\r\n    MsalModule\r\n  ],\r\n  declarations: [\r\n    AuthFormComponent,\r\n    AuthGoogleComponent,\r\n    AuthInternComponent,\r\n    AuthFacebookComponent,\r\n    AuthMicrosoftComponent,\r\n    AuthMicrosoftb2cComponent,\r\n    ProtectedDirective\r\n  ],\r\n  exports: [AuthFormComponent, ProtectedDirective]\r\n})\r\nexport class IgoAuthModule {\r\n  static forRoot(): ModuleWithProviders<IgoAuthModule> {\r\n    return {\r\n      ngModule: IgoAuthModule,\r\n      providers: [\r\n        {\r\n          provide: HTTP_INTERCEPTORS,\r\n          useClass: AuthInterceptor,\r\n          multi: true\r\n        },\r\n        {\r\n          provide: StorageService,\r\n          useClass: AuthStorageService\r\n        },\r\n        ...provideAuthMicrosoft('add'),\r\n        ...provideAuthMicrosoft('b2c')\r\n      ]\r\n    };\r\n  }\r\n}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\nimport { AppAuthFormComponent } from './auth-form.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'auth-form',\r\n    component: AppAuthFormComponent\r\n  }\r\n];\r\n\r\nexport const AppAuthFormRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'app-auth-form',\r\n  templateUrl: './auth-form.component.html',\r\n  styleUrls: ['./auth-form.component.scss']\r\n})\r\nexport class AppAuthFormComponent {\r\n  private idsActivity: string[] = [];\r\n\r\n  constructor(private languageService: LanguageService) {}\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Auth</mat-card-subtitle>\r\n  <mat-card-title>Authentification</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: ConfigService, LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/auth/auth-form\">code of this example</a><br>\r\n    See auth section of the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/environments\"> environment config</a>\r\n  </mat-card-content>\r\n</mat-card>\r\n\r\n<igo-auth-form></igo-auth-form>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoAuthModule } from '@igo2/auth';\r\n\r\nimport { AppAuthFormComponent } from './auth-form.component';\r\nimport { AppAuthFormRoutingModule } from './auth-form-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppAuthFormComponent],\r\n  imports: [AppAuthFormRoutingModule, MatCardModule, IgoAuthModule.forRoot()],\r\n  exports: [AppAuthFormComponent]\r\n})\r\nexport class AppAuthFormModule {}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { MetadataOptions } from './metadata.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class MetadataService {\r\n  constructor() {}\r\n\r\n  open(metadata: MetadataOptions) {\r\n    if (metadata.extern) {\r\n      window.open(metadata.url, '_blank');\r\n    }\r\n  }\r\n}\r\n","<button\r\n  *ngIf=\"(options && options.metadata && options.metadata.url) || (options && options.metadata && options.metadata.abstract)\"\r\n  mat-icon-button\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.metadata.show' | translate\"\r\n  [color]=\"color\"\r\n  (click)=\"openMetadata(options.metadata)\">\r\n  <mat-icon svgIcon=\"information-outline\"></mat-icon>\r\n</button>\r\n","<h2 mat-dialog-title>{{ data.layerTitle }}</h2>\r\n<button class=\"close-button\" mat-button mat-dialog-close>X</button>\r\n<mat-dialog-content *ngIf=\"data.type !== 'arcgisrest'\" class=\"mat-typography\">\r\n  <h3>{{ data.abstract }}</h3>\r\n</mat-dialog-content>\r\n<mat-dialog-content *ngIf=\"data.type === 'arcgisrest'\" class=\"mat-typography\">\r\n  <h3 [innerHTML]=\"data.abstract\"></h3>\r\n</mat-dialog-content>\r\n","import { Component, Input, ChangeDetectionStrategy, Inject, ViewEncapsulation } from '@angular/core';\r\nimport { MatDialog, MAT_DIALOG_DATA } from '@angular/material/dialog';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\n\r\nimport {\r\n  MetadataOptions,\r\n  MetadataLayerOptions\r\n} from '../shared/metadata.interface';\r\nimport { MetadataService } from '../shared/metadata.service';\r\n\r\n@Component({\r\n  selector: 'igo-metadata-button',\r\n  templateUrl: './metadata-button.component.html',\r\n  styleUrls: ['./metadata-button.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class MetadataButtonComponent {\r\n  @Input()\r\n  get layer(): Layer {\r\n    return this._layer;\r\n  }\r\n  set layer(value: Layer) {\r\n    this._layer = value;\r\n  }\r\n  private _layer: Layer;\r\n\r\n  @Input()\r\n  get color() {\r\n    return this._color;\r\n  }\r\n  set color(value: string) {\r\n    this._color = value;\r\n  }\r\n  private _color = 'primary';\r\n\r\n  constructor(\r\n    private metadataService: MetadataService,\r\n    private dialog: MatDialog) {}\r\n\r\n  openMetadata(metadata: MetadataOptions) {\r\n    if (metadata.extern) {\r\n      this.metadataService.open(metadata);\r\n    } else if (!metadata.extern && metadata.abstract) {\r\n      this.dialog.open(MetadataAbstractComponent, {\r\n        data: {\r\n          layerTitle: this.layer.title,\r\n          abstract: metadata.abstract,\r\n          type: metadata.type\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  get options(): MetadataLayerOptions {\r\n    if (!this.layer) {\r\n      return;\r\n    }\r\n    return this.layer.options;\r\n  }\r\n}\r\n\r\n@Component({\r\n  selector: 'igo-metadata-abstract',\r\n  templateUrl: './metadata-abstract.component.html',\r\n  styleUrls: ['./metadata-abstract.component.scss'],\r\n  encapsulation: ViewEncapsulation.None\r\n})\r\nexport class MetadataAbstractComponent {\r\n  constructor(@Inject(MAT_DIALOG_DATA) public data: MetadataOptions) {}\r\n}\r\n","import { MatDialogModule } from '@angular/material/dialog';\r\nimport { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { MetadataButtonComponent, MetadataAbstractComponent } from './metadata-button/metadata-button.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatTooltipModule,\r\n    IgoLanguageModule,\r\n    MatDialogModule\r\n  ],\r\n  exports: [\r\n    MetadataButtonComponent,\r\n    MetadataAbstractComponent],\r\n  declarations: [\r\n    MetadataButtonComponent,\r\n    MetadataAbstractComponent]\r\n})\r\nexport class IgoMetadataModule {\r\n  static forRoot(): ModuleWithProviders<IgoMetadataModule> {\r\n    return {\r\n      ngModule: IgoMetadataModule,\r\n      providers: []\r\n    };\r\n  }\r\n}\r\n","export const FEATURE = 'Feature';\r\n\r\nexport enum FeatureMotion {\r\n  None,\r\n  Move,\r\n  Zoom,\r\n  Default\r\n}\r\n","import olSourceImage from 'ol/source/Image';\r\nimport { uuid, Watcher, SubjectStatus } from '@igo2/utils';\r\nimport { LanguageService, MessageService } from '@igo2/core';\r\nimport { ImageLayer } from '../shared/layers/image-layer';\r\n\r\n\r\nexport class ImageWatcher extends Watcher {\r\n  protected id: string;\r\n  protected loaded = 0;\r\n  protected loading = 0;\r\n\r\n  private source: olSourceImage;\r\n\r\n  private messageService: MessageService;\r\n  private languageService: LanguageService;\r\n\r\n  constructor(layer: ImageLayer, messageService: MessageService, languageService: LanguageService) {\r\n    super();\r\n    this.source = layer.options.source.ol;\r\n    this.id = uuid();\r\n    this.messageService = messageService;\r\n    this.languageService = languageService;\r\n  }\r\n\r\n  protected watch() {\r\n    this.source.on(`imageloadstart`, e => this.handleLoadStart(e));\r\n    this.source.on(`imageloadend`, e => this.handleLoadEnd(e));\r\n    this.source.on(`imageloaderror`, e => this.handleLoadEnd(e));\r\n    this.source.on(`imageloaderror`, e => this.handleLoadError(e));\r\n  }\r\n\r\n  protected unwatch() {\r\n    this.source.un(`imageloadstart`, e => this.handleLoadStart(e));\r\n    this.source.un(`imageloadend`, e => this.handleLoadEnd(e));\r\n    this.source.un(`imageloaderror`, e => this.handleLoadEnd(e));\r\n    this.source.un(`imageloaderror`, e => this.handleLoadError(e));\r\n  }\r\n\r\n  private handleLoadStart(event: any) {\r\n    if (!event.image.__watchers__) {\r\n      event.image.__watchers__ = [];\r\n    }\r\n    event.image.__watchers__.push(this.id);\r\n\r\n    this.loading += 1;\r\n    this.status = SubjectStatus.Working;\r\n  }\r\n\r\n  private handleLoadEnd(event) {\r\n    if (!event.image.__watchers__) {\r\n      return;\r\n    }\r\n\r\n    const watcherIndex = event.image.__watchers__.indexOf(this.id);\r\n    if (watcherIndex < 0) {\r\n      return;\r\n    }\r\n\r\n    event.image.__watchers__.splice(watcherIndex, 1);\r\n\r\n    this.loaded += 1;\r\n\r\n    const loading = this.loading;\r\n    if (this.loaded >= loading) {\r\n      if (loading === this.loading) {\r\n        this.status = SubjectStatus.Done;\r\n        this.loaded = this.loading = 0;\r\n      }\r\n    }\r\n  }\r\n\r\n  private handleLoadError(event) {\r\n\r\n    if (!event.image.__watchers__) {\r\n      return;\r\n    }\r\n    const title = this.languageService.translate.instant(\r\n      'igo.geo.dataSource.unavailableTitle'\r\n    );\r\n    const message = this.languageService.translate.instant(\r\n      'igo.geo.dataSource.unavailable', {value: event.target.params_.LAYERS}\r\n    );\r\n\r\n    this.messageService.error(message, title);\r\n    this.loaded = -1;\r\n    this.loading = 0;\r\n    this.status = SubjectStatus.Error;\r\n\r\n  }\r\n}\r\n","import { AnyLayerOptions } from \"../shared/layers/any-layer.interface\";\r\nimport { VectorTileLayerOptions } from \"../shared/layers/vectortile-layer.interface\";\r\n\r\n\r\nexport function computeMVTOptionsOnHover(layerOptions: AnyLayerOptions) {\r\n  const vectorTileLayerOptions = layerOptions as VectorTileLayerOptions;\r\n  if (\r\n    vectorTileLayerOptions.sourceOptions?.type === 'mvt' &&\r\n    (vectorTileLayerOptions.styleByAttribute?.hoverStyle || vectorTileLayerOptions.hoverStyle)) {\r\n    const fc = vectorTileLayerOptions.sourceOptions.featureClass;\r\n    vectorTileLayerOptions.sourceOptions.featureClass = fc ? fc : 'feature';\r\n  }\r\n  return layerOptions;\r\n}\r\n","import olLayer from 'ol/layer/Layer';\r\nimport olSource from 'ol/source/Source';\r\nimport { Message } from '@igo2/core';\r\n\r\nimport { DataSource } from '../../../datasource/shared/datasources/datasource';\r\nimport { AnyDataSourceOptions } from '../../../datasource/shared/datasources/any-datasource.interface';\r\nimport { MapExtent, MapViewOptions } from '../../../map/shared/map.interface';\r\n\r\nexport interface LayerOptions {\r\n  isIgoInternalLayer?: boolean; // useful when mapOffline directive set the resolution of the layers.\r\n  source?: DataSource;\r\n  sourceOptions?: AnyDataSourceOptions;\r\n  title?: string;\r\n  id?: string;\r\n  alias?: string;\r\n  baseLayer?: boolean;\r\n  opacity?: number;\r\n  visible?: boolean;\r\n  extent?: MapExtent;\r\n  zIndex?: number;\r\n  messages?: Message[];\r\n  minResolution?: number;\r\n  maxResolution?: number;\r\n  minScaleDenom?: number;\r\n  maxScaleDenom?: number;\r\n  showInLayerList?: boolean;\r\n  removable?: boolean;\r\n  workspace?: GeoWorkspaceOptions;\r\n  legendOptions?: LegendOptions;\r\n  ol?: olLayer<olSource>;\r\n  tooltip?: TooltipContent;\r\n  _internal?: { [key: string]: string };\r\n  active?: boolean;\r\n  check?: boolean;\r\n  linkedLayers?: LayersLink;\r\n}\r\n\r\nexport interface GeoWorkspaceOptions {\r\n  srcId?: string;\r\n  workspaceId?: string;\r\n  minResolution?: number;\r\n  maxResolution?: number;\r\n  enabled?: boolean;\r\n  queryOptions?: GeoWorkspaceQueryOptions;\r\n  pageSize?: number;\r\n  pageSizeOptions?: number[];\r\n}\r\n\r\nexport interface GeoWorkspaceQueryOptions {\r\n  mapQueryOnOpenTab?: boolean;\r\n  tabQuery?: boolean;\r\n}\r\n\r\nexport interface LayersLink {\r\n  linkId: string;\r\n  links?: LayersLinkProperties[];\r\n}\r\nexport interface LayersLinkProperties {\r\n  bidirectionnal?: boolean;\r\n  linkedIds: string[];\r\n  syncedDelete: boolean;\r\n  properties: LinkedProperties[];\r\n}\r\n\r\nexport enum LinkedProperties {\r\n  OPACITY = 'opacity',\r\n  VISIBLE = 'visible',\r\n  OGCFILTERS = 'ogcFilters',\r\n  MINRESOLUTION = 'minResolution',\r\n  MAXRESOLUTION = 'maxResolution',\r\n  ZINDEX = 'zIndex',\r\n  TIMEFILTER = 'timeFilter'\r\n}\r\n\r\nexport interface GroupLayers {\r\n  title: string;\r\n  layers?: LayerOptions;\r\n  collapsed?: boolean;\r\n}\r\n\r\nexport interface TooltipContent {\r\n  type?: TooltipType;\r\n  text?: string;\r\n}\r\nexport enum TooltipType {\r\n  TITLE = 'title',\r\n  ABSTRACT = 'abstract',\r\n  CUSTOM = 'custom'\r\n}\r\n\r\nexport interface LegendOptions {\r\n  collapsed?: boolean;\r\n  display?: boolean;\r\n  url?: string;\r\n  html?: string;\r\n  stylesAvailable?: ItemStyleOptions[];\r\n}\r\n\r\nexport interface LegendMapViewOptions extends MapViewOptions{\r\n  scale?: number;\r\n  size?: [number, number];\r\n}\r\n\r\nexport interface ItemStyleOptions {\r\n  name: string;\r\n  title?: string;\r\n}\r\n\r\nexport interface OutputLayerLegend {\r\n  title: string;\r\n  url: string;\r\n  display: boolean;\r\n}\r\n","import { ArcGISRestDataSourceOptions } from './../datasource/shared/datasources/arcgisrest-datasource.interface';\r\nimport { Md5 } from 'ts-md5';\r\n\r\nimport { uuid } from '@igo2/utils';\r\n\r\nimport { AnyDataSourceOptions } from '../datasource/shared/datasources/any-datasource.interface';\r\nimport { DataSourceOptions } from '../datasource/shared/datasources/datasource.interface';\r\nimport { WMSDataSourceOptions } from '../datasource/shared/datasources/wms-datasource.interface';\r\nimport { WMTSDataSourceOptions } from '../datasource/shared/datasources/wmts-datasource.interface';\r\nimport { WFSDataSourceOptions } from '../datasource';\r\n\r\n/**\r\n * Generate a id from it's datasource options.\r\n * @param options Data source options\r\n * @returns A id\r\n */\r\nexport function generateIdFromSourceOptions(options: DataSourceOptions): string {\r\n  const generators = {\r\n    wms: generateWMSIdFromSourceOptions,\r\n    wmts: generateWMTSIdFromSourceOptions,\r\n    xyz: generateXYZIdFromSourceOptions,\r\n    feature: generateFeatureIdFromSourceOptions,\r\n    wfs: generateWfsIdFromSourceOptions,\r\n    arcgisrest: generateArcgisRestIdFromSourceOptions,\r\n    imagearcgisrest: generateArcgisRestIdFromSourceOptions,\r\n    tilearcgisrest: generateArcgisRestIdFromSourceOptions,\r\n    osm: (_options: AnyDataSourceOptions) => 'OSM',\r\n    tiledebug: (_options: AnyDataSourceOptions) => 'tiledebug'\r\n  };\r\n  const generator = generators[options.type] || generateId;\r\n  return generator(options);\r\n}\r\n\r\n/**\r\n * Generate a id from WMS data source options\r\n * @param options WMS data source options\r\n * @returns A md5 hash of the the url and layers\r\n */\r\nexport function generateWMSIdFromSourceOptions(options: WMSDataSourceOptions) {\r\n  const layers = options.params.LAYERS;\r\n  const url = standardizeUrl(options.url);\r\n  const chain = 'wms' + url + layers;\r\n  return Md5.hashStr(chain) as string;\r\n}\r\n\r\n/**\r\n * Generate a id from WMTS data source options\r\n * @param options WMTS data source options\r\n * @returns A md5 hash of the the url and layer\r\n */\r\nexport function generateWMTSIdFromSourceOptions(options: WMTSDataSourceOptions) {\r\n  const layer = options.layer;\r\n  const url = standardizeUrl(options.url);\r\n  const chain = 'wmts' + url + layer;\r\n  return Md5.hashStr(chain) as string;\r\n}\r\n\r\n/**\r\n * Generate a id from XYZ data source options\r\n * @param options XYZ data source options\r\n * @returns A md5 hash of the the url and layer\r\n */\r\nexport function generateXYZIdFromSourceOptions(options: WMTSDataSourceOptions) {\r\n  const url = standardizeUrl(options.url);\r\n  const chain = 'xyz' + url;\r\n  return Md5.hashStr(chain) as string;\r\n}\r\n\r\n/**\r\n * Generate a id from feature data source options\r\n * @param options XYZ data source options\r\n * @returns A md5 hash of the the url and layer\r\n */\r\nexport function generateFeatureIdFromSourceOptions(options: WMTSDataSourceOptions) {\r\n  if (!options.url) { return generateId(options); }\r\n  const url = standardizeUrl(options.url);\r\n  const chain = 'feature' + url;\r\n  return Md5.hashStr(chain) as string;\r\n}\r\n\r\n/**\r\n * Generate a id from feature data source options\r\n * @param options XYZ data source options\r\n * @returns A md5 hash of the the url and layer\r\n */\r\nexport function generateWfsIdFromSourceOptions(options: WFSDataSourceOptions) {\r\n  if (!options.url || !options.params) { return generateId(options); }\r\n  const url = standardizeUrl(options.url);\r\n  const chain = 'wfs' + url + options.params.featureTypes;\r\n  return Md5.hashStr(chain) as string;\r\n}\r\n/**\r\n * Generate a id from ArcGIS Rest data source options\r\n * @param options ArcGIS Rest data source options\r\n * @returns A md5 hash of the url and layers\r\n */\r\nexport function generateArcgisRestIdFromSourceOptions(options: ArcGISRestDataSourceOptions) {\r\n  const layers = options.layer;\r\n  const url = standardizeUrl(options.url);\r\n  const chain = (options.type || 'arcgis') + url + layers;\r\n  return Md5.hashStr(chain) as string;\r\n}\r\n\r\n/**\r\n * Generate a unique id\r\n * @returns A uuid\r\n */\r\nexport function generateId(_options: AnyDataSourceOptions) {\r\n  return uuid();\r\n}\r\n\r\nexport function standardizeUrl(url: string): string {\r\n  const absUrl = url.charAt(0) === '/' ? window.location.origin + url : url;\r\n  const urlDecomposed = absUrl.split(/[?&]/);\r\n  let urlStandardized = urlDecomposed.shift();\r\n  const paramsToKeep = urlDecomposed.filter(p => p.length !== 0 && p.charAt(0) !== '_');\r\n  if (paramsToKeep.length) {\r\n    urlStandardized += '?' + paramsToKeep.join('&');\r\n  }\r\n  return urlStandardized;\r\n}\r\n","import olSource from 'ol/source/Source';\r\nimport olVectorSource from 'ol/source/Vector';\r\nimport olClusterSource from 'ol/source/Cluster';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport {\r\n  DataSourceOptions,\r\n  Legend\r\n} from './datasource.interface';\r\n\r\nimport { DataService } from './data.service';\r\nimport { generateIdFromSourceOptions } from '../../../utils/id-generator';\r\nimport { LegendMapViewOptions, LegendOptions } from '../../../layer/shared/layers/layer.interface';\r\n\r\nexport abstract class DataSource {\r\n\r\n  public id: string;\r\n  public ol: olSource | olVectorSource<OlGeometry> | olClusterSource ;\r\n  private legend: Legend[];\r\n\r\n  constructor(\r\n    public options: DataSourceOptions = {},\r\n    protected dataService?: DataService\r\n  ) {\r\n    this.options = options;\r\n    this.id = this.options.id ||this.generateId();\r\n    this.ol = this.createOlSource();\r\n  }\r\n\r\n  protected abstract createOlSource(): olSource;\r\n\r\n  protected generateId(): string {\r\n    return generateIdFromSourceOptions(this.options);\r\n  }\r\n\r\n  public getLegend(style?: string, view?: LegendMapViewOptions): Legend[] {\r\n    return this.legend ? this.legend : [];\r\n  }\r\n\r\n  public setLegend(options: LegendOptions): Legend[] {\r\n    if (options.url) {\r\n      this.legend = [{ url: options.url} ];\r\n    } else if (options.html) {\r\n      this.legend = [{ html: options.html} ];\r\n    } else {\r\n      this.legend = [];\r\n    }\r\n\r\n    return this.legend;\r\n  }\r\n\r\n  protected abstract onUnwatch();\r\n}\r\n","export enum OgcFilterOperatorType {\r\n    BasicNumericOperator = 'basicnumericoperator',\r\n    Basic = 'basic',\r\n    BasicAndSpatial = 'basicandspatial',\r\n    Spatial = 'spatial',\r\n    All = 'all',\r\n    Time = 'time'\r\n}\r\n\r\nexport enum OgcFilterOperator {\r\n    BBOX = 'BBox',\r\n    PropertyIsBetween = 'PropertyIsBetween',\r\n    Contains = 'Contains',\r\n    During = 'During',\r\n    PropertyIsEqualTo = 'PropertyIsEqualTo',\r\n    PropertyIsGreaterThan = 'PropertyIsGreaterThan',\r\n    PropertyIsGreaterThanOrEqualTo = 'PropertyIsGreaterThanOrEqualTo',\r\n    Intersects = 'Intersects',\r\n    PropertyIsNull = 'PropertyIsNull',\r\n    PropertyIsLessThan = 'PropertyIsLessThan',\r\n    PropertyIsLessThanOrEqualTo = 'PropertyIsLessThanOrEqualTo',\r\n    PropertyIsLike = 'PropertyIsLike',\r\n    PropertyIsNotEqualTo = 'PropertyIsNotEqualTo',\r\n    Within = 'Within',\r\n    And = 'And',\r\n    Or = 'Or',\r\n    Not = 'Not'\r\n}\r\n","import * as olfilter from 'ol/format/filter';\r\nimport olFormatWKT from 'ol/format/WKT';\r\nimport olFormatWFS, { WriteGetFeatureOptions } from 'ol/format/WFS';\r\nimport olGeometry from 'ol/geom/Geometry';\r\n\r\nimport olProjection from 'ol/proj/Projection';\r\n\r\nimport { uuid, ObjectUtils } from '@igo2/utils';\r\n\r\nimport {\r\n  OgcFilter,\r\n  IgoOgcFilterObject,\r\n  AnyBaseOgcFilterOptions,\r\n  OgcInterfaceFilterOptions,\r\n  OgcFilterableDataSourceOptions,\r\n  OgcFiltersOptions,\r\n  IgoOgcSelector,\r\n  SelectorGroup,\r\n  OgcSelectorBundle\r\n} from './ogc-filter.interface';\r\nimport { OgcFilterOperatorType, OgcFilterOperator } from './ogc-filter.enum';\r\nimport { SourceFieldsOptionsParams } from '../../datasource/shared/datasources/datasource.interface';\r\nimport * as moment_ from 'moment';\r\nconst moment = moment_;\r\n\r\nexport class OgcFilterWriter {\r\n  private filterSequence: OgcInterfaceFilterOptions[] = [];\r\n  public operators = {\r\n    [OgcFilterOperator.PropertyIsEqualTo as string]: {\r\n      spatial: false,\r\n      fieldRestrict: []\r\n    },\r\n    [OgcFilterOperator.PropertyIsNotEqualTo as string]: {\r\n      spatial: false,\r\n      fieldRestrict: []\r\n    },\r\n    [OgcFilterOperator.PropertyIsLike as string]: {\r\n      spatial: false,\r\n      fieldRestrict: ['string']\r\n    },\r\n    [OgcFilterOperator.PropertyIsGreaterThan as string]: {\r\n      spatial: false,\r\n      fieldRestrict: ['number']\r\n    },\r\n    [OgcFilterOperator.PropertyIsGreaterThanOrEqualTo as string]: {\r\n      spatial: false,\r\n      fieldRestrict: ['number']\r\n    },\r\n    [OgcFilterOperator.PropertyIsLessThan as string]: {\r\n      spatial: false,\r\n      fieldRestrict: ['number']\r\n    },\r\n    [OgcFilterOperator.PropertyIsLessThanOrEqualTo as string]: {\r\n      spatial: false,\r\n      fieldRestrict: ['number']\r\n    },\r\n    [OgcFilterOperator.PropertyIsBetween as string]: {\r\n      spatial: false,\r\n      fieldRestrict: ['number']\r\n    },\r\n    [OgcFilterOperator.During as string]: { spatial: false, fieldRestrict: [] },\r\n    [OgcFilterOperator.PropertyIsNull as string]: {\r\n      spatial: false,\r\n      fieldRestrict: []\r\n    },\r\n    [OgcFilterOperator.Intersects as string]: {\r\n      spatial: true,\r\n      fieldRestrict: []\r\n    },\r\n    [OgcFilterOperator.Within as string]: { spatial: true, fieldRestrict: [] },\r\n    [OgcFilterOperator.Contains as string]: { spatial: true, fieldRestrict: [] }\r\n  };\r\n\r\n  defineOgcFiltersDefaultOptions(\r\n    ogcFiltersOptions: OgcFiltersOptions,\r\n    fieldNameGeometry: string,\r\n    srcType?: string\r\n  ): OgcFiltersOptions {\r\n    let ogcFiltersDefaultValue = true; // default values for wfs.\r\n    if (srcType && srcType === 'wms') {\r\n      ogcFiltersDefaultValue = false;\r\n    }\r\n\r\n    ogcFiltersOptions = ogcFiltersOptions || {};\r\n    ogcFiltersOptions.enabled =\r\n      ogcFiltersOptions.enabled === undefined\r\n        ? ogcFiltersDefaultValue\r\n        : ogcFiltersOptions.enabled;\r\n    ogcFiltersOptions.editable =\r\n      ogcFiltersOptions.editable === undefined\r\n        ? ogcFiltersDefaultValue\r\n        : ogcFiltersOptions.editable;\r\n    ogcFiltersOptions.geometryName = fieldNameGeometry;\r\n\r\n    ogcFiltersOptions.advancedOgcFilters = true;\r\n    if (ogcFiltersOptions.enabled && (ogcFiltersOptions.pushButtons || ogcFiltersOptions.checkboxes\r\n      || ogcFiltersOptions.radioButtons || ogcFiltersOptions.select || ogcFiltersOptions.autocomplete)) {\r\n      ogcFiltersOptions.advancedOgcFilters = false;\r\n    }\r\n    return ogcFiltersOptions;\r\n  }\r\n\r\n  public buildFilter(\r\n    filters?: IgoOgcFilterObject,\r\n    extent?: [number, number, number, number],\r\n    proj?: olProjection,\r\n    fieldNameGeometry?: string,\r\n    options?: OgcFilterableDataSourceOptions\r\n  ): string {\r\n    let ourBboxFilter;\r\n    let enableBbox: boolean;\r\n    if (/intersects|contains|within/gi.test(JSON.stringify(filters))) {\r\n      enableBbox = false;\r\n    } else {\r\n      enableBbox = true;\r\n    }\r\n    if (filters) {\r\n      fieldNameGeometry =\r\n        (filters as any).geometryName !== undefined\r\n          ? (filters as any).geometryName\r\n          : fieldNameGeometry;\r\n    }\r\n    if (extent && filters) {\r\n      ourBboxFilter = olfilter.bbox(fieldNameGeometry, extent, proj.getCode());\r\n    }\r\n    let filterAssembly: OgcFilter;\r\n    if (filters) {\r\n      filters = this.checkIgoFiltersProperties(\r\n        filters,\r\n        fieldNameGeometry,\r\n        proj\r\n      );\r\n      if (extent && enableBbox) {\r\n        filterAssembly = olfilter.and(\r\n          ourBboxFilter,\r\n          this.bundleFilter(filters, options)\r\n        );\r\n      } else {\r\n        filterAssembly = this.bundleFilter(filters, options);\r\n      }\r\n    } else {\r\n      return 'bbox=' + extent.join(',') + ',' + proj.getCode();\r\n    }\r\n\r\n    const wfsOptions: WriteGetFeatureOptions = {\r\n      srsName: '',\r\n      featureNS: '',\r\n      featurePrefix: '',\r\n      featureTypes: ['featureTypes'],\r\n      filter: filterAssembly,\r\n      outputFormat: '',\r\n      geometryName: fieldNameGeometry\r\n    };\r\n\r\n    const query = new olFormatWFS().writeGetFeature(wfsOptions);\r\n    const str = new XMLSerializer().serializeToString(query);\r\n    const regexp1 = /typenames *=|typename *=\\\"featureTypes\\\" *>/gi;\r\n    const regexp2 = /<\\/Query><\\/GetFeature>/gi;\r\n\r\n    return 'filter=' + str.split(regexp1)[1].split(regexp2)[0];\r\n  }\r\n\r\n  private bundleFilter(\r\n    filterObject: any,\r\n    options?: OgcFilterableDataSourceOptions\r\n  ) {\r\n    if (filterObject instanceof Array) {\r\n      const logicalArray = [];\r\n      filterObject.forEach((element) => {\r\n        logicalArray.push(this.bundleFilter(element, options));\r\n      });\r\n      return logicalArray;\r\n    } else {\r\n      if (filterObject.hasOwnProperty('logical')) {\r\n        return this.createFilter(\r\n          {\r\n            operator: filterObject.logical,\r\n            logicalArray: this.bundleFilter(filterObject.filters, options)\r\n          },\r\n          options\r\n        );\r\n      } else if (filterObject.hasOwnProperty('operator')) {\r\n        return this.createFilter(\r\n          filterObject as AnyBaseOgcFilterOptions,\r\n          options\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  private createFilter(\r\n    filterOptions,\r\n    options?: OgcFilterableDataSourceOptions\r\n  ): OgcFilter {\r\n    const operator = filterOptions.operator;\r\n    const logicalArray = filterOptions.logicalArray;\r\n\r\n    const wfsPropertyName = filterOptions.propertyName;\r\n    const wfsPattern = filterOptions.pattern;\r\n    const wfsMatchCase = filterOptions.matchCase\r\n      ? filterOptions.matchCase\r\n      : true;\r\n    const wfsWildCard = filterOptions.wildCard ? filterOptions.wildCard : '*';\r\n    const wfsSingleChar = filterOptions.singleChar\r\n      ? filterOptions.singleChar\r\n      : '.';\r\n    const wfsEscapeChar = filterOptions.escapeChar\r\n      ? filterOptions.escapeChar\r\n      : '!';\r\n\r\n    const wfsLowerBoundary = filterOptions.lowerBoundary;\r\n    const wfsUpperBoundary = filterOptions.upperBoundary;\r\n\r\n    const wfsGeometryName = filterOptions.geometryName;\r\n    const wfsExtent = filterOptions.extent;\r\n    const wfsWktGeometry = filterOptions.wkt_geometry;\r\n    const wfsSrsName = filterOptions.srsName\r\n      ? filterOptions.srsName\r\n      : 'EPSG:3857';\r\n\r\n    const wfsBegin = this.parseFilterOptionDate(\r\n      filterOptions.begin,\r\n      options ? options.minDate : undefined\r\n    );\r\n    const wfsEnd = this.parseFilterOptionDate(\r\n      filterOptions.end,\r\n      options ? options.maxDate : undefined\r\n    );\r\n\r\n    const wfsExpression = filterOptions.expression;\r\n\r\n    let geometry: olGeometry;\r\n    if (wfsWktGeometry) {\r\n      const wkt = new olFormatWKT();\r\n      geometry = wkt.readGeometry(wfsWktGeometry, {\r\n        dataProjection: wfsSrsName,\r\n        featureProjection: wfsSrsName || 'EPSG:3857'\r\n      });\r\n    }\r\n\r\n    switch (operator.toLowerCase()) {\r\n      case OgcFilterOperator.BBOX.toLowerCase():\r\n        return olfilter.bbox(wfsGeometryName, wfsExtent, wfsSrsName);\r\n      case OgcFilterOperator.PropertyIsBetween.toLowerCase():\r\n        return olfilter.between(\r\n          wfsPropertyName,\r\n          wfsLowerBoundary || 1e40*-1,\r\n          wfsUpperBoundary || 1e40\r\n        );\r\n      case OgcFilterOperator.Contains.toLowerCase():\r\n        return olfilter.contains(wfsGeometryName, geometry, wfsSrsName);\r\n      case OgcFilterOperator.During.toLowerCase():\r\n        return olfilter.during(wfsPropertyName, wfsBegin, wfsEnd);\r\n      case OgcFilterOperator.PropertyIsEqualTo.toLowerCase():\r\n        return olfilter.equalTo(wfsPropertyName, wfsExpression, wfsMatchCase);\r\n      case OgcFilterOperator.PropertyIsGreaterThan.toLowerCase():\r\n        return olfilter.greaterThan(wfsPropertyName, wfsExpression);\r\n      case OgcFilterOperator.PropertyIsGreaterThanOrEqualTo.toLowerCase():\r\n        return olfilter.greaterThanOrEqualTo(wfsPropertyName, wfsExpression);\r\n      case OgcFilterOperator.Intersects.toLowerCase():\r\n        return olfilter.intersects(wfsGeometryName, geometry, wfsSrsName);\r\n      case OgcFilterOperator.PropertyIsNull.toLowerCase():\r\n        return olfilter.isNull(wfsPropertyName);\r\n      case OgcFilterOperator.PropertyIsLessThan.toLowerCase():\r\n        return olfilter.lessThan(wfsPropertyName, wfsExpression);\r\n      case OgcFilterOperator.PropertyIsLessThanOrEqualTo.toLowerCase():\r\n        return olfilter.lessThanOrEqualTo(wfsPropertyName, wfsExpression);\r\n      case OgcFilterOperator.PropertyIsLike.toLowerCase():\r\n        return olfilter.like(\r\n          wfsPropertyName,\r\n          wfsPattern ? wfsPattern.replace(/[()_]/gi, wfsSingleChar): wfsWildCard,\r\n          wfsWildCard,\r\n          wfsSingleChar,\r\n          wfsEscapeChar,\r\n          wfsMatchCase\r\n        );\r\n      case OgcFilterOperator.PropertyIsNotEqualTo.toLowerCase():\r\n        return olfilter.notEqualTo(\r\n          wfsPropertyName,\r\n          wfsExpression,\r\n          wfsMatchCase\r\n        );\r\n      case OgcFilterOperator.Within.toLowerCase():\r\n        return olfilter.within(wfsGeometryName, geometry, wfsSrsName);\r\n      // LOGICAL\r\n      case OgcFilterOperator.And.toLowerCase():\r\n        return olfilter.and.apply(null, logicalArray);\r\n      case OgcFilterOperator.Or.toLowerCase():\r\n        return olfilter.or.apply(null, logicalArray);\r\n      case OgcFilterOperator.Not.toLowerCase():\r\n        return olfilter.not.apply(null, logicalArray);\r\n\r\n      default:\r\n        return undefined;\r\n    }\r\n  }\r\n\r\n  public defineInterfaceFilterSequence(\r\n    filterObject: any,\r\n    geometryName,\r\n    logical = '',\r\n    level = -1\r\n  ): OgcInterfaceFilterOptions[] {\r\n    if (filterObject instanceof Array) {\r\n      filterObject.forEach((element) => {\r\n        this.filterSequence.concat(\r\n          this.defineInterfaceFilterSequence(\r\n            element,\r\n            geometryName,\r\n            logical,\r\n            level\r\n          )\r\n        );\r\n      });\r\n    } else {\r\n      if (filterObject.hasOwnProperty('logical')) {\r\n        level = level + 1;\r\n        this.filterSequence.concat(\r\n          this.defineInterfaceFilterSequence(\r\n            filterObject.filters,\r\n            geometryName,\r\n            filterObject.logical,\r\n            level\r\n          )\r\n        );\r\n      } else if (filterObject.hasOwnProperty('operator')) {\r\n        this.filterSequence.push(\r\n          this.addInterfaceFilter(filterObject, geometryName, level, logical)\r\n        );\r\n      }\r\n    }\r\n    return this.filterSequence;\r\n  }\r\n\r\n  public computeAllowedOperators(\r\n    fields?: SourceFieldsOptionsParams[],\r\n    propertyName?: string,\r\n    defaultOperatorsType?: OgcFilterOperatorType\r\n  ) {\r\n    let effectiveOperators: {} = {};\r\n    let allowedOperators;\r\n    let fieldsHasSpatialOperator: boolean;\r\n    let includeContains: boolean;\r\n\r\n    if (fields && propertyName) {\r\n      const srcField = fields.find((field) => field.name === propertyName);\r\n      allowedOperators =\r\n        srcField && srcField.allowedOperatorsType\r\n          ? srcField.allowedOperatorsType\r\n          : defaultOperatorsType;\r\n    }\r\n\r\n    if (fields) {\r\n      fields.map((field) => {\r\n        if (!field.allowedOperatorsType) {\r\n          return;\r\n        }\r\n        const allowedOperatorsType = field.allowedOperatorsType.toLowerCase();\r\n        if (\r\n          allowedOperatorsType === OgcFilterOperatorType.All.toLowerCase() ||\r\n          allowedOperatorsType ===\r\n            OgcFilterOperatorType.Spatial.toLowerCase() ||\r\n          allowedOperatorsType ===\r\n            OgcFilterOperatorType.BasicAndSpatial.toLowerCase()\r\n        ) {\r\n          fieldsHasSpatialOperator = true;\r\n          if (\r\n            allowedOperatorsType === OgcFilterOperatorType.All.toLowerCase()\r\n          ) {\r\n            includeContains = true;\r\n          }\r\n        }\r\n      });\r\n    }\r\n\r\n    allowedOperators = allowedOperators\r\n      ? allowedOperators\r\n      : OgcFilterOperatorType.BasicAndSpatial;\r\n\r\n    switch (allowedOperators.toLowerCase()) {\r\n      case OgcFilterOperatorType.All:\r\n        effectiveOperators = this.operators;\r\n        break;\r\n      case OgcFilterOperatorType.Spatial:\r\n        effectiveOperators = {\r\n          [OgcFilterOperator.Intersects]: { spatial: true, fieldRestrict: [] },\r\n          [OgcFilterOperator.Within]: { spatial: true, fieldRestrict: [] }\r\n        };\r\n        break;\r\n      case OgcFilterOperatorType.BasicAndSpatial:\r\n        effectiveOperators = {\r\n          [OgcFilterOperator.PropertyIsEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: []\r\n          },\r\n          [OgcFilterOperator.PropertyIsNotEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: []\r\n          },\r\n          [OgcFilterOperator.Intersects]: { spatial: true, fieldRestrict: [] },\r\n          [OgcFilterOperator.Within]: { spatial: true, fieldRestrict: [] }\r\n        };\r\n        break;\r\n      case OgcFilterOperatorType.Basic:\r\n        effectiveOperators = {\r\n          [OgcFilterOperator.PropertyIsEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: []\r\n          },\r\n          [OgcFilterOperator.PropertyIsNotEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: []\r\n          }\r\n        };\r\n        break;\r\n      case OgcFilterOperatorType.Time:\r\n        effectiveOperators = {\r\n          [OgcFilterOperator.During]: { spatial: false, fieldRestrict: [] }\r\n        };\r\n        break;\r\n      case OgcFilterOperatorType.BasicNumericOperator:\r\n        effectiveOperators = {\r\n          [OgcFilterOperator.PropertyIsEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: []\r\n          },\r\n          [OgcFilterOperator.PropertyIsNotEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: []\r\n          },\r\n          [OgcFilterOperator.PropertyIsGreaterThan]: {\r\n            spatial: false,\r\n            fieldRestrict: ['number']\r\n          },\r\n          [OgcFilterOperator.PropertyIsGreaterThanOrEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: ['number']\r\n          },\r\n          [OgcFilterOperator.PropertyIsLessThan]: {\r\n            spatial: false,\r\n            fieldRestrict: ['number']\r\n          },\r\n          [OgcFilterOperator.PropertyIsLessThanOrEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: ['number']\r\n          }\r\n        };\r\n        break;\r\n      default:\r\n        effectiveOperators = {\r\n          [OgcFilterOperator.PropertyIsEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: []\r\n          },\r\n          [OgcFilterOperator.PropertyIsNotEqualTo]: {\r\n            spatial: false,\r\n            fieldRestrict: []\r\n          },\r\n          [OgcFilterOperator.Intersects]: { spatial: true, fieldRestrict: [] },\r\n          [OgcFilterOperator.Within]: { spatial: true, fieldRestrict: [] }\r\n        };\r\n    }\r\n\r\n    if (fieldsHasSpatialOperator) {\r\n      (effectiveOperators as any).Intersects = {\r\n        spatial: true,\r\n        fieldRestrict: []\r\n      };\r\n      (effectiveOperators as any).Within = { spatial: true, fieldRestrict: [] };\r\n      if (includeContains) {\r\n        (effectiveOperators as any).Contains = {\r\n          spatial: true,\r\n          fieldRestrict: []\r\n        };\r\n      }\r\n    }\r\n\r\n    return effectiveOperators;\r\n  }\r\n\r\n  public addInterfaceFilter(\r\n    igoOgcFilterObject?,\r\n    geometryName?,\r\n    level = 0,\r\n    parentLogical = 'Or'\r\n  ): OgcInterfaceFilterOptions {\r\n    if (!igoOgcFilterObject) {\r\n      igoOgcFilterObject = { operator: 'PropertyIsEqualTo' };\r\n    }\r\n    const f = {\r\n      propertyName: '',\r\n      operator: '',\r\n      active: '',\r\n      filterid: uuid(),\r\n      step: '',\r\n      begin: '',\r\n      end: '',\r\n      sliderOptions: {},\r\n      lowerBoundary: '',\r\n      upperBoundary: '',\r\n      expression: '',\r\n      pattern: '',\r\n      wildCard: '*',\r\n      singleChar: '.',\r\n      escapeChar: '!',\r\n      matchCase: true,\r\n      igoSpatialSelector: '',\r\n      igoSNRC: '',\r\n      geometryName: '',\r\n      geometry: '',\r\n      wkt_geometry: '',\r\n      extent: '',\r\n      srsName: '',\r\n      parentLogical: '',\r\n      level: 0\r\n    };\r\n\r\n    return Object.assign(\r\n      f,\r\n      {\r\n        parentLogical,\r\n        level,\r\n        geometryName\r\n      },\r\n      igoOgcFilterObject\r\n    );\r\n  }\r\n\r\n  public checkIgoFiltersProperties(\r\n    filterObject: any,\r\n    fieldNameGeometry,\r\n    proj: olProjection,\r\n    active = false\r\n  ) {\r\n    const filterArray = [];\r\n    if (filterObject instanceof Array) {\r\n      filterObject.forEach((element) => {\r\n        filterArray.push(\r\n          this.checkIgoFiltersProperties(\r\n            element,\r\n            fieldNameGeometry,\r\n            proj,\r\n            active\r\n          )\r\n        );\r\n      });\r\n      return filterArray;\r\n    } else {\r\n      if (filterObject.hasOwnProperty('logical')) {\r\n        return Object.assign(\r\n          {},\r\n          {\r\n            logical: filterObject.logical,\r\n            filters: this.checkIgoFiltersProperties(\r\n              filterObject.filters,\r\n              fieldNameGeometry,\r\n              proj,\r\n              active\r\n            )\r\n          }\r\n        );\r\n      } else if (filterObject.hasOwnProperty('operator')) {\r\n        return this.addFilterProperties(\r\n          filterObject as OgcInterfaceFilterOptions,\r\n          fieldNameGeometry,\r\n          proj,\r\n          active\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  private addFilterProperties(\r\n    igoOgcFilterObject: OgcInterfaceFilterOptions,\r\n    fieldNameGeometry,\r\n    proj: olProjection,\r\n    active = false\r\n  ) {\r\n    const filterid = igoOgcFilterObject.hasOwnProperty('filterid')\r\n      ? igoOgcFilterObject.filterid\r\n      : uuid();\r\n    const status = igoOgcFilterObject.hasOwnProperty('active')\r\n      ? igoOgcFilterObject.active\r\n      : active;\r\n\r\n    const srsName = igoOgcFilterObject.hasOwnProperty('srsName')\r\n      ? igoOgcFilterObject.srsName\r\n      : proj\r\n      ? proj.getCode()\r\n      : 'EPSG:3857';\r\n\r\n    return Object.assign(\r\n      {},\r\n      {\r\n        filterid,\r\n        active: status,\r\n        igoSpatialSelector: 'fixedExtent',\r\n        srsName\r\n      },\r\n      igoOgcFilterObject,\r\n      { geometryName: fieldNameGeometry }\r\n    );\r\n  }\r\n\r\n  public rebuiltIgoOgcFilterObjectFromSequence(\r\n    sequence: OgcInterfaceFilterOptions[]\r\n  ): IgoOgcFilterObject {\r\n    if (sequence instanceof Array) {\r\n      if (sequence.length >= 1) {\r\n        let lastParentLogical = sequence[0].parentLogical;\r\n        let nextElement: any;\r\n        let logicalArray = [];\r\n        let lastProcessedFilter;\r\n        sequence.forEach((uiFilter) => {\r\n          const element = Object.assign({}, uiFilter);\r\n          const index = sequence.indexOf(uiFilter);\r\n          if (index >= 0 && index < sequence.length - 1) {\r\n            nextElement = sequence[index + 1];\r\n          } else {\r\n            nextElement = element;\r\n          }\r\n          delete element.active;\r\n          delete element.filterid;\r\n          delete element.parentLogical;\r\n          logicalArray.push(element);\r\n\r\n          if (sequence.length === 1) {\r\n            lastProcessedFilter = element;\r\n          } else if (lastParentLogical !== nextElement.parentLogical) {\r\n            if (logicalArray.length === 1) {\r\n              console.log(\r\n                'You must set at ' +\r\n                  'least two operator in a logical (' +\r\n                  lastParentLogical +\r\n                  ')'\r\n              );\r\n            } else {\r\n              lastProcessedFilter = Object.assign(\r\n                {},\r\n                { logical: lastParentLogical, filters: logicalArray }\r\n              );\r\n              logicalArray = [lastProcessedFilter];\r\n              lastParentLogical = nextElement.parentLogical;\r\n            }\r\n          }\r\n        });\r\n        return lastProcessedFilter;\r\n      } else {\r\n        return undefined;\r\n      }\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  private computeIgoSelector(selectors: IgoOgcSelector): IgoOgcSelector {\r\n    if (\r\n      selectors.groups.every((group) => group.computedSelectors !== undefined)\r\n    ) {\r\n      return selectors;\r\n    }\r\n    let selector: IgoOgcSelector;\r\n    if (selectors.groups && selectors.bundles) {\r\n      if (!selectors.bundles.every((bundle) => bundle.id !== undefined)) {\r\n        throw new Error(\r\n          'You must set an id for each of your bundles'\r\n        );\r\n      }\r\n      selector = ObjectUtils.copyDeep(selectors);\r\n      selector.groups.forEach((group) => {\r\n        group.title = group.title ? group.title : group.name;\r\n        group.enabled = group.enabled ? group.enabled : false;\r\n        group.computedSelectors = ObjectUtils.copyDeep(\r\n          selector.bundles.filter((b) => group.ids.includes(b.id))\r\n        );\r\n      });\r\n    } else if (!selectors.groups && selectors.bundles) {\r\n      selector = ObjectUtils.copyDeep(selectors);\r\n      selector.groups = [\r\n        {\r\n          title: 'group1',\r\n          name: 'group1',\r\n          computedSelectors: ObjectUtils.copyDeep(selector.bundles)\r\n        } as SelectorGroup\r\n      ];\r\n    } else {\r\n      selector = {\r\n        bundles: selectors as any,\r\n        groups: [\r\n          {\r\n            title: 'group1',\r\n            name: 'group1',\r\n            computedSelectors: ObjectUtils.copyDeep(\r\n              selectors\r\n            ) as OgcSelectorBundle[]\r\n          } as SelectorGroup\r\n        ],\r\n        selectorType: selector.selectorType\r\n      };\r\n    }\r\n    if (!selector.groups.find((selectorGroup) => selectorGroup.enabled)) {\r\n      selector.groups[0].enabled = true;\r\n    }\r\n    return selector;\r\n  }\r\n\r\n  public handleOgcFiltersAppliedValue(\r\n    options: OgcFilterableDataSourceOptions,\r\n    fieldNameGeometry: string,\r\n    extent?: [number, number, number, number],\r\n    proj?: olProjection\r\n  ): string {\r\n    const ogcFilters = options.ogcFilters;\r\n    if (!ogcFilters) {\r\n      return;\r\n    }\r\n    const conditions = [];\r\n    let filterQueryStringSelector = '';\r\n    let filterQueryStringAdvancedFilters = '';\r\n    if (ogcFilters.enabled && (ogcFilters.pushButtons || ogcFilters.checkboxes || ogcFilters.radioButtons || ogcFilters.select\r\n      || ogcFilters.autocomplete)) {\r\n      let selectors;\r\n      if (ogcFilters.pushButtons) {\r\n        selectors = ogcFilters.pushButtons;\r\n        const pushConditions = this.formatGroupAndFilter(ogcFilters, selectors);\r\n        for (const condition of pushConditions) {\r\n          conditions.push(condition);\r\n        }\r\n      }\r\n      if (ogcFilters.checkboxes) {\r\n        selectors = ogcFilters.checkboxes;\r\n        const checkboxConditions = this.formatGroupAndFilter(ogcFilters, selectors);\r\n        for (const condition of checkboxConditions) {\r\n          conditions.push(condition);\r\n        }\r\n      }\r\n      if (ogcFilters.radioButtons) {\r\n        selectors = ogcFilters.radioButtons;\r\n        const selectorsCorr = this.verifyMultipleEnableds(selectors);\r\n        const radioConditions = this.formatGroupAndFilter(ogcFilters, selectorsCorr);\r\n        for (const condition of radioConditions) {\r\n          conditions.push(condition);\r\n        }\r\n      }\r\n      if (ogcFilters.select) {\r\n        selectors = ogcFilters.select;\r\n        const selectorsCorr = this.verifyMultipleEnableds(selectors);\r\n        const selectConditions = this.formatGroupAndFilter(ogcFilters, selectorsCorr);\r\n        for (const condition of selectConditions) {\r\n          conditions.push(condition);\r\n        }\r\n      }\r\n      if (ogcFilters.autocomplete) {\r\n        selectors = ogcFilters.autocomplete;\r\n        const selectConditions = this.formatGroupAndFilter(ogcFilters, selectors);\r\n        for (const condition of selectConditions) {\r\n          conditions.push(condition);\r\n        }\r\n      }\r\n\r\n      if (conditions.length >= 1) {\r\n        filterQueryStringSelector = this.buildFilter(\r\n          conditions.length === 1\r\n            ? conditions[0]\r\n            : { logical: 'And', filters: conditions },\r\n          extent,\r\n          proj,\r\n          ogcFilters.geometryName\r\n        );\r\n      }\r\n    }\r\n    if (ogcFilters.enabled && ogcFilters.filters) {\r\n      ogcFilters.geometryName = ogcFilters.geometryName || fieldNameGeometry;\r\n      const igoFilters = ogcFilters.filters;\r\n      filterQueryStringAdvancedFilters = this.buildFilter(\r\n        igoFilters,\r\n        extent,\r\n        proj,\r\n        ogcFilters.geometryName,\r\n        options\r\n      );\r\n    }\r\n\r\n    let filterQueryString = ogcFilters.advancedOgcFilters\r\n      ? filterQueryStringAdvancedFilters\r\n      : filterQueryStringSelector;\r\n    if (options.type === 'wms') {\r\n      filterQueryString = this.formatProcessedOgcFilter(\r\n        filterQueryString,\r\n        (options as any).params.LAYERS\r\n      );\r\n    }\r\n    if (options.type === 'wfs') {\r\n      filterQueryString = this.formatProcessedOgcFilter(\r\n        filterQueryString,\r\n        (options as any).params.featureTypes\r\n      );\r\n    }\r\n\r\n    return filterQueryString;\r\n  }\r\n\r\n  public verifyMultipleEnableds(selectors) {\r\n    selectors.bundles.forEach(bundle => {\r\n      if (!bundle.multiple && bundle.selectors) {\r\n        const enableds = bundle.selectors.reduce((list, filter, index) => (filter.enabled) === true ? list.concat(index) : list, []);\r\n        if (enableds.length > 1) {\r\n          enableds.splice(0, 1);\r\n          enableds.forEach(index => {\r\n            bundle.selectors[index].enabled = false;\r\n          });\r\n        }\r\n      }\r\n    });\r\n    return selectors;\r\n  }\r\n\r\n  public formatGroupAndFilter(ogcFilters: OgcFiltersOptions, selectors) {\r\n    selectors = this.computeIgoSelector(\r\n      selectors\r\n    );\r\n    const selectorBundle = selectors.groups.find(\r\n      (g) => g.enabled\r\n    ).computedSelectors;\r\n    const conditions = [];\r\n    selectorBundle.map((bundle) => {\r\n      const bundleCondition = [];\r\n      const selectorsType = bundle.selectors as any;\r\n      if (!selectorsType) {\r\n        return;\r\n      }\r\n      selectorsType\r\n        .filter((ogcselector) => ogcselector.enabled === true)\r\n        .forEach((enabledSelector) => bundleCondition.push(enabledSelector.filters));\r\n      if (bundleCondition.length === 1) {\r\n        conditions.push(bundleCondition[0]);\r\n      } else if (bundleCondition.length > 1) {\r\n        conditions.push({\r\n          logical: bundle.logical,\r\n          filters: bundleCondition\r\n        });\r\n      }\r\n    });\r\n\r\n    if (selectors.selectorType === 'pushButton') {\r\n      ogcFilters.pushButtons = selectors;\r\n    } else if (selectors.selectorType === 'checkbox') {\r\n      ogcFilters.checkboxes = selectors;\r\n    } else if (selectors.selectorType === 'radioButton') {\r\n      ogcFilters.radioButtons = selectors;\r\n    } else if (selectors.selectorType === 'select') {\r\n      ogcFilters.select = selectors;\r\n    } else if (selectors.selectorType === 'autocomplete') {\r\n      ogcFilters.autocomplete = selectors;\r\n    }\r\n    return conditions;\r\n  }\r\n\r\n  public formatProcessedOgcFilter(\r\n    processedFilter: string,\r\n    layersOrTypenames: string\r\n  ): string {\r\n\r\n    if (!processedFilter) {return undefined;};\r\n    let appliedFilter = '';\r\n    if (processedFilter.length === 0 && layersOrTypenames.indexOf(',') === -1) {\r\n      appliedFilter = processedFilter;\r\n    } else {\r\n      layersOrTypenames.split(',').forEach((layerOrTypenames) => {\r\n        appliedFilter = `${appliedFilter}(${processedFilter.replace(\r\n          'filter=',\r\n          ''\r\n        )})`;\r\n      });\r\n    }\r\n    appliedFilter = appliedFilter.replace(/\\(\\)/g, '');\r\n    const filterValue =\r\n      appliedFilter.length > 0\r\n        ? appliedFilter.replace('filter=', '')\r\n        : undefined;\r\n    return filterValue;\r\n  }\r\n\r\n  public parseFilterOptionDate(value: string, defaultValue?: string): string {\r\n    if (!value) {\r\n      return defaultValue;\r\n    } else if (value === 'today') {\r\n      return undefined;\r\n    } else if (moment(value).isValid()) {\r\n      return value;\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n}\r\n","export enum QueryFormat {\r\n  GML2 = 'gml2',\r\n  GML3 = 'gml3',\r\n  JSON = 'json',\r\n  GEOJSON = 'geojson',\r\n  GEOJSON2 = 'geojson2',\r\n  ESRIJSON = 'esrijson',\r\n  TEXT = 'text',\r\n  HTML = 'html',\r\n  HTMLGML2 = 'htmlgml2'\r\n}\r\n\r\nexport enum QueryFormatMimeType {\r\n  GML2 = 'application/vnd.ogc.gml',\r\n  GML3 = 'application/vnd.ogc.gml/3.1.1',\r\n  JSON = 'application/json',\r\n  GEOJSON = 'application/geojson',\r\n  GEOJSON2 = 'geojson',\r\n  ESRIJSON = 'application/json',\r\n  TEXT = 'text/plain',\r\n  HTML = 'text/html',\r\n  HTMLGML2 = 'text/html'\r\n}\r\n\r\nexport enum QueryHtmlTarget {\r\n  IFRAME = 'iframe',\r\n  BLANK = '_blank'\r\n}\r\n","import { WFSDataSourceOptions } from './wfs-datasource.interface';\r\nimport { WMSDataSourceOptions } from './wms-datasource.interface';\r\nimport { OgcFiltersOptions } from '../../../filter/shared/ogc-filter.interface';\r\nimport { OgcFilterWriter } from '../../../filter/shared/ogc-filter';\r\n\r\nimport * as OlFormat from 'ol/format';\r\nimport olFormatGML2 from 'ol/format/GML2';\r\nimport olFormatGML3 from 'ol/format/GML3';\r\nimport olFormatGML32 from 'ol/format/GML32';\r\nimport olFormatOSMXML from 'ol/format/OSMXML';\r\nimport olProjection from 'ol/proj/Projection';\r\n\r\nexport const defaultEpsg = 'EPSG:3857';\r\nexport const defaultMaxFeatures = 5000;\r\nexport const defaultWfsVersion = '2.0.0';\r\nexport const defaultFieldNameGeometry = 'geometry';\r\nexport const gmlRegex = new RegExp(/(.*)?gml(.*)?/gi);\r\nexport const jsonRegex = new RegExp(/(.*)?json(.*)?/gi);\r\n\r\n\r\n/**\r\n * This method build the WFS URL based on the layer property.\r\n * @param options  WFSDataSourceOptions The common wfs datasource options interface\r\n * @param extent  An extent like array [number, number, number, number]\r\n * @param proj  olProjection\r\n * @param ogcFilters  OgcFiltersOptions\r\n * @returns A string representing the datasource options, based on filter and views\r\n */\r\nexport function buildUrl(\r\n  options: WFSDataSourceOptions,\r\n  extent,\r\n  proj: olProjection,\r\n  ogcFilters: OgcFiltersOptions,\r\n  randomParam?: boolean): string {\r\n  const paramsWFS = options.paramsWFS;\r\n  const queryStringValues = formatWFSQueryString(options, undefined, options.paramsWFS.srsName);\r\n  let igoFilters;\r\n  if (ogcFilters && ogcFilters.enabled) {\r\n    igoFilters = ogcFilters.filters;\r\n  }\r\n  const ogcFilterWriter = new OgcFilterWriter();\r\n  const filterOrBox = ogcFilterWriter.buildFilter(igoFilters, extent, proj, ogcFilters.geometryName, options);\r\n  let filterOrPush = ogcFilterWriter.handleOgcFiltersAppliedValue(options, ogcFilters.geometryName, extent, proj);\r\n\r\n  let prefix = 'filter';\r\n  if (!filterOrPush) {\r\n    prefix = 'bbox';\r\n    filterOrPush = extent.join(',') + ',' + proj.getCode();\r\n  }\r\n\r\n  paramsWFS.xmlFilter = ogcFilters.advancedOgcFilters ? filterOrBox : `${prefix}=${filterOrPush}`;\r\n  let baseUrl = queryStringValues.find(f => f.name === 'getfeature').value;\r\n  const patternFilter = /(filter|bbox)=.*/gi;\r\n  baseUrl = patternFilter.test(paramsWFS.xmlFilter) ? `${baseUrl}&${paramsWFS.xmlFilter}` : baseUrl;\r\n  options.download = Object.assign({}, options.download, { dynamicUrl: baseUrl });\r\n  if (randomParam) {\r\n    baseUrl += `$&_t${new Date().getTime()}`;\r\n  }\r\n  return baseUrl.replace(/&&/g, '&');\r\n}\r\n\r\n\r\n/**\r\n * This method build/standardize WFS call query params based on the layer property.\r\n * @param wfsDataSourceOptions  WFSDataSourceOptions The common wfs datasource options interface\r\n * @param count  Number: Used to control the number of feature. Used to bypass whe wfs datasource options interface (maxFeatures)\r\n * @param epsg  String: Used to control the EPSG code (es: 'EPSG3857'). Used to bypass whe wfs datasource options interface (srsName)\r\n * @param properties  String: Used to control the queried fields  (WFS service).\r\n * @returns An array array of {name: '', value: ''} of predefined query params.\r\n */\r\nexport function formatWFSQueryString(\r\n  dataSourceOptions: WFSDataSourceOptions | WMSDataSourceOptions,\r\n  count?: number,\r\n  epsg?: string,\r\n  properties?: string,\r\n  startIndex: number = 0,\r\n  forceDefaultOutputFormat: boolean = false\r\n): { name: string; value: string }[] {\r\n  const versionWfs200 = '2.0.0'; // not the same usage as defaultWfsVersion.\r\n  const url = dataSourceOptions.urlWfs;\r\n  const paramsWFS = dataSourceOptions.paramsWFS;\r\n  const effectiveCount = count || defaultMaxFeatures;\r\n  const effectiveStartIndex = paramsWFS.version === versionWfs200 ? `startIndex=${startIndex}` : '';\r\n  const epsgCode = epsg || defaultEpsg;\r\n  let outputFormat = paramsWFS.outputFormat\r\n    ? `outputFormat=${paramsWFS.outputFormat}`\r\n    : '';\r\n  let version = paramsWFS.version\r\n    ? `version=${paramsWFS.version}`\r\n    : `version=${defaultWfsVersion}`;\r\n  const paramTypename =\r\n    paramsWFS.version === versionWfs200 ? 'typenames' : 'typename';\r\n  const featureTypes = `${paramTypename}=${paramsWFS.featureTypes}`;\r\n  const paramMaxFeatures =\r\n    paramsWFS.version === versionWfs200 ? 'count' : 'maxFeatures';\r\n  let cnt = count\r\n    ? `${paramMaxFeatures}=${effectiveCount}`\r\n    : paramsWFS.maxFeatures\r\n    ? `${paramMaxFeatures}=${paramsWFS.maxFeatures}`\r\n    : `${paramMaxFeatures}=${effectiveCount}`;\r\n  if (forceDefaultOutputFormat) {\r\n      outputFormat = '';\r\n      version = 'version=1.1.0';\r\n      cnt = cnt.replace('count', 'maxFeatures');\r\n    }\r\n\r\n  const srs = epsg\r\n    ? `srsname=${epsgCode}`\r\n    : paramsWFS.srsName\r\n    ? 'srsname=' + paramsWFS.srsName\r\n    : `srsname=${epsgCode}`;\r\n\r\n  let propertyName = '';\r\n  let valueReference = '';\r\n  if (properties) {\r\n    propertyName = `propertyName=${properties}`;\r\n    valueReference = `valueReference=${properties}`;\r\n  }\r\n  const sourceFields = dataSourceOptions.sourceFields;\r\n  if (!propertyName && sourceFields && sourceFields.length > 0) {\r\n    const fieldsNames = [];\r\n    dataSourceOptions.sourceFields.forEach(sourcefield => {\r\n      fieldsNames.push(sourcefield.name);\r\n    });\r\n    propertyName = `propertyName=${fieldsNames.join(',')},${\r\n      paramsWFS.fieldNameGeometry\r\n    }`;\r\n  }\r\n\r\n  const separator = url.indexOf('?') === -1 ? '?' : '&';\r\n  const getCapabilities = `${url}${separator}service=WFS&request=GetCapabilities&${version}`;\r\n  let getFeature = `${url}${separator}service=WFS&request=GetFeature&${version}&${featureTypes}&`;\r\n  getFeature += `${outputFormat}&${srs}&${cnt}&${propertyName}&${effectiveStartIndex}`;\r\n\r\n  let getpropertyvalue = `${url}?service=WFS&request=GetPropertyValue&version=${versionWfs200}&${featureTypes}&`;\r\n  getpropertyvalue += `&${cnt}&${valueReference}`;\r\n\r\n  return [\r\n    { name: 'outputformat', value: outputFormat },\r\n    { name: 'version', value: version },\r\n    { name: 'typename', value: featureTypes },\r\n    { name: 'count', value: cnt },\r\n    { name: 'srsname', value: srs },\r\n    { name: 'propertyname', value: propertyName },\r\n    { name: 'valuereference', value: valueReference },\r\n    { name: 'getcapabilities', value: getCapabilities.replace(/&&/g, '&') },\r\n    { name: 'getfeature', value: getFeature.replace(/&&/g, '&') },\r\n    { name: 'getpropertyvalue', value: getpropertyvalue.replace(/&&/g, '&') }\r\n  ];\r\n}\r\n\r\n/**\r\n * Validate/Modify layer's wfs options based on :\r\n * 1- an Openlayers's issue with GML provided from WFS. Refer to\r\n * https://github.com/openlayers/openlayers/pull/6400\r\n * 2- Set default values for optionals parameters.\r\n * @param wfsDataSourceOptions  WFSDataSourceOptions The common wfs datasource options interface\r\n * @returns An array array of {name: '', value: ''} of predefined query params.\r\n */\r\nexport function checkWfsParams(wfsDataSourceOptions, srcType?: string) {\r\n  if (srcType && srcType === 'wfs') {\r\n    // reassignation of params to paramsWFS and url to urlWFS to have a common interface with wms-wfs datasources\r\n    wfsDataSourceOptions.paramsWFS = wfsDataSourceOptions.params;\r\n  }\r\n\r\n  const paramsWFS = wfsDataSourceOptions.paramsWFS;\r\n  wfsDataSourceOptions.urlWfs =\r\n    wfsDataSourceOptions.urlWfs || wfsDataSourceOptions.url;\r\n\r\n  paramsWFS.version = paramsWFS.version || defaultWfsVersion;\r\n  paramsWFS.fieldNameGeometry =\r\n    paramsWFS.fieldNameGeometry || defaultFieldNameGeometry;\r\n  paramsWFS.maxFeatures = paramsWFS.maxFeatures || defaultMaxFeatures;\r\n\r\n  let outputFormat;\r\n  if (paramsWFS.outputFormat) {\r\n    outputFormat = paramsWFS.outputFormat;\r\n  }\r\n\r\n  if (gmlRegex.test(outputFormat) || !outputFormat) {\r\n    paramsWFS.version = '1.1.0';\r\n  }\r\n  return Object.assign({}, wfsDataSourceOptions);\r\n}\r\n\r\nexport function getFormatFromOptions(\r\n  options: WFSDataSourceOptions | WMSDataSourceOptions\r\n) {\r\n  const wfsOptions = options as WFSDataSourceOptions;\r\n\r\n  let olFormatCls;\r\n  const outputFormat = wfsOptions.paramsWFS.outputFormat\r\n    ? wfsOptions.paramsWFS.outputFormat\r\n    : undefined;\r\n\r\n  if (!outputFormat) {\r\n    olFormatCls = OlFormat.WFS;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  }\r\n\r\n  if (OlFormat[outputFormat]) {\r\n    olFormatCls = OlFormat[outputFormat];\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('gml2')) {\r\n    olFormatCls = OlFormat.WFS;\r\n    return new olFormatCls({ ...wfsOptions.formatOptions, ...{ gmlFormat: olFormatGML2 }});\r\n  } else if (outputFormat.toLowerCase().match('gml32')) {\r\n    olFormatCls = OlFormat.WFS;\r\n    return new olFormatCls({ ...wfsOptions.formatOptions, ...{ gmlFormat: olFormatGML32 }});\r\n  } else if (outputFormat.toLowerCase().match('gml3')) {\r\n    olFormatCls = OlFormat.WFS;\r\n    return new olFormatCls({ ...wfsOptions.formatOptions, ...{ gmlFormat: olFormatGML3 }});\r\n  } else if (outputFormat.toLowerCase().match('topojson')) {\r\n    olFormatCls = OlFormat.TopoJSON;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('geojson')) {\r\n    olFormatCls = OlFormat.GeoJSON;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('esrijson')) {\r\n    olFormatCls = OlFormat.EsriJSON;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('json')) {\r\n    olFormatCls = OlFormat.GeoJSON;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('gpx')) {\r\n    olFormatCls = OlFormat.GPX;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('WKT')) {\r\n    olFormatCls = OlFormat.WKT;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('osmxml')) {\r\n    olFormatCls = olFormatOSMXML;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  } else if (outputFormat.toLowerCase().match('kml')) {\r\n    olFormatCls = OlFormat.KML;\r\n    return new olFormatCls(wfsOptions.formatOptions);\r\n  }\r\n\r\n  return new olFormatCls();\r\n}\r\n","import olSourceImageWMS from 'ol/source/ImageWMS';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { Legend } from './datasource.interface';\r\nimport { WMSDataSourceOptions } from './wms-datasource.interface';\r\nimport { WFSService } from './wfs.service';\r\n\r\nimport { OgcFilterWriter } from '../../../filter/shared/ogc-filter';\r\nimport { OgcFilterableDataSourceOptions, OgcFiltersOptions, OgcFilterDuringOptions } from '../../../filter/shared/ogc-filter.interface';\r\nimport { QueryHtmlTarget } from '../../../query/shared/query.enums';\r\nimport {\r\n  formatWFSQueryString,\r\n  checkWfsParams,\r\n  defaultFieldNameGeometry\r\n} from './wms-wfs.utils';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\nimport { LegendMapViewOptions } from '../../../layer/shared/layers/layer.interface';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport { TimeFilterableDataSourceOptions, TimeFilterOptions } from '../../../filter/shared/time-filter.interface';\r\n\r\nexport class WMSDataSource extends DataSource {\r\n  public ol: olSourceImageWMS;\r\n\r\n  get params(): any {\r\n    return this.options.params as any;\r\n  }\r\n\r\n  get queryTitle(): string {\r\n    return (this.options as any).queryTitle\r\n      ? (this.options as any).queryTitle\r\n      : 'title';\r\n  }\r\n\r\n  get mapLabel(): string {\r\n    return (this.options as any).mapLabel;\r\n  }\r\n\r\n  get queryHtmlTarget(): string {\r\n    return (this.options as any).queryHtmlTarget\r\n      ? (this.options as any).queryHtmlTarget\r\n      : QueryHtmlTarget.BLANK;\r\n  }\r\n\r\n  set ogcFilters(value: OgcFiltersOptions) {\r\n    (this.options as OgcFilterableDataSourceOptions).ogcFilters = value;\r\n  }\r\n  get ogcFilters(): OgcFiltersOptions {\r\n    return (this.options as OgcFilterableDataSourceOptions).ogcFilters;\r\n  }\r\n\r\n  readonly ogcFilters$: BehaviorSubject<OgcFiltersOptions> = new BehaviorSubject(undefined);\r\n\r\n  set timeFilter(value: TimeFilterOptions ) {\r\n    (this.options as TimeFilterableDataSourceOptions).timeFilter = value;\r\n  }\r\n  get timeFilter(): TimeFilterOptions {\r\n    return (this.options as TimeFilterableDataSourceOptions).timeFilter;\r\n  }\r\n  readonly timeFilter$: BehaviorSubject<TimeFilterOptions> = new BehaviorSubject(undefined);\r\n\r\n  constructor(\r\n    public options: WMSDataSourceOptions,\r\n    protected wfsService: WFSService\r\n  ) {\r\n    super(options);\r\n    const sourceParams: any = options.params;\r\n\r\n    const dpi = sourceParams.DPI || 96;\r\n    sourceParams.DPI = dpi;\r\n    sourceParams.MAP_RESOLUTION = dpi;\r\n    sourceParams.FORMAT_OPTIONS = 'dpi:' + dpi;\r\n\r\n    if (options.refreshIntervalSec && options.refreshIntervalSec > 0) {\r\n      setInterval(() => {\r\n        this.refresh();\r\n      }, options.refreshIntervalSec * 1000); // Convert seconds to MS\r\n    }\r\n\r\n    let fieldNameGeometry = defaultFieldNameGeometry;\r\n\r\n    // ####   START if paramsWFS\r\n    if (options.paramsWFS) {\r\n      const wfsCheckup = checkWfsParams(options, 'wms');\r\n      ObjectUtils.mergeDeep(options.paramsWFS, wfsCheckup.paramsWFS);\r\n\r\n      fieldNameGeometry =\r\n        options.paramsWFS.fieldNameGeometry || fieldNameGeometry;\r\n\r\n      options.download = Object.assign({}, options.download, {\r\n        dynamicUrl: this.buildDynamicDownloadUrlFromParamsWFS(options)\r\n      });\r\n    } //  ####   END  if paramsWFS\r\n\r\n    if (!options.sourceFields || options.sourceFields.length === 0) {\r\n      options.sourceFields = [];\r\n    } else {\r\n      options.sourceFields.forEach(sourceField => {\r\n        sourceField.alias = sourceField.alias\r\n          ? sourceField.alias\r\n          : sourceField.name;\r\n        // to allow only a list of sourcefield with names\r\n      });\r\n    }\r\n    const initOgcFilters = (options as OgcFilterableDataSourceOptions)\r\n      .ogcFilters;\r\n    const ogcFilterWriter = new OgcFilterWriter();\r\n\r\n    if (!initOgcFilters) {\r\n      (options as OgcFilterableDataSourceOptions).ogcFilters = ogcFilterWriter.defineOgcFiltersDefaultOptions(\r\n        initOgcFilters,\r\n        fieldNameGeometry,\r\n        'wms'\r\n      );\r\n    } else {\r\n      initOgcFilters.advancedOgcFilters = (initOgcFilters.pushButtons || initOgcFilters.checkboxes\r\n        || initOgcFilters.radioButtons || initOgcFilters.select || initOgcFilters.autocomplete)\r\n        ? false\r\n        : true;\r\n      if (initOgcFilters.advancedOgcFilters && initOgcFilters.filters) {\r\n          const filterDuring = initOgcFilters.filters as OgcFilterDuringOptions;\r\n          if(filterDuring.calendarModeYear) {\r\n            initOgcFilters.advancedOgcFilters = false;\r\n          }\r\n      }\r\n      if (initOgcFilters.pushButtons){\r\n        initOgcFilters.pushButtons.selectorType = 'pushButton';\r\n      }\r\n      if (initOgcFilters.checkboxes){\r\n        initOgcFilters.checkboxes.selectorType = 'checkbox';\r\n      }\r\n      if (initOgcFilters.radioButtons){\r\n        initOgcFilters.radioButtons.selectorType = 'radioButton';\r\n      }\r\n      if (initOgcFilters.select){\r\n        initOgcFilters.select.selectorType = 'select';\r\n      }\r\n      if (initOgcFilters.autocomplete){\r\n        initOgcFilters.autocomplete.selectorType = 'autocomplete';\r\n      }\r\n    }\r\n\r\n    if (\r\n      sourceParams.LAYERS.split(',').length > 1 &&\r\n      initOgcFilters &&\r\n      initOgcFilters.enabled\r\n    ) {\r\n      console.log('*******************************');\r\n      console.log(\r\n        'BE CAREFULL, YOUR WMS LAYERS (' +\r\n          sourceParams.LAYERS +\r\n          ') MUST SHARE THE SAME FIELDS TO ALLOW ogcFilters TO WORK !! '\r\n      );\r\n      console.log('*******************************');\r\n    }\r\n\r\n    if (\r\n      options.paramsWFS &&\r\n      initOgcFilters &&\r\n      initOgcFilters.enabled &&\r\n      initOgcFilters.editable &&\r\n      (options.sourceFields || []).filter(sf => !sf.values).length > 0) {\r\n      this.wfsService.getSourceFieldsFromWFS(options);\r\n    }\r\n\r\n    const filterQueryString = ogcFilterWriter.handleOgcFiltersAppliedValue(\r\n      options,\r\n      fieldNameGeometry\r\n    );\r\n    sourceParams.FILTER = filterQueryString;\r\n    this.setOgcFilters(initOgcFilters, true);\r\n\r\n    const timeFilterableDataSourceOptions = (options as TimeFilterableDataSourceOptions);\r\n    if (\r\n      timeFilterableDataSourceOptions?.timeFilterable &&\r\n      timeFilterableDataSourceOptions?.timeFilter) {\r\n      this.setTimeFilter(timeFilterableDataSourceOptions.timeFilter, true);\r\n    }\r\n  }\r\n\r\n  refresh() {\r\n    this.ol.updateParams({ igoRefresh: Math.random() });\r\n  }\r\n\r\n  private buildDynamicDownloadUrlFromParamsWFS(asWFSDataSourceOptions) {\r\n    const queryStringValues = formatWFSQueryString(asWFSDataSourceOptions);\r\n    const downloadUrl = queryStringValues.find(f => f.name === 'getfeature')\r\n      .value;\r\n    return downloadUrl;\r\n  }\r\n\r\n  protected createOlSource(): olSourceImageWMS {\r\n    return new olSourceImageWMS(Object.assign({ratio: 1}, this.options));\r\n  }\r\n\r\n  setOgcFilters(ogcFilters: OgcFiltersOptions, triggerEvent: boolean = false) {\r\n    this.ogcFilters = ogcFilters;\r\n    if (triggerEvent) {\r\n      this.ogcFilters$.next(this.ogcFilters);\r\n    }\r\n  }\r\n\r\n  setTimeFilter(timeFilter: TimeFilterOptions, triggerEvent: boolean = false) {\r\n    this.timeFilter = timeFilter;\r\n    if (triggerEvent) {\r\n      this.timeFilter$.next(this.timeFilter);\r\n    }\r\n  }\r\n\r\n  getLegend(style?: string, view?: LegendMapViewOptions): Legend[] {\r\n    let legend = super.getLegend();\r\n    if (legend.length > 0 && (style === undefined && !view?.scale)) {\r\n      return legend;\r\n    }\r\n\r\n    let contentDependent = false;\r\n    let projParam;\r\n\r\n    if (view?.size && view?.extent && view?.projection && this.options.contentDependentLegend) {\r\n      projParam = this.params.VERSION === '1.3.0' || this.params.VERSION === undefined ? 'CRS' : 'SRS';\r\n      contentDependent = true;\r\n    }\r\n\r\n    const sourceParams = this.params;\r\n\r\n    let layers = [];\r\n    if (sourceParams.LAYERS !== undefined) {\r\n      layers = sourceParams.LAYERS.split(',');\r\n    }\r\n\r\n    const baseUrl = this.options.url.replace(/\\?$/, '');\r\n    const params = [\r\n      'REQUEST=GetLegendGraphic',\r\n      'SERVICE=WMS',\r\n      'FORMAT=image/png',\r\n      'SLD_VERSION=1.1.0',\r\n      `VERSION=${sourceParams.VERSION || '1.3.0'}`\r\n    ];\r\n    if (style !== undefined) {\r\n      params.push(`STYLE=${style}`);\r\n    }\r\n    if (view?.scale !== undefined) {\r\n      params.push(`SCALE=${view.scale}`);\r\n    }\r\n    if (contentDependent) {\r\n      params.push(`WIDTH=${view.size[0]}`);\r\n      params.push(`HEIGHT=${view.size[1]}`);\r\n      params.push(`BBOX=${view.extent.join(',')}`);\r\n      params.push(`${projParam}=${view.projection}`);\r\n    }\r\n\r\n    legend = layers.map((layer: string) => {\r\n      const separator = baseUrl.match(/\\?/) ? '&' : '?';\r\n      return {\r\n        url: `${baseUrl}${separator}${params.join('&')}&LAYER=${layer}`,\r\n        title: layers.length > 1 ? layer : undefined,\r\n        currentStyle: style === undefined ? undefined : style as string\r\n      };\r\n    });\r\n\r\n    return legend;\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import { Watcher } from '@igo2/utils';\r\nimport { Layer } from '../shared/layers/layer';\r\nimport olLayer from 'ol/layer/Layer';\r\nimport olSource from 'ol/source/Source';\r\nimport { DataSource } from '../../datasource/shared/datasources/datasource';\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { LayersLink, LinkedProperties } from '../shared/layers/layer.interface';\r\nimport { OgcFilterableDataSource, OgcFilterableDataSourceOptions } from '../../filter/shared/ogc-filter.interface';\r\nimport { WMSDataSource } from '../../datasource/shared/datasources/wms-datasource';\r\nimport { OgcFilterWriter } from '../../filter/shared/ogc-filter';\r\nimport { TimeFilterableDataSource } from '../../filter/shared/time-filter.interface';\r\nimport { Subscription } from 'rxjs';\r\nimport { first } from 'rxjs/operators';\r\nimport olSourceImageWMS from 'ol/source/ImageWMS';\r\n\r\nexport class LayerSyncWatcher extends Watcher {\r\n    private ogcFilters$$: Subscription;\r\n    private timeFilter$$: Subscription;\r\n\r\n    private ol: olLayer<olSource>;\r\n    private layer: Layer;\r\n    private dataSource: DataSource;\r\n    private map: IgoMap;\r\n    private ogcFilterWriter;\r\n\r\n    constructor(layer: Layer, map: IgoMap) {\r\n        super();\r\n        this.ol = layer.ol;\r\n        this.layer = layer;\r\n        this.dataSource = layer.options.source;\r\n        this.map = map;\r\n        this.ogcFilterWriter = new OgcFilterWriter();\r\n    }\r\n\r\n    protected watch() {\r\n\r\n        this.ol.on('propertychange', evt => this.transferCommonProperties(evt));\r\n        if ((this.dataSource as OgcFilterableDataSource).ogcFilters$) {\r\n            this.ogcFilters$$ = (this.dataSource as OgcFilterableDataSource).ogcFilters$\r\n                .subscribe(ogcFilters => this.transferOgcFiltersProperties(ogcFilters));\r\n        }\r\n        if ((this.dataSource as TimeFilterableDataSource).timeFilter$) {\r\n            this.timeFilter$$ = (this.dataSource as TimeFilterableDataSource).timeFilter$\r\n                .subscribe(timeFilter => this.transferTimeFilterProperties(timeFilter));\r\n        }\r\n        this.syncChildLayers();\r\n    }\r\n\r\n    protected unwatch() {\r\n        this.ol.un('propertychange', evt => this.transferCommonProperties(evt));\r\n        if (this.ogcFilters$$) { this.ogcFilters$$.unsubscribe(); }\r\n        if (this.timeFilter$$) { this.timeFilter$$.unsubscribe(); }\r\n    }\r\n\r\n\r\n    private syncChildLayers() {\r\n        // Force the sync the child layers with parent on the first load.\r\n        if (!this.map) {\r\n            return;\r\n        }\r\n        this.map.status$\r\n            .pipe(first())\r\n            .subscribe(() => {\r\n                this.map.layers\r\n                    .filter(layer => layer.options.linkedLayers?.links)\r\n                    .map(layer => {\r\n                        layer.options.linkedLayers.links.map(link => {\r\n                            if (link.properties?.indexOf(LinkedProperties.VISIBLE) !== -1) {\r\n                                layer.ol.set('visible', !(layer.visible), false);\r\n                                layer.ol.set('visible', !(layer.visible), false);\r\n                                layer.visible = layer.visible;\r\n                            }\r\n                            if (link.properties?.indexOf(LinkedProperties.OPACITY) !== -1) {\r\n                                const baseOpacity = layer.ol.get('opacity');\r\n                                layer.ol.set('opacity', 0, false);\r\n                                layer.ol.set('opacity', baseOpacity, false);\r\n                                layer.opacity = layer.opacity;\r\n                            }\r\n                            if (link.properties?.indexOf(LinkedProperties.MINRESOLUTION) !== -1) {\r\n                                const baseMinResolution = layer.ol.get('minResolution');\r\n                                layer.ol.set('minResolution', 0, false);\r\n                                layer.ol.set('minResolution', baseMinResolution, false);\r\n                                layer.minResolution = layer.minResolution;\r\n                            }\r\n                            if (link.properties?.indexOf(LinkedProperties.MAXRESOLUTION) !== -1) {\r\n                                const baseMaxResolution = layer.ol.get('maxResolution');\r\n                                layer.ol.set('maxResolution', 0, false);\r\n                                layer.ol.set('maxResolution', baseMaxResolution, false);\r\n                                layer.minResolution = layer.minResolution;\r\n                            }\r\n                            if (link.properties?.indexOf(LinkedProperties.OGCFILTERS) !== -1) {\r\n                                const ogcFilters$ = (layer.dataSource as OgcFilterableDataSource).ogcFilters$;\r\n                                ogcFilters$.next(ogcFilters$.value);\r\n                            }\r\n                            if (link.properties?.indexOf(LinkedProperties.TIMEFILTER) !== -1) {\r\n                                const timeFilter$ = (layer.dataSource as TimeFilterableDataSource).timeFilter$;\r\n                                timeFilter$.next(timeFilter$.value);\r\n                            }\r\n                        });\r\n                    });\r\n            });\r\n    }\r\n\r\n    private transferCommonProperties(layerChange) {\r\n        const key = layerChange.key;\r\n        const layerChangeProperties = layerChange.target.getProperties();\r\n        const newValue = layerChangeProperties[key];\r\n\r\n        if (['visible', 'opacity', 'minResolution', 'maxResolution'].indexOf(key) === -1) {\r\n            return;\r\n        }\r\n        const linkedLayers = layerChangeProperties.linkedLayers as LayersLink;\r\n        if (!linkedLayers) {\r\n            return;\r\n        }\r\n        const currentLinkedId = linkedLayers.linkId;\r\n        const currentLinks = linkedLayers.links;\r\n        const isParentLayer = currentLinks ? true : false;\r\n\r\n        if (isParentLayer) {\r\n            // search for child layers\r\n            const silent = true;\r\n            currentLinks.map(link => {\r\n                if (!link.properties || link.properties.indexOf(key) === -1) {\r\n                    return;\r\n                }\r\n                link.linkedIds.map(linkedId => {\r\n                    const layerToApply = this.map.layers.find(layer => layer.options.linkedLayers?.linkId === linkedId);\r\n                    if (layerToApply) {\r\n                        layerToApply.ol.set(key, newValue, silent);\r\n                        if (key === 'visible') {\r\n                            layerToApply.visible$.next(newValue);\r\n                        }\r\n                    }\r\n                });\r\n            });\r\n        } else {\r\n            // search for parent layer\r\n            const silent = false;\r\n            this.map.layers.map(layer => {\r\n                if (layer.options.linkedLayers?.links) {\r\n                    layer.options.linkedLayers.links.map(l => {\r\n                        if (l.properties && l.properties.indexOf(key) !== -1 &&\r\n                            l.bidirectionnal !== false && l.linkedIds.indexOf(currentLinkedId) !== -1) {\r\n                            layer.ol.set(key, newValue, silent);\r\n                            if (key === 'visible') {\r\n                                layer.visible$.next(newValue);\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n            });\r\n        }\r\n    }\r\n\r\n    private transferOgcFiltersProperties(ogcFilters) {\r\n        const linkedLayers = this.ol.getProperties().linkedLayers as LayersLink;\r\n        if (!linkedLayers) {\r\n            return;\r\n        }\r\n        const currentLinkedId = linkedLayers.linkId;\r\n        const currentLinks = linkedLayers.links;\r\n        const isParentLayer = currentLinks ? true : false;\r\n        if (isParentLayer) {\r\n            // search for child layers\r\n            currentLinks.map(link => {\r\n                if (!link.properties || link.properties.indexOf(LinkedProperties.OGCFILTERS) === -1) {\r\n                    return;\r\n                }\r\n                link.linkedIds.map(linkedId => {\r\n                    const layerToApply = this.map.layers.find(layer => layer.options.linkedLayers?.linkId === linkedId);\r\n                    if (layerToApply) {\r\n                        const layerType = layerToApply.ol.getProperties().sourceOptions.type;\r\n                        (layerToApply.dataSource as OgcFilterableDataSource).setOgcFilters(ogcFilters, false);\r\n                        if (layerType === 'wfs') {\r\n                            layerToApply.ol.getSource().refresh();\r\n                        }\r\n                        if (layerType === 'wms') {\r\n                            let appliedOgcFilter;\r\n                            if (this.ol.getProperties().sourceOptions.type === 'wfs') {\r\n                                appliedOgcFilter = this.ogcFilterWriter.handleOgcFiltersAppliedValue(\r\n                                    this.layer.dataSource.options as OgcFilterableDataSourceOptions,\r\n                                    (this.dataSource.options as any).fieldNameGeometry,\r\n                                    undefined,\r\n                                    this.map.viewController.getOlProjection()\r\n                                );\r\n                            } else if (this.ol.getProperties().sourceOptions.type === 'wms') {\r\n                                appliedOgcFilter = (this.dataSource as WMSDataSource).ol.getParams().FILTER;\r\n                            }\r\n                            (layerToApply.dataSource as WMSDataSource).ol.updateParams({ FILTER: appliedOgcFilter });\r\n                        }\r\n                    }\r\n                });\r\n            });\r\n        } else {\r\n            // search for parent layer\r\n            this.map.layers.map(layer => {\r\n                if (layer.options.linkedLayers?.links) {\r\n                    layer.options.linkedLayers.links.map(l => {\r\n                        if (l.properties && l.properties.indexOf(LinkedProperties.OGCFILTERS) !== -1 &&\r\n                            l.bidirectionnal !== false && l.linkedIds.indexOf(currentLinkedId) !== -1) {\r\n                            const layerType = layer.ol.getProperties().sourceOptions.type;\r\n                            if (layerType === 'wfs') {\r\n                                (layer.dataSource as OgcFilterableDataSource).setOgcFilters(ogcFilters, true);\r\n                                layer.ol.getSource().refresh();\r\n                            }\r\n                            if (layerType === 'wms') {\r\n                                let appliedOgcFilter;\r\n                                if (this.ol.getProperties().sourceOptions.type === 'wfs') {\r\n                                    appliedOgcFilter = this.ogcFilterWriter.handleOgcFiltersAppliedValue(\r\n                                        layer.dataSource.options as OgcFilterableDataSourceOptions,\r\n                                        (this.dataSource.options as any).fieldNameGeometry,\r\n                                        undefined,\r\n                                        this.map.viewController.getOlProjection()\r\n                                    );\r\n\r\n                                } else if (this.ol.getProperties().sourceOptions.type === 'wms') {\r\n                                    appliedOgcFilter = (this.dataSource as WMSDataSource).ol.getParams().FILTER;\r\n                                }\r\n                                (layer.dataSource as WMSDataSource).ol.updateParams({ FILTER: appliedOgcFilter });\r\n                                (layer.dataSource as OgcFilterableDataSource).setOgcFilters(ogcFilters, true);\r\n                            }\r\n                        }\r\n                    });\r\n                }\r\n            });\r\n        }\r\n    }\r\n\r\n    private transferTimeFilterProperties(timeFilter) {\r\n        const linkedLayers = this.ol.getProperties().linkedLayers as LayersLink;\r\n        if (!linkedLayers) {\r\n            return;\r\n        }\r\n        const currentLinkedId = linkedLayers.linkId;\r\n        const currentLinks = linkedLayers.links;\r\n        const isParentLayer = currentLinks ? true : false;\r\n        if (isParentLayer) {\r\n            // search for child layers\r\n            currentLinks.map(link => {\r\n                if (!link.properties || link.properties.indexOf(LinkedProperties.TIMEFILTER) === -1) {\r\n                    return;\r\n                }\r\n                link.linkedIds.map(linkedId => {\r\n                    const childLayer = this.map.layers.find(layer =>\r\n                        layer.dataSource instanceof WMSDataSource &&\r\n                        layer.options.linkedLayers?.linkId === linkedId);\r\n                    if (childLayer) {\r\n                        (childLayer.dataSource as TimeFilterableDataSource).setTimeFilter(timeFilter, false);\r\n                        const appliedTimeFilter = (this.ol.getSource() as olSourceImageWMS).getParams().TIME;\r\n                        (childLayer.dataSource as WMSDataSource).ol.updateParams({ TIME: appliedTimeFilter });\r\n                    }\r\n                });\r\n            });\r\n        } else {\r\n            // search for parent layer\r\n            this.map.layers\r\n                .filter(layer => layer.dataSource instanceof WMSDataSource)\r\n                .map(parentLayer => {\r\n                    if (parentLayer.options.linkedLayers?.links) {\r\n                        parentLayer.options.linkedLayers.links.map(l => {\r\n                            if (l.properties && l.properties.indexOf(LinkedProperties.TIMEFILTER) !== -1 &&\r\n                                l.bidirectionnal !== false && l.linkedIds.indexOf(currentLinkedId) !== -1) {\r\n                                const appliedTimeFilter = (this.ol.getSource() as olSourceImageWMS).getParams().TIME;\r\n                                (parentLayer.dataSource as WMSDataSource).ol.updateParams({ TIME: appliedTimeFilter });\r\n                                (parentLayer.dataSource as TimeFilterableDataSource).setTimeFilter(timeFilter, true);\r\n                            }\r\n                        });\r\n                    }\r\n                });\r\n        }\r\n    }\r\n}\r\n","import olSourceTile from 'ol/source/Tile';\r\nimport { uuid, Watcher, SubjectStatus } from '@igo2/utils';\r\n\r\nimport { TileLayer } from '../shared/layers/tile-layer';\r\nimport { VectorTileLayer } from '../shared/layers/vectortile-layer';\r\n\r\nexport class TileWatcher extends Watcher {\r\n  private id: string;\r\n  private loaded = 0;\r\n  private loading = 0;\r\n\r\n  private source: olSourceTile;\r\n\r\n  constructor(layer: TileLayer | VectorTileLayer) {\r\n    super();\r\n    this.source = layer.options.source.ol;\r\n    this.id = uuid();\r\n  }\r\n\r\n  protected watch() {\r\n    this.source.on(`tileloadstart`, e => this.handleLoadStart(e));\r\n    this.source.on(`tileloadend`, e => this.handleLoadEnd(e));\r\n    this.source.on(`tileloaderror`, e => this.handleLoadEnd(e));\r\n  }\r\n\r\n  protected unwatch() {\r\n    this.source.un(`tileloadstart`, e => this.handleLoadStart(e));\r\n    this.source.un(`tileloadend`, e => this.handleLoadEnd(e));\r\n    this.source.un(`tileloaderror`, e => this.handleLoadEnd(e));\r\n  }\r\n\r\n  private handleLoadStart(event: any) {\r\n    // This is to avoid increasing\r\n    // the number of loaded tiles if a tile was loading\r\n    // before subscribing to this watcher\r\n    if (!event.tile.__watchers__) {\r\n      event.tile.__watchers__ = [];\r\n    }\r\n    event.tile.__watchers__.push(this.id);\r\n\r\n    this.loading += 1;\r\n    this.status = SubjectStatus.Working;\r\n  }\r\n\r\n  private handleLoadEnd(event) {\r\n    if (!event.tile.__watchers__) {\r\n      return;\r\n    }\r\n\r\n    const watcherIndex = event.tile.__watchers__.indexOf(this.id);\r\n    if (watcherIndex < 0) {\r\n      return;\r\n    }\r\n\r\n    event.tile.__watchers__.splice(watcherIndex, 1);\r\n\r\n    this.loaded += 1;\r\n\r\n    const loading = this.loading;\r\n    if (this.loaded >= loading) {\r\n      if (loading === this.loading) {\r\n        this.status = SubjectStatus.Done;\r\n        this.loaded = this.loading = 0;\r\n      }\r\n    }\r\n  }\r\n}\r\n","import olSourceVector from 'ol/source/Vector';\r\nimport * as olformat from 'ol/format';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { FeatureDataSourceOptions } from './feature-datasource.interface';\r\n\r\nexport class FeatureDataSource extends DataSource {\r\n  public options: FeatureDataSourceOptions;\r\n  public ol: olSourceVector<OlGeometry>;\r\n  protected createOlSource(): olSourceVector<OlGeometry> {\r\n    const sourceOptions = {\r\n      format: this.getSourceFormatFromOptions(this.options)\r\n    };\r\n\r\n    return new olSourceVector(Object.assign(sourceOptions, this.options));\r\n  }\r\n\r\n  protected getSourceFormatFromOptions(options: FeatureDataSourceOptions) {\r\n    if (options.format) {\r\n      return options.format;\r\n    }\r\n    let olFormatCls;\r\n    const formatType = options.formatType;\r\n    if (!formatType) {\r\n      olFormatCls = olformat.GeoJSON;\r\n    } else {\r\n      olFormatCls = olformat[formatType];\r\n      if (olFormatCls === undefined) {\r\n        throw new Error('Invalid vector source format ${formatType}.');\r\n      }\r\n    }\r\n\r\n    const formatOptions = options.formatOptions;\r\n    let format;\r\n    if (formatOptions) {\r\n      format = new olFormatCls(formatOptions);\r\n    } else {\r\n      format = new olFormatCls();\r\n    }\r\n\r\n    return format;\r\n  }\r\n\r\n  public onUnwatch() {}\r\n\r\n  get queryTitle(): string {\r\n    return (this.options as any).queryTitle\r\n      ? (this.options as any).queryTitle\r\n      : 'title';\r\n  }\r\n}\r\n","import olSourceCluster from 'ol/source/Cluster';\r\n\r\nimport { uuid } from '@igo2/utils';\r\n\r\nimport { FeatureDataSource } from './feature-datasource';\r\nimport { ClusterDataSourceOptions } from './cluster-datasource.interface';\r\n\r\nexport class ClusterDataSource extends FeatureDataSource {\r\n  public options: ClusterDataSourceOptions;\r\n  public ol: olSourceCluster;\r\n\r\n  protected createOlSource(): olSourceCluster {\r\n    this.options.format = this.getSourceFormatFromOptions(this.options);\r\n    this.options.source = super.createOlSource();\r\n    return new olSourceCluster(this.options);\r\n  }\r\n\r\n  protected generateId() {\r\n    return uuid();\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import { uuid, Watcher, SubjectStatus } from '@igo2/utils';\r\n\r\nimport { VectorLayer } from '../shared/layers/vector-layer';\r\nimport { ClusterDataSource } from '../../datasource/shared/datasources/cluster-datasource';\r\n\r\nexport class VectorWatcher extends Watcher {\r\n  private id: string;\r\n  private loaded = 0;\r\n  private loading = 0;\r\n\r\n  private layer: VectorLayer;\r\n\r\n  constructor(layer: VectorLayer) {\r\n    super();\r\n    this.layer = layer;\r\n    this.id = uuid();\r\n  }\r\n\r\n  protected watch() {\r\n    let olSource = this.layer.options.source.ol;\r\n    if (this.layer.dataSource instanceof ClusterDataSource) {\r\n      olSource = (this.layer.options.source.options as any).source;\r\n     }\r\n\r\n    if (olSource.getUrl()) {\r\n      olSource.on(`featuresloadstart`, e => this.handleLoadStart(e));\r\n      olSource.on(`featuresloadend`, e => this.handleLoadEnd(e));\r\n      olSource.on(`featuresloaderror`, e => this.handleLoadEnd(e));\r\n    }\r\n\r\n  }\r\n\r\n  protected unwatch() {\r\n    let olSource = this.layer.options.source.ol;\r\n    if (this.layer.dataSource instanceof ClusterDataSource) {\r\n      olSource = (this.layer.options.source.options as any).source;\r\n     }\r\n    if (olSource.getUrl()) {\r\n      olSource.un(`featuresloadstart`, e => this.handleLoadStart(e));\r\n      olSource.un(`featuresloadend`, e => this.handleLoadEnd(e));\r\n      olSource.un(`featuresloaderror`, e => this.handleLoadEnd(e));\r\n    }\r\n  }\r\n\r\n  private handleLoadStart(event: any) {\r\n    this.loading += 1;\r\n    this.status = SubjectStatus.Working;\r\n  }\r\n\r\n  private handleLoadEnd(event: any) {\r\n    this.loaded += 1;\r\n\r\n    const loading = this.loading;\r\n    if (this.loaded >= loading) {\r\n      if (loading === this.loading) {\r\n        this.status = SubjectStatus.Done;\r\n        this.loaded = this.loading = 0;\r\n      }\r\n    }\r\n  }\r\n}\r\n","import * as olproj from 'ol/proj';\r\nimport MapBrowserPointerEvent from 'ol/MapBrowserEvent';\r\nimport { MAC } from 'ol/has';\r\n\r\nimport { NumberUtils } from '@igo2/utils';\r\n\r\nimport { MapViewState } from './map.interface';\r\nimport { Projection } from './projection.interfaces';\r\n\r\n/**\r\n * This method extracts a coordinate tuple from a string.\r\n * @param str Any string\r\n * @param mapProjection string Map Projection\r\n * @param opts.forceNA boolean Force North America Zone\r\n * @returns object:\r\n *             lonLat: Coordinate,\r\n *             message: Message of error,\r\n *             radius: radius of the confience of coordinate,\r\n *             conf: confidence of the coordinate}\r\n */\r\nexport function stringToLonLat(\r\n  str: string,\r\n  mapProjection: string,\r\n  opts: { forceNA?: boolean } = {}\r\n): {\r\n  lonLat: [number, number] | undefined;\r\n  message: string;\r\n  radius: number | undefined;\r\n  conf: number | undefined;\r\n} {\r\n  let lonLat: [number, number];\r\n  let coordStr: string;\r\n  let negativeLon: string;\r\n  let degreesLon: string;\r\n  let minutesLon: string;\r\n  let secondsLon: string;\r\n  let directionLon: string;\r\n  let decimalLon: string;\r\n  let negativeLat: string;\r\n  let degreesLat: string;\r\n  let minutesLat: string;\r\n  let secondsLat: string;\r\n  let directionLat: string;\r\n  let decimalLat: string;\r\n  let zone: string;\r\n  let radius: string;\r\n  let conf: string;\r\n  let lon: any;\r\n  let lat: any;\r\n\r\n  const projectionPattern = '(\\\\s*;\\\\s*[\\\\d]{4,6})';\r\n  const toProjection = '4326';\r\n  let projectionStr: string;\r\n  const projectionRegex = new RegExp(projectionPattern, 'g');\r\n\r\n  const lonlatCoord = '([-+])?([\\\\d]{1,3})([,.](\\\\d+))?';\r\n  const lonLatPattern = `${lonlatCoord}[\\\\s,]+${lonlatCoord}`;\r\n  const lonLatRegex = new RegExp(`^${lonLatPattern}$`, 'g');\r\n\r\n  const dmsCoord =\r\n    '([0-9]{1,2})[:|]?\\\\s*([0-9]{1,2})?[:|\\'||]?\\\\s*([0-9]{1,2}(?:.[0-9]+){0,1})?\\\\s*[\"||]?\\\\s*';\r\n  const dmsCoordPattern = `${dmsCoord}([N|S|E|W|O]),?\\\\s*${dmsCoord}([N|S|E|W|O])`;\r\n  const dmsRegex = new RegExp(`^${dmsCoordPattern}$`, 'gi');\r\n\r\n  const patternUtm =\r\n    '(UTM)-?(\\\\d{1,2})[\\\\s,]*(\\\\d+[.,]?\\\\d+)[\\\\s,]+(\\\\d+[.,]?\\\\d+)';\r\n  const utmRegex = new RegExp(`^${patternUtm}`, 'gi');\r\n\r\n  const patternMtm =\r\n    '(MTM)-?(\\\\d{1,2})[\\\\s,]*(\\\\d+[.,]?\\\\d+)[\\\\s,]+(\\\\d+[.,]?\\\\d+)';\r\n  const mtmRegex = new RegExp(`^${patternMtm}`, 'gi');\r\n\r\n  const ddCoord = '([-+])?(\\\\d{1,3})[,.](\\\\d+)';\r\n  const patternDd = `${ddCoord}\\\\s*[,]?\\\\s*${ddCoord}`;\r\n  const ddRegex = new RegExp(`^${patternDd}`, 'g');\r\n\r\n  const dmdCoord =\r\n    '([-+])?(\\\\d{1,3})[\\\\s,.]{1}(\\\\d{1,2})[\\\\s,.]{1}(\\\\d{1,2})[.,]?(\\\\d{1,5})?';\r\n  const patternDmd = `${dmdCoord}\\\\s*[,.]?\\\\s*${dmdCoord}`;\r\n  const dmdRegex = new RegExp(`^${patternDmd}`, 'g');\r\n\r\n /* eslint-disable max-len */\r\n  const patternBELL =\r\n    'LAT\\\\s*[\\\\s:]*\\\\s*([-+])?(\\\\d{1,2})[\\\\s.,]?(\\\\d+)?[\\\\s.,]?\\\\s*(\\\\d{1,2}([.,]\\\\d+)?)?\\\\s*(N|S|E|W)?\\\\s*LONG\\\\s*[\\\\s:]*\\\\s*([-+])?(\\\\d{1,3})[\\\\s.,]?(\\\\d+)?[\\\\s.,]?\\\\s*(\\\\d{1,2}([.,]\\\\d+)?)?\\\\s*(N|S|E|W)?\\\\s*UNC\\\\s*[\\\\s:]?\\\\s*(\\\\d+)\\\\s*CONF\\\\s*[\\\\s:]?\\\\s*(\\\\d{1,3})';\r\n  const bellRegex = new RegExp(`^${patternBELL}?`, 'gi');\r\n\r\n  const mmCoord = '([-+]?\\\\d+)[,.]?(\\\\d+)?';\r\n  const mmPattern = `${mmCoord}[\\\\s,]+${mmCoord}`;\r\n  const mmRegex = new RegExp(`^${mmPattern}$`, 'g');\r\n\r\n  let isXYCoords = false;\r\n\r\n  str = str.toLocaleUpperCase().trim();\r\n\r\n  // Extract projection\r\n  if (projectionRegex.test(str)) {\r\n    [coordStr, projectionStr] = str.split(';').map(s => s.trim());\r\n  } else {\r\n    coordStr = str;\r\n  }\r\n  if (lonLatRegex.test(coordStr)) {\r\n    [\r\n      ,\r\n      negativeLon,\r\n      lon,\r\n      ,\r\n      decimalLon,\r\n      negativeLat,\r\n      lat,\r\n      ,\r\n      decimalLat\r\n    ] = coordStr.match(lonLatPattern);\r\n\r\n    lon = parseFloat((negativeLon ? negativeLon : '') + lon + '.' + decimalLon);\r\n    lat = parseFloat((negativeLat ? negativeLat : '') + lat + '.' + decimalLat);\r\n  } else if (dmsRegex.test(coordStr)) {\r\n    [\r\n      ,\r\n      degreesLon,\r\n      minutesLon,\r\n      secondsLon,\r\n      directionLon,\r\n      degreesLat,\r\n      minutesLat,\r\n      secondsLat,\r\n      directionLat\r\n    ] = coordStr.match(dmsCoordPattern);\r\n\r\n    if (directionLon === 'S' || directionLon === 'N') {\r\n      degreesLon = [degreesLat, (degreesLat = degreesLon)][0];\r\n      minutesLon = [minutesLat, (minutesLat = minutesLon)][0];\r\n      secondsLon = [secondsLat, (secondsLat = secondsLon)][0];\r\n      directionLon = [directionLat, (directionLat = directionLon)][0];\r\n    }\r\n\r\n    lon = convertDMSToDD(\r\n      parseFloat(degreesLon),\r\n      parseFloat(minutesLon),\r\n      parseFloat(secondsLon),\r\n      directionLon\r\n    );\r\n    lat = convertDMSToDD(\r\n      parseFloat(degreesLat),\r\n      parseFloat(minutesLat),\r\n      parseFloat(secondsLat),\r\n      directionLat\r\n    );\r\n  } else if (utmRegex.test(coordStr)) {\r\n    isXYCoords = true;\r\n    [, , zone, lon, lat] = coordStr.match(patternUtm);\r\n    const epsgUtm = Number(zone) < 10 ? `EPSG:3260${zone}` : `EPSG:326${zone}`;\r\n    [lon, lat] = olproj.transform(\r\n      [parseFloat(lon), parseFloat(lat)],\r\n      epsgUtm,\r\n      'EPSG:4326'\r\n    );\r\n  } else if (mtmRegex.test(coordStr)) {\r\n    isXYCoords = true;\r\n    [, , zone, lon, lat] = coordStr.match(patternMtm);\r\n    const epsgMtm =\r\n      Number(zone) < 10 ? `EPSG:3218${zone}` : `EPSG:321${80 + Number(zone)}`;\r\n    [lon, lat] = olproj.transform(\r\n      [parseFloat(lon), parseFloat(lat)],\r\n      epsgMtm,\r\n      'EPSG:4326'\r\n    );\r\n  } else if (dmdRegex.test(coordStr)) {\r\n    [\r\n      ,\r\n      negativeLon,\r\n      degreesLon,\r\n      minutesLon,\r\n      secondsLon,\r\n      decimalLon,\r\n      negativeLat,\r\n      degreesLat,\r\n      minutesLat,\r\n      secondsLat,\r\n      decimalLat\r\n    ] = coordStr.match(patternDmd);\r\n\r\n    lon = convertDMSToDD(\r\n      parseFloat((negativeLon ? negativeLon : '') + degreesLon),\r\n      parseFloat(minutesLon),\r\n      parseFloat(secondsLon),\r\n      directionLon\r\n    );\r\n    lat = convertDMSToDD(\r\n      parseFloat((negativeLat ? negativeLat : '') + degreesLat),\r\n      parseFloat(minutesLat),\r\n      parseFloat(secondsLat),\r\n      directionLat\r\n    );\r\n  } else if (ddRegex.test(coordStr)) {\r\n    [\r\n      ,\r\n      negativeLon,\r\n      degreesLon,\r\n      decimalLon,\r\n      negativeLat,\r\n      degreesLat,\r\n      decimalLat\r\n    ] = coordStr.match(patternDd);\r\n\r\n    lon = convertDMSToDD(\r\n      parseFloat((negativeLon ? negativeLon : '') + degreesLon),\r\n      parseFloat(minutesLon),\r\n      parseFloat(secondsLon),\r\n      directionLon\r\n    );\r\n    lat = convertDMSToDD(\r\n      parseFloat((negativeLat ? negativeLat : '') + degreesLat),\r\n      parseFloat(minutesLat),\r\n      parseFloat(secondsLat),\r\n      directionLat\r\n    );\r\n  } else if (bellRegex.test(coordStr)) {\r\n    [\r\n      ,\r\n      negativeLat,\r\n      degreesLat,\r\n      minutesLat,\r\n      secondsLat,\r\n      ,\r\n      directionLat,\r\n      negativeLon,\r\n      degreesLon,\r\n      minutesLon,\r\n      secondsLon,\r\n      ,\r\n      directionLon,\r\n      radius,\r\n      conf\r\n    ] = coordStr.match(patternBELL);\r\n\r\n    // Set default value for North America\r\n    if (!directionLon) {\r\n      directionLon = 'W';\r\n    }\r\n\r\n    // Check if real minutes or decimals\r\n    if (minutesLon && minutesLon.length > 2) {\r\n      lon = parseFloat(\r\n        (negativeLon ? negativeLon : '') + degreesLon + '.' + minutesLon\r\n      );\r\n    } else {\r\n      lon = convertDMSToDD(\r\n        parseFloat(degreesLon),\r\n        parseFloat(minutesLon),\r\n        parseFloat(secondsLon),\r\n        directionLon\r\n      );\r\n    }\r\n\r\n    if (minutesLat && minutesLat.length > 2) {\r\n      lat = parseFloat(\r\n        (negativeLat ? negativeLat : '') + degreesLat + '.' + minutesLat\r\n      );\r\n    } else {\r\n      lat = convertDMSToDD(\r\n        parseFloat(degreesLat),\r\n        parseFloat(minutesLat),\r\n        parseFloat(secondsLat),\r\n        directionLat\r\n      );\r\n    }\r\n  } else if (mmRegex.test(coordStr)) {\r\n    isXYCoords = true;\r\n    [, lon, decimalLon, lat, decimalLat] = coordStr.match(mmPattern);\r\n\r\n    if (decimalLon) {\r\n      lon = parseFloat(lon + '.' + decimalLon);\r\n    }\r\n\r\n    if (decimalLat) {\r\n      lat = parseFloat(lat + '.' + decimalLat);\r\n    }\r\n  } else {\r\n    return {\r\n      lonLat: undefined,\r\n      message: '',\r\n      radius: undefined,\r\n      conf: undefined\r\n    };\r\n  }\r\n\r\n  if (opts.forceNA && !isXYCoords) {\r\n    // Set a negative coordinate for North America zone\r\n    if (lon > 0 && lat > 0) {\r\n      if (lon > lat) {\r\n        lon = -lon;\r\n      } else {\r\n        lat = -lat;\r\n      }\r\n    }\r\n\r\n    // Reverse coordinate to respect lonLat convention\r\n    if (lon > lat) {\r\n      lon = [lat, (lat = lon)][0];\r\n    }\r\n  }\r\n\r\n  lonLat = [Number(lon), Number(lat)] as [number, number];\r\n\r\n  // Reproject the coordinate if projection parameter have been set and coord is not 4326\r\n  if (\r\n    (projectionStr !== undefined && projectionStr !== toProjection) ||\r\n    (lonLat[0] > 180 || lonLat[0] < -180) ||\r\n    (lonLat[1] > 90 || lonLat[1] < -90)\r\n  ) {\r\n    const source = projectionStr ? 'EPSG:' + projectionStr : mapProjection;\r\n    const dest = 'EPSG:' + toProjection;\r\n\r\n    try {\r\n      lonLat = olproj.transform(lonLat, source, dest) as [number, number];\r\n    } catch (e) {\r\n      return {\r\n        lonLat: undefined,\r\n        message: 'Projection ' + source + ' not supported',\r\n        radius: undefined,\r\n        conf: undefined\r\n      };\r\n    }\r\n  }\r\n  if (Math.abs(lonLat[0]) <= 180 && Math.abs(lonLat[1]) <= 90) {\r\n    return {\r\n      lonLat,\r\n      message: '',\r\n      radius: radius ? parseInt(radius, 10) : undefined,\r\n      conf: conf ? parseInt(conf, 10) : undefined\r\n    };\r\n  } else {\r\n    return {\r\n      lonLat: undefined,\r\n      message: 'Coordinate out of Longitude/Latitude bounds',\r\n      radius: undefined,\r\n      conf: undefined\r\n    };\r\n  }\r\n}\r\n\r\n/**\r\n * Convert degrees minutes seconds to dd\r\n * @param degrees Degrees\r\n * @param minutes Minutes\r\n * @param seconds Seconds\r\n * @param direction Direction\r\n */\r\nfunction convertDMSToDD(\r\n  degrees: number,\r\n  minutes: number,\r\n  seconds: number,\r\n  direction: string\r\n) {\r\n  minutes = minutes || 0;\r\n  seconds = seconds || 0;\r\n\r\n  const neg = degrees < 0;\r\n  let dd = Math.abs(degrees) + minutes / 60 + seconds / 3600;\r\n\r\n  if (neg || direction === 'S' || direction === 'W') {\r\n    dd = -dd;\r\n  } // Don't do anything for N or E\r\n  return dd;\r\n}\r\n\r\n/**\r\n * Convert dd to degrees minutes seconds\r\n * @param lonLatDD longitude and latitude in dd\r\n * @param decimal number of decimals for seconds\r\n * @returns longitude and latitude in dms\r\n */\r\nexport function convertDDToDMS(\r\n  lonLatDD: [number, number], decimal: number = 3\r\n): string[] {\r\n  const lonLatDMS = [];\r\n\r\n  lonLatDD.forEach(dd => {\r\n    const degrees = dd < 0 ? Math.ceil(dd) : Math.floor(dd);\r\n    const int = dd < 0 ? (degrees - dd) * 60 : (dd - degrees) * 60;\r\n    const minutes = Math.floor(int);\r\n    const seconds = ((int - minutes) * 60).toFixed(decimal);\r\n\r\n    lonLatDMS.push(`${degrees} ${minutes}' ${seconds}\"`);\r\n  });\r\n  return lonLatDMS;\r\n}\r\n\r\n/**\r\n * Return true of two view states are equal.\r\n * @param state1 View state\r\n * @param state2 View state\r\n * @returns True if the view states are equal\r\n */\r\nexport function viewStatesAreEqual(\r\n  state1: MapViewState,\r\n  state2: MapViewState\r\n): boolean {\r\n  if (state1 === undefined || state2 === undefined) {\r\n    return false;\r\n  }\r\n\r\n  const tolerance = 1 / 10000;\r\n  return (\r\n    state1.zoom === state2.zoom &&\r\n    Math.trunc(state1.center[0] / tolerance) ===\r\n      Math.trunc(state2.center[0] / tolerance) &&\r\n    Math.trunc(state1.center[1] / tolerance) ===\r\n      Math.trunc(state2.center[1] / tolerance)\r\n  );\r\n}\r\n\r\n/**\r\n * Format the scale to a human readable text\r\n * @param Scale of the map\r\n * @returns Human readable scale text\r\n */\r\nexport function formatScale(scale) {\r\n  scale = Math.round(scale);\r\n  if (scale < 10000) {\r\n    return scale + '';\r\n  }\r\n\r\n  scale = Math.round(scale / 1000);\r\n  if (scale < 1000) {\r\n    return scale + 'K';\r\n  }\r\n\r\n  scale = Math.round(scale / 1000);\r\n  return scale + 'M';\r\n}\r\n\r\n/**\r\n * Return the resolution from a scale denom\r\n * @param scale Scale denom\r\n * @param dpi DPI\r\n * @returns Resolution\r\n */\r\nexport function getResolutionFromScale(\r\n  scale: number,\r\n  dpi: number = 96\r\n): number {\r\n  const inchesPerMeter = 39.3701;\r\n  return scale / (inchesPerMeter * dpi);\r\n}\r\n\r\n/**\r\n * Return the resolution from a scale denom\r\n * @param Scale denom\r\n * @returns Resolution\r\n */\r\nexport function getScaleFromResolution(\r\n  resolution: number,\r\n  unit: string = 'm',\r\n  dpi: number = 96\r\n): number {\r\n  const inchesPerMeter = 39.3701;\r\n  return resolution * olproj.METERS_PER_UNIT[unit] * inchesPerMeter * dpi;\r\n}\r\n\r\n/**\r\n * Returns true if the CTRL key is pushed during an Ol MapBrowserPointerEvent\r\n * @param event OL MapBrowserPointerEvent\r\n * @returns Whether the CTRL key is pushed\r\n */\r\nexport function ctrlKeyDown(event: MapBrowserPointerEvent<any>): boolean {\r\n  const originalEvent = event.originalEvent;\r\n  return (\r\n    !originalEvent.altKey &&\r\n    (MAC ? originalEvent.metaKey : originalEvent.ctrlKey) &&\r\n    !originalEvent.shiftKey\r\n  );\r\n}\r\n\r\nexport function roundCoordTo(coord: [number, number], decimal: number = 3): [number, number] {\r\n  return [\r\n    NumberUtils.roundToNDecimal(coord[0], decimal),\r\n    NumberUtils.roundToNDecimal(coord[1], decimal)] as [number, number];\r\n}\r\n\r\n/**\r\n * Returns an array of converted coordinates.\r\n * Conversion is done for every configured projections\r\n * and for the current UTM zone and MTM zone.\r\n * @param lonLat [number, number] array of the coordinate to transform.\r\n * @param projections  Projection[] Array of destination projection.\r\n * @returns Returns an array of converted coordinates.\r\n */\r\nexport function lonLatConversion(\r\n  lonLat: [number, number],\r\n  projections: Projection[]\r\n): {\r\n  code: string;\r\n  alias: string;\r\n  coord: [number, number];\r\n  igo2CoordFormat: string;\r\n}[] {\r\n  const rawCoord3857 = olproj.transform(lonLat, 'EPSG:4326', 'EPSG:3857') as [number, number];\r\n  const convertedLonLat = [\r\n    {\r\n      code: 'EPSG:3857',\r\n      alias: 'Web Mercator',\r\n      coord: rawCoord3857,\r\n      igo2CoordFormat: `${roundCoordTo(rawCoord3857).join(', ')} ; 3857`\r\n    }\r\n  ];\r\n\r\n  // detect the current utm zone.\r\n  const utmZone = utmZoneFromLonLat(lonLat);\r\n  const epsgUtm = utmZone < 10 ? `EPSG:3260${utmZone}` : `EPSG:326${utmZone}`;\r\n  const utmName = `UTM-${utmZone}`;\r\n  const rawCoordUtm = olproj.transform(lonLat, 'EPSG:4326', epsgUtm) as [number, number];\r\n  convertedLonLat.push({\r\n    code: epsgUtm,\r\n    alias: 'UTM',\r\n    coord: rawCoordUtm,\r\n    igo2CoordFormat: `${utmName} ${roundCoordTo(rawCoordUtm).join(', ')}`\r\n  });\r\n\r\n  // detect the current mtm zone.\r\n  const mtmZone = mtmZoneFromLonLat(lonLat);\r\n  if (mtmZone) {\r\n    const epsgMtm =\r\n      mtmZone < 10 ? `EPSG:3218${mtmZone}` : `EPSG:321${80 + mtmZone}`;\r\n    const mtmName = `MTM-${mtmZone}`;\r\n    const rawCoordMtm = olproj.transform(lonLat, 'EPSG:4326', epsgMtm) as [number, number];\r\n    convertedLonLat.push({\r\n      code: epsgMtm,\r\n      alias: 'MTM',\r\n      coord: rawCoordMtm,\r\n      igo2CoordFormat: `${mtmName} ${roundCoordTo(rawCoordMtm).join(', ')}`\r\n    });\r\n  }\r\n\r\n  projections.forEach(projection => {\r\n    const rawCoord = olproj.transform(lonLat, 'EPSG:4326', projection.code) as [number, number];\r\n    const numericEpsgCode = projection.code.split(':')[1];\r\n    convertedLonLat.push({\r\n      code: projection.code,\r\n      alias: projection.alias || projection.code,\r\n      coord: rawCoord,\r\n      igo2CoordFormat: `${roundCoordTo(rawCoord).join(\r\n        ', '\r\n      )} ; ${numericEpsgCode}`\r\n    });\r\n  });\r\n\r\n  return convertedLonLat;\r\n}\r\n\r\n/**\r\n * Detect the current utm zone of the lon/lat coordinate.\r\n * @param lonLat [number, number] array of the coordinate to detect the UTM zone.\r\n * @returns number The UTM zone.\r\n */\r\nexport function utmZoneFromLonLat(lonLat: [number, number]) {\r\n  return Math.ceil((lonLat[0] + 180) / 6);\r\n}\r\n\r\n/**\r\n * Detect the current mtm zone of the lon/lat coordinate.\r\n * @param lonLat [number, number] array of the coordinate to detect the MTM zone.\r\n * @returns number The MTM zone. Undefined if outside of the mtm application zone.\r\n */\r\nexport function mtmZoneFromLonLat(lonLat: [number, number]) {\r\n  const long = lonLat[0];\r\n  let mtmZone;\r\n  if (long < -51 && long > -54) {\r\n    mtmZone = 1;\r\n  }\r\n  if (long < -54 && long > -57) {\r\n    mtmZone = 2;\r\n  }\r\n  if (long < -57 && long > -60) {\r\n    mtmZone = 3;\r\n  }\r\n  if (long < -60 && long > -63) {\r\n    mtmZone = 4;\r\n  }\r\n  if (long < -63 && long > -66) {\r\n    mtmZone = 5;\r\n  }\r\n  if (long < -66 && long > -69) {\r\n    mtmZone = 6;\r\n  }\r\n  if (long < -69 && long > -72) {\r\n    mtmZone = 7;\r\n  }\r\n  if (long < -72 && long > -75) {\r\n    mtmZone = 8;\r\n  }\r\n  if (long < -75 && long > -78) {\r\n    mtmZone = 9;\r\n  }\r\n  if (long < -78 && long > -81) {\r\n    mtmZone = 10;\r\n  }\r\n  return mtmZone;\r\n}\r\n","import {\r\n  BehaviorSubject,\r\n  Observable,\r\n  Subject,\r\n  Subscription,\r\n  combineLatest\r\n} from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport olLayer from 'ol/layer/Layer';\r\nimport olSource from 'ol/source/Source';\r\n\r\nimport { AuthInterceptor } from '@igo2/auth';\r\nimport { SubjectStatus } from '@igo2/utils';\r\n\r\nimport { DataSource, Legend } from '../../../datasource';\r\nimport { IgoMap } from '../../../map/shared/map';\r\nimport { getResolutionFromScale } from '../../../map/shared/map.utils';\r\n\r\nimport { LayerOptions } from './layer.interface';\r\nimport { LayerSyncWatcher } from '../../utils/layerSync-watcher';\r\nimport { Message, MessageService } from '@igo2/core';\r\n\r\nexport abstract class Layer {\r\n  public collapsed: boolean;\r\n  public dataSource: DataSource;\r\n  public legend: Legend[];\r\n  public legendCollapsed: boolean = true;\r\n  public firstLoadComponent: boolean = true;\r\n  public map: IgoMap;\r\n  public ol: olLayer<olSource>;\r\n  public olLoadingProblem: boolean = false;\r\n  public status$: Subject<SubjectStatus>;\r\n  public hasBeenVisible$: BehaviorSubject<boolean> = new BehaviorSubject(undefined);\r\n  private hasBeenVisible$$: Subscription;\r\n  private resolution$$: Subscription;\r\n\r\n  /**\r\n   * Define if a layer is generated by code OR defined by layer/context user layer.\r\n   * Useful for filtering layers list in mapOffline.directive or in the sharemap...\r\n   * return false by default.\r\n   */\r\n  get isIgoInternalLayer(): boolean {\r\n    return this.options.isIgoInternalLayer || false;\r\n  }\r\n\r\n  get id(): string {\r\n    return this.options.id || this.dataSource.id;\r\n  }\r\n\r\n  get alias(): string {\r\n    return this.options.alias;\r\n  }\r\n\r\n  get title(): string {\r\n    return this.options.title;\r\n  }\r\n\r\n  set title(title: string) {\r\n    this.options.title = title;\r\n  }\r\n\r\n  get zIndex(): number {\r\n    return this.ol.getZIndex();\r\n  }\r\n\r\n  set zIndex(zIndex: number) {\r\n    this.ol.setZIndex(zIndex);\r\n  }\r\n\r\n  get baseLayer(): boolean {\r\n    return this.options.baseLayer;\r\n  }\r\n\r\n  set baseLayer(baseLayer: boolean) {\r\n    this.options.baseLayer = baseLayer;\r\n  }\r\n\r\n  get opacity(): number {\r\n    return this.ol.get('opacity');\r\n  }\r\n\r\n  set opacity(opacity: number) {\r\n    this.ol.setOpacity(opacity);\r\n  }\r\n\r\n  set isInResolutionsRange(value: boolean) {\r\n    this.isInResolutionsRange$.next(value);\r\n  }\r\n  get isInResolutionsRange(): boolean {\r\n    return this.isInResolutionsRange$.value;\r\n  }\r\n  readonly isInResolutionsRange$: BehaviorSubject<\r\n    boolean\r\n  > = new BehaviorSubject(false);\r\n\r\n  set maxResolution(value: number) {\r\n    this.ol.setMaxResolution(value || Infinity);\r\n    this.updateInResolutionsRange();\r\n  }\r\n  get maxResolution(): number {\r\n    return this.ol.getMaxResolution();\r\n  }\r\n\r\n  set minResolution(value: number) {\r\n    this.ol.setMinResolution(value || 0);\r\n    this.updateInResolutionsRange();\r\n  }\r\n  get minResolution(): number {\r\n    return this.ol.getMinResolution();\r\n  }\r\n\r\n  set visible(value: boolean) {\r\n    this.ol.setVisible(value);\r\n    this.visible$.next(value);\r\n    if (!this.hasBeenVisible$.value && value){\r\n      this.hasBeenVisible$.next(value);\r\n    }\r\n    if (this.options?.messages && value) {\r\n      this.options?.messages\r\n        .filter(m => m.options?.showOnEachLayerVisibility)\r\n        .map(message =>\r\n          this.showMessage(message)\r\n        );\r\n    }\r\n  }\r\n  get visible(): boolean {\r\n    return this.visible$.value;\r\n  }\r\n  readonly visible$: BehaviorSubject<boolean> = new BehaviorSubject(undefined);\r\n\r\n  get displayed(): boolean {\r\n    return this.visible && this.isInResolutionsRange;\r\n  }\r\n  readonly displayed$: Observable<boolean> = combineLatest([\r\n    this.isInResolutionsRange$,\r\n    this.visible$\r\n  ]).pipe(map((bunch: [boolean, boolean]) => bunch[0] && bunch[1]));\r\n\r\n  get showInLayerList(): boolean {\r\n    return this.options.showInLayerList !== false;\r\n  }\r\n\r\n  private layerSyncWatcher: LayerSyncWatcher;\r\n\r\n  constructor(\r\n    public options: LayerOptions,\r\n    protected messageService?: MessageService,\r\n    protected authInterceptor?: AuthInterceptor\r\n  ) {\r\n    this.dataSource = options.source;\r\n\r\n    this.ol = this.createOlLayer();\r\n    if (options.zIndex !== undefined) {\r\n      this.zIndex = options.zIndex;\r\n    }\r\n\r\n    if (options.baseLayer && options.visible === undefined) {\r\n      options.visible = false;\r\n    }\r\n\r\n    this.maxResolution = options.maxResolution || getResolutionFromScale(Number(options.maxScaleDenom));\r\n    this.minResolution = options.minResolution || getResolutionFromScale(Number(options.minScaleDenom));\r\n\r\n    this.visible = options.visible === undefined ? true : options.visible;\r\n    this.opacity = options.opacity === undefined ? 1 : options.opacity;\r\n\r\n    if (\r\n      options.legendOptions &&\r\n      (options.legendOptions.url || options.legendOptions.html)\r\n    ) {\r\n      this.legend = this.dataSource.setLegend(options.legendOptions);\r\n    }\r\n\r\n    this.legendCollapsed = options.legendOptions\r\n      ? options.legendOptions.collapsed\r\n        ? options.legendOptions.collapsed\r\n        : true\r\n      : true;\r\n\r\n    this.ol.set('_layer', this, true);\r\n  }\r\n\r\n  protected abstract createOlLayer(): olLayer<olSource>;\r\n\r\n  setMap(igoMap: IgoMap | undefined) {\r\n    this.map = igoMap;\r\n\r\n    this.unobserveResolution();\r\n    if (igoMap !== undefined) {\r\n      this.observeResolution();\r\n      this.layerSyncWatcher = new LayerSyncWatcher(this, this.map);\r\n      this.layerSyncWatcher.subscribe(() => {});\r\n      this.hasBeenVisible$$ = this.hasBeenVisible$.subscribe(() => {\r\n        if (this.options.messages && this.visible) {\r\n          this.options.messages.map(message => {\r\n            this.showMessage(message);\r\n          });\r\n        }\r\n      });\r\n    } else {\r\n      this.layerSyncWatcher.unsubscribe();\r\n    }\r\n  }\r\n\r\n  private showMessage(message: Message) {\r\n    if (!this.messageService) {\r\n      return;\r\n    }\r\n    message.title = message.title;\r\n    message.text = message.text;\r\n    this.messageService.message(message as Message);\r\n  }\r\n\r\n  private observeResolution() {\r\n    this.resolution$$ = this.map.viewController.resolution$.subscribe(() =>\r\n      this.updateInResolutionsRange()\r\n    );\r\n  }\r\n\r\n  private unobserveResolution() {\r\n    if (this.resolution$$ !== undefined) {\r\n      this.resolution$$.unsubscribe();\r\n      this.resolution$$ = undefined;\r\n    }\r\n  }\r\n\r\n  private updateInResolutionsRange() {\r\n    if (this.map !== undefined) {\r\n      const resolution = this.map.viewController.getResolution();\r\n      const minResolution = this.minResolution;\r\n      const maxResolution = this.maxResolution === undefined ? Infinity : this.maxResolution;\r\n      this.isInResolutionsRange = resolution >= minResolution && resolution <= maxResolution;\r\n    } else {\r\n      this.isInResolutionsRange = false;\r\n    }\r\n  }\r\n}\r\n","import olLayerVector from 'ol/layer/Vector';\r\nimport olSourceVector from 'ol/source/Vector';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport { unByKey } from 'ol/Observable';\r\nimport { easeOut } from 'ol/easing';\r\nimport { asArray as ColorAsArray } from 'ol/color';\r\nimport { getVectorContext } from 'ol/render';\r\nimport FormatType from 'ol/format/FormatType';\r\nimport olFeature from 'ol/Feature';\r\nimport olProjection from 'ol/proj/Projection';\r\nimport * as olproj from 'ol/proj';\r\n\r\nimport { FeatureDataSource } from '../../../datasource/shared/datasources/feature-datasource';\r\nimport { WFSDataSource } from '../../../datasource/shared/datasources/wfs-datasource';\r\nimport { ArcGISRestDataSource } from '../../../datasource/shared/datasources/arcgisrest-datasource';\r\nimport { WebSocketDataSource } from '../../../datasource/shared/datasources/websocket-datasource';\r\nimport { ClusterDataSource } from '../../../datasource/shared/datasources/cluster-datasource';\r\n\r\nimport { VectorWatcher } from '../../utils';\r\nimport { IgoMap } from '../../../map';\r\nimport { Layer } from './layer';\r\nimport { VectorLayerOptions } from './vector-layer.interface';\r\nimport { AuthInterceptor } from '@igo2/auth';\r\nimport { MessageService } from '@igo2/core';\r\nimport { WFSDataSourceOptions } from '../../../datasource/shared/datasources/wfs-datasource.interface';\r\nimport { buildUrl, defaultMaxFeatures } from '../../../datasource/shared/datasources/wms-wfs.utils';\r\nimport { OgcFilterableDataSourceOptions } from '../../../filter/shared/ogc-filter.interface';\r\nimport { GeoNetworkService, SimpleGetOptions } from '../../../offline/shared/geo-network.service';\r\nimport { catchError, concatMap, first } from 'rxjs/operators';\r\nimport { GeoDBService } from '../../../offline/geoDB/geoDB.service';\r\nimport { of } from 'rxjs';\r\nexport class VectorLayer extends Layer {\r\n  public dataSource:\r\n    | FeatureDataSource\r\n    | WFSDataSource\r\n    | ArcGISRestDataSource\r\n    | WebSocketDataSource\r\n    | ClusterDataSource;\r\n  public options: VectorLayerOptions;\r\n  public ol: olLayerVector<olSourceVector<OlGeometry>>;\r\n  private watcher: VectorWatcher;\r\n  private trackFeatureListenerId;\r\n\r\n  get browsable(): boolean {\r\n    return this.options.browsable !== false;\r\n  }\r\n\r\n  get exportable(): boolean {\r\n    return this.options.exportable !== false;\r\n  }\r\n\r\n  constructor(\r\n    options: VectorLayerOptions,\r\n    public messageService?: MessageService,\r\n    public authInterceptor?: AuthInterceptor,\r\n    private geoNetworkService?: GeoNetworkService,\r\n    private geoDBService?: GeoDBService\r\n  ) {\r\n    super(options, messageService, authInterceptor);\r\n    this.watcher = new VectorWatcher(this);\r\n    this.status$ = this.watcher.status$;\r\n  }\r\n\r\n  protected createOlLayer(): olLayerVector<olSourceVector<OlGeometry>> {\r\n    const olOptions = Object.assign({}, this.options, {\r\n      source: this.options.source.ol as olSourceVector<OlGeometry>\r\n    });\r\n\r\n    if (this.options.animation) {\r\n      this.dataSource.ol.on(\r\n        'addfeature',\r\n        function(e) {\r\n          this.flash(e.feature);\r\n        }.bind(this)\r\n      );\r\n    }\r\n\r\n    if (this.options.trackFeature) {\r\n      this.enableTrackFeature(this.options.trackFeature);\r\n    }\r\n\r\n    const vector = new olLayerVector(olOptions);\r\n    const vectorSource = vector.getSource() as olSourceVector<OlGeometry>;\r\n    const url = vectorSource.getUrl();\r\n    if (url) {\r\n      let loader;\r\n      const wfsOptions = olOptions.sourceOptions as WFSDataSourceOptions;\r\n      if (wfsOptions?.type === 'wfs' && (wfsOptions.params || wfsOptions.paramsWFS)) {\r\n        loader = (extent, resolution, proj, success, failure) => {\r\n          this.customWFSLoader(\r\n            vectorSource,\r\n            wfsOptions,\r\n            this.authInterceptor,\r\n            extent,\r\n            resolution,\r\n            proj,\r\n            success,\r\n            failure\r\n          );\r\n        };\r\n      } else {\r\n        loader = (extent, resolution, proj, success, failure) => {\r\n          this.customLoader(\r\n            vectorSource,\r\n            url,\r\n            this.authInterceptor,\r\n            extent,\r\n            resolution,\r\n            proj,\r\n            success,\r\n            failure\r\n          );\r\n        };\r\n      }\r\n      if (loader) {\r\n        vectorSource.setLoader(loader);\r\n      }\r\n    }\r\n    return vector;\r\n  }\r\n\r\n  protected flash(feature) {\r\n    const start = new Date().getTime();\r\n    const listenerKey = this.ol.on('postrender', animate.bind(this));\r\n\r\n    function animate(event) {\r\n      const vectorContext = getVectorContext(event);\r\n      const frameState = event.frameState;\r\n      const flashGeom = feature.getGeometry().clone();\r\n      const elapsed = frameState.time - start;\r\n      const elapsedRatio = elapsed / this.options.animation.duration;\r\n      const opacity = easeOut(1 - elapsedRatio);\r\n      const newColor = ColorAsArray(this.options.animation.color || 'red');\r\n      newColor[3] = opacity;\r\n      let style = this.ol\r\n        .getStyleFunction()\r\n        .call(this, feature)\r\n        .find((style2) => {\r\n          return style2.getImage();\r\n        });\r\n      if (!style) {\r\n        style = this.ol.getStyleFunction().call(this, feature)[0];\r\n      }\r\n      const styleClone = style.clone();\r\n\r\n      switch (feature.getGeometry().getType()) {\r\n        case 'Point':\r\n          if(styleClone.getImage() !== null &&\r\n            typeof styleClone.getImage().getRadius === 'function'){\r\n            const radius =\r\n            easeOut(elapsedRatio) * (styleClone.getImage().getRadius() * 3);\r\n            styleClone.getImage().setRadius(radius);\r\n            styleClone.getImage().setOpacity(opacity);\r\n          }\r\n\r\n          break;\r\n        case 'LineString':\r\n          // TODO\r\n          if (styleClone.getImage()) {\r\n            styleClone.getImage().getStroke().setColor(newColor);\r\n            styleClone\r\n              .getImage()\r\n              .getStroke()\r\n              .setWidth(\r\n                easeOut(elapsedRatio) *\r\n                  (styleClone.getImage().getStroke().getWidth() * 3)\r\n              );\r\n          }\r\n          if (styleClone.getStroke()) {\r\n            styleClone.getStroke().setColor(newColor);\r\n            styleClone\r\n              .getStroke()\r\n              .setWidth(\r\n                easeOut(elapsedRatio) * (styleClone.getStroke().getWidth() * 3)\r\n              );\r\n          }\r\n          break;\r\n        case 'Polygon':\r\n          // TODO\r\n          if (styleClone.getImage()) {\r\n            styleClone.getImage().getFill().setColor(newColor);\r\n          }\r\n          if (styleClone.getFill()) {\r\n            styleClone.getFill().setColor(newColor);\r\n          }\r\n          break;\r\n      }\r\n\r\n      styleClone.setText('');\r\n      vectorContext.setStyle(styleClone);\r\n      vectorContext.drawGeometry(flashGeom);\r\n\r\n      if (elapsed > this.options.animation.duration) {\r\n        unByKey(listenerKey);\r\n        // remove last geometry\r\n        // there is a little flash before feature disappear, better solution ?\r\n        this.map.ol.render();\r\n        return;\r\n      }\r\n      // tell OpenLayers to continue postcompose animation\r\n      this.map.ol.render();\r\n    }\r\n  }\r\n\r\n  public setMap(map: IgoMap | undefined) {\r\n    if (map === undefined) {\r\n      this.watcher.unsubscribe();\r\n    } else {\r\n      this.watcher.subscribe(() => {});\r\n    }\r\n    super.setMap(map);\r\n  }\r\n\r\n  public onUnwatch() {\r\n    this.dataSource.onUnwatch();\r\n    this.stopAnimation();\r\n  }\r\n\r\n  public stopAnimation() {\r\n    this.dataSource.ol.un(\r\n      'addfeature',\r\n      function(e) {\r\n        if (this.visible) {\r\n          this.flash(e.feature);\r\n        }\r\n      }.bind(this)\r\n    );\r\n  }\r\n\r\n  public enableTrackFeature(id: string | number) {\r\n    this.trackFeatureListenerId = this.dataSource.ol.on(\r\n      'addfeature',\r\n      this.trackFeature.bind(this, id)\r\n    );\r\n  }\r\n  public centerMapOnFeature(id: string | number) {\r\n    const feat = this.dataSource.ol.getFeatureById(id);\r\n    if (feat) {\r\n      this.map.ol.getView().setCenter(feat.getGeometry().getCoordinates());\r\n    }\r\n  }\r\n\r\n  public trackFeature(id, feat) {\r\n    if (feat.feature.getId() === id && this.visible) {\r\n      this.centerMapOnFeature(id);\r\n    }\r\n  }\r\n\r\n  public disableTrackFeature(id?: string | number) {\r\n    unByKey(this.trackFeatureListenerId);\r\n  }\r\n\r\n  /**\r\n   * Custom loader for a WFS datasource\r\n   * @internal\r\n   * @param vectorSource the vector source to be created\r\n   * @param options olOptions from source\r\n   * @param interceptor the interceptor of the data\r\n   * @param extent the extent of the requested data\r\n   * @param resolution the current resolution\r\n   * @param proj the projection to retrieve the data\r\n   * @param success success callback\r\n   * @param failure failure callback\r\n   * @param randomParam random parameter to ensure cache is not causing problems in retrieving new data\r\n   */\r\n  public customWFSLoader(\r\n    vectorSource,\r\n    options,\r\n    interceptor,\r\n    extent,\r\n    resolution,\r\n    proj,\r\n    success,\r\n    failure,\r\n    randomParam?: boolean\r\n  ) {\r\n    {\r\n      const paramsWFS = options.paramsWFS;\r\n      const wfsProj = paramsWFS.srsName ? new olProjection({ code: paramsWFS.srsName }) : proj;\r\n      const currentExtent = olproj.transformExtent(extent, proj, wfsProj);\r\n      paramsWFS.srsName = paramsWFS.srsName || proj.getCode();\r\n      const url = buildUrl(\r\n        options,\r\n        currentExtent,\r\n        wfsProj,\r\n        (options as OgcFilterableDataSourceOptions).ogcFilters,\r\n        randomParam);\r\n      let startIndex = 0;\r\n      if (paramsWFS.version === '2.0.0' && paramsWFS.maxFeatures > defaultMaxFeatures) {\r\n        const nbOfFeature = 1000;\r\n        while (startIndex < paramsWFS.maxFeatures) {\r\n          let alteredUrl = url.replace('count=' + paramsWFS.maxFeatures, 'count=' + nbOfFeature);\r\n          alteredUrl = alteredUrl.replace('startIndex=0', '0');\r\n          alteredUrl += '&startIndex=' + startIndex;\r\n          alteredUrl.replace(/&&/g, '&');\r\n          this.getFeatures(vectorSource, interceptor, currentExtent, wfsProj, proj, alteredUrl, nbOfFeature, success, failure);\r\n          startIndex += nbOfFeature;\r\n        }\r\n      } else {\r\n        this.getFeatures(vectorSource, interceptor, currentExtent, wfsProj, proj, url, paramsWFS.maxFeatures, success, failure);\r\n      }\r\n    }\r\n  }\r\n\r\n\r\n  /**\r\n   * Custom loader to get feature from a WFS datasource\r\n   * @internal\r\n   * @param vectorSource the vector source to be created\r\n   * @param interceptor the interceptor of the data\r\n   * @param extent the extent of the requested data\r\n   * @param dataProjection the projection of the retrieved data\r\n   * @param featureProjection the projection of the created features\r\n   * @param url the url string to retrieve the data\r\n   * @param threshold the threshold to manage \"more features\" (TODO)\r\n   * @param success success callback\r\n   * @param failure failure callback\r\n   */\r\n  private getFeatures(\r\n    vectorSource: olSourceVector<OlGeometry>,\r\n    interceptor,\r\n    extent,\r\n    dataProjection,\r\n    featureProjection,\r\n    url: string,\r\n    threshold: number,\r\n    success, failure) {\r\n\r\n    const idAssociatedCall = (this.dataSource as WFSDataSource).mostRecentIdCallOGCFilter;\r\n    const xhr = new XMLHttpRequest();\r\n    const alteredUrlWithKeyAuth = interceptor.alterUrlWithKeyAuth(url);\r\n    let modifiedUrl = url;\r\n    if (alteredUrlWithKeyAuth) {\r\n      modifiedUrl = alteredUrlWithKeyAuth;\r\n    }\r\n    xhr.open('GET', modifiedUrl);\r\n    if (interceptor) {\r\n      interceptor.interceptXhr(xhr, modifiedUrl);\r\n    }\r\n    const onError = () => {\r\n      vectorSource.removeLoadedExtent(extent);\r\n      failure();\r\n    };\r\n    xhr.onerror = onError;\r\n    xhr.onload = () => {\r\n      if (xhr.status === 200 && xhr.responseText.length > 0) {\r\n        const features =\r\n          vectorSource\r\n            .getFormat()\r\n            .readFeatures(xhr.responseText, { dataProjection, featureProjection }) as olFeature<OlGeometry>[];\r\n        // TODO Manage \"More feature\"\r\n        /*if (features.length === 0 || features.length < threshold ) {\r\n          console.log('No more data to download at this resolution');\r\n        }*/\r\n        // Avoids retrieving an older call that took longer to be process\r\n        if (idAssociatedCall === (this.dataSource as WFSDataSource).mostRecentIdCallOGCFilter)\r\n        {\r\n            vectorSource.addFeatures(features);\r\n            success(features);\r\n        }\r\n        else {\r\n            success([]);\r\n        }\r\n      } else {\r\n        onError();\r\n      }\r\n    };\r\n    xhr.send();\r\n  }\r\n\r\n  /**\r\n   * Custom loader for vector layer.\r\n   * @internal\r\n   * @param vectorSource the vector source to be created\r\n   * @param url the url string or function to retrieve the data\r\n   * @param interceptor the interceptor of the data\r\n   * @param extent the extent of the requested data\r\n   * @param resolution the current resolution\r\n   * @param projection the projection to retrieve the data\r\n   */\r\n  private customLoader(\r\n    vectorSource,\r\n    url,\r\n    interceptor,\r\n    extent,\r\n    resolution,\r\n    projection,\r\n    success,\r\n    failure\r\n  ) {\r\n    const xhr = new XMLHttpRequest();\r\n    let modifiedUrl = url;\r\n    if (typeof url !== 'function') {\r\n      const alteredUrlWithKeyAuth = interceptor.alterUrlWithKeyAuth(url);\r\n      if (alteredUrlWithKeyAuth) {\r\n        modifiedUrl = alteredUrlWithKeyAuth;\r\n      }\r\n    } else {\r\n      modifiedUrl = url(extent, resolution, projection);\r\n    }\r\n\r\n    if (this.geoNetworkService && typeof url !== 'function') {\r\n      const format = vectorSource.getFormat();\r\n      const type = format.getType();\r\n\r\n      let responseType = type;\r\n      const onError = () => {\r\n        vectorSource.removeLoadedExtent(extent);\r\n        failure();\r\n      };\r\n\r\n      const options: SimpleGetOptions = { responseType };\r\n      this.geoNetworkService.geoDBService.get(url).pipe(concatMap(r =>\r\n        r ? of(r) : this.geoNetworkService.get(modifiedUrl, options)\r\n          .pipe(\r\n            first(),\r\n            catchError((res) => {\r\n              onError();\r\n              throw res;\r\n            })\r\n          )\r\n      ))\r\n      .subscribe((content) => {\r\n          if (content) {\r\n            const format = vectorSource.getFormat();\r\n            const type = format.getType();\r\n            let source;\r\n            if (type === FormatType.JSON || type === FormatType.TEXT) {\r\n              source = content;\r\n            } else if (type === FormatType.XML) {\r\n              source = content;\r\n              if (!source) {\r\n                source = new DOMParser().parseFromString(\r\n                  content,\r\n                  'application/xml'\r\n                );\r\n              }\r\n            } else if (type === FormatType.ARRAY_BUFFER) {\r\n              source = content;\r\n            }\r\n            if (source) {\r\n              const features = format.readFeatures(source, { extent, featureProjection: projection });\r\n              vectorSource.addFeatures(features, format.readProjection(source));\r\n              success(features);\r\n            } else {\r\n              onError();\r\n            }\r\n          }\r\n        });\r\n\r\n    } else {\r\n    xhr.open( 'GET', modifiedUrl);\r\n    const format = vectorSource.getFormat();\r\n    if (format.getType() === FormatType.ARRAY_BUFFER) {\r\n      xhr.responseType = 'arraybuffer';\r\n    }\r\n    if (interceptor) {\r\n      interceptor.interceptXhr(xhr, modifiedUrl);\r\n    }\r\n\r\n    const onError = () => {\r\n      vectorSource.removeLoadedExtent(extent);\r\n      failure();\r\n    };\r\n    xhr.onerror = onError;\r\n    xhr.onload = () => {\r\n      // status will be 0 for file:// urls\r\n      if (!xhr.status || (xhr.status >= 200 && xhr.status < 300)) {\r\n        const type = format.getType();\r\n        let source;\r\n        if (type === FormatType.JSON || type === FormatType.TEXT) {\r\n          source = xhr.responseText;\r\n        } else if (type === FormatType.XML) {\r\n          source = xhr.responseXML;\r\n          if (!source) {\r\n            source = new DOMParser().parseFromString(\r\n              xhr.responseText,\r\n              'application/xml'\r\n            );\r\n          }\r\n        } else if (type === FormatType.ARRAY_BUFFER) {\r\n          source = xhr.response;\r\n        }\r\n        if (source) {\r\n          const features = format.readFeatures(source, { extent, featureProjection: projection });\r\n          vectorSource.addFeatures(features, format.readProjection(source));\r\n          success(features);\r\n        } else {\r\n          onError();\r\n        }\r\n      } else {\r\n        onError();\r\n      }\r\n    };\r\n    xhr.send();\r\n  }\r\n  }\r\n}\r\n","import olSourceOSM from 'ol/source/OSM';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { OSMDataSourceOptions } from './osm-datasource.interface';\r\n\r\nexport class OSMDataSource extends DataSource {\r\n  public options: OSMDataSourceOptions;\r\n  public ol: olSourceOSM;\r\n\r\n  protected createOlSource(): olSourceOSM {\r\n    if (!this.options.url) {\r\n      this.options.url = 'https://tile.openstreetmap.org/{z}/{x}/{y}.png';\r\n    }\r\n    return new olSourceOSM(this.options);\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import olSourceXYZ from 'ol/source/XYZ';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { XYZDataSourceOptions } from './xyz-datasource.interface';\r\n\r\nexport class XYZDataSource extends DataSource {\r\n  public options: XYZDataSourceOptions;\r\n  public ol: olSourceXYZ;\r\n\r\n  protected createOlSource(): olSourceXYZ {\r\n    return new olSourceXYZ(this.options);\r\n  }\r\n\r\n  public onUnwatch() {}\r\n\r\n}\r\n","import olSourceVector from 'ol/source/Vector';\r\nimport * as OlLoadingStrategy from 'ol/loadingstrategy';\r\nimport olProjection from 'ol/proj/Projection';\r\nimport * as olproj from 'ol/proj';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { WFSDataSourceOptions } from './wfs-datasource.interface';\r\nimport { WFSService } from './wfs.service';\r\n\r\nimport { OgcFilterWriter } from '../../../filter/shared/ogc-filter';\r\nimport { OgcFilterableDataSourceOptions, OgcFiltersOptions } from '../../../filter/shared/ogc-filter.interface';\r\nimport {\r\n  defaultFieldNameGeometry,\r\n  checkWfsParams,\r\n  getFormatFromOptions,\r\n  buildUrl\r\n} from './wms-wfs.utils';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport { AuthInterceptor } from '@igo2/auth';\r\n\r\nexport class WFSDataSource extends DataSource {\r\n  public ol: olSourceVector<OlGeometry>;\r\n  public mostRecentIdCallOGCFilter: number = 0;\r\n\r\n  set ogcFilters(value: OgcFiltersOptions) {\r\n    (this.options as OgcFilterableDataSourceOptions).ogcFilters = value;\r\n  }\r\n  get ogcFilters(): OgcFiltersOptions {\r\n    return (this.options as OgcFilterableDataSourceOptions).ogcFilters;\r\n  }\r\n\r\n  readonly ogcFilters$: BehaviorSubject<OgcFiltersOptions> = new BehaviorSubject(undefined);\r\n\r\n  constructor(\r\n    public options: WFSDataSourceOptions,\r\n    protected wfsService: WFSService,\r\n    private authInterceptor?: AuthInterceptor\r\n  ) {\r\n    super(checkWfsParams(options, 'wfs'));\r\n\r\n    const ogcFilters = (this.options as OgcFilterableDataSourceOptions).ogcFilters;\r\n    const fieldNameGeometry = this.options.paramsWFS.fieldNameGeometry || defaultFieldNameGeometry;\r\n    const ogcFilterWriter = new OgcFilterWriter();\r\n    (this.options as OgcFilterableDataSourceOptions).ogcFilters =\r\n      ogcFilterWriter.defineOgcFiltersDefaultOptions(ogcFilters, fieldNameGeometry);\r\n    if (\r\n      (this.options as OgcFilterableDataSourceOptions).ogcFilters.enabled &&\r\n      (this.options as OgcFilterableDataSourceOptions).ogcFilters.editable &&\r\n      (options.sourceFields || []).filter(sf => !sf.values).length > 0\r\n    ) {\r\n      this.wfsService.getSourceFieldsFromWFS(this.options);\r\n    }\r\n\r\n    if (ogcFilters?.pushButtons){\r\n      ogcFilters.pushButtons.selectorType = 'pushButton';\r\n    }\r\n    if (ogcFilters?.checkboxes){\r\n      ogcFilters.checkboxes.selectorType = 'checkbox';\r\n    }\r\n    if (ogcFilters?.radioButtons){\r\n      ogcFilters.radioButtons.selectorType = 'radioButton';\r\n    }\r\n    if (ogcFilters?.select){\r\n      ogcFilters.select.selectorType = 'select';\r\n    }\r\n    if (ogcFilters?.autocomplete){\r\n      ogcFilters.autocomplete.selectorType = 'autocomplete';\r\n    }\r\n\r\n    this.setOgcFilters((this.options as OgcFilterableDataSourceOptions).ogcFilters, true);\r\n  }\r\n\r\n  protected createOlSource(): olSourceVector<OlGeometry> {\r\n    const vectorSource = new olSourceVector({\r\n      format: getFormatFromOptions(this.options),\r\n      url: (extent, resolution, proj: olProjection) => {\r\n        const paramsWFS = this.options.paramsWFS;\r\n        const wfsProj = paramsWFS.srsName ? new olProjection({ code: paramsWFS.srsName }) : proj;\r\n        const ogcFilters = (this.options as OgcFilterableDataSourceOptions).ogcFilters;\r\n        const currentExtent = olproj.transformExtent(extent, proj, wfsProj);\r\n        paramsWFS.srsName = paramsWFS.srsName || proj.getCode();\r\n        return buildUrl(this.options, currentExtent, wfsProj, ogcFilters);\r\n      },\r\n      strategy: OlLoadingStrategy.bbox\r\n    });\r\n    return vectorSource;\r\n  }\r\n\r\n  setOgcFilters(ogcFilters: OgcFiltersOptions, triggerEvent: boolean = false) {\r\n    this.ogcFilters = ogcFilters;\r\n    this.mostRecentIdCallOGCFilter += 1;\r\n    if (triggerEvent) {\r\n      this.ogcFilters$.next(this.ogcFilters);\r\n    }\r\n  }\r\n\r\n  public onUnwatch() { }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { combineLatest, Observable, of } from 'rxjs';\r\nimport olFeature from 'ol/Feature';\r\nimport { WFSDataSourceOptions } from './wfs-datasource.interface';\r\nimport { WMSDataSourceOptions } from './wms-datasource.interface';\r\nimport { DataService } from './data.service';\r\nimport { formatWFSQueryString,\r\n          gmlRegex,\r\n          defaultEpsg,\r\n          defaultMaxFeatures,\r\n          getFormatFromOptions} from './wms-wfs.utils';\r\nimport { concatMap } from 'rxjs/operators';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class WFSService extends DataService {\r\n  constructor(private http: HttpClient) {\r\n    super();\r\n  }\r\n\r\n  getData() {\r\n    console.log('This is defining a data service.');\r\n    return 'This is defining a data service.';\r\n  }\r\n\r\n  public getSourceFieldsFromWFS(dataSourceOptions: WFSDataSourceOptions | WMSDataSourceOptions) {\r\n    if (!dataSourceOptions.sourceFields || dataSourceOptions.sourceFields.length === 0 ) {\r\n      dataSourceOptions.sourceFields = [];\r\n      this.defineFieldAndValuefromWFS(dataSourceOptions).subscribe(getfeatureSourceField => {\r\n        dataSourceOptions.sourceFields = getfeatureSourceField;\r\n      });\r\n\r\n    } else {\r\n      this.defineFieldAndValuefromWFS(dataSourceOptions).subscribe(getfeatureSourceField => {\r\n        dataSourceOptions.sourceFields.forEach(sourcefield => {\r\n          if (sourcefield.alias === undefined) {\r\n            sourcefield.alias = sourcefield.name; // to allow only a list of sourcefield with names\r\n          }\r\n          if (sourcefield.values === undefined || sourcefield.values.length === 0) {\r\n            sourcefield.values = getfeatureSourceField.find(sf => sf.name === sourcefield.name).values;\r\n          }\r\n        });\r\n      });\r\n    }\r\n  }\r\n\r\n  private wfsGetFeature(\r\n    dataSourceOptions: WFSDataSourceOptions | WMSDataSourceOptions,\r\n    nb: number = defaultMaxFeatures,\r\n    epsgCode: string = defaultEpsg,\r\n    propertyName?: string,\r\n    startIndex: number = 0,\r\n    forceDefaultOutputFormat: boolean = false\r\n  ): Observable<any> {\r\n    const queryStringValues = formatWFSQueryString(dataSourceOptions, nb, epsgCode, propertyName, startIndex, forceDefaultOutputFormat );\r\n    const baseUrl = queryStringValues.find(f => f.name === 'getfeature').value;\r\n    const outputFormat = dataSourceOptions.paramsWFS.outputFormat;\r\n    if (forceDefaultOutputFormat || gmlRegex.test(outputFormat) || !outputFormat) {\r\n      return this.http.get(baseUrl, { responseType: 'text' });\r\n    } else {\r\n      return this.http.get(baseUrl);\r\n    }\r\n  }\r\n\r\n  defineFieldAndValuefromWFS(\r\n    dataSourceOptions: WFSDataSourceOptions | WMSDataSourceOptions\r\n  ): Observable<any> {\r\n    return new Observable(d => {\r\n      const sourceFields = [];\r\n      let fieldList;\r\n      let fieldListWoGeom;\r\n      let fieldListWoGeomStr;\r\n      let olFormats;\r\n      let effectiveOlFormats;\r\n\r\n      olFormats = getFormatFromOptions(dataSourceOptions);\r\n      const gmlDataSourceOptions: WFSDataSourceOptions | WMSDataSourceOptions = JSON.parse(\r\n        JSON.stringify(dataSourceOptions)\r\n      );\r\n      delete gmlDataSourceOptions.paramsWFS.outputFormat;\r\n      delete (gmlDataSourceOptions as WFSDataSourceOptions).formatOptions;\r\n\r\n      effectiveOlFormats = getFormatFromOptions(gmlDataSourceOptions);\r\n      let sourceFieldsToRetrieveValues = dataSourceOptions.sourceFields?.filter(f => !f.values).map(f => f.name);\r\n\r\n      // Validate if the service manage no outputformat (wfs 1.0.0 and GML is the default return)\r\n      this.wfsGetFeature(dataSourceOptions, 1, undefined, undefined, 0, true).pipe(\r\n        concatMap(res => String(res).toLowerCase().includes('exception') ? of(false) : of(true)),\r\n        concatMap(allowGml => {\r\n          // If the service return GML (return no exception)\r\n          return this.wfsGetFeature(dataSourceOptions, 1).pipe(\r\n            concatMap(firstFeature => {\r\n              const features = olFormats.readFeatures(firstFeature);\r\n              fieldList = features[0].getKeys();\r\n              if (dataSourceOptions.sourceFields || dataSourceOptions.sourceFields.length === 0) {\r\n                sourceFieldsToRetrieveValues = fieldList;\r\n              }\r\n              fieldListWoGeom = fieldList.filter(\r\n                field =>\r\n                  sourceFieldsToRetrieveValues.includes(field) &&\r\n                  field !== features[0].getGeometryName() &&\r\n                  !field.match(/boundedby/gi)\r\n              );\r\n              fieldListWoGeomStr = fieldListWoGeom.join(',');\r\n              const processingArray = [];\r\n              let startIndex = 0;\r\n              // If the service do not allow gml return, dice the call in multiple\r\n              // calls by increment of chunkSize with the original outputFormat\r\n              if (\r\n                !allowGml && dataSourceOptions.paramsWFS.version === '2.0.0' &&\r\n                dataSourceOptions.paramsWFS.maxFeatures > defaultMaxFeatures) {\r\n                const chunkSize = 1000;\r\n                while (startIndex < dataSourceOptions.paramsWFS.maxFeatures) {\r\n                  processingArray.push(this.wfsGetFeature(\r\n                    dataSourceOptions,\r\n                    chunkSize,\r\n                    dataSourceOptions.paramsWFS.srsName,\r\n                    fieldListWoGeomStr,\r\n                    startIndex\r\n                  ));\r\n                  startIndex += chunkSize;\r\n                }\r\n                effectiveOlFormats = olFormats;\r\n              } else {\r\n                processingArray.push(this.wfsGetFeature(\r\n                  dataSourceOptions,\r\n                  dataSourceOptions.paramsWFS.maxFeatures || defaultMaxFeatures,\r\n                  dataSourceOptions.paramsWFS.srsName,\r\n                  fieldListWoGeomStr,\r\n                  0, true\r\n                ));\r\n              }\r\n              return combineLatest(processingArray);\r\n            })\r\n          );\r\n        })).subscribe((results) => {\r\n          let mfeatures: olFeature<OlGeometry>[] = [];\r\n          results.map((result) => {\r\n            const loopFeatures = effectiveOlFormats.readFeatures(result);\r\n            mfeatures = mfeatures.concat(loopFeatures);\r\n          });\r\n          this.built_properties_value(mfeatures).forEach(element => {\r\n            sourceFields.push(element);\r\n          });\r\n          d.next(sourceFields);\r\n          d.complete();\r\n        });\r\n    });\r\n  }\r\n\r\n  private built_properties_value(features: olFeature<OlGeometry>[]): string[] {\r\n    if (features.length === 0) {\r\n      return [];\r\n    }\r\n    const kv = Object.assign({}, features[0].getProperties());\r\n    delete kv[features[0].getGeometryName()];\r\n    delete kv.boundedBy;\r\n    const sourceFields = [];\r\n    for (const property in kv) {\r\n      if (kv.hasOwnProperty(property)) {\r\n        const fieldType =\r\n          typeof features[0].get(property) === 'object'\r\n            ? undefined\r\n            : typeof features[0].get(property);\r\n        sourceFields.push({\r\n          name: property,\r\n          alias: property,\r\n          type: fieldType,\r\n          values: [kv[property]]\r\n        });\r\n      }\r\n    }\r\n    features.every((element) => {\r\n      const featureProperties = element.getProperties();\r\n      for (const key in featureProperties) {\r\n        if (featureProperties.hasOwnProperty(key) && key in kv) {\r\n          sourceFields.filter(f => f.name === key).forEach(v => {\r\n            if (v.values.indexOf(featureProperties[key]) === -1) {\r\n              v.values.push(featureProperties[key]);\r\n            }\r\n          });\r\n        }\r\n      }\r\n      return true;\r\n    });\r\n    return sourceFields;\r\n  }\r\n}\r\n","import olTileGridWMTS from 'ol/tilegrid/WMTS';\r\nimport * as olproj from 'ol/proj';\r\nimport {\r\n  getTopLeft as extentGetTopLeft,\r\n  getWidth as extentGetWidth\r\n} from 'ol/extent.js';\r\n\r\nexport function createDefaultTileGrid(epsg?: string): olTileGridWMTS {\r\n  const projection = epsg ? olproj.get(epsg) : olproj.get('EPSG:3857');\r\n  const projectionExtent = projection.getExtent();\r\n  const size = extentGetWidth(projectionExtent) / 256;\r\n  const resolutions = new Array(20);\r\n  const matrixIds = new Array(20);\r\n  for (let z = 0; z < 20; ++z) {\r\n    resolutions[z] = size / Math.pow(2, z);\r\n    matrixIds[z] = z;\r\n  }\r\n\r\n  return new olTileGridWMTS({\r\n    origin: extentGetTopLeft(projectionExtent),\r\n    resolutions,\r\n    matrixIds\r\n  });\r\n}\r\n","import { Options } from 'ol/source/WMTS';\r\nimport olSourceWMTS from 'ol/source/WMTS';\r\n\r\nimport { createDefaultTileGrid } from '../../utils/tilegrid';\r\nimport { DataSource } from './datasource';\r\nimport { WMTSDataSourceOptions } from './wmts-datasource.interface';\r\n\r\nexport class WMTSDataSource extends DataSource {\r\n  public options: WMTSDataSourceOptions;\r\n  public ol: olSourceWMTS;\r\n\r\n  constructor(options: WMTSDataSourceOptions) {\r\n    super(options);\r\n  }\r\n\r\n  protected createOlSource(): olSourceWMTS {\r\n    const sourceOptions = Object.assign(\r\n      {\r\n        tileGrid: createDefaultTileGrid(this.options.projection as string)\r\n      },\r\n      this.options\r\n    ) as Options;\r\n\r\n    return new olSourceWMTS(sourceOptions);\r\n  }\r\n\r\n  public onUnwatch() {}\r\n\r\n}\r\n","import olSourceCarto from 'ol/source/CartoDB';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { Legend } from './datasource.interface';\r\nimport { CartoDataSourceOptions } from './carto-datasource.interface';\r\nimport { QueryHtmlTarget } from '../../../query/shared/query.enums';\r\n\r\nexport class CartoDataSource extends DataSource {\r\n  public ol: olSourceCarto;\r\n  public options: CartoDataSourceOptions;\r\n\r\n  get params(): any {\r\n    return this.options.params as any;\r\n  }\r\n\r\n  get queryTitle(): string {\r\n    return (this.options as any).queryTitle\r\n      ? (this.options as any).queryTitle\r\n      : 'title';\r\n  }\r\n\r\n  get mapLabel(): string {\r\n    return (this.options as any).mapLabel;\r\n  }\r\n\r\n  get queryHtmlTarget(): string {\r\n    return (this.options as any).queryHtmlTarget\r\n      ? (this.options as any).queryHtmlTarget\r\n      : QueryHtmlTarget.BLANK;\r\n  }\r\n\r\n  protected createOlSource(): olSourceCarto {\r\n    const crossOrigin = this.options.crossOrigin\r\n      ? this.options.crossOrigin\r\n      : 'anonymous';\r\n    const sourceOptions = Object.assign(\r\n      {\r\n        crossOrigin\r\n      },\r\n      this.options\r\n    );\r\n    return new olSourceCarto(sourceOptions);\r\n  }\r\n\r\n  getLegend(): Legend[] {\r\n    const legend = super.getLegend();\r\n    if (legend.length > 0) {\r\n      return legend;\r\n    }\r\n\r\n    let htmlString = '<table>';\r\n    if (this.options.config.layers[0].legend !== null) {\r\n      this.options.config.layers[0].legend.items.forEach(f => {\r\n        if (f.visible === true) {\r\n          htmlString +=\r\n            '<tr><td>' +\r\n            '<p><font size=\"5\" color=\"' +\r\n            f.value +\r\n            '\"> &#9679</font></p></td>' +\r\n            '<td>' +\r\n            f.name +\r\n            '</td></tr>';\r\n        }\r\n      });\r\n      htmlString += '</table>';\r\n      return [{ html: htmlString }];\r\n    } else {\r\n      // Try to build the legend from the cartocss options\r\n      const layerOptions = this.options.config.layers[0].options;\r\n      // All available cartocss style options\r\n      const types = [\r\n        'polygon-fill:',\r\n        'marker-fill:',\r\n        'shield-fill:',\r\n        'building-fill:',\r\n        'line-color:'\r\n      ];\r\n      for (const oneType of types) {\r\n        if (layerOptions.cartocss.includes(oneType)) {\r\n          const type = layerOptions.cartocss.split(oneType).pop();\r\n          const color = type.substr(0, type.indexOf(';'));\r\n          if (color.includes('ramp')) {\r\n            const colors = color.split(', (')[1].split(',');\r\n            const data = color.split(', (')[2].split(',');\r\n            for (let j = 0; j < colors.length; j++) {\r\n              colors[j] = colors[j].replace(/(\"|\\))/g, '');\r\n              data[j] = data[j].replace(/(\"|\\))/g, '');\r\n              if (data[j].replace(/\\s+/g, '') === '=') {\r\n                data[j] = 'Autres';\r\n              }\r\n              htmlString +=\r\n                '<tr><td>' +\r\n                '<p><font size=\"5\" color=\"' +\r\n                colors[j] +\r\n                '\"> &#9679</font></p></td>' +\r\n                '<td>' +\r\n                data[j] +\r\n                '</td></tr>';\r\n            }\r\n            break;\r\n          } else {\r\n            const title = layerOptions.layer_name\r\n              ? layerOptions.layer_name\r\n              : '';\r\n            htmlString +=\r\n              '<tr><td>' +\r\n              '<p><font size=\"5\" color=\"' +\r\n              color +\r\n              '\"> &#9679</font></p>' +\r\n              '</td><td>' +\r\n              title +\r\n              '</td></tr>';\r\n            break;\r\n          }\r\n        }\r\n      }\r\n      htmlString += '</table>';\r\n      return [{ html: htmlString }];\r\n    }\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import olSourceVector from 'ol/source/Vector';\r\nimport olFormatEsriJSON from 'ol/format/EsriJSON';\r\nimport * as olloadingstrategy from 'ol/loadingstrategy';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { Legend } from './datasource.interface';\r\nimport { ArcGISRestDataSourceOptions } from './arcgisrest-datasource.interface';\r\n\r\nexport class ArcGISRestDataSource extends DataSource {\r\n  public ol: olSourceVector<OlGeometry>;\r\n  public options: ArcGISRestDataSourceOptions;\r\n\r\n  protected createOlSource(): olSourceVector<OlGeometry> {\r\n    const esrijsonFormat = new olFormatEsriJSON();\r\n    return new olSourceVector({\r\n      attributions: this.options.params.attributions,\r\n      overlaps: false,\r\n      format: esrijsonFormat,\r\n      url: function(extent, resolution, proj) {\r\n        const baseUrl = this.options.url + '/' + this.options.layer + '/query/';\r\n        const geometry = encodeURIComponent(\r\n          '{\"xmin\":' +\r\n            extent[0] +\r\n            ',\"ymin\":' +\r\n            extent[1] +\r\n            ',\"xmax\":' +\r\n            extent[2] +\r\n            ',\"ymax\":' +\r\n            extent[3] +\r\n            ',\"spatialReference\":{\"wkid\":102100}}'\r\n        );\r\n        const params = [\r\n          'f=json',\r\n          `geometry=${geometry}`,\r\n          'geometryType=esriGeometryEnvelope',\r\n          'inSR=102100',\r\n          'spatialRel=esriSpatialRelIntersects',\r\n          'outFields=*',\r\n          'returnGeometry=true',\r\n          'outSR=102100'\r\n        ];\r\n        if (this.options.params.time) {\r\n          const time = `time=${this.options.params.time}`;\r\n          params.push(time);\r\n        }\r\n        if (this.options.params.customParams) {\r\n          this.options.params.customParams.forEach(element => {\r\n            params.push(element);\r\n          });\r\n        }\r\n        return `${baseUrl}?${params.join('&')}`;\r\n      }.bind(this),\r\n      strategy: olloadingstrategy.bbox\r\n    });\r\n  }\r\n\r\n  getLegend(): Legend[] {\r\n    const legendInfo = this.options.legendInfo;\r\n    const legend = super.getLegend();\r\n    if (legendInfo === undefined || legend.length > 0) {\r\n      return legend;\r\n    }\r\n    if (!legendInfo) {\r\n      return;\r\n    }\r\n    let htmlString = '<table>';\r\n    let src: string;\r\n    let label: string;\r\n    let svg: string;\r\n\r\n    if (legendInfo.legend) {\r\n      for (const legendElement of legendInfo.legend) {\r\n        src = this.htmlImgSrc(legendElement.contentType, legendElement.imageData);\r\n        label = legendElement.label ? legendElement.label.replace('<Null>', 'Null') : '';\r\n        htmlString +=\r\n          `<tr><td align='left'><img src=\"` +\r\n          src +\r\n          `\" alt ='' /></td><td class=\"mat-typography\">` +\r\n          label +\r\n          '</td></tr>';\r\n      }\r\n    } else if (legendInfo.type === \"uniqueValue\") {\r\n      for (const legendElement of legendInfo.uniqueValueInfos) {\r\n        label = legendElement.label.replace('<Null>', 'Null');\r\n        if (legendElement.symbol.type === 'esriPMS') {\r\n          src = this.htmlImgSrc(legendElement.symbol.contentType, legendElement.symbol.imageData);\r\n          htmlString +=\r\n            `<tr><td align='left'><img src=\"` +\r\n            src +\r\n            `\" alt ='' /></td><td class=\"mat-typography\">` +\r\n            label +\r\n            '</td></tr>';\r\n        } else if (legendElement.symbol.type !== 'esriPMS') {\r\n          svg = this.createSVG(legendElement.symbol);\r\n          htmlString += `<tr><td align='left'>` + svg + `</td><td class=\"mat-typography\">` + label + '</td></tr>';\r\n        }\r\n      }\r\n    } else if (legendInfo.type === \"simple\") {\r\n      label = legendInfo.label ? legendInfo.label.replace('<Null>', 'Null') : '';\r\n      if (legendInfo.symbol.type === 'esriPMS') {\r\n        src = this.htmlImgSrc(legendInfo.symbol.contentType, legendInfo.symbol.imageData);\r\n        htmlString +=\r\n          `<tr><td align='left'><img src=\"` +\r\n          src +\r\n          `\" alt ='' /></td><td class=\"mat-typography\">` +\r\n          label +\r\n          '</td></tr>';\r\n      } else if (legendInfo.symbol.type !== 'esriPMS') {\r\n        svg = this.createSVG(legendInfo.symbol);\r\n        htmlString += `<tr><td align='left'>` + svg + `</td><td class=\"mat-typography\">` + label + '</td></tr>';\r\n      }\r\n    }\r\n    htmlString += '</table>';\r\n    return [{ html: htmlString }];\r\n  }\r\n\r\n  htmlImgSrc(contentType: string, imageData: string): string {\r\n    return `data:${contentType};base64,${imageData}`;\r\n  }\r\n\r\n  createSVG(symbol): string {\r\n    let svg: string = '';\r\n\r\n    const color: Array<number> = symbol.color ? symbol.color : [0, 0, 0, 0];\r\n\r\n    if (symbol.type === 'esriSLS') {\r\n      const width: number = symbol.width ? symbol.width : 0;\r\n\r\n      const stroke: string = `stroke:rgba(` + color[0] + ',' + color[1] + ',' + color[2] + ',' + color[3] + ')';\r\n      const strokeWidth: string = `stroke-width:` + width;\r\n\r\n      if (symbol.style === 'esriSLSSolid') {\r\n        svg = `<svg height=\"30\" width=\"30\"><line x1=\"0\" y1=\"15\" x2=\"30\" y2=\"15\" style=\"` + stroke + ';' + strokeWidth + `\"/></svg>`;\r\n      } else if (symbol.style === 'esriSLSDash') {\r\n        const strokeDashArray: string = `stroke-dasharray=\"5,5\"`;\r\n        svg = `<svg height=\"30\" width=\"30\"><line x1=\"0\" y1=\"15\" x2=\"30\" y2=\"15\" style=\"` + stroke + ';' + strokeWidth + `\" `+ strokeDashArray + `/></svg>`;\r\n      }\r\n    } else if (symbol.style === 'esriSMSCircle' || symbol.style === 'esriSFSSolid') {\r\n      const outlineColor = symbol.outline.color;\r\n      const outlineWidth = symbol.outline.width;\r\n      const size = symbol.size;\r\n\r\n      const stroke = `stroke:rgba(` + outlineColor[0] + ',' + outlineColor[1] + ',' + outlineColor[2] + ',' + outlineColor[3] + ')';\r\n      const strokeWidth = `stroke-width:` + outlineWidth;\r\n      const fill = `fill:rgba(` + color[0] + ',' + color[1] + ',' + color[2] + ',' + color[3] + ')';\r\n\r\n      if (symbol.style === 'esriSMSCircle') {\r\n        svg = `<svg height=\"30\" width=\"30\"><circle cx=\"15\" cy=\"15\" r=\"` + size/2 + `\" style=\"` + stroke + ';' + strokeWidth + ';' + fill + `\"/></svg>`;\r\n      } else {\r\n        svg = `<svg height=\"30\" width=\"30\"><rect x=\"5\" y=\"5\" width=\"20\" height=\"20\" style =\"` + stroke + ';' + strokeWidth + ';' + fill + `\"/></svg>`;\r\n      }\r\n    }\r\n    return svg;\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import ImageArcGISRest from 'ol/source/ImageArcGISRest';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { Legend } from './datasource.interface';\r\nimport { ArcGISRestImageDataSourceOptions } from './imagearcgisrest-datasource.interface';\r\nimport { QueryHtmlTarget } from '../../../query/shared/query.enums';\r\nexport class ImageArcGISRestDataSource extends DataSource {\r\n  public ol: ImageArcGISRest;\r\n  public options: ArcGISRestImageDataSourceOptions;\r\n\r\n  get params(): any {\r\n    return this.options.params as any;\r\n  }\r\n\r\n  get queryTitle(): string {\r\n    return (this.options as any).queryTitle\r\n      ? (this.options as any).queryTitle\r\n      : 'title';\r\n  }\r\n\r\n  get mapLabel(): string {\r\n    return (this.options as any).mapLabel;\r\n  }\r\n\r\n  get queryHtmlTarget(): string {\r\n    return (this.options as any).queryHtmlTarget\r\n      ? (this.options as any).queryHtmlTarget\r\n      : QueryHtmlTarget.BLANK;\r\n  }\r\n\r\n  protected createOlSource(): ImageArcGISRest {\r\n    const params = this.options.layer === undefined ? this.options.params : Object.assign(\r\n      {LAYERS: `show:${this.options.layer}`},\r\n      this.options.params\r\n    );\r\n\r\n    if (typeof params.renderingRule === 'object') {\r\n      params.renderingRule = JSON.stringify(params.renderingRule);\r\n    }\r\n\r\n    return new ImageArcGISRest({\r\n      ratio: 1,\r\n      params,\r\n      url: this.options.url\r\n    });\r\n  }\r\n\r\n  getLegend(): Legend[] {\r\n    const legendInfo = this.options.legendInfo;\r\n    const legend = super.getLegend();\r\n    if (legendInfo === undefined || this.options.layer === undefined || legend.length > 0) {\r\n      return legend;\r\n    }\r\n\r\n    if (!legendInfo) {\r\n      return;\r\n    }\r\n    let htmlString = '<table>';\r\n\r\n    for (const legendElement of legendInfo.legend) {\r\n      const src = `${this.options.url}/${legendInfo.layerId}/images/${legendElement.url}`;\r\n      const label = legendElement.label.replace('<Null>', 'Null');\r\n      htmlString +=\r\n        `<tr><td align='left'><img src=\"` +\r\n        src +\r\n        `\" alt ='' /></td><td class=\"mat-typography\">` +\r\n        label +\r\n        '</td></tr>';\r\n    }\r\n    htmlString += '</table>';\r\n    return [{ html: htmlString }];\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import olSourceTileArcGISRest from 'ol/source/TileArcGISRest';\r\nimport { Options } from 'ol/source/TileArcGISRest';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { Legend } from './datasource.interface';\r\nimport { TileArcGISRestDataSourceOptions } from './tilearcgisrest-datasource.interface';\r\nimport { QueryHtmlTarget } from '../../../query/shared/query.enums';\r\n\r\nexport class TileArcGISRestDataSource extends DataSource {\r\n  public ol: olSourceTileArcGISRest;\r\n  public options: TileArcGISRestDataSourceOptions;\r\n\r\n  get params(): any {\r\n    return this.options.params as any;\r\n  }\r\n\r\n  get queryTitle(): string {\r\n    return (this.options as any).queryTitle\r\n      ? (this.options as any).queryTitle\r\n      : 'title';\r\n  }\r\n\r\n  get mapLabel(): string {\r\n    return (this.options as any).mapLabel;\r\n  }\r\n\r\n  get queryHtmlTarget(): string {\r\n    return (this.options as any).queryHtmlTarget\r\n      ? (this.options as any).queryHtmlTarget\r\n      : QueryHtmlTarget.BLANK;\r\n  }\r\n\r\n  protected createOlSource(): olSourceTileArcGISRest {\r\n    return new olSourceTileArcGISRest(this.options as Options);\r\n  }\r\n\r\n  getLegend(): Legend[] {\r\n    const legendInfo = this.options.legendInfo;\r\n    const legend = super.getLegend();\r\n    if (legendInfo === undefined || this.options.layer === undefined || legend.length > 0) {\r\n      return legend;\r\n    }\r\n\r\n    if (!legendInfo) {\r\n      return;\r\n    }\r\n    let htmlString = '<table>';\r\n\r\n    for (const legendElement of legendInfo.legend) {\r\n      const src = `${this.options.url}/${legendInfo.layerId}/images/${legendElement.url}`;\r\n      const label = legendElement.label.replace('<Null>', 'Null');\r\n      htmlString +=\r\n        `<tr><td align='left'><img src=\"` +\r\n        src +\r\n        `\" alt ='' /></td><td class=\"mat-typography\">` +\r\n        label +\r\n        '</td></tr>';\r\n    }\r\n    htmlString += '</table>';\r\n    return [{ html: htmlString }];\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import TileDebug from 'ol/source/TileDebug';\r\nimport TileGrid from 'ol/tilegrid/TileGrid';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { TileDebugDataSourceOptions } from './tiledebug-datasource.interface';\r\n\r\nexport class TileDebugDataSource extends DataSource {\r\n  public options: TileDebugDataSourceOptions;\r\n  public ol: TileDebug;\r\n\r\n  protected createOlSource(): TileDebug {\r\n    const baseOptions = JSON.parse(JSON.stringify(this.options)); // to avoid to alter the original options\r\n    if (this.options.tileGrid) {\r\n      delete baseOptions.tileGrid;\r\n      baseOptions.tileGrid = new TileGrid(this.options.tileGrid);\r\n    }\r\n    return new TileDebug(baseOptions);\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import olSourceVector from 'ol/source/Vector';\r\nimport olFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport { FeatureDataSource } from './feature-datasource';\r\nimport { WebSocketDataSourceOptions } from './websocket-datasource.interface';\r\n\r\nexport class WebSocketDataSource extends FeatureDataSource {\r\n  public ws: WebSocket;\r\n  public options: WebSocketDataSourceOptions;\r\n\r\n  protected createOlSource(): olSourceVector<OlGeometry> {\r\n    this.createWebSocket();\r\n    this.options.format = this.getSourceFormatFromOptions(this.options);\r\n    return super.createOlSource();\r\n  }\r\n\r\n  private createWebSocket() {\r\n    this.ws = new WebSocket(this.options.url);\r\n    this.ws.onmessage = this.onMessage.bind(this);\r\n\r\n    if (this.options.onclose) {\r\n      this.ws.onclose = this.onClose.bind(this);\r\n    }\r\n\r\n    if (this.options.onerror) {\r\n      this.ws.onerror = this.onError.bind(this);\r\n    }\r\n\r\n    if (this.options.onopen) {\r\n      this.ws.onopen = this.onOpen.bind(this);\r\n    }\r\n  }\r\n\r\n  onMessage(event) {\r\n    const featureAdded = this.options.format.readFeature(event.data) as olFeature<OlGeometry>;\r\n\r\n    switch (this.options.onmessage) {\r\n      case 'update':\r\n        // ol don't add if same ID\r\n        const featureToRemove = this.ol.getFeatureById(featureAdded.getId());\r\n        if (featureToRemove) {\r\n          this.ol.removeFeature(featureToRemove);\r\n        }\r\n        this.ol.addFeature(featureAdded);\r\n        break;\r\n      case 'delete':\r\n        this.ol.clear(true);\r\n        this.ol.addFeature(featureAdded);\r\n        break;\r\n      case 'add':\r\n      default:\r\n        this.ol.addFeature(featureAdded);\r\n    }\r\n  }\r\n\r\n  onClose(event) {\r\n    // thrown message to user\r\n  }\r\n\r\n  onError(event) {\r\n    // thrown message to user\r\n  }\r\n\r\n  onOpen(event) {\r\n    // thrown message to user ?\r\n  }\r\n\r\n  public onUnwatch() {\r\n    this.ws.close();\r\n  }\r\n}\r\n","import { Md5 } from 'ts-md5';\r\nimport feature from 'ol/Feature';\r\nimport olSourceVectorTile from 'ol/source/VectorTile';\r\nimport olFormatMVT from 'ol/format/MVT';\r\n\r\nimport { uuid } from '@igo2/utils';\r\n\r\nimport { DataSource } from './datasource';\r\nimport { MVTDataSourceOptions } from './mvt-datasource.interface';\r\n\r\nexport class MVTDataSource extends DataSource {\r\n  public options: MVTDataSourceOptions;\r\n  public ol: olSourceVectorTile;\r\n\r\n  protected createOlSource(): olSourceVectorTile {\r\n    let mvtFormat;\r\n    if (this.options.featureClass === 'feature') {\r\n      mvtFormat = new olFormatMVT({featureClass: feature});\r\n    } else {\r\n      mvtFormat = new olFormatMVT();\r\n    }\r\n    this.options.format = mvtFormat;\r\n    return new olSourceVectorTile(this.options);\r\n  }\r\n\r\n  protected generateId() {\r\n    if (!this.options.url) {\r\n        return uuid();\r\n    }\r\n    const chain = 'mvt' + this.options.url;\r\n    return Md5.hashStr(chain) as string;\r\n  }\r\n\r\n  public onUnwatch() {}\r\n}\r\n","import * as olstyle from 'ol/style';\r\nimport * as olproj from 'ol/proj';\r\n\r\nexport class EsriStyleGenerator {\r\n  public _converters: any;\r\n  public _renderers: any;\r\n\r\n  constructor() {\r\n    this._converters = {};\r\n    this._converters.esriPMS = EsriStyleGenerator._convertEsriPMS;\r\n    this._converters.esriSFS = EsriStyleGenerator._convertEsriSFS;\r\n    this._converters.esriSLS = EsriStyleGenerator._convertEsriSLS;\r\n    this._converters.esriSMS = EsriStyleGenerator._convertEsriSMS;\r\n    this._converters.esriTS = EsriStyleGenerator._convertEsriTS;\r\n    this._renderers = {};\r\n    this._renderers.uniqueValue = this._renderUniqueValue;\r\n    this._renderers.simple = this._renderSimple;\r\n    this._renderers.classBreaks = this._renderClassBreaks;\r\n  }\r\n  static _convertPointToPixel(point) {\r\n    return point / 0.75;\r\n  }\r\n  static _transformColor(color): [number, number, number, number] {\r\n    // alpha channel is different, runs from 0-255 but in ol3 from 0-1\r\n    return [color[0], color[1], color[2], color[3] / 255];\r\n  }\r\n\r\n  static _getResolutionForScale(scale, units) {\r\n    const dpi = 96;\r\n    const mpu = olproj.METERS_PER_UNIT[units];\r\n    const inchesPerMeter = 39.3701;\r\n    return parseFloat(scale) / (mpu * inchesPerMeter * dpi);\r\n  }\r\n\r\n  /* convert an Esri Text Symbol */\r\n  static _convertEsriTS(symbol) {\r\n    const rotation = EsriStyleGenerator._transformAngle(symbol.angle);\r\n    const text = symbol.text !== undefined ? symbol.text : undefined;\r\n    return new olstyle.Style({\r\n      text: new olstyle.Text({\r\n        fill: new olstyle.Fill({\r\n          color: EsriStyleGenerator._transformColor(symbol.color)\r\n        }),\r\n        font:\r\n          symbol.font.style +\r\n          ' ' +\r\n          symbol.font.weight +\r\n          ' ' +\r\n          symbol.font.size +\r\n          ' px ' +\r\n          symbol.font.family,\r\n        textBaseline: symbol.verticalAlignment,\r\n        textAlign: symbol.horizontalAlignment,\r\n        offsetX: EsriStyleGenerator._convertPointToPixel(symbol.xoffset),\r\n        offsetY: EsriStyleGenerator._convertPointToPixel(symbol.yoffset),\r\n        rotation,\r\n        text\r\n      })\r\n    });\r\n  }\r\n  /* convert an Esri Picture Marker Symbol */\r\n  static _convertEsriPMS(symbol) {\r\n    const src = 'data:' + symbol.contentType + ';base64, ' + symbol.imageData;\r\n    const rotation = EsriStyleGenerator._transformAngle(symbol.angle);\r\n\r\n    return new olstyle.Style({\r\n      image: new olstyle.Icon({\r\n        src,\r\n        rotation\r\n      })\r\n    });\r\n  }\r\n  /* convert an Esri Simple Fill Symbol */\r\n  static _convertEsriSFS(symbol) {\r\n    // there is no support in openlayers currently for fill patterns, so style is not interpreted\r\n    const fill = new olstyle.Fill({\r\n      color: EsriStyleGenerator._transformColor(symbol.color)\r\n    });\r\n    const stroke = symbol.outline\r\n      ? EsriStyleGenerator._convertOutline(symbol.outline)\r\n      : undefined;\r\n    return new olstyle.Style({\r\n      fill,\r\n      stroke\r\n    });\r\n  }\r\n  static _convertOutline(outline) {\r\n    let lineDash;\r\n    const color = EsriStyleGenerator._transformColor(outline.color);\r\n    if (outline.style === 'esriSLSDash') {\r\n      lineDash = [5];\r\n    } else if (outline.style === 'esriSLSDashDot') {\r\n      lineDash = [5, 5, 1, 2];\r\n    } else if (outline.style === 'esriSLSDashDotDot') {\r\n      lineDash = [5, 5, 1, 2, 1, 2];\r\n    } else if (outline.style === 'esriSLSDot') {\r\n      lineDash = [1, 2];\r\n    } else if (outline.style === 'esriSLSNull') {\r\n      // line not visible, make color fully transparent\r\n      color[3] = 0;\r\n    }\r\n    return new olstyle.Stroke({\r\n      color,\r\n      lineDash,\r\n      width: EsriStyleGenerator._convertPointToPixel(outline.width)\r\n    });\r\n  }\r\n  /* convert an Esri Simple Line Symbol */\r\n  static _convertEsriSLS(symbol) {\r\n    return new olstyle.Style({\r\n      stroke: EsriStyleGenerator._convertOutline(symbol)\r\n    });\r\n  }\r\n  static _transformAngle(angle) {\r\n    if (angle === 0 || angle === undefined) {\r\n      return undefined;\r\n    }\r\n    const normalRad = (angle * Math.PI) / 180;\r\n    const ol3Rad = -normalRad + Math.PI / 2;\r\n    if (ol3Rad < 0) {\r\n      return 2 * Math.PI + ol3Rad;\r\n    } else {\r\n      return ol3Rad;\r\n    }\r\n  }\r\n  /* convert an Esri Simple Marker Symbol */\r\n  static _convertEsriSMS(symbol) {\r\n    const fill = new olstyle.Fill({\r\n      color: EsriStyleGenerator._transformColor(symbol.color)\r\n    });\r\n    const stroke = symbol.outline\r\n      ? EsriStyleGenerator._convertOutline(symbol.outline)\r\n      : undefined;\r\n    const radius = EsriStyleGenerator._convertPointToPixel(symbol.size) / 2;\r\n    const rotation = EsriStyleGenerator._transformAngle(symbol.angle);\r\n    if (symbol.style === 'esriSMSCircle') {\r\n      return new olstyle.Style({\r\n        image: new olstyle.Circle({\r\n          radius,\r\n          fill,\r\n          stroke\r\n        })\r\n      });\r\n    } else if (symbol.style === 'esriSMSCross') {\r\n      return new olstyle.Style({\r\n        image: new olstyle.RegularShape({\r\n          fill,\r\n          stroke,\r\n          points: 4,\r\n          radius,\r\n          radius2: 0,\r\n          angle: 0,\r\n          rotation\r\n        })\r\n      });\r\n    } else if (symbol.style === 'esriSMSDiamond') {\r\n      return new olstyle.Style({\r\n        image: new olstyle.RegularShape({\r\n          fill,\r\n          stroke,\r\n          points: 4,\r\n          radius,\r\n          rotation\r\n        })\r\n      });\r\n    } else if (symbol.style === 'esriSMSSquare') {\r\n      return new olstyle.Style({\r\n        image: new olstyle.RegularShape({\r\n          fill,\r\n          stroke,\r\n          points: 4,\r\n          radius,\r\n          angle: Math.PI / 4,\r\n          rotation\r\n        })\r\n      });\r\n    } else if (symbol.style === 'esriSMSX') {\r\n      return new olstyle.Style({\r\n        image: new olstyle.RegularShape({\r\n          fill,\r\n          stroke,\r\n          points: 4,\r\n          radius,\r\n          radius2: 0,\r\n          angle: Math.PI / 4,\r\n          rotation\r\n        })\r\n      });\r\n    } else if (symbol.style === 'esriSMSTriangle') {\r\n      return new olstyle.Style({\r\n        image: new olstyle.RegularShape({\r\n          fill,\r\n          stroke,\r\n          points: 3,\r\n          radius,\r\n          angle: 0,\r\n          rotation\r\n        })\r\n      });\r\n    }\r\n  }\r\n\r\n  _convertLabelingInfo(labelingInfo, mapUnits) {\r\n    const styles = [];\r\n    for (let i = 0, ii = labelingInfo.length; i < ii; ++i) {\r\n      const labelExpression = labelingInfo[i].labelExpression;\r\n      // only limited support for label expressions\r\n      const field = labelExpression.substr(\r\n        labelExpression.indexOf('[') + 1,\r\n        labelExpression.indexOf(']') - 1\r\n      );\r\n      const symbol = labelingInfo[i].symbol;\r\n      const maxScale = labelingInfo[i].maxScale;\r\n      const minScale = labelingInfo[i].minScale;\r\n      let minResolution = null;\r\n      if (maxScale !== 0) {\r\n        minResolution = EsriStyleGenerator._getResolutionForScale(\r\n          maxScale,\r\n          mapUnits\r\n        );\r\n      }\r\n      let maxResolution = null;\r\n      if (minScale !== 0) {\r\n        maxResolution = EsriStyleGenerator._getResolutionForScale(\r\n          minScale,\r\n          mapUnits\r\n        );\r\n      }\r\n      const style = this._converters[symbol.type].call(this, symbol);\r\n      styles.push(\r\n        (() => {\r\n          return function(feature, resolution) {\r\n            let visible = true;\r\n            if (this.minResolution !== null && this.maxResolution !== null) {\r\n              visible =\r\n                resolution < this.maxResolution &&\r\n                resolution >= this.minResolution;\r\n            } else if (this.minResolution !== null) {\r\n              visible = resolution >= this.minResolution;\r\n            } else if (this.maxResolution !== null) {\r\n              visible = resolution < this.maxResolution;\r\n            }\r\n            if (visible) {\r\n              const value = feature.get(this.field);\r\n              this.style.getText().setText(value);\r\n              return [this.style];\r\n            }\r\n          };\r\n        })().bind({\r\n          minResolution,\r\n          maxResolution,\r\n          field,\r\n          style\r\n        })\r\n      );\r\n    }\r\n    return styles;\r\n  }\r\n\r\n  _renderSimple(renderer) {\r\n    const style = this._converters[renderer.symbol.type].call(\r\n      this,\r\n      renderer.symbol\r\n    );\r\n    return (() => {\r\n      return () => {\r\n        return [style];\r\n      };\r\n    })();\r\n  }\r\n  _renderClassBreaks(renderer) {\r\n    const defaultSymbol = renderer.defaultSymbol;\r\n    const defaultStyle = this._converters[defaultSymbol.type].call(\r\n      this,\r\n      defaultSymbol\r\n    );\r\n    const field = renderer.field;\r\n    const classes = [];\r\n    for (let i = 0, ii = renderer.classBreakInfos.length; i < ii; ++i) {\r\n      const classBreakInfo = renderer.classBreakInfos[i];\r\n      let min;\r\n      if (\r\n        classBreakInfo.classMinValue === null ||\r\n        classBreakInfo.classMinValue === undefined\r\n      ) {\r\n        if (i === 0) {\r\n          min = renderer.minValue;\r\n        } else {\r\n          min = renderer.classBreakInfos[i - 1].classMaxValue;\r\n        }\r\n      } else {\r\n        min = classBreakInfo.classMinValue;\r\n      }\r\n      const max = classBreakInfo.classMaxValue;\r\n      const symbol = classBreakInfo.symbol;\r\n      const style = this._converters[symbol.type].call(this, symbol);\r\n      classes.push({ min, max, style });\r\n    }\r\n    return (() => {\r\n      return (feature) => {\r\n        const value = feature.get(field);\r\n        for (let i = 0, ii = classes.length; i < ii; ++i) {\r\n          let condition;\r\n          if (i === 0) {\r\n            condition = value >= classes[i].min && value <= classes[i].max;\r\n          } else {\r\n            condition = value > classes[i].min && value <= classes[i].max;\r\n          }\r\n          if (condition) {\r\n            return [classes[i].style];\r\n          }\r\n        }\r\n        return [defaultStyle];\r\n      };\r\n    })();\r\n  }\r\n  _renderUniqueValue(renderer) {\r\n    const defaultSymbol = renderer.defaultSymbol;\r\n    let defaultStyle = [];\r\n    if (defaultSymbol) {\r\n      defaultStyle = [\r\n        this._converters[defaultSymbol.type].call(this, defaultSymbol)\r\n      ];\r\n    }\r\n    const field = renderer.field1;\r\n    const infos = renderer.uniqueValueInfos;\r\n    const me = this;\r\n    return (() => {\r\n      const hash = {};\r\n      for (let i = 0, ii = infos.length; i < ii; ++i) {\r\n        const info = infos[i];\r\n        const symbol = info.symbol;\r\n        hash[info.value] = [me._converters[symbol.type].call(me, symbol)];\r\n      }\r\n\r\n      return (feature) => {\r\n        const style = hash[feature.get(field)];\r\n        return style ? style : defaultStyle;\r\n      };\r\n    })();\r\n  }\r\n  generateStyle(layerInfo, mapUnits) {\r\n    const drawingInfo = layerInfo.drawingInfo;\r\n    let styleFunctions = [];\r\n    const drawingInfoStyle = this._renderers[drawingInfo.renderer.type].call(\r\n      this,\r\n      drawingInfo.renderer\r\n    );\r\n    if (drawingInfoStyle !== undefined) {\r\n      styleFunctions.push(drawingInfoStyle);\r\n    }\r\n    if (layerInfo.labelingInfo) {\r\n      const labelingInfoStyleFunctions = this._convertLabelingInfo(\r\n        layerInfo.labelingInfo,\r\n        mapUnits\r\n      );\r\n      styleFunctions = styleFunctions.concat(labelingInfoStyleFunctions);\r\n    }\r\n    if (styleFunctions.length === 1) {\r\n      return styleFunctions[0];\r\n    } else {\r\n      return (() => {\r\n        return (feature, resolution) => {\r\n          let styles = [];\r\n          for (let i = 0, ii = styleFunctions.length; i < ii; ++i) {\r\n            const result = styleFunctions[i].call(null, feature, resolution);\r\n            if (result) {\r\n              styles = styles.concat(result);\r\n            }\r\n          }\r\n          return styles;\r\n        };\r\n      })();\r\n    }\r\n  }\r\n}\r\n","export enum TimeFilterType {\r\n    DATE = 'date',\r\n    TIME = 'time',\r\n    DATETIME = 'datetime',\r\n    YEAR = 'year',\r\n}\r\n\r\nexport enum TimeFilterStyle {\r\n    CALENDAR = 'calendar',\r\n    SLIDER = 'slider',\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { IgoMap } from './map';\r\n\r\n/**\r\n * MapService\r\n *\r\n * This service tracks the IgoMap instance, if any.\r\n * Currently, only one map instance is supported\r\n * but support for multiple maps may be added in the future.\r\n * This will impact other services such as the OverlayService\r\n * because these maps won't be sharing overlayed features.\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class MapService {\r\n  private map: IgoMap;\r\n\r\n  constructor() {}\r\n\r\n  getMap(): IgoMap {\r\n    return this.map;\r\n  }\r\n\r\n  setMap(map: IgoMap) {\r\n    this.map = map;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport {\r\n  HttpClient,\r\n  HttpParams\r\n} from '@angular/common/http';\r\nimport { Observable, forkJoin, of } from 'rxjs';\r\nimport { map, catchError } from 'rxjs/operators';\r\nimport { Cacheable } from 'ts-cacheable';\r\n\r\nimport { WMSCapabilities, WMTSCapabilities, EsriJSON } from 'ol/format';\r\nimport { optionsFromCapabilities } from 'ol/source/WMTS.js';\r\nimport olAttribution from 'ol/control/Attribution';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\nimport { MapService } from '../../map/shared/map.service';\r\nimport { getResolutionFromScale } from '../../map/shared/map.utils';\r\nimport { EsriStyleGenerator } from '../utils/esri-style-generator';\r\nimport {\r\n  QueryFormat,\r\n  QueryFormatMimeType\r\n} from '../../query/shared/query.enums';\r\n\r\nimport {\r\n  WMTSDataSourceOptions,\r\n  WMSDataSourceOptions,\r\n  CartoDataSourceOptions,\r\n  ArcGISRestDataSourceOptions,\r\n  TileArcGISRestDataSourceOptions,\r\n  ArcGISRestImageDataSourceOptions\r\n} from './datasources';\r\nimport {\r\n  LegendOptions,\r\n  ItemStyleOptions\r\n} from '../../layer/shared/layers/layer.interface';\r\nimport {\r\n  TimeFilterType,\r\n  TimeFilterStyle\r\n} from '../../filter/shared/time-filter.enum';\r\nimport * as olproj from 'ol/proj';\r\n\r\nexport enum TypeCapabilities {\r\n  wms = 'wms',\r\n  wmts = 'wmts',\r\n  arcgisrest = 'esriJSON',\r\n  imagearcgisrest = 'esriJSON',\r\n  tilearcgisrest = 'esriJSON'\r\n}\r\n\r\nexport type TypeCapabilitiesStrings = keyof typeof TypeCapabilities;\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class CapabilitiesService {\r\n  private parsers = {\r\n    wms: new WMSCapabilities(),\r\n    wmts: new WMTSCapabilities(),\r\n    esriJSON: new EsriJSON()\r\n  };\r\n\r\n  constructor(private http: HttpClient, private mapService: MapService) {}\r\n\r\n  getWMSOptions(\r\n    baseOptions: WMSDataSourceOptions\r\n  ): Observable<WMSDataSourceOptions> {\r\n    const url = baseOptions.url;\r\n    const version = (baseOptions.params as any).VERSION;\r\n\r\n    return this.getCapabilities('wms', url, version).pipe(\r\n      map((capabilities: any) => {\r\n        return capabilities\r\n          ? this.parseWMSOptions(baseOptions, capabilities)\r\n          : undefined;\r\n      })\r\n    );\r\n  }\r\n\r\n  getWMTSOptions(\r\n    baseOptions: WMTSDataSourceOptions\r\n  ): Observable<WMTSDataSourceOptions> {\r\n    const url = baseOptions.url;\r\n    const version = baseOptions.version;\r\n\r\n    const options = this.getCapabilities('wmts', url, version).pipe(\r\n      map((capabilities: any) => {\r\n        return capabilities\r\n          ? this.parseWMTSOptions(baseOptions, capabilities)\r\n          : undefined;\r\n      })\r\n    );\r\n    return options;\r\n  }\r\n\r\n  getCartoOptions(\r\n    baseOptions: CartoDataSourceOptions\r\n  ): Observable<CartoDataSourceOptions> {\r\n    const baseUrl =\r\n      'https://' +\r\n      baseOptions.account +\r\n      '.carto.com/api/v2/viz/' +\r\n      baseOptions.mapId +\r\n      '/viz.json';\r\n\r\n    return this.http\r\n      .jsonp(baseUrl, 'callback')\r\n      .pipe(\r\n        map((cartoOptions: any) =>\r\n          this.parseCartoOptions(baseOptions, cartoOptions)\r\n        )\r\n      );\r\n  }\r\n\r\n  getArcgisOptions(\r\n    baseOptions: ArcGISRestDataSourceOptions\r\n  ): Observable<ArcGISRestDataSourceOptions> {\r\n    const baseUrl = baseOptions.url + '/' + baseOptions.layer + '?f=json';\r\n    const modifiedUrl = baseOptions.url.replace('FeatureServer', 'MapServer');\r\n    const legendUrl = modifiedUrl + '/legend?f=json';\r\n    const serviceCapabilities = this.getCapabilities('arcgisrest', baseOptions.url);\r\n    const arcgisOptions = this.http.get(baseUrl);\r\n    const legend = this.http.get(legendUrl).pipe(\r\n      map((res: any) => res),\r\n      catchError((err) => {\r\n        console.log('No legend associated with this Feature Service');\r\n        return of(err);\r\n      })\r\n    );\r\n    return forkJoin([arcgisOptions, legend, serviceCapabilities]).pipe(\r\n      map((res: any) => {\r\n        return this.parseArcgisOptions(baseOptions, res[0], res[1], res[2]);\r\n      })\r\n    );\r\n  }\r\n\r\n  getImageArcgisOptions(\r\n    baseOptions: ArcGISRestImageDataSourceOptions | TileArcGISRestDataSourceOptions\r\n  ): Observable<ArcGISRestImageDataSourceOptions | TileArcGISRestDataSourceOptions> {\r\n    const baseUrl = baseOptions.url + '/' + baseOptions.layer + '?f=json';\r\n    const modifiedUrl = baseOptions.url.replace('FeatureServer', 'MapServer');\r\n    const legendUrl = modifiedUrl + '/legend?f=json';\r\n    const serviceCapabilities = this.getCapabilities('imagearcgisrest', baseOptions.url);\r\n    const arcgisOptions = this.http.get(baseUrl);\r\n    const legend = this.http.get(legendUrl).pipe(\r\n      map((res: any) => res),\r\n      catchError((err) => {\r\n        console.log('No legend associated with this Image Service');\r\n        return of(err);\r\n      })\r\n    );\r\n    return forkJoin([arcgisOptions, legend, serviceCapabilities]).pipe(\r\n      map((res: any) => {\r\n        return this.parseTileOrImageArcgisOptions(baseOptions, res[0], res[1], res[2]);\r\n      })\r\n    );\r\n  }\r\n\r\n  getTileArcgisOptions(\r\n    baseOptions: TileArcGISRestDataSourceOptions\r\n  ): Observable<ArcGISRestImageDataSourceOptions | TileArcGISRestDataSourceOptions> {\r\n    const baseUrl = baseOptions.url + '/' + baseOptions.layer + '?f=json';\r\n    const legendUrl = baseOptions.url + '/legend?f=json';\r\n    const serviceCapabilities = this.getCapabilities('tilearcgisrest', baseOptions.url);\r\n    const arcgisOptions = this.http.get(baseUrl);\r\n    const legendInfo = this.http.get(legendUrl).pipe(\r\n      map((res: any) => res),\r\n      catchError((err) => {\r\n        console.log('No legend associated with this Tile Service');\r\n        return of(err);\r\n      })\r\n    );\r\n    return forkJoin([arcgisOptions, legendInfo, serviceCapabilities]).pipe(\r\n      map((res: any) =>\r\n        this.parseTileOrImageArcgisOptions(baseOptions, res[0], res[1], res[2])\r\n      )\r\n    );\r\n  }\r\n\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  getCapabilities(\r\n    service: TypeCapabilitiesStrings,\r\n    baseUrl: string,\r\n    version?: string\r\n  ): Observable<any> {\r\n    const params = new HttpParams({\r\n      fromObject: {\r\n        request: 'GetCapabilities',\r\n        service: service.toUpperCase(),\r\n        version: version || '1.3.0',\r\n        _i: 'true'\r\n      }\r\n    });\r\n\r\n    let request;\r\n    if (TypeCapabilities[service] === 'esriJSON') {\r\n      request = this.http.get(baseUrl + '?f=json');\r\n    } else {\r\n      request = this.http.get(baseUrl, {\r\n        params,\r\n        responseType: 'text'\r\n      });\r\n    }\r\n\r\n    return request.pipe(\r\n      map((res) => {\r\n        if (TypeCapabilities[service] === 'esriJSON') {\r\n          return res as object;\r\n        }\r\n        if (\r\n          String(res).toLowerCase().includes('serviceexception') &&\r\n          String(res).toLowerCase().includes('access denied')\r\n        ) {\r\n          throw {\r\n            error: {\r\n              message: 'Service error getCapabilities: Access is denied'\r\n            }\r\n          };\r\n        } else {\r\n          return this.parsers[service].read(res);\r\n        }\r\n      }),\r\n      catchError((e) => {\r\n        if (typeof e.error !== 'undefined') {\r\n          e.error.caught = true;\r\n        }\r\n        throw e;\r\n      })\r\n    );\r\n  }\r\n\r\n  private parseWMSOptions(\r\n    baseOptions: WMSDataSourceOptions,\r\n    capabilities: any\r\n  ): WMSDataSourceOptions {\r\n    const layers = (baseOptions.params as any).LAYERS;\r\n    const layer = this.findDataSourceInCapabilities(\r\n      capabilities.Capability.Layer,\r\n      layers\r\n    );\r\n\r\n    if (!layer) {\r\n      throw {\r\n        error: {\r\n          message: 'Layer not found'\r\n        }\r\n      };\r\n    }\r\n    const metadata = layer.DataURL ? layer.DataURL[0] : undefined;\r\n    const abstract = layer.Abstract ? layer.Abstract : undefined;\r\n    const keywordList = layer.KeywordList ? layer.KeywordList : undefined;\r\n    let queryable = layer.queryable;\r\n    const timeFilter = this.getTimeFilter(layer);\r\n    const timeFilterable = timeFilter && Object.keys(timeFilter).length > 0;\r\n    const legendOptions = layer.Style ? this.getStyle(layer.Style) : undefined;\r\n    let isExtentInGeographic = true;\r\n    if (layer.EX_GeographicBoundingBox) {\r\n      layer.EX_GeographicBoundingBox.forEach((coord, index) => {\r\n        if (index < 2 && (coord > 180 || coord < -180)) {\r\n          isExtentInGeographic = false;\r\n        }\r\n        if (index >= 2 && (coord > 90 || coord < -90)) {\r\n          isExtentInGeographic = false;\r\n        }\r\n      });\r\n    } else {\r\n      isExtentInGeographic = false;\r\n    }\r\n\r\n    const extent = isExtentInGeographic ?\r\n        olproj.transformExtent(layer.EX_GeographicBoundingBox, 'EPSG:4326', this.mapService.getMap().projection) :\r\n        undefined;\r\n\r\n    let queryFormat: QueryFormat;\r\n    const queryFormatMimeTypePriority = [\r\n      QueryFormatMimeType.GEOJSON,\r\n      QueryFormatMimeType.GEOJSON2,\r\n      QueryFormatMimeType.GML3,\r\n      QueryFormatMimeType.GML2,\r\n      QueryFormatMimeType.JSON,\r\n      QueryFormatMimeType.HTML\r\n    ];\r\n\r\n    for (const mimeType of queryFormatMimeTypePriority) {\r\n      if (\r\n        capabilities.Capability.Request.GetFeatureInfo.Format.indexOf(\r\n          mimeType\r\n        ) !== -1\r\n      ) {\r\n        const keyEnum = Object.keys(QueryFormatMimeType).find(\r\n          (key) => QueryFormatMimeType[key] === mimeType\r\n        );\r\n        queryFormat = QueryFormat[keyEnum];\r\n        break;\r\n      }\r\n    }\r\n    if (!queryFormat) {\r\n      queryable = false;\r\n    }\r\n\r\n    const options: WMSDataSourceOptions = ObjectUtils.removeUndefined({\r\n      _layerOptionsFromSource: {\r\n        title: layer.Title,\r\n        maxResolution: getResolutionFromScale(layer.MaxScaleDenominator),\r\n        minResolution: getResolutionFromScale(layer.MinScaleDenominator),\r\n        extent,\r\n        metadata: {\r\n          url: metadata ? metadata.OnlineResource : undefined,\r\n          extern: metadata ? true : undefined,\r\n          abstract,\r\n          keywordList\r\n        },\r\n        legendOptions\r\n      },\r\n      queryable,\r\n      queryFormat,\r\n      timeFilter: timeFilterable ? timeFilter : undefined,\r\n      timeFilterable: timeFilterable ? true : undefined,\r\n      minDate: timeFilterable ? timeFilter.min : undefined,\r\n      maxDate: timeFilterable ? timeFilter.max : undefined,\r\n      stepDate: timeFilterable ? timeFilter.step : undefined\r\n    });\r\n\r\n    return ObjectUtils.mergeDeep(options, baseOptions);\r\n  }\r\n\r\n  private parseWMTSOptions(\r\n    baseOptions: WMTSDataSourceOptions,\r\n    capabilities: any\r\n  ): WMTSDataSourceOptions {\r\n    // Put Title source in _layerOptionsFromSource. (For source & catalog in _layerOptionsFromSource, if not already on config)\r\n    const layer = capabilities.Contents.Layer.find(\r\n      (el) => el.Identifier === baseOptions.layer\r\n    );\r\n\r\n    const options = optionsFromCapabilities(capabilities, baseOptions);\r\n\r\n    const ouputOptions = Object.assign(options, baseOptions);\r\n    const sourceOptions = ObjectUtils.removeUndefined({\r\n      _layerOptionsFromSource: {\r\n        title: layer.Title\r\n      }\r\n    });\r\n\r\n    return ObjectUtils.mergeDeep(sourceOptions, ouputOptions);\r\n  }\r\n\r\n  private parseCartoOptions(\r\n    baseOptions: CartoDataSourceOptions,\r\n    cartoOptions: any\r\n  ): CartoDataSourceOptions {\r\n    const layers = [];\r\n    const params = cartoOptions.layers[1].options.layer_definition;\r\n    params.layers.forEach((element) => {\r\n      layers.push({\r\n        type: element.type.toLowerCase(),\r\n        options: element.options,\r\n        legend: element.legend\r\n      });\r\n    });\r\n    const options = ObjectUtils.removeUndefined({\r\n      config: {\r\n        version: params.version,\r\n        layers\r\n      }\r\n    });\r\n    return ObjectUtils.mergeDeep(options, baseOptions);\r\n  }\r\n\r\n  private parseArcgisOptions(\r\n    baseOptions: ArcGISRestDataSourceOptions,\r\n    arcgisOptions: any,\r\n    legend: any,\r\n    serviceCapabilities: any,\r\n  ): ArcGISRestDataSourceOptions {\r\n    const title = arcgisOptions.name;\r\n    let legendInfo: any;\r\n\r\n    if (legend.layers) {\r\n      legendInfo = legend.layers.find(x => x.layerName === title);\r\n    } else if (arcgisOptions.drawingInfo?.renderer) {\r\n      legendInfo = arcgisOptions.drawingInfo.renderer;\r\n    } else {\r\n      legendInfo = undefined;\r\n    }\r\n\r\n    let style;\r\n    if (arcgisOptions.drawingInfo) {\r\n      const styleGenerator = new EsriStyleGenerator();\r\n      const units = arcgisOptions.units === 'esriMeters' ? 'm' : 'degrees';\r\n      style = styleGenerator.generateStyle(arcgisOptions, units);\r\n    }\r\n    const attributions = new olAttribution({\r\n      target: arcgisOptions.copyrightText\r\n    });\r\n    let timeExtent;\r\n    let timeFilter;\r\n    if (arcgisOptions.timeInfo) {\r\n      const time = arcgisOptions.timeInfo.timeExtent;\r\n      timeExtent = time[0] + ',' + time[1];\r\n      const min = new Date();\r\n      min.setTime(time[0]);\r\n      const max = new Date();\r\n      max.setTime(time[1]);\r\n      timeFilter = {\r\n        min: min.toUTCString(),\r\n        max: max.toUTCString(),\r\n        range: true,\r\n        type: TimeFilterType.DATETIME,\r\n        style: TimeFilterStyle.CALENDAR\r\n      };\r\n    }\r\n    const params = Object.assign(\r\n      {},\r\n      {\r\n        style,\r\n        LAYERS: baseOptions.layer ? 'show:' + baseOptions.layer : undefined,\r\n        time: timeExtent\r\n      }\r\n    );\r\n    const options = ObjectUtils.removeUndefined({\r\n      params,\r\n      _layerOptionsFromSource: {\r\n        title,\r\n        minResolution: getResolutionFromScale(arcgisOptions.maxScale),\r\n        maxResolution: getResolutionFromScale(arcgisOptions.minScale),\r\n        metadata: {\r\n          extern: false,\r\n          abstract: arcgisOptions.description || serviceCapabilities.serviceDescription\r\n        },\r\n      },\r\n      legendInfo,\r\n      timeFilter,\r\n      sourceFields: arcgisOptions.fields,\r\n      queryTitle: arcgisOptions.displayField\r\n    });\r\n    options.attributions = attributions;\r\n    return ObjectUtils.mergeDeep(options, baseOptions);\r\n  }\r\n\r\n  private parseTileOrImageArcgisOptions(\r\n    baseOptions: TileArcGISRestDataSourceOptions | ArcGISRestImageDataSourceOptions,\r\n    arcgisOptions: any,\r\n    legend: any,\r\n    serviceCapabilities: any\r\n  ): TileArcGISRestDataSourceOptions | ArcGISRestImageDataSourceOptions {\r\n    const title = arcgisOptions.name;\r\n    const legendInfo = legend.layers ? legend.layers.find(x => x.layerName === title) : undefined;\r\n    const attributions = new olAttribution({\r\n      target: arcgisOptions.copyrightText\r\n    });\r\n    let timeExtent;\r\n    let timeFilter;\r\n    if (arcgisOptions.timeInfo) {\r\n      const time = arcgisOptions.timeInfo.timeExtent;\r\n      timeExtent = time[0] + ',' + time[1];\r\n      const min = new Date();\r\n      min.setTime(time[0]);\r\n      const max = new Date();\r\n      max.setTime(time[1]);\r\n      timeFilter = {\r\n        min: min.toUTCString(),\r\n        max: max.toUTCString(),\r\n        range: true,\r\n        type: TimeFilterType.DATETIME,\r\n        style: TimeFilterStyle.CALENDAR\r\n      };\r\n    }\r\n    const params = Object.assign(\r\n      {},\r\n      {\r\n        LAYERS: baseOptions.layer ? 'show:' + baseOptions.layer : undefined,\r\n        time: timeExtent\r\n      }\r\n    );\r\n    const options = ObjectUtils.removeUndefined({\r\n      params,\r\n      _layerOptionsFromSource: {\r\n        title,\r\n        minResolution: getResolutionFromScale(arcgisOptions.maxScale),\r\n        maxResolution: getResolutionFromScale(arcgisOptions.minScale),\r\n        metadata: {\r\n          extern: false,\r\n          abstract: arcgisOptions.description || serviceCapabilities.serviceDescription\r\n        },\r\n      },\r\n      legendInfo,\r\n      timeFilter,\r\n      sourceFields: arcgisOptions.fields,\r\n      queryTitle: arcgisOptions.displayField\r\n    });\r\n    options.attributions = attributions;\r\n    return ObjectUtils.mergeDeep(options, baseOptions);\r\n  }\r\n\r\n  private findDataSourceInCapabilities(layerArray, name): any {\r\n    if (Array.isArray(layerArray)) {\r\n      let layer;\r\n      layerArray.find((value) => {\r\n        layer = this.findDataSourceInCapabilities(value, name);\r\n        return layer !== undefined;\r\n      }, this);\r\n\r\n      return layer;\r\n    } else if (layerArray.Layer) {\r\n      return this.findDataSourceInCapabilities(layerArray.Layer, name);\r\n    } else {\r\n      if (layerArray.Name && layerArray.Name === name) {\r\n        return layerArray;\r\n      }\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  getTimeFilter(layer) {\r\n    let dimension;\r\n\r\n    if (layer.Dimension) {\r\n      const timeFilter: any = {};\r\n      dimension = layer.Dimension[0];\r\n\r\n      if (dimension.values) {\r\n        const minMaxDim = dimension.values.split('/');\r\n        timeFilter.min = minMaxDim[0] !== undefined ? minMaxDim[0] : undefined;\r\n        timeFilter.max = minMaxDim[1] !== undefined ? minMaxDim[1] : undefined;\r\n        timeFilter.step = minMaxDim[2] !== undefined ? minMaxDim[2] : undefined;\r\n      }\r\n\r\n      if (dimension.default) {\r\n        timeFilter.value = dimension.default;\r\n      }\r\n      return timeFilter;\r\n    }\r\n  }\r\n\r\n  getStyle(Style): LegendOptions {\r\n    const styleOptions: ItemStyleOptions[] = Style.map((style) => {\r\n      return {\r\n        name: style.Name,\r\n        title: style.Title\r\n      };\r\n    })\r\n      // Handle repeat the style \"default\" in output  (MapServer or OpenLayer)\r\n      .filter(\r\n        (item, index, self) =>\r\n          self.findIndex((i: ItemStyleOptions) => i.name === item.name) ===\r\n          index\r\n      );\r\n\r\n    const legendOptions: LegendOptions = {\r\n      stylesAvailable: styleOptions\r\n    } as LegendOptions;\r\n\r\n    return legendOptions;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport proj4 from 'proj4';\r\nimport * as olproj from 'ol/proj';\r\nimport * as olproj4 from 'ol/proj/proj4';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\n\r\nimport { Projection } from './projection.interfaces';\r\n\r\n/**\r\n * When injected, this service automatically registers and\r\n * projection defined in the application config. A custom projection\r\n * needs to be registered to be usable by OL.\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ProjectionService {\r\n\r\n  constructor(private config: ConfigService) {\r\n    const projections = this.config.getConfig('projections') || [];\r\n    projections.forEach((projection: Projection) => {\r\n      projection.alias = projection.alias ? projection.alias : projection.code;\r\n      this.registerProjection(projection);\r\n    });\r\n\r\n    // register all utm zones\r\n    for (let utmZone = 1; utmZone < 61; utmZone++) {\r\n      const code = utmZone < 10 ? `EPSG:3260${utmZone}` : `EPSG:326${utmZone}`;\r\n      const def = `+proj=utm +zone=${utmZone} +datum=WGS84 +units=m +no_defs`;\r\n      const proj: Projection = { code, def, extent : undefined};\r\n      this.registerProjection(proj);\r\n    }\r\n\r\n    // register all mtm zones\r\n    for (let mtmZone = 1; mtmZone < 11; mtmZone++) {\r\n      const code = mtmZone < 10 ? `EPSG:3218${mtmZone}` : `EPSG:321${80 + mtmZone}`;\r\n      let lon0;\r\n      if (Number(mtmZone) <= 2) {\r\n        lon0 = -50 - Number(mtmZone) * 3;\r\n      } else if (Number(mtmZone) >= 12) {\r\n        lon0 = -81 - (Number(mtmZone) - 12) * 3;\r\n      } else {\r\n        lon0 = -49.5 - Number(mtmZone) * 3;\r\n      }\r\n      const def = `+proj=tmerc +lat_0=0 +lon_0=${lon0} +k=0.9999 +x_0=304800 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs\"`;\r\n      const proj: Projection = { code, def, extent : undefined};\r\n      this.registerProjection(proj);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Define a proj4 projection and register it in OL\r\n   * @param projection Projection\r\n   */\r\n  registerProjection(projection: Projection) {\r\n    proj4.defs(projection.code, projection.def);\r\n    olproj4.register(proj4);\r\n    if (projection.extent) {\r\n      olproj.get(projection.code).setExtent(projection.extent);\r\n    }\r\n  }\r\n\r\n}\r\n","import { Injectable, Optional } from '@angular/core';\r\nimport { forkJoin, of, Observable, BehaviorSubject } from 'rxjs';\r\nimport { map, catchError } from 'rxjs/operators';\r\n\r\nimport { CapabilitiesService } from './capabilities.service';\r\nimport { OptionsService } from './options/options.service';\r\nimport { WFSService } from './datasources/wfs.service';\r\nimport {\r\n  DataSource,\r\n  OSMDataSource,\r\n  OSMDataSourceOptions,\r\n  FeatureDataSource,\r\n  FeatureDataSourceOptions,\r\n  XYZDataSource,\r\n  XYZDataSourceOptions,\r\n  TileDebugDataSource,\r\n  TileDebugDataSourceOptions,\r\n  WFSDataSource,\r\n  WFSDataSourceOptions,\r\n  WMTSDataSource,\r\n  WMTSDataSourceOptions,\r\n  WMSDataSource,\r\n  WMSDataSourceOptions,\r\n  CartoDataSource,\r\n  CartoDataSourceOptions,\r\n  ArcGISRestDataSource,\r\n  ArcGISRestDataSourceOptions,\r\n  ImageArcGISRestDataSource,\r\n  ArcGISRestImageDataSourceOptions,\r\n  TileArcGISRestDataSource,\r\n  TileArcGISRestDataSourceOptions,\r\n  WebSocketDataSource,\r\n  AnyDataSourceOptions,\r\n  MVTDataSource,\r\n  MVTDataSourceOptions,\r\n  ClusterDataSource,\r\n  ClusterDataSourceOptions\r\n} from './datasources';\r\nimport { ObjectUtils } from '@igo2/utils';\r\nimport { LanguageService, MessageService } from '@igo2/core';\r\nimport { ProjectionService } from '../../map/shared/projection.service';\r\nimport { AuthInterceptor } from '@igo2/auth';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class DataSourceService {\r\n  public datasources$ = new BehaviorSubject<DataSource[]>([]);\r\n\r\n  constructor(\r\n    private capabilitiesService: CapabilitiesService,\r\n    @Optional() private optionsService: OptionsService,\r\n    private wfsDataSourceService: WFSService,\r\n    private languageService: LanguageService,\r\n    private messageService: MessageService,\r\n    private projectionService: ProjectionService,\r\n    private authInterceptor?: AuthInterceptor\r\n  ) {}\r\n\r\n  createAsyncDataSource(context: AnyDataSourceOptions, detailedContextUri?: string): Observable<DataSource> {\r\n    if (!context.type) {\r\n      console.error(context);\r\n      throw new Error('Datasource needs a type');\r\n    }\r\n    let dataSource;\r\n    switch (context.type.toLowerCase()) {\r\n      case 'osm':\r\n        dataSource = this.createOSMDataSource(context as OSMDataSourceOptions);\r\n        break;\r\n      case 'vector':\r\n        dataSource = this.createFeatureDataSource(\r\n          context as FeatureDataSourceOptions\r\n        );\r\n        break;\r\n      case 'wfs':\r\n        dataSource = this.createWFSDataSource(context as WFSDataSourceOptions);\r\n        break;\r\n      case 'wms':\r\n        const wmsContext = context as WMSDataSourceOptions;\r\n        ObjectUtils.removeDuplicateCaseInsensitive(wmsContext.params);\r\n        dataSource = this.createWMSDataSource(wmsContext, detailedContextUri);\r\n        break;\r\n      case 'wmts':\r\n        dataSource = this.createWMTSDataSource(\r\n          context as WMTSDataSourceOptions\r\n        );\r\n        break;\r\n      case 'xyz':\r\n        dataSource = this.createXYZDataSource(context as XYZDataSourceOptions);\r\n        break;\r\n      case 'tiledebug':\r\n        dataSource = this.createTileDebugDataSource(context as TileDebugDataSource);\r\n        break;\r\n      case 'carto':\r\n        dataSource = this.createCartoDataSource(\r\n          context as CartoDataSourceOptions\r\n        );\r\n        break;\r\n      case 'arcgisrest':\r\n        dataSource = this.createArcGISRestDataSource(\r\n          context as ArcGISRestDataSourceOptions, detailedContextUri\r\n        );\r\n        break;\r\n      case 'imagearcgisrest':\r\n        dataSource = this.createArcGISRestImageDataSource(\r\n          context as ArcGISRestImageDataSourceOptions, detailedContextUri\r\n        );\r\n        break;\r\n      case 'websocket':\r\n        dataSource = this.createWebSocketDataSource(\r\n          context as FeatureDataSourceOptions\r\n        );\r\n        break;\r\n      case 'mvt':\r\n        dataSource = this.createMVTDataSource(context as MVTDataSourceOptions);\r\n        break;\r\n      case 'tilearcgisrest':\r\n        dataSource = this.createTileArcGISRestDataSource(\r\n          context as TileArcGISRestDataSourceOptions, detailedContextUri\r\n        );\r\n        break;\r\n      case 'cluster':\r\n        dataSource = this.createClusterDataSource(\r\n          context as ClusterDataSourceOptions\r\n        );\r\n        break;\r\n      default:\r\n        console.error(context);\r\n        throw new Error('Invalid datasource type');\r\n    }\r\n\r\n    this.datasources$.next(this.datasources$.value.concat([dataSource]));\r\n\r\n    return dataSource;\r\n  }\r\n\r\n  private createOSMDataSource(\r\n    context: OSMDataSourceOptions\r\n  ): Observable<OSMDataSource> {\r\n    return new Observable(d => d.next(new OSMDataSource(context)));\r\n  }\r\n\r\n  private createFeatureDataSource(\r\n    context: FeatureDataSourceOptions\r\n  ): Observable<FeatureDataSource> {\r\n    return new Observable(d => d.next(new FeatureDataSource(context)));\r\n  }\r\n\r\n  private createWebSocketDataSource(\r\n    context: FeatureDataSourceOptions\r\n  ): Observable<WebSocketDataSource> {\r\n    return new Observable(d => d.next(new WebSocketDataSource(context)));\r\n  }\r\n\r\n  private createWFSDataSource(\r\n    context: WFSDataSourceOptions\r\n  ): Observable<WFSDataSource> {\r\n    return new Observable(d =>\r\n      d.next(new WFSDataSource(context, this.wfsDataSourceService, this.authInterceptor))\r\n    );\r\n  }\r\n\r\n  private createWMSDataSource(context: WMSDataSourceOptions, detailedContextUri?: string): Observable<any> {\r\n    const observables = [];\r\n    if (context.optionsFromCapabilities) {\r\n      observables.push(\r\n        this.capabilitiesService.getWMSOptions(context).pipe(\r\n          catchError(e => {\r\n            const title = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.unavailableTitle'\r\n            );\r\n            const message = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.unavailable',\r\n              { value: context.params.LAYERS }\r\n            );\r\n\r\n            this.messageService.error(message, title);\r\n            throw e;\r\n          })\r\n        )\r\n      );\r\n    }\r\n\r\n    if (this.optionsService && context.optionsFromApi === true) {\r\n      observables.push(\r\n        this.optionsService.getWMSOptions(context, detailedContextUri).pipe(\r\n          catchError(e => {\r\n            e.error.toDisplay = true;\r\n            e.error.title = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.unavailableTitle'\r\n            );\r\n            e.error.message = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.optionsApiUnavailable'\r\n            );\r\n            return of({});\r\n          })\r\n        )\r\n      );\r\n    }\r\n\r\n    observables.push(of(context));\r\n\r\n    return forkJoin(observables).pipe(\r\n      map((options: WMSDataSourceOptions[]) => {\r\n        const optionsMerged = options.reduce((a, b) =>\r\n          ObjectUtils.mergeDeep(a, b)\r\n        );\r\n        return new WMSDataSource(optionsMerged, this.wfsDataSourceService);\r\n      }),\r\n      catchError(() => {\r\n        return of(undefined);\r\n      })\r\n    );\r\n  }\r\n\r\n  private createWMTSDataSource(\r\n    context: WMTSDataSourceOptions\r\n  ): Observable<WMTSDataSource> {\r\n    if (context.optionsFromCapabilities) {\r\n      return this.capabilitiesService.getWMTSOptions(context).pipe(\r\n        map((options: WMTSDataSourceOptions) => {\r\n          return options ? new WMTSDataSource(options) : undefined;\r\n        }),\r\n        catchError(() => {\r\n          const title = this.languageService.translate.instant(\r\n            'igo.geo.dataSource.unavailableTitle'\r\n          );\r\n          const message = this.languageService.translate.instant(\r\n            'igo.geo.dataSource.unavailable',\r\n            { value: context.layer }\r\n          );\r\n\r\n          this.messageService.error(message, title);\r\n          return of(undefined);\r\n        })\r\n      );\r\n    }\r\n\r\n    return new Observable(d => d.next(new WMTSDataSource(context)));\r\n  }\r\n\r\n  private createXYZDataSource(\r\n    context: XYZDataSourceOptions\r\n  ): Observable<XYZDataSource> {\r\n    return new Observable(d => d.next(new XYZDataSource(context)));\r\n  }\r\n\r\n  private createTileDebugDataSource(\r\n    context: TileDebugDataSourceOptions\r\n  ): Observable<TileDebugDataSource> {\r\n    return new Observable(d => d.next(new TileDebugDataSource(context)));\r\n  }\r\n\r\n  private createCartoDataSource(\r\n    context: CartoDataSourceOptions\r\n  ): Observable<CartoDataSource> {\r\n    if (context.mapId) {\r\n      return this.capabilitiesService\r\n        .getCartoOptions(context)\r\n        .pipe(\r\n          map((options: CartoDataSourceOptions) => new CartoDataSource(options))\r\n        );\r\n    }\r\n    return new Observable(d => d.next(new CartoDataSource(context)));\r\n  }\r\n\r\n  private createArcGISRestDataSource(\r\n    context: ArcGISRestDataSourceOptions,\r\n    detailedContextUri?: string\r\n  ): Observable<ArcGISRestDataSource> {\r\n    const observables = [];\r\n    observables.push(this.capabilitiesService.getArcgisOptions(context).pipe(\r\n      catchError(e => {\r\n        const title = this.languageService.translate.instant(\r\n          'igo.geo.dataSource.unavailableTitle'\r\n        );\r\n        const message = this.languageService.translate.instant(\r\n          'igo.geo.dataSource.unavailable',\r\n          { value: context.layer }\r\n        );\r\n\r\n        this.messageService.error(message, title);\r\n        throw e;\r\n      })\r\n    ));\r\n    if (this.optionsService && context.optionsFromApi === true) {\r\n      observables.push(\r\n        this.optionsService.getArcgisRestOptions(context, detailedContextUri).pipe(\r\n          catchError(e => {\r\n            e.error.toDisplay = true;\r\n            e.error.title = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.unavailableTitle'\r\n            );\r\n            e.error.message = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.optionsApiUnavailable'\r\n            );\r\n            return of({});\r\n          })\r\n        )\r\n      );\r\n    }\r\n    observables.push(of(context));\r\n    return forkJoin(observables).pipe(\r\n      map((options: ArcGISRestDataSource[]) => {\r\n        const optionsMerged = options.reduce((a, b) =>\r\n          ObjectUtils.mergeDeep(a, b)\r\n        );\r\n        return new ArcGISRestDataSource(optionsMerged);\r\n      }),\r\n      catchError(() => {\r\n        return of(undefined);\r\n      })\r\n    );\r\n  }\r\n\r\n  private createArcGISRestImageDataSource(\r\n    context: ArcGISRestImageDataSourceOptions,\r\n    detailedContextUri?: string\r\n  ): Observable<ArcGISRestImageDataSourceOptions> {\r\n    const observables = [];\r\n\r\n    observables.push(this.capabilitiesService.getImageArcgisOptions(context).pipe(\r\n      catchError(e => {\r\n        const title = this.languageService.translate.instant(\r\n          'igo.geo.dataSource.unavailableTitle'\r\n        );\r\n        const message = this.languageService.translate.instant(\r\n          'igo.geo.dataSource.unavailable',\r\n          { value: context.params.LAYERS }\r\n        );\r\n\r\n        this.messageService.error(message, title);\r\n        throw e;\r\n      })\r\n    ));\r\n    if (this.optionsService && context.optionsFromApi === true) {\r\n      observables.push(\r\n        this.optionsService.getArcgisRestOptions(context, detailedContextUri).pipe(\r\n          catchError(e => {\r\n            e.error.toDisplay = true;\r\n            e.error.title = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.unavailableTitle'\r\n            );\r\n            e.error.message = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.optionsApiUnavailable'\r\n            );\r\n            return of({});\r\n          })\r\n        )\r\n      );\r\n    }\r\n    observables.push(of(context));\r\n    return forkJoin(observables).pipe(\r\n      map((options: ImageArcGISRestDataSource[]) => {\r\n        const optionsMerged = options.reduce((a, b) =>\r\n          ObjectUtils.mergeDeep(a, b)\r\n        );\r\n        return new ImageArcGISRestDataSource(optionsMerged);\r\n      }),\r\n      catchError(() => {\r\n        return of(undefined);\r\n      })\r\n    );\r\n  }\r\n\r\n  private createTileArcGISRestDataSource(\r\n    context: TileArcGISRestDataSourceOptions,\r\n    detailedContextUri?: string\r\n  ): Observable<TileArcGISRestDataSource> {\r\n    const observables = [];\r\n    observables.push(this.capabilitiesService.getImageArcgisOptions(context).pipe(\r\n      catchError(e => {\r\n        const title = this.languageService.translate.instant(\r\n          'igo.geo.dataSource.unavailableTitle'\r\n        );\r\n        const message = this.languageService.translate.instant(\r\n          'igo.geo.dataSource.unavailable',\r\n          { value: context.params.LAYERS }\r\n        );\r\n\r\n        this.messageService.error(message, title);\r\n        throw e;\r\n      })\r\n    ));\r\n    if (this.optionsService && context.optionsFromApi === true) {\r\n      observables.push(\r\n        this.optionsService.getArcgisRestOptions(context, detailedContextUri).pipe(\r\n          catchError(e => {\r\n            e.error.toDisplay = true;\r\n            e.error.title = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.unavailableTitle'\r\n            );\r\n            e.error.message = this.languageService.translate.instant(\r\n              'igo.geo.dataSource.optionsApiUnavailable'\r\n            );\r\n            return of({});\r\n          })\r\n        )\r\n      );\r\n    }\r\n    observables.push(of(context));\r\n    return forkJoin(observables).pipe(\r\n      map((options: TileArcGISRestDataSource[]) => {\r\n        const optionsMerged = options.reduce((a, b) =>\r\n          ObjectUtils.mergeDeep(a, b)\r\n        );\r\n        return new TileArcGISRestDataSource(optionsMerged);\r\n      }),\r\n      catchError(() => {\r\n        return of(undefined);\r\n      })\r\n    );\r\n  }\r\n\r\n  private createMVTDataSource(\r\n    context: MVTDataSourceOptions\r\n  ): Observable<MVTDataSource> {\r\n    return new Observable(d => d.next(new MVTDataSource(context)));\r\n  }\r\n\r\n  private createClusterDataSource(\r\n    context: ClusterDataSourceOptions\r\n  ): Observable<ClusterDataSource> {\r\n    return new Observable(d => d.next(new ClusterDataSource(context)));\r\n  }\r\n}\r\n","import * as olextent from 'ol/extent';\r\nimport * as olproj from 'ol/proj';\r\nimport * as olstyle from 'ol/style';\r\nimport OlFeature from 'ol/Feature';\r\nimport OlGeometryLayout from 'ol/geom/GeometryLayout';\r\nimport OlPolygon from 'ol/geom/Polygon';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport OlLineString from 'ol/geom/LineString';\r\nimport OlRenderFeature from 'ol/render/Feature';\r\nimport OlFormatGeoJSON from 'ol/format/GeoJSON';\r\nimport OlLayer from 'ol/layer/Layer';\r\nimport OlSource from 'ol/source/Source';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport { uuid } from '@igo2/utils';\r\n\r\nimport {\r\n  EntityKey,\r\n  getEntityId,\r\n  getEntityTitle,\r\n  getEntityRevision,\r\n  getEntityIcon,\r\n  getEntityProperty\r\n} from '@igo2/common';\r\n\r\nimport { IgoMap } from '../../map';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { FeatureDataSource } from '../../datasource';\r\nimport { FEATURE, FeatureMotion } from './feature.enums';\r\nimport { Feature, FeatureGeometry } from './feature.interfaces';\r\nimport { FeatureStore } from './store';\r\n\r\n/**\r\n * Create an Openlayers feature object out of a feature definition.\r\n * The output object has a reference to the feature id.\r\n * @param feature Feature definition\r\n * @param projectionOut Feature object projection\r\n * @returns OpenLayers feature object\r\n */\r\nexport function featureToOl(\r\n  feature: Feature,\r\n  projectionOut: string,\r\n  getId?: (Feature) => EntityKey\r\n): OlFeature<OlGeometry> {\r\n  getId = getId ? getId : getEntityId;\r\n\r\n  const olFormat = new OlFormatGeoJSON();\r\n  const olFeature = olFormat.readFeature(feature, {\r\n    dataProjection: feature.projection,\r\n    featureProjection: projectionOut\r\n  });\r\n\r\n  olFeature.setId(getId(feature));\r\n\r\n  const title = getEntityTitle(feature);\r\n  if (title !== undefined) {\r\n    olFeature.set('_title', title, true);\r\n  }\r\n\r\n  if (feature.extent !== undefined) {\r\n    olFeature.set('_extent', feature.extent, true);\r\n  }\r\n\r\n  if (feature.projection !== undefined) {\r\n    olFeature.set('_projection', feature.projection, true);\r\n  }\r\n\r\n  const mapTitle = getEntityProperty(feature, 'meta.mapTitle');\r\n  if (mapTitle !== undefined) {\r\n    olFeature.set('_mapTitle', mapTitle, true);\r\n  }\r\n\r\n  olFeature.set('_entityRevision', getEntityRevision(feature), true);\r\n\r\n  const icon = getEntityIcon(feature);\r\n  if (icon !== undefined) {\r\n    olFeature.set('_icon', icon, true);\r\n  }\r\n\r\n  if (feature.meta && feature.meta.style) {\r\n    olFeature.set('_style', feature.meta.style, true);\r\n  }\r\n\r\n  if (feature.sourceId) {\r\n    olFeature.set('_sourceId', feature.sourceId, true);\r\n  }\r\n\r\n  return olFeature;\r\n}\r\n\r\nexport function renderFeatureFromOl(\r\n  olRenderFeature: OlRenderFeature,\r\n  projectionIn: string,\r\n  olLayer?: OlLayer<OlSource>,\r\n  projectionOut = 'EPSG:4326'\r\n): Feature {\r\n  let geom;\r\n  let title;\r\n  let exclude;\r\n  let excludeOffline;\r\n\r\n  if (olLayer) {\r\n    title = olLayer.get('title');\r\n    if (olLayer.get('sourceOptions')) {\r\n      exclude = olLayer.get('sourceOptions').excludeAttribute;\r\n      excludeOffline = olLayer.get('sourceOptions').excludeAttributeOffline;\r\n    }\r\n  } else {\r\n    title = olRenderFeature.get('_title');\r\n  }\r\n\r\n  const olFormat = new OlFormatGeoJSON();\r\n  const properties = olRenderFeature.getProperties();\r\n  const geometryType = olRenderFeature.getType();\r\n\r\n  if (geometryType === 'Polygon') {\r\n    const ends = olRenderFeature.getEnds() as number[];\r\n    geom = new OlPolygon(\r\n      olRenderFeature.getFlatCoordinates(),\r\n      OlGeometryLayout.XY,\r\n      ends\r\n    );\r\n  } else if (geometryType === 'Point') {\r\n    geom = new OlPoint(olRenderFeature.getFlatCoordinates(), OlGeometryLayout.XY);\r\n  } else if (geometryType === 'LineString') {\r\n    geom = new OlLineString(\r\n      olRenderFeature.getFlatCoordinates(),\r\n      OlGeometryLayout.XY\r\n    );\r\n  }\r\n\r\n  const geometry = olFormat.writeGeometryObject(geom, {\r\n    dataProjection: projectionOut,\r\n    featureProjection: projectionIn\r\n  }) as FeatureGeometry;\r\n\r\n  const id = olRenderFeature.getId() ? olRenderFeature.getId() : uuid();\r\n  const mapTitle = olRenderFeature.get('_mapTitle');\r\n  const extent = olproj.transformExtent(olRenderFeature.getExtent(), projectionIn, projectionOut) as [number, number, number, number];\r\n  return {\r\n    type: FEATURE,\r\n    projection: projectionOut,\r\n    extent,\r\n    meta: {\r\n      id,\r\n      title: title ? title : mapTitle ? mapTitle : id,\r\n      mapTitle,\r\n      excludeAttribute: exclude,\r\n      excludeAttributeOffline: excludeOffline\r\n    },\r\n    properties,\r\n    geometry,\r\n    ol: olRenderFeature\r\n  };\r\n}\r\n/**\r\n * Create a feature object out of an OL feature\r\n * The output object has a reference to the feature id.\r\n * @param olFeature OL Feature\r\n * @param projectionIn OL feature projection\r\n * @param olLayer OL Layer\r\n * @param projectionOut Feature projection\r\n * @returns Feature\r\n */\r\nexport function featureFromOl(\r\n  olFeature: OlFeature<OlGeometry>,\r\n  projectionIn: string,\r\n  olLayer?: OlLayer<OlSource>,\r\n  projectionOut = 'EPSG:4326'\r\n): Feature {\r\n  let title;\r\n  let exclude;\r\n  let excludeOffline;\r\n  let idColumn; // for arcgisrest and tilearcgisrest source\r\n  const olFormat = new OlFormatGeoJSON();\r\n\r\n  const keys = olFeature.getKeys().filter((key: string) => {\r\n    return !key.startsWith('_') && key !== 'geometry';\r\n  });\r\n  const properties = keys.reduce((acc: object, key: string) => {\r\n    acc[key] = olFeature.get(key);\r\n    return acc;\r\n  }, {});\r\n\r\n  const geometry = olFormat.writeGeometryObject(olFeature.getGeometry(), {\r\n    dataProjection: projectionOut,\r\n    featureProjection: projectionIn\r\n  }) as FeatureGeometry;\r\n\r\n  if (olLayer) {\r\n    title = olLayer.get('title');\r\n    const sourceOptions = olLayer.get('sourceOptions');\r\n    if (sourceOptions) {\r\n      exclude = sourceOptions.excludeAttribute;\r\n      excludeOffline = sourceOptions.excludeAttributeOffline;\r\n      idColumn =\r\n        sourceOptions.idColumn ||\r\n        ((sourceOptions.type === 'arcgisrest' || sourceOptions.type === 'tilearcgisrest') ? 'OBJECTID' : undefined );\r\n    }\r\n  } else {\r\n    title = olFeature.get('_title');\r\n  }\r\n  const mapTitle = olFeature.get('_mapTitle');\r\n  const id = olFeature.getId() ? olFeature.getId() : olFeature.get(idColumn) ? olFeature.get(idColumn) : uuid();\r\n  const newFeature = olFeature.get('_newFeature');\r\n\r\n  return {\r\n    type: FEATURE,\r\n    projection: projectionOut,\r\n    extent: olFeature.get('_extent'),\r\n    meta: {\r\n      id,\r\n      title: title ? title : mapTitle ? mapTitle : id,\r\n      mapTitle,\r\n      revision: olFeature.getRevision(),\r\n      style: olFeature.get('_style'),\r\n      excludeAttribute: exclude,\r\n      excludeAttributeOffline: excludeOffline\r\n    },\r\n    properties,\r\n    geometry,\r\n    ol: olFeature\r\n  };\r\n}\r\n\r\n/**\r\n * Compute an OL feature extent in it's map projection\r\n * @param map Map\r\n * @param olFeature OL feature\r\n * @returns Extent in the map projection\r\n */\r\nexport function computeOlFeatureExtent(\r\n  map: IgoMap,\r\n  olFeature: OlFeature<OlGeometry>\r\n): [number, number, number, number] {\r\n  let olExtent = olextent.createEmpty();\r\n\r\n  const olFeatureExtent = olFeature.get('_extent');\r\n  const olFeatureProjection = olFeature.get('_projection');\r\n  if (olFeatureExtent !== undefined && olFeatureProjection !== undefined) {\r\n    olExtent = olproj.transformExtent(\r\n      olFeatureExtent,\r\n      olFeatureProjection,\r\n      map.projection\r\n    );\r\n  } else {\r\n    const olGeometry = olFeature.getGeometry();\r\n    if (olGeometry !== null) {\r\n      olExtent = olGeometry.getExtent();\r\n    }\r\n  }\r\n\r\n  return olExtent as [number, number, number, number];\r\n}\r\n\r\n/**\r\n * Compute a multiple OL features extent in their map projection\r\n * @param map Map\r\n * @param olFeatures OL features\r\n * @returns Extent in the map projection\r\n */\r\nexport function computeOlFeaturesExtent(\r\n  map: IgoMap,\r\n  olFeatures: OlFeature<OlGeometry>[]\r\n): [number, number, number, number] {\r\n  const extent = olextent.createEmpty();\r\n\r\n  olFeatures.forEach((olFeature: OlFeature<OlGeometry>) => {\r\n    const featureExtent = computeOlFeatureExtent(map, olFeature);\r\n    olextent.extend(extent, featureExtent);\r\n  });\r\n\r\n  return extent as [number, number, number, number];\r\n}\r\n\r\n/**\r\n * Scale an extent.\r\n * @param extent Extent\r\n * @param Scaling factors for top, right, bottom and left directions, in that order\r\n * @returns Scaled extent\r\n */\r\nexport function scaleExtent(\r\n  extent: [number, number, number, number],\r\n  scale: [number, number, number, number]\r\n): [number, number, number, number] {\r\n  const [width, height] = olextent.getSize(extent);\r\n  return [\r\n    scale[3] ? extent[0] - width * scale[3] : extent[0],\r\n    scale[2] ? extent[1] - height * scale[2] : extent[1],\r\n    scale[1] ? extent[2] + width * scale[1] : extent[2],\r\n    scale[0] ? extent[3] + height * scale[0] : extent[3]\r\n  ];\r\n}\r\n\r\n/**\r\n * Return true if features are out of view.\r\n * If features are too close to the edge, they are considered out of view.\r\n * We define the edge as 5% of the extent size.\r\n * @param map Map\r\n * @param featuresExtent The features's extent\r\n * @returns Return true if features are out of view\r\n */\r\nexport function featuresAreOutOfView(\r\n  map: IgoMap,\r\n  featuresExtent: [number, number, number, number]\r\n) {\r\n  const mapExtent = map.viewController.getExtent();\r\n  const edgeRatio = 0.05;\r\n  const scale = [-1, -1, -1, -1].map(x => x * edgeRatio);\r\n  const viewExtent = scaleExtent(mapExtent, scale as [\r\n    number,\r\n    number,\r\n    number,\r\n    number\r\n  ]);\r\n\r\n  return !olextent.containsExtent(viewExtent, featuresExtent);\r\n}\r\n\r\n/**\r\n * Return true if features are too deep into the view. This results\r\n * in features being too small.\r\n * Features are considered too small if their extent occupies less than\r\n * 1% of the map extent.\r\n * @param map Map\r\n * @param featuresExtent The features's extent\r\n * @param areaRatio The features extent to view extent acceptable ratio\r\n * @returns Return true if features are too deep in the view\r\n */\r\nexport function featuresAreTooDeepInView(\r\n  map: IgoMap,\r\n  featuresExtent: [number, number, number, number],\r\n  areaRatio?: number\r\n) {\r\n  // An area ratio of 0.004 means that the feature extent's width and height\r\n  // should be about 1/16 of the map extent's width and height\r\n  areaRatio = areaRatio ? areaRatio : 0.004;\r\n  const mapExtent = map.viewController.getExtent();\r\n  const mapExtentArea = olextent.getArea(mapExtent);\r\n  const featuresExtentArea = olextent.getArea(featuresExtent);\r\n\r\n  if (featuresExtentArea === 0 && map.viewController.getZoom() > 13) {\r\n    // In case it's a point\r\n    return false;\r\n  }\r\n\r\n  return featuresExtentArea / mapExtentArea < areaRatio;\r\n}\r\n\r\n/**\r\n * Fit view to include the features extent.\r\n * By default, this method will let the features occupy about 50% of the viewport.\r\n * @param map Map\r\n * @param olFeatures OL features\r\n * @param motion To motion to the new map view\r\n * @param scale If this is defined, the original view will be scaled\r\n *  by that factor before any logic is applied.\r\n */\r\nexport function moveToOlFeatures(\r\n  map: IgoMap,\r\n  olFeatures: OlFeature<OlGeometry>[],\r\n  motion: FeatureMotion = FeatureMotion.Default,\r\n  scale?: [number, number, number, number],\r\n  areaRatio?: number\r\n) {\r\n  const featuresExtent = computeOlFeaturesExtent(map, olFeatures);\r\n  let viewExtent = featuresExtent;\r\n  if (scale !== undefined) {\r\n    viewExtent = scaleExtent(viewExtent, scale);\r\n  }\r\n\r\n  if (motion === FeatureMotion.Zoom) {\r\n    map.viewController.zoomToExtent(viewExtent);\r\n  } else if (motion === FeatureMotion.Move) {\r\n    map.viewController.moveToExtent(viewExtent);\r\n  } else if (motion === FeatureMotion.Default) {\r\n    if (\r\n      featuresAreOutOfView(map, featuresExtent) ||\r\n      featuresAreTooDeepInView(map, featuresExtent, areaRatio)\r\n    ) {\r\n      map.viewController.zoomToExtent(viewExtent);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Hide an OL feature\r\n * @param olFeature OL feature\r\n */\r\nexport function hideOlFeature(olFeature: OlFeature<OlGeometry>) {\r\n  olFeature.setStyle(new olstyle.Style({}));\r\n}\r\n\r\n/**\r\n * Try to bind a layer to a store if none is bound already.\r\n * The layer will also be added to the store's map.\r\n * If no layer is given to that function, a basic one will be created.\r\n * @param store The store to bind the layer\r\n * @param layer An optional VectorLayer\r\n */\r\nexport function tryBindStoreLayer(store: FeatureStore, layer?: VectorLayer) {\r\n  if (store.layer !== undefined) {\r\n    if (store.layer.map === undefined) {\r\n      store.map.addLayer(store.layer);\r\n    }\r\n    return;\r\n  }\r\n\r\n  layer = layer\r\n    ? layer\r\n    : new VectorLayer({\r\n        source: new FeatureDataSource()\r\n      });\r\n  store.bindLayer(layer);\r\n  if (store.layer.map === undefined) {\r\n    store.map.addLayer(store.layer);\r\n  }\r\n}\r\n\r\n/**\r\n * Compute a diff between a source array of Ol features and a target array\r\n * @param source Source array of OL features\r\n * @param starget Target array of OL features\r\n * @returns Features to add and remove\r\n */\r\nexport function computeOlFeaturesDiff(\r\n  source: OlFeature<OlGeometry>[],\r\n  target: OlFeature<OlGeometry>[]\r\n): {\r\n  add: OlFeature<OlGeometry>[];\r\n  remove: OlFeature<OlGeometry>[];\r\n} {\r\n  const olFeaturesMap = new Map();\r\n  target.forEach((olFeature: OlFeature<OlGeometry>) => {\r\n    olFeaturesMap.set(olFeature.getId(), olFeature);\r\n  });\r\n\r\n  const olFeaturesToRemove = [];\r\n  source.forEach((olFeature: OlFeature<OlGeometry>) => {\r\n    const newOlFeature = olFeaturesMap.get(olFeature.getId());\r\n    if (newOlFeature === undefined) {\r\n      olFeaturesToRemove.push(olFeature);\r\n    } else if (\r\n      newOlFeature.get('_entityRevision') !== olFeature.get('_entityRevision')\r\n    ) {\r\n      olFeaturesToRemove.push(olFeature);\r\n    } else {\r\n      olFeaturesMap.delete(newOlFeature.getId());\r\n    }\r\n  });\r\n\r\n  const olFeaturesToAddIds = Array.from(olFeaturesMap.keys());\r\n  const olFeaturesToAdd = target.filter((olFeature: OlFeature<OlGeometry>) => {\r\n    return olFeaturesToAddIds.indexOf(olFeature.getId()) >= 0;\r\n  });\r\n\r\n  return {\r\n    add: olFeaturesToAdd,\r\n    remove: olFeaturesToRemove\r\n  };\r\n}\r\n","import OlFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport {\r\n  getEntityId,\r\n  EntityKey,\r\n  EntityStore\r\n} from '@igo2/common';\r\n\r\nimport { FeatureDataSource } from '../../datasource';\r\nimport { VectorLayer } from '../../layer';\r\nimport { IgoMap } from '../../map';\r\n\r\nimport { FeatureMotion } from './feature.enums';\r\nimport { Feature, FeatureStoreOptions } from './feature.interfaces';\r\nimport { computeOlFeaturesDiff, featureFromOl, featureToOl, moveToOlFeatures } from './feature.utils';\r\n\r\n/**\r\n * The class is a specialized version of an EntityStore that stores\r\n * features and the map layer to display them on. Synchronization\r\n * between the store and the layer is handled by strategies.\r\n */\r\nexport class FeatureStore<T extends Feature = Feature> extends EntityStore<T> {\r\n\r\n  /**\r\n   * Vector layer to display the features on\r\n   */\r\n  layer: VectorLayer;\r\n\r\n  /**\r\n   * The map the layer is bound to\r\n   */\r\n  readonly map: IgoMap;\r\n\r\n  /**\r\n   * The layer's data source\r\n   */\r\n  get source(): FeatureDataSource {\r\n    return this.layer ? this.layer.dataSource as FeatureDataSource : undefined;\r\n  }\r\n\r\n  constructor(entities: T[], options: FeatureStoreOptions) {\r\n    super(entities, options);\r\n    this.map = options.map;\r\n  }\r\n\r\n  /**\r\n   * Bind this store to a vector layer\r\n   * @param layer Vector layer\r\n   * @returns Feature store\r\n   */\r\n  bindLayer(layer: VectorLayer): FeatureStore {\r\n    this.layer = layer;\r\n    return this;\r\n  }\r\n\r\n  /**\r\n   * Set the layer's features and perform a motion to make them visible. Strategies\r\n   * make extensive use of that method.\r\n   * @param features Features\r\n   * @param motion Optional: The type of motion to perform\r\n   */\r\n  setLayerFeatures(\r\n    features: Feature[],\r\n    motion: FeatureMotion = FeatureMotion.Default,\r\n    viewScale?: [number, number, number, number],\r\n    areaRatio?: number,\r\n    getId?: (Feature) => EntityKey\r\n  ) {\r\n    getId = getId ? getId : getEntityId;\r\n    this.checkLayer();\r\n\r\n    const olFeatures = features\r\n      .map((feature: Feature) => featureToOl(feature, this.map.projection, getId));\r\n    this.setLayerOlFeatures(olFeatures, motion, viewScale, areaRatio);\r\n  }\r\n\r\n  /**\r\n   * Set the store's features from an array of OL features.\r\n   * @param olFeatures Ol features\r\n   */\r\n  setStoreOlFeatures(olFeatures: OlFeature<OlGeometry>[]) {\r\n    this.checkLayer();\r\n\r\n    const features = olFeatures.map((olFeature: OlFeature<OlGeometry>) => {\r\n      olFeature.set('_featureStore', this, true);\r\n      return featureFromOl(olFeature, this.layer.map.projection);\r\n    });\r\n    this.load(features as T[]);\r\n  }\r\n\r\n  /**\r\n   * Remove all features from the layer\r\n   */\r\n  clearLayer() {\r\n    this.checkLayer();\r\n    this.source.ol.clear();\r\n  }\r\n\r\n  /**\r\n   * Check wether a layer is bound or not and throw an error if not.\r\n   */\r\n  private checkLayer() {\r\n    if (this.layer === undefined) {\r\n      throw new Error('This FeatureStore is not bound to a layer.');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set the layer's features and perform a motion to make them visible.\r\n   * @param features Openlayers feature objects\r\n   * @param motion Optional: The type of motion to perform\r\n   */\r\n  public setLayerOlFeatures(\r\n    olFeatures: OlFeature<OlGeometry>[],\r\n    motion: FeatureMotion = FeatureMotion.Default,\r\n    viewScale?: [number, number, number, number],\r\n    areaRatio?: number\r\n  ) {\r\n    const olSource = this.layer.ol.getSource();\r\n    const diff = computeOlFeaturesDiff(olSource.getFeatures(), olFeatures);\r\n    if (diff.remove.length > 0) {\r\n      this.removeOlFeaturesFromLayer(diff.remove);\r\n    }\r\n\r\n    if (diff.add.length > 0) {\r\n      this.addOlFeaturesToLayer(diff.add);\r\n    }\r\n\r\n    if (diff.add.length > 0) {\r\n      // If features are added, do a motion toward the newly added features\r\n      moveToOlFeatures(this.map, diff.add, motion, viewScale, areaRatio);\r\n    } else if (diff.remove.length > 0) {\r\n      // Else, do a motion toward all the features\r\n      moveToOlFeatures(this.map, olFeatures, motion, viewScale, areaRatio);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add features to the the layer\r\n   * @param features Openlayers feature objects\r\n   */\r\n  private addOlFeaturesToLayer(olFeatures: OlFeature<OlGeometry>[]) {\r\n    olFeatures.forEach((olFeature: OlFeature<OlGeometry>) => {\r\n      olFeature.set('_featureStore', this, true);\r\n    });\r\n    this.source.ol.addFeatures(olFeatures);\r\n  }\r\n\r\n  /**\r\n   * Remove features from the the layer\r\n   * @param features Openlayers feature objects\r\n   */\r\n  private removeOlFeaturesFromLayer(olFeatures: OlFeature<OlGeometry>[]) {\r\n    olFeatures.forEach((olFeature: OlFeature<OlGeometry>) => {\r\n      this.source.ol.removeFeature(olFeature);\r\n    });\r\n  }\r\n\r\n}\r\n","import * as olextent from 'ol/extent';\r\n\r\nimport { EntityStoreStrategy } from '@igo2/common';\r\n\r\nimport { FeatureStore } from '../store';\r\nimport { FeatureStoreInMapExtentStrategyOptions } from '../feature.interfaces';\r\nimport { Subscription } from 'rxjs';\r\nimport { skipWhile } from 'rxjs/operators';\r\n\r\n/**\r\n * This strategy maintain the store features updated while the map is moved.\r\n * The features's state inside the map are tagged inMapExtent = true;\r\n */\r\nexport class FeatureStoreInMapExtentStrategy extends EntityStoreStrategy {\r\n\r\n  /**\r\n   * Subscription to the store's OL source changes\r\n   */\r\n  private stores$$ = new Map<FeatureStore, string>();\r\n  private states$$: Subscription[] = [];\r\n  private empty$$: Subscription;\r\n\r\n  constructor(protected options: FeatureStoreInMapExtentStrategyOptions) {\r\n    super(options);\r\n  }\r\n\r\n  /**\r\n   * Bind this strategy to a store and start watching for Ol source changes\r\n   * @param store Feature store\r\n   */\r\n  bindStore(store: FeatureStore) {\r\n    super.bindStore(store);\r\n    if (this.active === true) {\r\n      this.watchStore(store);\r\n    }\r\n    this.empty$$ = store.empty$\r\n      .pipe(skipWhile((empty) => !empty))\r\n      .subscribe(() => this.updateEntitiesInExtent(store));\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from a store and stop watching for Ol source changes\r\n   * @param store Feature store\r\n   */\r\n  unbindStore(store: FeatureStore) {\r\n    super.unbindStore(store);\r\n    if (this.active === true) {\r\n      this.unwatchStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start watching all stores already bound to that strategy at once.\r\n   * @internal\r\n   */\r\n  protected doActivate() {\r\n    this.stores.forEach((store: FeatureStore) => this.watchStore(store));\r\n  }\r\n\r\n  /**\r\n   * Stop watching all stores bound to that strategy\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {\r\n    this.unwatchAll();\r\n  }\r\n\r\n  /**\r\n   * Watch for a store's  OL source changes\r\n   * @param store Feature store\r\n   */\r\n  private watchStore(store: FeatureStore) {\r\n    if (this.stores$$.has(store)) {\r\n      return;\r\n    }\r\n\r\n    this.updateEntitiesInExtent(store);\r\n    this.states$$.push(store.layer.map.viewController.state$.subscribe(() => {\r\n      this.updateEntitiesInExtent(store);\r\n    }));\r\n  }\r\n\r\n  private updateEntitiesInExtent(store) {\r\n    if (store?.layer?.map?.viewController) {\r\n      store.state.updateAll({ inMapExtent: false });\r\n      const mapExtent = store.layer.map.viewController.getExtent();\r\n      let entitiesInMapExtent = [];\r\n      let entitiesWithNoGeom = [];\r\n      for (const entity of store.entities$.value) {\r\n        if (entity.ol) {\r\n          if (olextent.intersects(entity.ol.getGeometry().getExtent(), mapExtent)) {\r\n            entitiesInMapExtent.push(entity);\r\n          }\r\n        } else {\r\n          entitiesWithNoGeom.push(entity);\r\n        }\r\n      }\r\n      if (entitiesInMapExtent.length > 0) {\r\n        store.state.updateMany(entitiesInMapExtent, { inMapExtent: true }, false);\r\n      }\r\n      if (entitiesWithNoGeom.length > 0) {\r\n        store.state.updateMany(entitiesWithNoGeom, { inMapExtent: true }, false);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop watching for a store's OL source changes\r\n   * @param store Feature store\r\n   */\r\n  private unwatchStore(store: FeatureStore) {\r\n    const key = this.stores$$.get(store);\r\n    if (key !== undefined) {\r\n      this.stores$$.delete(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop watching for OL source changes in all stores.\r\n   */\r\n  private unwatchAll() {\r\n    this.stores$$.clear();\r\n    this.states$$.map(state => state.unsubscribe());\r\n    if (this.empty$$) { this.empty$$.unsubscribe(); }\r\n  }\r\n}\r\n","import { EntityStoreStrategy } from '@igo2/common';\r\n\r\nimport { FeatureStore } from '../store';\r\nimport { FeatureStoreInMapResolutionStrategyOptions } from '../feature.interfaces';\r\nimport { Subscription } from 'rxjs';\r\n\r\n\r\n/**\r\n * This strategy maintain the store features updated while the map is scrolled.\r\n * The features's state inside the map's resolution are tagged inMapResolution = true;\r\n */\r\nexport class FeatureStoreInMapResolutionStrategy extends EntityStoreStrategy {\r\n\r\n  /**\r\n   * Subscription to the store's OL source changes\r\n   */\r\n  private stores$$ = new Map<FeatureStore, string>();\r\n  private resolution$$: Subscription[] = [];\r\n  private empty$$: Subscription;\r\n\r\n  constructor(protected options: FeatureStoreInMapResolutionStrategyOptions) {\r\n    super(options);\r\n  }\r\n\r\n  /**\r\n   * Bind this strategy to a store and start watching for Ol source changes\r\n   * @param store Feature store\r\n   */\r\n  bindStore(store: FeatureStore) {\r\n    super.bindStore(store);\r\n    if (this.active === true) {\r\n      this.watchStore(store);\r\n    }\r\n    this.empty$$ = store.empty$\r\n      .subscribe(() => this.updateEntitiesInResolution(store, store.layer.map.viewController.getResolution()));\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from a store and stop watching for Ol source changes\r\n   * @param store Feature store\r\n   */\r\n  unbindStore(store: FeatureStore) {\r\n    super.unbindStore(store);\r\n    if (this.active === true) {\r\n      this.unwatchStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start watching all stores already bound to that strategy at once.\r\n   * @internal\r\n   */\r\n  protected doActivate() {\r\n    this.stores.forEach((store: FeatureStore) => this.watchStore(store));\r\n  }\r\n\r\n  /**\r\n   * Stop watching all stores bound to that strategy\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {\r\n    this.unwatchAll();\r\n  }\r\n\r\n  /**\r\n   * Watch for a store's  OL source changes\r\n   * @param store Feature store\r\n   */\r\n  private watchStore(store: FeatureStore) {\r\n    if (this.stores$$.has(store)) {\r\n      return;\r\n    }\r\n\r\n    this.updateEntitiesInResolution(store, store.layer.map.viewController.getResolution());\r\n    this.resolution$$.push(store.layer.map.viewController.resolution$.subscribe((res) => {\r\n      this.updateEntitiesInResolution(store, res);\r\n    }));\r\n  }\r\n\r\n  private updateEntitiesInResolution(store, mapResolution: number) {\r\n    if (mapResolution > store.layer.minResolution && mapResolution < store.layer.maxResolution) {\r\n      store.state.updateAll({ inMapResolution: true });\r\n    } else {\r\n      store.state.updateAll({ inMapResolution: false });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop watching for a store's OL source changes\r\n   * @param store Feature store\r\n   */\r\n  private unwatchStore(store: FeatureStore) {\r\n    const key = this.stores$$.get(store);\r\n    if (key !== undefined) {\r\n      this.stores$$.delete(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop watching for OL source changes in all stores.\r\n   */\r\n  private unwatchAll() {\r\n    this.stores$$.clear();\r\n    this.resolution$$.map(state => state.unsubscribe());\r\n    if (this.empty$$) { this.empty$$.unsubscribe(); }\r\n  }\r\n}\r\n","import { Subscription } from 'rxjs';\r\n\r\nimport { EntityStoreStrategy } from '@igo2/common';\r\n\r\nimport { FeatureMotion } from '../feature.enums';\r\nimport { Feature, FeatureStoreLoadingStrategyOptions } from '../feature.interfaces';\r\nimport { FeatureStore } from '../store';\r\n\r\n/**\r\n * This strategy loads a store's features into it's layer counterpart.\r\n * The store -> layer binding is a one-way binding. That means any entity\r\n * added to the store will be added to the layer but the opposite is false.\r\n *\r\n * Important: This strategy observes filtered entities, not raw entities. This\r\n * is not configurable yet.\r\n */\r\nexport class FeatureStoreLoadingStrategy extends EntityStoreStrategy {\r\n\r\n  /**\r\n   * Subscription to the store's features\r\n   */\r\n  private stores$$ = new Map<FeatureStore, Subscription>();\r\n\r\n  private motion: FeatureMotion;\r\n\r\n  constructor(protected options: FeatureStoreLoadingStrategyOptions) {\r\n    super(options);\r\n    this.setMotion(options.motion);\r\n  }\r\n\r\n  /**\r\n   * Bind this strategy to a store and start watching for entities changes\r\n   * @param store Feature store\r\n   */\r\n  bindStore(store: FeatureStore) {\r\n    super.bindStore(store);\r\n    if (this.active === true) {\r\n      this.watchStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from a store and stop watching for entities changes\r\n   * @param store Feature store\r\n   */\r\n  unbindStore(store: FeatureStore) {\r\n    super.unbindStore(store);\r\n    if (this.active === true) {\r\n      this.unwatchStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Define the motion to apply on load\r\n   * @param motion Feature motion\r\n   */\r\n  setMotion(motion: FeatureMotion) {\r\n    this.motion = motion;\r\n  }\r\n\r\n  /**\r\n   * Start watching all stores already bound to that strategy at once.\r\n   * @internal\r\n   */\r\n  protected doActivate() {\r\n    this.stores.forEach((store: FeatureStore) => this.watchStore(store));\r\n  }\r\n\r\n  /**\r\n   * Stop watching all stores bound to that strategy\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {\r\n    this.unwatchAll();\r\n  }\r\n\r\n  /**\r\n   * Watch for entities changes in a store.\r\n   * Important: Never observe a store's sorted entities. It makes no sense\r\n   * to display sorted entities (instead of unsorted) on a layer and it\r\n   * would potentially result in a lot of useless computation.\r\n   * @param store Feature store\r\n   */\r\n  private watchStore(store: FeatureStore) {\r\n    if (this.stores$$.has(store)) {\r\n      return;\r\n    }\r\n\r\n    const subscription = store.view.all$()\r\n      .subscribe((features: Feature[]) => this.onFeaturesChange(features, store));\r\n    this.stores$$.set(store, subscription);\r\n  }\r\n\r\n  /**\r\n   * Stop watching for entities changes in a store.\r\n   * @param store Feature store\r\n   */\r\n  private unwatchStore(store: FeatureStore) {\r\n    const subscription = this.stores$$.get(store);\r\n    if (subscription !== undefined) {\r\n      subscription.unsubscribe();\r\n      this.stores$$.delete(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop watching for entities changes in all stores.\r\n   */\r\n  private unwatchAll() {\r\n    Array.from(this.stores$$.entries()).forEach((entries: [FeatureStore, Subscription]) => {\r\n      entries[1].unsubscribe();\r\n    });\r\n    this.stores$$.clear();\r\n  }\r\n\r\n  /**\r\n   * Load features into a layer or clear the layer if the array of features is empty.\r\n   * @param features Store filtered features\r\n   * @param store Feature store\r\n   */\r\n  private onFeaturesChange(features: Feature[], store: FeatureStore) {\r\n    if (features.length === 0) {\r\n      store.clearLayer();\r\n    } else {\r\n      store.setLayerFeatures(\r\n        features,\r\n        this.selectMotion(store),\r\n        this.options.viewScale,\r\n        this.options.areaRatio,\r\n        this.options.getFeatureId\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Selects the best motion\r\n   * @param store A FeatureStore to apply the motion\r\n   * @returns The motion selected\r\n   */\r\n  private selectMotion(store: FeatureStore) {\r\n    if (this.motion !== undefined) { return this.motion; }\r\n\r\n    if (store.pristine === true) {\r\n      // If features have just been loaded into the store, move/zoom on them\r\n      return FeatureMotion.Default;\r\n    } else if (store.count > store.view.count) {\r\n      // If features have been filtered, move/zoom on the remaining ones\r\n      return FeatureMotion.Default;\r\n    } else {\r\n      // On insert, update or delete, do nothing\r\n      return FeatureMotion.None;\r\n    }\r\n  }\r\n}\r\n","import OlEvent from 'ol/events/Event';\r\n\r\nimport { EntityStoreStrategy } from '@igo2/common';\r\n\r\nimport { FeatureStore } from '../store';\r\nimport { FeatureStoreLoadingLayerStrategyOptions } from '../feature.interfaces';\r\nimport { ClusterDataSource } from '../../../datasource/shared/datasources/cluster-datasource';\r\n\r\n/**\r\n * This strategy loads a layer's features into it's store counterpart.\r\n * The layer -> store binding is a one-way binding. That means any OL feature\r\n * added to the layer will be added to the store but the opposite is false.\r\n *\r\n * Important: In it's current state, this strategy is to meant to be combined\r\n * with a standard Loading strategy and it would probably cause recursion issues.\r\n */\r\nexport class FeatureStoreLoadingLayerStrategy extends EntityStoreStrategy {\r\n\r\n  /**\r\n   * Subscription to the store's OL source changes\r\n   */\r\n  private stores$$ = new Map<FeatureStore, string>();\r\n\r\n  constructor(protected options: FeatureStoreLoadingLayerStrategyOptions) {\r\n    super(options);\r\n  }\r\n\r\n  /**\r\n   * Bind this strategy to a store and start watching for Ol source changes\r\n   * @param store Feature store\r\n   */\r\n  bindStore(store: FeatureStore) {\r\n    super.bindStore(store);\r\n    if (this.active === true) {\r\n      this.watchStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from a store and stop watching for Ol source changes\r\n   * @param store Feature store\r\n   */\r\n  unbindStore(store: FeatureStore) {\r\n    super.unbindStore(store);\r\n    if (this.active === true) {\r\n      this.unwatchStore(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start watching all stores already bound to that strategy at once.\r\n   * @internal\r\n   */\r\n  protected doActivate() {\r\n    this.stores.forEach((store: FeatureStore) => this.watchStore(store));\r\n  }\r\n\r\n  /**\r\n   * Stop watching all stores bound to that strategy\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {\r\n    this.unwatchAll();\r\n  }\r\n\r\n  /**\r\n   * Watch for a store's  OL source changes\r\n   * @param store Feature store\r\n   */\r\n  private watchStore(store: FeatureStore) {\r\n    if (this.stores$$.has(store)) {\r\n      return;\r\n    }\r\n\r\n    this.onSourceChanges(store);\r\n    const olSource = store.layer.ol.getSource();\r\n    olSource.on('change', (event: OlEvent) => {\r\n      this.onSourceChanges(store);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Stop watching for a store's OL source changes\r\n   * @param store Feature store\r\n   */\r\n  private unwatchStore(store: FeatureStore) {\r\n    const key = this.stores$$.get(store);\r\n    if (key !== undefined) {\r\n      this.stores$$.delete(store);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Stop watching for OL source changes in all stores.\r\n   */\r\n  private unwatchAll() {\r\n    Array.from(this.stores$$.entries()).forEach((entries: [FeatureStore, string]) => {\r\n    });\r\n    this.stores$$.clear();\r\n  }\r\n\r\n  /**\r\n   * Load features from an OL source into a  store or clear the store if the source is empty\r\n   * @param features Store filtered features\r\n   * @param store Feature store\r\n   */\r\n  private onSourceChanges(store: FeatureStore) {\r\n    let olFeatures = store.layer.ol.getSource().getFeatures();\r\n\r\n    if (store.layer.dataSource instanceof ClusterDataSource) {\r\n      olFeatures = (olFeatures as any).flatMap((cluster: any) =>\r\n        cluster.get('features')\r\n      );\r\n    }\r\n    if (olFeatures.length === 0) {\r\n      store.clear();\r\n    } else {\r\n      store.setStoreOlFeatures(olFeatures);\r\n    }\r\n  }\r\n}\r\n","import OlFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport OlDragBoxInteraction, { DragBoxEvent } from 'ol/interaction/DragBox';\r\nimport { DragBoxEvent as OlDragBoxEvent } from 'ol/interaction/DragBox';\r\nimport { EventsKey } from 'ol/events';\r\nimport MapBrowserPointerEvent from 'ol/MapBrowserEvent';\r\nimport { unByKey } from 'ol/Observable';\r\n\r\nimport { Subscription, combineLatest } from 'rxjs';\r\nimport { map, debounceTime, skip } from 'rxjs/operators';\r\n\r\nimport { EntityKey, EntityRecord, EntityStoreStrategy } from '@igo2/common';\r\n\r\nimport { FeatureDataSource } from '../../../datasource';\r\nimport { VectorLayer } from '../../../layer/shared/layers/vector-layer';\r\nimport { IgoMap } from '../../../map/shared/map';\r\nimport { ctrlKeyDown } from '../../../map/shared/map.utils';\r\n\r\nimport {\r\n  Feature,\r\n  FeatureStoreSelectionStrategyOptions\r\n} from '../feature.interfaces';\r\nimport { FeatureStore } from '../store';\r\nimport { FeatureMotion } from '../feature.enums';\r\n\r\nexport class OlDragSelectInteraction extends OlDragBoxInteraction {\r\n  constructor(options) {\r\n    super(options);\r\n  }\r\n}\r\n\r\n/**\r\n * This strategy synchronizes a store and a layer selected entities.\r\n * The store <-> layer binding is a two-way binding.\r\n *\r\n * In many cases, a single strategy bound to multiple stores\r\n * will yield better results that multiple strategies with each their\r\n * own store. In the latter scenario, a click on overlapping features\r\n * would trigger the strategy of each layer and they would cancel\r\n * each other as well as move the map view around needlessly.\r\n */\r\nexport class FeatureStoreSelectionStrategy extends EntityStoreStrategy {\r\n  /**\r\n   * Listener to the map click event that allows selecting a feature\r\n   * by clicking on the map\r\n   */\r\n  private mapClickListener;\r\n\r\n  private olDragSelectInteraction: OlDragSelectInteraction;\r\n\r\n  private olDragSelectInteractionEndKey: EventsKey | EventsKey[];\r\n\r\n  /**\r\n   * Subscription to all stores selected entities\r\n   */\r\n  private stores$$: Subscription;\r\n\r\n  private motion: FeatureMotion;\r\n\r\n  /**\r\n   * The map the layers belong to\r\n   */\r\n  get map(): IgoMap {\r\n    return this.options.map;\r\n  }\r\n\r\n  /**\r\n   * A feature store that'll contain the selected features. It has it's own\r\n   * layer, shared by all the stores this staretgy is bound to.\r\n   */\r\n  get overlayStore(): FeatureStore {\r\n    return this._overlayStore;\r\n  }\r\n  private _overlayStore: FeatureStore;\r\n\r\n  constructor(protected options: FeatureStoreSelectionStrategyOptions) {\r\n    super(options);\r\n    this.setMotion(options.motion);\r\n    this._overlayStore = this.createOverlayStore();\r\n  }\r\n\r\n  /**\r\n   * Bind this strategy to a store and force this strategy's\r\n   * reactivation to properly setup watchers.\r\n   * @param store Feature store\r\n   */\r\n  bindStore(store: FeatureStore) {\r\n    super.bindStore(store);\r\n    if (this.active === true) {\r\n      // Force reactivation\r\n      this.activate();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unbind this strategy from a store and force this strategy's\r\n   * reactivation to properly setup watchers.\r\n   * @param store Feature store\r\n   */\r\n  unbindStore(store: FeatureStore) {\r\n    super.unbindStore(store);\r\n    if (this.active === true) {\r\n      // Force reactivation\r\n      this.activate();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Define the motion to apply on select\r\n   * @param motion Feature motion\r\n   */\r\n  setMotion(motion: FeatureMotion) {\r\n    this.motion = motion;\r\n  }\r\n\r\n  /**\r\n   * Unselect all entities, from all stores\r\n   */\r\n  unselectAll() {\r\n    this.stores.forEach((store: FeatureStore) => {\r\n      store.state.updateAll({ selected: false });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay\r\n   */\r\n  clear() {\r\n    this.overlayStore.source.ol.clear();\r\n    this.overlayStore.clear();\r\n  }\r\n\r\n  /**\r\n   * Deactivate the selection without removing the selection\r\n   * overlay.\r\n   */\r\n  deactivateSelection() {\r\n    this.unlistenToMapClick();\r\n    this.removeDragBoxInteraction();\r\n    this.unwatchAll();\r\n  }\r\n\r\n  /**\r\n   * Add the overlay layer, setup the map click lsitener and\r\n   * start watching for stores selection\r\n   * @internal\r\n   */\r\n  protected doActivate() {\r\n    this.addOverlayLayer();\r\n    this.listenToMapClick();\r\n    if (this.options.dragBox === true) {\r\n      this.addDragBoxInteraction();\r\n    }\r\n    this.watchAll();\r\n  }\r\n\r\n  /**\r\n   * Remove the overlay layer, remove the map click lsitener and\r\n   * stop watching for stores selection\r\n   * @internal\r\n   */\r\n  protected doDeactivate() {\r\n    this.deactivateSelection();\r\n    this.removeOverlayLayer();\r\n  }\r\n\r\n  /**\r\n   * Create a single observable of all the stores. With a single observable,\r\n   * features can be added all at once to the overlay layer and a single\r\n   * motion can be performed. Multiple observable would have\r\n   * a cancelling effect on each other.\r\n   */\r\n  private watchAll() {\r\n    this.unwatchAll();\r\n\r\n    const stores$ = this.stores.map((store: FeatureStore) => {\r\n      return store.stateView\r\n        .manyBy$((record: EntityRecord<Feature>) => {\r\n          return record.state.selected === true;\r\n        })\r\n        .pipe(\r\n          map((records: EntityRecord<Feature>[]) =>\r\n            records.map((record) => record.entity)\r\n          )\r\n        );\r\n    });\r\n    this.stores$$ = combineLatest(stores$)\r\n      .pipe(\r\n        debounceTime(5),\r\n        skip(1), // Skip intial selection\r\n        map((features: Array<Feature[]>) =>\r\n          features.reduce((a, b) => a.concat(b))\r\n        )\r\n      )\r\n      .subscribe((features: Feature[]) => this.onSelectFromStore(features));\r\n  }\r\n\r\n  /**\r\n   * Stop watching for selection in all stores.\r\n   */\r\n  private unwatchAll() {\r\n    if (this.stores$$ !== undefined) {\r\n      this.stores$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add a 'singleclick' listener to the map that'll allow selecting\r\n   * features by clicking on the map. The selection will be performed\r\n   * only on the layers bound to this strategy.\r\n   */\r\n  private listenToMapClick() {\r\n    this.mapClickListener = this.map.ol.on(\r\n      'singleclick',\r\n      (event: MapBrowserPointerEvent<any>) => {\r\n        this.onMapClick(event);\r\n      }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Remove the map click listener\r\n   */\r\n  private unlistenToMapClick() {\r\n    unByKey(this.mapClickListener);\r\n  }\r\n\r\n  /**\r\n   * On map click, select feature at pixel\r\n   * @param event OL MapBrowserPointerEvent\r\n   */\r\n  private onMapClick(event: MapBrowserPointerEvent<any>) {\r\n    const exclusive = !ctrlKeyDown(event);\r\n    const reverse = !exclusive;\r\n    const olFeatures = event.map.getFeaturesAtPixel(event.pixel, {\r\n      hitTolerance: this.options.hitTolerance || 0,\r\n      layerFilter: olLayer => {\r\n        const storeOlLayer = this.stores.find((store: FeatureStore) => {\r\n          return store.layer.ol === olLayer;\r\n        });\r\n        return storeOlLayer !== undefined;\r\n      }\r\n    }) as OlFeature<OlGeometry>[];\r\n    this.onSelectFromMap(olFeatures, exclusive, reverse);\r\n  }\r\n\r\n  /**\r\n   * Add a drag box interaction and, on drag box end, select features\r\n   */\r\n  private addDragBoxInteraction() {\r\n    let olDragSelectInteraction;\r\n    const olInteractions = this.map.ol.getInteractions().getArray();\r\n\r\n    // There can only be one dragbox interaction, so find the current one, if any\r\n    // Don't keep a reference to the current dragbox because we don't want\r\n    // to remove it when this startegy is deactivated\r\n    for (const olInteraction of olInteractions) {\r\n      if (olInteraction instanceof OlDragSelectInteraction) {\r\n        olDragSelectInteraction = olInteraction;\r\n        break;\r\n      }\r\n    }\r\n    // If no drag box interaction is found, create a new one and add it to the map\r\n    if (olDragSelectInteraction === undefined) {\r\n      olDragSelectInteraction = new OlDragSelectInteraction({\r\n        condition: ctrlKeyDown\r\n      });\r\n      this.map.ol.addInteraction(olDragSelectInteraction);\r\n      this.olDragSelectInteraction = olDragSelectInteraction;\r\n    }\r\n\r\n    this.olDragSelectInteractionEndKey = olDragSelectInteraction.on(\r\n      'boxend',\r\n      (event: DragBoxEvent) => this.onDragBoxEnd(event)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Remove drag box interaction\r\n   */\r\n  private removeDragBoxInteraction() {\r\n    if (this.olDragSelectInteractionEndKey !== undefined) {\r\n      unByKey(this.olDragSelectInteractionEndKey);\r\n    }\r\n    if (this.olDragSelectInteraction !== undefined) {\r\n      this.map.ol.removeInteraction(this.olDragSelectInteraction);\r\n    }\r\n    this.olDragSelectInteraction = undefined;\r\n  }\r\n\r\n  /**\r\n   * On dragbox end, select features in drag box\r\n   * @param event OL MapBrowserPointerEvent\r\n   */\r\n  private onDragBoxEnd(event: OlDragBoxEvent) {\r\n    const exclusive = !ctrlKeyDown(event.mapBrowserEvent);\r\n    const target = event.target as any;\r\n    const extent = target.getGeometry().getExtent();\r\n    const olFeatures = this.stores.reduce(\r\n      (acc: OlFeature<OlGeometry>[], store: FeatureStore) => {\r\n        const olSource = store.layer.ol.getSource();\r\n        acc.push(...olSource.getFeaturesInExtent(extent));\r\n        return acc;\r\n      },\r\n      []\r\n    );\r\n    this.onSelectFromMap(olFeatures, exclusive, false);\r\n  }\r\n\r\n  /**\r\n   * When features are selected from the store, add\r\n   * them to this startegy's overlay layer (select on map)\r\n   * @param features Store features\r\n   */\r\n  private onSelectFromStore(features: Feature[]) {\r\n    const motion = this.motion;\r\n    const olOverlayFeatures = this.overlayStore.layer.ol\r\n      .getSource()\r\n      .getFeatures();\r\n    const overlayFeaturesKeys = olOverlayFeatures.map((olFeature: OlFeature<OlGeometry>) =>\r\n      olFeature.getId()\r\n    );\r\n    const featuresKeys = features.map(this.overlayStore.getKey);\r\n\r\n    let doMotion;\r\n    if (features.length === 0) {\r\n      doMotion = false;\r\n    } else {\r\n      doMotion =\r\n        overlayFeaturesKeys.length !== featuresKeys.length ||\r\n        !overlayFeaturesKeys.every(\r\n          (key: EntityKey) => featuresKeys.indexOf(key) >= 0\r\n        );\r\n    }\r\n\r\n    this.overlayStore.setLayerFeatures(\r\n      features,\r\n      doMotion ? motion : FeatureMotion.None,\r\n      this.options.viewScale,\r\n      this.options.areaRatio,\r\n      this.options.getFeatureId\r\n    );\r\n  }\r\n\r\n  /**\r\n   * When features are selected from the map, also select them\r\n   * in their store.\r\n   * @param olFeatures OL feature objects\r\n   */\r\n  private onSelectFromMap(\r\n    olFeatures: OlFeature<OlGeometry>[],\r\n    exclusive: boolean,\r\n    reverse: boolean\r\n  ) {\r\n    const groupedFeatures = this.groupFeaturesByStore(olFeatures);\r\n\r\n    this.stores.forEach((store: FeatureStore) => {\r\n      const features = groupedFeatures.get(store);\r\n      if (features === undefined && exclusive === true) {\r\n        this.unselectAllFeaturesFromStore(store);\r\n      } else if (features === undefined && exclusive === false) {\r\n        // Do nothing\r\n      } else {\r\n        this.selectFeaturesFromStore(store, features, exclusive, reverse);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Select features in store\r\n   * @param store: Feature store\r\n   * @param features Features\r\n   */\r\n  private selectFeaturesFromStore(\r\n    store: FeatureStore,\r\n    features: Feature[],\r\n    exclusive: boolean,\r\n    reverse: boolean\r\n  ) {\r\n    if (reverse === true) {\r\n      store.state.reverseMany(features, ['selected']);\r\n    } else {\r\n      store.state.updateMany(features, { selected: true }, exclusive);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unselect all features from store\r\n   * @param store: Feature store\r\n   */\r\n  private unselectAllFeaturesFromStore(store: FeatureStore) {\r\n    store.state.updateAll({ selected: false });\r\n  }\r\n\r\n  /**\r\n   * This method returns a store -> features mapping from a list\r\n   * of OL selected features. OL features keep a reference to the store\r\n   * they are from.\r\n   * @param olFeatures: OL feature objects\r\n   * @returns Store -> features mapping\r\n   */\r\n  private groupFeaturesByStore(\r\n    olFeatures: OlFeature<OlGeometry>[]\r\n  ): Map<FeatureStore, Feature[]> {\r\n    const groupedFeatures = new Map<FeatureStore, Feature[]>();\r\n    if (olFeatures === null || olFeatures === undefined) {\r\n      return groupedFeatures;\r\n    }\r\n\r\n    olFeatures.forEach((olFeature: OlFeature<OlGeometry>) => {\r\n      const store = olFeature.get('_featureStore');\r\n      if (store === undefined) {\r\n        return;\r\n      }\r\n\r\n      let features = groupedFeatures.get(store);\r\n      if (features === undefined) {\r\n        features = [];\r\n        groupedFeatures.set(store, features);\r\n      }\r\n\r\n      const feature = store.get(olFeature.getId());\r\n      if (feature !== undefined) {\r\n        features.push(feature);\r\n      }\r\n    });\r\n\r\n    return groupedFeatures;\r\n  }\r\n\r\n  /**\r\n   * Create an overlay store that'll contain the selected features.\r\n   * @returns Overlay store\r\n   */\r\n  private createOverlayStore(): FeatureStore {\r\n    const overlayLayer = this.options.layer\r\n      ? this.options.layer\r\n      : this.createOverlayLayer();\r\n    return new FeatureStore([], { map: this.map }).bindLayer(overlayLayer);\r\n  }\r\n\r\n  /**\r\n   * Create an overlay store that'll contain the selected features.\r\n   * @returns Overlay layer\r\n   */\r\n  private createOverlayLayer(): VectorLayer {\r\n    return new VectorLayer({\r\n      zIndex: 300,\r\n      source: new FeatureDataSource(),\r\n      style: undefined,\r\n      showInLayerList: false,\r\n      exportable: false,\r\n      browsable: false\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Add the overlay store's layer to the map to display the selected\r\n   * features.\r\n   */\r\n  private addOverlayLayer() {\r\n    if (this.overlayStore.layer.map === undefined) {\r\n      this.map.addLayer(this.overlayStore.layer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove the overlay layer from the map\r\n   */\r\n  private removeOverlayLayer() {\r\n    this.overlayStore.source.ol.clear();\r\n    this.map.removeLayer(this.overlayStore.layer);\r\n  }\r\n}\r\n","import { FeatureStore } from './store';\r\nimport { FeatureStoreSelectionStrategy } from './strategies/selection';\r\nimport { FeatureStoreLoadingStrategy } from './strategies/loading';\r\n\r\n/**\r\n * Try to add a loading strategy to a store and activate it.\r\n * If no strategy is given to that function, a basic one will be created.\r\n * @param store The store to bind the loading strategy\r\n * @param strategy An optional loading strategy\r\n */\r\nexport function tryAddLoadingStrategy(\r\n  store: FeatureStore,\r\n  strategy?: FeatureStoreLoadingStrategy\r\n) {\r\n  if (store.getStrategyOfType(FeatureStoreLoadingStrategy) !== undefined) {\r\n    store.activateStrategyOfType(FeatureStoreLoadingStrategy);\r\n    return;\r\n  }\r\n\r\n  strategy = strategy ? strategy : new FeatureStoreLoadingStrategy({});\r\n  store.addStrategy(strategy);\r\n  strategy.activate();\r\n}\r\n\r\n/**\r\n * Try to add a selection strategy to a store and activate it.\r\n * If no strategy is given to that function, a basic one will be created.\r\n * @param store The store to bind the selection strategy\r\n * @param [strategy] An optional selection strategy\r\n */\r\nexport function tryAddSelectionStrategy(\r\n  store: FeatureStore,\r\n  strategy?: FeatureStoreSelectionStrategy\r\n) {\r\n  if (store.getStrategyOfType(FeatureStoreSelectionStrategy) !== undefined) {\r\n    store.activateStrategyOfType(FeatureStoreSelectionStrategy);\r\n    return;\r\n  }\r\n  strategy = strategy\r\n    ? strategy\r\n    : new FeatureStoreSelectionStrategy({\r\n        map: store.map\r\n      });\r\n  store.addStrategy(strategy);\r\n  strategy.activate();\r\n}\r\n","import * as olstyle from 'ol/style';\r\nimport { asArray as ColorAsArray } from 'ol/color';\r\n\r\n/**\r\n * Create a marker style for points\r\n * @returns Style\r\n */\r\nexport function createOverlayMarkerStyle({\r\n  text,\r\n  opacity = 1,\r\n  markerColor = [0, 161, 222],\r\n  markerOutlineColor = [255, 255, 255]\r\n}: {\r\n  text?: string;\r\n  opacity?: number;\r\n  markerColor?: string | number[];\r\n  markerOutlineColor?: string | number[];\r\n} = {}): olstyle.Style {\r\n  let iconColor;\r\n  let svgIconColor;\r\n  let svgOutlineColor;\r\n  let svg;\r\n\r\n  const isIE = /msie\\s|trident\\/|edge\\//i.test(window.navigator.userAgent); // To fix IE11 svg bug (temporarly)\r\n\r\n  const newColor = ColorAsArray(markerColor).slice(0);\r\n  const newOutlineColor = ColorAsArray(markerOutlineColor).slice(0);\r\n\r\n  if (newColor.length === 4 && (typeof markerColor !== 'string' || /^#[0-9A-F]{8}$/i.test(markerColor as string))) {\r\n    opacity = newColor[3];\r\n  }\r\n\r\n  svgIconColor = `\"rgba(${newColor[0]},${newColor[1]},${newColor[2]},${opacity})\"`;\r\n  iconColor = markerColor;\r\n\r\n  svgOutlineColor = `\"rgb(${newOutlineColor[0]},${newOutlineColor[1]},${newOutlineColor[2]})\"`;\r\n\r\n  svg =\r\n    'data:image/svg+xml;utf8,<svg version=\"1.1\" xmlns=\"http://www.w3.org/2000/svg\" height=\"36\" width=\"36\" viewBox=\"0 0 36 36\">' +\r\n    '<path fill=' +\r\n    svgIconColor +\r\n    ' stroke=' +\r\n    svgOutlineColor +\r\n    ` stroke-width=\"2\" d=\"M 17.692635,32.565644 C 15.71852,30.330584 13.290925,27.058065 11.6766,24.455732 9.3398623,20.688851 7.8905694,17.205334 7.6297492,14.728733 7.5616025,14.081649 7.5739557,12.528552 7.6513363,12.014724 8.1013861,9.0262716 9.8047068,6.3655569 12.310675,4.7364878 c 1.113691,-0.7239832 2.508083,-1.2834131 3.776687,-1.5152052 0.242945,-0.044389 0.451656,-0.09393 0.463804,-0.1100911 0.01215,-0.016161 0.638282,-0.025502 1.391411,-0.02076 1.088235,0.00685 1.450932,0.024316 1.766871,0.085071 2.650763,0.5097353 4.947142,1.8701891 6.498786,3.8501033 0.628018,0.8013587 1.297046,2.0200608 1.640967,2.9891872 0.191065,0.538399 0.427644,1.447408 0.477391,1.834287 0.0164,0.127546 0.0434,0.231902 0.06,0.231902 0.0166,0 0.03122,0.626135 0.03249,1.391411 0.0013,0.765276 -0.011,1.391411 -0.02726,1.391411 -0.01626,0 -0.05449,0.154049 -0.08495,0.342331 -0.08815,0.544879 -0.387235,1.721449 -0.604837,2.379406 -1.209421,3.656888 -4.014463,8.349762 -7.849521,13.132357 -0.790496,0.985807 -1.795217,2.167992 -1.842543,2.167992 -0.01896,0 -0.161766,-0.144111 -0.317336,-0.320246 z m 1.066937,-15.36525 c 0.133519,-0.02121 0.248766,-0.05657 0.256105,-0.07859 0.0073,-0.02202 0.04918,-0.03066 0.09298,-0.0192 0.0438,0.01145 0.107628,-0.0072 0.141834,-0.04137 0.03421,-0.03421 0.08456,-0.05474 0.111888,-0.04563 0.02733,0.0091 0.07703,-0.01077 0.110429,-0.04417 0.03341,-0.03341 0.08416,-0.05293 0.112796,-0.04338 0.02863,0.0095 0.08974,-0.01867 0.135802,-0.06271 0.04606,-0.04403 0.111902,-0.08625 0.146319,-0.09381 0.204084,-0.04483 0.762371,-0.519108 1.079463,-0.917027 0.26749,-0.335672 0.570987,-0.878795 0.529019,-0.946701 -0.01496,-0.0242 -0.0067,-0.044 0.01835,-0.044 0.05645,0 0.196809,-0.467982 0.158801,-0.529481 -0.01521,-0.02461 -0.0043,-0.04475 0.02427,-0.04475 0.03157,0 0.04365,-0.04329 0.03082,-0.11043 -0.01161,-0.06074 -0.0066,-0.110429 0.01124,-0.110429 0.01779,0 0.03235,-0.258405 0.03235,-0.574233 0,-0.315829 -0.01545,-0.574234 -0.03434,-0.574234 -0.01889,0 -0.02437,-0.03811 -0.01219,-0.08469 0.04412,-0.168712 -0.336329,-1.152668 -0.481536,-1.245401 -0.02327,-0.01486 -0.04022,-0.03992 -0.03765,-0.05568 0.01222,-0.07498 -0.156557,-0.318365 -0.406379,-0.586027 -0.295921,-0.317054 -0.773059,-0.690104 -0.83427,-0.652274 -0.0206,0.01273 -0.03745,0.0024 -0.03745,-0.02289 0,-0.06107 -0.433076,-0.2789369 -0.487546,-0.245273 -0.02338,0.01445 -0.04251,0.0068 -0.04251,-0.01695 0,-0.056281 -0.393995,-0.1865457 -0.613804,-0.2029397 -0.0943,-0.00703 -0.188579,-0.023183 -0.209503,-0.035888 -0.02092,-0.012705 -0.276571,-0.023337 -0.568105,-0.023627 -0.534044,-5.301e-4 -1.12638,0.091025 -1.12638,0.1741017 0,0.023781 -0.01713,0.032648 -0.03808,0.019705 -0.05054,-0.031232 -0.403641,0.1088602 -0.403641,0.1601422 0,0.02204 -0.01988,0.02779 -0.04417,0.01278 -0.0243,-0.01501 -0.04417,-0.0051 -0.04417,0.02209 0,0.02716 -0.01988,0.0371 -0.04417,0.02209 -0.0243,-0.01501 -0.04417,-0.0051 -0.04417,0.02209 0,0.02716 -0.01915,0.03755 -0.04256,0.02308 -0.02341,-0.01447 -0.08138,0.01252 -0.128834,0.05997 -0.04745,0.04745 -0.0974,0.07515 -0.111001,0.06155 -0.0136,-0.0136 -0.03722,0.0078 -0.05248,0.0476 -0.01526,0.03978 -0.0411,0.06408 -0.0574,0.054 -0.03277,-0.02025 -0.462299,0.323995 -0.491977,0.394291 -0.01026,0.02429 -0.07454,0.0912 -0.142856,0.148686 -0.248033,0.208705 -0.730279,0.974169 -0.672565,1.067553 0.0145,0.02346 0.0059,0.04266 -0.01914,0.04266 -0.05907,0 -0.241471,0.599428 -0.208527,0.685278 0.01385,0.0361 0.0044,0.06564 -0.02098,0.06564 -0.02539,0 -0.04169,0.0646 -0.03622,0.143558 0.0055,0.07896 -0.0042,0.213129 -0.02144,0.29816 -0.04741,0.233576 0.0511,1.055502 0.167516,1.397721 0.126048,0.370516 0.310099,0.740163 0.426484,0.856548 0.04776,0.04776 0.07554,0.08684 0.06174,0.08684 -0.0138,0 0.01516,0.05653 0.06436,0.125632 0.131301,0.184396 0.499365,0.587266 0.518785,0.567846 0.0092,-0.0092 0.09821,0.06081 0.197812,0.155562 0.09961,0.09475 0.190589,0.162786 0.202187,0.151188 0.0116,-0.0116 0.05991,0.01774 0.107361,0.06519 0.04745,0.04745 0.105426,0.07444 0.128834,0.05997 0.02341,-0.01447 0.04256,-0.0057 0.04256,0.01958 0,0.06106 0.344664,0.23496 0.399061,0.201341 0.02346,-0.0145 0.04266,-0.0059 0.04266,0.01914 0,0.05907 0.599429,0.241471 0.685279,0.208527 0.0361,-0.01385 0.06564,-0.0065 0.06564,0.01645 0,0.05196 1.079115,0.04833 1.413314,-0.0048 z\"></path>` +\r\n    '</svg>';\r\n\r\n  let src;\r\n  if (isIE) {\r\n    switch (markerColor) {\r\n      case 'blue' || [0, 161, 222] || '#00a1de':\r\n        iconColor = 'blue';\r\n        break;\r\n      case 'red' || '#f64139':\r\n        iconColor = 'red';\r\n        break;\r\n      case 'yellow' || '#ffd700':\r\n        iconColor = 'yellow';\r\n        break;\r\n      case 'green' || '#008000':\r\n        iconColor = 'green';\r\n        break;\r\n      default:\r\n        iconColor = 'blue';\r\n        break;\r\n    }\r\n    src = './assets/igo2/geo/icons/place_' + iconColor + '_36px.svg';\r\n  } else {\r\n    src = svg;\r\n  }\r\n\r\n  return new olstyle.Style({\r\n    image: new olstyle.Icon({\r\n      src: svg,\r\n      opacity,\r\n      imgSize: [36, 36], // for ie\r\n      anchor: [0.5, 0.92]\r\n    }),\r\n    text: new olstyle.Text({\r\n      text,\r\n      font: '12px Calibri,sans-serif',\r\n      fill: new olstyle.Fill({ color: '#000' }),\r\n      stroke: new olstyle.Stroke({ color: '#fff', width: 3 }),\r\n      overflow: true\r\n    })\r\n  });\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport * as olstyle from 'ol/style';\r\nimport OlFeature from 'ol/Feature';\r\nimport { StyleByAttribute } from './vector-style.interface';\r\n\r\nimport { ClusterParam } from './clusterParam';\r\nimport { createOverlayMarkerStyle } from '../../overlay/shared/overlay-marker-style.utils';\r\nimport RenderFeature from 'ol/render/Feature';\r\nimport { getResolutionFromScale } from '../../map/shared/map.utils';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class StyleService {\r\n  public style: olstyle.Style;\r\n\r\n  /**\r\n   * Create a style based on a object as\r\n   * style: {\r\n   *       \"stroke\": {\r\n   *         \"color\": \"blue\",\r\n   *         \"lineDash\": [10, 5]\r\n   *       },\r\n   *       \"text\": {\r\n   *         \"minScaleDenom\": 50000,\r\n   *         \"maxScaleDenom\": 200000,\r\n   *         \"minResolution\": 100,\r\n   *         \"maxResolution\": 400,\r\n   *         \"attribute\": \"THE COLUMN NAME TO RETRIEVE THE LABEL VALUE\",\r\n   *         \"text\": \"MY HARCODED TEXT\",\r\n   *         \"stroke\": {\r\n   *           \"color\": \"blue\",\r\n   *           \"width\": 0.75\r\n   *         },\r\n   *         \"fill\": {\r\n   *           \"color\": \"black\"\r\n   *         },\r\n   *         \"font\": \"20px sans-serif\",\r\n   *         \"overflow\": true,\r\n   *         \"offsetX\": 10,\r\n   *         \"offsetY\": 20,\r\n   *         \"padding\": [2.5, 2.5, 2.5, 2.5]\r\n   *       },\r\n   *       \"width\": 5\r\n   *     }\r\n   *\r\n   * @param options\r\n   * @param feature feature to apply style on\r\n   * @param resolution current map resolution, to control label resolution range\r\n   * @returns\r\n   */\r\n  createStyle(options: { [key: string]: any }, feature?: RenderFeature | OlFeature<OlGeometry>, resolution?: number) {\r\n\r\n    if (!options) {\r\n      return createOverlayMarkerStyle();\r\n    }\r\n    if (typeof options === 'function' || options instanceof olstyle.Style) {\r\n      return options;\r\n    }\r\n    const parsedStyle = this.parseStyle('style', options);\r\n    if (parsedStyle.getText()) {\r\n      let labelMinResolution = 0;\r\n      let labelMaxResolution = Infinity;\r\n      if (options.text) {\r\n        const labelMinResolutionFromScale =\r\n          options.text?.minScaleDenom ? getResolutionFromScale(Number(options.text.minScaleDenom)) : undefined;\r\n        const labelMaxResolutionFromScale =\r\n          options.text?.maxScaleDenom ? getResolutionFromScale(Number(options.text.maxScaleDenom)) : undefined;\r\n        const minResolution = options.text?.minResolution ? options.text.minResolution : 0;\r\n        const maxResolution = options.text?.maxResolution ? options.text.maxResolution : Infinity;\r\n\r\n        labelMinResolution = labelMinResolutionFromScale || minResolution;\r\n        labelMaxResolution = labelMaxResolutionFromScale || maxResolution;\r\n      }\r\n      if (feature && resolution >= labelMinResolution && resolution <= labelMaxResolution) {\r\n        if (feature && options.text.attribute) {\r\n          parsedStyle.getText().setText(this.getLabel(feature, options.text.attribute));\r\n        }\r\n      } else {\r\n        parsedStyle.setText();\r\n      }\r\n    }\r\n    return parsedStyle;\r\n  }\r\n\r\n  private parseStyle(key: string, value: any) {\r\n    const styleOptions = {};\r\n    const olCls = this.getOlCls(key);\r\n\r\n    if (olCls && value instanceof Object) {\r\n      Object.keys(value).forEach(_key => {\r\n        const olKey = this.getOlKey(_key);\r\n        styleOptions[olKey] = this.parseStyle(_key, value[_key]);\r\n      });\r\n      return new olCls(styleOptions);\r\n    } else {\r\n      return value;\r\n    }\r\n  }\r\n\r\n  private getOlKey(key: any) {\r\n    let olKey;\r\n    switch (key.toLowerCase()) {\r\n      case 'circle':\r\n      case 'regularshape':\r\n      case 'icon':\r\n        olKey = 'image';\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n\r\n    return olKey || key;\r\n  }\r\n\r\n  private getOlCls(key: any) {\r\n    let olCls = olstyle[key.charAt(0).toUpperCase() + key.slice(1)];\r\n    if (key === 'regularshape') {\r\n      olCls = olstyle.RegularShape;\r\n    }\r\n    if (key === 'backgroundFill') {\r\n      olCls = olstyle.Fill;\r\n    }\r\n    if (key === 'backgroundStroke') {\r\n      olCls = olstyle.Stroke;\r\n    }\r\n\r\n    return olCls;\r\n  }\r\n\r\n  createStyleByAttribute(feature: RenderFeature | OlFeature<OlGeometry>, styleByAttribute: StyleByAttribute, resolution: number) {\r\n\r\n    let style;\r\n    const type = styleByAttribute.type ? styleByAttribute.type : this.guessTypeFeature(feature);\r\n    const attribute = styleByAttribute.attribute;\r\n    const data = styleByAttribute.data;\r\n    const stroke = styleByAttribute.stroke;\r\n    const width = styleByAttribute.width;\r\n    const fill = styleByAttribute.fill;\r\n    const anchor = styleByAttribute.anchor;\r\n    const radius = styleByAttribute.radius;\r\n    const icon = styleByAttribute.icon;\r\n    const scale = styleByAttribute.scale;\r\n    const size = data ? data.length : 0;\r\n    const label = styleByAttribute.label ? styleByAttribute.label.attribute : undefined;\r\n    const labelMinResolutionFromScale =\r\n      styleByAttribute.label?.minScaleDenom ? getResolutionFromScale(Number(styleByAttribute.label.minScaleDenom)) : undefined;\r\n    const labelMaxResolutionFromScale =\r\n      styleByAttribute.label?.maxScaleDenom ? getResolutionFromScale(Number(styleByAttribute.label.maxScaleDenom)) : undefined;\r\n    const minResolution = styleByAttribute.label?.minResolution ? styleByAttribute.label.minResolution : 0;\r\n    const maxResolution = styleByAttribute.label?.maxResolution ? styleByAttribute.label.maxResolution : Infinity;\r\n\r\n    const labelMinResolution = labelMinResolutionFromScale || minResolution;\r\n    const labelMaxResolution = labelMaxResolutionFromScale || maxResolution;\r\n\r\n    let labelStyle = styleByAttribute.label?.style ? this.parseStyle('text', styleByAttribute.label.style) : undefined;\r\n    if (!labelStyle && label) {\r\n        labelStyle = new olstyle.Text();\r\n    }\r\n    const baseStyle = styleByAttribute.baseStyle;\r\n\r\n    if (labelStyle) {\r\n      if (resolution >= labelMinResolution && resolution <= labelMaxResolution) {\r\n        labelStyle.setText(this.getLabel(feature, label));\r\n      } else {\r\n        labelStyle.setText('');\r\n      }\r\n    }\r\n\r\n    if (type === 'circle') {\r\n      for (let i = 0; i < size; i++) {\r\n        const val =\r\n          typeof feature.get(attribute) !== 'undefined' && feature.get(attribute) !== null\r\n            ? feature.get(attribute)\r\n            : '';\r\n        if (val === data[i] || val.toString().match(new RegExp(data[i], 'gmi'))) {\r\n          if (icon) {\r\n            style = [\r\n              new olstyle.Style({\r\n                image: new olstyle.Icon({\r\n                  color: fill ? fill[i] : undefined,\r\n                  src: icon[i],\r\n                  scale: scale ? scale[i] : 1,\r\n                  anchor: anchor ? anchor[i] : [0.5, 0.5]\r\n                }),\r\n                text: labelStyle instanceof olstyle.Text ? labelStyle : undefined\r\n              })\r\n            ];\r\n            return style;\r\n          }\r\n          style = [\r\n            new olstyle.Style({\r\n              image: new olstyle.Circle({\r\n                radius: radius ? radius[i] : 4,\r\n                stroke: new olstyle.Stroke({\r\n                  color: stroke ? stroke[i] : 'black',\r\n                  width: width ? width[i] : 1\r\n                }),\r\n                fill: new olstyle.Fill({\r\n                  color: fill ? fill[i] : 'black'\r\n                })\r\n              }),\r\n              text: labelStyle instanceof olstyle.Text ? labelStyle : undefined\r\n            })\r\n          ];\r\n          return style;\r\n        }\r\n      }\r\n      if (!(feature as OlFeature<OlGeometry>).getStyle()) {\r\n        if (baseStyle) {\r\n          style = this.createStyle(baseStyle, feature, resolution);\r\n          if (labelStyle) {\r\n            style.setText(labelStyle);\r\n          }\r\n          return style;\r\n        }\r\n        style = [\r\n          new olstyle.Style({\r\n            image: new olstyle.Circle({\r\n              radius: 4,\r\n              stroke: new olstyle.Stroke({\r\n                color: 'black'\r\n              }),\r\n              fill: new olstyle.Fill({\r\n                color: '#bbbbf2'\r\n              })\r\n            })\r\n          })\r\n        ];\r\n        return style;\r\n      }\r\n    } else if (type === 'regular') {\r\n      for (let i = 0; i < size; i++) {\r\n        const val =\r\n        typeof feature.get(attribute) !== 'undefined' && feature.get(attribute) !== null\r\n            ? feature.get(attribute)\r\n            : '';\r\n        if (val === data[i] || val.toString().match(new RegExp(data[i], 'gmi'))) {\r\n          style = [\r\n            new olstyle.Style({\r\n              stroke: new olstyle.Stroke({\r\n                color: stroke ? stroke[i] : 'black',\r\n                width: width ? width[i] : 1\r\n              }),\r\n              fill: new olstyle.Fill({\r\n                color: fill ? fill[i] : 'rgba(255,255,255,0.4)'\r\n              }),\r\n              text: labelStyle instanceof olstyle.Text ? labelStyle : undefined\r\n            })\r\n          ];\r\n          return style;\r\n        }\r\n      }\r\n      if (feature instanceof OlFeature) {\r\n        if (!feature.getStyle()) {\r\n          if (baseStyle) {\r\n            style = this.createStyle(baseStyle, feature, resolution);\r\n            if (labelStyle) {\r\n              style.setText(labelStyle);\r\n            }\r\n            return style;\r\n          }\r\n          style = [\r\n            new olstyle.Style({\r\n              stroke: new olstyle.Stroke({\r\n                color: 'black'\r\n              }),\r\n              fill: new olstyle.Fill({\r\n                color: '#bbbbf2'\r\n              })\r\n            })\r\n          ];\r\n          return style;\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  createClusterStyle(feature: RenderFeature | OlFeature<OlGeometry>, resolution: number, clusterParam: ClusterParam = {}, layerStyle) {\r\n    let style;\r\n    const size = feature.get('features').length;\r\n    if (size !== 1) {\r\n      if (clusterParam.clusterRanges) {\r\n        for (const r of clusterParam.clusterRanges) {\r\n          if (\r\n            (!r.minRadius || r.minRadius <= size) &&\r\n            (!r.maxRadius || r.maxRadius >= size)\r\n          ) {\r\n            style = this.createStyle(r.style) as olstyle.Circle;\r\n\r\n            if (r.showRange) {\r\n              const text = new olstyle.Text({\r\n                text: size.toString(),\r\n                fill: new olstyle.Fill({\r\n                  color: '#fff'\r\n                })\r\n              });\r\n              style.setText(text);\r\n            }\r\n\r\n            if (r.dynamicRadius) {\r\n              let clusterRadius: number;\r\n              const radiusMin = style.getRadius();\r\n              clusterRadius = 5 * Math.log(size);\r\n              if (clusterRadius < radiusMin) {\r\n                clusterRadius = radiusMin;\r\n              }\r\n              style.image_.setRadius(clusterRadius);\r\n            }\r\n            break;\r\n          }\r\n        }\r\n      }\r\n\r\n      if (!style) {\r\n        let clusterRadius: number;\r\n        if (clusterParam.radiusCalc) {\r\n          clusterRadius = clusterParam.radiusCalc(size);\r\n        } else {\r\n          const radiusMin = 6;\r\n          clusterRadius = 5 * Math.log(size);\r\n          if (clusterRadius < radiusMin) {\r\n            clusterRadius = radiusMin;\r\n          }\r\n        }\r\n\r\n        style = [\r\n          new olstyle.Style({\r\n            image: new olstyle.Circle({\r\n              radius: clusterRadius,\r\n              stroke: new olstyle.Stroke({\r\n                color: 'black'\r\n              }),\r\n              fill: new olstyle.Fill({\r\n                color: 'rgba(24, 134, 45, 0.5)'\r\n              })\r\n            }),\r\n            text: new olstyle.Text({\r\n              text: size.toString(),\r\n              fill: new olstyle.Fill({\r\n                color: '#fff'\r\n              })\r\n            })\r\n          })\r\n        ];\r\n      }\r\n    } else {\r\n      style = this.createStyle(layerStyle, feature, resolution);\r\n    }\r\n    return style;\r\n  }\r\n\r\n  getLabel(feature, labelMatch): string {\r\n    let label = labelMatch;\r\n    if (!label) {\r\n      return;\r\n    }\r\n    const labelToGet = Array.from(labelMatch.matchAll(/\\$\\{([^\\{\\}]+)\\}/g));\r\n\r\n    labelToGet.forEach(v => {\r\n      label = label.replace(v[0], feature.get(v[1]));\r\n    });\r\n\r\n    // Nothing done? check feature's attribute\r\n    if (labelToGet.length === 0 && label === labelMatch) {\r\n      label = feature.get(labelMatch) || labelMatch;\r\n    }\r\n\r\n    return label;\r\n  }\r\n\r\n  private guessTypeFeature(feature) {\r\n    switch (feature.getGeometry().getType()) {\r\n      case 'Point':\r\n      case 'MultiPoint':\r\n      case 'Circle':\r\n        return 'circle';\r\n      default:\r\n        return 'regular';\r\n    }\r\n  }\r\n}\r\n","import * as olstyle from 'ol/style';\r\nimport OlFeature from 'ol/Feature';\r\nimport { asArray as ColorAsArray } from 'ol/color';\r\n\r\nimport { FeatureDataSource } from '../../datasource';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { StyleService } from '../../layer/shared/style.service';\r\nimport { createOverlayMarkerStyle } from './overlay-marker-style.utils';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\n/**\r\n * Create an overlay layer and it's source\r\n * @returns Overlay layer\r\n */\r\nexport function createOverlayLayer(): VectorLayer {\r\n  const overlayDataSource = new FeatureDataSource();\r\n  return new VectorLayer({\r\n    title: 'Overlay',\r\n    zIndex: 300,\r\n    source: overlayDataSource,\r\n    style: createOverlayLayerStyle()\r\n  });\r\n}\r\n\r\n/**\r\n * Create an overlay style with markers for points and a basic stroke/fill\r\n * combination for lines and polygons\r\n * @returns Style function\r\n */\r\nfunction createOverlayLayerStyle(): (olFeature: OlFeature<OlGeometry>, resolution: number) => olstyle.Style {\r\n  const defaultStyle = createOverlayDefaultStyle();\r\n  const markerStyle = createOverlayMarkerStyle();\r\n\r\n  let style;\r\n\r\n  return (olFeature: OlFeature<OlGeometry>, resolution) => {\r\n    if (olFeature.getId() === 'bufferFeature') {\r\n      style = createBufferStyle(\r\n        olFeature.get('bufferStroke'),\r\n        2,\r\n        olFeature.get('bufferFill'),\r\n        olFeature.get('bufferText')\r\n      );\r\n      return style;\r\n    } else {\r\n      const customStyle = olFeature.get('_style');\r\n      if (customStyle) {\r\n        const styleService = new StyleService();\r\n        return styleService.createStyle(customStyle, olFeature, resolution);\r\n      }\r\n      const geometryType = olFeature.getGeometry().getType();\r\n      style = geometryType === 'Point' ? markerStyle : defaultStyle;\r\n      style.getText().setText(olFeature.get('_mapTitle'));\r\n      return style;\r\n    }\r\n  };\r\n}\r\n\r\n/**\r\n * Create a basic style for lines and polygons\r\n * @returns Style\r\n */\r\nexport function createOverlayDefaultStyle({\r\n  text,\r\n  strokeWidth = 2,\r\n  fillColor = [0, 161, 222, 0.3],\r\n  strokeColor = [0, 161, 222, 0.9],\r\n}: {\r\n  text?: string;\r\n  strokeWidth?: number;\r\n  fillColor?: string | number[];\r\n  strokeColor?: string | number[];\r\n} = {}): olstyle.Style {\r\n  const fillWithOpacity = ColorAsArray(fillColor).slice(0);\r\n  const strokeWithOpacity = ColorAsArray(strokeColor).slice(0);\r\n\r\n  const stroke = new olstyle.Stroke({\r\n    width: strokeWidth,\r\n    color: strokeWithOpacity\r\n  });\r\n\r\n  const fill = new olstyle.Fill({\r\n    color: fillWithOpacity\r\n  });\r\n\r\n  return new olstyle.Style({\r\n    stroke,\r\n    fill,\r\n    image: new olstyle.Circle({\r\n      radius: 5,\r\n      stroke,\r\n      fill\r\n    }),\r\n    text: new olstyle.Text({\r\n      text,\r\n      font: '12px Calibri,sans-serif',\r\n      fill: new olstyle.Fill({ color: '#000' }),\r\n      stroke: new olstyle.Stroke({ color: '#fff', width: 3 }),\r\n      overflow: true\r\n    })\r\n  });\r\n}\r\n\r\nfunction createBufferStyle(\r\n  strokeRGBA: [number, number, number, number] = [0, 161, 222, 1],\r\n  strokeWidth: number = 2,\r\n  fillRGBA: [number, number, number, number] = [0, 161, 222, 0.15],\r\n  bufferRadius?\r\n): olstyle.Style {\r\n  const stroke = new olstyle.Stroke({\r\n    width: strokeWidth,\r\n    color: strokeRGBA\r\n  });\r\n\r\n  const fill = new olstyle.Fill({\r\n    color: fillRGBA\r\n  });\r\n\r\n  return new olstyle.Style({\r\n    stroke,\r\n    fill,\r\n    image: new olstyle.Circle({\r\n      radius: 5,\r\n      stroke,\r\n      fill\r\n    }),\r\n    text: new olstyle.Text({\r\n      font: '12px Calibri,sans-serif',\r\n      text: bufferRadius,\r\n      fill: new olstyle.Fill({ color: '#000' }),\r\n      stroke: new olstyle.Stroke({ color: '#fff', width: 3 }),\r\n      overflow: true\r\n    })\r\n  });\r\n}\r\n","import OlFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport {\r\n  Feature,\r\n  FeatureMotion,\r\n  featureToOl,\r\n  moveToOlFeatures\r\n} from '../../feature/shared';\r\nimport { FeatureDataSource } from '../../datasource';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { IgoMap } from '../../map/shared/map';\r\n\r\nimport { createOverlayLayer } from './overlay.utils';\r\n\r\n/**\r\n * This class is simply a shortcut for adding features to a map.\r\n * It does nothing more than a standard layer but it's shipped with\r\n * a defautl style based on the geometry type of the features it contains.\r\n * @todo Enhance that by using a FeatureStore and strategies.\r\n */\r\nexport class Overlay {\r\n  /**\r\n   * The map to add the layer to\r\n   */\r\n  private map: IgoMap;\r\n\r\n  /**\r\n   * Overlay layer\r\n   */\r\n  private layer: VectorLayer;\r\n\r\n  /**\r\n   * Overlay layer's data source\r\n   */\r\n  get dataSource(): FeatureDataSource {\r\n    return this.layer.dataSource as FeatureDataSource;\r\n  }\r\n\r\n  constructor(map?: IgoMap) {\r\n    this.layer = createOverlayLayer();\r\n    this.setMap(map);\r\n  }\r\n\r\n  /**\r\n   * Bind this to a map and add the overlay layer to that map\r\n   * @param map Map\r\n   */\r\n  setMap(map: IgoMap) {\r\n    if (map === undefined) {\r\n      if (this.map !== undefined) {\r\n        this.map.ol.removeLayer(this.layer.ol);\r\n      }\r\n    } else {\r\n      map.ol.addLayer(this.layer.ol);\r\n    }\r\n    this.map = map;\r\n  }\r\n\r\n  /**\r\n   * Set the overlay features and, optionally, move to them\r\n   * @param features Features\r\n   * @param motion Optional: Apply this motion to the map view\r\n   * @param sourceId Optional: Remove features of certain sourceId (ex: 'Map' for query features)\r\n   */\r\n  setFeatures(\r\n    features: Feature[],\r\n    motion: FeatureMotion = FeatureMotion.Default,\r\n    sourceId?: string\r\n  ) {\r\n    if (sourceId) {\r\n      for (const olFeature of this.dataSource.ol.getFeatures()) {\r\n        if (olFeature.get('_sourceId') === sourceId) {\r\n          this.removeOlFeature(olFeature);\r\n        }\r\n      }\r\n    } else {\r\n      this.clear();\r\n    }\r\n    this.addFeatures(features, motion);\r\n  }\r\n\r\n  /**\r\n   * Add a feature to the  overlay and, optionally, move to it\r\n   * @param feature Feature\r\n   * @param motion Optional: Apply this motion to the map view\r\n   */\r\n  addFeature(feature: Feature, motion: FeatureMotion = FeatureMotion.Default) {\r\n    this.addFeatures([feature], motion);\r\n  }\r\n\r\n  /**\r\n   * Add features to the  overlay and, optionally, move to them\r\n   * @param features Features\r\n   * @param motion Optional: Apply this motion to the map view\r\n   */\r\n  addFeatures(\r\n    features: Feature[],\r\n    motion: FeatureMotion = FeatureMotion.Default\r\n  ) {\r\n    const olFeatures = [];\r\n    features.forEach((feature: Feature) => {\r\n      const olFeature = featureToOl(feature, this.map.projection);\r\n      const olGeometry = olFeature.getGeometry();\r\n      if (olGeometry === null) {\r\n        return;\r\n      }\r\n      olFeatures.push(olFeature);\r\n    });\r\n\r\n    this.addOlFeatures(olFeatures, motion);\r\n  }\r\n\r\n  /**\r\n   * Add a OpenLayers feature to the  overlay and, optionally, move to it\r\n   * @param olFeature OpenLayers Feature\r\n   * @param motion Optional: Apply this motion to the map view\r\n   */\r\n  addOlFeature(\r\n    olFeature: OlFeature<OlGeometry>,\r\n    motion: FeatureMotion = FeatureMotion.Default\r\n  ) {\r\n    this.addOlFeatures([olFeature], motion);\r\n  }\r\n\r\n  /**\r\n   * Add OpenLayers features to the overlay and, optionally, move to them\r\n   * @param olFeatures OpenLayers Features\r\n   * @param motion Optional: Apply this motion to the map view\r\n   */\r\n  addOlFeatures(\r\n    olFeatures: OlFeature<OlGeometry>[],\r\n    motion: FeatureMotion = FeatureMotion.Default\r\n  ) {\r\n    this.dataSource.ol.addFeatures(olFeatures);\r\n    moveToOlFeatures(this.map, olFeatures, motion);\r\n  }\r\n\r\n  /**\r\n   * Remove a feature from the overlay\r\n   * @param feature Feature\r\n   */\r\n  removeFeature(feature: Feature) {\r\n    this.removeFeatures([feature]);\r\n  }\r\n\r\n  /**\r\n   * Remove features from the overlay\r\n   * @param features Features\r\n   */\r\n  removeFeatures(features: Feature[]) {\r\n    features.forEach((feature: Feature) => {\r\n      if (feature.meta) {\r\n        if (this.dataSource.ol.getFeatureById(feature.meta.id)) {\r\n          this.removeOlFeature(this.dataSource.ol.getFeatureById(feature.meta.id));\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Remove an OpenLayers feature from the overlay\r\n   * @param olFeature OpenLayers Feature\r\n   */\r\n  removeOlFeature(olFeature: OlFeature<OlGeometry>) {\r\n    this.dataSource.ol.removeFeature(olFeature);\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay\r\n   */\r\n  clear() {\r\n    this.dataSource.ol.clear();\r\n  }\r\n}\r\n","import { Subscription } from 'rxjs';\r\nimport { distinctUntilChanged } from 'rxjs/operators';\r\n\r\nimport { Watcher, SubjectStatus } from '@igo2/utils';\r\nimport { Layer } from '../../layer/shared/layers';\r\n\r\nexport class LayerWatcher extends Watcher {\r\n  private loaded = 0;\r\n  private loading = 0;\r\n  private layers: Layer[] = [];\r\n  private subscriptions: Subscription[] = [];\r\n\r\n  constructor() {\r\n    super();\r\n  }\r\n\r\n  watch() {}\r\n\r\n  unwatch() {\r\n    this.layers.forEach(layer => this.unwatchLayer(layer), this);\r\n  }\r\n\r\n  watchLayer(layer: Layer) {\r\n    if (layer.status$ === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.layers.push(layer);\r\n\r\n    const layer$$ = layer.status$\r\n      .pipe(distinctUntilChanged())\r\n      .subscribe(status => {\r\n        if (status === SubjectStatus.Error) {\r\n          this.loading = 0;\r\n          this.loaded = -1;\r\n        }\r\n        if (status === SubjectStatus.Working) {\r\n          this.loading += 1;\r\n        } else if (status === SubjectStatus.Done) {\r\n          this.loaded += 1;\r\n        }\r\n\r\n        if (this.loaded >= this.loading) {\r\n          this.loading = this.loaded = 0;\r\n          this.status = SubjectStatus.Done;\r\n        } else if (this.loading > 0) {\r\n          this.status = SubjectStatus.Working;\r\n        }\r\n      });\r\n\r\n    this.subscriptions.push(layer$$);\r\n  }\r\n\r\n  unwatchLayer(layer: Layer) {\r\n    layer.status$.next(SubjectStatus.Done);\r\n    const index = this.layers.indexOf(layer);\r\n    if (index >= 0) {\r\n      const status = (layer as any).watcher.status;\r\n      if (\r\n        [SubjectStatus.Working, SubjectStatus.Waiting].indexOf(status) !== -1\r\n      ) {\r\n        this.loaded += 1;\r\n      }\r\n      this.subscriptions[index].unsubscribe();\r\n      this.subscriptions.splice(index, 1);\r\n      this.layers.splice(index, 1);\r\n      (layer as any).watcher.unwatch();\r\n    }\r\n  }\r\n}\r\n","export enum MapViewAction {\r\n  Move,\r\n  Zoom\r\n}\r\n","import { EventsKey } from 'ol/events';\r\nimport OlMap from 'ol/Map';\r\nimport { unByKey } from 'ol/Observable';\r\n\r\n/**\r\n * Base map controller\r\n */\r\nexport class MapController {\r\n\r\n  /**\r\n   * OL Map\r\n   */\r\n  protected olMap: OlMap;\r\n\r\n  /**\r\n   * Array of observer keys\r\n   */\r\n  protected observerKeys: EventsKey[] = [];\r\n\r\n  /**\r\n   * Return the OL map this controller is bound to\r\n   * @returns OL Map\r\n   */\r\n  getOlMap(): OlMap {\r\n    return this.olMap;\r\n  }\r\n\r\n  /**\r\n   * Add or remove this controller to/from a map.\r\n   * @param map OL Map\r\n   */\r\n  setOlMap(olMap: OlMap | undefined) {\r\n    if (olMap !== undefined && this.getOlMap() !== undefined) {\r\n      throw new Error('This controller is already bound to a map.');\r\n    }\r\n\r\n    if (olMap === undefined) {\r\n      this.teardownObservers();\r\n      this.olMap = olMap;\r\n      return;\r\n    }\r\n\r\n    this.olMap = olMap;\r\n  }\r\n\r\n  /**\r\n   * Teardown any observers\r\n   */\r\n  teardownObservers() {\r\n    this.observerKeys.forEach((key: EventsKey) => unByKey(key));\r\n    this.observerKeys = [];\r\n  }\r\n\r\n}\r\n","import OlMap from 'ol/Map';\r\nimport OlMapEvent from 'ol/MapEvent';\r\n\r\nimport { BehaviorSubject, Subject, Subscription } from 'rxjs';\r\nimport { debounceTime } from 'rxjs/operators';\r\n\r\nimport * as oleasing from 'ol/easing';\r\nimport * as olproj from 'ol/proj';\r\nimport OlProjection from 'ol/proj/Projection';\r\nimport OlView from 'ol/View';\r\n\r\nimport { MapViewAction } from '../map.enums';\r\nimport { MapExtent, MapViewState } from '../map.interface';\r\nimport { getScaleFromResolution, viewStatesAreEqual } from '../map.utils';\r\nimport { MapController } from './controller';\r\nimport { EventsKey } from 'ol/events';\r\n\r\nexport interface MapViewControllerOptions {\r\n  stateHistory: boolean;\r\n}\r\n\r\n/**\r\n * Controller to handle map view interactions\r\n */\r\nexport class MapViewController extends MapController {\r\n  /**\r\n   * Observable of the current resolution\r\n   */\r\n  resolution$ = new BehaviorSubject<number>(undefined);\r\n\r\n  /**\r\n   * Observable of the current state\r\n   */\r\n  state$ = new BehaviorSubject<MapViewState>(undefined);\r\n\r\n  /**\r\n   * View Padding\r\n   * Values in the array are top, right, bottom and left padding.\r\n   */\r\n  padding = [0, 0, 0, 0];\r\n\r\n  /**\r\n   * Max zoom after set extent\r\n   */\r\n  maxZoomOnExtent = 19;\r\n\r\n  /**\r\n   * Max extent possible when zooming\r\n   */\r\n  maxLayerZoomExtent: MapExtent;\r\n\r\n  /**\r\n   * Extent stream\r\n   */\r\n  private extent$ = new Subject<{ extent: MapExtent; action: MapViewAction }>();\r\n\r\n  /**\r\n   * Subscription to the movement stream\r\n   */\r\n  private extent$$: Subscription;\r\n\r\n  /**\r\n   * History of states\r\n   */\r\n  private states: MapViewState[] = [];\r\n\r\n  /**\r\n   * Current state index\r\n   */\r\n  private stateIndex: number = 0;\r\n\r\n  /**\r\n   * Whether the view controller should keep the view's state history\r\n   */\r\n  get stateHistory(): boolean {\r\n    return this.options ? this.options.stateHistory === true : false;\r\n  }\r\n\r\n  /**\r\n   * OL View\r\n   */\r\n  get olView(): OlView {\r\n    return this.olMap.getView();\r\n  }\r\n\r\n  constructor(private options?: MapViewControllerOptions) {\r\n    super();\r\n  }\r\n\r\n  setPadding(padding: { top?: number, bottom?: number, left?: number, right?: number }) {\r\n    // Values in the array are top, right, bottom and left padding.\r\n    if (padding.top || padding.top === 0) {\r\n      this.padding[0] = padding.top;\r\n    }\r\n    if (padding.right || padding.right === 0) {\r\n      this.padding[1] = padding.right;\r\n    }\r\n    if (padding.bottom || padding.bottom === 0) {\r\n      this.padding[2] = padding.bottom;\r\n    }\r\n    if (padding.left || padding.left === 0) {\r\n      this.padding[3] = padding.left;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add or remove this controller to/from a map.\r\n   * @param map OL Map\r\n   */\r\n  setOlMap(olMap: OlMap | undefined) {\r\n    super.setOlMap(olMap);\r\n    this.setupObservers();\r\n  }\r\n\r\n  /**\r\n   * Observe move moveend and subscribe to the extent stream\r\n   */\r\n  setupObservers() {\r\n    if (this.stateHistory === true) {\r\n      this.observerKeys.push(\r\n        this.olMap.on('moveend', (event: OlMapEvent) => this.onMoveEnd(event)) as EventsKey\r\n      );\r\n    }\r\n\r\n    this.extent$$ = this.extent$\r\n      .pipe(debounceTime(25))\r\n      .subscribe((value: { extent: MapExtent; action: MapViewAction }) => {\r\n        this.setExtent(value.extent, value.action);\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Teardown any observers\r\n   */\r\n  teardownObservers() {\r\n    super.teardownObservers();\r\n    if (this.extent$$ !== undefined) {\r\n      this.extent$$.unsubscribe();\r\n      this.extent$$ = undefined;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get the view's OL projection\r\n   * @returns OL projection\r\n   */\r\n  getOlProjection(): OlProjection {\r\n    return this.olView.getProjection();\r\n  }\r\n\r\n  /**\r\n   * Get the current map view center\r\n   * @param projection Output projection\r\n   * @returns Center\r\n   */\r\n  getCenter(projection?: string | OlProjection): [number, number] {\r\n    let center = this.olView.getCenter() as [number, number];\r\n    if (projection && center) {\r\n      center = olproj.transform(center, this.getOlProjection(), projection) as [number, number];\r\n    }\r\n    return center;\r\n  }\r\n\r\n  /**\r\n   * Get the current view extent\r\n   * @param projection Output projection\r\n   * @returns Extent\r\n   */\r\n  getExtent(projection?: string | OlProjection): MapExtent {\r\n    let extent = this.olView.calculateExtent(this.olMap.getSize());\r\n    if (projection && extent) {\r\n      extent = olproj.transformExtent(\r\n        extent,\r\n        this.getOlProjection(),\r\n        projection\r\n      );\r\n    }\r\n    return extent as [number, number, number, number];\r\n  }\r\n\r\n  /**\r\n   * Get the current scale\r\n   * @param dpi Dot per inches\r\n   * @returns View scale\r\n   */\r\n  getScale(dpi = 96) {\r\n    return getScaleFromResolution(\r\n      this.getResolution(),\r\n      this.getOlProjection().getUnits(),\r\n      dpi\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Get the current resolution\r\n   * @returns Projection denominator\r\n   */\r\n  getResolution(): number {\r\n    return this.olView.getResolution();\r\n  }\r\n\r\n  /**\r\n   * Get the current zoom level\r\n   * @returns Zoom level\r\n   */\r\n  getZoom(): number {\r\n    return Math.round(this.olView.getZoom());\r\n  }\r\n\r\n  /**\r\n   * Zoom in\r\n   */\r\n  zoomIn() {\r\n    this.zoomTo(this.olView.getZoom() + 1);\r\n  }\r\n\r\n  /**\r\n   * Zoom out\r\n   */\r\n  zoomOut() {\r\n    this.zoomTo(this.olView.getZoom() - 1);\r\n  }\r\n\r\n  /**\r\n   * Zoom to specific zoom level\r\n   * @param zoom Zoom level\r\n   */\r\n  zoomTo(zoom: number) {\r\n    this.olView.cancelAnimations();\r\n    this.olView.animate({\r\n      zoom,\r\n      duration: 250,\r\n      easing: oleasing.easeOut\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Move to extent after a short delay (100ms) unless\r\n   * a new movement gets registered in the meantime.\r\n   * @param extent Extent to move to\r\n   */\r\n  moveToExtent(extent: [number, number, number, number]) {\r\n    this.extent$.next({ extent, action: MapViewAction.Move });\r\n  }\r\n\r\n  /**\r\n   * Zoom to extent after a short delay (100ms) unless\r\n   * a new movement gets registered in the meantime.\r\n   * @param extent Extent to zoom to\r\n   */\r\n  zoomToExtent(extent: [number, number, number, number]) {\r\n    this.extent$.next({ extent, action: MapViewAction.Zoom });\r\n  }\r\n\r\n  /**\r\n   * Return the current view rotation\r\n   * @returns Rotation angle in degrees\r\n   */\r\n  getRotation(): number {\r\n    return this.olView.getRotation();\r\n  }\r\n\r\n  /**\r\n   * Reset the view rotation to 0\r\n   */\r\n  resetRotation() {\r\n    this.olView.animate({ rotation: 0 });\r\n  }\r\n\r\n  /**\r\n   * Whether the view has a previous state\r\n   * @returns True if the view has a previous state\r\n   */\r\n  hasPreviousState(): boolean {\r\n    return this.states.length > 1 && this.stateIndex > 0;\r\n  }\r\n\r\n  /**\r\n   * Whether the view has a next state\r\n   * @returns True if the view has a next state\r\n   */\r\n  hasNextState(): boolean {\r\n    return this.states.length > 1 && this.stateIndex < this.states.length - 1;\r\n  }\r\n\r\n  /**\r\n   * Restore the previous view state\r\n   */\r\n  previousState() {\r\n    if (this.hasPreviousState()) {\r\n      this.setStateIndex(this.stateIndex - 1);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Restore the next view state\r\n   */\r\n  nextState() {\r\n    if (this.hasNextState()) {\r\n      this.setStateIndex(this.stateIndex + 1);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the state history\r\n   */\r\n  clearStateHistory() {\r\n    this.states = [];\r\n    this.stateIndex = 0;\r\n  }\r\n\r\n  /**\r\n   * Update the the view to it's intial state\r\n   */\r\n  setInitialState() {\r\n    if (this.states.length > 0) {\r\n      this.setStateIndex(0);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Move to the extent retrieved from the stream\r\n   * @param extent Extent\r\n   * @param action Either zoom or move\r\n   * @param animation With or without animation to the target extent.\r\n   */\r\n  private setExtent(\r\n    extent: MapExtent,\r\n    action: MapViewAction,\r\n    animation: boolean = true\r\n  ) {\r\n    const olView = this.olView;\r\n    olView.cancelAnimations();\r\n    const duration = animation ? 500 : 0;\r\n    const zoom = olView.getZoom();\r\n\r\n    const fromCenter = olView.getCenter();\r\n    const toCenter = [\r\n      extent[0] + (extent[2] - extent[0]) / 2,\r\n      extent[1] + (extent[3] - extent[1]) / 2\r\n    ];\r\n    const distCenter = Math.sqrt(\r\n      Math.pow(fromCenter[0] - toCenter[0], 2) +\r\n        Math.pow(fromCenter[1] - toCenter[1], 2)\r\n    );\r\n    const fromExtent = olView.calculateExtent();\r\n    const fromSize = Math.sqrt(\r\n      Math.pow(fromExtent[2] - fromExtent[0], 2) +\r\n        Math.pow(fromExtent[3] - fromExtent[1], 2)\r\n    );\r\n    const toSize = Math.sqrt(\r\n      Math.pow(extent[2] - extent[0], 2) + Math.pow(extent[3] - extent[1], 2)\r\n    );\r\n    const moySize = (toSize + fromSize) / 2;\r\n    const xSize = distCenter / moySize;\r\n\r\n    const maxZoom =\r\n      action === MapViewAction.Move || zoom > this.maxZoomOnExtent\r\n        ? zoom\r\n        : this.maxZoomOnExtent;\r\n\r\n    olView.fit(extent, {\r\n      size: this.olMap.getSize(),\r\n      maxZoom,\r\n      padding: this.padding,\r\n      duration: xSize > 4 ? 0 : duration,\r\n      callback: (isFinished: boolean) => {\r\n        if (!isFinished) {\r\n          olView.fit(extent, {\r\n            size: this.olMap.getSize(),\r\n            maxZoom,\r\n            padding: this.padding,\r\n            duration: xSize > 4 ? 0 : duration\r\n          });\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Set the view state index\r\n   * @param index State index\r\n   */\r\n  private setStateIndex(index: number) {\r\n    this.stateIndex = index;\r\n    this.setState(this.states[index]);\r\n  }\r\n\r\n  /**\r\n   * Set the view state\r\n   * @param state View state\r\n   */\r\n  private setState(state: MapViewState) {\r\n    this.olView.animate({\r\n      resolution: state.resolution,\r\n      center: state.center,\r\n      duration: 0\r\n    });\r\n  }\r\n\r\n  /**\r\n   * On move end, get the view state and record it.\r\n   * @param event Map event\r\n   */\r\n  private onMoveEnd(event: OlMapEvent) {\r\n    const resolution = this.getResolution();\r\n    if (this.resolution$.value !== resolution) {\r\n      this.resolution$.next(resolution);\r\n    }\r\n\r\n    const state = {\r\n      resolution,\r\n      center: this.getCenter(),\r\n      zoom: this.getZoom()\r\n    };\r\n\r\n    if (this.stateHistory === true) {\r\n      const stateIndex = this.stateIndex;\r\n      const stateAtIndex =\r\n        this.states.length === 0 ? undefined : this.states[stateIndex];\r\n      if (!viewStatesAreEqual(state, stateAtIndex)) {\r\n        this.states = this.states.slice(0, stateIndex + 1).concat([state]);\r\n        this.stateIndex = this.states.length - 1;\r\n      }\r\n    }\r\n\r\n    this.state$.next(state);\r\n  }\r\n}\r\n","import OlMap from 'ol/Map';\r\nimport olGeolocation from 'ol/Geolocation';\r\nimport { BehaviorSubject, interval, Subscription } from 'rxjs';\r\n\r\nimport * as olproj from 'ol/proj';\r\nimport olFeature from 'ol/Feature';\r\nimport { MapController } from './controller';\r\nimport { Point, Polygon } from 'ol/geom';\r\nimport { fromCircle } from 'ol/geom/Polygon';\r\nimport OlCircle from 'ol/geom/Circle';\r\nimport { IgoMap } from '../map';\r\nimport * as olstyle from 'ol/style';\r\nimport { Overlay } from '../../../overlay/shared/overlay';\r\nimport { FeatureMotion } from '../../../feature/shared/feature.enums';\r\nimport { StorageService } from '@igo2/core';\r\nimport { MapViewOptions } from '../map.interface';\r\nimport { switchMap } from 'rxjs/operators';\r\nexport interface MapGeolocationControllerOptions {\r\n  //  todo keepPositionHistory?: boolean;\r\n  projection: olproj.ProjectionLike\r\n  accuracyThreshold?: number;\r\n  followPosition?: boolean;\r\n  buffer?: GeolocationBuffer;\r\n}\r\nexport interface MapGeolocationState {\r\n  position: number[];\r\n  projection: string;\r\n  accuracy: number;\r\n  altitude: number;\r\n  altitudeAccuracy: number;\r\n  heading: number;\r\n  speed: number;\r\n  enableHighAccuracy: boolean;\r\n  timestamp: Date;\r\n}\r\nexport interface GeolocationBuffer {\r\n  bufferRadius?: number;\r\n  bufferStroke?: [number, number, number, number];\r\n  bufferFill?: [number, number, number, number];\r\n  showBufferRadius?: boolean;\r\n}\r\n\r\n\r\nenum GeolocationOverlayType {\r\n  Position = 'position',\r\n  Accuracy = 'accuracy',\r\n  Buffer= 'buffer'\r\n}\r\n\r\n/**\r\n * Controller to handle map view interactions\r\n */\r\nexport class MapGeolocationController extends MapController {\r\n\r\n  private subscriptions$$: Subscription[] = [];\r\n  private geolocationOverlay: Overlay;\r\n  private positionFeatureStyle: olstyle.Style | olstyle.Style[] = new olstyle.Style({\r\n    image: new olstyle.Circle({\r\n      radius: 6,\r\n      fill: new olstyle.Fill({\r\n        color: '#3399CC',\r\n      }),\r\n      stroke: new olstyle.Stroke({\r\n        color: '#fff',\r\n        width: 2,\r\n      }),\r\n    }),\r\n  })\r\n  private accuracyFeatureStyle: olstyle.Style | olstyle.Style[] = new olstyle.Style({\r\n    stroke: new olstyle.Stroke({\r\n      color: 'rgba(120, 120, 120, 0.4)',\r\n      width: 1,\r\n    }),\r\n    fill: new olstyle.Fill({\r\n      color: 'rgba(120, 120, 120, 0.4)',\r\n    }),\r\n  })\r\n\r\n  private geolocation: olGeolocation;\r\n\r\n  /**\r\n   * Observable of the current emission interval of the position. In seconds\r\n   */\r\n   public readonly emissionIntervalSeconds$: BehaviorSubject<number> = new BehaviorSubject(5);\r\n\r\n  /**\r\n   * Observable of the current position\r\n   */\r\n  public readonly position$ = new BehaviorSubject<MapGeolocationState>(undefined);\r\n  /**\r\n   * Observable of the tracking state\r\n   */\r\n  public readonly tracking$ = new BehaviorSubject<boolean>(undefined);\r\n  /**\r\n   * Observable of the follow position state\r\n   */\r\n  public readonly followPosition$ = new BehaviorSubject<boolean>(undefined);\r\n\r\n\r\n  /**\r\n   * History of positions\r\n   */\r\n  // private positions: MapGeolocationState[] = [];\r\n\r\n  /**\r\n   * Whether the geolocate controller should keep the position history\r\n   */\r\n  /*\r\n  // todo: refine this method\r\n  set keepPositionHistory(value) {\r\n    this._keepPositionHistory = value;\r\n  }\r\n  get keepPositionHistory(): boolean {\r\n    return this._keepPositionHistory;\r\n  }\r\n  private _keepPositionHistory: boolean = this.options && this.options.keepPositionHistory ? this.options.keepPositionHistory : true;\r\n*/\r\n  /**\r\n   * Whether the geolocate should show a buffer around the current position\r\n   */\r\n   set buffer(value: GeolocationBuffer) {\r\n    this._buffer = value;\r\n    this.handleFeatureCreation(this.position$.value);\r\n  }\r\n   get buffer(): GeolocationBuffer {\r\n    return this._buffer;\r\n  }\r\n  private _buffer: GeolocationBuffer = this.options && this.options.buffer ? this.options.buffer : undefined;\r\n\r\n  /**\r\n   * Whether the geolocate controller accuracy threshold to store/show the position.\r\n   */\r\n  set accuracyThreshold(value: number) {\r\n    this._accuracyThreshold = value;\r\n    this.handleFeatureCreation(this.position$.value);\r\n  }\r\n\r\n  get accuracyThreshold(): number {\r\n    return this._accuracyThreshold;\r\n  }\r\n  private _accuracyThreshold = this.options && this.options.accuracyThreshold ? this.options.accuracyThreshold : 5000;\r\n\r\n\r\n  /**\r\n   * Whether the activate the geolocation.\r\n   */\r\n  get tracking() {\r\n    return this.geolocation.getTracking();\r\n  }\r\n\r\n  set tracking(value: boolean) {\r\n    this.geolocation.setTracking(value || false);\r\n    this.tracking$.next(value);\r\n    if (this.storageService && value !== undefined) {\r\n      this.storageService.set('geolocation.tracking', value);\r\n    }\r\n    if (!value) {\r\n      this.position$.next(undefined);\r\n    }\r\n  }\r\n\r\n    /**\r\n   * Whether the activate the view tracking of the current position\r\n   */\r\n  set followPosition(value: boolean) {\r\n    this._followPosition = value;\r\n    this.handleFeatureCreation(this.position$.value);\r\n    this.followPosition$.next(value);\r\n    if (this.storageService && value !== undefined) {\r\n      this.storageService.set('geolocation.followPosition', value);\r\n    }\r\n  }\r\n\r\n  get followPosition() {\r\n    return this._followPosition;\r\n  }\r\n\r\n\r\n  private _followPosition = this.options && this.options.followPosition ? this.options.followPosition : false;\r\n\r\n\r\n  constructor(\r\n    private map: IgoMap,\r\n    private options?: MapGeolocationControllerOptions,\r\n    private storageService?: StorageService) {\r\n    super();\r\n    this.geolocationOverlay = new Overlay(this.map);\r\n  }\r\n\r\n  /**\r\n   * Add or remove this controller to/from a map.\r\n   * @param map OL Map\r\n   */\r\n  setOlMap(olMap: OlMap | undefined) {\r\n    super.setOlMap(olMap);\r\n    this.setupObservers();\r\n  }\r\n\r\n  private deleteGeolocationFeatures() {\r\n    this.deleteFeatureByType(GeolocationOverlayType.Position);\r\n    this.deleteFeatureByType(GeolocationOverlayType.Accuracy);\r\n    this.deleteFeatureByType(GeolocationOverlayType.Buffer);\r\n  }\r\n\r\n  setupObservers() {\r\n    this.tracking$.subscribe(tracking => {\r\n      if (tracking) {\r\n        this.onPositionChange(true, true);\r\n      } else {\r\n        this.deleteGeolocationFeatures();\r\n      }\r\n    });\r\n\r\n    this.geolocation = new olGeolocation({\r\n      // enableHighAccuracy must be set to true to have the heading value.\r\n      trackingOptions: {\r\n        enableHighAccuracy: true,\r\n        maximumAge: 10000,\r\n        timeout: 600000\r\n      },\r\n      projection: this.options.projection,\r\n    });\r\n\r\n    this.subscriptions$$.push(this.emissionIntervalSeconds$\r\n      .pipe(switchMap(value => interval(value * 1000)))\r\n      .subscribe(() => this.onPositionChange(true)));\r\n  }\r\n\r\n  public updateGeolocationOptions(options: MapViewOptions) {\r\n    if (!options) { return;}\r\n    // todo maybe a dedicated interface for geolocation should be defined instead of putting these inside the mapviewoptions?\r\n    let tracking = options.geolocate;\r\n    let followPosition = options.alwaysTracking;\r\n    if (this.storageService) {\r\n      const storedTracking = this.storageService.get('geolocation.tracking') as boolean;\r\n      if (storedTracking !== null && storedTracking !== undefined) {\r\n        tracking = storedTracking;\r\n      }\r\n\r\n      const storedFollowPosition = this.storageService.get('geolocation.followPosition') as boolean;\r\n      if (storedFollowPosition !== null && storedFollowPosition !== undefined) {\r\n        followPosition = storedFollowPosition;\r\n      }\r\n    }\r\n    this.tracking = tracking;\r\n    this.followPosition = followPosition;\r\n    this.buffer = options.buffer;\r\n  }\r\n\r\n  /**\r\n   * Teardown any observers\r\n   */\r\n  teardownObservers() {\r\n    if (this.subscriptions$$.length) {\r\n      this.subscriptions$$.map(s => s.unsubscribe());\r\n    }\r\n    super.teardownObservers();\r\n  }\r\n\r\n  /**\r\n   * Clear the position  history\r\n   */\r\n  /*\r\n  // todo\r\n  clearPositionsHistory() {\r\n    this.positions = [];\r\n  }*/\r\n\r\n  /**\r\n   * On position change, get the position, show it on the map and record it.\r\n   * @param emitEvent Map event\r\n   */\r\n  private onPositionChange(emitEvent: boolean = false, zoomTo: boolean = false) {\r\n    if (!this.tracking) {\r\n      return;\r\n    }\r\n    const geolocateProperties = this.geolocation.getProperties();\r\n\r\n    if (geolocateProperties.accuracy > this.accuracyThreshold) {\r\n      console.warn('Poor geolocation accuracy. No position are stored/shown');\r\n      this.position$.next(undefined);\r\n      return;\r\n    }\r\n\r\n    const position: MapGeolocationState = {\r\n      position: geolocateProperties.position,\r\n      projection: this.geolocation.getProjection().getCode(),\r\n      accuracy: geolocateProperties.accuracy,\r\n      altitude: geolocateProperties.altitude,\r\n      altitudeAccuracy: geolocateProperties.altitudeAccuracy,\r\n      heading: geolocateProperties.heading,\r\n      speed: geolocateProperties.speed,\r\n      enableHighAccuracy: geolocateProperties.trackingOptions?.enableHighAccuracy ? true : false,\r\n      timestamp: new Date()\r\n    };\r\n    this.handleFeatureCreation(position, zoomTo);\r\n    if (emitEvent) {\r\n      this.position$.next(position);\r\n      /*if (this.keepPositionHistory === true) {\r\n        // handle position diff to store only true diff;\r\n        this.positions.push(position);\r\n      }*/\r\n    }\r\n  }\r\n\r\n  private deleteFeatureByType(type: GeolocationOverlayType) {\r\n    const featureById = this.geolocationOverlay.dataSource.ol.getFeatureById(type);\r\n    if (featureById) {\r\n      this.geolocationOverlay.dataSource.ol.removeFeature(featureById);\r\n    }\r\n\r\n  }\r\n\r\n  private handleFeatureCreation(position: MapGeolocationState, zoomTo: boolean = false) {\r\n    if (!position || !position.position) {\r\n      return;\r\n    }\r\n    this.deleteGeolocationFeatures();\r\n    const positionGeometry = new Point(position.position);\r\n    const accuracyGeometry = fromCircle(new OlCircle(position.position, position.accuracy || 0));\r\n\r\n    const positionFeature = new olFeature<Point>({ geometry: positionGeometry });\r\n    const accuracyFeature = new olFeature<Polygon>({ geometry: accuracyGeometry });\r\n\r\n    if (positionGeometry) {\r\n      let motion = this.followPosition ? FeatureMotion.Move : FeatureMotion.None;\r\n      if (zoomTo) {\r\n        motion = FeatureMotion.Zoom;\r\n      }\r\n      positionFeature.setId(GeolocationOverlayType.Position);\r\n      positionFeature.setStyle(this.positionFeatureStyle);\r\n      this.geolocationOverlay.addOlFeature(positionFeature, motion);\r\n      if (accuracyGeometry) {\r\n        accuracyFeature.setId(GeolocationOverlayType.Accuracy);\r\n        accuracyFeature.setStyle(this.accuracyFeatureStyle);\r\n        this.geolocationOverlay.addOlFeature(accuracyFeature, motion);\r\n      }\r\n      if (this.buffer) {\r\n        const bufferFeature = new olFeature(new OlCircle(position.position, this.buffer.bufferRadius));\r\n        const bufferStyle = new olstyle.Style({\r\n          stroke: new olstyle.Stroke({ width: 2, color: this.buffer.bufferStroke }),\r\n          fill: new olstyle.Fill({ color: this.buffer.bufferFill }),\r\n          text: new olstyle.Text({\r\n            textAlign: 'left',\r\n            offsetX: 10,\r\n            offsetY: -10,\r\n            font: '12px Calibri,sans-serif',\r\n            text: this.buffer.showBufferRadius ? `${this.buffer.bufferRadius}m` : '',\r\n            fill: new olstyle.Fill({ color: '#000' }),\r\n            stroke: new olstyle.Stroke({ color: '#fff', width: 3 })\r\n          })\r\n        });\r\n        bufferFeature.setId(GeolocationOverlayType.Buffer);\r\n        bufferFeature.setStyle(bufferStyle);\r\n        this.geolocationOverlay.addOlFeature(bufferFeature, motion);\r\n      }\r\n\r\n    }\r\n\r\n  }\r\n}\r\n","import olMap from 'ol/Map';\r\nimport olView from 'ol/View';\r\nimport olControlAttribution from 'ol/control/Attribution';\r\nimport olControlScaleLine from 'ol/control/ScaleLine';\r\nimport * as olproj from 'ol/proj';\r\nimport * as olproj4 from 'ol/proj/proj4';\r\nimport OlProjection from 'ol/proj/Projection';\r\nimport * as olinteraction from 'ol/interaction';\r\n\r\nimport proj4 from 'proj4';\r\nimport { BehaviorSubject, Subject } from 'rxjs';\r\n\r\nimport { SubjectStatus } from '@igo2/utils';\r\n\r\nimport { Layer } from '../../layer/shared/layers';\r\nimport { Overlay } from '../../overlay/shared/overlay';\r\n\r\nimport { LayerWatcher } from '../utils/layer-watcher';\r\nimport {\r\n  MapViewOptions,\r\n  MapOptions,\r\n  MapAttributionOptions,\r\n  MapScaleLineOptions,\r\n  MapExtent,\r\n  MapControlsOptions\r\n} from './map.interface';\r\nimport { MapViewController } from './controllers/view';\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { MapGeolocationController } from './controllers/geolocation';\r\nimport { StorageService } from '@igo2/core';\r\n\r\n// TODO: This class is messy. Clearly define it's scope and the map browser's.\r\n// Move some stuff into controllers.\r\nexport class IgoMap {\r\n  public ol: olMap;\r\n  public offlineButtonToggle$ = new BehaviorSubject<boolean>(false);\r\n  public layers$ = new BehaviorSubject<Layer[]>([]);\r\n  public status$: Subject<SubjectStatus>;\r\n  public overlay: Overlay;\r\n  public queryResultsOverlay: Overlay;\r\n  public searchResultsOverlay: Overlay;\r\n  public viewController: MapViewController;\r\n  public geolocationController: MapGeolocationController;\r\n  public swipeEnabled$ = new BehaviorSubject<boolean>(false);\r\n  public mapCenter$ = new BehaviorSubject<boolean>(false);\r\n  public selectedFeatures$ = new BehaviorSubject<Layer[]>(null);\r\n\r\n  public bufferDataSource: FeatureDataSource;\r\n\r\n  private layerWatcher: LayerWatcher;\r\n\r\n  private options: MapOptions;\r\n  private mapViewOptions: MapViewOptions;\r\n  private defaultOptions: Partial<MapOptions> = {\r\n    controls: { attribution: false }\r\n  };\r\n\r\n  get layers(): Layer[] {\r\n    return this.layers$.value;\r\n  }\r\n\r\n  get projection(): string {\r\n    return this.viewController.getOlProjection().getCode();\r\n  }\r\n\r\n  constructor(\r\n    options?: MapOptions,\r\n    private storageService?: StorageService) {\r\n    this.options = Object.assign({}, this.defaultOptions, options);\r\n    this.layerWatcher = new LayerWatcher();\r\n    this.status$ = this.layerWatcher.status$;\r\n    olproj4.register(proj4);\r\n    this.init();\r\n  }\r\n\r\n  init() {\r\n    const controls = [];\r\n    if (this.options.controls) {\r\n      if (this.options.controls.attribution) {\r\n        const attributionOpt = (this.options.controls.attribution === true\r\n          ? {}\r\n          : this.options.controls.attribution) as MapAttributionOptions;\r\n        controls.push(new olControlAttribution(attributionOpt));\r\n      }\r\n      if (this.options.controls.scaleLine) {\r\n        const scaleLineOpt = (this.options.controls.scaleLine === true\r\n          ? {}\r\n          : this.options.controls.scaleLine) as MapScaleLineOptions;\r\n        controls.push(new olControlScaleLine(scaleLineOpt));\r\n      }\r\n    }\r\n    let interactions = {};\r\n    if (this.options.interactions === false) {\r\n      interactions = {\r\n        altShiftDragRotate: false,\r\n        doubleClickZoom: false,\r\n        keyboard: false,\r\n        mouseWheelZoom: false,\r\n        shiftDragZoom: false,\r\n        dragPan: false,\r\n        pinchRotate: false,\r\n        pinchZoom: false\r\n      };\r\n    }\r\n\r\n    this.ol = new olMap({\r\n      interactions: olinteraction.defaults(interactions),\r\n      controls\r\n    });\r\n\r\n    this.setView(this.options.view || {});\r\n    this.viewController = new MapViewController({\r\n      stateHistory: true\r\n    });\r\n    this.viewController.setOlMap(this.ol);\r\n    this.overlay = new Overlay(this);\r\n    this.queryResultsOverlay = new Overlay(this);\r\n    this.searchResultsOverlay = new Overlay(this);\r\n    this.ol.once('rendercomplete', () => {\r\n      this.geolocationController = new MapGeolocationController(\r\n        this,\r\n        {\r\n          projection: this.viewController.getOlProjection()\r\n        },\r\n        this.storageService);\r\n      this.geolocationController.setOlMap(this.ol);\r\n      if (this.geolocationController) {\r\n        this.geolocationController.updateGeolocationOptions(this.mapViewOptions);\r\n      }\r\n  });\r\n  }\r\n\r\n  setTarget(id: string) {\r\n    this.ol.setTarget(id);\r\n    if (id !== undefined) {\r\n      this.layerWatcher.subscribe(() => { }, null);\r\n    } else {\r\n      this.layerWatcher.unsubscribe();\r\n    }\r\n  }\r\n\r\n  updateView(options: MapViewOptions) {\r\n    const currentView = this.ol.getView();\r\n    const viewOptions = Object.assign(\r\n      {\r\n        zoom: currentView.getZoom()\r\n      },\r\n      currentView.getProperties()\r\n    );\r\n\r\n    this.setView(Object.assign(viewOptions, options));\r\n    if (options.maxZoomOnExtent) {\r\n      this.viewController.maxZoomOnExtent = options.maxZoomOnExtent;\r\n    }\r\n    this.mapViewOptions = options;\r\n  }\r\n\r\n  /**\r\n   * Set the map view\r\n   * @param options Map view options\r\n   */\r\n  setView(options: MapViewOptions) {\r\n    if (this.viewController !== undefined) {\r\n      this.viewController.clearStateHistory();\r\n    }\r\n\r\n    options = Object.assign({ constrainResolution: true }, options);\r\n    const view = new olView(options);\r\n    this.ol.setView(view);\r\n\r\n    if (options) {\r\n      if (options.maxLayerZoomExtent) {\r\n        this.viewController.maxLayerZoomExtent = options.maxLayerZoomExtent;\r\n      }\r\n\r\n      if (options.center) {\r\n        const projection = view.getProjection().getCode();\r\n        const center = olproj.fromLonLat(options.center, projection);\r\n        view.setCenter(center);\r\n      }\r\n    }\r\n  }\r\n\r\n  updateControls(value: MapControlsOptions) {\r\n    if (value === undefined) {\r\n      return;\r\n    }\r\n\r\n    const controls = [];\r\n    if (value.attribution) {\r\n      const attributionOpt = (value.attribution === true\r\n        ? {}\r\n        : value.attribution) as MapAttributionOptions;\r\n      controls.push(new olControlAttribution(attributionOpt));\r\n    }\r\n    if (value.scaleLine) {\r\n      const scaleLineOpt = (value.scaleLine === true\r\n        ? {}\r\n        : value.scaleLine) as MapScaleLineOptions;\r\n      controls.push(new olControlScaleLine(scaleLineOpt));\r\n    }\r\n\r\n    const currentControls = Object.assign([], this.ol.getControls().getArray());\r\n    currentControls.forEach(control => {\r\n      this.ol.removeControl(control);\r\n    });\r\n    controls.forEach(control => {\r\n      this.ol.addControl(control);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Deprecated\r\n   * TODO: Move to ViewController and update every place it's used\r\n   */\r\n  getCenter(projection?: string | OlProjection): [number, number] {\r\n    return this.viewController.getCenter(projection);\r\n  }\r\n\r\n  /**\r\n   * Deprecated\r\n   * TODO: Move to ViewController and update every place it's used\r\n   */\r\n  getExtent(projection?: string | OlProjection): MapExtent {\r\n    return this.viewController.getExtent(projection);\r\n  }\r\n\r\n  // TODO: Move to ViewController and update every place it's used\r\n  getZoom(): number {\r\n    return this.viewController.getZoom();\r\n  }\r\n\r\n  changeBaseLayer(baseLayer: Layer) {\r\n    if (!baseLayer) {\r\n      return;\r\n    }\r\n\r\n    for (const bl of this.getBaseLayers()) {\r\n      bl.visible = false;\r\n    }\r\n\r\n    baseLayer.visible = true;\r\n\r\n    this.viewController.olView.setMinZoom(\r\n      baseLayer.dataSource.options.minZoom || (this.options.view || {}).minZoom\r\n    );\r\n    this.viewController.olView.setMaxZoom(\r\n      baseLayer.dataSource.options.maxZoom || (this.options.view || {}).maxZoom\r\n    );\r\n  }\r\n\r\n  getBaseLayers(): Layer[] {\r\n    return this.layers.filter((layer: Layer) => layer.baseLayer === true);\r\n  }\r\n\r\n  getLayerById(id: string): Layer {\r\n    return this.layers.find((layer: Layer) => layer.id && layer.id === id);\r\n  }\r\n\r\n  getLayerByAlias(alias: string): Layer {\r\n    return this.layers.find(\r\n      (layer: Layer) => layer.alias && layer.alias === alias\r\n    );\r\n  }\r\n\r\n  getLayerByOlUId(olUId: string): Layer {\r\n    return this.layers.find(\r\n      (layer: Layer) => (layer.ol as any).ol_uid && (layer.ol as any).ol_uid === olUId\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Add a single layer\r\n   * @param layer Layer to add\r\n   * @param push DEPRECATED\r\n   */\r\n  addLayer(layer: Layer, push = true) {\r\n    this.addLayers([layer]);\r\n  }\r\n\r\n  /**\r\n   * Add many layers\r\n   * @param layers Layers to add\r\n   * @param push DEPRECATED\r\n   */\r\n  addLayers(layers: Layer[], push = true) {\r\n    let offsetZIndex = 0;\r\n    let offsetBaseLayerZIndex = 0;\r\n    const addedLayers = layers\r\n      .map((layer: Layer) => {\r\n        if (!layer) { return; }\r\n        const offset = layer.zIndex\r\n          ? 0\r\n          : layer.baseLayer\r\n            ? offsetBaseLayerZIndex++\r\n            : offsetZIndex++;\r\n        return this.doAddLayer(layer, offset);\r\n      })\r\n      .filter((layer: Layer | undefined) => layer !== undefined);\r\n    this.setLayers([].concat(this.layers, addedLayers));\r\n  }\r\n\r\n  /**\r\n   * Remove a single layer\r\n   * @param layer Layer to remove\r\n   */\r\n  removeLayer(layer: Layer) {\r\n    this.removeLayers([layer]);\r\n  }\r\n\r\n  /**\r\n   * Remove many layers\r\n   * @param layers Layers to remove\r\n   */\r\n  removeLayers(layers: Layer[]) {\r\n    const newLayers = this.layers$.value.slice(0);\r\n    const layersToRemove = [];\r\n    layers.forEach((layer: Layer) => {\r\n      const index = newLayers.indexOf(layer);\r\n      if (index >= 0) {\r\n        layersToRemove.push(layer);\r\n        newLayers.splice(index, 1);\r\n        this.handleLinkedLayersDeletion(layer, layersToRemove);\r\n        layersToRemove.map(linkedLayer => {\r\n          layersToRemove.push(linkedLayer);\r\n          const linkedIndex = newLayers.indexOf(linkedLayer);\r\n          if (linkedIndex >= 0) {\r\n            newLayers.splice(linkedIndex, 1);\r\n          }\r\n        });\r\n      }\r\n    });\r\n\r\n    layersToRemove.forEach((layer: Layer) => this.doRemoveLayer(layer));\r\n    this.setLayers(newLayers);\r\n  }\r\n\r\n  /**\r\n   * Build a list of linked layers to delete\r\n   * @param srcLayer Layer that has triggered the deletion\r\n   * @param layersToRemove list to append the layer to delete into\r\n   */\r\n  handleLinkedLayersDeletion(srcLayer: Layer, layersToRemove: Layer[]) {\r\n    const linkedLayers = srcLayer.options.linkedLayers;\r\n    if (!linkedLayers) {\r\n      return;\r\n    }\r\n    const currentLinkedId = linkedLayers.linkId;\r\n    const currentLinks = linkedLayers.links;\r\n    const isParentLayer = currentLinks ? true : false;\r\n    if (isParentLayer) {\r\n      // search for child layers\r\n      currentLinks.map(link => {\r\n        if (!link.syncedDelete) {\r\n          return;\r\n        }\r\n        link.linkedIds.map(linkedId => {\r\n          const layerToApply = this.layers.find(layer => layer.options.linkedLayers?.linkId === linkedId);\r\n          if (layerToApply) {\r\n            layersToRemove.push(layerToApply);\r\n          }\r\n        });\r\n      });\r\n    } else {\r\n      // search for parent layer\r\n      this.layers.map(layer => {\r\n        if (layer.options.linkedLayers?.links) {\r\n          layer.options.linkedLayers.links.map(l => {\r\n            if (\r\n              l.syncedDelete && l.bidirectionnal !== false &&\r\n              l.linkedIds.indexOf(currentLinkedId) !== -1) {\r\n              layersToRemove.push(layer);\r\n              this.handleLinkedLayersDeletion(layer, layersToRemove);\r\n            }\r\n          });\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove all layers\r\n   */\r\n  removeAllLayers() {\r\n    this.layers.forEach((layer: Layer) => this.doRemoveLayer(layer));\r\n    this.layers$.next([]);\r\n  }\r\n\r\n  raiseLayer(layer: Layer) {\r\n    const index = this.getLayerIndex(layer);\r\n    if (index > 1) {\r\n      this.moveLayer(layer, index, index - 1);\r\n    }\r\n  }\r\n\r\n  raiseLayers(layers: Layer[]) {\r\n    for (const layer of layers) {\r\n      this.raiseLayer(layer);\r\n    }\r\n  }\r\n\r\n  lowerLayer(layer: Layer) {\r\n    const index = this.getLayerIndex(layer);\r\n    if (index < this.layers.length - 1) {\r\n      this.moveLayer(layer, index, index + 1);\r\n    }\r\n  }\r\n\r\n  lowerLayers(layers: Layer[]) {\r\n    const reverseLayers = layers.reverse();\r\n    for (const layer of reverseLayers) {\r\n      this.lowerLayer(layer);\r\n    }\r\n  }\r\n\r\n  moveLayer(layer: Layer, from: number, to: number) {\r\n    const layerTo = this.layers[to];\r\n    const zIndexTo = layerTo.zIndex;\r\n    const zIndexFrom = layer.zIndex;\r\n\r\n    if (layerTo.baseLayer || layer.baseLayer) {\r\n      return;\r\n    }\r\n\r\n    layer.zIndex = zIndexTo;\r\n    layerTo.zIndex = zIndexFrom;\r\n\r\n    this.layers[to] = layer;\r\n    this.layers[from] = layerTo;\r\n    this.layers$.next(this.layers.slice(0));\r\n  }\r\n\r\n  /**\r\n   * Add a layer to the OL map and start watching. If the layer is already\r\n   * added to this map, make it visible but don't add it one again.\r\n   * @param layer Layer\r\n   * @returns The layer added, if any\r\n   */\r\n  private doAddLayer(layer: Layer, offsetZIndex: number) {\r\n    if (layer.baseLayer && layer.visible) {\r\n      this.changeBaseLayer(layer);\r\n    }\r\n\r\n    const existingLayer = this.getLayerById(layer.id);\r\n    if (existingLayer !== undefined) {\r\n      existingLayer.visible = true;\r\n      return;\r\n    }\r\n\r\n    if (!layer.baseLayer && layer.zIndex) {\r\n      layer.zIndex += 10;\r\n    }\r\n\r\n    if (layer.zIndex === undefined || layer.zIndex === 0) {\r\n      const maxZIndex = Math.max(\r\n        layer.baseLayer ? 0 : 10,\r\n        ...this.layers\r\n          .filter(\r\n            (l) => l.baseLayer === layer.baseLayer && l.zIndex < 200 // zIndex > 200 = system layer\r\n          )\r\n          .map((l) => l.zIndex)\r\n      );\r\n      layer.zIndex = maxZIndex + 1 + offsetZIndex;\r\n    }\r\n\r\n    if (layer.baseLayer && layer.zIndex > 9) {\r\n      layer.zIndex = 10; // baselayer must have zIndex < 10\r\n    }\r\n\r\n    layer.setMap(this);\r\n    this.layerWatcher.watchLayer(layer);\r\n    this.ol.addLayer(layer.ol);\r\n\r\n    return layer;\r\n  }\r\n\r\n  /**\r\n   * Remove a layer from the OL map and stop watching\r\n   * @param layer Layer\r\n   */\r\n  private doRemoveLayer(layer: Layer) {\r\n    this.layerWatcher.unwatchLayer(layer);\r\n    this.ol.removeLayer(layer.ol);\r\n    layer.setMap(undefined);\r\n  }\r\n\r\n  /**\r\n   * Update the layers observable\r\n   * @param layers Layers\r\n   */\r\n  private setLayers(layers: Layer[]) {\r\n    this.layers$.next(this.sortLayersByZIndex(layers).slice(0));\r\n  }\r\n\r\n  /**\r\n   * Sort layers by descending zIndex\r\n   * @param layers Array of layers\r\n   * @returns The original array, sorted by zIndex\r\n   */\r\n  private sortLayersByZIndex(layers: Layer[]) {\r\n    // Sort by descending zIndex\r\n    return layers.sort(\r\n      (layer1: Layer, layer2: Layer) => layer2.zIndex - layer1.zIndex\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Get layer index in the map's inenr array of layers\r\n   * @param layer Layer\r\n   * @returns The layer index\r\n   */\r\n  private getLayerIndex(layer: Layer) {\r\n    return this.layers.findIndex((_layer: Layer) => _layer === layer);\r\n  }\r\n\r\n  onOfflineToggle(offline: boolean) {\r\n    this.offlineButtonToggle$.next(offline);\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  AfterViewInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\nimport { Subscription } from 'rxjs';\r\n\r\nimport { SubjectStatus } from '@igo2/utils';\r\nimport { ActivityService } from '@igo2/core';\r\n\r\nimport { IgoMap } from '../shared/map';\r\nimport { MapControlsOptions, MapViewOptions } from '../shared/map.interface';\r\n\r\n@Component({\r\n  selector: 'igo-map-browser',\r\n  templateUrl: './map-browser.component.html',\r\n  styleUrls: ['./map-browser.component.scss']\r\n})\r\nexport class MapBrowserComponent implements OnInit, AfterViewInit, OnDestroy {\r\n  private activityId: string;\r\n  private status$$: Subscription;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input()\r\n  get view(): MapViewOptions {\r\n    return this._view;\r\n  }\r\n  set view(value: MapViewOptions) {\r\n    this._view = value;\r\n    if (this.map !== undefined) {\r\n      this.map.updateView(value);\r\n    }\r\n  }\r\n  private _view: MapViewOptions;\r\n\r\n  get controls(): MapControlsOptions {\r\n    return this._controls;\r\n  }\r\n\r\n  set controls(value: MapControlsOptions) {\r\n    this._controls = value;\r\n    if (this.map !== undefined) {\r\n      this.map.updateControls(value);\r\n    }\r\n  }\r\n  private _controls: MapControlsOptions;\r\n\r\n  public id = `igo-map-target-${new Date().getTime()}`;\r\n\r\n  constructor(private activityService: ActivityService) {}\r\n\r\n  ngOnInit() {\r\n    this.status$$ = this.map.status$.subscribe(status =>\r\n      this.handleStatusChange(status)\r\n    );\r\n  }\r\n\r\n  ngAfterViewInit() {\r\n    this.map.setTarget(this.id);\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.map.setTarget(undefined);\r\n    this.activityService.unregister(this.activityId);\r\n    this.status$$.unsubscribe();\r\n  }\r\n\r\n  private handleStatusChange(status: SubjectStatus) {\r\n    if (status === SubjectStatus.Working && this.activityId === undefined) {\r\n      this.activityId = this.activityService.register();\r\n    } else if (status === SubjectStatus.Done && this.activityId !== undefined) {\r\n      this.activityService.unregister(this.activityId);\r\n      this.activityId = undefined;\r\n    }\r\n  }\r\n}\r\n","<div [id]=\"id\" class=\"igo-map-browser-target\"></div>\r\n<ng-content></ng-content>\r\n","import {\r\n  Directive,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  OnDestroy,\r\n  Self,\r\n  OnInit\r\n} from '@angular/core';\r\n\r\nimport MapBrowserPointerEvent from 'ol/MapBrowserEvent';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { MapBrowserComponent } from '../../map/map-browser/map-browser.component';\r\n\r\nimport { transform } from 'ol/proj';\r\nimport { MediaService } from '@igo2/core';\r\nimport { unByKey } from 'ol/Observable';\r\n/**\r\n * This directive return the pointer coordinate (on click or pointermove)\r\n * in [longitude, latitude], delayed by in input (pointerMoveDelay)\r\n * to avoid too many emitted values.\r\n */\r\n@Directive({\r\n  selector: '[igoPointerPosition]'\r\n})\r\nexport class PointerPositionDirective implements OnInit, OnDestroy {\r\n\r\n  private lastTimeoutRequest;\r\n\r\n  /**\r\n   * Listener to the pointer move event\r\n   */\r\n  private pointerMoveListener;\r\n\r\n  /**\r\n   * Listener to the map click event\r\n   */\r\n  private mapClickListener;\r\n\r\n  /**\r\n   * Delay before emitting an event\r\n   */\r\n  @Input() pointerPositionDelay: number = 1000;\r\n\r\n  /**\r\n   * Event emitted when the pointer move, delayed by pointerMoveDelay\r\n   */\r\n  @Output() pointerPositionCoord = new EventEmitter<[number, number]>();\r\n\r\n  /**\r\n   * IGO map\r\n   * @internal\r\n   */\r\n  get map(): IgoMap {\r\n    return this.component.map;\r\n  }\r\n\r\n  get mapProjection(): string {\r\n    return (this.component.map as IgoMap).projection;\r\n  }\r\n\r\n  constructor(\r\n    @Self() private component: MapBrowserComponent,\r\n    private mediaService: MediaService\r\n  ) { }\r\n\r\n  /**\r\n   * Start listening to pointermove\r\n   * @internal\r\n   */\r\n  ngOnInit(): void {\r\n    this.listenToMapPointerMove();\r\n    this.listenToMapClick();\r\n  }\r\n\r\n  /**\r\n   * Stop listening to pointermove\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.unlistenToMapPointerMove();\r\n    this.unlistenToMapClick();\r\n  }\r\n\r\n  /**\r\n   * On map pointermove\r\n   */\r\n  private listenToMapPointerMove() {\r\n    this.pointerMoveListener = this.map.ol.on(\r\n      'pointermove',\r\n      (event: MapBrowserPointerEvent<any>) => this.onPointerEvent(event, this.pointerPositionDelay)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * On map click\r\n   */\r\n  private listenToMapClick() {\r\n    this.mapClickListener = this.map.ol.on(\r\n      'singleclick',\r\n      (event: MapBrowserPointerEvent<any>) => this.onPointerEvent(event, 0)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Stop listening for map pointermove\r\n   */\r\n  private unlistenToMapPointerMove() {\r\n    unByKey(this.pointerMoveListener);\r\n    this.pointerMoveListener = undefined;\r\n  }\r\n\r\n  /**\r\n   * Stop listening for map clicks\r\n   */\r\n  private unlistenToMapClick() {\r\n    this.mapClickListener = undefined;\r\n  }\r\n\r\n  /**\r\n   * emit delayed coordinate (longitude, latitude array) based on pointerMoveDelay or on click\r\n   * @param event OL map browser pointer event\r\n   */\r\n  private onPointerEvent(event: MapBrowserPointerEvent<any>, delay: number) {\r\n    if (event.dragging || this.mediaService.isTouchScreen()) {return; }\r\n    if (typeof this.lastTimeoutRequest !== 'undefined') { // cancel timeout when the mouse moves\r\n      clearTimeout(this.lastTimeoutRequest);\r\n    }\r\n\r\n    const lonlat = transform(event.coordinate, this.mapProjection, 'EPSG:4326') as [number, number];\r\n    this.lastTimeoutRequest = setTimeout(() => {\r\n      this.pointerPositionCoord.emit(lonlat);\r\n    }, delay);\r\n  }\r\n}\r\n","import olLayerImage from 'ol/layer/Image';\r\nimport olSourceImage from 'ol/source/Image';\r\n\r\nimport { AuthInterceptor } from '@igo2/auth';\r\n\r\nimport { ImageWatcher } from '../../utils';\r\nimport { IgoMap } from '../../../map';\r\n\r\nimport { WMSDataSource } from '../../../datasource/shared/datasources/wms-datasource';\r\n\r\nimport { Layer } from './layer';\r\nimport { ImageLayerOptions } from './image-layer.interface';\r\nimport { ImageArcGISRestDataSource } from '../../../datasource/shared/datasources/imagearcgisrest-datasource';\r\nimport { LanguageService, MessageService } from '@igo2/core';\r\n\r\nexport class ImageLayer extends Layer {\r\n  public dataSource: WMSDataSource | ImageArcGISRestDataSource;\r\n  public options: ImageLayerOptions;\r\n  public ol: olLayerImage<olSourceImage>;\r\n\r\n  private watcher: ImageWatcher;\r\n\r\n  constructor(\r\n    options: ImageLayerOptions,\r\n    public messageService: MessageService,\r\n    private languageService: LanguageService,\r\n    public authInterceptor?: AuthInterceptor\r\n  ) {\r\n    super(options, messageService, authInterceptor);\r\n    this.watcher = new ImageWatcher(this, this.messageService, this.languageService);\r\n    this.status$ = this.watcher.status$;\r\n    this.status$.subscribe(valStatus => {\r\n      if (valStatus === 0) {\r\n        this.olLoadingProblem = true;\r\n      }\r\n    });\r\n  }\r\n\r\n  protected createOlLayer(): olLayerImage<olSourceImage> {\r\n    const olOptions = Object.assign({}, this.options, {\r\n      source: this.options.source.ol as olSourceImage\r\n    });\r\n\r\n    const image = new olLayerImage(olOptions);\r\n    if (this.authInterceptor) {\r\n      (image.getSource() as any).setImageLoadFunction((tile, src) => {\r\n        this.customLoader(tile, src, this.authInterceptor, this.messageService, this.languageService);\r\n      });\r\n    }\r\n\r\n    return image;\r\n  }\r\n\r\n  public setMap(map: IgoMap | undefined) {\r\n    if (map === undefined) {\r\n      this.watcher.unsubscribe();\r\n    } else {\r\n      this.watcher.subscribe(() => {});\r\n    }\r\n    super.setMap(map);\r\n  }\r\n\r\n  private customLoader(tile, src: string, interceptor: AuthInterceptor, messageService: MessageService, languageService: LanguageService) {\r\n    const xhr = new XMLHttpRequest();\r\n\r\n    const alteredUrlWithKeyAuth = interceptor.alterUrlWithKeyAuth(src);\r\n    let url = src;\r\n    if (alteredUrlWithKeyAuth) {\r\n      url = alteredUrlWithKeyAuth;\r\n    }\r\n    xhr.open('GET', url);\r\n    const intercepted = interceptor.interceptXhr(xhr, url);\r\n    if (!intercepted) {\r\n      xhr.abort();\r\n      tile.getImage().src = url;\r\n      return;\r\n    }\r\n\r\n    xhr.responseType = 'arraybuffer';\r\n\r\n    xhr.onload = function() {\r\n      const arrayBufferView = new Uint8Array((this as any).response);\r\n      const responseString = new TextDecoder().decode(arrayBufferView);\r\n      if (responseString.includes('ServiceExceptionReport')) {\r\n        messageService.error(languageService.translate.instant(\r\n          'igo.geo.dataSource.optionsApiUnavailable'\r\n        ),\r\n        languageService.translate.instant(\r\n          'igo.geo.dataSource.unavailableTitle'\r\n        ));\r\n      }\r\n      const blob = new Blob([arrayBufferView], { type: 'image/png' });\r\n      const urlCreator = window.URL;\r\n      const imageUrl = urlCreator.createObjectURL(blob);\r\n      tile.getImage().src = imageUrl;\r\n    };\r\n    xhr.send();\r\n  }\r\n}\r\n","import olLayerTile from 'ol/layer/Tile';\r\nimport olSourceTile from 'ol/source/Tile';\r\nimport Tile from 'ol/Tile';\r\n\r\nimport { TileWatcher } from '../../utils';\r\nimport { IgoMap } from '../../../map';\r\n\r\nimport { OSMDataSource } from '../../../datasource/shared/datasources/osm-datasource';\r\nimport { WMTSDataSource } from '../../../datasource/shared/datasources/wmts-datasource';\r\nimport { XYZDataSource } from '../../../datasource/shared/datasources/xyz-datasource';\r\nimport { CartoDataSource } from '../../../datasource/shared/datasources/carto-datasource';\r\nimport { TileArcGISRestDataSource } from '../../../datasource/shared/datasources/tilearcgisrest-datasource';\r\nimport { TileDebugDataSource } from '../../../datasource/shared/datasources/tiledebug-datasource';\r\n\r\nimport { Layer } from './layer';\r\nimport { TileLayerOptions } from './tile-layer.interface';\r\n\r\nimport { MessageService } from '@igo2/core';\r\nimport { AuthInterceptor } from '@igo2/auth';\r\nexport class TileLayer extends Layer {\r\n  public dataSource:\r\n    | OSMDataSource\r\n    | WMTSDataSource\r\n    | XYZDataSource\r\n    | TileDebugDataSource\r\n    | CartoDataSource\r\n    | TileArcGISRestDataSource;\r\n  public options: TileLayerOptions;\r\n  public ol: olLayerTile<olSourceTile>;\r\n\r\n  private watcher: TileWatcher;\r\n\r\n  constructor(\r\n    options: TileLayerOptions,\r\n    public messageService?: MessageService,\r\n    public authInterceptor?: AuthInterceptor) {\r\n    super(options, messageService);\r\n\r\n    this.watcher = new TileWatcher(this);\r\n    this.status$ = this.watcher.status$;\r\n  }\r\n\r\n  protected createOlLayer(): olLayerTile<olSourceTile> {\r\n    const olOptions = Object.assign({}, this.options, {\r\n      source: this.options.source.ol\r\n    });\r\n    const tileLayer = new olLayerTile(olOptions);\r\n    const tileSource = tileLayer.getSource();\r\n    tileSource.setTileLoadFunction((tile: Tile, url: string) => {\r\n      this.customLoader(tile, url, this.authInterceptor);\r\n    });\r\n\r\n    return tileLayer;\r\n  }\r\n\r\n  /**\r\n   * Custom loader for tile layer.\r\n   * @internal\r\n   * @param tile the current tile\r\n   * @param url the url string or function to retrieve the data\r\n   */\r\n  customLoader(tile, url: string, interceptor: AuthInterceptor ) {\r\n\r\n    const alteredUrlWithKeyAuth = interceptor.alterUrlWithKeyAuth(url);\r\n    let modifiedUrl = url;\r\n    if (alteredUrlWithKeyAuth) {\r\n      modifiedUrl = alteredUrlWithKeyAuth;\r\n    }\r\n    tile.getImage().src = modifiedUrl;\r\n  }\r\n\r\n  public setMap(map: IgoMap | undefined) {\r\n    if (map === undefined) {\r\n      this.watcher.unsubscribe();\r\n    } else {\r\n      this.watcher.subscribe(() => {});\r\n    }\r\n    super.setMap(map);\r\n  }\r\n}\r\n","import olLayerVectorTile from 'ol/layer/VectorTile';\r\nimport olSourceVectorTile from 'ol/source/VectorTile';\r\n\r\nimport { MVTDataSource } from '../../../datasource/shared/datasources/mvt-datasource';\r\n\r\nimport { Layer } from './layer';\r\nimport { VectorTileLayerOptions } from './vectortile-layer.interface';\r\nimport { TileWatcher } from '../../utils';\r\nimport { AuthInterceptor } from '@igo2/auth';\r\nimport { IgoMap } from '../../../map';\r\nimport { MessageService } from '@igo2/core';\r\nimport VectorTile from 'ol/VectorTile';\r\n\r\nexport class VectorTileLayer extends Layer {\r\n  public dataSource: MVTDataSource;\r\n  public options: VectorTileLayerOptions;\r\n  public ol: olLayerVectorTile;\r\n\r\n  private watcher: TileWatcher;\r\n\r\n  constructor(\r\n    options: VectorTileLayerOptions,\r\n    public messageService?: MessageService,\r\n    public authInterceptor?: AuthInterceptor) {\r\n    super(options, messageService, authInterceptor);\r\n    this.watcher = new TileWatcher(this);\r\n    this.status$ = this.watcher.status$;\r\n  }\r\n\r\n  protected createOlLayer(): olLayerVectorTile {\r\n    const olOptions = Object.assign({}, this.options, {\r\n      source: this.options.source.ol as olSourceVectorTile\r\n    });\r\n\r\n    const vectorTile = new olLayerVectorTile(olOptions);\r\n    const vectorTileSource = vectorTile.getSource() as olSourceVectorTile;\r\n\r\n    vectorTileSource.setTileLoadFunction((tile: VectorTile, url: string) => {\r\n      const loader = this.customLoader(url, tile.getFormat(), this.authInterceptor, tile.onLoad.bind(tile));\r\n      if (loader) {\r\n        tile.setLoader(loader);\r\n      }\r\n    }\r\n    );\r\n\r\n    return vectorTile;\r\n  }\r\n\r\n  /**\r\n   * Custom loader for vector tile layer. Modified from the loadFeaturesXhr function in ol\\featureloader.js\r\n   * @internal\r\n   * @param url the url string or function to retrieve the data\r\n   * @param format the format of the tile\r\n   * @param interceptor the interceptor of the data\r\n   * @param success On success event action to trigger\r\n   * @param failure On failure event action to trigger TODO\r\n   */\r\n  customLoader(url, format, interceptor, success, failure?) {\r\n    return ((extent, resolution, projection) => {\r\n      const xhr = new XMLHttpRequest();\r\n      let modifiedUrl = url;\r\n      if (typeof url !== 'function') {\r\n        const alteredUrlWithKeyAuth = interceptor.alterUrlWithKeyAuth(url);\r\n        if (alteredUrlWithKeyAuth) {\r\n          modifiedUrl = alteredUrlWithKeyAuth;\r\n        }\r\n      } else {\r\n        modifiedUrl = url(extent, resolution, projection);\r\n      }\r\n      xhr.open( 'GET', modifiedUrl);\r\n      if (interceptor) {\r\n        interceptor.interceptXhr(xhr, modifiedUrl);\r\n      }\r\n\r\n      if (format.getType() === 'arraybuffer') {\r\n        xhr.responseType = 'arraybuffer';\r\n      }\r\n      xhr.onload = (event) => {\r\n        if (!xhr.status || xhr.status >= 200 && xhr.status < 300) {\r\n          const type = format.getType();\r\n          let source;\r\n          if (type === 'json' || type === 'text') {\r\n            source = xhr.responseText;\r\n          }\r\n          else if (type === 'xml') {\r\n            source = xhr.responseXML;\r\n            if (!source) {\r\n              source = new DOMParser().parseFromString(xhr.responseText, 'application/xml');\r\n            }\r\n          }\r\n          else if (type === 'arraybuffer') {\r\n            source = xhr.response;\r\n          }\r\n          if (source) {\r\n            success.call(this, format.readFeatures(source, {\r\n              extent,\r\n              featureProjection: projection\r\n            }), format.readProjection(source));\r\n          }\r\n          else {\r\n            // TODO\r\n            failure.call(this);\r\n          }\r\n        } else {\r\n          // TODO\r\n          failure.call(this);\r\n        }\r\n      };\r\n      xhr.onerror = () => {\r\n        // TODO\r\n        failure.call(this);\r\n      };\r\n      xhr.send();\r\n    });\r\n  }\r\n\r\n  public setMap(map: IgoMap | undefined) {\r\n    if (map === undefined) {\r\n      this.watcher.unsubscribe();\r\n    } else {\r\n      this.watcher.subscribe(() => {});\r\n    }\r\n    super.setMap(map);\r\n  }\r\n}\r\n","import {\r\n  Directive,\r\n  Input,\r\n  OnDestroy,\r\n  Self,\r\n  OnInit,\r\n  HostListener\r\n} from '@angular/core'\r\n  ;\r\nimport olLayerVectorTile from 'ol/layer/VectorTile';\r\nimport olLayerVector from 'ol/layer/Vector';\r\n\r\nimport { Subscription } from 'rxjs';\r\nimport olVectorTileSource from 'ol/source/VectorTile';\r\n\r\nimport type { default as OlMapBrowserEvent } from 'ol/MapBrowserEvent';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { MapBrowserComponent } from '../../map/map-browser/map-browser.component';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\n\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport OlFeature from 'ol/Feature';\r\nimport * as OlStyle from 'ol/style';\r\nimport * as OlGeom from 'ol/geom';\r\n\r\nimport { EntityStore } from '@igo2/common';\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { VectorLayer, Layer, VectorTileLayer } from '../../layer/shared/layers';\r\nimport { take } from 'rxjs/operators';\r\nimport { tryBindStoreLayer } from '../../feature/shared/feature.utils';\r\nimport { FeatureStore } from '../../feature/shared/store';\r\nimport { FeatureMotion } from '../../feature/shared/feature.enums';\r\nimport { MediaService } from '@igo2/core';\r\nimport { StyleService } from '../../layer/shared/style.service';\r\nimport { unByKey } from 'ol/Observable';\r\nimport RenderFeature from 'ol/render/Feature';\r\nimport { StyleByAttribute } from '../../layer/shared/vector-style.interface';\r\n\r\n/**\r\n * This directive makes the mouse coordinate trigger a reverse search on available search sources.\r\n * The search results are placed into a label, on a cross icon, representing the mouse coordinate.\r\n * By default, no search sources. Config in config file must be defined.\r\n * the layer level.\r\n */\r\n@Directive({\r\n  selector: '[igoHoverFeature]'\r\n})\r\nexport class HoverFeatureDirective implements OnInit, OnDestroy {\r\n\r\n  public store: FeatureStore<Feature>;\r\n  private pointerHoverFeatureStore: EntityStore<OlFeature<OlGeometry>> = new EntityStore<OlFeature<OlGeometry>>([]);\r\n  private lastTimeoutRequest;\r\n  private store$$: Subscription;\r\n  private layers$$: Subscription;\r\n\r\n  private selectionLayer: olLayerVectorTile;\r\n  private selectionMVT = {};\r\n  private mvtStyleOptions: StyleByAttribute;\r\n\r\n  /**\r\n   * Listener to the pointer move event\r\n   */\r\n  private pointerMoveListener;\r\n\r\n  private singleClickMapListener;\r\n\r\n  private hoverFeatureId: string = 'hoverFeatureId';\r\n  /**\r\n   * The delay where the mouse must be motionless before trigger the reverse search\r\n   */\r\n  @Input() igoHoverFeatureDelay: number = 1000;\r\n\r\n  /**\r\n   * If the user has enabled or not the directive\r\n   */\r\n  @Input() igoHoverFeatureEnabled: boolean = false;\r\n\r\n  @HostListener('mouseout')\r\n  mouseout() {\r\n    clearTimeout(this.lastTimeoutRequest);\r\n    this.clearLayer();\r\n  }\r\n\r\n  /**\r\n   * IGO map\r\n   * @internal\r\n   */\r\n  get map(): IgoMap {\r\n    return this.component.map;\r\n  }\r\n\r\n  get mapProjection(): string {\r\n    return (this.component.map as IgoMap).projection;\r\n  }\r\n\r\n  constructor(\r\n    @Self() private component: MapBrowserComponent,\r\n    private mediaService: MediaService,\r\n    private styleService: StyleService,\r\n  ) { }\r\n\r\n  /**\r\n   * Start listening to pointermove and reverse search results.\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.listenToMapPointerMove();\r\n    this.subscribeToPointerStore();\r\n    this.listenToMapClick();\r\n\r\n    this.map.status$.pipe(take(1)).subscribe(() => {\r\n      this.store = new FeatureStore<Feature>([], { map: this.map });\r\n      this.initStore();\r\n    });\r\n\r\n    // To handle context change without using the contextService.\r\n    this.layers$$ = this.map.layers$.subscribe((layers: Layer[]) => {\r\n      if (this.store && !layers.find(l => l.id === 'hoverFeatureId')) {\r\n        this.initStore();\r\n      }\r\n    });\r\n\r\n  }\r\n\r\n  /**\r\n   * Initialize the pointer position store\r\n   * @internal\r\n   */\r\n  private initStore() {\r\n    const store = this.store;\r\n\r\n    const layer = new VectorLayer({\r\n      isIgoInternalLayer: true,\r\n      id: 'hoverFeatureId',\r\n      title: 'hoverFeature',\r\n      zIndex: 900,\r\n      source: new FeatureDataSource(),\r\n      showInLayerList: false,\r\n      exportable: false,\r\n      browsable: false,\r\n      style: hoverFeatureMarker\r\n    });\r\n    tryBindStoreLayer(store, layer);\r\n\r\n    this.selectionLayer = new olLayerVectorTile({\r\n      map: this.map.ol,\r\n      zIndex: 901,\r\n      renderMode: \"vector\",\r\n      declutter: true,\r\n      source: new olVectorTileSource({}),\r\n      style: (feature, resolution) => {\r\n        if (this.mvtStyleOptions && feature.getId() in this.selectionMVT) {\r\n          return this.createHoverStyle(feature, this.mvtStyleOptions, resolution);\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  createHoverStyle(feature: RenderFeature | OlFeature<OlGeometry>, hoverStyle: StyleByAttribute, resolution: number) {\r\n    const localHoverStyle = { ...hoverStyle };\r\n    let label = hoverStyle.label ? hoverStyle.label.attribute : undefined;\r\n    let hasLabelStyle = hoverStyle.label?.style ? true : false;\r\n\r\n    if (!feature.get('_isLabel')) {\r\n      localHoverStyle.label = undefined;\r\n      hasLabelStyle = false;\r\n      label = undefined;\r\n    } else {\r\n      // clear the style for label....\r\n      const size = localHoverStyle.data ? localHoverStyle.data.length : 0;\r\n      const radius = [];\r\n      const stroke = [];\r\n      const width = [];\r\n      const fill = [];\r\n      for (let i = 0; i < size; i++) {\r\n        radius.push(0);\r\n        stroke.push('rgba(255, 255, 255, 0)');\r\n        width.push(0);\r\n        fill.push('rgba(255, 255, 255, 0)');\r\n      }\r\n      localHoverStyle.radius = radius;\r\n      localHoverStyle.stroke = stroke;\r\n      localHoverStyle.width = width;\r\n      localHoverStyle.fill = fill;\r\n    }\r\n    if (!hasLabelStyle && label) {\r\n      localHoverStyle.label.style =\r\n      {\r\n        textAlign: 'left',\r\n        textBaseline: 'top',\r\n        font: '12px Calibri,sans-serif',\r\n        fill: { color: '#000' },\r\n        backgroundFill: { color: 'rgba(255, 255, 255, 0.5)' },\r\n        backgroundStroke: { color: 'rgba(200, 200, 200, 0.75)', width: 2 },\r\n        stroke: { color: '#fff', width: 3 },\r\n        overflow: true,\r\n        offsetX: 10,\r\n        offsetY: 20,\r\n        padding: [2.5, 2.5, 2.5, 2.5]\r\n      };\r\n    }\r\n    return this.styleService.createStyleByAttribute(feature, localHoverStyle, resolution);\r\n  }\r\n\r\n  /**\r\n   * Stop listening to pointermove and reverse search results.\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.unlistenToMapPointerMove();\r\n    this.unsubscribeToPointerStore();\r\n    this.unlistenToMapSingleClick();\r\n    this.layers$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * Subscribe to pointermove result store\r\n   * @internal\r\n   */\r\n  subscribeToPointerStore() {\r\n    this.store$$ = this.pointerHoverFeatureStore.entities$.subscribe(resultsUnderPointerPosition => {\r\n      this.entitiesToPointerOverlay(resultsUnderPointerPosition);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * convert store entities to a pointer position overlay with label summary on.\r\n   * @param event OL map browser pointer event\r\n   */\r\n  private entitiesToPointerOverlay(resultsUnderPointerPosition: OlFeature<OlGeometry>[]) {\r\n\r\n    this.addFeatureOverlay(resultsUnderPointerPosition);\r\n\r\n  }\r\n\r\n  /**\r\n   * On map pointermove\r\n   */\r\n  private listenToMapPointerMove() {\r\n    this.pointerMoveListener = this.map.ol.on(\r\n      'pointermove',\r\n      (event: OlMapBrowserEvent<any>) => this.onMapEvent(event)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * On map singleclick\r\n   */\r\n  private listenToMapClick() {\r\n    this.singleClickMapListener = this.map.ol.on(\r\n      'singleclick',\r\n      (event: OlMapBrowserEvent<any>) => this.onMapSingleClickEvent(event)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to pointer store.\r\n   * @internal\r\n   */\r\n  unsubscribeToPointerStore() {\r\n    this.store$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * Stop listening for map pointermove\r\n   * @internal\r\n   */\r\n  private unlistenToMapPointerMove() {\r\n    unByKey(this.pointerMoveListener);\r\n    this.pointerMoveListener = undefined;\r\n  }\r\n\r\n  /**\r\n   * Stop listening for map singleclick\r\n   * @internal\r\n   */\r\n  private unlistenToMapSingleClick() {\r\n    unByKey(this.singleClickMapListener);\r\n    this.singleClickMapListener = undefined;\r\n  }\r\n\r\n  /**\r\n   * Trigger clear layer on singleclick.\r\n   * @param event OL map browser singleclick event\r\n   */\r\n  private onMapSingleClickEvent(event: OlMapBrowserEvent<any>) {\r\n    this.clearLayer();\r\n  }\r\n\r\n  /**\r\n   * Trigger hover when the mouse is motionless during the defined delay (pointerMoveDelay).\r\n   * @param event OL map browser pointer event\r\n   */\r\n  private onMapEvent(event: OlMapBrowserEvent<any>) {\r\n    if (\r\n      event.dragging || !this.igoHoverFeatureEnabled ||\r\n      this.mediaService.isTouchScreen()) {\r\n      this.clearLayer();\r\n      return;\r\n    }\r\n    if (typeof this.lastTimeoutRequest !== 'undefined') { // cancel timeout when the mouse moves\r\n      clearTimeout(this.lastTimeoutRequest);\r\n    }\r\n    this.clearLayer();\r\n    let maximumZindex = -Infinity;\r\n    let topMostOlLayer;\r\n    const pixel = this.map.ol.getPixelFromCoordinate(event.coordinate);\r\n    this.lastTimeoutRequest = setTimeout(() => {\r\n\r\n      // retrieve the topmost layer with feature to only apply the hover on this layer.\r\n      this.map.ol.forEachFeatureAtPixel(pixel, (mapFeature: RenderFeature | OlFeature<OlGeometry>, layerOL: any) => {\r\n        if (!layerOL) {\r\n          return;\r\n        }\r\n        const igoLayer = this.map.getLayerByOlUId((layerOL as any).ol_uid);\r\n        if (!this.canProcessHover(igoLayer as any)) {\r\n          return;\r\n        }\r\n        if (igoLayer.zIndex <= maximumZindex) {\r\n          return;\r\n        }\r\n        maximumZindex = igoLayer.zIndex;\r\n        topMostOlLayer = layerOL;\r\n\r\n      }, {\r\n        hitTolerance: 10, layerFilter: olLayer => olLayer instanceof olLayerVector || olLayer instanceof olLayerVectorTile\r\n      });\r\n      if (!topMostOlLayer) {\r\n        return;\r\n      }\r\n\r\n      this.clearLayer();\r\n      this.map.ol.forEachFeatureAtPixel(pixel, (mapFeature: RenderFeature | OlFeature<OlGeometry>, layerOL: any) => {\r\n        if (mapFeature.get('hoverSummary') === undefined) {\r\n          let igoLayer;\r\n          if (layerOL instanceof olLayerVector) {\r\n            igoLayer = this.map.getLayerByOlUId((layerOL as any).ol_uid) as VectorLayer;\r\n            if (!this.canProcessHover(igoLayer)) {\r\n              return;\r\n            }\r\n            let localOlFeature = this.handleRenderFeature(mapFeature);\r\n            this.setLayerStyleFromOptions(igoLayer, localOlFeature);\r\n            const featuresToLoad = [localOlFeature];\r\n            localOlFeature.set(\"_isLabel\", false);\r\n            const myLabelOlFeature = new OlFeature();\r\n            myLabelOlFeature.setProperties(localOlFeature.getProperties());\r\n            const labelGeom =\r\n              localOlFeature.getGeometry().getType() === 'Point' ? localOlFeature.getGeometry() : new OlGeom.Point(event.coordinate);\r\n            myLabelOlFeature.setGeometry(labelGeom);\r\n            myLabelOlFeature.setId(localOlFeature.getId());\r\n            myLabelOlFeature.set(\"_isLabel\", true);\r\n            this.setLayerStyleFromOptions(igoLayer, myLabelOlFeature);\r\n            featuresToLoad.push(myLabelOlFeature);\r\n            this.pointerHoverFeatureStore.load(featuresToLoad);\r\n            return true;\r\n          }\r\n          if (layerOL instanceof olLayerVectorTile) {\r\n            igoLayer = this.map.getLayerByOlUId((layerOL as any).ol_uid) as VectorTileLayer;\r\n            if (!this.canProcessHover(igoLayer)) {\r\n              return;\r\n            }\r\n            if (igoLayer?.options?.styleByAttribute?.hoverStyle) {\r\n              this.mvtStyleOptions = igoLayer.options.styleByAttribute.hoverStyle;\r\n            } else if (igoLayer?.options?.hoverStyle) {\r\n              this.mvtStyleOptions = igoLayer.options.hoverStyle;\r\n            }\r\n            this.selectionLayer.setSource(layerOL.getSource());\r\n            layerOL.getFeatures(event.pixel).then((mvtFeatures: (RenderFeature | OlFeature<OlGeometry>)[]) => {\r\n              if (!mvtFeatures.length) {\r\n                this.selectionMVT = {};\r\n                this.selectionLayer.changed();\r\n                this.clearLayer();\r\n                return;\r\n              }\r\n              const feature = mvtFeatures[0];\r\n              if (!feature) {\r\n                this.clearLayer();\r\n                return;\r\n              }\r\n              let localOlFeature = this.handleRenderFeature(feature);\r\n              localOlFeature.set(\"_isLabel\", false);\r\n              const myLabelOlFeature = new OlFeature();\r\n              myLabelOlFeature.setProperties(localOlFeature.getProperties());\r\n              const labelGeom =\r\n              localOlFeature.getGeometry().getType() === 'Point' ? localOlFeature.getGeometry() : new OlGeom.Point(event.coordinate);\r\n              myLabelOlFeature.setGeometry(labelGeom);\r\n              myLabelOlFeature.setId(localOlFeature.getId());\r\n              myLabelOlFeature.set(\"_isLabel\", true);\r\n              this.setLayerStyleFromOptions(igoLayer, myLabelOlFeature);\r\n              this.pointerHoverFeatureStore.load([myLabelOlFeature]);\r\n              this.selectionMVT[feature.getId()] = localOlFeature;\r\n              this.selectionLayer.changed();\r\n            });\r\n          }\r\n        }\r\n        return true;\r\n      }, {\r\n        hitTolerance: 10, layerFilter: olLayer => olLayer === topMostOlLayer\r\n      });\r\n    }, this.igoHoverFeatureDelay);\r\n  }\r\n\r\n  canProcessHover(igoLayer: VectorLayer | VectorTileLayer): boolean {\r\n    if (!igoLayer) {\r\n      return false;\r\n    }\r\n    if (!igoLayer.visible) {\r\n      return false;\r\n    }\r\n    if (!igoLayer.options) {\r\n      return false;\r\n    }\r\n\r\n    if (!igoLayer.options.styleByAttribute && !igoLayer.options.hoverStyle) {\r\n      return false;\r\n    }\r\n\r\n    if (\r\n      (igoLayer.options.styleByAttribute && !igoLayer.options.styleByAttribute.hoverStyle) &&\r\n      !igoLayer.options.hoverStyle) {\r\n      return false;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  handleRenderFeature(feature: RenderFeature | OlFeature<OlGeometry>): OlFeature<OlGeometry> {\r\n    let localFeature: OlFeature<OlGeometry>;\r\n    if (feature instanceof RenderFeature) {\r\n      localFeature = new OlFeature({\r\n        geometry: this.getGeometry(feature)\r\n      });\r\n      localFeature.setId(feature.getId());\r\n    } else if (feature instanceof OlFeature) {\r\n      localFeature = feature;\r\n    }\r\n    return localFeature;\r\n  }\r\n\r\n  /**\r\n   * Add a feature to the pointer store\r\n   * @param text string\r\n   */\r\n  private addFeatureOverlay(hoverEntity: OlFeature<OlGeometry>[]) {\r\n\r\n    if (hoverEntity.length > 0) {\r\n\r\n      const result = hoverEntity[0];\r\n      this.clearLayer();\r\n      const feature = new OlFeature({\r\n        geometry: result.getGeometry(),\r\n        meta: { id: this.hoverFeatureId },\r\n        hoverSummary: this.getHoverSummary(result.getProperties())\r\n      });\r\n\r\n      this.store.setLayerOlFeatures([feature], FeatureMotion.None);\r\n    }\r\n  }\r\n\r\n  private setLayerStyleFromOptions(igoLayer: VectorLayer | VectorTileLayer, feature: OlFeature<OlGeometry>) {\r\n    const resolution = this.store.layer.map.viewController.getResolution();\r\n    if (igoLayer?.options?.styleByAttribute?.hoverStyle) {\r\n      this.store.layer.ol.setStyle(this.createHoverStyle(feature, igoLayer.options.styleByAttribute.hoverStyle, resolution));\r\n      return;\r\n    }\r\n    if (igoLayer?.options?.hoverStyle) {\r\n      this.store.layer.ol.setStyle(this.createHoverStyle(feature, igoLayer.options.hoverStyle, resolution));\r\n    }\r\n  }\r\n\r\n  private getHoverSummary(properties): string {\r\n    let summary = '';\r\n    for (const [key, value] of Object.entries(properties)) {\r\n      if (!key.startsWith('_') && key !== 'geometry') {\r\n        summary += `${key}: ${value}` + '\\n';\r\n      }\r\n    }\r\n    return summary.length >= 2 ? summary.slice(0, -2) : summary;\r\n  }\r\n\r\n  private getGeometry(feature): OlGeom.Geometry {\r\n    let geom;\r\n    if (!feature.getOrientedFlatCoordinates) {\r\n      geom = feature.getGeometry();\r\n    } else {\r\n\r\n      const coords = feature.getOrientedFlatCoordinates();\r\n      const flatCoords = [];\r\n\r\n      coords.forEach((c, idx) => {\r\n        if (idx % 2 === 0) {\r\n          flatCoords.push([parseFloat(coords[idx]), parseFloat(coords[idx + 1])]);\r\n        }\r\n      });\r\n\r\n      // TODO: test MultiX\r\n      switch (feature.getType()) {\r\n        case 'Point':\r\n          geom = new OlGeom.Point(flatCoords);\r\n          break;\r\n        case 'Polygon':\r\n          geom = new OlGeom.Polygon([flatCoords]);\r\n          break;\r\n        case 'LineString':\r\n          geom = new OlGeom.LineString([flatCoords]);\r\n          break;\r\n      }\r\n    }\r\n\r\n    return geom;\r\n  }\r\n\r\n\r\n  /**\r\n   * Clear the pointer store features\r\n   */\r\n  private clearLayer() {\r\n    this.selectionMVT = {};\r\n    if (this.selectionLayer) {\r\n      this.selectionLayer.changed();\r\n    }\r\n    if (this.store) {\r\n      this.store.clearLayer();\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Create a default style for the pointer position and it's label summary.\r\n * @param feature OlFeature\r\n * @returns OL style function\r\n */\r\nexport function hoverFeatureMarker(feature: OlFeature<OlGeom.Geometry>, resolution: number): OlStyle.Style[] {\r\n\r\n  const olStyleText = new OlStyle.Style({\r\n    text: new OlStyle.Text({\r\n      text: feature.get('hoverSummary'),\r\n      textAlign: 'left',\r\n      textBaseline: 'top',\r\n      font: '12px Calibri,sans-serif',\r\n      fill: new OlStyle.Fill({ color: '#000' }),\r\n      backgroundFill: new OlStyle.Fill({ color: 'rgba(255, 255, 255, 0.5)' }),\r\n      backgroundStroke: new OlStyle.Stroke({ color: 'rgba(200, 200, 200, 0.75)', width: 2 }),\r\n      stroke: new OlStyle.Stroke({ color: '#fff', width: 3 }),\r\n      overflow: true,\r\n      offsetX: 10,\r\n      offsetY: 20,\r\n      padding: [2.5, 2.5, 2.5, 2.5]\r\n    })\r\n  });\r\n\r\n  const olStyle = [olStyleText];\r\n  switch (feature.getGeometry().getType()) {\r\n    case 'Point':\r\n      olStyle.push(new OlStyle.Style({\r\n        image: new OlStyle.Circle({\r\n          radius: 10,\r\n          stroke: new OlStyle.Stroke({\r\n            color: 'blue',\r\n            width: 3\r\n          })\r\n        })\r\n      }));\r\n      break;\r\n    default:\r\n      olStyle.push(new OlStyle.Style({\r\n        stroke: new OlStyle.Stroke({\r\n          color: 'white',\r\n          width: 5\r\n        })\r\n      }));\r\n      olStyle.push(new OlStyle.Style({\r\n        stroke: new OlStyle.Stroke({\r\n          color: 'blue',\r\n          width: 3\r\n        })\r\n      }));\r\n  }\r\n\r\n  return olStyle;\r\n\r\n}\r\n","import { Component, Input } from '@angular/core';\r\n\r\nimport { IgoMap } from '../shared/map';\r\n\r\n@Component({\r\n  selector: 'igo-zoom-button',\r\n  templateUrl: './zoom-button.component.html',\r\n  styleUrls: ['./zoom-button.component.scss']\r\n})\r\nexport class ZoomButtonComponent {\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() color: string;\r\n\r\n  get zoom(): number { return this.map.viewController.getZoom(); }\r\n\r\n  get minZoom(): number { return this.map.viewController.olView.getMinZoom() || 1; }\r\n\r\n  get maxZoom(): number { return this.map.viewController.olView.getMaxZoom(); }\r\n\r\n  constructor() {}\r\n}\r\n","<div class=\"igo-zoom-button-container\">\r\n  <button\r\n    mat-icon-button\r\n    [matTooltip]=\"'igo.geo.mapButtons.zoomIn' | translate: {zoom: zoom + 1}\"\r\n    matTooltipPosition=\"left\"\r\n    [color]=\"color\"\r\n    [disabled]=\"zoom >= maxZoom\"\r\n    (click)=\"map.viewController.zoomIn()\">\r\n    <mat-icon svgIcon=\"plus\"></mat-icon>\r\n  </button>\r\n\r\n  <button\r\n    mat-icon-button\r\n    [matTooltip]=\"'igo.geo.mapButtons.zoomOut' | translate: {zoom: zoom - 1}\"\r\n    matTooltipPosition=\"left\"\r\n    [color]=\"color\"\r\n    [disabled]=\"zoom <= minZoom\"\r\n    (click)=\"map.viewController.zoomOut()\">\r\n    <mat-icon svgIcon=\"minus\"></mat-icon>\r\n  </button>\r\n</div>\r\n","<div class=\"igo-geolocate-button-container\" *ngIf=\"map.geolocationController\">\r\n  <button\r\n    mat-icon-button\r\n    [matTooltip]=\"'igo.geo.mapButtons.geolocate' | translate\"\r\n    matTooltipPosition=\"left\"\r\n    [color]=\"color\"\r\n    (click)=\"onGeolocationClick()\">\r\n    <mat-icon svgIcon=\"{{icon$ | async}}\"></mat-icon>\r\n  </button>\r\n</div>\r\n","import { AfterContentInit, Component, Input, OnDestroy } from '@angular/core';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\nimport { IgoMap } from '../shared/map';\r\n\r\n@Component({\r\n  selector: 'igo-geolocate-button',\r\n  templateUrl: './geolocate-button.component.html',\r\n  styleUrls: ['./geolocate-button.component.scss']\r\n})\r\nexport class GeolocateButtonComponent implements AfterContentInit, OnDestroy {\r\n\r\n  private tracking$$: Subscription;\r\n  readonly icon$: BehaviorSubject<string> = new BehaviorSubject('crosshairs-gps');\r\n\r\n  @Input()\r\n  get map(): IgoMap {\r\n    return this._map;\r\n  }\r\n  set map(value: IgoMap) {\r\n    this._map = value;\r\n  }\r\n  private _map: IgoMap;\r\n\r\n  @Input()\r\n  get color(): string {\r\n    return this._color;\r\n  }\r\n  set color(value: string) {\r\n    this._color = value;\r\n  }\r\n  private _color: string;\r\n\r\n  constructor() {}\r\n  ngAfterContentInit(): void {\r\n    this.map.ol.once('rendercomplete', () => {\r\n      this.tracking$$ =this.map.geolocationController.tracking$.subscribe(tracking => {\r\n        if (tracking) {\r\n          this.icon$.next('crosshairs-gps');\r\n        } else {\r\n          this.icon$.next('crosshairs');\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    if (this.tracking$$) {\r\n      this.tracking$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  onGeolocationClick() {\r\n    const tracking = this.map.geolocationController.tracking;\r\n    this.map.geolocationController.tracking = tracking ? false : true;\r\n  }\r\n}\r\n","import { ConfigService } from '@igo2/core';\r\nimport { Component, Input } from '@angular/core';\r\nimport { IgoMap } from '../shared/map';\r\nimport { MapExtent } from '../shared/map.interface';\r\nimport * as olproj from 'ol/proj';\r\n/*\r\nButton to center the map to the home extent\r\n*/\r\n@Component({\r\n  selector: 'igo-home-extent-button',\r\n  templateUrl:'./home-extent-button.component.html',\r\n  styleUrls: ['./home-extent-button.component.scss'],\r\n})\r\nexport class HomeExtentButtonComponent {\r\n  @Input() map: IgoMap;\r\n  @Input() color: string;\r\n  @Input() extentOverride?: MapExtent\r\n  @Input() centerOverride?: [number, number];\r\n  @Input() zoomOverride?: number;\r\n\r\n  private homeExtentButtonExtent;\r\n  private homeExtentButtonCenter;\r\n  private homeExtentButtonZoom;\r\n\r\n constructor(public configService: ConfigService) {\r\n      this.computeHomeExtent();\r\n  }\r\n\r\n  computeHomeExtent() {\r\n    this.homeExtentButtonExtent = this.extentOverride || this.configService.getConfig('homeExtentButton.homeExtButtonExtent');\r\n    this.homeExtentButtonCenter = this.centerOverride || this.configService.getConfig('homeExtentButton.homeExtButtonCenter');\r\n    this.homeExtentButtonZoom = this.zoomOverride || this.configService.getConfig('homeExtentButton.homeExtButtonZoom');\r\n\r\n    // priority over extent if these 2 properties are defined;\r\n    if (this.centerOverride && this.zoomOverride) {\r\n      this.homeExtentButtonExtent = undefined;\r\n    }\r\n  }\r\n\r\n  onToggleClick() {\r\n    this.computeHomeExtent();\r\n    if (this.homeExtentButtonExtent) {\r\n      this.map.viewController.zoomToExtent(this.homeExtentButtonExtent);\r\n    } else if (this.homeExtentButtonCenter && this.homeExtentButtonZoom) {\r\n      const center = olproj.fromLonLat(this.homeExtentButtonCenter, this.map.viewController.olView.getProjection().getCode());\r\n      this.map.viewController.olView.setCenter(center);\r\n      this.map.viewController.zoomTo(this.homeExtentButtonZoom);\r\n    }\r\n  }\r\n}\r\n","<div class=\"igo-home-extent-button-container\"><button\r\n    mat-icon-button\r\n    [matTooltip]=\"'igo.geo.mapButtons.home-extent' | translate\"\r\n            matTooltipPosition=\"left\"\r\n    [color]=\"color\"\r\n    (click)=\"onToggleClick()\"><mat-icon svgIcon = \"home-map-marker\"></mat-icon></button></div>\r\n","<div *ngIf=\"visible\" class=\"igo-wake-lock-button-container\">\r\n  <div>\r\n    <button \r\n      [color]=\"color\"\r\n      mat-icon-button\r\n      [matTooltip]=\"enabled ? ('igo.geo.mapButtons.preventSreenLock' | translate): ('igo.geo.mapButtons.letScreenLock' | translate)\"\r\n      matTooltipPosition=\"left\"\r\n      (click)=\"toggleWakeLock()\">\r\n      <mat-icon svgIcon=\"{{icon$ | async}}\"></mat-icon>\r\n    </button>\r\n  </div>\r\n</div>","import { Component, Input } from '@angular/core';\r\nimport { ConfigService, StorageService } from '@igo2/core';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport NoSleep from 'nosleep.js';\r\nimport { IgoMap } from '../shared/map';\r\nimport { userAgent } from '@igo2/utils';\r\n\r\n@Component({\r\n  selector: 'igo-wake-lock-button',\r\n  templateUrl: './wake-lock-button.component.html',\r\n  styleUrls: ['./wake-lock-button.component.scss']\r\n})\r\n\r\n/**\r\n * Prevent display sleep and enable wake lock in all Android and iOS web browsers.\r\n * On iOS, the Wake Lock API is not supported\r\n * https://developer.mozilla.org/en-US/docs/Web/API/Screen_Wake_Lock_API\r\n * On not supported browser, a fake video is used to keep the screen open.\r\n *\r\n * TODO: When the API will be supported by every browser, We should remove the NoSleep.js dependency\r\n * and replace it by a WakeLock API implementation.\r\n */\r\nexport class WakeLockButtonComponent {\r\n\r\n  @Input() color: string = 'primary';\r\n  @Input() map: IgoMap;\r\n  @Input()\r\n  get enabled(): boolean {\r\n    return this.storageService.get('wakeLockEnabled') as boolean;\r\n  }\r\n  set enabled(value: boolean) {\r\n    this.storageService.set('wakeLockEnabled', value);\r\n  }\r\n\r\n  private noSleep: NoSleep;\r\n  readonly icon$: BehaviorSubject<string> = new BehaviorSubject('sleep');\r\n  public visible = false;\r\n\r\n  constructor(\r\n    private config: ConfigService,\r\n    private storageService: StorageService\r\n  ) {\r\n    this.visible = this.config.getConfig('wakeLockApiButton') ? true : false;\r\n    this.noSleep = new NoSleep();\r\n    const nonWakeLockApiBrowser = userAgent.satisfies({\r\n      ie: '>0',\r\n      edge: '<84',\r\n      chrome: '<84',\r\n      firefox: '>0',\r\n      opera: '<70',\r\n      safari: '>0'\r\n    });\r\n    if (nonWakeLockApiBrowser) {\r\n      this.disableWakeLock();\r\n      this.enabled = false;\r\n      window.onblur = () => {\r\n        this.disableWakeLock();\r\n        this.enabled = false;\r\n    };\r\n    }\r\n    this.enabled ? this.enableWakeLock() : this.disableWakeLock();\r\n  }\r\n\r\n  /**\r\n   * Prevent display sleep and enable wake lock in all Android and iOS web browsers.\r\n   * On iOS, the Wake Lock API is not supported\r\n   * https://developer.mozilla.org/en-US/docs/Web/API/Screen_Wake_Lock_API\r\n   * On not supported browser, a fake video is used to keep the screen open.\r\n   */\r\n  private enableWakeLock() {\r\n    this.noSleep.enable();\r\n    this.enabled = true;\r\n    this.icon$.next('sleep-off');\r\n  }\r\n  /**\r\n   * Let display sleep\r\n   */\r\n  private disableWakeLock() {\r\n    this.noSleep.disable();\r\n    this.enabled = false;\r\n    this.icon$.next('sleep');\r\n  }\r\n\r\n  toggleWakeLock() {\r\n    if (this.enabled) {\r\n      this.disableWakeLock();\r\n    } else {\r\n      this.enableWakeLock();\r\n    }\r\n  }\r\n}\r\n","<div *ngIf=\"baseLayers.length > 0\"\r\n     class=\"igo-baselayers-switcher-container\"\r\n     [ngClass]=\"{'container-expand': expand}\"\r\n     [@baseLayerSwitcherState]=\"expand ? 'expand' : useStaticIcon ? 'collapseIcon' : 'collapseMap'\"\r\n     (@baseLayerSwitcherState.start)=\"showButton=false\"\r\n     (@baseLayerSwitcherState.done)=\"showButton=true\"\r\n     (click)=\"collapseOrExpand()\">\r\n\r\n     <div *ngIf=\"useStaticIcon && !expand && showButton\" class=\"igo-baselayers-switcher-button-container\">\r\n       <button\r\n         mat-icon-button\r\n         [matTooltip]=\"'igo.geo.mapButtons.baselayerSwitcher' | translate\"\r\n         matTooltipPosition=\"right\"\r\n         color=\"primary\">\r\n         <mat-icon svgIcon=\"image-multiple\"></mat-icon>\r\n       </button>\r\n     </div>\r\n\r\n     <igo-mini-basemap class=\"mat-typography\" *ngFor=\"let baseLayer of baseLayers; let i = index\"\r\n       [map]=\"map\"\r\n       [baseLayer]=\"baseLayer\"\r\n       [title]=\"(baseLayers.length > 2 && !expand) ? ('igo.geo.baselayersSwitcher.title' | translate) : baseLayer.title\"\r\n       [display]=\"expand || (i === 0 && !useStaticIcon)\"\r\n       [disabled]=\"!expand && baseLayers.length > 1\">\r\n     </igo-mini-basemap>\r\n\r\n    <div class=\"more-baselayers\">\r\n      <mat-icon class=\"material-icons mat-icon mat-list-avatar\" color=\"primary\" svgIcon=\"menu-down\"></mat-icon>\r\n    </div>\r\n\r\n</div>\r\n","import { Component, Input, AfterViewInit, OnDestroy } from '@angular/core';\r\nimport { Subscription } from 'rxjs';\r\n\r\nimport { MediaService, Media } from '@igo2/core';\r\nimport { Layer } from '../../layer';\r\nimport { IgoMap } from '../shared';\r\nimport { baseLayersSwitcherSlideInOut } from './baselayers-switcher.animation';\r\n\r\n@Component({\r\n  selector: 'igo-baselayers-switcher',\r\n  templateUrl: './baselayers-switcher.component.html',\r\n  styleUrls: ['./baselayers-switcher.component.scss'],\r\n  animations: [baseLayersSwitcherSlideInOut()]\r\n})\r\nexport class BaseLayersSwitcherComponent implements AfterViewInit, OnDestroy {\r\n  @Input() map: IgoMap;\r\n  @Input() useStaticIcon: boolean;\r\n\r\n  public _baseLayers: Layer[] = [];\r\n  public expand = false;\r\n  public showButton = true;\r\n\r\n  private layers$$: Subscription;\r\n\r\n  constructor(private mediaService: MediaService) {\r\n    const media = this.mediaService.media$.value;\r\n    if (media === Media.Mobile && this.useStaticIcon === undefined) {\r\n      this.useStaticIcon = true;\r\n    }\r\n  }\r\n\r\n  ngAfterViewInit() {\r\n    this.layers$$ = this.map.layers$.subscribe(arrayLayers => {\r\n      this._baseLayers = arrayLayers.filter(l => l.baseLayer);\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.layers$$.unsubscribe();\r\n  }\r\n\r\n  collapseOrExpand() {\r\n    if (this.baseLayers.length > 1 || this.useStaticIcon) {\r\n      this.expand = !this.expand;\r\n    } else {\r\n      this.expand = false;\r\n    }\r\n  }\r\n\r\n  get baseLayers(): Layer[] {\r\n    const mapResolution = this.map.viewController.getResolution();\r\n    const mapZoom = this.map.viewController.getZoom();\r\n\r\n    const bl = this._baseLayers.filter(l => {\r\n      return (\r\n        (!l.options.maxResolution ||\r\n          mapResolution <= l.options.maxResolution) &&\r\n        (!l.options.minResolution || mapResolution >= l.options.minResolution) &&\r\n        (!l.options.source.options.maxZoom || mapZoom <= l.options.source.options.maxZoom) &&\r\n        (!l.options.source.options.minZoom || mapZoom >= l.options.source.options.minZoom)\r\n      );\r\n    });\r\n\r\n    const blHidden = bl.filter(l => !l.visible);\r\n    return blHidden.length + 1 === bl.length ? blHidden : bl;\r\n  }\r\n}\r\n","import {\r\n  trigger,\r\n  state,\r\n  style,\r\n  transition,\r\n  animate,\r\n  AnimationTriggerMetadata\r\n} from '@angular/animations';\r\n\r\nexport function baseLayersSwitcherSlideInOut(): AnimationTriggerMetadata {\r\n  return trigger('baseLayerSwitcherState', [\r\n    state(\r\n      'collapseIcon',\r\n      style({\r\n        height: '40px',\r\n        width: '40px',\r\n        overflow: 'hidden'\r\n      })\r\n    ),\r\n    state(\r\n      'collapseMap',\r\n      style({\r\n        height: '85px',\r\n        overflow: 'hidden'\r\n      })\r\n    ),\r\n    state(\r\n      'expand',\r\n      style({\r\n        overflow: 'hidden'\r\n      })\r\n    ),\r\n    transition('collapse => expand', animate('200ms')),\r\n    transition('expand => collapse', animate('200ms'))\r\n  ]);\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { DBMode, NgxIndexedDBService } from 'ngx-indexed-db';\r\nimport { Observable, of, Subject } from 'rxjs';\r\nimport { concatMap, first, map, take } from 'rxjs/operators';\r\nimport { CompressionService } from '@igo2/core';\r\nimport { GeoDBData } from './geoDB.interface';\r\nimport { InsertSourceInsertDBEnum } from './geoDB.enums';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class GeoDBService {\r\n  readonly dbName: string = 'geoData';\r\n  public collisionsMap: Map<number, string[]> = new Map();\r\n  public _newTiles: number = 0;\r\n\r\n  constructor(\r\n    private ngxIndexedDBService: NgxIndexedDBService,\r\n    private compression: CompressionService\r\n  ) { }\r\n\r\n  /**\r\n   * Only blob can be will be compressed\r\n   * @param url\r\n   * @param regionID\r\n   * @param object object to handle\r\n   * @param insertSource type of event user or system\r\n   * @param insertEvent Name of the event where the insert has been triggered\r\n   * @returns\r\n   */\r\n  update(url: string, regionID: number, object: any, insertSource: InsertSourceInsertDBEnum, insertEvent: string): Observable<any> {\r\n    if (!object) {\r\n      return;\r\n    }\r\n    let compress = false;\r\n\r\n    const subject: Subject<GeoDBData> = new Subject();\r\n    let object$: Observable<any> = of(object);\r\n    if (object instanceof Blob) {\r\n      object$ = this.compression.compressBlob(object);\r\n      compress = true;\r\n    }\r\n    let geoDBData: GeoDBData;\r\n    object$.pipe(\r\n      first(),\r\n      concatMap(object => {\r\n        geoDBData = {\r\n          url,\r\n          regionID,\r\n          object: object,\r\n          compressed: compress,\r\n          insertSource,\r\n          insertEvent\r\n        };\r\n        return this.ngxIndexedDBService.getByID(this.dbName, url);\r\n      }),\r\n      concatMap((dbObject: GeoDBData) => {\r\n        if (!dbObject) {\r\n          this._newTiles++;\r\n          return this.ngxIndexedDBService.add(this.dbName, geoDBData);\r\n        } else {\r\n          const currentRegionID = dbObject.regionID;\r\n          if (currentRegionID !== regionID) {\r\n            const collisions = this.collisionsMap.get(currentRegionID);\r\n            if (collisions !== undefined) {\r\n              collisions.push(dbObject.url);\r\n              this.collisionsMap.set(currentRegionID, collisions);\r\n            } else {\r\n              this.collisionsMap.set(currentRegionID, [dbObject.url]);\r\n            }\r\n          }\r\n          return this.customUpdate(geoDBData);\r\n        }\r\n      })\r\n    ).subscribe((response) => {\r\n      subject.next(response);\r\n      subject.complete();\r\n    });\r\n    return subject;\r\n  }\r\n\r\n  private customUpdate(geoDBData: GeoDBData): Observable<GeoDBData> {\r\n    const subject: Subject<GeoDBData> = new Subject();\r\n    const deleteRequest = this.ngxIndexedDBService.deleteByKey(this.dbName, geoDBData.url);\r\n    deleteRequest.pipe(\r\n      concatMap(isDeleted => isDeleted ? this.ngxIndexedDBService.add(this.dbName, geoDBData) : of(undefined))\r\n    )\r\n    .subscribe(object => {\r\n      if (object) {\r\n        subject.next(object);\r\n      }\r\n      subject.complete();\r\n    });\r\n    return subject;\r\n  }\r\n\r\n  get(url: string): Observable<any> {\r\n    return this.ngxIndexedDBService.getByID(this.dbName, url).pipe(\r\n      map((data: GeoDBData) => {\r\n        if (data) {\r\n          const object = data.object;\r\n          if (!data.compressed) {\r\n            return object;\r\n          }\r\n          return this.compression.decompressBlob(object);\r\n        }\r\n      })\r\n    );\r\n  }\r\n\r\n  getRegionTileCountByID(id: number): Observable<number> {\r\n    const subject: Subject<number> = new Subject();\r\n    const dbRequest = this.getRegionByID(id)\r\n      .subscribe((tiles) => {\r\n        subject.next(tiles.length);\r\n        subject.complete();\r\n      });\r\n    return subject;\r\n  }\r\n\r\n  getRegionByID(id: number): Observable<any[]> {\r\n    if (!id) {\r\n      return;\r\n    }\r\n\r\n    const IDBKey: IDBKeyRange = IDBKeyRange.only(id);\r\n    const dbRequest = this.ngxIndexedDBService.getAllByIndex(this.dbName, 'regionID', IDBKey);\r\n    return dbRequest;\r\n  }\r\n\r\n  deleteByRegionID(id: number): Observable<any> {\r\n    if (!id) {\r\n      return;\r\n    }\r\n\r\n    const IDBKey: IDBKeyRange = IDBKeyRange.only(id);\r\n    const dbRequest = this.ngxIndexedDBService.getAllByIndex(this.dbName, 'regionID', IDBKey);\r\n    dbRequest.subscribe((tiles: GeoDBData[]) => {\r\n      tiles.forEach((tile) => {\r\n        this.ngxIndexedDBService.deleteByKey(this.dbName, tile.url);\r\n      });\r\n    });\r\n    return dbRequest;\r\n  }\r\n\r\n  openCursor(\r\n    keyRange: IDBKeyRange = IDBKeyRange.lowerBound(0),\r\n    mode: DBMode = DBMode.readonly\r\n  ) {\r\n    const request = this.ngxIndexedDBService.openCursorByIndex(this.dbName, 'regionID', keyRange, mode);\r\n    return request;\r\n  }\r\n\r\n  resetCounters() {\r\n    this.resetCollisionsMap();\r\n    this._newTiles = 0;\r\n  }\r\n\r\n  resetCollisionsMap() {\r\n    this.collisionsMap = new Map();\r\n  }\r\n\r\n  revertCollisions() {\r\n    for (const [regionID, collisions] of this.collisionsMap) {\r\n      for (const url of collisions) {\r\n        this.ngxIndexedDBService.getByKey(this.dbName, url)\r\n          .pipe(take(1))\r\n          .subscribe((dbObject: GeoDBData) => {\r\n            const updatedObject = dbObject;\r\n            updatedObject.regionID = regionID;\r\n            this.customUpdate(dbObject);\r\n          });\r\n      }\r\n    }\r\n  }\r\n\r\n  get newTiles(): number {\r\n    return this._newTiles;\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\nimport { Injectable } from '@angular/core';\r\nimport { ConnectionState, NetworkService } from '@igo2/core';\r\nimport { Observable } from 'rxjs';\r\nimport { GeoDBService } from '../geoDB/geoDB.service';\r\n\r\nexport enum ResponseType {\r\n  Arraybuffer= 'arraybuffer',\r\n  Blob= 'blob',\r\n  Text= 'text',\r\n  Json= 'json',\r\n}\r\nexport interface SimpleGetOptions {\r\n  responseType: ResponseType;\r\n  withCredentials?: boolean;\r\n}\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class GeoNetworkService {\r\n  private networkOnline: boolean = true;\r\n  constructor(\r\n    private http: HttpClient,\r\n    public geoDBService: GeoDBService,\r\n    private networkService: NetworkService,\r\n  ) {\r\n    this.networkService.currentState().subscribe((state: ConnectionState) => {\r\n      this.networkOnline = state.connection;\r\n    });\r\n  }\r\n\r\n  get(url: string, simpleGetOptions: SimpleGetOptions): Observable<any> {\r\n    if (window.navigator.onLine && this.networkOnline) {\r\n      return this.getOnline(url, simpleGetOptions);\r\n    }\r\n    return this.getOffline(url);\r\n  }\r\n\r\n  private getOnline(url: string, simpleGetOptions: SimpleGetOptions): Observable<any> {\r\n    let request;\r\n    switch (simpleGetOptions.responseType) {\r\n      // TODO Ajuster pour autre formats\r\n      case 'arraybuffer':\r\n        request = this.http.get(url, { responseType: 'arraybuffer', withCredentials: simpleGetOptions.withCredentials });\r\n        break;\r\n      case 'blob':\r\n        request = this.http.get(url, { responseType: 'blob', withCredentials: simpleGetOptions.withCredentials });\r\n        break;\r\n      case 'text':\r\n        request = this.http.get(url, { responseType: 'text', withCredentials: simpleGetOptions.withCredentials });\r\n          break;\r\n      case 'json':\r\n        request = this.http.get(url, { responseType: 'json', withCredentials: simpleGetOptions.withCredentials });\r\n        break;\r\n      default:\r\n        request = this.http.get(url, { responseType: 'blob', withCredentials: simpleGetOptions.withCredentials });\r\n        break;\r\n    }\r\n    return request;\r\n  }\r\n\r\n  private getOffline(url: string): Observable<any> {\r\n    return this.geoDBService.get(url);\r\n  }\r\n\r\n  public isOnline() {\r\n    return this.networkOnline && window.navigator.onLine;\r\n  }\r\n}\r\n","import { Injectable, Optional } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { Observable, of } from 'rxjs';\r\nimport { map, catchError } from 'rxjs/operators';\r\nimport stylefunction from 'ol-mapbox-style/dist/stylefunction';\r\nimport { AuthInterceptor } from '@igo2/auth';\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport { Style } from 'ol/style';\r\n\r\nimport {\r\n  OSMDataSource,\r\n  FeatureDataSource,\r\n  XYZDataSource,\r\n  TileDebugDataSource,\r\n  WFSDataSource,\r\n  WMTSDataSource,\r\n  WMSDataSource,\r\n  CartoDataSource,\r\n  ImageArcGISRestDataSource,\r\n  ArcGISRestDataSource,\r\n  TileArcGISRestDataSource,\r\n  WebSocketDataSource,\r\n  MVTDataSource,\r\n  ClusterDataSource\r\n} from '../../datasource';\r\n\r\nimport { DataSourceService } from '../../datasource/shared/datasource.service';\r\n\r\nimport {\r\n  Layer,\r\n  ImageLayer,\r\n  ImageLayerOptions,\r\n  TileLayer,\r\n  TileLayerOptions,\r\n  VectorLayer,\r\n  VectorLayerOptions,\r\n  AnyLayerOptions,\r\n  VectorTileLayer,\r\n  VectorTileLayerOptions\r\n} from './layers';\r\n\r\nimport { computeMVTOptionsOnHover } from '../utils/layer.utils';\r\nimport { StyleService } from './style.service';\r\nimport { LanguageService, MessageService } from '@igo2/core';\r\nimport { GeoNetworkService } from '../../offline/shared/geo-network.service';\r\nimport { StyleLike as OlStyleLike } from 'ol/style/Style';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class LayerService {\r\n  constructor(\r\n    private http: HttpClient,\r\n    private styleService: StyleService,\r\n    private dataSourceService: DataSourceService,\r\n    private geoNetwork: GeoNetworkService,\r\n    private messageService: MessageService,\r\n    private languageService: LanguageService,\r\n    @Optional() private authInterceptor: AuthInterceptor\r\n  ) {}\r\n\r\n  createLayer(layerOptions: AnyLayerOptions): Layer {\r\n    if (!layerOptions.source) {\r\n      return;\r\n    }\r\n\r\n    if (\r\n      layerOptions.source.options &&\r\n      layerOptions.source.options._layerOptionsFromSource\r\n    ) {\r\n      layerOptions = ObjectUtils.mergeDeep(\r\n        layerOptions.source.options._layerOptionsFromSource,\r\n        layerOptions || {}\r\n      );\r\n    }\r\n\r\n    let layer;\r\n    switch (layerOptions.source.constructor) {\r\n      case OSMDataSource:\r\n      case WMTSDataSource:\r\n      case XYZDataSource:\r\n      case TileDebugDataSource:\r\n      case CartoDataSource:\r\n      case TileArcGISRestDataSource:\r\n        layer = this.createTileLayer(layerOptions as TileLayerOptions);\r\n        break;\r\n      case FeatureDataSource:\r\n      case WFSDataSource:\r\n      case ArcGISRestDataSource:\r\n      case WebSocketDataSource:\r\n      case ClusterDataSource:\r\n        layer = this.createVectorLayer(layerOptions as VectorLayerOptions);\r\n        break;\r\n      case ImageArcGISRestDataSource:\r\n      case WMSDataSource:\r\n        layer = this.createImageLayer(layerOptions as ImageLayerOptions);\r\n        break;\r\n      case MVTDataSource:\r\n        const _layerOptions = computeMVTOptionsOnHover(layerOptions);\r\n        layer = this.createVectorTileLayer(\r\n          _layerOptions as VectorTileLayerOptions\r\n        );\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n\r\n    return layer;\r\n  }\r\n\r\n  createAsyncLayer(_layerOptions: AnyLayerOptions, detailedContextUri?: string): Observable<Layer> {\r\n    const layerOptions = computeMVTOptionsOnHover(_layerOptions);\r\n    if (layerOptions.source) {\r\n      return new Observable(d => d.next(this.createLayer(layerOptions)));\r\n    }\r\n\r\n    return this.dataSourceService\r\n      .createAsyncDataSource(layerOptions.sourceOptions, detailedContextUri)\r\n      .pipe(\r\n        map(source => {\r\n          if (source === undefined) {\r\n            return undefined;\r\n          }\r\n          return this.createLayer(Object.assign(layerOptions, { source }));\r\n        })\r\n      );\r\n  }\r\n\r\n  private createImageLayer(layerOptions: ImageLayerOptions): ImageLayer {\r\n    return new ImageLayer(layerOptions, this.messageService, this.languageService, this.authInterceptor);\r\n  }\r\n\r\n  private createTileLayer(layerOptions: TileLayerOptions): TileLayer {\r\n    return new TileLayer(layerOptions, this.messageService, this.authInterceptor);\r\n  }\r\n\r\n  private createVectorLayer(layerOptions: VectorLayerOptions): VectorLayer {\r\n    let style: Style[] | Style | OlStyleLike;\r\n    let igoLayer: VectorLayer;\r\n    if (layerOptions.style !== undefined) {\r\n      style = (feature, resolution) => this.styleService.createStyle(layerOptions.style, feature, resolution);\r\n    }\r\n\r\n    if (layerOptions.source instanceof ArcGISRestDataSource) {\r\n      const source = layerOptions.source as ArcGISRestDataSource;\r\n      style = source.options.params.style;\r\n    } else if (layerOptions.styleByAttribute) {\r\n      const serviceStyle = this.styleService;\r\n      layerOptions.style = (feature, resolution) => {\r\n        return serviceStyle.createStyleByAttribute(\r\n          feature,\r\n          layerOptions.styleByAttribute,\r\n          resolution\r\n        );\r\n      };\r\n      igoLayer = new VectorLayer(layerOptions, this.messageService, this.authInterceptor, this.geoNetwork);\r\n    }\r\n\r\n    if (layerOptions.source instanceof ClusterDataSource) {\r\n      const serviceStyle = this.styleService;\r\n      const baseStyle = layerOptions.clusterBaseStyle;\r\n      layerOptions.style = (feature, resolution) => {\r\n        return serviceStyle.createClusterStyle(\r\n          feature,\r\n          resolution,\r\n          layerOptions.clusterParam,\r\n          baseStyle\r\n        );\r\n      };\r\n      igoLayer = new VectorLayer(layerOptions, this.messageService, this.authInterceptor, this.geoNetwork);\r\n    }\r\n\r\n    const layerOptionsOl = Object.assign({}, layerOptions, {\r\n      style\r\n    });\r\n\r\n    if (!igoLayer) {\r\n      igoLayer = new VectorLayer(layerOptionsOl, this.messageService, this.authInterceptor, this.geoNetwork);\r\n    }\r\n\r\n    this.applyMapboxStyle(igoLayer, layerOptionsOl as any);\r\n\r\n    return igoLayer;\r\n  }\r\n\r\n  private createVectorTileLayer(\r\n    layerOptions: VectorTileLayerOptions\r\n  ): VectorTileLayer {\r\n    let style: Style[] | Style | OlStyleLike;\r\n    let igoLayer: VectorTileLayer;\r\n\r\n    if (layerOptions.style !== undefined) {\r\n      style = (feature, resolution) => this.styleService.createStyle(layerOptions.style, feature, resolution);\r\n    }\r\n\r\n    if (layerOptions.styleByAttribute) {\r\n      const serviceStyle = this.styleService;\r\n      layerOptions.style = (feature, resolution) => {\r\n        return serviceStyle.createStyleByAttribute(\r\n          feature,\r\n          layerOptions.styleByAttribute,\r\n          resolution\r\n        );\r\n      };\r\n      igoLayer = new VectorTileLayer(layerOptions, this.messageService, this.authInterceptor);\r\n    }\r\n\r\n    const layerOptionsOl = Object.assign({}, layerOptions, {\r\n      style\r\n    });\r\n\r\n    if (!igoLayer) {\r\n      igoLayer = new VectorTileLayer(layerOptionsOl, this.messageService, this.authInterceptor);\r\n    }\r\n\r\n    this.applyMapboxStyle(igoLayer, layerOptionsOl);\r\n    return igoLayer;\r\n  }\r\n\r\n  private applyMapboxStyle(layer: Layer, layerOptions: VectorTileLayerOptions) {\r\n    if (layerOptions.mapboxStyle) {\r\n      this.getStuff(layerOptions.mapboxStyle.url).subscribe(res => {\r\n        if (res.sprite){\r\n          const url = this.getAbsoluteUrl(layerOptions.mapboxStyle.url, res.sprite);\r\n          this.getStuff(url+'.json').subscribe(res2 => {\r\n            stylefunction(layer.ol, res, layerOptions.mapboxStyle.source, undefined, res2,\r\n              url+'.png');\r\n          });\r\n        } else {\r\n          stylefunction(layer.ol, res, layerOptions.mapboxStyle.source);\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  private getStuff(url: string) {\r\n    return this.http.get(url).pipe(\r\n      map((res: any) => res),\r\n      catchError(err => {\r\n        console.log('No style was found');\r\n        return of(err);\r\n      })\r\n    );\r\n  }\r\n\r\n  private getAbsoluteUrl(source, url) {\r\n    const r = new RegExp('^http|\\/\\/', 'i');\r\n    if(r.test(url)){\r\n      return url;\r\n    } else {\r\n      if ( source.substr(source.length -1) === \"/\"){\r\n        return source + url;\r\n      } else{\r\n        return source + \"/\" + url;\r\n      }\r\n    }\r\n  }\r\n\r\n}\r\n","<div class=\"igo-mini-basemap-container\">\r\n\r\n  <div *ngIf=\"display\" (click)=\"changeBaseLayer(baseLayer)\">\r\n    <igo-map-browser [map]=\"basemap\"></igo-map-browser>\r\n    <div *ngIf='title' class='igo-mini-basemap-title'> {{title}} </div>\r\n  </div>\r\n\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  AfterViewInit,\r\n  OnDestroy,\r\n  ApplicationRef\r\n} from '@angular/core';\r\n\r\nimport { Layer, LayerOptions } from '../../layer/shared';\r\nimport { LayerService } from '../../layer/shared/layer.service';\r\nimport { IgoMap } from '../shared';\r\n\r\nimport OlMap from 'ol/Map';\r\nimport OlView from 'ol/View';\r\n\r\n@Component({\r\n  selector: 'igo-mini-basemap',\r\n  templateUrl: './mini-basemap.component.html',\r\n  styleUrls: ['./mini-basemap.component.scss']\r\n})\r\nexport class MiniBaseMapComponent implements AfterViewInit, OnDestroy {\r\n\r\n  @Input() map: IgoMap;\r\n  @Input() disabled: boolean;\r\n  @Input() display: boolean;\r\n  @Input() title: string;\r\n\r\n  @Input()\r\n  get baseLayer(): Layer {\r\n    return this._baseLayer;\r\n  }\r\n  set baseLayer(value: Layer) {\r\n    this._baseLayer = value;\r\n    this.handleBaseLayerChanged(value);\r\n  }\r\n  private _baseLayer: Layer;\r\n\r\n  public basemap = new IgoMap({\r\n    controls: {},\r\n    interactions: false\r\n  });\r\n\r\n  constructor(\r\n    private layerService: LayerService,\r\n    private appRef: ApplicationRef\r\n  ) { }\r\n\r\n  ngAfterViewInit() {\r\n    this.handleMainMapViewChange(this.map.ol.getView());\r\n    this.map.viewController.olView.on('change', change => {\r\n      this.handleMainMapViewChange((change.target as OlView));\r\n    });\r\n    this.map.ol.on('pointerdrag', change => {\r\n      this.handleMainMapViewChange((change.target as OlMap).getView());\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.map.viewController.olView.un('change', change => {\r\n      this.handleMainMapViewChange((change.target as OlView));\r\n    });\r\n    this.map.ol.un('pointerdrag', change => {\r\n      this.handleMainMapViewChange((change.target as OlMap).getView());\r\n    });\r\n  }\r\n\r\n  changeBaseLayer(baseLayer: Layer) {\r\n    if (this.disabled) {\r\n      return;\r\n    }\r\n    this.map.changeBaseLayer(baseLayer);\r\n    this.appRef.tick();\r\n  }\r\n\r\n  private handleMainMapViewChange(mainMapView) {\r\n    const mainMapViewProperties = mainMapView.getProperties();\r\n    this.basemap.viewController.olView.setResolution(mainMapViewProperties.resolution);\r\n    this.basemap.viewController.olView.setRotation(mainMapViewProperties.rotation);\r\n    this.basemap.viewController.olView.setCenter(this.map.viewController.getCenter());\r\n  }\r\n\r\n  private handleBaseLayerChanged(baselayer: Layer) {\r\n    this.basemap.removeAllLayers();\r\n\r\n    const options: any = Object.assign(\r\n      Object.create(baselayer.options),\r\n      baselayer.options,\r\n      {\r\n        visible: true,\r\n        baseLayer: false\r\n      }\r\n    );\r\n\r\n    const layer = this.layerService.createLayer(options);\r\n    this.basemap.addLayer(layer);\r\n    this.handleLinkedBaseLayer(layer);\r\n  }\r\n\r\n  private handleLinkedBaseLayer(baselayer: Layer) {\r\n    const linkedLayers = baselayer.options.linkedLayers;\r\n    if (!linkedLayers) {\r\n      return;\r\n    }\r\n    const currentLinkedId = linkedLayers.linkId;\r\n    const currentLinks = linkedLayers.links;\r\n    const isParentLayer = currentLinks ? true : false;\r\n    if (isParentLayer && currentLinkedId === baselayer.options.linkedLayers.linkId) {\r\n      // search for child layers\r\n      currentLinks.map(link => {\r\n        link.linkedIds.map(linkedId => {\r\n          const layerToApply = this.map.layers.find(l => l.options.linkedLayers?.linkId === linkedId);\r\n          if (layerToApply) {\r\n            const linkedLayerOptions: any = Object.assign(\r\n              Object.create(layerToApply.options),\r\n              layerToApply.options,\r\n              {\r\n                zIndex: 9000,\r\n                visible: true,\r\n                baseLayer: false,\r\n              } as LayerOptions\r\n            );\r\n            this.basemap.addLayer(this.layerService.createLayer(linkedLayerOptions));\r\n          }\r\n        });\r\n      });\r\n    }\r\n  }\r\n}\r\n","<div *ngIf=\"rotated && !showIfNoRotation\" class=\"igo-rotation-button-container\"\r\n  [matTooltip]=\"rotated ? ('igo.geo.mapButtons.resetRotation' | translate): ('igo.geo.mapButtons.tipRotation' | translate)\"\r\n  matTooltipPosition=\"left\">\r\n  <button mat-icon-button matTooltipPosition=\"left\" [color]=\"color\" [disabled]=\"!rotated\"\r\n    (click)=\"map.viewController.resetRotation()\">\r\n    <mat-icon [ngStyle]=\"rotationStyle(map.viewController.getRotation())\" svgIcon=\"navigation\">\r\n    </mat-icon>\r\n  </button>\r\n</div>\r\n\r\n<div *ngIf=\"showIfNoRotation\" class=\"igo-rotation-button-container\"\r\n  [matTooltip]=\"rotated ? ('igo.geo.mapButtons.resetRotation' | translate): ('igo.geo.mapButtons.tipRotation' | translate)\"\r\n  matTooltipPosition=\"left\">\r\n  <button mat-icon-button matTooltipPosition=\"left\" [color]=\"color\" [disabled]=\"!rotated\"\r\n    (click)=\"map.viewController.resetRotation()\">\r\n    <mat-icon [ngStyle]=\"rotationStyle(map.viewController.getRotation())\" svgIcon=\"navigation\">\r\n    </mat-icon>\r\n  </button>\r\n</div>","import { Component, Input } from '@angular/core';\r\n\r\nimport { IgoMap } from '../shared/map';\r\n\r\n@Component({\r\n  selector: 'igo-rotation-button',\r\n  templateUrl: './rotation-button.component.html',\r\n  styleUrls: ['./rotation-button.component.scss']\r\n})\r\nexport class RotationButtonComponent {\r\n  @Input()\r\n  get map(): IgoMap {\r\n    return this._map;\r\n  }\r\n  set map(value: IgoMap) {\r\n    this._map = value;\r\n  }\r\n  private _map: IgoMap;\r\n\r\n  @Input()\r\n  get showIfNoRotation(): boolean {\r\n    return this._showIfNoRotation;\r\n  }\r\n  set showIfNoRotation(value: boolean) {\r\n    this._showIfNoRotation = value;\r\n  }\r\n  private _showIfNoRotation: boolean;\r\n\r\n  @Input()\r\n  get color(): string {\r\n    return this._color;\r\n  }\r\n  set color(value: string) {\r\n    this._color = value;\r\n  }\r\n  private _color: string;\r\n\r\n  get rotated(): boolean {\r\n    return this.map.viewController.getRotation() !== 0;\r\n  }\r\n\r\n  constructor() {}\r\n\r\n  rotationStyle(radians): {} {\r\n    const rotation = 'rotate(' + radians + 'rad)';\r\n    return {\r\n      transform: rotation\r\n    };\r\n  }\r\n}\r\n","<div *ngIf=\"infoContent && infoContent.length\" class=\"infoSection\">\r\n    <pre>{{infoContent}}</pre>\r\n</div>","import { Component, Input } from '@angular/core';\r\n\r\n@Component({\r\n  selector: 'igo-info-section',\r\n  templateUrl: './info-section.component.html',\r\n  styleUrls: ['./info-section.component.scss']\r\n})\r\nexport class InfoSectionComponent {\r\n\r\n  @Input() infoContent: string = '';\r\n\r\n  constructor() {}\r\n\r\n}\r\n","export enum CatalogItemType {\r\n  Layer = 'layer',\r\n  Group = 'group'\r\n}\r\n\r\nexport enum TypeCatalog {\r\n  wms, wmts, baselayers, arcgisrest, tilearcgisrest, imagearcgisrest, composite\r\n}\r\n\r\nexport type TypeCatalogStrings = keyof typeof TypeCatalog;\r\n","import { Observable } from 'rxjs';\r\n\r\nimport { TooltipType } from '../../layer';\r\nimport { TimeFilterOptions } from '../../filter';\r\nimport { QueryFormat, QueryHtmlTarget } from '../../query';\r\n\r\nimport { ICatalog, ICompositeCatalog , CatalogItem, CatalogItemGroup } from './catalog.interface';\r\nimport { CatalogService } from './catalog.service';\r\nimport { TypeCatalog, TypeCatalogStrings } from './catalog.enum';\r\n\r\nexport abstract class Catalog implements ICatalog {\r\n\r\n    // ICatalog -----------------------------\r\n    id: string;\r\n    title: string;\r\n    url: string;\r\n    removable?: boolean;\r\n    externalProvider?: boolean;\r\n    abstract?: string;\r\n    forcedProperties?: any[];\r\n    items?: CatalogItem[];\r\n    type?: TypeCatalogStrings;\r\n    version?: string;\r\n    matrixSet?: string;\r\n    requestEncoding?: string;\r\n    regFilters?: string[];\r\n    groupImpose?: CatalogItemGroup;\r\n    groupSeparator?: string;\r\n    timeFilter?: TimeFilterOptions;\r\n    queryFormat?: QueryFormat;\r\n    queryHtmlTarget?: QueryHtmlTarget;\r\n    queryParams?: { [key: string]: string; };\r\n    sourceOptions?: { [key: string]: any; };\r\n    count?: number;\r\n    tooltipType?: TooltipType.ABSTRACT | TooltipType.TITLE;\r\n    sortDirection?: 'asc' | 'desc';\r\n    setCrossOriginAnonymous?: boolean;\r\n    showLegend?: boolean;\r\n    // ICatalog -----------------------------\r\n\r\n    protected catalogService: CatalogService;\r\n\r\n    constructor(options: Catalog, service: CatalogService) {\r\n        Object.assign(this, options);\r\n        this.catalogService = service;\r\n    }\r\n\r\n    public abstract collectCatalogItems(): Observable<CatalogItem[]>;\r\n}\r\n\r\nclass WMSCatalog extends Catalog {\r\n    constructor(options: Catalog, service: CatalogService) {\r\n        super(options, service);\r\n        const sType: string = TypeCatalog[TypeCatalog.wms];\r\n        this.type = TypeCatalog[sType];\r\n    }\r\n\r\n    public collectCatalogItems(): Observable<CatalogItem[]> {\r\n        return this.catalogService.loadCatalogWMSLayerItems(this);\r\n    }\r\n}\r\n\r\nclass WMTSCatalog extends Catalog {\r\n    constructor(options: Catalog, service: CatalogService) {\r\n        super(options, service);\r\n        const sType: string = TypeCatalog[TypeCatalog.wmts];\r\n        this.type = TypeCatalog[sType];\r\n    }\r\n\r\n    public collectCatalogItems(): Observable<CatalogItem[]> {\r\n        return this.catalogService.loadCatalogWMTSLayerItems(this);\r\n    }\r\n}\r\n\r\nclass BaselayersCatalog extends Catalog {\r\n    constructor(options: Catalog, service: CatalogService) {\r\n        super(options, service);\r\n        const sType: string = TypeCatalog[TypeCatalog.baselayers];\r\n        this.type = TypeCatalog[sType];\r\n    }\r\n\r\n    public collectCatalogItems(): Observable<CatalogItemGroup[]> {\r\n        return this.catalogService.loadCatalogBaseLayerItems(this);\r\n    }\r\n}\r\n\r\nclass ArcGISRestCatalog extends Catalog {\r\n    constructor(options: Catalog, service: CatalogService) {\r\n        super(options, service);\r\n        const sType: string = TypeCatalog[TypeCatalog.arcgisrest];\r\n        this.type = TypeCatalog[sType];\r\n    }\r\n\r\n    public collectCatalogItems() {\r\n        return this.catalogService.loadCatalogArcGISRestItems(this);\r\n    }\r\n}\r\n\r\nclass TileOrImageArcGISRestCatalog extends Catalog {\r\n    constructor(options: Catalog, service: CatalogService, typeCatalog: TypeCatalog) {\r\n        super(options, service);\r\n        this.type = TypeCatalog[TypeCatalog[typeCatalog]];\r\n    }\r\n\r\n    public collectCatalogItems() {\r\n        return this.catalogService.loadCatalogArcGISRestItems(this);\r\n    }\r\n}\r\n\r\nexport class CompositeCatalog extends Catalog implements ICompositeCatalog {\r\n    composite: ICatalog[];\r\n\r\n    constructor(options: Catalog, service: CatalogService) {\r\n        super(options, service);\r\n        const sType: string = TypeCatalog[TypeCatalog.composite];\r\n        this.type = TypeCatalog[sType];\r\n        this.url = null;\r\n    }\r\n\r\n    public collectCatalogItems(): Observable<CatalogItem[]> {\r\n        return this.catalogService.loadCatalogCompositeLayerItems(this);\r\n    }\r\n}\r\n\r\nexport class CatalogFactory {\r\n\r\n    public static createInstanceCatalog(options: Catalog, service: CatalogService): Catalog {\r\n\r\n        let catalog: Catalog;\r\n        if (options.hasOwnProperty('composite')) {\r\n            catalog = new CompositeCatalog(options, service);\r\n        } else if (options.type === TypeCatalog[TypeCatalog.baselayers]) {\r\n            catalog = new BaselayersCatalog(options, service);\r\n        } else if (options.type === TypeCatalog[TypeCatalog.arcgisrest]) {\r\n            catalog = new ArcGISRestCatalog(options, service);\r\n        } else if (options.type === TypeCatalog[TypeCatalog.tilearcgisrest]) {\r\n            catalog = new TileOrImageArcGISRestCatalog(options, service, TypeCatalog.tilearcgisrest);\r\n        } else if (options.type === TypeCatalog[TypeCatalog.imagearcgisrest]) {\r\n            catalog = new TileOrImageArcGISRestCatalog(options, service, TypeCatalog.imagearcgisrest);\r\n        } else if (options.type === TypeCatalog[TypeCatalog.wmts]) {\r\n            catalog = new WMTSCatalog(options, service);\r\n        } else {\r\n            catalog = new WMSCatalog(options, service);\r\n        }\r\n\r\n        return catalog;\r\n    }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { Observable, of } from 'rxjs';\r\nimport { map, mergeMap } from 'rxjs/operators';\r\n\r\nimport * as striptags_ from 'striptags';\r\n\r\nimport * as olformat from 'ol/format';\r\nimport * as olextent from 'ol/extent';\r\nimport olFormatGML2 from 'ol/format/GML2';\r\nimport olFormatGML3 from 'ol/format/GML3';\r\nimport olFormatEsriJSON from 'ol/format/EsriJSON';\r\nimport olFeature from 'ol/Feature';\r\nimport * as olgeom from 'ol/geom';\r\n\r\nimport { LanguageService, MessageService } from '@igo2/core';\r\nimport { uuid } from '@igo2/utils';\r\nimport { Feature, FeatureGeometry } from '../../feature/shared/feature.interfaces';\r\nimport { FEATURE } from '../../feature/shared/feature.enums';\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport {\r\n  WMSDataSource,\r\n  CartoDataSource,\r\n  TileArcGISRestDataSource,\r\n  WMSDataSourceOptions,\r\n  ImageArcGISRestDataSource\r\n} from '../../datasource';\r\n\r\nimport {\r\n  QueryFormat,\r\n  QueryFormatMimeType,\r\n  QueryHtmlTarget\r\n} from './query.enums';\r\nimport {\r\n  QueryOptions,\r\n  QueryableDataSource,\r\n  QueryableDataSourceOptions\r\n} from './query.interfaces';\r\nimport { MapExtent } from '../../map/shared/map.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class QueryService {\r\n  public queryEnabled = true;\r\n  public defaultFeatureCount = 20; // default feature count\r\n  public featureCount = 20; // feature count\r\n\r\n  private previousMessageIds = [];\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private messageService: MessageService,\r\n    private languageService: LanguageService) {}\r\n\r\n  query(layers: Layer[], options: QueryOptions): Observable<Feature[]>[] {\r\n    if (this.previousMessageIds.length) {\r\n      this.previousMessageIds.forEach(id => {\r\n        this.messageService.remove(id);\r\n      });\r\n    }\r\n    return layers\r\n      .filter((layer: Layer) => layer.visible && layer.isInResolutionsRange)\r\n      .map((layer: Layer) => this.queryLayer(layer, options));\r\n  }\r\n\r\n  queryLayer(layer: Layer, options: QueryOptions): Observable<Feature[]> {\r\n    const url = this.getQueryUrl(layer.dataSource, options, false, layer.map.viewController.getExtent());\r\n    if (!url) {\r\n      return of([]);\r\n    }\r\n\r\n    if (\r\n      (layer.dataSource as QueryableDataSource).options.queryFormat ===\r\n      QueryFormat.HTMLGML2\r\n    ) {\r\n      const urlGml = this.getQueryUrl(layer.dataSource, options, true);\r\n      return this.http.get(urlGml, { responseType: 'text' }).pipe(\r\n        mergeMap(gmlRes => {\r\n          const mergedGML = this.mergeGML(gmlRes, url, layer);\r\n          const imposedGeom = mergedGML[0];\r\n          const imposedProperties = mergedGML[1];\r\n          return this.http\r\n            .get(url, { responseType: 'text' })\r\n            .pipe(\r\n              map(res =>\r\n                this.extractData(res, layer, options, url, imposedGeom, imposedProperties)\r\n              )\r\n            );\r\n        })\r\n      );\r\n    }\r\n\r\n    const request = this.http.get(url, { responseType: 'text' });\r\n    return request.pipe(map(res => this.extractData(res, layer, options, url)));\r\n  }\r\n\r\n  private mergeGML(gmlRes, url, layer: Layer): [FeatureGeometry, { [key: string]: any }] {\r\n    const parser = new olFormatGML2();\r\n    let features = parser.readFeatures(gmlRes);\r\n    // Handle non standard GML output (MapServer)\r\n    if (features.length === 0) {\r\n      const wmsParser = new olformat.WMSGetFeatureInfo();\r\n      features = wmsParser.readFeatures(gmlRes);\r\n    }\r\n    const olmline = new olgeom.MultiLineString([]);\r\n    let pts;\r\n    const ptsArray = [];\r\n    let olmpoly = new olgeom.MultiPolygon([]);\r\n    let firstFeatureType;\r\n    const nbFeatures = features.length;\r\n\r\n    // Check if geometry intersect bbox\r\n    // for geoserver getfeatureinfo response in data projection, not call projection\r\n    const searchParams: any = this.getQueryParams(url.toLowerCase());\r\n    const bboxRaw = searchParams.bbox;\r\n    const bbox = bboxRaw.split(',');\r\n    const bboxExtent = olextent.createEmpty();\r\n    olextent.extend(bboxExtent, bbox);\r\n    const outBboxExtent = false;\r\n    let titleContent;\r\n    let queryTileField;\r\n    if (layer.options?.source?.options) {\r\n      const dataSourceOptions = layer.options.source\r\n        .options as QueryableDataSourceOptions;\r\n      if (dataSourceOptions.queryTitle) {\r\n        queryTileField = dataSourceOptions.queryTitle;\r\n      }\r\n    }\r\n    features.map(feature => {\r\n\r\n      if (queryTileField) {\r\n        let queryTitleContent = feature.getProperties()[queryTileField];\r\n        if (queryTitleContent) {\r\n          titleContent = !titleContent ? queryTitleContent : `${titleContent},${queryTitleContent}`;\r\n        }\r\n      }\r\n      /*  if (!feature.getGeometry().simplify(100).intersectsExtent(bboxExtent)) {\r\n        outBboxExtent = true;\r\n        // TODO: Check to project the geometry?\r\n      }*/\r\n      const featureGeometryCoordinates = feature.getGeometry().getCoordinates();\r\n      const featureGeometryType = feature.getGeometry().getType();\r\n\r\n      if (!firstFeatureType && !outBboxExtent) {\r\n        firstFeatureType = featureGeometryType;\r\n      }\r\n      if (!outBboxExtent) {\r\n        switch (featureGeometryType) {\r\n          case 'Point':\r\n            if (nbFeatures === 1) {\r\n              pts = new olgeom.Point(featureGeometryCoordinates, 'XY');\r\n            } else {\r\n              ptsArray.push(featureGeometryCoordinates);\r\n            }\r\n            break;\r\n          case 'LineString':\r\n            olmline.appendLineString(\r\n              new olgeom.LineString(featureGeometryCoordinates, 'XY')\r\n            );\r\n            break;\r\n          case 'Polygon':\r\n            olmpoly.appendPolygon(\r\n              new olgeom.Polygon(featureGeometryCoordinates, 'XY')\r\n            );\r\n            break;\r\n          case 'MultiPolygon':\r\n            olmpoly = new olgeom.MultiPolygon(featureGeometryCoordinates, 'XY');\r\n            break;\r\n          default:\r\n            return;\r\n        }\r\n      }\r\n    });\r\n\r\n    let olmpts;\r\n    if (ptsArray.length === 0 && pts) {\r\n      olmpts = {\r\n        type: pts.getType(),\r\n        coordinates: pts.getCoordinates()\r\n      };\r\n    } else {\r\n      olmpts = {\r\n        type: 'Polygon',\r\n        coordinates: [this.convexHull(ptsArray)]\r\n      };\r\n    }\r\n\r\n    let returnGeometry;\r\n    switch (firstFeatureType) {\r\n      case 'LineString':\r\n        returnGeometry = {\r\n          type: olmline.getType(),\r\n          coordinates: olmline.getCoordinates()\r\n        };\r\n      case 'Point':\r\n        returnGeometry = olmpts;\r\n      case 'Polygon':\r\n        returnGeometry = {\r\n          type: olmpoly.getType(),\r\n          coordinates: olmpoly.getCoordinates()\r\n        };\r\n      case 'MultiPolygon':\r\n        returnGeometry = {\r\n          type: olmpoly.getType(),\r\n          coordinates: olmpoly.getCoordinates()\r\n        };\r\n    }\r\n    const imposedProperties = {};\r\n\r\n    if (queryTileField) {\r\n      imposedProperties[queryTileField] = titleContent;\r\n    }\r\n\r\n    return [ returnGeometry, imposedProperties];\r\n\r\n\r\n  }\r\n\r\n  cross(a, b, o) {\r\n    return (a[0] - o[0]) * (b[1] - o[1]) - (a[1] - o[1]) * (b[0] - o[0]);\r\n  }\r\n\r\n  /**\r\n   * @param points An array of [X, Y] coordinates\r\n   * This method is use instead of turf.js convexHull because Turf needs at least 3 point to make a hull.\r\n   * https://en.wikibooks.org/wiki/Algorithm_Implementation/Geometry/Convex_hull/Monotone_chain#JavaScript\r\n   */\r\n  convexHull(points) {\r\n    points.sort((a, b) => {\r\n      return a[0] === b[0] ? a[1] - b[1] : a[0] - b[0];\r\n    });\r\n\r\n    const lower = [];\r\n    for (const point of points) {\r\n      while (\r\n        lower.length >= 2 &&\r\n        this.cross(lower[lower.length - 2], lower[lower.length - 1], point) <= 0\r\n      ) {\r\n        lower.pop();\r\n      }\r\n      lower.push(point);\r\n    }\r\n\r\n    const upper = [];\r\n    for (let i = points.length - 1; i >= 0; i--) {\r\n      while (\r\n        upper.length >= 2 &&\r\n        this.cross(\r\n          upper[upper.length - 2],\r\n          upper[upper.length - 1],\r\n          points[i]\r\n        ) <= 0\r\n      ) {\r\n        upper.pop();\r\n      }\r\n      upper.push(points[i]);\r\n    }\r\n\r\n    upper.pop();\r\n    lower.pop();\r\n    return lower.concat(upper);\r\n  }\r\n\r\n  private extractData(\r\n    res,\r\n    layer: Layer,\r\n    options: QueryOptions,\r\n    url: string,\r\n    imposedGeometry?,\r\n    imposedProperties?: { [key: string]: any }\r\n  ): Feature[] {\r\n    const queryDataSource = layer.dataSource as QueryableDataSource;\r\n\r\n    const allowedFieldsAndAlias = this.getAllowedFieldsAndAlias(layer);\r\n    let features = [];\r\n    switch (queryDataSource.options.queryFormat) {\r\n      case QueryFormat.GML3:\r\n        features = this.extractGML3Data(\r\n          res,\r\n          layer.zIndex,\r\n          allowedFieldsAndAlias\r\n        );\r\n        break;\r\n      case QueryFormat.JSON:\r\n      case QueryFormat.GEOJSON:\r\n      case QueryFormat.GEOJSON2:\r\n        features = this.extractGeoJSONData(res, layer.zIndex, allowedFieldsAndAlias);\r\n        break;\r\n      case QueryFormat.ESRIJSON:\r\n        features = this.extractEsriJSONData(res, layer.zIndex, allowedFieldsAndAlias);\r\n        break;\r\n      case QueryFormat.TEXT:\r\n        features = this.extractTextData(res);\r\n        break;\r\n      case QueryFormat.HTML:\r\n        features = this.extractHtmlData(\r\n          res,\r\n          queryDataSource.queryHtmlTarget,\r\n          url\r\n        );\r\n        break;\r\n      case QueryFormat.HTMLGML2:\r\n        features = this.extractHtmlData(\r\n          res,\r\n          queryDataSource.queryHtmlTarget,\r\n          url,\r\n          imposedGeometry,\r\n          imposedProperties\r\n        );\r\n        break;\r\n      case QueryFormat.GML2:\r\n      default:\r\n        features = this.extractGML2Data(res, layer, allowedFieldsAndAlias);\r\n        break;\r\n    }\r\n\r\n    if (features.length > 0 && features[0].geometry === null) {\r\n      const geomToAdd = this.createGeometryFromUrlClick(url);\r\n\r\n      for (const feature of features) {\r\n        feature.geometry = geomToAdd;\r\n      }\r\n    }\r\n\r\n    const wmsDatasource = layer.dataSource as WMSDataSource;\r\n    const featureCount = wmsDatasource.params?.FEATURE_COUNT ?\r\n      new RegExp('FEATURE_COUNT=' + this.featureCount) :\r\n      new RegExp('FEATURE_COUNT=' + this.defaultFeatureCount);\r\n\r\n    if (\r\n      featureCount.test(url) &&\r\n      ((wmsDatasource.params?.FEATURE_COUNT && features.length === this.featureCount) ||\r\n      (!wmsDatasource.params?.FEATURE_COUNT && features.length === this.defaultFeatureCount))) {\r\n      this.languageService.translate.get('igo.geo.query.featureCountMax', {value: layer.title}).subscribe(message => {\r\n        const messageObj = this.messageService.info(message);\r\n        this.previousMessageIds.push(messageObj.toastId);\r\n      });\r\n    }\r\n\r\n    return features.map((feature: Feature, index: number) => {\r\n      const mapLabel = feature.properties[queryDataSource.mapLabel];\r\n\r\n      let exclude;\r\n      if (layer.options.sourceOptions?.type === 'wms') {\r\n        const sourceOptions = layer.options\r\n          .sourceOptions as WMSDataSourceOptions;\r\n        exclude = sourceOptions ? sourceOptions.excludeAttribute : undefined;\r\n      }\r\n\r\n      let title = this.getQueryTitle(feature, layer);\r\n      if (!title && features.length > 1) {\r\n        title = `${layer.title} (${index + 1})`;\r\n      } else if (!title) {\r\n        title = layer.title;\r\n      }\r\n\r\n      const meta = Object.assign({}, feature.meta || {}, {\r\n        id: uuid(),\r\n        title,\r\n        mapTitle: mapLabel,\r\n        sourceTitle: layer.title,\r\n        order: 1000 - layer.zIndex,\r\n        excludeAttribute: exclude\r\n      });\r\n\r\n      return Object.assign(feature, {\r\n        meta,\r\n        projection:\r\n          queryDataSource.options.type === 'carto'\r\n            ? 'EPSG:4326'\r\n            : options.projection\r\n      });\r\n    });\r\n  }\r\n\r\n  private createGeometryFromUrlClick(url) {\r\n    const searchParams: any = this.getQueryParams(url.toLowerCase());\r\n    const bboxRaw = searchParams.bbox;\r\n    const width = parseInt(searchParams.width, 10);\r\n    const height = parseInt(searchParams.height, 10);\r\n    const xPosition = parseInt(searchParams.i || searchParams.x, 10);\r\n    const yPosition = parseInt(searchParams.j || searchParams.y, 10);\r\n\r\n    const bbox = bboxRaw.split(',');\r\n    let threshold =\r\n      (Math.abs(parseFloat(bbox[0])) - Math.abs(parseFloat(bbox[2]))) * 0.05;\r\n\r\n    // for context in degree (EPSG:4326,4269...)\r\n    if (Math.abs(parseFloat(bbox[0])) < 180) {\r\n      threshold = 0.045;\r\n    }\r\n    const clickx =\r\n      parseFloat(bbox[0]) +\r\n      (Math.abs(parseFloat(bbox[0]) - parseFloat(bbox[2])) * xPosition) /\r\n        width -\r\n      threshold;\r\n    const clicky =\r\n      parseFloat(bbox[1]) +\r\n      (Math.abs(parseFloat(bbox[1]) - parseFloat(bbox[3])) * yPosition) /\r\n        height -\r\n      threshold;\r\n    const clickx1 = clickx + threshold * 2;\r\n    const clicky1 = clicky + threshold * 2;\r\n\r\n    const wktPoly =\r\n      'POLYGON((' +\r\n      clickx +\r\n      ' ' +\r\n      clicky +\r\n      ', ' +\r\n      clickx +\r\n      ' ' +\r\n      clicky1 +\r\n      ', ' +\r\n      clickx1 +\r\n      ' ' +\r\n      clicky1 +\r\n      ', ' +\r\n      clickx1 +\r\n      ' ' +\r\n      clicky +\r\n      ', ' +\r\n      clickx +\r\n      ' ' +\r\n      clicky +\r\n      '))';\r\n\r\n    const format = new olformat.WKT();\r\n    const tenPercentWidthGeom = format.readFeature(wktPoly);\r\n    const f = tenPercentWidthGeom.getGeometry() as any;\r\n\r\n    const newGeom = {\r\n      type: f.getType(),\r\n      coordinates: f.getCoordinates()\r\n    };\r\n\r\n    return newGeom;\r\n  }\r\n\r\n  private extractGML2Data(res, zIndex, allowedFieldsAndAlias?) {\r\n    const parser = new olFormatGML2();\r\n    let features = parser.readFeatures(res);\r\n    // Handle non standard GML output (MapServer)\r\n    if (features.length === 0) {\r\n      const wmsParser = new olformat.WMSGetFeatureInfo();\r\n      try {\r\n        features = wmsParser.readFeatures(res);\r\n      } catch (e) {\r\n        console.warn(\r\n          'query.service: Multipolygons are badly managed in mapserver in GML2. Use another format.'\r\n        );\r\n      }\r\n    }\r\n\r\n    return features.map(feature =>\r\n      this.featureToResult(feature, zIndex, allowedFieldsAndAlias)\r\n    );\r\n  }\r\n\r\n  private extractGML3Data(res, zIndex, allowedFieldsAndAlias?) {\r\n    const parser = new olFormatGML3();\r\n    let features = [];\r\n    try {\r\n      features = parser.readFeatures(res);\r\n    } catch (e) {\r\n      console.warn('query.service: GML3 is not well supported');\r\n    }\r\n    return features.map(feature =>\r\n      this.featureToResult(feature, zIndex, allowedFieldsAndAlias)\r\n    );\r\n  }\r\n\r\n  private extractGeoJSONData(res, zIndex, allowedFieldsAndAlias?) {\r\n    let features = [];\r\n    try {\r\n      features = JSON.parse(res.replace(/(\\r|\\n)/g, ' ')).features;\r\n    } catch (e) {\r\n      console.warn('query.service: Unable to parse geojson', '\\n', res);\r\n    }\r\n    features.map(feature => feature.meta = {\r\n      id: uuid(),\r\n      order: 1000 - zIndex,\r\n      alias: allowedFieldsAndAlias\r\n    });\r\n    return features;\r\n  }\r\n\r\n  private extractEsriJSONData(res, zIndex, allowedFieldsAndAlias) {\r\n    if (res) {\r\n      try {\r\n        if (JSON.parse(res).error) {\r\n          return [];\r\n        }\r\n      } catch (e) {}\r\n    }\r\n    const parser = new olFormatEsriJSON();\r\n    const features = parser.readFeatures(res);\r\n\r\n    return features.map(feature => this.featureToResult(feature, zIndex, allowedFieldsAndAlias));\r\n  }\r\n\r\n  private extractTextData(res) {\r\n    // TODO\r\n    return [];\r\n  }\r\n\r\n  private extractHtmlData(\r\n    res,\r\n    htmlTarget: QueryHtmlTarget,\r\n    url,\r\n    imposedGeometry?,\r\n    imposedProperties?: { [key: string]: any }\r\n  ) {\r\n    const searchParams: any = this.getQueryParams(url.toLowerCase());\r\n    const projection = searchParams.crs || searchParams.srs || 'EPSG:3857';\r\n    const geomToAdd = this.createGeometryFromUrlClick(url);\r\n\r\n    if (\r\n      htmlTarget !== QueryHtmlTarget.BLANK &&\r\n      htmlTarget !== QueryHtmlTarget.IFRAME\r\n    ) {\r\n      htmlTarget = QueryHtmlTarget.IFRAME;\r\n    }\r\n\r\n    const bodyTagStart = res.toLowerCase().indexOf('<body>');\r\n    const bodyTagEnd = res.toLowerCase().lastIndexOf('</body>') + 7;\r\n    // replace \\r \\n  and ' ' with '' to validate if the body is really empty. Clear all the html tags from body\r\n    const striptags = striptags_;\r\n    const body = striptags(res.slice(bodyTagStart, bodyTagEnd).replace(/(\\r|\\n|\\s)/g, ''));\r\n    if (body === '' || res === '') {\r\n      return [];\r\n    }\r\n\r\n    return [\r\n      {\r\n        type: FEATURE,\r\n        projection,\r\n        properties: Object.assign({ target: htmlTarget, body: res, url }, imposedProperties),\r\n        geometry: imposedGeometry || geomToAdd\r\n      }\r\n    ];\r\n  }\r\n\r\n  private getQueryParams(url) {\r\n    const queryString = url.split('?');\r\n    if (!queryString[1]) {\r\n      return;\r\n    }\r\n    const pairs = queryString[1].split('&');\r\n\r\n    const result = {};\r\n    pairs.forEach(pair => {\r\n      pair = pair.split('=');\r\n      result[pair[0]] = decodeURIComponent(pair[1] || '');\r\n    });\r\n    return result;\r\n  }\r\n\r\n  public featureToResult(\r\n    featureOL: olFeature<olgeom.Geometry>,\r\n    zIndex: number,\r\n    allowedFieldsAndAlias?\r\n  ): Feature {\r\n    const featureGeometry = featureOL.getGeometry() as any;\r\n    const properties: any = Object.assign({}, featureOL.getProperties());\r\n    delete properties.geometry;\r\n    delete properties.GEOMETRIE;\r\n    delete properties.boundedBy;\r\n    delete properties.shape;\r\n    delete properties.SHAPE;\r\n    delete properties.the_geom;\r\n    delete properties.geom;\r\n\r\n    let geometry;\r\n    if (featureGeometry) {\r\n      geometry = {\r\n        type: featureGeometry.getType(),\r\n        coordinates: featureGeometry.getCoordinates()\r\n      };\r\n    }\r\n\r\n    return {\r\n      type: FEATURE,\r\n      projection: undefined,\r\n      properties,\r\n      geometry,\r\n      meta: {\r\n        id: uuid(),\r\n        order: 1000 - zIndex,\r\n        alias: allowedFieldsAndAlias\r\n      }\r\n    };\r\n  }\r\n\r\n  private getQueryUrl(\r\n    datasource: QueryableDataSource,\r\n    options: QueryOptions,\r\n    forceGML2 = false,\r\n    mapExtent?: MapExtent\r\n  ): string {\r\n    let url;\r\n\r\n    if (datasource.options.queryUrl) {\r\n      return this.getCustomQueryUrl(datasource, options, mapExtent);\r\n    }\r\n\r\n    switch (datasource.constructor) {\r\n      case WMSDataSource:\r\n        const wmsDatasource = datasource as WMSDataSource;\r\n\r\n        const WMSGetFeatureInfoOptions = {\r\n          INFO_FORMAT:\r\n            wmsDatasource.params.INFO_FORMAT ||\r\n            this.getMimeInfoFormat(datasource.options.queryFormat),\r\n          QUERY_LAYERS: wmsDatasource.params.LAYERS,\r\n          FEATURE_COUNT: wmsDatasource.params.FEATURE_COUNT || this.defaultFeatureCount\r\n        };\r\n\r\n        if (wmsDatasource.params.FEATURE_COUNT) {\r\n          this.featureCount = wmsDatasource.params.FEATURE_COUNT;\r\n        }\r\n\r\n        if (forceGML2) {\r\n          WMSGetFeatureInfoOptions.INFO_FORMAT = this.getMimeInfoFormat(\r\n            QueryFormat.GML2\r\n          );\r\n        }\r\n\r\n        url = wmsDatasource.ol.getFeatureInfoUrl(\r\n          options.coordinates,\r\n          options.resolution,\r\n          options.projection,\r\n          WMSGetFeatureInfoOptions\r\n        );\r\n        // const wmsVersion =\r\n        //   wmsDatasource.params.VERSION ||\r\n        //   wmsDatasource.params.version ||\r\n        //   '1.3.0';\r\n        // if (wmsVersion !== '1.3.0') {\r\n        //   url = url.replace('&I=', '&X=');\r\n        //   url = url.replace('&J=', '&Y=');\r\n        // }\r\n        break;\r\n      case CartoDataSource:\r\n        const cartoDatasource = datasource as CartoDataSource;\r\n        const baseUrl =\r\n          'https://' +\r\n          cartoDatasource.options.account +\r\n          '.carto.com/api/v2/sql?';\r\n        const format = 'format=GeoJSON';\r\n        const sql =\r\n          '&q=' + cartoDatasource.options.config.layers[0].options.sql;\r\n        const clause =\r\n          ' WHERE ST_Intersects(the_geom_webmercator,ST_BUFFER(ST_SetSRID(ST_POINT(';\r\n        const meters = cartoDatasource.options.queryPrecision\r\n          ? cartoDatasource.options.queryPrecision\r\n          : '1000';\r\n        const coordinates =\r\n          options.coordinates[0] +\r\n          ',' +\r\n          options.coordinates[1] +\r\n          '),3857),' +\r\n          meters +\r\n          '))';\r\n\r\n        url = `${baseUrl}${format}${sql}${clause}${coordinates}`;\r\n        break;\r\n      case ImageArcGISRestDataSource:\r\n      case TileArcGISRestDataSource:\r\n        const tileArcGISRestDatasource = datasource as TileArcGISRestDataSource;\r\n        const deltaX = Math.abs(mapExtent[0] - mapExtent[2]);\r\n        const deltaY = Math.abs(mapExtent[1] - mapExtent[3]);\r\n        const maxDelta = deltaX > deltaY ? deltaX : deltaY;\r\n        const clickBuffer = maxDelta * 0.005;\r\n        const threshold = tileArcGISRestDatasource.options.queryPrecision ? tileArcGISRestDatasource.options.queryPrecision : clickBuffer;\r\n        const extent = olextent.buffer(\r\n          olextent.boundingExtent([options.coordinates]),\r\n          threshold\r\n        );\r\n        const serviceUrl =\r\n          tileArcGISRestDatasource.options.url +\r\n          '/' +\r\n          tileArcGISRestDatasource.options.layer +\r\n          '/query/';\r\n        const geometry = encodeURIComponent(\r\n          '{\"xmin\":' +\r\n            extent[0] +\r\n            ',\"ymin\":' +\r\n            extent[1] +\r\n            ',\"xmax\":' +\r\n            extent[2] +\r\n            ',\"ymax\":' +\r\n            extent[3] +\r\n            ',\"spatialReference\":{\"wkid\":102100}}'\r\n        );\r\n        const params = [\r\n          'f=json',\r\n          `geometry=${geometry}`,\r\n          'geometryType=esriGeometryEnvelope',\r\n          'inSR=102100',\r\n          'spatialRel=esriSpatialRelIntersects',\r\n          'outFields=*',\r\n          'returnGeometry=true',\r\n          'outSR=102100'\r\n        ];\r\n        url = `${serviceUrl}?${params.join('&')}`;\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n\r\n    return url;\r\n  }\r\n\r\n  private getMimeInfoFormat(queryFormat: string) {\r\n    let mime = 'application/vnd.ogc.gml';\r\n    const keyEnum = Object.keys(QueryFormat).find(\r\n      key => QueryFormat[key] === queryFormat\r\n    );\r\n    if (keyEnum) {\r\n      mime = QueryFormatMimeType[keyEnum];\r\n    }\r\n\r\n    return mime;\r\n  }\r\n\r\n  getAllowedFieldsAndAlias(layer: any) {\r\n    let allowedFieldsAndAlias;\r\n    if (\r\n      layer.options?.source?.options?.sourceFields &&\r\n      layer.options.source.options.sourceFields.length >= 1\r\n    ) {\r\n      allowedFieldsAndAlias = {};\r\n      layer.options.source.options.sourceFields.forEach(sourceField => {\r\n        const alias = sourceField.alias ? sourceField.alias : sourceField.name;\r\n        allowedFieldsAndAlias[sourceField.name] = alias;\r\n      });\r\n    }\r\n    return allowedFieldsAndAlias;\r\n  }\r\n\r\n  getQueryTitle(feature: Feature, layer: Layer): string {\r\n    let title;\r\n    if (layer.options?.source?.options) {\r\n      const dataSourceOptions = layer.options.source\r\n        .options as QueryableDataSourceOptions;\r\n      if (dataSourceOptions.queryTitle) {\r\n        title = this.getLabelMatch(feature, dataSourceOptions.queryTitle);\r\n      }\r\n    }\r\n\r\n    return title;\r\n  }\r\n\r\n  getLabelMatch(feature: Feature, labelMatch): string {\r\n    let label = labelMatch;\r\n    const labelToGet = Array.from(labelMatch.matchAll(/\\$\\{([^\\{\\}]+)\\}/g));\r\n\r\n    labelToGet.forEach(v => {\r\n      label = label.replace(v[0], feature.properties[v[1]]);\r\n    });\r\n\r\n    // Nothing done? check feature's attribute\r\n    if (labelToGet.length === 0 && label === labelMatch) {\r\n      label = feature.properties[labelMatch] || labelMatch;\r\n    }\r\n\r\n    return label;\r\n  }\r\n\r\n  /**\r\n   * @param datasource QueryableDataSource\r\n   * @param options QueryOptions\r\n   * @mapExtent extent of the map when click event\r\n   *\r\n   */\r\n\r\n  getCustomQueryUrl(\r\n    datasource: QueryableDataSource,\r\n    options: QueryOptions,\r\n    mapExtent?: MapExtent): string {\r\n\r\n      let url = datasource.options.queryUrl.replace(/\\{xmin\\}/g, mapExtent[0].toString())\r\n      .replace(/\\{ymin\\}/g, mapExtent[1].toString())\r\n      .replace(/\\{xmax\\}/g, mapExtent[2].toString())\r\n      .replace(/\\{ymax\\}/g, mapExtent[3].toString())\r\n      .replace(/\\{x\\}/g, options.coordinates[0].toString())\r\n      .replace(/\\{y\\}/g, options.coordinates[1].toString())\r\n      .replace(/\\{resolution\\}/g, options.resolution.toString())\r\n      .replace(/\\{srid\\}/g, options.projection.replace('EPSG:',''));\r\n\r\n      return url;\r\n    }\r\n}\r\n","import OlLayer from 'ol/layer/Layer';\r\nimport OlSource from 'ol/source/Source';\r\n\r\nimport { AnyLayer } from '../../layer/shared/layers/any-layer';\r\nimport { QueryableDataSource } from './query.interfaces';\r\n\r\n/**\r\n * Whether a layer is queryable\r\n * @param layer Layer\r\n * @returns True if the layer s squeryable\r\n */\r\nexport function layerIsQueryable(layer: AnyLayer): boolean {\r\n  const dataSource = layer.dataSource as QueryableDataSource;\r\n  return dataSource.options.queryable === true;\r\n}\r\n\r\n/**\r\n * Whether an OL layer is queryable\r\n * @param layer Layer\r\n * @returns True if the ol layer is queryable\r\n */\r\nexport function olLayerIsQueryable(olLayer: OlLayer<OlSource>): boolean {\r\n  const layer = olLayer.get('_layer');\r\n  return layer === undefined ? false : layerIsQueryable(layer);\r\n}\r\n\r\n/**\r\n * Whether a layer's feature is queryable\r\n * @param layer Layer\r\n * @returns True if the layer's feature is queryable\r\n */\r\nexport function layerFeatureIsQueryable(layer: AnyLayer): boolean {\r\n  const dataSource = layer.dataSource as QueryableDataSource;\r\n  return dataSource.options.queryLayerFeatures !== undefined ? (dataSource.options.queryLayerFeatures === true) : true;\r\n}\r\n\r\n/**\r\n * Whether an OL Vector layer is queryable\r\n * @param layer Layer\r\n * @returns True if the ol vector layer is queryable\r\n */\r\nexport function olLayerFeatureIsQueryable(olLayer: OlLayer<OlSource>): boolean {\r\n  const layer = olLayer.get('_layer');\r\n  return layer === undefined ? false : (layerIsQueryable(layer) && layerFeatureIsQueryable(layer));\r\n}\r\n","import {\r\n  Directive,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  OnDestroy,\r\n  AfterViewInit,\r\n  Self\r\n} from '@angular/core';\r\n\r\nimport { Subscription, Observable, of, zip } from 'rxjs';\r\nimport { unByKey } from 'ol/Observable';\r\n\r\nimport OlFeature from 'ol/Feature';\r\nimport OlRenderFeature from 'ol/render/Feature';\r\nimport OlLayer from 'ol/layer/Layer';\r\nimport OlSource from 'ol/source/Source';\r\nimport olVectorSource from 'ol/source/Vector';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport MapBrowserPointerEvent from 'ol/MapBrowserEvent';\r\nimport { EventsKey } from 'ol/events';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { MapBrowserComponent } from '../../map/map-browser/map-browser.component';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport { renderFeatureFromOl } from '../../feature/shared/feature.utils';\r\nimport { featureFromOl } from '../../feature/shared/feature.utils';\r\nimport { QueryService } from './query.service';\r\nimport { layerIsQueryable, olLayerFeatureIsQueryable } from './query.utils';\r\nimport { ctrlKeyDown } from '../../map/shared/map.utils';\r\nimport { OlDragSelectInteraction } from '../../feature/shared/strategies/selection';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { QueryableDataSourceOptions } from './query.interfaces';\r\n\r\n/**\r\n * This directive makes a map queryable with a click of with a drag box.\r\n * By default, all layers are queryable but this can ben controlled at\r\n * the layer level.\r\n */\r\n@Directive({\r\n  selector: '[igoQuery]'\r\n})\r\nexport class QueryDirective implements AfterViewInit, OnDestroy {\r\n  /**\r\n   * Subscriptions to ongoing queries\r\n   */\r\n  private queries$$: Subscription[] = [];\r\n\r\n  /**\r\n   * Listener to the map click event\r\n   */\r\n  private mapClickListener;\r\n\r\n  /**\r\n   * OL drag box interaction\r\n   */\r\n  private olDragSelectInteraction: OlDragSelectInteraction;\r\n\r\n  /**\r\n   * Ol drag box \"end\" event key\r\n   */\r\n  private olDragSelectInteractionEndKey: EventsKey | EventsKey[];\r\n\r\n  /**\r\n   * Whter to query features or not\r\n   */\r\n  @Input() queryFeatures: boolean = false;\r\n\r\n  /**\r\n   * Feature query hit tolerance\r\n   */\r\n  @Input() queryFeaturesHitTolerance: number = 0;\r\n\r\n  /**\r\n   * Feature query hit tolerance\r\n   */\r\n  @Input() queryFeaturesCondition: (olLayer: OlLayer<OlSource>) => boolean;\r\n\r\n  /**\r\n   * Whether all query should complete before emitting an event\r\n   */\r\n  @Input() waitForAllQueries: boolean = true;\r\n\r\n  /**\r\n   * Event emitted when a query (or all queries) complete\r\n   */\r\n  @Output() query = new EventEmitter<{\r\n    features: Feature[] | Feature[][];\r\n    event: MapBrowserPointerEvent<any>;\r\n  }>();\r\n\r\n  /**\r\n   * IGO map\r\n   * @internal\r\n   */\r\n  get map(): IgoMap {\r\n    return (this.component.map as any) as IgoMap;\r\n  }\r\n\r\n  constructor(\r\n    @Self() private component: MapBrowserComponent,\r\n    private queryService: QueryService\r\n  ) {}\r\n\r\n  /**\r\n   * Start listening to click and drag box events\r\n   * @internal\r\n   */\r\n  ngAfterViewInit() {\r\n    this.listenToMapClick();\r\n    this.addDragBoxInteraction();\r\n  }\r\n\r\n  /**\r\n   * Stop listening to click and drag box events and cancel ongoind requests\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.cancelOngoingQueries();\r\n    this.unlistenToMapClick();\r\n    this.removeDragBoxInteraction();\r\n  }\r\n\r\n  /**\r\n   * On map click, issue queries\r\n   */\r\n  private listenToMapClick() {\r\n    this.mapClickListener = this.map.ol.on(\r\n      'singleclick',\r\n      (event: MapBrowserPointerEvent<any>) => this.onMapEvent(event)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Stop listening for map clicks\r\n   */\r\n  private unlistenToMapClick() {\r\n    unByKey(this.mapClickListener);\r\n    this.mapClickListener = undefined;\r\n  }\r\n\r\n  /**\r\n   * Issue queries from a map event and emit events with the results\r\n   * @param event OL map browser pointer event\r\n   */\r\n  private onMapEvent(event: MapBrowserPointerEvent<any>) {\r\n    this.cancelOngoingQueries();\r\n    if (!this.queryService.queryEnabled) {\r\n      return;\r\n    }\r\n\r\n    const queries$ = [];\r\n    if (this.queryFeatures) {\r\n      queries$.push(this.doQueryFeatures(event));\r\n    }\r\n\r\n    const resolution = this.map.ol.getView().getResolution();\r\n    const queryLayers = this.map.layers.filter(layerIsQueryable);\r\n    queries$.push(\r\n      ...this.queryService.query(queryLayers, {\r\n        coordinates: event.coordinate as [number, number],\r\n        projection: this.map.projection,\r\n        resolution\r\n      })\r\n    );\r\n\r\n    if (queries$.length === 0) {\r\n      return;\r\n    }\r\n\r\n    if (this.waitForAllQueries) {\r\n      this.queries$$.push(\r\n        zip(...queries$).subscribe((results: Feature[][]) => {\r\n          const features = [].concat(...results);\r\n          this.query.emit({ features, event });\r\n        })\r\n      );\r\n    } else {\r\n      this.queries$$ = queries$.map((query$: Observable<Feature[]>) => {\r\n        return query$.subscribe((features: Feature[]) => {\r\n          this.query.emit({ features, event });\r\n        });\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Query features already present on the map\r\n   * @param event OL map browser pointer event\r\n   */\r\n  private doQueryFeatures(\r\n    event: MapBrowserPointerEvent<any>\r\n  ): Observable<Feature[]> {\r\n    const clickedFeatures = [];\r\n\r\n    if (event.type === 'singleclick') {\r\n      this.map.ol.forEachFeatureAtPixel(\r\n        event.pixel,\r\n        (featureOL: OlFeature<OlGeometry>, layerOL: any) => {\r\n          const layer = this.map.getLayerById(layerOL.values_._layer.id);\r\n          if ((layer.dataSource.options as QueryableDataSourceOptions).queryFormatAsWms) {\r\n            return;\r\n          }\r\n          if (featureOL) {\r\n            if (featureOL.get('features')) {\r\n              for (const feature of featureOL.get('features')) {\r\n                const newFeature = featureFromOl(feature, this.map.projection);\r\n                newFeature.meta = {\r\n                  title: feature.values_.nom,\r\n                  id: layerOL.values_._layer.id + '.' + feature.id_,\r\n                  icon: feature.values_._icon,\r\n                  sourceTitle: layerOL.values_.title,\r\n                  alias: this.queryService.getAllowedFieldsAndAlias(layer),\r\n                  // title: this.queryService.getQueryTitle(newFeature, layer) || newFeature.meta.title\r\n                };\r\n                clickedFeatures.push(newFeature);\r\n              }\r\n            } else if (featureOL instanceof OlRenderFeature) {\r\n              const newFeature = renderFeatureFromOl(\r\n                featureOL,\r\n                this.map.projection,\r\n                layerOL\r\n              );\r\n              newFeature.meta = {\r\n                id: layerOL.values_._layer.id + '.' + newFeature.meta.id,\r\n                sourceTitle: layerOL.values_.title,\r\n                alias: this.queryService.getAllowedFieldsAndAlias(layer),\r\n                title: this.queryService.getQueryTitle(newFeature, layer) || newFeature.meta.title\r\n              };\r\n              clickedFeatures.push(newFeature);\r\n            } else {\r\n              const newFeature = featureFromOl(\r\n                featureOL,\r\n                this.map.projection,\r\n                layerOL\r\n              );\r\n              newFeature.meta = {\r\n                id: layerOL.values_._layer.id + '.' + newFeature.meta.id,\r\n                sourceTitle: layerOL.values_.title,\r\n                alias: this.queryService.getAllowedFieldsAndAlias(layer),\r\n                title: this.queryService.getQueryTitle(newFeature, layer) || newFeature.meta.title\r\n              };\r\n              clickedFeatures.push(newFeature);\r\n            }\r\n          }\r\n        },\r\n        {\r\n          hitTolerance: this.queryFeaturesHitTolerance || 0,\r\n          layerFilter: this.queryFeaturesCondition\r\n            ? this.queryFeaturesCondition\r\n            : olLayerFeatureIsQueryable\r\n        }\r\n      );\r\n    } else if (event.type === 'boxend') {\r\n      const target = event.target as any;\r\n      const dragExtent = target.getGeometry().getExtent();\r\n      this.map.layers\r\n        .filter(layerIsQueryable)\r\n        .filter(layer => layer instanceof VectorLayer && layer.visible)\r\n        .map(layer => {\r\n          const featuresOL = layer.dataSource.ol as olVectorSource<OlGeometry>;\r\n          featuresOL.forEachFeatureIntersectingExtent(dragExtent, (olFeature: any) => {\r\n            const newFeature: Feature = featureFromOl(olFeature, this.map.projection, layer.ol);\r\n            newFeature.meta = {\r\n              id: layer.id + '.' + olFeature.getId(),\r\n              icon: olFeature.values_._icon,\r\n              sourceTitle: layer.title,\r\n              alias: this.queryService.getAllowedFieldsAndAlias(layer),\r\n              title: this.queryService.getQueryTitle(newFeature, layer) || newFeature.meta.title\r\n            };\r\n            clickedFeatures.push(newFeature);\r\n          });\r\n        });\r\n    }\r\n\r\n\r\n    return of(clickedFeatures);\r\n  }\r\n\r\n  /**\r\n   * Cancel ongoing requests, if any\r\n   */\r\n  private cancelOngoingQueries() {\r\n    this.queries$$.forEach((sub: Subscription) => sub.unsubscribe());\r\n    this.queries$$ = [];\r\n  }\r\n\r\n  /**\r\n   * Add a drag box interaction and, on drag box end, select features\r\n   */\r\n  private addDragBoxInteraction() {\r\n    let olDragSelectInteractionOnQuery;\r\n    const olInteractions = this.map.ol.getInteractions().getArray();\r\n\r\n    // There can only be one dragbox interaction, so find the current one, if any\r\n    // Don't keep a reference to the current dragbox because we don't want\r\n    // to remove it when this startegy is deactivated\r\n    for (const olInteraction of olInteractions) {\r\n      if (olInteraction instanceof OlDragSelectInteraction) {\r\n        olDragSelectInteractionOnQuery = olInteraction;\r\n        break;\r\n      }\r\n    }\r\n    // If no drag box interaction is found, create a new one and add it to the map\r\n    if (olDragSelectInteractionOnQuery === undefined) {\r\n      olDragSelectInteractionOnQuery = new OlDragSelectInteraction({\r\n        condition: ctrlKeyDown\r\n      });\r\n      this.map.ol.addInteraction(olDragSelectInteractionOnQuery);\r\n      this.olDragSelectInteraction = olDragSelectInteractionOnQuery;\r\n    }\r\n\r\n    this.olDragSelectInteractionEndKey = olDragSelectInteractionOnQuery.on(\r\n      'boxend',\r\n      (event: MapBrowserPointerEvent<any>) => this.onMapEvent(event)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Remove drag box interaction\r\n   */\r\n  private removeDragBoxInteraction() {\r\n    if (this.olDragSelectInteractionEndKey !== undefined) {\r\n      unByKey(this.olDragSelectInteractionEndKey);\r\n    }\r\n    if (this.olDragSelectInteraction !== undefined) {\r\n      this.map.ol.removeInteraction(this.olDragSelectInteraction);\r\n    }\r\n    this.olDragSelectInteraction = undefined;\r\n  }\r\n}\r\n","import { Observable } from 'rxjs';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\nimport { StorageService } from '@igo2/core';\r\nimport { SearchResult } from '../search.interfaces';\r\nimport {\r\n  SearchSourceOptions,\r\n  TextSearchOptions,\r\n  ReverseSearchOptions,\r\n  SearchSourceSettings\r\n} from './source.interfaces';\r\n\r\n/**\r\n * Base search source class\r\n */\r\nexport class SearchSource {\r\n  /**\r\n   * Search source ID\r\n   * @internal\r\n   */\r\n  static id = '';\r\n\r\n  /**\r\n   * Search source type\r\n   * @internal\r\n   */\r\n  static type = '';\r\n\r\n  /**\r\n   * Search source options\r\n   * @internal\r\n   */\r\n  protected options: SearchSourceOptions;\r\n\r\n  /**\r\n   * Get search source's id\r\n   * @returns Search source's id\r\n   */\r\n  getId(): string {\r\n    throw new Error('You have to implement the method \"getId\".');\r\n  }\r\n  /**\r\n   * Get search source's type\r\n   * @returns Search source's type\r\n   */\r\n  getType(): string {\r\n    throw new Error('You have to implement the method \"getType\".');\r\n  }\r\n\r\n  /**\r\n   * Get search source's default options\r\n   * @returns Search source default options\r\n   */\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    throw new Error('You have to implement the method \"getDefaultOptions\".');\r\n  }\r\n\r\n  /**\r\n   * Search source's title\r\n   */\r\n  get title(): string {\r\n    return this.options.title;\r\n  }\r\n\r\n  /**\r\n   * Whether the search source is available\r\n   */\r\n  get available(): boolean {\r\n    return this.options.available !== false;\r\n  }\r\n\r\n  /**\r\n   * Whether the search source is enabled\r\n   */\r\n  set enabled(value: boolean) {\r\n    this.options.enabled = value;\r\n  }\r\n  get enabled(): boolean {\r\n    return this.available && this.options.enabled !== false;\r\n  }\r\n\r\n  get showInPointerSummary(): boolean {\r\n    const showInPointerSummary = this.options.showInPointerSummary;\r\n    return showInPointerSummary ? showInPointerSummary : false;\r\n  }\r\n\r\n  get showInSettings(): boolean {\r\n    const showInSettings = this.options.showInSettings;\r\n    return showInSettings === undefined ? true : showInSettings;\r\n  }\r\n\r\n  /**\r\n   * Search url\r\n   */\r\n  get searchUrl(): string {\r\n    return this.options.searchUrl;\r\n  }\r\n\r\n  /**\r\n   * Search query params\r\n   */\r\n  get params(): { [key: string]: string } {\r\n    return this.options.params === undefined ? {} : this.options.params;\r\n  }\r\n\r\n  /**\r\n   * Search settings\r\n   */\r\n  get settings(): SearchSourceSettings[] {\r\n    return this.options.settings === undefined ? [] : this.options.settings;\r\n  }\r\n\r\n  /**\r\n   * Set params from selected settings\r\n   */\r\n  setParamFromSetting(setting: SearchSourceSettings, saveInStorage = true) {\r\n    switch (setting.type) {\r\n      case 'radiobutton':\r\n        setting.values.forEach(conf => {\r\n          if (conf.enabled) {\r\n            this.options.params = Object.assign(this.options.params || {}, {\r\n              [setting.name]: conf.value\r\n            });\r\n          }\r\n        });\r\n        break;\r\n      case 'checkbox':\r\n        let confValue = '';\r\n        setting.values\r\n          .filter(s => s.available !== false)\r\n          .forEach(conf => {\r\n            if (conf.enabled) {\r\n              confValue += conf.value + ',';\r\n            }\r\n          });\r\n        confValue = confValue.slice(0, -1);\r\n        this.options.params = Object.assign(this.options.params || {}, {\r\n          [setting.name]: confValue\r\n        });\r\n        break;\r\n    }\r\n\r\n    if (saveInStorage && this.storageService) {\r\n      this.storageService.set(\r\n        this.getId() + '.options',\r\n        {params: this.options.params}\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Search results display order\r\n   */\r\n  get displayOrder(): number {\r\n    return this.options.order === undefined ? 99 : this.options.order;\r\n  }\r\n\r\n  constructor(options: SearchSourceOptions, private storageService?: StorageService) {\r\n    this.options = options;\r\n    if (this.storageService) {\r\n      const storageOptions = this.storageService.get(\r\n        this.getId() + '.options'\r\n      ) as object;\r\n      if (storageOptions) {\r\n        this.options = ObjectUtils.mergeDeep(this.options, storageOptions);\r\n      }\r\n    }\r\n\r\n    this.options = ObjectUtils.mergeDeep(this.getDefaultOptions(), this.options);\r\n\r\n\r\n    // Set Default Params from Settings\r\n    this.settings.forEach(setting => {\r\n      this.setParamFromSetting(setting, false);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Get hashtags valid\r\n   * @param hashtag hashtag from query\r\n   */\r\n  getHashtagsValid(term: string, settingsName: string): string[] {\r\n    const hashtags = term.match(/(#[A-Za-z+]+)/g);\r\n    if (!hashtags) {\r\n      return undefined;\r\n    }\r\n\r\n    const searchSourceSetting = this.getSettingsValues(settingsName);\r\n    const hashtagsValid = [];\r\n    hashtags.forEach(hashtag => {\r\n      searchSourceSetting.values.forEach(conf => {\r\n        const hashtagKey = hashtag.substring(1);\r\n        if (typeof conf.value === 'string') {\r\n          const types = conf.value\r\n            .toLowerCase()\r\n            .normalize('NFD')\r\n            .replace(/[\\u0300-\\u036f]/g, '')\r\n            .split(',');\r\n          const index = types.indexOf(\r\n            hashtagKey\r\n              .toLowerCase()\r\n              .normalize('NFD')\r\n              .replace(/[\\u0300-\\u036f]/g, '')\r\n          );\r\n          if (index !== -1) {\r\n            hashtagsValid.push(types[index]);\r\n          }\r\n        }\r\n        if (conf.hashtags && conf.hashtags.indexOf(hashtagKey.toLowerCase()) !== -1) {\r\n          hashtagsValid.push(conf.value);\r\n        }\r\n      });\r\n    });\r\n\r\n    return hashtagsValid.filter((a, b) => hashtagsValid.indexOf(a) === b);\r\n  }\r\n\r\n  getSettingsValues(search: string): SearchSourceSettings {\r\n    return this.getDefaultOptions().settings.find(\r\n      (value: SearchSourceSettings) => {\r\n        return value.name === search;\r\n      }\r\n    );\r\n  }\r\n}\r\n\r\n/**\r\n * Search sources that allow searching by text implement this class\r\n */\r\nexport interface TextSearch {\r\n  /**\r\n   * Search by text\r\n   * @param term Text\r\n   * @param options Optional: TextSearchOptions\r\n   * @returns Observable or search results\r\n   */\r\n  search(\r\n    term: string | undefined,\r\n    options?: TextSearchOptions\r\n  ): Observable<SearchResult[]>;\r\n}\r\n\r\n/**\r\n * Search sources that allow searching by coordinates implement this class\r\n */\r\nexport interface ReverseSearch {\r\n  /**\r\n   * Search by text\r\n   * @param lonLat Coordinates\r\n   * @param options Optional: ReverseSearchOptions\r\n   * @returns Observable or search results\r\n   */\r\n  reverseSearch(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions\r\n  ): Observable<SearchResult[]>;\r\n}\r\n","import { Injectable, Inject } from '@angular/core';\r\n\r\nimport { FEATURE } from '../../feature/shared/feature.enums';\r\nimport { SearchSource } from '../../search/shared/sources/source';\r\nimport { SearchSourceOptions } from '../../search/shared/sources/source.interfaces';\r\n/**\r\n * Map search source. For now it has no search capability. All it does\r\n * is act as a placeholder for the map query results' \"search source\".\r\n */\r\n@Injectable()\r\nexport class QuerySearchSource extends SearchSource {\r\n  static id = 'map';\r\n  static type = FEATURE;\r\n\r\n  constructor(@Inject('options') options: SearchSourceOptions) {\r\n    super(options);\r\n  }\r\n\r\n  getId(): string {\r\n    return QuerySearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return QuerySearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    return {\r\n      title: 'Carte'\r\n    };\r\n  }\r\n}\r\n","export class GoogleLinks {\r\n  static getGoogleMapsCoordLink(lon, lat) {\r\n    return 'https://www.google.com/maps?q=' + lat + ',' + lon;\r\n  }\r\n\r\n  static getGoogleStreetViewLink(lon, lat) {\r\n    return 'https://www.google.com/maps?q=&layer=c&cbll=' + lat + ',' + lon;\r\n  }\r\n\r\n  static getGoogleMapsNameLink(name) {\r\n    const encodedName = encodeURI(name);\r\n    return 'https://www.google.com/maps?q=' + encodedName;\r\n  }\r\n}\r\n","import type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport * as olstyle from 'ol/style';\r\nimport olFeature from 'ol/Feature';\r\nimport { asArray as ColorAsArray } from 'ol/color';\r\n\r\nimport { createOverlayMarkerStyle } from '../overlay/shared/overlay-marker-style.utils';\r\nimport { createOverlayDefaultStyle } from '../overlay/shared/overlay.utils';\r\nimport { FeatureCommonVectorStyleOptions } from './commonVectorStyle.interface';\r\nimport { Feature } from '../feature';\r\n\r\n\r\n/**\r\n * Generate a style for selected features\r\n * @param feature The feature to generate the style\r\n * @returns A olStyle\r\n */\r\nexport function getCommonVectorSelectedStyle(\r\n  {\r\n    feature,\r\n    markerColor = [0, 161, 222],\r\n    markerOpacity = 1,\r\n    markerOutlineColor = [0, 255, 255],\r\n    fillColor,\r\n    fillOpacity = 0.15,\r\n    strokeColor = [0, 255, 255],\r\n    strokeOpacity = 0.5,\r\n    strokeWidth = 4\r\n  }: FeatureCommonVectorStyleOptions): olstyle.Style {\r\n\r\n  return getCommonVectorStyle({\r\n    feature,\r\n    markerColor,\r\n    markerOpacity,\r\n    markerOutlineColor,\r\n    fillColor,\r\n    fillOpacity,\r\n    strokeColor,\r\n    strokeOpacity,\r\n    strokeWidth\r\n  });\r\n}\r\n\r\n/**\r\n * Generate a basic style for features\r\n * @param feature The feature to generate the style\r\n * @returns A olStyle\r\n */\r\nexport function getCommonVectorStyle(\r\n  {\r\n    feature,\r\n    markerColor = [0, 161, 222],\r\n    markerOpacity = 0.5,\r\n    markerOutlineColor,\r\n    fillColor = [0, 161, 222],\r\n    fillOpacity = 0.15,\r\n    strokeColor = [0, 161, 222],\r\n    strokeOpacity = 0.5,\r\n    strokeWidth = 2\r\n  }: FeatureCommonVectorStyleOptions): olstyle.Style {\r\n\r\n  const isOlFeature = feature instanceof olFeature;\r\n  let geometry;\r\n  let text;\r\n  if (isOlFeature) {\r\n    feature = feature as olFeature<OlGeometry>;\r\n    geometry = feature.getGeometry();\r\n  } else {\r\n    feature = feature as Feature;\r\n    geometry = feature.geometry;\r\n    text = feature.meta.mapTitle;\r\n  }\r\n  const geometryType = isOlFeature ? geometry.getType() : geometry.type;\r\n\r\n  if (!geometry || geometryType === 'Point') {\r\n    const markerColorAsArray = ColorAsArray(markerColor).slice(0);\r\n    const markerColorRGB = markerColorAsArray.slice(0, 3);\r\n\r\n    if (markerColorAsArray.length === 4 &&\r\n        (typeof markerColor !== 'string' || /^#[0-9A-F]{8}$/i.test(markerColor as string))) {\r\n      markerOpacity = markerColorAsArray[3];\r\n    }\r\n\r\n    return createOverlayMarkerStyle({\r\n      text,\r\n      opacity: markerOpacity,\r\n      markerOutlineColor,\r\n      markerColor: markerColorRGB\r\n    });\r\n  } else {\r\n    const fillWithOpacity = ColorAsArray(fillColor).slice(0);\r\n    const strokeWithOpacity = ColorAsArray(strokeColor).slice(0);\r\n\r\n    if (!(fillWithOpacity.length === 4 &&\r\n        (typeof fillColor !== 'string' || /^#[0-9A-F]{8}$/i.test(fillColor as string)))) {\r\n      fillWithOpacity[3] = fillOpacity;\r\n    }\r\n\r\n    if (!(strokeWithOpacity.length === 4 &&\r\n        (typeof strokeColor !== 'string' || /^#[0-9A-F]{8}$/i.test(strokeColor as string)))) {\r\n      strokeWithOpacity[3] = strokeOpacity;\r\n    }\r\n\r\n    return createOverlayDefaultStyle({\r\n      text,\r\n      strokeWidth,\r\n      strokeColor: strokeWithOpacity,\r\n      fillColor: fillWithOpacity\r\n    });\r\n  }\r\n}\r\n","export class OsmLinks {\r\n  static getOpenStreetMapLink(lon, lat, zoom: number = 17) {\r\n    // return 'https://www.google.com/maps?q=' + lat + ',' + lon;\r\n    return `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}#map=${zoom}/${lat}/${lon}`;\r\n  }\r\n\r\n  static getOpenStreetCamLink(lon, lat, zoom: number = 17) {\r\n    return `https://openstreetcam.org/map/@${lat},${lon},${zoom}z`;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient, HttpErrorResponse } from '@angular/common/http';\r\nimport { EMPTY, Observable, of, zip } from 'rxjs';\r\nimport { map, catchError } from 'rxjs/operators';\r\n\r\nimport { uuid, ObjectUtils } from '@igo2/utils';\r\nimport { LanguageService, MessageService, ConfigService } from '@igo2/core';\r\nimport {\r\n  CapabilitiesService,\r\n  WMSDataSourceOptions,\r\n  WMSDataSourceOptionsParams,\r\n  WMTSDataSourceOptions,\r\n  ArcGISRestDataSourceOptions\r\n} from '../../datasource';\r\nimport { LayerOptions, ImageLayerOptions } from '../../layer';\r\nimport { getResolutionFromScale } from '../../map';\r\n\r\nimport {\r\n  CatalogItem,\r\n  CatalogItemLayer,\r\n  CatalogItemGroup,\r\n  ForcedProperty\r\n} from './catalog.interface';\r\nimport { Catalog, CatalogFactory, CompositeCatalog } from './catalog.abstract';\r\nimport { CatalogItemType, TypeCatalog } from './catalog.enum';\r\nimport { QueryFormat } from '../../query';\r\nimport { generateIdFromSourceOptions } from '../../utils';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class CatalogService {\r\n  constructor(\r\n    private http: HttpClient,\r\n    private config: ConfigService,\r\n    private languageService: LanguageService,\r\n    private messageService: MessageService,\r\n    private capabilitiesService: CapabilitiesService\r\n  ) {}\r\n\r\n  loadCatalogs(): Observable<Catalog[]> {\r\n    const contextConfig = this.config.getConfig('context') || {};\r\n    const catalogConfig = this.config.getConfig('catalog') || {};\r\n    const apiUrl = catalogConfig.url || contextConfig.url;\r\n    const catalogsFromConfig = catalogConfig.sources || [];\r\n\r\n    const observables$ = [];\r\n\r\n    if (apiUrl) {\r\n      // Base layers catalog\r\n      if (catalogConfig.baseLayers) {\r\n        const translate = this.languageService.translate;\r\n        const title = translate.instant('igo.geo.catalog.baseLayers');\r\n        const baseLayersCatalog = [\r\n          {\r\n            id: 'catalog.baselayers',\r\n            title,\r\n            url: `${apiUrl}/baselayers`,\r\n            type: 'baselayers'\r\n          }\r\n        ];\r\n        observables$.push(of(baseLayersCatalog));\r\n      }\r\n\r\n      // Catalogs from API\r\n      const catalogsFromApi$ = this.http\r\n        .get<Catalog[]>(`${apiUrl}/catalogs`)\r\n        .pipe(\r\n          map((catalogs) =>\r\n            catalogs.map((c: any) => Object.assign(c, c.options))\r\n          ),\r\n          catchError((_response: HttpErrorResponse) => EMPTY)\r\n        );\r\n      observables$.push(catalogsFromApi$);\r\n    }\r\n\r\n    // Catalogs from config\r\n    if (catalogsFromConfig.length > 0) {\r\n      observables$.push(\r\n        of(catalogsFromConfig).pipe(\r\n          map((catalogs: Catalog[]) =>\r\n            catalogs.map((c) => {\r\n              if (!c.id) {\r\n                c.id = uuid();\r\n              }\r\n              return c;\r\n            })\r\n          )\r\n        )\r\n      );\r\n    }\r\n\r\n    return zip(...observables$).pipe(\r\n      map((catalogs: Catalog[][]) => [].concat.apply([], catalogs))\r\n    ) as Observable<Catalog[]>;\r\n  }\r\n\r\n  loadCatalogItems(catalog: Catalog): Observable<CatalogItem[]> {\r\n    let newCatalog: Catalog;\r\n    newCatalog = CatalogFactory.createInstanceCatalog(catalog, this);\r\n    return newCatalog.collectCatalogItems();\r\n  }\r\n\r\n  loadCatalogBaseLayerItems(catalog: Catalog): Observable<CatalogItemGroup[]> {\r\n    return this.getCatalogBaseLayersOptions(catalog).pipe(\r\n      map((layersOptions: LayerOptions[]) => {\r\n        const items = layersOptions.map((layerOptions: LayerOptions) => {\r\n          return {\r\n            id: generateIdFromSourceOptions(layerOptions.sourceOptions),\r\n            title: layerOptions.title,\r\n            type: CatalogItemType.Layer,\r\n            externalProvider: catalog.externalProvider,\r\n            options: layerOptions\r\n          } as CatalogItemLayer;\r\n        });\r\n        return [\r\n          {\r\n            id: 'catalog.group.baselayers',\r\n            type: CatalogItemType.Group,\r\n            externalProvider: catalog.externalProvider,\r\n            title: catalog.title,\r\n            items\r\n          }\r\n        ];\r\n      })\r\n    );\r\n  }\r\n\r\n  private getCatalogBaseLayersOptions(\r\n    catalog: Catalog\r\n  ): Observable<LayerOptions[]> {\r\n    return this.http.get<LayerOptions[]>(catalog.url);\r\n  }\r\n\r\n  loadCatalogWMSLayerItems(catalog: Catalog): Observable<CatalogItem[]> {\r\n    return this.getCatalogCapabilities(catalog).pipe(\r\n      map((capabilities: any) => {\r\n        const items = [];\r\n        if (!capabilities) {\r\n          return items;\r\n        }\r\n        if (capabilities.Service && capabilities.Service.Abstract && capabilities.Service.Abstract.length) {\r\n          catalog.abstract = capabilities.Service.Abstract;\r\n        }\r\n        const finalLayers = [];\r\n        this.flattenWmsCapabilities(capabilities.Capability.Layer, 0, finalLayers, catalog.groupSeparator);\r\n        const capabilitiesCapabilityLayer = Object.assign({}, capabilities.Capability.Layer);\r\n        capabilitiesCapabilityLayer.Layer = finalLayers.filter(f => f.Layer.length !== 0);\r\n        this.includeRecursiveItems(\r\n          catalog,\r\n          capabilitiesCapabilityLayer,\r\n          items\r\n        );\r\n        return items;\r\n      })\r\n    );\r\n  }\r\n\r\n  flattenWmsCapabilities(parent, level = 0, finalLayers, separator = ' / ') {\r\n    if (!finalLayers.includes(parent.Title)) {\r\n        const modifiedParent = Object.assign({}, parent);\r\n        modifiedParent.Layer = [];\r\n        finalLayers.push(modifiedParent);\r\n    }\r\n    for (const layer of parent.Layer) {\r\n        const modifiedLayer = Object.assign({}, layer);\r\n        if (level > 0) {\r\n          modifiedLayer.Title = parent.Title + separator + layer.Title;\r\n        }\r\n        if (layer.Layer) {\r\n            this.flattenWmsCapabilities(modifiedLayer, level + 1, finalLayers, separator);\r\n        } else {\r\n            finalLayers.find(ff => ff.Title === parent.Title).Layer.push(layer);\r\n         }\r\n    }\r\n}\r\n\r\n  loadCatalogWMTSLayerItems(catalog: Catalog): Observable<CatalogItem[]> {\r\n    return this.getCatalogCapabilities(catalog).pipe(\r\n      map((capabilities: any) => this.getWMTSItems(catalog, capabilities))\r\n    );\r\n  }\r\n\r\n  loadCatalogArcGISRestItems(catalog: Catalog): Observable<CatalogItem[]> {\r\n    return this.getCatalogCapabilities(catalog).pipe(\r\n      map((capabilities: any) => {\r\n        return this.getArcGISRESTItems(catalog, capabilities);\r\n      })\r\n    );\r\n  }\r\n\r\n  loadCatalogCompositeLayerItems(catalog: Catalog): Observable<CatalogItem[]> {\r\n    const compositeCatalog = (catalog as CompositeCatalog).composite;\r\n\r\n    const catalogsFromInstance = [] as Catalog[];\r\n    compositeCatalog.map((component: Catalog) => {\r\n      component.sortDirection = catalog.sortDirection; // propagate sortDirection with parent value\r\n      catalogsFromInstance.push(\r\n        CatalogFactory.createInstanceCatalog(component, this)\r\n    );\r\n  }\r\n    );\r\n\r\n    // get CatalogItems for each original Catalog-----------------------------------------------------\r\n    const request1$ = [];\r\n    catalogsFromInstance.map((component: Catalog) =>\r\n      request1$.push(component.collectCatalogItems())\r\n    );\r\n\r\n    // integrate imposed group -----------------------------------------------------\r\n    let request2$ = [];\r\n\r\n    function flatDeepLayer(arr) {\r\n      return arr.reduce(\r\n        (acc, val) =>\r\n          acc.concat(\r\n            val.type === CatalogItemType.Group ? flatDeepLayer(val.items) : val\r\n          ),\r\n        []\r\n      );\r\n    }\r\n\r\n    if (\r\n      Object.keys(compositeCatalog).find((k) => compositeCatalog[k].groupImpose)\r\n    ) {\r\n      const pushImposeGroup = (item, index) => {\r\n        const c = catalogsFromInstance[index];\r\n        const outGroupImpose = Object.assign({}, c.groupImpose);\r\n        outGroupImpose.address = c.id;\r\n        outGroupImpose.type = CatalogItemType.Group;\r\n        outGroupImpose.externalProvider = c.externalProvider;\r\n        if (outGroupImpose.sortDirection === undefined) {\r\n          outGroupImpose.sortDirection = c.sortDirection;\r\n        }\r\n        outGroupImpose.items = [];\r\n\r\n        const flatLayer = flatDeepLayer(item);\r\n        flatLayer.map(\r\n          (v) => (v.address = `${outGroupImpose.address}.${outGroupImpose.id}`)\r\n        );\r\n        outGroupImpose.items = flatLayer;\r\n\r\n        return outGroupImpose;\r\n      };\r\n\r\n      request2$ = request1$.map((obs, idx) =>\r\n        obs.pipe(\r\n          map((items) =>\r\n            compositeCatalog[idx].groupImpose\r\n              ? pushImposeGroup(items, idx)\r\n              : items\r\n          )\r\n        )\r\n      );\r\n    } else {\r\n      request2$ = request1$;\r\n    }\r\n\r\n    // concat Group -----------------------------------------------------\r\n    const request3$ = zip(...request2$).pipe(\r\n      map(\r\n        (output: CatalogItem[]) => [].concat(...output) // [].concat.apply([], result1\r\n      )\r\n    );\r\n\r\n    // merge Group (first level only) -----------------------------------------------------\r\n    const groupByGroupId = (data, keyFn) =>\r\n      data.reduce((acc, group) => {\r\n        const groupId = keyFn(group);\r\n        const ind = acc.find((x) => x.id === groupId);\r\n\r\n        if (!ind) {\r\n          acc[acc.length] = group;\r\n        } else {\r\n          const ix = acc.indexOf(ind);\r\n          if (acc[ix].address.split('|').indexOf(group.address) === -1) {\r\n            acc[ix].address = `${acc[ix].address}|${group.address}`;\r\n          }\r\n          acc[ix].items.push(...group.items);\r\n        }\r\n        return acc;\r\n      }, []);\r\n\r\n    // merge Layer for each Level (catalog, group(recursive))\r\n    const recursiveGroupByLayerAddress = (items, keyFn) =>\r\n      items.reduce((acc, item, idx, arr) => {\r\n        const layerTitle = keyFn(item);\r\n        const outItem = Object.assign({}, item);\r\n\r\n        if (item.type === CatalogItemType.Layer) {\r\n          // same title, same address => result: only one item is kept\r\n\r\n          // same title, address diff\r\n          const indicesMatchTitle = [];\r\n          const indicesMatchNewMetadataUrl = []; // metadata\r\n          const diffAddress = arr.filter((x, i) => {\r\n            let bInd = false;\r\n            if (x.title === layerTitle && x.type === CatalogItemType.Layer) {\r\n              if (i !== idx && x.address !== item.address) {\r\n                bInd = true;\r\n              }\r\n              indicesMatchTitle.push(i);\r\n            }\r\n            return bInd;\r\n          }); // $& i !== idx\r\n\r\n          if (diffAddress.length > 0) {\r\n            let nPosition = indicesMatchTitle.findIndex((x) => x === idx) + 1;\r\n            outItem.title = `${item.title} (${nPosition})`; // source: ${item.address.split('.')[0]}\r\n            nPosition = indicesMatchNewMetadataUrl.findIndex((x) => x === idx) + 1;\r\n            outItem.newMetadataUrl = `${item.newMetadataUrl} (${nPosition})`; // source: ${item.address.split('.')[0]}\r\n          }\r\n\r\n          const exist = acc.find(\r\n            (x) => x.title === outItem.title && x.type === CatalogItemType.Layer\r\n          );\r\n          if (!exist) {\r\n            acc[acc.length] = outItem;\r\n          }\r\n        } else if (item.type === CatalogItemType.Group) {\r\n          outItem.items = recursiveGroupByLayerAddress(\r\n            item.items,\r\n            (layer) => layer.title\r\n          );\r\n          acc[acc.length] = outItem;\r\n        }\r\n\r\n        return acc;\r\n      }, []);\r\n\r\n    const request4$ = request3$.pipe(\r\n      map((output) => groupByGroupId(output, (group) => group.id)),\r\n      map((output) => [].concat(...output)),\r\n      map((data) => recursiveGroupByLayerAddress(data, (layer) => layer.title))\r\n    );\r\n\r\n    return request4$;\r\n  }\r\n\r\n  private getCatalogCapabilities(catalog: Catalog): Observable<any> {\r\n    const sType: string = TypeCatalog[catalog.type as string];\r\n    return this.capabilitiesService\r\n      .getCapabilities(sType as any, catalog.url, catalog.version)\r\n      .pipe(\r\n        catchError((e) => {\r\n          const title = this.languageService.translate.instant(\r\n            'igo.geo.catalog.unavailableTitle'\r\n          );\r\n          const message =\r\n          catalog.title ? this.languageService.translate.instant(\r\n            'igo.geo.catalog.unavailable',\r\n            { value: catalog.title }\r\n          ) : this.languageService.translate.instant(\r\n            'igo.geo.catalog.someUnavailable'\r\n          );\r\n\r\n          this.messageService.error(message, title);\r\n          console.error(e);\r\n          return of(undefined);\r\n        })\r\n      );\r\n  }\r\n\r\n  private computeForcedProperties(\r\n    layerNameFromCatalog: string,\r\n    forcedProperties: ForcedProperty[]): ForcedProperty {\r\n\r\n    if (!forcedProperties || forcedProperties.length === 0) {\r\n      return;\r\n    }\r\n    const returnProperty: ForcedProperty = {\r\n      layerName: layerNameFromCatalog,\r\n      title: undefined,\r\n      metadataUrl: undefined,\r\n      metadataAbstract: undefined,\r\n      metadataAbstractAll: undefined,\r\n      metadataUrlAll: undefined\r\n    };\r\n    //process wildcard before\r\n    // if there is a * wildcard\r\n    const forcedPropertiesForAllLayers = forcedProperties.find(f => f.layerName === '*');\r\n    if (forcedPropertiesForAllLayers) {\r\n      // metadataAbstractAll\r\n      if (forcedPropertiesForAllLayers.metadataAbstractAll) {\r\n        returnProperty.metadataAbstractAll = forcedPropertiesForAllLayers.metadataAbstractAll;\r\n      }\r\n      // metadataUrlAll\r\n      if (forcedPropertiesForAllLayers.metadataUrlAll) {\r\n        returnProperty.metadataUrlAll = forcedPropertiesForAllLayers.metadataUrlAll;\r\n      }\r\n    }\r\n    forcedProperties.map(forcedProperty => {\r\n      // if match found\r\n      if (layerNameFromCatalog === forcedProperty.layerName) {\r\n        // title\r\n        if (forcedProperty.title) {\r\n          returnProperty.title = forcedProperty.title;\r\n        }\r\n        // metadataUrl\r\n        if (forcedProperty.metadataUrl) {\r\n          returnProperty.metadataUrl = forcedProperty.metadataUrl;\r\n        }\r\n        // metadataAbstract\r\n        if (forcedProperty.metadataAbstract) {\r\n          returnProperty.metadataAbstract = forcedProperty.metadataAbstract;\r\n        }\r\n      }\r\n    });\r\n    return returnProperty;\r\n  }\r\n\r\n  /// WMS\r\n\r\n  private prepareCatalogItemLayer(layer, idParent, layersQueryFormat, catalog) {\r\n    const configuredQueryFormat = this.retrieveLayerInfoFormat(\r\n      layer.Name,\r\n      layersQueryFormat\r\n    );\r\n\r\n    const legendOptions =\r\n      catalog.showLegend && layer.Style\r\n        ? this.capabilitiesService.getStyle(layer.Style)\r\n        : undefined;\r\n\r\n    const params = Object.assign({}, catalog.queryParams, {\r\n      LAYERS: layer.Name,\r\n      VERSION: catalog.version\r\n    } as WMSDataSourceOptionsParams);\r\n\r\n    const baseSourceOptions = {\r\n      type: 'wms',\r\n      url: catalog.url,\r\n      crossOrigin: catalog.setCrossOriginAnonymous ? 'anonymous' : undefined,\r\n      queryFormat: configuredQueryFormat,\r\n      queryHtmlTarget:\r\n        configuredQueryFormat === QueryFormat.HTML ||\r\n        configuredQueryFormat === QueryFormat.HTMLGML2\r\n          ? 'iframe'\r\n          : undefined,\r\n      optionsFromCapabilities: true\r\n    };\r\n\r\n    const sourceOptions = Object.assign(\r\n      {},\r\n      baseSourceOptions,\r\n      catalog.sourceOptions,\r\n      { params }\r\n    ) as WMSDataSourceOptions;\r\n\r\n    const propertiesToForce = this.computeForcedProperties(layer.Name, catalog.forcedProperties);\r\n    let baseAbstract;\r\n    let extern = true;\r\n    if (layer.Abstract) {\r\n      baseAbstract = layer.Abstract;\r\n    } else if (!layer.Abstract && catalog.abstract) {\r\n      baseAbstract = catalog.abstract;\r\n    }\r\n    const layerOnlineResource = layer?.DataURL && layer?.DataURL.length >0 ? layer?.DataURL[0].OnlineResource : undefined;\r\n\r\n    let metadataUrl = propertiesToForce?.metadataUrl || propertiesToForce?.metadataUrlAll || layerOnlineResource;\r\n    let metadataAbstract = propertiesToForce?.metadataAbstract || propertiesToForce?.metadataAbstractAll || baseAbstract;\r\n\r\n    if (\r\n      !propertiesToForce?.metadataUrl &&\r\n      !propertiesToForce?.metadataUrlAll &&\r\n      (propertiesToForce?.metadataAbstract ||\r\n        propertiesToForce?.metadataAbstractAll)\r\n    ) {\r\n      extern = false;\r\n    }\r\n    if (propertiesToForce?.metadataAbstract && propertiesToForce?.metadataUrlAll) {\r\n      extern = false;\r\n    }\r\n\r\n    const layerPrepare = {\r\n      id: generateIdFromSourceOptions(sourceOptions),\r\n      type: CatalogItemType.Layer,\r\n      title: propertiesToForce?.title ? propertiesToForce.title : layer.Title,\r\n      address: idParent,\r\n      externalProvider: catalog.externalProvider || false,\r\n      options: {\r\n        maxResolution: getResolutionFromScale(layer.MaxScaleDenominator),\r\n        minResolution: getResolutionFromScale(layer.MinScaleDenominator),\r\n        metadata: {\r\n          url: metadataUrl,\r\n          extern,\r\n          abstract: metadataAbstract,\r\n          type: baseSourceOptions.type\r\n        },\r\n        legendOptions,\r\n        tooltip: { type: catalog.tooltipType },\r\n        sourceOptions\r\n      }\r\n    } as CatalogItem;\r\n\r\n    return ObjectUtils.removeUndefined(layerPrepare);\r\n  }\r\n\r\n  private prepareCatalogItemGroup(\r\n    itemListIn,\r\n    regexes,\r\n    idGroup,\r\n    layersQueryFormat,\r\n    catalog\r\n  ) {\r\n    const groupPrepare = {\r\n      id: idGroup,\r\n      type: CatalogItemType.Group,\r\n      title: itemListIn.Title,\r\n      address: catalog.id,\r\n      externalProvider: catalog.externalProvider || false,\r\n      sortDirection: catalog.sortDirection, // propagate sortDirection\r\n      items: itemListIn.Layer.reduce((items: CatalogItem[], layer: any) => {\r\n        if (layer.Layer !== undefined) {\r\n          // recursive, check next level\r\n          const idGroupItemNextLevel =\r\n            idGroup + `.group.${layer.Name || layer.Layer[0].Name}`;\r\n          const groupItem: CatalogItemGroup = this.prepareCatalogItemGroup(\r\n            layer,\r\n            regexes,\r\n            idGroupItemNextLevel,\r\n            layersQueryFormat,\r\n            catalog\r\n          );\r\n\r\n          items.push(groupItem);\r\n        } else {\r\n          if (this.testLayerRegexes(layer.Name, regexes) === false) {\r\n            return items;\r\n          }\r\n\r\n          const layerItem: CatalogItemLayer<ImageLayerOptions> = this.prepareCatalogItemLayer(\r\n            layer,\r\n            idGroup,\r\n            layersQueryFormat,\r\n            catalog\r\n          );\r\n\r\n          items.push(layerItem);\r\n        }\r\n        return items;\r\n      }, [])\r\n    };\r\n    return groupPrepare;\r\n  }\r\n\r\n  private includeRecursiveItems(\r\n    catalog: Catalog,\r\n    itemListIn: any,\r\n    itemsPrepare: CatalogItem[],\r\n    loopLevel: number = 0\r\n  ) {\r\n    // Dig all levels until last level (layer object are not defined on last level)\r\n    const regexes = (catalog.regFilters || []).map(\r\n      (pattern: string) => new RegExp(pattern)\r\n    );\r\n    if (!itemListIn.Layer) {\r\n      return;\r\n    }\r\n\r\n    for (const item of itemListIn.Layer) {\r\n      if (item.Layer !== undefined) {\r\n        // recursive, check next level\r\n        this.includeRecursiveItems(catalog, item, itemsPrepare, loopLevel + 1);\r\n        continue;\r\n      }\r\n\r\n      const layersQueryFormat = this.findCatalogInfoFormat(catalog);\r\n\r\n      // group(with layers) and layer(without group) level 1\r\n      if (loopLevel !== 0) {\r\n        // TODO: Slice that into multiple methods\r\n        // Define object of group layer\r\n        const idGroupItem = `catalog.group.${itemListIn.Name || item.Name}`;\r\n        const groupItem = this.prepareCatalogItemGroup(\r\n          itemListIn,\r\n          regexes,\r\n          idGroupItem,\r\n          layersQueryFormat,\r\n          catalog\r\n        );\r\n\r\n        if (groupItem.items.length !== 0) {\r\n          itemsPrepare.push(groupItem);\r\n        }\r\n\r\n        // Break the group (don't add a group of layer for each of their layer!)\r\n        break;\r\n      } else {\r\n        // layer without group\r\n        if (this.testLayerRegexes(item.Name, regexes) !== false) {\r\n          const layerItem = this.prepareCatalogItemLayer(\r\n            item,\r\n            catalog.id,\r\n            layersQueryFormat,\r\n            catalog\r\n          );\r\n          itemsPrepare.push(layerItem);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /// WMTS\r\n\r\n  private getWMTSItems(\r\n    catalog,\r\n    capabilities: { [key: string]: any }\r\n  ): CatalogItemLayer[] {\r\n    if (!capabilities) {\r\n      return [];\r\n    }\r\n    const layers = capabilities.Contents.Layer;\r\n    const regexes = (catalog.regFilters || []).map(\r\n      (pattern: string) => new RegExp(pattern)\r\n    );\r\n\r\n    if (\r\n      capabilities.ServiceIdentification &&\r\n      capabilities.ServiceIdentification.Abstract &&\r\n      capabilities.ServiceIdentification.Abstract.length) {\r\n      catalog.abstract = capabilities.ServiceIdentification.Abstract;\r\n    }\r\n\r\n    return layers\r\n      .map((layer: any) => {\r\n\r\n        const propertiesToForce = this.computeForcedProperties(layer.Title, catalog.forcedProperties);\r\n        let extern = true;\r\n\r\n        let metadataUrl = propertiesToForce?.metadataUrl || propertiesToForce?.metadataUrlAll;\r\n        let metadataAbstract = propertiesToForce?.metadataAbstract || propertiesToForce?.metadataAbstractAll || catalog.abstract;\r\n\r\n        if (\r\n          !propertiesToForce?.metadataUrl &&\r\n          !propertiesToForce?.metadataUrlAll &&\r\n          (propertiesToForce?.metadataAbstract ||\r\n            propertiesToForce?.metadataAbstractAll)\r\n        ) {\r\n          extern = false;\r\n        }\r\n        if (propertiesToForce?.metadataAbstract && propertiesToForce?.metadataUrlAll) {\r\n          extern = false;\r\n        }\r\n\r\n\r\n      if (this.testLayerRegexes(layer.Identifier, regexes) === false) {\r\n        return undefined;\r\n      }\r\n      const params = Object.assign({}, catalog.queryParams, {\r\n        version: '1.0.0'\r\n      });\r\n      const baseSourceOptions = {\r\n        type: 'wmts',\r\n        url: catalog.url,\r\n        crossOrigin: catalog.setCrossOriginAnonymous\r\n          ? 'anonymous'\r\n          : undefined,\r\n        layer: layer.Identifier,\r\n        matrixSet: catalog.matrixSet,\r\n        optionsFromCapabilities: true,\r\n        requestEncoding: catalog.requestEncoding || 'KVP',\r\n        style: 'default'\r\n      } as WMTSDataSourceOptions;\r\n      const sourceOptions = Object.assign(\r\n        {},\r\n        baseSourceOptions,\r\n        catalog.sourceOptions,\r\n        { params }\r\n      ) as WMTSDataSourceOptions;\r\n\r\n      return ObjectUtils.removeUndefined({\r\n        id: generateIdFromSourceOptions(sourceOptions),\r\n        type: CatalogItemType.Layer,\r\n        title: propertiesToForce?.title ? propertiesToForce.title : layer.Title,\r\n        address: catalog.id,\r\n        externalProvider: catalog.externalProvider,\r\n        options: {\r\n          sourceOptions,\r\n          metadata: {\r\n            url: metadataUrl,\r\n            extern,\r\n            abstract: metadataAbstract,\r\n            type: baseSourceOptions.type\r\n          }\r\n        }\r\n      } as CatalogItem);\r\n    })\r\n    .filter((item: CatalogItemLayer | undefined) => item !== undefined);\r\n}\r\n\r\n/// ERSI\r\n\r\n  private getArcGISRESTItems(\r\n    catalog,\r\n    capabilities\r\n  ): CatalogItemLayer[] {\r\n    if (!capabilities) {\r\n      return [];\r\n    }\r\n    const layers =\r\n    !capabilities.layers ? [] : capabilities.layers.filter(layer => !layer.type || layer.type === 'Feature Layer');\r\n    if (!capabilities.layers) {\r\n      this.messageService.error(\r\n        this.languageService.translate.instant('igo.geo.catalog.someUnavailable'),\r\n        this.languageService.translate.instant('igo.geo.catalog.unavailableTitle')\r\n      );\r\n    }\r\n\r\n    const regexes = (catalog.regFilters || []).map(\r\n      (pattern: string) => new RegExp(pattern)\r\n    );\r\n\r\n    let abstract;\r\n    if (capabilities.serviceDescription && capabilities.serviceDescription.length) {\r\n      const regex = /(<([^>]+)>)/ig;\r\n      abstract = capabilities.serviceDescription.replace(regex, '');\r\n    }\r\n\r\n    return layers\r\n      .map((layer: any) => {\r\n\r\n        const propertiesToForce = this.computeForcedProperties(layer.name, catalog.forcedProperties);\r\n        let baseAbstract;\r\n        let extern = true;\r\n        if (layer.Abstract) {\r\n          baseAbstract = layer.Abstract;\r\n        } else if (!layer.Abstract && catalog.abstract) {\r\n          baseAbstract = catalog.abstract;\r\n        }\r\n\r\n        let metadataUrl = propertiesToForce?.metadataUrl || propertiesToForce?.metadataUrlAll;\r\n        let metadataAbstract = propertiesToForce?.metadataAbstract || propertiesToForce?.metadataAbstractAll || baseAbstract;\r\n\r\n        if (\r\n          !propertiesToForce?.metadataUrl &&\r\n          !propertiesToForce?.metadataUrlAll &&\r\n          (propertiesToForce?.metadataAbstract ||\r\n            propertiesToForce?.metadataAbstractAll)\r\n        ) {\r\n          extern = false;\r\n        }\r\n        if (propertiesToForce?.metadataAbstract && propertiesToForce?.metadataUrlAll) {\r\n          extern = false;\r\n        }\r\n\r\n        if (this.testLayerRegexes(layer.id, regexes) === false) {\r\n          return undefined;\r\n        }\r\n        const baseSourceOptions = {\r\n          type: TypeCatalog[catalog.type],\r\n          url: catalog.url,\r\n          crossOrigin: catalog.setCrossOriginAnonymous\r\n            ? 'anonymous'\r\n            : undefined,\r\n          layer: layer.id as string,\r\n          queryable: true,\r\n          queryFormat: 'esrijson',\r\n          matrixSet: catalog.matrixSet,\r\n          optionsFromCapabilities: true,\r\n          style: 'default'\r\n        } as ArcGISRestDataSourceOptions;\r\n        const sourceOptions = Object.assign(\r\n          {},\r\n          baseSourceOptions,\r\n          catalog.sourceOptions\r\n        ) as ArcGISRestDataSourceOptions;\r\n        return ObjectUtils.removeUndefined({\r\n          id: generateIdFromSourceOptions(sourceOptions),\r\n          type: CatalogItemType.Layer,\r\n          title: propertiesToForce?.title ? propertiesToForce.title : layer.name,\r\n          externalProvider: catalog.externalProvider,\r\n          address: catalog.id,\r\n          options: {\r\n            sourceOptions,\r\n            minResolution: getResolutionFromScale(layer.maxScale),\r\n            maxResolution: getResolutionFromScale(layer.minScale),\r\n            metadata: {\r\n              url: metadataUrl,\r\n              extern,\r\n              abstract: metadataAbstract,\r\n              type: baseSourceOptions.type\r\n            },\r\n          }\r\n        } as CatalogItem);\r\n      })\r\n      .filter((item: CatalogItemLayer | undefined) => item !== undefined);\r\n  }\r\n\r\n  private testLayerRegexes(layerName: string, regexes: RegExp[]): boolean {\r\n    if (regexes.length === 0) {\r\n      return true;\r\n    }\r\n    return regexes.find((regex: RegExp) => regex.test(layerName)) !== undefined;\r\n  }\r\n\r\n  private retrieveLayerInfoFormat(\r\n    layerNameFromCatalog: string,\r\n    layersQueryFormat: { layer: string; queryFormat: QueryFormat }[]\r\n  ): QueryFormat {\r\n    const currentLayerInfoFormat = layersQueryFormat.find(\r\n      (f) => f.layer === layerNameFromCatalog\r\n    );\r\n    const baseInfoFormat = layersQueryFormat.find((f) => f.layer === '*');\r\n    let queryFormat: QueryFormat;\r\n    if (currentLayerInfoFormat) {\r\n      queryFormat = currentLayerInfoFormat.queryFormat;\r\n    } else if (baseInfoFormat) {\r\n      queryFormat = baseInfoFormat.queryFormat;\r\n    }\r\n    return queryFormat;\r\n  }\r\n\r\n  private findCatalogInfoFormat(\r\n    catalog: Catalog\r\n  ): { layer: string; queryFormat: QueryFormat }[] {\r\n    const layersQueryFormat: { layer: string; queryFormat: QueryFormat }[] = [];\r\n    if (!catalog.queryFormat) {\r\n      return layersQueryFormat;\r\n    }\r\n    Object.keys(catalog.queryFormat).forEach((configuredInfoFormat) => {\r\n      if (catalog.queryFormat[configuredInfoFormat] instanceof Array) {\r\n        catalog.queryFormat[configuredInfoFormat].forEach((layerName) => {\r\n          if (\r\n            !layersQueryFormat.find((specific) => specific.layer === layerName)\r\n          ) {\r\n            layersQueryFormat.push({\r\n              layer: layerName,\r\n              queryFormat: configuredInfoFormat as QueryFormat\r\n            });\r\n          }\r\n        });\r\n      } else {\r\n        if (\r\n          !layersQueryFormat.find(\r\n            (specific) =>\r\n              specific.layer === catalog.queryFormat[configuredInfoFormat]\r\n          )\r\n        ) {\r\n          layersQueryFormat.push({\r\n            layer: catalog.queryFormat[configuredInfoFormat],\r\n            queryFormat: configuredInfoFormat as QueryFormat\r\n          });\r\n        }\r\n      }\r\n    });\r\n    return layersQueryFormat;\r\n  }\r\n}\r\n","<igo-list [navigation]=\"false\" [selection]=\"false\">\r\n  <ng-template ngFor let-item [ngForOf]=\"store.view.all$() | async\">\r\n    <ng-container *ngIf=\"isGroup(item)\">\r\n      <igo-catalog-browser-group\r\n        [catalog]=\"catalog\"\r\n        [group]=\"item\"\r\n        [state]=\"store.state\"\r\n        [resolution]=\"resolution$ | async\"\r\n        [catalogAllowLegend]=\"catalogAllowLegend\"\r\n        [collapsed]=\"(store.count === 1) ? false : true\"\r\n        [toggleCollapsed]=\"toggleCollapsedGroup\"\r\n        (addedChange)=\"onGroupAddedChange($event)\"\r\n        (layerAddedChange)=\"onLayerAddedChange($event)\">\r\n      </igo-catalog-browser-group>\r\n    </ng-container>\r\n\r\n    <ng-container *ngIf=\"isLayer(item)\">\r\n      <igo-catalog-browser-layer\r\n        igoListItem\r\n        [layer]=\"item\"\r\n        [resolution]=\"resolution$ | async\"\r\n        [catalogAllowLegend]=\"catalogAllowLegend\"\r\n        [added]=\"store.state.get(item).added\"\r\n        (addedChange)=\"onLayerAddedChange($event)\">\r\n      </igo-catalog-browser-layer>\r\n    </ng-container>\r\n  </ng-template>\r\n</igo-list>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { zip, BehaviorSubject } from 'rxjs';\r\n\r\nimport { EntityStore, EntityStoreWatcher } from '@igo2/common';\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { LayerService } from '../../layer/shared/layer.service';\r\nimport { IgoMap } from '../../map';\r\n\r\nimport {\r\n  Catalog,\r\n  CatalogItem,\r\n  CatalogItemLayer,\r\n  CatalogItemGroup,\r\n  CatalogItemState,\r\n  CatalogItemType\r\n} from '../shared';\r\n\r\n/**\r\n * Component to browse a catalog's groups and layers and display them on a map.\r\n */\r\n@Component({\r\n  selector: 'igo-catalog-browser',\r\n  templateUrl: './catalog-browser.component.html',\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class CatalogBrowserComponent implements OnInit, OnDestroy {\r\n  /**\r\n   * Catalog items store watcher\r\n   */\r\n  private watcher: EntityStoreWatcher<CatalogItem>;\r\n\r\n // private resolution$$: Subscription;\r\n\r\n  get resolution$(): BehaviorSubject<number> { return this.map.viewController.resolution$; }\r\n\r\n  @Input() catalogAllowLegend = false;\r\n\r\n  /**\r\n   * Catalog\r\n   */\r\n  @Input() catalog: Catalog;\r\n\r\n  /**\r\n   * Store holding the catalog's items\r\n   */\r\n  @Input() store: EntityStore<CatalogItem, CatalogItemState>;\r\n\r\n  /**\r\n   * Map to add the catalog items to\r\n   */\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * Whether a group can be toggled when it's collapsed\r\n   */\r\n  @Input() toggleCollapsedGroup: boolean = true;\r\n\r\n  constructor(\r\n    private layerService: LayerService,\r\n    private cdRef: ChangeDetectorRef\r\n  ) {}\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    const currentItems = this.map.layers.map((layer: Layer) => {\r\n      return {\r\n        id: layer.options.source.id,\r\n        title: layer.title,\r\n        type: CatalogItemType.Layer\r\n      };\r\n    });\r\n    this.store.state.updateMany(currentItems, { added: true }, true);\r\n    if (this.catalog && this.catalog.sortDirection !== undefined) {\r\n      this.store.view.sort({\r\n        direction: this.catalog.sortDirection,\r\n        valueAccessor: (item: CatalogItem) => item.title\r\n      });\r\n    }\r\n\r\n    const catalogShowLegend = this.catalog ? this.catalog.showLegend : false;\r\n    this.catalogAllowLegend = catalogShowLegend ? catalogShowLegend : this.catalogAllowLegend;\r\n\r\n    this.watcher = new EntityStoreWatcher(this.store, this.cdRef);\r\n\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.watcher.destroy();\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  isGroup(item: CatalogItem): boolean {\r\n    return item.type === CatalogItemType.Group;\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  isLayer(item: CatalogItem): boolean {\r\n    return item.type === CatalogItemType.Layer;\r\n  }\r\n\r\n  /**\r\n   * When a layer is added or removed, add or remove it from the map\r\n   * @internal\r\n   * @param event Layer added event\r\n   */\r\n  onLayerAddedChange(event: { added: boolean; layer: CatalogItemLayer }) {\r\n    const layer = event.layer;\r\n    this.store.state.update(layer, { added: event.added }, false);\r\n    event.added ? this.addLayerToMap(layer) : this.removeLayerFromMap(layer);\r\n  }\r\n\r\n  /**\r\n   * When a froup is added or removed, add or remove it from the map\r\n   * @internal\r\n   * @param event Group added event\r\n   */\r\n  onGroupAddedChange(event: { added: boolean; group: CatalogItemGroup }) {\r\n    const group = event.group;\r\n    this.store.state.update(group, { added: event.added }, false);\r\n    event.added ? this.addGroupToMap(group) : this.removeGroupFromMap(group);\r\n  }\r\n\r\n  /**\r\n   * Add layer to map\r\n   * @param layer Catalog layer\r\n   */\r\n  private addLayerToMap(layer: CatalogItemLayer) {\r\n    this.addLayersToMap([layer]);\r\n  }\r\n\r\n  /**\r\n   * Remove layer from map\r\n   * @param layer Catalog layer\r\n   */\r\n  private removeLayerFromMap(layer: CatalogItemLayer) {\r\n    this.removeLayersFromMap([layer]);\r\n  }\r\n\r\n  /**\r\n   * Add multiple layers to map\r\n   * @param layers Catalog layers\r\n   */\r\n  private addLayersToMap(layers: CatalogItemLayer[]) {\r\n    const layers$ = layers.map((layer: CatalogItemLayer) => {\r\n      if (!layer.options.sourceOptions.optionsFromApi) {\r\n        layer.options.sourceOptions.optionsFromApi = true;\r\n      }\r\n      return this.layerService.createAsyncLayer(layer.options);\r\n    });\r\n\r\n    zip(...layers$).subscribe((oLayers: Layer[]) => {\r\n      this.store.state.updateMany(layers, { added: true });\r\n      this.map.addLayers(oLayers);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Remove multiple layers from map\r\n   * @param layers Catalog layers\r\n   */\r\n  private removeLayersFromMap(layers: CatalogItemLayer[]) {\r\n    layers.forEach((layer: CatalogItemLayer) => {\r\n      this.store.state.update(layer, { added: false });\r\n      if (layer.options.baseLayer === true) {\r\n        const oLayer = this.map.getLayerById(layer.options.id);\r\n        if (oLayer !== undefined) {\r\n          this.map.removeLayer(oLayer);\r\n        }\r\n      } else {\r\n        const oLayer = this.map.getLayerById(layer.id);\r\n        if (oLayer !== undefined) {\r\n          this.map.removeLayer(oLayer);\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Sort the layers by title. asc or desc.\r\n   * @internal\r\n   */\r\n  private sortCatalogItemsByTitle(items: CatalogItem[], direction) {\r\n    const returnItem = items.sort((a, b) => {\r\n      const titleA = a.title.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n      const titleB = b.title.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n\r\n      if (titleA < titleB) {\r\n        return -1;\r\n      }\r\n      if (titleA > titleB) {\r\n        return 1;\r\n      }\r\n      return 0;\r\n    });\r\n    switch (direction) {\r\n      case 'asc':\r\n        return returnItem;\r\n      case 'desc':\r\n        return returnItem.reverse();\r\n      default:\r\n        return items;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add all the layers of a group to map\r\n   * @param group Catalog group\r\n   */\r\n  private addGroupToMap(group: CatalogItemGroup) {\r\n    let layers = group.items.filter((item: CatalogItem) => {\r\n      const added = this.store.state.get(item).added || false;\r\n      return this.isLayer(item) && added === false;\r\n    });\r\n    if (group.sortDirection !== undefined) {\r\n      layers = this.sortCatalogItemsByTitle(layers, group.sortDirection);\r\n    }\r\n    this.addLayersToMap(layers.reverse() as CatalogItemLayer[]);\r\n  }\r\n\r\n  /**\r\n   * Remove all the layers of a group from map\r\n   * @param group Catalog group\r\n   */\r\n  private removeGroupFromMap(group: CatalogItemGroup) {\r\n    const layers = group.items.filter((item: CatalogItem) => {\r\n      const added = this.store.state.get(item).added || false;\r\n      return this.isLayer(item) && added === true;\r\n    });\r\n    this.removeLayersFromMap(layers as CatalogItemLayer[]);\r\n  }\r\n}\r\n","<ng-container *ngIf=\"legendItems$ | async as items\">\r\n  <ng-container *ngIf=\"items.length; else noItems\">\r\n    <ng-container *ngFor=\"let item of items.slice().reverse()\" #renderedLegends>\r\n      <div *ngIf=\"getLegend; else noItems\">\r\n        <mat-list-item *ngIf=\"item.title\">\r\n          <mat-icon\r\n            id=\"legend-toggle\"\r\n            class=\"igo-chevron\"\r\n            mat-list-avatar\r\n            igoCollapse\r\n            [target]=\"legend\"\r\n            [collapsed]=\"(item.collapsed)\"\r\n            (toggle)=\"toggleLegendItem($event, item)\"\r\n            svgIcon=\"chevron-up\">\r\n          </mat-icon>\r\n          <h4 matLine>{{computeItemTitle(item) | async}} </h4>\r\n        </mat-list-item>\r\n        <div #legend class=\"igo-layer-legend\" [ngClass]=\"{'with-title': item.title}\">\r\n          <div *ngIf=\"currentStyle !== undefined\">\r\n              <mat-form-field>\r\n                <mat-select tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n                  [matTooltip]=\"'igo.geo.layer.legend.selectStyle' | translate\" [(ngModel)]=\"currentStyle\"\r\n                  (selectionChange)=\"onChangeStyle()\">\r\n                  <mat-option *ngFor=\"let style of styles\" [value]=\"style.name\">{{style.title}}</mat-option>\r\n                </mat-select>\r\n            </mat-form-field>\r\n          </div>\r\n          <div *ngIf=\"!(item.collapsed)\">\r\n            <div *ngIf=\"item.url\">\r\n              <img #renderedLegend id=\"{{item.title}}\" (load)=\"onLoadImage(item.title)\"\r\n                src=\"{{[item.imgGraphValue]}}\"\r\n                alt=\"{{'igo.geo.layer.legend.loadingLegendText' | translate}}\">\r\n              <small *ngIf=\"imagesHeight[item.title]<16\">\r\n                  {{'igo.geo.layer.legend.noLegendScale' | translate}}\r\n              </small>\r\n            </div>\r\n            <div\r\n              [ngStyle]=\"item.style\"\r\n              [innerHTML]=\"item.html | sanitizeHtml\"\r\n              *ngIf=\"item.html\">\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </ng-container>\r\n  </ng-container>\r\n\r\n  <ng-template #noItems>\r\n    <small>\r\n      {{'igo.geo.layer.legend.noLegendText' | translate}}\r\n    </small>\r\n  </ng-template>\r\n\r\n</ng-container>\r\n","import { HttpClient } from '@angular/common/http';\r\nimport { Component, Input, OnInit, OnDestroy, ChangeDetectionStrategy, ViewChildren, ElementRef, ChangeDetectorRef } from '@angular/core';\r\nimport type { QueryList } from '@angular/core';\r\n\r\nimport { Subscription, BehaviorSubject, of, Observable } from 'rxjs';\r\n\r\nimport { Legend } from '../../datasource/shared/datasources/datasource.interface';\r\nimport { Layer, ItemStyleOptions } from '../shared/layers';\r\nimport { LegendMapViewOptions } from '../shared/layers/layer.interface';\r\nimport { CapabilitiesService } from '../../datasource/shared/capabilities.service';\r\nimport { catchError, map } from 'rxjs/operators';\r\nimport { LanguageService, ConfigService } from '@igo2/core';\r\nimport { WMSDataSource, WMSDataSourceOptions } from '../../datasource';\r\nimport { SecureImagePipe } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'igo-layer-legend',\r\n  templateUrl: './layer-legend.component.html',\r\n  styleUrls: ['./layer-legend.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class LayerLegendComponent implements OnInit, OnDestroy {\r\n\r\n  @Input() updateLegendOnResolutionChange: boolean = false;\r\n\r\n  /**\r\n   * Observable of the legend items\r\n   */\r\n  legendItems$: BehaviorSubject<Legend[]> = new BehaviorSubject([]);\r\n\r\n  /**\r\n   * Subscription to the map's resolution\r\n   */\r\n  private state$$: Subscription;\r\n\r\n  /**\r\n   * The available styles\r\n   */\r\n  public styles;\r\n\r\n  /**\r\n   * The style used to make the legend\r\n   */\r\n  public currentStyle;\r\n\r\n  /**\r\n   * The scale used to make the legend\r\n   */\r\n  private scale: number = undefined;\r\n\r\n  /**\r\n   * The extent used to make the legend\r\n   */\r\n  private view: LegendMapViewOptions = undefined;\r\n  /**\r\n   * Get list of images display\r\n   */\r\n  @ViewChildren('renderedLegend') renderedLegends: QueryList<ElementRef>;\r\n\r\n  /**\r\n   * List of size of images displayed\r\n   */\r\n  public imagesHeight: { [srcKey: string]: number } = {};\r\n\r\n  /**\r\n   * Layer\r\n   */\r\n  @Input() layer: Layer;\r\n\r\n  /**\r\n   * if getLegendGraphic is authorized\r\n   */\r\n  public getLegend = true;\r\n\r\n  /**\r\n   * activeLegend\r\n   */\r\n\r\n  constructor(\r\n    private capabilitiesService: CapabilitiesService,\r\n    private languageService: LanguageService,\r\n    private configService: ConfigService,\r\n    private http: HttpClient,\r\n    private cdRef: ChangeDetectorRef) {}\r\n\r\n  /**\r\n   * On init, subscribe to the map's resolution and update the legend accordingly\r\n   */\r\n  ngOnInit() {\r\n    let lastlLegend = this.layer.legend;\r\n    this.styles = this.listStyles();\r\n    const sourceOptions = this.layer.options.source.options as any;\r\n    if (sourceOptions && sourceOptions.params && sourceOptions.params.STYLES) {\r\n      // if a styles is provided into the layers wms params\r\n      this.currentStyle = this.styles.find(style => style.name === sourceOptions.params.STYLES).name;\r\n    } else if (!lastlLegend) {\r\n      // if no legend is manually provided\r\n      if (this.styles && this.styles.length > 1) {\r\n        this.currentStyle = this.styles[0].name;\r\n      }\r\n    } else if (this.styles && this.styles.length > 1) {\r\n      this.currentStyle = lastlLegend[0].currentStyle;\r\n    }\r\n    if (typeof this.layer.options.legendOptions !== 'undefined' && this.layer.options.legendOptions.display === false) {\r\n      lastlLegend = [];\r\n    } else {\r\n      lastlLegend = this.layer.dataSource.getLegend(this.currentStyle, this.view);\r\n    }\r\n\r\n    if (this.updateLegendOnResolutionChange || (sourceOptions as WMSDataSourceOptions).contentDependentLegend) {\r\n      const state$ = this.layer.map.viewController.state$;\r\n      this.state$$ = state$.subscribe(() => this.onViewControllerStateChange());\r\n    } else if (lastlLegend && lastlLegend.length !== 0) {\r\n      this.legendItems$.next(lastlLegend);\r\n      for (const legend of lastlLegend) {\r\n        this.getLegendGraphic(legend);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * On destroy, unsubscribe to the map's view state\r\n   */\r\n  ngOnDestroy() {\r\n    if (this.state$$ !== undefined) {\r\n      this.state$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  getLegendGraphic(item: Legend) {\r\n    if (item.url) {\r\n      const secureIMG = new SecureImagePipe(this.http, this.configService);\r\n      secureIMG.transform(item.url).pipe(\r\n        catchError((err) => {\r\n          if (err.error) {\r\n            err.error.caught = true;\r\n            this.getLegend = false;\r\n            this.cdRef.detectChanges();\r\n            return err;\r\n          }\r\n        })\r\n        ).subscribe(obsLegGraph => {\r\n          const idx = this.legendItems$.value.findIndex(leg => leg.title === item.title);\r\n          const legendGraph = obsLegGraph as string;\r\n          this.legendItems$.value[idx].imgGraphValue = legendGraph;\r\n          this.cdRef.detectChanges();\r\n        }\r\n      );\r\n    }\r\n  }\r\n\r\n  toggleLegendItem(collapsed: boolean, item: Legend) {\r\n    item.collapsed = collapsed;\r\n  }\r\n\r\n  private transfertToggleLegendItem(newLegends: Legend[]): Legend[] {\r\n    const outLegends: Legend[] = newLegends;\r\n    const lastLegends = this.layer.legend;\r\n    for (let i = 0; i < lastLegends.length; i++) {\r\n      outLegends[i].collapsed = lastLegends[i].collapsed;\r\n   }\r\n    return outLegends;\r\n  }\r\n\r\n  computeItemTitle(layerLegend): Observable<string> {\r\n    const layerOptions = this.layer.dataSource.options as any;\r\n    if (layerOptions.type !== 'wms') {\r\n      return of(layerLegend.title);\r\n    }\r\n\r\n    const layers = layerOptions.params.LAYERS.split(',');\r\n    const localLayerOptions = JSON.parse(JSON.stringify(layerOptions)); // to avoid to alter the original options.\r\n    localLayerOptions.params.LAYERS = layers.find(layer => layer === layerLegend.title);\r\n    return this.capabilitiesService\r\n      .getWMSOptions(localLayerOptions)\r\n      .pipe(map(wmsDataSourceOptions => {\r\n        return wmsDataSourceOptions._layerOptionsFromSource.title;\r\n      }));\r\n  }\r\n\r\n  /**\r\n   * On resolution change, compute the effective scale level and update the\r\n   * legend accordingly.\r\n   * @param resolution Map resolution\r\n   */\r\n  private onViewControllerStateChange() {\r\n    this.view = {\r\n      resolution: this.layer.map.viewController.getResolution(),\r\n      extent: this.layer.map.viewController.getExtent(),\r\n      projection: this.layer.map.viewController.getOlProjection().getCode(),\r\n      scale: this.layer.map.viewController.getScale(),\r\n      size: this.layer.map.ol.getSize()\r\n    } as LegendMapViewOptions;\r\n    this.updateLegend();\r\n  }\r\n\r\n  /**\r\n   * Update the legend with scale level and style define\r\n   */\r\n  private updateLegend() {\r\n    let legendItems = this.layer.dataSource.getLegend(this.currentStyle, this.view);\r\n    if (this.layer.legend && this.layer.legend.length > 1) { legendItems = this.transfertToggleLegendItem(legendItems); }\r\n    this.layer.legend = legendItems;\r\n\r\n    if (legendItems.length === 0 && this.legendItems$.value.length === 0) {\r\n      return;\r\n    }\r\n    this.legendItems$.next(legendItems);\r\n    for (const legend of this.legendItems$.value) {\r\n      this.getLegendGraphic(legend);\r\n    }\r\n  }\r\n\r\n  private listStyles() {\r\n    const layerOptions = this.layer.options;\r\n    if (layerOptions && layerOptions.legendOptions) {\r\n      const translate = this.languageService.translate;\r\n      const title = translate.instant('igo.geo.layer.legend.default');\r\n      let stylesAvailable = [{ name: '', title } as ItemStyleOptions];\r\n      if (layerOptions.legendOptions.stylesAvailable) {\r\n        stylesAvailable = stylesAvailable.concat(layerOptions.legendOptions.stylesAvailable.filter(sA => (\r\n          sA.name.normalize('NFD').replace(/[\\u0300-\\u036f]/gi, '') !== 'default' &&\r\n          sA.name.normalize('NFD').replace(/[\\u0300-\\u036f]/gi, '') !== 'defaut')));\r\n      }\r\n      stylesAvailable.filter(sa => !sa.title).map((sa) => sa.title = sa.name);\r\n      stylesAvailable.map(s => s.title = s.title.charAt(0).toUpperCase() + s.title.slice(1).replace(/_/g, ' '));\r\n      return stylesAvailable;\r\n    }\r\n    return ;\r\n  }\r\n\r\n  onChangeStyle() {\r\n    this.updateLegend();\r\n    let STYLES = '';\r\n    if (this.layer.dataSource instanceof WMSDataSource) {\r\n      this.layer.dataSource.ol.getParams().LAYERS.split(',').map(layer =>\r\n        STYLES += this.currentStyle + ','\r\n      );\r\n      STYLES = STYLES.slice(0, -1);\r\n      this.layer.dataSource.ol.updateParams({ STYLES });\r\n    }\r\n  }\r\n\r\n  onLoadImage(id: string) {\r\n    let elemRef: HTMLImageElement;\r\n    if (this.renderedLegends.length === 1) {\r\n      elemRef = this.renderedLegends.first.nativeElement as HTMLImageElement;\r\n    } else {\r\n      elemRef = this.renderedLegends.find(renderedLegend => renderedLegend.nativeElement.id === id).nativeElement as HTMLImageElement;\r\n    }\r\n    this.imagesHeight[id] = elemRef.height;\r\n  }\r\n}\r\n","<mat-list-item>\r\n  <mat-icon *ngIf=\"haveGroup()\" mat-list-avatar svgIcon=\"blank\"></mat-icon>\r\n  <h4 mat-line matTooltipShowDelay=\"500\" [ngClass]=\"(catalogAllowLegend)?'igo-cataloglayer-title':''\" (click)=\"askForLegend($event)\" [matTooltip]=\"computeTitleTooltip()\">{{title}}</h4>\r\n\r\n    <button *ngIf=\"layer.externalProvider\"\r\n      disabled=\"true\"\r\n      mat-icon-button>\r\n    <mat-icon\r\n      class=\"igo-cataloglayer-external-icon\"\r\n      *ngIf=\"layer.externalProvider\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.catalog.externalProvider.layer' | translate\"\r\n      color=\"primary\"\r\n      (click)=\"$event.stopPropagation()\"\r\n      svgIcon=\"earth-arrow-right\">\r\n    </mat-icon>\r\n  </button>\r\n  <igo-metadata-button [layer]=\"layer\"></igo-metadata-button>\r\n\r\n  <button\r\n    (mouseenter)=\"onMouseEvent($event)\" (mouseleave)=\"onMouseEvent($event)\"\r\n    mat-icon-button\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"computeTooltip() | translate\"\r\n    [color]=\"(isPreview$ | async) ? '' : added ? 'warn' : ''\"\r\n    (click)=\"onToggleClick($event)\">\r\n    <mat-icon\r\n       matBadge=\"icon\"\r\n       igoMatBadgeIcon=\"eye-off\"\r\n       igoMatBadgeInverseColor=\"true\"\r\n       [matBadgeHidden]=\"isInResolutionsRange()\"\r\n       matBadgeDisabled=\"true\"\r\n       matBadgeSize=\"small\"\r\n       matBadgePosition=\"after\"\r\n       [svgIcon]=\"(isPreview$ | async) ? 'plus' : added ? 'delete' : 'plus'\">\r\n    </mat-icon>\r\n  </button>\r\n\r\n</mat-list-item>\r\n\r\n<div #legend class=\"igo-cataloglayer-legend-container\">\r\n  <igo-layer-legend\r\n    *ngIf=\"(layerLegendShown$ | async) && (igoLayer$ | async) && catalogAllowLegend\"\r\n    [layer]=\"igoLayer$ | async\">\r\n  </igo-layer-legend>\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  Output,\r\n  EventEmitter,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { getEntityTitle, getEntityIcon } from '@igo2/common';\r\n\r\nimport { CatalogItemLayer } from '../shared';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport { LayerService } from '../../layer/shared/layer.service';\r\nimport { first } from 'rxjs/operators';\r\nimport { Layer, TooltipType } from '../../layer/shared/layers';\r\nimport { MetadataLayerOptions } from '../../metadata/shared/metadata.interface';\r\n\r\n/**\r\n * Catalog browser layer item\r\n */\r\n@Component({\r\n  selector: 'igo-catalog-browser-layer',\r\n  templateUrl: './catalog-browser-layer.component.html',\r\n  styleUrls: ['./catalog-browser-layer.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class CatalogBrowserLayerComponent implements OnInit, OnDestroy {\r\n  public inRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n  public isPreview$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  private isPreview$$: Subscription;\r\n  private lastTimeoutRequest;\r\n\r\n  public layerLegendShown$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  public igoLayer$ = new BehaviorSubject<Layer>(undefined);\r\n\r\n  private mouseInsideAdd: boolean = false;\r\n\r\n  @Input() resolution: number;\r\n\r\n  @Input() catalogAllowLegend = false;\r\n\r\n  /**\r\n   * Catalog layer\r\n   */\r\n  @Input() layer: CatalogItemLayer;\r\n\r\n  /**\r\n   * Whether the layer is already added to the map\r\n   */\r\n  @Input() added = false;\r\n\r\n  /**\r\n   * Event emitted when the add/remove button is clicked\r\n   */\r\n  @Output() addedChange = new EventEmitter<{\r\n    added: boolean;\r\n    layer: CatalogItemLayer;\r\n  }>();\r\n\r\n  @Output() addedLayerIsPreview = new EventEmitter<boolean>();\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get title(): string {\r\n    return getEntityTitle(this.layer);\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get icon(): string {\r\n    return getEntityIcon(this.layer) || 'layers';\r\n  }\r\n\r\n  constructor(private layerService: LayerService ) {}\r\n\r\n  ngOnInit(): void {\r\n    this.isInResolutionsRange();\r\n    this.isPreview$$ = this.isPreview$.subscribe(value => this.addedLayerIsPreview.emit(value));\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.isPreview$$.unsubscribe();\r\n  }\r\n\r\n  computeTitleTooltip(): string {\r\n      const layerOptions = this.layer.options;\r\n      if (!layerOptions.tooltip) {\r\n        return getEntityTitle(this.layer);\r\n      }\r\n      const layerTooltip = layerOptions.tooltip;\r\n      const layerMetadata = (layerOptions as MetadataLayerOptions).metadata;\r\n      switch (layerOptions.tooltip.type) {\r\n        case TooltipType.TITLE:\r\n          return this.layer.title;\r\n        case TooltipType.ABSTRACT:\r\n          if (layerMetadata && layerMetadata.abstract) {\r\n            return layerMetadata.abstract;\r\n          } else {\r\n            return this.layer.title;\r\n          }\r\n        case TooltipType.CUSTOM:\r\n          if (layerTooltip && layerTooltip.text) {\r\n            return layerTooltip.text;\r\n          } else {\r\n            return this.layer.title;\r\n          }\r\n        default:\r\n          return this.layer.title;\r\n      }\r\n  }\r\n\r\n  /**\r\n   * On mouse event, mouseenter /mouseleave\r\n   * @internal\r\n   */\r\n  onMouseEvent(event) {\r\n    this.onToggleClick(event);\r\n  }\r\n\r\n  askForLegend(event) {\r\n    this.layerLegendShown$.next(!this.layerLegendShown$.value);\r\n    this.layerService.createAsyncLayer(this.layer.options).pipe(first())\r\n    .subscribe(layer => this.igoLayer$.next(layer));\r\n  }\r\n\r\n  /**\r\n   * On toggle button click, emit the added change event\r\n   * @internal\r\n   */\r\n  onToggleClick(event) {\r\n    if (typeof this.lastTimeoutRequest !== 'undefined') {\r\n      clearTimeout(this.lastTimeoutRequest);\r\n    }\r\n    if (event.type === 'mouseenter' && this.mouseInsideAdd ) {\r\n      return;\r\n    }\r\n    switch (event.type) {\r\n      case 'click':\r\n        if (!this.isPreview$.value) {\r\n          if (this.added) {\r\n            this.remove();\r\n          } else {\r\n            this.add();\r\n          }\r\n        }\r\n        this.isPreview$.next(false);\r\n        break;\r\n      case 'mouseenter':\r\n        if (!this.isPreview$.value && !this.added) {\r\n          this.lastTimeoutRequest = setTimeout(() => {\r\n            this.add();\r\n            this.isPreview$.next(true);\r\n          }, 500);\r\n        }\r\n        this.mouseInsideAdd = true;\r\n        break;\r\n      case 'mouseleave':\r\n        if (this.isPreview$.value) {\r\n          this.remove();\r\n          this.isPreview$.next(false);\r\n        }\r\n        this.mouseInsideAdd = false;\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Emit added change event with added = true\r\n   */\r\n  private add() {\r\n    if (!this.added) {\r\n      this.added = true;\r\n      this.addedChange.emit({ added: true, layer: this.layer });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Emit added change event with added = false\r\n   */\r\n  private remove() {\r\n    if (this.added) {\r\n      this.added = false;\r\n      this.addedChange.emit({ added: false, layer: this.layer });\r\n    }\r\n  }\r\n\r\n  haveGroup(): boolean {\r\n    return !(!this.layer.address || this.layer.address.split('.').length === 1);\r\n  }\r\n\r\n  isInResolutionsRange(): boolean {\r\n    const minResolution = this.layer.options.minResolution || 0;\r\n    const maxResolution = this.layer.options.maxResolution || Infinity;\r\n    this.inRange$.next(\r\n      this.resolution >= minResolution && this.resolution <= maxResolution\r\n    );\r\n    return this.inRange$.value;\r\n  }\r\n\r\n  computeTooltip(): string {\r\n    if (this.added) {\r\n      return this.isPreview$.value\r\n        ? 'igo.geo.catalog.layer.addToMap'\r\n        : this.inRange$.value\r\n        ? 'igo.geo.catalog.layer.removeFromMap'\r\n        : 'igo.geo.catalog.layer.removeFromMapOutRange';\r\n    } else {\r\n      return this.inRange$.value\r\n        ? 'igo.geo.catalog.layer.addToMap'\r\n        : 'igo.geo.catalog.layer.addToMapOutRange';\r\n    }\r\n  }\r\n}\r\n","<mat-list-item>\r\n  <mat-icon\r\n    mat-list-avatar\r\n    svgIcon=\"chevron-up\"\r\n    igoCollapse\r\n    class=\"igo-chevron\"\r\n    [target]=\"items\"\r\n    [collapsed]=\"collapsed\"\r\n    (toggle)=\"onToggleCollapsed($event)\">\r\n  </mat-icon>\r\n\r\n  <h4 class=\"igo-catalog-group-title\" id=\"catalog-group-title\" mat-line matTooltipShowDelay=\"500\" [matTooltip]=\"title\" (click)=\"onTitleClick()\">{{title}}</h4>\r\n\r\n  <button *ngIf=\"group.externalProvider\"\r\n    disabled=\"true\"\r\n    mat-icon-button>\r\n    <mat-icon\r\n      class=\"igo-cataloggroup-external-icon\"\r\n      *ngIf=\"group.externalProvider\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.catalog.externalProvider.group' | translate\"\r\n      color=\"primary\"\r\n      (click)=\"$event.stopPropagation()\"\r\n      svgIcon=\"earth-arrow-right\">\r\n    </mat-icon>\r\n  </button>\r\n\r\n  <ng-container *ngIf=\"(added$ | async) && (preview$ | async) === false; else notadded\">\r\n    <button\r\n      mat-icon-button\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.catalog.group.removeFromMap' | translate\"\r\n      color=\"warn\"\r\n      [disabled]=\"disabled$ | async\"\r\n      (click)=\"onToggleClick()\">\r\n      <mat-icon svgIcon=\"delete\"></mat-icon>\r\n    </button>\r\n  </ng-container>\r\n\r\n  <ng-template #notadded>\r\n    <button\r\n      mat-icon-button\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.catalog.group.addToMap' | translate\"\r\n      [disabled]=\"disabled$ | async\"\r\n      (click)=\"onToggleClick()\">\r\n      <mat-icon svgIcon=\"plus\"></mat-icon>\r\n    </button>\r\n  </ng-template>\r\n</mat-list-item>\r\n\r\n<div #items>\r\n  <ng-template ngFor let-item [ngForOf]=\"store.view.all$() | async\">\r\n    <ng-container *ngIf=\"isGroup(item)\">\r\n      <!-- todo: add display ans manage CatalogItemGroup -->\r\n    </ng-container>\r\n    <ng-container *ngIf=\"isLayer(item)\">\r\n      <igo-catalog-browser-layer\r\n        igoListItem\r\n        [layer]=\"item\"\r\n        [resolution]=\"resolution\"\r\n        [catalogAllowLegend]=\"catalogAllowLegend\"\r\n        [added]=\"state.get(item).added\"\r\n        (addedLayerIsPreview)=\"onLayerPreview($event)\"\r\n        (addedChange)=\"onLayerAddedChange($event)\">\r\n      </igo-catalog-browser-layer>\r\n    </ng-container>\r\n  </ng-template>\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { EntityStore } from '@igo2/common';\r\nimport type { EntityStateManager } from '@igo2/common';\r\n\r\nimport {\r\n  Catalog,\r\n  CatalogItem,\r\n  CatalogItemGroup,\r\n  CatalogItemLayer,\r\n  CatalogItemState,\r\n  CatalogItemType\r\n} from '../shared';\r\n\r\n/**\r\n * Catalog browser group item\r\n */\r\n@Component({\r\n  selector: 'igo-catalog-browser-group',\r\n  templateUrl: './catalog-browser-group.component.html',\r\n  styleUrls: ['./catalog-browser-group.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class CatalogBrowserGroupComponent implements OnInit, OnDestroy {\r\n\r\n  /**\r\n   * Group's items store\r\n   * @internal\r\n   */\r\n  store = new EntityStore<CatalogItem, CatalogItemState>([]);\r\n\r\n  /**\r\n   * Whether all the layers of the group are added\r\n   * @internal\r\n   */\r\n  added$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  preview$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  /**\r\n   * Whether the toggle button is disabled\r\n   * @internal\r\n   */\r\n  disabled$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  /**\r\n   * Catalog\r\n   */\r\n  @Input() catalog: Catalog;\r\n\r\n  /**\r\n   * Catalog group\r\n   */\r\n  @Input() group: CatalogItemGroup;\r\n\r\n  /**\r\n   * Whether the group is collapsed\r\n   */\r\n  @Input() collapsed: boolean = true;\r\n\r\n  @Input() resolution: number;\r\n\r\n  @Input() catalogAllowLegend = false;\r\n\r\n  /**\r\n   * Whether the group can be toggled when it's collapsed\r\n   */\r\n  @Input() toggleCollapsed: boolean = true;\r\n\r\n  /**\r\n   * Parent catalog's items store state. Groups share a unique\r\n   * EntityState that tracks the group and it's layers state (whether they are added or not).\r\n   * Sharing a unique state would also allow us to expand this component to allow\r\n   * the selection of a layer while unselecting any layer already selected in another group.\r\n   * This could be useful to display some layer info before adding it, for example.\r\n   */\r\n  @Input() state: EntityStateManager<CatalogItem, CatalogItemState>;\r\n\r\n  /**\r\n   * Event emitted when the add/remove button of the group is clicked\r\n   */\r\n  @Output() addedChange = new EventEmitter<{\r\n    added: boolean;\r\n    group: CatalogItemGroup;\r\n  }>();\r\n\r\n  /**\r\n   * Event emitted when the add/remove button of a layer is clicked\r\n   */\r\n  @Output() layerAddedChange = new EventEmitter<{\r\n    added: boolean;\r\n    layer: CatalogItemLayer;\r\n  }>();\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get title(): string {\r\n    return this.group.title;\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.store.load(this.group.items);\r\n    this.evaluateAdded();\r\n    this.evaluateDisabled(this.collapsed);\r\n    if (this.group.sortDirection !== undefined) {\r\n      this.store.view.sort({\r\n        direction: this.group.sortDirection,\r\n        valueAccessor: (item: CatalogItem) => item.title\r\n        });\r\n    }\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.store.destroy();\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  isGroup(item: CatalogItem): boolean {\r\n    return item.type === CatalogItemType.Group;\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  isLayer(item: CatalogItem): boolean {\r\n    return item.type === CatalogItemType.Layer;\r\n  }\r\n\r\n  /**\r\n   * On toggle button click, emit the added change event\r\n   * @internal\r\n   */\r\n  onToggleClick() {\r\n    this.added$.value ? this.remove() : this.add();\r\n  }\r\n\r\n  /**\r\n   * On toggle button click, emit the added change event\r\n   * @internal\r\n   */\r\n  onToggleCollapsed(collapsed: boolean) {\r\n    this.evaluateDisabled(collapsed);\r\n  }\r\n\r\n  /**\r\n   * When a layer is added or removed, evaluate if all the layers of the group\r\n   * are now added or removed. If so, consider that the group itself is added\r\n   * or removed.\r\n   * @internal\r\n   * @param event Layer added change event\r\n   */\r\n  onLayerAddedChange(event: { added: boolean; layer: CatalogItemLayer }) {\r\n    this.layerAddedChange.emit(event);\r\n    this.tryToggleGroup(event);\r\n  }\r\n\r\n  /**\r\n   * Emit added change event with added = true\r\n   */\r\n  private add() {\r\n    this.added$.next(true);\r\n    this.addedChange.emit({\r\n      added: true,\r\n      group: this.group\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Emit added change event with added = true\r\n   */\r\n  private remove() {\r\n    this.added$.next(false);\r\n    this.addedChange.emit({\r\n      added: false,\r\n      group: this.group\r\n    });\r\n  }\r\n\r\n  onLayerPreview(event) {\r\n    this.preview$.next(event);\r\n  }\r\n\r\n  /**\r\n   * If all the layers of the group added or removed, add or remove the group itself.\r\n   * @param event The last layer added change event to occur\r\n   */\r\n  private tryToggleGroup(event: { added: boolean; layer: CatalogItemLayer }) {\r\n    const added = event.added;\r\n    const layer = event.layer;\r\n\r\n    const layersAdded = this.store.view\r\n      .all()\r\n      .filter((item: CatalogItem) => item.id !== layer.id)\r\n      .map((item: CatalogItem) => this.state.get(item).added || false);\r\n\r\n    if (layersAdded.every(value => value === added)) {\r\n      added ? this.add() : this.remove();\r\n    } else if (this.added$.value === true) {\r\n      this.added$.next(false);\r\n    }\r\n  }\r\n\r\n  private evaluateAdded() {\r\n    const added = this.store.all().every((item: CatalogItem) => {\r\n      return (this.state.get(item).added || false) === true;\r\n    });\r\n    this.added$.next(added);\r\n  }\r\n\r\n  private evaluateDisabled(collapsed: boolean) {\r\n    let disabled = false;\r\n    if (this.toggleCollapsed === false) {\r\n      disabled = collapsed;\r\n    }\r\n    this.disabled$.next(disabled);\r\n  }\r\n\r\n  onTitleClick() {\r\n    this.collapsed = !this.collapsed;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class LayerListToolService {\r\n  public keyword: string;\r\n  public sortAlpha = false;\r\n  public onlyVisible = false;\r\n  public onlyInRange = false;\r\n  public keywordInitialized = false;\r\n  public sortedAlphaInitialized = false;\r\n  public onlyVisibleInitialized = false;\r\n  public onlyInRangeInitialized = false;\r\n\r\n  constructor() {}\r\n\r\n}\r\n","<mat-list-item class= \"igo-layer-list-item\">\r\n  <mat-checkbox *ngIf=\"selectionMode\"\r\n    class=\"layerCheck\"\r\n    mat-list-icon\r\n    (change)=\"check()\"\r\n    [checked]=\"layerCheck\">\r\n  </mat-checkbox>\r\n  <h4 (click)=\"toggleLegendOnClick()\" matLine class=\"igo-layer-title\" [matTooltip]=\"tooltipText\" matTooltipShowDelay=\"500\">{{layer.title}}</h4>\r\n\r\n  <button *ngIf=\"!selectionMode\"\r\n    mat-icon-button\r\n    [color]=\"layer.visible ? 'primary' : 'default'\"\r\n    collapsibleButton\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"eyeTooltip | translate\"\r\n    (click)=\"toggleVisibility()\">\r\n    <mat-icon\r\n      matBadge=\"?\"\r\n      matBadgeColor=\"accent\"\r\n      matBadgeSize=\"small\"\r\n      matBadgePosition=\"after\"\r\n      [matBadgeHidden]=\"queryBadgeHidden$ | async\"\r\n      [ngClass]=\"{disabled: (inResolutionRange$ | async)===false}\"\r\n      [svgIcon]=\"(layer.visible$ | async) ? 'eye' : 'eye-off'\">\r\n    </mat-icon>\r\n  </button>\r\n\r\n  <button *ngIf=\"selectionMode\" class=\"selection-eye\"\r\n  mat-icon-button\r\n  [color]=\"layer.visible ? 'primary' : 'default'\"\r\n  collapsibleButton\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"layer.visible ?\r\n                ('igo.geo.layer.hideLayer' | translate) :\r\n                ('igo.geo.layer.showLayer' | translate)\"\r\n  (click)=\"toggleVisibility()\">\r\n  <mat-icon\r\n    matBadge=\"?\"\r\n    matBadgeColor=\"accent\"\r\n    matBadgeSize=\"small\"\r\n    matBadgePosition=\"after\"\r\n    [matBadgeHidden]=\"queryBadgeHidden$ | async\"\r\n    [ngClass]=\"{disabled: (inResolutionRange$ | async)===false}\"\r\n    [svgIcon]=\"layer.visible ? 'eye' : 'eye-off'\">\r\n  </mat-icon>\r\n</button>\r\n\r\n  <button *ngIf=\"!selectionMode\"\r\n    class=\"actions-button\"\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]= \"'igo.geo.layer.moreOptions' | translate\"\r\n    mat-icon-button\r\n    color=\"primary\"\r\n    (click)=\"toggleLayerTool()\">\r\n    <mat-icon svgIcon=\"dots-horizontal\"></mat-icon>\r\n  </button>\r\n</mat-list-item>\r\n\r\n<div #legend class=\"igo-layer-legend-container\">\r\n  <igo-layer-legend\r\n    *ngIf=\"showLegend$ | async\"\r\n    [layer]=\"layer\"\r\n    [updateLegendOnResolutionChange]=\"updateLegendOnResolutionChange\">\r\n  </igo-layer-legend>\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy,\r\n  Output,\r\n  EventEmitter,\r\n  Renderer2,\r\n  ElementRef,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\nimport { Subscription, BehaviorSubject } from 'rxjs';\r\n\r\nimport { MetadataLayerOptions } from '../../metadata/shared/metadata.interface';\r\nimport { layerIsQueryable } from '../../query/shared/query.utils';\r\nimport { Layer, TooltipType } from '../shared/layers';\r\nimport { NetworkService, ConnectionState } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'igo-layer-item',\r\n  templateUrl: './layer-item.component.html',\r\n  styleUrls: ['./layer-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class LayerItemComponent implements OnInit, OnDestroy {\r\n  public focusedCls = 'igo-layer-item-focused';\r\n\r\n  @Input()\r\n  get activeLayer() {\r\n    return this._activeLayer;\r\n  }\r\n  set activeLayer(value) {\r\n    if (value && this.layer && value.id === this.layer.id && !this.selectionMode) {\r\n      this.layerTool$.next(true);\r\n      this.renderer.addClass(this.elRef.nativeElement, this.focusedCls);\r\n    } else {\r\n      this.renderer.removeClass(this.elRef.nativeElement, this.focusedCls);\r\n    }\r\n  }\r\n  private _activeLayer;\r\n\r\n  layerTool$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  showLegend$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  inResolutionRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  queryBadgeHidden$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  tooltipText: string;\r\n\r\n  state: ConnectionState;\r\n\r\n  @Input()\r\n  get selectAll() {\r\n    return this._selectAll;\r\n  }\r\n  set selectAll(value: boolean) {\r\n    this._selectAll = value;\r\n    if (value === true) {\r\n      this.layerCheck = true;\r\n    }\r\n  }\r\n  private _selectAll = false;\r\n\r\n  @Input() layerCheck;\r\n\r\n  private resolution$$: Subscription;\r\n  private network$$: Subscription;\r\n  private layers$$: Subscription;\r\n\r\n  layers$: BehaviorSubject<Layer> = new BehaviorSubject<Layer>(undefined);\r\n\r\n  @Input()\r\n  get layer() {\r\n    return this._layer;\r\n  }\r\n  set layer(value) {\r\n    this._layer = value;\r\n    this.layers$.next(value);\r\n  }\r\n  private _layer;\r\n\r\n  @Input() toggleLegendOnVisibilityChange: boolean = false;\r\n\r\n  @Input() expandLegendIfVisible: boolean = false;\r\n\r\n  @Input() updateLegendOnResolutionChange: boolean = false;\r\n\r\n  @Input() orderable: boolean = true;\r\n\r\n  @Input() lowerDisabled: boolean = false;\r\n\r\n  @Input() raiseDisabled: boolean = false;\r\n\r\n  @Input() queryBadge: boolean = false;\r\n\r\n  @Input() selectionMode;\r\n\r\n  @Input() changeDetection;\r\n\r\n  get opacity() {\r\n    return this.layer.opacity * 100;\r\n  }\r\n  set opacity(opacity: number) {\r\n    this.layer.opacity = opacity / 100;\r\n  }\r\n\r\n  get eyeTooltip() {\r\n    if (this.inResolutionRange$.getValue() === false) {\r\n      return 'igo.geo.layer.notInResolution';\r\n    } else {\r\n      return this.layer.visible ? 'igo.geo.layer.hideLayer' : 'igo.geo.layer.showLayer';\r\n    }\r\n  }\r\n\r\n  @Output() action: EventEmitter<Layer> = new EventEmitter<Layer>(undefined);\r\n  @Output() checkbox = new EventEmitter<{\r\n    layer: Layer;\r\n    check: boolean;\r\n  }>();\r\n\r\n  constructor(\r\n    private networkService: NetworkService,\r\n    private renderer: Renderer2,\r\n    private elRef: ElementRef,\r\n    private cdRef: ChangeDetectorRef) {}\r\n\r\n  ngOnInit() {\r\n    if (\r\n      this.layer.visible &&\r\n      this.expandLegendIfVisible &&\r\n      this.layer.firstLoadComponent === true\r\n    ) {\r\n      this.layer.firstLoadComponent = false;\r\n      this.layer.legendCollapsed = false;\r\n    }\r\n    this.toggleLegend(this.layer.legendCollapsed);\r\n    this.updateQueryBadge();\r\n\r\n    const resolution$ = this.layer.map.viewController.resolution$;\r\n    this.resolution$$ = resolution$.subscribe(() => {\r\n      this.onResolutionChange();\r\n    });\r\n    this.tooltipText = this.computeTooltip();\r\n\r\n    this.network$$ = this.networkService.currentState().subscribe((state: ConnectionState) => {\r\n      this.state = state;\r\n      this.onResolutionChange();\r\n    });\r\n\r\n    this.layers$$ = this.layers$.subscribe(() => {\r\n      if (this.layer && this.layer.options.active) {\r\n        this.layerTool$.next(true);\r\n        this.renderer.addClass(this.elRef.nativeElement, this.focusedCls);\r\n      }\r\n    });\r\n\r\n    if (this.changeDetection) {\r\n      this.changeDetection.subscribe(() => this.cdRef.detectChanges());\r\n    }\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.resolution$$.unsubscribe();\r\n    this.network$$.unsubscribe();\r\n    this.layers$$.unsubscribe();\r\n  }\r\n\r\n  toggleLegend(collapsed: boolean) {\r\n    this.layer.legendCollapsed = collapsed;\r\n    this.showLegend$.next(!collapsed);\r\n  }\r\n\r\n  toggleLegendOnClick() {\r\n    this.toggleLegend(this.showLegend$.value);\r\n  }\r\n\r\n  toggleVisibility() {\r\n    this.layer.visible = !this.layer.visible;\r\n    if (this.toggleLegendOnVisibilityChange) {\r\n      this.toggleLegend(!this.layer.visible);\r\n    }\r\n    this.updateQueryBadge();\r\n  }\r\n\r\n  computeTooltip(): string {\r\n    const layerOptions = this.layer.options;\r\n    if (!layerOptions.tooltip) {\r\n      return this.layer.title;\r\n    }\r\n    const layerTooltip = layerOptions.tooltip;\r\n    const layerMetadata = (layerOptions as MetadataLayerOptions).metadata;\r\n    switch (layerOptions.tooltip.type) {\r\n      case TooltipType.TITLE:\r\n        return this.layer.title;\r\n      case TooltipType.ABSTRACT:\r\n        if (layerMetadata && layerMetadata.abstract) {\r\n          return layerMetadata.abstract;\r\n        } else {\r\n          return this.layer.title;\r\n        }\r\n      case TooltipType.CUSTOM:\r\n        if (layerTooltip && layerTooltip.text) {\r\n          return layerTooltip.text;\r\n        } else {\r\n          return this.layer.title;\r\n        }\r\n      default:\r\n        return this.layer.title;\r\n    }\r\n  }\r\n\r\n  private onResolutionChange() {\r\n    const inResolutionRange = this.layer.isInResolutionsRange;\r\n    if (\r\n      inResolutionRange === false &&\r\n      this.updateLegendOnResolutionChange === true\r\n    ) {\r\n      this.toggleLegend(true);\r\n    }\r\n    this.inResolutionRange$.next(inResolutionRange);\r\n  }\r\n\r\n  private updateQueryBadge() {\r\n    const hidden =\r\n      this.queryBadge === false ||\r\n      this.layer.visible === false ||\r\n      !layerIsQueryable(this.layer);\r\n    this.queryBadgeHidden$.next(hidden);\r\n  }\r\n\r\n  toggleLayerTool() {\r\n    this.layerTool$.next(!this.layerTool$.getValue());\r\n    if (this.layerTool$.getValue() === true) {\r\n      this.renderer.addClass(this.elRef.nativeElement, this.focusedCls);\r\n    } else {\r\n      this.renderer.removeClass(this.elRef.nativeElement, this.focusedCls);\r\n    }\r\n    this.action.emit(this.layer);\r\n  }\r\n\r\n  public check() {\r\n    this.layerCheck = !this.layerCheck;\r\n    this.checkbox.emit({layer: this.layer, check: this.layerCheck});\r\n  }\r\n}\r\n","export enum LayerListControlsEnum {\r\n  always = 'always',\r\n  never = 'never',\r\n  default = 'default'\r\n}\r\nexport enum LayerListSelectVisibleEnum {\r\n  ALL_VISIBLE = 'ALL_VISIBLE',\r\n  ALL_HIDDEN = 'ALL_HIDDEN',\r\n  MIXED = 'MIXED',\r\n  NULL = 'NULL'\r\n}\r\n\r\nexport enum LayerListDisplacement {\r\n  Raise = 'raise',\r\n  Lower = 'lower',\r\n}\r\n","<mat-list>\r\n  <igo-layer-list-tool *ngIf=\"showToolbar$ | async\"\r\n    floatLabel=\"auto\"\r\n    [layersAreAllVisible]=\"layersAreAllVisible\"\r\n    [term]=\"layerFilterAndSortOptions.keyword\"\r\n    [onlyVisible]=\"layerFilterAndSortOptions.onlyVisible\"\r\n    [sortAlpha]=\"layerFilterAndSortOptions.sortAlpha\"\r\n    (appliedFilterAndSort)=\"onAppliedFilterAndSortChange($event)\"\r\n    (selection)=\"toggleSelectionMode($event)\">\r\n  </igo-layer-list-tool>\r\n</mat-list>\r\n\r\n<mat-list-item *ngIf=\"selection\" class=\"select-all\">\r\n  <mat-checkbox\r\n    class=\"select-all-checkbox mat-subheading-2\"\r\n    [color]=\"!selectAllCheck && layersChecked.length > 0 ? 'accent' : 'primary'\"\r\n    (change)=\"selectAll()\"\r\n    [checked]=\"selectAllCheck\"\r\n    [indeterminate]=\"!selectAllCheck && layersChecked.length > 0\"> {{selectAllCheck ? ('igo.geo.layer.deselectAll' | translate) : ('igo.geo.layer.selectAll' | translate)}}\r\n  </mat-checkbox>\r\n</mat-list-item>\r\n<mat-divider></mat-divider>\r\n\r\n<igo-list #igoList [ngClass]=\"{'igo-list-tools-multi': selection, 'igo-list-tools-single': (layerTool && !selection), 'igo-list-no-tools': (!layerTool && !selection)}\" [navigation]=\"false\" [selection]=\"false\">\r\n  <ng-template ngFor let-layer let-i=\"index\" [ngForOf]=\"layers$ | async\">\r\n    <igo-layer-item *ngIf=\"!(excludeBaseLayers && layer.baseLayer)\"\r\n      igoListItem\r\n      [layer]=\"layer\"\r\n      [activeLayer]=\"activeLayer\"\r\n      [orderable]=\"orderable && !layer.baseLayer\"\r\n      [lowerDisabled]=\"getLowerLayer().id === layer.id\"\r\n      [raiseDisabled]=\"getUpperLayer().id === layer.id\"\r\n      [queryBadge]=\"queryBadge\"\r\n      [expandLegendIfVisible]=\"expandLegendOfVisibleLayers\"\r\n      [updateLegendOnResolutionChange]=\"updateLegendOnResolutionChange\"\r\n      [toggleLegendOnVisibilityChange]=\"toggleLegendOnVisibilityChange\"\r\n      [selectionMode]=\"selection\"\r\n      [selectAll]=\"selectAllCheck\"\r\n      [layerCheck]=\"layer.options.check\"\r\n      [changeDetection]=\"layerItemChangeDetection$\"\r\n      (action)=\"toggleLayerTool($event)\"\r\n      (checkbox)=\"layersCheck($event)\">\r\n    </igo-layer-item>\r\n  </ng-template>\r\n</igo-list>\r\n\r\n<igo-panel *ngIf=\"!selection && layerTool && activeLayer\" class=\"igo-layer-actions-container\" [title]=\"activeLayer.title\">\r\n  <div class=\"igo-layer-button-group\">\r\n    <button\r\n      *ngIf=\"isLayerRemovable(activeLayer)\"\r\n      class=\"delete-button\"\r\n      mat-icon-button\r\n      color=\"warn\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.layer.removeLayer' | translate\"\r\n      (click)=\"removeLayers()\">\r\n      <mat-icon svgIcon=\"delete\"></mat-icon>\r\n    </button>\r\n\r\n    <button\r\n      class=\"down-button\"\r\n      mat-icon-button\r\n      color=\"primary\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"(sortAlpha || onlyVisible || keyword) ? ('igo.geo.layer.filterLowerLayer' | translate) : ('igo.geo.layer.lowerLayer' | translate)\"\r\n      [disabled]=\"lowerDisabled\"\r\n      (click)=\"moveActiveLayer(activeLayer,layerListDisplacement.Lower)\">\r\n      <mat-icon [matBadge]=\"(sortAlpha || onlyVisible || keyword) ? '!' : ''\" matBadgeColor=\"warn\" matBadgeSize=\"medium\" [matBadgeHidden]=\"lowerDisabled\"\r\n                svgIcon=\"arrow-down\"></mat-icon>\r\n    </button>\r\n\r\n    <button\r\n      class=\"up-button\"\r\n      color=\"primary\"\r\n      mat-icon-button\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"(sortAlpha || onlyVisible || keyword) ? ('igo.geo.layer.filterRaiseLayer' | translate) : ('igo.geo.layer.raiseLayer' | translate)\"\r\n      [disabled]=\"raiseDisabled\"\r\n      (click)=\"moveActiveLayer(activeLayer,layerListDisplacement.Raise)\">\r\n      <mat-icon [matBadge]=\"(sortAlpha || onlyVisible || keyword) ? '!' : ''\" matBadgeColor=\"warn\" matBadgeSize=\"medium\" [matBadgeHidden]=\"raiseDisabled\"\r\n                svgIcon=\"arrow-up\"></mat-icon>\r\n    </button>\r\n\r\n    <!-- <label>{{ 'igo.geo.layer.opacity' | translate }} </label> -->\r\n    <button\r\n      class=\"opacity-button\"\r\n      color=\"primary\"\r\n      mat-icon-button\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matMenuTriggerFor]=\"opacityMenu\"\r\n      [matTooltip]=\"'igo.geo.layer.opacity' | translate\">\r\n      <mat-icon [matBadge]=\"badgeOpacity\" matBadgeColor=\"primary\" matBadgeSize=\"medium\" svgIcon=\"opacity\"></mat-icon>\r\n    </button>\r\n\r\n    <mat-menu #opacityMenu=\"matMenu\" class=\"mat-menu-opacity-slider\">\r\n      <div id=\"opacity-menu\">\r\n        <mat-slider\r\n          id=\"opacity-slider\"\r\n          color=\"primary\"\r\n          thumbLabel\r\n          tickInterval=\"5\"\r\n          step=\"5\"\r\n          [min]=\"0\"\r\n          [max]=\"100\"\r\n          [value]=\"opacity\"\r\n          (input)=\"changeOpacity($event)\"\r\n          [matTooltip]=\"'igo.geo.layer.opacity' | translate\"\r\n          (click) = \"$event.stopPropagation()\"\r\n          matTooltipShowDelay=\"500\"\r\n          tooltip-position=\"below\">\r\n        </mat-slider>\r\n      </div>\r\n    </mat-menu>\r\n\r\n    <button\r\n      *ngIf=\"activeLayerIsValid(activeLayer)\"\r\n      class=\"zoomLayer-button\"\r\n      color=\"primary\"\r\n      mat-icon-button\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.layer.zoomLayer' | translate\"\r\n      (click)=\"zoomLayerExtents(activeLayer)\">\r\n      <mat-icon matBadgeColor=\"primary\" matBadgeSize=\"medium\" svgIcon=\"magnify-scan\"></mat-icon>\r\n    </button>\r\n\r\n    <ng-container igoLayerItemToolbar\r\n      [ngTemplateOutlet]=\"templateLayerToolbar\"\r\n      [ngTemplateOutletContext]=\"{layer: activeLayer}\">\r\n    </ng-container>\r\n\r\n    <ng-content select=\"[igoLayerItemToolbar]\"></ng-content>\r\n  </div>\r\n</igo-panel>\r\n\r\n<igo-panel *ngIf=\"selection && layers.length > 0\" class=\"igo-layer-actions-container\" [title]=\"'igo.geo.layer.tools' | translate\">\r\n  <div class=\"actions-buttons-multi\">\r\n    <button\r\n      class=\"delete-button\"\r\n      mat-icon-button\r\n      color=\"warn\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [disabled]=\"layersChecked.length === 0\"\r\n      [matTooltip]=\"isAllLayersRemovable(layersChecked) ? ('igo.geo.layer.removeSelectedLayers' | translate) : 'igo.geo.layer.removeSelectedLayersRestriction' | translate\"\r\n      (click)=\"removeLayers(layersChecked)\">\r\n      <mat-icon [matBadge]=\"'!'\" matBadgeColor=\"warn\" matBadgeSize=\"medium\" [matBadgeHidden]=\"isAllLayersRemovable(layersChecked)\"\r\n                svgIcon=\"delete\"></mat-icon>\r\n    </button>\r\n\r\n    <button\r\n      class=\"eye-button\"\r\n      mat-icon-button\r\n      color=\"primary\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [disabled]=\"layersChecked.length === 0\"\r\n      [matTooltip]=\"statusSelectedLayersCheck === 'ALL_HIDDEN' ? ('igo.geo.layer.showSelectedLayers' | translate) : ('igo.geo.layer.hideSelectedLayers' | translate)\"\r\n      (click)=\"toggleVisibility(layersChecked)\">\r\n      <mat-icon\t[svgIcon]=\"(statusSelectedLayersCheck === 'ALL_HIDDEN') ? 'eye-off' : 'eye'\"></mat-icon>\r\n    </button>\r\n\r\n    <button\r\n      class=\"down-button\"\r\n      mat-icon-button\r\n      color=\"primary\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"(sortAlpha || onlyVisible || keyword) ? ('igo.geo.layer.filterLowerLayer' | translate) : ('igo.geo.layer.lowerLayer' | translate)\"\r\n      [disabled]=\"lowerDisabledSelection\"\r\n      (click)=\"lowerLayers(layersChecked)\">\r\n      <mat-icon [matBadge]=\"(sortAlpha || onlyVisible || keyword) ? '!' : ''\" matBadgeColor=\"warn\" matBadgeSize=\"medium\" [matBadgeHidden]=\"lowerDisabledSelection\"\r\n                svgIcon=\"arrow-down\"></mat-icon>\r\n    </button>\r\n\r\n    <button\r\n      class=\"up-button\"\r\n      color=\"primary\"\r\n      mat-icon-button\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"(sortAlpha || onlyVisible || keyword) ? ('igo.geo.layer.filterRaiseLayer' | translate) : ('igo.geo.layer.raiseLayer' | translate)\"\r\n      [disabled]=\"raiseDisabledSelection\"\r\n      (click)=\"raiseLayers(layersChecked)\">\r\n      <mat-icon [matBadge]=\"(sortAlpha || onlyVisible || keyword) ? '!' : ''\" matBadgeColor=\"warn\" matBadgeSize=\"medium\" [matBadgeHidden]=\"raiseDisabledSelection\"\r\n                svgIcon=\"arrow-up\"></mat-icon>\r\n    </button>\r\n\r\n    <button\r\n      class=\"opacity-button\"\r\n      color=\"primary\"\r\n      mat-icon-button\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [disabled]=\"layersChecked.length === 0\"\r\n      [matMenuTriggerFor]=\"opacityMenu\"\r\n      [matTooltip]=\"'igo.geo.layer.opacity' | translate\">\r\n      <mat-icon svgIcon=\"opacity\"></mat-icon>\r\n    </button>\r\n\r\n    <mat-menu #opacityMenu=\"matMenu\"  class=\"mat-menu-opacity-slider\">\r\n      <div id=\"opacity-menu\">\r\n        <mat-slider *ngIf=\"layersChecked.length\"\r\n          id=\"opacity-slider\"\r\n          color=\"primary\"\r\n          thumbLabel\r\n          tickInterval=\"5\"\r\n          step=\"5\"\r\n          [min]=\"0\"\r\n          [max]=\"100\"\r\n          [(ngModel)]=\"checkOpacity\"\r\n          [matTooltip]=\"'igo.geo.layer.opacity' | translate\"\r\n          matTooltipShowDelay=\"500\"\r\n          tooltip-position=\"below\"\r\n          (click) = \"$event.stopPropagation()\">\r\n        </mat-slider>\r\n      </div>\r\n    </mat-menu>\r\n\r\n    <button\r\n      *ngIf=\"layersChecked.length !== 0 && activeLayersAreValid(layersChecked)\"\r\n      class=\"zoomLayer-button\"\r\n      color=\"primary\"\r\n      mat-icon-button\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.layer.zoomLayers' | translate\"\r\n      (click)=\"zoomLayersExtents(layersChecked)\">\r\n      <mat-icon svgIcon=\"magnify-scan\"></mat-icon>\r\n    </button>\r\n  </div>\r\n</igo-panel>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  ContentChild,\r\n  OnInit,\r\n  OnDestroy,\r\n  Output,\r\n  EventEmitter,\r\n  ElementRef\r\n} from '@angular/core';\r\nimport type { TemplateRef } from '@angular/core';\r\n\r\nimport { FloatLabelType } from '@angular/material/form-field';\r\nimport { LayerListControlsEnum, LayerListDisplacement } from './layer-list.enum';\r\nimport { LayerListSelectVisibleEnum } from './layer-list.enum';\r\nimport {\r\n  BehaviorSubject,\r\n  ReplaySubject,\r\n  Subscription,\r\n  EMPTY,\r\n  timer\r\n} from 'rxjs';\r\nimport { debounce } from 'rxjs/operators';\r\nimport {\r\n  MetadataOptions,\r\n  MetadataLayerOptions\r\n} from '../../metadata/shared/metadata.interface';\r\nimport { LayerListControlsOptions } from '../layer-list-tool/layer-list-tool.interface';\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { Layer } from '../shared/layers/layer';\r\nimport { LinkedProperties, LayersLink } from '../shared/layers/layer.interface';\r\nimport { MatSliderChange } from '@angular/material/slider';\r\nimport * as olextent from 'ol/extent';\r\n\r\n// TODO: This class could use a clean up. Also, some methods could be moved ealsewhere\r\n@Component({\r\n  selector: 'igo-layer-list',\r\n  templateUrl: './layer-list.component.html',\r\n  styleUrls: ['./layer-list.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class LayerListComponent implements OnInit, OnDestroy {\r\n  orderable = true;\r\n  thresholdToFilterAndSort = 5;\r\n\r\n  layers$: BehaviorSubject<Layer[]> = new BehaviorSubject([]);\r\n\r\n  change$ = new ReplaySubject<void>(1);\r\n\r\n  showToolbar$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  public layerTool: boolean;\r\n\r\n  public hideSelectedLayers: boolean = true;\r\n  activeLayer$: BehaviorSubject<Layer> = new BehaviorSubject(undefined);\r\n\r\n  layersChecked: Layer[] = [];\r\n  public selection: boolean;\r\n\r\n  private change$$: Subscription;\r\n  private layers$$: Subscription;\r\n  public layerItemChangeDetection$ = new BehaviorSubject(undefined);\r\n\r\n  @ContentChild('igoLayerItemToolbar', /* TODO: add static flag */ {})\r\n  templateLayerToolbar: TemplateRef<any>;\r\n\r\n  @Input() layersAreAllVisible: boolean = true;\r\n\r\n  @Input() ogcButton: boolean = true;\r\n\r\n  @Input() timeButton: boolean = true;\r\n\r\n  @Input()\r\n  get map(): IgoMap {\r\n    return this._map;\r\n  }\r\n  set map(value: IgoMap) {\r\n    this._map = value;\r\n  }\r\n  private _map: IgoMap;\r\n\r\n  @Input()\r\n  set layers(value: Layer[]) {\r\n    this._layers = this.removeProblemLayerInList(value);\r\n    this.next();\r\n  }\r\n  get layers(): Layer[] {\r\n    return this._layers;\r\n  }\r\n  private _layers: Layer[];\r\n\r\n  set activeLayer(value: Layer) {\r\n    this._activeLayer = value;\r\n    this.activeLayer$.next(value);\r\n  }\r\n  get activeLayer(): Layer {\r\n    return this._activeLayer;\r\n  }\r\n  private _activeLayer: Layer;\r\n\r\n  @Input() floatLabel: FloatLabelType = 'auto';\r\n\r\n  @Input() layerFilterAndSortOptions: LayerListControlsOptions = {};\r\n\r\n  @Input() excludeBaseLayers: boolean = false;\r\n\r\n  @Input() toggleLegendOnVisibilityChange: boolean = false;\r\n\r\n  @Input() expandLegendOfVisibleLayers: boolean = false;\r\n\r\n  @Input() updateLegendOnResolutionChange: boolean = false;\r\n\r\n  @Input() queryBadge: boolean = false;\r\n\r\n  @Output() appliedFilterAndSort = new EventEmitter<LayerListControlsOptions>();\r\n\r\n  get keyword(): string {\r\n    return this._keyword;\r\n  }\r\n  set keyword(value: string) {\r\n    this._keyword = value;\r\n    this.next();\r\n  }\r\n  private _keyword = undefined;\r\n\r\n  get onlyVisible(): boolean {\r\n    return this._onlyVisible;\r\n  }\r\n  set onlyVisible(value: boolean) {\r\n    this._onlyVisible = value;\r\n    this.next();\r\n  }\r\n  private _onlyVisible = false;\r\n\r\n  get sortAlpha(): boolean {\r\n    return this._sortedAlpha;\r\n  }\r\n  set sortAlpha(value: boolean) {\r\n    this._sortedAlpha = value;\r\n    this.next();\r\n  }\r\n  private _sortedAlpha = false;\r\n\r\n  get opacity() {\r\n    return Math.round(this.activeLayer$.getValue().opacity * 100);\r\n  }\r\n  set opacity(opacity: number) {\r\n    this.activeLayer$.getValue().opacity = opacity / 100;\r\n  }\r\n\r\n  get badgeOpacity() {\r\n    if (this.opacity === 100) {\r\n      return;\r\n    }\r\n    return this.opacity;\r\n  }\r\n\r\n  get raiseDisabled(): boolean {\r\n    if (\r\n      !this.orderable ||\r\n      this.activeLayer.baseLayer ||\r\n      this.getUpperLayer().id === this.activeLayer.id ||\r\n      this.isUpperBaselayer(this.activeLayer)\r\n    ) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  get lowerDisabled(): boolean {\r\n    if (\r\n      !this.orderable ||\r\n      this.activeLayer.baseLayer ||\r\n      this.getLowerLayer().id === this.activeLayer.id ||\r\n      this.isLowerBaselayer(this.activeLayer)\r\n    ) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  get raiseDisabledSelection(): boolean {\r\n    if (\r\n      this.layersChecked.length === 0 ||\r\n      !this.orderable ||\r\n      !this.raisableLayers(this.layersChecked) ||\r\n      this.selectAllCheck === true\r\n    ) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  get lowerDisabledSelection(): boolean {\r\n    if (\r\n      this.layersChecked.length === 0 ||\r\n      !this.orderable ||\r\n      !this.lowerableLayers(this.layersChecked) ||\r\n      this.selectAllCheck === true\r\n    ) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  get checkOpacity() {\r\n    return this.layersCheckedOpacity() * 100;\r\n  }\r\n  set checkOpacity(opacity: number) {\r\n    for (const layer of this.layersChecked) {\r\n      layer.opacity = opacity / 100;\r\n    }\r\n  }\r\n\r\n  get layerListDisplacement(): typeof LayerListDisplacement {\r\n    return LayerListDisplacement;\r\n  }\r\n\r\n  public toggleOpacity = false;\r\n\r\n  public selectAllCheck: boolean;\r\n  public selectAllCheck$ = new BehaviorSubject<boolean>(undefined);\r\n  private selectAllCheck$$: Subscription;\r\n\r\n  constructor(private elRef: ElementRef) { }\r\n\r\n  /**\r\n   * Subscribe to the search term stream and trigger researches\r\n   * @internal\r\n   */\r\n  ngOnInit(): void {\r\n    this.change$$ = this.change$\r\n      .pipe(\r\n        debounce(() => {\r\n          return this.layers.length === 0 ? EMPTY : timer(50);\r\n        })\r\n      )\r\n      .subscribe(() => {\r\n        this.showToolbar$.next(this.computeShowToolbar());\r\n        this.layers$.next(this.computeLayers(this.layers.slice(0)));\r\n        this.appliedFilterAndSort.emit({\r\n          keyword: this.keyword,\r\n          sortAlpha: this.sortAlpha,\r\n          onlyVisible: this.onlyVisible\r\n        });\r\n      });\r\n\r\n    this.selectAllCheck$$ = this.selectAllCheck$.subscribe((value) => {\r\n      this.selectAllCheck = value;\r\n    });\r\n\r\n    this.layers$$ = this.layers$.subscribe(() => {\r\n      if (this.layers) {\r\n        let checks = 0;\r\n        for (const layer of this.layers) {\r\n          layer.status$.subscribe(valStatus => {\r\n            if (valStatus === 0) {\r\n              this.map.removeLayer(layer);\r\n            }\r\n          });\r\n          if (layer.options.active) {\r\n            this.activeLayer = layer;\r\n            this.layerTool = true;\r\n          }\r\n          if (layer.options.check) {\r\n            checks += 1;\r\n          }\r\n        }\r\n        if (this.excludeBaseLayers) {\r\n          this.selectAllCheck =\r\n            checks ===\r\n              this.layers.filter(\r\n                (lay) => lay.baseLayer !== true && lay.showInLayerList\r\n              ).length\r\n              ? true\r\n              : false;\r\n        } else {\r\n          this.selectAllCheck =\r\n            checks === this.layers.filter((lay) => lay.showInLayerList).length\r\n              ? true\r\n              : false;\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.change$$.unsubscribe();\r\n    this.selectAllCheck$$.unsubscribe();\r\n    this.layers$$.unsubscribe();\r\n  }\r\n\r\n  activeLayerIsValid(layer: Layer): boolean {\r\n    let valid = false;\r\n    const layerExtent = layer.options.extent;\r\n    const maxLayerZoomExtent = this.map.viewController.maxLayerZoomExtent;\r\n\r\n    if (layerExtent) {\r\n      if (maxLayerZoomExtent) {\r\n        valid = olextent.containsExtent(maxLayerZoomExtent, layerExtent);\r\n      } else {\r\n        valid = true;\r\n      }\r\n    }\r\n    return valid;\r\n  }\r\n\r\n  activeLayersAreValid(layers: Layer[]): boolean {\r\n    let valid = false;\r\n    const layersExtent = olextent.createEmpty();\r\n    const maxLayerZoomExtent = this.map.viewController.maxLayerZoomExtent;\r\n\r\n    for (const layer of layers) {\r\n      const layerExtent = layer.options.extent;\r\n\r\n      if (layerExtent && !layerExtent.includes(Infinity)) {\r\n        olextent.extend(layersExtent, layerExtent);\r\n      }\r\n    }\r\n\r\n    if (!olextent.isEmpty(layersExtent)) {\r\n      if (maxLayerZoomExtent) {\r\n        valid = (olextent.containsExtent(maxLayerZoomExtent, layersExtent));\r\n      } else {\r\n        valid = true;\r\n      }\r\n    }\r\n    return valid;\r\n  }\r\n\r\n  zoomLayerExtents(layer: Layer) {\r\n    this.map.viewController.zoomToExtent(layer.options.extent);\r\n  }\r\n\r\n  zoomLayersExtents(layers: Layer[]) {\r\n    const layersExtent = olextent.createEmpty() as [number, number, number, number];\r\n\r\n    for (const layer of layers) {\r\n      const layerExtent = layer.options.extent;\r\n\r\n      if (layerExtent) {\r\n        olextent.extend(layersExtent, layerExtent);\r\n      }\r\n    }\r\n    this.map.viewController.zoomToExtent(layersExtent);\r\n  }\r\n\r\n  changeOpacity(event: MatSliderChange){\r\n    this.opacity = event.value;\r\n  }\r\n\r\n  clearKeyword() {\r\n    this.keyword = undefined;\r\n  }\r\n\r\n  getLowerLayer() {\r\n    return this.layers\r\n      .filter((l) => !l.baseLayer)\r\n      .reduce(\r\n        (prev, current) => {\r\n          return prev.zIndex < current.zIndex ? prev : current;\r\n        },\r\n        { zIndex: undefined, id: undefined }\r\n      );\r\n  }\r\n\r\n  isLowerBaselayer(layer) {\r\n    const index = this.layers.findIndex((lay) => layer.id === lay.id);\r\n    if (\r\n      this.layers &&\r\n      this.layers[index + 1] &&\r\n      this.layers[index + 1].baseLayer === true\r\n    ) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  getUpperLayer() {\r\n    return this.layers\r\n      .filter((l) => !l.baseLayer)\r\n      .reduce(\r\n        (prev, current) => {\r\n          return prev.zIndex > current.zIndex ? prev : current;\r\n        },\r\n        { zIndex: undefined, id: undefined }\r\n      );\r\n  }\r\n\r\n  isUpperBaselayer(layer) {\r\n    const index = this.layers.findIndex((lay) => layer.id === lay.id);\r\n    if (\r\n      this.layers &&\r\n      this.layers[index - 1] &&\r\n      this.layers[index - 1].baseLayer === true\r\n    ) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  moveActiveLayer(activeLayer: Layer, actiontype: LayerListDisplacement) {\r\n    const layersToMove = [activeLayer];\r\n    const sortedLayersToMove = [];\r\n    this.getLinkedLayers(activeLayer, layersToMove);\r\n    this.layers.map(layer => {\r\n      if (layersToMove.indexOf(layer) !== -1) {\r\n        sortedLayersToMove.push(layer);\r\n      }\r\n    });\r\n\r\n    if (actiontype === LayerListDisplacement.Raise) {\r\n      this.raiseLayers(sortedLayersToMove, false);\r\n    } else if (actiontype === LayerListDisplacement.Lower) {\r\n      this.lowerLayers(sortedLayersToMove, false);\r\n    }\r\n  }\r\n\r\n  private getLinkedLayers(activeLayer: Layer, layersList: Layer[]) {\r\n    const linkedLayers = activeLayer.options.linkedLayers as LayersLink;\r\n    if (!linkedLayers) {\r\n      return;\r\n    }\r\n    const currentLinkedId = linkedLayers.linkId;\r\n    const currentLinks = linkedLayers.links;\r\n    const isParentLayer = currentLinks ? true : false;\r\n\r\n    if (isParentLayer) {\r\n      // search for child layers\r\n      currentLinks.map(link => {\r\n        if (!link.properties || link.properties.indexOf(LinkedProperties.ZINDEX) === -1) {\r\n          return;\r\n        }\r\n        link.linkedIds.map(linkedId => {\r\n          const childLayer = this.layers.find(layer => layer.options.linkedLayers?.linkId === linkedId);\r\n          if (childLayer) {\r\n            if (!layersList.includes(childLayer)) {\r\n              layersList.push(childLayer);\r\n            }\r\n          }\r\n        });\r\n      });\r\n    } else {\r\n      // search for parent layer\r\n      this.layers.map(parentLayer => {\r\n        if (parentLayer.options.linkedLayers?.links) {\r\n          parentLayer.options.linkedLayers.links.map(l => {\r\n            if (\r\n              l.properties?.indexOf(LinkedProperties.ZINDEX) !== -1 &&\r\n              l.bidirectionnal !== false &&\r\n              l.linkedIds.indexOf(currentLinkedId) !== -1) {\r\n              layersList.push(parentLayer);\r\n              this.getLinkedLayers(parentLayer, layersList);\r\n            }\r\n          });\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  /*\r\n   * For selection mode disabled attribute\r\n   */\r\n  raisableLayers(layers: Layer[]) {\r\n    let response = false;\r\n    let base = 0;\r\n    for (const layer of layers) {\r\n      const mapIndex = this.layers.findIndex((lay) => layer.id === lay.id);\r\n      const currentLayer = this.layers[mapIndex];\r\n      if (currentLayer.baseLayer) {\r\n        base += 1;\r\n      }\r\n\r\n      const previousLayer = this.layers[mapIndex - 1];\r\n      if (\r\n        previousLayer &&\r\n        previousLayer.baseLayer !== true &&\r\n        !layers.find((lay) => previousLayer.id === lay.id) &&\r\n        currentLayer.baseLayer !== true\r\n      ) {\r\n        response = true;\r\n      }\r\n    }\r\n\r\n    if (\r\n      (this.layersChecked.length === 1 && this.layersChecked[0].baseLayer) ||\r\n      base === this.layersChecked.length\r\n    ) {\r\n      response = false;\r\n    }\r\n    return response;\r\n  }\r\n\r\n  /*\r\n   * When multiple layers is selected but some may be allow to move\r\n   */\r\n  raisableLayer(index: number) {\r\n    if (index < 1) {\r\n      return false;\r\n    }\r\n\r\n    if (this.layers[index - 1].options.check) {\r\n      return this.raisableLayer(index - 1);\r\n    }\r\n    return true;\r\n  }\r\n\r\n  raiseLayers(layers: Layer[], fromUi: boolean = true) {\r\n    const layersToRaise = [];\r\n    for (const layer of layers) {\r\n      const index = this.layers.findIndex((lay) => lay.id === layer.id);\r\n      if (this.raisableLayer(index)) {\r\n        layersToRaise.push(layer);\r\n      }\r\n    }\r\n    this.map.raiseLayers(layersToRaise);\r\n    if (fromUi) {\r\n      setTimeout(() => {\r\n        const elements = this.computeElementRef();\r\n        if (!this.isScrolledIntoView(elements[0], elements[1].offsetParent)) {\r\n          elements[0].scrollTop = elements[1].offsetParent.offsetTop;\r\n        }\r\n      }, 100);\r\n    }\r\n  }\r\n  /*\r\n   * For selection mode disabled attribute\r\n   */\r\n  lowerableLayers(layers: Layer[]) {\r\n    let response = false;\r\n    let base = 0;\r\n    for (const layer of layers) {\r\n      const mapIndex = this.layers.findIndex((lay) => layer.id === lay.id);\r\n      const currentLayer = this.layers[mapIndex];\r\n      if (currentLayer.baseLayer) {\r\n        base += 1;\r\n      }\r\n\r\n      const nextLayer = this.layers[mapIndex + 1];\r\n      if (\r\n        nextLayer &&\r\n        nextLayer.baseLayer !== true &&\r\n        !layers.find((lay) => nextLayer.id === lay.id)\r\n      ) {\r\n        response = true;\r\n      }\r\n    }\r\n\r\n    if (\r\n      (this.layersChecked.length === 1 && this.layersChecked[0].baseLayer) ||\r\n      base === this.layersChecked.length\r\n    ) {\r\n      response = false;\r\n    }\r\n    return response;\r\n  }\r\n\r\n  /*\r\n   * When multiple layers is selected but some may be allow to move\r\n   */\r\n  lowerableLayer(index: number) {\r\n    if (\r\n      index >\r\n      this.layers.filter((lay) => lay.baseLayer !== true).length - 2\r\n    ) {\r\n      return false;\r\n    }\r\n\r\n    if (this.layers[index + 1].options.check) {\r\n      return this.lowerableLayer(index + 1);\r\n    }\r\n    return true;\r\n  }\r\n\r\n  lowerLayers(layers: Layer[], fromUi: boolean = true) {\r\n    const layersToLower = [];\r\n    for (const layer of layers) {\r\n      const index = this.layers.findIndex((lay) => lay.id === layer.id);\r\n      if (this.lowerableLayer(index)) {\r\n        layersToLower.push(layer);\r\n      }\r\n    }\r\n    this.map.lowerLayers(layersToLower);\r\n    if (fromUi) {\r\n      setTimeout(() => {\r\n        const elements = this.computeElementRef('lower');\r\n        if (!this.isScrolledIntoView(elements[0], elements[1].offsetParent)) {\r\n          elements[0].scrollTop =\r\n            elements[1].offsetParent.offsetTop +\r\n            elements[1].offsetParent.offsetHeight -\r\n            elements[0].clientHeight;\r\n        }\r\n      }, 100);\r\n    }\r\n  }\r\n  private next() {\r\n    this.change$.next();\r\n  }\r\n\r\n  private computeLayers(layers: Layer[]): Layer[] {\r\n    let layersOut = this.filterLayers(layers);\r\n    if (this.sortAlpha) {\r\n      layersOut = this.sortLayersByTitle(layersOut);\r\n    } else {\r\n      layersOut = this.sortLayersByZindex(layersOut);\r\n    }\r\n    return layersOut;\r\n  }\r\n\r\n  onKeywordChange(term) {\r\n    this.keyword = term;\r\n  }\r\n\r\n  onAppliedFilterAndSortChange(appliedFilter: LayerListControlsOptions) {\r\n    this.keyword = appliedFilter.keyword;\r\n    this.onlyVisible = appliedFilter.onlyVisible;\r\n    this.sortAlpha = appliedFilter.sortAlpha;\r\n  }\r\n\r\n  private filterLayers(layers: Layer[]): Layer[] {\r\n    if (\r\n      this.layerFilterAndSortOptions.showToolbar === LayerListControlsEnum.never\r\n    ) {\r\n      return layers;\r\n    }\r\n    if (!this.keyword && !this.onlyVisible) {\r\n      return layers;\r\n    }\r\n\r\n    const keepLayerIds = layers.map((layer: Layer) => layer.id);\r\n\r\n    layers.forEach((layer: Layer) => {\r\n      const layerOptions = (layer.options as MetadataLayerOptions) || {};\r\n      const dataSourceOptions = layer.dataSource.options || {};\r\n      const metadata = layerOptions.metadata || ({} as MetadataOptions);\r\n      const keywords = metadata.keywordList || [];\r\n      const layerKeywords = keywords.map((kw: string) => {\r\n        return kw.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n      });\r\n\r\n      if (this.keyword && layer.title) {\r\n        const localKeyword = this.keyword\r\n          .normalize('NFD')\r\n          .replace(/[\\u0300-\\u036f]/g, '');\r\n        const layerTitle = layer.title\r\n          .normalize('NFD')\r\n          .replace(/[\\u0300-\\u036f]/g, '');\r\n        const dataSourceType = dataSourceOptions.type || '';\r\n        const keywordRegex = new RegExp(localKeyword, 'gi');\r\n        const keywordInList =\r\n          layerKeywords.find((kw: string) => keywordRegex.test(kw)) !==\r\n          undefined;\r\n        if (\r\n          !keywordRegex.test(layerTitle) &&\r\n          !(this.keyword.toLowerCase() === dataSourceType.toLowerCase()) &&\r\n          !keywordInList\r\n        ) {\r\n          const index = keepLayerIds.indexOf(layer.id);\r\n          if (index > -1) {\r\n            keepLayerIds.splice(index, 1);\r\n          }\r\n        }\r\n      }\r\n\r\n      if (this.onlyVisible && layer.visible === false) {\r\n        const index = keepLayerIds.indexOf(layer.id);\r\n        if (index > -1) {\r\n          keepLayerIds.splice(index, 1);\r\n        }\r\n      }\r\n    });\r\n\r\n    return layers.filter(\r\n      (layer: Layer) => keepLayerIds.indexOf(layer.id) !== -1\r\n    );\r\n  }\r\n\r\n  private sortLayersByZindex(layers: Layer[]) {\r\n    return layers.sort((layer1, layer2) => layer2.zIndex - layer1.zIndex);\r\n  }\r\n\r\n  private sortLayersByTitle(layers: Layer[]) {\r\n    return layers.sort((a, b) => {\r\n      if (this.normalize(a.title) < this.normalize(b.title)) {\r\n        return -1;\r\n      }\r\n      if (this.normalize(a.title) > this.normalize(b.title)) {\r\n        return 1;\r\n      }\r\n      return 0;\r\n    });\r\n  }\r\n\r\n  private normalize(str: string) {\r\n    return str\r\n      .normalize('NFD')\r\n      .replace(/[\\u0300-\\u036f]/g, '')\r\n      .toLowerCase();\r\n  }\r\n\r\n  private computeShowToolbar(): boolean {\r\n    switch (this.layerFilterAndSortOptions.showToolbar) {\r\n      case LayerListControlsEnum.always:\r\n        return true;\r\n      case LayerListControlsEnum.never:\r\n        return false;\r\n      default:\r\n        if (\r\n          this.layers.length >= this.thresholdToFilterAndSort ||\r\n          this.keyword ||\r\n          this.onlyVisible\r\n        ) {\r\n          return true;\r\n        }\r\n        return false;\r\n    }\r\n  }\r\n\r\n  toggleLayerTool(layer) {\r\n    this.toggleOpacity = false;\r\n    if (this.layerTool && layer === this.activeLayer) {\r\n      this.layerTool = false;\r\n    } else {\r\n      this.layerTool = true;\r\n    }\r\n\r\n    for (const lay of this.layers) {\r\n      lay.options.active = false;\r\n    }\r\n    layer.options.active = true;\r\n    this.activeLayer = layer;\r\n  }\r\n\r\n  removeLayers(layers?: Layer[]) {\r\n    if (layers && layers.length > 0) {\r\n      this.layersChecked = [];\r\n      for (const layer of layers) {\r\n        if (layer.options.removable !== false) {\r\n          layer.map.removeLayer(layer);\r\n        } else {\r\n          this.layersChecked.push(layer);\r\n        }\r\n      }\r\n    } else if (!layers && this.activeLayer.options.removable !== false) {\r\n      this.activeLayer.map.removeLayer(this.activeLayer);\r\n      this.layerTool = false;\r\n    }\r\n  }\r\n\r\n  toggleVisibility(layers?: Layer[]) {\r\n    if (layers && layers.length > 0) {\r\n      for (const layer of layers) {\r\n        layer.visible = this.hideSelectedLayers;\r\n      }\r\n    }\r\n    this.layerItemChangeDetection$.next(true);\r\n  }\r\n\r\n  isLayerRemovable(layer: Layer): boolean {\r\n    return layer.options.removable !== false;\r\n  }\r\n\r\n  isAllLayersRemovable(layers: Layer[]): boolean {\r\n    return layers.every(l => this.isLayerRemovable(l));\r\n  }\r\n\r\n  get statusSelectedLayersCheck(): LayerListSelectVisibleEnum {\r\n    let statusSelectedLayers: LayerListSelectVisibleEnum =\r\n      LayerListSelectVisibleEnum.NULL;\r\n    let findTrue: boolean = false;\r\n    let findFalse: boolean = false;\r\n\r\n    if (this.layersChecked.length === 0) {\r\n      statusSelectedLayers = LayerListSelectVisibleEnum.NULL;\r\n    } else {\r\n      statusSelectedLayers = LayerListSelectVisibleEnum.MIXED;\r\n      this.hideSelectedLayers = false;\r\n\r\n      for (const layer2 of this.layersChecked) {\r\n        if (layer2.visible === true) {\r\n          findTrue = true;\r\n        }\r\n        if (layer2.visible === false) {\r\n          findFalse = true;\r\n        }\r\n      }\r\n\r\n      if (findTrue === true && findFalse === false) {\r\n        statusSelectedLayers = LayerListSelectVisibleEnum.ALL_VISIBLE;\r\n      }\r\n      if (findTrue === false && findFalse === true) {\r\n        statusSelectedLayers = LayerListSelectVisibleEnum.ALL_HIDDEN;\r\n        this.hideSelectedLayers = true;\r\n      }\r\n    }\r\n\r\n    return statusSelectedLayers;\r\n  }\r\n\r\n  layersCheck(event: { layer: Layer; check: boolean }) {\r\n    event.layer.options.check = event.check;\r\n    if (event.check === true) {\r\n      const eventMapIndex = this.layers.findIndex(\r\n        (layer) => event.layer.id === layer.id\r\n      );\r\n      for (const layer of this.layersChecked) {\r\n        const mapIndex = this.layers.findIndex((lay) => layer.id === lay.id);\r\n        if (eventMapIndex < mapIndex) {\r\n          this.layersChecked.splice(\r\n            this.layersChecked.findIndex((lay) => layer.id === lay.id),\r\n            0,\r\n            event.layer\r\n          );\r\n\r\n          if (this.excludeBaseLayers) {\r\n            if (\r\n              this.layersChecked.length ===\r\n              this.layers.filter(\r\n                (lay) => lay.baseLayer !== true && lay.showInLayerList\r\n              ).length\r\n            ) {\r\n              this.selectAllCheck = true;\r\n            } else {\r\n              this.selectAllCheck = false;\r\n            }\r\n          } else if (!this.excludeBaseLayers) {\r\n            if (\r\n              this.layersChecked.length ===\r\n              this.layers.filter((lay) => lay.showInLayerList).length\r\n            ) {\r\n              this.selectAllCheck = true;\r\n            } else {\r\n              this.selectAllCheck = false;\r\n            }\r\n          }\r\n          return;\r\n        }\r\n      }\r\n      this.layersChecked.push(event.layer);\r\n    } else {\r\n      const index = this.layersChecked.findIndex(\r\n        (layer) => event.layer.id === layer.id\r\n      );\r\n      this.layersChecked.splice(index, 1);\r\n    }\r\n\r\n    if (this.excludeBaseLayers) {\r\n      if (\r\n        this.layersChecked.length ===\r\n        this.layers.filter(\r\n          (lay) => lay.baseLayer !== true && lay.showInLayerList\r\n        ).length\r\n      ) {\r\n        this.selectAllCheck = true;\r\n      } else {\r\n        this.selectAllCheck = false;\r\n      }\r\n    } else if (!this.excludeBaseLayers) {\r\n      if (\r\n        this.layersChecked.length ===\r\n        this.layers.filter((lay) => lay.showInLayerList).length\r\n      ) {\r\n        this.selectAllCheck = true;\r\n      } else {\r\n        this.selectAllCheck = false;\r\n      }\r\n    }\r\n  }\r\n\r\n  toggleSelectionMode(value: boolean) {\r\n    this.selection = value;\r\n    this.activeLayer = undefined;\r\n    if (value === true) {\r\n      this.layerTool = false;\r\n      for (const layer of this.layers) {\r\n        if (layer.options.check) {\r\n          this.layersChecked.push(layer);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  layersCheckedOpacity(): any {\r\n    if (this.layersChecked.length > 1) {\r\n      return 1;\r\n    } else {\r\n      const opacity = [];\r\n      for (const layer of this.layersChecked) {\r\n        opacity.push(layer.opacity);\r\n      }\r\n      return opacity;\r\n    }\r\n  }\r\n\r\n  selectAll() {\r\n    if (!this.selectAllCheck) {\r\n      for (const layer of this.layers) {\r\n        if (\r\n          this.excludeBaseLayers &&\r\n          layer.baseLayer !== true &&\r\n          layer.showInLayerList\r\n        ) {\r\n          layer.options.check = true;\r\n          this.layersChecked.push(layer);\r\n        } else if (!this.excludeBaseLayers && layer.showInLayerList) {\r\n          layer.options.check = true;\r\n          this.layersChecked.push(layer);\r\n        }\r\n      }\r\n      this.selectAllCheck$.next(true);\r\n    } else {\r\n      for (const layer of this.layers) {\r\n        layer.options.check = false;\r\n      }\r\n      this.layersChecked = [];\r\n      this.selectAllCheck$.next(false);\r\n    }\r\n  }\r\n\r\n  isScrolledIntoView(elemSource, elem) {\r\n    const docViewTop = elemSource.scrollTop;\r\n    const docViewBottom = docViewTop + elemSource.clientHeight;\r\n\r\n    const elemTop = elem.offsetTop;\r\n    const elemBottom = elemTop + elem.clientHeight;\r\n    return elemBottom <= docViewBottom && elemTop >= docViewTop;\r\n  }\r\n\r\n  computeElementRef(type?: string) {\r\n    const checkItems = this.elRef.nativeElement.getElementsByClassName(\r\n      'mat-checkbox-checked'\r\n    );\r\n    const checkItem =\r\n      type === 'lower'\r\n        ? this.elRef.nativeElement.getElementsByClassName(\r\n          'mat-checkbox-checked'\r\n        )[checkItems.length - 1]\r\n        : this.elRef.nativeElement.getElementsByClassName(\r\n          'mat-checkbox-checked'\r\n        )[0];\r\n    const igoList = this.elRef.nativeElement.getElementsByTagName(\r\n      'igo-list'\r\n    )[0];\r\n\r\n    return [igoList, checkItem];\r\n  }\r\n\r\n  removeProblemLayerInList(layersList: Layer[]): Layer[] {\r\n    for (const layer of layersList) {\r\n      if (layer.olLoadingProblem === true) {\r\n        this.map.removeLayer(layer);\r\n      }\r\n    }\r\n    return layersList;\r\n  }\r\n}\r\n","  <mat-list-item>\r\n      <mat-form-field class=\"inputFilter\" [floatLabel]=\"floatLabel\">\r\n        <input\r\n          matInput\r\n          [placeholder]=\"'igo.geo.layer.filterPlaceholder' | translate\"\r\n          [matTooltip]=\"'igo.geo.layer.subsetLayersListKeyword' | translate\"\r\n          matTooltipShowDelay=\"500\"\r\n          type=\"text\" [(ngModel)]=\"term\">\r\n        <button\r\n          mat-button\r\n          *ngIf=\"term\"\r\n          matSuffix\r\n          mat-icon-button\r\n          aria-label=\"Clear\"\r\n          color=\"warn\"\r\n          (click)=\"clearTerm()\">\r\n          <mat-icon svgIcon=\"close\"></mat-icon>\r\n        </button>\r\n      </mat-form-field>\r\n\r\n      <div [matTooltip]=\"sortAlpha ?\r\n      ('igo.geo.layer.sortMapOrder' | translate) :\r\n      ('igo.geo.layer.sortAlphabetically' | translate)\" matTooltipShowDelay=\"500\">\r\n        <button class=\"sort-alpha\" [color]=\"sortAlpha ? 'warn' : 'primary'\" mat-icon-button (click)=\"toggleSortAlpha()\">\r\n          <mat-icon [svgIcon]=\"sortAlpha ? 'sort-ascending' : 'sort-alphabetical-ascending'\"></mat-icon>\r\n        </button>\r\n      </div>\r\n\r\n       <div [matTooltip]=\"onlyVisible ?\r\n        ('igo.geo.layer.resetLayersList' | translate) :\r\n        ('igo.geo.layer.subsetLayersListOnlyVisible' | translate)\" matTooltipShowDelay=\"500\">\r\n         <button class=\"only-visible\" mat-icon-button [disabled]=\"layersAreAllVisible && !onlyVisible\"\r\n           [color]=\"onlyVisible ? 'warn' : 'primary'\" (click)=\"toggleOnlyVisible()\">\r\n           <mat-icon\r\n             matBadge=\"icon\"\r\n             igoMatBadgeIcon=\"eye\"\r\n             igoMatBadgeInverseColor=\"true\"\r\n             igoMatBadgeInheritColor=\"true\"\r\n             [svgIcon]=\"onlyVisible ? 'filter-remove' : 'filter'\">\r\n           </mat-icon>\r\n         </button>\r\n       </div>\r\n\r\n       <div [matTooltip]=\"selectionMode ?\r\n        ('igo.geo.layer.deactivateSelectionMode' | translate) :\r\n        ('igo.geo.layer.activateSelectionMode' | translate)\" matTooltipShowDelay=\"500\">\r\n         <button class=\"selection-mode\" mat-icon-button\r\n           color=\"primary\" (click)=\"toggleSelectionMode()\">\r\n           <mat-icon [svgIcon]=\"selectionMode ? 'checkbox-multiple-marked-outline' : 'checkbox-multiple-blank-outline'\"></mat-icon>\r\n         </button>\r\n       </div>\r\n\r\n</mat-list-item>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  EventEmitter,\r\n  Output,\r\n  OnDestroy\r\n} from '@angular/core';\r\nimport { FloatLabelType } from '@angular/material/form-field';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport { LayerListControlsOptions } from './layer-list-tool.interface';\r\n\r\n@Component({\r\n  selector: 'igo-layer-list-tool',\r\n  templateUrl: './layer-list-tool.component.html',\r\n  styleUrls: ['./layer-list-tool.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class LayerListToolComponent implements OnInit, OnDestroy {\r\n  public onlyVisible$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  public sortAlpha$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  public term$: BehaviorSubject<string> = new BehaviorSubject(undefined);\r\n  onlyVisible$$: Subscription;\r\n  sortAlpha$$: Subscription;\r\n  term$$: Subscription;\r\n\r\n  @Input() layersAreAllVisible: boolean = true;\r\n\r\n  @Input() floatLabel: FloatLabelType = 'auto';\r\n\r\n  @Input()\r\n  set onlyVisible(value: boolean) {\r\n    this.onlyVisible$.next(value);\r\n  }\r\n  get onlyVisible(): boolean {\r\n    return this.onlyVisible$.value;\r\n  }\r\n\r\n  @Input()\r\n  set sortAlpha(value: boolean) {\r\n    this.sortAlpha$.next(value);\r\n  }\r\n  get sortAlpha(): boolean {\r\n    return this.sortAlpha$.value;\r\n  }\r\n\r\n  @Input()\r\n  set term(value: string) {\r\n    this.term$.next(value);\r\n  }\r\n  get term(): string {\r\n    return this.term$.value;\r\n  }\r\n\r\n  public selectionMode = false;\r\n\r\n  @Output() appliedFilterAndSort = new EventEmitter<LayerListControlsOptions>();\r\n  @Output() selection = new EventEmitter<boolean>();\r\n\r\n  ngOnInit(): void {\r\n    this.term$$ = this.term$.subscribe(keyword => {\r\n      this.appliedFilterAndSort.emit({\r\n        keyword,\r\n        onlyVisible: this.onlyVisible,\r\n        sortAlpha: this.sortAlpha\r\n      });\r\n    });\r\n\r\n    this.onlyVisible$$ = this.onlyVisible$.subscribe(onlyVisible => {\r\n      this.appliedFilterAndSort.emit({\r\n        keyword: this.term,\r\n        onlyVisible,\r\n        sortAlpha: this.sortAlpha\r\n      });\r\n    });\r\n    this.sortAlpha$$ = this.sortAlpha$.subscribe(sortAlpha => {\r\n      this.appliedFilterAndSort.emit({\r\n        keyword: this.term,\r\n        onlyVisible: this.onlyVisible,\r\n        sortAlpha\r\n      });\r\n    });\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this.onlyVisible$$.unsubscribe();\r\n    this.sortAlpha$$.unsubscribe();\r\n    this.term$$.unsubscribe();\r\n  }\r\n\r\n  clearTerm() {\r\n    this.term = undefined;\r\n  }\r\n  toggleSortAlpha() {\r\n    this.sortAlpha = !this.sortAlpha;\r\n  }\r\n\r\n  toggleOnlyVisible() {\r\n    this.onlyVisible = !this.onlyVisible;\r\n  }\r\n\r\n  toggleSelectionMode() {\r\n    this.selectionMode = !this.selectionMode;\r\n    this.selection.emit(this.selectionMode);\r\n  }\r\n}\r\n","import { Directive, Self, OnInit, OnDestroy, Optional } from '@angular/core';\r\nimport { Subscription, combineLatest } from 'rxjs';\r\n\r\nimport { RouteService } from '@igo2/core';\r\nimport { MapService } from '../../map/shared/map.service';\r\nimport { LayerListComponent } from './layer-list.component';\r\nimport { Layer } from '../shared/layers/layer';\r\nimport { map, debounceTime } from 'rxjs/operators';\r\n\r\n@Directive({\r\n  selector: '[igoLayerListBinding]'\r\n})\r\nexport class LayerListBindingDirective implements OnInit, OnDestroy {\r\n  private component: LayerListComponent;\r\n  private layersOrResolutionChange$$: Subscription;\r\n  layersVisibility$$: Subscription;\r\n\r\n  constructor(\r\n    @Self() component: LayerListComponent,\r\n    private mapService: MapService,\r\n    @Optional() private route: RouteService\r\n  ) {\r\n    this.component = component;\r\n  }\r\n\r\n  ngOnInit() {\r\n    // Override input layers\r\n    // this.component.layers = [];\r\n    this.layersOrResolutionChange$$ = combineLatest([\r\n      this.mapService.getMap().layers$,\r\n      this.mapService.getMap().viewController.resolution$]\r\n    ).pipe(\r\n      debounceTime(10)\r\n    ).subscribe((bunch: [Layer[], number]) => {\r\n      const shownLayers = bunch[0].filter((layer: Layer) => {\r\n        return layer.showInLayerList === true;\r\n      });\r\n      this.component.layers = shownLayers;\r\n      this.setLayersVisibilityStatus(shownLayers, this.component.excludeBaseLayers);\r\n    });\r\n  }\r\n\r\n  private setLayersVisibilityStatus(layers: Layer[], excludeBaseLayers: boolean) {\r\n    if (this.layersVisibility$$ !== undefined) {\r\n      this.layersVisibility$$.unsubscribe();\r\n      this.layersVisibility$$ = undefined;\r\n    }\r\n    this.layersVisibility$$ = combineLatest(layers\r\n      .filter(layer => layer.baseLayer !== excludeBaseLayers )\r\n      .map((layer: Layer) => layer.visible$))\r\n      .pipe(map((visibles: boolean[]) => visibles.every(Boolean)))\r\n      .subscribe((allLayersAreVisible: boolean) =>\r\n        this.component.layersAreAllVisible = allLayersAreVisible);\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.layersOrResolutionChange$$.unsubscribe();\r\n    if (this.layersVisibility$$ !== undefined) {\r\n      this.layersVisibility$$.unsubscribe();\r\n      this.layersVisibility$$ = undefined;\r\n    }\r\n  }\r\n\r\n}\r\n","\r\n<div class=\"layer-legend-list-container\">\r\n  <mat-slide-toggle \r\n  tooltip-position=\"above\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.layer.legend.showAll' | translate\"\r\n  [checked]=\"showAllLegendsValue\" class=\"mat-typography\" \r\n  *ngIf=\"(layersInUi$ | async).length && allowShowAllLegends\" [labelPosition]=\"'before'\" (change)=\"toggleShowAllLegends($event.checked)\">\r\n    {{'igo.geo.layer.legend.showAll' | translate}}\r\n  </mat-slide-toggle>\r\n  <mat-divider *ngIf=\"(layersInUi$ | async).length && allowShowAllLegends\"></mat-divider>\r\n  <igo-list [navigation]=\"false\" [selection]=\"false\">\r\n    <ng-template ngFor let-layer let-i=\"index\" [ngForOf]=\"layers$ | async\">\r\n      <igo-layer-legend-item *ngIf=\"!(excludeBaseLayers && layer.baseLayer)\"\r\n          igoListItem [layer]=\"layer\"\r\n          [updateLegendOnResolutionChange]=\"updateLegendOnResolutionChange\">\r\n      </igo-layer-legend-item>\r\n    </ng-template>\r\n  </igo-list>\r\n  <p class=\"layers-empty mat-typography\" \r\n    *ngIf=\"!showAllLegendsValue && (layersInUi$ | async).length && (hasVisibleOrInRangeLayers$ | async)===false && (hasVisibleAndNotInRangeLayers$ | async)===false && allowShowAllLegends\">\r\n    {{'igo.geo.layer.legend.noLayersVisibleWithShowAllButton' | translate}} \r\n  </p>\r\n  <p class=\"layers-empty mat-typography\" \r\n    *ngIf=\"!showAllLegendsValue && (layersInUi$ | async).length && (hasVisibleOrInRangeLayers$ | async)===false && (hasVisibleAndNotInRangeLayers$ | async) && allowShowAllLegends\">\r\n    {{'igo.geo.layer.legend.noLayersVisibleWithShowAllButtonButZoom' | translate}} \r\n  </p>\r\n  <p class=\"layers-empty mat-typography\"\r\n    *ngIf=\"(layersInUi$ | async).length && (hasVisibleOrInRangeLayers$ | async)===false && (hasVisibleAndNotInRangeLayers$ | async)===false && !allowShowAllLegends\">\r\n    {{'igo.geo.layer.legend.noLayersVisible' | translate}} \r\n  </p>\r\n  <p class=\"layers-empty mat-typography\"\r\n    *ngIf=\"(layersInUi$ | async).length && (hasVisibleOrInRangeLayers$ | async)===false && (hasVisibleAndNotInRangeLayers$ | async) && !allowShowAllLegends\">\r\n    {{'igo.geo.layer.legend.noLayersVisibleButZoom' | translate}} \r\n  </p>\r\n\r\n</div>","import { Component, Input, ChangeDetectionStrategy, OnInit, OnDestroy, EventEmitter, Output } from '@angular/core';\r\nimport { Layer } from '../shared';\r\nimport { BehaviorSubject, ReplaySubject, Subscription, EMPTY, timer } from 'rxjs';\r\nimport { debounce } from 'rxjs/operators';\r\n\r\n@Component({\r\n  selector: 'igo-layer-legend-list',\r\n  templateUrl: './layer-legend-list.component.html',\r\n  styleUrls: ['./layer-legend-list.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class LayerLegendListComponent implements OnInit, OnDestroy {\r\n  orderable = true;\r\n\r\n  hasVisibleOrInRangeLayers$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n  hasVisibleAndNotInRangeLayers$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n  layersInUi$: BehaviorSubject<Layer[]> = new BehaviorSubject([]);\r\n  layers$: BehaviorSubject<Layer[]> = new BehaviorSubject([]);\r\n  showAllLegend: boolean = false;\r\n  public change$ = new ReplaySubject<void>(1);\r\n  private change$$: Subscription;\r\n  @Input()\r\n  set layers(value: Layer[]) {\r\n    this._layers = value;\r\n    this.next();\r\n  }\r\n  get layers(): Layer[] {\r\n    return this._layers;\r\n  }\r\n  private _layers: Layer[];\r\n  @Input() excludeBaseLayers: boolean = false;\r\n\r\n  @Input() updateLegendOnResolutionChange: boolean = false;\r\n\r\n  @Input() allowShowAllLegends: boolean = false;\r\n\r\n  @Input() showAllLegendsValue: boolean = false;\r\n\r\n  @Output() allLegendsShown = new EventEmitter<boolean>(false);\r\n\r\n  constructor() { }\r\n  ngOnInit(): void {\r\n    this.change$$ = this.change$\r\n      .pipe(debounce(() => {\r\n        return this.layers.length === 0 ? EMPTY : timer(50);\r\n      }))\r\n      .subscribe(() => {\r\n        const layers = this.computeShownLayers(this.layers.slice(0));\r\n        this.layers$.next(layers);\r\n        this.hasVisibleOrInRangeLayers$.next(\r\n          this.layers.slice(0)\r\n            .filter(layer => layer.baseLayer !== true)\r\n            .filter(layer => layer.visible$.value && layer.isInResolutionsRange$.value).length > 0\r\n        );\r\n        this.hasVisibleAndNotInRangeLayers$.next(\r\n          this.layers.slice(0)\r\n            .filter(layer => layer.baseLayer !== true)\r\n            .filter(layer => layer.visible$.value && !layer.isInResolutionsRange$.value).length > 0\r\n        );\r\n\r\n        this.layersInUi$.next(\r\n          this.layers.slice(0).filter(layer => layer.showInLayerList !== false && (!this.excludeBaseLayers || !layer.baseLayer))\r\n        );\r\n      });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.change$$.unsubscribe();\r\n  }\r\n  private next() {\r\n    this.change$.next();\r\n  }\r\n  private computeShownLayers(layers: Layer[]) {\r\n    let shownLayers = layers.filter((layer: Layer) => layer.visible && layer.isInResolutionsRange);\r\n    if (this.showAllLegendsValue) {\r\n      shownLayers = layers;\r\n    }\r\n    return this.sortLayersByZindex(shownLayers);\r\n  }\r\n  private sortLayersByZindex(layers: Layer[]) {\r\n    return layers.sort((layer1, layer2) => layer2.zIndex - layer1.zIndex);\r\n  }\r\n\r\n  toggleShowAllLegends(toggle: boolean) {\r\n      this.showAllLegendsValue = toggle;\r\n      this.next();\r\n      this.allLegendsShown.emit(toggle);\r\n  }\r\n}\r\n","<button *ngIf=\"options.trackFeature\"\r\n  mat-icon-button\r\n  collapsibleButton\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.layer.trackFeature' | translate\"\r\n  [color]=\"color\"\r\n  (click)=\"toggleTrackFeature()\">\r\n  <mat-icon svgIcon=\"crosshairs-gps\"></mat-icon>\r\n</button>\r\n","import { Component, Input, ChangeDetectionStrategy, OnInit } from '@angular/core';\r\n\r\nimport { VectorLayer } from '../shared/layers';\r\nimport { VectorLayerOptions } from '../shared/layers/vector-layer.interface';\r\n\r\n@Component({\r\n  selector: 'igo-track-feature-button',\r\n  templateUrl: './track-feature-button.component.html',\r\n  styleUrls: ['./track-feature-button.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class TrackFeatureButtonComponent implements OnInit {\r\n\r\n  @Input() layer: VectorLayer;\r\n\r\n  @Input() trackFeature = false;\r\n\r\n  get options(): VectorLayerOptions {\r\n    if (!this.layer) {\r\n      return;\r\n    }\r\n    return this.layer.options;\r\n  }\r\n\r\n  public color: string = 'primary';\r\n\r\n  constructor() {}\r\n\r\n  ngOnInit() {\r\n    this.color = this.trackFeature ? 'primary' : 'basic';\r\n  }\r\n\r\n  toggleTrackFeature() {\r\n    if (this.trackFeature) {\r\n      this.layer.disableTrackFeature(this.layer.options.trackFeature);\r\n      this.color = 'basic';\r\n    } else {\r\n      this.layer.enableTrackFeature(this.layer.options.trackFeature);\r\n      this.color = 'primary';\r\n    }\r\n    this.trackFeature = !this.trackFeature;\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\nimport { Subscription, BehaviorSubject } from 'rxjs';\r\n\r\nimport { MetadataLayerOptions } from '../../metadata/shared/metadata.interface';\r\nimport { Layer, TooltipType } from '../shared/layers';\r\nimport { NetworkService, ConnectionState } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'igo-layer-legend-item',\r\n  templateUrl: './layer-legend-item.component.html',\r\n  styleUrls: ['./layer-legend-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class LayerLegendItemComponent implements OnInit, OnDestroy {\r\n\r\n  inResolutionRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  tooltipText: string;\r\n\r\n  state: ConnectionState;\r\n\r\n  private resolution$$: Subscription;\r\n  private network$$: Subscription;\r\n\r\n  @Input() layer: Layer;\r\n\r\n  @Input() updateLegendOnResolutionChange: boolean = false;\r\n\r\n  constructor(private networkService: NetworkService) {}\r\n\r\n  ngOnInit() {\r\n    const resolution$ = this.layer.map.viewController.resolution$;\r\n    this.resolution$$ = resolution$.subscribe(() => {\r\n      this.onResolutionChange();\r\n    });\r\n    this.tooltipText = this.computeTooltip();\r\n\r\n    this.network$$ = this.networkService.currentState().subscribe((state: ConnectionState) => {\r\n      this.state = state;\r\n      this.onResolutionChange();\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.resolution$$.unsubscribe();\r\n    this.network$$.unsubscribe();\r\n  }\r\n\r\n  computeTooltip(): string {\r\n    const layerOptions = this.layer.options;\r\n    if (!layerOptions.tooltip) {\r\n      return this.layer.title;\r\n    }\r\n    const layerTooltip = layerOptions.tooltip;\r\n    const layerMetadata = (layerOptions as MetadataLayerOptions).metadata;\r\n    switch (layerOptions.tooltip.type) {\r\n      case TooltipType.TITLE:\r\n        return this.layer.title;\r\n      case TooltipType.ABSTRACT:\r\n        if (layerMetadata && layerMetadata.abstract) {\r\n          return layerMetadata.abstract;\r\n        } else {\r\n          return this.layer.title;\r\n        }\r\n      case TooltipType.CUSTOM:\r\n        if (layerTooltip && layerTooltip.text) {\r\n          return layerTooltip.text;\r\n        } else {\r\n          return this.layer.title;\r\n        }\r\n      default:\r\n        return this.layer.title;\r\n    }\r\n  }\r\n\r\n  private onResolutionChange() {\r\n    const inResolutionRange = this.layer.isInResolutionsRange;\r\n    this.inResolutionRange$.next(inResolutionRange);\r\n  }\r\n}\r\n","<mat-list-item class= \"igo-layer-list-item\">\r\n  <h4 matLine class=\"igo-layer-title\" [matTooltip]=\"tooltipText\" matTooltipShowDelay=\"500\">{{layer.title}}</h4>\r\n</mat-list-item>\r\n\r\n<div #legend class=\"igo-layer-legend-container\">\r\n  <igo-layer-legend\r\n    [layer]=\"layer\"\r\n    [updateLegendOnResolutionChange]=\"updateLegendOnResolutionChange\">\r\n  </igo-layer-legend>\r\n</div>\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatDividerModule } from '@angular/material/divider';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatMenuModule } from '@angular/material/menu';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatSlideToggleModule } from '@angular/material/slide-toggle';\r\nimport { MatSliderModule } from '@angular/material/slider';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport {\r\n  IgoListModule,\r\n  IgoCollapsibleModule,\r\n  IgoImageModule,\r\n  IgoPanelModule,\r\n  IgoMatBadgeIconModule,\r\n  IgoCustomHtmlModule\r\n} from '@igo2/common';\r\n\r\nimport { LayerService } from './shared/layer.service';\r\nimport { StyleService } from './shared/style.service';\r\nimport { LayerListToolService } from './layer-list-tool/layer-list-tool.service';\r\nimport { LayerItemComponent } from './layer-item/layer-item.component';\r\nimport { LayerLegendComponent } from './layer-legend/layer-legend.component';\r\nimport { LayerListComponent } from './layer-list/layer-list.component';\r\nimport { LayerListToolComponent } from './layer-list-tool/layer-list-tool.component';\r\nimport { LayerListBindingDirective } from './layer-list/layer-list-binding.directive';\r\nimport { LayerLegendListBindingDirective } from './layer-legend-list/layer-legend-list-binding.directive';\r\nimport { TrackFeatureButtonComponent } from './track-feature-button/track-feature-button.component';\r\nimport { LayerLegendListComponent } from './layer-legend-list/layer-legend-list.component';\r\nimport { LayerLegendItemComponent } from './layer-legend-item/layer-legend-item.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    MatInputModule,\r\n    MatFormFieldModule,\r\n    CommonModule,\r\n    FormsModule,\r\n    MatDividerModule,\r\n    MatMenuModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatSlideToggleModule,\r\n    MatSelectModule,\r\n    MatTooltipModule,\r\n    MatListModule,\r\n    MatSliderModule,\r\n    MatBadgeModule,\r\n    MatCheckboxModule,\r\n    IgoLanguageModule,\r\n    IgoListModule,\r\n    IgoCollapsibleModule,\r\n    IgoImageModule,\r\n    IgoPanelModule,\r\n    IgoMatBadgeIconModule,\r\n    IgoCustomHtmlModule\r\n  ],\r\n  exports: [\r\n    LayerItemComponent,\r\n    LayerLegendItemComponent,\r\n    LayerLegendComponent,\r\n    LayerListComponent,\r\n    LayerListToolComponent,\r\n    LayerLegendListComponent,\r\n    LayerListBindingDirective,\r\n    LayerLegendListBindingDirective,\r\n    TrackFeatureButtonComponent\r\n  ],\r\n  declarations: [\r\n    LayerItemComponent,\r\n    LayerLegendItemComponent,\r\n    LayerLegendComponent,\r\n    LayerListComponent,\r\n    LayerListToolComponent,\r\n    LayerLegendListComponent,\r\n    LayerListBindingDirective,\r\n    LayerLegendListBindingDirective,\r\n    TrackFeatureButtonComponent\r\n  ]\r\n})\r\nexport class IgoLayerModule {\r\n  static forRoot(): ModuleWithProviders<IgoLayerModule> {\r\n    return {\r\n      ngModule: IgoLayerModule,\r\n      providers: [LayerService, StyleService, LayerListToolService]\r\n    };\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport {\r\n  IgoMatBadgeIconModule,\r\n  IgoCollapsibleModule,\r\n  IgoListModule\r\n} from '@igo2/common';\r\n\r\nimport { IgoMetadataModule } from './../../metadata/metadata.module';\r\nimport { CatalogBrowserComponent } from './catalog-browser.component';\r\nimport { CatalogBrowserLayerComponent } from './catalog-browser-layer.component';\r\nimport { CatalogBrowserGroupComponent } from './catalog-browser-group.component';\r\nimport { IgoLayerModule } from '../../layer/layer.module';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatBadgeModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    MatListModule,\r\n    MatTooltipModule,\r\n    IgoMatBadgeIconModule,\r\n    IgoLanguageModule,\r\n    IgoListModule,\r\n    IgoCollapsibleModule,\r\n    IgoMetadataModule,\r\n    IgoLayerModule\r\n  ],\r\n  exports: [\r\n    CatalogBrowserComponent\r\n  ],\r\n  declarations: [\r\n    CatalogBrowserComponent,\r\n    CatalogBrowserGroupComponent,\r\n    CatalogBrowserLayerComponent\r\n  ]\r\n})\r\nexport class IgoCatalogBrowserModule {}\r\n","<h1 mat-dialog-title class=\"mat-typography\">{{'igo.geo.catalog.library.addTitle' | translate}}</h1>\r\n<div mat-dialog-content class=\"mat-typography\">\r\n  <form class=\"igo-form\" [formGroup]=\"form\">\r\n    <div class=\"igo-input-container\">\r\n      <mat-form-field>\r\n        <input type=\"text\" formControlName=\"title\" placeholder=\"{{'igo.geo.printForm.title' | translate}}\" matInput [matAutocomplete]=\"auto2\">\r\n        <mat-autocomplete #auto2=\"matAutocomplete\" (optionSelected)='changeUrlOrTitle($event.option.value)'>\r\n          <mat-option *ngFor=\"let predefinedCatalog of (predefinedCatalogsList$ | async)\" matTooltipShowDelay=\"500\"\r\n            [matTooltip]=\"predefinedCatalog.title\" [value]=\"predefinedCatalog\">\r\n            {{predefinedCatalog.title}}\r\n          </mat-option>\r\n        </mat-autocomplete>\r\n      </mat-form-field>\r\n    </div>\r\n    <div class=\"igo-input-container\">\r\n      <mat-form-field>\r\n        <input type=\"text\" formControlName=\"url\" placeholder=\"URL\" matInput [matAutocomplete]=\"auto\">\r\n        <mat-autocomplete #auto=\"matAutocomplete\" (optionSelected)='changeUrlOrTitle($event.option.value)'>\r\n          <mat-option *ngFor=\"let predefinedCatalog of (predefinedCatalogsList$ | async)\" matTooltipShowDelay=\"500\"\r\n            [matTooltip]=\"predefinedCatalog.url\" [value]=\"predefinedCatalog\">\r\n            {{predefinedCatalog.url}}\r\n          </mat-option>\r\n        </mat-autocomplete>\r\n      </mat-form-field>\r\n    </div>\r\n    <div class=\"igo-input-container\">\r\n      <mat-form-field>\r\n        <mat-select\r\n          formControlName=\"type\"\r\n          placeholder=\"Type\">\r\n          <mat-option\r\n            *ngFor=\"let type of typeCapabilities\"\r\n            [value]=\"type\"\r\n            (click)=\"$event.stopPropagation()\">\r\n              <p mat-line>{{type}}</p>\r\n          </mat-option>\r\n        </mat-select>\r\n      </mat-form-field>\r\n    </div>\r\n  </form>\r\n  <span *ngIf=\"error && addedCatalog && emailAddress\">\r\n    <p class=\"error\">{{languageService.translate.instant('igo.geo.catalog.externalProvider.unavailableWithEmail', { value: addedCatalog.url, email: emailAddress })}}</p>\r\n  </span>\r\n  <span *ngIf=\"error && addedCatalog && !emailAddress\">\r\n    <p class=\"error\">{{languageService.translate.instant('igo.geo.catalog.unavailable', { value: addedCatalog.url })}}</p>\r\n  </span>\r\n</div>\r\n<div mat-dialog-actions style=\"justify-content: center\">\r\n  <div class=\"igo-form-button-group add-catalog-button-top-padding\">\r\n    <button\r\n      mat-raised-button\r\n      type=\"button\"\r\n      (click)=\"cancel()\">\r\n      {{'igo.geo.catalog.library.cancel' | translate}}\r\n    </button>\r\n    <button\r\n      id=\"addCatalogBtnDialog\"\r\n      mat-raised-button\r\n      type=\"button\"\r\n      color=\"primary\"\r\n      [disabled]=\"!form.valid\"\r\n      (click)=\"addCatalog(form.value)\">\r\n      {{'igo.geo.catalog.library.add' | translate}}\r\n    </button>\r\n  </div>\r\n</div>","import { LanguageService, ConfigService } from '@igo2/core';\r\nimport { Component, OnInit, OnDestroy, Optional, Inject } from '@angular/core';\r\nimport { MatDialogRef, MAT_DIALOG_DATA } from '@angular/material/dialog';\r\nimport { FormBuilder, FormGroup, Validators } from '@angular/forms';\r\nimport { Subscription, BehaviorSubject } from 'rxjs';\r\n\r\nimport { EntityStore } from '@igo2/common';\r\nimport { TypeCapabilities } from '../../datasource';\r\nimport { Catalog } from '../shared/catalog.abstract';\r\n\r\n@Component({\r\n  selector: 'igo-add-catalog-dialog',\r\n  templateUrl: './add-catalog-dialog.component.html',\r\n  styleUrls: ['./add-catalog-dialog.component.scss']\r\n})\r\nexport class AddCatalogDialogComponent implements OnInit, OnDestroy {\r\n  public form: FormGroup;\r\n  private defaultAddedCatalogType = 'wms';\r\n  private addedCatalogType$$: Subscription;\r\n  public predefinedCatalogsList$ = new BehaviorSubject<Catalog[]>([]);\r\n  typeCapabilities: string[];\r\n  predefinedCatalogs: Catalog[] = [];\r\n  store: EntityStore<Catalog>;\r\n  error = false;\r\n  addedCatalog: Catalog;\r\n  emailAddress: string;\r\n  private storeViewAll$$: Subscription;\r\n\r\n  constructor(\r\n    private formBuilder: FormBuilder,\r\n    public languageService: LanguageService,\r\n    private configService: ConfigService,\r\n    public dialogRef: MatDialogRef<AddCatalogDialogComponent>,\r\n    @Optional()\r\n    @Inject(MAT_DIALOG_DATA)\r\n    public data: { predefinedCatalogs: Catalog[]; store: EntityStore<Catalog>; error: boolean; addedCatalog: Catalog }\r\n  ) {\r\n    this.store = data.store;\r\n    this.predefinedCatalogs = data.predefinedCatalogs;\r\n    this.error = data.error;\r\n    this.addedCatalog = data.addedCatalog;\r\n    this.form = this.formBuilder.group({\r\n      id: ['', []],\r\n      title: ['', []],\r\n      url: ['', [Validators.required]],\r\n      type: [this.defaultAddedCatalogType, [Validators.required]]\r\n    });\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.store.state.clear();\r\n    this.typeCapabilities = Object.keys(TypeCapabilities);\r\n\r\n    this.addedCatalogType$$ = this.form\r\n      .get('type')\r\n      .valueChanges.subscribe((value) => {\r\n        if (value === 'wmts') {\r\n          this.form.get('title').setValidators(Validators.required);\r\n        } else {\r\n          this.form.get('title').setValidators([]);\r\n        }\r\n        this.form.get('title').updateValueAndValidity();\r\n      });\r\n\r\n    this.computePredefinedCatalogList();\r\n    this.storeViewAll$$ = this.store.view\r\n      .all$()\r\n      .subscribe(() => this.computePredefinedCatalogList());\r\n\r\n    this.emailAddress = this.configService.getConfig('emailAddress');\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.addedCatalogType$$.unsubscribe();\r\n    this.storeViewAll$$.unsubscribe();\r\n  }\r\n\r\n  changeUrlOrTitle(catalog: Catalog) {\r\n    this.form.patchValue(catalog);\r\n    this.error = false;\r\n    this.computePredefinedCatalogList();\r\n  }\r\n\r\n  computePredefinedCatalogList() {\r\n    this.predefinedCatalogsList$.next(\r\n      this.predefinedCatalogs.filter((c) => !this.store.get(c.id))\r\n    );\r\n  }\r\n\r\n  addCatalog(addedCatalog: Catalog) {\r\n    this.error = false;\r\n    this.dialogRef.close(addedCatalog);\r\n  }\r\n\r\n  cancel() {\r\n    this.error = false;\r\n    this.dialogRef.close();\r\n  }\r\n}\r\n","<igo-list [navigation]=\"false\">\r\n  <ng-template ngFor let-catalog [ngForOf]=\"getCatalogs() | async\">\r\n    <igo-catalog-library-item\r\n      igoListItem\r\n      color=\"accent\"\r\n      [map]=\"map\"\r\n      [catalog]=\"catalog\"\r\n      (catalogRemove)=\"onCatalogRemove(catalog)\"\r\n      (select)=\"onCatalogSelect(catalog)\">\r\n    </igo-catalog-library-item>\r\n  </ng-template>\r\n</igo-list>\r\n\r\n<div *ngIf=\"addCatalogAllowed\" class=btnAddCatalog>\r\n  <button\r\n    mat-raised-button\r\n    [matTooltip]=\"'igo.geo.catalog.library.addBtn' | translate\"\r\n    matTooltipPosition=\"above\"\r\n    color=\"primary\"\r\n    (click)=\"addCatalogDialog()\">\r\n    {{'igo.geo.catalog.library.addBtn' | translate}}\r\n    <mat-icon svgIcon=\"earth-plus\"></mat-icon>\r\n  </button>\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\nimport { MatDialog } from '@angular/material/dialog';\r\n\r\nimport { EntityStore } from '@igo2/common';\r\nimport { LanguageService, MessageService, StorageService } from '@igo2/core';\r\nimport { ObjectUtils } from '@igo2/utils';\r\nimport { Observable, Subscription } from 'rxjs';\r\nimport { catchError } from 'rxjs/operators';\r\nimport { Md5 } from 'ts-md5';\r\nimport { CapabilitiesService } from '../../datasource';\r\nimport { IgoMap } from '../../map';\r\nimport { standardizeUrl } from '../../utils/id-generator';\r\nimport { Catalog } from '../shared/catalog.abstract';\r\nimport { AddCatalogDialogComponent } from './add-catalog-dialog.component';\r\n\r\n/**\r\n * Component to browse a list of available catalogs\r\n */\r\n@Component({\r\n  selector: 'igo-catalog-library',\r\n  templateUrl: './catalog-library.component.html',\r\n  styleUrls: ['./catalog-library.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class CatalogLibaryComponent implements OnInit, OnDestroy {\r\n  /**\r\n   * Store holding the catalogs\r\n   */\r\n  @Input() store: EntityStore<Catalog>;\r\n\r\n  /**\r\n   * Map to add the catalog items to\r\n   */\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * Determine if the form to add a catalog is allowed\r\n   */\r\n  @Input() addCatalogAllowed: boolean = false;\r\n\r\n  /**\r\n   * Determine if the form to add a catalog is allowed\r\n   */\r\n  @Input() predefinedCatalogs: Catalog[] = [];\r\n\r\n  /**\r\n   * Event emitted a catalog is selected or unselected\r\n   */\r\n  @Output() catalogSelectChange = new EventEmitter<{\r\n    selected: boolean;\r\n    catalog: Catalog;\r\n  }>();\r\n\r\n  submitDisabled = true;\r\n  private addingCatalog$$: Subscription;\r\n\r\n  get addedCatalogs(): Catalog[] {\r\n    return (this.storageService.get('addedCatalogs') || []) as Catalog[];\r\n  }\r\n  set addedCatalogs(catalogs: Catalog[]) {\r\n    this.storageService.set('addedCatalogs', catalogs);\r\n  }\r\n\r\n  constructor(\r\n    private capabilitiesService: CapabilitiesService,\r\n    private messageService: MessageService,\r\n    private languageService: LanguageService,\r\n    private storageService: StorageService,\r\n    private dialog: MatDialog\r\n  ) {}\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.store.state.clear();\r\n\r\n    this.predefinedCatalogs = this.predefinedCatalogs.map(c => {\r\n      c.id = Md5.hashStr(\r\n        (c.type || 'wms') + standardizeUrl(c.url)\r\n      ) as string;\r\n      c.title = c.title === '' || !c.title ? c.url : c.title;\r\n      return c;\r\n    });\r\n  }\r\n\r\n  getCatalogs(): Observable<Catalog[]> {\r\n    return this.store.view.all$();\r\n  }\r\n\r\n  /**\r\n   * When a catalog is selected, update it's state in the store\r\n   * and emit the catalog select change event\r\n   * @internal\r\n   */\r\n  onCatalogSelect(catalog: Catalog) {\r\n    this.store.state.update(\r\n      catalog,\r\n      {\r\n        selected: true,\r\n        focused: true\r\n      },\r\n      true\r\n    );\r\n    this.catalogSelectChange.emit({ selected: true, catalog });\r\n  }\r\n\r\n  private unsubscribeAddingCatalog() {\r\n    if (this.addingCatalog$$) {\r\n      this.addingCatalog$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  addCatalog(addedCatalog: Catalog) {\r\n    if (!addedCatalog) {\r\n      return;\r\n    }\r\n    let id = Md5.hashStr(\r\n      addedCatalog.type + standardizeUrl(addedCatalog.url)\r\n    ) as string;\r\n    const predefinedCatalog = this.predefinedCatalogs.find(\r\n      (c) => c.id === addedCatalog.id\r\n    );\r\n\r\n    if (predefinedCatalog) {\r\n      addedCatalog.version = predefinedCatalog.version;\r\n      addedCatalog.externalProvider = predefinedCatalog.externalProvider;\r\n      id = predefinedCatalog.id;\r\n    }\r\n\r\n    if (this.store.get(id)) {\r\n      const title = this.languageService.translate.instant(\r\n        'igo.geo.catalog.library.inlist.title'\r\n      );\r\n      const message = this.languageService.translate.instant(\r\n        'igo.geo.catalog.library.inlist.message'\r\n      );\r\n      this.messageService.alert(message, title);\r\n      return;\r\n    }\r\n    this.unsubscribeAddingCatalog();\r\n\r\n    this.addingCatalog$$ = this.capabilitiesService\r\n    .getCapabilities(addedCatalog.type as any, addedCatalog.url, addedCatalog.version)\r\n      .pipe(\r\n        catchError((e) => {\r\n          const title = this.languageService.translate.instant('igo.geo.catalog.unavailableTitle');\r\n          if (e.error) {\r\n            this.addCatalogDialog(true, addedCatalog);\r\n            e.error.caught = true;\r\n            return e;\r\n          }\r\n          const message = this.languageService.translate.instant('igo.geo.catalog.unavailable', { value: addedCatalog.url });\r\n          this.messageService.error(message, title);\r\n          throw e;\r\n        })\r\n      )\r\n      .subscribe((capabilities) => {\r\n        let title;\r\n        let version;\r\n        switch (addedCatalog.type) {\r\n          case 'wms':\r\n            title = addedCatalog.title || capabilities.Service.Title;\r\n            version = addedCatalog.version || capabilities.version;\r\n            break;\r\n          case 'arcgisrest':\r\n          case 'imagearcgisrest':\r\n          case 'tilearcgisrest':\r\n            title = addedCatalog.title || capabilities.mapName;\r\n            break;\r\n          case 'wmts':\r\n            title =\r\n              addedCatalog.title ||\r\n              capabilities.ServiceIdentification.ServiceType;\r\n            break;\r\n          default:\r\n            title = addedCatalog.title;\r\n        }\r\n\r\n        const catalogToAdd = ObjectUtils.removeUndefined(\r\n          Object.assign({},\r\n            predefinedCatalog,\r\n            ObjectUtils.removeUndefined({\r\n              id,\r\n              title,\r\n              url: addedCatalog.url,\r\n              type: addedCatalog.type || 'wms',\r\n              externalProvider: addedCatalog.externalProvider || false,\r\n              removable: true,\r\n              version\r\n            })) as Catalog);\r\n        this.store.insert(catalogToAdd);\r\n        const newCatalogs = this.addedCatalogs.slice(0);\r\n        newCatalogs.push(catalogToAdd);\r\n        this.addedCatalogs = newCatalogs;\r\n        this.unsubscribeAddingCatalog();\r\n      });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.unsubscribeAddingCatalog();\r\n  }\r\n\r\n  onCatalogRemove(catalog) {\r\n    this.store.delete(catalog);\r\n    this.addedCatalogs = this.addedCatalogs\r\n      .slice(0)\r\n      .filter((c) => c.id !== catalog.id);\r\n  }\r\n\r\n  addCatalogDialog(error?, addedCatalog?: Catalog) {\r\n    const dialogRef = this.dialog.open(AddCatalogDialogComponent, {\r\n      width: '700px',\r\n      data: {\r\n        predefinedCatalogs: this.predefinedCatalogs,\r\n        store: this.store,\r\n        error,\r\n        addedCatalog\r\n      }\r\n    });\r\n\r\n    dialogRef.afterClosed().subscribe((catalog) => {\r\n      this.addCatalog(catalog);\r\n    });\r\n  }\r\n}\r\n","<mat-list-item>\r\n  <h4 mat-line>\r\n    {{title}}\r\n  </h4>\r\n  <mat-icon\r\n    class=\"igo-external-provider\"\r\n    *ngIf=\"catalog.externalProvider\"\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"'igo.geo.catalog.externalProvider.catalog' | translate\"\r\n    color=\"primary\"\r\n    (click)=\"$event.stopPropagation()\"\r\n    svgIcon=\"earth-arrow-right\">\r\n  </mat-icon>\r\n\r\n  <button\r\n  *ngIf=\"catalog.removable\"\r\n  mat-icon-button\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.catalog.library.remove' | translate\"\r\n  color=\"warn\"\r\n  (click)=\"removeCatalogFromLibrary($event)\">\r\n  <mat-icon svgIcon=\"delete\"></mat-icon>\r\n</button>\r\n\r\n<button\r\n  class=\"igo-blank\"\r\n  *ngIf=\"!catalog.removable\"\r\n  disabled=\"true\"\r\n  mat-icon-button>\r\n  <mat-icon svgIcon=\"blank\"></mat-icon>\r\n</button>\r\n</mat-list-item>\r\n","import { Component, Input, ChangeDetectionStrategy, Output, EventEmitter } from '@angular/core';\r\n\r\nimport { getEntityTitle } from '@igo2/common';\r\nimport { IgoMap } from '../../map';\r\nimport { Catalog } from '../shared/catalog.abstract';\r\n\r\n/**\r\n * Catalog library item\r\n */\r\n@Component({\r\n  selector: 'igo-catalog-library-item',\r\n  templateUrl: './catalog-library-item.component.html',\r\n  styleUrls: ['./catalog-library-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class CatalogLibaryItemComponent {\r\n\r\n  /**\r\n   * Catalog\r\n   */\r\n  @Input() catalog: Catalog;\r\n\r\n  /**\r\n   * Map to add the catalog items to\r\n   */\r\n  @Input() map: IgoMap;\r\n\r\n  @Output() catalogRemove = new EventEmitter();\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get title(): string { return getEntityTitle(this.catalog); }\r\n\r\n  removeCatalogFromLibrary(event) {\r\n    event.stopPropagation();\r\n    this.catalogRemove.emit();\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoListModule } from '@igo2/common';\r\n\r\nimport { CatalogLibaryComponent, } from './catalog-library.component';\r\nimport { CatalogLibaryItemComponent } from './catalog-library-item.component';\r\nimport { AddCatalogDialogComponent } from './add-catalog-dialog.component';\r\n\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { ReactiveFormsModule } from '@angular/forms';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatAutocompleteModule } from '@angular/material/autocomplete';\r\nimport { MatDialogModule } from '@angular/material/dialog';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatIconModule,\r\n    MatBadgeModule,\r\n    MatListModule,\r\n    MatTooltipModule,\r\n    IgoListModule,\r\n    IgoLanguageModule,\r\n    MatButtonModule,\r\n    MatFormFieldModule,\r\n    ReactiveFormsModule,\r\n    MatInputModule,\r\n    MatSelectModule,\r\n    MatAutocompleteModule,\r\n    MatDialogModule\r\n  ],\r\n  exports: [\r\n    CatalogLibaryComponent,\r\n    AddCatalogDialogComponent\r\n  ],\r\n  declarations: [\r\n    CatalogLibaryComponent,\r\n    CatalogLibaryItemComponent,\r\n    AddCatalogDialogComponent\r\n  ]\r\n})\r\nexport class IgoCatalogLibraryModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoListModule, IgoCollapsibleModule, IgoMatBadgeIconModule } from '@igo2/common';\r\n\r\nimport { IgoCatalogBrowserModule } from './catalog-browser/catalog-browser.module';\r\nimport { IgoCatalogLibraryModule } from './catalog-library/catalog-library.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatBadgeModule,\r\n    MatIconModule,\r\n    MatListModule,\r\n    MatTooltipModule,\r\n    IgoMatBadgeIconModule,\r\n    IgoListModule,\r\n    IgoCollapsibleModule\r\n  ],\r\n  exports: [\r\n    IgoCatalogBrowserModule,\r\n    IgoCatalogLibraryModule\r\n  ],\r\n  declarations: []\r\n})\r\nexport class IgoCatalogModule {}\r\n","import { Pipe, PipeTransform } from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\n\r\nimport { OgcFilterableDataSource } from './ogc-filter.interface';\r\nimport { TimeFilterableDataSource } from './time-filter.interface';\r\n\r\n@Pipe({\r\n  name: 'filterableDataSource'\r\n})\r\nexport class FilterableDataSourcePipe implements PipeTransform {\r\n  transform(value: Layer[], arg: string): Layer[] {\r\n    let layers;\r\n\r\n    if (arg === 'time') {\r\n      layers = value.filter((layer: Layer) => {\r\n        const datasource = layer.dataSource as TimeFilterableDataSource;\r\n        return (\r\n          this.isTimeFilterable(datasource) &&\r\n          datasource.options.timeFilter !== undefined &&\r\n          Object.keys(datasource.options.timeFilter).length\r\n        );\r\n      });\r\n    }\r\n    if (arg === 'ogc') {\r\n      layers = value.filter((layer: Layer) => {\r\n        const datasource = layer.dataSource as OgcFilterableDataSource;\r\n        return this.isOgcFilterable(datasource);\r\n      });\r\n    }\r\n    return layers;\r\n  }\r\n\r\n  private isTimeFilterable(dataSource: TimeFilterableDataSource) {\r\n    if (dataSource.options.type !== 'wms') {\r\n      return false;\r\n    }\r\n    return dataSource.options.timeFilterable;\r\n  }\r\n\r\n  private isOgcFilterable(dataSource: OgcFilterableDataSource): boolean {\r\n    let isOgcFilterable = false;\r\n    if (\r\n      dataSource.options.ogcFilters &&\r\n      dataSource.options.ogcFilters.enabled &&\r\n      dataSource.options.ogcFilters.editable\r\n    ) {\r\n      isOgcFilterable = true;\r\n    }\r\n    if (\r\n      dataSource.options.ogcFilters &&\r\n      dataSource.options.ogcFilters.enabled &&\r\n      (\r\n        dataSource.options.ogcFilters.pushButtons ||\r\n        dataSource.options.ogcFilters.checkboxes ||\r\n        dataSource.options.ogcFilters.radioButtons ||\r\n        dataSource.options.ogcFilters.select ||\r\n        dataSource.options.ogcFilters.autocomplete)) {\r\n        isOgcFilterable = true;\r\n    }\r\n    return isOgcFilterable;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { WMSDataSource } from '../../datasource/shared/datasources/wms-datasource';\r\nimport { TileArcGISRestDataSource } from '../../datasource/shared/datasources/tilearcgisrest-datasource';\r\n\r\n@Injectable()\r\nexport class TimeFilterService {\r\n  constructor() {}\r\n\r\n  filterByDate(\r\n    datasource: WMSDataSource | TileArcGISRestDataSource,\r\n    date: Date | [Date, Date]\r\n  ) {\r\n    let time;\r\n    let newdateform;\r\n    let newdateformStart;\r\n    let newdateformEnd;\r\n\r\n    if (Array.isArray(date)) {\r\n      const dates = [];\r\n      if (date[0]) {\r\n        newdateformStart = this.reformatDateTime(date[0]);\r\n        dates.push(date[0]);\r\n      }\r\n      if (date[1]) {\r\n        newdateformEnd = this.reformatDateTime(date[1]);\r\n        dates.push(date[1]);\r\n      }\r\n      if (dates.length === 2 && newdateformStart !== newdateformEnd) {\r\n        if (datasource instanceof TileArcGISRestDataSource) {\r\n          time = newdateformStart + ',' + newdateformEnd;\r\n        } else {\r\n          time = newdateformStart + '/' + newdateformEnd;\r\n        }\r\n      }\r\n      if (newdateformStart === newdateformEnd) {\r\n        time = newdateformStart;\r\n      }\r\n    } else if (date) {\r\n      newdateform = this.reformatDateTime(date);\r\n      time = newdateform;\r\n    }\r\n\r\n    const params = { TIME: time };\r\n    datasource.ol.updateParams(params);\r\n    if (datasource instanceof WMSDataSource) {\r\n      const wmsDataSource = datasource as WMSDataSource;\r\n      wmsDataSource.setTimeFilter(wmsDataSource.timeFilter, true);\r\n    }\r\n  }\r\n\r\n  filterByYear(\r\n    datasource: WMSDataSource | TileArcGISRestDataSource,\r\n    year: string | [string, string]\r\n  ) {\r\n    let time;\r\n    let newdateformStart;\r\n    let newdateformEnd;\r\n\r\n    if (Array.isArray(year)) {\r\n      const years = [];\r\n      if (year[0]) {\r\n        newdateformStart = year[0];\r\n        years.push(year[0]);\r\n      }\r\n      if (year[1]) {\r\n        newdateformEnd = year[1];\r\n        years.push(year[1]);\r\n      }\r\n      if (years.length === 2 && newdateformStart !== newdateformEnd) {\r\n        if (datasource instanceof TileArcGISRestDataSource) {\r\n          time = newdateformStart + ',' + newdateformEnd;\r\n        } else {\r\n          time = newdateformStart + '/' + newdateformEnd;\r\n        }\r\n      }\r\n      if (newdateformStart === newdateformEnd) {\r\n        time = newdateformStart;\r\n      }\r\n    } else { // to reset filter.\r\n      time = year;\r\n    }\r\n\r\n    const params = { TIME: time };\r\n    datasource.ol.updateParams(params);\r\n    if (datasource instanceof WMSDataSource) {\r\n      const wmsDataSource = datasource as WMSDataSource;\r\n      wmsDataSource.setTimeFilter(wmsDataSource.timeFilter, true);\r\n    }\r\n  }\r\n\r\n  private reformatDateTime(value) {\r\n    const year = value.getFullYear();\r\n    let month = value.getMonth() + 1;\r\n    let day = value.getUTCDate();\r\n    let hour = value.getUTCHours();\r\n    let minute = value.getUTCMinutes();\r\n\r\n    if (Number(month) < 10) {\r\n      month = '0' + month;\r\n    }\r\n\r\n    if (Number(day) < 10) {\r\n      day = '0' + day;\r\n    }\r\n\r\n    if (Number(hour) < 10) {\r\n      hour = '0' + hour;\r\n    }\r\n\r\n    if (Number(minute) < 10) {\r\n      minute = '0' + minute;\r\n    }\r\n\r\n    return year + '-' + month + '-' + day + 'T' + hour + ':' + minute + ':00Z';\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport olProjection from 'ol/proj/Projection';\r\n\r\nimport { WMSDataSource } from '../../datasource/shared/datasources/wms-datasource';\r\nimport { OgcFilterWriter } from './ogc-filter';\r\nimport { OgcFilterableDataSource } from './ogc-filter.interface';\r\n\r\n@Injectable()\r\nexport class OGCFilterService {\r\n  constructor() {}\r\n\r\n  public filterByOgc(wmsDatasource: WMSDataSource, filterString: string) {\r\n    const appliedFilter = new OgcFilterWriter().formatProcessedOgcFilter(filterString, wmsDatasource.options.params.LAYERS);\r\n    wmsDatasource.ol.updateParams({ FILTER: appliedFilter });\r\n  }\r\n\r\n  public setOgcWFSFiltersOptions(wfsDatasource: OgcFilterableDataSource) {\r\n    const options: any = wfsDatasource.options;\r\n    const ogcFilterWriter = new OgcFilterWriter();\r\n\r\n    if (options.ogcFilters.enabled && options.ogcFilters.filters) {\r\n      options.ogcFilters.filters = ogcFilterWriter.checkIgoFiltersProperties(\r\n        options.ogcFilters.filters,\r\n        options.paramsWFS.fieldNameGeometry,\r\n        new olProjection({ code: options.paramsWFS.srsName }),\r\n        true\r\n      );\r\n      if (!options.ogcFilters.interfaceOgcFilters) {\r\n        options.ogcFilters.interfaceOgcFilters = ogcFilterWriter.defineInterfaceFilterSequence(\r\n          options.ogcFilters.filters,\r\n          options.paramsWFS.fieldNameGeometry\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  public setOgcWMSFiltersOptions(wmsDatasource: OgcFilterableDataSource) {\r\n    const options: any = wmsDatasource.options;\r\n    const ogcFilterWriter = new OgcFilterWriter();\r\n\r\n    if (options.ogcFilters.enabled && options.ogcFilters.filters) {\r\n      options.ogcFilters.filters = ogcFilterWriter.checkIgoFiltersProperties(\r\n        options.ogcFilters.filters,\r\n        options.fieldNameGeometry,\r\n        undefined,\r\n        true\r\n      );\r\n      if (!options.ogcFilters.interfaceOgcFilters) {\r\n        options.ogcFilters.interfaceOgcFilters = ogcFilterWriter.defineInterfaceFilterSequence(\r\n          // With some wms server, this param must be set to make spatials call.\r\n          options.ogcFilters.filters,\r\n          options.fieldNameGeometry\r\n        );\r\n      }\r\n      this.filterByOgc(\r\n        wmsDatasource as WMSDataSource,\r\n        ogcFilterWriter.buildFilter(options.ogcFilters.filters,\r\n        undefined,\r\n        undefined,\r\n        undefined,\r\n        wmsDatasource.options\r\n        )\r\n      );\r\n      options.filtered = true;\r\n    } else {\r\n      options.ogcFilters.filters = undefined;\r\n      options.ogcFilters.interfaceOgcFilters = [];\r\n      options.filtered = false;\r\n    }\r\n  }\r\n}\r\n","export enum SpatialFilterQueryType {\r\n    AdmRegion = 'AdmRegion',\r\n    Mun = 'Mun',\r\n    Arrond = 'Arrond',\r\n    CircFed = 'CircFed',\r\n    CircProv = 'CircProv',\r\n    DirReg = 'DirReg',\r\n    MRC = 'MRC',\r\n    RegTour = 'RegTour'\r\n}\r\n\r\nexport enum SpatialFilterType {\r\n    Predefined = 'Predefined',\r\n    Polygon = 'Polygon',\r\n    Point = 'Point'\r\n}\r\n\r\nexport enum SpatialFilterItemType {\r\n    Address = 'Address',\r\n    Thematics = 'Thematics'\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { ConfigService, LanguageService } from '@igo2/core';\r\nimport { map } from 'rxjs/operators';\r\nimport { Observable } from 'rxjs';\r\nimport { Feature } from '../../feature/shared';\r\nimport {\r\n  SpatialFilterQueryType,\r\n  SpatialFilterItemType,\r\n  SpatialFilterType\r\n} from './spatial-filter.enum';\r\nimport { SpatialFilterThematic } from './spatial-filter.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class SpatialFilterService {\r\n  public baseUrl: string = 'https://geoegl.msp.gouv.qc.ca/apis/terrapi/';\r\n\r\n  /*\r\n   * Type association with URL\r\n   */\r\n  public urlFilterList = {\r\n    AdmRegion: 'regadmin',\r\n    Arrond: 'arrondissements',\r\n    CircFed: 'circ-fed',\r\n    CircProv: 'circ-prov',\r\n    DirReg: 'dir-reg',\r\n    MRC: 'mrc',\r\n    Mun: 'municipalites',\r\n    RegTour: 'tourisme',\r\n    bornes: 'bornes-sumi',\r\n    hydro: 'hydro',\r\n    routes: 'routes'\r\n  };\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private languageService: LanguageService,\r\n    private configService: ConfigService\r\n  ) {\r\n    this.baseUrl =\r\n      this.configService.getConfig('spatialFilter.url') || this.baseUrl;\r\n  }\r\n\r\n  getKeyByValue(object, value) {\r\n    return Object.keys(object).find(key => object[key] === value);\r\n  }\r\n\r\n  /*\r\n   * Loading data for spatial filter list component (NO GEOMETRY)\r\n   */\r\n  loadFilterList(type: SpatialFilterQueryType): Observable<Feature[]> {\r\n    const urlPath = type as string;\r\n    if (urlPath) {\r\n      return this.http\r\n        .get<{ features: Feature[] }>(\r\n          this.baseUrl + this.urlFilterList[urlPath]\r\n        )\r\n        .pipe(\r\n          map(featureCollection =>\r\n            featureCollection.features.map(f => {\r\n              f.meta = {\r\n                id: f.properties.code\r\n              };\r\n              return f;\r\n            })\r\n          )\r\n        );\r\n    }\r\n  }\r\n\r\n  /*\r\n   * Loading item list (STRING)\r\n   */\r\n  loadThematicsList() {\r\n    const url = 'types';\r\n    const items: SpatialFilterThematic[] = [];\r\n    return this.http.get(this.baseUrl + url).pipe(\r\n      map((types: string[]) => {\r\n        types.forEach(type => {\r\n          if (type.startsWith('lieux')) {\r\n            const item: SpatialFilterThematic = {\r\n              name: undefined,\r\n              source: type\r\n            };\r\n            let substr = type.substring(6, type.length);\r\n            let name = substr;\r\n            if (substr.includes('.')) {\r\n              const index = substr.indexOf('.');\r\n              name = substr.substring(index + 1, substr.length);\r\n              substr = substr.substring(0, index);\r\n            }\r\n            try {\r\n              item.name = this.languageService.translate.instant(\r\n                'igo.geo.terrapi.' + name\r\n              );\r\n            } catch (e) {\r\n              item.name = name.substring(0, 1).toUpperCase() + name.substring(1, name.length - 1);\r\n            }\r\n\r\n            try {\r\n              item.group = this.languageService.translate.instant(\r\n                'igo.geo.spatialFilter.group.' + substr\r\n              );\r\n            } catch (e) {\r\n              item.group = substr.substring(0, 1).toUpperCase() + substr.substring(1, name.length - 1);\r\n            }\r\n\r\n            items.push(item);\r\n          } else {\r\n            if (this.getKeyByValue(this.urlFilterList, type)) {\r\n              const item: SpatialFilterThematic = {\r\n                name: undefined,\r\n                source: type\r\n              };\r\n              const name = this.getKeyByValue(this.urlFilterList, type);\r\n              try {\r\n                item.name = this.languageService.translate.instant(\r\n                  'igo.geo.terrapi.' + name\r\n                );\r\n              } catch (e) {\r\n                item.name = name.substring(0, 1).toUpperCase() + name.substring(1, name.length - 1);\r\n              }\r\n              item.source = type;\r\n\r\n              items.push(item);\r\n            }\r\n          }\r\n        });\r\n        return items;\r\n      })\r\n    );\r\n  }\r\n\r\n  /*\r\n   * Loading data for spatial filter item component (Address or Thematics) depends on predefined zone or draw zone (feature)\r\n   */\r\n  loadFilterItem(\r\n    feature,\r\n    itemType: SpatialFilterItemType,\r\n    type?: SpatialFilterQueryType,\r\n    thematic?: SpatialFilterThematic,\r\n    buffer?: number\r\n  ) {\r\n    if (type) {\r\n      // Predefined type\r\n      const urlType = type as string;\r\n      const url = this.baseUrl + this.urlFilterList[urlType];\r\n      let urlItem = '';\r\n      if (itemType === SpatialFilterItemType.Address) {\r\n        urlItem = 'adresses';\r\n        return this.http\r\n          .get<{ features: Feature[] }>(\r\n            url + '/' + feature.properties.code + '/' + urlItem,\r\n            {\r\n              params: {\r\n                geometry: 'true',\r\n                icon: 'true',\r\n                bufferInput: buffer.toString(),\r\n                simplified: '100'\r\n              }\r\n            }\r\n          )\r\n          .pipe(\r\n            map(featureCollection =>\r\n              featureCollection.features.map(f => {\r\n                f.meta = {\r\n                  id: f.properties.code,\r\n                  title: this.languageService.translate.instant(\r\n                    'igo.geo.spatialFilter.Address'\r\n                  ),\r\n                  icon: (f as any).icon\r\n                };\r\n                return f;\r\n              })\r\n            )\r\n          );\r\n      } else {\r\n        // If thematics search\r\n        urlItem = thematic.source;\r\n        return this.http\r\n          .get<{ features: Feature[] }>(\r\n            url + '/' + feature.properties.code + '/' + urlItem,\r\n            {\r\n              params: {\r\n                geometry: 'true',\r\n                icon: 'true',\r\n                bufferInput: buffer.toString(),\r\n                simplified: '100'\r\n              }\r\n            }\r\n          )\r\n          .pipe(\r\n            map(featureCollection =>\r\n              featureCollection.features.map(f => {\r\n                f.meta = {\r\n                  id: f.properties.code,\r\n                  title: thematic.name,\r\n                  icon: (f as any).icon\r\n                };\r\n                return f;\r\n              })\r\n            )\r\n          );\r\n      }\r\n    } else {\r\n      // Draw type\r\n      const url = this.baseUrl + 'locate';\r\n      if (itemType === SpatialFilterItemType.Address) {\r\n        const urlItem = '?type=adresses';\r\n        return this.http\r\n          .post<{ features: Feature[] }>(url + urlItem, {\r\n            geometry: 'true',\r\n            icon: 'true',\r\n            loc: JSON.stringify(feature),\r\n            bufferInput: buffer.toString(),\r\n            simplified: '100'\r\n          })\r\n          .pipe(\r\n            map(featureCollection =>\r\n              featureCollection.features.map(f => {\r\n                f.meta = {\r\n                  id: f.properties.code,\r\n                  title: this.languageService.translate.instant(\r\n                    'igo.geo.spatialFilter.Address'\r\n                  ),\r\n                  icon: (f as any).icon\r\n                };\r\n                return f;\r\n              })\r\n            )\r\n          );\r\n      } else {\r\n        // If thematics search\r\n        const urlItem = '?type=' + thematic.source;\r\n        return this.http\r\n          .post<{ features: Feature[] }>(url + urlItem, {\r\n            geometry: 'true',\r\n            icon: 'true',\r\n            loc: JSON.stringify(feature),\r\n            bufferInput: buffer.toString(),\r\n            simplified: '100'\r\n          })\r\n          .pipe(\r\n            map(featureCollection =>\r\n              featureCollection.features.map(f => {\r\n                f.meta = {\r\n                  id: f.properties.code,\r\n                  title: thematic.name,\r\n                  icon: (f as any).icon\r\n                };\r\n                return f;\r\n              })\r\n            )\r\n          );\r\n      }\r\n    }\r\n  }\r\n\r\n  /*\r\n   * Get one territory by id (WITH GEOMETRY)\r\n   */\r\n  loadItemById(\r\n    feature: Feature,\r\n    type: SpatialFilterQueryType\r\n  ): Observable<Feature> {\r\n    const featureType = this.urlFilterList[type];\r\n    const featureCode = '/' + feature.properties.code;\r\n    if (featureType && featureCode) {\r\n      return this.http\r\n        .get<Feature>(this.baseUrl + featureType + featureCode, {\r\n          params: {\r\n            geometry: 'true'\r\n          }\r\n        })\r\n        .pipe(\r\n          map(f => {\r\n            f.meta = {\r\n              id: f.properties.code,\r\n              alias: f.properties.nom,\r\n              title: f.properties.nom\r\n            };\r\n            return f;\r\n          })\r\n        );\r\n    }\r\n  }\r\n\r\n  /*\r\n   * Get buffer geometry\r\n   */\r\n  loadBufferGeometry(\r\n    feature: Feature,\r\n    filterType: SpatialFilterType,\r\n    buffer?: number,\r\n    type?: SpatialFilterQueryType,\r\n  ): Observable<Feature> {\r\n    if (filterType === SpatialFilterType.Predefined) {\r\n      const featureType = this.urlFilterList[type];\r\n      const featureCode = '/' + feature.properties.code;\r\n      if (featureType && featureCode) {\r\n        return this.http\r\n          .get<Feature>(this.baseUrl + featureType + featureCode,\r\n            {\r\n              params: {\r\n                geometry: '100',\r\n                bufferOutput: buffer.toString()\r\n              }\r\n            }\r\n          )\r\n          .pipe(\r\n            map(f => {\r\n              f.meta = {\r\n                id: f.properties.code,\r\n                alias: f.properties.nom,\r\n                title: f.properties.nom\r\n              };\r\n              return f;\r\n            })\r\n          );\r\n      }\r\n    } else {\r\n      return this.http\r\n        .post<Feature>(this.baseUrl + 'geospatial/buffer?', {\r\n          buffer,\r\n          loc: JSON.stringify(feature)\r\n        })\r\n        .pipe(\r\n          map(f => {\r\n            return f;\r\n          })\r\n        );\r\n    }\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport olProjection from 'ol/proj/Projection';\r\nimport * as olproj from 'ol/proj';\r\n\r\nimport { MessageService, LanguageService } from '@igo2/core';\r\n\r\nimport { Layer } from '../../layer/shared';\r\nimport { OgcFilterWriter, OgcFilterableDataSourceOptions } from '../../filter/shared';\r\n\r\nimport { DataSourceOptions } from '../../datasource/shared/datasources/datasource.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class DownloadService {\r\n\r\n  constructor(\r\n    private messageService: MessageService,\r\n    private languageService: LanguageService\r\n  ) {}\r\n\r\n  open(layer: Layer) {\r\n    const translate = this.languageService.translate;\r\n    const title = translate.instant('igo.geo.download.title');\r\n    this.messageService.success(\r\n      translate.instant('igo.geo.download.start'),\r\n      title\r\n    );\r\n\r\n    const DSOptions: DataSourceOptions = layer.dataSource.options;\r\n    if (Object.keys(DSOptions.download).length > 0) {\r\n      if (\r\n        DSOptions.download.dynamicUrl &&\r\n        DSOptions.download.url === undefined\r\n      ) {\r\n        let wfsOptions;\r\n        let currentProj = new olProjection({ code: layer.map.projection });\r\n        const paramsWFS = (layer.dataSource.options as any).paramsWFS;\r\n        if (paramsWFS && Object.keys(paramsWFS).length > 0\r\n        ) {\r\n          currentProj = paramsWFS.srsName ? new olProjection({ code: paramsWFS.srsName }) : currentProj;\r\n          wfsOptions = (layer.dataSource.options as any).paramsWFS;\r\n        } else {\r\n          wfsOptions = (layer.dataSource.options as any).params;\r\n        }\r\n\r\n        const currentExtent = olproj.transformExtent(\r\n          layer.map.viewController.getExtent(),\r\n          new olProjection({ code: layer.map.projection }),\r\n          currentProj\r\n        );\r\n        const outputFormatDownload =\r\n          wfsOptions.outputFormatDownload === undefined\r\n            ? wfsOptions.outputFormat === undefined ? '' : 'outputformat=' + wfsOptions.outputFormat\r\n            : 'outputformat=' + wfsOptions.outputFormatDownload;\r\n\r\n        const baseurl = DSOptions.download.dynamicUrl\r\n          .replace(/&?outputformat=[^&]*/gi, '')\r\n          .replace(/&?filter=[^&]*/gi, '')\r\n          .replace(/&?bbox=[^&]*/gi, '');\r\n\r\n        const ogcFilters = (layer.dataSource.options as OgcFilterableDataSourceOptions).ogcFilters;\r\n\r\n        let filterQueryString;\r\n        filterQueryString = new OgcFilterWriter()\r\n        .handleOgcFiltersAppliedValue(\r\n          layer.dataSource.options,\r\n          ogcFilters.geometryName,\r\n          currentExtent as [number, number, number, number],\r\n          currentProj);\r\n        if (!filterQueryString) {\r\n          // Prevent getting all the features for empty filter\r\n            filterQueryString = new OgcFilterWriter().buildFilter(\r\n            undefined,\r\n            currentExtent as [number, number, number, number],\r\n            currentProj,\r\n            ogcFilters.geometryName\r\n          );\r\n        } else {\r\n          filterQueryString = 'filter=' + encodeURIComponent(filterQueryString);\r\n        }\r\n        window.open(\r\n          `${baseurl}&${filterQueryString}&${outputFormatDownload}`,\r\n          '_blank'\r\n        );\r\n      } else if (DSOptions.download) {\r\n        window.open(DSOptions.download.url, '_blank');\r\n      }\r\n    }\r\n  }\r\n}\r\n","<button\r\n  *ngIf=\"options && options.download && (options.download['dynamicUrl'] || options.download['url']) \"\r\n  mat-icon-button\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.download.action' | translate\"\r\n  [color]=\"color\"\r\n  (click)=\"openDownload(layer)\">\r\n  <mat-icon svgIcon=\"download\"></mat-icon>\r\n</button>\r\n","import { Component, Input, ChangeDetectionStrategy } from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\n\r\nimport { DownloadDataSourceOptions } from '../shared/download.interface';\r\nimport { DownloadService } from '../shared/download.service';\r\n\r\n@Component({\r\n  selector: 'igo-download-button',\r\n  templateUrl: './download-button.component.html',\r\n  styleUrls: ['./download-button.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class DownloadButtonComponent {\r\n  @Input()\r\n  get layer(): Layer {\r\n    return this._layer;\r\n  }\r\n  set layer(value: Layer) {\r\n    this._layer = value;\r\n  }\r\n  private _layer: Layer;\r\n\r\n  @Input()\r\n  get color() {\r\n    return this._color;\r\n  }\r\n  set color(value: string) {\r\n    this._color = value;\r\n  }\r\n  private _color = 'primary';\r\n\r\n  constructor(private downloadService: DownloadService) {}\r\n\r\n  openDownload(layer: Layer) {\r\n    this.downloadService.open(layer);\r\n  }\r\n\r\n  get options(): DownloadDataSourceOptions {\r\n    if (!this.layer) {\r\n      return;\r\n    }\r\n    return this.layer.dataSource.options;\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { DownloadButtonComponent } from './download-button/download-button.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatTooltipModule,\r\n    IgoLanguageModule\r\n  ],\r\n  exports: [DownloadButtonComponent],\r\n  declarations: [DownloadButtonComponent]\r\n})\r\nexport class IgoDownloadModule {\r\n  static forRoot(): ModuleWithProviders<IgoDownloadModule> {\r\n    return {\r\n      ngModule: IgoDownloadModule\r\n    };\r\n  }\r\n}\r\n","<table class=\"igo-striped mat-typography\" *ngIf=\"ready && feature && isObject(feature.properties) && feature.properties.target !== 'iframe'\">\r\n  <tbody>\r\n    <tr *ngFor=\"let property of filterFeatureProperties(feature) | keyvalue\">\r\n\r\n      <td *ngIf=\"feature.properties.target === '_blank' && property.key === 'url'\">\r\n        <mat-icon mat-list-avatar svgIcon=\"{{icon}}\"></mat-icon>\r\n      </td>\r\n\r\n      <td *ngIf=\"feature.properties.target === '_blank' && property.key === 'url'\">\r\n        <a href=\"{{property.value}}\" target='_blank' rel=\"noopener noreferrer\"> {{ 'igo.geo.targetHtmlUrl' | translate }} {{title}}</a>\r\n      </td>\r\n\r\n      <td id=\"keyValue\" *ngIf=\"feature.properties.target === undefined\">\r\n        {{property.key}}\r\n      </td>\r\n\r\n      <td *ngIf=\"feature.properties.target === undefined && !isObject(property.value) && !isUrl(property.value) && !isEmbeddedLink(property.value)\" [innerHTML]=\"property.value\">\r\n      </td>\r\n\r\n      <td *ngIf=\"feature.properties.target === undefined && isEmbeddedLink(property.value)\">\r\n        <u [ngStyle]=\"{'cursor': 'pointer', 'color': 'blue'}\" (click)=\"openSecureUrl(property.value)\">{{ getEmbeddedLinkText(property.value) }}</u>\r\n      </td>\r\n\r\n      <td *ngIf=\"feature.properties.target === undefined && !isObject(property.value) && (isDoc(property.value) || isUrl(property.value)) && !isImg(property.value)\">\r\n        <u [ngStyle]=\"{'cursor': 'pointer', 'color': 'blue'}\" (click)=\"openSecureUrl(property.value)\">{{ 'igo.geo.targetHtmlUrl' | translate }}</u>\r\n      </td>\r\n\r\n      <td *ngIf=\"feature.properties.target === undefined && !isObject(property.value) && isUrl(property.value) && isImg(property.value)\">\r\n        <a href=\"{{property.value}}\" target='_blank' (click)=\"openSecureUrl(property.value)\" rel=\"noopener noreferrer\">\r\n          <img src=\"{{(property.value | secureImage) |async}}\" width=\"225\" height=\"auto\">\r\n        </a>\r\n      </td>\r\n\r\n      <td *ngIf=\"feature.properties.target === undefined && isObject(property.value)\" [innerHTML]=\"property.value | json\">\r\n      </td>\r\n\r\n    </tr>\r\n  </tbody>\r\n</table>\r\n\r\n<iframe *ngIf=\"isHtmlDisplay()\" [srcdoc]=\"htmlSanitizer(feature.properties)\" [src]=\"urlSanitizer(feature.properties.url)\"></iframe>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef,\r\n  Output,\r\n  EventEmitter,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\nimport { DomSanitizer, SafeResourceUrl } from '@angular/platform-browser';\r\nimport { Subject } from 'rxjs';\r\nimport { takeUntil } from 'rxjs/operators';\r\n\r\nimport { userAgent } from '@igo2/utils';\r\nimport { NetworkService, ConnectionState, MessageService, LanguageService } from '@igo2/core';\r\nimport { ConfigService } from '@igo2/core';\r\nimport { getEntityTitle, getEntityIcon } from '@igo2/common';\r\nimport type { Toolbox } from '@igo2/common';\r\n\r\nimport { Feature } from '../shared';\r\nimport { SearchSource } from '../../search/shared/sources/source';\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { HttpClient } from '@angular/common/http';\r\n\r\n@Component({\r\n  selector: 'igo-feature-details',\r\n  templateUrl: './feature-details.component.html',\r\n  styleUrls: ['./feature-details.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\n\r\nexport class FeatureDetailsComponent implements OnInit, OnDestroy {\r\n  private state: ConnectionState;\r\n  private unsubscribe$ = new Subject<void>();\r\n  ready = false;\r\n\r\n  @Input()\r\n  get source(): SearchSource {\r\n    return this._source;\r\n  }\r\n  set source(value: SearchSource) {\r\n    this._source = value;\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() toolbox: Toolbox;\r\n\r\n  @Input()\r\n  get feature(): Feature {\r\n    return this._feature;\r\n  }\r\n  set feature(value: Feature) {\r\n    this._feature = value;\r\n    this.cdRef.detectChanges();\r\n    this.selectFeature.emit();\r\n  }\r\n\r\n  private _feature: Feature;\r\n  private _source: SearchSource;\r\n\r\n  @Output() routeEvent = new EventEmitter<boolean>();\r\n  @Output() selectFeature = new EventEmitter<boolean>();\r\n  @Output() htmlDisplayEvent = new EventEmitter<boolean>();\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get title(): string {\r\n    return getEntityTitle(this.feature);\r\n  }\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  get icon(): string {\r\n    return getEntityIcon(this.feature) || 'link';\r\n  }\r\n\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private cdRef: ChangeDetectorRef,\r\n    private sanitizer: DomSanitizer,\r\n    private networkService: NetworkService,\r\n    private messageService: MessageService,\r\n    private languageService: LanguageService,\r\n    private configService: ConfigService\r\n  ) {\r\n    this.networkService.currentState().pipe(takeUntil(this.unsubscribe$)).subscribe((state: ConnectionState) => {\r\n      this.state = state;\r\n    });\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.ready = true;\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.unsubscribe$.next();\r\n    this.unsubscribe$.complete();\r\n  }\r\n\r\n  urlSanitizer(value): SafeResourceUrl {\r\n    return this.sanitizer.bypassSecurityTrustResourceUrl(value);\r\n  }\r\n\r\n\r\n  isHtmlDisplay(): boolean {\r\n    if (this.feature && this.isObject(this.feature.properties) && this.feature.properties.target === 'iframe') {\r\n      this.htmlDisplayEvent.emit(true);\r\n      return true;\r\n    } else {\r\n      this.htmlDisplayEvent.emit(false);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  htmlSanitizer(value): SafeResourceUrl {\r\n    if (!value.body || userAgent.getBrowserName() === 'Internet Explorer') {\r\n      return;\r\n    }\r\n    const regexBase = /<base href=\"[\\w:\\/\\.]+\">/;\r\n    if (!regexBase.test(value.body)) {\r\n      const url = new URL(value.url, window.location.origin);\r\n      value.body = value.body.replace('<head>', `<head><base href=\"${url.origin}\">`);\r\n    }\r\n\r\n    return this.sanitizer.bypassSecurityTrustHtml(value.body);\r\n  }\r\n\r\n  isObject(value) {\r\n    return typeof value === 'object';\r\n  }\r\n\r\n  openSecureUrl(value) {\r\n    let url: string;\r\n    const regexDepot = new RegExp(this.configService?.getConfig('depot.url') + '.*?(?=\"|$)');\r\n    const regexUrl = /https?:\\/\\/(www\\.)?[-a-zA-Z0-9@:%._\\+~#=]{1,256}\\.[a-zA-Z0-9()]{1,6}\\b([-a-zA-Z0-9()@:%_\\+.~#?&//=]*)/;\r\n\r\n    if (regexDepot.test(value)) {\r\n      url = value.match(regexDepot)[0];\r\n\r\n      this.http.get(url, {\r\n        responseType: 'blob'\r\n      })\r\n      .subscribe((docOrImage) => {\r\n        const fileUrl = URL.createObjectURL(docOrImage);\r\n        window.open(fileUrl, '_blank');\r\n        this.cdRef.detectChanges();\r\n      },\r\n      (error: Error) => {\r\n        const translate = this.languageService.translate;\r\n        const title = translate.instant('igo.geo.targetHtmlUrlUnauthorizedTitle');\r\n        const message = translate.instant('igo.geo.targetHtmlUrlUnauthorized');\r\n        this.messageService.error(message, title);\r\n      });\r\n    } else {\r\n      url = value.match(regexUrl)[0];\r\n      window.open(url, '_blank');\r\n    }\r\n  }\r\n\r\n  isUrl(value) {\r\n    if (typeof value === 'string') {\r\n      const regex = /^https?:\\/\\//;\r\n      return regex.test(value);\r\n    }\r\n  }\r\n\r\n  isDoc(value) {\r\n    if (typeof value === 'string') {\r\n      if (this.isUrl(value)) {\r\n        const regex = /(pdf|docx?|xlsx?)$/;\r\n        return regex.test(value.toLowerCase());\r\n      } else {\r\n        return false;\r\n      }\r\n    }\r\n  }\r\n\r\n  isImg(value) {\r\n    if (typeof value ==='string') {\r\n      if (this.isUrl(value)) {\r\n        const regex = /(jpe?g|png|gif)$/;\r\n        return regex.test(value.toLowerCase());\r\n      } else {\r\n        return false;\r\n      }\r\n    }\r\n  }\r\n\r\n  isEmbeddedLink(value) {\r\n    if (typeof value === 'string') {\r\n      const regex = /^<a/;\r\n      return regex.test(value);\r\n    }\r\n  }\r\n\r\n  getEmbeddedLinkText(value) {\r\n    const regex = /(?<=>).*?(?=<|$)/;\r\n    const text = value.match(regex)[0];\r\n    return text;\r\n  }\r\n\r\n  filterFeatureProperties(feature) {\r\n    const allowedFieldsAndAlias = feature.meta ? feature.meta.alias : undefined;\r\n    const properties = {};\r\n    let offlineButtonState;\r\n\r\n    if (this.map) {\r\n      this.map.offlineButtonToggle$.pipe(takeUntil(this.unsubscribe$)).subscribe(state => {\r\n        offlineButtonState = state;\r\n      });\r\n    }\r\n\r\n    if (feature.properties && feature.properties.Route && this.toolbox && !this.toolbox.getTool('directions')) {\r\n      delete feature.properties.Route;\r\n    }\r\n\r\n    if (allowedFieldsAndAlias) {\r\n      Object.keys(allowedFieldsAndAlias).forEach(field => {\r\n        properties[allowedFieldsAndAlias[field]] = feature.properties[field];\r\n      });\r\n      return properties;\r\n    } else if (offlineButtonState !== undefined) {\r\n      if (!offlineButtonState) {\r\n        if (this.state.connection && feature.meta && feature.meta.excludeAttribute) {\r\n          const excludeAttribute = feature.meta.excludeAttribute;\r\n          excludeAttribute.forEach(attribute => {\r\n            delete feature.properties[attribute];\r\n          });\r\n        } else if (!this.state.connection && feature.meta && feature.meta.excludeAttributeOffline) {\r\n          const excludeAttributeOffline = feature.meta.excludeAttributeOffline;\r\n          excludeAttributeOffline.forEach(attribute => {\r\n            delete feature.properties[attribute];\r\n          });\r\n        }\r\n      } else {\r\n        if (feature.meta && feature.meta.excludeAttributeOffline) {\r\n          const excludeAttributeOffline = feature.meta.excludeAttributeOffline;\r\n          excludeAttributeOffline.forEach(attribute => {\r\n            delete feature.properties[attribute];\r\n          });\r\n        }\r\n      }\r\n    } else {\r\n      if (this.state.connection && feature.meta && feature.meta.excludeAttribute) {\r\n        const excludeAttribute = feature.meta.excludeAttribute;\r\n        excludeAttribute.forEach(attribute => {\r\n          delete feature.properties[attribute];\r\n        });\r\n      } else if (!this.state.connection && feature.meta && feature.meta.excludeAttributeOffline) {\r\n        const excludeAttributeOffline = feature.meta.excludeAttributeOffline;\r\n        excludeAttributeOffline.forEach(attribute => {\r\n          delete feature.properties[attribute];\r\n        });\r\n      }\r\n    }\r\n    return feature.properties;\r\n  }\r\n}\r\n","export enum GeometryType {\r\n    Point = 'Point',\r\n    LineString = 'LineString',\r\n    Polygon = 'Polygon',\r\n    Circle = 'Circle'\r\n}\r\n\r\nexport enum FontType {\r\n    Arial = 'Arial',\r\n    ArialBlack = 'Arial Black',\r\n    Verdana = 'Verdana',\r\n    Tahoma = 'Tahoma',\r\n    TrebuchetMS = 'Trebuchet MS',\r\n    Impact = 'Impact',\r\n    TimesNewRoman = 'Times New Roman',\r\n    Georgia = 'Georgia',\r\n    AmericanTypewriter = 'American Typewriter',\r\n    Courier = 'Courier',\r\n    LucidaConsole = 'Lucida Console',\r\n    BrushScriptMT = 'Brush Script MT',\r\n    ComicSansMS = 'Comic Sans MS'\r\n}\r\n","import OlCircle from 'ol/geom/Circle';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport * as olstyle from 'ol/style';\r\nimport OlLineString from 'ol/geom/LineString';\r\nimport OlLinearRing from 'ol/geom/LinearRing';\r\nimport OlPolygon from 'ol/geom/Polygon';\r\nimport BasicEvent from 'ol/events/Event';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport lineIntersect from '@turf/line-intersect';\r\nimport { lineString } from '@turf/helpers';\r\n\r\nimport {\r\n  GeometrySliceMultiPolygonError,\r\n  GeometrySliceLineStringError,\r\n  GeometrySliceTooManyIntersectionError\r\n } from './geometry.errors';\r\n\r\n/**\r\n * Create a default style for draw and modify interactions\r\n * @param color Style color (R, G, B)\r\n * @returns OL style\r\n */\r\nexport function createDrawInteractionStyle(color?: [number, number, number]): olstyle.Circle {\r\n  color = color || [0, 153, 255];\r\n  return new olstyle.Circle({\r\n    stroke: new olstyle.Stroke({\r\n      color: color.concat([1]),\r\n      width: 2\r\n    }),\r\n    fill:  new olstyle.Fill({\r\n      color: color.concat([0.2])\r\n    }),\r\n    radius: 8\r\n  });\r\n}\r\n\r\n/**\r\n * Create a default style for drawing a hole\r\n * @returns OL style\r\n */\r\nexport function createDrawHoleInteractionStyle(): olstyle.Style {\r\n  return new olstyle.Style({\r\n    stroke: new olstyle.Stroke({\r\n      color:  [0, 153, 255, 1],\r\n      width: 2\r\n    })\r\n  });\r\n}\r\n\r\n/**\r\n * Slice geometry into two parts\r\n * @param olGeometry OL geometry\r\n * @param olSlicer Slicing line\r\n * @returns New OL geometries\r\n */\r\nexport function sliceOlGeometry(\r\n  olGeometry: OlLineString | OlPolygon,\r\n  olSlicer: OlLineString\r\n): Array<OlLineString | OlPolygon> {\r\n  if (olGeometry instanceof OlPolygon) {\r\n    return sliceOlPolygon(olGeometry, olSlicer);\r\n  } else if (olGeometry instanceof OlLineString) {\r\n    return sliceOlLineString(olGeometry, olSlicer);\r\n  }\r\n  return [];\r\n}\r\n\r\n/**\r\n * Slice OL LineString into one or more lines\r\n * @param olLineString OL line string\r\n * @param olSlicer Slicing line\r\n * @returns New OL line strings\r\n */\r\nexport function sliceOlLineString(olLineString: OlLineString, olSlicer: OlLineString): OlLineString[] {\r\n  return [];\r\n}\r\n\r\n/**\r\n * Slice OL Polygon into one or more polygons\r\n * @param olPolygon OL polygon\r\n * @param olSlicer Slicing line\r\n * @returns New OL polygons\r\n */\r\nexport function sliceOlPolygon(olPolygon: OlPolygon, olSlicer: OlLineString): OlPolygon[] {\r\n  if (olPolygon.getLinearRingCount() > 1) {\r\n    throw new GeometrySliceMultiPolygonError();\r\n  }\r\n\r\n  if (olSlicer.getCoordinates().length > 2) {\r\n    throw new GeometrySliceLineStringError();\r\n  }\r\n\r\n  const olGeoJSON = new OlGeoJSON();\r\n  const slicer = olGeoJSON.writeGeometryObject(olSlicer) as any;\r\n  const outerCoordinates = olPolygon.getLinearRing(0).getCoordinates();\r\n\r\n  const parts = [[], []];\r\n  let totalIntersectionCount = 0;\r\n  for (let i = 0, ii = outerCoordinates.length - 1; i < ii; i++) {\r\n    const segmentCoordinates = [outerCoordinates[i], outerCoordinates[i + 1]];\r\n    const segment = lineString(segmentCoordinates);\r\n    const intersections = lineIntersect(segment, slicer).features;\r\n\r\n    const intersectionCount = intersections.length;\r\n    totalIntersectionCount += intersectionCount;\r\n    if (intersectionCount > 1 || totalIntersectionCount > 2) {\r\n      throw new GeometrySliceTooManyIntersectionError();\r\n    }\r\n\r\n    parts[0].push(segmentCoordinates[0]);\r\n    if (intersectionCount === 1) {\r\n      const intersection = intersections[0].geometry.coordinates;\r\n      parts[0].push(intersection);\r\n      parts[1].push(intersection);\r\n      parts.reverse();\r\n    }\r\n  }\r\n\r\n  if (totalIntersectionCount <= 1) {\r\n    return [];\r\n  }\r\n\r\n  parts[0].push(parts[0][0]);\r\n  parts[1].push(parts[1][0]);\r\n\r\n  return [new OlPolygon([parts[0]]), new OlPolygon([parts[1]])];\r\n}\r\n\r\n/**\r\n * Splice geometry into two parts\r\n * @param olGeometry OL geometry\r\n * @param olSlicer Slicing line\r\n * @returns New OL geometries\r\n */\r\nexport function addLinearRingToOlPolygon(olPolygon: OlPolygon, olLinearRing: OlLinearRing ) {\r\n  // TODO: make some validation and support updating an existing linear ring\r\n  olPolygon.appendLinearRing(olLinearRing);\r\n}\r\n\r\nexport function getMousePositionFromOlGeometryEvent(\r\n  olEvent: BasicEvent\r\n) {\r\n  const olGeometry = olEvent.target as OlGeometry;\r\n  if (olGeometry instanceof OlPolygon) {\r\n    return olGeometry.getFlatCoordinates().slice(-4, -2) as [number, number];\r\n  }\r\n  const olGeometryCast = olGeometry as OlPoint | OlLineString | OlCircle;\r\n  return olGeometryCast.getFlatCoordinates().slice(-2) as [number, number];\r\n}\r\n","/* eslint-disable */\r\n// See this issue: https://github.com/Microsoft/TypeScript/issues/13965\r\n// And the solution: https://github.com/Microsoft/TypeScript/wiki/Breaking-Changes#extending-built-ins-like-error-array-and-map-may-no-longer-work\r\n// for an explanation as to why the prototype is set manually\r\n/* eslint-enable */\r\n\r\nexport class GeometrySliceError extends Error {}\r\n\r\nexport class GeometrySliceMultiPolygonError extends GeometrySliceError {\r\n  constructor() {\r\n    super('Can\\'t slice a MultiPolygon.');\r\n    Object.setPrototypeOf(this, GeometrySliceMultiPolygonError.prototype);\r\n  }\r\n}\r\n\r\nexport class GeometrySliceLineStringError extends GeometrySliceError {\r\n  constructor() {\r\n    super('Can\\'t slice with a line that has more than 2 points.');\r\n    Object.setPrototypeOf(this, GeometrySliceLineStringError.prototype);\r\n  }\r\n}\r\n\r\nexport class GeometrySliceTooManyIntersectionError extends GeometrySliceError {\r\n  constructor() {\r\n    super('More than 2 intersections found between the target polygon and the slicing line.');\r\n    Object.setPrototypeOf(this, GeometrySliceTooManyIntersectionError.prototype);\r\n  }\r\n}\r\n","import { EventsKey } from 'ol/events';\r\nimport OlMap from 'ol/Map';\r\nimport { StyleLike as OlStyleLike } from 'ol/style/Style';\r\nimport type { default as OlGeometryType } from 'ol/geom/GeometryType';\r\nimport OlVectorSource from 'ol/source/Vector';\r\nimport OlVectorLayer from 'ol/layer/Vector';\r\nimport OlDraw from 'ol/interaction/Draw';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport OlModify from 'ol/interaction/Modify';\r\nimport OlSelect from 'ol/interaction/Select';\r\nimport BasicEvent from 'ol/events/Event';\r\nimport { DrawEvent as OlDrawEvent } from 'ol/interaction/Draw';\r\nimport { SelectEvent as OlSelectEvent } from 'ol/interaction/Select';\r\nimport { unByKey } from 'ol/Observable';\r\nimport { doubleClick } from 'ol/events/condition';\r\n\r\nimport { Subject, Subscription, fromEvent, BehaviorSubject } from 'rxjs';\r\n\r\nimport { getMousePositionFromOlGeometryEvent } from '../geometry.utils';\r\n\r\nexport interface DrawControlOptions {\r\n  geometryType: typeof OlGeometryType | string;\r\n  drawingLayerSource?: OlVectorSource<OlGeometry>;\r\n  drawingLayer?: OlVectorLayer<OlVectorSource<OlGeometry>>;\r\n  drawingLayerStyle?: OlStyleLike;\r\n  interactionStyle?: OlStyleLike;\r\n  maxPoints?: number;\r\n}\r\n\r\n/**\r\n * Control to draw entities\r\n */\r\nexport class DrawControl {\r\n  /**\r\n   * Draw start observable\r\n   */\r\n  public start$: Subject<OlGeometry> = new Subject();\r\n\r\n  /**\r\n   * Draw end observable\r\n   */\r\n  public end$: Subject<OlGeometry> = new Subject();\r\n\r\n  /**\r\n   * Draw changes observable (while drawing)\r\n   */\r\n  public changes$: Subject<any> = new Subject();\r\n\r\n  /**\r\n   * Draw modify observable (modify drawn features)\r\n   */\r\n  public modify$: Subject<OlGeometry> = new Subject();\r\n\r\n  /**\r\n   * Draw select observable (modify drawn features)\r\n   */\r\n  public select$: Subject<any> = new Subject();\r\n\r\n  /**\r\n   * Draw abort observable (abort drawn features)\r\n   */\r\n     public abort$: Subject<any> = new Subject();\r\n\r\n  /**\r\n   * Freehand mode observable (defaults to false)\r\n   */\r\n  freehand$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  private keyDown$$: Subscription;\r\n\r\n  private olGeometryType: typeof OlGeometryType | undefined | string;\r\n  private olMap: OlMap;\r\n  private olDrawingLayer: OlVectorLayer<OlVectorSource<OlGeometry>>;\r\n  private olDrawInteraction: OlDraw;\r\n  private olSelectInteraction: OlSelect;\r\n  private olModifyInteraction: OlModify;\r\n  private onDrawStartKey: EventsKey;\r\n  private onDrawEndKey: EventsKey;\r\n  private onDrawAbortKey: EventsKey;\r\n  private onDrawKey: EventsKey;\r\n\r\n  private mousePosition: [number, number];\r\n\r\n  /**\r\n   * Wheter the control is active\r\n   */\r\n  get active(): boolean {\r\n    return this.olMap !== undefined;\r\n  }\r\n\r\n  /**\r\n   * OL overlay source\r\n   * @internal\r\n   */\r\n  get olDrawingLayerSource(): OlVectorSource<OlGeometry> {\r\n    return this.olDrawingLayer.getSource();\r\n  }\r\n\r\n  constructor(private options: DrawControlOptions) {\r\n    this.olDrawingLayer = options.drawingLayer ? options.drawingLayer : this.createOlInnerOverlayLayer();\r\n    this.olGeometryType = this.options.geometryType;\r\n  }\r\n\r\n  /**\r\n   * Add or remove this control to/from a map.\r\n   * @param map OL Map\r\n   */\r\n  setOlMap(olMap: OlMap | undefined, activateModifyAndSelect?: boolean) {\r\n    if (!olMap) {\r\n      this.clearOlInnerOverlaySource();\r\n      this.removeOlInnerOverlayLayer();\r\n      this.removeOlInteractions();\r\n      this.olMap = olMap;\r\n      return;\r\n    }\r\n\r\n    this.olMap = olMap;\r\n    this.addOlInnerOverlayLayer();\r\n    this.addOlInteractions(activateModifyAndSelect);\r\n  }\r\n\r\n  /**\r\n   * Return the drawing layer source\r\n   */\r\n  getSource(): OlVectorSource<OlGeometry> {\r\n    return this.olDrawingLayerSource;\r\n  }\r\n\r\n  /**\r\n   * Set the current geometry type\r\n   * @param geometryType the geometry type\r\n   */\r\n  setGeometryType(geometryType: typeof OlGeometryType) {\r\n    this.olGeometryType = geometryType;\r\n  }\r\n\r\n  /**\r\n   * Create a drawing source if none is defined in the options\r\n   */\r\n  private createOlInnerOverlayLayer(): OlVectorLayer<OlVectorSource<OlGeometry>> {\r\n    return new OlVectorLayer({\r\n      source: this.options.drawingLayerSource ? this.options.drawingLayerSource : new OlVectorSource(),\r\n      style: this.options.drawingLayerStyle,\r\n      zIndex: 500\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Clear the drawing layer if it wasn't defined in the options\r\n   */\r\n  private removeOlInnerOverlayLayer() {\r\n    if (!this.options.drawingLayer && this.olMap) {\r\n      this.olMap.removeLayer(this.olDrawingLayer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add the drawing layer if it wasn't defined in the options\r\n   */\r\n  private addOlInnerOverlayLayer() {\r\n    if (!this.options.drawingLayer) {\r\n      this.olMap.addLayer(this.olDrawingLayer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the drawing layer source if it wasn't defined in the options\r\n   */\r\n  private clearOlInnerOverlaySource() {\r\n    if (!this.options.drawingLayer && !this.options.drawingLayerSource) {\r\n      this.olDrawingLayerSource.clear(true);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add interactions to the map an set up some listeners\r\n   */\r\n  addOlInteractions(activateModifyAndSelect?: boolean) {\r\n    // Create Draw interaction\r\n    let olDrawInteraction;\r\n    if (!this.freehand$.getValue()) {\r\n      olDrawInteraction = new OlDraw({\r\n        type: this.olGeometryType,\r\n        source: this.getSource(),\r\n        stopClick: true,\r\n        style: this.options.interactionStyle,\r\n        maxPoints: this.options.maxPoints,\r\n        freehand: false,\r\n        freehandCondition: () => false\r\n      });\r\n\r\n    } else {\r\n      if (this.olGeometryType === 'Point') {\r\n        olDrawInteraction = new OlDraw({\r\n          type: 'Circle',\r\n          source: this.getSource(),\r\n          maxPoints: this.options.maxPoints,\r\n          freehand: true\r\n        });\r\n\r\n      } else {\r\n        olDrawInteraction = new OlDraw({\r\n          type: this.olGeometryType,\r\n          source: this.getSource(),\r\n          maxPoints: this.options.maxPoints,\r\n          freehand: true\r\n        });\r\n      }\r\n    }\r\n\r\n    // Add Draw interaction to map and create listeners\r\n    this.olMap.addInteraction(olDrawInteraction);\r\n    this.olDrawInteraction = olDrawInteraction;\r\n\r\n    this.onDrawStartKey = olDrawInteraction.on('drawstart', (event: OlDrawEvent) => this.onDrawStart(event));\r\n    this.onDrawEndKey = olDrawInteraction.on('drawend', (event: OlDrawEvent) => this.onDrawEnd(event));\r\n    this.onDrawAbortKey = olDrawInteraction.on('drawabort', (event: OlDrawEvent) => this.abort$.next(event.feature.getGeometry()));\r\n\r\n    if (activateModifyAndSelect) {\r\n      // Create a Modify interaction, add it to map and create a listener\r\n      const olModifyInteraction = new OlModify({\r\n        source: this.getSource()\r\n      });\r\n\r\n      this.olMap.addInteraction(olModifyInteraction);\r\n      this.olModifyInteraction = olModifyInteraction;\r\n\r\n      // Create a select interaction and add it to map\r\n      if (!this.olSelectInteraction) {\r\n        const olSelectInteraction = new OlSelect({\r\n          condition: doubleClick,\r\n          style: undefined\r\n        });\r\n        this.olMap.addInteraction(olSelectInteraction);\r\n        this.olSelectInteraction = olSelectInteraction;\r\n\r\n        this.olSelectInteraction.on('select', (event: OlSelectEvent) => this.onSelect(event));\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove interactions\r\n   */\r\n  private removeOlInteractions() {\r\n    this.unsubscribeKeyDown();\r\n    unByKey([this.onDrawStartKey, this.onDrawEndKey, this.onDrawKey, this.onDrawAbortKey]);\r\n\r\n    if (this.olMap) {\r\n      this.olMap.removeInteraction(this.olDrawInteraction);\r\n      this.olMap.removeInteraction(this.olModifyInteraction);\r\n    }\r\n\r\n    this.olDrawInteraction = undefined;\r\n    this.olModifyInteraction = undefined;\r\n  }\r\n\r\n  /**\r\n   * When drawing starts, clear the overlay and start watching for changes\r\n   * @param event Draw start event\r\n   */\r\n  private onDrawStart(event: OlDrawEvent) {\r\n    const olGeometry = event.feature.getGeometry();\r\n    this.start$.next(olGeometry);\r\n    this.clearOlInnerOverlaySource();\r\n    this.onDrawKey = olGeometry.on('change', (olGeometryEvent: BasicEvent) => {\r\n      this.mousePosition = getMousePositionFromOlGeometryEvent(olGeometryEvent);\r\n      this.changes$.next(olGeometryEvent.target);\r\n    });\r\n    this.subscribeKeyDown();\r\n  }\r\n\r\n  /**\r\n   * When drawing ends, update the drawing (feature) geometry observable and add\r\n   * @param event Draw event (drawend)\r\n   */\r\n  private onDrawEnd(event: OlDrawEvent) {\r\n    this.unsubscribeKeyDown();\r\n    unByKey(this.onDrawKey);\r\n    const olGeometry = event.feature.getGeometry();\r\n    olGeometry.on('change', () => {\r\n      this.modify$.next(olGeometry);\r\n    });\r\n    this.end$.next(olGeometry);\r\n  }\r\n\r\n  /**\r\n   * When a feature is selected, update the selected feature observable\r\n   * @param event Modify event (modifyend)\r\n   */\r\n  private onSelect(event: OlSelectEvent) {\r\n    if (event.selected.length === 1) {\r\n      this.select$.next(event.selected[0]);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Subscribe to key downs used as drawing interaction shorcuts\r\n   */\r\n  private subscribeKeyDown() {\r\n    this.unsubscribeKeyDown();\r\n    this.keyDown$$ = fromEvent(document, 'keydown').subscribe((event: KeyboardEvent) => {\r\n      // On Escape or 'c' keydowns, abort the current drawing\r\n      if (event.key === 'Escape') {\r\n        this.olDrawInteraction.abortDrawing();\r\n        return;\r\n      }\r\n\r\n      // On Backspace or 'u' keydowns, remove last vertex of current drawing\r\n      if (event.key === 'Backspace') {\r\n        this.olDrawInteraction.removeLastPoint();\r\n      }\r\n\r\n      // On Enter or 'f' keydowns, finish current drawing\r\n      if (event.key === 'Enter') {\r\n        this.olDrawInteraction.finishDrawing();\r\n      }\r\n\r\n      // On space bar key down, pan to the current mouse position\r\n      if (event.key === ' ') {\r\n        this.olMap.getView().animate({\r\n          center: this.mousePosition,\r\n          duration: 100\r\n        });\r\n        return;\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to key down\r\n   */\r\n  private unsubscribeKeyDown() {\r\n    if (this.keyDown$$) {\r\n      this.keyDown$$.unsubscribe();\r\n      this.keyDown$$ = undefined;\r\n    }\r\n  }\r\n}\r\n","import { Component, Inject, Input } from '@angular/core';\r\nimport { MatDialogRef, MAT_DIALOG_DATA } from '@angular/material/dialog';\r\n\r\nexport interface DialogData {\r\n  label: string;\r\n}\r\n\r\n@Component({\r\n  selector: 'igo-draw-popup-component',\r\n  templateUrl: './draw-popup.component.html',\r\n  styleUrls: ['./draw-popup.component.scss']\r\n})\r\nexport class DrawPopupComponent {\r\n  @Input() confirmFlag: boolean = false;\r\n\r\n  constructor(\r\n    public dialogRef: MatDialogRef<DrawPopupComponent>,\r\n    @Inject(MAT_DIALOG_DATA) public data: { currentLabel: string }\r\n  ) {}\r\n\r\n  cancelDrawing() {\r\n    this.dialogRef.close();\r\n  }\r\n  confirm(labelString: string) {\r\n    this.confirmFlag = true;\r\n    this.dialogRef.close(labelString);\r\n  }\r\n}\r\n","<div mat-dialog-content>\r\n  <p class=\"mat-typography\">\r\n    {{ 'igo.geo.draw.dialogInstruction' | translate }}\r\n  </p>\r\n  <mat-form-field class=\"example-full-width\">\r\n    <input\r\n      #input\r\n      matInput\r\n      placeholder=\"{{ 'igo.geo.draw.dialogTitle' | translate }}\"\r\n      value=\"{{ data.currentLabel }}\"/>\r\n  </mat-form-field>\r\n</div>\r\n<div mat-dialog-actions>\r\n  <button mat-raised-button (click)=\"cancelDrawing()\">\r\n    {{ 'igo.geo.draw.cancel' | translate }}\r\n  </button>\r\n  <button mat-raised-button color=\"primary\" (click)=\"confirm(input.value)\">\r\n    OK\r\n  </button>\r\n</div>\r\n","import { Component } from '@angular/core';\r\n\r\n@Component({\r\n  selector: 'igo-draw-shorcuts',\r\n  templateUrl: './draw-shorcuts.component.html',\r\n  styleUrls: ['./draw-shorcuts.component.scss']\r\n})\r\n\r\nexport class DrawShorcutsComponent {}\r\n","<mat-dialog-content>\r\n  <div>\r\n    <span class=\"shortcut mat-typography\">\r\n      <mat-icon class=\"shortcut-icon\" svgIcon=\"keyboard-return\"></mat-icon>{{'igo.geo.draw.finish' | translate}}</span>\r\n  </div>\r\n  <div>\r\n    <span class=\"shortcut mat-typography\">\r\n      <mat-icon class=\"shortcut-icon\" svgIcon=\"backspace-outline\"></mat-icon>{{'igo.geo.draw.undo' | translate}}</span>\r\n  </div>\r\n  <div>\r\n    <span class=\"shortcut mat-typography\">\r\n      <mat-icon class=\"shortcut-icon\" svgIcon=\"keyboard-esc\"></mat-icon>{{'igo.geo.draw.abort' | translate}}</span>\r\n  </div>\r\n  <div>\r\n    <span class=\"shortcut mat-typography\">\r\n      <mat-icon class=\"shortcut-icon\" svgIcon=\"keyboard-space\"></mat-icon>{{'igo.geo.draw.move' | translate}}</span>\r\n  </div>\r\n</mat-dialog-content>\r\n<mat-dialog-actions class=\"shortcuts-close\">\r\n  <button mat-raised-button mat-dialog-close color=\"primary\">OK</button>\r\n</mat-dialog-actions>","\r\nexport const MEASURE_UNIT_AUTO = 'auto';\r\n\r\nexport enum MeasureType {\r\n  Length = 'length',\r\n  Area = 'area'\r\n}\r\n\r\nexport enum MeasureLengthUnit {\r\n  Meters = 'meters',\r\n  Kilometers = 'kilometers',\r\n  Miles = 'miles',\r\n  Feet = 'feet'\r\n}\r\n\r\nexport const MeasureLengthUnitAbbreviation = {\r\n  [MeasureLengthUnit.Meters]: 'm',\r\n  [MeasureLengthUnit.Kilometers]: 'km',\r\n  [MeasureLengthUnit.Miles]: 'mi',\r\n  [MeasureLengthUnit.Feet]: 'ft'\r\n};\r\n\r\nexport enum MeasureAreaUnit {\r\n  SquareMeters = 'squareMeters',\r\n  SquareKilometers = 'squareKilometers',\r\n  SquareMiles = 'squareMiles',\r\n  SquareFeet = 'squareFeet',\r\n  Hectares = 'hectares',\r\n  Acres = 'acres'\r\n}\r\n\r\nexport const MeasureAreaUnitAbbreviation = {\r\n  [MeasureAreaUnit.SquareMeters]: 'm',\r\n  [MeasureAreaUnit.SquareKilometers]: 'km',\r\n  [MeasureAreaUnit.SquareMiles]: 'mi',\r\n  [MeasureAreaUnit.SquareFeet]: 'ft',\r\n  [MeasureAreaUnit.Hectares]: 'ha',\r\n  [MeasureAreaUnit.Acres]: 'ac'\r\n};\r\n","import { LanguageService } from '@igo2/core';\r\nimport * as olstyle from 'ol/style';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport OlLineString from 'ol/geom/LineString';\r\nimport OlPolygon from 'ol/geom/Polygon';\r\nimport OlCircle from 'ol/geom/Circle';\r\nimport OlOverlay from 'ol/Overlay';\r\nimport { getCenter as olGetCenter } from 'ol/extent';\r\nimport {\r\n  getLength as olGetLength,\r\n  getArea as olGetArea\r\n} from 'ol/sphere';\r\n\r\nimport { Measure } from './measure.interfaces';\r\nimport {\r\n  MeasureAreaUnit,\r\n  MeasureAreaUnitAbbreviation,\r\n  MeasureLengthUnit,\r\n  MeasureLengthUnitAbbreviation\r\n} from './measure.enum';\r\n\r\n/**\r\n * Convert value from meters to kilometers\r\n * @param value Value in meters\r\n * @returns Value in kilometers\r\n */\r\nexport function metersToKilometers(value: number): number {\r\n  return value * 0.001;\r\n}\r\n\r\n/**\r\n * Convert value from meters to feet\r\n * @param value Value in meters\r\n * @returns Value in feet\r\n */\r\nexport function metersToFeet(value: number): number {\r\n  return value * 3.2808;\r\n}\r\n\r\n/**\r\n * Convert value from meters to miles\r\n * @param value Value in meters\r\n * @returns Value in miles\r\n */\r\nexport function metersToMiles(value: number): number {\r\n  return value * 0.000621;\r\n}\r\n\r\n/**\r\n * Convert value from square meters to square kilometers\r\n * @param value Value in square meters\r\n * @returns Value in square kilometers\r\n */\r\nexport function squareMetersToSquareKilometers(value: number): number {\r\n  return value * 0.000001;\r\n}\r\n\r\n/**\r\n * Convert value from square meters to square miles\r\n * @param value Value in square meters\r\n * @returns Value in square miles\r\n */\r\nexport function squareMetersToSquareMiles(value: number): number {\r\n  return value * 0.0000003861;\r\n}\r\n\r\n/**\r\n * Convert value from square meters to square feet\r\n * @param value Value in square meters\r\n * @returns Value in square feet\r\n */\r\nexport function squareMetersToSquareFeet(value: number): number {\r\n  return value * 10.764;\r\n}\r\n\r\n/**\r\n * Convert value from square meters to hectares\r\n * @param value Value in square meters\r\n * @returns Value in hectares\r\n */\r\nexport function squareMetersToHectares(value: number): number {\r\n  return value * 0.0001;\r\n}\r\n\r\n/**\r\n * Convert value from square meters to acres\r\n * @param value Value in square meters\r\n * @returns Value in acres\r\n */\r\nexport function squareMetersToAcres(value: number): number {\r\n  return value * 0.00024711;\r\n}\r\n\r\n/**\r\n * Convert value from meters to the specified length unit\r\n * @param value Value in meters\r\n * @param unit Length unit\r\n * @returns Value in unit\r\n */\r\nexport function metersToUnit(value: number, unit: MeasureLengthUnit): number | undefined {\r\n  const conversionMapper = new Map([\r\n    [MeasureLengthUnit.Meters, (val: number) => val],\r\n    [MeasureLengthUnit.Kilometers, metersToKilometers],\r\n    [MeasureLengthUnit.Miles, metersToMiles],\r\n    [MeasureLengthUnit.Feet, metersToFeet],\r\n  ]);\r\n  const conversion = conversionMapper.get(unit);\r\n\r\n  return conversion ? conversion(value) : undefined;\r\n}\r\n\r\n/**\r\n * Convert value from square meters to the specified area unit\r\n * @param value Value in meters\r\n * @param unit Area unit\r\n * @returns Value in unit\r\n */\r\nexport function squareMetersToUnit(value: number, unit: MeasureAreaUnit): number | undefined {\r\n  const conversionMapper = new Map([\r\n    [MeasureAreaUnit.SquareMeters, (val: number) => val],\r\n    [MeasureAreaUnit.SquareKilometers, squareMetersToSquareKilometers],\r\n    [MeasureAreaUnit.SquareMiles, squareMetersToSquareMiles],\r\n    [MeasureAreaUnit.SquareFeet, squareMetersToSquareFeet],\r\n    [MeasureAreaUnit.Hectares, squareMetersToHectares],\r\n    [MeasureAreaUnit.Acres, squareMetersToAcres],\r\n  ]);\r\n  const conversion = conversionMapper.get(unit);\r\n\r\n  return conversion ? conversion(value) : undefined;\r\n}\r\n\r\n/**\r\n * This method format a measure to a readable format\r\n * @param measure Measure\r\n * @param options Formatting options\r\n * @returns Formatted measure\r\n */\r\nexport function formatMeasure(\r\n  measure: number,\r\n  options?: {\r\n    decimal?: number;\r\n    unit?: MeasureAreaUnit | MeasureLengthUnit;\r\n    unitAbbr?: boolean;\r\n    locale?: string;\r\n  },\r\n  languageService?: LanguageService) {\r\n  let decimal = options.decimal;\r\n  if (decimal === undefined || decimal < 0) {\r\n    decimal = 1;\r\n  }\r\n\r\n  const parts = [];\r\n  if (options.locale !== undefined) {\r\n    parts.push(measure.toLocaleString(options.locale, {\r\n      minimumFractionDigits: decimal,\r\n      maximumFractionDigits: decimal\r\n    }));\r\n  } else {\r\n    parts.push(measure.toFixed(decimal).toString());\r\n  }\r\n\r\n  if (options.unit !== undefined && options.unitAbbr === true) {\r\n    if (languageService) {\r\n      parts.push(\r\n        MeasureLengthUnitAbbreviation[options.unit] ?\r\n          languageService.translate.instant('igo.geo.measure.' + MeasureLengthUnitAbbreviation[options.unit]) :\r\n          languageService.translate.instant('igo.geo.measure.' + MeasureAreaUnitAbbreviation[options.unit])\r\n      );\r\n    } else {\r\n      parts.push(\r\n        MeasureLengthUnitAbbreviation[options.unit] || MeasureAreaUnitAbbreviation[options.unit]\r\n      );\r\n    }\r\n  }\r\n\r\n  return parts.filter(p => p !== undefined).join(' ');\r\n}\r\n\r\n/**\r\n * Compute best length measure unit for a given measure in meters\r\n * @param value Value in meters\r\n * @returns Measure unit\r\n */\r\nexport function computeBestLengthUnit(value: number): MeasureLengthUnit {\r\n  let unit = MeasureLengthUnit.Meters;\r\n  let converted = value;\r\n  const possibleUnits = [MeasureLengthUnit.Kilometers];\r\n  while (converted > 1000 && possibleUnits.length > 0) {\r\n    unit = possibleUnits.pop();\r\n    converted = metersToUnit(value, unit);\r\n  }\r\n  return unit;\r\n}\r\n\r\n/**\r\n * Compute best length measure unit for a given measure in square meters\r\n * @param value Value in meters\r\n * @returns Measure unit\r\n */\r\nexport function computeBestAreaUnit(value: number): MeasureAreaUnit {\r\n  let unit = MeasureAreaUnit.SquareMeters;\r\n  let converted = value;\r\n  const possibleUnits = [MeasureAreaUnit.SquareKilometers];\r\n  while (converted > 1000000 && possibleUnits.length > 0) {\r\n    unit = possibleUnits.pop();\r\n    converted = squareMetersToUnit(value, unit);\r\n  }\r\n  return unit;\r\n}\r\n\r\n/**\r\n * Create a default style for a measure interaction\r\n * @returns OL style\r\n */\r\nexport function createMeasureInteractionStyle(): olstyle.Style {\r\n  return new olstyle.Style({\r\n    stroke: new olstyle.Stroke({\r\n      color: '#ffcc33',\r\n      lineDash: [10, 10],\r\n      width: 2\r\n    }),\r\n    fill:  new olstyle.Fill({\r\n      color: 'rgba(255, 255, 255, 0.2)'\r\n    }),\r\n    image: new olstyle.Circle({\r\n      radius: 5,\r\n      stroke: new olstyle.Stroke({\r\n        color: '#ffcc33',\r\n      }),\r\n      fill: new olstyle.Fill({\r\n        color: 'rgba(255, 255, 255, 0.2)'\r\n      })\r\n    })\r\n  });\r\n}\r\n\r\n/**\r\n * Create a default style for a measure layer\r\n * @returns OL style\r\n */\r\nexport function createMeasureLayerStyle(): olstyle.Style {\r\n  return new olstyle.Style({\r\n    stroke: new olstyle.Stroke({\r\n      color: '#ffcc33',\r\n      width: 2\r\n    }),\r\n    fill:  new olstyle.Fill({\r\n      color: 'rgba(255, 255, 255, 0.2)'\r\n    })\r\n  });\r\n}\r\n\r\n/**\r\n * Compute the length in meters of an OL geometry with a given projection\r\n * @param olGeometry Ol geometry\r\n * @param projection olGeometry's projection\r\n * @returns Length in meters\r\n */\r\nexport function measureOlGeometryLength(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle, projection: string): number | undefined {\r\n  if (olGeometry instanceof OlPoint) {\r\n    return undefined;\r\n  }\r\n  if (olGeometry.getFlatCoordinates().length === 0) {\r\n    return undefined;\r\n  }\r\n  return olGetLength(olGeometry, {projection});\r\n}\r\n\r\n/**\r\n * Compute the area in square meters of an OL geometry with a given projection\r\n * @param olGeometry Ol geometry\r\n * @param projection olGeometry's projection\r\n * @returns Area in square meters\r\n */\r\nexport function measureOlGeometryArea(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle, projection: string): number | undefined {\r\n  if (olGeometry instanceof OlPoint || olGeometry instanceof OlLineString) {\r\n    return undefined;\r\n  }\r\n  if (olGeometry.getFlatCoordinates().length === 0) {\r\n    return undefined;\r\n  }\r\n  return olGetArea(olGeometry, {projection});\r\n}\r\n\r\n/**\r\n * Compute the area (square meters), length (meters) and last length (meters)\r\n * of an OL geometry with a given projection.\r\n * @param olGeometry Ol geometry\r\n * @param projection olGeometry's projection\r\n * @returns Computed measure\r\n */\r\nexport function measureOlGeometry(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle, projection: string): Measure {\r\n  const length = measureOlGeometryLength(olGeometry, projection);\r\n  const area = measureOlGeometryArea(olGeometry, projection);\r\n\r\n  const lengths = [];\r\n  const coordinates = olGeometry.getFlatCoordinates();\r\n  const coordinatesLength = coordinates.length;\r\n  for (let i = 0; i <= coordinatesLength - 4; i += 2) {\r\n    const olSegment = new OlLineString([\r\n      [coordinates[i], coordinates[i + 1]],\r\n      [coordinates[i + 2], coordinates[i + 3]]\r\n    ]);\r\n\r\n    lengths.push(measureOlGeometryLength(olSegment, projection));\r\n  }\r\n\r\n  return {\r\n    area,\r\n    length,\r\n    lengths\r\n  };\r\n}\r\n\r\n/**\r\n * Update an OL geometry midpoints and return an array of those points\r\n * @param olGeometry OL Geometry\r\n * @returns OL points\r\n */\r\nexport function updateOlGeometryMidpoints(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlPoint[] {\r\n  let olMidpoints;\r\n  if (olGeometry instanceof OlPoint) {\r\n    const olMidpointPoint = new OlPoint(olGeometry.getFlatCoordinates());\r\n    olMidpoints = new Array(1);\r\n    olMidpoints[0] = olMidpointPoint;\r\n  } else {\r\n    olMidpoints = getOlGeometryMidpoints(olGeometry);\r\n    // TODO: handle multi geometries\r\n    const coordinates = olGeometry.getFlatCoordinates();\r\n    const midpointsLength = olMidpoints.length;\r\n    for (let i = 0; i < midpointsLength; i++) {\r\n      const j = i * 2;\r\n      const olSegment = new OlLineString([\r\n        [coordinates[j], coordinates[j + 1]],\r\n        [coordinates[j + 2], coordinates[j + 3]]\r\n      ]);\r\n\r\n      const midpointCoordinate = olSegment.getCoordinateAt(0.5);\r\n      const olMidpoint = olMidpoints[i];\r\n      if (olMidpoint !== undefined) {\r\n        olMidpoint.setCoordinates(midpointCoordinate);\r\n      } else {\r\n        olMidpoints[i] = new OlPoint(midpointCoordinate);\r\n      }\r\n    }\r\n  }\r\n  return olMidpoints;\r\n}\r\n\r\n/**\r\n * Clear an OL geometry midpoints and return an array of those points\r\n * @param olGeometry OL Geometry\r\n */\r\nexport function clearOlGeometryMidpoints(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle) {\r\n  const olMidpoints = olGeometry.get('_midpoints') || [];\r\n  const midpointsLength = olMidpoints.length;\r\n  for (let i = 0; i < midpointsLength; i++) {\r\n    const olMidpoint = olMidpoints[i];\r\n    if (olMidpoint !== undefined) {\r\n      if (olMidpoint !== undefined) {\r\n        clearOlMidpointTooltip(olMidpoint);\r\n      }\r\n    }\r\n  }\r\n\r\n  olGeometry.set('_midpoints', undefined, true);\r\n\r\n  return olMidpoints;\r\n}\r\n\r\n/**\r\n * Return an array of  OL geometry midpoints, if any\r\n * @param olGeometry OL Geometry\r\n * @returns OL points\r\n */\r\nfunction getOlGeometryMidpoints(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlPoint[] {\r\n  let expectedNumber;\r\n  if (olGeometry instanceof OlCircle) {\r\n    expectedNumber = 0;\r\n  } else {\r\n    expectedNumber = Math.max((olGeometry.getFlatCoordinates().length / 2) - 1, 0);\r\n  }\r\n  // TODO: This works but it's quite messy. If time permits,\r\n  // clean this. Maybe a Tooltip class could handle that\r\n  let olMidpoints = olGeometry.get('_midpoints');\r\n\r\n  if (olMidpoints === undefined) {\r\n    if (olGeometry instanceof OlPoint) {\r\n      olMidpoints = new Array(1);\r\n    } else {\r\n      olMidpoints = new Array(expectedNumber);\r\n    }\r\n    olGeometry.set('_midpoints', olMidpoints, true);\r\n    return olMidpoints;\r\n  }\r\n\r\n  if (expectedNumber === 0) {\r\n    return olMidpoints;\r\n  }\r\n\r\n  if (expectedNumber === olMidpoints.length) {\r\n    return olMidpoints;\r\n  }\r\n\r\n  if (expectedNumber > olMidpoints.length) {\r\n    olMidpoints.push(...new Array(expectedNumber - olMidpoints.length));\r\n    return olMidpoints;\r\n  }\r\n\r\n  for (let i = expectedNumber; i < olMidpoints.length; i++) {\r\n    const olMidpoint = olMidpoints[expectedNumber];\r\n    if (olMidpoint !== undefined) {\r\n      clearOlMidpointTooltip(olMidpoint);\r\n    }\r\n  }\r\n  olMidpoints.splice(expectedNumber);\r\n\r\n  return olMidpoints;\r\n}\r\n\r\n/**\r\n * Remove an OL midpoint's tooltip from the map\r\n * @param olMidpoint OL Point\r\n */\r\nfunction clearOlMidpointTooltip(olMidpoint: OlPoint) {\r\n  const olTooltip = olMidpoint.get('_tooltip');\r\n  if (olTooltip !== undefined) {\r\n    const olMap = olTooltip.getMap();\r\n    if (olMap !== undefined) {\r\n      olMap.removeOverlay(olTooltip);\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Add an OL overlay at each midpoint and return an array of those overlays\r\n * @param olGeometry OL Geometry\r\n * @returns OL overlays\r\n */\r\nexport function updateOlTooltipsAtMidpoints(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlOverlay[] {\r\n  const olMidpoints = updateOlGeometryMidpoints(olGeometry);\r\n  let typeGeom = '';\r\n  if (olGeometry instanceof OlLineString) {\r\n  typeGeom = 'line-';\r\n  } else if (olGeometry instanceof OlPolygon) {\r\n    typeGeom = 'polygone-';\r\n    }\r\n  const olTooltips = olMidpoints.map((olMidpoint: OlPoint) => {\r\n    let olTooltip = olMidpoint.get('_tooltip');\r\n    if (olTooltip === undefined) {\r\n      olTooltip = createOlTooltipAtPoint(olMidpoint, false, typeGeom);\r\n    } else {\r\n      olTooltip.setPosition(olMidpoint.getFlatCoordinates());\r\n    }\r\n    return olTooltip;\r\n  });\r\n  return olTooltips;\r\n}\r\n\r\n/**\r\n * Return an array of OL overlay at midspoints, if any\r\n * @param olGeometry OL Geometry\r\n * @returns OL overlays\r\n */\r\nexport function getOlTooltipsAtMidpoints(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlOverlay[] {\r\n  const olMidpoints = getOlGeometryMidpoints(olGeometry);\r\n  return olMidpoints.map((olMidpoint: OlPoint) => {\r\n    return olMidpoint ? olMidpoint.get('_tooltip') : undefined;\r\n  });\r\n}\r\n\r\n/**\r\n * Update an OL geometry center and return it\r\n * @param olGeometry OL Geometry\r\n * @returns OL point\r\n */\r\nexport function updateOlGeometryCenter(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlPoint {\r\n  let olCenter = olGeometry.get('_center');\r\n  const centerCoordinate = olGetCenter(olGeometry.getExtent());\r\n  if (olCenter !== undefined) {\r\n    olCenter.setCoordinates(centerCoordinate);\r\n  } else {\r\n    olCenter = new OlPoint(centerCoordinate);\r\n    olGeometry.set('_center', olCenter);\r\n  }\r\n\r\n  return olCenter;\r\n}\r\n\r\n/**\r\n * Add an OL overlay at the center of a geometry and return that overlay\r\n * @param olGeometry OL Geometry\r\n * @returns OL overlay\r\n */\r\nexport function updateOlTooltipAtCenter(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlOverlay {\r\n  const olCenter = updateOlGeometryCenter(olGeometry);\r\n  let olTooltip = olCenter.get('_tooltip');\r\n  if (olTooltip === undefined) {\r\n    olTooltip = createOlTooltipAtPoint(olCenter, true);\r\n  } else {\r\n    olTooltip.setPosition(olCenter.getFlatCoordinates());\r\n  }\r\n  return olTooltip;\r\n}\r\n\r\n/**\r\n * Return an array of OL overlay at midspoints, if any\r\n * @param olGeometry OL Geometry\r\n * @returns OL overlays\r\n */\r\nexport function getOlTooltipAtCenter(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlOverlay {\r\n  const olCenter = olGeometry.get('_center');\r\n  return olCenter ? olCenter.get('_tooltip') : undefined;\r\n}\r\n\r\n/**\r\n * Get all the tooltips of an OL geometry\r\n * @param olGeometry OL Geometry\r\n * @returns OL overlays\r\n */\r\nexport function getTooltipsOfOlGeometry(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlOverlay[] {\r\n  const olTooltips = [].concat(getOlTooltipsAtMidpoints(olGeometry) || []);\r\n  const olCenterTooltip = getOlTooltipAtCenter(olGeometry);\r\n  if (olCenterTooltip !== undefined) {\r\n    olTooltips.push(olCenterTooltip);\r\n  }\r\n  return olTooltips;\r\n}\r\n\r\n/**\r\n * Create an OL overlay at a point and bind the overlay to the point\r\n * @param olPoint OL Point\r\n * @returns OL overlay\r\n */\r\nexport function createOlTooltipAtPoint(olPoint: OlPoint, center: boolean = false, srcGeomType: string= ''): OlOverlay {\r\n  const olTooltip = new OlOverlay({\r\n    element: document.createElement('div'),\r\n    offset: [-30, -10],\r\n    className: (center ?\r\n    [ 'igo-map-tooltip',\r\n      'igo-map-tooltip-measure', 'igo-map-tooltip-measure-area'] : ['igo-map-tooltip', 'igo-map-tooltip-measure',\r\n      `igo-map-tooltip-measure-${srcGeomType}segments`]).join(' '),\r\n    stopEvent: false\r\n  });\r\n  olTooltip.setPosition(olPoint.getFlatCoordinates());\r\n  olPoint.set('_tooltip', olTooltip);\r\n\r\n  return olTooltip;\r\n}\r\n","import * as Olstyle from 'ol/style';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport OlLineString from 'ol/geom/LineString';\r\nimport OlPolygon from 'ol/geom/Polygon';\r\nimport OlCircle from 'ol/geom/Circle';\r\nimport OlOverlay from 'ol/Overlay';\r\nimport {\r\n  updateOlGeometryMidpoints,\r\n  updateOlGeometryCenter\r\n} from '../../measure/shared/measure.utils';\r\n\r\n\r\n/**\r\n * Create a default style\r\n * @param fillColor the fill color\r\n * @param strokeColor the stroke color\r\n * @param strokeWidth the stroke width\r\n * @param label a label\r\n * @returns OL style\r\n */\r\nexport function createInteractionStyle(fillColor?: string, strokeColor?: string, strokeWidth?: number, label?: string): Olstyle.Style {\r\n  return new Olstyle.Style({\r\n    stroke: new Olstyle.Stroke({\r\n      color: strokeColor ? strokeColor : 'rgba(143,7,7,1)',\r\n      width: strokeWidth ? strokeWidth : 1\r\n    }),\r\n    fill: new Olstyle.Fill({\r\n      color: fillColor ? fillColor : 'rgba(255,255,255,0.4)'\r\n    }),\r\n    image: new Olstyle.Circle({\r\n      radius: 5,\r\n      stroke: new Olstyle.Stroke({\r\n        color: strokeColor ? strokeColor : 'rgba(143,7,7,1)',\r\n        width: strokeWidth ? strokeWidth : 1\r\n      }),\r\n      fill: new Olstyle.Fill({\r\n        color: fillColor ? fillColor : 'rgba(255,255,255,0.4)'\r\n      })\r\n    })\r\n  });\r\n}\r\n\r\n/**\r\n * Add an OL overlay at each midpoint and return an array of those overlays\r\n * @param olGeometry OL Geometry\r\n * @returns OL overlays\r\n */\r\nexport function updateOlTooltipsDrawAtMidpoints(olGeometry: OlPoint | OlLineString | OlPolygon | OlCircle): OlOverlay[] {\r\n  let olMidpoints;\r\n  if (olGeometry instanceof OlPoint) {\r\n    const olMidpointPoint = new OlPoint(olGeometry.getFlatCoordinates());\r\n    olMidpoints = new Array(1);\r\n    olMidpoints[0] = olMidpointPoint;\r\n    olGeometry.setProperties({_midpoints: olMidpoints}, true);\r\n  } else if (olGeometry instanceof OlCircle) {\r\n    const olMidpointPoint = new OlPoint(olGeometry.getCenter());\r\n    olMidpoints = new Array(1);\r\n    olMidpoints[0] = olMidpointPoint;\r\n    olGeometry.setProperties({_midpoints: olMidpoints}, true);\r\n  } else {\r\n    olMidpoints = updateOlGeometryMidpoints(olGeometry);\r\n  }\r\n  const olTooltips = olMidpoints.map((olMidpoint: OlPoint) => {\r\n    let olTooltip = olMidpoint.get('_tooltip');\r\n    if (olTooltip === undefined) {\r\n      olTooltip = createOlTooltipDrawAtPoint(olMidpoint);\r\n    } else {\r\n      olTooltip.setPosition(olMidpoint.getFlatCoordinates());\r\n    }\r\n    return olTooltip;\r\n  });\r\n  return olTooltips;\r\n}\r\n\r\n/**\r\n * Add an OL overlay at the center of a geometry and return that overlay\r\n * @param olGeometry OL Geometry\r\n * @returns OL overlay\r\n */\r\nexport function updateOlTooltipDrawAtCenter(olGeometry: OlLineString | OlPolygon): OlOverlay {\r\n  const olCenter = updateOlGeometryCenter(olGeometry);\r\n  let olTooltip = olCenter.get('_tooltip');\r\n  if (olTooltip === undefined) {\r\n    olTooltip = createOlTooltipDrawAtPoint(olCenter);\r\n  } else {\r\n    olTooltip.setPosition(olCenter.getFlatCoordinates());\r\n  }\r\n  return olTooltip;\r\n}\r\n\r\n/**\r\n * Create an OL overlay at a point and bind the overlay to the point\r\n * @param olPoint OL Point\r\n * @returns OL overlay\r\n */\r\nexport function createOlTooltipDrawAtPoint(olPoint: OlPoint): OlOverlay {\r\n  const olTooltip = new OlOverlay({\r\n    element: document.createElement('div'),\r\n    offset: [-30, -10],\r\n    className: [\r\n      'igo-map-tooltip',\r\n      'igo-map-tooltip-draw'\r\n    ].join(' '),\r\n    stopEvent: false\r\n  });\r\n  olTooltip.setPosition(olPoint.getFlatCoordinates());\r\n  olPoint.set('_tooltip', olTooltip);\r\n\r\n  return olTooltip;\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport * as OlStyle from 'ol/style';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport { transform } from 'ol/proj';\r\nimport { MapService } from '../../map/shared/map.service';\r\nimport { FontType } from './draw.enum';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class DrawStyleService {\r\n  private fillColor = 'rgba(255,255,255,0.4)';\r\n  private strokeColor = 'rgba(143,7,7,1)';\r\n  private strokeWidth: number = 1;\r\n  private labelsAreShown = true;\r\n  private icon: string;\r\n  private fontSize: string = '20';\r\n  private fontStyle: string = FontType.Arial.toString();\r\n\r\n  constructor(private mapService: MapService) {}\r\n\r\n  getFillColor(): string {\r\n    return this.fillColor;\r\n  }\r\n\r\n  setFillColor(fillColor: string) {\r\n    this.fillColor = fillColor;\r\n  }\r\n\r\n  getStrokeColor(): string {\r\n    return this.strokeColor;\r\n  }\r\n\r\n  setStrokeColor(strokeColor: string) {\r\n    this.strokeColor = strokeColor;\r\n  }\r\n\r\n  getStrokeWidth(): number {\r\n    return this.strokeWidth;\r\n  }\r\n\r\n  getLabelsAreShown() {\r\n    return this.labelsAreShown;\r\n  }\r\n\r\n  toggleLabelsAreShown() {\r\n    this.labelsAreShown = !this.labelsAreShown;\r\n  }\r\n\r\n  setIcon(icon: string) {\r\n    this.icon = icon;\r\n  }\r\n\r\n  getIcon() {\r\n    return this.icon;\r\n  }\r\n\r\n  // To edit the label of drawing\r\n  getFontSize() {\r\n    return this.fontSize;\r\n  }\r\n\r\n  setFontSize(fontSize: string) {\r\n    this.fontSize = fontSize;\r\n  }\r\n\r\n  getFontStyle() {\r\n    return this.fontStyle;\r\n  }\r\n\r\n  setFontStyle(fontStyle: string) {\r\n    this.fontStyle = fontStyle;\r\n  }\r\n\r\n  createDrawingLayerStyle(\r\n    feature,\r\n    resolution,\r\n    labelsAreShown?: boolean,\r\n    icon?: string\r\n  ): OlStyle.Style {\r\n    let style;\r\n    let labelsAreOffset: boolean = false;\r\n    const proj = this.mapService.getMap().projection;\r\n    const geom = feature.getGeometry();\r\n    const fontSizeAndStyle = `${this.fontSize}px ${this.fontStyle}`;\r\n\r\n    if (geom instanceof OlPoint) {\r\n      labelsAreOffset = !labelsAreOffset;\r\n    }\r\n\r\n    // if feature is a circle\r\n    if (feature.get('rad')) {\r\n      const coordinates = transform(\r\n        feature.getGeometry().flatCoordinates,\r\n        proj,\r\n        'EPSG:4326'\r\n      );\r\n      style = new OlStyle.Style({\r\n        text: new OlStyle.Text({\r\n          text: labelsAreShown ? feature.get('draw') : '',\r\n          stroke: new OlStyle.Stroke({\r\n            color: 'white',\r\n            width: 0.75\r\n          }),\r\n          fill: new OlStyle.Fill({\r\n            color: 'black'\r\n          }),\r\n          font: fontSizeAndStyle,\r\n          overflow: true\r\n        }),\r\n        image: new OlStyle.Circle({\r\n          radius:\r\n            feature.get('rad') /\r\n            Math.cos((Math.PI / 180) * coordinates[1]) /\r\n            resolution,\r\n          stroke: new OlStyle.Stroke({\r\n            color: this.strokeColor,\r\n            width: this.strokeWidth\r\n          }),\r\n          fill: new OlStyle.Fill({\r\n            color: this.fillColor\r\n          })\r\n        })\r\n      });\r\n      return style;\r\n      // if feature is an icon\r\n    } else if (icon) {\r\n      style = new OlStyle.Style({\r\n        text: new OlStyle.Text({\r\n          text: labelsAreShown ? feature.get('draw') : '',\r\n          offsetY: -26,\r\n          stroke: new OlStyle.Stroke({\r\n            color: 'white',\r\n            width: 0.75\r\n          }),\r\n          fill: new OlStyle.Fill({\r\n            color: 'black'\r\n          }),\r\n          font: fontSizeAndStyle,\r\n          overflow: true\r\n        }),\r\n        stroke: new OlStyle.Stroke({\r\n          color: this.strokeColor,\r\n          width: this.strokeWidth\r\n        }),\r\n        fill: new OlStyle.Fill({\r\n          color: this.fillColor\r\n        }),\r\n        image: new OlStyle.Icon({\r\n          src: icon\r\n        })\r\n      });\r\n      return style;\r\n      // if feature is a point, a linestring or a polygon\r\n    } else {\r\n      style = new OlStyle.Style({\r\n        text: new OlStyle.Text({\r\n          text: labelsAreShown ? feature.get('draw') : '',\r\n          stroke: new OlStyle.Stroke({\r\n            color: 'white',\r\n            width: 0.75\r\n          }),\r\n          fill: new OlStyle.Fill({\r\n            color: 'black'\r\n          }),\r\n          font: fontSizeAndStyle,\r\n          overflow: true,\r\n          offsetY: labelsAreOffset ? -15 : 0\r\n        }),\r\n\r\n        stroke: new OlStyle.Stroke({\r\n          color: this.strokeColor,\r\n          width: this.strokeWidth\r\n        }),\r\n\r\n        fill: new OlStyle.Fill({\r\n          color: this.fillColor\r\n        }),\r\n\r\n        image: new OlStyle.Circle({\r\n          radius: 5,\r\n          stroke: new OlStyle.Stroke({\r\n            color: this.strokeColor,\r\n            width: this.strokeWidth\r\n          }),\r\n          fill: new OlStyle.Fill({\r\n            color: this.fillColor\r\n          })\r\n        })\r\n      });\r\n      return style;\r\n    }\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\n\r\n@Injectable({\r\n    providedIn: 'root'\r\n  })\r\nexport class DrawIconService {\r\n\r\n    protected icons: Array<string>;\r\n\r\n    constructor(\r\n      protected config: ConfigService\r\n    ) {\r\n        this.getIconsList();\r\n    }\r\n\r\n    getIcons() {\r\n        return this.icons;\r\n    }\r\n\r\n    getPath(): any {\r\n      return this.config.getConfig('drawingTool.icons') || [];\r\n    }\r\n\r\n    getIconsList() {\r\n      this.icons = this.getPath();\r\n    }\r\n}\r\n","<div>\r\n  <div class=\"geometry-type-toggle mat-typography\">\r\n    <mat-button-toggle-group (change)=\"onGeometryTypeChange($event.value)\" [value]=\"geometryType.Point\">\r\n\r\n      <mat-button-toggle [value]=\"geometryType.Point\">\r\n        {{ 'igo.geo.draw.' + geometryType.Point | translate }}\r\n      </mat-button-toggle>\r\n\r\n      <mat-button-toggle [value]=\"geometryType.LineString\">\r\n        {{ 'igo.geo.draw.' + geometryType.LineString | translate }}\r\n      </mat-button-toggle>\r\n\r\n      <mat-button-toggle [value]=\"geometryType.Polygon\">\r\n        {{ 'igo.geo.draw.' + geometryType.Polygon | translate }}\r\n      </mat-button-toggle>\r\n\r\n      <mat-button-toggle [value]=\"geometryType.Circle\">\r\n        {{ 'igo.geo.draw.' + geometryType.Circle | translate }}\r\n      </mat-button-toggle>\r\n    </mat-button-toggle-group>\r\n  </div>\r\n\r\n  <div class=\"draw-options mat-typography\">\r\n    <mat-slide-toggle\r\n      [disabled]=\"drawControlIsDisabled\"\r\n      [checked]=\"drawControlIsActive\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onToggleDrawControl($event.checked)\">\r\n      {{ 'igo.geo.spatialFilter.drawControl' | translate }}\r\n    </mat-slide-toggle>\r\n\r\n    <mat-slide-toggle\r\n      [checked]=\"labelsAreShown\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onToggleLabels()\">\r\n      {{ 'igo.geo.draw.toggleMapTooltips' | translate }}\r\n    </mat-slide-toggle>\r\n  </div>\r\n\r\n  <form class=\"igo-form\" [formGroup]=\"form\">\r\n    <div class=\"fill-color-picker mat-typography\">\r\n      <span>\r\n        <mat-icon class=\"stroke-palette-icon\" svgIcon=\"square\"></mat-icon>\r\n        {{ 'igo.geo.draw.fill' | translate }}\r\n      </span>\r\n\r\n      <mat-form-field\r\n        class=\"fill-field\"\r\n        appearance=\"outline\"\r\n        floatLabel=\"always\"\r\n        tooltip-position=\"below\"\r\n        matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.geo.draw.colorPicker' | translate\">\r\n        <mat-label>{{ fillColor }}</mat-label>\r\n\r\n        <input\r\n          formControlName=\"fill\"\r\n          matInput\r\n          type=\"text\"\r\n          [(colorPicker)]=\"fillColor\"\r\n          [style.background]=\"fillColor\"\r\n          [readonly]=\"true\"\r\n          [colorPicker]=\"fillColor\"\r\n          [cpWidth]=\"'200px'\"\r\n          [cpOutputFormat]=\"'rgba'\"\r\n          [cpPosition]=\"'bottom'\"\r\n          [cpPositionOffset]=\"'-75%'\"\r\n          [cpCancelButton]=\"true\"\r\n          [cpCancelButtonText]=\"'igo.geo.draw.cancel' | translate\"\r\n          [cpOKButton]=\"true\"\r\n          (colorPickerChange)=\"onColorChange(labelsAreShown, false)\"/>\r\n      </mat-form-field>\r\n    </div>\r\n\r\n    <div class=\"stroke-color-picker mat-typography\">\r\n      <span>\r\n        <mat-icon class=\"stroke-palette-icon\" svgIcon=\"square-outline\"></mat-icon>\r\n        {{ 'igo.geo.draw.stroke' | translate }}\r\n      </span>\r\n\r\n      <mat-form-field\r\n        class=\"stroke-field\"\r\n        appearance=\"outline\"\r\n        floatLabel=\"always\"\r\n        tooltip-position=\"below\"\r\n        matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.geo.draw.colorPicker' | translate\">\r\n        <mat-label>{{ strokeColor }}</mat-label>\r\n        <input\r\n          formControlName=\"stroke\"\r\n          matInput\r\n          type=\"text\"\r\n          [(colorPicker)]=\"strokeColor\"\r\n          [style.background]=\"strokeColor\"\r\n          [readonly]=\"true\"\r\n          [colorPicker]=\"strokeColor\"\r\n          [cpWidth]=\"'200px'\"\r\n          [cpPosition]=\"'bottom'\"\r\n          [cpPositionOffset]=\"'-75%'\"\r\n          [cpOutputFormat]=\"'rgba'\"\r\n          [cpCancelButton]=\"true\"\r\n          [cpCancelButtonText]=\"'igo.geo.draw.cancel' | translate\"\r\n          [cpOKButton]=\"true\"\r\n          (colorPickerChange)=\"onColorChange(labelsAreShown, false)\">\r\n      </mat-form-field>\r\n    </div>\r\n\r\n    <div>\r\n      <mat-form-field *ngIf=\"icons.length >= 1\">\r\n        <mat-label>{{ 'igo.geo.draw.icon' | translate }}</mat-label>\r\n        <mat-select>\r\n          <mat-select-trigger>\r\n            <div *ngIf=\"icon\" class=\"box\">\r\n              <img src=\"{{ icon }}\">\r\n            </div>\r\n          </mat-select-trigger>\r\n          <mat-option value=\"\" (click)=\"onIconChange()\">{{ 'igo.geo.draw.noIcon' | translate }}</mat-option>\r\n          <mat-option\r\n            *ngFor=\"let icon_html of icons\"\r\n            [value]=\"icon_html\"\r\n            (click)=\"onIconChange(icon_html)\">\r\n            <div class=\"box\">\r\n              <img src=\"{{ icon_html }}\">\r\n            </div>\r\n          </mat-option>\r\n        </mat-select>\r\n      </mat-form-field>\r\n    </div>\r\n  </form>\r\n\r\n\r\n  <div class=\"igo-form-font\">\r\n    <mat-form-field appearance=\"outline\" class=\"igo-form-fontSize\">\r\n      <mat-label>{{ 'igo.geo.draw.fontSize' | translate }}</mat-label>\r\n      <input\r\n        matInput\r\n        #testFontSize\r\n        type=\"number\"\r\n        placeholder=\"10\"\r\n        min=\"10\"\r\n        onkeydown=\"return event.keyCode !== 69\"\r\n        [value]=\"fontSize\"\r\n        (input)=\"\r\n          onFontChange(\r\n            labelsAreShown,\r\n            $event.target.value,\r\n            testFontStyle.value\r\n          )\"\r\n      />\r\n      <span matSuffix>px</span>\r\n    </mat-form-field>\r\n    <mat-form-field appearance=\"outline\" class=\"igo-form-fontStyle\">\r\n      <mat-label>{{ 'igo.geo.draw.fontStyle' | translate }}</mat-label>\r\n      <mat-select\r\n        #testFontStyle\r\n        [value]=\"fontStyle\"\r\n        (selectionChange)=\"onFontChange(labelsAreShown, testFontSize.value, $event.value)\">\r\n        <mat-option\r\n          *ngFor=\"let fontSelect of allFontStyles\"\r\n          [value]=\"fontSelect\">\r\n          {{ fontSelect }}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <mat-divider></mat-divider>\r\n  <div>\r\n    <button\r\n      *ngIf=\"store.count$.getValue() > 0\"\r\n      class=\"deleteBtn\"\r\n      mat-icon-button\r\n      color=\"warn\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.draw.delete' | translate\"\r\n      [disabled]=\"(selectedFeatures$ | async).length === 0\"\r\n      (click)=\"deleteDrawings()\">\r\n      <mat-icon svgIcon=\"delete\"></mat-icon>\r\n    </button>\r\n\r\n    <igo-entity-table\r\n      #table\r\n      class=\"table-compact\"\r\n      [store]=\"store\"\r\n      [template]=\"tableTemplate\"\r\n      (dblclick)=\"editLabelDrawing()\">\r\n    </igo-entity-table>\r\n  </div>\r\n\r\n  <button\r\n    mat-icon-button\r\n    color=\"accent\"\r\n    disableRipple=\"true\"\r\n    (click)=\"openShorcutsDialog()\">\r\n    <mat-icon\r\n      class=\"shortcuts-icon\"\r\n      svgIcon=\"keyboard-outline\"\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.draw.shortcuts' | translate\">\r\n    </mat-icon>\r\n  </button>\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy,\r\n  Output\r\n} from '@angular/core';\r\n\r\nimport {\r\n  FEATURE,\r\n  FeatureStore,\r\n  FeatureStoreSelectionStrategy,\r\n  tryBindStoreLayer,\r\n  tryAddLoadingStrategy,\r\n  tryAddSelectionStrategy,\r\n  FeatureMotion,\r\n  FeatureStoreLoadingStrategy,\r\n  featureToOl\r\n} from '../../feature';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { MatDialog } from '@angular/material/dialog';\r\nimport { FontType, GeometryType } from '../shared/draw.enum';\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport { Draw, FeatureWithDraw } from '../shared/draw.interface';\r\nimport { FormGroup, FormBuilder } from '@angular/forms';\r\nimport { VectorSourceEvent as OlVectorSourceEvent } from 'ol/source/Vector';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { DrawControl } from '../../geometry/shared/controls/draw';\r\nimport { EntityRecord, EntityTableTemplate } from '@igo2/common';\r\n\r\nimport * as OlStyle from 'ol/style';\r\nimport OlVectorSource from 'ol/source/Vector';\r\nimport OlCircle from 'ol/geom/Circle';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport OlFeature from 'ol/Feature';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport OlOverlay from 'ol/Overlay';\r\nimport type { default as OlGeometryType } from 'ol/geom/GeometryType';\r\nimport { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport { getDistance } from 'ol/sphere';\r\nimport { DrawStyleService } from '../shared/draw-style.service';\r\nimport { skip } from 'rxjs/operators';\r\nimport { DrawPopupComponent } from './draw-popup.component';\r\nimport { DrawShorcutsComponent } from './draw-shorcuts.component';\r\nimport { getTooltipsOfOlGeometry } from '../../measure/shared/measure.utils';\r\nimport { createInteractionStyle } from '../shared/draw.utils';\r\nimport { transform } from 'ol/proj';\r\nimport { DrawIconService } from '../shared/draw-icon.service';\r\n\r\n@Component({\r\n  selector: 'igo-draw',\r\n  templateUrl: './draw.component.html',\r\n  styleUrls: ['./draw.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class DrawComponent implements OnInit, OnDestroy {\r\n  /**\r\n   * Table template\r\n   * @internal\r\n   */\r\n  public tableTemplate: EntityTableTemplate = {\r\n    selection: true,\r\n    selectMany: true,\r\n    selectionCheckbox: true,\r\n    sort: true,\r\n    columns: [{\r\n        name: 'Drawing',\r\n        title: this.languageService.translate.instant('igo.geo.draw.labels'),\r\n        valueAccessor: (feature: FeatureWithDraw) => {\r\n          return feature.properties.draw;\r\n        }\r\n      }]\r\n  };\r\n\r\n  public geometryType = GeometryType; // Reference to the GeometryType enum\r\n\r\n  @Output() fillColor: string;\r\n  @Output() strokeColor: string;\r\n  @Output() strokeWidth: number;\r\n\r\n  @Output() fontSize: string;\r\n  @Output() fontStyle: string;\r\n  @Input() fontType: FontType;\r\n\r\n  @Input() map: IgoMap; // Map to draw on\r\n\r\n  @Input() store: FeatureStore<FeatureWithDraw>; // Drawing store\r\n\r\n  public draw$: BehaviorSubject<Draw> = new BehaviorSubject({}); // Observable of draw\r\n\r\n  private olDrawingLayerSource = new OlVectorSource();\r\n  private drawControl: DrawControl;\r\n  private drawEnd$$: Subscription;\r\n  private drawSelect$$: Subscription;\r\n  private olDrawingLayer: VectorLayer;\r\n  public selectedFeatures$: BehaviorSubject<FeatureWithDraw[]> =\r\n    new BehaviorSubject([]);\r\n  public fillForm: string;\r\n  public strokeForm: string;\r\n  public drawControlIsDisabled: boolean = true;\r\n  public drawControlIsActive: boolean = false;\r\n  public labelsAreShown: boolean;\r\n  private subscriptions$$: Subscription[] = [];\r\n\r\n  public fontSizeForm: string;\r\n  public fontStyleForm: string;\r\n  public position: string = 'bottom';\r\n  public form: FormGroup;\r\n  public icons: Array<string>;\r\n  public icon: string;\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private formBuilder: FormBuilder,\r\n    private drawStyleService: DrawStyleService,\r\n    private dialog: MatDialog,\r\n    private drawIconService: DrawIconService\r\n  ) {\r\n    this.buildForm();\r\n    this.fillColor = this.drawStyleService.getFillColor();\r\n    this.strokeColor = this.drawStyleService.getStrokeColor();\r\n    this.strokeWidth = this.drawStyleService.getStrokeWidth();\r\n    this.labelsAreShown = this.drawStyleService.getLabelsAreShown();\r\n    this.icons = this.drawIconService.getIcons();\r\n    this.icon = this.drawStyleService.getIcon();\r\n\r\n    this.fontSize = this.drawStyleService.getFontSize();\r\n    this.fontStyle = this.drawStyleService.getFontStyle();\r\n  }\r\n\r\n  // Initialize the store that will contain the entities and create the Draw control\r\n  ngOnInit() {\r\n    this.initStore();\r\n    this.drawControl = this.createDrawControl(\r\n      this.fillColor,\r\n      this.strokeColor,\r\n      this.strokeWidth\r\n    );\r\n    this.drawControl.setGeometryType(this.geometryType.Point as any);\r\n    this.toggleDrawControl();\r\n  }\r\n\r\n  /**\r\n   * Remove the drawing layer and the interactions\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.drawControl.setOlMap(undefined);\r\n    this.subscriptions$$.map((s) => s.unsubscribe());\r\n  }\r\n\r\n  /**\r\n   * Create a Draw Control\r\n   * @param fillColor the fill color\r\n   * @param strokeColor the stroke color\r\n   * @param strokeWidth the stroke width\r\n   * @returns a Draw Control\r\n   */\r\n  createDrawControl(\r\n    fillColor?: string,\r\n    strokeColor?: string,\r\n    strokeWidth?: number\r\n  ) {\r\n    const drawControl = new DrawControl({\r\n      geometryType: undefined,\r\n      drawingLayerSource: this.olDrawingLayerSource,\r\n      drawingLayerStyle: new OlStyle.Style({}),\r\n      interactionStyle: createInteractionStyle(\r\n        fillColor,\r\n        strokeColor,\r\n        strokeWidth\r\n      )\r\n    });\r\n    return drawControl;\r\n  }\r\n\r\n  /**\r\n   * Called when the user selects a new geometry type\r\n   * @param geometryType the geometry type selected by the user\r\n   */\r\n  onGeometryTypeChange(geometryType: typeof OlGeometryType) {\r\n    this.drawControl.setGeometryType(geometryType);\r\n    this.toggleDrawControl();\r\n  }\r\n\r\n  /**\r\n   * Store initialization, including drawing layer creation\r\n   */\r\n  private initStore() {\r\n    this.map.removeLayer(this.olDrawingLayer);\r\n    this.olDrawingLayer = new VectorLayer({\r\n      isIgoInternalLayer: true,\r\n      id: 'igo-draw-layer',\r\n      title: this.languageService.translate.instant('igo.geo.draw.drawing'),\r\n      zIndex: 200,\r\n      source: new FeatureDataSource(),\r\n      style: (feature, resolution) => {\r\n        return this.drawStyleService.createDrawingLayerStyle(\r\n          feature,\r\n          resolution,\r\n          this.labelsAreShown,\r\n          this.icon\r\n        );\r\n      },\r\n      showInLayerList: true,\r\n      exportable: true,\r\n      browsable: false,\r\n      workspace: {\r\n        enabled: false\r\n      }\r\n    });\r\n    tryBindStoreLayer(this.store, this.olDrawingLayer);\r\n    tryAddLoadingStrategy(\r\n      this.store,\r\n      new FeatureStoreLoadingStrategy({\r\n        motion: FeatureMotion.None\r\n      })\r\n    );\r\n    tryAddSelectionStrategy(\r\n      this.store,\r\n      new FeatureStoreSelectionStrategy({\r\n        map: this.map,\r\n        motion: FeatureMotion.None,\r\n        many: true\r\n      })\r\n    );\r\n    this.store.layer.visible = true;\r\n    this.store.source.ol.on(\r\n      'removefeature',\r\n      (event: OlVectorSourceEvent<OlGeometry>) => {\r\n        const olGeometry = event.feature.getGeometry();\r\n        this.clearLabelsOfOlGeometry(olGeometry);\r\n      }\r\n    );\r\n    this.subscriptions$$.push(\r\n      this.store.stateView\r\n        .manyBy$((record: EntityRecord<FeatureWithDraw>) => {\r\n          return record.state.selected === true;\r\n        })\r\n        .pipe(\r\n          skip(1) // Skip initial emission\r\n        )\r\n        .subscribe((records: EntityRecord<FeatureWithDraw>[]) => {\r\n          this.selectedFeatures$.next(records.map((record) => record.entity));\r\n        })\r\n    );\r\n    this.subscriptions$$.push(\r\n      this.store.count$.subscribe((cnt) => {\r\n        cnt >= 1\r\n          ? (this.store.layer.options.showInLayerList = true)\r\n          : (this.store.layer.options.showInLayerList = false);\r\n      })\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Called when the user changes the color in a color picker\r\n   * @param labelsAreShown wheter the labels are shown or not\r\n   * @param isAnIcon wheter the feature is an icon or not\r\n   */\r\n  onColorChange(labelsAreShown: boolean, isAnIcon: boolean) {\r\n    this.fillForm = this.fillColor;\r\n    this.strokeForm = this.strokeColor;\r\n    this.drawStyleService.setFillColor(this.fillColor);\r\n    this.drawStyleService.setStrokeColor(this.strokeColor);\r\n\r\n    if (isAnIcon) {\r\n      this.store.layer.ol.setStyle((feature, resolution) => {\r\n        return this.drawStyleService.createDrawingLayerStyle(\r\n          feature,\r\n          resolution,\r\n          labelsAreShown,\r\n          this.icon\r\n        );\r\n      });\r\n      this.icon = undefined;\r\n    } else {\r\n      this.store.layer.ol.setStyle((feature, resolution) => {\r\n        return this.drawStyleService.createDrawingLayerStyle(\r\n          feature,\r\n          resolution,\r\n          labelsAreShown\r\n        );\r\n      });\r\n    }\r\n    this.createDrawControl();\r\n  }\r\n\r\n  /**\r\n   * Called when the user toggles the Draw control is toggled\r\n   * @internal\r\n   */\r\n  onToggleDrawControl(toggleIsChecked: boolean) {\r\n    toggleIsChecked ? this.toggleDrawControl() : this.deactivateDrawControl();\r\n  }\r\n\r\n  /**\r\n   * Activate the correct control\r\n   */\r\n  private toggleDrawControl() {\r\n    this.deactivateDrawControl();\r\n    this.activateDrawControl();\r\n  }\r\n\r\n  /**\r\n   * Open a dialog box to enter label and do something\r\n   * @param olGeometry geometry at draw end or selected geometry\r\n   * @param drawEnd event fired at drawEnd?\r\n   */\r\n  private openDialog(olGeometryFeature, isDrawEnd: boolean) {\r\n    setTimeout(() => {\r\n      // open the dialog box used to enter label\r\n      const dialogRef = this.dialog.open(DrawPopupComponent, {\r\n        disableClose: false,\r\n        data: { currentLabel: olGeometryFeature.get('draw') }\r\n      });\r\n\r\n      // when dialog box is closed, get label and set it to geometry\r\n      dialogRef.afterClosed().subscribe((label: string) => {\r\n        // checks if the user clicked ok\r\n        if (dialogRef.componentInstance.confirmFlag) {\r\n          this.updateLabelOfOlGeometry(olGeometryFeature, label);\r\n          // if event was fired at draw end\r\n          if (isDrawEnd) {\r\n            this.onDrawEnd(olGeometryFeature);\r\n            // if event was fired at select\r\n          } else {\r\n            this.onSelectDraw(olGeometryFeature, label);\r\n          }\r\n        }\r\n        // deletes the feature\r\n        else {\r\n          this.olDrawingLayerSource\r\n            .getFeatures()\r\n            .forEach((drawingLayerFeature) => {\r\n              const geometry = drawingLayerFeature.getGeometry() as any;\r\n              if (olGeometryFeature === geometry) {\r\n                this.olDrawingLayerSource.removeFeature(drawingLayerFeature);\r\n              }\r\n            });\r\n        }\r\n      });\r\n    }, 250);\r\n  }\r\n\r\n  /**\r\n   * Activate a given control\r\n   */\r\n  private activateDrawControl() {\r\n    this.drawControlIsDisabled = false;\r\n    this.drawControlIsActive = true;\r\n    this.drawEnd$$ = this.drawControl.end$.subscribe(\r\n      (olGeometry: OlGeometry) => {\r\n        this.openDialog(olGeometry, true);\r\n      }\r\n    );\r\n\r\n    this.drawControl.modify$.subscribe((olGeometry: OlGeometry) => {\r\n      this.onModifyDraw(olGeometry);\r\n    });\r\n\r\n    if (!this.drawSelect$$) {\r\n      this.drawSelect$$ = this.drawControl.select$.subscribe(\r\n        (olFeature: OlFeature<OlGeometry>) => {\r\n          this.openDialog(olFeature, false);\r\n        }\r\n      );\r\n    }\r\n\r\n    this.drawControl.setOlMap(this.map.ol, true);\r\n  }\r\n\r\n  /**\r\n   * Deactivate the active draw control\r\n   */\r\n  private deactivateDrawControl() {\r\n    if (!this.drawControl) {\r\n      return;\r\n    }\r\n\r\n    if (this.drawEnd$$) {\r\n      this.drawEnd$$.unsubscribe();\r\n    }\r\n\r\n    this.drawControl.setOlMap(undefined);\r\n    this.drawControlIsActive = false;\r\n  }\r\n\r\n  /**\r\n   * Clear the draw source and track the geometry being draw\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onDrawEnd(olGeometry: OlGeometry, radius?: number) {\r\n    this.addFeatureToStore(olGeometry, radius);\r\n    this.clearLabelsOfOlGeometry(olGeometry);\r\n    this.store.layer.ol.getSource().refresh();\r\n  }\r\n\r\n  private onModifyDraw(olGeometry) {\r\n    const entities = this.store.all();\r\n\r\n    entities.forEach((entity) => {\r\n      const entityId = entity.properties.id;\r\n\r\n      const olGeometryId = olGeometry.ol_uid;\r\n\r\n      if (entityId === olGeometryId) {\r\n        this.updateLabelOfOlGeometry(olGeometry, entity.properties.draw);\r\n        this.replaceFeatureInStore(entity, olGeometry);\r\n      }\r\n    });\r\n  }\r\n\r\n  private onSelectDraw(olFeature: OlFeature<OlGeometry>, label: string) {\r\n    const entities = this.store.all();\r\n\r\n    const olGeometry = olFeature.getGeometry() as any;\r\n    olGeometry.ol_uid = olFeature.get('id');\r\n\r\n    const olGeometryCoordinates = JSON.stringify(\r\n      olGeometry.getCoordinates()[0]\r\n    );\r\n\r\n    entities.forEach((entity) => {\r\n      const entityCoordinates = JSON.stringify(entity.geometry.coordinates[0]);\r\n\r\n      if (olGeometryCoordinates === entityCoordinates) {\r\n        const rad: number = entity.properties.rad\r\n          ? entity.properties.rad\r\n          : undefined;\r\n        this.updateLabelOfOlGeometry(olGeometry, label);\r\n        this.replaceFeatureInStore(entity, olGeometry, rad);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Add a feature with draw label to the store. The loading stragegy of the store\r\n   * will trigger and add the feature to the map.\r\n   * @internal\r\n   */\r\n  private addFeatureToStore(\r\n    olGeometry,\r\n    radius?: number,\r\n    feature?: FeatureWithDraw\r\n  ) {\r\n    let rad: number;\r\n    let center4326: Array<number>;\r\n    let point4326: Array<number>;\r\n    let lon4326: number;\r\n    let lat4326: number;\r\n    const featureId = feature ? feature.properties.id : olGeometry.ol_uid;\r\n    const projection = this.map.ol.getView().getProjection();\r\n\r\n    const geometry = new OlGeoJSON().writeGeometryObject(olGeometry, {\r\n      featureProjection: projection,\r\n      dataProjection: projection\r\n    }) as any;\r\n\r\n    if (olGeometry instanceof OlCircle || radius) {\r\n      if (radius) {\r\n        rad = radius;\r\n      } else {\r\n        geometry.type = 'Point';\r\n        geometry.coordinates = olGeometry.getCenter();\r\n        const extent4326 = transform(\r\n          [\r\n            olGeometry.getFlatCoordinates()[2],\r\n            olGeometry.getFlatCoordinates()[3]\r\n          ],\r\n          projection,\r\n          'EPSG:4326'\r\n        );\r\n        center4326 = transform(\r\n          [\r\n            olGeometry.getFlatCoordinates()[0],\r\n            olGeometry.getFlatCoordinates()[1]\r\n          ],\r\n          projection,\r\n          'EPSG:4326'\r\n        );\r\n        lon4326 = center4326[0];\r\n        lat4326 = center4326[1];\r\n        rad = getDistance(center4326, extent4326);\r\n      }\r\n    }\r\n\r\n    if (olGeometry instanceof OlPoint) {\r\n      point4326 = transform(\r\n        olGeometry.getFlatCoordinates(),\r\n        projection,\r\n        'EPSG:4326'\r\n      );\r\n      lon4326 = point4326[0];\r\n      lat4326 = point4326[1];\r\n    }\r\n\r\n    this.store.update({\r\n      type: FEATURE,\r\n      geometry,\r\n      projection: projection.getCode(),\r\n      properties: {\r\n        id: featureId,\r\n        draw: olGeometry.get('_label'),\r\n        longitude: lon4326 ? lon4326 : null,\r\n        latitude: lat4326 ? lat4326 : null,\r\n        rad: rad ? rad : null\r\n      },\r\n      meta: {\r\n        id: featureId\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Replace the feature in the store\r\n   * @param entity the entity to replace\r\n   * @param olGeometry the new geometry to insert in the store\r\n   */\r\n  private replaceFeatureInStore(\r\n    entity,\r\n    olGeometry: OlGeometry,\r\n    radius?: number\r\n  ) {\r\n    this.store.delete(entity);\r\n    this.onDrawEnd(olGeometry, radius);\r\n  }\r\n\r\n  private buildForm() {\r\n    this.form = this.formBuilder.group({\r\n      fill: [''],\r\n      stroke: ['']\r\n    });\r\n  }\r\n\r\n  deleteDrawings() {\r\n    this.store.deleteMany(this.selectedFeatures$.value);\r\n    this.selectedFeatures$.value.forEach((selectedFeature) => {\r\n      this.olDrawingLayerSource.getFeatures().forEach((drawingLayerFeature) => {\r\n        const geometry = drawingLayerFeature.getGeometry() as any;\r\n        if (selectedFeature.properties.id === geometry.ol_uid) {\r\n          this.olDrawingLayerSource.removeFeature(drawingLayerFeature);\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Clear the tooltips of an OL geometry\r\n   * @param olGeometry OL geometry with tooltips\r\n   */\r\n  private clearLabelsOfOlGeometry(olGeometry) {\r\n    getTooltipsOfOlGeometry(olGeometry).forEach(\r\n      (olTooltip: OlOverlay | undefined) => {\r\n        if (olTooltip && olTooltip.getMap()) {\r\n          this.map.ol.removeOverlay(olTooltip);\r\n        }\r\n      }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Called when the user toggles the labels toggle\r\n   */\r\n  onToggleLabels() {\r\n    this.drawStyleService.toggleLabelsAreShown();\r\n    this.labelsAreShown = !this.labelsAreShown;\r\n    this.icon\r\n      ? this.onColorChange(this.labelsAreShown, true)\r\n      : this.onColorChange(this.labelsAreShown, false);\r\n  }\r\n\r\n  /**\r\n   * Update the label of a geometry when a label is entered in a dialog box\r\n   * @param olGeometry the geometry\r\n   * @param label the label\r\n   */\r\n  private updateLabelOfOlGeometry(olGeometry: OlGeometry, label: string) {\r\n    olGeometry.setProperties(\r\n      {\r\n        _label: label\r\n      },\r\n      true\r\n    );\r\n  }\r\n\r\n  onIconChange(event?) {\r\n    this.icon = event;\r\n    this.drawStyleService.setIcon(this.icon);\r\n    this.store.layer.ol.setStyle((feature, resolution) => {\r\n      return this.drawStyleService.createDrawingLayerStyle(\r\n        feature,\r\n        resolution,\r\n        true,\r\n        this.icon\r\n      );\r\n    });\r\n  }\r\n\r\n  openShorcutsDialog() {\r\n    this.dialog.open(DrawShorcutsComponent);\r\n  }\r\n\r\n  /**\r\n   * Called when the user double-clicks the selected drawing\r\n   */\r\n  editLabelDrawing() {\r\n    const olGeometry = featureToOl(\r\n      this.selectedFeatures$.value[0],\r\n      this.map.ol.getView().getProjection().getCode()\r\n    );\r\n    this.openDialog(olGeometry, false);\r\n  }\r\n\r\n  /**\r\n   * Called when the user changes the font size or/and style\r\n   * @param labelsAreShown wheter the labels are shown or not\r\n   * @param size the size of the font\r\n   * @param style the style of the font\r\n   */\r\n\r\n  onFontChange(labelsAreShown: boolean, size: string, style: FontType) {\r\n    this.drawStyleService.setFontSize(size);\r\n    this.drawStyleService.setFontStyle(style);\r\n\r\n    this.store.layer.ol.setStyle((feature, resolution) => {\r\n      return this.drawStyleService.createDrawingLayerStyle(\r\n        feature,\r\n        resolution,\r\n        labelsAreShown\r\n      );\r\n    });\r\n    this.createDrawControl();\r\n  }\r\n\r\n  get allFontStyles(): string[] {\r\n    return Object.values(FontType);\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatButtonToggleModule } from '@angular/material/button-toggle';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatSlideToggleModule } from '@angular/material/slide-toggle';\r\nimport { MatDividerModule } from '@angular/material/divider';\r\nimport { MatDialogModule } from '@angular/material/dialog';\r\nimport { ColorPickerModule } from 'ngx-color-picker';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoEntityTableModule } from '@igo2/common';\r\nimport { DrawComponent } from './draw.component';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { DrawPopupComponent } from './draw-popup.component';\r\nimport { DrawShorcutsComponent } from './draw-shorcuts.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    CommonModule,\r\n    MatButtonModule,\r\n    MatButtonToggleModule,\r\n    MatDividerModule,\r\n    MatFormFieldModule,\r\n    MatIconModule,\r\n    MatTooltipModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatListModule,\r\n    MatSelectModule,\r\n    MatSlideToggleModule,\r\n    MatDialogModule,\r\n    IgoLanguageModule,\r\n    IgoEntityTableModule,\r\n    ColorPickerModule\r\n  ],\r\n  declarations: [\r\n    DrawComponent,\r\n    DrawPopupComponent,\r\n    DrawShorcutsComponent\r\n  ],\r\n  exports: [\r\n    DrawComponent\r\n  ]\r\n})\r\nexport class IgoDrawModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoKeyValueModule, IgoImageModule } from '@igo2/common';\r\n\r\nimport { FeatureDetailsComponent } from './feature-details.component';\r\nimport { FeatureDetailsDirective } from './feature-details.directive';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatIconModule,\r\n    IgoLanguageModule,\r\n    IgoKeyValueModule,\r\n    IgoImageModule\r\n  ],\r\n  exports: [\r\n    FeatureDetailsComponent,\r\n    FeatureDetailsDirective],\r\n  declarations: [\r\n    FeatureDetailsComponent,\r\n    FeatureDetailsDirective]\r\n})\r\nexport class IgoFeatureDetailsModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoFormModule } from '@igo2/common';\r\n\r\nimport { FeatureFormComponent } from './feature-form.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoFormModule\r\n  ],\r\n  exports: [\r\n    IgoFormModule,\r\n    FeatureFormComponent\r\n  ],\r\n  declarations: [\r\n    FeatureFormComponent\r\n  ]\r\n})\r\nexport class IgoFeatureFormModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoFeatureDetailsModule } from './feature-details/feature-details.module';\r\nimport { IgoFeatureFormModule } from './feature-form/feature-form.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule\r\n  ],\r\n  exports: [\r\n    IgoFeatureDetailsModule,\r\n    IgoFeatureFormModule\r\n  ],\r\n  declarations: [],\r\n  providers: []\r\n})\r\nexport class IgoFeatureModule {}\r\n","import OlMap from 'ol/Map';\r\nimport OlFeature from 'ol/Feature';\r\nimport * as OlStyle from 'ol/style';\r\nimport { StyleLike as OlStyleLike } from 'ol/style/Style';\r\nimport OlVectorSource from 'ol/source/Vector';\r\nimport OlVectorLayer from 'ol/layer/Vector';\r\nimport OlModify from 'ol/interaction/Modify';\r\nimport OlTranslate from 'ol/interaction/Translate';\r\nimport OlDraw from 'ol/interaction/Draw';\r\nimport OlPolygon from 'ol/geom/Polygon';\r\nimport OlLineString from 'ol/geom/LineString';\r\nimport OlCircle from 'ol/geom/Circle';\r\nimport OlLinearRing from 'ol/geom/LinearRing';\r\nimport OlInteraction from 'ol/interaction/Interaction';\r\nimport OlDragBoxInteraction from 'ol/interaction/DragBox';\r\nimport MapBrowserEvent from 'ol/MapBrowserEvent';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport BasicEvent from 'ol/events/Event';\r\nimport { ModifyEvent as OlModifyEvent } from 'ol/interaction/Modify';\r\nimport { TranslateEvent as OlTranslateEvent } from 'ol/interaction/Translate';\r\nimport { DrawEvent as OlDrawEvent } from 'ol/interaction/Draw';\r\nimport { unByKey } from 'ol/Observable';\r\n\r\nimport { Subject, Subscription, fromEvent } from 'rxjs';\r\n\r\nimport {\r\n  addLinearRingToOlPolygon,\r\n  createDrawHoleInteractionStyle,\r\n  getMousePositionFromOlGeometryEvent\r\n} from '../geometry.utils';\r\n\r\nexport interface ModifyControlOptions {\r\n  source?: OlVectorSource<any>;\r\n  layer?: OlVectorLayer<any>;\r\n  layerStyle?: OlStyleLike;\r\n  drawStyle?: OlStyleLike;\r\n  modify?: boolean;\r\n  translate?: boolean;\r\n}\r\n\r\n/**\r\n * Control to modify geometries\r\n */\r\nexport class ModifyControl {\r\n  /**\r\n   * Modify start observable\r\n   */\r\n  public start$: Subject<OlGeometry> = new Subject();\r\n\r\n  /**\r\n   * Modify end observable\r\n   */\r\n  public end$: Subject<OlGeometry> = new Subject();\r\n\r\n  /**\r\n   * Geometry changes observable\r\n   */\r\n  public changes$: Subject<OlGeometry> = new Subject();\r\n\r\n  private olMap: OlMap;\r\n  private olOverlayLayer: OlVectorLayer<any>;\r\n  public olModifyInteraction: OlModify;\r\n  private onModifyStartKey: any;\r\n  private onModifyEndKey: any;\r\n  private onModifyKey: any;\r\n  private olModifyInteractionIsActive: boolean = false;\r\n  private olTranslateInteraction: OlTranslate;\r\n  private onTranslateStartKey: any;\r\n  private onTranslateEndKey: any;\r\n  private onTranslateKey: any;\r\n  private olTranslateInteractionIsActive: boolean = false;\r\n  private olDrawInteraction: OlDraw;\r\n  private onDrawStartKey: any;\r\n  private onDrawEndKey: any;\r\n  private onDrawKey: any;\r\n  private olDrawInteractionIsActive: boolean = false;\r\n\r\n  private mousePosition: [number, number];\r\n\r\n  private keyDown$$: Subscription;\r\n  private drawKeyUp$$: Subscription;\r\n  private drawKeyDown$$: Subscription;\r\n\r\n  private removedOlInteractions: OlInteraction[] = [];\r\n  private olLinearRingsLayer: OlVectorLayer<any>;\r\n\r\n  // This is the geometry to test against when drawing holes\r\n  private olOuterGeometry: OlGeometry;\r\n\r\n  /**\r\n   * Wheter the control is active\r\n   */\r\n  get active(): boolean {\r\n    return this.olMap !== undefined;\r\n  }\r\n\r\n  /**\r\n   * OL overlay source\r\n   * @internal\r\n   */\r\n  get olOverlaySource(): OlVectorSource<any> {\r\n    return this.olOverlayLayer.getSource();\r\n  }\r\n\r\n  /**\r\n   * OL linear rings source\r\n   * @internal\r\n   */\r\n  get olLinearRingsSource(): OlVectorSource<any> {\r\n    return this.olLinearRingsLayer.getSource();\r\n  }\r\n\r\n  /**\r\n   * Whether a modify control should be available\r\n   */\r\n  private modify: boolean = true;\r\n\r\n  /**\r\n   * Whether a translate control should be available\r\n   */\r\n  private translate: boolean = true;\r\n\r\n  constructor(private options: ModifyControlOptions) {\r\n    if (options.modify !== undefined) {\r\n      this.modify = options.modify;\r\n    }\r\n    if (options.translate !== undefined) {\r\n      this.translate = options.translate;\r\n    }\r\n\r\n    if (options.layer !== undefined) {\r\n      this.olOverlayLayer = options.layer;\r\n    } else {\r\n      this.olOverlayLayer = this.createOlInnerOverlayLayer();\r\n    }\r\n    this.olLinearRingsLayer = this.createOlLinearRingsLayer();\r\n  }\r\n\r\n  /**\r\n   * Add or remove this control to/from a map.\r\n   * @param map OL Map\r\n   */\r\n  setOlMap(olMap: OlMap | undefined) {\r\n    if (olMap === undefined) {\r\n      this.clearOlInnerOverlaySource();\r\n      this.removeOlInnerOverlayLayer();\r\n      this.removeOlModifyInteraction();\r\n      this.removeOlTranslateInteraction();\r\n      this.removeOlDrawInteraction();\r\n      this.olMap = olMap;\r\n      return;\r\n    }\r\n\r\n    this.olMap = olMap;\r\n    this.addOlInnerOverlayLayer();\r\n\r\n    // The order in which these interactions\r\n    // are added is important\r\n    if (this.modify === true) {\r\n      this.addOlDrawInteraction();\r\n    }\r\n\r\n    if (this.translate === true) {\r\n      this.addOlTranslateInteraction();\r\n      this.activateTranslateInteraction();\r\n    }\r\n\r\n    if (this.modify === true) {\r\n      this.addOlModifyInteraction();\r\n      this.activateModifyInteraction();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Return the overlay source\r\n   */\r\n  getSource(): OlVectorSource<any> {\r\n    return this.olOverlaySource;\r\n  }\r\n\r\n  /**\r\n   * Add an OL geometry to the overlay and start modifying it\r\n   * @param olGeometry Ol Geometry\r\n   */\r\n  setOlGeometry(olGeometry: OlGeometry) {\r\n    const olFeature = new OlFeature({ geometry: olGeometry });\r\n    this.olOverlaySource.clear();\r\n    this.olOverlaySource.addFeature(olFeature);\r\n  }\r\n\r\n  /**\r\n   * Create an overlay source if none is defined in the options\r\n   */\r\n  private createOlInnerOverlayLayer(): OlVectorLayer<any> {\r\n    return new OlVectorLayer({\r\n      source: this.options.source ? this.options.source : new OlVectorSource(),\r\n      style: this.options.layerStyle,\r\n      zIndex: 500\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Add the overlay layer if it wasn't defined in the options\r\n   */\r\n  private addOlInnerOverlayLayer() {\r\n    if (this.options.layer === undefined) {\r\n      this.olMap.addLayer(this.olOverlayLayer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay layer if it wasn't defined in the options\r\n   */\r\n  private removeOlInnerOverlayLayer() {\r\n    if (this.options.layer === undefined && this.olMap !== undefined) {\r\n      this.olMap.removeLayer(this.olOverlayLayer);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay source if it wasn't defined in the options\r\n   */\r\n  private clearOlInnerOverlaySource() {\r\n    if (this.options.layer === undefined && this.options.source === undefined) {\r\n      this.olOverlaySource.clear(true);\r\n    }\r\n  }\r\n\r\n  private createOlLinearRingsLayer(): OlVectorLayer<any> {\r\n    return new OlVectorLayer({\r\n      source: new OlVectorSource(),\r\n      style: createDrawHoleInteractionStyle(),\r\n      zIndex: 500\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Add the linear rings layer\r\n   */\r\n  private addOlLinearRingsLayer() {\r\n    this.olMap.addLayer(this.olLinearRingsLayer);\r\n  }\r\n\r\n  /**\r\n   * Clear the linear rings layer\r\n   */\r\n  private removeOlLinearRingsLayer() {\r\n    this.olMap.removeLayer(this.olLinearRingsLayer);\r\n  }\r\n\r\n  /**\r\n   * Clear the linear rings source\r\n   */\r\n  private clearOlLinearRingsSource() {\r\n    this.olLinearRingsSource.clear(true);\r\n  }\r\n\r\n  /**\r\n   * Add a modify interaction to the map an set up some listeners\r\n   */\r\n  private addOlModifyInteraction() {\r\n    const olModifyInteraction = new OlModify({\r\n      source: this.olOverlaySource,\r\n      style: this.options.drawStyle as OlStyle.Style\r\n    });\r\n    this.olModifyInteraction = olModifyInteraction;\r\n  }\r\n\r\n  /**\r\n   * Remove the modify interaction\r\n   */\r\n  private removeOlModifyInteraction() {\r\n    if (this.olModifyInteraction === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.deactivateModifyInteraction();\r\n    this.olModifyInteraction = undefined;\r\n  }\r\n\r\n  private activateModifyInteraction() {\r\n    if (this.olModifyInteractionIsActive === true) {\r\n      return;\r\n    }\r\n\r\n    this.olModifyInteractionIsActive = true;\r\n    this.onModifyStartKey = this.olModifyInteraction.on(\r\n      'modifystart',\r\n      (event: OlModifyEvent) => this.onModifyStart(event)\r\n    );\r\n    this.onModifyEndKey = this.olModifyInteraction.on(\r\n      'modifyend',\r\n      (event: OlModifyEvent) => this.onModifyEnd(event)\r\n    );\r\n    this.olMap.addInteraction(this.olModifyInteraction);\r\n  }\r\n\r\n  private deactivateModifyInteraction() {\r\n    if (this.olModifyInteractionIsActive === false) {\r\n      return;\r\n    }\r\n\r\n    this.olModifyInteractionIsActive = false;\r\n\r\n    unByKey([this.onModifyStartKey, this.onModifyEndKey, this.onModifyKey]);\r\n    if (this.olMap !== undefined) {\r\n      this.olMap.removeInteraction(this.olModifyInteraction);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * When modifying starts, clear the overlay and start watching for changes\r\n   * @param event Modify start event\r\n   */\r\n  private onModifyStart(event: OlModifyEvent) {\r\n    const olGeometry = event.features.item(0).getGeometry() as OlGeometry;\r\n    this.start$.next(olGeometry);\r\n    this.onModifyKey = olGeometry.on(\r\n      'change',\r\n      (olGeometryEvent: BasicEvent) => {\r\n        this.mousePosition = getMousePositionFromOlGeometryEvent(\r\n          olGeometryEvent\r\n        );\r\n        this.changes$.next(olGeometryEvent.target as OlLineString | OlCircle | OlPolygon);\r\n      }\r\n    );\r\n    this.subscribeToKeyDown();\r\n  }\r\n\r\n  /**\r\n   * When modifying ends, update the geometry observable and stop watching for changes\r\n   * @param event Modify end event\r\n   */\r\n  private onModifyEnd(event: OlModifyEvent) {\r\n    unByKey(this.onModifyKey);\r\n    this.end$.next(event.features.item(0).getGeometry() as OlGeometry);\r\n    this.unsubscribeToKeyDown();\r\n  }\r\n\r\n  /**\r\n   * Subscribe to space key down to pan the map\r\n   */\r\n  private subscribeToKeyDown() {\r\n    this.keyDown$$ = fromEvent(document, 'keydown').subscribe(\r\n      (event: KeyboardEvent) => {\r\n        if (event.key === ' ') {\r\n          // On space bar, pan to the current mouse position\r\n          this.olMap.getView().animate({\r\n            center: this.mousePosition,\r\n            duration: 0\r\n          });\r\n          return;\r\n        }\r\n      }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to key down\r\n   */\r\n  private unsubscribeToKeyDown() {\r\n    if (this.keyDown$$ !== undefined) {\r\n      this.keyDown$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add a translate interaction to the map an set up some listeners\r\n   */\r\n  private addOlTranslateInteraction() {\r\n    const olTranslateInteraction = new OlTranslate({\r\n      layers: [this.olOverlayLayer]\r\n    });\r\n    this.olTranslateInteraction = olTranslateInteraction;\r\n  }\r\n\r\n  /**\r\n   * Remove the translate interaction\r\n   */\r\n  private removeOlTranslateInteraction() {\r\n    if (this.olTranslateInteraction === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.deactivateTranslateInteraction();\r\n    this.olTranslateInteraction = undefined;\r\n  }\r\n\r\n  private activateTranslateInteraction() {\r\n    if (this.olTranslateInteractionIsActive === true) {\r\n      return;\r\n    }\r\n\r\n    this.olTranslateInteractionIsActive = true;\r\n    this.onTranslateStartKey = this.olTranslateInteraction.on(\r\n      'translatestart',\r\n      (event: OlTranslateEvent) => this.onTranslateStart(event)\r\n    );\r\n    this.onTranslateEndKey = this.olTranslateInteraction.on(\r\n      'translateend',\r\n      (event: OlTranslateEvent) => this.onTranslateEnd(event)\r\n    );\r\n    this.olMap.addInteraction(this.olTranslateInteraction);\r\n  }\r\n\r\n  private deactivateTranslateInteraction() {\r\n    if (this.olTranslateInteractionIsActive === false) {\r\n      return;\r\n    }\r\n\r\n    this.olTranslateInteractionIsActive = false;\r\n    unByKey([\r\n      this.onTranslateStartKey,\r\n      this.onTranslateEndKey,\r\n      this.onTranslateKey\r\n    ]);\r\n    if (this.olMap !== undefined) {\r\n      this.olMap.removeInteraction(this.olTranslateInteraction);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * When translation starts, clear the overlay and start watching for changes\r\n   * @param event Translate start event\r\n   */\r\n  private onTranslateStart(event: OlTranslateEvent) {\r\n    const olGeometry = event.features.item(0).getGeometry() as OlGeometry;\r\n    this.start$.next(olGeometry);\r\n    this.onTranslateKey = olGeometry.on(\r\n      'change',\r\n      (olGeometryEvent: BasicEvent) => {\r\n        // this.changes$.next(olGeometryEvent.target);\r\n      }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * When translation ends, update the geometry observable and stop watchign for changes\r\n   * @param event Translate end event\r\n   */\r\n  private onTranslateEnd(event: OlTranslateEvent) {\r\n    unByKey(this.onTranslateKey);\r\n    this.end$.next(event.features.item(0).getGeometry() as OlGeometry);\r\n  }\r\n\r\n  /**\r\n   * Add a draw interaction to the map an set up some listeners\r\n   */\r\n  private addOlDrawInteraction() {\r\n    const olDrawInteraction = new OlDraw({\r\n      type: 'Polygon',\r\n      source: this.olLinearRingsSource,\r\n      stopClick: true,\r\n      style: createDrawHoleInteractionStyle(),\r\n      condition: (event: MapBrowserEvent<any>) => {\r\n        const olOuterGeometry = this.olOuterGeometry || this.getOlGeometry();\r\n        const intersects = olOuterGeometry.intersectsCoordinate(\r\n          event.coordinate\r\n        );\r\n        return intersects;\r\n      }\r\n    });\r\n\r\n    this.olDrawInteraction = olDrawInteraction;\r\n    this.subscribeToDrawKeyDown();\r\n  }\r\n\r\n  /**\r\n   * Subscribe to CTRL key down to activate the draw control\r\n   */\r\n  private subscribeToDrawKeyDown() {\r\n    this.drawKeyDown$$ = fromEvent(document, 'keydown').subscribe(\r\n      (event: KeyboardEvent) => {\r\n        if (event.key !== 'Control') {\r\n          return;\r\n        }\r\n\r\n        this.unsubscribeToDrawKeyDown();\r\n\r\n        const olGeometry = this.getOlGeometry();\r\n        if (!olGeometry || !(olGeometry instanceof OlPolygon)) {\r\n          return;\r\n        }\r\n\r\n        this.subscribeToDrawKeyUp();\r\n\r\n        this.deactivateModifyInteraction();\r\n        this.deactivateTranslateInteraction();\r\n        this.activateDrawInteraction();\r\n      }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Subscribe to CTRL key up to deactivate the draw control\r\n   */\r\n  private subscribeToDrawKeyUp() {\r\n    this.drawKeyUp$$ = fromEvent(document, 'keyup').subscribe(\r\n      (event: KeyboardEvent) => {\r\n        if (event.key !== 'Control') {\r\n          return;\r\n        }\r\n\r\n        this.unsubscribeToDrawKeyUp();\r\n        this.unsubscribeToKeyDown();\r\n        this.deactivateDrawInteraction();\r\n\r\n        this.activateModifyInteraction();\r\n        if (this.translate === true) {\r\n          this.activateTranslateInteraction();\r\n        }\r\n        this.subscribeToDrawKeyDown();\r\n\r\n        this.olOuterGeometry = undefined;\r\n        this.clearOlLinearRingsSource();\r\n        this.end$.next(this.getOlGeometry());\r\n      }\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to draw key down\r\n   */\r\n  private unsubscribeToDrawKeyDown() {\r\n    if (this.drawKeyDown$$ !== undefined) {\r\n      this.drawKeyDown$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to key up\r\n   */\r\n  private unsubscribeToDrawKeyUp() {\r\n    if (this.drawKeyUp$$ !== undefined) {\r\n      this.drawKeyUp$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove the draw interaction\r\n   */\r\n  private removeOlDrawInteraction() {\r\n    if (this.olDrawInteraction === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.unsubscribeToKeyDown();\r\n    this.unsubscribeToDrawKeyUp();\r\n    this.unsubscribeToDrawKeyDown();\r\n    this.deactivateDrawInteraction();\r\n    this.clearOlLinearRingsSource();\r\n    this.olDrawInteraction = undefined;\r\n  }\r\n\r\n  /**\r\n   * Activate the draw interaction\r\n   */\r\n  private activateDrawInteraction() {\r\n    if (this.olDrawInteractionIsActive === true) {\r\n      return;\r\n    }\r\n\r\n    this.clearOlLinearRingsSource();\r\n    this.addOlLinearRingsLayer();\r\n\r\n    this.olMap.getInteractions().forEach((olInteraction: OlInteraction) => {\r\n      if (olInteraction instanceof OlDragBoxInteraction) {\r\n        this.olMap.removeInteraction(olInteraction);\r\n        this.removedOlInteractions.push(olInteraction);\r\n      }\r\n    });\r\n\r\n    this.olDrawInteractionIsActive = true;\r\n    this.onDrawStartKey = this.olDrawInteraction.on(\r\n      'drawstart',\r\n      (event: OlDrawEvent) => this.onDrawStart(event)\r\n    );\r\n    this.onDrawEndKey = this.olDrawInteraction.on(\r\n      'drawend',\r\n      (event: OlDrawEvent) => this.onDrawEnd(event)\r\n    );\r\n    this.olMap.addInteraction(this.olDrawInteraction);\r\n  }\r\n\r\n  /**\r\n   * Deactivate the draw interaction\r\n   */\r\n  private deactivateDrawInteraction() {\r\n    if (this.olDrawInteractionIsActive === false) {\r\n      return;\r\n    }\r\n\r\n    this.removeOlLinearRingsLayer();\r\n\r\n    this.removedOlInteractions.forEach((olInteraction: OlInteraction) => {\r\n      this.olMap.addInteraction(olInteraction);\r\n    });\r\n    this.removedOlInteractions = [];\r\n\r\n    this.olDrawInteractionIsActive = false;\r\n    unByKey([this.onDrawStartKey, this.onDrawEndKey, this.onDrawKey]);\r\n    if (this.olMap !== undefined) {\r\n      this.olMap.removeInteraction(this.olDrawInteraction);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * When draw start, add a new linerar ring to the geometry and start watching for changes\r\n   * @param event Draw start event\r\n   */\r\n  private onDrawStart(event: OlDrawEvent) {\r\n    const olGeometry = event.feature.getGeometry();\r\n    this.olOuterGeometry = this.getOlGeometry().clone();\r\n\r\n    const linearRingCoordinates = olGeometry.getLinearRing().getCoordinates();\r\n    this.addLinearRingToOlGeometry(linearRingCoordinates);\r\n    this.start$.next(this.getOlGeometry());\r\n\r\n    this.onDrawKey = olGeometry.on(\r\n      'change',\r\n      (olGeometryEvent: BasicEvent) => {\r\n        this.mousePosition = getMousePositionFromOlGeometryEvent(\r\n          olGeometryEvent\r\n        );\r\n        const olGeometryTarget = olGeometryEvent.target as OlPolygon;\r\n        const _linearRingCoordinates = olGeometryTarget\r\n          .getLinearRing(0)\r\n          .getCoordinates();\r\n        this.updateLinearRingOfOlGeometry(_linearRingCoordinates);\r\n        this.changes$.next(this.getOlGeometry());\r\n      }\r\n    );\r\n    this.subscribeToKeyDown();\r\n  }\r\n\r\n  /**\r\n   * When translation ends, update the geometry observable and stop watchign for changes\r\n   * @param event Draw end event\r\n   */\r\n  private onDrawEnd(event: OlDrawEvent) {\r\n    unByKey(this.onDrawKey);\r\n    this.olOuterGeometry = undefined;\r\n\r\n    const linearRingCoordinates = event.feature\r\n      .getGeometry()\r\n      .getLinearRing()\r\n      .getCoordinates();\r\n    this.updateLinearRingOfOlGeometry(linearRingCoordinates);\r\n    this.clearOlLinearRingsSource();\r\n    this.end$.next(this.getOlGeometry());\r\n    this.unsubscribeToKeyDown();\r\n  }\r\n\r\n  /**\r\n   * Add a linear ring to the geometry being modified\r\n   * @param coordinates Linear ring coordinates\r\n   */\r\n  private addLinearRingToOlGeometry(coordinates: number[]) {\r\n    const olGeometry = this.getOlGeometry() as OlPolygon;\r\n    const olLinearRing = new OlLinearRing(coordinates);\r\n    addLinearRingToOlPolygon(olGeometry, olLinearRing);\r\n  }\r\n\r\n  /**\r\n   * Update the last linear ring of the geometry being modified\r\n   * @param coordinates Linear ring coordinates\r\n   */\r\n  private updateLinearRingOfOlGeometry(coordinates: number[][]) {\r\n    const olGeometry = this.getOlGeometry() as OlPolygon;\r\n    // Remove the last linear ring (the one we are updating)\r\n    const olLinearRings = olGeometry.getLinearRings().slice(0, -1);\r\n    const newCoordinates = olLinearRings.map((olLinearRing: OlLinearRing) => {\r\n      return olLinearRing.getCoordinates();\r\n    });\r\n    newCoordinates.push(coordinates);\r\n    olGeometry.setCoordinates(newCoordinates);\r\n  }\r\n\r\n  /**\r\n   * Get the geometry being modified\r\n   * @returns OL Geometry\r\n   */\r\n  private getOlGeometry(): OlGeometry {\r\n    const olFeatures = this.olOverlaySource.getFeatures();\r\n    return olFeatures.length > 0 ? olFeatures[0].getGeometry() : undefined;\r\n  }\r\n}\r\n","export const LAYER = 'Layer';\r\n","<h3 mat-dialog-title>{{'igo.geo.measure.dialog.title' | translate}}</h3>\r\n\r\n<table *ngIf=\"data.length > 0\"\r\n  class=\"mat-typography\">\r\n  <thead>\r\n    <tr>\r\n      <th colspan=\"2\">{{'igo.geo.measure.dialog.length.title' | translate}}</th>\r\n    </tr>\r\n  </thead>\r\n  <tbody>\r\n    <tr>\r\n      <td>{{data.length | measureFormat: measureLengthUnit.Meters}}</td>\r\n      <td>{{'igo.geo.measure.dialog.lengthInMeters' | translate}}</td>\r\n    </tr>\r\n    <tr>\r\n      <td>{{data.length | measureFormat: measureLengthUnit.Kilometers}}</td>\r\n      <td>{{'igo.geo.measure.dialog.lengthInKilometers' | translate}}</td>\r\n    </tr>\r\n    <tr>\r\n      <td>{{data.length | measureFormat: measureLengthUnit.Miles}}</td>\r\n      <td>{{'igo.geo.measure.dialog.lengthInMiles' | translate}}</td>\r\n    </tr>\r\n    <tr>\r\n      <td>{{data.length | measureFormat: measureLengthUnit.Feet}}</td>\r\n      <td>{{'igo.geo.measure.dialog.lengthInFeet' | translate}}</td>\r\n    </tr>\r\n  </tbody>\r\n</table>\r\n\r\n<table *ngIf=\"data.area > 0\"\r\n  class=\"mat-typography\">\r\n  <thead>\r\n    <tr>\r\n      <th colspan=\"2\">{{'igo.geo.measure.dialog.area.title' | translate}}</th>\r\n    </tr>\r\n  </thead>\r\n  <tbody>\r\n    <tr>\r\n      <td>{{data.area | measureFormat: measureAreaUnit.SquareMeters}}</td>\r\n      <td>{{'igo.geo.measure.dialog.areaInSquareMeters' | translate}}</td>\r\n    </tr>\r\n    <tr>\r\n      <td>{{data.area | measureFormat:measureAreaUnit.SquareKilometers}}</td>\r\n      <td>{{'igo.geo.measure.dialog.areaInSquareKilometers' | translate}}</td>\r\n    </tr>\r\n    <tr>\r\n      <td>{{data.area | measureFormat: measureAreaUnit.SquareMiles}}</td>\r\n      <td>{{'igo.geo.measure.dialog.areaInSquareMiles' | translate}}</td>\r\n    </tr>\r\n    <tr>\r\n      <td>{{data.area | measureFormat: measureAreaUnit.Acres}}</td>\r\n      <td>{{'igo.geo.measure.dialog.areaInAcres' | translate}}</td>\r\n    </tr>\r\n    <tr>\r\n      <td>{{data.area | measureFormat: measureAreaUnit.Hectares}}</td>\r\n      <td>{{'igo.geo.measure.dialog.areaInHectares' | translate}}</td>\r\n    </tr>\r\n    <tr>\r\n      <td>{{'igo.geo.measure.dialog.perimeterInMeters' | translate}}</td>\r\n      <td>{{data.perimeter | measureFormat: measureLengthUnit.Meters}}</td>\r\n    </tr>\r\n  </tbody>\r\n</table>\r\n","import { Component, Inject } from '@angular/core';\r\nimport { MatDialogRef, MAT_DIALOG_DATA } from '@angular/material/dialog';\r\n\r\nimport { MeasurerDialogData } from '../shared/measure.interfaces';\r\n\r\nimport { MeasureAreaUnit, MeasureLengthUnit} from '../shared/measure.enum';\r\n\r\n@Component({\r\n  selector: 'igo-measurer-dialog',\r\n  templateUrl: 'measurer-dialog.component.html',\r\n  styleUrls: ['./measurer-dialog.component.scss']\r\n})\r\nexport class MeasurerDialogComponent {\r\n\r\n  measureAreaUnit = MeasureAreaUnit;\r\n\r\n  measureLengthUnit = MeasureLengthUnit;\r\n\r\n  constructor(\r\n    public dialogRef: MatDialogRef<MeasurerDialogComponent>,\r\n    @Inject(MAT_DIALOG_DATA) public data: MeasurerDialogData\r\n  ) {}\r\n\r\n  onNoClick(): void {\r\n    this.dialogRef.close();\r\n  }\r\n\r\n}\r\n","<div>\r\n  <div class=\"measure-type-toggle mat-typography\">\r\n    <mat-button-toggle-group\r\n      [value]=\"activeMeasureType\"\r\n      (change)=\"onMeasureTypeChange($event.value)\">\r\n      <mat-button-toggle [value]=\"measureType.Length\">\r\n        {{('igo.geo.measure.' + measureType.Length) | translate}}\r\n      </mat-button-toggle>\r\n      <mat-button-toggle [value]=\"measureType.Area\">\r\n        {{('igo.geo.measure.' + measureType.Area) | translate}}\r\n      </mat-button-toggle>\r\n    </mat-button-toggle-group>\r\n  </div>\r\n\r\n  <div class=\"measure-options mat-typography\">\r\n    <mat-slide-toggle\r\n      [disabled]=\"drawControlIsDisabled\"\r\n      [checked]=\"drawControlIsActive\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onToggleDrawControl($event.checked)\">\r\n      {{'igo.geo.measure.toggleActive' | translate}}\r\n    </mat-slide-toggle>\r\n\r\n    <mat-divider *ngIf=\"(hasLine$ | async)\"></mat-divider>\r\n\r\n    <mat-slide-toggle *ngIf=\"(hasLine$ | async)\"\r\n      [checked]=\"displayLines\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onToggleDisplayLines($event.checked)\">\r\n      {{'igo.geo.measure.toggleDisplayLines' | translate}}\r\n    </mat-slide-toggle>\r\n\r\n    <mat-divider *ngIf=\"(hasLine$ | async) || (hasArea$ | async)\"></mat-divider>\r\n\r\n    <mat-slide-toggle *ngIf=\"(hasArea$ | async)\"\r\n      [checked]=\"displayDistance\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onToggleDisplayDistance($event.checked)\">\r\n      {{'igo.geo.measure.toggleDisplayDistance' | translate}}\r\n    </mat-slide-toggle>\r\n\r\n    <mat-slide-toggle *ngIf=\"(hasArea$ | async)\"\r\n      [checked]=\"displayAreas\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onToggleDisplayAreas($event.checked)\">\r\n      {{'igo.geo.measure.toggleDisplayAreas' | translate}}\r\n    </mat-slide-toggle>\r\n\r\n    <mat-divider *ngIf=\"(hasArea$ | async)\"></mat-divider>\r\n\r\n    <mat-slide-toggle\r\n      [checked]=\"measureUnitsAuto\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onToggleMeasureUnitsAuto($event.checked)\">\r\n      {{'igo.geo.measure.toggleAutoUnits' | translate}}\r\n    </mat-slide-toggle>\r\n  </div>\r\n\r\n  <ng-container *ngIf=\"measure$ | async as measure\">\r\n    <igo-measurer-item *ngIf=\"activeMeasureType === measureType.Length || activeMeasureType === measureType.Area\"\r\n      [measureType]=\"measureType.Length\"\r\n      [measureUnit]=\"measureLengthUnit.Meters\"\r\n      [measure]=\"measure.length\"\r\n      [auto]=\"measureUnitsAuto\"\r\n      [placeholder]=\"(activeMeasureType === measureType.Area ? 'igo.geo.measure.perimeter' : 'igo.geo.measure.length') | translate\"\r\n      (measureUnitChange)=\"onLengthUnitChange($event)\">\r\n    </igo-measurer-item>\r\n\r\n    <igo-measurer-item *ngIf=\"activeMeasureType === measureType.Area\"\r\n      [measureType]=\"measureType.Area\"\r\n      [measureUnit]=\"measureAreaUnit.SquareMeters\"\r\n      [measure]=\"measure.area\"\r\n      [auto]=\"measureUnitsAuto\"\r\n      [placeholder]=\"'igo.geo.measure.area' | translate\"\r\n      (measureUnitChange)=\"onAreaUnitChange($event)\">\r\n    </igo-measurer-item>\r\n  </ng-container>\r\n\r\n  <mat-divider *ngIf=\"(hasLine$ | async) || (hasArea$ | async)\"></mat-divider>\r\n\r\n  <div class=\"measure-store-buttons\">\r\n    <button *ngIf=\"(hasLine$ | async) || (hasArea$ | async)\"\r\n      mat-icon-button\r\n      [matTooltip]=\"'igo.geo.measure.actionbar.calculate.tooltip' | translate\"\r\n      [disabled]=\"(selectedFeatures$ | async).length === 0\"\r\n      color=\"accent\"\r\n      (click)=\"onCalculateClick()\">\r\n      <mat-icon svgIcon=\"calculator\"></mat-icon>\r\n    </button>\r\n\r\n    <button *ngIf=\"(hasLine$ | async) || (hasArea$ | async)\"\r\n      mat-icon-button\r\n      [matTooltip]=\"'igo.geo.measure.actionbar.delete.tooltip' | translate\"\r\n      [disabled]=\"(selectedFeatures$ | async).length === 0\"\r\n      color=\"warn\"\r\n      (click)=\"onDeleteClick()\">\r\n      <mat-icon svgIcon=\"delete\"></mat-icon>\r\n    </button>\r\n\r\n    <!--button\r\n      mat-icon-button\r\n      [matTooltip]=\"'igo.geo.measure.actionbar.modify.tooltip' | translate\"\r\n      [disabled]=\"(selectedFeatures$ | async).length !== 1\"\r\n      (click)=\"onModifyClick()\">\r\n      <mat-icon svgIcon=\"edit\"></mat-icon>\r\n    </button-->\r\n  </div>\r\n\r\n  <igo-entity-table\r\n    #table\r\n    class=\"table-compact\"\r\n    [store]=\"store\"\r\n    [template]=\"tableTemplate\">\r\n  </igo-entity-table>\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy,\r\n  ViewChild\r\n} from '@angular/core';\r\nimport { MatDialog } from '@angular/material/dialog';\r\n\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport { skip } from 'rxjs/operators';\r\n\r\nimport OlStyle from 'ol/style/Style';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport OlVectorSource from 'ol/source/Vector';\r\nimport { VectorSourceEvent as OlVectorSourceEvent } from 'ol/source/Vector';\r\nimport OlLineString from 'ol/geom/LineString';\r\nimport OlPolygon from 'ol/geom/Polygon';\r\nimport OlFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport OlOverlay from 'ol/Overlay';\r\nimport { unByKey } from 'ol/Observable';\r\n\r\nimport { LanguageService, StorageScope, StorageService } from '@igo2/core';\r\nimport { EntityRecord, EntityTableTemplate } from '@igo2/common';\r\nimport type { EntityTableComponent } from '@igo2/common';\r\nimport { uuid } from '@igo2/utils';\r\n\r\nimport { FeatureDataSource } from '../../datasource';\r\nimport {\r\n  FEATURE,\r\n  FeatureStore,\r\n  FeatureStoreLoadingStrategy,\r\n  FeatureStoreSelectionStrategy,\r\n  tryBindStoreLayer,\r\n  tryAddLoadingStrategy,\r\n  tryAddSelectionStrategy\r\n} from '../../feature';\r\nimport { DrawControl, ModifyControl } from '../../geometry/shared';\r\nimport { VectorLayer } from '../../layer';\r\nimport { IgoMap } from '../../map';\r\n\r\nimport { Measure, MeasurerDialogData, FeatureWithMeasure } from '../shared/measure.interfaces';\r\nimport {\r\n  MeasureType,\r\n  MeasureAreaUnit,\r\n  MeasureLengthUnit,\r\n} from '../shared/measure.enum';\r\nimport {\r\n  measureOlGeometry,\r\n  createMeasureInteractionStyle,\r\n  createMeasureLayerStyle,\r\n  updateOlTooltipsAtMidpoints,\r\n  updateOlTooltipAtCenter,\r\n  getTooltipsOfOlGeometry,\r\n  squareMetersToUnit,\r\n  metersToUnit,\r\n  formatMeasure\r\n} from '../shared/measure.utils';\r\nimport { MeasurerDialogComponent } from './measurer-dialog.component';\r\n\r\n/**\r\n * Tool to measure lengths and areas\r\n */\r\n@Component({\r\n  selector: 'igo-measurer',\r\n  templateUrl: './measurer.component.html',\r\n  styleUrls: ['./measurer.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class MeasurerComponent implements OnInit, OnDestroy {\r\n\r\n  /**\r\n   * Table template\r\n   * @internal\r\n   */\r\n  public tableTemplate: EntityTableTemplate = {\r\n    selection: true,\r\n    selectMany: true,\r\n    selectionCheckbox: true,\r\n    sort: true,\r\n    columns: [\r\n      {\r\n        name: 'length',\r\n        title: this.languageService.translate.instant('igo.geo.measure.lengthHeader'),\r\n        valueAccessor: (localFeature: FeatureWithMeasure) => {\r\n          const unit = this.activeLengthUnit;\r\n          const measure = metersToUnit(localFeature.properties.measure.length, unit);\r\n          return formatMeasure(measure, {\r\n            decimal: 1,\r\n            unit,\r\n            unitAbbr: false,\r\n            locale: 'fr'\r\n          });\r\n        }\r\n      },\r\n      {\r\n        name: 'area',\r\n        title: this.languageService.translate.instant('igo.geo.measure.areaHeader'),\r\n        valueAccessor: (localFeature: FeatureWithMeasure) => {\r\n          const unit = this.activeAreaUnit;\r\n          const measure = squareMetersToUnit(localFeature.properties.measure.area, unit);\r\n          return measure ? formatMeasure(measure, {\r\n            decimal: 1,\r\n            unit,\r\n            unitAbbr: false,\r\n            locale: 'fr'\r\n          }) : '';\r\n        }\r\n      }\r\n    ]\r\n  };\r\n\r\n  private subscriptions$$: Subscription[] = [];\r\n\r\n  /**\r\n   * Reference to the MeasureType enum\r\n   * @internal\r\n   */\r\n  public measureType = MeasureType;\r\n\r\n  /**\r\n   * Reference to the AreaMeasureUnit enum\r\n   * @internal\r\n   */\r\n  public measureAreaUnit = MeasureAreaUnit;\r\n\r\n  /**\r\n   * Reference to the LengthMeasureUnit enum\r\n   * @internal\r\n   */\r\n  public measureLengthUnit = MeasureLengthUnit;\r\n\r\n  /**\r\n   * Whether measure units should be automatically determined\r\n   * @internal\r\n   */\r\n  public measureUnitsAuto: boolean = false;\r\n\r\n  /**\r\n   * Whether display of distances of areas\r\n   * @internal\r\n   */\r\n  public displayDistance: boolean = true;\r\n\r\n  /**\r\n   * Whether display of distances of lines\r\n   * @internal\r\n   */\r\n  public displayLines: boolean = true;\r\n\r\n  /**\r\n   * Whether display of areas\r\n   * @internal\r\n   */\r\n  public displayAreas: boolean = true;\r\n\r\n  /**\r\n   * Observable of line boolean\r\n   * @internal\r\n   */\r\n   public hasLine$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  /**\r\n   * Observable of area boolean\r\n   * @internal\r\n   */\r\n  public hasArea$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  /**\r\n   * Observable of area\r\n   * @internal\r\n   */\r\n  public measure$: BehaviorSubject<Measure> = new BehaviorSubject({});\r\n\r\n  /**\r\n   * Observable of selected features\r\n   * @internal\r\n   */\r\n  public selectedFeatures$: BehaviorSubject<FeatureWithMeasure[]> = new BehaviorSubject([]);\r\n\r\n  /**\r\n   * OL draw source\r\n   * @internal\r\n   */\r\n  public showTooltips: boolean = true;\r\n\r\n  /**\r\n   * Whether draw control toggle is disabled or not\r\n   * @internal\r\n   */\r\n  public drawControlIsDisabled: boolean = true;\r\n\r\n  /**\r\n   * Draw line control\r\n   */\r\n  private drawLineControl: DrawControl;\r\n\r\n  /**\r\n   * Draw polygon control\r\n   */\r\n  private drawPolygonControl: DrawControl;\r\n\r\n  /**\r\n   * Modify control\r\n   */\r\n  private modifyControl: ModifyControl;\r\n\r\n  /**\r\n   * Active OL geometry\r\n   */\r\n  private activeOlGeometry: OlLineString | OlPolygon;\r\n\r\n  /**\r\n   * Active mlength unit\r\n   */\r\n  private activeLengthUnit: MeasureLengthUnit = MeasureLengthUnit.Meters;\r\n\r\n  /**\r\n   * Active area unit\r\n   */\r\n  private activeAreaUnit: MeasureAreaUnit = MeasureAreaUnit.SquareMeters;\r\n\r\n  /**\r\n   * Feature added listener key\r\n   */\r\n  private onFeatureAddedKey;\r\n\r\n  /**\r\n   * Feature removed listener key\r\n   */\r\n  private onFeatureRemovedKey;\r\n\r\n  /**\r\n   * Active draw control\r\n   * @internal\r\n   */\r\n  private activeDrawControl: DrawControl;\r\n\r\n  /**\r\n   * Subscription to draw start\r\n   */\r\n  private drawStart$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to draw end\r\n   */\r\n  private drawEnd$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to controls changes\r\n   */\r\n  private drawChanges$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to modify start\r\n   */\r\n  private modifyStart$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to modify end\r\n   */\r\n  private modifyEnd$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to controls changes\r\n   */\r\n  private modifyChanges$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to measures selection\r\n   */\r\n  private selectedFeatures$$: Subscription;\r\n\r\n  /**\r\n   * OL draw source\r\n   */\r\n  private olDrawSource = new OlVectorSource();\r\n\r\n  /**\r\n   * The map to measure on\r\n   */\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * The measures store\r\n   */\r\n  @Input() store: FeatureStore<FeatureWithMeasure>;\r\n\r\n  /**\r\n   * Measure type\r\n   * @internal\r\n   */\r\n  @Input()\r\n  set activeMeasureType(value: MeasureType) { this.setActiveMeasureType(value); }\r\n  get activeMeasureType(): MeasureType { return this._activeMeasureType; }\r\n  private _activeMeasureType: MeasureType;\r\n\r\n  /**\r\n   * The minimum length a segment must have to display a tooltip.\r\n   * It also applies to area tooltips.\r\n   */\r\n  @Input() minSegmentLength: number = 10;\r\n\r\n  @ViewChild('table', { static: true }) table: EntityTableComponent;\r\n\r\n  /**\r\n   * Wheter one of the draw control is active\r\n   * @internal\r\n   */\r\n  get drawControlIsActive(): boolean {\r\n    return this.activeDrawControl !== undefined;\r\n  }\r\n\r\n  get projection(): string {\r\n    return this.map.ol.getView().getProjection().getCode();\r\n  }\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dialog: MatDialog,\r\n    private storageService: StorageService\r\n  ) {}\r\n\r\n  /**\r\n   * Add draw controls and activate one\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.initStore();\r\n    this.createDrawLineControl();\r\n    this.createDrawPolygonControl();\r\n    this.createModifyControl();\r\n    this.toggleDrawControl();\r\n    this.updateTooltipsOfOlSource(this.store.source.ol);\r\n    this.checkDistanceAreaToggle();\r\n    this.setActiveMeasureType(MeasureType.Length);\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay layer and any interaction added by this component.\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.setActiveMeasureType(undefined);\r\n    this.deactivateModifyControl();\r\n    this.freezeStore();\r\n    this.subscriptions$$.map(s => s.unsubscribe());\r\n  }\r\n\r\n  /**\r\n   * Set the measure type\r\n   * @internal\r\n   */\r\n  onMeasureTypeChange(measureType: MeasureType) {\r\n    this.activeMeasureType = measureType;\r\n  }\r\n\r\n  /**\r\n   * Activate or deactivate the current draw control\r\n   * @internal\r\n   */\r\n  onToggleDrawControl(toggle: boolean) {\r\n    if (toggle === true) {\r\n      this.toggleDrawControl();\r\n    } else {\r\n      this.deactivateDrawControl();\r\n    }\r\n  }\r\n\r\n\r\n  /**\r\n   * Activate or deactivate the current draw control\r\n   * @internal\r\n   */\r\n   onToggleMeasureUnitsAuto(toggle: boolean) {\r\n    this.measureUnitsAuto = toggle;\r\n  }\r\n\r\n  /**\r\n   * Activate or deactivate the current display of distances of the areas\r\n   * @internal\r\n   */\r\n  onToggleDisplayDistance(toggle: boolean) {\r\n    this.displayDistance = toggle;\r\n    this.onDisplayDistance();\r\n    toggle ? (this.storageService.set('distanceToggle', true, StorageScope.SESSION)) :\r\n     (this.storageService.set('distanceToggle', false, StorageScope.SESSION));\r\n  }\r\n\r\n  /**\r\n   * Activate or deactivate the current display of distances of the lines\r\n   * @internal\r\n   */\r\n  onToggleDisplayLines(toggle: boolean) {\r\n    this.displayLines = toggle;\r\n    this.onDisplayLines();\r\n    toggle ? (this.storageService.set('linesToggle', true, StorageScope.SESSION)) :\r\n     (this.storageService.set('linesToggle', false, StorageScope.SESSION));\r\n  }\r\n\r\n  /**\r\n   * Activate or deactivate the current display of areas\r\n   * @internal\r\n   */\r\n  onToggleDisplayAreas(toggle: boolean) {\r\n    this.displayAreas = toggle;\r\n    this.onDisplayAreas();\r\n    toggle ? (this.storageService.set('areasToggle', true, StorageScope.SESSION)) :\r\n     (this.storageService.set('areasToggle', false, StorageScope.SESSION));\r\n  }\r\n\r\n  /**\r\n   * Set display parametres in current values\r\n   * @internal\r\n   */\r\n  checkDistanceAreaToggle(){\r\n    if (this.storageService.get('distanceToggle') === false){\r\n      this.displayDistance = false;\r\n    }\r\n    if (this.storageService.get('linesToggle') === false){\r\n      this.displayLines = false;\r\n    }\r\n    if (this.storageService.get('areasToggle') === false){\r\n      this.displayAreas = false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Activate or deactivate the current display of distances of areas\r\n   * @internal\r\n   */\r\n  onDisplayDistance() {\r\n    if (this.displayDistance) {\r\n      Array.from(document.getElementsByClassName('igo-map-tooltip-measure-polygone-segments')).map((value: Element) =>\r\n        value.classList.remove('igo-map-tooltip-hidden'));\r\n    } else {\r\n      Array.from(document.getElementsByClassName('igo-map-tooltip-measure-polygone-segments')).map((value: Element) =>\r\n        value.classList.add('igo-map-tooltip-hidden'));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Activate or deactivate the current display of distances of lines\r\n   * @internal\r\n   */\r\n  onDisplayLines() {\r\n    if (this.displayLines) {\r\n      Array.from(document.getElementsByClassName('igo-map-tooltip-measure-line-segments')).map((value: Element) =>\r\n        value.classList.remove('igo-map-tooltip-hidden'));\r\n    } else {\r\n      Array.from(document.getElementsByClassName('igo-map-tooltip-measure-line-segments')).map((value: Element) =>\r\n        value.classList.add('igo-map-tooltip-hidden'));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Activate or deactivate the current display of areas\r\n   * @internal\r\n   */\r\n  onDisplayAreas() {\r\n    if (this.displayAreas) {\r\n      Array.from(document.getElementsByClassName('igo-map-tooltip-measure-area')).map((value: Element) =>\r\n        value.classList.remove('igo-map-tooltip-hidden'));\r\n    } else {\r\n      Array.from(document.getElementsByClassName('igo-map-tooltip-measure-area')).map((value: Element) =>\r\n        value.classList.add('igo-map-tooltip-hidden'));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set the measure type\r\n   * @internal\r\n   */\r\n  onLengthUnitChange(unit: MeasureLengthUnit) {\r\n    this.activeLengthUnit = unit;\r\n    this.table.refresh();\r\n    this.updateTooltipsOfOlSource(this.store.source.ol);\r\n    if (this.activeOlGeometry !== undefined) {\r\n      this.updateTooltipsOfOlGeometry(this.activeOlGeometry);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set the measure type\r\n   * @internal\r\n   */\r\n  onAreaUnitChange(unit: MeasureAreaUnit) {\r\n    this.activeAreaUnit = unit;\r\n    this.table.refresh();\r\n    this.updateTooltipsOfOlSource(this.store.source.ol);\r\n    if (this.activeOlGeometry !== undefined) {\r\n      this.updateTooltipsOfOlGeometry(this.activeOlGeometry);\r\n    }\r\n  }\r\n\r\n  onCalculateClick() {\r\n    const features = this.selectedFeatures$.value;\r\n    const area = features.reduce((sum: number, localFeature: FeatureWithMeasure) => {\r\n      return sum + localFeature.properties.measure.area || 0;\r\n    }, 0);\r\n    const length = features.reduce((sum: number, localFeature: FeatureWithMeasure) => {\r\n      if (localFeature.geometry.type === 'Polygon') {\r\n        return sum;\r\n      }\r\n      return sum + localFeature.properties.measure.length || 0;\r\n    }, 0);\r\n    const perimeter = features.reduce((sum: number, localFeature: FeatureWithMeasure) => {\r\n      if (localFeature.geometry.type === 'LineString') {\r\n        return sum;\r\n      }\r\n      return sum + localFeature.properties.measure.length || 0;\r\n    }, 0);\r\n\r\n    this.openDialog({\r\n      area,\r\n      length,\r\n      perimeter\r\n    });\r\n  }\r\n\r\n  onDeleteClick() {\r\n    this.store.deleteMany(this.selectedFeatures$.value);\r\n    this.selectedFeatures$.value.forEach(selectedFeature => {\r\n      this.olDrawSource.getFeatures().forEach(drawingLayerFeature => {\r\n        const geometry = drawingLayerFeature.getGeometry() as any;\r\n        if (selectedFeature.properties.id === geometry.ol_uid) {\r\n          this.olDrawSource.removeFeature(drawingLayerFeature);\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  onModifyClick() {\r\n    if (this.selectedFeatures$.value.length !== 1) { return; }\r\n\r\n    if (this.modifyControl.active === true) {\r\n      this.deactivateModifyControl();\r\n      this.toggleDrawControl();\r\n    } else {\r\n      const localFeature = this.selectedFeatures$.value[0];\r\n      const olFeatures = this.store.layer.ol.getSource().getFeatures();\r\n      const olFeature = olFeatures.find((_olFeature: OlFeature<OlGeometry>) => {\r\n        return _olFeature.get('id') === localFeature.properties.id;\r\n      });\r\n\r\n      if (olFeature !== undefined) {\r\n        this.deactivateDrawControl();\r\n        this.activateModifyControl();\r\n\r\n        const olGeometry = olFeature.getGeometry();\r\n        this.clearTooltipsOfOlGeometry(olGeometry as (OlLineString | OlPolygon));\r\n        this.modifyControl.setOlGeometry(olGeometry);\r\n      }\r\n    }\r\n  }\r\n\r\n  private openDialog(data: MeasurerDialogData): void {\r\n    this.dialog.open(MeasurerDialogComponent, {data});\r\n  }\r\n\r\n  /**\r\n   * Initialize the measure store and set up some listeners\r\n   * @internal\r\n   */\r\n  private initStore() {\r\n    const store = this.store;\r\n\r\n    const layer = new VectorLayer({\r\n      title: this.languageService.translate.instant('igo.geo.measure.layerTitle'),\r\n      isIgoInternalLayer: true,\r\n      id: `igo-measures-${uuid()}`,\r\n      zIndex: 200,\r\n      source: new FeatureDataSource(),\r\n      style: createMeasureLayerStyle(),\r\n      showInLayerList: true,\r\n      exportable: true,\r\n      browsable: false,\r\n      workspace: { enabled: false }\r\n    });\r\n    tryBindStoreLayer(store, layer);\r\n    store.layer.visible = true;\r\n    layer.visible$.subscribe(visible => {\r\n      if (visible) {\r\n        Array.from(document.getElementsByClassName('igo-map-tooltip-measure')).map((value: Element) =>\r\n        value.classList.remove('igo-map-tooltip-measure-by-display'));\r\n      }\r\n      else {\r\n        Array.from(document.getElementsByClassName('igo-map-tooltip-measure')).map((value: Element) =>\r\n        value.classList.add('igo-map-tooltip-measure-by-display'));\r\n      }\r\n    });\r\n\r\n    tryAddLoadingStrategy(store);\r\n\r\n    tryAddSelectionStrategy(store, new FeatureStoreSelectionStrategy({\r\n      map: this.map,\r\n      many: true\r\n    }));\r\n\r\n    this.onFeatureAddedKey = store.source.ol.on('addfeature', (event: OlVectorSourceEvent<OlGeometry>) => {\r\n      const localFeature = event.feature;\r\n      const olGeometry = localFeature.getGeometry() as any;\r\n      this.updateMeasureOfOlGeometry(olGeometry, localFeature.get('measure'));\r\n      this.onDisplayDistance();\r\n    });\r\n\r\n    this.onFeatureRemovedKey = store.source.ol.on('removefeature', (event: OlVectorSourceEvent<OlGeometry>) => {\r\n      const olGeometry = event.feature.getGeometry() as any;\r\n      this.clearTooltipsOfOlGeometry(olGeometry);\r\n    });\r\n\r\n    this.selectedFeatures$$ = store.stateView.manyBy$((record: EntityRecord<FeatureWithMeasure>) => {\r\n      return record.state.selected === true;\r\n    }).pipe(\r\n      skip(1) // Skip initial emission\r\n    )\r\n    .subscribe((records: EntityRecord<FeatureWithMeasure>[]) => {\r\n      if (this.modifyControl.active === true) {\r\n        this.deactivateModifyControl();\r\n      }\r\n      this.selectedFeatures$.next(records.map(record => record.entity));\r\n    });\r\n\r\n    this.subscriptions$$.push(this.store.entities$.subscribe(objectsExists => {\r\n      if (objectsExists.find(objectExist => objectExist.geometry.type === 'Polygon')){\r\n        this.hasArea$.next(true);\r\n      } else {\r\n        this.hasArea$.next(false);\r\n      }\r\n\r\n      if (objectsExists.find(objectExist => objectExist.geometry.type === 'LineString')){\r\n        this.hasLine$.next(true);\r\n      } else {\r\n        this.hasLine$.next(false);\r\n      }\r\n    }));\r\n\r\n    this.subscriptions$$.push(this.store.count$.subscribe(cnt => {\r\n      cnt >= 1 ?\r\n        this.store.layer.options.showInLayerList = true :\r\n        this.store.layer.options.showInLayerList = false;\r\n    }));\r\n  }\r\n\r\n  /**\r\n   * Freeze any store, meaning the layer is removed, strategies are deactivated\r\n   * and some listener removed\r\n   * @internal\r\n   */\r\n  private freezeStore() {\r\n    const store = this.store;\r\n    this.selectedFeatures$$.unsubscribe();\r\n    unByKey(this.onFeatureAddedKey);\r\n    unByKey(this.onFeatureRemovedKey);\r\n    store.deactivateStrategyOfType(FeatureStoreLoadingStrategy);\r\n    store.deactivateStrategyOfType(FeatureStoreSelectionStrategy);\r\n  }\r\n\r\n  /**\r\n   * Create a draw line control\r\n   */\r\n  private createDrawLineControl() {\r\n    this.drawLineControl = new DrawControl({\r\n      geometryType: 'LineString',\r\n      drawingLayerSource: this.olDrawSource,\r\n      interactionStyle: createMeasureInteractionStyle(),\r\n      drawingLayerStyle: new OlStyle({})\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create a draw polygon control\r\n   */\r\n  private createDrawPolygonControl() {\r\n    this.drawPolygonControl = new DrawControl({\r\n      geometryType: 'Polygon',\r\n      drawingLayerSource: this.olDrawSource,\r\n      interactionStyle: createMeasureInteractionStyle(),\r\n      drawingLayerStyle: new OlStyle({})\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create a draw polygon control\r\n   */\r\n  private createModifyControl() {\r\n    this.modifyControl = new ModifyControl({\r\n      source: this.olDrawSource,\r\n      drawStyle: createMeasureInteractionStyle(),\r\n      layerStyle: new OlStyle({})\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Activate the right control\r\n   */\r\n  private toggleDrawControl() {\r\n    this.deactivateDrawControl();\r\n    // this.deactivateModifyControl();\r\n    if (this.activeMeasureType === MeasureType.Length) {\r\n      this.activateDrawControl(this.drawLineControl);\r\n    } else if (this.activeMeasureType === MeasureType.Area) {\r\n      this.activateDrawControl(this.drawPolygonControl);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Activate a given control\r\n   * @param drawControl Draw control\r\n   */\r\n  private activateDrawControl(drawControl: DrawControl) {\r\n    this.drawControlIsDisabled = false;\r\n    this.activeDrawControl = drawControl;\r\n    this.drawStart$$ = drawControl.start$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => this.onDrawStart(olGeometry));\r\n    this.drawEnd$$ = drawControl.end$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => this.onDrawEnd(olGeometry));\r\n    this.drawChanges$$ = drawControl.changes$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => this.onDrawChanges(olGeometry));\r\n    this.drawChanges$$ = drawControl.abort$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => {\r\n        this.clearTooltipsOfOlGeometry(olGeometry);\r\n        this.clearMeasures();\r\n      });\r\n    drawControl.setOlMap(this.map.ol, false);\r\n  }\r\n\r\n  /**\r\n   * Deactivate the active draw control\r\n   */\r\n  private deactivateDrawControl() {\r\n    if (this.activeDrawControl === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.olDrawSource.clear();\r\n    if (this.drawStart$$ !== undefined ) { this.drawStart$$.unsubscribe(); }\r\n    if (this.drawEnd$$ !== undefined ) { this.drawEnd$$.unsubscribe(); }\r\n    if (this.drawChanges$$ !== undefined ) { this.drawChanges$$.unsubscribe(); }\r\n\r\n    this.clearTooltipsOfOlSource(this.olDrawSource);\r\n    if (this.activeOlGeometry !== undefined) {\r\n      this.clearTooltipsOfOlGeometry(this.activeOlGeometry);\r\n    }\r\n    this.activeDrawControl.setOlMap(undefined);\r\n    this.activeDrawControl = undefined;\r\n    this.activeOlGeometry = undefined;\r\n  }\r\n\r\n  private setActiveMeasureType(measureType: MeasureType) {\r\n    this._activeMeasureType = measureType;\r\n    this.clearMeasures();\r\n    this.toggleDrawControl();\r\n  }\r\n\r\n  /**\r\n   * Clear the draw source and track the geometry being drawn\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onDrawStart(olGeometry: OlLineString | OlPolygon) {\r\n    this.activeOlGeometry = olGeometry;\r\n  }\r\n\r\n  /**\r\n   * Clear the draw source and track the geometry being draw\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onDrawEnd(olGeometry: OlLineString | OlPolygon) {\r\n    this.activeOlGeometry = undefined;\r\n    this.finalizeMeasureOfOlGeometry(olGeometry);\r\n    this.addFeatureToStore(olGeometry);\r\n    this.clearTooltipsOfOlGeometry(olGeometry);\r\n    this.olDrawSource.clear(true);\r\n  }\r\n\r\n  /**\r\n   * Update measures observables and map tooltips\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onDrawChanges(olGeometry: OlLineString | OlPolygon) {\r\n    const measure = measureOlGeometry(olGeometry, this.projection);\r\n    this.updateMeasureOfOlGeometry(olGeometry, Object.assign({}, measure, {\r\n      area: undefined // We don't want to display an area tooltip while drawing.\r\n    }));\r\n    this.measure$.next(measure);\r\n  }\r\n\r\n  /**\r\n   * Activate a given control\r\n   * @param modifyControl Modify control\r\n   */\r\n  private activateModifyControl() {\r\n    const selection = this.store.getStrategyOfType(FeatureStoreSelectionStrategy) as FeatureStoreSelectionStrategy;\r\n    selection.deactivate();\r\n    selection.clear();\r\n\r\n    this.modifyStart$$ = this.modifyControl.start$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => this.onModifyStart(olGeometry));\r\n    this.modifyEnd$$ = this.modifyControl.end$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => this.onModifyEnd(olGeometry));\r\n    this.modifyChanges$$ = this.modifyControl.changes$\r\n      .subscribe((olGeometry: OlLineString | OlPolygon) => this.onModifyChanges(olGeometry));\r\n    this.modifyControl.setOlMap(this.map.ol);\r\n  }\r\n\r\n  /**\r\n   * Deactivate the active modify control\r\n   */\r\n  private deactivateModifyControl() {\r\n    if (this.modifyStart$$ !== undefined ) { this.modifyStart$$.unsubscribe(); }\r\n    if (this.modifyEnd$$ !== undefined ) { this.modifyEnd$$.unsubscribe(); }\r\n    if (this.modifyChanges$$ !== undefined ) { this.modifyChanges$$.unsubscribe(); }\r\n\r\n    if (this.activeOlGeometry !== undefined) {\r\n      if (this.selectedFeatures$.value.length === 1) {\r\n        const localFeature = this.selectedFeatures$.value[0];\r\n        this.addFeatureToStore(this.activeOlGeometry, localFeature);\r\n      }\r\n      this.finalizeMeasureOfOlGeometry(this.activeOlGeometry);\r\n    }\r\n\r\n    this.olDrawSource.clear();\r\n\r\n    this.store.activateStrategyOfType(FeatureStoreSelectionStrategy);\r\n\r\n    this.activeOlGeometry = undefined;\r\n    this.modifyControl.setOlMap(undefined);\r\n  }\r\n\r\n  /**\r\n   * Clear the draw source and track the geometry being drawn\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onModifyStart(olGeometry: OlLineString | OlPolygon) {\r\n    this.onDrawStart(olGeometry);\r\n  }\r\n\r\n  /**\r\n   * Update measures observables and map tooltips\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onModifyChanges(olGeometry: OlLineString | OlPolygon) {\r\n    this.onDrawChanges(olGeometry);\r\n  }\r\n\r\n  /**\r\n   * Clear the draw source and track the geometry being draw\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onModifyEnd(olGeometry: OlLineString | OlPolygon) {\r\n    this.finalizeMeasureOfOlGeometry(olGeometry);\r\n  }\r\n\r\n  private finalizeMeasureOfOlGeometry(olGeometry: OlLineString | OlPolygon) {\r\n    const measure = measureOlGeometry(olGeometry, this.projection);\r\n    this.updateMeasureOfOlGeometry(olGeometry, measure);\r\n  }\r\n\r\n  /**\r\n   * Update measures observables\r\n   * @param olGeometry Ol linestring or polygon\r\n   * @param measure Measure\r\n   */\r\n  private updateMeasureOfOlGeometry(olGeometry: OlLineString | OlPolygon, measure: Measure) {\r\n    olGeometry.setProperties({_measure: measure}, true);\r\n    this.updateTooltipsOfOlGeometry(olGeometry);\r\n  }\r\n\r\n  /**\r\n   * Clear the measures observables\r\n   */\r\n  private clearMeasures() {\r\n    this.measure$.next({});\r\n  }\r\n\r\n  /**\r\n   * Add a feature with measures to the store. The loading stragegy of the store\r\n   * will trigger and add the feature to the map.\r\n   * @internal\r\n   */\r\n  private addFeatureToStore(olGeometry, localFeature?: FeatureWithMeasure) {\r\n    const featureId = localFeature ? localFeature.properties.id : olGeometry.ol_uid;\r\n    const projection = this.map.ol.getView().getProjection();\r\n    const geometry = new OlGeoJSON().writeGeometryObject(olGeometry, {\r\n      featureProjection: projection,\r\n      dataProjection: projection\r\n    }) as any;\r\n    this.store.update({\r\n      type: FEATURE,\r\n      geometry,\r\n      projection: projection.getCode(),\r\n      properties: {\r\n        id: featureId,\r\n        measure: olGeometry.get('_measure')\r\n      },\r\n      meta: {\r\n        id: featureId\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Update all the tooltips of an OL geometry\r\n   * @param olGeometry OL Geometry\r\n   * @param lengths Lengths of the OL geometry's segments\r\n   * @param measureUnit Display tooltip measure in those units\r\n   */\r\n  private updateTooltipsOfOlGeometry(olGeometry: OlLineString | OlPolygon) {\r\n    const measure = olGeometry.get('_measure');\r\n    const lengths = measure.lengths;\r\n    const area = measure.area;\r\n\r\n    const olMidpointsTooltips = updateOlTooltipsAtMidpoints(olGeometry);\r\n    if (lengths.length === olMidpointsTooltips.length) {\r\n      for (let i = 0; i < olMidpointsTooltips.length; i++) {\r\n        const length = lengths[i];\r\n        if (length !== undefined) {\r\n          this.updateOlTooltip(\r\n            olMidpointsTooltips[i],\r\n            metersToUnit(length, this.activeLengthUnit),\r\n            this.activeLengthUnit,\r\n            MeasureType.Length\r\n          );\r\n        }\r\n      }\r\n    }\r\n\r\n    if (area !== undefined) {\r\n      this.updateOlTooltip(\r\n        updateOlTooltipAtCenter(olGeometry),\r\n        squareMetersToUnit(area, this.activeAreaUnit),\r\n        this.activeAreaUnit,\r\n        MeasureType.Area\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Show the map tooltips of a geoemtry\r\n   */\r\n  private showTooltipsOfOlGeometry(olGeometry: OlLineString | OlPolygon) {\r\n    getTooltipsOfOlGeometry(olGeometry).forEach((olTooltip: OlOverlay | undefined) => {\r\n      if (this.shouldShowTooltip(olTooltip)) {\r\n        this.map.ol.addOverlay(olTooltip);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Clear the tooltips of an OL geometrys\r\n   * @param olGeometry OL geometry with tooltips\r\n   */\r\n  private clearTooltipsOfOlGeometry(olGeometry: OlLineString | OlPolygon) {\r\n    getTooltipsOfOlGeometry(olGeometry).forEach((olTooltip: OlOverlay | undefined) => {\r\n      if (olTooltip !== undefined && olTooltip.getMap() !== undefined) {\r\n        this.map.ol.removeOverlay(olTooltip);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Show the map tooltips of all the geometries of a source\r\n   */\r\n  private updateTooltipsOfOlSource(olSource: OlVectorSource<OlGeometry>) {\r\n    olSource.forEachFeature((olFeature: OlFeature<OlGeometry>) => {\r\n      this.updateTooltipsOfOlGeometry(olFeature.getGeometry() as any);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Show the map tooltips of all the geometries of a source\r\n   */\r\n  private showTooltipsOfOlSource(olSource: OlVectorSource<OlGeometry>) {\r\n    olSource.forEachFeature((olFeature: OlFeature<OlGeometry>) => {\r\n      this.showTooltipsOfOlGeometry(olFeature.getGeometry() as any);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Clear the map tooltips\r\n   * @param olDrawSource OL vector source\r\n   */\r\n  private clearTooltipsOfOlSource(olSource: OlVectorSource<OlGeometry>) {\r\n    olSource.forEachFeature((olFeature: OlFeature<OlGeometry>) => {\r\n      const olGeometry = olFeature.getGeometry();\r\n      if (olGeometry !== undefined) {\r\n        this.clearTooltipsOfOlGeometry(olFeature.getGeometry() as any);\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Update an OL tooltip properties and inner HTML and add it to the map if possible\r\n   * @param olTooltip OL tooltip\r\n   * @param measure The measure valeu ti display\r\n   * @param measureUnit Display tooltip measure in those units\r\n   */\r\n  private updateOlTooltip(\r\n    olTooltip: OlOverlay,\r\n    measure: number,\r\n    unit: MeasureAreaUnit | MeasureLengthUnit,\r\n    type: MeasureType\r\n  ) {\r\n    olTooltip.setProperties({_measure: measure, _unit: unit, _type: type}, true);\r\n    olTooltip.getElement().innerHTML = this.computeTooltipInnerHTML(olTooltip);\r\n    if (this.shouldShowTooltip(olTooltip)) {\r\n      this.map.ol.addOverlay(olTooltip);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Compute a tooltip's content\r\n   * @param olTooltip OL overlay\r\n   * @returns Inner HTML\r\n   */\r\n  private computeTooltipInnerHTML(olTooltip: OlOverlay): string {\r\n    const properties = olTooltip.getProperties() as any;\r\n    return formatMeasure(properties._measure, {\r\n      decimal: 1,\r\n      unit: properties._unit,\r\n      unitAbbr: true,\r\n      locale: 'fr'\r\n    }, this.languageService);\r\n  }\r\n\r\n  /**\r\n   * Whether a tooltip should be showned based on the length\r\n   * of the segment it is bound to.\r\n   * @param olTooltip OL overlay\r\n   * @returns True if the tooltip should be shown\r\n   */\r\n  private shouldShowTooltip(olTooltip: OlOverlay): boolean {\r\n    if (this.showTooltips === false) {\r\n      return false;\r\n    }\r\n\r\n    const properties = olTooltip.getProperties() as any;\r\n    const measure = properties._measure;\r\n    if (measure === undefined) {\r\n      return false;\r\n    }\r\n\r\n    if (properties._unit === MeasureType.Length) {\r\n      const minSegmentLength = metersToUnit(this.minSegmentLength, properties._unit) || 0;\r\n      return measure > Math.max(minSegmentLength, 0);\r\n    }\r\n\r\n    return true;\r\n  }\r\n}\r\n","import { Pipe, PipeTransform } from '@angular/core';\r\n\r\nimport { MeasureAreaUnit, MeasureLengthUnit } from '../shared/measure.enum';\r\nimport { metersToUnit, squareMetersToUnit, formatMeasure } from '../shared/measure.utils';\r\n\r\n/**\r\n * This pipe returns a measure converted from meters (or square meters)\r\n * to the specified unit. It also keeps a certain number of decimals.\r\n */\r\n@Pipe({\r\n  name: 'measureFormat'\r\n})\r\nexport class MeasureFormatPipe implements PipeTransform {\r\n\r\n  /**\r\n   * @ignore\r\n   */\r\n  transform(\r\n    value: number, unit: MeasureAreaUnit | MeasureLengthUnit,\r\n    unitAbbr: boolean = false,\r\n    decimal: number = 1\r\n  ): number {\r\n    let out;\r\n    if (Object.values(MeasureAreaUnit).indexOf(unit as MeasureAreaUnit) >= 0) {\r\n      out = squareMetersToUnit(value, unit as MeasureAreaUnit);\r\n    } else if (Object.values(MeasureLengthUnit).indexOf(unit as MeasureLengthUnit) >= 0) {\r\n      out = metersToUnit(value, unit as MeasureLengthUnit);\r\n    }\r\n\r\n    return out ? formatMeasure(out, {\r\n      decimal: 1,\r\n      unit,\r\n      unitAbbr,\r\n      locale: 'fr'\r\n    }) : out;\r\n  }\r\n}\r\n","import { DrawControlOptions } from './../shared/controls/draw';\r\nimport {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  OnDestroy,\r\n  Optional,\r\n  Self,\r\n  ChangeDetectorRef,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\nimport { NgControl, ControlValueAccessor } from '@angular/forms';\r\n\r\nimport { Subscription } from 'rxjs';\r\n\r\nimport * as OlStyle from 'ol/style';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport OlGeometry from 'ol/geom/Geometry';\r\nimport type { default as OlGeometryType } from 'ol/geom/GeometryType';\r\nimport OlFeature from 'ol/Feature';\r\nimport OlVectorSource from 'ol/source/Vector';\r\nimport OlVectorLayer from 'ol/layer/Vector';\r\nimport OlOverlay from 'ol/Overlay';\r\nimport * as olproj from 'ol/proj';\r\nimport Point from 'ol/geom/Point';\r\n\r\nimport { IgoMap } from '../../map';\r\nimport {\r\n  MeasureLengthUnit,\r\n  updateOlGeometryMidpoints,\r\n  formatMeasure,\r\n  measureOlGeometry\r\n} from '../../measure';\r\nimport { DrawControl, ModifyControl, ModifyControlOptions } from '../shared/controls';\r\nimport { createDrawInteractionStyle } from '../shared/geometry.utils';\r\nimport { GeoJSONGeometry } from '../shared/geometry.interfaces';\r\nimport OlCircle from 'ol/geom/Circle';\r\nimport OlLineString from 'ol/geom/LineString';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport OlPolygon from 'ol/geom/Polygon';\r\n\r\n/**\r\n * This input allows a user to draw a new geometry or to edit\r\n * an existing one on a map. A text input is also displayed in the\r\n * form with some instructions.\r\n * This is still WIP.\r\n */\r\n@Component({\r\n  selector: 'igo-geometry-form-field-input',\r\n  templateUrl: './geometry-form-field-input.component.html',\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class GeometryFormFieldInputComponent implements OnInit, OnDestroy, ControlValueAccessor {\r\n\r\n  private olOverlayLayer: OlVectorLayer<OlVectorSource<OlGeometry>>;\r\n  private olGeoJSON = new OlGeoJSON();\r\n  private ready = false;\r\n\r\n  private drawControl: DrawControl;\r\n  private modifyControl: ModifyControl;\r\n  private defaultDrawStyleRadius: number;\r\n  private olGeometryEnds$$: Subscription;\r\n  private olGeometryChanges$$: Subscription;\r\n  private olTooltip = this.createMeasureTooltip();\r\n\r\n  /**\r\n   * Active control\r\n   * @internal\r\n   */\r\n  public activeControl: DrawControl | ModifyControl;\r\n\r\n  /**\r\n   * The map to draw the geometry on\r\n   */\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * The geometry type\r\n   */\r\n  @Input()\r\n  set geometryType(value: typeof OlGeometryType) {\r\n    this._geometryType = value;\r\n    if (this.ready === false) {\r\n      return;\r\n    }\r\n\r\n    this.deactivateControl();\r\n    this.createDrawControl();\r\n    this.drawControl.freehand$.next(this.freehandDrawIsActive);\r\n    this.toggleControl();\r\n  }\r\n  get geometryType(): typeof OlGeometryType { return this._geometryType; }\r\n  private _geometryType: typeof OlGeometryType;\r\n\r\n  /**\r\n   * The drawGuide around the mouse pointer to help drawing\r\n   */\r\n  @Input() drawGuide: number = null;\r\n\r\n  /**\r\n   * Whether a measure tooltip should be displayed\r\n   */\r\n  @Input() measure: boolean = false;\r\n\r\n  /**\r\n   * Whether draw control should be active or not\r\n   */\r\n  @Input()\r\n  get drawControlIsActive(): boolean { return this._drawControlIsActive; }\r\n  set drawControlIsActive(value: boolean) {\r\n    this._drawControlIsActive = value;\r\n    if (this.ready === false) {\r\n      return;\r\n    }\r\n    this.deactivateControl();\r\n    if (!this._drawControlIsActive) {\r\n      return;\r\n    } else {\r\n      this.toggleControl();\r\n    }\r\n  }\r\n  private _drawControlIsActive: boolean = true;\r\n\r\n  /**\r\n   * Whether freehand draw control should be active or not\r\n   */\r\n  @Input()\r\n  get freehandDrawIsActive(): boolean { return this._freehandDrawIsActive; }\r\n  set freehandDrawIsActive(value: boolean) {\r\n    this._freehandDrawIsActive = value;\r\n    this.deactivateControl();\r\n\r\n    this.createDrawControl();\r\n    this.createModifyControl();\r\n\r\n    this.drawControl.freehand$.next(this.freehandDrawIsActive);\r\n\r\n    if (this.ready === false) {\r\n      return;\r\n    }\r\n\r\n    if (!this.drawControlIsActive) {\r\n      return;\r\n    }\r\n    this.toggleControl();\r\n  }\r\n  private _freehandDrawIsActive: boolean;\r\n\r\n  /**\r\n   * Control options\r\n   */\r\n  @Input() controlOptions: {[key: string]: any} = {};\r\n\r\n  /**\r\n   * Style for the draw control (applies while the geometry is being drawn)\r\n   */\r\n  @Input()\r\n  set drawStyle(value: OlStyle.Style | ((feature, resolution) => OlStyle.Style) | OlStyle.Circle) {\r\n    if (value === undefined) {\r\n      value = createDrawInteractionStyle();\r\n    }\r\n    this._drawStyle = value;\r\n\r\n    const olGuideStyle = this.getGuideStyleFromDrawStyle(value) as OlStyle.Circle;\r\n    if (olGuideStyle !== undefined) {\r\n      this.defaultDrawStyleRadius = olGuideStyle.getRadius();\r\n    } else {\r\n      this.defaultDrawStyleRadius = null;\r\n    }\r\n\r\n    if (this.ready === false) {\r\n      return;\r\n    }\r\n\r\n    this.deactivateControl();\r\n    this.createDrawControl();\r\n    this.createModifyControl();\r\n\r\n    this.drawControl.freehand$.next(this.freehandDrawIsActive);\r\n    this.toggleControl();\r\n  }\r\n  get drawStyle(): OlStyle.Style | ((feature, resolution) => OlStyle.Style) | OlStyle.Circle { return this._drawStyle; }\r\n  private _drawStyle: OlStyle.Style | ((feature, resolution) => OlStyle.Style) | OlStyle.Circle;\r\n\r\n  /**\r\n   * Style for the overlay layer (applies once the geometry is added to the map)\r\n   * If not specified, drawStyle applies\r\n   */\r\n  @Input()\r\n  set overlayStyle(value: OlStyle.Style | ((feature, resolution) => OlStyle.Style) | OlStyle.Circle) { this._overlayStyle = value; }\r\n  get overlayStyle(): OlStyle.Style | ((feature, resolution) => OlStyle.Style) | OlStyle.Circle { return this._overlayStyle; }\r\n  private _overlayStyle: OlStyle.Style | ((feature, resolution) => OlStyle.Style) | OlStyle.Circle;\r\n\r\n  /**\r\n   * The geometry value (GeoJSON)\r\n   * Implemented as part of ControlValueAccessor.\r\n   */\r\n  @Input()\r\n  set value(value: GeoJSONGeometry) {\r\n    this._value = value;\r\n    if (this.ready === false) {\r\n      return;\r\n    }\r\n\r\n    if (value) {\r\n      this.addGeoJSONToOverlay(value);\r\n    } else {\r\n      this.olOverlaySource.clear(true);\r\n    }\r\n    this.onChange(value);\r\n    this.toggleControl();\r\n    this.cdRef.detectChanges();\r\n  }\r\n  get value(): GeoJSONGeometry { return this._value; }\r\n  private _value: GeoJSONGeometry;\r\n\r\n  /**\r\n   * The vector source to add the geometry to\r\n   * @internal\r\n   */\r\n  get olOverlaySource(): OlVectorSource<OlGeometry> {\r\n    return this.olOverlayLayer.getSource();\r\n  }\r\n\r\n  @Input()\r\n  set radius(value: any) {\r\n    if (this.ready === false) {\r\n      return;\r\n    }\r\n    if (this.modifyControl.getSource()) {\r\n      this.modifyControl.getSource().refresh();\r\n    }\r\n    if (this.freehandDrawIsActive) {\r\n      let olModify;\r\n      setTimeout(() => {\r\n        olModify = this.modifyControl.olModifyInteraction;\r\n        if (olModify) {\r\n          if (olModify.features_) {\r\n            olModify.features_.clear();\r\n            this.addGeoJSONToOverlay(this.value);\r\n          }\r\n        }\r\n      }, 0);\r\n    }\r\n  }\r\n\r\n  constructor(\r\n    private cdRef: ChangeDetectorRef,\r\n    @Optional() @Self() public ngControl: NgControl\r\n  ) {\r\n    if (this.ngControl !== undefined) {\r\n      // Setting the value accessor directly (instead of using\r\n      // the providers) to avoid running into a circular import.\r\n      this.ngControl.valueAccessor = this;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create an overlay layer, add the initial geometry to it (if any)\r\n   * and toggle the right interaction.\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    if (this.drawStyle === undefined) {\r\n      this.drawStyle = createDrawInteractionStyle();\r\n    }\r\n\r\n    if (this.overlayStyle === undefined) {\r\n      this.overlayStyle = this.drawStyle;\r\n    }\r\n\r\n    this.addOlOverlayLayer();\r\n    this.createDrawControl();\r\n    this.createModifyControl();\r\n\r\n    if (this.value) {\r\n      this.addGeoJSONToOverlay(this.value);\r\n    }\r\n    this.toggleControl();\r\n\r\n    this.ready = true;\r\n  }\r\n\r\n  /**\r\n   * Clear the overlay layer and any interaction added by this component.\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    // This is mandatory when the form control is reused after\r\n    // this component has been destroyed. It seems like the control\r\n    // keeps a reference to this component even after it's destroyed\r\n    // and it attempts to set it's value\r\n    this.ready = false;\r\n\r\n    this.deactivateControl();\r\n    this.olOverlaySource.clear();\r\n    this.map.ol.removeLayer(this.olOverlayLayer);\r\n  }\r\n\r\n  /**\r\n   * Implemented as part of ControlValueAccessor.\r\n   */\r\n  // eslint-disable-next-line @typescript-eslint/ban-types\r\n  registerOnChange(fn: Function) {\r\n    this.onChange = fn;\r\n  }\r\n  private onChange: any = () => {};\r\n\r\n  /**\r\n   * Implemented as part of ControlValueAccessor.\r\n   */\r\n  // eslint-disable-next-line @typescript-eslint/ban-types\r\n  registerOnTouched(fn: Function) {\r\n    this.onTouched = fn;\r\n  }\r\n  private onTouched: any = () => {};\r\n\r\n  /**\r\n   * Implemented as part of ControlValueAccessor.\r\n   */\r\n  writeValue(value: GeoJSONGeometry) {\r\n    this.value = value;\r\n  }\r\n\r\n  /**\r\n   * Add an overlay layer to the map\r\n   */\r\n  private addOlOverlayLayer() {\r\n    this.olOverlayLayer = new OlVectorLayer({\r\n      source: new OlVectorSource(),\r\n      zIndex: 500,\r\n      style: null\r\n    });\r\n    this.map.ol.addLayer(this.olOverlayLayer);\r\n  }\r\n\r\n  /**\r\n   * Create a draw control and subscribe to it's geometry\r\n   */\r\n  private createDrawControl() {\r\n    const controlOptions = Object.assign({}, this.controlOptions, {\r\n      geometryType: this.geometryType || 'Point',\r\n      drawingLayer: this.olOverlayLayer,\r\n      interactionStyle: typeof this.drawStyle === 'function' ? this.drawStyle : (olFeature: OlFeature<OlGeometry>, resolution: number) => {\r\n        const style = this.drawStyle;\r\n        this.updateDrawStyleWithDrawGuide(style, resolution);\r\n        return style;\r\n      }\r\n    }) as DrawControlOptions;\r\n    this.drawControl = new DrawControl(controlOptions);\r\n  }\r\n\r\n  /**\r\n   * Create a modify control and subscribe to it's geometry\r\n   */\r\n  private createModifyControl() {\r\n    const controlOptions = Object.assign({}, this.controlOptions, {\r\n      layer: this.olOverlayLayer,\r\n      drawStyle: typeof this.drawStyle === 'function' ? this.drawStyle : (olFeature: OlFeature<OlGeometry>, resolution: number) => {\r\n        const style = this.drawStyle;\r\n        this.updateDrawStyleWithDrawGuide(style, resolution);\r\n        return style;\r\n      }\r\n    }) as ModifyControlOptions;\r\n    this.modifyControl = new ModifyControl(controlOptions);\r\n  }\r\n\r\n  /**\r\n   * Toggle the proper control (draw or modify)\r\n   */\r\n  private toggleControl() {\r\n    let activate;\r\n    if (!this.value && this.geometryType) {\r\n      activate = this.drawControl;\r\n    } else {\r\n      activate = this.modifyControl;\r\n    }\r\n\r\n    // If the control that should be activated\r\n    // is not the same as the current active control,\r\n    // deactivate the current control and activate the new one\r\n    // Otherwise, do nothing and keep the current control active\r\n    if (activate !== this.activeControl) {\r\n      this.deactivateControl();\r\n      this.activateControl(activate);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Activate a given control\r\n   * @param control Control\r\n   */\r\n  private activateControl(control: DrawControl | ModifyControl) {\r\n    this.activeControl = control;\r\n    this.olGeometryEnds$$ = control.end$\r\n      .subscribe((olGeometry: OlGeometry) => this.onOlGeometryEnds(olGeometry));\r\n    if (this.measure === true && control === this.drawControl) {\r\n      this.olGeometryChanges$$ = control.changes$\r\n        .subscribe((olGeometry: OlPolygon | OlPoint | OlLineString | OlCircle) => this.onOlGeometryChanges(olGeometry));\r\n    }\r\n    control.setOlMap(this.map.ol, false);\r\n  }\r\n\r\n  /**\r\n   * Deactivate the active control\r\n   */\r\n  private deactivateControl() {\r\n    this.removeMeasureTooltip();\r\n    if (this.activeControl !== undefined) {\r\n      this.activeControl.setOlMap(undefined);\r\n    }\r\n    if (this.olGeometryEnds$$ !== undefined) {\r\n      this.olGeometryEnds$$.unsubscribe();\r\n    }\r\n    if (this.olGeometryChanges$$ !== undefined) {\r\n      this.olGeometryChanges$$.unsubscribe();\r\n    }\r\n    this.activeControl = undefined;\r\n  }\r\n\r\n  /**\r\n   * Update measures observables and map tooltips\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onOlGeometryEnds(olGeometry: OlGeometry | undefined) {\r\n    this.removeMeasureTooltip();\r\n    this.setOlGeometry(olGeometry);\r\n  }\r\n\r\n  /**\r\n   * Update measures observables and map tooltips\r\n   * @param olGeometry Ol linestring or polygon\r\n   */\r\n  private onOlGeometryChanges(olGeometry: OlPolygon | OlPoint | OlLineString | OlCircle) {\r\n    if (olGeometry.getType() !== 'Point') {\r\n      this.updateMeasureTooltip(olGeometry);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * When drawing ends, convert the output value to GeoJSON and keep it.\r\n   * Restore the double click interaction.\r\n   * @param olGeometry OL geometry\r\n   */\r\n  private setOlGeometry(olGeometry: OlGeometry | undefined) {\r\n    let value;\r\n    if (olGeometry === undefined) {\r\n      return;\r\n    }\r\n\r\n    if (olGeometry.getType() === 'Circle') { // Because Circle doesn't exist as a GeoJSON object\r\n      olGeometry = this.circleToPoint(olGeometry);\r\n    }\r\n\r\n    value = this.olGeoJSON.writeGeometryObject(olGeometry, {\r\n      featureProjection: this.map.projection,\r\n      dataProjection: 'EPSG:4326'\r\n    });\r\n    if (olGeometry.get('radius')) {\r\n      value.radius = olGeometry.get('radius');\r\n      olGeometry.set('radius', value.radius);\r\n    }\r\n    this.writeValue(value);\r\n  }\r\n\r\n  private circleToPoint(olGeometry) {\r\n    const center = olGeometry.getCenter();\r\n    const coordinates = olproj.transform(center, this.map.projection, 'EPSG:4326');\r\n    const radius = Math.round(olGeometry.getRadius() * (Math.cos((Math.PI / 180) * coordinates[1])));\r\n\r\n    // Convert it to a point object\r\n    olGeometry = new Point(center);\r\n    olGeometry.set('radius', radius, true);\r\n    return olGeometry;\r\n  }\r\n\r\n  /**\r\n   * Add a GeoJSON geometry to the overlay\r\n   * @param geometry GeoJSON geometry\r\n   */\r\n  private addGeoJSONToOverlay(geometry: GeoJSONGeometry) {\r\n    const olGeometry = this.olGeoJSON.readGeometry(geometry, {\r\n      dataProjection: 'EPSG:4326',\r\n      featureProjection: this.map.projection\r\n    });\r\n    const olFeature = new OlFeature({\r\n      geometry: olGeometry\r\n    });\r\n    olFeature.setStyle(this.overlayStyle as OlStyle.Style);\r\n    this.olOverlaySource.clear();\r\n    this.olOverlaySource.addFeature(olFeature);\r\n  }\r\n\r\n  /**\r\n   * Create the measure tooltip\r\n   */\r\n  private createMeasureTooltip() {\r\n    return new OlOverlay({\r\n      element: document.createElement('div'),\r\n      offset: [-30, -10],\r\n      className: [\r\n        'igo-map-tooltip',\r\n        'igo-map-tooltip-measure'\r\n      ].join(' '),\r\n      stopEvent: false\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Update the measure tooltip of an OL geometry\r\n   * @param olGeometry OL Geometry\r\n   */\r\n  private updateMeasureTooltip(olGeometry: OlPolygon | OlPoint | OlLineString | OlCircle) {\r\n    const measure = measureOlGeometry(olGeometry, this.map.projection);\r\n    const lengths = measure.lengths;\r\n    const lastIndex = olGeometry.getType() === 'Polygon' ? lengths.length - 2 : lengths.length - 1;\r\n    const lastLength = lengths[lastIndex];\r\n\r\n    const olMidpoints = updateOlGeometryMidpoints(olGeometry);\r\n    const olLastMidpoint = olMidpoints[lastIndex];\r\n    if (olMidpoints.length === 0 || olLastMidpoint === undefined) {\r\n      this.removeMeasureTooltip();\r\n      return;\r\n    }\r\n\r\n    this.olTooltip.setPosition(olLastMidpoint.getFlatCoordinates());\r\n\r\n    const innerHtml = formatMeasure(lastLength, {\r\n      decimal: 1,\r\n      unit: MeasureLengthUnit.Meters,\r\n      unitAbbr: true,\r\n      locale: 'fr'\r\n    });\r\n    this.olTooltip.getElement().innerHTML = innerHtml;\r\n    if (this.olTooltip.getMap() === undefined) {\r\n      this.map.ol.addOverlay(this.olTooltip);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Remove the measure tooltip from the map\r\n   */\r\n  private removeMeasureTooltip() {\r\n    if (this.olTooltip.getMap && this.olTooltip.getMap() !== undefined) {\r\n      this.map.ol.removeOverlay(this.olTooltip);\r\n      this.olTooltip.setMap(undefined);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Adjust the draw style with the specified draw guide distance, if possible\r\n   * @param olStyle Draw style to update\r\n   * @param resolution Resolution (to make the screen size of symbol fit the drawGuide value)\r\n   */\r\n  private updateDrawStyleWithDrawGuide(\r\n    olStyle: OlStyle.Style |\r\n    ((feature, resolution) => OlStyle.Style) |\r\n    OlStyle.Circle,\r\n    resolution: number) {\r\n    const olGuideStyle = this.getGuideStyleFromDrawStyle(olStyle) as OlStyle.Circle;\r\n    if (olGuideStyle === undefined) {\r\n      return;\r\n    }\r\n\r\n    const drawGuide = this.drawGuide;\r\n    let radius;\r\n    if (!drawGuide || drawGuide < 0) {\r\n      radius = this.defaultDrawStyleRadius;\r\n    } else {\r\n      radius = drawGuide > 0 ? drawGuide / resolution : drawGuide;\r\n    }\r\n    olGuideStyle.setRadius(radius);\r\n  }\r\n\r\n  /**\r\n   * Returns wether a given Open Layers style has a radius property that can be set (used to set draw guide)\r\n   * @param olStyle The style on which to perform the check\r\n   */\r\n  private isStyleWithRadius(olStyle) {\r\n    return typeof olStyle !== 'function' && olStyle.setRadius;\r\n  }\r\n\r\n  /**\r\n   * Returns wether a given Open Layers style has a radius property that can be set (used to set draw guide)\r\n   * @param olStyle The style on which to perform the check\r\n   */\r\n  private getGuideStyleFromDrawStyle(\r\n    olStyle: OlStyle.Style | ((feature, resolution) => OlStyle.Style) | OlStyle.Circle |\r\n    OlStyle.Style[] | ((feature, resolution) => OlStyle.Style)[] | OlStyle.Circle[]\r\n  ) {\r\n    if (Array.isArray(olStyle)) {\r\n      olStyle = olStyle[0];\r\n    }\r\n    if (this.isStyleWithRadius(olStyle)) {\r\n      return olStyle;\r\n    }\r\n    return undefined;\r\n  }\r\n}\r\n","<ng-template></ng-template>","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatButtonToggleModule } from '@angular/material/button-toggle';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { GeometryFormFieldComponent } from './geometry-form-field.component';\r\nimport { GeometryFormFieldInputComponent } from './geometry-form-field-input.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    MatIconModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatButtonModule,\r\n    MatButtonToggleModule,\r\n    IgoLanguageModule\r\n  ],\r\n  exports: [\r\n    GeometryFormFieldComponent,\r\n    GeometryFormFieldInputComponent\r\n  ],\r\n  declarations: [\r\n    GeometryFormFieldComponent,\r\n    GeometryFormFieldInputComponent\r\n  ]\r\n})\r\nexport class IgoGeometryFormFieldModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoGeometryFormFieldModule } from './geometry-form-field/geometry-form-field.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoGeometryFormFieldModule\r\n  ],\r\n  exports: [\r\n    IgoGeometryFormFieldModule\r\n  ],\r\n  declarations: [],\r\n  providers: []\r\n})\r\nexport class IgoGeometryModule {}\r\n","<button *ngIf=\"header && options.timeFilterable && options.timeFilter\"\r\n  mat-icon-button\r\n  collapsibleButton\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.filter.filterBy' | translate\"\r\n  [color]=\"color\">\r\n  <mat-icon [matBadge]=\"badge\" matBadgeColor=\"warn\" matBadgeSize=\"medium\" svgIcon=\"history\"></mat-icon>\r\n</button>\r\n\r\n<div #ogcFilter class=\"igo-layer-actions-container\"\r\n*ngIf=\"header && options.timeFilterable && options.timeFilter\">\r\n  <igo-time-filter-item\r\n    *ngIf=\"timeFilterCollapse && options.timeFilter\"\r\n    igoListItem\r\n    [header]=\"false\"\r\n    [layer]=\"layer\">\r\n  </igo-time-filter-item>\r\n</div>\r\n","import { Component, Input, ChangeDetectionStrategy, OnInit } from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { IgoMap } from '../../map';\r\nimport { TimeFilterableDataSourceOptions } from '../shared/time-filter.interface';\r\nimport { WMSDataSourceOptions } from '../../datasource/shared/datasources/wms-datasource.interface';\r\n\r\n@Component({\r\n  selector: 'igo-time-filter-button',\r\n  templateUrl: './time-filter-button.component.html',\r\n  styleUrls: ['./time-filter-button.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class TimeFilterButtonComponent implements OnInit {\r\n\r\n  public options: TimeFilterableDataSourceOptions;\r\n\r\n  get badge() {\r\n    const filter = this.options.timeFilter as any;\r\n    if (filter && filter.enabled) {\r\n      return 1;\r\n    } else {\r\n      return;\r\n    }\r\n  }\r\n\r\n  @Input()\r\n  get layer(): Layer {\r\n    return this._layer;\r\n  }\r\n  set layer(value: Layer) {\r\n    this._layer = value;\r\n    if (value) {\r\n      this.options = this.layer.dataSource.options as WMSDataSourceOptions;\r\n    }\r\n  }\r\n  private _layer;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() color: string = 'primary';\r\n\r\n  @Input() header: boolean = true;\r\n\r\n  public timeFilterCollapse = false;\r\n\r\n  constructor() {}\r\n\r\n  ngOnInit() {\r\n    this.options = this.layer.dataSource.options as WMSDataSourceOptions;\r\n  }\r\n}\r\n","<div *ngIf=\"style === 'calendar' && type !=='year'\">\r\n  <div *ngIf=\"!isRange\" class=\"igo-col igo-col-100 igo-col-100-m\">\r\n    <mat-form-field>\r\n      <mat-datetimepicker-toggle [for]=\"datetimePicker\" matSuffix></mat-datetimepicker-toggle>\r\n      <mat-datetimepicker #datetimePicker type=\"{{type}}\" openOnFocus=\"true\" timeInterval=\"5\"></mat-datetimepicker>\r\n      <input matInput autocomplete=\"false\"\r\n        placeholder=\"{{'igo.geo.timeFilter.date' | translate}}\"\r\n        [matDatetimepicker]=\"datetimePicker\"\r\n        [(ngModel)]=\"date\"\r\n        [min]=\"min\"\r\n        [max]=\"max\"\r\n        readonly=\"readonly\"\r\n        (dateChange)=\"handleDateChange($event)\">\r\n    </mat-form-field>\r\n\r\n  </div>\r\n\r\n  <div *ngIf=\"isRange\">\r\n    <div class=\"igo-col igo-col-100\">\r\n      <mat-form-field>\r\n        <mat-datetimepicker-toggle [for]=\"minDatetimePicker\" matSuffix></mat-datetimepicker-toggle>\r\n        <mat-datetimepicker #minDatetimePicker type=\"{{type}}\" openOnFocus=\"true\" timeInterval=\"5\"></mat-datetimepicker>\r\n        <input matInput autocomplete=\"false\"\r\n          placeholder=\"{{'igo.geo.timeFilter.startDate' | translate}}\"\r\n          [matDatetimepicker]=\"minDatetimePicker\"\r\n          [(ngModel)]=\"startDate\"\r\n          [min]=\"min\"\r\n          [max]=\"getRangeMaxDate()\"\r\n          readonly=\"readonly\"\r\n          (input)=\"startDate\"\r\n          (dateChange)=\"handleDateChange($event)\">\r\n      </mat-form-field>\r\n    </div>\r\n\r\n    <div class=\"igo-col igo-col-100\">\r\n      <mat-form-field>\r\n        <mat-datetimepicker-toggle [for]=\"maxDatetimePicker\" matSuffix></mat-datetimepicker-toggle>\r\n        <mat-datetimepicker #maxDatetimePicker type=\"{{type}}\" openOnFocus=\"true\" timeInterval=\"5\"></mat-datetimepicker>\r\n        <input matInput autocomplete=\"false\"\r\n          placeholder=\"{{'igo.geo.timeFilter.endDate' | translate}}\"\r\n          [matDatetimepicker]=\"maxDatetimePicker\"\r\n          [(ngModel)]=\"endDate\"\r\n          [min]=\"getRangeMinDate()\"\r\n          [max]=\"max\"\r\n          readonly=\"readonly\"\r\n          (dateChange)=\"handleDateChange($event)\">\r\n      </mat-form-field>\r\n    </div>\r\n  </div>\r\n</div>\r\n\r\n<div *ngIf=\"style === 'calendar' && type ==='year'\">\r\n\r\n  <div *ngIf=\"!isRange\" class=\"igo-col igo-col-100 igo-col-100-m\">\r\n        <mat-form-field>\r\n            <mat-select placeholder=\"{{'igo.geo.timeFilter.date' | translate}}\" [(ngModel)]=\"year\" (selectionChange)=\"handleYearChange($event)\">\r\n                  <mat-option [value]=\"year\" *ngFor=\"let year of listYears\">{{year}}</mat-option>\r\n            </mat-select>\r\n        </mat-form-field>\r\n  </div>\r\n\r\n  <div *ngIf=\"isRange\">\r\n    <div class=\"igo-col igo-col-100\">\r\n        <mat-form-field>\r\n            <mat-select placeholder=\"{{'igo.geo.timeFilter.startDate' | translate}}\" [(ngModel)]=\"startYear\" (selectionChange)=\"handleYearChange($event)\">\r\n              <mat-option [value]=\"startYear\" *ngFor=\"let startYear of startListYears\">{{startYear}}</mat-option>\r\n            </mat-select>\r\n      </mat-form-field>\r\n    </div>\r\n\r\n    <div class=\"igo-col igo-col-100\">\r\n    <mat-form-field>\r\n        <mat-select placeholder=\"{{'igo.geo.timeFilter.endDate' | translate}}\" [(ngModel)]=\"endYear\" (selectionChange)=\"handleYearChange($event)\">\r\n              <mat-option [value]=\"endYear\" *ngFor=\"let endYear of endListYears\">{{endYear}}</mat-option>\r\n        </mat-select>\r\n      </mat-form-field>\r\n    </div>\r\n  </div>\r\n\r\n</div>\r\n\r\n\r\n  <br>\r\n  <div *ngIf=\"!isRange && style === 'slider' && type === 'year'\" class=\"igo-col igo-col-100 igo-col-100-m mat-typography\">\r\n    <span>{{startYear}}</span>\r\n    <mat-slider\r\n        id=\"time-slider\"\r\n        tickInterval=\"auto\"\r\n        step=\"{{step}}\"\r\n        [min]=\"startYear\"\r\n        [max]=\"endYear\"\r\n        [value]=\"handleSliderValue()\"\r\n        [color]=\"color\"\r\n        thumbLabel\r\n        (input)=\"handleSliderYearChange($event)\"\r\n        (change)=\"handleSliderYearChange($event)\"\r\n        [disabled]= \"!options.enabled || !layer.visible\">\r\n    </mat-slider>\r\n    <span>{{endYear}}</span>\r\n    <p *ngIf= \"options.enabled\" class=\"date-below\">{{year}}</p>\r\n    <div #actions class=\"igo-layer-actions-container\">\r\n      <mat-slide-toggle (change)=\"toggleFilterState()\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.geo.filter.toggleFilterState' | translate\" [color]=\"color\" [checked]=\"options.enabled\"\r\n        [disabled]=\"!layer.visible\">\r\n      </mat-slide-toggle>\r\n      <button [disabled]= \"!options.enabled  || !layer.visible\" mat-icon-button color=\"primary\" (click)=\"playYear($event)\">\r\n        <mat-icon svgIcon=\"{{playIcon}}\"></mat-icon>\r\n       </button>\r\n      <button [disabled]=\"!options.enabled  || !layer.visible\" mat-icon-button color=\"primary\" (click)=\"resetFilter($event)\">\r\n        <mat-icon svgIcon=\"{{resetIcon}}\"></mat-icon>\r\n      </button>\r\n    </div>\r\n  </div>\r\n\r\n<div *ngIf=\"style === 'slider' && type !== 'year'\" class=\"igo-col igo-col-100 igo-col-100-m\">\r\n  <mat-slider\r\n      id=\"time-slider\"\r\n      tickInterval=\"auto\"\r\n      step=\"{{step}}\"\r\n      [min]=\"dateToNumber(min)\"\r\n      [max]=\"dateToNumber(max)\"\r\n      [value]=\"handleSliderValue()\"\r\n      thumbLabel\r\n      (input)=\"handleSliderDateChange($event)\"\r\n      (selectionChange)=\"handleSliderDateChange($event)\">\r\n  </mat-slider>\r\n  <p class=\"date-below\">{{handleSliderTooltip()}}</p>\r\n  <button mat-icon-button color=\"primary\" (click)=\"playFilter($event)\">\r\n   <mat-icon svgIcon=\"{{playIcon}}\"></mat-icon>\r\n  </button>\r\n</div>\r\n","import {\r\n  Component,\r\n  OnInit,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ViewChild\r\n} from '@angular/core';\r\nimport { DateAdapter } from '@angular/material/core';\r\nimport { MatSlider } from '@angular/material/slider';\r\nimport * as moment from 'moment';\r\nimport olSourceImageWMS from 'ol/source/ImageWMS';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { TimeFilterOptions } from '../shared/time-filter.interface';\r\nimport { TimeFilterType, TimeFilterStyle } from '../shared/time-filter.enum';\r\n\r\n@Component({\r\n  selector: 'igo-time-filter-form',\r\n  templateUrl: './time-filter-form.component.html',\r\n  styleUrls: ['./time-filter-form.component.scss']\r\n})\r\nexport class TimeFilterFormComponent implements OnInit {\r\n  @Input() layer: Layer;\r\n\r\n  @Input() options: TimeFilterOptions;\r\n\r\n  public color = 'primary';\r\n  public date: Date;\r\n  public startDate: Date;\r\n  public endDate: Date;\r\n  public year: any;\r\n  public startYear: any;\r\n  public endYear: any;\r\n  public initStartYear: any;\r\n  public initEndYear: any;\r\n  public listYears: Array<string> = [];\r\n  public startListYears: Array<string> = [];\r\n  public endListYears: Array<string> = [];\r\n\r\n  @Input()\r\n  set currentValue(value: string) {\r\n    if (value) {\r\n      if (this.type !== TimeFilterType.YEAR) {\r\n        const valueArray = value.split('/');\r\n        if (valueArray.length > 0) {\r\n          const startDate = new Date(valueArray[0]);\r\n          const endDate = new Date(valueArray[1]);\r\n          if (!isNaN(startDate.valueOf())) {\r\n            this.startDate = startDate;\r\n          }\r\n          if (!isNaN(endDate.valueOf())) {\r\n            this.endDate = endDate;\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  public interval: any;\r\n  public playIcon = 'play-circle';\r\n  public resetIcon = 'replay';\r\n\r\n  @Output() change: EventEmitter<Date | [Date, Date]> = new EventEmitter();\r\n  @Output()\r\n  yearChange: EventEmitter<string | [string, string]> = new EventEmitter();\r\n  @ViewChild(MatSlider) mySlider;\r\n\r\n  get type(): TimeFilterType {\r\n    return this.options.type === undefined\r\n      ? TimeFilterType.DATE\r\n      : this.options.type;\r\n  }\r\n\r\n  get isRange(): boolean {\r\n    return this.options.range === undefined ||\r\n      this.options.style === TimeFilterStyle.SLIDER\r\n      ? false\r\n      : this.options.range;\r\n  }\r\n\r\n  get style(): TimeFilterStyle {\r\n    return this.options.style === undefined\r\n      ? TimeFilterStyle.SLIDER\r\n      : this.options.style;\r\n  }\r\n\r\n  get step(): number {\r\n    let step = 10800000;\r\n    if (this.options.step === undefined) {\r\n      switch (this.type) {\r\n        case TimeFilterType.DATE:\r\n        case TimeFilterType.DATETIME:\r\n          step = 10800000;\r\n          break;\r\n        case TimeFilterType.TIME:\r\n          step = 3600000;\r\n          break;\r\n        case TimeFilterType.YEAR:\r\n          step = 31536000000;\r\n          break;\r\n        default:\r\n          step = 10800000;\r\n      }\r\n    } else {\r\n      step = this.getStepDefinition(this.options.step);\r\n    }\r\n\r\n    return step;\r\n  }\r\n\r\n  get timeInterval(): number {\r\n    return this.options.timeInterval === undefined\r\n      ? 2000\r\n      : this.options.timeInterval;\r\n  }\r\n\r\n  get min(): Date {\r\n    if (this.options.min) {\r\n      const min = new Date(this.options.min);\r\n      return new Date(min.getTime() + min.getTimezoneOffset() * 60000);\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  get max(): Date {\r\n    if (this.options.max) {\r\n      const max = new Date(this.options.max);\r\n      return new Date(max.getTime() + max.getTimezoneOffset() * 60000);\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n\r\n  get is(): boolean {\r\n    return this.options.range === undefined ? false : this.options.range;\r\n  }\r\n\r\n  constructor(private dateAdapter: DateAdapter<Date>) {\r\n    this.dateAdapter.setLocale('fr');\r\n  }\r\n\r\n  ngOnInit() {\r\n    if (this.startDate === undefined) {\r\n      this.startDate = new Date(this.min);\r\n    }\r\n    if (this.endDate === undefined) {\r\n      this.endDate = new Date(this.max);\r\n    }\r\n    if (this.startYear === undefined) {\r\n      this.startYear = new Date(this.startDate).getFullYear();\r\n      this.initStartYear = this.startYear;\r\n    }\r\n    if (this.endYear === undefined) {\r\n      this.endYear = new Date(this.endDate).getFullYear();\r\n      this.initEndYear = this.endYear;\r\n    }\r\n\r\n    if (!this.isRange) {\r\n      for (let i = this.startYear; i <= this.endYear + 1; i++) {\r\n        this.listYears.push(i);\r\n      }\r\n    } else {\r\n      for (let i = this.startYear; i < this.endYear; i++) {\r\n        this.startListYears.push(i);\r\n      }\r\n      for (let i = this.startYear + 1; i <= this.endYear; i++) {\r\n        this.endListYears.push(i);\r\n      }\r\n    }\r\n    this.options.enabled =\r\n      this.options.enabled === undefined ? true : this.options.enabled;\r\n    this.checkFilterValue();\r\n    if (this.options.enabled) {\r\n      if (!this.isRange && this.style === 'slider' && this.type === 'year') {\r\n        this.yearChange.emit(this.year);\r\n      }\r\n    } else {\r\n      this.storeCurrentFilterValue();\r\n      this.yearChange.emit(undefined); // TODO: FIX THIS for ALL OTHER TYPES STYLES OR RANGE.\r\n    }\r\n  }\r\n\r\n  storeCurrentFilterValue() {\r\n    // TODO: FIX THIS for ALL OTHER TYPES STYLES OR RANGE.\r\n    if (\r\n      !this.isRange &&\r\n      this.style === TimeFilterStyle.SLIDER &&\r\n      this.type === TimeFilterType.YEAR\r\n    ) {\r\n      this.options.value = this.year.toString();\r\n    }\r\n  }\r\n\r\n  checkFilterValue() {\r\n    const olSource = this.layer.dataSource.ol as olSourceImageWMS;\r\n    const timeFromWms = olSource.getParams().TIME;\r\n    if (\r\n      !this.isRange &&\r\n      this.style === TimeFilterStyle.SLIDER &&\r\n      this.type === TimeFilterType.YEAR\r\n    ) {\r\n      if (timeFromWms) {\r\n        this.year = new Date(timeFromWms.toString()).getFullYear() + 1;\r\n      } else if (this.options.value) {\r\n        this.year = new Date(this.options.value.toString()).getFullYear() + 1;\r\n      } else {\r\n        this.year = new Date(this.min).getFullYear() + 1;\r\n      }\r\n    } else if (\r\n      this.isRange &&\r\n      this.style === TimeFilterStyle.CALENDAR &&\r\n      this.type === TimeFilterType.YEAR\r\n    ) {\r\n      if (timeFromWms) {\r\n        this.startYear = parseInt(timeFromWms.substr(0, 4), 10);\r\n        this.endYear = parseInt(timeFromWms.substr(5, 4), 10);\r\n        const newStartListYears: any[] = [];\r\n        const newEndListYears: any[] = [];\r\n        for (let i = this.initStartYear; i < this.endYear; i++) {\r\n          newStartListYears.push(i);\r\n        }\r\n        for (let i = this.startYear + 1; i <= this.initEndYear; i++) {\r\n          newEndListYears.push(i);\r\n        }\r\n        this.startListYears = newStartListYears;\r\n        this.endListYears = newEndListYears;\r\n      }\r\n    }\r\n    // TODO: FIX THIS for ALL OTHER TYPES STYLES OR RANGE.\r\n  }\r\n\r\n  handleDateChange(event: any) {\r\n    this.setupDateOutput();\r\n    this.applyTypeChange();\r\n\r\n    // Only if is range, use 2 dates to make the range\r\n    if (this.isRange) {\r\n      this.change.emit([this.startDate, this.endDate]);\r\n    } else {\r\n      this.change.emit(this.startDate);\r\n    }\r\n  }\r\n\r\n  handleYearChange(event: any) {\r\n    if (this.isRange) {\r\n      this.endListYears = [];\r\n      for (let i = this.startYear + 1; i <= this.initEndYear; i++) {\r\n        this.endListYears.push(i);\r\n      }\r\n      this.startListYears = [];\r\n      for (let i = this.initStartYear + 1; i < this.endYear; i++) {\r\n        this.startListYears.push(i);\r\n      }\r\n      this.yearChange.emit([this.startYear, this.endYear]);\r\n    } else {\r\n      this.yearChange.emit(this.year);\r\n    }\r\n  }\r\n\r\n  handleListYearChange(event: any) {\r\n    this.handleYearChange([this.startYear, this.endYear]);\r\n  }\r\n\r\n  handleListYearStartChange(event: any) {\r\n    this.change.emit([this.startDate, this.endDate]);\r\n  }\r\n\r\n  dateToNumber(date: Date): number {\r\n    let newDate;\r\n    if (date) {\r\n      newDate = new Date(date);\r\n    } else {\r\n      newDate = new Date(this.min);\r\n    }\r\n\r\n    return newDate.getTime();\r\n  }\r\n\r\n  setSliderThumbLabel(label: string) {\r\n    const thumbLabel = this.findThumbLabel(\r\n      this.mySlider._elementRef.nativeElement.childNodes\r\n    );\r\n    if (thumbLabel) {\r\n      thumbLabel.textContent = label;\r\n    }\r\n  }\r\n\r\n  findThumbLabel(test: any[]): any {\r\n    let thumbLabel;\r\n\r\n    test.forEach(value => {\r\n      if (value.className === 'mat-slider-thumb-label-text') {\r\n        thumbLabel = value;\r\n      }\r\n\r\n      if (value.children.length > 0 && !thumbLabel) {\r\n        thumbLabel = this.findThumbLabel(value.childNodes);\r\n      }\r\n    }, this);\r\n    return thumbLabel;\r\n  }\r\n\r\n  toggleFilterState() {\r\n    this.options.enabled = !this.options.enabled;\r\n\r\n    if (this.options.enabled) {\r\n      if (\r\n        !this.isRange &&\r\n        TimeFilterStyle.SLIDER &&\r\n        this.type === TimeFilterType.YEAR\r\n      ) {\r\n        this.yearChange.emit(this.year);\r\n      }\r\n    } else {\r\n      this.stopFilter();\r\n      this.storeCurrentFilterValue();\r\n      this.change.emit(undefined); // TODO: FIX THIS for ALL OTHER TYPES STYLES OR RANGE.\r\n    }\r\n  }\r\n\r\n  resetFilter(event: any) {\r\n    this.date = new Date(this.min);\r\n    this.year = this.date.getFullYear();\r\n    if (\r\n      !this.isRange &&\r\n      TimeFilterStyle.SLIDER &&\r\n      this.type === TimeFilterType.YEAR\r\n    ) {\r\n      this.yearChange.emit(this.year);\r\n    } else {\r\n      this.setupDateOutput();\r\n      this.change.emit(undefined); // TODO: FIX THIS for ALL OTHER TYPES STYLES OR RANGE.\r\n    }\r\n  }\r\n\r\n  playFilter(event: any) {\r\n    if (this.interval) {\r\n      this.stopFilter();\r\n    } else {\r\n      this.playIcon = 'pause-circle';\r\n      this.interval = setInterval(\r\n        that => {\r\n          let newMinDateNumber;\r\n          const maxDateNumber = new Date(that.max);\r\n\r\n          newMinDateNumber =\r\n            that.date === undefined ? that.min.getTime() : that.date.getTime();\r\n          newMinDateNumber += that.mySlider.step;\r\n          that.date = new Date(newMinDateNumber);\r\n\r\n          if (newMinDateNumber > maxDateNumber.getTime()) {\r\n            that.stopFilter();\r\n          }\r\n\r\n          that.handleDateChange({ value: that.date, date: that.date });\r\n        },\r\n        this.timeInterval,\r\n        this\r\n      );\r\n    }\r\n  }\r\n\r\n  playYear(event: any) {\r\n    if (\r\n      this.year + this.mySlider.step >\r\n      this.max.getFullYear() + this.mySlider.step\r\n    ) {\r\n      this.stopFilter();\r\n      this.resetFilter(event);\r\n    }\r\n    if (this.interval) {\r\n      this.stopFilter();\r\n    } else {\r\n      this.playIcon = 'pause-circle';\r\n      this.interval = setInterval(() => {\r\n        if (\r\n          (this.year + this.mySlider.step) > this.max.getFullYear()) {\r\n          this.stopFilter();\r\n        } else {\r\n          this.year = this.year + this.mySlider.step;\r\n        }\r\n        this.yearChange.emit(this.year);\r\n\r\n      }, this.timeInterval, this);\r\n    }\r\n  }\r\n\r\n  stopFilter() {\r\n    if (this.interval) {\r\n      clearInterval(this.interval);\r\n    }\r\n    this.interval = undefined;\r\n    this.playIcon = 'play-circle';\r\n  }\r\n\r\n  handleSliderDateChange(event: any) {\r\n    this.date = new Date(event.value);\r\n    this.setSliderThumbLabel(this.handleSliderTooltip());\r\n    this.handleDateChange(event);\r\n  }\r\n\r\n  handleSliderYearChange(event: any) {\r\n    this.year = event.value;\r\n    this.yearChange.emit(this.year);\r\n  }\r\n\r\n  handleSliderValue(): number {\r\n    if (this.options.current === true || !this.min) {\r\n      const currentDate = new Date();\r\n      this.date = this.getRoundedDate(currentDate);\r\n    }\r\n    if (this.type === TimeFilterType.YEAR) {\r\n      return this.year;\r\n    } else {\r\n      return this.date === undefined ? this.min.getTime() : this.date.getTime();\r\n    }\r\n  }\r\n\r\n  handleSliderTooltip() {\r\n    let label: string;\r\n\r\n    switch (this.type) {\r\n      case TimeFilterType.DATE:\r\n        label =\r\n          this.date === undefined\r\n            ? this.min.toDateString()\r\n            : this.date.toDateString();\r\n        break;\r\n      case TimeFilterType.TIME:\r\n        label =\r\n          this.date === undefined\r\n            ? this.min.toTimeString()\r\n            : this.date.toTimeString();\r\n        break;\r\n      // datetime\r\n      default:\r\n        label =\r\n          this.date === undefined\r\n            ? this.min.toUTCString()\r\n            : this.date.toUTCString();\r\n        break;\r\n    }\r\n\r\n    return label;\r\n  }\r\n\r\n  setupDateOutput() {\r\n    if (this.style === TimeFilterStyle.SLIDER) {\r\n      this.startDate = new Date(this.date);\r\n      this.startDate.setSeconds(-(this.step / 1000));\r\n      this.endDate = new Date(this.startDate);\r\n      this.endDate.setSeconds(this.step / 1000);\r\n    } else if (!this.isRange && !!this.date) {\r\n      this.endDate = new Date(this.date);\r\n      this.startDate = new Date(this.date);\r\n    } else if (this.isRange && (!!this.date || !this.date)) {\r\n      this.startDate =\r\n        this.startDate === undefined ? new Date(this.min) : this.startDate;\r\n      this.endDate =\r\n        this.endDate === undefined ? new Date(this.max) : this.endDate;\r\n    } else if (!this.date) {\r\n      this.startDate =\r\n        this.startDate === undefined ? new Date(this.min) : this.startDate;\r\n      this.endDate =\r\n        this.endDate === undefined ? new Date(this.max) : this.endDate;\r\n    }\r\n  }\r\n\r\n  applyTypeChange() {\r\n    switch (this.type) {\r\n      case TimeFilterType.DATE:\r\n        if (this.startDate !== undefined || this.endDate !== undefined) {\r\n          this.startDate.setHours(0);\r\n          this.startDate.setMinutes(0);\r\n          this.startDate.setSeconds(0);\r\n          this.endDate.setHours(23);\r\n          this.endDate.setMinutes(59);\r\n          this.endDate.setSeconds(59);\r\n        }\r\n        break;\r\n      case TimeFilterType.TIME:\r\n        if (this.style === TimeFilterStyle.CALENDAR) {\r\n          if (this.startDate.getDay() !== this.min.getDay()) {\r\n            const selectedHour = this.startDate.getHours();\r\n            const selectedMinute = this.startDate.getMinutes();\r\n            this.startDate = this.min;\r\n            this.startDate.setHours(selectedHour);\r\n            this.startDate.setMinutes(selectedMinute);\r\n          }\r\n\r\n          if (this.endDate.getDay() !== this.min.getDay()) {\r\n            const selectedHour = this.endDate.getHours();\r\n            const selectedMinute = this.endDate.getMinutes();\r\n            this.endDate = this.min;\r\n            this.endDate.setHours(selectedHour);\r\n            this.endDate.setMinutes(selectedMinute);\r\n          }\r\n        }\r\n\r\n        if (!this.isRange && this.step > 60 * 60 * 1000) {\r\n          this.startDate.setMinutes(0);\r\n          this.startDate.setSeconds(0);\r\n          this.endDate.setMinutes(59);\r\n          this.endDate.setSeconds(59);\r\n        }\r\n        break;\r\n      // datetime\r\n      default:\r\n      // do nothing\r\n    }\r\n  }\r\n\r\n  getRangeMinDate(): Date {\r\n    return this.startDate === undefined ? this.min : this.startDate;\r\n  }\r\n\r\n  getRangeMaxDate(): Date {\r\n    return this.endDate === undefined ? this.max : this.endDate;\r\n  }\r\n\r\n  /**\r\n   * Round date at a certain time, 10 minutes by Default\r\n   * @param date - Date to Round\r\n   * @param atMinute - round to closest 'atMinute' minute, rounded 10 by default\r\n   * @return the rounded date\r\n   */\r\n  getRoundedDate(date, atMinute = 10) {\r\n    const coeff = 1000 * 60 * atMinute;\r\n    return new Date(Math.round(date.getTime() / coeff) * coeff);\r\n  }\r\n\r\n  /**\r\n   * Get the step (period) definition from the layer dimension tag\r\n   * @param step The step as ISO 8601 example: PT10M for 10 Minutes\r\n   * @return the duration in milliseconds\r\n   */\r\n  getStepDefinition(step) {\r\n    return moment.duration(step).asMilliseconds();\r\n  }\r\n}\r\n","<mat-list-item *ngIf=\"header\">\r\n  <mat-icon\r\n    class=\"igo-chevron\"\r\n    mat-list-avatar\r\n    igoCollapse\r\n    [target]=\"filters\"\r\n    [collapsed]=\"filtersCollapsed\"\r\n    (click)=\"toggleFiltersCollapsed()\"\r\n    svgIcon=\"chevron-up\" >\r\n  </mat-icon>\r\n  <h4 (click)=\"toggleLegendOnClick()\" [ngStyle]=\"{'cursor': filtersCollapsed ? 'default' : 'pointer'}\"  matLine>{{layer.title}}</h4>\r\n  \r\n  <button *ngIf=\"header\"\r\n    mat-icon-button\r\n    [color]=\"layer.visible ? 'primary' : 'default'\"\r\n    collapsibleButton\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"layer.visible ?\r\n                  ('igo.geo.layer.hideLayer' | translate) :\r\n                  ('igo.geo.layer.showLayer' | translate)\"\r\n    (click)=\"layer.visible = !layer.visible\">\r\n    <mat-icon\r\n      [ngClass]=\"{disabled: (inResolutionRange$ | async)===false}\"\r\n      [svgIcon]=\"layer.visible ? 'eye' : 'eye-off'\">\r\n    </mat-icon>\r\n  </button>\r\n\r\n</mat-list-item>\r\n\r\n<div #filters class=\"igo-datasource-filters-container\">\r\n  <div #legend class=\"igo-layer-legend-container\">\r\n    <igo-layer-legend *ngIf=\"showLegend$ | async\" [layer]=\"layer\">\r\n    </igo-layer-legend>\r\n  </div>\r\n  <igo-time-filter-form\r\n    [layer]= \"layer\"\r\n    [options]=\"datasource.options.timeFilter\"\r\n    [currentValue]=\"datasource.options.params.TIME\"\r\n    (change)=\"handleDateChange($event)\"\r\n    (yearChange)=\"handleYearChange($event)\">\r\n  </igo-time-filter-form>\r\n</div>\r\n","import { Component, Input, OnDestroy, OnInit } from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { TimeFilterableDataSource } from '../shared/time-filter.interface';\r\nimport { TimeFilterService } from '../shared/time-filter.service';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'igo-time-filter-item',\r\n  templateUrl: './time-filter-item.component.html',\r\n  styleUrls: ['./time-filter-item.component.scss']\r\n})\r\nexport class TimeFilterItemComponent implements OnInit, OnDestroy {\r\n  public color = 'primary';\r\n  showLegend$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  inResolutionRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n  private resolution$$: Subscription;\r\n\r\n  filtersCollapsed: boolean = false;\r\n\r\n  @Input() header: boolean = true;\r\n\r\n  @Input() layer: Layer;\r\n\r\n  get datasource(): TimeFilterableDataSource {\r\n    return this.layer.dataSource as TimeFilterableDataSource;\r\n  }\r\n  constructor(private timeFilterService: TimeFilterService) {}\r\n\r\n  ngOnInit(): void {\r\n    const resolution$ = this.layer.map.viewController.resolution$;\r\n    this.resolution$$ = resolution$.subscribe(() => {\r\n      this.inResolutionRange$.next(this.layer.isInResolutionsRange);\r\n    });\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this.resolution$$.unsubscribe();\r\n  }\r\n\r\n  handleYearChange(year: string | [string, string]) {\r\n    this.timeFilterService.filterByYear(this.datasource, year);\r\n  }\r\n\r\n  handleDateChange(date: Date | [Date, Date]) {\r\n    this.timeFilterService.filterByDate(this.datasource, date);\r\n  }\r\n\r\n  private toggleLegend(collapsed: boolean) {\r\n    this.layer.legendCollapsed = collapsed;\r\n    this.showLegend$.next(!collapsed);\r\n  }\r\n\r\n  toggleLegendOnClick() {\r\n    if (!this.filtersCollapsed) {\r\n      this.toggleLegend(this.showLegend$.value);\r\n    }\r\n  }\r\n\r\n  public setVisible() {\r\n    this.layer.visible = true;\r\n  }\r\n\r\n  toggleFiltersCollapsed() {\r\n    this.filtersCollapsed = !this.filtersCollapsed;\r\n  }\r\n}\r\n","<igo-list [navigation]=\"false\" [selection]=\"false\">\r\n  <ng-template ngFor let-layer [ngForOf]=\"layers | filterableDataSource: 'time'\">\r\n    <igo-time-filter-item [header]=\"true\" igoListItem [layer]=\"layer\"></igo-time-filter-item>\r\n  </ng-template>\r\n</igo-list>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\n\r\n@Component({\r\n  selector: 'igo-time-filter-list',\r\n  templateUrl: './time-filter-list.component.html',\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class TimeFilterListComponent {\r\n  @Input()\r\n  get layers(): Layer[] {\r\n    return this._layers;\r\n  }\r\n  set layers(value: Layer[]) {\r\n    this._layers = value;\r\n    this.cdRef.detectChanges();\r\n  }\r\n  private _layers: Layer[] = [];\r\n\r\n  constructor(private cdRef: ChangeDetectorRef) {}\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport * as olproj from 'ol/proj';\r\nimport olWKT from 'ol/format/WKT';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class WktService {\r\n  constructor() {}\r\n\r\n  public wktToFeature(wkt, wktProj, featureProj) {\r\n    return new olWKT().readFeature(wkt, {\r\n      dataProjection: wktProj,\r\n      featureProjection: featureProj\r\n    });\r\n  }\r\n  public extentToWkt(epsgTO, extent, extentProj) {\r\n    let currentExtent = olproj.transformExtent(extent, extentProj, epsgTO);\r\n    currentExtent = this.roundCoordinateArray(currentExtent, epsgTO, 0);\r\n    const wktPoly = `POLYGON((\r\n      ${extent[0]} ${extent[1]},\r\n      ${extent[0]} ${extent[3]},\r\n      ${extent[2]} ${extent[3]},\r\n      ${extent[2]} ${extent[1]},\r\n      ${extent[0]} ${extent[1]}))`;\r\n    const wktLine = `LINESTRING(\r\n      ${extent[0]} ${extent[1]},\r\n      ${extent[0]} ${extent[3]},\r\n      ${extent[2]} ${extent[3]},\r\n      ${extent[2]} ${extent[1]},\r\n      ${extent[0]} ${extent[1]})`;\r\n    const wktMultiPoints = `MULTIPOINT(\r\n        ${extent[0]} ${extent[1]},\r\n        ${extent[0]} ${extent[3]},\r\n        ${extent[2]} ${extent[3]},\r\n        ${extent[2]} ${extent[1]})`;\r\n    return {\r\n      wktPoly,\r\n      wktLine,\r\n      wktMultiPoints\r\n    };\r\n  }\r\n\r\n  private roundCoordinateArray(coordinateArray, projection, decimal = 0) {\r\n    const lproj = olproj.get(projection);\r\n    const units = lproj.getUnits();\r\n    const olUnits = ['ft', 'm', 'us-ft'];\r\n    if (olUnits.indexOf(units) !== -1) {\r\n      coordinateArray = this.roundArray(coordinateArray, decimal);\r\n    }\r\n    return coordinateArray;\r\n  }\r\n\r\n  private roundArray(array, decimal = 0) {\r\n    let x = 0;\r\n    while (x < array.length) {\r\n      array[x] = array[x].toFixed(decimal);\r\n      x++;\r\n    }\r\n    return array;\r\n  }\r\n\r\n  public snrcToWkt(snrc, epsgTO) {\r\n    snrc = snrc.toLowerCase();\r\n    let wktPoly;\r\n    const ew = {\r\n      1: { from: -56, to: -64 },\r\n      2: { from: -64, to: -72 },\r\n      3: { from: -72, to: -80 },\r\n      4: { from: -80, to: -88 },\r\n      5: { from: -88, to: -96 },\r\n      6: { from: -96, to: -104 },\r\n      7: { from: -104, to: -112 },\r\n      8: { from: -112, to: -120 },\r\n      9: { from: -120, to: -128 },\r\n      10: { from: -128, to: -136 }\r\n    };\r\n    const sn = {\r\n      1: { from: 44, to: 48 },\r\n      2: { from: 48, to: 52 },\r\n      3: { from: 52, to: 56 },\r\n      4: { from: 56, to: 60 },\r\n      5: { from: 60, to: 64 },\r\n      6: { from: 64, to: 68 },\r\n      7: { from: 68, to: 72 },\r\n      8: { from: 72, to: 76 },\r\n      9: { from: 76, to: -128 }\r\n    };\r\n    const snrc250kIndex = [\r\n      ['m', 'n', 'o', 'p'],\r\n      ['l', 'k', 'j', 'i'],\r\n      ['e', 'f', 'g', 'h'],\r\n      ['d', 'c', 'b', 'a']\r\n    ];\r\n\r\n    const snrc50kIndex = [\r\n      ['13', '14', '15', '16'],\r\n      ['12', '11', '10', '09'],\r\n      ['05', '06', '07', '08'],\r\n      ['04', '03', '02', '01']\r\n    ];\r\n    const checkSNRC50k = /\\d{2,3}[a-p][0,1][0-9]/gi;\r\n    const checkSNRC250k = /\\d{2,3}[a-p]/gi;\r\n    const checkSNRC1m = /\\d{2,3}/gi;\r\n\r\n    let snrc1m = false;\r\n    let snrc250k = false;\r\n    let snrc50k = false;\r\n\r\n    if (checkSNRC50k.test(snrc)) {\r\n      snrc50k = true;\r\n    } else {\r\n      if (checkSNRC250k.test(snrc)) {\r\n        snrc250k = true;\r\n      } else {\r\n        if (checkSNRC1m.test(snrc)) {\r\n          snrc1m = true;\r\n        }\r\n      }\r\n    }\r\n\r\n    if (snrc1m) {\r\n      snrc += 'a01';\r\n    } else if (snrc250k) {\r\n      snrc += '01';\r\n    }\r\n    if (/\\d{2,3}[a-p][0,1][0-9]/gi.test(snrc)) {\r\n      const regex1m = /(?=[a-p])/gi;\r\n      const ar1m = snrc.split(regex1m);\r\n      const part1m = ar1m[0];\r\n      const part250k = ar1m[1][0];\r\n      const part50k = ar1m[1].split(part250k)[1];\r\n      let separator = 1;\r\n      if (part1m.length === 3) {\r\n        separator = 2;\r\n      }\r\n      const partEW = part1m.substring(0, separator);\r\n      const partSN = part1m.substring(separator);\r\n      const unit1mEW = 8;\r\n      const unit1mSN = 4;\r\n      const unit250kEW = 2;\r\n      const unit250kSN = 1;\r\n      const unit50kEW = 0.5;\r\n      const unit50kSN = 0.25;\r\n      let index250kEW = 0;\r\n      let index250kSN = 0;\r\n      let index50kEW = 0;\r\n      let index50kSN = 0;\r\n      snrc250kIndex.forEach(element => {\r\n        if (element.indexOf(part250k) !== -1) {\r\n          index250kSN = snrc250kIndex.indexOf(element);\r\n          index250kEW = element.indexOf(part250k);\r\n        }\r\n      });\r\n      snrc50kIndex.forEach(element => {\r\n        if (element.indexOf(part50k) !== -1) {\r\n          index50kSN = snrc50kIndex.indexOf(element);\r\n          index50kEW = element.indexOf(part50k);\r\n        }\r\n      });\r\n\r\n      let increment250kEW = 0;\r\n      let increment250kSN = 0;\r\n      let increment50kEW = 0;\r\n      let increment50kSN = 0;\r\n      let unitPerTypeEW = unit1mEW;\r\n      let unitPerTypeSN = unit1mSN;\r\n      if (snrc250k) {\r\n        increment250kEW = index250kEW * unit250kEW;\r\n        increment250kSN = index250kSN * unit250kSN;\r\n        increment50kEW = 0;\r\n        increment50kSN = 0;\r\n        unitPerTypeEW = unit250kEW;\r\n        unitPerTypeSN = unit250kSN;\r\n      } else if (snrc50k) {\r\n        increment250kEW = index250kEW * unit250kEW;\r\n        increment250kSN = index250kSN * unit250kSN;\r\n        increment50kEW = index50kEW * unit50kEW;\r\n        increment50kSN = index50kSN * unit50kSN;\r\n        unitPerTypeEW = unit50kEW;\r\n        unitPerTypeSN = unit50kSN;\r\n      }\r\n\r\n      const coord: {ul?: any, lr?: any, ur?: any, ll?: any} = {\r\n        ul: [\r\n          ew[partEW].to + increment250kEW + increment50kEW,\r\n          sn[partSN].to - increment250kSN - increment50kSN\r\n        ]\r\n      };\r\n\r\n      coord.lr = [\r\n        coord.ul[0] + unitPerTypeEW,\r\n        coord.ul[1] - unitPerTypeSN\r\n      ];\r\n      coord.ur = [coord.ul[0], coord.ul[1] - unitPerTypeSN];\r\n      coord.ll = [coord.ul[0] + unitPerTypeEW, coord.ul[1]];\r\n\r\n      coord.ul = olproj.transform(\r\n        [coord.ul[0], coord.ul[1]],\r\n        'EPSG:4326',\r\n        epsgTO\r\n      );\r\n      coord.lr = olproj.transform(\r\n        [coord.lr[0], coord.lr[1]],\r\n        'EPSG:4326',\r\n        epsgTO\r\n      );\r\n      coord.ur = olproj.transform(\r\n        [coord.ur[0], coord.ur[1]],\r\n        'EPSG:4326',\r\n        epsgTO\r\n      );\r\n      coord.ll = olproj.transform(\r\n        [coord.ll[0], coord.ll[1]],\r\n        'EPSG:4326',\r\n        epsgTO\r\n      );\r\n\r\n      // Rounded coordinate to shorten url in get\r\n      coord.ul = this.roundCoordinateArray(coord.ul, epsgTO, 0);\r\n      coord.lr = this.roundCoordinateArray(coord.lr, epsgTO, 0);\r\n      coord.ur = this.roundCoordinateArray(coord.ur, epsgTO, 0);\r\n      coord.ll = this.roundCoordinateArray(coord.ll, epsgTO, 0);\r\n\r\n      wktPoly =\r\n        'POLYGON((' +\r\n        [\r\n          coord.ul.join(' '),\r\n          coord.ur.join(' '),\r\n          coord.lr.join(' '),\r\n          coord.ll.join(' '),\r\n          coord.ul.join(' ')\r\n        ].join(',') +\r\n        '))';\r\n      const wktLine =\r\n        'LINESTRING(' +\r\n        [\r\n          coord.ul.join(' '),\r\n          coord.ur.join(' '),\r\n          coord.lr.join(' '),\r\n          coord.ll.join(' '),\r\n          coord.ul.join(' ')\r\n        ].join(',') +\r\n        ')';\r\n\r\n      const wktMultiPoints =\r\n        'MULTIPOINT(' +\r\n        [\r\n          coord.ul.join(' '),\r\n          coord.ur.join(' '),\r\n          coord.lr.join(' '),\r\n          coord.ll.join(' ')\r\n        ].join(',') +\r\n        ')';\r\n      return {\r\n        wktPoly,\r\n        wktLine,\r\n        wktMultiPoints\r\n      };\r\n    }\r\n  }\r\n}\r\n","<mat-checkbox\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.filter.toggleFilterState' | translate\"\r\n  (click)=\"$event.stopPropagation()\"\r\n  (change)=\"toggleFilterState($event)\"\r\n  [checked]=\"currentFilter.active\">\r\n</mat-checkbox>\r\n\r\n<mat-form-field\r\n  [ngClass]=\"{'logical': activeFilters.indexOf(currentFilter) !== 0 && currentFilter.active===true, 'logicalHidden': activeFilters.indexOf(currentFilter) === 0 || currentFilter.active!==true}\">\r\n  <mat-select\r\n    [disabled]=\"!currentFilter.active\"\r\n    [value]=\"currentFilter.parentLogical\"\r\n    tooltip-position=\"above\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"currentFilter.parentLogical ? (('igo.geo.operators.tooltip.'+ currentFilter.parentLogical) | translate) : ''\"\r\n    (selectionChange)=\"changeLogical($event.value)\">\r\n      <mat-option\r\n        [value]=ogcFilterOperator.And\r\n        tooltip-position=\"above\"\r\n        matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.geo.operators.tooltip.And' | translate\">\r\n          {{'igo.geo.operators.And' | translate}}\r\n      </mat-option>\r\n      <mat-option\r\n        [value]=ogcFilterOperator.Or\r\n        tooltip-position=\"above\"\r\n        matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.geo.operators.tooltip.Or' | translate\">\r\n          {{'igo.geo.operators.Or' | translate}}\r\n      </mat-option>\r\n  </mat-select>\r\n</mat-form-field>\r\n\r\n<mat-form-field\r\n  class=\"field\"\r\n  *ngIf=\"(currentFilterIsSpatial$ | async)===false && (fields$ | async) && (fields$| async).length > 0 && (fields$| async)[0].name !== ''\"\r\n  (mouseenter)=\"inputClearable = 'selectField'\"\r\n  (mouseleave)=\"inputClearable = undefined\"\r\n  [floatLabel]=\"floatLabel\">\r\n  <input\r\n  matInput\r\n  [placeholder]=\"'igo.geo.sourceFields.selectField' | translate\"\r\n  [disabled]=\"!currentFilter.active\"\r\n  [matAutocomplete]=\"autoCompleteField\"\r\n  [value]=\"(selectedField$ | async) ? (selectedField$ | async).alias : ''\"\r\n  tooltip-position=\"above\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"(selectedField$ | async) ? (selectedField$ | async).alias : ('igo.geo.sourceFields.selectField' | translate)\"\r\n  (input)=\"updateFieldsList($event.target.value)\">\r\n  <mat-autocomplete #autoCompleteField=\"matAutocomplete\"\r\n  (optionSelected)='changeField($event.option.id)'>\r\n    <mat-option\r\n      *ngFor=\"let field of filteredFields$ | async\"\r\n      matTooltipShowDelay=\"500\"\r\n      [value]=\"field.alias\"\r\n      [id]=\"field.name\"\r\n      [matTooltip]=\"field.alias\">\r\n      {{field.alias}}\r\n    </mat-option>\r\n  </mat-autocomplete>\r\n  <button mat-button\r\n    *ngIf=\"currentFilter.propertyName && inputClearable === 'selectField' && currentFilter.active\"\r\n    matSuffix\r\n    mat-icon-button\r\n    aria-label=\"Clear\"\r\n    [disabled]=\"!currentFilter.active\"\r\n    (click)=\"clearSelectedField()\">\r\n        <mat-icon svgIcon=\"close\"></mat-icon>\r\n  </button>\r\n</mat-form-field>\r\n\r\n\r\n<mat-form-field\r\n  [ngClass]=\"{'operator': (currentFilterIsSpatial$ | async)===false , 'dualInput': (currentFilterIsSpatial$ | async)}\"\r\n  [floatLabel]=\"floatLabel\">\r\n  <mat-select\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"currentFilter.operator ? (('igo.geo.operators.tooltip.'+ currentFilter.operator) | translate) : ('igo.geo.filter.selectOperator' | translate)\"\r\n    [disabled]=\"!currentFilter.active\"\r\n    [value]=\"currentFilter.operator\"\r\n    (selectionChange)=\"changeOperator($event.value)\">\r\n      <mat-option\r\n        *ngFor=\"let operator of (ogcFilterOperators$ | async) | keyvalue\"\r\n        tooltip-position=\"above\"\r\n        matTooltipShowDelay=\"500\"\r\n        [value]=\"operator.key\"\r\n        [matTooltip]=\"('igo.geo.operators.tooltip.'+ operator.key) | translate\">\r\n          {{('igo.geo.operators.'+ operator.key) | translate}}\r\n      </mat-option>\r\n  </mat-select>\r\n</mat-form-field>\r\n\r\n<mat-form-field\r\nclass=\"spatialSelector\"\r\n*ngIf=\"currentFilterIsSpatial$ | async\">\r\n  <mat-select\r\n    [disabled]=\"!currentFilter.active\"\r\n    [value]=\"currentFilter.igoSpatialSelector\"\r\n    (selectionChange)=\"changeSpatialSelector($event.value)\">\r\n      <mat-option\r\n        *ngFor=\"let igoSpatialSelector of igoSpatialSelectors\"\r\n        [value]=\"igoSpatialSelector.type\">\r\n          {{('igo.geo.spatialSelector.'+ igoSpatialSelector.type) | translate}}\r\n      </mat-option>\r\n  </mat-select>\r\n</mat-form-field>\r\n\r\n<mat-form-field\r\nclass=\"singleInput\"\r\n*ngIf=\"['expression','pattern'].indexOf(detectProperty()) !== -1\"\r\n(mouseenter)=\"inputClearable = 'selectProperty'\"\r\n(mouseleave)=\"inputClearable = undefined\"\r\n[floatLabel]=\"floatLabel\">\r\n  <input\r\n    matInput\r\n    [placeholder]=\"'igo.geo.filter.placeholder' | translate\"\r\n    [disabled]=\"!currentFilter.active\"\r\n    [matAutocomplete]=\"autoCompleteValues\"\r\n    [value]=\"detectProperty() === 'expression' ? currentFilter.expression : currentFilter.pattern\"\r\n    tooltip-position=\"above\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"detectProperty() === 'expression' ? currentFilter.expression || '' : currentFilter.pattern || ''\"\r\n    (input)=\"updateValuesList($event.target.value)\">\r\n  <mat-autocomplete #autoCompleteValues=\"matAutocomplete\"\r\n    (optionSelected)=\"changeProperty($event.option.value)\">\r\n    <mat-option\r\n      *ngFor=\"let value of filteredValues$ | async\"\r\n      matTooltipShowDelay=\"500\"\r\n      [value]=\"value\"\r\n      [matTooltip]=\"value\">\r\n      {{value}}\r\n    </mat-option>\r\n  </mat-autocomplete>\r\n  <button mat-button\r\n    *ngIf=\"isClearable() && inputClearable === 'selectProperty' && currentFilter.active\"\r\n    matSuffix\r\n    mat-icon-button\r\n    aria-label=\"Clear\"\r\n    [disabled]=\"!currentFilter.active\"\r\n    (click)=\"clearProperty()\">\r\n        <mat-icon svgIcon=\"close\"></mat-icon>\r\n  </button>\r\n</mat-form-field>\r\n\r\n<div class=\"igo-layer-button-group\">\r\n  <button\r\n    mat-icon-button\r\n    collapsibleButton\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"'igo.geo.filter.removeFilter' | translate\"\r\n    color=\"warn\"\r\n    (click)=\"deleteFilter()\">\r\n    <mat-icon svgIcon=\"delete\"></mat-icon>\r\n  </button>\r\n</div>\r\n\r\n<mat-form-field\r\nclass=\"snrc\"\r\n*ngIf=\"(currentFilterIsSpatial$ | async) && currentFilter.igoSpatialSelector === 'snrc'\"\r\n(mouseenter)=\"inputClearable = 'selectSNRC'\"\r\n(mouseleave)=\"inputClearable = undefined\"\r\n[floatLabel]=\"floatLabel\">\r\n  <input\r\n    matInput\r\n    [placeholder]=\"'igo.geo.filter.placeholderSnrc' | translate\"\r\n    [value]=\"currentFilter.igoSNRC\"\r\n    tooltip-position=\"above\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"currentFilter.igoSNRC ? currentFilter.igoSNRC : ''\"\r\n    (input)=\"changeSNRC($event.target.value)\">\r\n  <button\r\n    mat-button\r\n    *ngIf=\"currentFilter.igoSNRC\"\r\n    matSuffix\r\n    mat-icon-button\r\n    aria-label=\"Clear\"\r\n    [disabled]=\"!currentFilter.active && inputClearable === 'selectSNRC' && currentFilter.active\"\r\n    (click)=\"currentFilter.igoSNRC=''\">\r\n      <mat-icon svgIcon=\"close\"></mat-icon>\r\n  </button>\r\n  </mat-form-field>\r\n\r\n  <ng-container *ngIf=\"(currentFilterIsSpatial$ | async) && currentFilter.igoSpatialSelector === 'fixedExtent'\">\r\n    <button\r\n    mat-button\r\n    [disabled]=\"!currentFilter.active\"\r\n    *ngIf=\"currentFilter.igoSpatialSelector === 'fixedExtent'\"\r\n    matSuffix\r\n    mat-icon-button\r\n    [disabled]=\"!currentFilter.active\"\r\n    (click)=\"changeMapExtentGeometry()\"\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"'igo.geo.spatialSelector.btnSetExtent' | translate\">\r\n      <mat-icon svgIcon=\"arrow-expand-all\"></mat-icon>\r\n  </button>\r\n</ng-container>\r\n\r\n<br/>\r\n\r\n<mat-form-field\r\nclass=\"dualInput\"\r\n*ngIf=\"!isTemporalOperator() && ['lowerBoundary','begin'].indexOf(detectProperty(1)) !== -1\"\r\n(mouseenter)=\"inputClearable = 'selectProperty1'\"\r\n(mouseleave)=\"inputClearable = undefined\"\r\n[floatLabel]=\"floatLabel\">\r\n    <input\r\n      matInput\r\n      [placeholder]=\"'igo.geo.filter.placeholder' | translate\"\r\n      [disabled]=\"!currentFilter.active\"\r\n      [matAutocomplete]=\"autoDualValueOperator1\"\r\n      type=\"number\"\r\n      [value]=\"detectProperty(1) === 'lowerBoundary' ? currentFilter.lowerBoundary : currentFilter.begin\"\r\n      (input)=\"updateValuesList($event.target.value,1)\">\r\n    <mat-autocomplete #autoDualValueOperator1=\"matAutocomplete\"\r\n      (optionSelected)=\"changeNumericProperty($event.option.value,1)\">\r\n      <mat-option\r\n        *ngFor=\"let value of filteredValues$ | async\"\r\n        matTooltipShowDelay=\"500\"\r\n        [value]=\"value\"\r\n        [matTooltip]=\"value\">\r\n        {{value}}\r\n      </mat-option>\r\n    </mat-autocomplete>\r\n    <button mat-button\r\n      *ngIf=\"isClearable(1) && inputClearable === 'selectProperty1' && currentFilter.active\"\r\n      matSuffix\r\n      mat-icon-button\r\n      aria-label=\"Clear\"\r\n    [disabled]=\"!currentFilter.active\"\r\n      (click)=\"clearProperty(1)\">\r\n          <mat-icon svgIcon=\"close\"></mat-icon>\r\n    </button>\r\n</mat-form-field>\r\n\r\n<mat-form-field\r\n  class=\"dualInput\"\r\n  *ngIf=\"!isTemporalOperator() && ['upperBoundary','end'].indexOf(detectProperty(2)) !== -1\"\r\n  (mouseenter)=\"inputClearable = 'selectProperty2'\"\r\n  (mouseleave)=\"inputClearable = undefined\"\r\n  [floatLabel]=\"floatLabel\">\r\n    <input\r\n      matInput\r\n      [placeholder]=\"'igo.geo.filter.placeholder' | translate\"\r\n      [disabled]=\"!currentFilter.active\"\r\n      [matAutocomplete]=\"autoDualValueOperator2\"\r\n      type=\"number\"\r\n      [value]=\"detectProperty(2) === 'upperBoundary' ? currentFilter.upperBoundary : currentFilter.end\"\r\n      (input)=\"updateValuesList($event.target.value,2)\">\r\n    <mat-autocomplete #autoDualValueOperator2=\"matAutocomplete\"\r\n      (optionSelected)=\"changeNumericProperty($event.option.value,2)\">\r\n      <mat-option\r\n        *ngFor=\"let value of filteredValues$ | async\"\r\n        matTooltipShowDelay=\"500\"\r\n        [value]=\"value\"\r\n        [matTooltip]=\"value\">\r\n        {{value}}\r\n      </mat-option>\r\n    </mat-autocomplete>\r\n    <button mat-button\r\n      *ngIf=\"isClearable(2) && inputClearable === 'selectProperty2' && currentFilter.active\"\r\n      matSuffix\r\n      mat-icon-button\r\n      aria-label=\"Clear\"\r\n      [disabled]=\"!currentFilter.active\"\r\n      (click)=\"clearProperty(2)\">\r\n          <mat-icon svgIcon=\"close\"></mat-icon>\r\n    </button>\r\n</mat-form-field>\r\n\r\n<igo-ogc-filter-time *ngIf=\"isTemporalOperator()\"\r\n  [(datasource)]=\"datasource\"\r\n  [(currentFilter)]=\"currentFilter\"\r\n  (changeProperty)=\"changeProperty($event.value, $event.pos)\">\r\n</igo-ogc-filter-time>\r\n\r\n<!--\r\nTODO C'EST PERTINENT je crois\r\n<mat-form-field class=\"field\" *ngIf=\"!(currentFilterIsSpatial$ | async) && (fields$| async) && (fields$| async).length === 1 &&  (fields$| async)[0].name === ''\">\r\n<input [disabled]=\"!currentFilter.active\" matInput #fieldPerUser (keyup)=\"changeProperty(currentFilter,'propertyName',fieldPerUser.value)\"\r\n  (blur)=\"changeProperty(currentFilter,'propertyName',fieldPerUser.value)\" [(ngModel)]=\"currentFilter.propertyName\">\r\n<button mat-button *ngIf=\"currentFilter.propertyName\" matSuffix mat-icon-button aria-label=\"Clear\" (click)=\"currentFilter.propertyName=''\">\r\n  <mat-icon svgIcon=\"close\"></mat-icon>\r\n</button>\r\n</mat-form-field>\r\n\r\n\r\n\r\n<mat-checkbox labelPosition='before' (change)=\"changeCaseSensitive($event)\" [(ngModel)]=\"currentFilter.matchCase\">\r\n  {{('igo.geo.operators.caseSensitive') | translate}}\r\n</mat-checkbox>\r\n\r\n</mat-list-item> -->\r\n","import { Component, Input, OnInit } from '@angular/core';\r\nimport { FloatLabelType } from '@angular/material/form-field';\r\nimport { BehaviorSubject, Observable, of } from 'rxjs';\r\n\r\nimport {\r\n  OgcFilterableDataSource,\r\n  OgcFiltersOptions\r\n} from '../../filter/shared/ogc-filter.interface';\r\nimport { OgcFilterWriter } from '../../filter/shared/ogc-filter';\r\nimport { WktService } from '../../wkt/shared/wkt.service';\r\nimport { IgoMap } from '../../map';\r\nimport { SourceFieldsOptionsParams } from '../../datasource/shared/datasources/datasource.interface';\r\nimport { OgcFilterOperator } from '../../filter/shared/ogc-filter.enum';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filter-form',\r\n  templateUrl: './ogc-filter-form.component.html',\r\n  styleUrls: ['./ogc-filter-form.component.scss']\r\n})\r\nexport class OgcFilterFormComponent implements OnInit {\r\n  ogcFilterOperator = OgcFilterOperator;\r\n  filteredValues$: Observable<string[]>;\r\n  filteredFields$: Observable<SourceFieldsOptionsParams[]>;\r\n  public allOgcFilterOperators;\r\n  public ogcFilterOperators$ = new BehaviorSubject<{ [key: string]: any }>(\r\n    undefined\r\n  );\r\n  public igoSpatialSelectors;\r\n  public value = '';\r\n  public inputOperator;\r\n  public selectedField$ = new BehaviorSubject<SourceFieldsOptionsParams>(\r\n    undefined\r\n  );\r\n  public fields$ = new BehaviorSubject<SourceFieldsOptionsParams[]>([]);\r\n  public color = 'primary';\r\n  public disabled;\r\n  public currentFilterIsSpatial$ = new BehaviorSubject<boolean>(false);\r\n  public defaultStepMillisecond = 6000;\r\n  public inputClearable: string;\r\n\r\n  @Input() refreshFilters: () => void;\r\n\r\n  @Input() datasource: OgcFilterableDataSource;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() currentFilter: any;\r\n\r\n  set snrc(value: any) {\r\n    const checkSNRC50k = /^\\d{2}[a-l][0,1][0-9]$/gi;\r\n    const checkSNRC250k = /^\\d{2}[a-p]$/gi;\r\n    const checkSNRC1m = /^\\d{2}$/gi;\r\n    if (\r\n      checkSNRC1m.test(value) ||\r\n      checkSNRC250k.test(value) ||\r\n      checkSNRC50k.test(value)\r\n    ) {\r\n      this._snrc = value;\r\n      this.currentFilter.igoSNRC = value;\r\n    }\r\n  }\r\n\r\n  get snrc(): any {\r\n    return this._snrc;\r\n  }\r\n\r\n  private _snrc = '';\r\n\r\n  @Input() floatLabel: FloatLabelType = 'never';\r\n\r\n  get activeFilters() {\r\n    return this.datasource.options.ogcFilters.interfaceOgcFilters.filter(\r\n      (f) => f.active === true\r\n    );\r\n  }\r\n\r\n  get allowedOperators() {\r\n    return new OgcFilterWriter().computeAllowedOperators(\r\n      this.fields$.value,\r\n      this.currentFilter.propertyName,\r\n      this.datasource.options.ogcFilters.allowedOperatorsType\r\n    );\r\n  }\r\n\r\n  constructor(private wktService: WktService) {\r\n    // TODO: Filter permitted operator based on wfscapabilities\r\n    // Need to work on regex on XML capabilities because\r\n    // comaparison operator's name varies between WFS servers...\r\n    // Ex: IsNull vs PropertyIsNull vs IsNil ...\r\n    this.allOgcFilterOperators = new OgcFilterWriter().operators;\r\n    this.ogcFilterOperators$.next(this.allOgcFilterOperators);\r\n    this.igoSpatialSelectors = [\r\n      {\r\n        type: 'fixedExtent'\r\n      },\r\n      {\r\n        type: 'snrc'\r\n      }\r\n    ];\r\n    // TODO: selectFeature & drawFeature\r\n  }\r\n\r\n  ngOnInit() {\r\n\r\n    if ( this.datasource.options.sourceFields) {\r\n      const sFields = this.datasource.options.sourceFields.filter(\r\n        (sf) =>\r\n          sf.excludeFromOgcFilters === undefined || !sf.excludeFromOgcFilters\r\n      );\r\n      sFields.map((sfs) => {\r\n        if (sfs.values) {\r\n          sfs.values.sort();\r\n        }\r\n      });\r\n      this.fields$.next(sFields);\r\n    }\r\n\r\n    this.updateFieldsList();\r\n    this.selectedField$.next(\r\n      this.fields$.value.find((f) => f.name === this.currentFilter.propertyName)\r\n    );\r\n    this.updateValuesList();\r\n    this.selectedField$.subscribe((f) => {\r\n      this.ogcFilterOperators$.next(this.allowedOperators);\r\n      if (\r\n        Object.keys(this.allowedOperators).indexOf(\r\n          this.currentFilter.operator\r\n        ) === -1\r\n      ) {\r\n        this.currentFilter.operator = Object.keys(this.allowedOperators)[0];\r\n        this.currentFilter.operator = Object.keys(this.allowedOperators)[0];\r\n      }\r\n      this.updateValuesList();\r\n    });\r\n    this.currentFilterIsSpatial();\r\n  }\r\n\r\n  updateFieldsList(value?: string) {\r\n    this.filteredFields$ =\r\n      value && value.length > 0 ? of(this._filterFields(value)) : this.fields$;\r\n    if (this.fields$.value.find((f) => f.name === value)) {\r\n      this.changeField(value);\r\n    }\r\n  }\r\n\r\n  updateValuesList(value?: string, pos?: number) {\r\n    this.filteredValues$ =\r\n      value && value.length > 0\r\n        ? of(this._filterValues(value))\r\n        : this.selectedField$.value\r\n        ? of(this.selectedField$.value.values)\r\n        : of([]);\r\n    if (value && value.length >= 1) {\r\n      this.changeProperty(value, pos);\r\n    }\r\n  }\r\n\r\n  private _filterFields(value: string): SourceFieldsOptionsParams[] {\r\n    const keywordRegex = new RegExp(\r\n      value.normalize('NFD').replace(/[\\u0300-\\u036f]/g, ''),\r\n      'gi'\r\n    );\r\n    return this.fields$.value.filter((val) =>\r\n      keywordRegex.test(\r\n        val.alias.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '')\r\n      )\r\n    );\r\n  }\r\n\r\n  private _filterValues(value: string): string[] {\r\n    const keywordRegex = new RegExp(\r\n      value\r\n        .toString()\r\n        .normalize('NFD')\r\n        .replace(/[\\u0300-\\u036f]/g, ''),\r\n      'gi'\r\n    );\r\n    return this.selectedField$.value.values.filter((val) =>\r\n      val && keywordRegex.test(\r\n        val\r\n          .toString()\r\n          .normalize('NFD')\r\n          .replace(/[\\u0300-\\u036f]/g, '')\r\n      )\r\n    );\r\n  }\r\n\r\n  clearSelectedField() {\r\n    this.currentFilter.propertyName = '';\r\n    this.selectedField$.next(undefined);\r\n    this.clearProperty();\r\n  }\r\n\r\n  isClearable(pos?: number) {\r\n    const detectedProperty = this.detectProperty(pos);\r\n    if (detectedProperty) {\r\n      return this.currentFilter[detectedProperty];\r\n    }\r\n  }\r\n  clearProperty(pos?: number) {\r\n    // this.autoCompleteInputValues.closePanel();\r\n    const detectedProperty = this.detectProperty(pos);\r\n    if (detectedProperty) {\r\n      return (this.currentFilter[detectedProperty] = '');\r\n    }\r\n  }\r\n\r\n  toggleFilterState(event) {\r\n    this.datasource.options.ogcFilters.interfaceOgcFilters.find(\r\n      (f) => f.filterid === this.currentFilter.filterid\r\n    ).active = event.checked;\r\n    this.refreshFilters();\r\n  }\r\n\r\n  deleteFilter() {\r\n    const ogcFilters: OgcFiltersOptions = this.datasource.options.ogcFilters;\r\n    ogcFilters.interfaceOgcFilters = ogcFilters.interfaceOgcFilters.filter(\r\n      (f) => f.filterid !== this.currentFilter.filterid\r\n    );\r\n    this.refreshFilters();\r\n  }\r\n\r\n  changeLogical(logical: string) {\r\n    this.currentFilter.parentLogical = logical;\r\n    this.refreshFilters();\r\n  }\r\n\r\n  changeOperator(operator: string) {\r\n    this.currentFilter.operator = operator;\r\n    this.currentFilterIsSpatial();\r\n\r\n    if (\r\n      this.currentFilterIsSpatial$.value &&\r\n      this.currentFilter.wkt_geometry.length === 0\r\n    ) {\r\n      this.changeSpatialSelector(this.currentFilter.igoSpatialSelector);\r\n    } else {\r\n      this.refreshFilters();\r\n    }\r\n  }\r\n\r\n  changeField(field: string) {\r\n    this.currentFilter.propertyName = field;\r\n    this.selectedField$.next(\r\n      this.fields$.value.find((f) => f.name === this.currentFilter.propertyName)\r\n    );\r\n    this.refreshFilters();\r\n  }\r\n\r\n  // Issue with mapserver 7.2 and Postgis layers. Fixed in 7.4\r\n  // Due to this issue, the checkbox is hide.\r\n  changeCaseSensitive(matchCase) {\r\n    this.currentFilter.matchCase = matchCase.checked;\r\n    this.refreshFilters();\r\n  }\r\n\r\n  changeProperty(value: any, pos?: number, refreshFilter = true) {\r\n    const detectedProperty = this.detectProperty(pos);\r\n    if (detectedProperty) {\r\n      this.datasource.options.ogcFilters.interfaceOgcFilters.find(\r\n        (f) => f.filterid === this.currentFilter.filterid\r\n      )[detectedProperty] = value;\r\n\r\n      if ( refreshFilter ) {\r\n        this.refreshFilters();\r\n      }\r\n    }\r\n  }\r\n\r\n  changeNumericProperty(value, pos: number) {\r\n    this.changeProperty(parseFloat(value), pos);\r\n  }\r\n\r\n  changeSpatialSelector(value: any) {\r\n    this.currentFilter.igoSpatialSelector = value;\r\n\r\n    if (value === 'fixedExtent') {\r\n      this.changeMapExtentGeometry(false);\r\n    }\r\n    this.currentFilterIsSpatial();\r\n    this.refreshFilters();\r\n  }\r\n\r\n  changeSNRC(value: any) {\r\n    this.snrc = value;\r\n    this.changeSNRCGeometry();\r\n  }\r\n\r\n  changeSNRCGeometry() {\r\n    const interfaceOgcFilter = this.datasource.options.ogcFilters.interfaceOgcFilters.find(\r\n      (f) => f.filterid === this.currentFilter.filterid\r\n    );\r\n    if (!interfaceOgcFilter) {\r\n      return;\r\n    }\r\n\r\n    if (this.snrc && this.currentFilter.igoSpatialSelector === 'snrc') {\r\n      this.currentFilter.wkt_geometry = this.wktService.snrcToWkt(\r\n        this.snrc,\r\n        this.map.projection\r\n      ).wktPoly;\r\n    }\r\n    this.refreshFilters();\r\n  }\r\n\r\n  changeMapExtentGeometry(refresh: boolean = true) {\r\n    const interfaceOgcFilter = this.datasource.options.ogcFilters.interfaceOgcFilters.find(\r\n      (f) => f.filterid === this.currentFilter.filterid\r\n    );\r\n    if (!interfaceOgcFilter) {\r\n      return;\r\n    }\r\n\r\n    if (this.currentFilter.igoSpatialSelector === 'fixedExtent') {\r\n      this.currentFilter.wkt_geometry = this.wktService.extentToWkt(\r\n        this.map.projection,\r\n        this.map.viewController.getExtent(),\r\n        this.map.projection\r\n      ).wktPoly;\r\n    }\r\n    if (refresh) {\r\n      this.refreshFilters();\r\n    }\r\n  }\r\n\r\n  detectProperty(pos?: number): string {\r\n    switch (this.currentFilter.operator) {\r\n      case OgcFilterOperator.PropertyIsNotEqualTo:\r\n      case OgcFilterOperator.PropertyIsEqualTo:\r\n      case OgcFilterOperator.PropertyIsGreaterThan:\r\n      case OgcFilterOperator.PropertyIsGreaterThanOrEqualTo:\r\n      case OgcFilterOperator.PropertyIsLessThan:\r\n      case OgcFilterOperator.PropertyIsLessThanOrEqualTo:\r\n        return 'expression';\r\n      case OgcFilterOperator.PropertyIsLike:\r\n        return 'pattern';\r\n      case OgcFilterOperator.PropertyIsBetween:\r\n        return pos && pos === 1\r\n          ? 'lowerBoundary'\r\n          : pos && pos === 2\r\n          ? 'upperBoundary'\r\n          : undefined;\r\n      case OgcFilterOperator.During:\r\n        return pos && pos === 1\r\n          ? 'begin'\r\n          : pos && pos === 2\r\n          ? 'end'\r\n          : undefined;\r\n      default:\r\n        return;\r\n    }\r\n  }\r\n\r\n  private currentFilterIsSpatial() {\r\n    let isSpatial = false;\r\n    if (this.currentFilter) {\r\n      isSpatial =\r\n        [\r\n          OgcFilterOperator.Contains,\r\n          OgcFilterOperator.Intersects,\r\n          OgcFilterOperator.Within\r\n        ].indexOf(this.currentFilter.operator) !== -1;\r\n    }\r\n    this.currentFilterIsSpatial$.next(isSpatial);\r\n  }\r\n\r\n  isTemporalOperator() {\r\n    return (\r\n      this.currentFilter.operator.toLowerCase() ===\r\n      this.ogcFilterOperator.During.toLowerCase()\r\n    );\r\n  }\r\n}\r\n","<igo-ogc-filter-selection\r\n  *ngIf=\"!advancedOgcFilters\"\r\n  igoListItem\r\n  [refreshFilters]=\"refreshFunc\"\r\n  [datasource]=\"datasource\"\r\n  [map]=\"map\"\r\n  [currentFilter]=\"currentFilter\">\r\n</igo-ogc-filter-selection>\r\n\r\n<ng-template \r\n*ngIf=\"advancedOgcFilters && datasource.options.ogcFilters.editable\"\r\nngFor let-currentFilter \r\n[ngForOf]=\"datasource.options.ogcFilters.interfaceOgcFilters\">\r\n<igo-ogc-filter-form\r\n  [currentFilter]=\"currentFilter\"\r\n  [refreshFilters]=\"refreshFunc\"\r\n  [datasource]=\"datasource\"\r\n  [map]=\"map\">\r\n</igo-ogc-filter-form>\r\n</ng-template>","import { Component, Input } from '@angular/core';\r\nimport { OgcFilterableDataSource } from '../shared/ogc-filter.interface';\r\nimport { IgoMap } from '../../map';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filterable-form',\r\n  templateUrl: './ogc-filterable-form.component.html'\r\n})\r\nexport class OgcFilterableFormComponent {\r\n\r\n  @Input() datasource: OgcFilterableDataSource;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() refreshFilters: () => void;\r\n\r\n  get refreshFunc() {\r\n    return this.refreshFilters;\r\n  }\r\n\r\n  get advancedOgcFilters(): boolean {\r\n    if (this.datasource.options.ogcFilters) {\r\n      return this.datasource.options.ogcFilters.advancedOgcFilters;\r\n    }\r\n    return;\r\n  }\r\n\r\n  get currentFilter(): any {\r\n    return this.datasource.options.ogcFilters.interfaceOgcFilters ?\r\n    this.datasource.options.ogcFilters.interfaceOgcFilters[0] : undefined;\r\n  }\r\n\r\n  public color = 'primary';\r\n\r\n  constructor() {}\r\n}\r\n","<mat-list-item>\r\n\r\n  <mat-icon\r\n    *ngIf=\"header\"\r\n    class=\"igo-chevron\"\r\n    mat-list-avatar\r\n    igoCollapse [target]=\"ogcFilters\"\r\n    [collapsed]=\"filtersCollapsed\"\r\n    (click)=\"toggleFiltersCollapsed()\"\r\n    svgIcon=\"chevron-up\">\r\n  </mat-icon>\r\n  <h4 (click)=\"toggleLegendOnClick()\" *ngIf=\"header\" [ngStyle]=\"{'cursor': filtersCollapsed ? 'default' : 'pointer'}\" matLine [matTooltip]=\"layer.title\" matTooltipShowDelay=\"500\">{{layer.title}}</h4>\r\n    <button *ngIf=\"isAdvancedOgcFilters() && filtersAreEditable\" [disabled]=\"addFilterDisabled()\" mat-icon-button tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"'igo.geo.filter.addFilter' | translate\" [color]=\"color\" (click)=\"addFilterToSequence()\">\r\n      <mat-icon svgIcon=\"plus\"></mat-icon>\r\n    </button>\r\n    <button *ngIf=\"header\"\r\n      mat-icon-button\r\n      [color]=\"layer.visible ? 'primary' : 'default'\"\r\n      collapsibleButton\r\n      tooltip-position=\"below\"\r\n      matTooltipShowDelay=\"500\"\r\n      [matTooltip]=\"layer.visible ?\r\n                    ('igo.geo.layer.hideLayer' | translate) :\r\n                    ('igo.geo.layer.showLayer' | translate)\"\r\n      (click)=\"layer.visible = !layer.visible\">\r\n      <mat-icon\r\n        [ngClass]=\"{disabled: (inResolutionRange$ | async)===false}\"\r\n        [svgIcon]=\"layer.visible ? 'eye' : 'eye-off'\">\r\n      </mat-icon>\r\n    </button>\r\n</mat-list-item>\r\n\r\n<div #ogcFilters>\r\n    <div *ngIf=\"header\" #legend class=\"igo-layer-legend-container\">\r\n      <igo-layer-legend *ngIf=\"showLegend$ | async\" [layer]=\"layer\">\r\n      </igo-layer-legend>\r\n    </div>\r\n  <igo-ogc-filterable-form [datasource]=\"datasource\" [map]=\"map\" [refreshFilters]=\"refreshFunc\">\r\n  </igo-ogc-filterable-form>\r\n\r\n  <section *ngIf=\"hasSelector && filtersAreEditable\" class=\"mat-typography advancedOgcFilters\">\r\n    <mat-divider></mat-divider>\r\n    <mat-checkbox labelPosition='before' (change)=\"changeOgcFilterType($event)\"\r\n      [(ngModel)]=\"datasource.options.ogcFilters.advancedOgcFilters\">\r\n      {{'igo.geo.filter.advancedOgcFilters' | translate}}\r\n    </mat-checkbox>\r\n  </section>\r\n</div>","import { Component, Input, OnDestroy, OnInit } from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { WMSDataSource } from '../../datasource/shared/datasources/wms-datasource';\r\nimport { WFSDataSourceOptionsParams } from '../../datasource/shared/datasources/wfs-datasource.interface';\r\nimport { OgcFilterOperator } from '../../filter/shared/ogc-filter.enum';\r\n\r\nimport {\r\n  OgcFilterableDataSource,\r\n  OgcFiltersOptions,\r\n  OgcInterfaceFilterOptions\r\n} from '../shared/ogc-filter.interface';\r\nimport { OGCFilterService } from '../shared/ogc-filter.service';\r\nimport { IgoMap } from '../../map';\r\nimport { OgcFilterWriter } from '../shared/ogc-filter';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filterable-item',\r\n  templateUrl: './ogc-filterable-item.component.html',\r\n  styleUrls: ['./ogc-filterable-item.component.scss']\r\n})\r\nexport class OgcFilterableItemComponent implements OnInit, OnDestroy {\r\n  public color = 'primary';\r\n  private lastRunOgcFilter;\r\n  private defaultLogicalParent = OgcFilterOperator.And;\r\n  public hasActiveSpatialFilter = false;\r\n  public filtersAreEditable = true;\r\n  public filtersCollapsed = true;\r\n  public hasSelector: boolean = false;\r\n  showLegend$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  inResolutionRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n  private resolution$$: Subscription;\r\n  private ogcFilterWriter;\r\n\r\n  @Input() layer: Layer;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() header: boolean = true;\r\n\r\n  get refreshFunc() {\r\n    return this.refreshFilters.bind(this);\r\n  }\r\n\r\n  get datasource(): OgcFilterableDataSource {\r\n    return this.layer.dataSource as OgcFilterableDataSource;\r\n  }\r\n\r\n  constructor(private ogcFilterService: OGCFilterService) {\r\n    this.ogcFilterWriter = new OgcFilterWriter();\r\n  }\r\n\r\n  ngOnInit() {\r\n    const ogcFilters = this.datasource.options.ogcFilters;\r\n    if (\r\n      (ogcFilters.pushButtons && ogcFilters.pushButtons.bundles.length > 0) ||\r\n      (ogcFilters.checkboxes && ogcFilters.checkboxes.bundles.length > 0) ||\r\n      (ogcFilters.radioButtons && ogcFilters.radioButtons.bundles.length > 0) ||\r\n      (ogcFilters.select && ogcFilters.select.bundles.length > 0) ||\r\n      (ogcFilters.autocomplete && ogcFilters.autocomplete.bundles.length > 0)) {\r\n      if (ogcFilters.advancedOgcFilters === undefined) {\r\n        ogcFilters.advancedOgcFilters = false;\r\n      }\r\n      this.hasSelector = true;\r\n    }\r\n\r\n    switch (this.datasource.options.type) {\r\n      case 'wms':\r\n        this.ogcFilterService.setOgcWMSFiltersOptions(this.datasource);\r\n        break;\r\n      case 'wfs':\r\n        this.ogcFilterService.setOgcWFSFiltersOptions(this.datasource);\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n\r\n    if (ogcFilters) {\r\n      if (ogcFilters.interfaceOgcFilters) {\r\n        this.lastRunOgcFilter = JSON.parse(\r\n          JSON.stringify(ogcFilters.interfaceOgcFilters)\r\n        );\r\n        if (\r\n          ogcFilters.interfaceOgcFilters.filter(f => f.wkt_geometry).length >= 1\r\n        ) {\r\n          this.hasActiveSpatialFilter = true;\r\n        }\r\n      }\r\n\r\n      this.filtersAreEditable = ogcFilters.editable\r\n        ? ogcFilters.editable\r\n        : false;\r\n    }\r\n\r\n    const resolution$ = this.layer.map.viewController.resolution$;\r\n    this.resolution$$ = resolution$.subscribe(() => {\r\n      this.inResolutionRange$.next(this.layer.isInResolutionsRange);\r\n    });\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this.resolution$$.unsubscribe();\r\n  }\r\n\r\n  addFilterToSequence() {\r\n    this.filtersCollapsed = false;\r\n    const interfaceOgcFilters: OgcInterfaceFilterOptions[] = this.datasource\r\n      .options.ogcFilters.interfaceOgcFilters;\r\n    const arr = interfaceOgcFilters || [];\r\n    const lastLevel = arr.length === 0 ? 0 : arr[arr.length - 1].level;\r\n    let firstFieldName = '';\r\n    const includedFields = this.datasource.options.sourceFields.filter(f => !f.excludeFromOgcFilters);\r\n    if (includedFields.length > 0) {\r\n      firstFieldName =\r\n        includedFields[0].name === undefined ? '' : includedFields[0].name;\r\n    }\r\n    let fieldNameGeometry;\r\n    const datasourceOptions = this.datasource\r\n      .options as WFSDataSourceOptionsParams;\r\n    if (datasourceOptions.fieldNameGeometry) {\r\n      fieldNameGeometry = datasourceOptions.fieldNameGeometry;\r\n    } else if (\r\n      (this.datasource.options as any).paramsWFS &&\r\n      (this.datasource.options as any).paramsWFS.fieldNameGeometry\r\n    ) {\r\n      fieldNameGeometry = (this.datasource.options as any).paramsWFS\r\n        .fieldNameGeometry;\r\n    }\r\n    const allowedOperators = this.ogcFilterWriter.computeAllowedOperators(\r\n      this.datasource.options.sourceFields,\r\n      firstFieldName,\r\n      this.datasource.options.ogcFilters.allowedOperatorsType);\r\n    const firstOperatorName = Object.keys(allowedOperators)[0];\r\n\r\n    arr.push(\r\n      this.ogcFilterWriter.addInterfaceFilter(\r\n        {\r\n          propertyName: firstFieldName,\r\n          operator: firstOperatorName,\r\n          active: true,\r\n          igoSpatialSelector: 'fixedExtent',\r\n          srsName: this.map.projection,\r\n        } as OgcInterfaceFilterOptions,\r\n        fieldNameGeometry,\r\n        lastLevel,\r\n        this.defaultLogicalParent\r\n      )\r\n    );\r\n    this.datasource.options.ogcFilters.interfaceOgcFilters = arr;\r\n  }\r\n\r\n  refreshFilters(force?: boolean) {\r\n    if (force === true) {\r\n      this.lastRunOgcFilter = undefined;\r\n    }\r\n    const ogcFilters: OgcFiltersOptions = this.datasource.options.ogcFilters;\r\n    const activeFilters = ogcFilters.interfaceOgcFilters ?\r\n      ogcFilters.interfaceOgcFilters.filter(f => f.active === true) : [];\r\n    if (activeFilters.length === 0) {\r\n      ogcFilters.filters = undefined;\r\n      ogcFilters.filtered = false;\r\n    }\r\n    if (activeFilters.length > 1) {\r\n      activeFilters[0].parentLogical = activeFilters[1].parentLogical;\r\n    }\r\n    if (\r\n      activeFilters.filter(\r\n        af => ['Contains', 'Intersects', 'Within'].indexOf(af.operator) !== -1\r\n      ).length === 0\r\n    ) {\r\n      this.hasActiveSpatialFilter = false;\r\n    } else {\r\n      this.hasActiveSpatialFilter = true;\r\n    }\r\n\r\n    if (\r\n      !(JSON.stringify(this.lastRunOgcFilter) === JSON.stringify(activeFilters))\r\n    ) {\r\n      if (this.layer.dataSource.options.type === 'wfs') {\r\n        const ogcDataSource: any = this.layer.dataSource;\r\n        const ogcLayer: OgcFiltersOptions = ogcDataSource.options.ogcFilters;\r\n        ogcLayer.filters = this.ogcFilterWriter.rebuiltIgoOgcFilterObjectFromSequence(\r\n          activeFilters\r\n        );\r\n        this.layer.dataSource.ol.refresh();\r\n      } else if (\r\n        this.layer.dataSource.options.type === 'wms' &&\r\n        ogcFilters.enabled\r\n      ) {\r\n        let rebuildFilter = '';\r\n        if (activeFilters.length >= 1) {\r\n          const ogcDataSource: any = this.layer.dataSource;\r\n          const ogcLayer: OgcFiltersOptions = ogcDataSource.options.ogcFilters;\r\n          ogcLayer.filters = this.ogcFilterWriter.rebuiltIgoOgcFilterObjectFromSequence(\r\n            activeFilters\r\n          );\r\n          rebuildFilter = this.ogcFilterWriter.buildFilter(\r\n            ogcLayer.filters,\r\n            undefined,\r\n            undefined,\r\n            (this.layer.dataSource.options as any).fieldNameGeometry,\r\n            ogcDataSource.options\r\n          );\r\n        }\r\n        this.ogcFilterService.filterByOgc(\r\n          this.datasource as WMSDataSource,\r\n          rebuildFilter\r\n        );\r\n        this.datasource.options.ogcFilters.filtered =\r\n          activeFilters.length === 0 ? false : true;\r\n      }\r\n\r\n      this.lastRunOgcFilter = JSON.parse(JSON.stringify(activeFilters));\r\n    } else {\r\n      // identical filter. Nothing triggered\r\n    }\r\n    (this.layer.dataSource as OgcFilterableDataSource).setOgcFilters(ogcFilters, true);\r\n  }\r\n\r\n  public setVisible() {\r\n    this.layer.visible = true;\r\n  }\r\n\r\n  public isAdvancedOgcFilters(): boolean {\r\n    return this.datasource.options.ogcFilters.advancedOgcFilters;\r\n  }\r\n\r\n  public addFilterDisabled(): boolean {\r\n    return (\r\n      !this.datasource.options.sourceFields ||\r\n      this.datasource.options.sourceFields.length === 0\r\n    );\r\n  }\r\n\r\n  private changeOgcFiltersAdvancedOgcFilters(value: boolean) {\r\n    this.datasource.options.ogcFilters.advancedOgcFilters = value;\r\n  }\r\n\r\n  changeOgcFilterType(isAdvancedOgcFilters) {\r\n    this.changeOgcFiltersAdvancedOgcFilters(isAdvancedOgcFilters.checked);\r\n    if (isAdvancedOgcFilters.checked) {\r\n      this.refreshFilters(true);\r\n    }\r\n  }\r\n\r\n  private toggleLegend(collapsed: boolean) {\r\n    this.layer.legendCollapsed = collapsed;\r\n    this.showLegend$.next(!collapsed);\r\n  }\r\n\r\n  toggleLegendOnClick() {\r\n    if (!this.filtersCollapsed) {\r\n      this.toggleLegend(this.showLegend$.value);\r\n    }\r\n  }\r\n\r\n  toggleFiltersCollapsed() {\r\n    this.filtersCollapsed = !this.filtersCollapsed;\r\n  }\r\n}\r\n","<igo-list [navigation]=\"false\" [selection]=\"false\">\r\n  <ng-template ngFor let-layer [ngForOf]=\"layers | filterableDataSource: 'ogc'\">\r\n    <igo-ogc-filterable-item igoListItem [header]=\"true\" [layer]=\"layer\" \r\n    [map]=\"layer.map\" ></igo-ogc-filterable-item>\r\n  </ng-template>\r\n</igo-list>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { IgoMap } from '../../map';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filterable-list',\r\n  templateUrl: './ogc-filterable-list.component.html',\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class OgcFilterableListComponent {\r\n\r\n  @Input() layers: Layer[];\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  constructor() {}\r\n}\r\n","<button\r\n  *ngIf=\"header && options.ogcFilters && options.ogcFilters.enabled &&\r\n  (options.ogcFilters.pushButtons || options.ogcFilters.checkboxes || options.ogcFilters.radioButtons || options.ogcFilters.select || options.ogcFilters.autocomplete\r\n    || options.ogcFilters.editable)\"\r\n  mat-icon-button\r\n  collapsibleButton\r\n  tooltip-position=\"below\"\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.filter.filterBy' | translate\"\r\n  [color]=\"color\">\r\n  <mat-icon [matBadge]=\"badge\" matBadgeColor=\"warn\" matBadgeSize=\"medium\" svgIcon=\"filter\"></mat-icon>\r\n</button>\r\n\r\n<div #ogcFilter class=\"igo-layer-actions-container\"\r\n*ngIf=\"options.ogcFilters && options.ogcFilters.enabled &&\r\n(options.ogcFilters.pushButtons || options.ogcFilters.checkboxes || options.ogcFilters.radioButtons || options.ogcFilters.select || options.ogcFilters.autocomplete\r\n  || options.ogcFilters.editable)\">\r\n  <igo-ogc-filterable-item\r\n    *ngIf=\"ogcFilterCollapse && options.ogcFilters.enabled\"\r\n    igoListItem\r\n    [header]=\"false\"\r\n    [map]=\"layer.map\"\r\n    [layer]=\"layer\">\r\n  </igo-ogc-filterable-item>\r\n</div>\r\n","import { Component, Input, ChangeDetectionStrategy, OnInit } from '@angular/core';\r\n\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { IgoMap } from '../../map';\r\nimport { OgcFilterableDataSourceOptions, IgoOgcSelector } from '../shared/ogc-filter.interface';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filter-button',\r\n  templateUrl: './ogc-filter-button.component.html',\r\n  styleUrls: ['./ogc-filter-button.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class OgcFilterButtonComponent implements OnInit {\r\n\r\n  public options: OgcFilterableDataSourceOptions;\r\n\r\n  get badge() {\r\n    const filter = this.options.ogcFilters as any;\r\n    let cnt = 0;\r\n    if (filter && !filter.advancedOgcFilters) {\r\n      if (filter.pushButtons) {\r\n        const pushButtons = filter.pushButtons as IgoOgcSelector;\r\n        const currentPushButtonGroup = pushButtons.groups.find(gr => gr.enabled);\r\n        let cntPushButtons = 0;\r\n        if (currentPushButtonGroup) {\r\n          currentPushButtonGroup.computedSelectors?.map(cb => cntPushButtons += (cb.selectors as any)?.filter(\r\n            button => button.enabled).length);\r\n        }\r\n        cnt += cntPushButtons;\r\n      }\r\n      if (filter.checkboxes) {\r\n        const checkboxes = filter.checkboxes as IgoOgcSelector;\r\n        const currentCheckboxGroup = checkboxes.groups.find(gr => gr.enabled);\r\n        let cntCheckboxes = 0;\r\n        if (currentCheckboxGroup) {\r\n          currentCheckboxGroup.computedSelectors?.map(cb => cntCheckboxes += (cb.selectors as any)?.filter(\r\n            checkbox => checkbox.enabled).length);\r\n        }\r\n        cnt += cntCheckboxes;\r\n      }\r\n      if (filter.radioButtons) {\r\n        const radioButtons = filter.radioButtons as IgoOgcSelector;\r\n        const currentRadioButtonsGroup = radioButtons.groups.find(gr => gr.enabled);\r\n        let cntRadioButtons = 0;\r\n        if (currentRadioButtonsGroup) {\r\n          currentRadioButtonsGroup.computedSelectors?.map(cb => cntRadioButtons += (cb.selectors as any)?.filter(\r\n            radio => radio.enabled).length);\r\n        }\r\n        cnt += cntRadioButtons;\r\n      }\r\n      if (filter.select) {\r\n        const select = filter.select as IgoOgcSelector;\r\n        const currentSelectGroup = select.groups.find(gr => gr.enabled);\r\n        let cntSelect = 0;\r\n        if (currentSelectGroup) {\r\n          currentSelectGroup.computedSelectors?.map(cb => cntSelect += (cb.selectors as any)?.filter(\r\n            multi => multi.enabled).length);\r\n        }\r\n        cnt += cntSelect;\r\n      }\r\n      if (filter.autocomplete) {\r\n        const autocomplete = filter.autocomplete as IgoOgcSelector;\r\n        const currentAutocompleteGroup = autocomplete.groups.find(gr => gr.enabled);\r\n        let cntAutocomplete = 0;\r\n        if (currentAutocompleteGroup) {\r\n          currentAutocompleteGroup.computedSelectors?.map(cb => cntAutocomplete += (cb.selectors as any)?.filter(\r\n            autocomplete => autocomplete.enabled).length);\r\n        }\r\n        cnt += cntAutocomplete;\r\n      }\r\n    } else if (filter && filter.filters && !filter.filters.filters) {\r\n      return 1;\r\n    } else if (filter && filter.filters && filter.filters.filters) {\r\n      return filter.filters.filters.length;\r\n    }\r\n    if (filter.filters && filter.filters.operator === 'During' && filter.filters.active &&\r\n      filter.interfaceOgcFilters && filter.interfaceOgcFilters[0].active) {\r\n      const filterActiveValue = filter.interfaceOgcFilters[0];\r\n      if (filter.filters.calendarModeYear) {\r\n        // year mode check just year\r\n        if ((filterActiveValue.begin.substring(0,4) !== this.options.minDate.substring(0,4) ) ||\r\n        (filterActiveValue.end.substring(0,4) !== this.options.maxDate.substring(0,4) )) {\r\n          cnt += 1;\r\n        }\r\n      } else if ((filterActiveValue.begin !== this.options.minDate) || (filterActiveValue.end !== this.options.maxDate)) {\r\n        cnt += 1;\r\n      }\r\n    }\r\n    return cnt > 0 ? cnt : undefined;\r\n  }\r\n\r\n  @Input()\r\n  get layer(): Layer {\r\n    return this._layer;\r\n  }\r\n  set layer(value: Layer) {\r\n    this._layer = value;\r\n    if (value) {\r\n      this.options = this.layer.dataSource.options as OgcFilterableDataSourceOptions;\r\n    }\r\n  }\r\n  private _layer;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() color: string = 'primary';\r\n\r\n  @Input() header: boolean;\r\n\r\n  public ogcFilterCollapse = false;\r\n\r\n  constructor() {}\r\n\r\n  ngOnInit() {\r\n    this.options = this.layer.dataSource.options as OgcFilterableDataSourceOptions;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport * as moment_ from 'moment';\r\nconst moment = moment_;\r\n\r\nimport {\r\n    OgcFilterableDataSource\r\n  } from './ogc-filter.interface';\r\n\r\n@Injectable()\r\nexport class OGCFilterTimeService {\r\n\r\n    readonly defaultStepMillisecond = 60000;\r\n\r\n    constructor() {}\r\n\r\n    step(datasource: OgcFilterableDataSource, currentFilter): string {\r\n    return datasource.options.stepDate\r\n      ? datasource.options.stepDate\r\n      : currentFilter.step;\r\n    }\r\n\r\n    stepMillisecond(dataSource: OgcFilterableDataSource, currentFilter): number {\r\n        const step = moment.duration(this.step(dataSource, currentFilter)).asMilliseconds();\r\n        return step === 0 ? this.defaultStepMillisecond : step;\r\n    }\r\n\r\n    stepIsYearDuration(step: string) {\r\n        const year = moment.duration(step);\r\n        return (\r\n            year.years() !== 0 &&\r\n            year.months() === 0 &&\r\n            year.weeks() === 0 &&\r\n            year.days() === 0 &&\r\n            year.hours() === 0 &&\r\n            year.minutes() === 0\r\n        );\r\n    }\r\n\r\n    stepIsMonthDuration(step: string) {\r\n        const month = moment.duration(step);\r\n        return (\r\n            month.months() !== 0 &&\r\n            month.weeks() === 0 &&\r\n            month.days() === 0 &&\r\n            month.hours() === 0 &&\r\n            month.minutes() === 0\r\n        );\r\n    }\r\n\r\n    stepIsWeekDuration(step: string) {\r\n        const week = moment.duration(step);\r\n        return (\r\n            week.weeks() !== 0 &&\r\n            week.days() === 7 &&\r\n            week.hours() === 0 &&\r\n            week.minutes() === 0\r\n        );\r\n    }\r\n\r\n    stepIsDayDuration(step: string) {\r\n        const day = moment.duration(step);\r\n        return day.days() !== 0 && day.hours() === 0 && day.minutes() === 0;\r\n    }\r\n\r\n    stepIsHourDuration(step: string) {\r\n        const hour = moment.duration(step);\r\n        return hour.hours() !== 0 && hour.minutes() === 0;\r\n    }\r\n\r\n    stepIsMinuteDuration(step: string) {\r\n        const minute = moment.duration(step);\r\n        return minute.minutes() !== 0;\r\n    }\r\n\r\n    dateToNumber(date: Date): number {\r\n        let newDate = new Date();\r\n        if (date) {\r\n          newDate = new Date(date);\r\n        }\r\n        return newDate.getTime();\r\n    }\r\n\r\n    public addStep(value, stepMillisecond) {\r\n        return moment(value).add(stepMillisecond, 'milliseconds').toDate();\r\n    }\r\n\r\n    public subtractStep(value, stepMillisecond) {\r\n        return moment(value).subtract(stepMillisecond, 'milliseconds').toDate();\r\n    }\r\n}\r\n","<form [formGroup]=\"form\">\r\n  <div *ngFor=\"let selector of ogcFiltersSelectors\">\r\n    <div class=\"pushButtonGroups\" *ngIf=\"selector.selectorType === 'pushButton'\">\r\n      <mat-divider></mat-divider>\r\n      <div class=\"groupsSelector\" *ngIf=\"getPushButtonsGroups().length > 1\">\r\n        <mat-form-field>\r\n          <mat-select\r\n            formControlName=\"pushButtonsGroup\"\r\n            [matTooltip]=\"'igo.geo.layer.legend.selectStyle' | translate\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n            [(value)]=\"currentPushButtonsGroup\">\r\n            <mat-option *ngFor=\"let selectorGroup of getPushButtonsGroups()\"\r\n              [value]=\"selectorGroup\">{{selectorGroup.title}}\r\n            </mat-option>\r\n          </mat-select>\r\n        </mat-form-field>\r\n      </div>\r\n      <ng-container *ngFor=\"let bundle of currentPushButtonsGroup.computedSelectors\">\r\n        <h4>{{bundle.title}}</h4>\r\n        <mat-button-toggle-group\r\n          formControlName=\"pushButtons\" class=\"mat-typography\" appearance=\"legacy\" vertical={{bundleIsVertical(bundle)}} multiple=\"true\">\r\n          <mat-button-toggle *ngFor=\"let ogcPushButton of bundle.selectors\"\r\n            [matTooltip]=\"getToolTip(ogcPushButton)\" tooltip-position=\"below\" matTooltipShowDelay=\"500\" matTooltipClass=\"material-tooltip\"\r\n            [ngStyle]=\"getButtonColor(ogcPushButton)\"\r\n            [checked]=\"ogcPushButton.enabled\" (change)=\"onSelectionChange(ogcPushButton, selector.selectorType)\"\r\n            [value]=\"ogcPushButton\">{{ogcPushButton.title}}\r\n          </mat-button-toggle>\r\n        </mat-button-toggle-group>\r\n      </ng-container>\r\n    </div>\r\n\r\n    <div class=\"checkboxGroups\" *ngIf=\"selector.selectorType === 'checkbox'\">\r\n      <mat-divider></mat-divider>\r\n      <div class=\"groupsSelector\" *ngIf=\"getCheckboxesGroups().length > 1\">\r\n        <mat-form-field>\r\n          <mat-select\r\n            formControlName=\"checkboxesGroup\"\r\n            [matTooltip]=\"'igo.geo.layer.legend.selectStyle' | translate\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n            [(value)]=\"currentCheckboxesGroup\">\r\n            <mat-option *ngFor=\"let selectorGroup of getCheckboxesGroups()\"\r\n              [value]=\"selectorGroup\">{{selectorGroup.title}}\r\n            </mat-option>\r\n          </mat-select>\r\n        </mat-form-field>\r\n      </div>\r\n      <ng-container *ngFor=\"let bundle of currentCheckboxesGroup.computedSelectors\">\r\n        <h4>{{bundle.title}}</h4>\r\n        <div class=\"checkboxes mat-typography\">\r\n          <mat-checkbox *ngFor=\"let ogcCheckbox of bundle.selectors\"\r\n            [matTooltip]=\"getToolTip(ogcCheckbox)\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"  matTooltipClass=\"material-tooltip\"\r\n            [checked]=\"ogcCheckbox.enabled\" (change)=\"onSelectionChange(ogcCheckbox, selector.selectorType)\"\r\n            [value]=\"ogcCheckbox\">{{ogcCheckbox.title}}\r\n          </mat-checkbox>\r\n        </div>\r\n        <p *ngIf=\"isLessResults(bundle, 'checkbox') || isMoreResults(bundle, 'checkbox')\">\r\n          <u *ngIf=\"isLessResults(bundle, 'checkbox')\"\r\n            class=\"lessResults mat-typography\"\r\n            (click)=\"displayLessResults('checkbox')\">{{ 'igo.geo.filter.displayLessResults' | translate }}\r\n          </u>\r\n          <u *ngIf=\"isMoreResults(bundle, 'checkbox')\"\r\n            class=\"moreResults mat-typography\"\r\n            (click)=\"displayMoreResults('checkbox')\">{{ 'igo.geo.filter.displayMoreResults' | translate }}\r\n          </u>\r\n        </p>\r\n      </ng-container>\r\n    </div>\r\n\r\n    <div class=\"radioButtonGroups\" *ngIf=\"selector.selectorType === 'radioButton'\">\r\n      <mat-divider></mat-divider>\r\n      <div class=\"groupsSelector\" *ngIf=\"getRadioButtonsGroups().length > 1\">\r\n        <mat-form-field>\r\n          <mat-select\r\n            formControlName=\"radioButtonsGroup\"\r\n            [matTooltip]=\"'igo.geo.layer.legend.selectStyle' | translate\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n            [(value)]=\"currentRadioButtonsGroup\">\r\n            <mat-option *ngFor=\"let selectorGroup of getRadioButtonsGroups()\"\r\n              [value]=\"selectorGroup\">{{selectorGroup.title}}\r\n            </mat-option>\r\n          </mat-select>\r\n        </mat-form-field>\r\n      </div>\r\n      <ng-container *ngFor=\"let bundle of currentRadioButtonsGroup.computedSelectors\">\r\n        <h4>{{bundle.title}}</h4>\r\n        <mat-radio-group\r\n          formControlName=\"radioButtons\" class=\"mat-typography\">\r\n          <mat-radio-button *ngIf=\"bundle.unfiltered\"\r\n            [matTooltip]=\"'igo.geo.filter.resetFilters' | translate\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"  matTooltipClass=\"material-tooltip\"\r\n            (change)=\"emptyRadioButtons()\">{{ 'igo.geo.filter.resetFilters' | translate }}\r\n          </mat-radio-button>\r\n          <mat-radio-button *ngFor=\"let ogcRadioButton of bundle.selectors\"\r\n            [matTooltip]=\"getToolTip(ogcRadioButton)\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"  matTooltipClass=\"material-tooltip\"\r\n            [checked]=\"ogcRadioButton.enabled\" (change)=\"onSelectionChange(ogcRadioButton, selector.selectorType)\"\r\n            [value]=\"ogcRadioButton\">{{ogcRadioButton.title}}\r\n          </mat-radio-button>\r\n          <p *ngIf=\"isLessResults(bundle, 'radio') || isMoreResults(bundle, 'radio')\">\r\n            <u *ngIf=\"isLessResults(bundle, 'radio')\"\r\n              class=\"lessResults mat-typography\"\r\n              (click)=\"displayLessResults('radio')\">{{ 'igo.geo.filter.displayLessResults' | translate }}\r\n            </u>\r\n            <u *ngIf=\"isMoreResults(bundle, 'radio')\"\r\n              class=\"moreResults mat-typography\"\r\n              (click)=\"displayMoreResults('radio')\">{{ 'igo.geo.filter.displayMoreResults' | translate }}\r\n            </u>\r\n          </p>\r\n        </mat-radio-group>\r\n      </ng-container>\r\n    </div>\r\n\r\n    <div class=\"selectGroups\" *ngIf=\"selector.selectorType === 'select'\">\r\n      <mat-divider></mat-divider>\r\n      <div class=\"groupsSelector\" *ngIf=\"getSelectGroups().length > 1\">\r\n        <mat-form-field>\r\n          <mat-select\r\n            formControlName=\"selectGroup\"\r\n            [matTooltip]=\"'igo.geo.layer.legend.selectStyle' | translate\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n            [(value)]=\"currentSelectGroup\">\r\n            <mat-option *ngFor=\"let selectorGroup of getSelectGroups()\"\r\n              [value]=\"selectorGroup\">{{selectorGroup.title}}\r\n            </mat-option>\r\n          </mat-select>\r\n        </mat-form-field>\r\n      </div>\r\n      <ng-container *ngFor=\"let bundle of currentSelectGroup.computedSelectors\">\r\n        <h4>{{bundle.title}}</h4>\r\n        <div class=\"groupsSelector\">\r\n          <mat-button *ngIf=\"bundle.unfiltered && !bundle.multiple\"\r\n            mat-icon-button\r\n            color=\"warn\"\r\n            [matTooltip]=\"'igo.geo.filter.resetFilters' | translate\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"  matTooltipClass=\"material-tooltip\"\r\n            (click)=\"emptySelect()\">\r\n            <mat-icon svgIcon=\"filter-remove\"></mat-icon>\r\n          </mat-button>\r\n          <mat-form-field [style.width.%]=\"bundle.width ? bundle.width : undefined\">\r\n            <div *ngIf=\"bundle.multiple; else notMulti\">\r\n              <mat-select\r\n                #selection [multiple]=\"bundle.multiple\" [placeholder]=\"bundle.title\" formControlName=\"selectMulti\">\r\n                <div class=\"checkboxes mat-typography\">\r\n                  <mat-checkbox *ngIf=\"bundle.multiple\"\r\n                    [(ngModel)]=\"selectAllSelected\" [ngModelOptions]=\"{standalone: true}\"\r\n                    (change)=\"toggleAllSelection()\">Tous\r\n                  </mat-checkbox>\r\n                </div>\r\n                <mat-option *ngFor=\"let ogcSelect of bundle.selectors\"\r\n                  [matTooltip]=\"getToolTip(ogcSelect)\" tooltip-position=\"below\" matTooltipDelay=\"500\" matTooltipClass=\"material-tooltip\"\r\n                  (onSelectionChange)=\"selectOptionClick($event.source.value, bundle, $event)\"\r\n                  [value]=\"ogcSelect\">{{ogcSelect.title}}\r\n                </mat-option>\r\n              </mat-select>\r\n            </div>\r\n            <ng-template #notMulti>\r\n              <mat-select\r\n                [placeholder]=\"bundle.title\" formControlName=\"select\">\r\n                <mat-option *ngFor=\"let ogcSelect of bundle.selectors\"\r\n                  [matTooltip]=\"getToolTip(ogcSelect)\" tooltip-position=\"below\" matTooltipDelay=\"500\" matTooltipClass=\"material-tooltip\"\r\n                  [value]=\"ogcSelect\" (onSelectionChange)=\"selectOptionClick($event.source.value, bundle)\">{{ogcSelect.title}}\r\n                </mat-option>\r\n              </mat-select>\r\n            </ng-template>\r\n          </mat-form-field>\r\n        </div>\r\n      </ng-container>\r\n    </div>\r\n\r\n    <div class=\"autocompleteGroups\" *ngIf=\"selector.selectorType === 'autocomplete'\">\r\n      <mat-divider></mat-divider>\r\n      <div class=\"groupsSelector\" *ngIf=\"getAutocompleteGroups().length > 1\">\r\n        <mat-form-field>\r\n          <mat-select\r\n            formControlName=\"autocompleteGroup\"\r\n            [matTooltip]=\"'igo.geo.layer.legend.selectStyle' | translate\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n            [(value)]=\"currentAutocompleteGroup\">\r\n            <mat-option *ngFor=\"let autocompleteGroup of getAutocompleteGroups()\"\r\n              [value]=\"autocompleteGroup\">{{autocompleteGroup.title}}\r\n            </mat-option>\r\n          </mat-select>\r\n        </mat-form-field>\r\n      </div>\r\n      <ng-container *ngFor=\"let bundle of currentAutocompleteGroup.computedSelectors\">\r\n        <h4>{{bundle.title}}</h4>\r\n        <div class=\"groupsSelector\">\r\n          <mat-button *ngIf=\"bundle.unfiltered\"\r\n            mat-icon-button\r\n            color=\"warn\"\r\n            [matTooltip]=\"'igo.geo.filter.resetFilters' | translate\" tooltip-position=\"below\" matTooltipShowDelay=\"500\"  matTooltipClass=\"material-tooltip\"\r\n            (click)=\"emptyAutocomplete()\">\r\n            <mat-icon svgIcon=\"filter-remove\"></mat-icon>\r\n          </mat-button>\r\n          <mat-form-field *ngIf=\"filteredOgcAutocomplete[bundle.id]\" [style.width.%]=\"bundle.width ? bundle.width : undefined\">\r\n            <input matInput type=\"text\" formControlName=\"autocomplete\" #autocomplete class=\"autocomplete\"\r\n              [matAutocomplete]=\"auto\" [placeholder]=\"bundle.title\">\r\n              <mat-autocomplete #auto=\"matAutocomplete\" #autocomplete (optionSelected)=\"autocompleteOptionClick($event.option.value)\"\r\n              [displayWith]=\"displayFn\">\r\n                <mat-option *ngFor=\"let ogcAutocomplete of filteredOgcAutocomplete[bundle.id] | async\" [value]=\"ogcAutocomplete\">\r\n                  {{ ogcAutocomplete.value }}\r\n                </mat-option>\r\n              </mat-autocomplete>\r\n          </mat-form-field>\r\n        </div>\r\n      </ng-container>\r\n    </div>\r\n  </div>\r\n</form>\r\n\r\n<div *ngIf=\"isTemporalOperator()\">\r\n  <mat-divider></mat-divider>\r\n  <h4 *ngIf=\"!currentFilter.title\">{{ 'igo.geo.filter.reportingDate' | translate }}</h4>\r\n  <h4 *ngIf=\"currentFilter.title\">{{ currentFilter.title }}</h4>\r\n  <igo-ogc-filter-time\r\n    [(datasource)]=\"datasource\"\r\n    [(currentFilter)]=\"currentFilter\"\r\n    (changeProperty)=\"changeProperty($event.value, $event.pos)\">\r\n  </igo-ogc-filter-time>\r\n</div>","import {\r\n  ChangeDetectorRef,\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  ViewChild\r\n} from '@angular/core';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { DOMService, DOMValue } from '@igo2/common';\r\n\r\nimport {\r\n  OgcFilterableDataSource,\r\n  IgoOgcFilterObject,\r\n  OgcPushButton,\r\n  OgcSelectorBundle,\r\n  SelectorGroup\r\n\r\n} from '../../filter/shared/ogc-filter.interface';\r\nimport { OgcFilterWriter } from '../../filter/shared/ogc-filter';\r\nimport { IgoMap } from '../../map';\r\nimport { OGCFilterService } from '../shared/ogc-filter.service';\r\nimport { WMSDataSource } from '../../datasource/shared/datasources/wms-datasource';\r\nimport { FormBuilder, FormGroup, Validators } from '@angular/forms';\r\nimport { debounceTime, map } from 'rxjs/operators';\r\nimport { OgcFilterOperator } from '../shared/ogc-filter.enum';\r\nimport { MatSelect } from '@angular/material/select';\r\nimport { MatOption } from '@angular/material/core';\r\nimport { BehaviorSubject, Observable } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filter-selection',\r\n  templateUrl: './ogc-filter-selection.component.html',\r\n  styleUrls: ['./ogc-filter-selection.component.scss'],\r\n  providers: [ DOMService ]\r\n})\r\nexport class OgcFilterSelectionComponent implements OnInit {\r\n\r\n  @ViewChild('selection') sel: MatSelect;\r\n\r\n  @Input() refreshFilters: () => void;\r\n\r\n  @Input() datasource: OgcFilterableDataSource;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input() checkboxesIndex = 5;\r\n  @Input() radioButtonsIndex = 5;\r\n  @Input() baseIndex = 5;\r\n\r\n  @Input()\r\n  get currentFilter(): any {\r\n    return this._currentFilter;\r\n  }\r\n  set currentFilter(value) {\r\n    this._currentFilter = value;\r\n    if (this._currentFilter?.sliderOptions) {\r\n      this._currentFilter.sliderOptions.enabled = false; // remove slider toggle (animation temporelle)\r\n    }\r\n  }\r\n  private _currentFilter: any;\r\n\r\n  public ogcFilterOperator = OgcFilterOperator;\r\n\r\n  public form: FormGroup;\r\n  private ogcFilterWriter: OgcFilterWriter;\r\n  public color = 'primary';\r\n  public selectAllSelected = false;\r\n  public selectEnabled$ = new BehaviorSubject(undefined);\r\n  public selectEnableds$ = new BehaviorSubject([]);\r\n  public autocompleteEnabled$ = new BehaviorSubject(undefined);\r\n  public filteredOgcAutocomplete = {};\r\n\r\n  public applyFiltersTimeout;\r\n\r\n  get ogcFiltersSelectors() {\r\n    const ogcSelector = [];\r\n    if (this.datasource?.options?.ogcFilters?.pushButtons) {\r\n      ogcSelector.push(this.datasource?.options?.ogcFilters?.pushButtons);\r\n    }\r\n    if (this.datasource?.options?.ogcFilters?.checkboxes) {\r\n      ogcSelector.push(this.datasource?.options?.ogcFilters?.checkboxes);\r\n    }\r\n    if (this.datasource?.options?.ogcFilters?.radioButtons) {\r\n      ogcSelector.push(this.datasource?.options?.ogcFilters?.radioButtons);\r\n    }\r\n    if (this.datasource?.options?.ogcFilters?.select) {\r\n      ogcSelector.push(this.datasource?.options?.ogcFilters?.select);\r\n    }\r\n    if (this.datasource?.options?.ogcFilters?.autocomplete) {\r\n      ogcSelector.push(this.datasource?.options?.ogcFilters?.autocomplete);\r\n    }\r\n    ogcSelector.sort((a, b) => {\r\n      if (a.order < b.order) {\r\n        return -1;\r\n      }\r\n      if (a.order > b.order) {\r\n        return 1;\r\n      }\r\n      return 0;\r\n    });\r\n    return ogcSelector;\r\n  }\r\n\r\n  get currentPushButtonsGroup() {\r\n    return this.form.get('pushButtonsGroup').value;\r\n  }\r\n  set currentPushButtonsGroup(value) {\r\n    this.form.patchValue({ pushButtonsGroup: value });\r\n  }\r\n\r\n  get currentCheckboxesGroup() {\r\n    return this.form.get('checkboxesGroup').value;\r\n  }\r\n  set currentCheckboxesGroup(value) {\r\n    this.form.patchValue({ checkboxesGroup: value });\r\n  }\r\n\r\n  get currentRadioButtonsGroup() {\r\n    return this.form.get('radioButtonsGroup').value;\r\n  }\r\n  set currentRadioButtonsGroup(value) {\r\n    this.form.patchValue({ radioButtonsGroup: value });\r\n  }\r\n\r\n  get currentSelectGroup() {\r\n    return this.form.get('selectGroup').value;\r\n  }\r\n  set currentSelectGroup(value) {\r\n    this.form.patchValue({ selectGroup: value });\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n  get currentAutocompleteGroup() {\r\n    return this.form.get('autocompleteGroup').value;\r\n  }\r\n  set currentAutocompleteGroup(value) {\r\n    this.form.patchValue({ autocompleteGroup: value });\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n  get selectEnabled() {\r\n    return this.selectEnabled$.value;\r\n  }\r\n\r\n  set selectEnabled(value) {\r\n    this.selectEnabled$.next(value);\r\n    clearTimeout(this.applyFiltersTimeout);\r\n    this.currentSelectGroup.computedSelectors.forEach(compSelect => {\r\n      compSelect.selectors?.forEach(selector => {\r\n        value === selector ? selector.enabled = true : selector.enabled = false;\r\n      });\r\n    });\r\n\r\n    this.applyFiltersTimeout = setTimeout(() => {\r\n      this.applyFilters();\r\n    }, 750);\r\n  }\r\n\r\n  get selectEnableds() {\r\n    return this.selectEnableds$.value;\r\n  }\r\n\r\n  set selectEnableds(value) {\r\n    this.selectEnableds$.next(value);\r\n    clearTimeout(this.applyFiltersTimeout);\r\n    this.currentSelectGroup.computedSelectors.forEach(compSelect => {\r\n      compSelect.selectors?.forEach(selector => {\r\n        value.includes(selector) ? selector.enabled = true : selector.enabled = false;\r\n      });\r\n    });\r\n\r\n    this.applyFiltersTimeout = setTimeout(() => {\r\n      this.applyFilters();\r\n    }, 750);\r\n  }\r\n\r\n  get autocompleteEnabled() {\r\n    return this.autocompleteEnabled$.value;\r\n  }\r\n\r\n  set autocompleteEnabled(value) {\r\n    this.autocompleteEnabled$.next(value);\r\n    clearTimeout(this.applyFiltersTimeout);\r\n    this.currentAutocompleteGroup.computedSelectors.forEach(compSelect => {\r\n      compSelect.selectors?.forEach(selector => {\r\n        value === selector.title ? selector.enabled = true : selector.enabled = false;\r\n      });\r\n    });\r\n\r\n    this.applyFiltersTimeout = setTimeout(() => {\r\n      this.applyFilters();\r\n    }, 750);\r\n  }\r\n\r\n  constructor(\r\n    private ogcFilterService: OGCFilterService,\r\n    private formBuilder: FormBuilder,\r\n    private domService: DOMService,\r\n    private configService: ConfigService,\r\n    private cdRef: ChangeDetectorRef\r\n  ) {\r\n    this.ogcFilterWriter = new OgcFilterWriter();\r\n    this.buildForm();\r\n  }\r\n\r\n  private buildForm() {\r\n    this.form = this.formBuilder.group({\r\n      pushButtons: ['', [Validators.required]],\r\n      radioButtons: ['', [Validators.required]],\r\n      pushButtonsGroup: ['', [Validators.required]],\r\n      checkboxesGroup: ['', [Validators.required]],\r\n      radioButtonsGroup: ['', [Validators.required]],\r\n      selectGroup: ['', [Validators.required]],\r\n      select: ['', [Validators.required]],\r\n      selectMulti: ['', [Validators.required]],\r\n      autocompleteGroup: ['', [Validators.required]],\r\n      autocomplete: ['', [Validators.required]]\r\n    });\r\n  }\r\n\r\n  getPushButtonsGroups(): SelectorGroup[] {\r\n    if (this.datasource?.options?.ogcFilters?.pushButtons) {\r\n      return this.datasource.options.ogcFilters.pushButtons.groups;\r\n    }\r\n  }\r\n\r\n  getCheckboxesGroups(): SelectorGroup[] {\r\n    if (this.datasource?.options?.ogcFilters?.checkboxes) {\r\n      return this.datasource.options.ogcFilters.checkboxes.groups;\r\n    }\r\n  }\r\n\r\n  getRadioButtonsGroups(): SelectorGroup[] {\r\n    if (this.datasource?.options?.ogcFilters?.radioButtons) {\r\n      return this.datasource.options.ogcFilters.radioButtons.groups;\r\n    }\r\n  }\r\n\r\n  getSelectGroups(): SelectorGroup[] {\r\n    if (this.datasource?.options?.ogcFilters?.select) {\r\n      return this.datasource.options.ogcFilters.select.groups;\r\n    }\r\n  }\r\n\r\n  getAutocompleteGroups(): SelectorGroup[] {\r\n    if (this.datasource?.options?.ogcFilters?.autocomplete) {\r\n      return this.datasource.options.ogcFilters.autocomplete.groups;\r\n    }\r\n  }\r\n\r\n  async ngOnInit() {\r\n    if (this.datasource.options.ogcFilters) {\r\n      if (this.datasource.options.ogcFilters.pushButtons) {\r\n        this.currentPushButtonsGroup =\r\n          this.datasource.options.ogcFilters.pushButtons.groups.find(group => group.enabled) ||\r\n          this.datasource.options.ogcFilters.pushButtons.groups[0];\r\n      }\r\n      if (this.datasource.options.ogcFilters.checkboxes) {\r\n        this.currentCheckboxesGroup =\r\n          this.datasource.options.ogcFilters.checkboxes.groups.find(group => group.enabled) ||\r\n          this.datasource.options.ogcFilters.checkboxes.groups[0];\r\n      }\r\n      if (this.datasource.options.ogcFilters.radioButtons) {\r\n        this.currentRadioButtonsGroup =\r\n          this.datasource.options.ogcFilters.radioButtons.groups.find(group => group.enabled) ||\r\n          this.datasource.options.ogcFilters.radioButtons.groups[0];\r\n      }\r\n      if (this.datasource.options.ogcFilters.select) {\r\n        this.currentSelectGroup =\r\n          this.datasource.options.ogcFilters.select.groups.find(group => group.enabled) ||\r\n          this.datasource.options.ogcFilters.select.groups[0];\r\n        this.getSelectEnabled();\r\n        await this.getSelectDomValues();\r\n      }\r\n      if (this.datasource.options.ogcFilters.autocomplete) {\r\n        this.currentAutocompleteGroup =\r\n          this.datasource.options.ogcFilters.autocomplete.groups.find(group => group.enabled) ||\r\n          this.datasource.options.ogcFilters.autocomplete.groups[0];\r\n        this.getAutocompleteEnabled();\r\n        await this.getAutocompleteDomValues();\r\n      }\r\n      this.applyFilters();\r\n    }\r\n\r\n    this.form\r\n    .get('pushButtonsGroup')\r\n    .valueChanges\r\n    .pipe(debounceTime(750))\r\n    .subscribe(() => {\r\n      this.onPushButtonsChangeGroup();\r\n      this.applyFilters();\r\n      });\r\n    this.form\r\n    .get('checkboxesGroup')\r\n    .valueChanges\r\n    .pipe(debounceTime(750))\r\n    .subscribe(() => {\r\n      this.onCheckboxesChangeGroup();\r\n      this.applyFilters();\r\n      });\r\n    this.form\r\n      .get('radioButtonsGroup')\r\n      .valueChanges\r\n      .pipe(debounceTime(750))\r\n      .subscribe(() => {\r\n        this.onRadioButtonsChangeGroup();\r\n        this.applyFilters();\r\n      });\r\n    this.form\r\n      .get('selectGroup')\r\n      .valueChanges\r\n      .pipe(debounceTime(750))\r\n      .subscribe(() => {\r\n        this.onSelectChangeGroup();\r\n        this.applyFilters();\r\n      });\r\n    this.form\r\n      .get('autocompleteGroup')\r\n      .valueChanges\r\n      .pipe(debounceTime(750))\r\n      .subscribe(() => {\r\n        this.onAutocompleteChangeGroup();\r\n        this.applyFilters();\r\n      });\r\n    this.form\r\n      .get('pushButtons')\r\n      .valueChanges\r\n      .pipe(debounceTime(750))\r\n      .subscribe(() => {\r\n        this.applyFilters();\r\n      });\r\n    this.form\r\n      .get('radioButtons')\r\n      .valueChanges\r\n      .pipe(debounceTime(750))\r\n      .subscribe(() => {\r\n        this.applyFilters();\r\n      });\r\n  }\r\n\r\n  private getSelectEnabled() {\r\n    const enableds = [];\r\n    let enabled;\r\n    this.currentSelectGroup.computedSelectors.forEach(compSelect => {\r\n      if (compSelect.multiple) {\r\n        compSelect.selectors?.forEach(selector => {\r\n          if (selector.enabled) {\r\n            enableds.push(selector);\r\n          }\r\n        });\r\n        this.selectEnableds = enableds;\r\n        this.form.controls['selectMulti'].setValue(enableds);\r\n      } else {\r\n        compSelect.selectors?.forEach(selector => {\r\n          if (selector.enabled) {\r\n            enabled = selector;\r\n          }\r\n        });\r\n        this.form.controls['select'].reset(enabled);\r\n        this.selectEnabled$.subscribe((value) => {\r\n          if (this.form.controls['select'].value !== value) {\r\n            this.form.controls['select'].setValue(value);\r\n          }\r\n        });\r\n        this.selectEnabled = enabled;\r\n      }\r\n    });\r\n  }\r\n\r\n  private getAutocompleteEnabled() {\r\n    let enabled;\r\n    this.currentAutocompleteGroup.computedSelectors.forEach(compSelect => {\r\n      compSelect.selectors?.forEach(selector => {\r\n        if (selector.enabled) {\r\n          const dom = {\r\n            id: selector.filters.expression,\r\n            value: selector.title\r\n          };\r\n          enabled = selector.title;\r\n          this.form.controls['autocomplete'].setValue(dom);\r\n        }\r\n      });\r\n      this.autocompleteEnabled = enabled;\r\n    });\r\n  }\r\n\r\n  getToolTip(selector): string {\r\n    let toolTip;\r\n    if (selector.tooltip) {\r\n      if (Array.isArray(selector.tooltip)) {\r\n        toolTip = selector.tooltip.join('\\n');\r\n      } else {\r\n        toolTip = selector.tooltip;\r\n      }\r\n    }\r\n    return toolTip || '';\r\n  }\r\n\r\n  async getSelectDomValues() {\r\n    for (const bundle of this.datasource.options.ogcFilters.select.bundles) {\r\n      if (bundle.domSelectors) {\r\n        let domValues;\r\n        for (const domSelector of bundle.domSelectors) {\r\n          let filterDOM;\r\n          for (const domOptions of this.configService.getConfig('dom')) {\r\n            if (domSelector.id === domOptions.id || domSelector.name === domOptions.name) {\r\n              filterDOM = {\r\n                id: domOptions.id,\r\n                url: domOptions.url,\r\n                name: domOptions.name,\r\n                values: domOptions.values\r\n              };\r\n            }\r\n          }\r\n          filterDOM.url ? domValues = await this.domService.getDom(filterDOM) as DOMValue[] :\r\n            domValues = filterDOM.values;\r\n\r\n          if (domValues) {\r\n            let newBundle = bundle;\r\n            newBundle.selectors = [];\r\n            let selector;\r\n            for (const value of domValues) {\r\n              if (bundle.multiple) {\r\n                let enabled;\r\n                this.selectEnableds?.find(sel => sel.title === value.value) ? enabled = true : enabled = false;\r\n                selector = {\r\n                  title: value.value,\r\n                  enabled,\r\n                  filters: {\r\n                    operator: domSelector.operator,\r\n                    propertyName: domSelector.propertyName,\r\n                    expression: value.id,\r\n                  }\r\n                };\r\n              } else {\r\n                selector = {\r\n                  title: value.value,\r\n                  enabled: this.selectEnabled?.title === value.value ?\r\n                    true : false,\r\n                  filters: {\r\n                    operator: domSelector.operator,\r\n                    propertyName: domSelector.propertyName,\r\n                    expression: value.id,\r\n                  }\r\n                };\r\n              }\r\n              newBundle.selectors.push(selector);\r\n            }\r\n            this.getSelectGroups().find(group => group.ids.includes(newBundle.id)).computedSelectors\r\n              .find(comp => comp.title === newBundle.title).selectors = newBundle.selectors;\r\n          }\r\n        }\r\n        this.getSelectEnabled();\r\n      }\r\n    }\r\n  }\r\n\r\n  async getAutocompleteDomValues() {\r\n    for (const bundle of this.datasource.options.ogcFilters.autocomplete.bundles) {\r\n      if (bundle.domSelectors) {\r\n        let domValues;\r\n        for (const domSelector of bundle.domSelectors) {\r\n          let filterDOM;\r\n          for (const domOptions of this.configService.getConfig('dom')) {\r\n            if (domSelector.id === domOptions.id || domSelector.name === domOptions.name) {\r\n              filterDOM = {\r\n                id: domOptions.id,\r\n                url: domOptions.url,\r\n                name: domOptions.name,\r\n                values: domOptions.values\r\n              };\r\n            }\r\n          }\r\n          filterDOM.url ? domValues = await this.domService.getDom(filterDOM) as DOMValue[] :\r\n            domValues = filterDOM.values;\r\n\r\n          if (domValues) {\r\n            let newBundle = bundle;\r\n            newBundle.selectors = [];\r\n            let selector;\r\n            for (const value of domValues) {\r\n              selector = {\r\n                title: value.value,\r\n                enabled: this.autocompleteEnabled && this.autocompleteEnabled === value.value ?\r\n                  true : false,\r\n                filters: {\r\n                  operator: domSelector.operator,\r\n                  propertyName: domSelector.propertyName,\r\n                  expression: value.id,\r\n                }\r\n              };\r\n              newBundle.selectors.push(selector);\r\n            }\r\n            this.getAutocompleteGroups().find(group => group.ids.includes(newBundle.id)).computedSelectors\r\n              .find(comp => comp.title === newBundle.title).selectors = newBundle.selectors;\r\n          }\r\n        }\r\n\r\n        this.filteredOgcAutocomplete[bundle.id] = new Observable<any[]>();\r\n        this.cdRef.detectChanges();\r\n        this.filteredOgcAutocomplete[bundle.id] = this.form.controls['autocomplete'].valueChanges.pipe(\r\n          map(value => {\r\n            if (value.length) {\r\n              return domValues?.filter((option) => {\r\n                const filterNormalized = value ? value.toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g, '') : '';\r\n                const featureNameNormalized = option.value.toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n                return featureNameNormalized.includes(filterNormalized);\r\n              });\r\n            }\r\n          })\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  // getButtonStyle(pb: OgcPushButton): {} {\r\n\r\n  //   let styles;\r\n  //   if (pb.color) {\r\n  //     styles = {\r\n  //       'background-color': pb.enabled ? `rgba(${pb.color})` : `rgba(255,255,255,0)`\r\n  //     };\r\n  //   } else {\r\n  //     styles = {\r\n  //       'background-color': pb.enabled ? 'accent': `rgba(255,255,255,0)`,\r\n  //       'color': pb.enabled ? `rgba(0,0,0,0.9)` : `rgba(33,33,33,0.38)`\r\n  //     }\r\n  //   }\r\n  //   return styles;\r\n  // }\r\n\r\n  getButtonColor(pushButton: OgcPushButton): {} {\r\n    let styles;\r\n    if (pushButton.color && pushButton.enabled) {\r\n      styles = {\r\n        'background-color': `rgba(${pushButton.color})`\r\n      };\r\n    }\r\n    return styles;\r\n  }\r\n\r\n  bundleIsVertical(bundle: OgcSelectorBundle): boolean {\r\n    return bundle.vertical ? bundle.vertical : false;\r\n  }\r\n\r\n  private onPushButtonsChangeGroup() {\r\n    this.getPushButtonsGroups().map(group => group.enabled = false);\r\n    this.getPushButtonsGroups().find(group => group === this.currentPushButtonsGroup).enabled = true;\r\n  }\r\n\r\n  private onCheckboxesChangeGroup() {\r\n    this.getCheckboxesGroups().map(group => group.enabled = false);\r\n    this.getCheckboxesGroups().find(group => group === this.currentCheckboxesGroup).enabled = true;\r\n  }\r\n\r\n  private onRadioButtonsChangeGroup() {\r\n    this.getRadioButtonsGroups().map(group => group.enabled = false);\r\n    this.getRadioButtonsGroups().find(group => group === this.currentRadioButtonsGroup).enabled = true;\r\n  }\r\n\r\n  private onSelectChangeGroup() {\r\n    this.getSelectGroups().map(group => group.enabled = false);\r\n    this.getSelectGroups().find(group => group === this.currentSelectGroup).enabled = true;\r\n  }\r\n\r\n  private onAutocompleteChangeGroup() {\r\n    this.getAutocompleteGroups().map(group => group.enabled = false);\r\n    this.getAutocompleteGroups().find(group => group === this.currentAutocompleteGroup).enabled = true;\r\n  }\r\n\r\n  onSelectionChange(currentOgcSelection?, selectorType?) {\r\n    clearTimeout(this.applyFiltersTimeout);\r\n    if (selectorType === 'radioButton') {\r\n      this.emptyRadioButtons();\r\n    }\r\n\r\n    if (currentOgcSelection) {\r\n      currentOgcSelection.enabled = !currentOgcSelection.enabled;\r\n    }\r\n    this.applyFiltersTimeout = setTimeout(() => {\r\n      this.applyFilters();\r\n    }, 750);\r\n  }\r\n\r\n  emptyRadioButtons() {\r\n    this.currentRadioButtonsGroup.computedSelectors.forEach(compSelect => {\r\n      compSelect.selectors.map(selector => selector.enabled = false);\r\n\r\n      this.applyFiltersTimeout = setTimeout(() => {\r\n        this.applyFilters();\r\n      }, 750);\r\n   });\r\n  }\r\n\r\n  emptySelect() {\r\n    this.selectEnabled = undefined;\r\n  }\r\n\r\n  emptyAutocomplete() {\r\n    this.autocompleteEnabled = undefined;\r\n    this.form.controls['autocomplete'].setValue('');\r\n    this.form.controls['autocomplete'].markAsUntouched();\r\n  }\r\n\r\n  toggleAllSelection() {\r\n    if (this.selectAllSelected) {\r\n      const enableds = [];\r\n      this.currentSelectGroup.computedSelectors.forEach(compSelect => {\r\n        compSelect.selectors?.forEach(selector => {\r\n          enableds.push(selector);\r\n        });\r\n      });\r\n      this.sel.options.forEach((item: MatOption) => item.select());\r\n      this.selectEnableds = enableds;\r\n    } else {\r\n      this.sel.options.forEach((item: MatOption) => item.deselect());\r\n      this.selectEnableds = [];\r\n    }\r\n  }\r\n\r\n  selectOptionClick(value, bundle, event?) {\r\n    if (bundle.multiple) {\r\n      const enableds = this.selectEnableds;\r\n      let newStatus = true;\r\n      this.sel.options.forEach((item: MatOption) => {\r\n        if (!item.selected) {\r\n          newStatus = false;\r\n        }\r\n      });\r\n      this.selectAllSelected = newStatus;\r\n      if (event.isUserInput) {\r\n        if (enableds.length) {\r\n          for (const enabled of enableds) {\r\n            if (enabled.title === value.title) {\r\n              if (enabled.enabled && value.enabled) {\r\n                enableds.splice(enableds.indexOf(enabled), 1);\r\n                this.selectEnableds = enableds;\r\n                break;\r\n              }\r\n            } else if (enableds.indexOf(enabled) === enableds.length - 1) {\r\n              enableds.push(value);\r\n              this.selectEnableds = enableds;\r\n              break;\r\n            }\r\n          }\r\n        } else {\r\n          enableds.push(value);\r\n          this.selectEnableds = enableds;\r\n        }\r\n      }\r\n    } else {\r\n      this.selectEnabled = value;\r\n    }\r\n  }\r\n\r\n  autocompleteOptionClick(value) {\r\n    this.autocompleteEnabled = value.value;\r\n  }\r\n\r\n  displayFn(dom): string {\r\n    return dom ? dom.value : undefined;\r\n  }\r\n\r\n  private applyFilters() {\r\n    let filterQueryString = '';\r\n    const conditions = [];\r\n    const currentGroups = [this.currentPushButtonsGroup, this.currentCheckboxesGroup,\r\n      this.currentRadioButtonsGroup, this.currentSelectGroup, this.currentAutocompleteGroup];\r\n    for (const currentGroup of currentGroups) {\r\n      if (currentGroup.computedSelectors) {\r\n        currentGroup.computedSelectors.map(selectorBundle => {\r\n          const bundleCondition = [];\r\n          selectorBundle.selectors?.filter(ogcSelector => ogcSelector.enabled === true)\r\n          .forEach(enabledSelector => bundleCondition.push(enabledSelector.filters));\r\n          if (bundleCondition.length >= 1 ) {\r\n            if (bundleCondition.length === 1) {\r\n              conditions.push(bundleCondition[0]);\r\n            } else {\r\n              conditions.push({logical: selectorBundle.logical, filters: bundleCondition});\r\n            }\r\n          }\r\n        });\r\n      }\r\n    }\r\n    if (this.isTemporalOperator() && this._currentFilter.active) {\r\n      conditions.push(this.datasource.options.ogcFilters.interfaceOgcFilters[0]);\r\n    }\r\n    if (conditions.length >= 1) {\r\n      filterQueryString = this.ogcFilterWriter\r\n        .buildFilter(conditions.length === 1 ?\r\n          conditions[0] : {logical: 'And', filters: conditions } as IgoOgcFilterObject);\r\n    }\r\n    if (this.datasource.options.type === 'wms') {\r\n      this.ogcFilterService.filterByOgc(this.datasource as WMSDataSource, filterQueryString );\r\n    }\r\n    if (this.datasource.options.type === 'wfs') {\r\n      // TODO: Check how to prevent wfs to refresh when filter icon is pushed...\r\n      this.datasource.ol.refresh();\r\n    }\r\n    this.datasource.setOgcFilters(this.datasource.options.ogcFilters, true);\r\n  }\r\n\r\n  isMoreResults(bundle, type) {\r\n    let selectorsLength = 0;\r\n    for (const selectors of bundle.selectors) {\r\n      selectorsLength++;\r\n    }\r\n    const index = type === 'radio' ? this.radioButtonsIndex : this.checkboxesIndex;\r\n    return selectorsLength > index;\r\n  }\r\n\r\n  displayMoreResults(type) {\r\n    type === 'radio' ? this.radioButtonsIndex += 5 : this.checkboxesIndex += 5;\r\n    return;\r\n  }\r\n\r\n  isLessResults(bundle, type) {\r\n    let selectorsLength = 0;\r\n    for (const selectors of bundle.selectors) {\r\n      selectorsLength++;\r\n    }\r\n    const index = type === 'radio' ? this.radioButtonsIndex : this.checkboxesIndex;\r\n    return this.baseIndex !== index && selectorsLength > this.baseIndex;\r\n  }\r\n\r\n  displayLessResults(type) {\r\n    type === 'radio' ? this.radioButtonsIndex = this.baseIndex : this.checkboxesIndex = this.baseIndex;\r\n    return;\r\n  }\r\n\r\n  isTemporalOperator() {\r\n    return (\r\n      this.currentFilter?.operator?.toLowerCase() ===\r\n      this.ogcFilterOperator.During.toLowerCase()\r\n    );\r\n  }\r\n\r\n  changeProperty(value: any, pos?: number, refreshFilter = true) {\r\n    const detectedProperty = this.detectProperty(pos);\r\n    if (detectedProperty) {\r\n      this.datasource.options.ogcFilters.interfaceOgcFilters.find(\r\n        filter => filter.filterid === this.currentFilter.filterid\r\n      )[detectedProperty] = value;\r\n\r\n      if ( refreshFilter ) {\r\n        this.applyFilters();\r\n      }\r\n    }\r\n  }\r\n\r\n  detectProperty(pos?: number): string {\r\n    switch (this.currentFilter.operator) {\r\n      case OgcFilterOperator.PropertyIsNotEqualTo:\r\n      case OgcFilterOperator.PropertyIsEqualTo:\r\n      case OgcFilterOperator.PropertyIsGreaterThan:\r\n      case OgcFilterOperator.PropertyIsGreaterThanOrEqualTo:\r\n      case OgcFilterOperator.PropertyIsLessThan:\r\n      case OgcFilterOperator.PropertyIsLessThanOrEqualTo:\r\n        return 'expression';\r\n      case OgcFilterOperator.PropertyIsLike:\r\n        return 'pattern';\r\n      case OgcFilterOperator.PropertyIsBetween:\r\n        return pos && pos === 1\r\n          ? 'lowerBoundary'\r\n          : pos && pos === 2\r\n          ? 'upperBoundary'\r\n          : undefined;\r\n      case OgcFilterOperator.During:\r\n        return pos && pos === 1\r\n          ? 'begin'\r\n          : pos && pos === 2\r\n          ? 'end'\r\n          : undefined;\r\n      default:\r\n        return;\r\n    }\r\n  }\r\n}\r\n","<mat-tab-group\r\n  [selectedIndex]=\"selectedTypeIndex.value\"\r\n  (selectedIndexChange)=\"selectedTypeIndex.setValue($event)\"\r\n  (selectedTabChange)=\"onTypeChange($event)\">\r\n\r\n  <mat-tab [label]=\"'igo.geo.spatialFilter.predefined' |translate\">\r\n    <mat-form-field>\r\n      <mat-label>{{'igo.geo.spatialFilter.searchLabel' | translate}}</mat-label>\r\n      <mat-select (selectionChange)=\"onSelectionChange()\" [(value)]=\"selectedQueryType\">\r\n        <mat-option *ngFor=\"let queryType of queryType\" [value]=\"queryType\">\r\n          {{('igo.geo.terrapi.' + queryType) | translate}}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n    <igo-spatial-filter-list\r\n      [store]=\"store\"\r\n      [queryType]=\"selectedQueryType\"\r\n      [zone]=\"zone\"\r\n      [layers]=\"layers\"\r\n      (zoneChange)=\"zoneChange.emit($event)\"\r\n      (zoneWithBufferChange)=\"zoneWithBufferChange.emit($event)\"\r\n      (bufferChange)=\"bufferChange.emit($event)\"\r\n      (measureUnitChange)=\"measureUnitChange.emit($event)\">\r\n    </igo-spatial-filter-list>\r\n  </mat-tab>\r\n\r\n  <mat-tab [label]=\"'igo.geo.spatialFilter.draw' |translate\">\r\n    <div class=\"spatial-type-toggle\">\r\n      <mat-button-toggle-group\r\n        [value]=\"activeDrawType\"\r\n        (change)=\"onDrawTypeChange($event.value)\">\r\n        <mat-button-toggle [value]=\"spatialType.Polygon\" [matTooltip]=\"'igo.geo.spatialFilter.drawPolygon' |translate\">\r\n            <mat-icon svgIcon=\"pentagon-outline\"></mat-icon>\r\n        </mat-button-toggle>\r\n        <mat-button-toggle [value]=\"spatialType.Point\" [matTooltip]=\"'igo.geo.spatialFilter.drawCircle' |translate\">\r\n            <mat-icon svgIcon=\"record-circle-outline\"></mat-icon>\r\n        </mat-button-toggle>\r\n      </mat-button-toggle-group>\r\n    </div>\r\n  </mat-tab>\r\n\r\n</mat-tab-group>\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  ChangeDetectionStrategy,\r\n  Output,\r\n  EventEmitter\r\n} from '@angular/core';\r\nimport { SpatialFilterQueryType, SpatialFilterType } from '../../shared/spatial-filter.enum';\r\nimport { FormControl } from '@angular/forms';\r\nimport { EntityStore } from '@igo2/common';\r\nimport { Feature } from '../../../feature';\r\nimport { MeasureLengthUnit } from '../../../measure';\r\nimport { Layer } from '../../../layer';\r\n\r\n/**\r\n * Spatial Filter Type\r\n */\r\n@Component({\r\n  selector: 'igo-spatial-filter-type',\r\n  templateUrl: './spatial-filter-type.component.html',\r\n  styleUrls: ['./spatial-filter-type.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SpatialFilterTypeComponent implements OnInit {\r\n\r\n  @Input()\r\n  get store(): EntityStore<Feature> {\r\n    return this._store;\r\n  }\r\n  set store(store: EntityStore<Feature>) {\r\n    this._store = store;\r\n  }\r\n  private _store: EntityStore<Feature>;\r\n\r\n  public queryType: string[] = ['Arrond', 'CircFed', 'CircProv', 'DirReg', 'Mun', 'MRC', 'AdmRegion', 'RegTour'];\r\n  public selectedTypeIndex = new FormControl(0);\r\n\r\n  /**\r\n   * Reference to the SpatialFIlterType enum\r\n   * @internal\r\n   */\r\n  public spatialType = SpatialFilterType;\r\n\r\n  public activeDrawType: SpatialFilterType = this.spatialType.Polygon;\r\n\r\n  @Input() selectedQueryType: SpatialFilterQueryType;\r\n\r\n  @Input() zone: Feature;\r\n\r\n  @Input() layers: Layer[] = [];\r\n\r\n  public type: SpatialFilterType;\r\n\r\n  @Output() eventType = new EventEmitter<SpatialFilterType>();\r\n\r\n  @Output() eventQueryType = new EventEmitter<SpatialFilterQueryType>();\r\n\r\n  @Output() zoneChange = new EventEmitter<Feature>();\r\n  @Output() zoneWithBufferChange = new EventEmitter<Feature>();\r\n\r\n  @Output() bufferChange = new EventEmitter<number>();\r\n  @Output() measureUnitChange = new EventEmitter<MeasureLengthUnit>();\r\n\r\n  constructor() {}\r\n\r\n  ngOnInit() {\r\n    if (this.selectedTypeIndex.value === 0) {\r\n      this.type = this.spatialType.Predefined;\r\n    }\r\n    if (this.selectedTypeIndex.value === 1) {\r\n      this.type = this.activeDrawType;\r\n    }\r\n    this.eventType.emit(this.type);\r\n  }\r\n\r\n  onTypeChange(event) {\r\n    if (this.selectedTypeIndex.value === 0) {\r\n      this.type = SpatialFilterType.Predefined;\r\n    }\r\n    if (this.selectedTypeIndex.value === 1) {\r\n      this.type = this.activeDrawType;\r\n    }\r\n    this.eventType.emit(this.type);\r\n  }\r\n\r\n  onDrawTypeChange(spatialType: SpatialFilterType) {\r\n    this.activeDrawType = spatialType;\r\n    this.eventType.emit(this.activeDrawType);\r\n  }\r\n\r\n  onSelectionChange() {\r\n    this.eventQueryType.emit(this.selectedQueryType);\r\n    this.zoneChange.emit(undefined);\r\n  }\r\n}\r\n","<form class=\"form-list\">\r\n    <mat-form-field class=\"zone-list\">\r\n        <input #input type=\"text\" placeholder=\"{{'igo.geo.spatialFilter.listLabel' |translate}}\" matInput\r\n        [formControl]=\"formControl\" [matAutocomplete]=\"auto\">\r\n        <mat-autocomplete #auto=\"matAutocomplete\" (optionSelected)=\"onZoneChange($event.option.value)\"\r\n        [displayWith]=\"displayFn\">\r\n            <mat-option *ngFor=\"let entities of this.store.view.all$() | async\" [value]=\"entities\">\r\n                {{entities.properties.nom}}\r\n            </mat-option>\r\n        </mat-autocomplete>\r\n    </mat-form-field>\r\n<form>\r\n\r\n<div class=\"buffer-div\">\r\n    <form class=\"buffer-form\">\r\n        <mat-form-field class=\"buffer\">\r\n            <input type=\"number\" matInput placeholder=\"{{'igo.geo.spatialFilter.buffer' | translate}}\" [formControl]=\"bufferFormControl\"\r\n            [value]=\"0\" [readonly]=\"!zone\">\r\n        </mat-form-field>\r\n    </form>\r\n\r\n    <mat-form-field class=\"unit-field\">\r\n        <mat-select\r\n        [value]=\"measureUnit\"\r\n        (selectionChange)=\"onMeasureUnitChange($event.value)\">\r\n        <mat-option *ngFor=\"let measureUnit of measureUnits\" [value]=\"measureUnit\">\r\n            {{('igo.geo.measure.' + measureUnit) | translate}}\r\n        </mat-option>\r\n        </mat-select>\r\n    </mat-form-field>\r\n</div>\r\n","import { debounceTime, distinctUntilChanged } from 'rxjs/operators';\r\nimport { EntityStore } from '@igo2/common';\r\nimport { SpatialFilterService } from './../../shared/spatial-filter.service';\r\nimport { SpatialFilterQueryType, SpatialFilterType } from './../../shared/spatial-filter.enum';\r\nimport {\r\n  Component,\r\n  Input,\r\n  OnInit,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy,\r\n  Output,\r\n  EventEmitter\r\n} from '@angular/core';\r\nimport { Subscription } from 'rxjs';\r\nimport { FormControl } from '@angular/forms';\r\nimport { Feature } from '../../../feature';\r\nimport { MeasureLengthUnit } from '../../../measure/shared';\r\nimport { LanguageService, MessageService } from '@igo2/core';\r\nimport { Layer } from '../../../layer';\r\n\r\n@Component({\r\n  selector: 'igo-spatial-filter-list',\r\n  templateUrl: './spatial-filter-list.component.html',\r\n  styleUrls: ['./spatial-filter-list.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SpatialFilterListComponent implements OnInit, OnDestroy {\r\n\r\n  @Input()\r\n  get store(): EntityStore<Feature> {\r\n    return this._store;\r\n  }\r\n  set store(store: EntityStore<Feature>) {\r\n    this._store = store;\r\n  }\r\n  private _store: EntityStore<Feature>;\r\n\r\n  @Input()\r\n  get queryType(): SpatialFilterQueryType {\r\n    return this._queryType;\r\n  }\r\n  set queryType(queryType: SpatialFilterQueryType) {\r\n    this.formControl.setValue('');\r\n    this._queryType = queryType;\r\n  }\r\n  private _queryType: SpatialFilterQueryType;\r\n\r\n  @Input()\r\n  get zone() {\r\n    return this._zone;\r\n  }\r\n  set zone(value) {\r\n    this._zone = value;\r\n    if (!value) {\r\n      this.zoneWithBuffer = undefined;\r\n      this.bufferFormControl.setValue(0);\r\n    }\r\n  }\r\n  private _zone;\r\n\r\n  @Input() layers: Layer[] = [];\r\n\r\n  public zoneWithBuffer;\r\n  public selectedZone: any;\r\n\r\n  public measureUnit: MeasureLengthUnit = MeasureLengthUnit.Meters;\r\n\r\n  public formControl = new FormControl();\r\n\r\n  public bufferFormControl = new FormControl();\r\n\r\n  /**\r\n   * Available measure units for the measure type given\r\n   * @internal\r\n   */\r\n  get measureUnits(): string[] {\r\n    return [MeasureLengthUnit.Meters, MeasureLengthUnit.Kilometers];\r\n  }\r\n\r\n  @Output() zoneChange = new EventEmitter<Feature>();\r\n  @Output() zoneWithBufferChange = new EventEmitter<Feature>();\r\n  @Output() bufferChange = new EventEmitter<number>();\r\n  @Output() measureUnitChange = new EventEmitter<MeasureLengthUnit>();\r\n\r\n  formValueChanges$$: Subscription;\r\n  bufferValueChanges$$: Subscription;\r\n\r\n  constructor(\r\n    private spatialFilterService: SpatialFilterService,\r\n    private messageService: MessageService,\r\n    private languageService: LanguageService) {}\r\n\r\n  ngOnInit() {\r\n    this.formValueChanges$$ = this.formControl.valueChanges.subscribe((value) => {\r\n      if (value.length) {\r\n        this.store.view.filter((feature) => {\r\n          const filterNormalized = value.toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n          const featureNameNormalized = feature.properties.nom.toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n          return featureNameNormalized.includes(filterNormalized);\r\n        });\r\n      }\r\n    });\r\n\r\n    this.bufferValueChanges$$ = this.bufferFormControl.valueChanges\r\n      .pipe(\r\n        debounceTime(500),\r\n        distinctUntilChanged()\r\n      )\r\n      .subscribe((value) => {\r\n        if (this.measureUnit === MeasureLengthUnit.Meters && value > 0 && value <= 100000) {\r\n          this.bufferChange.emit(value);\r\n          this.spatialFilterService.loadBufferGeometry(\r\n            this.selectedZone,\r\n            SpatialFilterType.Predefined,\r\n            value,\r\n            this.queryType\r\n          ).subscribe((featureGeom: Feature) => {\r\n            this.zoneWithBuffer = featureGeom;\r\n            this.zoneWithBufferChange.emit(this.zoneWithBuffer);\r\n          });\r\n        } else if (this.measureUnit === MeasureLengthUnit.Kilometers && value > 0 && value <= 100) {\r\n          this.bufferChange.emit(value);\r\n          this.spatialFilterService.loadBufferGeometry(\r\n            this.selectedZone,\r\n            SpatialFilterType.Predefined,\r\n            value * 1000,\r\n            this.queryType\r\n          ).subscribe((featureGeom: Feature) => {\r\n            this.zoneWithBuffer = featureGeom;\r\n            this.zoneWithBufferChange.emit(this.zoneWithBuffer);\r\n          });\r\n        } else if (value === 0 && this.layers.length > 0) {\r\n          this.bufferChange.emit(value);\r\n          this.zoneWithBufferChange.emit(this.selectedZone);\r\n        } else if (\r\n            value < 0 ||\r\n            (this.measureUnit === MeasureLengthUnit.Meters && value > 100000) ||\r\n            (this.measureUnit === MeasureLengthUnit.Kilometers && value > 100)) {\r\n            this.bufferFormControl.setValue(0);\r\n            this.messageService.alert(this.languageService.translate.instant('igo.geo.spatialFilter.bufferAlert'),\r\n              this.languageService.translate.instant('igo.geo.spatialFilter.warning'));\r\n        }\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.formValueChanges$$.unsubscribe();\r\n  }\r\n\r\n  displayFn(feature?: Feature): string | undefined {\r\n    return feature ? feature.properties.nom : undefined;\r\n  }\r\n\r\n  onZoneChange(feature) {\r\n    if (feature && this.queryType) {\r\n      this.spatialFilterService.loadItemById(feature, this.queryType)\r\n      .subscribe((featureGeom: Feature) => {\r\n        this.selectedZone = featureGeom;\r\n        this.zoneChange.emit(featureGeom);\r\n      });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set the measure unit\r\n   * @internal\r\n   */\r\n  onMeasureUnitChange(unit: MeasureLengthUnit) {\r\n    if (unit === this.measureUnit) {\r\n      return;\r\n    } else {\r\n      this.measureUnit = unit;\r\n      this.measureUnitChange.emit(this.measureUnit);\r\n      this.measureUnit === MeasureLengthUnit.Meters ?\r\n        this.bufferFormControl.setValue(this.bufferFormControl.value * 1000) :\r\n        this.bufferFormControl.setValue(this.bufferFormControl.value / 1000);\r\n    }\r\n  }\r\n}\r\n","<igo-geometry-form-field-input\r\n  [formControl]=\"formControl\"\r\n  [map]=\"map\"\r\n  [geometryType]=\"geometryType\"\r\n  [drawGuide]=\"drawGuide$ | async\"\r\n  [measure]=\"measure\"\r\n  [drawControlIsActive]=\"drawControlIsActive\"\r\n  [freehandDrawIsActive]=\"freehandDrawIsActive\"\r\n  [drawStyle]=\"drawStyle$ | async\"\r\n  [overlayStyle]=\"overlayStyle$ | async\"\r\n  [radius]=\"radius\">\r\n</igo-geometry-form-field-input>\r\n\r\n<div class=\"header\">\r\n    <mat-slide-toggle *ngIf=\"!isPredefined()\"\r\n      [checked]=\"drawControlIsActive\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onDrawControlChange()\">\r\n      {{'igo.geo.spatialFilter.drawControl' | translate}}\r\n    </mat-slide-toggle>\r\n    <mat-slide-toggle *ngIf=\"!isPredefined()\"\r\n      [checked]=\"freehandDrawIsActive\"\r\n      [labelPosition]=\"'before'\"\r\n      (change)=\"onfreehandControlChange()\">\r\n      {{'igo.geo.spatialFilter.freehandControl' | translate}}\r\n    </mat-slide-toggle>\r\n</div>\r\n\r\n<div class=\"buffer-unit\" *ngIf=\"isPolygon()\">\r\n  <form class=\"buffer-form\">\r\n    <mat-form-field class=\"buffer\">\r\n      <input type=\"number\" matInput placeholder=\"{{'igo.geo.spatialFilter.buffer' | translate}}\" [formControl]=\"bufferFormControl\"\r\n      [value]=\"0\" [readonly]=\"this.formControl.value === null\">\r\n    </mat-form-field>\r\n  </form>\r\n\r\n  <mat-form-field class=\"unit-field\">\r\n    <mat-select\r\n    [value]=\"measureUnit\"\r\n    (selectionChange)=\"onMeasureUnitChange($event.value)\">\r\n    <mat-option *ngFor=\"let measureUnit of measureUnits\" [value]=\"measureUnit\">\r\n        {{('igo.geo.measure.' + measureUnit) | translate}}\r\n    </mat-option>\r\n    </mat-select>\r\n  </mat-form-field>\r\n</div>\r\n\r\n<div class=\"radius-unit\" *ngIf=\"isPoint()\">\r\n  <form class=\"radius-form\">\r\n    <mat-form-field class=\"radius\">\r\n      <input type=\"number\" matInput placeholder=\"{{'igo.geo.spatialFilter.radius' | translate}}\" [formControl]=\"radiusFormControl\"\r\n      [value]=\"1000\" (input)=\"getRadius()\" [readonly]=\"this.freehandDrawIsActive && this.formControl.value === null\">\r\n    </mat-form-field>\r\n  </form>\r\n\r\n  <mat-form-field class=\"unit-field\">\r\n    <mat-select\r\n    [value]=\"measureUnit\"\r\n    (selectionChange)=\"onMeasureUnitChange($event.value)\">\r\n    <mat-option *ngFor=\"let measureUnit of measureUnits\" [value]=\"measureUnit\">\r\n        {{('igo.geo.measure.' + measureUnit) | translate}}\r\n    </mat-option>\r\n    </mat-select>\r\n  </mat-form-field>\r\n</div>\r\n\r\n<mat-label class=\"title mat-typography\">{{'igo.geo.spatialFilter.search' | translate}} : </mat-label>\r\n<mat-radio-group [value]=\"selectedItemType\">\r\n    <mat-radio-button *ngFor=\"let item of itemType\"\r\n      [value]=\"item\"\r\n      (change)=\"onItemTypeChange($event)\">\r\n      {{'igo.geo.spatialFilter.' + item | translate}}\r\n    </mat-radio-button>\r\n</mat-radio-group>\r\n\r\n<div class=\"thematics\" *ngIf=\"(selectedItemType==='Thematics' && !tableTemplate) || (selectedItemType==='Thematics' && tableTemplate && !listIsVisible)\">\r\n  <mat-table>\r\n      <!-- Name Column -->\r\n      <ng-container matColumnDef=\"name\">\r\n        <mat-header-cell *matHeaderCellDef class=\"thematics-header\">{{'igo.geo.spatialFilter.Thematics' | translate}}</mat-header-cell>\r\n      </ng-container>\r\n\r\n      <!-- Select Column -->\r\n      <ng-container matColumnDef=\"select\">\r\n        <mat-header-cell *matHeaderCellDef class=\"checks-header\">\r\n          <mat-checkbox (change)=\"$event ? masterToggle() : null\"\r\n                        [checked]=\"isAllSelected()\"\r\n                        [indeterminate]=\"selectedThematics.hasValue() && !isAllSelected()\">\r\n          </mat-checkbox>\r\n        </mat-header-cell>\r\n    </ng-container>\r\n\r\n    <mat-header-row *matHeaderRowDef=\"displayedColumns\"></mat-header-row>\r\n    <mat-row *matRowDef=\"let row; columns: displayedColumns;\"></mat-row>\r\n\r\n  </mat-table>\r\n\r\n  <mat-tree [dataSource]=\"dataSource\" [treeControl]=\"treeControl\">\r\n    <!-- This is the tree node template for leaf nodes -->\r\n    <mat-tree-node *matTreeNodeDef=\"let node\" matTreeNodeToggle>\r\n      <li class=\"mat-tree-node\">\r\n        <!-- use a disabled button to provide padding for tree leaf -->\r\n        <button mat-icon-button disabled></button>\r\n        {{node.name}}\r\n        <mat-checkbox class=\"tree-check\" (click)=\"$event.stopPropagation()\"\r\n                      (change)=\"$event ? onToggleChange(node) : null\"\r\n                      [checked]=\"selectedThematics.isSelected(node)\">\r\n        </mat-checkbox>\r\n      </li>\r\n    </mat-tree-node>\r\n\r\n    <!-- This is the tree node template for expandable nodes -->\r\n    <mat-nested-tree-node *matTreeNodeDef=\"let node; when: hasChild\">\r\n        <div class=\"mat-tree-node\">\r\n          <button mat-icon-button\r\n            (click)=\"onToggleClick(node)\">\r\n            <mat-icon [svgIcon]=\"treeControl.isExpanded(node) ? 'chevron-down' : 'chevron-right'\"></mat-icon>\r\n          </button>\r\n          {{node.name}}\r\n          <mat-checkbox class=\"tree-check-2\" (change)=\"$event ? childrensToggle(node) : null\"\r\n                        [checked]=\"isAllSelected(node)\"\r\n                        [indeterminate]=\"hasChildrenSelected(node) && !isAllSelected(node)\">\r\n          </mat-checkbox>\r\n        </div>\r\n        <ul class=\"tree-ul\" [class.example-tree-invisible]=\"!treeControl.isExpanded(node)\">\r\n          <ng-container matTreeNodeOutlet></ng-container>\r\n        </ul>\r\n    </mat-nested-tree-node>\r\n\r\n  </mat-tree>\r\n</div>\r\n\r\n<div class=\"buttons\">\r\n\r\n  <button *ngIf=\"isPredefined()\" mat-raised-button class=\"clear-search-button\" [disabled]=\"disabledClearSearch()\"\r\n    (click)=\"clearSearch()\">\r\n      {{'igo.geo.spatialFilter.clearSearch' | translate}}\r\n  </button>\r\n\r\n  <button *ngIf=\"isPolygon() || isPoint()\" mat-raised-button class=\"clear-form-button\" [disabled]=\"this.formControl.value === null\"\r\n    (click)=\"clearDrawZone()\">\r\n    {{'igo.geo.spatialFilter.clearForm' | translate}}\r\n  </button>\r\n\r\n  <button mat-raised-button class=\"search-button\" [disabled]=\"disableSearchButton()\" color=\"primary\"\r\n    (click)=\"toggleSearchButton()\">\r\n    {{'igo.geo.spatialFilter.goSearch' | translate}}\r\n  </button>\r\n\r\n  <button mat-raised-button class=\"remove-button\" [disabled]=\"allLayers.length === 0\" (click)=\"clearButton()\">\r\n    {{'igo.geo.spatialFilter.removeLayer' | translate}}\r\n  </button>\r\n\r\n  <button mat-raised-button class=\"export-button\" [disabled]=\"!store.entities$.getValue().length\" (click)=\"export.emit()\">\r\n    {{'igo.geo.spatialFilter.exportLayer' | translate}}\r\n  </button>\r\n\r\n</div>\r\n\r\n<button\r\n  class=\"chevron-down\"\r\n  *ngIf=\"store.all().length && tableTemplate && !listIsVisible\"\r\n  mat-icon-button\r\n  matTooltipShowDelay=\"500\"\r\n  [matTooltip]=\"'igo.geo.spatialFilter.showSearchResults' | translate\"\r\n  (click)=\"toggleVisibleList()\">\r\n  <mat-icon svgIcon=\"chevron-down\"></mat-icon>\r\n</button>\r\n\r\n<div class=\"results\" *ngIf=\"store.all().length && tableTemplate && listIsVisible\">\r\n  <button\r\n    *ngIf=\"listIsVisible\"\r\n    mat-icon-button\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"'igo.geo.spatialFilter.hideSearchResults' | translate\"\r\n    (click)=\"toggleVisibleList()\">\r\n  <mat-icon svgIcon=\"chevron-up\"></mat-icon>\r\n  </button>\r\n  <igo-entity-table\r\n    class=\"results-list\"\r\n    [template]=\"tableTemplate\"\r\n    [store]=\"store\"\r\n    (entitySelectChange)=\"entityChange.emit($event)\">\r\n  </igo-entity-table>\r\n</div>\r\n","import OlFeature from 'ol/Feature';\r\nimport {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef,\r\n  Output,\r\n  EventEmitter,\r\n  OnDestroy,\r\n  OnInit\r\n} from '@angular/core';\r\nimport { SpatialFilterQueryType, SpatialFilterType } from '../../shared/spatial-filter.enum';\r\nimport { SelectionModel } from '@angular/cdk/collections';\r\nimport { IgoMap } from '../../../map';\r\nimport { SpatialFilterItemType } from './../../shared/spatial-filter.enum';\r\nimport { Feature } from './../../../feature/shared/feature.interfaces';\r\nimport { FormControl } from '@angular/forms';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport type { default as OlGeometryType } from 'ol/geom/GeometryType';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport { GeoJSONGeometry } from '../../../geometry/shared/geometry.interfaces';\r\nimport * as olStyle from 'ol/style';\r\nimport * as olproj from 'ol/proj';\r\nimport OlPoint from 'ol/geom/Point';\r\nimport { MatTreeNestedDataSource } from '@angular/material/tree';\r\nimport { SpatialFilterService } from '../../shared/spatial-filter.service';\r\nimport { MeasureLengthUnit } from '../../../measure';\r\nimport { EntityStore, EntityStoreFilterSelectionStrategy, EntityTableColumnRenderer, EntityTableTemplate } from '@igo2/common';\r\nimport { Layer, VectorLayer } from '../../../layer/shared';\r\nimport { NestedTreeControl } from '@angular/cdk/tree';\r\nimport { SpatialFilterThematic } from './../../shared/spatial-filter.interface';\r\nimport { MessageService, LanguageService } from '@igo2/core';\r\nimport { debounceTime } from 'rxjs/operators';\r\n\r\nimport { FeatureMotion, FeatureStoreSelectionStrategy } from '../../../feature';\r\nimport { FeatureDataSource } from '../../../datasource/shared';\r\n\r\n/**\r\n * Spatial-Filter-Item (search parameters)\r\n */\r\n@Component({\r\n  selector: 'igo-spatial-filter-item',\r\n  templateUrl: './spatial-filter-item.component.html',\r\n  styleUrls: ['./spatial-filter-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SpatialFilterItemComponent implements OnDestroy, OnInit {\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Input()\r\n  get type(): SpatialFilterType {\r\n    return this._type;\r\n  }\r\n  set type(type: SpatialFilterType) {\r\n    this._type = type;\r\n    const index = this.geometryTypes.findIndex(geom => geom === this.type);\r\n    this.geometryType = this.geometryTypes[index];\r\n    this.formControl.reset();\r\n    this.radius = undefined;\r\n    this.drawGuide$.next(null);\r\n    this.drawStyle$.next(undefined);\r\n\r\n    // Necessary to keep reference to the geometry form field input\r\n    if (this.type === SpatialFilterType.Predefined) {\r\n      const geojson: GeoJSONGeometry = {\r\n        type: 'Point',\r\n        coordinates: ''\r\n      };\r\n      this.formControl.setValue(geojson);\r\n    }\r\n\r\n    // Necessary to apply the right style when geometry type is Point\r\n    if (this.type === SpatialFilterType.Point) {\r\n      this.radius = 1000; // Base radius\r\n      this.radiusFormControl.setValue(this.radius);\r\n      this.PointStyle = (feature: OlFeature<OlGeometry>, resolution: number) => {\r\n        const geom = feature.getGeometry() as OlPoint;\r\n        const coordinates = olproj.transform(geom.getCoordinates(), this.map.projection, 'EPSG:4326');\r\n        return new olStyle.Style ({\r\n          image: new olStyle.Circle ({\r\n            radius: this.radius / (Math.cos((Math.PI / 180) * coordinates[1])) / resolution, // Latitude correction\r\n            stroke: new olStyle.Stroke({\r\n              width: 2,\r\n              color: 'rgba(0, 153, 255)'\r\n            }),\r\n            fill: new olStyle.Fill({\r\n              color: 'rgba(0, 153, 255, 0.2)'\r\n            })\r\n          })\r\n        });\r\n      };\r\n      this.overlayStyle = this.PointStyle;\r\n      this.drawStyle$.next(this.overlayStyle);\r\n    } else {\r\n      // If geometry types is Polygon\r\n      this.radius = undefined;\r\n      this.PolyStyle = () => {\r\n        return new olStyle.Style ({\r\n          stroke: new olStyle.Stroke({\r\n            width: 2,\r\n            color: 'rgba(0, 153, 255)'\r\n          }),\r\n          fill: new olStyle.Fill({\r\n            color: 'rgba(0, 153, 255, 0.2)'\r\n          })\r\n        });\r\n      };\r\n      const color = [0, 153, 255];\r\n      const drawStyle = () => {\r\n        return new olStyle.Style({\r\n          image: new olStyle.Circle ({\r\n            radius: 8,\r\n            stroke: new olStyle.Stroke({\r\n              width: 2,\r\n              color: 'rgba(0, 153, 255)'\r\n            }),\r\n            fill: new olStyle.Fill({\r\n              color: 'rgba(0, 153, 255, 0.2)'\r\n            })\r\n          }),\r\n          stroke: new olStyle.Stroke({\r\n            color: color.concat([1]),\r\n            width: 2\r\n          }),\r\n          fill:  new olStyle.Fill({\r\n            color: color.concat([0.2])\r\n          })\r\n        });\r\n      };\r\n      this.overlayStyle = this.PolyStyle;\r\n      this.drawStyle$.next(drawStyle);\r\n    }\r\n    this.overlayStyle$.next(this.overlayStyle);\r\n  }\r\n  private _type: SpatialFilterType;\r\n\r\n  @Input() queryType: SpatialFilterQueryType;\r\n\r\n  @Input() zone: Feature;\r\n\r\n  @Input() loading;\r\n\r\n  @Input()\r\n  get store(): EntityStore<Feature> {\r\n    return this._store;\r\n  }\r\n  set store(store: EntityStore<Feature>) {\r\n    this._store = store;\r\n    this._store.entities$.subscribe(() => { this.cdRef.detectChanges(); });\r\n  }\r\n  private _store: EntityStore<Feature>;\r\n\r\n  /**\r\n   * Available measure units for the measure type given\r\n   * @internal\r\n   */\r\n  get measureUnits(): string[] {\r\n    return [MeasureLengthUnit.Meters, MeasureLengthUnit.Kilometers];\r\n  }\r\n\r\n  @Input() layers: Layer[] = [];\r\n\r\n  @Input() allLayers: Layer[] = [];\r\n\r\n  @Input()\r\n  get thematicLength(): number {\r\n    return this._thematicLength;\r\n  }\r\n  set thematicLength(value: number) {\r\n    this._thematicLength = value;\r\n  }\r\n  private _thematicLength: number;\r\n\r\n  @Output() toggleSearch = new EventEmitter();\r\n\r\n  @Output() itemTypeChange = new EventEmitter<SpatialFilterItemType>();\r\n\r\n  @Output() thematicChange = new EventEmitter<SpatialFilterThematic[]>();\r\n\r\n  @Output() drawZoneEvent = new EventEmitter<Feature>();\r\n\r\n  @Output() bufferEvent = new EventEmitter<number>();\r\n  @Output() zoneWithBufferChange = new EventEmitter<Feature>();\r\n  @Output() measureUnitChange = new EventEmitter<MeasureLengthUnit>();\r\n\r\n  @Output() radiusEvent = new EventEmitter<number>();\r\n  @Output() freehandControl = new EventEmitter<boolean>();\r\n\r\n  @Output() clearButtonEvent = new EventEmitter();\r\n\r\n  @Output() clearSearchEvent = new EventEmitter();\r\n\r\n  @Output() export = new EventEmitter();\r\n\r\n  @Output() openWorkspace = new EventEmitter();\r\n  @Output() entityChange = new EventEmitter<any>();\r\n\r\n  public itemType: SpatialFilterItemType[] = [SpatialFilterItemType.Address, SpatialFilterItemType.Thematics];\r\n  public selectedItemType: SpatialFilterItemType = SpatialFilterItemType.Address;\r\n  public selectedSourceAddress;\r\n\r\n  treeControl: NestedTreeControl<SpatialFilterThematic> = new NestedTreeControl<SpatialFilterThematic>(node => node.children);\r\n\r\n  // For thematics and results tables\r\n  public displayedColumns: string[] = ['name', 'select'];\r\n  public childrens: SpatialFilterThematic[] = [];\r\n  public groups: string[] = [];\r\n  public thematics: SpatialFilterThematic[] = [];\r\n  public dataSource = new MatTreeNestedDataSource<SpatialFilterThematic>();\r\n  public selectedThematics = new SelectionModel<SpatialFilterThematic>(true, []);\r\n\r\n  // For geometry form field input\r\n  value$: BehaviorSubject<GeoJSONGeometry> = new BehaviorSubject(undefined);\r\n  drawGuide$: BehaviorSubject<number> = new BehaviorSubject(null);\r\n  overlayStyle$: BehaviorSubject<olStyle.Style | ((feature, resolution) => olStyle.Style)> = new BehaviorSubject(undefined);\r\n  drawStyle$: BehaviorSubject<olStyle.Style | ((feature, resolution) => olStyle.Style)> = new BehaviorSubject(undefined);\r\n\r\n  private value$$: Subscription;\r\n  private radiusChanges$$: Subscription;\r\n  private bufferChanges$$: Subscription;\r\n\r\n  public formControl = new FormControl();\r\n  public geometryType: typeof OlGeometryType | string;\r\n  public geometryTypeField = false;\r\n  public geometryTypes: string[] = ['Point', 'Polygon'];\r\n  public drawGuideField = false;\r\n  public drawGuide: number = null;\r\n  public drawGuidePlaceholder = '';\r\n  public measure = false;\r\n  public drawControlIsActive = true;\r\n  public freehandDrawIsActive = false;\r\n  public drawStyle: olStyle.Style | ((feature, resolution) => olStyle.Style);\r\n  public drawZone;\r\n  public overlayStyle: olStyle.Style | ((feature, resolution) => olStyle.Style);\r\n  public PointStyle: olStyle.Style | ((feature, resolution) => olStyle.Style);\r\n  public PolyStyle: olStyle.Style | ((feature, resolution) => olStyle.Style);\r\n\r\n  public radius: number;\r\n  public buffer: number = 0;\r\n  public radiusFormControl = new FormControl();\r\n  public bufferFormControl = new FormControl();\r\n\r\n  public measureUnit: MeasureLengthUnit = MeasureLengthUnit.Meters;\r\n  public zoneWithBuffer;\r\n\r\n  public listIsVisible = true;\r\n  public tableTemplate: EntityTableTemplate;\r\n\r\n  constructor(\r\n    private cdRef: ChangeDetectorRef,\r\n    private spatialFilterService: SpatialFilterService,\r\n    private messageService: MessageService,\r\n    private languageService: LanguageService) {}\r\n\r\n  ngOnInit() {\r\n    this.spatialFilterService.loadThematicsList()\r\n    .subscribe((items: SpatialFilterThematic[]) => {\r\n      for (const item of items) {\r\n        this.childrens.push(item);\r\n        this.childrens.sort((a, b) => {\r\n          return a.name.localeCompare(b.name);\r\n        });\r\n      }\r\n      this.groups.push(this.languageService.translate.instant('igo.geo.terrapi.limites'));\r\n      const limits: SpatialFilterThematic = {\r\n        name: this.groups[0],\r\n        children: []\r\n      };\r\n      this.thematics.push(limits);\r\n      this.childrens.forEach(child => {\r\n        if (child.group && (this.groups.indexOf(child.group) === -1)) {\r\n          this.groups.push(child.group);\r\n          const thematic: SpatialFilterThematic = {\r\n            name: child.group,\r\n            children: []\r\n          };\r\n          this.thematics.push(thematic);\r\n        }\r\n\r\n        if (!child.group) {\r\n          if (\r\n            child.name === this.languageService.translate.instant('igo.geo.terrapi.AdmRegion') ||\r\n            child.name === this.languageService.translate.instant('igo.geo.terrapi.Mun') ||\r\n            child.name === this.languageService.translate.instant('igo.geo.terrapi.Arrond') ||\r\n            child.name === this.languageService.translate.instant('igo.geo.terrapi.CircFed') ||\r\n            child.name === this.languageService.translate.instant('igo.geo.terrapi.CircProv') ||\r\n            child.name === this.languageService.translate.instant('igo.geo.terrapi.DirReg') ||\r\n            child.name === this.languageService.translate.instant('igo.geo.terrapi.MRC') ||\r\n            child.name === this.languageService.translate.instant('igo.geo.terrapi.RegTour')) {\r\n              child.group = limits.name;\r\n          } else if (child.name === this.languageService.translate.instant('igo.geo.terrapi.routes')) {\r\n            child.group = this.languageService.translate.instant('igo.geo.spatialFilter.group.transport');\r\n          } else {\r\n            const thematic: SpatialFilterThematic = {\r\n              name: child.name,\r\n              children: [],\r\n              source: child.source\r\n            };\r\n            this.thematics.push(thematic);\r\n          }\r\n        }\r\n        this.thematics.sort((a, b) => {\r\n          return a.name.localeCompare(b.name);\r\n        });\r\n      });\r\n      this.thematics.forEach(thematic => {\r\n        for (const child of this.childrens) {\r\n          if (child.group === thematic.name) {\r\n            thematic.children.push(child);\r\n          }\r\n        }\r\n      });\r\n    });\r\n\r\n    this.dataSource.data = this.thematics;\r\n\r\n    this.drawGuide$.next(null);\r\n    this.value$.next(this.formControl.value ? this.formControl.value : undefined);\r\n    this.value$$ = this.formControl.valueChanges.subscribe((value: GeoJSONGeometry) => {\r\n      if (value) {\r\n        this.value$.next(value);\r\n        this.drawZone = this.formControl.value as Feature;\r\n        if (this.buffer !== 0) {\r\n          this.drawZoneEvent.emit(this.drawZone);\r\n          this.bufferFormControl.setValue(this.buffer);\r\n        }\r\n      } else {\r\n        this.value$.next(undefined);\r\n        this.drawZone = undefined;\r\n      }\r\n    });\r\n\r\n    this.value$.subscribe(() => {\r\n      this.getRadius();\r\n      this.cdRef.detectChanges();\r\n    });\r\n\r\n    this.radiusChanges$$ = this.radiusFormControl.valueChanges.subscribe(() => {\r\n      this.getRadius();\r\n      this.cdRef.detectChanges();\r\n    });\r\n\r\n    this.bufferChanges$$ = this.bufferFormControl.valueChanges\r\n      .pipe(\r\n        debounceTime(500)\r\n      )\r\n      .subscribe((value) => {\r\n        if (this.measureUnit === MeasureLengthUnit.Meters && value > 0 && value <= 100000) {\r\n          this.buffer = value;\r\n          this.bufferEvent.emit(value);\r\n          this.spatialFilterService.loadBufferGeometry(\r\n            this.drawZone,\r\n            SpatialFilterType.Polygon,\r\n            value\r\n          ).subscribe((featureGeom: Feature) => {\r\n            this.zoneWithBuffer = featureGeom;\r\n            this.zoneWithBufferChange.emit(this.zoneWithBuffer);\r\n          });\r\n        } else if (this.measureUnit === MeasureLengthUnit.Kilometers && value > 0 && value <= 100) {\r\n          this.buffer = value;\r\n          this.bufferEvent.emit(value);\r\n          this.spatialFilterService.loadBufferGeometry(\r\n            this.drawZone,\r\n            SpatialFilterType.Polygon,\r\n            value * 1000\r\n          ).subscribe((featureGeom: Feature) => {\r\n            this.zoneWithBuffer = featureGeom;\r\n            this.zoneWithBufferChange.emit(this.zoneWithBuffer);\r\n          });\r\n        } else if (value === 0) {\r\n          this.buffer = value;\r\n          this.bufferEvent.emit(value);\r\n          this.drawZoneEvent.emit(this.drawZone);\r\n        } else if (\r\n          value < 0 ||\r\n          (this.measureUnit === MeasureLengthUnit.Meters && value > 100000) ||\r\n          (this.measureUnit === MeasureLengthUnit.Kilometers && value > 100)) {\r\n            this.bufferFormControl.setValue(0);\r\n            this.buffer = 0;\r\n            this.messageService.alert(this.languageService.translate.instant('igo.geo.spatialFilter.bufferAlert'),\r\n              this.languageService.translate.instant('igo.geo.spatialFilter.warning'));\r\n        }\r\n    });\r\n\r\n    const selectedRecordStrategy = new EntityStoreFilterSelectionStrategy({});\r\n    const selectionStrategy = new FeatureStoreSelectionStrategy({\r\n      layer: new VectorLayer({\r\n        zIndex: 300,\r\n        source: new FeatureDataSource(),\r\n        style: undefined,\r\n        showInLayerList: false,\r\n        exportable: false,\r\n        browsable: false\r\n      }),\r\n      map: this.map,\r\n      hitTolerance: 15,\r\n      motion: FeatureMotion.Default,\r\n      many: true,\r\n      dragBox: true\r\n    });\r\n\r\n    this.store.addStrategy(selectionStrategy, true);\r\n    this.store.addStrategy(selectedRecordStrategy, false);\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to the value stream\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.value$$.unsubscribe();\r\n    this.radiusChanges$$.unsubscribe();\r\n    this.bufferChanges$$.unsubscribe();\r\n    this.cdRef.detach();\r\n    if (this.radiusChanges$$) {\r\n      this.radiusChanges$$.unsubscribe();\r\n    }\r\n    if (this.value$$) {\r\n      this.value$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  onItemTypeChange(event) {\r\n    this.selectedItemType = event.value;\r\n    this.itemTypeChange.emit(this.selectedItemType);\r\n  }\r\n\r\n  /**\r\n   * Set the measure unit\r\n   * @internal\r\n   */\r\n  onMeasureUnitChange(unit: MeasureLengthUnit) {\r\n    if (unit === this.measureUnit) {\r\n      return;\r\n    } else {\r\n      this.measureUnit = unit;\r\n      this.measureUnitChange.emit(this.measureUnit);\r\n      if (this.isPolygon()) {\r\n        this.measureUnit === MeasureLengthUnit.Meters ?\r\n          this.bufferFormControl.setValue(this.bufferFormControl.value * 1000) :\r\n          this.bufferFormControl.setValue(this.bufferFormControl.value / 1000);\r\n      } else if (this.isPoint()) {\r\n        this.measureUnit === MeasureLengthUnit.Meters ?\r\n          this.radiusFormControl.setValue(this.radiusFormControl.value * 1000) :\r\n          this.radiusFormControl.setValue(this.radiusFormControl.value / 1000);\r\n      }\r\n    }\r\n  }\r\n\r\n  isPredefined() {\r\n    return this.type === SpatialFilterType.Predefined;\r\n  }\r\n\r\n  isPolygon() {\r\n    return this.type === SpatialFilterType.Polygon;\r\n  }\r\n\r\n  isPoint() {\r\n    return this.type === SpatialFilterType.Point;\r\n  }\r\n\r\n  hasChild(_: number, node: SpatialFilterThematic) {\r\n    if (node.children) {\r\n      return node.children.length;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  onToggleClick(node: SpatialFilterThematic) {\r\n    this.treeControl.isExpanded(node) ? this.treeControl.collapse(node) : this.treeControl.expand(node);\r\n  }\r\n\r\n  isAllSelected(node?: SpatialFilterThematic) {\r\n    let numSelected;\r\n    let numNodes = 0;\r\n    if (!node) {\r\n      numSelected = this.selectedThematics.selected.length;\r\n      this.thematics.forEach(thematic => {\r\n        if (this.groups.indexOf(thematic.name) === -1) {\r\n          numNodes++;\r\n        }\r\n      });\r\n      this.childrens.forEach(children => {\r\n        if (!this.thematics.find(thematic => thematic.source === children.source)) {\r\n          numNodes++;\r\n        }\r\n      });\r\n    } else {\r\n      numSelected = node.children.length;\r\n      node.children.forEach(children => {\r\n        if (this.selectedThematics.selected.find(thematic => thematic === children)) {\r\n          numNodes++;\r\n        }\r\n      });\r\n    }\r\n\r\n    if (numNodes >= 1) {\r\n      return numSelected === numNodes;\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  hasChildrenSelected(node: SpatialFilterThematic) {\r\n    let bool = false;\r\n    node.children.forEach(child => {\r\n      if (this.selectedThematics.selected.find(thematic => thematic.source === child.source)) {\r\n        bool = true;\r\n      }\r\n    });\r\n    return bool;\r\n  }\r\n\r\n  /**\r\n   * Apply header checkbox\r\n   */\r\n  masterToggle() {\r\n    this.isAllSelected() ?\r\n      this.selectedThematics.clear() :\r\n      this.selectAll();\r\n\r\n    const selectedThematicsName: SpatialFilterThematic[] = [];\r\n    for (const thematic of this.selectedThematics.selected) {\r\n      selectedThematicsName.push(thematic);\r\n    }\r\n\r\n    if (this.isAllSelected()) {\r\n      this.thematics.forEach(thematic => {\r\n        if (this.hasChild(0, thematic)) {\r\n          this.treeControl.expand(thematic);\r\n        }\r\n      });\r\n    } else {\r\n      this.thematics.forEach(thematic => {\r\n        if (this.hasChild(0, thematic)) {\r\n          this.treeControl.collapse(thematic);\r\n        }\r\n      });\r\n    }\r\n    this.thematicChange.emit(selectedThematicsName);\r\n  }\r\n\r\n  selectAll(node?: SpatialFilterThematic) {\r\n    if (!node) {\r\n      this.thematics.forEach(thematic => {\r\n        if (this.groups.indexOf(thematic.name) === -1) {\r\n          this.selectedThematics.select(thematic);\r\n        }\r\n      });\r\n      this.childrens.forEach(children => {\r\n        if (!this.selectedThematics.selected.find(thematic => thematic.source === children.source)) {\r\n          this.selectedThematics.select(children);\r\n        }\r\n      });\r\n    } else {\r\n      if (this.hasChild(0, node)) {\r\n        node.children.forEach(children => this.selectedThematics.select(children));\r\n      }\r\n    }\r\n  }\r\n\r\n  childrensToggle(node: SpatialFilterThematic) {\r\n    this.isAllSelected(node) ?\r\n    node.children.forEach(child => this.selectedThematics.deselect(child)) :\r\n    this.selectAll(node);\r\n\r\n    const selectedThematicsName: SpatialFilterThematic[] = [];\r\n    for (const thematic of this.selectedThematics.selected) {\r\n      selectedThematicsName.push(thematic);\r\n    }\r\n    this.treeControl.expand(node);\r\n    this.thematicChange.emit(selectedThematicsName);\r\n  }\r\n\r\n  /**\r\n   * Apply changes to the thematics selected tree and emit event\r\n   */\r\n  onToggleChange(nodeSelected: SpatialFilterThematic) {\r\n    let selected = false;\r\n    if (this.selectedThematics.selected.find(thematic => thematic.source === nodeSelected.source) !== undefined) {\r\n      selected = true;\r\n    }\r\n\r\n    this.childrens.forEach(children => {\r\n      if (children === nodeSelected && selected === false) {\r\n        this.selectedThematics.select(children);\r\n      }\r\n      if (children === nodeSelected && selected === true) {\r\n        this.selectedThematics.deselect(children);\r\n      }\r\n    });\r\n    this.thematics.forEach(thematic => {\r\n      if (thematic === nodeSelected && selected === false) {\r\n        this.selectedThematics.select(thematic);\r\n      }\r\n      if (thematic === nodeSelected && selected === true) {\r\n        this.selectedThematics.deselect(thematic);\r\n      }\r\n    });\r\n\r\n    const selectedThematicsName: SpatialFilterThematic[] = [];\r\n    for (const thematic of this.selectedThematics.selected) {\r\n      selectedThematicsName.push(thematic);\r\n    }\r\n    this.thematicChange.emit(selectedThematicsName);\r\n  }\r\n\r\n  onDrawControlChange() {\r\n    this.drawControlIsActive = !this.drawControlIsActive;\r\n  }\r\n\r\n  onfreehandControlChange() {\r\n    this.freehandDrawIsActive = !this.freehandDrawIsActive;\r\n    this.freehandControl.emit(this.freehandDrawIsActive);\r\n  }\r\n\r\n  /**\r\n   * Launch search button\r\n   */\r\n  toggleSearchButton() {\r\n    if (!this.isPredefined()) {\r\n      if (this.buffer > 0) {\r\n        this.zoneWithBuffer.meta = {\r\n          id: undefined,\r\n          title: 'Zone'\r\n        };\r\n        this.zoneWithBuffer.properties = {\r\n          nom: 'Zone',\r\n          type: this.type as string\r\n        };\r\n        this.drawZoneEvent.emit(this.zoneWithBuffer);\r\n      } else {\r\n        this.drawZone.meta = {\r\n          id: undefined,\r\n          title: 'Zone'\r\n        };\r\n        this.drawZone.properties = {\r\n          nom: 'Zone',\r\n          type: this.type as string\r\n        };\r\n        this.drawZoneEvent.emit(this.drawZone);\r\n      }\r\n    }\r\n    if (this.isPoint()) {\r\n      this.radiusEvent.emit(this.radius);\r\n    } else if (this.isPolygon()) {\r\n      this.bufferEvent.emit(this.buffer);\r\n    }\r\n    this.toggleSearch.emit();\r\n    this.store.entities$.pipe(\r\n      debounceTime(500)\r\n    ).subscribe((value) => {\r\n      if (value.length && this.layers.length === this.thematicLength + 1) {\r\n        this.openWorkspace.emit();\r\n        this.createTableTemplate();\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Launch clear button (clear store and map layers)\r\n   */\r\n  clearButton() {\r\n    this.loading = true;\r\n    if (this.store) {\r\n      this.store.clear();\r\n    }\r\n    if (this.isPoint() || this.isPolygon()) {\r\n      this.drawZone = undefined;\r\n      this.formControl.reset();\r\n    }\r\n    this.bufferFormControl.setValue(0);\r\n    this.buffer = 0;\r\n    this.bufferEvent.emit(0);\r\n    this.clearButtonEvent.emit();\r\n    this.loading = false;\r\n    this.tableTemplate = undefined;\r\n  }\r\n\r\n  clearDrawZone() {\r\n    this.formControl.reset();\r\n    this.bufferFormControl.setValue(0);\r\n    this.buffer = 0;\r\n  }\r\n\r\n  /**\r\n   * Launch clear search (clear field if type is predefined)\r\n   */\r\n  clearSearch() {\r\n    this.selectedThematics.clear();\r\n    this.bufferFormControl.setValue(0);\r\n    this.buffer = 0;\r\n    this.bufferEvent.emit(0);\r\n    this.thematicChange.emit([]);\r\n    this.clearSearchEvent.emit();\r\n  }\r\n\r\n  /**\r\n   * Verify conditions of incomplete fields or busy service\r\n   */\r\n  disableSearchButton(): boolean {\r\n    if (this.type === SpatialFilterType.Predefined) {\r\n      if (this.selectedItemType === SpatialFilterItemType.Address) {\r\n        if (this.queryType !== undefined && this.zone !== undefined) {\r\n          return this.loading;\r\n        }\r\n      }\r\n      if (this.selectedItemType === SpatialFilterItemType.Thematics) {\r\n        if (this.queryType !== undefined && this.zone !== undefined && this.selectedThematics.selected.length > 0) {\r\n          return this.loading;\r\n        }\r\n      }\r\n    }\r\n    if (this.type === SpatialFilterType.Polygon || this.type === SpatialFilterType.Point) {\r\n      if (this.selectedItemType === SpatialFilterItemType.Address && this.formControl.value !== null) {\r\n        return this.loading;\r\n      }\r\n      if (this.selectedItemType === SpatialFilterItemType.Thematics) {\r\n        if (this.selectedThematics.selected.length > 0 && this.formControl.value !== null) {\r\n          return this.loading;\r\n        }\r\n      }\r\n    }\r\n    return true;\r\n  }\r\n\r\n  disabledClearSearch() {\r\n    let disable = true;\r\n    this.selectedItemType === SpatialFilterItemType.Address ?\r\n      disable = this.queryType === undefined :\r\n      disable = this.queryType === undefined && this.selectedThematics.selected.length === 0;\r\n\r\n    return disable;\r\n  }\r\n\r\n  /**\r\n   * Manage radius value at user change\r\n   */\r\n  getRadius() {\r\n    let formValue;\r\n    if (this.formControl.value !== null) {\r\n      this.measureUnit === MeasureLengthUnit.Meters ?\r\n        formValue = this.formControl.value.radius :\r\n        formValue = this.formControl.value.radius / 1000;\r\n    } else {\r\n      formValue = undefined;\r\n    }\r\n\r\n    if (this.type === SpatialFilterType.Point) {\r\n      if (!this.freehandDrawIsActive) {\r\n        if (\r\n          this.radiusFormControl.value < 0 ||\r\n          (this.measureUnit === MeasureLengthUnit.Meters && this.radiusFormControl.value >= 100000) ||\r\n          (this.measureUnit === MeasureLengthUnit.Kilometers && this.radiusFormControl.value >= 100)) {\r\n          this.messageService.alert(this.languageService.translate.instant('igo.geo.spatialFilter.radiusAlert'),\r\n            this.languageService.translate.instant('igo.geo.spatialFilter.warning'));\r\n          this.radius = 1000;\r\n          this.measureUnit === MeasureLengthUnit.Meters ?\r\n            this.radiusFormControl.setValue(this.radius) :\r\n            this.radiusFormControl.setValue(this.radius / 1000);\r\n          this.drawGuide$.next(this.radius);\r\n          return;\r\n        }\r\n      } else {\r\n        if (formValue) {\r\n          if (formValue >= 100000) {\r\n            this.messageService.alert(this.languageService.translate.instant('igo.geo.spatialFilter.radiusAlert'),\r\n              this.languageService.translate.instant('igo.geo.spatialFilter.warning'));\r\n            this.formControl.reset();\r\n            return;\r\n          }\r\n          if (formValue !== this.radiusFormControl.value) {\r\n            this.radiusFormControl.setValue(formValue);\r\n            return;\r\n          }\r\n        }\r\n      }\r\n      if (this.measureUnit === MeasureLengthUnit.Meters) {\r\n        this.radius = this.radiusFormControl.value;\r\n        this.drawGuide$.next(this.radius);\r\n      } else {\r\n        this.radius = this.radiusFormControl.value * 1000;\r\n        this.drawGuide$.next(this.radius * 1000);\r\n      }\r\n      this.overlayStyle$.next(this.PointStyle);\r\n      this.drawStyle$.next(this.PointStyle);\r\n    }\r\n  }\r\n\r\n  toggleVisibleList() {\r\n    this.listIsVisible = !this.listIsVisible;\r\n  }\r\n\r\n  private createTableTemplate() {\r\n    const typeColumn = {\r\n      name: 'meta.title',\r\n      title: this.languageService.translate.instant('igo.geo.spatialFilter.type'),\r\n      renderer: EntityTableColumnRenderer.UnsanitizedHTML\r\n    };\r\n    const nameColumn = {\r\n      name: 'properties.nom',\r\n      title: this.languageService.translate.instant('igo.geo.spatialFilter.searchResults'),\r\n      renderer: EntityTableColumnRenderer.UnsanitizedHTML\r\n    };\r\n    const columns = [typeColumn, nameColumn];\r\n\r\n    this.tableTemplate = {\r\n      selection: true,\r\n      sort: true,\r\n      columns\r\n    };\r\n  }\r\n}\r\n","<div class=\"datetime-container\">\r\n  <mat-slide-toggle \r\n    *ngIf=\"this.currentFilter.sliderOptions?.enabled\"\r\n    [(ngModel)]=\"sliderMode\"\r\n    (change)=\"modeChange($event)\">\r\n    {{'igo.geo.filter.sliderModeTitle' | translate}}\r\n  </mat-slide-toggle>\r\n\r\n  <div class=\"slider-container\" *ngIf=\"sliderMode\">\r\n    <igo-ogc-filter-time-slider\r\n      [begin]=\"beginValue\"\r\n      [max]=\"this.restrictedToStep() ? this.maxDate : this.endValue\"\r\n      [currentFilter]=\"currentFilter\" \r\n      [datasource]=\"datasource\"\r\n      (changeProperty)=\"changePropertyByPass($event)\"\r\n    >\r\n    </igo-ogc-filter-time-slider>\r\n    \r\n  </div>\r\n\r\n  <div *ngIf=\"!sliderMode\">\r\n\r\n    <div class=\"year-input-container\" *ngIf=\"calendarTypeYear\">\r\n      <!-- to emulate a year-picker, 2 input: first input to show user just year and second input hiden and bind \r\n        with the datepicker  -->\r\n      <mat-form-field  class=\"year-input\">\r\n        <mat-label>{{'igo.geo.timeFilter.startYear'| translate}}</mat-label>\r\n        <input\r\n          matInput\r\n          class=\"year-input-only-year\"\r\n          value=\"{{onlyYearBegin}}\"\r\n          (change)= \"yearOnlyInputChange($event, beginDatepicker, 'begin')\"\r\n          [disabled]= \"filterStateDisable\"\r\n          >\r\n        <mat-datepicker-toggle matSuffix [for]=\"beginDatepicker\" [disabled]=\"filterStateDisable\"></mat-datepicker-toggle>\r\n  \r\n        <mat-datepicker\r\n          panelClass=\"datepicker-year\"\r\n          #beginDatepicker\r\n          [startView]=\"calendarView()\"\r\n          [startAt]=\"beginValue\"\r\n          (yearSelected)=\"yearSelected($event, beginDatepicker, 'begin')\"\r\n          >\r\n        </mat-datepicker>\r\n\r\n        <input #beginYear\r\n          class= \"year-input-hide\"\r\n          matInput\r\n          [matDatepicker]=\"beginDatepicker\"\r\n          enabled= false\r\n          readonly= true\r\n          [value]=\"beginValue?beginValue:handleDate(datasource.options.minDate)\"\r\n          [min]=\"handleDate(datasource.options.minDate)\"\r\n          [max]=\"(endValue && (!restrictedToStep()))?endValue:handleDate(datasource.options.maxDate)\"\r\n          >\r\n      </mat-form-field>\r\n\r\n      <mat-form-field  class=\"year-input\">\r\n        <mat-label>{{'igo.geo.timeFilter.endYear'| translate}}</mat-label>\r\n        <input\r\n          matInput\r\n          class=\"year-input-only-year\"\r\n          value=\"{{onlyYearEnd}}\"\r\n          (change)= \"yearOnlyInputChange($event, endDatepicker, 'end')\"\r\n          [disabled] = \"filterStateDisable\">\r\n        <mat-datepicker-toggle matSuffix [for]=\"endDatepicker\" [disabled]=\"filterStateDisable\"></mat-datepicker-toggle>\r\n        <mat-datepicker\r\n          panelClass=\"datepicker-year\"\r\n          #endDatepicker\r\n          [startView]=\"calendarView()\"\r\n          [startAt]=\"endValue\"\r\n          (yearSelected)=\"yearSelected($event, endDatepicker, 'end')\"\r\n          >\r\n        </mat-datepicker>\r\n\r\n        <input #endYear\r\n          class= \"year-input-hide\"\r\n          matInput\r\n          [matDatepicker]=\"endDatepicker\"\r\n          enabled= false\r\n          readonly= true\r\n          [value]=\"endValue?endValue:handleDate(datasource.options.maxDate)\"\r\n          [min]=\"beginValue?beginValue:handleDate(datasource.options.minDate)\"\r\n          [max]=\"handleDate(datasource.options.maxDate)\"\r\n          >\r\n      </mat-form-field>\r\n      <button class=\"reset-button\" \r\n        mat-icon-button\r\n        color=\"primary\" \r\n        (click)=\"resetFilter()\" \r\n        [matTooltip]=\"'igo.geo.filter.resetFilters' | translate\" \r\n        [disabled]= \"filterStateDisable\">\r\n        <mat-icon svgIcon=\"{{resetIcon}}\"></mat-icon>\r\n      </button>\r\n      <mat-slide-toggle \r\n        class='toggle-filter-state' \r\n        (change)=\"toggleFilterState()\" \r\n        [matTooltip]=\"'igo.geo.filter.toggleFilterState' | translate\" \r\n        tooltip-position=\"below\" \r\n        matTooltipShowDelay=\"500\"\r\n        [checked]=\"!filterStateDisable\">\r\n      </mat-slide-toggle>\r\n\r\n    </div>\r\n\r\n    <div class=\"datetime-input-container\" *ngIf=\"calendarType()!=='year'\">\r\n      <div class=\"datetime-input\">\r\n        <mat-form-field class=\"date-input\">\r\n          <mat-datepicker-toggle matSuffix [for]=\"beginDatepicker\" [disabled]= \"filterStateDisable\"></mat-datepicker-toggle>\r\n          <input #begin\r\n            matInput\r\n            [matDatepicker]=\"beginDatepicker\"\r\n            [placeholder]=\"'igo.geo.timeFilter.startDate' | translate\"\r\n            [attr.disabled]=\"!currentFilter.active\"\r\n            (dateChange)=\"changeTemporalProperty(begin.value, 1)\"\r\n            [matDatepickerFilter]=\"dateFilter.bind(this, 'begin')\"\r\n            [value]=\"beginValue?beginValue:handleDate(datasource.options.minDate)\"\r\n            [min]=\"handleDate(datasource.options.minDate)\"\r\n            [max]=\"(endValue && (!restrictedToStep()))?endValue:handleDate(datasource.options.maxDate)\" \r\n            [disabled]= \"filterStateDisable\">\r\n          <span class=\"filler\"></span>\r\n          <mat-datepicker\r\n            #beginDatepicker\r\n            [startView]=\"calendarView()\"\r\n            [startAt]=\"beginValue\"\r\n            (yearSelected)=\"yearSelected($event, beginDatepicker, 'begin')\"\r\n            (monthSelected)=\"monthSelected($event, beginDatepicker, 'begin')\">\r\n          </mat-datepicker>\r\n        </mat-form-field>\r\n\r\n        <div class=\"time-input\">\r\n          <mat-form-field class=\"hour-input\" *ngIf=\"calendarType()==='datetime'\">\r\n            <mat-label>{{'igo.geo.timeFilter.hour' | translate}}</mat-label>\r\n            <mat-select\r\n              [formControl]=\"beginHourFormControl\"\r\n              [attr.disabled]=\"!currentFilter.active\"\r\n              (selectionChange)=\"changeTemporalProperty(begin.value, 1)\">\r\n              <mat-option *ngFor=\"let hour of beginHours\" [value]=\"hour\">{{hour}}</mat-option>\r\n            </mat-select>\r\n          </mat-form-field>\r\n          <mat-form-field class=\"minute-input\" *ngIf=\"calendarType()==='datetime'\">\r\n            <mat-label>{{'igo.geo.timeFilter.minute' | translate}}</mat-label>\r\n            <mat-select\r\n              [formControl]=\"beginMinuteFormControl\"\r\n              [attr.disabled]=\"!currentFilter.active\"\r\n              (selectionChange)=\"changeTemporalProperty(begin.value, 1)\">\r\n              <mat-option *ngFor=\"let minute of beginMinutes\" [value]=\"minute\">{{minute}}</mat-option>\r\n            </mat-select>\r\n          </mat-form-field>\r\n        </div>\r\n      </div>\r\n\r\n      <div class=\"datetime-input\" *ngIf=\"!restrictedToStep()\">\r\n        <mat-form-field class=\"date-input\">\r\n          <mat-datepicker-toggle matSuffix [for]=\"endDatepicker\" [disabled]= \"filterStateDisable\"></mat-datepicker-toggle>\r\n            <input #end\r\n              matInput\r\n              [matDatepicker]=\"endDatepicker\"\r\n              [placeholder]=\"'igo.geo.timeFilter.endDate' | translate\"\r\n              [attr.disabled]=\"!currentFilter.active\"\r\n              (dateChange)=\"changeTemporalProperty(end.value, 2)\"\r\n              [matDatepickerFilter]=\"dateFilter.bind(this, 'end')\"\r\n              [value]=\"endValue?endValue:handleDate(datasource.options.maxDate)\"\r\n              [min]=\"beginValue?beginValue:handleDate(datasource.options.minDate)\"\r\n              [max]=\"handleDate(datasource.options.maxDate)\" \r\n              [disabled]= \"filterStateDisable\">\r\n            <span class=\"filler\"></span>\r\n            <mat-datepicker #endDatepicker\r\n              [startView]=\"calendarView()\"\r\n              [startAt]=\"endValue\"\r\n              (yearSelected)=\"yearSelected($event, endDatepicker, 'end')\"\r\n              (monthSelected)=\"monthSelected($event, endDatepicker, 'end')\">\r\n          </mat-datepicker>\r\n        </mat-form-field>\r\n\r\n        <div class=\"time-input\">\r\n          <mat-form-field class=\"hour-input\" *ngIf=\"calendarType()==='datetime'\" >\r\n            <mat-label>{{'igo.geo.timeFilter.hour' | translate}}</mat-label>\r\n            <mat-select\r\n              [formControl]=\"endHourFormControl\"\r\n              [attr.disabled]=\"!currentFilter.active\"\r\n              (selectionChange)=\"changeTemporalProperty(end.value, 2)\">\r\n              <mat-option *ngFor=\"let hour of endHours\" [value]=\"hour\">{{hour}}</mat-option>\r\n            </mat-select>\r\n          </mat-form-field>\r\n          <mat-form-field class=\"minute-input\" *ngIf=\"calendarType()==='datetime'\">\r\n            <mat-label>{{'igo.geo.timeFilter.minute' | translate}}</mat-label>\r\n            <mat-select\r\n              [formControl]=\"endMinuteFormControl\"\r\n              [attr.disabled]=\"!currentFilter.active\"\r\n              (selectionChange)=\"changeTemporalProperty(end.value, 2)\">\r\n              <mat-option *ngFor=\"let minute of endMinutes\" [value]=\"minute\">{{minute}}</mat-option>\r\n            </mat-select>\r\n          </mat-form-field>\r\n        </div>\r\n      </div>\r\n\r\n      <button class=\"reset-button\" \r\n        mat-icon-button color=\"primary\"\r\n        (click)=\"resetFilter()\" \r\n        [matTooltip]=\"'igo.geo.filter.resetFilters' | translate\" \r\n        [disabled]= \"filterStateDisable\">\r\n        <mat-icon svgIcon=\"{{resetIcon}}\"></mat-icon>\r\n      </button>\r\n      <mat-slide-toggle \r\n        class=\"toggle-filter-state\" \r\n        (change)=\"toggleFilterState()\" \r\n        tooltip-position=\"below\" \r\n        matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.geo.filter.toggleFilterState' | translate\" \r\n        [checked]= \"!filterStateDisable\">\r\n      </mat-slide-toggle>\r\n    </div>\r\n  </div>\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ViewChild,\r\n  ElementRef,\r\n  Output,\r\n  EventEmitter,\r\n  OnInit\r\n} from '@angular/core';\r\nimport { FormControl } from '@angular/forms';\r\nimport { OgcFilterOperator } from '../../filter/shared/ogc-filter.enum';\r\nimport { OGCFilterTimeService } from '../shared/ogc-filter-time.service';\r\nimport {\r\n  OgcFilterableDataSourceOptions,\r\n  OgcFilterableDataSource,\r\n  OgcFilterDuringOptions\r\n} from '../shared/ogc-filter.interface';\r\n\r\nimport * as moment_ from 'moment';\r\nconst moment = moment_;\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filter-time',\r\n  templateUrl: './ogc-filter-time.component.html',\r\n  styleUrls: ['./ogc-filter-time.component.scss']\r\n})\r\nexport class OgcFilterTimeComponent implements OnInit {\r\n  @Input() datasource: OgcFilterableDataSource;\r\n  @Input() currentFilter: any;\r\n  @Output() changeProperty: EventEmitter<{\r\n    value: string;\r\n    pos: number;\r\n    refreshFilter: boolean;\r\n  }> = new EventEmitter<any>();\r\n\r\n  beginHours: number[];\r\n  endHours: number[];\r\n  beginMinutes: number[];\r\n  endMinutes: number[];\r\n  beginHourFormControl = new FormControl();\r\n  beginMinuteFormControl = new FormControl();\r\n  endHourFormControl = new FormControl();\r\n  endMinuteFormControl = new FormControl();\r\n  _beginValue: Date;\r\n  _endValue: Date;\r\n  readonly _defaultMin: string = '1900-01-01';\r\n  readonly _defaultMax: string = '2052-01-06';\r\n  readonly _defaultDisplayFormat: string = 'DD/MM/YYYY HH:mm A';\r\n  readonly _defaultSliderModeEnabled: boolean = true;\r\n  ogcFilterOperator = OgcFilterOperator;\r\n  public sliderMode = false;\r\n\r\n  readonly defaultStepMillisecond = 60000;\r\n  public options: OgcFilterableDataSourceOptions;\r\n\r\n  public onlyYearBegin: number;\r\n  public onlyYearEnd: number;\r\n  public calendarTypeYear = false;\r\n  public resetIcon = 'replay';\r\n  public filterStateDisable: boolean;\r\n\r\n  @ViewChild('endDatepickerTime') endDatepickerTime: ElementRef;\r\n  @ViewChild('beginDatepickerTime') beginDatepickerTime: ElementRef;\r\n  @ViewChild('beginTime') beginTime: HTMLInputElement;\r\n  @ViewChild('endTime') endTime: HTMLInputElement;\r\n\r\n  get step(): string {\r\n    return this.datasource.options.stepDate\r\n      ? this.datasource.options.stepDate\r\n      : this.currentFilter.step;\r\n  }\r\n\r\n  get stepMilliseconds(): number {\r\n    const step = moment.duration(this.step).asMilliseconds();\r\n    return step === 0 ? this.defaultStepMillisecond : step;\r\n  }\r\n\r\n  set beginValue(begin: Date) {\r\n    this._beginValue = begin;\r\n  }\r\n\r\n  get beginValue(): Date {\r\n    return this._beginValue;\r\n  }\r\n\r\n  set endValue(end: Date) {\r\n    this._endValue = end;\r\n  }\r\n\r\n  get endValue(): Date {\r\n    return this._endValue;\r\n  }\r\n\r\n  get sliderInterval(): number {\r\n    return this.currentFilter.sliderInterval === undefined\r\n      ? 2000\r\n      : this.currentFilter.sliderInterval;\r\n  }\r\n\r\n  get maxDate(): string {\r\n    return this.datasource.options.maxDate ? this.datasource.options.maxDate : this._defaultMax;\r\n  }\r\n\r\n  get displayFormat(): string {\r\n    return this.currentFilter.displayFormat ? this.currentFilter.displayFormat : this._defaultDisplayFormat;\r\n  }\r\n\r\n  constructor(public ogcFilterTimeService: OGCFilterTimeService) {}\r\n\r\n  ngOnInit(){\r\n    if (this.currentFilter.sliderOptions) {\r\n      this.currentFilter.sliderOptions.enabled = this.currentFilter.sliderOptions.enabled !== undefined ?\r\n        this.currentFilter.sliderOptions.enabled : this._defaultSliderModeEnabled;\r\n    }\r\n    this.beginValue = this.parseFilter(this.handleMin());\r\n    this.endValue = this.parseFilter(this.handleMax());\r\n\r\n    this.onlyYearBegin = this.beginValue.getUTCFullYear();\r\n    this.onlyYearEnd = this.endValue.getUTCFullYear();\r\n    this.calendarTypeYear = this.isCalendarYearMode();\r\n    this.setFilterStateDisable();\r\n    this.updateHoursMinutesArray();\r\n    // update value for now value\r\n    this.updateValues();\r\n  }\r\n\r\n  parseFilter(filter): Date {\r\n    if (!filter){\r\n      return new Date();\r\n    } else if ( isNaN( new Date(filter).getTime() ) ){\r\n      if (filter.search('now') >= 0 ){\r\n        const interval = filter.match(/years|months|weeks|days|hours|seconds/);\r\n        if (filter.match(/\\+/)) {\r\n          const intervalInt = parseInt(\r\n            filter.substring(filter.search('+') + 1, interval.index),\r\n            10\r\n          );\r\n          return moment().add(intervalInt, interval[0]).toDate();\r\n        }\r\n        if (filter.match(/\\-/)) {\r\n          const intervalInt = parseInt(\r\n            filter.substring(filter.search('-') + 1, interval.index),\r\n            10\r\n          );\r\n          return moment().subtract(intervalInt, interval[0]).toDate();\r\n        }\r\n        return new Date();\r\n      }\r\n      if (filter.search('today') >= 0){\r\n        const _now = moment().endOf('day').toDate();\r\n        const interval = filter.match(/years|months|weeks|days|hours|seconds/);\r\n        if ( filter.match(/\\+/) ) {\r\n          const intervalInt = parseInt( filter.substring(filter.search('+') + 1, interval.index), 10 );\r\n          return moment(_now).add(intervalInt, interval[0]).toDate();\r\n        }\r\n        if ( filter.match(/\\-/) ) {\r\n          const intervalInt = parseInt(filter.substring(filter.search('-') + 1, interval.index), 10);\r\n          return moment(_now).subtract(intervalInt, interval[0]).toDate();\r\n        }\r\n        return _now;\r\n      }\r\n      return new Date();\r\n    }\r\n    if (this.currentFilter.calendarModeYear) {\r\n      const date = this.getDateFromStringWithoutTime(filter);\r\n      return date;\r\n    } else {\r\n      return filter ? new Date(filter) : new Date();\r\n    }\r\n  }\r\n\r\n  changeTemporalProperty(value, position?, refreshFilter = true) {\r\n    let valueTmp = this.getDateTime(value, position);\r\n    if (this.isCalendarYearMode()) {\r\n      let dateStringFromYearNotime;\r\n      if (position === 1) {\r\n        this.beginValue = value;\r\n        this.onlyYearBegin = this.beginValue.getFullYear();\r\n        dateStringFromYearNotime = `${this.onlyYearBegin}-01-01`;\r\n      } else {\r\n        this.endValue = value;\r\n        this.onlyYearEnd = this.endValue.getFullYear();\r\n        dateStringFromYearNotime = `${this.onlyYearEnd}-01-01`;\r\n      }\r\n      // call service with string date without time\r\n      this.changeProperty.next({ value: dateStringFromYearNotime, pos: position, refreshFilter });\r\n      return;\r\n    }\r\n    if (position === 2 && this.calendarType() === 'date' && !this.sliderMode) {\r\n      /* Above month: see yearSelected or monthSelected */\r\n      valueTmp = moment(valueTmp).endOf('day').toDate();\r\n    }\r\n\r\n    if (position === 1) {\r\n      this.beginValue = valueTmp;\r\n      if (this.restrictedToStep()) {\r\n        this.changeTemporalProperty(this.ogcFilterTimeService.addStep(valueTmp, this.stepMilliseconds), 2, refreshFilter);\r\n      }\r\n    } else {\r\n      this.endValue = valueTmp;\r\n    }\r\n    this.updateHoursMinutesArray();\r\n    this.changeProperty.next({ value: valueTmp.toISOString(), pos: position, refreshFilter });\r\n  }\r\n\r\n  handleDate(value): Date {\r\n    if (!value || value === '') {\r\n      return undefined;\r\n    }\r\n    if (typeof(value) === 'string' && this.currentFilter.calendarModeYear) {\r\n      return this.getDateFromStringWithoutTime(value);\r\n    }\r\n    return new Date(value);\r\n  }\r\n\r\n  calendarType() {\r\n    if (this.currentFilter.calendarModeYear) {\r\n      return 'year';\r\n    }\r\n    if (this.stepMilliseconds < 86400000) {\r\n      return 'datetime';\r\n    }\r\n    return 'date';\r\n  }\r\n\r\n  isCalendarYearMode(): boolean {\r\n    if (this.calendarType() === 'year') {\r\n      return true;\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  yearOnlyInputChange(changeEvent, datePicker?: any, property?: string) {\r\n    const year = changeEvent.target.value;\r\n    const date = this.getDateFromStringWithoutTime(year);\r\n    this.yearSelected(date, datePicker, property);\r\n  }\r\n\r\n  yearSelected(year, datePicker?: any, property?: string, refreshFilter = true) {\r\n    if (this.ogcFilterTimeService.stepIsYearDuration(this.step)) {\r\n      if (datePicker) {\r\n        datePicker.close();\r\n      }\r\n      if (property === 'end') {\r\n        // change value 01 jan to 31 dec same year\r\n        year = moment(year).endOf('year').toDate();\r\n      } else if (property === 'begin' && this.restrictedToStep() && !this.calendarTypeYear) {\r\n        this.yearSelected(year, undefined, 'end');\r\n      }\r\n      this.changeTemporalProperty(year, property === 'begin' ? 1 : 2, refreshFilter);\r\n    }\r\n  }\r\n\r\n  monthSelected(month, datePicker?: any, property?: string, refreshFilter = true) {\r\n    if (this.ogcFilterTimeService.stepIsMonthDuration(this.step)) {\r\n      if (datePicker) {\r\n        datePicker.close();\r\n      }\r\n      if (property === 'end') {\r\n        month = moment(month).endOf('month').toDate();\r\n      } else if (property === 'begin' && this.restrictedToStep()) {\r\n        this.monthSelected(month, undefined, 'end');\r\n      }\r\n      this.changeTemporalProperty(month, property === 'begin' ? 1 : 2, refreshFilter);\r\n    }\r\n  }\r\n\r\n  calendarView() {\r\n    const test = this.stepMilliseconds;\r\n    const diff = Math.abs(\r\n      this.parseFilter(this.currentFilter.end).getTime() -\r\n        this.parseFilter(this.currentFilter.begin).getTime()\r\n    );\r\n    if (this.ogcFilterTimeService.stepIsYearDuration(this.step)) {\r\n      return 'multi-year';\r\n    } else if (this.ogcFilterTimeService.stepIsMonthDuration(this.step)) {\r\n      return 'year';\r\n    } else if (test < 86400000 && diff < 86400000) {\r\n      return 'clock';\r\n    } else {\r\n      return 'month';\r\n    }\r\n  }\r\n\r\n  dateFilter(type: string, date: string): boolean {\r\n    const dateValue = new Date(date);\r\n    const diff = dateValue.getTime() - new Date(this.handleMin()).getTime();\r\n\r\n    if (this.ogcFilterTimeService.stepIsYearDuration(this.step)) {\r\n      const monthDiff = moment(dateValue).diff(moment(this.handleMin()), 'years', true);\r\n      if ( type === 'end' ) {\r\n        const dateValuePlus1 = moment(dateValue).add(1, 'd');\r\n        const monthDiffPlus1 = moment(dateValuePlus1).diff(moment(this.handleMin()), 'years', true);\r\n        return (monthDiffPlus1 % moment.duration(this.step).asYears()) === 0;\r\n      } else if ( type === 'begin' ) {\r\n        return (monthDiff % moment.duration(this.step).asYears()) === 0;\r\n      }\r\n    }\r\n    else if (this.ogcFilterTimeService.stepIsMonthDuration(this.step)) {\r\n      const monthDiff = moment(dateValue).diff(moment(this.handleMin()), 'months', true);\r\n      if ( type === 'end' ) {\r\n        const dateValuePlus1 = moment(dateValue).add(1, 'd');\r\n        const monthDiffPlus1 = moment(dateValuePlus1).diff(moment(this.handleMin()), 'months', true);\r\n        return (monthDiffPlus1 % moment.duration(this.step).asMonths()) === 0;\r\n      } else if ( type === 'begin' ) {\r\n        return (monthDiff % moment.duration(this.step).asMonths()) === 0;\r\n      }\r\n    } else if (this.ogcFilterTimeService.stepIsWeekDuration(this.step)) {\r\n      const weekDiff = moment(dateValue).diff(moment(this.handleMin()), 'weeks', true);\r\n      if ( type === 'end' ) {\r\n        const dateValuePlus1 = moment(dateValue).add(1, 'd');\r\n        const weekDiffPlus1 = moment(dateValuePlus1).diff(moment(this.handleMin()), 'weeks', true);\r\n        return (weekDiffPlus1 % moment.duration(this.step).asWeeks()) === 0;\r\n      } else if ( type === 'begin' ) {\r\n        return (weekDiff % moment.duration(this.step).asWeeks()) === 0;\r\n      }\r\n    } else if (this.ogcFilterTimeService.stepIsDayDuration(this.step)) {\r\n      const dayDiff = moment(dateValue).diff(moment(this.handleMin()), 'days', true);\r\n      if ( type === 'end' ) {\r\n        const dateValuePlus1 = moment(dateValue).add(1, 'd');\r\n        const dayDiffPlus1 = moment(dateValuePlus1).diff(moment(this.handleMin()), 'days', true);\r\n        const _mod = (dayDiffPlus1 % moment.duration(this.step).asDays());\r\n        return (_mod < 0.0000001 && _mod > -0.0000001) || _mod === 0 ; // 1 millisecond = 1.1574074074074076e-8\r\n      } else if ( type === 'begin' ) {\r\n        const _mod = ((dayDiff % moment.duration(this.step).asDays()) + 1);\r\n        return (_mod < 0.0000001 && _mod > -0.0000001 && _mod !== 0) || _mod === 1 ; // 1 millisecond = 1.1574074074074076e-8\r\n      }\r\n    } else if ( this.ogcFilterTimeService.stepIsHourDuration(this.step) ) {\r\n      const hourDiff = moment(dateValue).diff(moment(this.handleMin()), 'hours', true);\r\n      return (hourDiff % moment.duration(this.step).asHours()) === 0;\r\n\r\n    } else if ( this.ogcFilterTimeService.stepIsMinuteDuration(this.step) ) {\r\n      return true;\r\n    }\r\n\r\n    return diff % this.stepMilliseconds === 0;\r\n  }\r\n\r\n  getDateTime(date, pos) {\r\n    const valuetmp = new Date(date);\r\n    let valuetmp2;\r\n    if (!this.sliderMode) {\r\n      switch (pos) {\r\n        case 1: {\r\n          if (this.currentFilter.calendarModeYear) {\r\n            valuetmp2 = valuetmp.setHours(0, 0);\r\n            break;\r\n          } else {\r\n            valuetmp2 = valuetmp.setHours(\r\n            this.beginHourFormControl.value,\r\n            this.beginMinuteFormControl.value\r\n            );\r\n            break;\r\n          }\r\n        }\r\n        case 2: {\r\n          if (this.currentFilter.calendarModeYear) {\r\n            valuetmp2 = valuetmp.setHours(0, 0);\r\n            break;\r\n          } else {\r\n            valuetmp2 = valuetmp.setHours(\r\n              this.endHourFormControl.value,\r\n              this.endMinuteFormControl.value\r\n            );\r\n            break;\r\n          }\r\n        }\r\n      }\r\n    }\r\n    return new Date(valuetmp2 ? valuetmp2 : valuetmp);\r\n  }\r\n\r\n  handleMinuteIncrement() {\r\n    if (this.ogcFilterTimeService.stepIsMinuteDuration(this.step)) {\r\n      if (this.stepMilliseconds < 3600000) {\r\n        return this.stepMilliseconds / 1000 === 60 ? 1 : this.stepMilliseconds / 1000;\r\n      } else {\r\n        return (this.stepMilliseconds % 3600000) / 60;\r\n      }\r\n    } else if (this.ogcFilterTimeService.stepIsHourDuration(this.step)) {\r\n      return 60;\r\n    }\r\n    return 1;\r\n  }\r\n\r\n  handleHourIncrement() {\r\n    if (this.ogcFilterTimeService.stepIsHourDuration(this.step)) {\r\n      return this.stepMilliseconds / 1000 / 60 / 60;\r\n    }\r\n    return 1;\r\n  }\r\n\r\n  fullBeginHoursArray(checkEndValue?) {\r\n    if (checkEndValue) {\r\n      this.beginHours = Array.from(\r\n        {\r\n          length:\r\n            (this.endHourFormControl.value - 0) / this.handleHourIncrement() + 1\r\n        },\r\n        (_, i) => 0 + i * this.handleHourIncrement()\r\n      );\r\n    } else {\r\n      this.beginHours = Array.from(\r\n        { length: (23 - 0) / this.handleHourIncrement() + 1 },\r\n        (_, i) => 0 + i * this.handleHourIncrement()\r\n      );\r\n    }\r\n    this.beginHourFormControl.setValue(this.beginValue.getHours());\r\n  }\r\n\r\n  fullEndHoursArray(checkEndValue?) {\r\n    if (checkEndValue) {\r\n      this.endHours = Array.from(\r\n        {\r\n          length:\r\n            (23 - this.beginHourFormControl.value) /\r\n              this.handleHourIncrement() +\r\n            1\r\n        },\r\n        (_, i) =>\r\n          this.beginHourFormControl.value + i * this.handleHourIncrement()\r\n      );\r\n    } else {\r\n      this.endHours = Array.from(\r\n        { length: (23 - 0) / this.handleHourIncrement() + 1 },\r\n        (_, i) => 0 + i * this.handleHourIncrement()\r\n      );\r\n    }\r\n    this.endHourFormControl.setValue(this.endValue.getHours());\r\n  }\r\n\r\n  fullBeginMinutesArray(checkEndValue?) {\r\n    if (checkEndValue) {\r\n      this.beginMinutes = Array.from(\r\n        {\r\n          length:\r\n            (this.endMinuteFormControl.value - 0) /\r\n              this.handleMinuteIncrement() +\r\n            1\r\n        },\r\n        (_, i) => 0 + i * this.handleMinuteIncrement()\r\n      );\r\n    } else {\r\n      this.beginMinutes = Array.from(\r\n        { length: (59 - 0) / this.handleMinuteIncrement() + 1 },\r\n        (_, i) => 0 + i * this.handleMinuteIncrement()\r\n      );\r\n    }\r\n    this.beginMinuteFormControl.setValue(this.beginValue.getMinutes());\r\n  }\r\n\r\n  fullEndMinutesArray(checkEndValue?) {\r\n    if (checkEndValue) {\r\n      this.endMinutes = Array.from(\r\n        {\r\n          length:\r\n            (59 - this.beginMinuteFormControl.value) /\r\n              this.handleMinuteIncrement() +\r\n            1\r\n        },\r\n        (_, i) =>\r\n          this.beginMinuteFormControl.value + i * this.handleMinuteIncrement()\r\n      );\r\n    } else {\r\n      this.endMinutes = Array.from(\r\n        { length: (59 - 0) / this.handleMinuteIncrement() + 1 },\r\n        (_, i) => 0 + i * this.handleMinuteIncrement()\r\n      );\r\n    }\r\n    this.endMinuteFormControl.setValue(this.endValue.getMinutes());\r\n  }\r\n\r\n  updateHoursMinutesArray() {\r\n    const beginTmp = new Date(this.beginValue);\r\n    const endTmp = new Date(this.endValue);\r\n    if (beginTmp.setHours(0, 0) === endTmp.setHours(0, 0)) {\r\n      this.fullBeginHoursArray(true);\r\n      this.fullEndHoursArray(true);\r\n      if (this.beginValue.getHours() === this.endValue.getHours()) {\r\n        this.fullBeginMinutesArray(true);\r\n        this.fullEndMinutesArray(true);\r\n      }\r\n    } else {\r\n      this.fullBeginHoursArray();\r\n      this.fullEndHoursArray();\r\n      this.fullBeginMinutesArray();\r\n      this.fullEndMinutesArray();\r\n    }\r\n  }\r\n\r\n  private updateValues() {\r\n    this.changeTemporalProperty(this.beginValue, 1, false);\r\n    this.changeTemporalProperty(this.endValue, 2, true);\r\n  }\r\n\r\n  public restrictedToStep(): boolean {\r\n    return this.currentFilter.restrictToStep\r\n      ? this.currentFilter.restrictToStep : false;\r\n  }\r\n\r\n  public handleMin() {\r\n    return this.currentFilter.begin ? this.currentFilter.begin :\r\n              (this.datasource.options.minDate ? this.datasource.options.minDate : this._defaultMin);\r\n  }\r\n\r\n  public handleMax() {\r\n    return this.currentFilter.end ? this.currentFilter.end :\r\n              (this.datasource.options.maxDate ? this.datasource.options.maxDate : this._defaultMax);\r\n  }\r\n\r\n  changePropertyByPass(event) {\r\n    this.changeProperty.next(event);\r\n  }\r\n\r\n  modeChange(event) {\r\n    if (!event.checked) {\r\n      this.updateValues();\r\n    }\r\n  }\r\n\r\n  setFilterStateDisable() {\r\n    if (this.currentFilter) {\r\n      this.filterStateDisable = !this.currentFilter.active;\r\n    } else {\r\n      this.filterStateDisable = false;\r\n    }\r\n    if(this.calendarType() === 'datetime') {\r\n      if (this.filterStateDisable === true) {\r\n        this.beginHourFormControl.disable();\r\n        this.beginMinuteFormControl.disable();\r\n        this.endHourFormControl.disable();\r\n        this.endMinuteFormControl.disable();\r\n      } else {\r\n        this.beginHourFormControl.enable();\r\n        this.beginMinuteFormControl.enable();\r\n        this.endHourFormControl.enable();\r\n        this.endMinuteFormControl.enable();\r\n      }\r\n    }\r\n  }\r\n  getDateFromStringWithoutTime(stringDate: string): Date {\r\n    // warning create date with no time make a date UTC with TZ and the date create maybe not the same year, month and day\r\n    // exemple:\r\n    // new Date('2022-01-01') -> Fri Dec 31 2021 19:00:00 GMT-0500 (heure normale de lEst nord-amricain)\r\n    // to create same date as string, add time 00 in the creation\r\n    // new Date('2022-01-01 00:00:00') -> Sat Jan 01 2022 00:00:00 GMT-0500 (heure normale de lEst nord-amricain)\r\n    let year;\r\n    let month = '01';\r\n    let day = '01';\r\n    if (stringDate.length === 10) {\r\n       const dateItems = stringDate.split('-');\r\n        if (dateItems.length !== 3) {\r\n          throw new Error('Error in config date begin-end for ogcFilter: Date without time format need to be YYYY-MM-DD or YYYY');\r\n        } else {\r\n          year = dateItems[0];\r\n          month = dateItems[1];\r\n          day = dateItems[2];\r\n        }\r\n    } else if (stringDate.length === 4) {\r\n      year = stringDate;\r\n    } else {\r\n      return new Date(stringDate);\r\n    }\r\n    return new Date(`${year}-${month}-${day} 00:00:00`);\r\n  }\r\n\r\n  resetFilter() {\r\n    let filterOriginConfig = this.datasource.options.ogcFilters.filters as OgcFilterDuringOptions;\r\n\r\n    let minDefaultDate;\r\n    let maxDefaultDate;\r\n    let minDefaultISOString;\r\n    let maxDefaultISOString;\r\n\r\n    if (this.calendarTypeYear) {\r\n      if (filterOriginConfig.end === 'today') {\r\n        let todayDateStringNoTime = new Date().toLocaleDateString('en-CA'); // '2022-02-13'\r\n        maxDefaultISOString = `${todayDateStringNoTime.substring(0,4)}-01-01`;\r\n      } else {\r\n        maxDefaultISOString = `${filterOriginConfig.end.substring(0,4)}-01-01`;\r\n      }\r\n      minDefaultISOString = `${filterOriginConfig.begin.substring(0,4)}-01-01`;\r\n      minDefaultDate = this.getDateFromStringWithoutTime(minDefaultISOString);\r\n      maxDefaultDate = this.getDateFromStringWithoutTime(maxDefaultISOString);\r\n    } else {\r\n      minDefaultDate = this.parseFilter(filterOriginConfig.begin);\r\n      maxDefaultDate = this.parseFilter(filterOriginConfig.end);\r\n      minDefaultISOString = minDefaultDate.toISOString();\r\n      maxDefaultISOString = maxDefaultDate.toISOString();\r\n    }\r\n\r\n    if ((this.currentFilter.begin !== minDefaultISOString ) ||\r\n    (this.currentFilter.end !== maxDefaultISOString)) {\r\n      this.beginValue = minDefaultDate;\r\n      this.endValue = maxDefaultDate;\r\n      this.updateValues();\r\n    }\r\n  }\r\n\r\n  toggleFilterState() {\r\n    if (this.currentFilter.active === true) {\r\n      this.currentFilter.active = false;\r\n    } else {\r\n      this.currentFilter.active = true;\r\n    }\r\n    this.setFilterStateDisable();\r\n    this.updateValues();\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  ViewChild,\r\n  Output,\r\n  EventEmitter,\r\n  OnInit\r\n} from '@angular/core';\r\nimport { OGCFilterTimeService } from '../shared/ogc-filter-time.service';\r\n\r\nimport * as moment_ from 'moment';\r\nimport { MatSlider } from '@angular/material/slider';\r\nconst moment = moment_;\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filter-time-slider',\r\n  templateUrl: './ogc-filter-time-slider.component.html',\r\n  styleUrls: ['./ogc-filter-time-slider.component.scss']\r\n})\r\nexport class OgcFilterTimeSliderComponent implements OnInit {\r\n  @Input() currentFilter: any;\r\n  @Input() begin: any;\r\n  @Input() max: any;\r\n  @Input() datasource: any;\r\n  @Output() changeProperty: EventEmitter<{\r\n    value: any;\r\n    pos: number;\r\n    refreshFilter: boolean;\r\n  }> = new EventEmitter<any>();\r\n  @ViewChild(MatSlider) slider: MatSlider;\r\n\r\n  interval;\r\n  sliderValue: number = 1;\r\n  calculatedStep: number = 0;\r\n  readonly _defaultDisplayFormat: string = 'DD/MM/YYYY HH:mm A';\r\n  readonly _defaultSliderInterval: number = 2000;\r\n  public playIcon = 'play-circle';\r\n  public resetIcon = 'replay';\r\n\r\n  get sliderInterval(): number {\r\n    return this.currentFilter.sliderInterval === undefined\r\n      ? this._defaultSliderInterval\r\n      : this.currentFilter.sliderInterval;\r\n  }\r\n\r\n  get displayFormat(): string {\r\n    if (this.currentFilter.sliderOptions?.displayFormat){\r\n      return this.currentFilter.sliderOptions.displayFormat;\r\n    }\r\n    if (this.currentFilter.displayFormat) {\r\n      return this.currentFilter.displayFormat;\r\n    }\r\n    return this._defaultDisplayFormat;\r\n  }\r\n\r\n  get beginMillisecond(): number {\r\n    return this.ogcFilterTimeService.dateToNumber(this.begin);\r\n  }\r\n\r\n  get maxMillisecond(): number {\r\n    return this.ogcFilterTimeService.dateToNumber(this.max);\r\n  }\r\n\r\n  get stepMillisecond(): number {\r\n    return this.ogcFilterTimeService.stepMillisecond(this.datasource, this.currentFilter);\r\n  }\r\n\r\n  constructor(public ogcFilterTimeService: OGCFilterTimeService) {\r\n    this.sliderDisplayWith = this.sliderDisplayWith.bind(this);\r\n  }\r\n\r\n  ngOnInit(){\r\n    this.calculateStep();\r\n    this.handleSliderInput({value: 1});\r\n  }\r\n\r\n  sliderDisplayWith(value) {\r\n    let dateTmp = new Date(this.beginMillisecond + ((value - 1) * this.stepMillisecond));\r\n\r\n    if (this.ogcFilterTimeService.stepIsYearDuration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter))) {\r\n      const toAdd = moment.duration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)).years();\r\n      dateTmp = moment(this.beginMillisecond).add((value - 1) * toAdd, 'year').toDate();\r\n    } else if ( this.ogcFilterTimeService.stepIsMonthDuration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter))) {\r\n      const toAdd = moment.duration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)).months();\r\n      dateTmp = moment(this.beginMillisecond).add((value - 1) * toAdd, 'month').toDate();\r\n    }\r\n\r\n    return moment(dateTmp).format(this.displayFormat);\r\n  }\r\n\r\n  playFilter(event: any) {\r\n    if (this.interval) {\r\n      this.stopFilter();\r\n    } else {\r\n      this.playIcon = 'pause-circle';\r\n      this.interval = setInterval(\r\n        that => {\r\n\r\n          if (this.slider.value < this.calculatedStep) {\r\n            const _increment = '_increment';\r\n            const _emitInputEvent = '_emitInputEvent';\r\n            this.slider[_increment](1);\r\n            this.slider[_emitInputEvent]();\r\n          } else {\r\n            this.stopFilter();\r\n          }\r\n        },\r\n        this.sliderInterval,\r\n        this\r\n      );\r\n    }\r\n  }\r\n\r\n  stopFilter() {\r\n    if (this.interval) {\r\n      clearInterval(this.interval);\r\n    }\r\n    this.interval = undefined;\r\n    this.playIcon = 'play-circle';\r\n  }\r\n\r\n  resetFilter(event: any) {\r\n    if (this.interval) {\r\n      clearInterval(this.interval);\r\n    }\r\n    this.interval = undefined;\r\n    this.playIcon = 'play-circle';\r\n    this.slider.value = 1;\r\n    const _increment = '_increment';\r\n    const _emitInputEvent = '_emitInputEvent';\r\n    this.slider[_emitInputEvent]();\r\n  }\r\n\r\n  handleSliderInput(matSliderChange) {\r\n    if (matSliderChange) {\r\n\r\n      if ( this.ogcFilterTimeService.stepIsYearDuration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)) ) {\r\n        const toAdd = moment.duration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)).years();\r\n        const dateBeginTmp = moment(this.beginMillisecond).add((matSliderChange.value - 1) * toAdd, 'year').toDate();\r\n        const dateEndTmp = moment(dateBeginTmp).add(toAdd, 'year').toDate();\r\n        this.changeProperty.next({value: moment(dateBeginTmp).toDate().toISOString(),\r\n                                    pos: 1, refreshFilter: false});\r\n        this.changeProperty.next({value: moment(dateEndTmp).toDate().toISOString(),\r\n                                    pos: 2, refreshFilter: true});\r\n\r\n      } else if ( this.ogcFilterTimeService.stepIsMonthDuration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)) ) {\r\n        const toAdd = moment.duration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)).months();\r\n        const dateBeginTmp = moment(this.beginMillisecond).add((matSliderChange.value - 1) * toAdd, 'month').toDate();\r\n        const dateEndTmp = moment(dateBeginTmp).add(toAdd, 'month').toDate();\r\n        this.changeProperty.next({value: moment(dateBeginTmp).startOf('month').toDate().toISOString(),\r\n                                    pos: 1, refreshFilter: false});\r\n        this.changeProperty.next({value: moment(dateEndTmp).toDate().toISOString(),\r\n                                    pos: 2, refreshFilter: true});\r\n\r\n      } else if ( this.ogcFilterTimeService.stepIsDayDuration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)) ||\r\n          this.ogcFilterTimeService.stepIsHourDuration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)) ||\r\n          this.ogcFilterTimeService.stepIsMinuteDuration(this.ogcFilterTimeService.step(this.datasource, this.currentFilter)) ) {\r\n            const dateTmp = new Date(this.beginMillisecond + (this.stepMillisecond * (matSliderChange.value - 1)));\r\n            this.changeProperty.next({value: dateTmp.toISOString(), pos: 1, refreshFilter: false});\r\n            this.changeProperty.next({value: new Date(this.ogcFilterTimeService.addStep(dateTmp.toISOString(),\r\n                                        this.stepMillisecond)).toISOString(),\r\n                                        pos: 2, refreshFilter: true});\r\n      }\r\n    }\r\n  }\r\n\r\n  calculateStep(){\r\n    for (let i = 1; (this.maxMillisecond - (this.beginMillisecond + (i * this.stepMillisecond))) >= -1; i++) {\r\n      this.calculatedStep = i;\r\n    }\r\n  }\r\n\r\n}\r\n","<div class=\"slider-container\">\r\n  <mat-slider\r\n    id=\"time-slider\"\r\n    [step]=\"1\"\r\n    [min]=\"1\"\r\n    [max]=\"calculatedStep\"\r\n    [(ngModel)]=\"sliderValue\"\r\n    [displayWith]=\"sliderDisplayWith\"\r\n    (input)=\"handleSliderInput($event)\"\r\n    thumbLabel\r\n    >\r\n  </mat-slider>\r\n  <button mat-icon-button color=\"primary\" (click)=\"playFilter($event)\">\r\n    <mat-icon [svgIcon]=\"playIcon\"></mat-icon>\r\n  </button>\r\n  <button mat-icon-button color=\"primary\" (click)=\"resetFilter($event)\">\r\n    <mat-icon svgIcon=\"{{resetIcon}}\"></mat-icon>\r\n  </button>\r\n  \r\n</div>","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { MatAutocompleteModule } from '@angular/material/autocomplete';\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatButtonToggleModule } from '@angular/material/button-toggle';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatOptionModule, MatNativeDateModule, MAT_DATE_LOCALE } from '@angular/material/core';\r\nimport { MatDatepickerModule } from '@angular/material/datepicker';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatMenuModule } from '@angular/material/menu';\r\nimport { MatRadioModule } from '@angular/material/radio';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatSlideToggleModule } from '@angular/material/slide-toggle';\r\nimport { MatSliderModule } from '@angular/material/slider';\r\nimport { MatTableModule } from '@angular/material/table';\r\nimport { MatTabsModule } from '@angular/material/tabs';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\nimport { MatTreeModule } from '@angular/material/tree';\r\n\r\nimport {\r\n  MatDatetimepickerModule,\r\n  MatNativeDatetimeModule\r\n} from '@mat-datetimepicker/core';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport {\r\n  IgoCollapsibleModule,\r\n  IgoListModule,\r\n  IgoKeyValueModule,\r\n  IgoEntityModule,\r\n  IgoDOMModule\r\n} from '@igo2/common';\r\nimport { IgoGeometryModule } from './../geometry/geometry.module';\r\n\r\nimport { FilterableDataSourcePipe } from './shared/filterable-datasource.pipe';\r\nimport { IgoLayerModule } from '../layer/layer.module';\r\nimport { TimeFilterButtonComponent } from './time-filter-button/time-filter-button.component';\r\nimport { TimeFilterFormComponent } from './time-filter-form/time-filter-form.component';\r\nimport { TimeFilterItemComponent } from './time-filter-item/time-filter-item.component';\r\nimport { TimeFilterListBindingDirective } from './time-filter-list/time-filter-list-binding.directive';\r\nimport { TimeFilterListComponent } from './time-filter-list/time-filter-list.component';\r\nimport { TimeFilterService } from './shared/time-filter.service';\r\n\r\nimport { OgcFilterFormComponent } from './ogc-filter-form/ogc-filter-form.component';\r\nimport { OgcFilterableFormComponent } from './ogc-filterable-form/ogc-filterable-form.component';\r\nimport { OgcFilterableItemComponent } from './ogc-filterable-item/ogc-filterable-item.component';\r\nimport { OgcFilterableListBindingDirective } from './ogc-filterable-list/ogc-filterable-list-binding.directive';\r\nimport { OgcFilterableListComponent } from './ogc-filterable-list/ogc-filterable-list.component';\r\nimport { OgcFilterButtonComponent } from './ogc-filter-button/ogc-filter-button.component';\r\nimport { OGCFilterService } from './shared/ogc-filter.service';\r\nimport { OGCFilterTimeService } from './shared/ogc-filter-time.service';\r\nimport { OgcFilterSelectionComponent } from './ogc-filter-selection/ogc-filter-selection.component';\r\n\r\nimport { SpatialFilterTypeComponent } from './spatial-filter/spatial-filter-type/spatial-filter-type.component';\r\nimport { SpatialFilterListComponent } from './spatial-filter/spatial-filter-list/spatial-filter-list.component';\r\nimport { SpatialFilterItemComponent } from './spatial-filter/spatial-filter-item/spatial-filter-item.component';\r\nimport { SpatialFilterService } from './shared/spatial-filter.service';\r\nimport { OgcFilterTimeComponent } from './ogc-filter-time/ogc-filter-time.component';\r\nimport { OgcFilterTimeSliderComponent } from './ogc-filter-time/ogc-filter-time-slider.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    MatAutocompleteModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatTabsModule,\r\n    MatRadioModule,\r\n    MatMenuModule,\r\n    MatTableModule,\r\n    MatTreeModule,\r\n    MatButtonToggleModule,\r\n    MatCheckboxModule,\r\n    MatSliderModule,\r\n    MatSlideToggleModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatOptionModule,\r\n    MatSelectModule,\r\n    MatListModule,\r\n    MatTooltipModule,\r\n    MatDatepickerModule,\r\n    MatNativeDateModule,\r\n    MatDatetimepickerModule,\r\n    MatNativeDatetimeModule,\r\n    IgoLanguageModule,\r\n    IgoLayerModule,\r\n    IgoCollapsibleModule,\r\n    IgoListModule,\r\n    IgoEntityModule,\r\n    IgoDOMModule,\r\n    IgoKeyValueModule,\r\n    IgoGeometryModule,\r\n    MatBadgeModule\r\n  ],\r\n  exports: [\r\n    FilterableDataSourcePipe,\r\n    TimeFilterButtonComponent,\r\n    TimeFilterFormComponent,\r\n    TimeFilterItemComponent,\r\n    TimeFilterListComponent,\r\n    TimeFilterListBindingDirective,\r\n    OgcFilterFormComponent,\r\n    OgcFilterButtonComponent,\r\n    OgcFilterSelectionComponent,\r\n    OgcFilterableFormComponent,\r\n    OgcFilterableItemComponent,\r\n    OgcFilterableListComponent,\r\n    OgcFilterableListBindingDirective,\r\n    SpatialFilterTypeComponent,\r\n    SpatialFilterListComponent,\r\n    SpatialFilterItemComponent,\r\n    OgcFilterTimeComponent,\r\n    OgcFilterTimeSliderComponent\r\n  ],\r\n  declarations: [\r\n    FilterableDataSourcePipe,\r\n    TimeFilterButtonComponent,\r\n    TimeFilterFormComponent,\r\n    TimeFilterItemComponent,\r\n    TimeFilterListComponent,\r\n    TimeFilterListBindingDirective,\r\n    OgcFilterFormComponent,\r\n    OgcFilterButtonComponent,\r\n    OgcFilterSelectionComponent,\r\n    OgcFilterableFormComponent,\r\n    OgcFilterableItemComponent,\r\n    OgcFilterableListComponent,\r\n    OgcFilterableListBindingDirective,\r\n    SpatialFilterTypeComponent,\r\n    SpatialFilterListComponent,\r\n    SpatialFilterItemComponent,\r\n    OgcFilterTimeComponent,\r\n    OgcFilterTimeSliderComponent\r\n  ],\r\n  providers: [TimeFilterService, OGCFilterService, OGCFilterTimeService, SpatialFilterService]\r\n})\r\nexport class IgoFilterModule {\r\n  static forRoot(): ModuleWithProviders<IgoFilterModule> {\r\n    return {\r\n      ngModule: IgoFilterModule,\r\n      providers: [\r\n        {\r\n          provide: MAT_DATE_LOCALE,\r\n          useValue: 'fr-FR'\r\n        }\r\n      ]\r\n    };\r\n  }\r\n}\r\n","export class ExportError extends Error {}\r\n\r\nexport class ExportInvalidFileError extends ExportError {\r\n  constructor() {\r\n    super('Invalid file');\r\n    Object.setPrototypeOf(this, ExportInvalidFileError.prototype);\r\n  }\r\n}\r\n\r\nexport class ExportNothingToExportError extends ExportError {\r\n  constructor() {\r\n    super('Nothing to export');\r\n    Object.setPrototypeOf(this, ExportNothingToExportError.prototype);\r\n  }\r\n}\r\n","import { strEnum } from '@igo2/utils';\r\n\r\nexport const ExportFormat = strEnum(['URL', 'GeoJSON', 'GML', 'GPX', 'KML', 'Shapefile', 'CSVcomma', 'CSVsemicolon']);\r\nexport type ExportFormat = keyof typeof ExportFormat;\r\n\r\nexport const EncodingFormat = strEnum(['UTF8', 'LATIN1']);\r\nexport type EncodingFormat = keyof typeof EncodingFormat;\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { downloadContent } from '@igo2/utils';\r\n\r\nimport { Observable, Observer } from 'rxjs';\r\n\r\nimport * as olformat from 'ol/format';\r\nimport OlFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport {encode} from 'windows-1252';\r\n\r\nimport { ExportFormat, EncodingFormat } from './export.type';\r\n\r\nimport {\r\n  ExportInvalidFileError,\r\n  ExportNothingToExportError\r\n} from './export.errors';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ExportService {\r\n  static ogreFormats = {\r\n    GML: 'gml',\r\n    GPX: 'gpx',\r\n    KML: 'kml',\r\n    Shapefile: 'ESRI Shapefile',\r\n    CSVcomma: 'CSVcomma',\r\n    CSVsemicolon: 'CSVsemicolon'\r\n  };\r\n\r\n  static noOgreFallbacks = ['GML', 'GPX', 'KML'];\r\n\r\n  private ogreUrl: string;\r\n  private aggregateInComment: boolean = true;\r\n\r\n  constructor(private config: ConfigService) {\r\n    this.ogreUrl = this.config.getConfig('importExport.url');\r\n    const gpxAggregateInComment = this.config.getConfig(\r\n      'importExport.gpxAggregateInComment'\r\n    );\r\n    if (gpxAggregateInComment !== undefined) {\r\n      this.aggregateInComment = gpxAggregateInComment;\r\n    }\r\n  }\r\n\r\n  export(\r\n    olFeatures: OlFeature<OlGeometry>[],\r\n    format: ExportFormat,\r\n    title: string,\r\n    encoding: EncodingFormat,\r\n    projectionIn = 'EPSG:4326',\r\n    projectionOut = 'EPSG:4326'\r\n  ): Observable<void> {\r\n    const exportOlFeatures = this.generateFeature(olFeatures, format);\r\n\r\n    return this.exportAsync(exportOlFeatures, format, title, encoding, projectionIn, projectionOut);\r\n  }\r\n\r\n  private generateFeature(\r\n    olFeatures: OlFeature<OlGeometry>[],\r\n    format: ExportFormat\r\n  ): OlFeature<OlGeometry>[] {\r\n    if (format === ExportFormat.GPX && this.aggregateInComment) {\r\n      return this.generateAggregatedFeature(olFeatures);\r\n    }\r\n\r\n    return olFeatures.map((olFeature: OlFeature<OlGeometry>) => {\r\n      const keys = olFeature\r\n        .getKeys()\r\n        .filter((key: string) => !key.startsWith('_'));\r\n      const properties = keys.reduce(\r\n        (acc: object, key: string) => {\r\n          acc[key] = olFeature.get(key);\r\n          return acc;\r\n        },\r\n        { geometry: olFeature.getGeometry() }\r\n      );\r\n      return new OlFeature(properties);\r\n    });\r\n  }\r\n\r\n  private generateAggregatedFeature(olFeatures: OlFeature<OlGeometry>[]): OlFeature<OlGeometry>[] {\r\n    return olFeatures.map((olFeature: OlFeature<OlGeometry>) => {\r\n      const keys = olFeature.getKeys().filter((key: string) => !key.startsWith('_'));\r\n      let comment: string = '';\r\n      const properties = keys.reduce((acc: object, key: string) => {\r\n        if (key && key !== 'geometry') {\r\n          key === 'id' && olFeature.get('draw') ? comment += key + ':' + olFeature.get('draw') + '   \\r\\n'\r\n          : comment += key + ':' + olFeature.get(key) + '   \\r\\n';\r\n        }\r\n        acc[key] = olFeature.get(key);\r\n        return acc;\r\n      },\r\n      {\r\n        geometry: olFeature.getGeometry()\r\n      });\r\n      const newFeature = new OlFeature(properties);\r\n      newFeature.set('name', olFeature.getId());\r\n      newFeature.set('cmt', comment);\r\n\r\n      return newFeature;\r\n    });\r\n  }\r\n\r\n  private exportAsync(\r\n    olFeatures: OlFeature<OlGeometry>[],\r\n    format: ExportFormat,\r\n    title: string,\r\n    encoding: EncodingFormat,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ): Observable<void> {\r\n    const doExport = (observer: Observer<void>) => {\r\n      const nothingToExport = this.nothingToExport(olFeatures, format);\r\n      if (nothingToExport) {\r\n        observer.error(new ExportNothingToExportError());\r\n        return;\r\n      }\r\n\r\n      const ogreFormats = Object.keys(ExportService.ogreFormats);\r\n      if (ogreFormats.indexOf(format) >= 0) {\r\n        if (!this.ogreUrl) {\r\n          if (ExportService.noOgreFallbacks.indexOf(format) >= 0) {\r\n            this.exportToFile(olFeatures, observer, format, title, projectionIn, projectionOut);\r\n          } else {\r\n            observer.error(new ExportInvalidFileError());\r\n          }\r\n          return;\r\n        }\r\n        this.exportWithOgre(olFeatures, observer, format, title, encoding, projectionIn, projectionOut);\r\n      } else {\r\n        this.exportToFile(olFeatures, observer, format, title, projectionIn, projectionOut);\r\n      }\r\n    };\r\n\r\n    return new Observable(doExport);\r\n  }\r\n\r\n  protected exportToFile(\r\n    olFeatures: OlFeature<OlGeometry>[],\r\n    observer: Observer<void>,\r\n    format: ExportFormat,\r\n    title: string,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ) {\r\n    const olFormat = new olformat[format]();\r\n    const featuresText = olFormat.writeFeatures(olFeatures, {\r\n      dataProjection: projectionOut,\r\n      featureProjection: projectionIn,\r\n      featureType: 'feature',\r\n      featureNS: 'http://example.com/feature'\r\n    });\r\n\r\n    const fileName = `${title}.${format.toLowerCase()}`;\r\n\r\n    downloadContent(featuresText, 'text/plain;charset=utf-8', fileName);\r\n    observer.complete();\r\n  }\r\n\r\n  private exportWithOgre(\r\n    olFeatures: OlFeature<OlGeometry>[],\r\n    observer: Observer<void>,\r\n    format: string,\r\n    title: string,\r\n    encodingType: EncodingFormat,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ) {\r\n    let featuresText: string = new olformat.GeoJSON().writeFeatures(\r\n      olFeatures,\r\n      {\r\n        dataProjection: projectionOut,\r\n        featureProjection: projectionIn\r\n      }\r\n    );\r\n\r\n    const url = `${this.ogreUrl}/convertJson`;\r\n    const form = document.createElement('form');\r\n    form.style.display = 'none';\r\n    document.body.appendChild(form);\r\n    form.setAttribute('method', 'post');\r\n    form.setAttribute('target', '_blank');\r\n    form.setAttribute('action', url);\r\n\r\n    if (encodingType === EncodingFormat.UTF8) {\r\n      form.acceptCharset = 'UTF-8';\r\n      form.enctype = 'application/x-www-form-urlencoded; charset=utf-8;';\r\n    } else if (encodingType === EncodingFormat.LATIN1) {\r\n      const enctype = 'ISO-8859-1';\r\n      const featuresJson = JSON.parse(featuresText);\r\n      featuresJson.features.map(f => {\r\n        const encodedProperties = String.fromCharCode\r\n          .apply(null, encode(JSON.stringify(f.properties), { mode: 'replacement' }));\r\n        f.properties = JSON.parse(encodedProperties);\r\n      });\r\n      featuresText = JSON.stringify(featuresJson);\r\n      const encoding = document.createElement('input');\r\n      encoding.setAttribute('type', 'hidden');\r\n      encoding.setAttribute('name', 'encoding');\r\n      encoding.setAttribute('value', enctype);\r\n      form.appendChild(encoding);\r\n    }\r\n\r\n    if (format === 'CSVsemicolon') {\r\n      const options = document.createElement('input');\r\n      options.setAttribute('type', 'hidden');\r\n      options.setAttribute('name', 'lco');\r\n      options.setAttribute('value', 'SEPARATOR=SEMICOLON');\r\n      form.appendChild(options);\r\n    }\r\n\r\n    const geojsonField = document.createElement('input');\r\n    geojsonField.setAttribute('type', 'hidden');\r\n    geojsonField.setAttribute('name', 'json');\r\n    geojsonField.setAttribute('value', featuresText);\r\n    form.appendChild(geojsonField);\r\n\r\n    const outputNameField = document.createElement('input');\r\n    let outputName = format === 'Shapefile' ? `${title}.zip` : `${title}.${format.toLowerCase()}`;\r\n    if (format === 'CSVcomma' || format === 'CSVsemicolon') {\r\n      outputName = `${title}.csv`;\r\n    }\r\n    outputName = outputName.replace(' ', '_');\r\n    outputName = outputName.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '');\r\n    outputNameField.setAttribute('type', 'hidden');\r\n    outputNameField.setAttribute('name', 'outputName');\r\n    outputNameField.setAttribute('value', outputName);\r\n    form.appendChild(outputNameField);\r\n\r\n    let ogreFormat = ExportService.ogreFormats[format];\r\n    if (format === 'CSVcomma' || format === 'CSVsemicolon') {\r\n      ogreFormat = 'CSV';\r\n    }\r\n    const outputFormatField = document.createElement('input');\r\n    outputFormatField.setAttribute('type', 'hidden');\r\n    outputFormatField.setAttribute('name', 'format');\r\n    outputFormatField.setAttribute('value', ogreFormat);\r\n    form.appendChild(outputFormatField);\r\n\r\n    form.submit();\r\n    document.body.removeChild(form);\r\n\r\n    observer.complete();\r\n  }\r\n\r\n  private nothingToExport(olFeatures: OlFeature<OlGeometry>[], format: string): boolean {\r\n    if (olFeatures.length === 0) {\r\n      return true;\r\n    }\r\n    if (format === 'GPX') {\r\n      const pointOrLine = olFeatures.find(olFeature => {\r\n        return (\r\n          ['Point', 'LineString', 'MultiLineString'].indexOf(olFeature.getGeometry().getType()) >= 0\r\n        );\r\n      });\r\n      return pointOrLine === undefined;\r\n    }\r\n    return false;\r\n  }\r\n}\r\n","/**\r\n * Trigger download of a file\r\n *\r\n * @param content File content\r\n * @param mimeType File mime type\r\n * @param fileName File name\r\n */\r\nexport function downloadContent(content: string, mimeType: string, fileName: string) {\r\n  const uri = `data:${mimeType},${encodeURIComponent(content)}`;\r\n  downloadFromUri(uri, fileName);\r\n}\r\n\r\n/**\r\n * Trigger download of a file\r\n *\r\n * @param content File content\r\n * @param mimeType File mime type\r\n * @param fileName File name\r\n */\r\nexport function downloadFromUri(uri: string, fileName: string) {\r\n  const element = document.createElement('a');\r\n  element.setAttribute('href', uri);\r\n  element.setAttribute('download', fileName);\r\n  element.style.display = 'none';\r\n  document.body.appendChild(element);\r\n\r\n  element.click();\r\n\r\n  document.body.removeChild(element);\r\n}\r\n","import * as olStyle from 'ol/style';\r\nimport OlFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport { MessageService, LanguageService } from '@igo2/core';\r\n\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { FeatureDataSourceOptions } from '../../datasource/shared/datasources/feature-datasource.interface';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport {\r\n  featureToOl,\r\n  moveToOlFeatures\r\n} from '../../feature/shared/feature.utils';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { QueryableDataSourceOptions } from '../../query/shared/query.interfaces';\r\nimport { StyleService } from '../../layer/shared/style.service';\r\nimport { StyleByAttribute } from '../../layer/shared/vector-style.interface';\r\nimport { StyleListService } from '../style-list/style-list.service';\r\nimport { ClusterParam } from '../../layer/shared/clusterParam';\r\nimport { ClusterDataSource } from '../../datasource/shared/datasources/cluster-datasource';\r\nimport { ClusterDataSourceOptions } from '../../datasource/shared/datasources/cluster-datasource.interface';\r\nimport { uuid } from '@igo2/utils';\r\n\r\nexport function addLayerAndFeaturesToMap(\r\n  features: Feature[],\r\n  map: IgoMap,\r\n  layerTitle: string\r\n): VectorLayer {\r\n  const olFeatures = features.map((feature: Feature) =>\r\n    featureToOl(feature, map.projection)\r\n  );\r\n\r\n  const sourceOptions: FeatureDataSourceOptions & QueryableDataSourceOptions = {\r\n    type: 'vector',\r\n    queryable: true\r\n  };\r\n  const source = new FeatureDataSource(sourceOptions);\r\n  source.ol.addFeatures(olFeatures);\r\n  const layer = new VectorLayer({\r\n    title: layerTitle,\r\n    isIgoInternalLayer: true,\r\n    source,\r\n    style: createImportedLayerRandomStyle()\r\n  });\r\n  map.addLayer(layer);\r\n  moveToOlFeatures(map, olFeatures);\r\n\r\n  return layer;\r\n}\r\n\r\nexport function addLayerAndFeaturesStyledToMap(\r\n  features: Feature[],\r\n  map: IgoMap,\r\n  layerTitle: string,\r\n  styleListService: StyleListService,\r\n  styleService: StyleService,\r\n  layerId?: string,\r\n  imposedSourceOptions?,\r\n  imposedLayerOptions?,\r\n  zoomTo: boolean = true\r\n\r\n): VectorLayer {\r\n  const olFeatures = features.map((feature: Feature) =>\r\n    featureToOl(feature, map.projection)\r\n  );\r\n  let style;\r\n  let distance: number;\r\n\r\n  if (\r\n    styleListService.getStyleList(layerTitle.toString() + '.styleByAttribute')\r\n  ) {\r\n    const styleByAttribute: StyleByAttribute = styleListService.getStyleList(\r\n      layerTitle.toString() + '.styleByAttribute'\r\n    );\r\n\r\n    style = (feature, resolution) => {\r\n      return styleService.createStyleByAttribute(feature, styleByAttribute, resolution);\r\n    };\r\n  } else if (\r\n    styleListService.getStyleList(layerTitle.toString() + '.clusterStyle')\r\n  ) {\r\n    const clusterParam: ClusterParam = styleListService.getStyleList(\r\n      layerTitle.toString() + '.clusterParam'\r\n    );\r\n    distance = styleListService.getStyleList(\r\n      layerTitle.toString() + '.distance'\r\n    );\r\n\r\n    style = (feature, resolution) => {\r\n      const baseStyle = styleService.createStyle(\r\n        styleListService.getStyleList(layerTitle.toString() + '.clusterStyle'), feature, resolution\r\n      );\r\n      return styleService.createClusterStyle(feature, resolution, clusterParam, baseStyle);\r\n    };\r\n  } else if (styleListService.getStyleList(layerTitle.toString() + '.style')) {\r\n    style = (feature, resolution) => styleService.createStyle(\r\n      styleListService.getStyleList(layerTitle.toString() + '.style'), feature, resolution\r\n    );\r\n  } else if (\r\n    styleListService.getStyleList('default.clusterStyle') &&\r\n    features[0].geometry.type === 'Point'\r\n  ) {\r\n    const clusterParam: ClusterParam = styleListService.getStyleList(\r\n      'default.clusterParam'\r\n    );\r\n    distance = styleListService.getStyleList('default.distance');\r\n\r\n    style = (feature, resolution) => {\r\n      const baseStyle = styleService.createStyle(\r\n        styleListService.getStyleList('default.clusterStyle'), feature, resolution\r\n      );\r\n      return styleService.createClusterStyle(feature, resolution, clusterParam, baseStyle);\r\n    };\r\n  } else {\r\n    style = (feature, resolution) => styleService.createStyle(\r\n      styleListService.getStyleList('default.style'), feature, resolution\r\n    );\r\n  }\r\n\r\n  let source;\r\n  if (styleListService.getStyleList(layerTitle.toString() + '.clusterStyle')) {\r\n    const sourceOptions: ClusterDataSourceOptions &\r\n      QueryableDataSourceOptions = {\r\n      distance,\r\n      type: 'cluster',\r\n      queryable: true\r\n    };\r\n    source = new ClusterDataSource(Object.assign(sourceOptions, imposedSourceOptions));\r\n    source.ol.source.addFeatures(olFeatures);\r\n  } else if (styleListService.getStyleList(layerTitle.toString())) {\r\n    const sourceOptions: FeatureDataSourceOptions & QueryableDataSourceOptions = {\r\n      type: 'vector',\r\n      queryable: true\r\n    };\r\n    source = new FeatureDataSource(Object.assign(sourceOptions, imposedSourceOptions));\r\n    source.ol.addFeatures(olFeatures);\r\n  } else if (\r\n    styleListService.getStyleList('default.clusterStyle') &&\r\n    features[0].geometry.type === 'Point'\r\n  ) {\r\n    const sourceOptions: ClusterDataSourceOptions &\r\n      QueryableDataSourceOptions = {\r\n      distance,\r\n      type: 'cluster',\r\n      queryable: true\r\n    };\r\n    source = new ClusterDataSource(Object.assign(sourceOptions, imposedSourceOptions));\r\n    source.ol.source.addFeatures(olFeatures);\r\n  } else {\r\n    const sourceOptions: FeatureDataSourceOptions & QueryableDataSourceOptions = {\r\n      type: 'vector',\r\n      queryable: true\r\n    };\r\n    source = new FeatureDataSource(Object.assign(sourceOptions, imposedSourceOptions));\r\n    source.ol.addFeatures(olFeatures);\r\n  }\r\n\r\n  const layer = new VectorLayer(\r\n    Object.assign({\r\n      title: layerTitle,\r\n      id: layerId || uuid(),\r\n      isIgoInternalLayer: true,\r\n      source,\r\n      style\r\n    }, imposedLayerOptions));\r\n  map.addLayer(layer);\r\n  if (zoomTo){\r\n    moveToOlFeatures(map, olFeatures);\r\n  }\r\n  return layer;\r\n}\r\n\r\nexport function handleFileImportSuccess(\r\n  file: File,\r\n  features: Feature[],\r\n  map: IgoMap,\r\n  messageService: MessageService,\r\n  languageService: LanguageService,\r\n  styleListService?: StyleListService,\r\n  styleService?: StyleService\r\n) {\r\n  if (features.length === 0) {\r\n    handleNothingToImportError(file, messageService, languageService);\r\n    return;\r\n  }\r\n\r\n  const layerTitle = computeLayerTitleFromFile(file);\r\n\r\n  if (!styleListService) {\r\n    addLayerAndFeaturesToMap(features, map, layerTitle);\r\n  } else {\r\n    addLayerAndFeaturesStyledToMap(\r\n      features,\r\n      map,\r\n      layerTitle,\r\n      styleListService,\r\n      styleService\r\n    );\r\n  }\r\n\r\n  const translate = languageService.translate;\r\n  const messageTitle = translate.instant('igo.geo.dropGeoFile.success.title');\r\n  const message = translate.instant('igo.geo.dropGeoFile.success.text', {\r\n    value: layerTitle\r\n  });\r\n  messageService.success(message, messageTitle);\r\n}\r\n\r\nexport function handleFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService,\r\n  sizeMb?: number\r\n) {\r\n  sizeMb = sizeMb ? sizeMb : 30;\r\n  const errMapping = {\r\n    'Invalid file': handleInvalidFileImportError,\r\n    'File is too large': handleSizeFileImportError,\r\n    'Failed to read file': handleUnreadbleFileImportError,\r\n    'Invalid SRS definition': handleSRSImportError,\r\n    'Error 500 with OGRE': handleOgreServerImportError\r\n  };\r\n  errMapping[error.message](\r\n    file,\r\n    error,\r\n    messageService,\r\n    languageService,\r\n    sizeMb\r\n  );\r\n}\r\n\r\nexport function handleInvalidFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant('igo.geo.dropGeoFile.invalid.title');\r\n  const message = translate.instant('igo.geo.dropGeoFile.invalid.text', {\r\n    value: file.name,\r\n    mimeType: file.type\r\n  });\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function handleUnreadbleFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant('igo.geo.dropGeoFile.unreadable.title');\r\n  const message = translate.instant('igo.geo.dropGeoFile.unreadable.text', {\r\n    value: file.name\r\n  });\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function handleSizeFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService,\r\n  sizeMb: number\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant('igo.geo.dropGeoFile.tooLarge.title');\r\n  const message = translate.instant('igo.geo.dropGeoFile.tooLarge.text', {\r\n    value: file.name,\r\n    size: sizeMb\r\n  });\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function handleNothingToImportError(\r\n  file: File,\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant('igo.geo.dropGeoFile.empty.title');\r\n  const message = translate.instant('igo.geo.dropGeoFile.empty.text', {\r\n    value: file.name,\r\n    mimeType: file.type\r\n  });\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function handleSRSImportError(\r\n  file: File,\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant('igo.geo.dropGeoFile.invalidSRS.title');\r\n  const message = translate.instant('igo.geo.dropGeoFile.invalidSRS.text', {\r\n    value: file.name,\r\n    mimeType: file.type\r\n  });\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function handleOgreServerImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const title = languageService.translate.instant('igo.geo.dropGeoFile.ogreServer.title');\r\n  const message = languageService.translate.instant('igo.geo.dropGeoFile.ogreServer.text');\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function getFileExtension(file: File): string {\r\n  return file.name\r\n    .split('.')\r\n    .pop()\r\n    .toLowerCase();\r\n}\r\n\r\nexport function computeLayerTitleFromFile(file: File): string {\r\n  return file.name.substr(0, file.name.lastIndexOf('.'));\r\n}\r\nfunction createImportedLayerRandomStyle(): (olFeature: OlFeature<OlGeometry>) => olStyle.Style {\r\n  const r = Math.floor(Math.random() * 255);\r\n  const g = Math.floor(Math.random() * 255);\r\n  const b = Math.floor(Math.random() * 255);\r\n  const stroke = new olStyle.Stroke({\r\n    color: [r, g, b, 1],\r\n    width: 2\r\n  });\r\n  const fill = new olStyle.Fill({\r\n    color: [r, g, b, 0.4]\r\n  });\r\n\r\n  return (olFeature: OlFeature<OlGeometry>) => {\r\n      const customStyle = olFeature.get('_style');\r\n      if (customStyle) {\r\n        const styleService = new StyleService();\r\n        return styleService.createStyle(customStyle);\r\n      }\r\n\r\n      const style = new olStyle.Style({\r\n        stroke,\r\n        fill,\r\n        image: new olStyle.Circle({\r\n          radius: 5,\r\n          stroke,\r\n          fill\r\n        }),\r\n        text: olFeature.get('_mapTitle') ? new olStyle.Text({\r\n          text: olFeature.get('_mapTitle').toString(),\r\n          offsetX: 5,\r\n          offsetY: -5,\r\n          font: '12px Calibri,sans-serif',\r\n          fill: new olStyle.Fill({ color: '#000' }),\r\n          stroke: new olStyle.Stroke({ color: '#fff', width: 3 }),\r\n          overflow: true\r\n        }): undefined\r\n      });\r\n      return style;\r\n  };\r\n}\r\n\r\n","export class ImportError extends Error {}\r\n\r\nexport class ImportInvalidFileError extends ImportError {\r\n  constructor() {\r\n    super('Invalid file');\r\n    Object.setPrototypeOf(this, ImportInvalidFileError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportUnreadableFileError extends ImportError {\r\n  constructor() {\r\n      super('Failed to read file');\r\n      Object.setPrototypeOf(this, ImportUnreadableFileError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportNothingToImportError extends ImportError {\r\n  constructor() {\r\n      super('Nothing to import');\r\n      Object.setPrototypeOf(this, ImportNothingToImportError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportSizeError extends ImportError {\r\n  constructor() {\r\n      super('File is too large');\r\n      Object.setPrototypeOf(this, ImportNothingToImportError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportSRSError extends ImportError {\r\n  constructor() {\r\n      super('Invalid SRS definition');\r\n      Object.setPrototypeOf(this, ImportNothingToImportError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportOgreServerError extends ImportError {\r\n  constructor() {\r\n      super('Error 500 with OGRE');\r\n      Object.setPrototypeOf(this, ImportOgreServerError.prototype);\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient, HttpHeaders } from '@angular/common/http';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { uuid } from '@igo2/utils';\r\n\r\nimport { Observable, Observer } from 'rxjs';\r\n\r\nimport * as olformat from 'ol/format';\r\nimport OlFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport {\r\n  ImportInvalidFileError,\r\n  ImportUnreadableFileError,\r\n  ImportSizeError,\r\n  ImportSRSError,\r\n  ImportOgreServerError\r\n} from './import.errors';\r\nimport { computeLayerTitleFromFile, getFileExtension } from './import.utils';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ImportService {\r\n  static allowedMimeTypes = [\r\n    'application/gml+xml',\r\n    'application/vnd.google-earth.kml+xml',\r\n    'application/gpx+xml',\r\n    'application/json'\r\n  ];\r\n\r\n  static allowedZipMimeTypes = [\r\n    'application/zip',\r\n    'application/x-zip-compressed',\r\n    'application/x-zip'\r\n  ];\r\n\r\n  static allowedExtensions = ['geojson', 'kml', 'gpx', 'json', 'gml'];\r\n\r\n  private ogreUrl: string;\r\n  private clientSideFileSizeMax: number;\r\n\r\n  constructor(private http: HttpClient, private config: ConfigService) {\r\n    this.ogreUrl = this.config.getConfig('importExport.url');\r\n    const configFileSizeMb = this.config.getConfig('importExport.clientSideFileSizeMaxMb');\r\n    this.clientSideFileSizeMax = (configFileSizeMb ? configFileSizeMb : 30) * Math.pow(1024, 2);\r\n  }\r\n\r\n  import(\r\n    file: File,\r\n    projectionIn = 'EPSG:4326',\r\n    projectionOut = 'EPSG:4326'\r\n  ): Observable<Feature[]> {\r\n    return this.importAsync(file, projectionIn, projectionOut);\r\n  }\r\n\r\n  private getFileImporter(\r\n    file: File\r\n  ): (\r\n    file: File,\r\n    observer: Observer<Feature[]>,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ) => void {\r\n    const extension = getFileExtension(file);\r\n    const mimeType = file.type;\r\n    const allowedMimeTypes = [\r\n      ...ImportService.allowedMimeTypes,\r\n      ...ImportService.allowedZipMimeTypes\r\n    ];\r\n    const allowedExtensions = ImportService.allowedExtensions;\r\n\r\n    if (\r\n      allowedMimeTypes.indexOf(mimeType) < 0 &&\r\n      allowedExtensions.indexOf(extension) < 0\r\n    ) {\r\n      return undefined;\r\n    } else if (\r\n      mimeType === 'application/json' ||\r\n      ['json', 'geojson', 'kml', 'gpx'].indexOf(extension) >= 0\r\n    ) {\r\n      return this.importFile;\r\n    } else if (this.ogreUrl !== undefined) {\r\n      return this.importFileWithOgre;\r\n    }\r\n\r\n    return undefined;\r\n  }\r\n\r\n  private importAsync(\r\n    file: File,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ): Observable<Feature[]> {\r\n    const doImport = (observer: Observer<Feature[]>) => {\r\n      if (file.size >= this.clientSideFileSizeMax) {\r\n        observer.error(new ImportSizeError());\r\n        return;\r\n      }\r\n      const importer = this.getFileImporter(file);\r\n      if (importer === undefined) {\r\n        observer.error(new ImportInvalidFileError());\r\n        return;\r\n      }\r\n\r\n      importer.call(this, file, observer, projectionIn, projectionOut);\r\n    };\r\n\r\n    return new Observable(doImport);\r\n  }\r\n\r\n  private importFile(\r\n    file: File,\r\n    observer: Observer<Feature[]>,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ) {\r\n    const reader = new FileReader();\r\n\r\n    reader.onload = (event: any) => {\r\n      try {\r\n        const features = this.parseFeaturesFromFile(\r\n          file,\r\n          event.target.result,\r\n          projectionIn,\r\n          projectionOut\r\n        );\r\n        observer.next(features);\r\n      } catch (e) {\r\n        observer.error(new ImportUnreadableFileError());\r\n      }\r\n\r\n      observer.complete();\r\n    };\r\n\r\n    reader.onerror = evt => {\r\n      observer.error(new ImportUnreadableFileError());\r\n    };\r\n\r\n    reader.readAsText(file, 'UTF-8');\r\n  }\r\n\r\n  private importFileWithOgre(\r\n    file: File,\r\n    observer: Observer<Feature[]>,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ) {\r\n    const url = `${this.ogreUrl}/convert`;\r\n    const formData = new FormData();\r\n    formData.append('upload', file);\r\n    formData.append('sourceSrs', projectionIn);\r\n    formData.append('targetSrs', projectionOut);\r\n    formData.append('formatOutput', 'GEOJSON');\r\n    formData.append('skipFailures', '');\r\n\r\n    this.http.post(url, formData, { headers: new HttpHeaders() })\r\n    .subscribe(\r\n      (response: { errors?: string[] } | object | null) => {\r\n        if (response === null) {\r\n          observer.error(new ImportUnreadableFileError());\r\n          return;\r\n        }\r\n\r\n        const errors = (response as any).errors || [];\r\n        if (errors.length > 0) {\r\n          observer.error(new ImportUnreadableFileError());\r\n        } else {\r\n          const features = this.parseFeaturesFromGeoJSON(\r\n            file,\r\n            response,\r\n            projectionOut\r\n          );\r\n          observer.next(features);\r\n          observer.complete();\r\n        }\r\n      },\r\n      (error: any) => {\r\n        error.error.caught = true;\r\n        const errMsg = error.error.msg || '';\r\n        if (errMsg === 'No valid files found') {\r\n          observer.error(new ImportInvalidFileError());\r\n        } else if (errMsg && errMsg.startWith('ERROR 1: Failed to process SRS definition')\r\n        ) {\r\n          observer.error(new ImportSRSError());\r\n        } else if (error.status === 500) {\r\n          observer.error(new ImportOgreServerError());\r\n        } else {\r\n          observer.error(new ImportUnreadableFileError());\r\n        }\r\n      }\r\n    );\r\n  }\r\n\r\n  private parseFeaturesFromFile(\r\n    file: File,\r\n    data: string,\r\n    projectionIn: string,\r\n    projectionOut: string\r\n  ): Feature[] {\r\n    const extension = getFileExtension(file);\r\n    const mimeType = file.type;\r\n\r\n    const GeoJSON = new olformat.GeoJSON();\r\n\r\n    let format;\r\n    if (mimeType === 'application/vnd.google-earth.kml+xml') {\r\n      format = new olformat.KML();\r\n    } else if (mimeType === 'application/gml+xml') {\r\n      format = new olformat.GML();\r\n    } else if (mimeType === 'application/gpx+xml') {\r\n      format = new olformat.GPX();\r\n    } else {\r\n      switch (extension) {\r\n        case 'kml':\r\n          format = new olformat.KML();\r\n          break;\r\n        case 'gpx':\r\n          format = new olformat.GPX();\r\n          break;\r\n        case 'gml':\r\n          format = new olformat.GML();\r\n          break;\r\n        default:\r\n          format = GeoJSON;\r\n          break;\r\n      }\r\n    }\r\n\r\n    const olFeatures = format.readFeatures(data, {\r\n      dataProjection: projectionIn,\r\n      featureProjection: projectionOut\r\n    });\r\n    const features = olFeatures.map((olFeature: OlFeature<OlGeometry>) => {\r\n      return Object.assign(GeoJSON.writeFeatureObject(olFeature), {\r\n        projection: projectionOut,\r\n        meta: {\r\n          id: uuid(),\r\n          title: computeLayerTitleFromFile(file)\r\n        }\r\n      });\r\n    });\r\n\r\n    return features;\r\n  }\r\n\r\n  private parseFeaturesFromGeoJSON(\r\n    file: File,\r\n    data: object,\r\n    projectionOut: string\r\n  ): Feature[] {\r\n    const olFormat = new olformat.GeoJSON();\r\n    const olFeatures = olFormat.readFeatures(data);\r\n    const features = olFeatures.map((olFeature: OlFeature<OlGeometry>) => {\r\n      return Object.assign(olFormat.writeFeatureObject(olFeature), {\r\n        projection: projectionOut,\r\n        meta: {\r\n          id: uuid(),\r\n          title: computeLayerTitleFromFile(file)\r\n        }\r\n      });\r\n    });\r\n\r\n    return features as Feature[];\r\n  }\r\n}\r\n","import { Injectable, Injector } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { throwError } from 'rxjs';\r\nimport { catchError } from 'rxjs/operators';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport { StyleListOptions } from './style-list.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class StyleListService {\r\n  private styleList: object = {};\r\n\r\n  constructor(private injector: Injector) {}\r\n\r\n  /**\r\n   * Use to get the data found in styleList file\r\n   */\r\n  public getStyleList(key: string): any {\r\n    return ObjectUtils.resolve(this.styleList, key);\r\n  }\r\n\r\n  /**\r\n   * This method loads \"[path]\" to get all styleList's variables\r\n   */\r\n  public load(options: StyleListOptions) {\r\n    const baseStyleList = options.default || {};\r\n    if (!options.path) {\r\n      this.styleList = baseStyleList;\r\n      return true;\r\n    }\r\n\r\n    const http = this.injector.get(HttpClient);\r\n\r\n    return new Promise((resolve, _reject) => {\r\n      http\r\n        .get(options.path)\r\n        .pipe(\r\n          catchError((error: any): any => {\r\n            console.log(`StyleList file ${options.path} could not be read`);\r\n            resolve(true);\r\n            return throwError(error.error || 'Server error');\r\n          })\r\n        )\r\n        .subscribe((styleListResponse: object) => {\r\n          this.styleList = ObjectUtils.mergeDeep(baseStyleList, styleListResponse);\r\n          resolve(true);\r\n        });\r\n    });\r\n  }\r\n}\r\n","<div class=\"import-export-toggle mat-typography\">\r\n  <mat-button-toggle-group\r\n        [value]=\"selectedMode\"\r\n        (change)=\"onImportExportChange($event)\">\r\n        <mat-button-toggle [value]=\"'import'\">\r\n          {{'igo.geo.importExportForm.importTabTitle' | translate}}\r\n        </mat-button-toggle>\r\n        <mat-button-toggle [value]=\"'export'\">\r\n          {{'igo.geo.importExportForm.exportTabTitle' | translate}}\r\n        </mat-button-toggle>\r\n  </mat-button-toggle-group>\r\n</div>\r\n\r\n<form class=\"igo-form\" [formGroup]=\"importForm\" *ngIf=\"selectedMode === 'import'\">\r\n  <div class=\"igo-input-container\">\r\n    <mat-form-field>\r\n      <mat-label>{{'igo.geo.importExportForm.importProjPlaceholder' | translate}}</mat-label>\r\n      <mat-select\r\n        [(value)]=\"inputProj\">\r\n        <mat-option\r\n          *ngFor=\"let projection of (projections$ | async)\"\r\n          [value]=\"projection\"\r\n          (click)=\"$event.stopPropagation()\">\r\n          <p mat-line *ngIf=\"projection.translateKey\">{{('igo.geo.importExportForm.projections.' + projection.translateKey) | translate: projection}}</p>\r\n          <p mat-line *ngIf=\"!projection.translateKey\">{{projection.alias}}</p>\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"importForm.invalid ? ('igo.geo.importExportForm.projections.choose' | translate) : ('igo.geo.importExportForm.importButton' | translate)\"\r\n    class=\"igo-form-button-group\">\r\n    <button\r\n      [disabled]=\"importForm.invalid || (loading$ | async)\"\r\n      mat-raised-button\r\n      type=\"button\"\r\n      (click)=\"fileInput.click()\">\r\n        {{'igo.geo.importExportForm.importButton' | translate}}\r\n    </button>\r\n    <igo-spinner [shown]=\"loading$ | async\"></igo-spinner>\r\n    <input\r\n      hidden\r\n      #fileInput\r\n      type=\"file\"\r\n      [style.display]=\"'none'\"\r\n      (click)=\"fileInput.value = null\"\r\n      (change)=\"importFiles($event.target.files)\">\r\n  </div>\r\n</form>\r\n<section class=\"mat-typography\" *ngIf=\"selectedMode === 'import'\">\r\n  <h4>{{'igo.geo.importExportForm.importClarifications' | translate}}</h4>\r\n  <ul>\r\n    <li>{{'igo.geo.importExportForm.importSizeMax' | translate: {size: fileSizeMb} }}</li>\r\n    <li>{{'igo.geo.importExportForm.importFormatAuthorized' | translate}}</li>\r\n    <li>{{'igo.geo.importExportForm.importShpZip' | translate}}</li>\r\n  </ul>\r\n</section>\r\n\r\n<section class=\"mat-typography\" *ngIf=\"(exportableLayers$ | async).length === 0 && selectedMode === 'export'\">\r\n  <h4>{{'igo.geo.importExportForm.exportNoLayersExportable' | translate}}</h4>\r\n</section>\r\n\r\n<form class=\"igo-form\" [formGroup]=\"form\" *ngIf=\"(exportableLayers$ | async).length > 0 && selectedMode === 'export'\">\r\n  <div class=\"igo-input-container\">\r\n    <mat-form-field>\r\n      <mat-label>{{'igo.geo.importExportForm.exportLayerPlaceholder' | translate}}</mat-label>\r\n      <mat-select\r\n        [(value)]=\"layers\" multiple>\r\n        <mat-select-trigger>\r\n          {{layers.length ? getLayerTitleById(layers[0]) : ''}}\r\n          <span *ngIf=\"layers.length > 1\" class=\"export-select-trigger\">\r\n            (+{{layers.length - 1}} {{(layers?.length === 2 ? 'igo.geo.importExportForm.other' : 'igo.geo.importExportForm.others') | translate }})\r\n          </span>\r\n        </mat-select-trigger>\r\n        <mat-option\r\n          *ngFor=\"let layer of (exportableLayers$ | async)\"\r\n          [ngClass]=\"{'igo-export-layer-mat-option': layerHasSelectedFeatures(layer)}\"\r\n          [value]=\"layer.id\"\r\n          (click)=\"$event.stopPropagation()\">\r\n          <p mat-line>{{layer.title}}</p>\r\n          <p mat-line>\r\n            <mat-slide-toggle *ngIf=\"layerHasSelectedFeatures(layer)\"\r\n              [labelPosition]=\"'after'\"\r\n              (click)=\"onlySelectedClick($event,layer.id)\"\r\n              (checked)=\"inLayersIdToExportSelectionOnly(layer)\"\r\n              (change)=\"onlySelected($event,layer.id)\">\r\n              <small>{{'igo.geo.importExportForm.exportSelectedFeature' | translate}}</small>\r\n            </mat-slide-toggle>\r\n          </p>\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\">\r\n    <mat-form-field>\r\n      <mat-label>{{'igo.geo.importExportForm.exportFormatPlaceholder' | translate}}</mat-label>\r\n      <mat-select\r\n        formControlName=\"format\">\r\n        <ng-container *ngIf=\"(formats$ | async).length !== 0\">\r\n          <mat-option *ngFor=\"let format of (formats$ | async) | keyvalue\" [value]=\"format.key\">\r\n            {{'igo.geo.export.format.' + format.value | translate}}\r\n          </mat-option>\r\n        </ng-container>\r\n        <mat-option *ngIf=\"(formats$ | async).length === 0\" disabled=\"true\">\r\n          {{'igo.geo.export.noFormat.title' | translate}}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\" *ngIf=\"forceNaming && form.value.format !== 'URL'\">\r\n    <mat-form-field>\r\n        <input matInput formControlName=\"name\" placeholder=\"{{'igo.geo.importExportForm.exportFileNamePlaceholder' | translate}}\">\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\" *ngIf=\"form.value.format === 'CSVcomma' || form.value.format === 'CSVsemicolon'\">\r\n    <mat-form-field>\r\n      <mat-label>{{'igo.geo.importExportForm.encodingPlaceholder' | translate}}</mat-label>\r\n      <mat-select\r\n        formControlName=\"encoding\">\r\n        <ng-container *ngIf=\"(encodings$ | async).length !== 0\">\r\n          <mat-option *ngFor=\"let encoding of (encodings$ | async) | keyvalue\" [value]=\"encoding.key\">\r\n            {{'igo.geo.export.encoding.' + encoding.value | translate}}\r\n          </mat-option>\r\n        </ng-container>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"export-combine-layers mat-typography\" *ngIf=\"layers.length > 1 && (form.value.format === 'CSVcomma' || form.value.format === 'CSVsemicolon')\">\r\n    <mat-slide-toggle\r\n        formControlName=\"combineLayers\"\r\n        [labelPosition]=\"'before'\">\r\n          {{'igo.geo.importExportForm.exportCombineResults' | translate}}\r\n    </mat-slide-toggle>\r\n  </div>\r\n\r\n  <div class=\"export-separator mat-typography\" *ngIf=\"layers.length > 1 && (form.value.format === 'CSVcomma' || form.value.format === 'CSVsemicolon') && form.value.combineLayers\">\r\n    <mat-slide-toggle\r\n        formControlName=\"separator\"\r\n        [labelPosition]=\"'before'\">\r\n          {{'igo.geo.importExportForm.exportSeparator' | translate}}\r\n    </mat-slide-toggle>\r\n  </div>\r\n\r\n  <div class=\"export-options mat-typography\" *ngIf=\"form.value.format !== 'URL'\">\r\n    <mat-slide-toggle\r\n        formControlName=\"featureInMapExtent\"\r\n        [labelPosition]=\"'before'\">\r\n          {{'igo.geo.importExportForm.exportFeatureInExtent' | translate}}\r\n    </mat-slide-toggle>\r\n  </div>\r\n\r\n  <div class=\"igo-form-button-group\">\r\n    <button\r\n      mat-raised-button\r\n      type=\"button\"\r\n      [disabled]=\"!form.valid || (loading$ | async)\"\r\n      (click)=\"handleExportFormSubmit(form.value)\">\r\n      {{form.value.format !== 'URL'  ? ('igo.geo.importExportForm.exportButton' | translate): (form.value.layers.length > 1  ? ('igo.geo.importExportForm.exportButtonLinks' | translate): ('igo.geo.importExportForm.exportButtonLink' | translate))}}\r\n    </button>\r\n    <igo-spinner [shown]=\"loading$ | async\"></igo-spinner>\r\n  </div>\r\n\r\n</form>\r\n","import {\r\n  Component,\r\n  Input,\r\n  OnDestroy,\r\n  OnInit,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\nimport { FormGroup, FormBuilder, Validators } from '@angular/forms';\r\nimport { Subscription, BehaviorSubject } from 'rxjs';\r\n\r\nimport {\r\n  MessageService,\r\n  LanguageService,\r\n  ConfigService,\r\n  StorageService\r\n} from '@igo2/core';\r\nimport { strEnum } from '@igo2/utils';\r\n\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { ClusterDataSource } from '../../datasource/shared/datasources/cluster-datasource';\r\nimport { Layer } from '../../layer/shared/layers/layer';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { AnyLayer } from '../../layer/shared/layers/any-layer';\r\nimport { DataSourceOptions } from '../../datasource/shared/datasources/datasource.interface';\r\nimport olPoint from 'ol/geom/Point';\r\nimport { circular } from 'ol/geom/Polygon';\r\n\r\nimport {\r\n  handleFileExportError,\r\n  handleFileExportSuccess\r\n} from '../shared/export.utils';\r\nimport { ExportOptions } from '../shared/export.interface';\r\nimport { ExportFormat, EncodingFormat } from '../shared/export.type';\r\nimport { ExportService } from '../shared/export.service';\r\nimport { ImportService } from '../shared/import.service';\r\nimport {\r\n  handleFileImportSuccess,\r\n  handleFileImportError\r\n} from '../shared/import.utils';\r\nimport { StyleService } from '../../layer/shared/style.service';\r\nimport { StyleListService } from '../style-list/style-list.service';\r\nimport { skipWhile } from 'rxjs/operators';\r\nimport { EntityRecord, Workspace } from '@igo2/common';\r\nimport type { WorkspaceStore } from '@igo2/common';\r\nimport { WfsWorkspace } from '../../workspace/shared/wfs-workspace';\r\nimport { EditionWorkspace } from '../../workspace/shared/edition-workspace';\r\nimport { FeatureWorkspace } from '../../workspace/shared/feature-workspace';\r\nimport { MatSlideToggleChange } from '@angular/material/slide-toggle';\r\nimport { InputProjections, ProjectionsLimitationsOptions } from '../../map/';\r\nimport { DownloadService } from '../../download/shared/download.service';\r\nimport { computeProjectionsConstraints } from '../../map';\r\n\r\nimport olVectorSource from 'ol/source/Vector';\r\nimport olClusterSource from 'ol/source/Cluster';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\n@Component({\r\n  selector: 'igo-import-export',\r\n  templateUrl: './import-export.component.html',\r\n  styleUrls: ['./import-export.component.scss']\r\n})\r\nexport class ImportExportComponent implements OnDestroy, OnInit {\r\n  public form: FormGroup;\r\n  public importForm: FormGroup;\r\n  public formats$ = new BehaviorSubject(undefined);\r\n  public encodings$ = new BehaviorSubject(undefined);\r\n  public exportableLayers$: BehaviorSubject<AnyLayer[]> = new BehaviorSubject(\r\n    []\r\n  );\r\n  public loading$ = new BehaviorSubject(false);\r\n  public forceNaming = false;\r\n  public controlFormat = 'format';\r\n\r\n  private layers$$: Subscription;\r\n  private exportableLayers$$: Subscription;\r\n  private formats$$: Subscription;\r\n  private encodings$$: Subscription;\r\n  private formLayer$$: Subscription;\r\n  private exportOptions$$: Subscription;\r\n\r\n\r\n  private espgCodeRegex = new RegExp('^\\\\d{4,6}');\r\n  private clientSideFileSizeMax: number;\r\n  public fileSizeMb: number;\r\n\r\n  public projections$: BehaviorSubject<InputProjections[]> = new BehaviorSubject([]);\r\n  private projectionsConstraints: ProjectionsLimitationsOptions;\r\n\r\n  public popupChecked: boolean = false;\r\n\r\n  private previousLayerSpecs$: BehaviorSubject<\r\n    {\r\n      id: string;\r\n      visible: boolean;\r\n      opacity: number;\r\n      queryable: boolean;\r\n    }[]\r\n  > = new BehaviorSubject(undefined);\r\n\r\n  @Input() selectFirstProj: boolean = false;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  private _projectionsLimitations: ProjectionsLimitationsOptions = {};\r\n  @Input()\r\n  set projectionsLimitations(value: ProjectionsLimitationsOptions) {\r\n    this._projectionsLimitations = value;\r\n    this.computeProjections();\r\n  }\r\n  get projectionsLimitations(): ProjectionsLimitationsOptions {\r\n    return this._projectionsLimitations || {};\r\n  }\r\n\r\n  /**\r\n   * Store that holds the available workspaces.\r\n   */\r\n  @Input() store: WorkspaceStore;\r\n\r\n  @Input() selectedMode = 'import';\r\n\r\n  @Output() selectMode = new EventEmitter<string>();\r\n\r\n  @Input() exportOptions$: BehaviorSubject<ExportOptions> = new BehaviorSubject(\r\n    undefined\r\n  );\r\n\r\n  @Output() exportOptionsChange = new EventEmitter<ExportOptions>();\r\n\r\n  get layers() {\r\n    return this.form.get('layers').value;\r\n  }\r\n  set layers(value) {\r\n    this.form.patchValue({ layers: value });\r\n  }\r\n\r\n  get inputProj() {\r\n    return this.importForm.get('inputProj').value;\r\n  }\r\n  set inputProj(value) {\r\n    this.importForm.patchValue({ inputProj: value });\r\n  }\r\n\r\n  get popupAllowed(): boolean {\r\n    return this.storageService.get('importExportPopupAllowed') as boolean || false;\r\n  }\r\n\r\n  set popupAllowed(value: boolean) {\r\n    this.storageService.set('importExportPopupAllowed', value);\r\n  }\r\n\r\n  constructor(\r\n    private importService: ImportService,\r\n    private exportService: ExportService,\r\n    private languageService: LanguageService,\r\n    private messageService: MessageService,\r\n    private styleListService: StyleListService,\r\n    private styleService: StyleService,\r\n    private formBuilder: FormBuilder,\r\n    private config: ConfigService,\r\n    private cdRef: ChangeDetectorRef,\r\n    private storageService: StorageService,\r\n    private downloadService: DownloadService\r\n  ) {\r\n    this.loadConfig();\r\n    this.buildForm();\r\n    this.computeProjections();\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.layers$$ = this.map.layers$.subscribe((layers) => {\r\n      this.exportableLayers$.next(\r\n        layers.filter((layer: Layer) => {\r\n          return (\r\n            (layer instanceof VectorLayer && layer.exportable === true) ||\r\n            (layer.dataSource.options.download &&\r\n              layer.dataSource.options.download.url)\r\n          );\r\n        }) as AnyLayer[]\r\n      );\r\n    });\r\n    const configFileSizeMb = this.config.getConfig(\r\n      'importExport.clientSideFileSizeMaxMb'\r\n    );\r\n    this.clientSideFileSizeMax =\r\n      (configFileSizeMb ? configFileSizeMb : 30) * Math.pow(1024, 2);\r\n    this.fileSizeMb = this.clientSideFileSizeMax / Math.pow(1024, 2);\r\n\r\n    this.exportOptions$$ = this.exportOptions$\r\n      .pipe(skipWhile((exportOptions) => !exportOptions))\r\n      .subscribe((exportOptions) => {\r\n        this.form.patchValue(exportOptions, { emitEvent: true });\r\n        if (exportOptions.layers) {\r\n          this.computeFormats(\r\n            exportOptions.layers.map((l) => this.map.getLayerById(l))\r\n          );\r\n        }\r\n      });\r\n    this.formLayer$$ = this.form\r\n      .get('format')\r\n      .valueChanges\r\n      .subscribe((format) => {\r\n        const ogreFormats = Object.keys(ExportService.ogreFormats);\r\n        if (\r\n          !this.popupChecked &&\r\n          this.form.get('layers').value?.length > 1 &&\r\n          (ogreFormats.indexOf(format) >= 0 || format === ExportFormat.URL)) {\r\n          if (!this.handlePopup(true)) {\r\n            this.form.patchValue({ format: undefined }, { emitEvent: false });\r\n          }\r\n        }\r\n      });\r\n\r\n    this.formLayer$$ = this.form\r\n      .get('layers')\r\n      .valueChanges.subscribe((layersId) => {\r\n        this.handlePreviousLayerSpecs();\r\n        const selectedLayers = layersId instanceof Array ? layersId : [layersId];\r\n        this.form.patchValue({ layers: selectedLayers }, { emitEvent: false });\r\n        const layers = selectedLayers.map((l) => this.map.getLayerById(l));\r\n        this.computeFormats(layers);\r\n\r\n        if (\r\n          Object.keys(this.formats$.value).indexOf(this.form.value.format) ===\r\n          -1\r\n        ) {\r\n          this.form.patchValue({ format: undefined });\r\n        }\r\n\r\n        this.loading$.next(true);\r\n        const previousSpecs: {\r\n          id: string;\r\n          visible: boolean;\r\n          opacity: number;\r\n          queryable: boolean;\r\n        }[] = [];\r\n        layers.forEach((layer) => {\r\n          if (\r\n            layer instanceof VectorLayer &&\r\n            layer.dataSource.ol.getFeatures().length === 0\r\n          ) {\r\n            previousSpecs.push({\r\n              id: layer.id,\r\n              visible: layer.visible,\r\n              opacity: layer.opacity,\r\n              queryable: (layer as any).queryable\r\n            });\r\n            layer.opacity = 0;\r\n            layer.visible = true;\r\n          }\r\n        });\r\n\r\n        this.previousLayerSpecs$.next(previousSpecs);\r\n        setTimeout(() => {\r\n          this.loading$.next(false);\r\n        }, 500);\r\n      });\r\n\r\n    this.formats$$ = this.formats$\r\n      .pipe(skipWhile((formats) => !formats))\r\n      .subscribe((formats) => {\r\n        if (Object.keys(formats).length === 1) {\r\n          this.form.patchValue({ format: formats[Object.keys(formats)[0]] });\r\n        }\r\n      });\r\n\r\n    this.encodings$$ = this.encodings$\r\n      .pipe(skipWhile((encodings) => !encodings))\r\n      .subscribe((encodings) => {\r\n        if (Object.keys(encodings).length === 1) {\r\n          this.form.patchValue({ encoding: encodings[Object.keys(encodings)[0]] });\r\n        }\r\n      });\r\n\r\n    this.exportableLayers$$ = this.exportableLayers$\r\n      .pipe(skipWhile((layers) => !layers))\r\n      .subscribe((layers) => {\r\n        if (layers.length === 1) {\r\n          this.form.patchValue({ layers: layers[0].id });\r\n        }\r\n      });\r\n\r\n    this.form.controls[this.controlFormat].valueChanges.subscribe((format) => {\r\n      if (format === ExportFormat.CSVcomma || format === ExportFormat.CSVsemicolon) {\r\n        this.form.patchValue({ encoding: EncodingFormat.LATIN1 });\r\n      } else {\r\n        this.form.patchValue({ encoding: EncodingFormat.UTF8 });\r\n      }\r\n      this.cdRef.detectChanges();\r\n    });\r\n\r\n    if (this.selectFirstProj) {\r\n      if (this.projections$.value.length === 0) {\r\n        this.importForm.patchValue({ inputProj: { translateKey: 'nad83', alias: 'NAD83', code: 'EPSG:4326', zone: '' } });\r\n      } else {\r\n        this.importForm.patchValue({ inputProj: this.projections$.value[0] });\r\n      }\r\n    } else {\r\n      this.importForm.patchValue({ inputProj: undefined });\r\n    }\r\n  }\r\n\r\n  private computeProjections() {\r\n    this.projectionsConstraints = computeProjectionsConstraints(this.projectionsLimitations);\r\n    const projections: InputProjections[] = [];\r\n\r\n    if (this.projectionsConstraints.nad83) {\r\n      projections.push({ translateKey: 'nad83', alias: 'NAD83', code: 'EPSG:4269', zone: '' });\r\n    }\r\n    if (this.projectionsConstraints.wgs84) {\r\n      projections.push({ translateKey: 'wgs84', alias: 'WGS84', code: 'EPSG:4326', zone: '' });\r\n    }\r\n    if (this.projectionsConstraints.webMercator) {\r\n      projections.push({ translateKey: 'webMercator', alias: 'Web Mercator', code: 'EPSG:3857', zone: '' });\r\n    }\r\n\r\n    if (this.projectionsConstraints.mtm) {\r\n      // all mtm zones\r\n      const minZone = this.projectionsConstraints.mtmZone.minZone;\r\n      const maxZone = this.projectionsConstraints.mtmZone.maxZone;\r\n\r\n      for (let mtmZone = minZone; mtmZone <= maxZone; mtmZone++) {\r\n        const code = mtmZone < 10 ? `EPSG:3218${mtmZone}` : `EPSG:321${80 + mtmZone}`;\r\n        projections.push({ translateKey: 'mtm', alias: `MTM ${mtmZone}`, code, zone: `${mtmZone}` });\r\n      }\r\n    }\r\n\r\n    if (this.projectionsConstraints.utm) {\r\n      // all utm zones\r\n      const minZone = this.projectionsConstraints.utmZone.minZone;\r\n      const maxZone = this.projectionsConstraints.utmZone.maxZone;\r\n\r\n      for (let utmZone = minZone; utmZone <= maxZone; utmZone++) {\r\n        const code = utmZone < 10 ? `EPSG:3260${utmZone}` : `EPSG:326${utmZone}`;\r\n        projections.push({ translateKey: 'utm', alias: `UTM ${utmZone}`, code, zone: `${utmZone}` });\r\n      }\r\n    }\r\n\r\n    let configProjection = [];\r\n    if (this.projectionsConstraints.projFromConfig) {\r\n      configProjection = this.config.getConfig('projections') || [];\r\n    }\r\n\r\n    this.projections$.next(configProjection.concat(projections));\r\n  }\r\n\r\n  private getWorkspaceByLayerId(id: string): Workspace {\r\n    const wksFromLayerId = this.store\r\n      .all()\r\n      .find(workspace => (workspace as WfsWorkspace | FeatureWorkspace | EditionWorkspace).layer.id === id);\r\n    if (wksFromLayerId) {\r\n      return wksFromLayerId;\r\n    }\r\n    return;\r\n  }\r\n\r\n  public getLayerTitleById(id): string {\r\n    return this.map.getLayerById(id)?.title;\r\n  }\r\n\r\n\r\n  layerHasSelectedFeatures(layer: Layer): boolean {\r\n    const wksFromLayer = this.getWorkspaceByLayerId(layer.id);\r\n    if (wksFromLayer) {\r\n      const recs = wksFromLayer.entityStore.stateView\r\n        .firstBy((record: EntityRecord<Feature>) => {\r\n          return record.state.selected === true;\r\n        });\r\n      return recs ? true : false;\r\n    }\r\n  }\r\n\r\n  public onlySelected(event: MatSlideToggleChange, id: string) {\r\n    let layersWithSelection = this.form.value.layersWithSelection;\r\n    if (event.checked) {\r\n      layersWithSelection.push(id);\r\n    } else {\r\n      layersWithSelection = layersWithSelection.filter(layerId => layerId !== id);\r\n    }\r\n    this.form.patchValue({ layersWithSelection });\r\n  }\r\n\r\n  public onlySelectedClick(event, id: string) {\r\n    if (this.form.value.layers.find(layerId => layerId === id)) {\r\n      event.stopPropagation();\r\n    }\r\n  }\r\n\r\n  public inLayersIdToExportSelectionOnly(layer: Layer): boolean {\r\n    return this.form.value.layersWithSelection.find(layerId => layerId === layer.id) ? true : false;\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.layers$$.unsubscribe();\r\n    this.exportableLayers$$.unsubscribe();\r\n    this.formats$$.unsubscribe();\r\n    this.encodings$$.unsubscribe();\r\n    this.formLayer$$.unsubscribe();\r\n    if (this.exportOptions$$) {\r\n      this.exportOptions$$.unsubscribe();\r\n    }\r\n    this.exportOptionsChange.emit(this.form.value);\r\n    this.handlePreviousLayerSpecs();\r\n  }\r\n\r\n  private handlePreviousLayerSpecs() {\r\n    const previousSpecs = this.previousLayerSpecs$.value;\r\n    if (previousSpecs && previousSpecs.length) {\r\n      previousSpecs.forEach((specs) => {\r\n        const previousLayer = this.map.getLayerById(specs.id);\r\n        previousLayer.visible = specs.visible;\r\n        previousLayer.opacity = specs.opacity;\r\n        (previousLayer as any).queryable = specs.queryable;\r\n      });\r\n    }\r\n    this.previousLayerSpecs$.next(undefined);\r\n  }\r\n\r\n  importFiles(files: File[]) {\r\n    let inputProj = this.inputProj.code;\r\n    if (this.espgCodeRegex.test(inputProj)) {\r\n      inputProj = `EPSG:${inputProj}`;\r\n    }\r\n\r\n    this.loading$.next(true);\r\n    for (const file of files) {\r\n      this.importService.import(file, inputProj).subscribe(\r\n        (features: Feature[]) => this.onFileImportSuccess(file, features),\r\n        (error: Error) => this.onFileImportError(file, error),\r\n        () => {\r\n          this.loading$.next(false);\r\n        }\r\n      );\r\n    }\r\n  }\r\n\r\n  handlePopup(preCheck: boolean = true): boolean {\r\n    const p1 = window.open('', 'popup', 'width=1, height=1');\r\n    p1.close();\r\n    const p2 = window.open('', 'popup', 'width=1, height=1');\r\n    if (!p2 || p2.closed || typeof p2.closed === 'undefined' || p2 === null) {\r\n      this.onPopupBlockedError(preCheck);\r\n      this.popupAllowed = false;\r\n    } else {\r\n      p2.close();\r\n      this.popupAllowed = true;\r\n      this.popupChecked = true;\r\n    }\r\n    return this.popupAllowed;\r\n  }\r\n\r\n  handleExportFormSubmit(data: ExportOptions) {\r\n    this.loading$.next(true);\r\n\r\n    const ogreFormats = Object.keys(ExportService.ogreFormats);\r\n    if (!this.popupChecked && data.layers.length > 1 &&\r\n      (ogreFormats.indexOf(data.format) >= 0 || data.format === ExportFormat.URL) && !this.popupAllowed) {\r\n      this.handlePopup();\r\n    }\r\n\r\n    let geomTypesCSV: { geometryType: string, features: any[] }[] = [];\r\n    let featuresCSV: any[] = [];\r\n    let filename: string = \"\";\r\n\r\n    for (const [layerIndex, layer] of data.layers.entries()) {\r\n      const lay = this.map.getLayerById(layer);\r\n      if (!(data.format === ExportFormat.CSVsemicolon || data.format === ExportFormat.CSVcomma)\r\n      || !data.combineLayers || data.layers.length === 1) {\r\n        filename = lay.title;\r\n        if (data.name) {\r\n          filename = data.name;\r\n        }\r\n      } else {\r\n        filename = this.languageService.translate.instant('igo.geo.export.combinedLayers');\r\n      }\r\n      const dSOptions: DataSourceOptions = lay.dataSource.options;\r\n      if (data.format === ExportFormat.URL && dSOptions.download && (dSOptions.download.url || dSOptions.download.dynamicUrl)) {\r\n        setTimeout(() => {\r\n          // better look an feel\r\n          const url = dSOptions.download.url || dSOptions.download.dynamicUrl;\r\n          url.match(/service=wfs/gi) ? this.downloadService.open(lay) : window.open(url , '_blank');\r\n          this.loading$.next(false);\r\n        }, 500);\r\n        return;\r\n      }\r\n      const wks = this.getWorkspaceByLayerId(layer);\r\n      let olFeatures;\r\n      if (wks && wks.entityStore && wks.entityStore.stateView.all().length) {\r\n\r\n        if (data.layersWithSelection.indexOf(layer) !== -1 && data.featureInMapExtent) {\r\n          // Only export selected feature && into map extent\r\n          olFeatures = wks.entityStore.stateView.all()\r\n            .filter((e: EntityRecord<object>) => e.state.inMapExtent && e.state.selected).map(e => (e.entity as Feature).ol);\r\n        } else if (data.layersWithSelection.indexOf(layer) !== -1 && !data.featureInMapExtent) {\r\n          // Only export selected feature &&  (into map extent OR not)\r\n          olFeatures = wks.entityStore.stateView.all()\r\n            .filter((e: EntityRecord<object>) => e.state.selected).map(e => (e.entity as Feature).ol);\r\n        } else if (data.featureInMapExtent) {\r\n          // Only into map extent\r\n          olFeatures = wks.entityStore.stateView.all()\r\n            .filter((e: EntityRecord<object>) => e.state.inMapExtent).map(e => (e.entity as Feature).ol);\r\n        } else {\r\n          // All features\r\n          olFeatures = wks.entityStore.stateView.all().map(e => (e.entity as Feature).ol);\r\n        }\r\n      }\r\n      else {\r\n        const ol = lay.dataSource.ol as olVectorSource<OlGeometry> | olClusterSource ;\r\n        if (data.featureInMapExtent) {\r\n          olFeatures = ol.getFeaturesInExtent(\r\n            lay.map.viewController.getExtent()\r\n          );\r\n        } else {\r\n          olFeatures = ol.getFeatures();\r\n        }\r\n        if (lay.dataSource instanceof ClusterDataSource) {\r\n          olFeatures = olFeatures.flatMap((cluster: any) =>\r\n            cluster.get('features')\r\n          );\r\n        }\r\n      }\r\n\r\n      const translate = this.languageService.translate;\r\n      let geomTypes: { geometryType: string, features: any[] }[] = [];\r\n      if (data.format === ExportFormat.Shapefile || data.format === ExportFormat.GPX) {\r\n        olFeatures.forEach((olFeature) => {\r\n          const featureGeomType = olFeature.getGeometry().getType();\r\n          const currentGeomType = geomTypes.find(geomType => geomType.geometryType === featureGeomType);\r\n          if (currentGeomType) {\r\n            currentGeomType.features.push(olFeature);\r\n          } else {\r\n            geomTypes.push({ geometryType: featureGeomType, features: [olFeature] });\r\n          }\r\n        });\r\n      } else {\r\n        geomTypes = [{ geometryType: '', features: olFeatures }];\r\n      }\r\n\r\n      geomTypes.forEach(geomType => {\r\n        geomType.features.forEach(feature => {\r\n          const radius: number = feature.get('rad');\r\n          if (radius) {\r\n            const center4326: Array<number> = [feature.get('longitude'), feature.get('latitude')];\r\n            const circle = circular(center4326, radius, 500);\r\n            circle.transform('EPSG:4326', feature.get('_projection'));\r\n            feature.setGeometry(circle);\r\n          }\r\n        });\r\n      });\r\n\r\n      if (data.format === ExportFormat.GPX) {\r\n        const gpxFeatureCnt = geomTypes.length;\r\n        geomTypes = geomTypes.filter(geomType => ['LineString', 'Point'].includes(geomType.geometryType));\r\n        const gpxFeatureCntPointOrPoly = geomTypes.length;\r\n        if (gpxFeatureCnt > gpxFeatureCntPointOrPoly) {\r\n          const title = translate.instant('igo.geo.export.gpx.error.poly.title');\r\n          const message = translate.instant('igo.geo.export.gpx.error.poly.text');\r\n          this.messageService.error(message, title, { timeOut: 20000 });\r\n        }\r\n      } else if ((data.format === ExportFormat.CSVsemicolon || data.format === ExportFormat.CSVcomma) && data.combineLayers) {\r\n        geomTypes.forEach(geomType => geomTypesCSV.push(geomType));\r\n\r\n        if (layerIndex !== data.layers.length - 1) {\r\n          continue;\r\n        } else {\r\n          let previousFeature = undefined;\r\n          geomTypesCSV.forEach(geomType => {\r\n            geomType.features.forEach(currentFeature => {\r\n              if (data.separator) {\r\n                if (previousFeature) {\r\n                  if (currentFeature.get('_featureStore').layer.options.title !==\r\n                  previousFeature.get('_featureStore').layer.options.title) {\r\n                    const titleEmptyRows = this.createTitleEmptyRows(previousFeature, currentFeature);\r\n                    featuresCSV.push(titleEmptyRows[2]);\r\n                    featuresCSV.push(titleEmptyRows[0]);\r\n                    featuresCSV.push(titleEmptyRows[1]);\r\n                  }\r\n                } else {\r\n                  const titleEmptyRows = this.createTitleEmptyRows(currentFeature, currentFeature);\r\n                  featuresCSV.push(titleEmptyRows[0]);\r\n                }\r\n              }\r\n              featuresCSV.push(currentFeature);\r\n              previousFeature = currentFeature;\r\n            });\r\n          });\r\n        }\r\n      }\r\n\r\n      if (geomTypes.length === 0) {\r\n        this.loading$.next(false);\r\n        const title = translate.instant('igo.geo.export.nothing.title');\r\n        const message = translate.instant('igo.geo.export.nothing.text');\r\n        this.messageService.error(message, title, { timeOut: 20000 });\r\n\r\n      } else {\r\n        if (!(data.format === ExportFormat.CSVsemicolon || data.format === ExportFormat.CSVcomma) || !data.combineLayers) {\r\n          geomTypes.map(geomType =>\r\n            this.exportService.export(geomType.features, data.format, filename + geomType.geometryType, data.encoding, this.map.projection)\r\n            .subscribe(\r\n              () => {},\r\n              (error: Error) => this.onFileExportError(error),\r\n              () => {\r\n                this.onFileExportSuccess();\r\n\r\n                geomType.features.forEach(feature => {\r\n                  this.circleToPoint(feature);\r\n                });\r\n\r\n                this.loading$.next(false);\r\n            }\r\n          ));\r\n        }\r\n      }\r\n    };\r\n    if ((data.format === ExportFormat.CSVsemicolon || data.format === ExportFormat.CSVcomma) && data.combineLayers) {\r\n      this.exportService.export(featuresCSV, data.format, filename, data.encoding, this.map.projection)\r\n      .subscribe(\r\n        () => {},\r\n        (error: Error) => this.onFileExportError(error),\r\n        () => {\r\n          this.onFileExportSuccess();\r\n\r\n          featuresCSV.forEach(feature => {\r\n            this.circleToPoint(feature);\r\n          });\r\n\r\n          this.loading$.next(false);\r\n        }\r\n      );\r\n    }\r\n  }\r\n\r\n  private createTitleEmptyRows(previousFeature, currentFeature) {\r\n    const titleRow = currentFeature.clone();\r\n    const headerRow = currentFeature.clone();\r\n    const emptyRow = currentFeature.clone();\r\n    const previousFeatureKeys: Array<string> = previousFeature.getKeys();\r\n    let firstKeyPrevious: string = '';\r\n    for (const key in previousFeatureKeys) {\r\n      if (previousFeatureKeys[key] !== 'geometry') {\r\n        firstKeyPrevious = previousFeatureKeys[key];\r\n        break;\r\n      }\r\n    }\r\n\r\n    const currentFeatureKeys: Array<string> = currentFeature.getKeys();\r\n    let firstKeyCurrent: string = '';\r\n    for (const key in currentFeatureKeys) {\r\n      if (currentFeatureKeys[key] !== 'geometry') {\r\n        firstKeyCurrent = currentFeatureKeys[key];\r\n        break;\r\n      }\r\n    }\r\n    const allKeys: Array<string> = currentFeature.getKeys();\r\n    previousFeatureKeys.forEach(previousKey => {\r\n      if (allKeys.includes(previousKey) && previousKey !== firstKeyPrevious) {\r\n        allKeys.push(previousKey);\r\n      }\r\n    });\r\n    allKeys.unshift(firstKeyPrevious);\r\n\r\n    let firstKeyAll: string = '';\r\n    for (const key in allKeys) {\r\n      if (allKeys[key] !== 'geometry') {\r\n        firstKeyAll = allKeys[key];\r\n        break;\r\n      }\r\n    }\r\n    allKeys.forEach(key => {\r\n      const sameKeys: boolean = previousFeatureKeys.length === currentFeatureKeys.length &&\r\n      previousFeatureKeys.every((value, index) => value === currentFeatureKeys[index]);\r\n      if (key === firstKeyAll && !sameKeys) {\r\n        titleRow.set(key, currentFeature.get('_featureStore').layer.options.title + \" ===============>\", true);\r\n        headerRow.set(key, key, true);\r\n        emptyRow.unset(key, true);\r\n      } else if (key === firstKeyAll && sameKeys) {\r\n        titleRow.set(key, currentFeature.get('_featureStore').layer.options.title, true);\r\n        headerRow.set(key, key, true);\r\n        emptyRow.unset(key, true);\r\n      } else if (key === firstKeyCurrent) {\r\n        titleRow.set(key, currentFeature.get('_featureStore').layer.options.title, true);\r\n        headerRow.set(key, key, true);\r\n        emptyRow.unset(key, true);\r\n      } else if (key !== 'geometry') {\r\n        titleRow.unset(key, true);\r\n        headerRow.set(key, key, true);\r\n        emptyRow.unset(key, true);\r\n      } else {\r\n        titleRow.unset(key, true);\r\n        emptyRow.unset(key, true);\r\n      }\r\n\r\n      if (!(currentFeatureKeys.includes(key))) {\r\n        headerRow.unset(key, true);\r\n      }\r\n    });\r\n    const titleEmptyRows = [titleRow, headerRow, emptyRow];\r\n    return titleEmptyRows;\r\n  }\r\n\r\n  private circleToPoint(feature) {\r\n    const radius: number = feature.get('rad');\r\n\r\n    if (radius) {\r\n      const point = new olPoint([feature.get('longitude'), feature.get('latitude')]);\r\n      point.transform('EPSG:4326', feature.get('_projection'));\r\n      feature.setGeometry(point);\r\n    }\r\n  }\r\n\r\n  private buildForm() {\r\n    this.importForm = this.formBuilder.group({\r\n      inputProj: ['', [Validators.required]]\r\n    });\r\n\r\n    if (this.forceNaming) {\r\n      this.form = this.formBuilder.group({\r\n        format: ['', [Validators.required]],\r\n        layers: [[], [Validators.required]],\r\n        layersWithSelection: [[]],\r\n        encoding: [EncodingFormat.UTF8, [Validators.required]],\r\n        combineLayers: [true, [Validators.required]],\r\n        separator: [false, [Validators.required]],\r\n        featureInMapExtent: [false, [Validators.required]],\r\n        name: ['', [Validators.required]]\r\n      });\r\n    } else {\r\n      this.form = this.formBuilder.group({\r\n        format: ['', [Validators.required]],\r\n        layers: [[], [Validators.required]],\r\n        layersWithSelection: [[]],\r\n        encoding: [EncodingFormat.UTF8, [Validators.required]],\r\n        combineLayers: [true, [Validators.required]],\r\n        separator: [false, [Validators.required]],\r\n        featureInMapExtent: [false, [Validators.required]],\r\n      });\r\n    }\r\n  }\r\n\r\n  private onFileImportSuccess(file: File, features: Feature[]) {\r\n    if (!this.config.getConfig('importWithStyle')) {\r\n      handleFileImportSuccess(\r\n        file,\r\n        features,\r\n        this.map,\r\n        this.messageService,\r\n        this.languageService\r\n      );\r\n    } else {\r\n      handleFileImportSuccess(\r\n        file,\r\n        features,\r\n        this.map,\r\n        this.messageService,\r\n        this.languageService,\r\n        this.styleListService,\r\n        this.styleService\r\n      );\r\n    }\r\n  }\r\n\r\n  private onFileImportError(file: File, error: Error) {\r\n    this.loading$.next(false);\r\n    handleFileImportError(\r\n      file,\r\n      error,\r\n      this.messageService,\r\n      this.languageService,\r\n      this.fileSizeMb\r\n    );\r\n  }\r\n\r\n  private onPopupBlockedError(preCheck: boolean = true) {\r\n    this.loading$.next(false);\r\n    const translate = this.languageService.translate;\r\n    const title = translate.instant('igo.geo.export.popupBlocked.title');\r\n    const extraMessage = preCheck ?\r\n      translate.instant('igo.geo.export.popupBlocked.selectAgain') :\r\n      translate.instant('igo.geo.export.popupBlocked.retry');\r\n    const message = translate.instant('igo.geo.export.popupBlocked.text', { extraMessage });\r\n    this.messageService.error(message, title, { timeOut: 20000 });\r\n  }\r\n\r\n  private onFileExportError(error: Error) {\r\n    this.loading$.next(false);\r\n    handleFileExportError(error, this.messageService, this.languageService);\r\n  }\r\n\r\n  private loadConfig() {\r\n    if (this.config.getConfig('importExport.forceNaming') !== undefined) {\r\n      this.forceNaming = this.config.getConfig('importExport.forceNaming');\r\n    }\r\n    this.computeFormats();\r\n    this.loadEncodings();\r\n  }\r\n\r\n  public encodingDefaultValue(format: ExportFormat) {\r\n    if (format === ExportFormat.CSVcomma || format === ExportFormat.CSVsemicolon) {\r\n      this.form.patchValue({ encoding: EncodingFormat.LATIN1 });\r\n      return EncodingFormat.LATIN1;\r\n    } else {\r\n      this.form.patchValue({ encoding: EncodingFormat.UTF8 });\r\n      return EncodingFormat.UTF8;\r\n    }\r\n  }\r\n\r\n  private loadEncodings() {\r\n    this.encodings$.next(EncodingFormat);\r\n  }\r\n\r\n  private computeFormats(layers?: AnyLayer[]) {\r\n    let appliedformats: string[] = Object.keys(ExportFormat);\r\n    const formatsType = {\r\n      onlyUrl: false,\r\n      onlyVector: false,\r\n      vectorAndUrl: false,\r\n      customList: false\r\n    };\r\n    const customList = [];\r\n    if (layers && layers.length) {\r\n      layers.forEach((layer) => {\r\n        if (!layer) {\r\n          return;\r\n        }\r\n        if (layer.dataSource.options.download?.allowedFormats) {\r\n          formatsType.customList = true;\r\n          customList.push({layer: layer.title, formats: this.validateListFormat(layer.dataSource.options.download.allowedFormats)});\r\n        } else if (\r\n          !(layer instanceof VectorLayer) &&\r\n          layer.dataSource.options.download &&\r\n          layer.dataSource.options.download.url\r\n        ) {\r\n          formatsType.onlyUrl = true;\r\n        } else if (\r\n          layer.dataSource.options.download &&\r\n          (layer.dataSource.options.download.url || layer.dataSource.options.download.dynamicUrl)\r\n        ) {\r\n          formatsType.vectorAndUrl = true;\r\n        } else if (layer instanceof VectorLayer) {\r\n          formatsType.onlyVector = true;\r\n        }\r\n      });\r\n\r\n      if (formatsType.onlyUrl === true && formatsType.onlyVector === false) {\r\n        appliedformats = ['URL'];\r\n      } else if (\r\n        formatsType.onlyVector === true &&\r\n        formatsType.onlyUrl === false\r\n      ) {\r\n        this.computeFormats(); // reset\r\n        if (ExportFormat.URL in this.formats$.value) {\r\n          const keys = Object.keys(this.formats$.value).filter(\r\n            (key) => key !== 'URL'\r\n          );\r\n          appliedformats = keys;\r\n        }\r\n      } else if (\r\n        formatsType.vectorAndUrl === true &&\r\n        formatsType.onlyUrl === false &&\r\n        formatsType.onlyVector === false\r\n      ) {\r\n        this.computeFormats(); // reset\r\n        if (!(ExportFormat.URL in this.formats$.value)) {\r\n          const keys = Object.keys(this.formats$.value);\r\n          keys.push('URL');\r\n          appliedformats = keys;\r\n        }\r\n      }\r\n    }\r\n    if (this.config.getConfig('importExport.formats') !== undefined) {\r\n      const validatedListFormat = this.validateListFormat(\r\n        this.config.getConfig('importExport.formats')\r\n      );\r\n      appliedformats = validatedListFormat;\r\n    }\r\n    if (formatsType.customList) {\r\n      let commonFormats;\r\n      const layersWithCustomFormats = [];\r\n      let previousCustomListFormats = customList[0].formats;\r\n      customList.map(list => {\r\n        layersWithCustomFormats.push(list.layer);\r\n        commonFormats = list.formats.filter(value => previousCustomListFormats.includes(value));\r\n        previousCustomListFormats = list.formats;\r\n      });\r\n      const finalFormats = commonFormats.filter(value => appliedformats.includes(value));\r\n      if (finalFormats.length > 0) {\r\n        this.formats$.next(strEnum(finalFormats));\r\n\r\n        if (layers && layers.length) {\r\n          if (layers.length > 1) {\r\n            this.messageService.alert(\r\n              this.languageService.translate.instant('igo.geo.export.customList.text', { value: layersWithCustomFormats.join() }),\r\n              this.languageService.translate.instant('igo.geo.export.customList.title')\r\n            );\r\n          }\r\n        }\r\n      } else {\r\n        this.formats$.next([]);\r\n        this.messageService.alert(\r\n          this.languageService.translate.instant('igo.geo.export.noFormat.text'),\r\n          this.languageService.translate.instant('igo.geo.export.noFormat.title')\r\n        );\r\n      }\r\n      return;\r\n    } else {\r\n      this.formats$.next(strEnum(appliedformats));\r\n    }\r\n  }\r\n\r\n  private validateListFormat(formats: string[]): string[] {\r\n    return formats\r\n      .filter((format) => {\r\n        if (\r\n          format.toUpperCase() === ExportFormat.CSVcomma.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.CSVsemicolon.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.GML.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.GPX.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.GeoJSON.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.KML.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.Shapefile.toUpperCase() ||\r\n          format.toUpperCase() === ExportFormat.URL.toUpperCase()\r\n        ) {\r\n          return format;\r\n        }\r\n      })\r\n      .map((format) => {\r\n        if (format.toUpperCase() === ExportFormat.CSVcomma.toUpperCase()) {\r\n          format = ExportFormat.CSVcomma;\r\n          return format;\r\n        }\r\n        if (format.toUpperCase() === ExportFormat.CSVsemicolon.toUpperCase()) {\r\n          format = ExportFormat.CSVsemicolon;\r\n          return format;\r\n        }\r\n        if (format.toUpperCase() === ExportFormat.GML.toUpperCase()) {\r\n          format = ExportFormat.GML;\r\n          return format;\r\n        }\r\n        if (format.toUpperCase() === ExportFormat.GPX.toUpperCase()) {\r\n          format = ExportFormat.GPX;\r\n          return format;\r\n        }\r\n        if (format.toUpperCase() === ExportFormat.GeoJSON.toUpperCase()) {\r\n          format = ExportFormat.GeoJSON;\r\n          return format;\r\n        }\r\n        if (format.toUpperCase() === ExportFormat.KML.toUpperCase()) {\r\n          format = ExportFormat.KML;\r\n          return format;\r\n        }\r\n        if (format.toUpperCase() === ExportFormat.Shapefile.toUpperCase()) {\r\n          format = ExportFormat.Shapefile;\r\n          return format;\r\n        }\r\n\r\n        if (format.toUpperCase() === ExportFormat.URL.toUpperCase()) {\r\n          format = ExportFormat.URL;\r\n          return format;\r\n        }\r\n      });\r\n  }\r\n\r\n  public modeChanged(mode) {\r\n    this.selectMode.emit(mode);\r\n  }\r\n\r\n  private onFileExportSuccess() {\r\n    handleFileExportSuccess(this.messageService, this.languageService);\r\n  }\r\n\r\n  onImportExportChange(event) {\r\n    this.selectedMode = event.value;\r\n  }\r\n}\r\n","import { ProjectionsLimitationsOptions } from './projection.interfaces';\r\n\r\n/**\r\n * Return a number of zone MTM for a longitude for province of Quebec only\r\n * @param lon number\r\n * @returns zone\r\n */\r\nexport function zoneMtm(lon: number): number {\r\n    let lonMin = -54;\r\n    const lonMax = -81;\r\n    if (lon < lonMax || lon > lonMin) {\r\n      return 0;\r\n    }\r\n    else {\r\n      const deltaLon = 3;\r\n      let zone = 2;\r\n      while (Math.abs(lon - lonMin) > deltaLon) {\r\n        lonMin = lonMin - deltaLon;\r\n        zone++;\r\n      }\r\n      return zone;\r\n    }\r\n  }\r\n/**\r\n * Return a number of zone UTM for a longitude\r\n * @param lon number\r\n * @returns zone\r\n */\r\nexport function zoneUtm(lon: number): number {\r\n  let lonMin = -180;\r\n  const lonMax = 180;\r\n  const deltaLon = 6;\r\n  let zone = 1;\r\n  while (Math.abs(lon - lonMin) > deltaLon) {\r\n    lonMin = lonMin + deltaLon;\r\n    zone++;\r\n  }\r\n  return zone;\r\n}\r\n\r\n/**\r\n * Compute the contraints of projections\r\n * @param projectionsLimitations: ProjectionsLimitationsOptions\r\n * @returns projectionsContraints: ProjectionsLimitationsOptions\r\n */\r\nexport function computeProjectionsConstraints(\r\n    projectionsLimitations: ProjectionsLimitationsOptions):\r\n    ProjectionsLimitationsOptions {\r\n    const mtmZone = projectionsLimitations.mtmZone;\r\n    const utmZone = projectionsLimitations.utmZone;\r\n    const projectionsConstraints = {\r\n        projFromConfig: projectionsLimitations.projFromConfig === false ? false : true,\r\n        nad83: projectionsLimitations.nad83 === false ? false : true,\r\n        wgs84: projectionsLimitations.wgs84 === false ? false : true,\r\n        webMercator: projectionsLimitations.webMercator === false ? false : true,\r\n        utm: projectionsLimitations.utm === false ? false : true,\r\n        mtm: projectionsLimitations.mtm === false ? false : true,\r\n        utmZone: {\r\n        minZone: utmZone && utmZone.minZone ? utmZone.minZone : 17,\r\n        maxZone: utmZone && utmZone.maxZone ? utmZone.maxZone : 21,\r\n        },\r\n        mtmZone: {\r\n        minZone: mtmZone && mtmZone.minZone ? mtmZone.minZone : 2,\r\n        maxZone: mtmZone && mtmZone.maxZone ? mtmZone.maxZone : 10,\r\n        }\r\n    };\r\n    return projectionsConstraints;\r\n  }\r\n","import {\r\n  getEntityProperty,\r\n  EntityTableColumn,\r\n  EntityTableColumnRenderer\r\n} from '@igo2/common';\r\nimport { MessageService, LanguageService } from '@igo2/core';\r\nimport { downloadContent } from '@igo2/utils';\r\n\r\nimport { ExportNothingToExportError } from './export.errors';\r\n\r\nexport function handleFileExportError(\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  if (error instanceof ExportNothingToExportError) {\r\n    handleNothingToExportError(messageService, languageService);\r\n    return;\r\n  }\r\n  const translate = languageService.translate;\r\n  const title = translate.instant('igo.geo.export.failed.title');\r\n  const message = translate.instant('igo.geo.export.failed.text');\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function handleFileExportSuccess(\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant('igo.geo.export.success.title');\r\n  const message = translate.instant('igo.geo.export.success.text');\r\n  messageService.success(message, title);\r\n}\r\n\r\nexport function handleNothingToExportError(\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant('igo.geo.export.nothing.title');\r\n  const message = translate.instant('igo.geo.export.nothing.text');\r\n  messageService.error(message, title);\r\n}\r\n\r\n/**\r\n * Export array to CSV\r\n *\r\n * @param rows Array of arrays to export as CSV\r\n * @param separator Cell separator\r\n */\r\nexport function exportToCSV(rows: any[][], fileName: string, separator: string = ';') {\r\n  const lines = rows.map((row: any[][], index: number) => row.join(separator));\r\n  const csvContent = lines.join('\\n');\r\n  downloadContent(csvContent, 'text/csv;charset=utf-8', fileName);\r\n}\r\n\r\n/**\r\n * Return an array of values from an array of entities.\r\n *\r\n * @param entities Array of entities\r\n * @param scolumns Columns definition of the output data\r\n */\r\nexport function entitiesToRowData(entities: object[], columns: EntityTableColumn[]) {\r\n  return entities.map((entity: object) => {\r\n    return columns.map((column: EntityTableColumn) => {\r\n      let valueAccessor;\r\n      if (column.renderer === undefined || column.renderer === EntityTableColumnRenderer.Default) {\r\n        valueAccessor = column.valueAccessor;\r\n      }\r\n      valueAccessor = valueAccessor ? valueAccessor : getEntityProperty;\r\n      return valueAccessor(entity, column.name);\r\n    });\r\n  });\r\n}\r\n","import { APP_INITIALIZER, InjectionToken } from '@angular/core';\r\n\r\nimport { StyleListService } from './style-list.service';\r\nimport { StyleListOptions } from './style-list.interface';\r\n\r\nexport let STYLELIST_OPTIONS = new InjectionToken<StyleListOptions>('styleListOptions');\r\n\r\nexport function provideStyleListOptions(options: StyleListOptions) {\r\n  return {\r\n    provide: STYLELIST_OPTIONS,\r\n    useValue: options\r\n  };\r\n}\r\n\r\nexport function styleListFactory(\r\n  styleListService: StyleListService,\r\n  options: StyleListOptions\r\n) {\r\n  return () => styleListService.load(options);\r\n}\r\n\r\nexport function provideStyleListLoader() {\r\n  return {\r\n    provide: APP_INITIALIZER,\r\n    useFactory: styleListFactory,\r\n    multi: true,\r\n    deps: [StyleListService, STYLELIST_OPTIONS]\r\n  };\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { provideStyleListOptions, provideStyleListLoader } from './style-list.provider';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [],\r\n  exports: []\r\n})\r\nexport class IgoStyleListModule {\r\n  static forRoot(): ModuleWithProviders<IgoStyleListModule> {\r\n    return {\r\n      ngModule: IgoStyleListModule,\r\n      providers: [provideStyleListOptions({}), provideStyleListLoader()]\r\n    };\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatButtonToggleModule } from '@angular/material/button-toggle';\r\nimport { MatOptionModule } from '@angular/material/core';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatSlideToggleModule } from '@angular/material/slide-toggle';\r\nimport { MatTabsModule } from '@angular/material/tabs';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoKeyValueModule, IgoDrapDropModule, IgoSpinnerModule } from '@igo2/common';\r\n\r\nimport { ExportButtonComponent } from './export-button/export-button.component';\r\nimport { ImportExportComponent } from './import-export/import-export.component';\r\nimport { DropGeoFileDirective } from './shared/drop-geo-file.directive';\r\nimport { IgoStyleListModule } from './style-list/style-list.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    MatIconModule,\r\n    MatTooltipModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    CommonModule,\r\n    MatButtonModule,\r\n    MatButtonToggleModule,\r\n    MatTabsModule,\r\n    MatSelectModule,\r\n    MatOptionModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatSlideToggleModule,\r\n    IgoLanguageModule,\r\n    IgoSpinnerModule,\r\n    IgoKeyValueModule,\r\n    IgoDrapDropModule,\r\n    IgoStyleListModule.forRoot()\r\n  ],\r\n  exports: [ImportExportComponent, DropGeoFileDirective, IgoStyleListModule, ExportButtonComponent],\r\n  declarations: [ImportExportComponent, DropGeoFileDirective, ExportButtonComponent]\r\n})\r\nexport class IgoImportExportModule {\r\n  static forRoot(): ModuleWithProviders<IgoImportExportModule> {\r\n    return {\r\n      ngModule: IgoImportExportModule\r\n    };\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoConfirmDialogModule } from '@igo2/common';\r\nimport { MapBrowserComponent } from './map-browser/map-browser.component';\r\nimport { ZoomButtonComponent } from './zoom-button/zoom-button.component';\r\nimport { GeolocateButtonComponent } from './geolocate-button/geolocate-button.component';\r\nimport { HomeExtentButtonComponent } from './home-extent-button/home-extent-button.component';\r\nimport { RotationButtonComponent } from './rotation-button/rotation-button.component';\r\nimport { BaseLayersSwitcherComponent } from './baselayers-switcher/baselayers-switcher.component';\r\nimport { MiniBaseMapComponent } from './baselayers-switcher/mini-basemap.component';\r\nimport { MapOfflineDirective } from './shared/mapOffline.directive';\r\nimport { OfflineButtonComponent } from './offline-button/offline-button.component';\r\nimport { WakeLockButtonComponent } from './wake-lock-button/wake-lock-button.component';\r\nimport { PointerPositionDirective } from './shared/map-pointer-position.directive';\r\nimport { HoverFeatureDirective } from './shared/hover-feature.directive';\r\nimport { SwipeControlComponent } from './swipe-control/swipe-control.component';\r\nimport { MapCenterComponent } from './map-center/map-center.component';\r\nimport { MenuButtonComponent } from './menu-button/menu-button.component';\r\nimport { InfoSectionComponent } from './info-section/info-section.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoLanguageModule,\r\n    IgoConfirmDialogModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatTooltipModule\r\n  ],\r\n  exports: [\r\n    MapBrowserComponent,\r\n    ZoomButtonComponent,\r\n    GeolocateButtonComponent,\r\n    HomeExtentButtonComponent,\r\n    RotationButtonComponent,\r\n    InfoSectionComponent,\r\n    BaseLayersSwitcherComponent,\r\n    MiniBaseMapComponent,\r\n    MapOfflineDirective,\r\n    OfflineButtonComponent,\r\n    WakeLockButtonComponent,\r\n    PointerPositionDirective,\r\n    HoverFeatureDirective,\r\n    SwipeControlComponent,\r\n    MapCenterComponent,\r\n    MenuButtonComponent\r\n  ],\r\n  declarations: [\r\n    MapBrowserComponent,\r\n    ZoomButtonComponent,\r\n    GeolocateButtonComponent,\r\n    HomeExtentButtonComponent,\r\n    RotationButtonComponent,\r\n    InfoSectionComponent,\r\n    BaseLayersSwitcherComponent,\r\n    MiniBaseMapComponent,\r\n    MapOfflineDirective,\r\n    OfflineButtonComponent,\r\n    WakeLockButtonComponent,\r\n    PointerPositionDirective,\r\n    HoverFeatureDirective,\r\n    SwipeControlComponent,\r\n    MapCenterComponent,\r\n    MenuButtonComponent\r\n  ]\r\n})\r\nexport class IgoMapModule {}\r\n","<mat-form-field\r\n  class=\"measure-field\"\r\n  appearance=\"outline\"\r\n  floatLabel=\"always\">\r\n  <mat-label>{{placeholder}}</mat-label>\r\n  <input\r\n    matInput\r\n    [readonly]=\"true\"\r\n    [value]=\"((measure$ | async) || 0) | measureFormat: measureUnit\">\r\n</mat-form-field>\r\n<mat-form-field class=\"unit-field\">\r\n  <mat-select\r\n    [value]=\"measureUnit\"\r\n    [disabled]=\"auto\"\r\n    (selectionChange)=\"onMeasureUnitChange($event.value)\">\r\n    <mat-option *ngFor=\"let measureUnit of measureUnits\" [value]=\"measureUnit\">\r\n      {{('igo.geo.measure.' + measureUnit) | translate}}\r\n    </mat-option>\r\n  </mat-select>\r\n</mat-form-field>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\nimport {\r\n  MeasureType,\r\n  MeasureAreaUnit,\r\n  MeasureLengthUnit\r\n} from '../shared/measure.enum';\r\nimport { computeBestAreaUnit, computeBestLengthUnit } from '../shared/measure.utils';\r\n\r\n/**\r\n * Measurer item\r\n */\r\n@Component({\r\n  selector: 'igo-measurer-item',\r\n  templateUrl: './measurer-item.component.html',\r\n  styleUrls: ['./measurer-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class MeasurerItemComponent implements OnDestroy {\r\n\r\n  /**\r\n   * Measure observable\r\n   * @internal\r\n   */\r\n  public measure$: BehaviorSubject<number> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Subscription to the measure observable when the auto mode is on\r\n   * @internal\r\n   */\r\n  public measure$$: Subscription;\r\n\r\n  /**\r\n   * Measure type\r\n   */\r\n  @Input() measureType: MeasureType;\r\n\r\n  /**\r\n   * Measure unit\r\n   */\r\n  @Input() measureUnit: MeasureAreaUnit | MeasureLengthUnit;\r\n\r\n  /**\r\n   * Measure\r\n   */\r\n  @Input()\r\n  set measure(value: number) {\r\n    this.measure$.next(value);\r\n  }\r\n  get measure(): number { return this.measure$.value; }\r\n\r\n  /**\r\n   * Whther measure units should be automatically determined\r\n   */\r\n  @Input()\r\n  set auto(value: boolean) { this.toggleAutoUnit(value); }\r\n  get auto(): boolean { return this._auto; }\r\n  private _auto: boolean = false;\r\n\r\n  /**\r\n   * Placeholder\r\n   */\r\n  @Input() placeholder: string;\r\n\r\n  /**\r\n   * Event emitted when the measure unit changes\r\n   */\r\n  @Output() measureUnitChange = new EventEmitter<MeasureAreaUnit | MeasureLengthUnit>();\r\n\r\n  /**\r\n   * Available measure units for the measure type given\r\n   * @internal\r\n   */\r\n  get measureUnits(): string[] {\r\n    if (this.measureType === MeasureType.Area) {\r\n      return Object.values(MeasureAreaUnit);\r\n    }\r\n    return Object.values(MeasureLengthUnit);\r\n  }\r\n\r\n  constructor() {}\r\n\r\n  /**\r\n   * Toggle the auto unit off\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.toggleAutoUnit(false);\r\n  }\r\n\r\n  /**\r\n   * Set the measure unit\r\n   * @internal\r\n   */\r\n  onMeasureUnitChange(unit: MeasureAreaUnit | MeasureLengthUnit) {\r\n    this.measureUnit = unit;\r\n    this.measureUnitChange.emit(unit);\r\n  }\r\n\r\n  private toggleAutoUnit(toggle: boolean) {\r\n    if (this.measure$$ !== undefined) {\r\n      this.measure$$.unsubscribe();\r\n    }\r\n    if (toggle === true) {\r\n      this.measure$$ = this.measure$.subscribe((measure: number) => {\r\n        this.computeBestMeasureUnit(measure);\r\n      });\r\n    }\r\n    this._auto = toggle;\r\n  }\r\n\r\n  private computeBestMeasureUnit(measure: number) {\r\n    let measureUnit = this.measureUnit;\r\n    if (this.measureType === MeasureType.Area) {\r\n      measureUnit = computeBestAreaUnit(measure);\r\n    } else if (this.measureType === MeasureType.Length) {\r\n      measureUnit = computeBestLengthUnit(measure);\r\n    }\r\n    if (measureUnit !== this.measureUnit) {\r\n      this.onMeasureUnitChange(measureUnit);\r\n    }\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatButtonToggleModule } from '@angular/material/button-toggle';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatSlideToggleModule } from '@angular/material/slide-toggle';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\nimport { MatDividerModule } from '@angular/material/divider';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoEntityTableModule } from '@igo2/common';\r\n\r\nimport { MeasureFormatPipe } from './measure-format.pipe';\r\nimport { MeasurerItemComponent } from './measurer-item.component';\r\nimport { MeasurerComponent } from './measurer.component';\r\nimport { MeasurerDialogComponent } from './measurer-dialog.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatButtonModule,\r\n    MatButtonToggleModule,\r\n    MatIconModule,\r\n    MatTooltipModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatSelectModule,\r\n    MatSlideToggleModule,\r\n    MatDividerModule,\r\n    IgoLanguageModule,\r\n    IgoEntityTableModule\r\n  ],\r\n  declarations: [\r\n    MeasureFormatPipe,\r\n    MeasurerItemComponent,\r\n    MeasurerComponent,\r\n    MeasurerDialogComponent\r\n  ],\r\n  exports: [\r\n    MeasureFormatPipe,\r\n    MeasurerComponent\r\n  ]\r\n})\r\nexport class IgoMeasurerModule {}\r\n","import { NgModule } from '@angular/core';\r\n\r\nimport { IgoMeasurerModule } from './measurer/measurer.module';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [],\r\n  exports: [\r\n    IgoMeasurerModule\r\n  ]\r\n})\r\nexport class IgoMeasureModule {}\r\n","export enum OverlayAction {\r\n    None,\r\n    Move,\r\n    Zoom,\r\n    ZoomIfOutMapExtent\r\n  }\r\n","import { Injectable } from '@angular/core';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\n\r\nimport { OverlayAction } from './overlay.enum';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class OverlayService {\r\n  public features$ = new BehaviorSubject<[Feature[], OverlayAction]>([\r\n    [],\r\n    undefined\r\n  ]);\r\n\r\n  constructor() {}\r\n\r\n  setFeatures(features: Feature[], action: OverlayAction = OverlayAction.None) {\r\n    this.features$.next([features, action]);\r\n  }\r\n\r\n  clear() {\r\n    this.features$.next([[], OverlayAction.None]);\r\n  }\r\n}\r\n","import { Directive, Self, OnInit, OnDestroy } from '@angular/core';\r\nimport { Subscription } from 'rxjs';\r\n\r\nimport olFormatGeoJSON from 'ol/format/GeoJSON';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { MapBrowserComponent } from '../../map/map-browser/map-browser.component';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\n\r\nimport { OverlayService } from '../shared/overlay.service';\r\nimport { OverlayAction } from '../shared/overlay.enum';\r\n\r\n@Directive({\r\n  selector: '[igoOverlay]'\r\n})\r\nexport class OverlayDirective implements OnInit, OnDestroy {\r\n  private features$$: Subscription;\r\n  private format = new olFormatGeoJSON();\r\n\r\n  get map(): IgoMap {\r\n    return this.component.map;\r\n  }\r\n\r\n  constructor(\r\n    @Self() private component: MapBrowserComponent,\r\n    private overlayService: OverlayService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.features$$ = this.overlayService.features$.subscribe(res =>\r\n      this.handleFeatures(res[0], res[1])\r\n    );\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.features$$.unsubscribe();\r\n  }\r\n\r\n  private handleFeatures(features: Feature[], action: OverlayAction) {}\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\n\r\nimport { OverlayDirective } from './shared/overlay.directive';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  exports: [OverlayDirective],\r\n  declarations: [OverlayDirective]\r\n})\r\nexport class IgoOverlayModule {\r\n  static forRoot(): ModuleWithProviders<IgoOverlayModule> {\r\n    return {\r\n      ngModule: IgoOverlayModule\r\n    };\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\n\r\nimport { Observable, Subject, forkJoin } from 'rxjs';\r\nimport { map as rxMap } from 'rxjs/operators';\r\n\r\nimport { saveAs } from 'file-saver';\r\nimport jspdf from 'jspdf';\r\nimport html2canvas from 'html2canvas';\r\nimport * as JSZip from 'jszip';\r\n\r\nimport { SubjectStatus } from '@igo2/utils';\r\nimport { SecureImagePipe } from '@igo2/common';\r\nimport { MessageService, ActivityService, LanguageService, ConfigService } from '@igo2/core';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { formatScale } from '../../map/shared/map.utils';\r\nimport { LegendMapViewOptions } from '../../layer/shared/layers/layer.interface';\r\nimport { getLayersLegends } from '../../layer/utils/outputLegend';\r\n\r\nimport { PrintOptions } from './print.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class PrintService {\r\n  zipFile: JSZip;\r\n  nbFileToProcess: number;\r\n  activityId: string;\r\n  constructor(\r\n    private http: HttpClient,\r\n    private messageService: MessageService,\r\n    private activityService: ActivityService,\r\n    private languageService: LanguageService,\r\n    private configService: ConfigService\r\n  ) {}\r\n\r\n  print(map: IgoMap, options: PrintOptions): Subject<any> {\r\n    const status$ = new Subject();\r\n\r\n    const paperFormat: string = options.paperFormat;\r\n    const resolution = +options.resolution; // Default is 96\r\n    const orientation = options.orientation;\r\n    const legendPostion = options.legendPosition;\r\n\r\n    this.activityId = this.activityService.register();\r\n    const doc = new jspdf({\r\n      orientation,\r\n      format: paperFormat.toLowerCase()\r\n    });\r\n\r\n    const dimensions = [\r\n      doc.internal.pageSize.width,\r\n      doc.internal.pageSize.height\r\n    ];\r\n\r\n    const margins = [10, 10, 10, 10];\r\n    const width = dimensions[0] - margins[3] - margins[1];\r\n    const height = dimensions[1] - margins[0] - margins[2];\r\n    const size = [width, height];\r\n    let titleSizeResults = [0, 0];\r\n\r\n    if (options.title !== undefined) {\r\n      titleSizeResults = this.getTitleSize(options.title, width, height, doc); // return : size(pt) and left margin (mm)\r\n      this.addTitle(doc, options.title, titleSizeResults[0], margins[3] + titleSizeResults[1], titleSizeResults[0] * (25.4 / 72));\r\n    }\r\n    if (options.subtitle !== undefined) {\r\n      let subtitleSizeResult = 0;\r\n      const titleH = titleSizeResults[0];\r\n      subtitleSizeResult = this.getSubTitleSize(options.subtitle, width, height, doc); // return : size(pt) and left margin (mm)\r\n      this.addSubTitle(doc, options.subtitle, titleH * 0.7, margins[3] + subtitleSizeResult, titleH * 1.7 * (25.4 / 72));\r\n      margins[0] = margins[0] + titleSizeResults[0] * 0.7 * (25.4 / 72);\r\n    }\r\n    if (options.showProjection === true || options.showScale === true) {\r\n      this.addProjScale(\r\n        doc,\r\n        map,\r\n        resolution,\r\n        options.showProjection,\r\n        options.showScale\r\n        );\r\n    }\r\n    if (options.comment !== '') {\r\n      this.addComment(doc, options.comment);\r\n    }\r\n\r\n    this.addMap(doc, map, resolution, size, margins).subscribe(\r\n      async (status: SubjectStatus) => {\r\n        if (status === SubjectStatus.Done) {\r\n          await this.addScale(doc, map, margins);\r\n          await this.handleMeasureLayer(doc, map, margins);\r\n          if (options.legendPosition !== 'none') {\r\n            if (['topleft', 'topright', 'bottomleft', 'bottomright'].indexOf(options.legendPosition) > -1 ) {\r\n              await this.addLegendSamePage(doc, map, margins, resolution, options.legendPosition);\r\n            } else if (options.legendPosition === 'newpage') {\r\n              await this.addLegend(doc, map, margins, resolution);\r\n            }\r\n          } else {\r\n            await this.saveDoc(doc);\r\n          }\r\n        }\r\n\r\n        if (status === SubjectStatus.Done || status === SubjectStatus.Error) {\r\n          this.activityService.unregister(this.activityId);\r\n          status$.next(SubjectStatus.Done);\r\n        }\r\n      }\r\n    );\r\n\r\n    return status$;\r\n  }\r\n\r\n  /**\r\n   * Add measure overlay on the map on the document when the measure layer is present\r\n   * @param  doc - Pdf document where measure tooltip will be added\r\n   * @param  map - Map of the app\r\n   * @param  margins - Page margins\r\n   */\r\n  private async handleMeasureLayer(\r\n    doc: jspdf,\r\n    map: IgoMap,\r\n    margins: Array<number>\r\n  ) {\r\n    if (map.layers.find(layer => layer.visible && layer.id.startsWith('igo-measures-'))) {\r\n      let canvasOverlayHTMLMeasures;\r\n      const mapOverlayMeasuresHTML = map.ol.getOverlayContainer();\r\n      await html2canvas(mapOverlayMeasuresHTML, {\r\n        scale: 1,\r\n        backgroundColor: null\r\n      }).then(e => {\r\n        canvasOverlayHTMLMeasures = e;\r\n      });\r\n      this.addCanvas(doc, canvasOverlayHTMLMeasures, margins); // this adds measure overlays\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get html code for all layers legend\r\n   * @param  map IgoMap\r\n   * @param  width The width that the legend need to be\r\n   * @return Html code for the legend\r\n   */\r\n  getLayersLegendHtml(\r\n    map: IgoMap,\r\n    width: number,\r\n    resolution: number\r\n  ): Observable<string> {\r\n    return new Observable((observer) => {\r\n      let html = '';\r\n      const legends = getLayersLegends(\r\n        map.layers,\r\n        {\r\n          resolution: map.viewController.getResolution(),\r\n          extent: map.viewController.getExtent(),\r\n          projection: map.viewController.getOlProjection().getCode(),\r\n          // scale: map.viewController.getScale(resolution),\r\n          size: map.ol.getSize()\r\n        } as LegendMapViewOptions\r\n      );\r\n      if (legends.filter(l => l.display === true).length === 0) {\r\n        observer.next(html);\r\n        observer.complete();\r\n        return;\r\n      }\r\n      // Define important style to be sure that all container is convert\r\n      // to image not just visible part\r\n      html += '<style media=\"screen\" type=\"text/css\">';\r\n      html += '.html2canvas-container { width: ' + width + 'mm !important; height: 2000px !important; }';\r\n      html += 'table.tableLegend {table-layout: auto;}';\r\n      html += 'div.styleLegend {padding-top: 5px; padding-right:5px;padding-left:5px;padding-bottom:5px;}';\r\n      html += '</style>';\r\n      // The font size will also be lowered afterwards (globally along the legend size)\r\n      // this allows having a good relative font size here and to keep ajusting the legend size\r\n      // while keeping good relative font size\r\n      html += '<font size=\"3\" face=\"Times\" >';\r\n      html += '<div class=\"styleLegend\">';\r\n      html += '<table class=\"tableLegend\" >';\r\n\r\n      // For each legend, define an html table cell\r\n      const images$ = legends.filter(l => l.display).map((legend) =>\r\n        this.getDataImage(legend.url).pipe(\r\n          rxMap((dataImage) => {\r\n            let htmlImg = '<tr><td>' + legend.title.toUpperCase() + '</td></tr>';\r\n            htmlImg += '<tr><td><img src=\"' + dataImage + '\"></td></tr>';\r\n            return htmlImg;\r\n          })\r\n        )\r\n      );\r\n      forkJoin(images$).subscribe((dataImages) => {\r\n        html = dataImages.reduce((acc, current) => (acc += current), html);\r\n        html += '</table>';\r\n        html += '</div>';\r\n        observer.next(html);\r\n        observer.complete();\r\n      });\r\n    });\r\n  }\r\n\r\n  getDataImage(url: string): Observable<string> {\r\n    const secureIMG = new SecureImagePipe(this.http, this.configService);\r\n    return secureIMG.transform(url);\r\n  }\r\n\r\n  /**\r\n   * Get all the legend in a single image\r\n   * * @param  format - Image format. default value to \"png\"\r\n   * @return The image of the legend\r\n   */\r\n  async getLayersLegendImage(\r\n    map,\r\n    format: string = 'png',\r\n    doZipFile: boolean,\r\n    resolution: number\r\n  ) {\r\n    const status$ = new Subject();\r\n    // Get html code for the legend\r\n    const width = 200; // milimeters unit, originally define for document pdf\r\n    let html = await this.getLayersLegendHtml(\r\n      map,\r\n      width,\r\n      resolution\r\n    ).toPromise();\r\n    format = format.toLowerCase();\r\n\r\n    // If no legend show No LEGEND in an image\r\n    if (html.length === 0) {\r\n      html = '<font size=\"12\" face=\"Courier New\" >';\r\n      html += '<div align=\"center\"><b>NO LEGEND</b></div>';\r\n    }\r\n    // Create div to contain html code for legend\r\n    const div = window.document.createElement('div');\r\n    div.style.position = 'absolute';\r\n    div.style.top = '0';\r\n\r\n    // Add html code to convert in the new window\r\n    window.document.body.appendChild(div);\r\n    div.innerHTML = html;\r\n\r\n    await this.timeout(1);\r\n    const canvas = await html2canvas(div, { useCORS: true }).catch((e) => {\r\n      console.log(e);\r\n    });\r\n\r\n    if (canvas) {\r\n      let status = SubjectStatus.Done;\r\n      try {\r\n        if (!doZipFile) {\r\n          // Save the canvas as file\r\n          this.saveCanvasImageAsFile(canvas, 'legendImage', format);\r\n        } else {\r\n          // Add the canvas to zip\r\n          this.generateCanvaFileToZip(canvas, 'legendImage' + '.' + format);\r\n        }\r\n        div.parentNode.removeChild(div); // remove temp div (IE)\r\n      } catch (err) {\r\n        status = SubjectStatus.Error;\r\n      }\r\n      status$.next(status);\r\n    }\r\n\r\n    return status$;\r\n  }\r\n\r\n  getTitleSize(title: string, pageWidth: number, pageHeight: number, doc: jspdf) {\r\n    const pdfResolution = 96;\r\n    const titleSize = Math.round(2 * (pageHeight + 145) * 0.05) / 2;\r\n    doc.setFont('Times', 'bold');\r\n    const width = doc.getTextWidth(title);\r\n\r\n    const titleWidth = doc.getStringUnitWidth(title) * titleSize / doc.internal.scaleFactor;\r\n    const titleTailleMinimale = Math.round( 2 * (pageHeight + 150 ) * 0.037) / 2;\r\n    let titleFontSize = 0;\r\n\r\n    let titleMarginLeft;\r\n    if (titleWidth >= (pageWidth)) {\r\n      titleMarginLeft = 0;\r\n      titleFontSize = Math.round(((pageWidth / title.length) * pdfResolution) / 25.4);\r\n      // If the formula to find the font size gives below the defined minimum size\r\n      if (titleFontSize < titleTailleMinimale) {\r\n        titleFontSize = titleTailleMinimale;\r\n      }\r\n    } else {\r\n      titleMarginLeft = (pageWidth - titleWidth) / 2 ;\r\n      titleFontSize = titleSize;\r\n    }\r\n    return [titleFontSize, titleMarginLeft];\r\n  }\r\n\r\n  getSubTitleSize(subtitle: string, pageWidth: number, pageHeight: number, doc: jspdf) {\r\n    const subtitleSize = 0.7 * Math.round(2 * (pageHeight + 145) * 0.05) / 2; // 70% of the title's font size\r\n\r\n    doc.setFont('Times', 'bold');\r\n\r\n    const subtitleWidth = doc.getStringUnitWidth(subtitle) * subtitleSize / doc.internal.scaleFactor;\r\n\r\n    let subtitleMarginLeft;\r\n    if (subtitleWidth >= (pageWidth)) {\r\n      subtitleMarginLeft = 0;\r\n    } else {\r\n      subtitleMarginLeft = (pageWidth - subtitleWidth) / 2 ;\r\n    }\r\n    return subtitleMarginLeft;\r\n  }\r\n\r\n  private addTitle(doc: jspdf, title: string, titleFontSize: number, titleMarginLeft: number, titleMarginTop: number) {\r\n    doc.setFont('Times', 'bold');\r\n    doc.setFontSize(titleFontSize);\r\n    doc.text(title, titleMarginLeft, titleMarginTop);\r\n  }\r\n\r\n  private addSubTitle(doc: jspdf, subtitle: string, subtitleFontSize: number, subtitleMarginLeft: number, subtitleMarginTop: number) {\r\n    doc.setFont('Times', 'bold');\r\n    doc.setFontSize(subtitleFontSize);\r\n    doc.text(subtitle, subtitleMarginLeft, subtitleMarginTop);\r\n  }\r\n  /**\r\n   * Add comment to the document\r\n   * * @param  doc - pdf document\r\n   * * @param  comment - Comment to add in the document\r\n   * * @param  size - Size of the document\r\n   */\r\n  private addComment(doc: jspdf, comment: string) {\r\n    const commentSize = 16;\r\n    const commentMarginLeft = 20;\r\n    const marginBottom = 5;\r\n    const heightPixels = doc.internal.pageSize.height - marginBottom;\r\n\r\n    doc.setFont('courier');\r\n    doc.setFontSize(commentSize);\r\n    doc.text(comment, commentMarginLeft, heightPixels);\r\n  }\r\n  /**\r\n   * Add projection and/or scale to the document\r\n   * @param  doc - pdf document\r\n   * @param  map - Map of the app\r\n   * @param  dpi - DPI resolution of the document\r\n   * @param  projection - Bool to indicate if projection need to be added\r\n   * @param  scale - Bool to indicate if scale need to be added\r\n   */\r\n  private addProjScale(\r\n    doc: jspdf,\r\n    map: IgoMap,\r\n    dpi: number,\r\n    projection: boolean,\r\n    scale: boolean\r\n  ) {\r\n    const translate = this.languageService.translate;\r\n    const projScaleSize = 16;\r\n    const projScaleMarginLeft = 20;\r\n    const marginBottom = 15;\r\n    const heightPixels = doc.internal.pageSize.height - marginBottom;\r\n\r\n    let textProjScale: string = '';\r\n    if (projection === true) {\r\n      const projText = translate.instant('igo.geo.printForm.projection');\r\n      textProjScale += projText + ': ' + map.projection;\r\n    }\r\n    if (scale === true) {\r\n      if (projection === true) {\r\n        textProjScale += '   ';\r\n      }\r\n      const scaleText = translate.instant('igo.geo.printForm.scale');\r\n      const mapScale = map.viewController.getScale(dpi);\r\n      textProjScale += scaleText + ': ~ 1 / ' + formatScale(mapScale);\r\n    }\r\n    doc.setFont('courier');\r\n    doc.setFontSize(projScaleSize);\r\n    doc.text(textProjScale, projScaleMarginLeft, heightPixels);\r\n  }\r\n\r\n  /**\r\n   * Add the legend to the document\r\n   * @param  doc - Pdf document where legend will be added\r\n   * @param  map - Map of the app\r\n   * @param  margins - Page margins\r\n   */\r\n  private async addLegend(\r\n    doc: jspdf,\r\n    map: IgoMap,\r\n    margins: Array<number>,\r\n    resolution: number\r\n  ) {\r\n    // Get html code for the legend\r\n    const width = doc.internal.pageSize.width;\r\n    const html = await this.getLayersLegendHtml(\r\n      map,\r\n      width,\r\n      resolution\r\n    ).toPromise();\r\n    // If no legend, save the map directly\r\n    if (html === '') {\r\n      await this.saveDoc(doc);\r\n      return true;\r\n    }\r\n    // Create div to contain html code for legend\r\n    const div = window.document.createElement('div');\r\n    div.style.position = 'absolute';\r\n    div.style.top = '0';\r\n\r\n    // Add html code to convert in the new window\r\n    window.document.body.appendChild(div);\r\n    div.innerHTML = html;\r\n\r\n    await this.timeout(1);\r\n    const canvas = await html2canvas(div, { useCORS: true }).catch((e) => {\r\n      console.log(e);\r\n    });\r\n\r\n    if (canvas) {\r\n      const pourcentageReduction = 0.85;\r\n      const imageSize = [pourcentageReduction * (25.4 * canvas.width) / resolution, pourcentageReduction\r\n        * (25.4 * canvas.height) / resolution];\r\n      let imgData;\r\n      doc.addPage();\r\n      imgData = canvas.toDataURL('image/png');\r\n      doc.addImage(imgData, 'PNG', 10, 10, imageSize[0], imageSize[1]);\r\n      div.parentNode.removeChild(div); // remove temp div (IE style)\r\n    }\r\n\r\n    await this.saveDoc(doc);\r\n\r\n  }\r\n\r\n  /**\r\n   * Add the legend to the document\r\n   * @param  doc - Pdf document where legend will be added\r\n   * @param  map - Map of the app\r\n   * @param  margins - Page margins\r\n   */\r\n     private async addLegendSamePage(\r\n      doc: jspdf,\r\n      map: IgoMap,\r\n      margins: Array<number>,\r\n      resolution: number,\r\n      legendPosition: string\r\n    ) {\r\n      // Get html code for the legend\r\n      const width = doc.internal.pageSize.width;\r\n      const html = await this.getLayersLegendHtml(\r\n        map,\r\n        width,\r\n        resolution\r\n      ).toPromise();\r\n      // If no legend, save the map directly\r\n      if (html === '') {\r\n        await this.saveDoc(doc);\r\n        return true;\r\n      }\r\n      // Create div to contain html code for legend\r\n      const div = window.document.createElement('div');\r\n      div.style.position = 'absolute';\r\n      div.style.top = '0';\r\n      // Add html code to convert in the new window\r\n      window.document.body.appendChild(div);\r\n      div.innerHTML = html;\r\n      await this.timeout(1);\r\n      const canvas = await html2canvas(div, { useCORS: true }).catch((e) => {\r\n        console.log(e);\r\n      });\r\n      let marginsLegend;\r\n      if (canvas) {\r\n        const pourcentageReduction = 0.85;\r\n        const imageSize = [pourcentageReduction * (25.4 * canvas.width) / resolution,\r\n           pourcentageReduction * (25.4 * canvas.height) / resolution];\r\n        // Move the legend to the correct position on the page\r\n        if ( legendPosition === 'bottomright') {\r\n          marginsLegend = [doc.internal.pageSize.height - margins[2] - imageSize[1], margins[1],\r\n           margins[2], doc.internal.pageSize.width - margins[1] - imageSize[0]];\r\n        } else if (legendPosition === 'topright') {\r\n          marginsLegend = [margins[0], margins[1], doc.internal.pageSize.height - margins[0] - imageSize[1],\r\n          doc.internal.pageSize.width - margins[1] - imageSize[0] ];\r\n        } else if (legendPosition === 'bottomleft') {\r\n          // When the legend is in the bottom left, raise the legend slightly upward so that attributions are visible\r\n          marginsLegend = [doc.internal.pageSize.height - margins[2] - imageSize[1] - 15,\r\n          doc.internal.pageSize.width - margins[3] - imageSize[0], margins[2] + 15, margins[3] ];\r\n        } else if (legendPosition === 'topleft') {\r\n          marginsLegend = [margins[0], doc.internal.pageSize.width - margins[3] - imageSize[0],\r\n           doc.internal.pageSize.height - margins[0] - imageSize[1], margins[3] ];\r\n        }\r\n        this.addCanvas(doc, canvas, marginsLegend); // this adds the legend\r\n        div.parentNode.removeChild(div); // remove temp div (IE style)\r\n        await this.saveDoc(doc);\r\n      }\r\n    }\r\n\r\n  /**\r\n   * Add scale and attributions on the map on the document\r\n   * @param  doc - Pdf document where legend will be added\r\n   * @param  map - Map of the app\r\n   * @param  margins - Page margins\r\n   */\r\n  private async addScale(\r\n    doc: jspdf,\r\n    map: IgoMap,\r\n    margins: Array<number>\r\n    ) {\r\n      const mapSize = map.ol.getSize();\r\n      const extent = map.ol.getView().calculateExtent(mapSize);\r\n      // Get the scale and attribution\r\n      // we use cloneNode to modify the nodes to print without modifying it on the page, using deep:true to get children\r\n      let canvasOverlayHTML;\r\n      const mapOverlayHTML = map.ol.getOverlayContainerStopEvent();\r\n      // Remove the UI buttons from the nodes\r\n      const OverlayHTMLButtons = mapOverlayHTML.getElementsByTagName('button');\r\n      const OverlayHTMLButtonsarr = Array.from(OverlayHTMLButtons);\r\n      for (const OverlayHTMLButton of OverlayHTMLButtonsarr) {\r\n        OverlayHTMLButton.setAttribute('data-html2canvas-ignore', 'true');\r\n      }\r\n      // Change the styles of hyperlink in the printed version\r\n      // Transform the Overlay into a canvas\r\n      // scale is necessary to make it in google chrome\r\n      // background as null because otherwise it is white and cover the map\r\n      // allowtaint is to allow rendering images in the attributions\r\n      // useCORS: true pour permettre de renderer les images (ne marche pas en local)\r\n      const canvas = await html2canvas(mapOverlayHTML, {\r\n        scale: 1,\r\n        backgroundColor: null,\r\n        allowTaint: true,\r\n        useCORS: true,\r\n      }).then( e => {\r\n        canvasOverlayHTML = e;\r\n      });\r\n      this.addCanvas(doc, canvasOverlayHTML, margins); // this adds scales and attributions\r\n }\r\n\r\n  defineNbFileToProcess(nbFileToProcess) {\r\n    this.nbFileToProcess = nbFileToProcess;\r\n  }\r\n\r\n  private timeout(ms) {\r\n    return new Promise((resolve) => setTimeout(resolve, ms));\r\n  }\r\n\r\n  private addCanvas(\r\n    doc: jspdf,\r\n    canvas: HTMLCanvasElement,\r\n    margins: Array<number>\r\n  ) {\r\n    let image;\r\n    if (canvas) {\r\n      image = canvas.toDataURL('image/png');\r\n    }\r\n\r\n    if (image !== undefined) {\r\n      const imageSize = this.getImageSizeToFitPdf(doc, canvas, margins);\r\n      doc.addImage(\r\n        image,\r\n        'PNG',\r\n        margins[3],\r\n        margins[0],\r\n        imageSize[0],\r\n        imageSize[1]\r\n      );\r\n      doc.rect(margins[3], margins[0], imageSize[0], imageSize[1]);\r\n    }\r\n  }\r\n\r\n  // TODO fix printing with image resolution\r\n  private addMap(\r\n    doc: jspdf,\r\n    map: IgoMap,\r\n    resolution: number,\r\n    size: Array<number>,\r\n    margins: Array<number>\r\n  ) {\r\n    const status$ = new Subject();\r\n\r\n    const mapSize = map.ol.getSize();\r\n    const extent = map.ol.getView().calculateExtent(mapSize);\r\n\r\n    const widthPixels = Math.round((size[0] * resolution) / 25.4);\r\n    const heightPixels = Math.round((size[1] * resolution) / 25.4);\r\n\r\n    let timeout;\r\n\r\n    map.ol.once('rendercomplete', (event: any) => {\r\n      const canvases = event.target.getViewport().getElementsByTagName('canvas');\r\n      const mapStatus$$ = map.status$.subscribe((mapStatus: SubjectStatus) => {\r\n        clearTimeout(timeout);\r\n\r\n        if (mapStatus !== SubjectStatus.Done) {\r\n          return;\r\n        }\r\n\r\n        mapStatus$$.unsubscribe();\r\n\r\n        let status = SubjectStatus.Done;\r\n        try {\r\n          for (const canvas of canvases) {\r\n            if (canvas.width !== 0) {\r\n              this.addCanvas(doc, canvas, margins);\r\n            }\r\n          }\r\n        } catch (err) {\r\n          status = SubjectStatus.Error;\r\n          this.messageService.error(\r\n            this.languageService.translate.instant(\r\n              'igo.geo.printForm.corsErrorMessageBody'\r\n            ),\r\n            this.languageService.translate.instant(\r\n              'igo.geo.printForm.corsErrorMessageHeader'\r\n            )\r\n          );\r\n        }\r\n        this.renderMap(map, mapSize, extent);\r\n        status$.next(status);\r\n      });\r\n\r\n      // If no loading as started after 200ms, then probably no loading\r\n      // is required.\r\n      timeout = window.setTimeout(() => {\r\n        mapStatus$$.unsubscribe();\r\n\r\n        let status = SubjectStatus.Done;\r\n        try {\r\n          for (const canvas of canvases) {\r\n            if (canvas.width !== 0) {\r\n              this.addCanvas(doc, canvas, margins);\r\n            }\r\n          }\r\n        } catch (err) {\r\n          status = SubjectStatus.Error;\r\n          this.messageService.error(\r\n            this.languageService.translate.instant(\r\n              'igo.geo.printForm.corsErrorMessageBody'\r\n            ),\r\n            this.languageService.translate.instant(\r\n              'igo.geo.printForm.corsErrorMessageHeader'\r\n            )\r\n          );\r\n        }\r\n        this.renderMap(map, mapSize, extent);\r\n        status$.next(status);\r\n      }, 200);\r\n    });\r\n\r\n    this.renderMap(map, [widthPixels, heightPixels], extent);\r\n\r\n    return status$;\r\n  }\r\n\r\n  /**\r\n   * Download an image of the map with addition of informations\r\n   * @param  map - Map of the app\r\n   * @param  format - Image format. default value to \"png\"\r\n   * @param  projection - Indicate if projection need to be add. Default to false\r\n   * @param  scale - Indicate if scale need to be add. Default to false\r\n   * @param  legend - Indicate if the legend of layers need to be download. Default to false\r\n   * @param  title - Title to add for the map - Default to blank\r\n   * @param  subtitle - Subtitle to add for the map - Default to blank\r\n   * @param  comment - Comment to add for the map - Default to blank\r\n   * @param  doZipFile - Indicate if we do a zip with the file\r\n   * @return Image file of the map with extension format given as parameter\r\n   */\r\n  downloadMapImage(\r\n    map: IgoMap,\r\n    resolution: number,\r\n    format = 'png',\r\n    projection = false,\r\n    scale = false,\r\n    legend = false,\r\n    title = '',\r\n    subtitle = '',\r\n    comment = '',\r\n    doZipFile = true\r\n  ) {\r\n    const status$ = new Subject();\r\n    // const resolution = map.ol.getView().getResolution();\r\n    this.activityId = this.activityService.register();\r\n    const translate = this.languageService.translate;\r\n    map.ol.once('rendercomplete', (event: any) => {\r\n      format = format.toLowerCase();\r\n      const oldCanvas = event.target\r\n        .getViewport()\r\n        .getElementsByTagName('canvas')[0];\r\n      const newCanvas = document.createElement('canvas');\r\n      const newContext = newCanvas.getContext('2d');\r\n      // Postion in height to set the canvas in new canvas\r\n      let positionHCanvas = 0;\r\n      // Position in width to set the Proj/Scale in new canvas\r\n      let positionWProjScale = 10;\r\n      // Get height/width of map canvas\r\n      const width = oldCanvas.width;\r\n      let height = oldCanvas.height;\r\n      // Set Font to calculate comment width\r\n      newContext.font = '20px Calibri';\r\n      const commentWidth = newContext.measureText(comment).width;\r\n      // Add height for title if defined\r\n      height = title !== '' ? height + 30 : height;\r\n      // Add height for title if defined\r\n      height = subtitle !== '' ? height + 30 : height;\r\n      // Add height for projection or scale (same line) if defined\r\n      height = projection !== false || scale !== false ? height + 30 : height;\r\n      const positionHProjScale = height - 10;\r\n      // Define number of line depending of the comment length\r\n      const commentNbLine = Math.ceil(commentWidth / width);\r\n      // Add height for multiline comment if defined\r\n      height = comment !== '' ? height + commentNbLine * 30 : height;\r\n      let positionHComment = height - commentNbLine * 20 + 5;\r\n      // Set the new canvas with the new calculated size\r\n      newCanvas.width = width;\r\n      newCanvas.height = height;\r\n      // Patch Jpeg default black background to white\r\n      if (format === 'jpeg') {\r\n        newContext.fillStyle = '#ffffff';\r\n        newContext.fillRect(0, 0, width, height);\r\n        newContext.fillStyle = '#000000';\r\n      }\r\n      // If a title need to be added to canvas\r\n      if (title !== '') {\r\n        // Set font for title\r\n        // Adjust according to title length\r\n        newContext.font = '26px Calibri';\r\n        positionHCanvas = 30;\r\n        newContext.textAlign = 'center';\r\n        newContext.fillText(title, width / 2, 20, width * 0.9);\r\n      }\r\n      if (subtitle !== '') {\r\n        // Set font for subtitle\r\n        // Adjust according to title length\r\n        newContext.font = '26px Calibri';\r\n        positionHCanvas = 60;\r\n        newContext.textAlign = 'center';\r\n        newContext.fillText(subtitle, width / 2, 50, width * 0.9);\r\n      }\r\n      // Set font for next section\r\n      newContext.font = '20px Calibri';\r\n      // If projection need to be added to canvas\r\n      if (projection !== false) {\r\n        const projText = translate.instant('igo.geo.printForm.projection');\r\n        newContext.textAlign = 'start';\r\n        newContext.fillText(\r\n          projText + ': ' + map.projection,\r\n          positionWProjScale,\r\n          positionHProjScale\r\n        );\r\n        positionWProjScale += 200; // Width position change for scale position\r\n      }\r\n\r\n      // If scale need to be added to canvas\r\n      if (scale !== false) {\r\n        const scaleText = translate.instant('igo.geo.printForm.scale');\r\n        const mapScale = map.viewController.getScale(resolution);\r\n        newContext.textAlign = 'start';\r\n        newContext.fillText(\r\n          scaleText + ': ~ 1 / ' + formatScale(mapScale),\r\n          positionWProjScale,\r\n          positionHProjScale\r\n        );\r\n      }\r\n      // If a comment need to be added to canvas\r\n      if (comment !== '') {\r\n        newContext.textAlign = 'center';\r\n        // If only one line, no need to multiline the comment\r\n        if (commentNbLine === 1) {\r\n          newContext.fillText(comment, width / 2, positionHComment);\r\n        } else {\r\n          // Separate the setenses to be approx. the same length\r\n          const nbCommentChar = comment.length;\r\n          const CommentLengthToCut = Math.floor(nbCommentChar / commentNbLine);\r\n          let commentCurrentLine = '';\r\n          let positionFirstCutChar = 0;\r\n          let positionLastBlank;\r\n          // Loop for the number of line calculated\r\n          for (let i = 0; i < commentNbLine; i++) {\r\n            // For all line except last\r\n            if (commentNbLine - 1 > i) {\r\n              // Get comment current line to find the right place tu cut comment\r\n              commentCurrentLine = comment.substr(\r\n                positionFirstCutChar,\r\n                CommentLengthToCut\r\n              );\r\n              // Cut the setence at blank\r\n              positionLastBlank = commentCurrentLine.lastIndexOf(' ');\r\n              newContext.fillText(\r\n                commentCurrentLine.substr(0, positionLastBlank),\r\n                width / 2,\r\n                positionHComment\r\n              );\r\n              positionFirstCutChar += positionLastBlank;\r\n              // Go to next line for insertion\r\n              positionHComment += 20;\r\n            } else {\r\n              // Don't cut last part\r\n              newContext.fillText(\r\n                comment.substr(positionFirstCutChar),\r\n                width / 2,\r\n                positionHComment\r\n              );\r\n            }\r\n          }\r\n        }\r\n      }\r\n      // Add map to new canvas\r\n      newContext.drawImage(oldCanvas, 0, positionHCanvas);\r\n\r\n      let status = SubjectStatus.Done;\r\n      let fileNameWithExt = 'map.' + format;\r\n      if (format.toLowerCase() === 'tiff') {\r\n        fileNameWithExt = 'map' + map.projection.replace(':', '_') + '.' + format;\r\n      }\r\n\r\n      try {\r\n        // Save the canvas as file\r\n        if (!doZipFile) {\r\n          this.saveCanvasImageAsFile(newCanvas, fileNameWithExt, format);\r\n        } else if (format.toLowerCase() === 'tiff') {\r\n          // Add the canvas to zip\r\n          this.generateCanvaFileToZip(newCanvas, fileNameWithExt);\r\n        } else {\r\n          // Add the canvas to zip\r\n          this.generateCanvaFileToZip(newCanvas, fileNameWithExt);\r\n        }\r\n      } catch (err) {\r\n        status = SubjectStatus.Error;\r\n      }\r\n\r\n      status$.next(status);\r\n\r\n      if (format.toLowerCase() === 'tiff') {\r\n        const tfwFileNameWithExt = fileNameWithExt.substring(0, fileNameWithExt.toLowerCase().indexOf('.tiff')) + '.tfw';\r\n        const tiwContent = this.getWorldFileInformation(map);\r\n        const blob = new Blob([tiwContent], {\r\n          type: 'text/plain;charset=utf-8'\r\n        });\r\n        if (!doZipFile) {\r\n          // saveAs automaticly replace ':' for '_'\r\n          saveAs(blob, tfwFileNameWithExt);\r\n          this.saveFileProcessing();\r\n        } else {\r\n          // Add the canvas to zip\r\n          this.addFileToZip(tfwFileNameWithExt,blob);\r\n        }\r\n      }\r\n    });\r\n    map.ol.renderSync();\r\n\r\n    return status$;\r\n  }\r\n\r\n  private renderMap(map, size, extent) {\r\n    map.ol.updateSize();\r\n    map.ol.renderSync();\r\n  }\r\n\r\n  /**\r\n   * Save document\r\n   * @param  doc - Document to save\r\n   */\r\n  protected async saveDoc(doc: jspdf) {\r\n    await doc.save('map.pdf', { returnPromise: true });\r\n  }\r\n\r\n  /**\r\n   * Calculate the best Image size to fit in pdf\r\n   * @param doc - Pdf Document\r\n   * @param canvas - Canvas of image\r\n   * @param margins - Page margins\r\n   */\r\n  private getImageSizeToFitPdf(doc, canvas, margins) {\r\n    // Define variable to calculate best size to fit in one page\r\n    const pageHeight =\r\n      doc.internal.pageSize.getHeight() - (margins[0] + margins[2]);\r\n    const pageWidth =\r\n      doc.internal.pageSize.getWidth() - (margins[1] + margins[3]);\r\n    const canHeight = canvas.height;\r\n    const canWidth = canvas.width;\r\n    const heightRatio = canHeight / pageHeight;\r\n    const widthRatio = canWidth / pageWidth;\r\n    const maxRatio = heightRatio > widthRatio ? heightRatio : widthRatio;\r\n    const imgHeigh = maxRatio > 1 ? canHeight / maxRatio : canHeight;\r\n    const imgWidth = maxRatio > 1 ? canWidth / maxRatio : canWidth;\r\n\r\n    return [imgWidth, imgHeigh];\r\n  }\r\n\r\n  /**\r\n   * Get a world file information for tiff\r\n   * @param  map - Map of the app\r\n   */\r\n  private getWorldFileInformation(map) {\r\n    const currentResolution = map.viewController.getResolution();\r\n    const currentExtent = map.viewController.getExtent(); // Return [minx, miny, maxx, maxy]\r\n    return [\r\n      currentResolution,\r\n      0,\r\n      0,\r\n      -currentResolution,\r\n      currentExtent[0] + currentResolution / 0.5,\r\n      currentExtent[3] - currentResolution / 0.5\r\n    ].join('\\n');\r\n  }\r\n\r\n  /**\r\n   * Save canvas image as file\r\n   * @param canvas - Canvas to save\r\n   * @param name - Name of the file\r\n   * @param format - file format\r\n   */\r\n  private saveCanvasImageAsFile(canvas, nameWithExt, format) {\r\n    const blobFormat = 'image/' + format;\r\n    const that = this;\r\n\r\n    try {\r\n      canvas.toDataURL(); // Just to make the catch trigger wihtout toBlob Error throw not catched\r\n      // If navigator is Internet Explorer\r\n      if (navigator.msSaveBlob) {\r\n        navigator.msSaveBlob(canvas.msToBlob(), nameWithExt);\r\n        this.saveFileProcessing();\r\n      } else {\r\n        canvas.toBlob((blob) => {\r\n          // download image\r\n          saveAs(blob, nameWithExt);\r\n          that.saveFileProcessing();\r\n        }, blobFormat);\r\n      }\r\n    } catch (err) {\r\n      this.messageService.error(\r\n        this.languageService.translate.instant(\r\n          'igo.geo.printForm.corsErrorMessageBody'\r\n        ),\r\n        this.languageService.translate.instant(\r\n          'igo.geo.printForm.corsErrorMessageHeader'\r\n        )\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add file to a zip\r\n   * @param canvas - File to add to the zip\r\n   * @param  name -Name of the fileoverview\r\n   */\r\n  private generateCanvaFileToZip(canvas, name) {\r\n    const blobFormat = 'image/' + 'jpeg';\r\n    const that = this;\r\n    if (\r\n      !this.hasOwnProperty('zipFile') ||\r\n      typeof this.zipFile === 'undefined'\r\n    ) {\r\n      this.zipFile = new JSZip();\r\n    }\r\n\r\n    try {\r\n      canvas.toDataURL(); // Just to make the catch trigger wihtout toBlob Error throw not catched\r\n      if (navigator.msSaveBlob) {\r\n        this.addFileToZip(name, canvas.msToBlob());\r\n      } else {\r\n        canvas.toBlob((blob) => {\r\n          that.addFileToZip(name, blob);\r\n        }, blobFormat);\r\n      }\r\n    } catch (err) {\r\n      this.messageService.error(\r\n        this.languageService.translate.instant(\r\n          'igo.geo.printForm.corsErrorMessageBody'\r\n        ),\r\n        this.languageService.translate.instant(\r\n          'igo.geo.printForm.corsErrorMessageHeader'\r\n        )\r\n      );\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Add file to zip, if all file are zipped, download\r\n   * @param name - Name of the files\r\n   * @param blob - Contain of file\r\n   */\r\n  private addFileToZip(name, blob) {\r\n    // add file to zip\r\n    this.zipFile.file(name, blob);\r\n    this.nbFileToProcess--;\r\n\r\n    // If all files are proccessed\r\n    if (this.nbFileToProcess === 0) {\r\n      // Download zip file\r\n      this.getZipFile();\r\n      // Stop loading\r\n      this.activityService.unregister(this.activityId);\r\n    }\r\n  }\r\n\r\n  private saveFileProcessing() {\r\n    this.nbFileToProcess--;\r\n\r\n    // If all files are proccessed\r\n    if (this.nbFileToProcess === 0) {\r\n      // Stop loading\r\n      this.activityService.unregister(this.activityId);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get the zipped file\r\n   * @return Retun a zip file\r\n   */\r\n  private getZipFile() {\r\n    const that = this;\r\n    this.zipFile.generateAsync({ type: 'blob' }).then((blob) => {\r\n      // 1) generate the zip file\r\n      saveAs(blob, 'map.zip');\r\n      delete that.zipFile;\r\n    });\r\n  }\r\n}\r\n","import { Layer } from '../shared/layers/layer';\r\nimport { LegendMapViewOptions, OutputLayerLegend } from '../shared/layers/layer.interface';\r\n\r\n/**\r\n * Get all the layers legend\r\n * @return Array of legend\r\n */\r\nexport function getLayersLegends(layers: Layer[], view?: LegendMapViewOptions): OutputLayerLegend[] {\r\n  const legends = [];\r\n\r\n  for (const layer of layers) {\r\n    const legendOptions = layer.options.legendOptions;\r\n    if (layer.visible === false) { continue; }\r\n\r\n    const legendUrls = layer.dataSource.getLegend(undefined, view) || [];\r\n    for (const legendUrl of legendUrls) {\r\n      if (legendUrl.url === undefined) { continue; }\r\n\r\n      // Add legend info to the list\r\n      legends.push({\r\n        title: layer.title || '',\r\n        url: legendUrl.url,\r\n        display: legendOptions?.display === undefined ? true : legendOptions.display\r\n      });\r\n    }\r\n  }\r\n\r\n  return legends;\r\n}\r\n","import { strEnum } from '@igo2/utils';\r\n\r\nexport const PrintOutputFormat = strEnum(['Pdf', 'Image']);\r\n\r\nexport type PrintOutputFormat = keyof typeof PrintOutputFormat;\r\n\r\nexport const PrintPaperFormat = strEnum([\r\n  'A0',\r\n  'A1',\r\n  'A2',\r\n  'A3',\r\n  'A4',\r\n  'A5',\r\n  'Letter',\r\n  'Legal'\r\n]);\r\nexport type PrintPaperFormat = keyof typeof PrintPaperFormat;\r\n\r\nexport const PrintOrientation = strEnum(['landscape', 'portrait']);\r\nexport type PrintOrientation = keyof typeof PrintOrientation;\r\n\r\nexport const PrintResolution = strEnum(['72', '96', '150', '300']);\r\nexport type PrintResolution = keyof typeof PrintResolution;\r\n\r\nexport const PrintSaveImageFormat = strEnum([\r\n  'Bmp',\r\n  'Gif',\r\n  'Jpeg',\r\n  'Png',\r\n  'Tiff'\r\n]);\r\nexport type PrintSaveImageFormat = keyof typeof PrintSaveImageFormat;\r\n\r\nexport const PrintLegendPosition = strEnum([\r\n  'none',\r\n  'topright',\r\n  'topleft',\r\n  'bottomleft',\r\n  'bottomright',\r\n  'newpage'\r\n]);\r\nexport type PrintLegendPosition = keyof typeof PrintLegendPosition;\r\n","<form class=\"igo-form\" [formGroup]=\"form\">\r\n  <div class=\"igo-input-container\">\r\n    <mat-form-field>\r\n      <input\r\n        matInput\r\n        formControlName=\"title\"\r\n        placeholder=\"{{'igo.geo.printForm.title' | translate}}\">\r\n    </mat-form-field>\r\n  </div>\r\n  <div class=\"igo-input-container\">\r\n    <mat-form-field>\r\n      <input\r\n        matInput\r\n        formControlName=\"subtitle\"\r\n        placeholder=\"{{'igo.geo.printForm.subtitle' | translate}}\">\r\n    </mat-form-field>\r\n  </div>\r\n  <div class=\"igo-input-container\">\r\n    <mat-form-field>\r\n      <input\r\n        matInput\r\n        formControlName=\"comment\"\r\n        placeholder=\"{{'igo.geo.printForm.comment' | translate}}\">\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\">\r\n    <div class=\"print-slide-toggle-container mat-typography\">\r\n      <mat-slide-toggle\r\n        class=\"print-option\"\r\n        formControlName=\"showProjection\"\r\n        [labelPosition]=\"'before'\">\r\n        {{'igo.geo.printForm.showProjection' | translate}}\r\n      </mat-slide-toggle>\r\n      <mat-slide-toggle\r\n        class=\"print-option\"\r\n        formControlName=\"showScale\"\r\n        [labelPosition]=\"'before'\">\r\n        {{'igo.geo.printForm.showScale' | translate}}\r\n      </mat-slide-toggle>\r\n      <mat-slide-toggle\r\n        class=\"print-option\"\r\n        formControlName=\"doZipFile\"\r\n        [labelPosition]=\"'before'\"\r\n        [style.display]=\"isPrintService ? 'none' : ''\">\r\n        {{'igo.geo.printForm.doZipFile' | translate}}\r\n      </mat-slide-toggle>\r\n    </div>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\">\r\n    <mat-form-field>\r\n      <mat-select\r\n        formControlName=\"legendPosition\"\r\n        placeholder=\"{{'igo.geo.printForm.legendPosition' | translate}}\">\r\n        <mat-option *ngFor=\"let legendPosition of legendPositions | keyvalue \" [value]=\"legendPosition.key\">\r\n            {{'igo.geo.printForm.legendPositions.' + legendPosition.value | translate}}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\">\r\n    <mat-form-field>\r\n      <mat-select (selectionChange)=\"toggleImageSaveProp()\"\r\n        formControlName=\"outputFormat\"\r\n        placeholder=\"{{'igo.geo.printForm.outputFormat' | translate}}\">\r\n        <mat-option *ngFor=\"let outputFormat of outputFormats | keyvalue \" [value]=\"outputFormat.key\">\r\n            {{outputFormat.value}}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\" [style.display]=\"isPrintService ? 'block' : 'none'\">\r\n    <mat-form-field>\r\n      <mat-select\r\n        formControlName=\"paperFormat\"\r\n        placeholder=\"{{'igo.geo.printForm.paperFormat' | translate}}\">\r\n        <mat-option *ngFor=\"let paperFormat of paperFormats | keyvalue \" [value]=\"paperFormat.key\">\r\n          {{('igo.geo.printForm.paperFormats.' + paperFormat.value) | translate}}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\" [style.display]=\"isPrintService ? 'none' : 'block'\">\r\n    <mat-form-field>\r\n      <mat-select\r\n        formControlName=\"imageFormat\"\r\n        placeholder=\"{{'igo.geo.printForm.imageFormat' | translate}}\">\r\n        <mat-option *ngFor=\"let imageFormat of imageFormats | keyvalue \" [value]=\"imageFormat.key\">\r\n          {{imageFormat.value}}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\" style=\"display: none;\">\r\n    <mat-form-field>\r\n      <mat-select\r\n        formControlName=\"resolution\"\r\n        placeholder=\"{{'igo.geo.printForm.resolution' | translate}}\">\r\n        <mat-option *ngFor=\"let resolution of resolutions | keyvalue \" [value]=\"resolution.key\">\r\n          {{resolution.value + ' PPI'}}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-input-container\" [style.display]=\"isPrintService ? 'block' : 'none'\">\r\n    <mat-form-field>\r\n      <mat-select\r\n        formControlName=\"orientation\"\r\n        placeholder=\"{{'igo.geo.printForm.orientation' | translate}}\">\r\n        <mat-option *ngFor=\"let orientation of orientations | keyvalue \" [value]=\"orientation.key\">\r\n          {{('igo.geo.printForm.' + orientation.value) | translate}}\r\n        </mat-option>\r\n      </mat-select>\r\n    </mat-form-field>\r\n  </div>\r\n\r\n  <div class=\"igo-form-button-group print-button-top-padding\">\r\n    <button\r\n      mat-raised-button\r\n      type=\"button\"\r\n      [disabled]=\"!form.valid || (disabled$ | async)\"\r\n      (click)=\"handleFormSubmit(form.value, form.valid)\">\r\n      {{'igo.geo.printForm.saveBtn' | translate}}\r\n    </button>\r\n  </div>\r\n\r\n</form>\r\n","import { Component, Input, Output, EventEmitter, OnInit } from '@angular/core';\r\nimport {\r\n  FormGroup,\r\n  FormBuilder,\r\n  FormControl,\r\n  Validators\r\n} from '@angular/forms';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { PrintOptions } from '../shared/print.interface';\r\n\r\nimport {\r\n  PrintOutputFormat,\r\n  PrintPaperFormat,\r\n  PrintOrientation,\r\n  PrintResolution,\r\n  PrintSaveImageFormat,\r\n  PrintLegendPosition\r\n} from '../shared/print.type';\r\n\r\n@Component({\r\n  selector: 'igo-print-form',\r\n  templateUrl: './print-form.component.html',\r\n  styleUrls: ['./print-form.component.scss']\r\n})\r\nexport class PrintFormComponent implements OnInit {\r\n  public form: FormGroup;\r\n  public outputFormats = PrintOutputFormat;\r\n  public paperFormats = PrintPaperFormat;\r\n  public orientations = PrintOrientation;\r\n  public resolutions = PrintResolution;\r\n  public imageFormats = PrintSaveImageFormat;\r\n  public legendPositions = PrintLegendPosition;\r\n  public isPrintService = true;\r\n\r\n  @Input() disabled$: BehaviorSubject<boolean>;\r\n\r\n  @Input()\r\n  get imageFormat(): PrintSaveImageFormat {\r\n    return this.imageFormatField.value;\r\n  }\r\n  set imageFormat(value: PrintSaveImageFormat) {\r\n    this.imageFormatField.setValue(value || PrintSaveImageFormat.Jpeg, {\r\n      onlySelf: true\r\n    });\r\n  }\r\n\r\n  @Input()\r\n  get outputFormat(): PrintOutputFormat {\r\n    return this.outputFormatField.value;\r\n  }\r\n  set outputFormat(value: PrintOutputFormat) {\r\n    this.outputFormatField.setValue(value || PrintOutputFormat.Pdf, {\r\n      onlySelf: true\r\n    });\r\n  }\r\n\r\n  @Input()\r\n  get paperFormat(): PrintPaperFormat {\r\n    return this.paperFormatField.value;\r\n  }\r\n  set paperFormat(value: PrintPaperFormat) {\r\n    this.paperFormatField.setValue(value || PrintPaperFormat.Letter, {\r\n      onlySelf: true\r\n    });\r\n  }\r\n\r\n  @Input()\r\n  get orientation(): PrintOrientation {\r\n    return this.orientationField.value;\r\n  }\r\n  set orientation(value: PrintOrientation) {\r\n    this.orientationField.setValue(value || PrintOrientation.landscape, {\r\n      onlySelf: true\r\n    });\r\n  }\r\n\r\n  @Input()\r\n  get resolution(): PrintResolution {\r\n    return this.resolutionField.value;\r\n  }\r\n  set resolution(value: PrintResolution) {\r\n    this.resolutionField.setValue(value || PrintResolution['96'], {\r\n      onlySelf: true\r\n    });\r\n  }\r\n\r\n  @Input()\r\n  get legendPosition(): PrintLegendPosition {\r\n    return this.legendPositionField.value;\r\n  }\r\n  set legendPosition(value: PrintLegendPosition) {\r\n    this.legendPositionField.setValue(value || PrintLegendPosition.none, {\r\n      onlySelf: true\r\n    });\r\n  }\r\n\r\n  @Input()\r\n  get title(): string {\r\n    return this.titleField.value;\r\n  }\r\n  set title(value: string) {\r\n    this.titleField.setValue(value, { onlySelf: true });\r\n  }\r\n  @Input()\r\n  get subtitle(): string {\r\n    return this.subtitleField.value;\r\n  }\r\n  set subtitle(value: string) {\r\n    this.subtitleField.setValue(value, { onlySelf: true });\r\n  }\r\n  @Input()\r\n  get comment(): string {\r\n    return this.commentField.value;\r\n  }\r\n  set comment(value: string) {\r\n    this.commentField.setValue(value, { onlySelf: true });\r\n  }\r\n  @Input()\r\n  get showProjection(): boolean {\r\n    return this.showProjectionField.value;\r\n  }\r\n  set showProjection(value: boolean) {\r\n    this.showProjectionField.setValue(value, { onlySelf: true });\r\n  }\r\n  @Input()\r\n  get showScale(): boolean {\r\n    return this.showScaleField.value;\r\n  }\r\n  set showScale(value: boolean) {\r\n    this.showScaleField.setValue(value, { onlySelf: true });\r\n  }\r\n  @Input()\r\n  get showLegend(): boolean {\r\n    return this.showLegendField.value;\r\n  }\r\n  set showLegend(value: boolean) {\r\n    this.showLegendField.setValue(value, { onlySelf: true });\r\n  }\r\n\r\n  @Input()\r\n  get doZipFile(): boolean {\r\n    return this.doZipFileField.value;\r\n  }\r\n  set doZipFile(value: boolean) {\r\n    this.doZipFileField.setValue(value, { onlySelf: true });\r\n  }\r\n\r\n  get outputFormatField() {\r\n    return (this.form.controls as any).outputFormat as FormControl;\r\n  }\r\n\r\n  get paperFormatField() {\r\n    return (this.form.controls as any).paperFormat as FormControl;\r\n  }\r\n\r\n  get imageFormatField() {\r\n    return (this.form.controls as any).imageFormat as FormControl;\r\n  }\r\n\r\n  get orientationField() {\r\n    return (this.form.controls as any).orientation as FormControl;\r\n  }\r\n\r\n  get resolutionField() {\r\n    return (this.form.controls as any).resolution as FormControl;\r\n  }\r\n\r\n  get commentField() {\r\n    return (this.form.controls as any).comment as FormControl;\r\n  }\r\n\r\n  get showProjectionField() {\r\n    return (this.form.controls as any).showProjection as FormControl;\r\n  }\r\n\r\n  get showScaleField() {\r\n    return (this.form.controls as any).showScale as FormControl;\r\n  }\r\n\r\n  get showLegendField() {\r\n    return (this.form.controls as any).showLegend as FormControl;\r\n  }\r\n\r\n  get doZipFileField() {\r\n    return (this.form.controls as any).doZipFile as FormControl;\r\n  }\r\n\r\n  get titleField() {\r\n    return (this.form.controls as any).title as FormControl;\r\n  }\r\n\r\n  get subtitleField() {\r\n    return (this.form.controls as any).subtitle as FormControl;\r\n  }\r\n\r\n  get legendPositionField() {\r\n    return (this.form.controls as any).legendPosition as FormControl;\r\n  }\r\n\r\n  @Output() submit: EventEmitter<PrintOptions> = new EventEmitter();\r\n\r\n  constructor(private formBuilder: FormBuilder) {\r\n    this.form = this.formBuilder.group({\r\n      title: ['', []],\r\n      subtitle: ['', []],\r\n      comment: ['', []],\r\n      outputFormat: ['', [Validators.required]],\r\n      paperFormat: ['', [Validators.required]],\r\n      imageFormat: [ '', [Validators.required]],\r\n      resolution: ['', [Validators.required]],\r\n      orientation: ['', [Validators.required]],\r\n      legendPosition: ['', [Validators.required]],\r\n      showProjection: false,\r\n      showScale: false,\r\n      showLegend: false,\r\n      doZipFile: [{hidden: this.isPrintService }]\r\n    });\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.doZipFileField.setValue(false);\r\n  }\r\n\r\n  handleFormSubmit(data: PrintOptions, isValid: boolean) {\r\n    data.isPrintService = this.isPrintService;\r\n    if (isValid) {\r\n      this.submit.emit(data);\r\n    }\r\n  }\r\n\r\n  toggleImageSaveProp() {\r\n    if (this.outputFormatField.value === 'Image') {\r\n      this.isPrintService = false;\r\n    } else {\r\n      this.isPrintService = true;\r\n    }\r\n  }\r\n}\r\n","import { Component, Input } from '@angular/core';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport { take } from 'rxjs/operators';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { PrintOptions } from '../shared/print.interface';\r\n\r\nimport {\r\n  PrintOutputFormat,\r\n  PrintPaperFormat,\r\n  PrintOrientation,\r\n  PrintResolution,\r\n  PrintSaveImageFormat,\r\n  PrintLegendPosition\r\n} from '../shared/print.type';\r\n\r\nimport { PrintService } from '../shared/print.service';\r\n\r\n@Component({\r\n  selector: 'igo-print',\r\n  templateUrl: './print.component.html'\r\n})\r\nexport class PrintComponent {\r\n  public disabled$ = new BehaviorSubject(false);\r\n\r\n  @Input()\r\n  get map(): IgoMap {\r\n    return this._map;\r\n  }\r\n  set map(value: IgoMap) {\r\n    this._map = value;\r\n  }\r\n  private _map: IgoMap;\r\n\r\n  @Input()\r\n  get outputFormat(): PrintOutputFormat {\r\n    return this._outputFormat;\r\n  }\r\n  set outputFormat(value: PrintOutputFormat) {\r\n    this._outputFormat = value;\r\n  }\r\n  private _outputFormat: PrintOutputFormat;\r\n\r\n  @Input()\r\n  get paperFormat(): PrintPaperFormat {\r\n    return this._paperFormat;\r\n  }\r\n  set paperFormat(value: PrintPaperFormat) {\r\n    this._paperFormat = value;\r\n  }\r\n  private _paperFormat: PrintPaperFormat;\r\n\r\n  @Input()\r\n  get orientation(): PrintOrientation {\r\n    return this._orientation;\r\n  }\r\n  set orientation(value: PrintOrientation) {\r\n    this._orientation = value;\r\n  }\r\n  private _orientation: PrintOrientation;\r\n\r\n  @Input()\r\n  get imageFormat(): PrintSaveImageFormat {\r\n    return this._imageFormat;\r\n  }\r\n  set imageFormat(value: PrintSaveImageFormat) {\r\n    this._imageFormat = value;\r\n  }\r\n  private _imageFormat: PrintSaveImageFormat;\r\n\r\n  @Input()\r\n  get legendPosition(): PrintLegendPosition {\r\n    return this._legendPosition;\r\n  }\r\n  set legendPosition(value: PrintLegendPosition) {\r\n    this._legendPosition = value;\r\n  }\r\n  private _legendPosition: PrintLegendPosition;\r\n\r\n  @Input()\r\n  get resolution(): PrintResolution {\r\n    return this._resolution;\r\n  }\r\n  set resolution(value: PrintResolution) {\r\n    this._resolution = value;\r\n  }\r\n  private _resolution: PrintResolution;\r\n\r\n  constructor(private printService: PrintService) {}\r\n\r\n  handleFormSubmit(data: PrintOptions) {\r\n\r\n    this.disabled$.next(true);\r\n\r\n    if (data.isPrintService === true) {\r\n      this.printService\r\n        .print(this.map, data)\r\n        .pipe(take(1))\r\n        .subscribe(() => {\r\n          this.disabled$.next(false);\r\n        });\r\n    } else {\r\n      let nbFileToProcess = 1;\r\n\r\n      if (data.showLegend) {\r\n        nbFileToProcess++;\r\n      }\r\n      if (data.imageFormat.toLowerCase() === 'tiff') {\r\n        nbFileToProcess++;\r\n      }\r\n\r\n      this.printService.defineNbFileToProcess(nbFileToProcess);\r\n\r\n      const resolution = +data.resolution;\r\n\r\n      let nbRequests = data.showLegend ? 2 : 1;\r\n      this.printService\r\n        .downloadMapImage(\r\n          this.map,\r\n          resolution,\r\n          data.imageFormat,\r\n          data.showProjection,\r\n          data.showScale,\r\n          data.showLegend,\r\n          data.title,\r\n          data.subtitle,\r\n          data.comment,\r\n          data.doZipFile\r\n        )\r\n        .pipe(take(1))\r\n        .subscribe(() => {\r\n          nbRequests--;\r\n          if (!nbRequests) {\r\n            this.disabled$.next(false);\r\n          }\r\n        });\r\n      if (data.showLegend) {\r\n        this.printService\r\n          .getLayersLegendImage(\r\n            this.map,\r\n            data.imageFormat,\r\n            data.doZipFile,\r\n            +resolution\r\n          )\r\n          .then(() => {\r\n            nbRequests--;\r\n            if (!nbRequests) {\r\n              this.disabled$.next(false);\r\n            }\r\n          });\r\n      }\r\n    }\r\n  }\r\n}\r\n","<igo-print-form\r\n  [outputFormat]=\"outputFormat\"\r\n  [paperFormat]=\"paperFormat\"\r\n  [orientation]=\"orientation\"\r\n  [imageFormat]=\"imageFormat\"\r\n  [resolution]=\"resolution\"\r\n  [legendPosition]=\"legendPosition\"\r\n  [disabled$]=\"disabled$\"\r\n  (submit)=\"handleFormSubmit($event)\">\r\n</igo-print-form>\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatOptionModule } from '@angular/material/core';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatSlideToggleModule } from '@angular/material/slide-toggle';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoKeyValueModule } from '@igo2/common';\r\n\r\nimport { PrintComponent } from './print/print.component';\r\nimport { PrintFormComponent } from './print-form/print-form.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatSelectModule,\r\n    MatOptionModule,\r\n    MatInputModule,\r\n    MatFormFieldModule,\r\n    MatSlideToggleModule,\r\n    IgoLanguageModule,\r\n    IgoKeyValueModule\r\n  ],\r\n  exports: [PrintComponent, PrintFormComponent],\r\n  declarations: [PrintComponent, PrintFormComponent]\r\n})\r\nexport class IgoPrintModule {}\r\n","import { ConfigService } from '@igo2/core';\r\n\r\nimport { SearchSource } from '../../search/shared/sources/source';\r\n\r\nimport { QuerySearchSource } from './query-search-source';\r\n\r\n/**\r\n * Map search source factory\r\n * @ignore\r\n */\r\nexport function querySearchSourceFactory(config: ConfigService) {\r\n  return new QuerySearchSource(\r\n    config.getConfig(`searchSources.${QuerySearchSource.id}`) || {}\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the map search source\r\n */\r\nexport function provideQuerySearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: querySearchSourceFactory,\r\n    multi: true,\r\n    deps: [ConfigService]\r\n  };\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { IgoLanguageModule, IgoMessageModule } from '@igo2/core';\r\n\r\nimport { QueryDirective } from './shared/query.directive';\r\nimport { QueryService } from './shared/query.service';\r\nimport { provideQuerySearchSource } from './shared/query-search-source.providers';\r\n\r\n@NgModule({\r\n  imports: [CommonModule, IgoLanguageModule, IgoMessageModule],\r\n  exports: [QueryDirective],\r\n  declarations: [QueryDirective],\r\n  providers: [QueryService]\r\n})\r\nexport class IgoQueryModule {\r\n  static forRoot(): ModuleWithProviders<IgoQueryModule> {\r\n    return {\r\n      ngModule: IgoQueryModule,\r\n      providers: [provideQuerySearchSource()]\r\n    };\r\n  }\r\n}\r\n","import { DirectionsSource } from '../directions-sources/directions-source';\r\n\r\nexport class DirectionsSourceService {\r\n  constructor(public sources: DirectionsSource[]) {}\r\n}\r\n\r\nexport function directionsSourceServiceFactory(sources: DirectionsSource[]) {\r\n  return new DirectionsSourceService(sources);\r\n}\r\n\r\nexport function provideDirectionsSourceService() {\r\n  return {\r\n    provide: DirectionsSourceService,\r\n    useFactory: directionsSourceServiceFactory,\r\n    deps: [DirectionsSource]\r\n  };\r\n}\r\n","export enum DirectionsFormat {\r\n  GeoJSON,\r\n  JSON\r\n}\r\nexport enum SourceDirectionsType {\r\n  Route = 'route',\r\n  Trip = 'trip'\r\n}\r\n\r\nexport enum ProposalType {\r\n  Coord = 'coord',\r\n  Text = 'text'\r\n}\r\n\r\nexport enum DirectionType {\r\n  Stop = 'stop',\r\n  Route = 'route',\r\n  Vertex = 'vertex'\r\n}\r\n\r\nexport enum DirectionRelativePositionType {\r\n  Start = 'start',\r\n  Intermediate = 'intermediate',\r\n  End = 'end'\r\n}\r\n","import olFeature from 'ol/Feature';\r\nimport * as olStyle from 'ol/style';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport * as olGeom from 'ol/geom';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport * as olProj from 'ol/proj';\r\n\r\nimport { uuid, NumberUtils } from '@igo2/utils';\r\n\r\nimport { Direction, FeatureWithDirection, FeatureWithStop, Stop } from './directions.interface';\r\nimport { createOverlayMarkerStyle } from '../../overlay/shared/overlay-marker-style.utils';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { tryBindStoreLayer } from '../../feature/shared/feature.utils';\r\nimport { tryAddLoadingStrategy } from '../../feature/shared/strategies.utils';\r\nimport { FeatureStoreLoadingStrategy } from '../../feature/shared/strategies/loading';\r\nimport { FEATURE, FeatureMotion } from '../../feature/shared/feature.enums';\r\nimport { LanguageService } from '@igo2/core';\r\nimport { FeatureGeometry } from '../../feature/shared/feature.interfaces';\r\nimport { DirectionRelativePositionType, DirectionType } from './directions.enum';\r\nimport { RoutesFeatureStore, StepFeatureStore, StopsFeatureStore, StopsStore } from './store';\r\n\r\n/**\r\n * Function that updat the sort of the list base on the provided field.\r\n * @param source stop store\r\n * @param direction asc / desc sort order\r\n * @param field the field to use to sort the view\r\n */\r\nexport function updateStoreSorting(stopsStore: StopsStore, direction: 'asc' | 'desc' = 'asc', field = 'position') {\r\n  stopsStore.view.sort({\r\n    direction,\r\n    valueAccessor: (entity: Stop) => entity[field]\r\n  });\r\n}\r\n\r\nexport function computeRelativePosition(index: number, totalLength): DirectionRelativePositionType {\r\n  let relativePosition = DirectionRelativePositionType.Intermediate;\r\n  if (index === 0) {\r\n    relativePosition = DirectionRelativePositionType.Start;\r\n  } else if (index === totalLength - 1) {\r\n    relativePosition = DirectionRelativePositionType.End;\r\n  }\r\n  return relativePosition;\r\n}\r\n\r\nexport function computeStopsPosition(stopsStore: StopsStore) {\r\n\r\n  const stopsToComputePosition = [...stopsStore.all()];\r\n  stopsToComputePosition.sort((a, b) => a.position - b.position);\r\n  stopsToComputePosition.map((stop, i) => {\r\n    stop.position = i;\r\n    stop.relativePosition = computeRelativePosition(stop.position, stopsToComputePosition.length);\r\n  });\r\n  if (stopsToComputePosition) {\r\n    stopsStore.updateMany(stopsToComputePosition);\r\n  }\r\n}\r\n\r\n/**\r\n * Function that add a stop to the stop store. Stop are always added before the last stop.\r\n * @param stopsStore stop store as an EntityStore\r\n */\r\nexport function addStopToStore(stopsStore: StopsStore): Stop {\r\n\r\n  const id = uuid();\r\n  const stops = stopsStore.all();\r\n  let positions: number[];\r\n  if (stopsStore.count === 0) {\r\n    positions = [0];\r\n  } else {\r\n    positions = stops.map(stop => stop.position);\r\n  }\r\n  const maxPosition: number = Math.max(...positions);\r\n  const insertPosition: number = maxPosition;\r\n  const lastPosition: number = maxPosition + 1;\r\n\r\n  const stopToUpdate = stopsStore.all().find(stop => stop.position === maxPosition);\r\n  if (stopToUpdate) {\r\n    stopToUpdate.position = lastPosition;\r\n    stopToUpdate.relativePosition = computeRelativePosition(lastPosition, stopsStore.count + 1);\r\n  }\r\n\r\n  stopsStore.insert({ id, position: insertPosition, relativePosition: computeRelativePosition(insertPosition, stopsStore.count + 1) });\r\n\r\n  updateStoreSorting(stopsStore);\r\n  return stopsStore.get(id);\r\n}\r\n\r\nexport function removeStopFromStore(stopsStore: StopsStore, stop: Stop) {\r\n  stopsStore.delete(stop);\r\n  computeStopsPosition(stopsStore);\r\n}\r\n\r\n/**\r\n * Create a style for the directions stops and routes\r\n * @param feature OlFeature\r\n * @returns OL style function\r\n */\r\nexport function directionsStyle(\r\n  feature: olFeature<OlGeometry>,\r\n  resolution: number\r\n): olStyle.Style | olStyle.Style[] {\r\n  const vertexStyle = [\r\n    new olStyle.Style({\r\n      geometry: feature.getGeometry(),\r\n      image: new olStyle.Circle({\r\n        radius: 7,\r\n        stroke: new olStyle.Stroke({ color: '#FF0000', width: 3 })\r\n      })\r\n    })\r\n  ];\r\n\r\n  const stopStyle = createOverlayMarkerStyle({\r\n    text: feature.get('stopText'),\r\n    opacity: feature.get('stopOpacity'),\r\n    markerColor: feature.get('stopColor'),\r\n    markerOutlineColor: [255, 255, 255]\r\n  });\r\n\r\n  const routeStyle = [\r\n    new olStyle.Style({\r\n      stroke: new olStyle.Stroke({ color: `rgba(106, 121, 130, ${feature.get('active') ? 0.75 : 0})`, width: 10 })\r\n    }),\r\n    new olStyle.Style({\r\n      stroke: new olStyle.Stroke({ color: `rgba(79, 169, 221, ${feature.get('active') ? 0.75 : 0})`, width: 6 })\r\n    })\r\n  ];\r\n\r\n  if (feature.get('type') === DirectionType.Stop) {\r\n    return stopStyle;\r\n  }\r\n  if (feature.get('type') === 'vertex') {\r\n    return vertexStyle;\r\n  }\r\n  if (feature.get('type') === DirectionType.Route) {\r\n    return routeStyle;\r\n  }\r\n}\r\n\r\nexport function initStopsFeatureStore(stopsFeatureStore: StopsFeatureStore, languageService: LanguageService) {\r\n  const loadingStrategy = new FeatureStoreLoadingStrategy({\r\n    motion: FeatureMotion.None\r\n  });\r\n\r\n  const stopsLayer = new VectorLayer({\r\n    isIgoInternalLayer: true,\r\n    id: 'igo-direction-stops-layer',\r\n    title: languageService.translate.instant('igo.geo.directionsForm.stopLayer'),\r\n    zIndex: 911,\r\n    source: new FeatureDataSource(),\r\n    showInLayerList: true,\r\n    workspace: {\r\n      enabled: false,\r\n    },\r\n    linkedLayers: {\r\n      linkId: 'igo-direction-stops-layer',\r\n      links: [\r\n        {\r\n          bidirectionnal: false,\r\n          syncedDelete: true,\r\n          linkedIds: ['igo-direction-route-layer'],\r\n          properties: []\r\n        }\r\n      ]\r\n    },\r\n    exportable: true,\r\n    browsable: false,\r\n    style: directionsStyle\r\n  });\r\n  tryBindStoreLayer(stopsFeatureStore, stopsLayer);\r\n  stopsFeatureStore.layer.visible = true;\r\n  tryAddLoadingStrategy(stopsFeatureStore, loadingStrategy);\r\n}\r\n\r\nexport function initRoutesFeatureStore(routesFeatureStore: RoutesFeatureStore, languageService: LanguageService) {\r\n  const loadingStrategy = new FeatureStoreLoadingStrategy({\r\n    motion: FeatureMotion.None\r\n  });\r\n\r\n  const routeLayer = new VectorLayer({\r\n    isIgoInternalLayer: true,\r\n    id: 'igo-direction-route-layer',\r\n    title: languageService.translate.instant('igo.geo.directionsForm.routeLayer'),\r\n    zIndex: 910,\r\n    source: new FeatureDataSource(),\r\n    showInLayerList: true,\r\n    workspace: {\r\n      enabled: false,\r\n    },\r\n    linkedLayers: {\r\n      linkId: 'igo-direction-route-layer'\r\n    },\r\n    exportable: true,\r\n    browsable: false,\r\n    style: directionsStyle\r\n  });\r\n  tryBindStoreLayer(routesFeatureStore, routeLayer);\r\n  routesFeatureStore.layer.visible = true;\r\n  tryAddLoadingStrategy(routesFeatureStore, loadingStrategy);\r\n}\r\n\r\nexport function initStepFeatureStore(stepFeatureStore: StepFeatureStore) {\r\n  const loadingStrategy = new FeatureStoreLoadingStrategy({\r\n    motion: FeatureMotion.None\r\n  });\r\n\r\n  const stepLayer = new VectorLayer({\r\n    isIgoInternalLayer: true,\r\n    id: 'igo-direction-step-layer',\r\n    title: '',\r\n    zIndex: 910,\r\n    source: new FeatureDataSource(),\r\n    showInLayerList: false,\r\n    workspace: {\r\n      enabled: false,\r\n    },\r\n    linkedLayers: {\r\n      linkId: 'igo-direction-route-layer'\r\n    },\r\n    exportable: false,\r\n    browsable: false,\r\n    style: directionsStyle\r\n  });\r\n  tryBindStoreLayer(stepFeatureStore, stepLayer);\r\n  stepFeatureStore.layer.visible = true;\r\n  tryAddLoadingStrategy(stepFeatureStore, loadingStrategy);\r\n}\r\n\r\n\r\nexport function addStopToStopsFeatureStore(\r\n  stop: Stop,\r\n  stopsStore: StopsStore,\r\n  stopsFeatureStore: StopsFeatureStore,\r\n  projection: string,\r\n  languageService: LanguageService) {\r\n  let stopColor;\r\n  let stopText;\r\n\r\n\r\n  switch (stop.relativePosition) {\r\n    case DirectionRelativePositionType.Start:\r\n      stopColor = '#008000';\r\n      stopText = languageService.translate.instant('igo.geo.directionsForm.start');\r\n      break;\r\n    case DirectionRelativePositionType.End:\r\n      stopColor = '#f64139';\r\n      stopText = languageService.translate.instant('igo.geo.directionsForm.end');\r\n      break;\r\n    default:\r\n      stopColor = '#ffd700';\r\n      stopText = languageService.translate.instant('igo.geo.directionsForm.intermediate') + ' #' + stop.position;\r\n      break;\r\n  }\r\n\r\n  const geometry = new olGeom.Point(\r\n    olProj.transform(stop.coordinates, projection, stopsFeatureStore.map.projection)\r\n  );\r\n\r\n  const geojsonGeom = new OlGeoJSON().writeGeometryObject(geometry, {\r\n    featureProjection: stopsFeatureStore.map.projection,\r\n    dataProjection: stopsFeatureStore.map.projection\r\n  }) as FeatureGeometry;\r\n\r\n  const previousStop = stopsFeatureStore.get(stop.id);\r\n  const previousStopRevision = previousStop ? previousStop.meta.revision : 0;\r\n\r\n  const stopFeatureStore: FeatureWithStop = {\r\n    type: FEATURE,\r\n    geometry: geojsonGeom,\r\n    projection: stopsFeatureStore.map.projection,\r\n    properties: {\r\n      id: stop.id,\r\n      type: DirectionType.Stop,\r\n      stopText,\r\n      stopColor,\r\n      stopOpacity: 1,\r\n      stop\r\n    },\r\n    meta: {\r\n      id: stop.id,\r\n      revision: previousStopRevision + 1\r\n    },\r\n    ol: new olFeature({ geometry })\r\n  };\r\n  stopsFeatureStore.update(stopFeatureStore);\r\n}\r\n\r\nexport function addDirectionToRoutesFeatureStore(\r\n  routesFeatureStore: RoutesFeatureStore,\r\n  direction: Direction,\r\n  projection: string,\r\n  active: boolean = false,\r\n  moveToExtent = false) {\r\n  const geom = direction.geometry.coordinates;\r\n  const geometry4326 = new olGeom.LineString(geom);\r\n  const geometry = geometry4326.transform(\r\n    projection,\r\n    routesFeatureStore.map.projection\r\n  );\r\n\r\n  const geojsonGeom = new OlGeoJSON().writeGeometryObject(geometry, {\r\n    featureProjection: routesFeatureStore.map.projection,\r\n    dataProjection: routesFeatureStore.map.projection\r\n  }) as FeatureGeometry;\r\n\r\n\r\n  const previousRoute = routesFeatureStore.get(direction.id);\r\n  const previousRouteRevision = previousRoute\r\n    ? previousRoute.meta.revision\r\n    : 0;\r\n\r\n  const routeFeatureStore: FeatureWithDirection = {\r\n    type: FEATURE,\r\n    geometry: geojsonGeom,\r\n    projection: routesFeatureStore.map.projection,\r\n    properties: {\r\n      id: direction.id,\r\n      type: DirectionType.Route,\r\n      active,\r\n      direction\r\n    },\r\n    meta: {\r\n      id: direction.id,\r\n      revision: previousRouteRevision + 1\r\n    },\r\n    ol: new olFeature({ geometry })\r\n  };\r\n  routesFeatureStore.update(routeFeatureStore);\r\n}\r\n\r\nexport function formatDistance(distance: number): string {\r\n  if (distance === 0) {\r\n    return;\r\n  }\r\n  if (distance >= 100000) {\r\n    return NumberUtils.roundToNDecimal(Math.round(distance) / 1000, 1) + ' km';\r\n  }\r\n  if (distance >= 10000) {\r\n    return NumberUtils.roundToNDecimal(Math.round(distance) / 100 / 10, 1) + ' km';\r\n  }\r\n  if (distance >= 1000) {\r\n    return NumberUtils.roundToNDecimal(Math.round(distance) / 100 / 10, 1) + ' km';\r\n  }\r\n  return NumberUtils.roundToNDecimal(distance, 0) + ' m';\r\n}\r\n\r\nexport function formatDuration(duration: number): string {\r\n  if (duration >= 3600) {\r\n    const hour = Math.floor(duration / 3600);\r\n    const minute = Math.round((duration / 3600 - hour) * 60);\r\n    if (minute === 60) {\r\n      return hour + 1 + ' h';\r\n    }\r\n    return hour + ' h ' + minute + ' min';\r\n  }\r\n\r\n  if (duration >= 60) {\r\n    return Math.round(duration / 60) + ' min';\r\n  }\r\n  return duration + ' s';\r\n}\r\n\r\nexport function formatInstruction(\r\n  type,\r\n  modifier,\r\n  route,\r\n  direction,\r\n  stepPosition,\r\n  exit,\r\n  languageService: LanguageService,\r\n  lastStep = false\r\n) {\r\n  const translate = languageService.translate;\r\n  let directive;\r\n  let image = 'forward';\r\n  let cssClass = 'rotate-270';\r\n  const translatedDirection = translateBearing(direction, languageService);\r\n  const translatedModifier = translateModifier(modifier, languageService);\r\n  const prefix = modifier === 'straight' ? '' : translate.instant('igo.geo.directions.modifier.prefix');\r\n\r\n  let aggregatedDirection = prefix + translatedModifier;\r\n\r\n\r\n  if (modifier?.search('slight') >= 0) {\r\n    aggregatedDirection = translatedModifier;\r\n  }\r\n\r\n  if (modifier === 'uturn') {\r\n    image = 'forward';\r\n    cssClass = 'rotate-90';\r\n  } else if (modifier === 'sharp right') {\r\n    image = 'subdirectory-arrow-right';\r\n    cssClass = 'icon-flipped';\r\n  } else if (modifier === 'right') {\r\n    image = 'subdirectory-arrow-right';\r\n    cssClass = 'icon-flipped';\r\n  } else if (modifier === 'slight right') {\r\n    image = 'forward';\r\n    cssClass = 'rotate-290';\r\n  } else if (modifier === 'straight') {\r\n    image = 'forward';\r\n  } else if (modifier === 'slight left') {\r\n    image = 'forward';\r\n    cssClass = 'rotate-250';\r\n  } else if (modifier === 'left') {\r\n    image = 'subdirectory-arrow-left';\r\n    cssClass = 'icon-flipped';\r\n  } else if (modifier === 'sharp left') {\r\n    image = 'subdirectory-arrow-left';\r\n    cssClass = 'icon-flipped';\r\n  }\r\n\r\n  if (type === 'turn') {\r\n    if (modifier === 'straight') {\r\n      directive = translate.instant('igo.geo.directions.turn.straight', { route });\r\n    } else if (modifier === 'uturn') {\r\n      directive = translate.instant('igo.geo.directions.turn.uturn', { route });\r\n    } else {\r\n      directive = translate.instant('igo.geo.directions.turn.else', { route, aggregatedDirection, translatedModifier });\r\n    }\r\n  } else if (type === 'new name') {\r\n    directive = translate.instant('igo.geo.directions.new name', { route, translatedDirection });\r\n    image = 'compass';\r\n    cssClass = '';\r\n  } else if (type === 'depart') {\r\n    directive = translate.instant('igo.geo.directions.depart', { route, translatedDirection });\r\n    image = 'compass';\r\n    cssClass = '';\r\n  } else if (type === 'arrive') {\r\n    if (lastStep) {\r\n      const coma = !translatedModifier ? '' : ', ';\r\n      aggregatedDirection = !translatedModifier ? '' : aggregatedDirection;\r\n      directive = translate.instant('igo.geo.directions.arrive.lastStep', { coma, aggregatedDirection });\r\n    } else {\r\n      directive = translate.instant('igo.geo.directions.arrive.intermediate', { route });\r\n      image = 'map-marker';\r\n      cssClass = '';\r\n    }\r\n  } else if (type === 'merge') {\r\n    directive = translate.instant('igo.geo.directions.merge', { route });\r\n    image = 'forward';\r\n    cssClass = 'rotate-270';\r\n  } else if (type === 'on ramp') {\r\n    directive = translate.instant('igo.geo.directions.on ramp', { aggregatedDirection });\r\n  } else if (type === 'off ramp') {\r\n    directive = translate.instant('igo.geo.directions.off ramp', { aggregatedDirection });\r\n  } else if (type === 'fork') {\r\n    if (modifier.search('left') >= 0) {\r\n      directive = translate.instant('igo.geo.directions.fork.left', { route });\r\n    } else if (modifier.search('right') >= 0) {\r\n      directive = translate.instant('igo.geo.directions.fork.right', { route });\r\n    } else {\r\n      directive = translate.instant('igo.geo.directions.fork.else', { route });\r\n    }\r\n  } else if (type === 'end of road') {\r\n    directive = translate.instant('igo.geo.directions.end of road', { translatedModifier, route });\r\n  } else if (type === 'use lane') {\r\n    directive = translate.instant('igo.geo.directions.use lane');\r\n  } else if (type === 'continue' && modifier !== 'uturn') {\r\n    directive = translate.instant('igo.geo.directions.continue.notUturn', { route });\r\n    image = 'forward';\r\n    cssClass = 'rotate-270';\r\n  } else if (type === 'roundabout') {\r\n    const cntSuffix = exit === 1 ?\r\n      translate.instant('igo.geo.directions.cntSuffix.first') :\r\n      translate.instant('igo.geo.directions.cntSuffix.secondAndMore');\r\n    directive = translate.instant('igo.geo.directions.roundabout', { exit, cntSuffix, route });\r\n    image = 'chart-donut';\r\n    cssClass = '';\r\n  } else if (type === 'rotary') {\r\n    directive = translate.instant('igo.geo.directions.rotary');\r\n    image = 'chart-donut';\r\n    cssClass = '';\r\n  } else if (type === 'roundabout turn') {\r\n    directive = translate.instant('igo.geo.directions.roundabout turn');\r\n    image = 'chart-donut';\r\n    cssClass = '';\r\n  } else if (type === 'exit roundabout') {\r\n    directive = translate.instant('igo.geo.directions.exit roundabout', { route });\r\n    image = 'forward';\r\n    cssClass = 'rotate-270';\r\n  } else if (type === 'notification') {\r\n    directive = translate.instant('igo.geo.directions.notification');\r\n  } else if (modifier === 'uturn') {\r\n    directive = translate.instant('igo.geo.directions.uturnText', { translatedDirection, route });\r\n  } else {\r\n    directive = translate.instant('igo.geo.directions.unknown');\r\n  }\r\n\r\n  image = lastStep ? 'flag-variant' : image;\r\n  cssClass = lastStep ? '' : cssClass;\r\n  image = stepPosition === 0 ? 'compass' : image;\r\n  cssClass = stepPosition === 0 ? '' : cssClass;\r\n\r\n  return { instruction: directive, image, cssClass };\r\n}\r\n\r\nexport function translateModifier(modifier, languageService: LanguageService) {\r\n  const translate = languageService.translate;\r\n  if (modifier === 'uturn') {\r\n    return translate.instant('igo.geo.directions.uturn');\r\n  } else if (modifier === 'sharp right') {\r\n    return translate.instant('igo.geo.directions.sharp right');\r\n  } else if (modifier === 'right') {\r\n    return translate.instant('igo.geo.directions.right');\r\n  } else if (modifier === 'slight right') {\r\n    return translate.instant('igo.geo.directions.slight right');\r\n  } else if (modifier === 'sharp left') {\r\n    return languageService.translate.instant('igo.geo.directions.sharp left');\r\n  } else if (modifier === 'left') {\r\n    return languageService.translate.instant('igo.geo.directions.left');\r\n  } else if (modifier === 'slight left') {\r\n    return languageService.translate.instant('igo.geo.directions.slight left');\r\n  } else if (modifier === 'straight') {\r\n    return languageService.translate.instant('igo.geo.directions.straight');\r\n  } else {\r\n    return modifier;\r\n  }\r\n}\r\n\r\nexport function translateBearing(bearing: number, languageService: LanguageService) {\r\n  const translate = languageService.translate;\r\n  if (bearing >= 337 || bearing < 23) {\r\n    return translate.instant('igo.geo.cardinalPoints.n');\r\n  } else if (bearing < 67) {\r\n    return translate.instant('igo.geo.cardinalPoints.ne');\r\n  } else if (bearing < 113) {\r\n    return translate.instant('igo.geo.cardinalPoints.e');\r\n  } else if (bearing < 157) {\r\n    return translate.instant('igo.geo.cardinalPoints.se');\r\n  } else if (bearing < 203) {\r\n    return translate.instant('igo.geo.cardinalPoints.s');\r\n  } else if (bearing < 247) {\r\n    return translate.instant('igo.geo.cardinalPoints.sw');\r\n  } else if (bearing < 293) {\r\n    return translate.instant('igo.geo.cardinalPoints.w');\r\n  } else if (bearing < 337) {\r\n    return translate.instant('igo.geo.cardinalPoints.nw');\r\n  } else {\r\n    return;\r\n  }\r\n}\r\n\r\n\r\n","<div cdkDropList class=\"stops-list\" (cdkDropListDropped)=\"drop($event)\">\r\n  <div touchleave  \r\n  (touchenter)=\"onStopEnter(stop)\"\r\n  (touchleave)=\"onStopLeave()\"\r\n  (mouseover)=\"onStopEnter(stop)\"\r\n  (mouseleave)=\"onStopLeave()\"\r\n  (cdkDragStarted)=\"stopIsDragged=true\"\r\n  (cdkDragEnded)=\"stopIsDragged=false\"\r\n  cdkDragLockAxis=\"y\" class=\"stop-box mat-typography\" *ngFor=\"let stop of stopsStore.view.all$() | async; let i = index;\" cdkDrag>\r\n    <div [ngClass]=\"getNgClass(stop)\">\r\n      <mat-form-field>\r\n        <input id=\"{{stop.id}}\" type=\"text\"\r\n            [placeholder]=\"getPlaceholder(stop)\"\r\n            matTooltipShowDelay=\"500\"\r\n            [matTooltip]=\"stop.text\"\r\n            aria-label=\"Number\"\r\n            matInput\r\n            (focus)=\"onInputFocus(stop)\"\r\n            [(ngModel)]=\"stop.text\"\r\n            (keyup)=\"setStopText($event,stop)\"\r\n            (keydown.enter)=\"$event.preventDefault()\"\r\n            [matAutocomplete]=\"auto\">\r\n        <button \r\n            mat-button \r\n            *ngIf=\"(stop.text || stop.coordinates) && stopWithHover && stop.id===stopWithHover.id\"\r\n            matTooltipShowDelay=\"500\"\r\n            [matTooltip]=\"'igo.geo.directionsForm.clearStop' | translate\"\r\n            matSuffix mat-icon-button color=\"warn\" aria-label=\"Clear\" (click)=\"clearStop(stop)\">\r\n            <mat-icon svgIcon=\"close\"></mat-icon>\r\n        </button>\r\n      \r\n        <mat-autocomplete [displayWith]=\"getOptionText\" #auto=\"matAutocomplete\" (optionSelected)=\"chooseProposal($event,stop)\">\r\n          <mat-optgroup *ngFor=\"let source of stop.searchProposals\" [label]=\"source.source.title\" [disabled]=\"source.source.enabled === false\">\r\n          <mat-option *ngFor=\"let result of source.results\" [value]=\"result\" \r\n          matTooltipShowDelay=\"500\" [matTooltip]=\"result.meta ? result.meta.title : ''\">\r\n            {{ result.meta ? result.meta.title : '' }}\r\n          </mat-option>\r\n          </mat-optgroup>\r\n        </mat-autocomplete>\r\n      </mat-form-field>\r\n    </div>\r\n\r\n\r\n\r\n\r\n    <div class=\"igo-form-button-group\" *ngIf=\"!stopIsDragged && stopWithHover && stop.id === stopWithHover.id\">\r\n      <button class=\"swipe-vertical\" cdkDragHandle mat-icon-button tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.geo.directionsForm.moveStop' | translate\" color=\"primary\">\r\n        <mat-icon svgIcon=\"gesture-swipe-vertical\"></mat-icon>\r\n      </button>\r\n\r\n      <button *ngIf=\"(stopsStore.count$ | async)> 2\" mat-icon-button tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n        [matTooltip]=\"'igo.geo.directionsForm.removeStop' | translate\" color=\"warn\" (click)=\"removeStop(stop)\">\r\n        <mat-icon svgIcon=\"delete\"></mat-icon>\r\n      </button>\r\n      <button *ngIf=\"(stopsStore.count$ | async)<= 2\" disabled=\"true\" mat-icon-button tooltip-position=\"below\"\r\n        matTooltipShowDelay=\"500\" [matTooltip]=\"'igo.geo.directionsForm.removeStop' | translate\" color=\"warn\">\r\n        <mat-icon svgIcon=\"blank\"></mat-icon>\r\n      </button>\r\n    </div>\r\n  </div>\r\n</div>","import { Component, EventEmitter, Input, OnDestroy, Output } from '@angular/core';\r\nimport { CdkDragDrop, moveItemInArray } from '@angular/cdk/drag-drop';\r\n\r\nimport * as olProj from 'ol/proj';\r\nimport * as olObservable from 'ol/Observable';\r\n\r\nimport { Stop } from '../shared/directions.interface';\r\n\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport pointOnFeature from '@turf/point-on-feature';\r\nimport { computeRelativePosition, removeStopFromStore, updateStoreSorting } from '../shared/directions.utils';\r\nimport { MatAutocomplete } from '@angular/material/autocomplete';\r\nimport { MatOption } from '@angular/material/core';\r\nimport { StopsFeatureStore, StopsStore } from '../shared/store';\r\nimport { roundCoordTo } from '../../map/shared/map.utils';\r\nimport { LanguageService } from '@igo2/core';\r\nimport { DirectionRelativePositionType } from '../shared/directions.enum';\r\n\r\n@Component({\r\n  selector: 'igo-directions-inputs',\r\n  templateUrl: './directions-inputs.component.html',\r\n  styleUrls: ['./directions-inputs.component.scss']\r\n})\r\nexport class DirectionsInputsComponent implements OnDestroy {\r\n\r\n  private readonly invalidKeys = ['Control', 'Shift', 'Alt'];\r\n  private onMapClickEventKeys = [];\r\n  public stopWithHover: Stop;\r\n  public stopIsDragged: boolean = false;\r\n  @Input() stopsStore: StopsStore;\r\n  @Input() stopsFeatureStore: StopsFeatureStore;\r\n  @Input() projection: string;\r\n  @Input() coordRoundedDecimals: number = 6;\r\n\r\n  @Input() debounce: number = 200;\r\n  @Input() length: number = 2;\r\n\r\n  @Output() stopInputHasFocus: EventEmitter<boolean> = new EventEmitter<boolean>(false);\r\n  constructor(private languageService: LanguageService) { }\r\n\r\n  ngOnDestroy(): void {\r\n    this.unlistenMapSingleClick();\r\n  }\r\n  onStopEnter(stop: Stop) {\r\n    this.stopWithHover = stop;\r\n  }\r\n  onStopLeave() {\r\n    this.stopWithHover = undefined;\r\n  }\r\n\r\n  getOptionText(option) {\r\n    if (option instanceof Object) {\r\n      return option?.meta ? option.meta.title : '';\r\n    }\r\n    return option;\r\n  }\r\n\r\n  chooseProposal(event: { source: MatAutocomplete, option: MatOption }, stop: Stop) {\r\n    const result: Feature = event.option.value;\r\n    if (result) {\r\n      let geomCoord;\r\n      const geom = result.geometry;\r\n      if (geom.type === 'Point') {\r\n        geomCoord = geom.coordinates;\r\n      } else {\r\n        const point = pointOnFeature(result.geometry);\r\n        geomCoord = [\r\n          point.geometry.coordinates[0],\r\n          point.geometry.coordinates[1]\r\n        ];\r\n      }\r\n      if (geomCoord) {\r\n        stop.coordinates = geomCoord;\r\n        stop.text = result.meta.title;\r\n        this.stopsStore.update(stop);\r\n      }\r\n    }\r\n  }\r\n\r\n  setStopText(event: KeyboardEvent, stop: Stop) {\r\n    this.unlistenMapSingleClick();\r\n    const term = (event.target as HTMLInputElement).value;\r\n    if (term.length === 0) {\r\n      this.clearStop(stop);\r\n    } else if (this.validateTerm(term)) {\r\n      stop.text = term;\r\n      this.stopsStore.update(stop);\r\n    }\r\n  }\r\n\r\n  validateTerm(term: string) {\r\n    if (\r\n      this.keyIsValid(term) &&\r\n      (term.length >= this.length || term.length === 0)\r\n    ) {\r\n      return true;\r\n    }\r\n    return false;\r\n  }\r\n\r\n  private keyIsValid(key: string) {\r\n    return this.invalidKeys.find(value => value === key) === undefined;\r\n  }\r\n\r\n  getNgClass(stop: Stop): string {\r\n    if (!this.stopWithHover) {\r\n      return 'igo-input-container';\r\n    } else if (stop.id === this.stopWithHover.id) {\r\n      return 'igo-input-container reduce';\r\n    } else {\r\n      return 'igo-input-container';\r\n    }\r\n  }\r\n\r\n  getPlaceholder(stop: Stop): string {\r\n    let extra = '';\r\n    if (stop.relativePosition) {\r\n      if (stop.relativePosition === DirectionRelativePositionType.Intermediate) {\r\n        extra = ' #' + stop.position;\r\n      }\r\n      return this.languageService.translate.instant('igo.geo.directionsForm.' + stop.relativePosition) + extra;\r\n    } else {\r\n      return '';\r\n    }\r\n  }\r\n\r\n  removeStop(stop: Stop) {\r\n    removeStopFromStore(this.stopsStore, stop);\r\n  }\r\n\r\n  clearStop(stop: Stop) {\r\n    this.stopsStore.update({ id: stop.id, relativePosition: stop.relativePosition, position: stop.position });\r\n  }\r\n\r\n  drop(event: CdkDragDrop<string[]>) {\r\n    this.moveStops(event.previousIndex, event.currentIndex);\r\n  }\r\n\r\n  private moveStops(fromIndex, toIndex) {\r\n    if (fromIndex !== toIndex) {\r\n      const stops = [...this.stopsStore.view.all()];\r\n      moveItemInArray(stops, fromIndex, toIndex);\r\n      stops.map((stop, i) => {\r\n        stop.relativePosition = computeRelativePosition(i, stops.length);\r\n        stop.position = i;\r\n      });\r\n      this.stopsStore.updateMany(stops);\r\n      updateStoreSorting(this.stopsStore);\r\n    }\r\n  }\r\n\r\n  onInputFocus(stop: Stop) {\r\n    if (!stop.text || stop.text?.length === 0) {\r\n      this.unlistenMapSingleClick();\r\n      this.stopInputHasFocus.emit(true);\r\n      this.listenMapSingleClick(stop);\r\n    }\r\n  }\r\n\r\n  private listenMapSingleClick(stop: Stop) {\r\n    const key = this.stopsFeatureStore.layer.map.ol.once('singleclick', event => {\r\n      const clickCoordinates = olProj.transform(\r\n        event.coordinate,\r\n        this.stopsFeatureStore.layer.map.projection,\r\n        this.projection\r\n      );\r\n      const roundedCoord = roundCoordTo(clickCoordinates as [number, number], this.coordRoundedDecimals);\r\n      stop.text = roundedCoord.join(',');\r\n      stop.coordinates = roundedCoord;\r\n      this.stopsStore.update(stop);\r\n      setTimeout(() => {\r\n        this.stopInputHasFocus.emit(false);\r\n      }, 500);\r\n    });\r\n    this.onMapClickEventKeys.push(key);\r\n  }\r\n\r\n  private unlistenMapSingleClick() {\r\n    this.onMapClickEventKeys.map(key => {\r\n      olObservable.unByKey(key);\r\n    });\r\n    this.onMapClickEventKeys = [];\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { Observable } from 'rxjs';\r\n\r\n\r\nimport { Direction, DirectionOptions } from '../shared/directions.interface';\r\nimport { DirectionsSource } from '../directions-sources/directions-source';\r\nimport { DirectionsSourceService } from './directions-source.service';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class DirectionsService {\r\n  constructor(private directionsSourceService: DirectionsSourceService) {}\r\n\r\n  route(coordinates: [number, number][], directionsOptions: DirectionOptions = {}): Observable<Direction[]>[] {\r\n    if (coordinates.length === 0) {\r\n      return;\r\n    }\r\n    return this.directionsSourceService.sources\r\n      .filter((source: DirectionsSource) => source.enabled)\r\n      .map((source: DirectionsSource) => this.routeSource(source, coordinates, directionsOptions));\r\n  }\r\n\r\n  routeSource(\r\n    source: DirectionsSource,\r\n    coordinates: [number, number][],\r\n    directionsOptions: DirectionOptions = {}\r\n  ): Observable<Direction[]> {\r\n    const request = source.route(coordinates, directionsOptions );\r\n    return request;\r\n  }\r\n}\r\n","import { FEATURE } from '../../feature/shared/feature.enums';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport { SearchSource } from './sources/source';\r\nimport { SearchResult } from './search.interfaces';\r\n\r\n/**\r\n * Function that checks whether a search source implements TextSearch\r\n * @param source Search source\r\n * @returns True if the search source implements TextSearch\r\n */\r\nexport function sourceCanSearch(source: SearchSource): boolean {\r\n  return (source as any).search !== undefined;\r\n}\r\n\r\n/**\r\n * Function that checks whether a search source implements ReverseSearch\r\n * @param source Search source\r\n * @returns True if the search source implements ReverseSearch\r\n */\r\nexport function sourceCanReverseSearch(source: SearchSource): boolean {\r\n  return (source as any).reverseSearch !== undefined;\r\n}\r\n\r\n/**\r\n * Function that checks whether a search source implements ReverseSearch AND is shown in the pointer summary\r\n * @param source Search source\r\n * @returns True if the search source implements ReverseSearch AND is shown in the pointer summary\r\n */\r\nexport function sourceCanReverseSearchAsSummary(source: SearchSource): boolean {\r\n  return (source as any).reverseSearch !== undefined && source.showInPointerSummary === true;\r\n}\r\n\r\n/**\r\n * Return a search result out of an Feature. This is used to adapt\r\n * the IGO query module to the new Feature/SearchResult interfaces\r\n * @param feature feature\r\n * @param source Search source\r\n * @returns SearchResult\r\n */\r\nexport function featureToSearchResult(\r\n  feature: Feature,\r\n  source: SearchSource\r\n): SearchResult<Feature> {\r\n  feature.sourceId = source.getId();\r\n  return {\r\n    source,\r\n    data: feature,\r\n    meta: {\r\n      dataType: FEATURE,\r\n      id: feature.meta.id as string,\r\n      title: feature.meta.title,\r\n      icon: feature.meta.icon || 'map-marker'\r\n    }\r\n  };\r\n}\r\n\r\nexport function findDiff(str1: string, str2: string){\r\n  let diff = '';\r\n  str2.split('').forEach((val, i) => {\r\n    if (val !== str1.charAt(i)) {\r\n      diff += val;\r\n    }\r\n  });\r\n  return diff;\r\n}\r\n\r\n\r\n/**\r\n * Return a score calculation based on \"from\" term with the \"to\" term,\r\n * where the perfect match is 100 and a total difference is 0 or under.\r\n * @param from string\r\n * @param to string\r\n * @param caseSensitive boolean\r\n * @returns number\r\n */\r\nexport function computeTermSimilarity(from, to, caseSensitive: boolean = false): number {\r\n  if (!from || !to) {\r\n    return 0;\r\n  }\r\n  const termFrom = caseSensitive ? from : from.toLowerCase();\r\n  const termTo = caseSensitive ? to : to.toLowerCase();\r\n  const fromToDiff = findDiff(termFrom, termTo);\r\n  const toFromDiff = findDiff(termTo, termFrom);\r\n  const totalDiff = fromToDiff + toFromDiff;\r\n\r\n  let delta = 0;\r\n  if (totalDiff.length) {\r\n    delta = totalDiff.length / termFrom.length * 100;\r\n  }\r\n\r\n  return 100 - Math.floor(delta);\r\n}\r\n","import { SearchSource } from './sources/source';\r\nimport { SearchSourceSettings } from './sources/source.interfaces';\r\n\r\n/**\r\n * Service where all available search sources are registered.\r\n */\r\nexport class SearchSourceService {\r\n\r\n  constructor(private sources: SearchSource[]) {}\r\n\r\n  /**\r\n   * Return available search sources\r\n   * @returns Search sources\r\n   */\r\n  getSources(): SearchSource[] {\r\n    return this.sources;\r\n  }\r\n\r\n  /**\r\n   * Return enabled search sources\r\n   * @returns Search sources\r\n   */\r\n  getEnabledSources(): SearchSource[] {\r\n    return this.getSources().filter(\r\n      (source: SearchSource) => source.enabled === true\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Enable search sources of given type\r\n   * @param type Search type\r\n   * @todo It would be better to track the enabled search sources\r\n   *  without updating their 'enabled' property.\r\n   */\r\n  enableSourcesByType(type: string) {\r\n    this.getSources().forEach((source: SearchSource) => {\r\n      if ((source.constructor as typeof SearchSource).type === type) {\r\n        source.enabled = true;\r\n      } else {\r\n        source.enabled = false;\r\n      }\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Set Param from the selected settings\r\n   * @param source search-source\r\n   * @param setting settings\r\n   */\r\n  setParamFromSetting(source: SearchSource, setting: SearchSourceSettings) {\r\n    source.setParamFromSetting(setting);\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { stringToLonLat } from '../../map';\r\nimport { MapService } from '../../map/shared/map.service';\r\n\r\nimport { SearchSource, TextSearch, ReverseSearch } from './sources/source';\r\nimport {\r\n  TextSearchOptions,\r\n  ReverseSearchOptions\r\n} from './sources/source.interfaces';\r\nimport { SearchSourceService } from './search-source.service';\r\nimport { Research } from './search.interfaces';\r\nimport {\r\n  sourceCanSearch,\r\n  sourceCanReverseSearch,\r\n  sourceCanReverseSearchAsSummary\r\n} from './search.utils';\r\n\r\n/**\r\n * This service perform researches in all the search sources enabled.\r\n * It returns Research objects who's 'request' property needs to be\r\n * subscribed to in order to trigger the research. This services has\r\n * keeps internal state of the researches it performed\r\n * and the results they yielded.\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class SearchService {\r\n  constructor(\r\n    private searchSourceService: SearchSourceService,\r\n    private mapService: MapService\r\n  ) {}\r\n\r\n  /**\r\n   * Perform a research by text\r\n   * @param term Any text\r\n   * @returns Researches\r\n   */\r\n  search(term: string, options: TextSearchOptions = {}): Research[] {\r\n    if (!this.termIsValid(term)) {\r\n      return [];\r\n    }\r\n\r\n    const proj = this.mapService.getMap()?.projection || 'EPSG:3857';\r\n    const response = stringToLonLat(term, proj, {\r\n      forceNA: options.forceNA\r\n    });\r\n    if (response.lonLat) {\r\n      return this.reverseSearch(response.lonLat, { distance: response.radius, conf: response.conf });\r\n    } else if (response.message) {\r\n      console.log(response.message);\r\n    }\r\n\r\n    options.extent = this.mapService\r\n      .getMap()\r\n      ?.viewController.getExtent('EPSG:4326');\r\n\r\n    let sources;\r\n\r\n    if (options.getEnabledOnly || options.getEnabledOnly === undefined) {\r\n      sources = this.searchSourceService.getEnabledSources();\r\n    } else {\r\n      sources = this.searchSourceService.getSources();\r\n    }\r\n\r\n    if (options.sourceId) {\r\n      sources = sources.filter((source) => source.getId() === options.sourceId);\r\n    } else if (options.searchType) {\r\n      sources = sources.filter(\r\n        (source) => source.getType() === options.searchType\r\n      );\r\n    }\r\n\r\n    sources = sources.filter(sourceCanSearch);\r\n    return this.searchSources(sources, term, options);\r\n  }\r\n\r\n  /**\r\n   * Perform a research by lon/lat\r\n   * @param lonLat Any lon/lat coordinates\r\n   * @returns Researches\r\n   */\r\n  reverseSearch(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions,\r\n    asPointerSummary: boolean = false\r\n  ) {\r\n    const reverseSourceFonction = asPointerSummary\r\n      ? sourceCanReverseSearchAsSummary\r\n      : sourceCanReverseSearch;\r\n    const sources = this.searchSourceService\r\n      .getEnabledSources()\r\n      .filter(reverseSourceFonction);\r\n    return this.reverseSearchSources(sources, lonLat, options || {});\r\n  }\r\n\r\n  /**\r\n   * Create a text research out of all given search sources\r\n   * @param sources Search sources that implement TextSearch\r\n   * @param term Search term\r\n   * @returns Observable of Researches\r\n   */\r\n  private searchSources(\r\n    sources: SearchSource[],\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): Research[] {\r\n    return sources.map((source: SearchSource) => {\r\n      return {\r\n        request: ((source as any) as TextSearch).search(term, options),\r\n        reverse: false,\r\n        source\r\n      };\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Create a reverse research out of all given search sources\r\n   * @param sources Search sources that implement ReverseSearch\r\n   * @param lonLat Any lon/lat coordinates\r\n   * @returns Observable of Researches\r\n   */\r\n  private reverseSearchSources(\r\n    sources: SearchSource[],\r\n    lonLat: [number, number],\r\n    options: ReverseSearchOptions\r\n  ): Research[] {\r\n    return sources.map((source: SearchSource) => {\r\n      return {\r\n        request: ((source as any) as ReverseSearch).reverseSearch(\r\n          lonLat,\r\n          options\r\n        ),\r\n        reverse: true,\r\n        source\r\n      };\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Validate that a search term is valid\r\n   * @param term Search term\r\n   * @returns True if the search term is valid\r\n   */\r\n  private termIsValid(term: string): boolean {\r\n    return typeof term === 'string' && term !== '';\r\n  }\r\n}\r\n","<div class=\"igo-form-button-group\">\r\n  <button mat-icon-button tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"'igo.geo.directionsForm.addStop' | translate\" color=\"primary\" (click)=\"addStop()\">\r\n    <mat-icon svgIcon=\"map-marker-plus\"></mat-icon>\r\n  </button>\r\n  <button mat-icon-button tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n    *ngIf=\"(routesFeatureStore.count$ | async)>=1 || (stopsStore.count$ | async)>=1\"\r\n    [matTooltip]=\"'igo.geo.directionsForm.resetDirectionsBtn' | translate\" color=\"warn\" (click)=\"resetStops()\">\r\n    <mat-icon svgIcon=\"file-restore\"></mat-icon>\r\n  </button>\r\n  <button mat-icon-button tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n    *ngIf=\"(routesFeatureStore.count$ | async)>=1\" (click)=\"zoomRoute()\"\r\n    [matTooltip]=\"'igo.geo.directionsForm.zoomRoute' | translate\" color=\"primary\">\r\n    <mat-icon svgIcon=\"magnify-plus-outline\"></mat-icon>\r\n  </button>\r\n  <button mat-icon-button tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n    *ngIf=\"(routesFeatureStore.count$ | async)>=1\" (click)=\"copyDirectionsToClipboard()\"\r\n    [matTooltip]=\"'igo.geo.directionsForm.copy' | translate\" color=\"primary\">\r\n    <mat-icon svgIcon=\"content-copy\"></mat-icon>\r\n  </button>\r\n  <button mat-icon-button tooltip-position=\"below\" matTooltipShowDelay=\"500\"\r\n    *ngIf=\"(routesFeatureStore.count$ | async)>=1\" (click)=\"copyLinkToClipboard()\" \r\n    [matTooltip]=\"'igo.geo.directionsForm.link' | translate\" color=\"primary\">\r\n    <mat-icon svgIcon=\"link\"></mat-icon>\r\n  </button>\r\n</div>","import { Component, Input, Optional } from '@angular/core';\r\nimport { LanguageService, MessageService, RouteService } from '@igo2/core';\r\nimport { Clipboard } from '@igo2/utils';\r\nimport { Subject } from 'rxjs';\r\nimport { roundCoordTo } from '../../map/shared/map.utils';\r\nimport { FeatureWithDirection } from '../shared/directions.interface';\r\n\r\nimport { addStopToStore, formatDistance, formatDuration, formatInstruction } from '../shared/directions.utils';\r\nimport { RoutesFeatureStore, StopsStore } from '../shared/store';\r\n\r\n@Component({\r\n  selector: 'igo-directions-buttons',\r\n  templateUrl: './directions-buttons.component.html',\r\n  styleUrls: ['./directions-buttons.component.scss']\r\n})\r\nexport class DirectionsButtonsComponent {\r\n\r\n  get activeRoute() {\r\n    return this.routesFeatureStore.all().find(route => route.properties.active);\r\n  }\r\n  @Input() contextUri: string;\r\n  @Input() zoomToActiveRoute$: Subject<void> = new Subject();\r\n  @Input() stopsStore: StopsStore;\r\n  @Input() routesFeatureStore: RoutesFeatureStore;\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private messageService: MessageService,\r\n    @Optional() private route: RouteService) { }\r\n\r\n  resetStops() {\r\n    this.stopsStore.clearStops();\r\n  }\r\n\r\n  // stop are always added before the last stop.\r\n  addStop(): void {\r\n    addStopToStore(this.stopsStore);\r\n  }\r\n\r\n\r\n  copyLinkToClipboard() {\r\n    const successful = Clipboard.copy(this.getUrl());\r\n    if (successful) {\r\n      const translate = this.languageService.translate;\r\n      const title = translate.instant(\r\n        'igo.geo.directionsForm.dialog.copyTitle'\r\n      );\r\n      const msg = translate.instant(\r\n        'igo.geo.directionsForm.dialog.copyMsgLink'\r\n      );\r\n      this.messageService.success(msg, title);\r\n    }\r\n  }\r\n\r\n  zoomRoute() {\r\n    this.zoomToActiveRoute$.next();\r\n  }\r\n\r\n  copyDirectionsToClipboard() {\r\n    const directionsBody = this.directionsToText();\r\n    const successful = Clipboard.copy(directionsBody);\r\n    if (successful) {\r\n      const translate = this.languageService.translate;\r\n      const title = translate.instant(\r\n        'igo.geo.directionsForm.dialog.copyTitle'\r\n      );\r\n      const msg = translate.instant('igo.geo.directionsForm.dialog.copyMsg');\r\n      this.messageService.success(msg, title);\r\n    }\r\n  }\r\n\r\n  private directionsToText() {\r\n    const indent = '\\t';\r\n    let activeRouteDirective =\r\n      this.languageService.translate.instant(\r\n        'igo.geo.directionsForm.instructions'\r\n      ) + ':\\n';\r\n    let wayPointList = '';\r\n    const summary =\r\n      this.languageService.translate.instant('igo.geo.directionsForm.summary') +\r\n      ': \\n' +\r\n      indent +\r\n      this.activeRoute.properties.direction.title +\r\n      '\\n' +\r\n      indent +\r\n      formatDistance(this.activeRoute.properties.direction.distance) +\r\n      '\\n' +\r\n      indent +\r\n      formatDuration(this.activeRoute.properties.direction.duration) +\r\n      '\\n\\n' +\r\n      this.languageService.translate.instant(\r\n        'igo.geo.directionsForm.stopsList'\r\n      ) +\r\n      ':\\n';\r\n\r\n    const url =\r\n      this.languageService.translate.instant('igo.geo.directionsForm.link') +\r\n      ':\\n' +\r\n      indent +\r\n      this.getUrl();\r\n\r\n    let wayPointsCnt = 1;\r\n    this.stopsStore.view.all().forEach(stop => {\r\n      let coord = '';\r\n      let stopText = '';\r\n      if (stop.text !== roundCoordTo(stop.coordinates).join(',')) {\r\n        stopText = stop.text;\r\n        coord = ` ( ${roundCoordTo(stop.coordinates).join(',')} )`;\r\n      } else {\r\n        stopText = roundCoordTo(stop.coordinates).join(\r\n          ','\r\n        );\r\n      }\r\n\r\n      wayPointList =\r\n        wayPointList +\r\n        indent +\r\n        wayPointsCnt.toLocaleString() +\r\n        '. ' +\r\n        stopText +\r\n        coord +\r\n        '\\n';\r\n      wayPointsCnt++;\r\n    });\r\n\r\n    let localCnt = 0;\r\n    this.activeRoute.properties.direction.steps.forEach(step => {\r\n      const instruction = this.formatStep(step, localCnt).instruction;\r\n      const distance =\r\n        formatDistance(step.distance) === undefined\r\n          ? ''\r\n          : ' (' + formatDistance(step.distance) + ')';\r\n      activeRouteDirective =\r\n        activeRouteDirective +\r\n        indent +\r\n        (localCnt + 1).toLocaleString() +\r\n        '. ' +\r\n        instruction +\r\n        distance +\r\n        '\\n';\r\n      localCnt++;\r\n    });\r\n\r\n    const directionsBody =\r\n      summary + wayPointList + '\\n' + url + '\\n\\n' + activeRouteDirective;\r\n\r\n    return directionsBody;\r\n  }\r\n\r\n  formatStep(step, cnt) {\r\n    return formatInstruction(\r\n      step.maneuver.type,\r\n      step.maneuver.modifier,\r\n      step.name,\r\n      step.maneuver.bearing_after,\r\n      cnt,\r\n      step.maneuver.exit,\r\n      this.languageService,\r\n      cnt === this.activeRoute.properties.direction.steps.length - 1\r\n    );\r\n  }\r\n\r\n  private getUrl() {\r\n    if (!this.route) {\r\n      return;\r\n    }\r\n    let context = '';\r\n    if (this.contextUri) {\r\n      context = `context=${this.contextUri}&`;\r\n    }\r\n\r\n    const pos = this.routesFeatureStore.all()\r\n    .map((direction: FeatureWithDirection) => direction.properties.id).indexOf(this.activeRoute.properties.id);\r\n    let routingOptions = '';\r\n    if (pos !== 0) {\r\n      const routingOptionsKey = this.route.options.directionsOptionsKey;\r\n      routingOptions = `&${routingOptionsKey}=result:${pos}`;\r\n    }\r\n    const directionsKey = this.route.options.directionsCoordKey;\r\n    const stopsCoordinates = this.stopsStore.view.all().map(stop => roundCoordTo(stop.coordinates, 6));\r\n    let directionsUrl = '';\r\n    if (stopsCoordinates.length >= 2) {\r\n      directionsUrl = `${directionsKey}=${stopsCoordinates.join(';')}`;\r\n      return `${location.origin}${location.pathname}?${context}tool=directions&sidenav=1&${directionsUrl}${routingOptions}`;\r\n    }\r\n    return;\r\n  }\r\n}\r\n","<div class=\"igo-input-container\" *ngIf=\"directions && activeDirection\">\r\n    <mat-form-field *ngIf=\"directions && directions.length > 1\">\r\n        <mat-select placeholder=\"{{'igo.geo.directionsForm.drivingOptions' | translate}}\"\r\n            (selectionChange)=\"changeRoute()\" [(ngModel)]=\"activeDirection\">\r\n            <mat-option *ngFor=\"let direction of directions; let cnt = index;\" [value]=\"direction\">\r\n                Option {{cnt + 1}} : {{formatDistance(direction.distance)}}\r\n                ({{formatDuration(direction.duration)}})\r\n            </mat-option>\r\n        </mat-select>\r\n    </mat-form-field>\r\n\r\n    <mat-divider *ngIf=\"directions && directions.length === 0\"></mat-divider>\r\n\r\n    <mat-list (mouseleave)=\"onStepsListBlur()\">\r\n        <h2 mat-header class=\"igo-route-title mat-typography\">{{activeDirection.title}}</h2>\r\n        <h2 mat-subheader>{{formatDistance(activeDirection.distance)}}, {{formatDuration(activeDirection.duration)}}</h2>\r\n        <mat-list-item class=\"igo-steps\" \r\n            (mouseenter)=\"showSegment(step)\" \r\n            (click)=\"showSegment(step,true)\" \r\n            *ngFor=\"let step of activeDirection.steps; let cnt = index;\" igoListItem>\r\n            <mat-icon [ngClass]=\"formatStep(step,cnt).cssClass\" mat-list-icon svgIcon=\"{{formatStep(step,cnt).image}}\">\r\n            </mat-icon>\r\n\r\n            <h4 mat-line>{{cnt +1}}. {{formatStep(step,cnt).instruction}}</h4>\r\n            <h4 mat-line class=\"right\">{{formatDistance(step.distance)}}</h4>\r\n        </mat-list-item>\r\n\r\n        <mat-divider></mat-divider>\r\n\r\n    </mat-list>\r\n\r\n</div>","import { ChangeDetectorRef, Component, Input, OnDestroy, OnInit } from '@angular/core';\r\nimport { LanguageService } from '@igo2/core';\r\nimport { Subscription } from 'rxjs';\r\nimport { debounceTime } from 'rxjs/operators';\r\n\r\nimport { Direction, FeatureWithStep, IgoStep } from '../shared/directions.interface';\r\nimport { formatDistance, formatDuration, formatInstruction } from '../shared/directions.utils';\r\nimport { RoutesFeatureStore, StepFeatureStore } from '../shared/store';\r\n\r\nimport olFeature from 'ol/Feature';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport * as olGeom from 'ol/geom';\r\n\r\nimport { FeatureGeometry } from '../../feature/shared/feature.interfaces';\r\nimport { FEATURE } from '../../feature/shared/feature.enums';\r\nimport { DirectionType } from '../shared/directions.enum';\r\n\r\n@Component({\r\n  selector: 'igo-directions-results',\r\n  templateUrl: './directions-results.component.html',\r\n  styleUrls: ['./directions-results.component.scss']\r\n})\r\nexport class DirectionsResultsComponent implements OnInit, OnDestroy {\r\n\r\n  public activeDirection: Direction;\r\n  public directions: Direction[];\r\n\r\n  private entities$$: Subscription;\r\n\r\n  @Input() routesFeatureStore: RoutesFeatureStore;\r\n  @Input() stepFeatureStore: StepFeatureStore;\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private cdRef: ChangeDetectorRef\r\n  ) { }\r\n\r\n  ngOnInit(): void {\r\n    this.entities$$ = this.routesFeatureStore.entities$\r\n      .pipe(debounceTime(200))\r\n      .subscribe(entities => {\r\n        const activeFeatureWithDirection = entities.find(entity => entity.properties.active);\r\n        this.directions = entities.map(entity => entity.properties.direction);\r\n        if (activeFeatureWithDirection) {\r\n          this.activeDirection = activeFeatureWithDirection.properties.direction;\r\n        } else {\r\n          this.activeDirection = undefined;\r\n        }\r\n        this.cdRef.detectChanges();\r\n      });\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this.entities$$.unsubscribe();\r\n  }\r\n\r\n  changeRoute() {\r\n    this.routesFeatureStore.entities$.value.map(entity =>\r\n      entity.properties.active = !entity.properties.active\r\n    );\r\n    this.routesFeatureStore.layer.ol.getSource().getFeatures().map(feature =>\r\n      feature.set('active', !feature.get('active'))\r\n    );\r\n  }\r\n\r\n  formatDistance(distance: number): string {\r\n    return formatDistance(distance);\r\n  }\r\n\r\n  formatDuration(duration: number): string {\r\n    return formatDuration(duration);\r\n  }\r\n\r\n  formatStep(step, cnt) {\r\n    return formatInstruction(\r\n      step.maneuver.type,\r\n      step.maneuver.modifier,\r\n      step.name,\r\n      step.maneuver.bearing_after,\r\n      cnt,\r\n      step.maneuver.exit,\r\n      this.languageService,\r\n      cnt === this.activeDirection.steps.length - 1\r\n    );\r\n  }\r\n\r\n  onStepsListBlur() {\r\n    this.stepFeatureStore.clear();\r\n  }\r\n\r\n  showSegment(step: IgoStep, zoomToExtent = false) {\r\n    this.showRouteSegmentGeometry(step, zoomToExtent);\r\n  }\r\n\r\n  showRouteSegmentGeometry(step: IgoStep, zoomToExtent = false) {\r\n\r\n    const coordinates = step.geometry.coordinates;\r\n    const vertexId = 'vertex';\r\n    const geometry4326 = new olGeom.LineString(coordinates);\r\n    const geometryMapProjection = geometry4326.transform(\r\n      'EPSG:4326',\r\n      this.stepFeatureStore.layer.map.projection\r\n    );\r\n    const routeSegmentCoordinates = (geometryMapProjection as any).getCoordinates();\r\n    const lastPoint = routeSegmentCoordinates[0];\r\n\r\n    const geometry = new olGeom.Point(lastPoint);\r\n    const feature = new olFeature({ geometry });\r\n\r\n    const geojsonGeom = new OlGeoJSON().writeGeometryObject(geometry, {\r\n      featureProjection: this.stepFeatureStore.layer.map.projection,\r\n      dataProjection: this.stepFeatureStore.layer.map.projection\r\n    }) as FeatureGeometry;\r\n\r\n    const previousVertex = this.stepFeatureStore.get(vertexId);\r\n    const previousVertexRevision = previousVertex\r\n      ? previousVertex.meta.revision\r\n      : 0;\r\n\r\n    const stepFeature: FeatureWithStep = {\r\n      type: FEATURE,\r\n      geometry: geojsonGeom,\r\n      projection: this.stepFeatureStore.layer.map.projection,\r\n      properties: {\r\n        id: vertexId,\r\n        step,\r\n        type: DirectionType.Vertex\r\n      },\r\n      meta: {\r\n        id: vertexId,\r\n        revision: previousVertexRevision + 1\r\n      },\r\n      ol: feature\r\n    };\r\n    this.stepFeatureStore.update(stepFeature);\r\n    if (zoomToExtent) {\r\n      this.stepFeatureStore.layer.map.viewController.zoomToExtent(feature.getGeometry().getExtent() as [number, number, number, number]);\r\n    }\r\n  }\r\n\r\n}\r\n","import { ChangeDetectorRef, Component, Input, OnDestroy, OnInit } from '@angular/core';\r\n\r\nimport { debounceTime, distinctUntilChanged, map } from 'rxjs/operators';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { EntityStoreWatcher } from '@igo2/common';\r\n\r\nimport * as olCondition from 'ol/events/condition';\r\nimport * as olInteraction from 'ol/interaction';\r\nimport * as olProj from 'ol/proj';\r\nimport { TranslateEvent } from 'ol/interaction/Translate';\r\nimport Collection from 'ol/Collection';\r\nimport { SelectEvent } from 'ol/interaction/Select';\r\n\r\nimport { DirectionOptions, FeatureWithStopProperties, Stop } from './shared/directions.interface';\r\nimport { Subject, Subscription } from 'rxjs';\r\nimport { addDirectionToRoutesFeatureStore, addStopToStopsFeatureStore, addStopToStore,\r\n  initRoutesFeatureStore, initStepFeatureStore, initStopsFeatureStore, updateStoreSorting } from './shared/directions.utils';\r\nimport { Feature } from '../feature/shared/feature.interfaces';\r\nimport { DirectionsService } from './shared/directions.service';\r\nimport { DirectionType, ProposalType } from './shared/directions.enum';\r\nimport { roundCoordTo, stringToLonLat } from '../map';\r\nimport { SearchService } from '../search/shared/search.service';\r\nimport { ChangeUtils, ObjectUtils } from '@igo2/utils';\r\nimport { RoutesFeatureStore, StepFeatureStore, StopsFeatureStore, StopsStore } from './shared/store';\r\nimport { FeatureStoreLoadingStrategy } from '../feature/shared/strategies/loading';\r\nimport { Research, SearchResult } from '../search/shared/search.interfaces';\r\nimport { QueryService } from '../query/shared/query.service';\r\n\r\n@Component({\r\n  selector: 'igo-directions',\r\n  templateUrl: './directions.component.html',\r\n  styleUrls: ['./directions.component.scss']\r\n})\r\nexport class DirectionsComponent implements OnInit, OnDestroy {\r\n\r\n  private watcher: EntityStoreWatcher<Stop>;\r\n\r\n  public projection: string = 'EPSG:4326';\r\n\r\n  private zoomRoute$$: Subscription;\r\n  private storeEmpty$$: Subscription;\r\n  private storeChange$$: Subscription;\r\n  private routesQueries$$: Subscription[] = [];\r\n\r\n  private selectStopInteraction: olInteraction.Select;\r\n  private translateStop: olInteraction.Translate;\r\n  private selectedRoute;\r\n  private focusOnStop: boolean = false;\r\n  private isTranslating: boolean = false;\r\n\r\n  public previousStops: Stop[] = [];\r\n\r\n  private searchs$$: Subscription[] = [];\r\n\r\n  @Input() contextUri: string;\r\n  @Input() stopsStore: StopsStore;\r\n  @Input() stopsFeatureStore: StopsFeatureStore;\r\n  @Input() routesFeatureStore: RoutesFeatureStore;\r\n  @Input() stepFeatureStore: StepFeatureStore;\r\n  @Input() debounce: number = 200;\r\n  @Input() length: number = 2;\r\n  @Input() coordRoundedDecimals: number = 6;\r\n  @Input() zoomToActiveRoute$: Subject<void> = new Subject();\r\n\r\n  constructor(\r\n    private cdRef: ChangeDetectorRef,\r\n    private languageService: LanguageService,\r\n    private directionsService: DirectionsService,\r\n    private searchService: SearchService,\r\n    private queryService: QueryService\r\n  ) { }\r\n\r\n\r\n  ngOnInit(): void {\r\n    this.queryService.queryEnabled = false;\r\n    this.initEntityStores();\r\n    setTimeout(() => {\r\n      initStopsFeatureStore(this.stopsFeatureStore, this.languageService);\r\n      initRoutesFeatureStore(this.routesFeatureStore, this.languageService);\r\n      initStepFeatureStore(this.stepFeatureStore);\r\n      this.initOlInteraction();\r\n    }, 1);\r\n\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this.queryService.queryEnabled = true;\r\n    this.storeEmpty$$.unsubscribe();\r\n    this.storeChange$$.unsubscribe();\r\n    this.routesQueries$$.map((u) => u.unsubscribe());\r\n    this.zoomRoute$$.unsubscribe();\r\n    this.freezeStores();\r\n  }\r\n\r\n  private freezeStores() {\r\n    this.stopsFeatureStore.layer.map.ol.removeInteraction(this.selectStopInteraction);\r\n    this.stopsFeatureStore.layer.map.ol.removeInteraction(this.translateStop);\r\n    this.routesFeatureStore.layer.map.ol.removeInteraction(this.selectedRoute);\r\n    this.stopsFeatureStore.deactivateStrategyOfType(FeatureStoreLoadingStrategy);\r\n    this.routesFeatureStore.deactivateStrategyOfType(FeatureStoreLoadingStrategy);\r\n    this.stepFeatureStore.deactivateStrategyOfType(FeatureStoreLoadingStrategy);\r\n  }\r\n\r\n  private initEntityStores() {\r\n    this.watcher = new EntityStoreWatcher(this.stopsStore, this.cdRef);\r\n    this.monitorEmptyEntityStore();\r\n    this.monitorEntityStoreChange();\r\n    this.monitorActiveRouteZoom();\r\n  }\r\n\r\n  private monitorActiveRouteZoom() {\r\n    this.zoomRoute$$ = this.zoomToActiveRoute$.subscribe(() => {\r\n      if (this.routesFeatureStore.count >= 1) {\r\n        const activeRoute = this.routesFeatureStore.all().find(route => route.properties.active);\r\n\r\n        if (activeRoute) {\r\n          activeRoute.ol.getGeometry();\r\n          const routeExtent = activeRoute.ol.getGeometry().getExtent();\r\n          this.routesFeatureStore.layer.map.viewController.zoomToExtent(routeExtent as [number, number, number, number]);\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  private initOlInteraction() {\r\n    this.selectStopInteraction = new olInteraction.Select({\r\n      layers: [this.stopsFeatureStore.layer.ol],\r\n      hitTolerance: 7,\r\n      condition: (event) => {\r\n        return event.type === 'pointermove' && !event.dragging;\r\n      }\r\n    });\r\n\r\n    this.translateStop = new olInteraction.Translate({\r\n      features: this.selectStopInteraction.getFeatures()\r\n    });\r\n    this.translateStop.on('translating', (evt: TranslateEvent) => {\r\n      this.isTranslating = true;\r\n      this.executeStopTranslation(evt.features);\r\n    });\r\n    this.translateStop.on('translateend', (evt: TranslateEvent) => {\r\n      this.isTranslating = false;\r\n      this.executeStopTranslation(evt.features);\r\n    });\r\n\r\n    this.selectedRoute = new olInteraction.Select({\r\n      layers: [this.routesFeatureStore.layer.ol],\r\n      condition: olCondition.click,\r\n      hitTolerance: 7,\r\n      filter: feature => {\r\n        return feature.get('type') === DirectionType.Route &&\r\n          feature.get('active') &&\r\n          !this.isTranslating;\r\n      }\r\n    });\r\n    this.selectedRoute.on('select', (evt: SelectEvent) => {\r\n      if (this.focusOnStop === false) {\r\n        const selectCoordinates = roundCoordTo(\r\n          olProj.transform(\r\n            (evt as any).mapBrowserEvent.coordinate,\r\n            this.routesFeatureStore.layer.map.projection,\r\n            this.projection\r\n          ) as [number, number], this.coordRoundedDecimals);\r\n        const addedStop = addStopToStore(this.stopsStore);\r\n        addedStop.text = selectCoordinates.join(',');\r\n        addedStop.coordinates = [selectCoordinates[0], selectCoordinates[1]];\r\n      }\r\n    });\r\n\r\n    this.stopsFeatureStore.layer.map.ol.addInteraction(this.selectStopInteraction);\r\n    this.stopsFeatureStore.layer.map.ol.addInteraction(this.translateStop);\r\n    this.routesFeatureStore.layer.map.ol.addInteraction(this.selectedRoute);\r\n  }\r\n\r\n  onStopInputHasFocusChange(stopInputHasFocus: boolean) {\r\n    stopInputHasFocus ?\r\n      this.routesFeatureStore.layer.map.ol.removeInteraction(this.selectedRoute) :\r\n      this.routesFeatureStore.layer.map.ol.addInteraction(this.selectedRoute);\r\n  }\r\n\r\n  private executeStopTranslation(\r\n    features: Collection<any>\r\n  ) {\r\n    if (features.getLength() === 0) {\r\n      return;\r\n    }\r\n    const firstFeature = features.getArray()[0];\r\n    const translatedStopId = firstFeature.getId();\r\n\r\n    const translationCoordinates = olProj.transform(\r\n      firstFeature.getGeometry().getCoordinates(),\r\n      this.stopsFeatureStore.layer.map.projection,\r\n      this.projection\r\n    );\r\n    const translatedStop = this.stopsStore.get(translatedStopId);\r\n    const roundedCoord = roundCoordTo(translationCoordinates as [number, number], this.coordRoundedDecimals);\r\n    translatedStop.coordinates = roundedCoord;\r\n    translatedStop.text = roundedCoord.join(',');\r\n    this.stopsStore.update(translatedStop);\r\n  }\r\n\r\n\r\n  private monitorEmptyEntityStore() {\r\n    // Watch if the store is empty to reset it\r\n    this.storeEmpty$$ = this.stopsStore.count$\r\n      .pipe(\r\n        distinctUntilChanged()\r\n      ).subscribe((count) => {\r\n        if (count < 2) {\r\n          addStopToStore(this.stopsStore);\r\n          if (this.stopsStore.count === 2) {\r\n            this.stopsStore.storeInitialized$.next(true);\r\n            return;\r\n          }\r\n          this.stopsStore.storeInitialized$.next(false);\r\n        }\r\n        this.routesQueries$$.map((u) => u.unsubscribe());\r\n      });\r\n  }\r\n\r\n  private monitorEntityStoreChange() {\r\n    this.storeChange$$ = this.stopsStore.entities$\r\n      .pipe(debounceTime(this.debounce))\r\n      .subscribe((stops: Stop[]) => {\r\n        this.handleStopDiff(stops);\r\n        updateStoreSorting(this.stopsStore);\r\n        this.handleStopsFeature();\r\n        this.getRoutes(this.isTranslating);\r\n      });\r\n  }\r\n\r\n  cancelSearch() {\r\n    this.searchs$$.map(s => s.unsubscribe());\r\n  }\r\n\r\n  private handleStopDiff(stops: Stop[]) {\r\n    const simplifiedStops = stops.map((stop: Stop) => {\r\n      return ObjectUtils.removeUndefined({ ...{ id: stop.id, text: stop.text, coordinates: stop.coordinates } });\r\n    });\r\n    const diff = ChangeUtils.findChanges(this.previousStops, simplifiedStops, ['coordinates']);\r\n    const stopIdToProcess = diff.added.concat(diff.modified);\r\n    if (stopIdToProcess) {\r\n      stopIdToProcess.map((change) => {\r\n        const changedStop = (change.newValue as Stop);\r\n        if (changedStop) {\r\n          const stop: Stop = this.stopsStore.get(changedStop.id);\r\n          const term = stop.text;\r\n          if (!term || term.length === 0) {\r\n            return;\r\n          }\r\n          const response = stringToLonLat(term, this.stopsFeatureStore.layer.map.projection);\r\n          let researches: Research[];\r\n          let isCoord = false;\r\n          if (response.lonLat) {\r\n            isCoord = true;\r\n          }\r\n          researches = this.searchService.search(term, { searchType: 'Feature' });\r\n          this.cancelSearch();\r\n          const requests$ = researches.map(res => res.request\r\n            .pipe(map((results: SearchResult[]) => results.filter(r =>\r\n              isCoord ? r.data.geometry.type === 'Point' && r.data.geometry : r.data.geometry)))\r\n\r\n          );\r\n          this.searchs$$ = requests$.map((request) => {\r\n            return request.pipe(map((results: SearchResult[]) => results.filter(r =>\r\n              isCoord ? r.data.geometry.type === 'Point' && r.data.geometry : r.data.geometry)))\r\n              .subscribe((res: SearchResult[]) => {\r\n                if (res.length > 0) {\r\n                  const source = res[0].source;\r\n                  const meta = res[0].meta;\r\n                  const results = res.map(r => r.data);\r\n                  if (!stop.searchProposals) {\r\n                    stop.searchProposals = [];\r\n                  }\r\n                  stop.searchProposals = stop.searchProposals.filter(sp => sp.type === (isCoord ? ProposalType.Coord : ProposalType.Text));\r\n                  let storedSource = stop.searchProposals.find(sp => sp.source === source);\r\n                  if (storedSource) {\r\n                    storedSource.results = results;\r\n                  } else {\r\n                    stop.searchProposals.push({\r\n                      type: isCoord ? ProposalType.Coord : ProposalType.Text,\r\n                      source,\r\n                      meta,\r\n                      results\r\n                    });\r\n                  }\r\n                }\r\n                this.cdRef.detectChanges();\r\n              });\r\n          });\r\n        }\r\n      });\r\n    }\r\n    this.previousStops = simplifiedStops;\r\n  }\r\n\r\n  private handleStopsFeature() {\r\n    const stops = this.stopsStore.all();\r\n    const stopsWithCoordinates = stops.filter(stop => stop.coordinates);\r\n    stopsWithCoordinates.map(stop => this.addStopOverlay(stop));\r\n    this.stopsFeatureStore.all().map(\r\n      (stopFeature: Feature<FeatureWithStopProperties>) => {\r\n        if (!this.stopsStore.get(stopFeature.properties.id)) {\r\n          this.stopsFeatureStore.delete(stopFeature);\r\n        }\r\n      });\r\n    const stopsWithoutCoordinates = stops.filter(stop => !stop.coordinates);\r\n    stopsWithoutCoordinates.map(stop => {\r\n      const stopFeature = this.stopsFeatureStore.get(stop.id);\r\n      if (stopFeature) {\r\n        this.stopsFeatureStore.delete(stopFeature);\r\n      }\r\n    });\r\n  }\r\n\r\n  private getRoutes(isOverview: boolean = false) {\r\n    const stopsWithCoordinates = this.stopsStore.view\r\n      .all()\r\n      .filter(stop => stop.coordinates);\r\n    if (stopsWithCoordinates.length < 2) {\r\n      this.routesFeatureStore.deleteMany(this.routesFeatureStore.all());\r\n      return;\r\n    }\r\n\r\n    const roundedCoordinates = stopsWithCoordinates.map((stop) => {\r\n      const roundedCoord = roundCoordTo(stop.coordinates, this.coordRoundedDecimals);\r\n      return roundedCoord;\r\n    });\r\n    const overviewDirectionsOptions: DirectionOptions = {\r\n      overview: true,\r\n      steps: false,\r\n      alternatives: false,\r\n      continue_straight: false\r\n    };\r\n    this.routesQueries$$.map((u) => u.unsubscribe());\r\n    const routeResponse = this.directionsService.route(\r\n      roundedCoordinates,\r\n      isOverview ? overviewDirectionsOptions : undefined\r\n    );\r\n    if (routeResponse) {\r\n      routeResponse.map(res =>\r\n        this.routesQueries$$.push(\r\n          res.subscribe(directions => {\r\n            this.routesFeatureStore.deleteMany(this.routesFeatureStore.all());\r\n            directions.map(direction =>\r\n              addDirectionToRoutesFeatureStore(\r\n                this.routesFeatureStore,\r\n                direction,\r\n                this.projection,\r\n                direction === directions[0] ? true : false)\r\n            );\r\n          })\r\n        )\r\n      );\r\n    }\r\n  }\r\n\r\n  public addStopOverlay(stop: Stop) {\r\n    addStopToStopsFeatureStore(stop, this.stopsStore, this.stopsFeatureStore, this.projection, this.languageService);\r\n  }\r\n}\r\n","<igo-directions-buttons [contextUri]=\"contextUri\" [zoomToActiveRoute$]=\"zoomToActiveRoute$\" [routesFeatureStore]=\"routesFeatureStore\" [stopsStore]=\"stopsStore\"></igo-directions-buttons>\r\n\r\n<igo-directions-inputs (stopInputHasFocus)=\"onStopInputHasFocusChange($event)\" [coordRoundedDecimals]=\"coordRoundedDecimals\" [projection]=\"projection\" [stopsFeatureStore]=\"stopsFeatureStore\" [stopsStore]=\"stopsStore\" [debounce]=\"debounce\" [length]=\"length\"></igo-directions-inputs>\r\n<br>\r\n<igo-directions-results [stepFeatureStore]=\"stepFeatureStore\" [routesFeatureStore]=\"routesFeatureStore\"></igo-directions-results>","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\n\r\nimport { MatAutocompleteModule } from '@angular/material/autocomplete';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatOptionModule } from '@angular/material/core';\r\nimport { MatDividerModule } from '@angular/material/divider';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { provideDirectionsSourceService } from './shared/directions-source.service';\r\nimport { DragDropModule } from '@angular/cdk/drag-drop';\r\nimport { DirectionsInputsComponent } from './directions-inputs/directions-inputs.component';\r\nimport { DirectionsComponent } from './directions.component';\r\nimport { DirectionsButtonsComponent } from './directions-buttons/directions-buttons.component';\r\nimport { DirectionsResultsComponent } from './directions-results/directions-results.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    DragDropModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatListModule,\r\n    MatDividerModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatOptionModule,\r\n    MatSelectModule,\r\n    MatTooltipModule,\r\n    MatAutocompleteModule,\r\n    IgoLanguageModule\r\n  ],\r\n  exports: [\r\n    DirectionsComponent,\r\n    DirectionsInputsComponent,\r\n    DirectionsButtonsComponent,\r\n    DirectionsResultsComponent\r\n  ],\r\n  declarations: [\r\n     DirectionsComponent,\r\n    DirectionsInputsComponent,\r\n    DirectionsButtonsComponent,\r\n    DirectionsResultsComponent\r\n  ],\r\n  providers: [provideDirectionsSourceService()]\r\n})\r\nexport class IgoDirectionsModule {\r\n  static forRoot(): ModuleWithProviders<IgoDirectionsModule> {\r\n    return {\r\n      ngModule: IgoDirectionsModule\r\n    };\r\n  }\r\n}\r\n","import { SearchSource } from './sources/source';\r\nimport { SearchSourceService } from './search-source.service';\r\n\r\n/**\r\n * Search source factory\r\n * @ignore\r\n */\r\nexport function searchSourceServiceFactory(sources: SearchSource[]) {\r\n  return new SearchSourceService(sources);\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the SearchSource service\r\n */\r\nexport function provideSearchSourceService() {\r\n  return {\r\n    provide: SearchSourceService,\r\n    useFactory: searchSourceServiceFactory,\r\n    deps: [SearchSource]\r\n  };\r\n}\r\n","import { Injectable, Inject, Injector } from '@angular/core';\r\nimport { HttpClient, HttpParams, HttpParameterCodec } from '@angular/common/http';\r\n\r\nimport { Observable, of, BehaviorSubject } from 'rxjs';\r\nimport { map, catchError } from 'rxjs/operators';\r\n\r\nimport { AuthService } from '@igo2/auth';\r\nimport { LanguageService, StorageService } from '@igo2/core';\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport pointOnFeature from '@turf/point-on-feature';\r\n\r\nimport { FEATURE, Feature } from '../../../feature';\r\nimport { GoogleLinks } from './../../../utils/googleLinks';\r\n\r\nimport { SearchResult } from '../search.interfaces';\r\nimport { SearchSource, TextSearch, ReverseSearch } from './source';\r\nimport {\r\n  SearchSourceOptions,\r\n  TextSearchOptions,\r\n  ReverseSearchOptions\r\n} from './source.interfaces';\r\nimport {\r\n  IChercheData,\r\n  IChercheResponse,\r\n  IChercheReverseData,\r\n  IChercheReverseResponse\r\n} from './icherche.interfaces';\r\nimport { computeTermSimilarity } from '../search.utils';\r\nimport { Cacheable } from 'ts-cacheable';\r\n\r\n@Injectable()\r\nexport class IChercheSearchResultFormatter {\r\n  constructor(private languageService: LanguageService) {}\r\n\r\n  formatResult(result: SearchResult<Feature>): SearchResult<Feature> {\r\n    return result;\r\n  }\r\n}\r\n\r\n// Fix the \"+\" is replaced with space \" \" in a query string\r\n// https://github.com/angular/angular/issues/11058\r\nexport class IgoHttpParameterCodec implements HttpParameterCodec {\r\n  encodeKey(key: string): string {\r\n    return encodeURIComponent(key);\r\n  }\r\n\r\n  encodeValue(value: string): string {\r\n    return encodeURIComponent(value);\r\n  }\r\n\r\n  decodeKey(key: string): string {\r\n    return decodeURIComponent(key);\r\n  }\r\n\r\n  decodeValue(value: string): string {\r\n    return decodeURIComponent(value);\r\n  }\r\n}\r\n\r\n/**\r\n * ICherche search source\r\n */\r\n@Injectable()\r\nexport class IChercheSearchSource extends SearchSource implements TextSearch {\r\n  static id = 'icherche';\r\n  static type = FEATURE;\r\n  static propertiesBlacklist: string[] = [];\r\n  title$: BehaviorSubject<string> = new BehaviorSubject<string>('');\r\n\r\n  private hashtagsLieuxToKeep = [];\r\n\r\n  get title(): string {\r\n    return this.title$.getValue();\r\n  }\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private languageService: LanguageService,\r\n    storageService: StorageService,\r\n    @Inject('options') options: SearchSourceOptions,\r\n    @Inject(IChercheSearchResultFormatter)\r\n    private formatter: IChercheSearchResultFormatter,\r\n    injector: Injector\r\n  ) {\r\n    super(options, storageService);\r\n\r\n    this.languageService.translate\r\n      .get(this.options.title)\r\n      .subscribe((title) => this.title$.next(title));\r\n\r\n    const authService = injector.get(AuthService);\r\n    if (this.settings.length) {\r\n      if (!authService) {\r\n        this.getAllowedTypes();\r\n      } else {\r\n        authService.authenticate$.subscribe(() => {\r\n          this.getAllowedTypes();\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  getId(): string {\r\n    return IChercheSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return IChercheSearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    const limit =\r\n      this.options.params && this.options.params.limit\r\n        ? Number(this.options.params.limit)\r\n        : undefined;\r\n    const ecmax =\r\n      this.options.params && this.options.params.ecmax\r\n        ? Number(this.options.params.ecmax)\r\n        : undefined;\r\n\r\n    const types = this.options.params?.type\r\n        ? this.options.params.type.replace(/\\s/g, '').toLowerCase().split(',')\r\n        : [\r\n            'adresses',\r\n            'codes-postaux',\r\n            'routes',\r\n            'intersections',\r\n            'municipalites',\r\n            'mrc',\r\n            'regadmin',\r\n            'lieux'\r\n          ];\r\n\r\n    return {\r\n      title: 'igo.geo.search.icherche.name',\r\n      searchUrl: 'https://geoegl.msp.gouv.qc.ca/apis/icherche',\r\n      settings: [\r\n        {\r\n          type: 'checkbox',\r\n          title: 'results type',\r\n          name: 'type',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.icherche.type.address',\r\n              value: 'adresses',\r\n              enabled: types.indexOf('adresses') !== -1,\r\n              hashtags: ['adresse']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.oldAddress',\r\n              value: 'anciennes-adresses',\r\n              enabled: types.indexOf('anciennes-adresses') !== -1,\r\n              hashtags: ['anciennes-adresses']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.postalCode',\r\n              value: 'codes-postaux',\r\n              enabled: types.indexOf('codes-postaux') !== -1,\r\n              hashtags: ['code-postal']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.road',\r\n              value: 'routes',\r\n              enabled: types.indexOf('routes') !== -1,\r\n              hashtags: ['route']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.intersection',\r\n              value: 'intersections',\r\n              enabled: types.indexOf('intersections') !== -1,\r\n              hashtags: ['intersection', '+']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.city',\r\n              value: 'municipalites',\r\n              enabled: types.indexOf('municipalites') !== -1,\r\n              hashtags: ['municipalit', 'mun']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.oldCity',\r\n              value: 'anciennes-municipalites',\r\n              enabled: types.indexOf('anciennes-municipalites') !== -1,\r\n              hashtags: ['anciennes-municipalites']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.mrc',\r\n              value: 'mrc',\r\n              enabled: types.indexOf('mrc') !== -1,\r\n              hashtags: ['mrc']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.regadmin',\r\n              value: 'regadmin',\r\n              enabled: types.indexOf('regadmin') !== -1,\r\n              hashtags: ['rgion-administrative', 'regadmin']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.entreprise',\r\n              value: 'entreprises',\r\n              enabled: types.indexOf('entreprises') !== -1,\r\n              available: false,\r\n              hashtags: ['entreprise']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.place',\r\n              value: 'lieux',\r\n              enabled: types.indexOf('lieux') !== -1,\r\n              hashtags: ['lieu']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.exit',\r\n              value: 'sorties-autoroute',\r\n              enabled: types.indexOf('sorties-autoroute') !== -1,\r\n              hashtags: ['sortie', 'sorties', 'exit']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.km',\r\n              value: 'bornes-km',\r\n              enabled: types.indexOf('bornes-km') !== -1,\r\n              hashtags: ['borne', 'bornes', 'repre', 'km']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.gcc',\r\n              value: 'bornes-gcc',\r\n              enabled: types.indexOf('bornes-gcc') !== -1,\r\n              hashtags: ['borne', 'bornes', 'repre', 'gcc', 'ccg']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.cn',\r\n              value: 'bornes-cn',\r\n              enabled: types.indexOf('bornes-cn') !== -1,\r\n              hashtags: ['borne', 'bornes', 'cn']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.sumi',\r\n              value: 'bornes-sumi',\r\n              enabled: types.indexOf('bornes-sumi') !== -1,\r\n              hashtags: ['borne', 'bornes', 'sumi']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.hq',\r\n              value: 'hq',\r\n              enabled: types.indexOf('hq') !== -1,\r\n              hashtags: ['hq']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.cadastre',\r\n              value: 'cadastre',\r\n              enabled: types.indexOf('cadastre') !== -1,\r\n              hashtags: ['cadastre']\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'results limit',\r\n          name: 'limit',\r\n          values: [\r\n            {\r\n              title: '1',\r\n              value: 1,\r\n              enabled: limit === 1\r\n            },\r\n            {\r\n              title: '5',\r\n              value: 5,\r\n              enabled: limit === 5 || !limit\r\n            },\r\n            {\r\n              title: '10',\r\n              value: 10,\r\n              enabled: limit === 10\r\n            },\r\n            {\r\n              title: '25',\r\n              value: 25,\r\n              enabled: limit === 25\r\n            },\r\n            {\r\n              title: '50',\r\n              value: 50,\r\n              enabled: limit === 50\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'ecmax',\r\n          name: 'ecmax',\r\n          values: [\r\n            {\r\n              title: '10 %',\r\n              value: 10,\r\n              enabled: ecmax === 10\r\n            },\r\n            {\r\n              title: '30 %',\r\n              value: 30,\r\n              enabled: ecmax === 30 || !ecmax\r\n            },\r\n            {\r\n              title: '50 %',\r\n              value: 50,\r\n              enabled: ecmax === 50\r\n            },\r\n            {\r\n              title: '75 %',\r\n              value: 75,\r\n              enabled: ecmax === 75\r\n            },\r\n            {\r\n              title: '100 %',\r\n              value: 100,\r\n              enabled: ecmax === 100\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'restrictExtent',\r\n          name: 'loc',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.icherche.restrictExtent.map',\r\n              value: 'true',\r\n              enabled: false\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.restrictExtent.quebec',\r\n              value: 'false',\r\n              enabled: true\r\n            }\r\n          ]\r\n        }\r\n      ]\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a location by name or keyword\r\n   * @param term Location name or keyword\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  search(\r\n    term: string,\r\n    options?: TextSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    const params = this.computeRequestParams(term, options || {});\r\n    if (!params.get('type').length) {\r\n      return of([]);\r\n    }\r\n    this.options.params.page = params.get('page') || '1';\r\n\r\n    return this.http.get(`${this.searchUrl}/geocode`, { params }).pipe(\r\n      map((response: IChercheResponse) => this.extractResults(response, term)),\r\n      catchError((err) => {\r\n        err.error.toDisplay = true;\r\n        err.error.title = this.languageService.translate.instant(\r\n          this.getDefaultOptions().title\r\n        );\r\n        throw err;\r\n      })\r\n    );\r\n  }\r\n\r\n  private getAllowedTypes() {\r\n    return this.http\r\n      .get(`${this.searchUrl}/types`)\r\n      .subscribe((types: string[]) => {\r\n        const typeSetting = this.settings.find((s) => s.name === 'type');\r\n        typeSetting.values.forEach((v) => {\r\n          const regex = new RegExp(`^${v.value}(\\\\.|$)`);\r\n          const typesMatched = types.filter((value) => regex.test(value));\r\n          v.available = typesMatched.length > 0;\r\n          if (v.value === 'lieux') {\r\n            this.hashtagsLieuxToKeep = [\r\n              ...(new Set(\r\n                typesMatched\r\n                  .map((t) => t.split('.'))\r\n                  .reduce((a, b) => a.concat(b))\r\n                  .filter((t) => t !== 'lieux')\r\n              ) as any)\r\n            ];\r\n          }\r\n        });\r\n        this.setParamFromSetting(typeSetting, false);\r\n      });\r\n  }\r\n\r\n  private computeRequestParams(\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): HttpParams {\r\n    const queryParams: any = Object.assign(\r\n      {\r\n        geometry: true,\r\n        bbox: true,\r\n        icon: true,\r\n        type:\r\n          'adresses,codes-postaux,municipalites,mrc,regadmin,lieux,entreprises,bornes-sumi'\r\n      },\r\n      this.params,\r\n      this.computeOptionsParam(term, options || {}).params,\r\n      {\r\n        q: this.computeTerm(term),\r\n        page: options.page\r\n      }\r\n    );\r\n\r\n    if (queryParams.loc === 'true') {\r\n      const [xMin, yMin, xMax, yMax] = options.extent;\r\n      queryParams.loc = `${xMin},${yMin};${xMax},${yMin};${xMax},${yMax};${xMin},${yMax};${xMin},${yMin}`;\r\n    } else if (queryParams.loc === 'false') {\r\n      delete queryParams.loc;\r\n    }\r\n\r\n    if (/#[A-Za-z]+/.test(queryParams.q)) {\r\n      queryParams.type = 'lieux';\r\n    }\r\n\r\n    return new HttpParams({\r\n      fromObject: ObjectUtils.removeUndefined(queryParams),\r\n      encoder: new IgoHttpParameterCodec()\r\n    });\r\n  }\r\n\r\n  private extractResults(response: IChercheResponse, term: string): SearchResult<Feature>[] {\r\n    return response.features.map((data: IChercheData) => {\r\n      return this.formatter.formatResult(this.dataToResult(data, term, response));\r\n    });\r\n  }\r\n\r\n  private dataToResult(\r\n    data: IChercheData,\r\n    term: string,\r\n    response?: IChercheResponse\r\n  ): SearchResult<Feature> {\r\n    const properties = this.computeProperties(data);\r\n    const id = [this.getId(), properties.type, properties.code].join('.');\r\n\r\n    const titleHtml = data.highlight.title || data.properties.nom;\r\n    const subtitleHtml = data.highlight.title2\r\n      ? ' <small> ' + data.highlight.title2 + '</small>'\r\n      : '';\r\n    const subtitleHtml2 = data.highlight.title3\r\n      ? '<br><small> ' + data.highlight.title3 + '</small>'\r\n      : '';\r\n\r\n    return {\r\n      source: this,\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry: data.geometry,\r\n        extent: data.bbox,\r\n        properties,\r\n        meta: {\r\n          id,\r\n          title: data.properties.nom\r\n        }\r\n      },\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id,\r\n        title: data.properties.nom,\r\n        titleHtml: titleHtml + subtitleHtml + subtitleHtml2,\r\n        icon: data.icon || 'map-marker',\r\n        score: data.score || computeTermSimilarity(term.trim(), data.properties.nom),\r\n        nextPage:\r\n          response.features.length % +this.options.params.limit === 0 &&\r\n          +this.options.params.page < 10\r\n      }\r\n    };\r\n  }\r\n\r\n  private computeProperties(data: IChercheData): { [key: string]: any } {\r\n    const properties = ObjectUtils.removeKeys(\r\n      data.properties,\r\n      IChercheSearchSource.propertiesBlacklist\r\n    );\r\n\r\n    if (!data.geometry) {\r\n      return Object.assign({ type: data.index }, properties);\r\n    }\r\n\r\n    const googleLinksProperties: {\r\n      GoogleMaps: string;\r\n      GoogleStreetView?: string;\r\n    } = {\r\n      GoogleMaps: ''\r\n    };\r\n\r\n    let googleMaps;\r\n    if (data.geometry.type === 'Point') {\r\n      googleMaps = GoogleLinks.getGoogleMapsCoordLink(\r\n        data.geometry.coordinates[0],\r\n        data.geometry.coordinates[1]\r\n      );\r\n    } else {\r\n      const point = pointOnFeature(data.geometry);\r\n      googleMaps = GoogleLinks.getGoogleMapsCoordLink(\r\n        point.geometry.coordinates[0],\r\n        point.geometry.coordinates[1]\r\n      );\r\n    }\r\n\r\n    let googleMapsNom;\r\n    if (data.index === 'routes') {\r\n      googleMapsNom = GoogleLinks.getGoogleMapsNameLink(\r\n        data.properties.nom + ', ' + data.properties.municipalite\r\n      );\r\n    } else if (data.index === 'municipalites') {\r\n      googleMapsNom = GoogleLinks.getGoogleMapsNameLink(\r\n        data.properties.nom + ', ' + 'ville'\r\n      );\r\n    } else if (data.index === 'mrc') {\r\n      googleMapsNom = GoogleLinks.getGoogleMapsNameLink(\r\n        'mrc+' + data.properties.nom\r\n      );\r\n    } else if (data.index === 'regadmin') {\r\n      googleMapsNom = GoogleLinks.getGoogleMapsNameLink(\r\n        data.properties.nom + ',+QC'\r\n      );\r\n    } else {\r\n      googleMapsNom = GoogleLinks.getGoogleMapsNameLink(\r\n        data.properties.nom || data.highlight.title\r\n      );\r\n    }\r\n\r\n    googleLinksProperties.GoogleMaps =\r\n      '<a href=' +\r\n      googleMaps +\r\n      ' target=\"_blank\">' +\r\n      this.languageService.translate.instant('igo.geo.searchByCoord') +\r\n      '</a> <br /> <a href=' +\r\n      googleMapsNom +\r\n      ' target=\"_blank\">' +\r\n      this.languageService.translate.instant('igo.geo.searchByName') +\r\n      '</a>';\r\n\r\n    if (data.geometry.type === 'Point') {\r\n      googleLinksProperties.GoogleStreetView = GoogleLinks.getGoogleStreetViewLink(\r\n        data.geometry.coordinates[0],\r\n        data.geometry.coordinates[1]\r\n      );\r\n    }\r\n\r\n    const routing: {\r\n      Route: string;\r\n    } = {\r\n      Route:\r\n        '<span class=\"routing\"> <u>' +\r\n        this.languageService.translate.instant('igo.geo.seeRouting') +\r\n        '</u> </span>'\r\n    };\r\n\r\n    return Object.assign(\r\n      { type: data.index },\r\n      properties,\r\n      googleLinksProperties,\r\n      routing\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Remove hashtag from query\r\n   * @param term Query with hashtag\r\n   */\r\n  private computeTerm(term: string): string {\r\n    // Keep hashtags for \"lieux\"\r\n    const hashtags = term.match(/(#[A-Za-z]+)/g) || [];\r\n    let keep = false;\r\n    keep = hashtags.some((hashtag) => {\r\n      const hashtagKey = hashtag.substring(1);\r\n      return this.hashtagsLieuxToKeep.some(\r\n        (h) =>\r\n          h\r\n            .toLowerCase()\r\n            .normalize('NFD')\r\n            .replace(/[\\u0300-\\u036f]/g, '') ===\r\n          hashtagKey\r\n            .toLowerCase()\r\n            .normalize('NFD')\r\n            .replace(/[\\u0300-\\u036f]/g, '')\r\n      );\r\n    });\r\n\r\n    if (!keep) {\r\n      term = term.replace(/(#[A-Za-z]+)/g, '');\r\n    }\r\n\r\n    return term.replace(/[^\\w- !\\-\\+\\(\\)\\.\\/,'#]+/g, '');\r\n  }\r\n\r\n  /**\r\n   * Add hashtag to param if valid\r\n   * @param term Query with hashtag\r\n   * @param options TextSearchOptions\r\n   */\r\n  private computeOptionsParam(\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): TextSearchOptions {\r\n    const hashtags = super.getHashtagsValid(term, 'type');\r\n    if (hashtags) {\r\n      options.params = Object.assign(options.params || {}, {\r\n        type: hashtags.join(',')\r\n      });\r\n    }\r\n\r\n    return options;\r\n  }\r\n}\r\n\r\n/**\r\n * IChercheReverse search source\r\n */\r\n@Injectable()\r\nexport class IChercheReverseSearchSource extends SearchSource\r\n  implements ReverseSearch {\r\n  static id = 'icherchereverse';\r\n  static type = FEATURE;\r\n  static propertiesBlacklist: string[] = [];\r\n\r\n  title$: BehaviorSubject<string> = new BehaviorSubject<string>('');\r\n\r\n  get title(): string {\r\n    return this.title$.getValue();\r\n  }\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private languageService: LanguageService,\r\n    storageService: StorageService,\r\n    @Inject('options') options: SearchSourceOptions,\r\n    injector: Injector,\r\n  ) {\r\n    super(options, storageService);\r\n\r\n    this.languageService.translate\r\n      .get(this.options.title)\r\n      .subscribe((title) => this.title$.next(title));\r\n\r\n    const authService = injector.get(AuthService);\r\n    if (this.settings.length) {\r\n      if (!authService) {\r\n        this.getAllowedTypes();\r\n      } else {\r\n        authService.authenticate$.subscribe(() => {\r\n          this.getAllowedTypes();\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  getId(): string {\r\n    return IChercheReverseSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return IChercheReverseSearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    const types =\r\n      this.options.params && this.options.params.type\r\n        ? this.options.params.type.replace(/\\s/g, '').toLowerCase().split(',')\r\n        : ['adresses', 'municipalites', 'mrc', 'regadmin'];\r\n\r\n    return {\r\n      title: 'igo.geo.search.ichercheReverse.name',\r\n      searchUrl: 'https://geoegl.msp.gouv.qc.ca/apis/terrapi',\r\n      settings: [\r\n        {\r\n          type: 'checkbox',\r\n          title: 'results type',\r\n          name: 'type',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.icherche.type.address',\r\n              value: 'adresses',\r\n              enabled: types.indexOf('adresses') !== -1\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.road',\r\n              value: 'routes',\r\n              enabled: types.indexOf('routes') !== -1,\r\n              available: false\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.district',\r\n              value: 'arrondissements',\r\n              enabled: types.indexOf('arrondissements') !== -1\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.city',\r\n              value: 'municipalites',\r\n              enabled: types.indexOf('municipalites') !== -1\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.mrc',\r\n              value: 'mrc',\r\n              enabled: types.indexOf('mrc') !== -1\r\n            },\r\n            {\r\n              title: 'igo.geo.search.icherche.type.regadmin',\r\n              value: 'regadmin',\r\n              enabled: types.indexOf('regadmin') !== -1\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'radius',\r\n          name: 'bufferInput',\r\n          values: [\r\n            {\r\n              title: '100 m',\r\n              value: 100,\r\n              enabled: !this.options.distance || this.options.distance === 100\r\n            },\r\n            {\r\n              title: '500 m',\r\n              value: 500,\r\n              enabled: this.options.distance === 500\r\n            },\r\n            {\r\n              title: '1 km',\r\n              value: 1000,\r\n              enabled: this.options.distance === 1000\r\n            },\r\n            {\r\n              title: '2 km',\r\n              value: 2000,\r\n              enabled: this.options.distance === 2000\r\n            },\r\n            {\r\n              title: '5 km',\r\n              value: 5000,\r\n              enabled: this.options.distance === 5000\r\n            }\r\n          ]\r\n        }\r\n      ]\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a location by coordinates\r\n   * @param lonLat Location coordinates\r\n   * @param distance Search raidus around lonLat\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  reverseSearch(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    const params = this.computeRequestParams(lonLat, options || {});\r\n    if (!params.get('type').length) {\r\n      return of([]);\r\n    }\r\n    return this.http.get(`${this.searchUrl}/locate`, { params }).pipe(\r\n      map((response: IChercheReverseResponse) => {\r\n        return this.extractResults(response);\r\n      })\r\n    );\r\n  }\r\n\r\n  private getAllowedTypes() {\r\n    return this.http\r\n      .get(`${this.searchUrl}/types`)\r\n      .subscribe((types: string[]) => {\r\n        const typeSetting = this.settings.find((s) => s.name === 'type');\r\n        typeSetting.values.forEach((v) => {\r\n          v.available = types.indexOf(v.value as string) > -1;\r\n        });\r\n        this.setParamFromSetting(typeSetting, false);\r\n      });\r\n  }\r\n\r\n  private computeRequestParams(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions\r\n  ): HttpParams {\r\n    if (options.distance || this.options.distance) {\r\n      options.params = Object.assign(options.params || {}, {\r\n        bufferInput: options.distance || this.options.distance\r\n      });\r\n    }\r\n\r\n    return new HttpParams({\r\n      fromObject: Object.assign(\r\n        {\r\n          loc: lonLat.join(','),\r\n          sort: 'distance',\r\n          geometry: true,\r\n          icon: true\r\n        },\r\n        options.params || {},\r\n        this.params\r\n      )\r\n    });\r\n  }\r\n\r\n  private extractResults(\r\n    response: IChercheReverseResponse\r\n  ): SearchResult<Feature>[] {\r\n    return response.features.map((data: IChercheReverseData) => {\r\n      return this.dataToResult(data);\r\n    });\r\n  }\r\n\r\n  private getSubtitle(data: IChercheReverseData) {\r\n    if (!this.settings.length) {\r\n      return '';\r\n    }\r\n    let subtitle = '';\r\n    switch (data.properties.type) {\r\n      case 'arrondissements':\r\n        subtitle = data.properties.municipalite + ' (Arrondissement)';\r\n        break;\r\n      default:\r\n        const typeSetting = this.settings.find((s) => s.name === 'type');\r\n        const type = typeSetting.values.find(\r\n          (t) => t.value === data.properties.type\r\n        );\r\n        if (type) {\r\n          subtitle = this.languageService.translate.instant(type.title);\r\n        }\r\n    }\r\n    return subtitle;\r\n  }\r\n\r\n  private dataToResult(data: IChercheReverseData): SearchResult<Feature> {\r\n    const properties = this.computeProperties(data);\r\n    const extent = this.computeExtent(data);\r\n    const id = [this.getId(), properties.type, properties.code].join('.');\r\n\r\n    const titleHtml = data.properties.nom;\r\n    const subtitleHtml = ' <small> ' + this.getSubtitle(data) + '</small>';\r\n\r\n    return {\r\n      source: this,\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry: data.geometry,\r\n        extent,\r\n        properties,\r\n        meta: {\r\n          id,\r\n          title: data.properties.nom\r\n        }\r\n      },\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id,\r\n        title: data.properties.nom,\r\n        titleHtml: titleHtml + subtitleHtml,\r\n        icon: data.icon || 'map-marker',\r\n        pointerSummaryTitle: this.getSubtitle(data)+ ': ' + data.properties.nom\r\n      }\r\n    };\r\n  }\r\n\r\n  private computeProperties(data: IChercheReverseData): { [key: string]: any } {\r\n    const properties = ObjectUtils.removeKeys(\r\n      data.properties,\r\n      IChercheReverseSearchSource.propertiesBlacklist\r\n    );\r\n\r\n    const routing: {\r\n      Route: string;\r\n    } = {\r\n      Route:\r\n        '<span class=\"routing\"> <u>' +\r\n        this.languageService.translate.instant('igo.geo.seeRouting') +\r\n        '</u> </span>'\r\n    };\r\n\r\n    return Object.assign(properties, routing);\r\n  }\r\n\r\n  private computeExtent(\r\n    data: IChercheReverseData\r\n  ): [number, number, number, number] | undefined {\r\n    return data.bbox\r\n      ? [data.bbox[0], data.bbox[2], data.bbox[1], data.bbox[3]]\r\n      : undefined;\r\n  }\r\n}\r\n","import { Injector } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\n\r\nimport { ConfigService, LanguageService, StorageService } from '@igo2/core';\r\n\r\nimport { SearchSource } from './source';\r\nimport {\r\n  IChercheSearchSource,\r\n  IChercheSearchResultFormatter,\r\n  IChercheReverseSearchSource\r\n} from './icherche';\r\n\r\n/**\r\n * ICherche search result formatter factory\r\n * @ignore\r\n */\r\nexport function defaultIChercheSearchResultFormatterFactory(\r\n  languageService: LanguageService\r\n) {\r\n  return new IChercheSearchResultFormatter(languageService);\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the ICherche search result formatter\r\n */\r\nexport function provideDefaultIChercheSearchResultFormatter() {\r\n  return {\r\n    provide: IChercheSearchResultFormatter,\r\n    useFactory: defaultIChercheSearchResultFormatterFactory,\r\n    deps: [LanguageService]\r\n  };\r\n}\r\n\r\n/**\r\n * ICherche search source factory\r\n * @ignore\r\n */\r\nexport function ichercheSearchSourceFactory(\r\n  http: HttpClient,\r\n  languageService: LanguageService,\r\n  storageService: StorageService,\r\n  config: ConfigService,\r\n  formatter: IChercheSearchResultFormatter,\r\n  injector: Injector\r\n) {\r\n  return new IChercheSearchSource(\r\n    http,\r\n    languageService,\r\n    storageService,\r\n    config.getConfig(`searchSources.${IChercheSearchSource.id}`),\r\n    formatter,\r\n    injector\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the ICherche search source\r\n */\r\nexport function provideIChercheSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: ichercheSearchSourceFactory,\r\n    multi: true,\r\n    deps: [\r\n      HttpClient,\r\n      LanguageService,\r\n      StorageService,\r\n      ConfigService,\r\n      IChercheSearchResultFormatter,\r\n      Injector\r\n    ]\r\n  };\r\n}\r\n\r\n/**\r\n * IChercheReverse search source factory\r\n * @ignore\r\n */\r\nexport function ichercheReverseSearchSourceFactory(\r\n  http: HttpClient,\r\n  languageService: LanguageService,\r\n  storageService: StorageService,\r\n  config: ConfigService,\r\n  injector: Injector\r\n) {\r\n  return new IChercheReverseSearchSource(\r\n    http,\r\n    languageService,\r\n    storageService,\r\n    config.getConfig(`searchSources.${IChercheReverseSearchSource.id}`),\r\n    injector\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the IChercheReverse search source\r\n */\r\nexport function provideIChercheReverseSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: ichercheReverseSearchSourceFactory,\r\n    multi: true,\r\n    deps: [HttpClient, LanguageService, StorageService, ConfigService, Injector]\r\n  };\r\n}\r\n","import { Injectable, Inject } from '@angular/core';\r\nimport { Observable, BehaviorSubject, of } from 'rxjs';\r\nimport * as olproj from 'ol/proj';\r\nimport { fromCircle } from 'ol/geom/Polygon';\r\nimport OlCircle from 'ol/geom/Circle';\r\nimport * as olformat from 'ol/format';\r\n\r\nimport { FEATURE, Feature, FeatureGeometry } from '../../../feature';\r\n\r\nimport { SearchResult } from '../search.interfaces';\r\nimport { SearchSource, ReverseSearch } from './source';\r\nimport { SearchSourceOptions, ReverseSearchOptions } from './source.interfaces';\r\n\r\nimport { LanguageService, StorageService } from '@igo2/core';\r\nimport { GoogleLinks } from '../../../utils/googleLinks';\r\nimport { Projection } from '../../../map/shared/projection.interfaces';\r\nimport { lonLatConversion, roundCoordTo, convertDDToDMS } from '../../../map/shared/map.utils';\r\nimport { OsmLinks } from '../../../utils';\r\nimport { Cacheable } from 'ts-cacheable';\r\n\r\n@Injectable()\r\nexport class CoordinatesSearchResultFormatter {\r\n  constructor(private languageService: LanguageService) {}\r\n\r\n  formatResult(result: SearchResult<Feature>): SearchResult<Feature> {\r\n    return result;\r\n  }\r\n}\r\n/**\r\n * CoordinatesReverse search source\r\n */\r\n@Injectable()\r\nexport class CoordinatesReverseSearchSource extends SearchSource\r\n  implements ReverseSearch {\r\n  static id = 'coordinatesreverse';\r\n  static type = FEATURE;\r\n\r\n  private projections;\r\n\r\n  title$: BehaviorSubject<string> = new BehaviorSubject<string>('');\r\n\r\n  get title(): string {\r\n    return this.title$.getValue();\r\n  }\r\n\r\n  constructor(\r\n    @Inject('options') options: SearchSourceOptions,\r\n    private languageService: LanguageService,\r\n    storageService: StorageService,\r\n    @Inject('projections') projections: Projection[],\r\n  ) {\r\n    super(options, storageService);\r\n    this.projections = projections;\r\n    this.languageService.translate\r\n      .get(this.options.title)\r\n      .subscribe(title => this.title$.next(title));\r\n  }\r\n\r\n  getId(): string {\r\n    return CoordinatesReverseSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return CoordinatesReverseSearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    return {\r\n      title: 'igo.geo.search.coordinates.name',\r\n      order: 1,\r\n      showInSettings: false\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a location by coordinates\r\n   * @param lonLat Location coordinates\r\n   * @param options options of ReverseSearchOptions (distance, conf, zoom, params)\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  reverseSearch(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    return of([this.dataToResult(lonLat, options)]);\r\n  }\r\n\r\n  private dataToResult(data: [number, number], options: ReverseSearchOptions): SearchResult<Feature> {\r\n    const dataDMS = convertDDToDMS(data);\r\n    const convertedCoord = lonLatConversion(data, this.projections);\r\n    const coords = convertedCoord.reduce((obj, item) => (\r\n      obj[item.alias] = item.igo2CoordFormat, obj), {});\r\n\r\n    const roundedCoordString = roundCoordTo(data, 6).join(', ');\r\n    const roundedCoordStringDMS = dataDMS.join(', ');\r\n\r\n    let geometry: FeatureGeometry = {\r\n      type: 'Point',\r\n      coordinates: [data[0], data[1]]\r\n    };\r\n\r\n    const properties = {};\r\n    let subtitleHtml = '';\r\n    if (options.distance) {\r\n      const radiusKey = this.languageService.translate.instant('igo.geo.search.coordinates.radius');\r\n      properties[radiusKey] = options.distance;\r\n      subtitleHtml = '<br><small>Rayon: ' + options.distance + ' m</small>';\r\n\r\n      // Create polygon\r\n      const center = olproj.transform([data[0], data[1]], 'EPSG:4326', 'EPSG:3857');\r\n      const circleGeometry = new OlCircle(center, options.distance);\r\n      const polygonGeometry = fromCircle(circleGeometry);\r\n      const writer = new olformat.GeoJSON();\r\n      geometry = JSON.parse(writer.writeGeometry(polygonGeometry.transform('EPSG:3857', 'EPSG:4326')));\r\n    }\r\n\r\n    if (options.conf) {\r\n      const confKey = this.languageService.translate.instant('igo.geo.search.coordinates.conf');\r\n      properties[confKey] = options.conf;\r\n      subtitleHtml += subtitleHtml === '' ? '<br>' : '<small> - </small>';\r\n      subtitleHtml += '<small>Confiance: ' + options.conf + '%</small>';\r\n    }\r\n\r\n    const coordKey = this.languageService.translate.instant('igo.geo.search.coordinates.coord');\r\n    properties[coordKey] = roundedCoordString;\r\n\r\n    const coordKeyDMS = this.languageService.translate.instant('igo.geo.search.coordinates.coordDMS');\r\n    properties[coordKeyDMS] = roundedCoordStringDMS;\r\n\r\n    return {\r\n      source: this,\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry,\r\n        extent: undefined,\r\n        properties: Object.assign(\r\n          properties,\r\n          coords,\r\n          {\r\n            GoogleMaps: GoogleLinks.getGoogleMapsCoordLink(data[0], data[1]),\r\n            GoogleStreetView: GoogleLinks.getGoogleStreetViewLink(\r\n              data[0],\r\n              data[1]\r\n            ),\r\n            OpenStreetMap: OsmLinks.getOpenStreetMapLink(data[0], data[1], 14),\r\n            Route: '<span class=\"routing\"> <u>' + this.languageService.translate.instant('igo.geo.seeRouting') + '</u> </span>'\r\n          }\r\n        ),\r\n        meta: {\r\n          id: data[0].toString() + ',' + data[1].toString(),\r\n          title: roundedCoordString\r\n        }\r\n      },\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id: data[0].toString() + ',' + data[1].toString(),\r\n        title: roundedCoordString,\r\n        titleHtml: roundedCoordString + subtitleHtml,\r\n        icon: 'map-marker',\r\n        score: 100, // every coord exists\r\n      }\r\n    };\r\n  }\r\n}\r\n","import { ConfigService, LanguageService, StorageService } from '@igo2/core';\r\n\r\nimport { SearchSource } from './source';\r\nimport {\r\n  CoordinatesReverseSearchSource,\r\n  CoordinatesSearchResultFormatter\r\n} from './coordinates';\r\nimport { Projection } from '../../../map/shared/projection.interfaces';\r\nimport { ProjectionService } from '../../../map/shared/projection.service';\r\n\r\n/**\r\n * ICherche search result formatter factory\r\n * @ignore\r\n */\r\nexport function defaultCoordinatesSearchResultFormatterFactory(\r\n  languageService: LanguageService\r\n) {\r\n  return new CoordinatesSearchResultFormatter(languageService);\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the ICherche search result formatter\r\n */\r\nexport function provideDefaultCoordinatesSearchResultFormatter() {\r\n  return {\r\n    provide: CoordinatesSearchResultFormatter,\r\n    useFactory: defaultCoordinatesSearchResultFormatterFactory,\r\n    deps: [LanguageService]\r\n  };\r\n}\r\n\r\n/**\r\n * CoordinatesReverse search source factory\r\n * @ignore\r\n */\r\nexport function CoordinatesReverseSearchSourceFactory(\r\n  config: ConfigService,\r\n  languageService: LanguageService,\r\n  storageService: StorageService,\r\n  _projectionService: ProjectionService\r\n) {\r\n  return new CoordinatesReverseSearchSource(\r\n    config.getConfig(`searchSources.${CoordinatesReverseSearchSource.id}`),\r\n    languageService,\r\n    storageService,\r\n    (config.getConfig('projections') as Projection[]) || []\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the IChercheReverse search source\r\n */\r\nexport function provideCoordinatesReverseSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: CoordinatesReverseSearchSourceFactory,\r\n    multi: true,\r\n    deps: [ConfigService, LanguageService, StorageService, ProjectionService]\r\n  };\r\n}\r\n","import { Injectable, Inject } from '@angular/core';\r\nimport { HttpClient, HttpParams } from '@angular/common/http';\r\n\r\nimport { Observable, BehaviorSubject, of } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { LanguageService, StorageService } from '@igo2/core';\r\nimport { ObjectUtils } from '@igo2/utils';\r\n\r\nimport { getResolutionFromScale } from '../../../map/shared/map.utils';\r\nimport { LAYER } from '../../../layer';\r\nimport { QueryableDataSourceOptions, QueryFormat } from '../../../query';\r\nimport { QueryHtmlTarget } from './../../../query/shared/query.enums';\r\n\r\nimport { SearchResult } from '../search.interfaces';\r\nimport { SearchSource, TextSearch } from './source';\r\nimport { TextSearchOptions } from './source.interfaces';\r\nimport {\r\n  ILayerSearchSourceOptions,\r\n  ILayerData,\r\n  ILayerItemResponse,\r\n  ILayerServiceResponse,\r\n  ILayerDataSource\r\n} from './ilayer.interfaces';\r\nimport { computeTermSimilarity } from '../search.utils';\r\nimport { Cacheable } from 'ts-cacheable';\r\n\r\n@Injectable()\r\nexport class ILayerSearchResultFormatter {\r\n  constructor(private languageService: LanguageService) {}\r\n\r\n  formatResult(data: ILayerData): ILayerData {\r\n    const allowedKey = [\r\n      'title',\r\n      'abstract',\r\n      'groupTitle',\r\n      'metadataUrl',\r\n      'downloadUrl',\r\n      'urlInfo',\r\n      'name'\r\n    ];\r\n\r\n    const property = Object.entries(data.properties)\r\n      .filter(([key]) => allowedKey.indexOf(key) !== -1)\r\n      .reduce((out: { [key: string]: any }, entries: [string, any]) => {\r\n        const [key, value] = entries;\r\n        let newKey;\r\n        try {\r\n          newKey = this.languageService.translate.instant(\r\n            'igo.geo.search.ilayer.properties.' + key\r\n          );\r\n        } catch (e) {\r\n          newKey = key;\r\n        }\r\n        out[newKey] = value ? value : '';\r\n        return out;\r\n      }, {});\r\n\r\n    const dataR = Object.assign({}, data);\r\n    dataR.properties = property as ILayerDataSource;\r\n\r\n    return dataR;\r\n  }\r\n}\r\n\r\n/**\r\n * ILayer search source\r\n */\r\n@Injectable()\r\nexport class ILayerSearchSource extends SearchSource implements TextSearch {\r\n  static id = 'ilayer';\r\n  static type = LAYER;\r\n\r\n  title$: BehaviorSubject<string> = new BehaviorSubject<string>('');\r\n\r\n  get title(): string {\r\n    return this.title$.getValue();\r\n  }\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private languageService: LanguageService,\r\n    storageService: StorageService,\r\n    @Inject('options') options: ILayerSearchSourceOptions,\r\n    @Inject(ILayerSearchResultFormatter)\r\n    private formatter: ILayerSearchResultFormatter\r\n  ) {\r\n    super(options, storageService);\r\n    this.languageService.translate\r\n      .get(this.options.title)\r\n      .subscribe(title => this.title$.next(title));\r\n  }\r\n\r\n  getId(): string {\r\n    return ILayerSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return ILayerSearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): ILayerSearchSourceOptions {\r\n    const limit =\r\n      this.options.params && this.options.params.limit\r\n        ? Number(this.options.params.limit)\r\n        : undefined;\r\n    const ecmax =\r\n      this.options.params && this.options.params.ecmax\r\n        ? Number(this.options.params.ecmax)\r\n        : undefined;\r\n    return {\r\n      title: 'igo.geo.search.ilayer.name',\r\n      searchUrl: 'https://geoegl.msp.gouv.qc.ca/apis/layers/search',\r\n      settings: [\r\n        {\r\n          type: 'checkbox',\r\n          title: 'results type',\r\n          name: 'type',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.ilayer.type.layer',\r\n              value: 'layer',\r\n              enabled: true,\r\n              hashtags: ['layer', 'layers', 'couche', 'couches']\r\n            },\r\n            {\r\n              title: 'igo.geo.search.ilayer.type.groupLayer',\r\n              value: 'group',\r\n              enabled: false,\r\n              hashtags: ['gr-layer', 'gr-layers', 'gr-couche', 'gr-couches']\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'results limit',\r\n          name: 'limit',\r\n          values: [\r\n            {\r\n              title: '1',\r\n              value: 1,\r\n              enabled: limit === 1\r\n            },\r\n            {\r\n              title: '5',\r\n              value: 5,\r\n              enabled: limit === 5 || !limit\r\n            },\r\n            {\r\n              title: '10',\r\n              value: 10,\r\n              enabled: limit === 10\r\n            },\r\n            {\r\n              title: '25',\r\n              value: 25,\r\n              enabled: limit === 25\r\n            },\r\n            {\r\n              title: '50',\r\n              value: 50,\r\n              enabled: limit === 50\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'ecmax',\r\n          name: 'ecmax',\r\n          values: [\r\n            {\r\n              title: '10 %',\r\n              value: 10,\r\n              enabled: ecmax === 10\r\n            },\r\n            {\r\n              title: '30 %',\r\n              value: 30,\r\n              enabled: ecmax === 30\r\n            },\r\n            {\r\n              title: '50 %',\r\n              value: 50,\r\n              enabled: ecmax === 50 || !ecmax\r\n            },\r\n            {\r\n              title: '75 %',\r\n              value: 75,\r\n              enabled: ecmax === 75\r\n            },\r\n            {\r\n              title: '100 %',\r\n              value: 100,\r\n              enabled: ecmax === 100\r\n            }\r\n          ]\r\n        }\r\n      ]\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a layer by name or keyword\r\n   * @param term Layer name or keyword\r\n   * @returns Observable of <SearchResult<LayerOptions>[]\r\n   */\r\n\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  search(\r\n    term: string | undefined,\r\n    options?: TextSearchOptions\r\n  ): Observable<SearchResult<ILayerItemResponse>[]> {\r\n    const params = this.computeSearchRequestParams(term, options || {});\r\n    if (!params.get('q') || !params.get('type')) {\r\n      return of([]);\r\n    }\r\n    this.options.params.page = params.get('page') || '1';\r\n\r\n    return this.http\r\n      .get(this.searchUrl, { params })\r\n      .pipe(\r\n        map((response: ILayerServiceResponse) => this.extractResults(response, term))\r\n      );\r\n  }\r\n\r\n  private computeSearchRequestParams(\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): HttpParams {\r\n    return new HttpParams({\r\n      fromObject: ObjectUtils.removeUndefined(\r\n        Object.assign(\r\n          {\r\n            q: this.computeTerm(term)\r\n          },\r\n          this.params,\r\n          this.computeOptionsParam(term, options || {}).params,\r\n          {\r\n            page: options.page\r\n          }\r\n        )\r\n      )\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Remove hashtag from query\r\n   * @param term Query with hashtag\r\n   */\r\n  private computeTerm(term: string): string {\r\n    return term.replace(/(#[^\\s]*)/g, '').replace(/[^\\w- !\\-\\(\\),'#]+/g, '');\r\n  }\r\n\r\n  /**\r\n   * Add hashtag to param if valid\r\n   * @param term Query with hashtag\r\n   * @param options TextSearchOptions\r\n   */\r\n  private computeOptionsParam(\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): TextSearchOptions {\r\n    const hashtags = super.getHashtagsValid(term, 'type');\r\n    if (hashtags) {\r\n      options.params = Object.assign(options.params || {}, {\r\n        type: hashtags.join(',')\r\n      });\r\n    }\r\n\r\n    return options;\r\n  }\r\n\r\n  private extractResults(\r\n    response: ILayerServiceResponse, term: string\r\n  ): SearchResult<ILayerItemResponse>[] {\r\n    return response.items.map((data: ILayerData) =>\r\n    this.dataToResult(data, term, response)\r\n    );\r\n  }\r\n\r\n  private dataToResult(\r\n    data: ILayerData,\r\n    term: string,\r\n    response?: ILayerServiceResponse\r\n  ): SearchResult<ILayerItemResponse> {\r\n    const layerOptions = this.computeLayerOptions(data);\r\n\r\n    const titleHtml = data.highlight.title || data.properties.title;\r\n    const groupTitle = data.highlight.groupTitle || data.properties.groupTitle;\r\n    const subtitleHtml = groupTitle\r\n      ? ' <small style=\"color: #6f6969\"> ' + groupTitle + '</small>'\r\n      : '';\r\n\r\n    return {\r\n      source: this,\r\n      meta: {\r\n        dataType: LAYER,\r\n        id: [this.getId(), data.properties.id].join('.'),\r\n        title: data.properties.title,\r\n        titleHtml: titleHtml + subtitleHtml,\r\n        icon: data.properties.type === 'Layer' ? 'layers' : 'map',\r\n        score: data.score || computeTermSimilarity(term.trim(), data.properties.name),\r\n        nextPage:\r\n          response.items.length % +this.options.params.limit === 0 &&\r\n          +this.options.params.page < 10\r\n      },\r\n      data: layerOptions\r\n    };\r\n  }\r\n\r\n  private computeLayerOptions(data: ILayerData): ILayerItemResponse {\r\n    const url = data.properties.url;\r\n    const queryParams: QueryableDataSourceOptions = this.extractQueryParamsFromSourceUrl(\r\n      url\r\n    );\r\n    return ObjectUtils.removeUndefined({\r\n      sourceOptions: {\r\n        id: data.properties.id,\r\n        type: data.properties.format,\r\n        url,\r\n        queryFormat: queryParams.queryFormat,\r\n        queryHtmlTarget: queryParams.queryHtmlTarget,\r\n        params: data.properties.format === 'wms' ? {LAYERS: data.properties.name} : undefined,\r\n        layer: data.properties.format === 'wms' ? undefined : data.properties.name,\r\n        optionsFromCapabilities: true,\r\n        crossOrigin: 'anonymous'\r\n      },\r\n      title: data.properties.title,\r\n      maxResolution: getResolutionFromScale(\r\n        Number(data.properties.maxScaleDenom)\r\n      ),\r\n      minResolution: getResolutionFromScale(\r\n        Number(data.properties.minScaleDenom)\r\n      ),\r\n      metadata: {\r\n        url: data.properties.metadataUrl,\r\n        extern: data.properties.metadataUrl ? true : undefined,\r\n        abstract: data.properties.abstract || undefined\r\n      },\r\n      properties: this.formatter.formatResult(data).properties\r\n    });\r\n  }\r\n\r\n  private extractQueryParamsFromSourceUrl(\r\n    url: string\r\n  ): { queryFormat: QueryFormat; queryHtmlTarget: QueryHtmlTarget } {\r\n    let queryFormat;\r\n    let queryHtmlTarget;\r\n    const formatOpt = (this.options as ILayerSearchSourceOptions).queryFormat;\r\n    if (formatOpt) {\r\n      for (const key of Object.keys(formatOpt)) {\r\n        const value = formatOpt[key];\r\n        if (value === '*') {\r\n          queryFormat = QueryFormat[key.toUpperCase()];\r\n          break;\r\n        }\r\n\r\n        const urls = ((value as any) as { urls: string[] }).urls;\r\n        if (Array.isArray(urls)) {\r\n          urls.forEach(urlOpt => {\r\n            if (url.indexOf(urlOpt) !== -1) {\r\n              queryFormat = QueryFormat[key.toUpperCase()];\r\n            }\r\n          });\r\n          break;\r\n        }\r\n      }\r\n\r\n      if (\r\n        queryFormat === QueryFormat.HTML ||\r\n        queryFormat === QueryFormat.HTMLGML2\r\n      ) {\r\n        queryHtmlTarget = 'iframe';\r\n      }\r\n    }\r\n\r\n    return {\r\n      queryFormat,\r\n      queryHtmlTarget\r\n    };\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\n\r\nimport { ConfigService, LanguageService, StorageService } from '@igo2/core';\r\n\r\nimport { SearchSource } from './source';\r\nimport { ILayerSearchSource, ILayerSearchResultFormatter } from './ilayer';\r\n\r\n/**\r\n * ILayer search result formatter factory\r\n * @ignore\r\n */\r\nexport function ilayerSearchResultFormatterFactory(\r\n  languageService: LanguageService\r\n) {\r\n  return new ILayerSearchResultFormatter(languageService);\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the ILayer search result formatter\r\n */\r\nexport function provideILayerSearchResultFormatter() {\r\n  return {\r\n    provide: ILayerSearchResultFormatter,\r\n    useFactory: ilayerSearchResultFormatterFactory,\r\n    deps: [LanguageService]\r\n  };\r\n}\r\n\r\n/**\r\n * ILayer search source factory\r\n * @ignore\r\n */\r\nexport function ilayerSearchSourceFactory(\r\n  http: HttpClient,\r\n  languageService: LanguageService,\r\n  storageService: StorageService,\r\n  config: ConfigService,\r\n  formatter: ILayerSearchResultFormatter\r\n) {\r\n  return new ILayerSearchSource(\r\n    http,\r\n    languageService,\r\n    storageService,\r\n    config.getConfig(`searchSources.${ILayerSearchSource.id}`),\r\n    formatter\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the ILayer search source\r\n */\r\nexport function provideILayerSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: ilayerSearchSourceFactory,\r\n    multi: true,\r\n    deps: [HttpClient, LanguageService, StorageService, ConfigService, ILayerSearchResultFormatter]\r\n  };\r\n}\r\n","import { FEATURE } from '../../feature';\r\nimport { LAYER } from '../../layer';\r\n\r\nexport const SEARCH_TYPES = [FEATURE, LAYER];\r\n","<div class=\"igo-search-selector\">\r\n  <button\r\n    mat-icon-button\r\n    class=\"igo-search-selector-button\"\r\n    color=\"primary\"\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"'igo.geo.search.menu.tooltip' | translate\"\r\n    [matMenuTriggerFor]=\"searchSelectorMenu\">\r\n    <mat-icon svgIcon=\"menu-down\"></mat-icon>\r\n  </button>\r\n\r\n  <mat-menu\r\n    #searchSelectorMenu=\"matMenu\"\r\n    class=\"no-border-radius\"\r\n    xPosition=\"before\"\r\n    yPosition=\"above\">\r\n    <mat-radio-group\r\n      class=\"igo-search-selector-radio-group\"\r\n      [value]=\"searchType$ | async\"\r\n      (change)=\"onSearchTypeChange($event.value)\">\r\n      <mat-radio-button *ngFor=\"let searchType of searchTypes\" [value]=\"searchType\">\r\n        {{getSearchTypeTitle(searchType) | translate}}\r\n      </mat-radio-button>\r\n    </mat-radio-group>\r\n  </mat-menu>\r\n\r\n</div>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport { distinctUntilChanged } from 'rxjs/operators';\r\n\r\nimport { SEARCH_TYPES } from '../shared/search.enums';\r\nimport { SearchSourceService } from '../shared/search-source.service';\r\n\r\n/**\r\n * This component allows a user to select a search type yo enable. In it's\r\n * current version, only one search type can be selected at once (radio). If\r\n * this component were to support more than one search source enabled (checkbox),\r\n * the searchbar component would require a small change to it's\r\n * placeholder getter. The search source service already supports having\r\n * more than one search source enabled.\r\n */\r\n@Component({\r\n  selector: 'igo-search-selector',\r\n  templateUrl: './search-selector.component.html',\r\n  styleUrls: ['./search-selector.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SearchSelectorComponent implements OnInit, OnDestroy {\r\n\r\n  readonly searchType$: BehaviorSubject<string> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Subscription to the search type\r\n   */\r\n  private searchType$$: Subscription;\r\n\r\n  /**\r\n   * List of available search types\r\n   */\r\n  @Input() searchTypes: string[] = SEARCH_TYPES;\r\n\r\n  /**\r\n   * The search type enabled\r\n   */\r\n  @Input()\r\n  set searchType(value: string) { this.setSearchType(value); }\r\n  get searchType(): string { return this.searchType$.value; }\r\n\r\n  /**\r\n   * Event emitted when the enabled search type changes\r\n   */\r\n  @Output() searchTypeChange = new EventEmitter<string>();\r\n\r\n  constructor(private searchSourceService: SearchSourceService) {}\r\n\r\n  ngOnInit() {\r\n    this.searchType$$ = this.searchType$\r\n      .pipe(distinctUntilChanged())\r\n      .subscribe((searchType: string) => this.onSetSearchType(searchType));\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.searchType$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * Enable the selected search type\r\n   * @param searchType Search type\r\n   * @internal\r\n   */\r\n  onSearchTypeChange(searchType: string) {\r\n    this.setSearchType(searchType);\r\n  }\r\n\r\n  /**\r\n   * Get a search type's title. The title\r\n   * for all availables search typers needs to be defined in the locale\r\n   * files or an error will be thrown.\r\n   * @param searchType Search type\r\n   * @internal\r\n   */\r\n  getSearchTypeTitle(searchType: string) {\r\n    return `igo.geo.search.${searchType.toLowerCase()}.title`;\r\n  }\r\n\r\n  /**\r\n   * Emit an event and enable the search sources of the given type.\r\n   * @param searchType Search type\r\n   */\r\n  private setSearchType(searchType: string | undefined) {\r\n    this.searchType$.next(searchType);\r\n  }\r\n\r\n  private onSetSearchType(searchType: string) {\r\n    if (searchType === undefined || searchType === null) {\r\n      return;\r\n    }\r\n\r\n    this.searchSourceService.enableSourcesByType(searchType);\r\n    this.searchTypeChange.emit(searchType);\r\n  }\r\n\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatMenuModule } from '@angular/material/menu';\r\nimport { MatRadioModule } from '@angular/material/radio';\r\nimport { MatTabsModule } from '@angular/material/tabs';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { SearchSelectorComponent } from './search-selector.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatTooltipModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatMenuModule,\r\n    MatRadioModule,\r\n    MatTabsModule,\r\n    MatCheckboxModule,\r\n    IgoLanguageModule\r\n  ],\r\n  exports: [SearchSelectorComponent],\r\n  declarations: [SearchSelectorComponent]\r\n})\r\nexport class IgoSearchSelectorModule {}\r\n","<div class=\"igo-search-settings\">\r\n\r\n  <button\r\n    mat-icon-button\r\n    class=\"igo-search-settings-button\"\r\n    color=\"primary\"\r\n    tooltip-position=\"below\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matTooltip]=\"'igo.geo.search.menu.tooltip' | translate\"\r\n    [matMenuTriggerFor]=\"searchSettingsMenu\">\r\n    <mat-icon svgIcon=\"chevron-down\"></mat-icon>\r\n  </button>\r\n  <mat-menu\r\n    #searchSettingsMenu=\"matMenu\"\r\n    class=\"no-border-radius\">\r\n    <div class=\"checkAllButton\" *ngIf=\"getSearchSources().length>4\">\r\n      <button mat-raised-button\r\n        (click)=\"checkUncheckAllSources($event)\">{{!searchSourcesAllEnabled  ? ('igo.geo.search.searchSources.unselectAll' | translate): ('igo.geo.search.searchSources.selectAll' | translate)}}</button>\r\n    </div>\r\n      <ng-container *ngFor=\"let source of getSearchSources()\">\r\n        <span class=\"igo-search-settings-search-source\">\r\n          <mat-checkbox\r\n            class=\"igo-search-settings-checkbox\"\r\n            [checked]=\"source.enabled\"\r\n            [value]=\"source\"\r\n            (click)=\"$event.stopPropagation()\"\r\n            (change)=\"onCheckSearchSource($event, source)\">\r\n          </mat-checkbox>\r\n          <button *ngIf=\"source.settings.length>0\"\r\n            [matMenuTriggerFor]=\"sub_menu\"\r\n            mat-menu-item>{{source.title}}\r\n          </button>\r\n          <button\r\n            mat-menu-item\r\n            *ngIf=\"source.settings.length===0\">\r\n            {{source.title}}\r\n          </button>\r\n        </span>\r\n          <mat-menu #sub_menu=\"matMenu\">\r\n            <ng-container *ngFor=\"let setting of source.settings\">\r\n              <button\r\n                  mat-menu-item\r\n                  [matMenuTriggerFor]=\"test_sub_menu\">\r\n                {{'igo.geo.search.searchSources.settings.'+ setting.title | translate}}\r\n              </button>\r\n              <mat-menu #test_sub_menu=\"matMenu\"\r\n                [ngSwitch]=\"setting.type\"\r\n                yPosition=\"above\">\r\n                <span *ngSwitchCase=\"'radiobutton'\">\r\n                  <mat-radio-group\r\n                    class=\"igo-search-settings-radio-group\"\r\n                    [value]=\"setting\">\r\n                    <mat-radio-button *ngFor=\"let settingValue of setting.values\"\r\n                      class=\"mat-typography\"\r\n                      [value]=\"settingValue\"\r\n                      [matTooltip]=\"getAvailableHashtagsValues(settingValue)\"\r\n                      [checked]=\"settingValue.enabled\"\r\n                      (click)=\"$event.stopPropagation()\"\r\n                      (change)=\"settingsValueCheckedRadioButton($event, source, setting, settingValue)\">\r\n                      {{settingValue.title | translate}}\r\n                    </mat-radio-button>\r\n                  </mat-radio-group>\r\n                </span>\r\n                <span *ngSwitchCase=\"'checkbox'\">\r\n                  <div class=\"checkAllButton\" *ngIf=\"setting.values.length>3\">\r\n                    <button mat-raised-button\r\n                      (click)=\"checkUncheckAll($event, source, setting)\">{{setting.allEnabled || setting.allEnabled === undefined  ? ('igo.geo.search.searchSources.settings.unselectAll' | translate): ('igo.geo.search.searchSources.settings.selectAll' | translate)}}</button>\r\n                  </div>\r\n                  <mat-checkbox *ngFor=\"let settingValue of getAvailableValues(setting)\"\r\n                    class=\"mat-menu-item\"\r\n                    [style.display]=\"displayBlock\"\r\n                    [checked]=\"settingValue.enabled\"\r\n                    [value]=\"setting\"\r\n                    [matTooltip]=\"getAvailableHashtagsValues(settingValue)\"\r\n                    (click)=\"$event.stopPropagation()\"\r\n                    (change)=\"settingsValueCheckedCheckbox($event, source, setting, settingValue)\">\r\n                    {{settingValue.title | translate}}\r\n                  </mat-checkbox>\r\n                </span>\r\n              </mat-menu>\r\n            </ng-container>\r\n          </mat-menu>\r\n      </ng-container>\r\n      <span *ngIf=\"hasPointerReverseSearchSource && !isTouchScreen\">\r\n        <mat-divider></mat-divider>\r\n        <span class=\"pointer-summary-slide-toggle-container mat-typography\">\r\n          <mat-slide-toggle class=\"pointer-summary-option\" (change)=\"changePointerReverseSearch($event)\" tooltip-position=\"below\"\r\n            matTooltipShowDelay=\"500\" [matTooltip]=\"'igo.geo.search.pointerSearchSummary.tooltip' | translate\"\r\n            (click)=\"$event.stopPropagation()\" [checked]=\"pointerSummaryEnabled\" [labelPosition]=\"'after'\">\r\n            {{'igo.geo.search.pointerSearchSummary.title' | translate}}\r\n          </mat-slide-toggle>\r\n          <mat-slide-toggle class=\"pointer-summary-option\" (change)=\"changeSearchResultsGeometry($event)\" tooltip-position=\"below\"\r\n            matTooltipShowDelay=\"500\" [matTooltip]=\"'igo.geo.search.searchResultsGeometry.tooltip' | translate\"\r\n            (click)=\"$event.stopPropagation()\" [checked]=\"searchResultsGeometryEnabled\" [labelPosition]=\"'after'\">\r\n            {{'igo.geo.search.searchResultsGeometry.title' | translate}}\r\n          </mat-slide-toggle>\r\n        </span>\r\n      </span>\r\n  </mat-menu>\r\n</div>\r\n","import { MatCheckboxChange } from '@angular/material/checkbox';\r\nimport { MatRadioChange } from '@angular/material/radio';\r\n\r\nimport {\r\n  Component,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  HostListener,\r\n  Input\r\n} from '@angular/core';\r\n\r\nimport { SearchSourceService } from '../shared/search-source.service';\r\nimport { SearchSource } from '../shared/sources/source';\r\nimport {\r\n  SearchSourceSettings,\r\n  SettingOptions\r\n} from '../shared/sources/source.interfaces';\r\nimport {\r\n  sourceCanReverseSearchAsSummary,\r\n  sourceCanSearch,\r\n  sourceCanReverseSearch\r\n} from '../shared/search.utils';\r\nimport { MediaService, StorageService } from '@igo2/core';\r\n\r\n/**\r\n * This component allows a user to select a search type yo enable. In it's\r\n * current version, only one search type can be selected at once (radio). If\r\n * this component were to support more than one search source enabled (checkbox),\r\n * the searchbar component would require a small change to it's\r\n * placeholder getter. The search source service already supports having\r\n * more than one search source enabled.\r\n */\r\n@Component({\r\n  selector: 'igo-search-settings',\r\n  templateUrl: './search-settings.component.html',\r\n  styleUrls: ['./search-settings.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SearchSettingsComponent implements OnInit {\r\n  public hasPointerReverseSearchSource: boolean = false;\r\n  public searchSourcesAllEnabled: boolean = false;\r\n\r\n  public buffer = [];\r\n  public lastKeyTime = Date.now();\r\n\r\n  public displayBlock = 'block';\r\n\r\n  get isTouchScreen(): boolean {\r\n    return this.mediaService.isTouchScreen();\r\n  }\r\n\r\n  @Input() pointerSummaryEnabled: boolean = false;\r\n  @Input() searchResultsGeometryEnabled: boolean = false;\r\n\r\n  /**\r\n   * Event emitted when the enabled search source changes\r\n   */\r\n  @Output() searchSourceChange = new EventEmitter<SearchSource>();\r\n\r\n  /**\r\n   * Event emitted when the pointer summary is activated\r\n   */\r\n  @Output() pointerSummaryStatus = new EventEmitter<boolean>();\r\n\r\n  /**\r\n   * Event emitted when the show geometry summary is changed\r\n   */\r\n  @Output() searchResultsGeometryStatus = new EventEmitter<boolean>();\r\n\r\n  @HostListener('document:keydown', ['$event'])\r\n  handleKeyboardEvent(event: KeyboardEvent) {\r\n    if (event.key === 'F2') {\r\n      this.pointerSummaryEnabled = !this.pointerSummaryEnabled;\r\n      this.pointerSummaryStatus.emit(this.pointerSummaryEnabled);\r\n    }\r\n  }\r\n\r\n  constructor(\r\n    private searchSourceService: SearchSourceService,\r\n    private mediaService: MediaService,\r\n    private storageService: StorageService\r\n  ) {}\r\n\r\n  ngOnInit(): void {\r\n    this.hasPointerReverseSearchSource = this.hasReverseSearchSourcesForPointerSummary();\r\n  }\r\n\r\n  /**\r\n   * Get all search sources\r\n   * @internal\r\n   */\r\n  getSearchSources(): SearchSource[] {\r\n    const textSearchSources = this.searchSourceService\r\n      .getSources()\r\n      .filter(sourceCanSearch)\r\n      .filter((s) => s.available && s.getId() !== 'map' && s.showInSettings);\r\n\r\n    const reverseSearchSources = this.searchSourceService\r\n      .getSources()\r\n      .filter(sourceCanReverseSearch)\r\n      .filter((s) => s.available && s.getId() !== 'map' && s.showInSettings);\r\n    const sources = textSearchSources.concat(reverseSearchSources);\r\n    this.computeSourcesCheckAllBehavior(sources);\r\n    return sources;\r\n  }\r\n\r\n  /**\r\n   * Get all search sources usable for pointer summary\r\n   * @internal\r\n   */\r\n  hasReverseSearchSourcesForPointerSummary(): boolean {\r\n    if (\r\n      this.searchSourceService\r\n        .getEnabledSources()\r\n        .filter(sourceCanReverseSearchAsSummary).length\r\n    ) {\r\n      return true;\r\n    } else {\r\n      return false;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Triggered when a setting is checked (checkbox style)\r\n   * @internal\r\n   */\r\n  settingsValueCheckedCheckbox(\r\n    event: MatCheckboxChange,\r\n    source: SearchSource,\r\n    setting: SearchSourceSettings,\r\n    settingValue: SettingOptions\r\n  ) {\r\n    settingValue.enabled = event.checked;\r\n    source.setParamFromSetting(setting);\r\n    this.searchSourceChange.emit(source);\r\n  }\r\n\r\n  /**\r\n   * Defining the action to do for check/uncheck checkboxes (settings)\r\n   * return true if all checkbox must be checked\r\n   * return false if all checkbox must be unchecked\r\n   * @internal\r\n   */\r\n  computeSettingCheckAllBehavior(setting: SearchSourceSettings) {\r\n    if (setting.allEnabled === undefined) {\r\n      if (setting.values.find((settingValue) => settingValue.enabled)) {\r\n        setting.allEnabled = false;\r\n      } else {\r\n        setting.allEnabled = true;\r\n      }\r\n    } else {\r\n      setting.allEnabled = !setting.allEnabled;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Defining the action to do for check/uncheck checkboxes (sources)\r\n   * return true if all checkbox must be checked\r\n   * return false if all checkbox must be unchecked\r\n   * @internal\r\n   */\r\n  computeSourcesCheckAllBehavior(sources: SearchSource[]) {\r\n    const enabledSourcesCnt = sources.filter((source) => source.enabled).length;\r\n    const disabledSourcesCnt = sources.filter((source) => !source.enabled)\r\n      .length;\r\n    this.searchSourcesAllEnabled =\r\n      enabledSourcesCnt >= disabledSourcesCnt ? false : true;\r\n  }\r\n\r\n  /**\r\n   * Triggered when the check all / uncheck all type is clicked,\r\n   * @internal\r\n   */\r\n  checkUncheckAll(event, source: SearchSource, setting: SearchSourceSettings) {\r\n    event.stopPropagation();\r\n    this.computeSettingCheckAllBehavior(setting);\r\n    setting.values.forEach((settingValue) => {\r\n      settingValue.enabled = setting.allEnabled;\r\n    });\r\n    source.setParamFromSetting(setting);\r\n    this.searchSourceChange.emit(source);\r\n  }\r\n\r\n  /**\r\n   * Triggered when the check all / uncheck all type is clicked,\r\n   * @internal\r\n   */\r\n  checkUncheckAllSources(event) {\r\n    event.stopPropagation();\r\n    this.getSearchSources().map((source) => {\r\n      source.enabled = this.searchSourcesAllEnabled;\r\n      this.searchSourceChange.emit(source);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Triggered when a setting is checked (radiobutton style)\r\n   * @internal\r\n   */\r\n  settingsValueCheckedRadioButton(\r\n    event: MatRadioChange,\r\n    source: SearchSource,\r\n    setting: SearchSourceSettings,\r\n    settingValue: SettingOptions\r\n  ) {\r\n    setting.values.forEach((conf) => {\r\n      if (conf.value !== settingValue.value) {\r\n        conf.enabled = !event.source.checked;\r\n      } else {\r\n        conf.enabled = event.source.checked;\r\n      }\r\n    });\r\n    source.setParamFromSetting(setting);\r\n    this.searchSourceChange.emit(source);\r\n  }\r\n\r\n  onCheckSearchSource(event: MatCheckboxChange, source: SearchSource) {\r\n    source.enabled = event.checked;\r\n    const storage = (this.storageService.get(source.getId() + '.options') || {}) as SettingOptions;\r\n    storage.enabled = source.enabled;\r\n    this.storageService.set(\r\n      source.getId() + '.options',\r\n      storage\r\n    );\r\n    this.searchSourceChange.emit(source);\r\n  }\r\n\r\n  getAvailableValues(setting: SearchSourceSettings) {\r\n    return setting.values.filter((s) => s.available !== false);\r\n  }\r\n\r\n  getAvailableHashtagsValues(setting: SettingOptions) {\r\n    if (setting.hashtags) {\r\n      return setting.hashtags.map((h) => '#' + h).join(', ');\r\n    }\r\n    return;\r\n  }\r\n\r\n  stopPropagation(event) {\r\n    event.stopPropagation();\r\n  }\r\n\r\n  changePointerReverseSearch(event) {\r\n    this.pointerSummaryEnabled = event.checked;\r\n    this.pointerSummaryStatus.emit(this.pointerSummaryEnabled);\r\n  }\r\n\r\n  changeSearchResultsGeometry(event) {\r\n    this.searchResultsGeometryEnabled = event.checked;\r\n    this.searchResultsGeometryStatus.emit(this.searchResultsGeometryEnabled);\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { SearchSettingsComponent } from './search-settings.component';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatDividerModule } from '@angular/material/divider';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatMenuModule } from '@angular/material/menu';\r\nimport { MatRadioModule } from '@angular/material/radio';\r\nimport { MatSlideToggleModule } from '@angular/material/slide-toggle';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  declarations: [SearchSettingsComponent],\r\n  imports: [\r\n    CommonModule,\r\n    MatTooltipModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatMenuModule,\r\n    MatRadioModule,\r\n    MatCheckboxModule,\r\n    MatDividerModule,\r\n    MatSlideToggleModule,\r\n    IgoLanguageModule\r\n  ],\r\n  exports: [SearchSettingsComponent]\r\n})\r\nexport class IgoSearchSettingsModule { }\r\n","<div class=\"igo-search-bar-container\" [ngClass]=\"{empty: empty$ | async}\">\r\n  <mat-form-field [floatLabel]=\"floatLabel\" [appearance]=\"appearance\">\r\n    <mat-label *ngIf=\"label\">{{label}}</mat-label>\r\n    <input\r\n      #input\r\n      matInput\r\n      autocomplete=\"off\"\r\n      [ngClass]=\"{'hasSearchIcon': searchIcon}\"\r\n      [disabled]=\"disabled$ | async\"\r\n      [placeholder]=\"placeholder ? placeholder : (placeholder$ | async) ? (placeholder$.value | translate) : undefined\"\r\n      [value]=\"term$ | async\"\r\n      (keyup)=\"onKeyup($event)\"\r\n      (touchend)=\"onKeyup($event)\">\r\n  </mat-form-field>\r\n\r\n  <div class=\"search-bar-buttons\">\r\n    <button\r\n      mat-icon-button\r\n      [color]=\"color\"\r\n      *ngIf=\"searchIcon !== undefined\">\r\n      <mat-icon svgIcon=\"{{searchIcon}}\"></mat-icon>\r\n    </button>\r\n\r\n    <button\r\n      *ngIf=\"(empty$ | async)===false\"\r\n      mat-icon-button\r\n      [color]=\"color\"\r\n      (click)=\"onClearButtonClick()\">\r\n      <mat-icon svgIcon=\"close\"></mat-icon>\r\n    </button>\r\n\r\n    <igo-search-selector\r\n      *ngIf=\"searchSelector\"\r\n      [searchTypes]=\"searchTypes\"\r\n      [searchType]=\"searchType$ | async\"\r\n      (searchTypeChange)=\"onSearchTypeChange($event)\">\r\n    </igo-search-selector>\r\n\r\n    <igo-search-settings\r\n      *ngIf=\"searchSettings\"\r\n      [pointerSummaryEnabled]=\"pointerSummaryEnabled\"\r\n      (pointerSummaryStatus)=\"pointerSummaryStatus.emit($event)\"\r\n      [searchResultsGeometryEnabled]=\"searchResultsGeometryEnabled\"\r\n      (searchResultsGeometryStatus)=\"searchResultsGeometryStatus.emit($event)\"\r\n      (searchSourceChange)=\"onSearchSettingsChange()\">\r\n    </igo-search-settings>\r\n  </div>\r\n</div>\r\n","import {\r\n  Component,\r\n  OnInit,\r\n  OnDestroy,\r\n  ChangeDetectionStrategy,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ViewChild,\r\n  ElementRef\r\n} from '@angular/core';\r\nimport {\r\n  FloatLabelType,\r\n  MatFormFieldAppearance\r\n} from '@angular/material/form-field';\r\nimport { BehaviorSubject, Subscription, EMPTY, timer } from 'rxjs';\r\nimport { debounce, distinctUntilChanged } from 'rxjs/operators';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { EntityStore } from '@igo2/common';\r\n\r\nimport { SEARCH_TYPES } from '../shared/search.enums';\r\nimport { SearchResult, Research } from '../shared/search.interfaces';\r\nimport { SearchService } from '../shared/search.service';\r\nimport { SearchSourceService } from '../shared/search-source.service';\r\n\r\n/**\r\n * Searchbar that triggers a research in all search sources enabled.\r\n * If the store input is defined, the search results will be loaded\r\n * into that store. An event is always emitted when a research is completed.\r\n */\r\n@Component({\r\n  selector: 'igo-search-bar',\r\n  templateUrl: './search-bar.component.html',\r\n  styleUrls: ['./search-bar.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SearchBarComponent implements OnInit, OnDestroy {\r\n  /**\r\n   * Invalid keys\r\n   */\r\n  static invalidKeys = [\r\n    'Control',\r\n    'Shift',\r\n    'Alt',\r\n    'ArrowDown',\r\n    'ArrowUp',\r\n    'ArrowRight',\r\n    'ArrowLeft'\r\n  ];\r\n\r\n  readonly placeholder$: BehaviorSubject<string> = new BehaviorSubject(\r\n    'igo.geo.search.placeholder'\r\n  );\r\n\r\n  readonly empty$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  /**\r\n   * Subscription to the ssearch bar term\r\n   */\r\n  private term$$: Subscription;\r\n\r\n  /**\r\n   * Search term stream\r\n   */\r\n  private stream$: BehaviorSubject<string> = new BehaviorSubject('');\r\n\r\n  /**\r\n   * Subscription to the search term stream\r\n   */\r\n  private stream$$: Subscription;\r\n\r\n  /**\r\n   * Subscription to the search type\r\n   */\r\n  private searchType$$: Subscription;\r\n\r\n  private researches$$: Subscription[];\r\n\r\n  /**\r\n   * List of available search types\r\n   */\r\n  @Input() searchTypes: string[] = SEARCH_TYPES;\r\n\r\n  /**\r\n   * Search term\r\n   */\r\n  @Input()\r\n  set searchType(value: string) {\r\n    this.setSearchType(value);\r\n  }\r\n  get searchType(): string {\r\n    return this.searchType$.value;\r\n  }\r\n  readonly searchType$: BehaviorSubject<string> = new BehaviorSubject(\r\n    undefined\r\n  );\r\n\r\n  /**\r\n   * Event emitted when the pointer summary is activated by the searchbar setting\r\n   */\r\n  @Output() pointerSummaryStatus = new EventEmitter<boolean>();\r\n\r\n  /**\r\n   * Event emitted when the show geometry setting is changed\r\n   */\r\n   @Output() searchResultsGeometryStatus = new EventEmitter<boolean>();\r\n\r\n  /**\r\n   * Search term\r\n   */\r\n  @Input()\r\n  set term(value: string) {\r\n    this.setTerm(value);\r\n  }\r\n  get term(): string {\r\n    return this.term$.value;\r\n  }\r\n  readonly term$: BehaviorSubject<string> = new BehaviorSubject('');\r\n\r\n  /**\r\n   * Whether this component is disabled\r\n   */\r\n  @Input()\r\n  set disabled(value: boolean) {\r\n    this.disabled$.next(value);\r\n  }\r\n  get disabled(): boolean {\r\n    return this.disabled$.value;\r\n  }\r\n  readonly disabled$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  @Input() pointerSummaryEnabled: boolean = false;\r\n  @Input() searchResultsGeometryEnabled: boolean = false;\r\n  /**\r\n   * Whether a float label should be displayed\r\n   */\r\n  @Input() floatLabel: FloatLabelType = 'never';\r\n\r\n  @Input() appearance: MatFormFieldAppearance = 'legacy';\r\n\r\n  @Input() placeholder: string;\r\n\r\n  @Input() label: string;\r\n\r\n  /**\r\n   * Icons color (search and clear)\r\n   */\r\n  @Input() color = 'primary';\r\n\r\n  @Input() termSplitter: string = '|';\r\n\r\n  /**\r\n   * Debounce time between each keystroke\r\n   */\r\n  @Input() debounce = 200;\r\n\r\n  /**\r\n   * Minimum term length required to trigger a research\r\n   */\r\n  @Input() minLength = 2;\r\n\r\n  /**\r\n   * Search icon\r\n   */\r\n  @Input() searchIcon: string;\r\n\r\n  /**\r\n   * Search Selector\r\n   */\r\n  @Input() searchSelector = false;\r\n\r\n  /**\r\n   * Search Settings\r\n   */\r\n  @Input() searchSettings = false;\r\n\r\n  /**\r\n   * Force coordinates in north america\r\n   */\r\n  @Input() forceNA = false;\r\n\r\n  /**\r\n   * Search results store\r\n   */\r\n  @Input() store: EntityStore<SearchResult>;\r\n\r\n  /**\r\n   * Event emitted when the search term changes\r\n   */\r\n  @Output() searchTermChange = new EventEmitter<string>();\r\n\r\n  /**\r\n   * Event emitted when a research is completed\r\n   */\r\n  @Output() search = new EventEmitter<{\r\n    research: Research;\r\n    results: SearchResult[];\r\n  }>();\r\n\r\n  /**\r\n   * Event emitted when the search type changes\r\n   */\r\n  @Output() searchTypeChange = new EventEmitter<string>();\r\n\r\n  /**\r\n   * Event emitted when the search type changes\r\n   */\r\n  @Output() clearFeature = new EventEmitter();\r\n\r\n  /**\r\n   * Event emitted when the search settings changes\r\n   */\r\n  @Output() searchSettingsChange = new EventEmitter();\r\n\r\n  /**\r\n   * Input element\r\n   * @internal\r\n   */\r\n  @ViewChild('input', { static: true }) input: ElementRef;\r\n\r\n  /**\r\n   * Whether the search bar is empty\r\n   * @internal\r\n   */\r\n  get empty(): boolean {\r\n    return this.term.length === 0;\r\n  }\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private searchService: SearchService,\r\n    private searchSourceService: SearchSourceService\r\n  ) {}\r\n\r\n  /**\r\n   * Subscribe to the search term stream and trigger researches\r\n   * @internal\r\n   */\r\n  ngOnInit(): void {\r\n    this.term$$ = this.term$.subscribe((term: string) => {\r\n      this.empty$.next(term === undefined || term.length === 0);\r\n    });\r\n\r\n    this.stream$$ = this.stream$\r\n      .pipe(\r\n        debounce((term: string) => (term === '' ? EMPTY : timer(this.debounce)))\r\n      )\r\n      .subscribe((term: string) => this.onSetTerm(term));\r\n\r\n    this.handlePlaceholder();\r\n\r\n    this.searchType$$ = this.searchType$\r\n      .pipe(distinctUntilChanged())\r\n      .subscribe((searchType: string) => this.onSetSearchType(searchType));\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to the search term stream\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.term$$.unsubscribe();\r\n    this.stream$$.unsubscribe();\r\n    this.searchType$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * When a user types, validates the key and send it into the\r\n   * stream if it's valid\r\n   * @param event Keyboard event\r\n   * @internal\r\n   */\r\n  onKeyup(event: KeyboardEvent) {\r\n    const key = event.key;\r\n    if (!this.keyIsValid(key)) {\r\n      return;\r\n    }\r\n    const term = (event.target as HTMLInputElement).value;\r\n    this.setTerm(term);\r\n  }\r\n\r\n  /**\r\n   * Clear the stream and the input\r\n   * @internal\r\n   */\r\n  onClearButtonClick() {\r\n    this.clear();\r\n    this.clearFeature.emit();\r\n  }\r\n\r\n  /**\r\n   * Update search type\r\n   * @param searchType Enabled search type\r\n   * @internal\r\n   */\r\n  onSearchTypeChange(searchType: string) {\r\n    this.setSearchType(searchType);\r\n  }\r\n\r\n  /**\r\n   * Update the placeholder with the enabled search type. The placeholder\r\n   * for all availables search typers needs to be defined in the locale\r\n   * files or an error will be thrown.\r\n   * @param searchType Enabled search type\r\n   * @internal\r\n   */\r\n  setSearchType(searchType: string) {\r\n    this.searchType$.next(searchType);\r\n  }\r\n\r\n  onSearchSettingsChange() {\r\n    this.doSearch(this.term);\r\n    this.searchSettingsChange.emit();\r\n    this.handlePlaceholder();\r\n  }\r\n\r\n  /**\r\n   * Send the term into the stream only if this component is not disabled\r\n   * @param term Search term\r\n   */\r\n  setTerm(term: string) {\r\n    if (this.disabled) {\r\n      return;\r\n    }\r\n\r\n    term = term || '';\r\n\r\n    if (term !== this.term) {\r\n      this.term$.next(term);\r\n    }\r\n\r\n    const slug = term.replace(/(#[^\\s]*)/g, '').trim();\r\n    if (slug.length >= this.minLength || slug.length === 0) {\r\n      this.stream$.next(term);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear the stream and the input\r\n   */\r\n  private clear() {\r\n    this.term$.next('');\r\n    this.stream$.next('');\r\n    this.input.nativeElement.focus();\r\n  }\r\n\r\n  /**\r\n   * Validate if a given key stroke is a valid input\r\n   */\r\n  private keyIsValid(key: string) {\r\n    return SearchBarComponent.invalidKeys.indexOf(key) === -1;\r\n  }\r\n\r\n  /**\r\n   * When the search term changes, emit an event and trigger a\r\n   * research in every enabled search sources.\r\n   * @param term Search term\r\n   */\r\n  private onSetTerm(term: string | undefined) {\r\n    this.searchTermChange.emit(term);\r\n    this.doSearch(term);\r\n  }\r\n\r\n  private handlePlaceholder() {\r\n    const searchTypes = [\r\n      ...new Set(\r\n        this.searchSourceService\r\n          .getEnabledSources()\r\n          .filter((ss) => !['map', 'coordinatesreverse'].includes(ss.getId()))\r\n          .map((ss) => ss.getType())\r\n      )\r\n    ];\r\n\r\n    let placeholder = `igo.geo.search.placeholder`;\r\n    if (searchTypes.length === 1) {\r\n      placeholder = `igo.geo.search.${searchTypes[0].toLowerCase()}.placeholder`;\r\n    } else if (searchTypes.length === 0) {\r\n      placeholder = `igo.geo.search.emptyType.placeholder`;\r\n    }\r\n    this.placeholder$.next(placeholder);\r\n  }\r\n\r\n  private onSetSearchType(searchType: string) {\r\n    if (searchType === undefined || searchType === null) {\r\n      return;\r\n    }\r\n\r\n    this.searchTypeChange.emit(searchType);\r\n\r\n    const placeholder = `igo.geo.search.${searchType.toLowerCase()}.placeholder`;\r\n    this.placeholder$.next(placeholder);\r\n\r\n    this.setTerm(this.term);\r\n  }\r\n\r\n  /**\r\n   * Execute the search\r\n   * @param term Search term\r\n   */\r\n  private doSearch(rawTerm: string | undefined) {\r\n    if (this.researches$$) {\r\n      this.researches$$.map((research) => research.unsubscribe());\r\n      this.researches$$ = undefined;\r\n    }\r\n\r\n    let terms;\r\n    if (this.termSplitter && rawTerm.match(new RegExp(this.termSplitter, 'g'))) {\r\n      terms = rawTerm.split(this.termSplitter).filter((t) => t.length >= this.minLength);\r\n      if (this.store) {\r\n        this.store.clear();\r\n      }\r\n    } else {\r\n      terms = [rawTerm];\r\n    }\r\n\r\n    let researches: Research[] = [];\r\n    terms.map((term: string) => {\r\n      const slug = term ? term.replace(/(#[^\\s]*)/g, '').trim() : '';\r\n      if (slug === '') {\r\n        if (this.store !== undefined) {\r\n          this.store.clear();\r\n        }\r\n        return;\r\n      }\r\n\r\n      researches = researches.concat(this.searchService.search(term, {\r\n        forceNA: this.forceNA\r\n      }));\r\n    });\r\n    this.researches$$ = researches.map((research) => {\r\n      return research.request.subscribe((results: SearchResult[]) => {\r\n        this.onResearchCompleted(research, results);\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * When a research  is completed, emit an event and update\r\n   * the store's items.\r\n   * @param research Research\r\n   * @param results Research results\r\n   */\r\n  private onResearchCompleted(research: Research, results: SearchResult[]) {\r\n    this.search.emit({ research, results });\r\n\r\n    if (this.store !== undefined) {\r\n      const newResults = this.store\r\n        .all()\r\n        .filter((result) => result.source !== research.source)\r\n        .concat(results);\r\n      this.store.updateMany(newResults);\r\n    }\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatMenuModule } from '@angular/material/menu';\r\nimport { MatRadioModule } from '@angular/material/radio';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { IgoSearchSelectorModule } from '../search-selector/search-selector.module';\r\nimport { IgoSearchSettingsModule } from '../search-settings/search-settings.module';\r\nimport { SearchBarComponent } from './search-bar.component';\r\nimport { SearchUrlParamDirective } from './search-url-param.directive';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    MatTooltipModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatMenuModule,\r\n    MatRadioModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    IgoLanguageModule,\r\n    IgoSearchSelectorModule,\r\n    IgoSearchSettingsModule\r\n  ],\r\n  exports: [\r\n    SearchBarComponent,\r\n  ],\r\n  declarations: [\r\n    SearchBarComponent,\r\n    SearchUrlParamDirective\r\n  ]\r\n})\r\nexport class IgoSearchBarModule {}\r\n","<mat-list-item>\r\n  <mat-icon *ngIf=\"icon\" mat-list-avatar svgIcon=\"{{showIcons ? icon : 'blank'}}\"></mat-icon>\r\n\r\n  <h4 matLine *ngIf=\"titleHtml\" [innerHtml]=\"titleHtml\" matTooltipShowDelay=\"500\" [matTooltip]=\"tooltipHtml\" matTooltipClass=\"search-result-tooltip\"></h4>\r\n  <h4 matLine *ngIf=\"!titleHtml\" matTooltipShowDelay=\"500\" [matTooltip]=\"title\">{{title}}</h4>\r\n\r\n  <button *ngIf=\"withZoomButton\"\r\n    igoStopPropagation\r\n    mat-icon-button\r\n    (click)=\"onZoomHandler()\">\r\n    <mat-icon svgIcon=\"magnify\"></mat-icon>\r\n  </button>\r\n\r\n  <ng-content\r\n    select=[igoSearchItemToolbar]>\r\n  </ng-content>\r\n\r\n</mat-list-item>\r\n","import { Component, Input, ChangeDetectionStrategy, EventEmitter, Output } from '@angular/core';\r\nimport olFormatGeoJSON from 'ol/format/GeoJSON';\r\n\r\nimport {\r\n  getEntityTitle,\r\n  getEntityTitleHtml,\r\n  getEntityIcon\r\n} from '@igo2/common';\r\n\r\nimport { SearchResult } from '../shared/search.interfaces';\r\nimport { FeatureMotion, moveToOlFeatures } from '../../feature';\r\nimport { IgoMap } from '../../map';\r\n\r\n/**\r\n * Search results list item\r\n */\r\n@Component({\r\n  selector: 'igo-search-results-item',\r\n  templateUrl: './search-results-item.component.html',\r\n  styleUrls: ['./search-results-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SearchResultsItemComponent {\r\n  /**\r\n   * Search result item\r\n   */\r\n  @Input() result: SearchResult;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * Search result title\r\n   * @internal\r\n   */\r\n\r\n  /**\r\n   * to show hide results icons\r\n   */\r\n  @Input() showIcons: boolean;\r\n\r\n  /**\r\n   * Whether there should be a zoom button\r\n   */\r\n  @Input() withZoomButton = false;\r\n\r\n  @Output() zoomEvent = new EventEmitter<boolean>();\r\n\r\n  private format = new olFormatGeoJSON();\r\n\r\n  get title(): string {\r\n    return getEntityTitle(this.result);\r\n  }\r\n\r\n  /**\r\n   * Search result HTML title\r\n   * @internal\r\n   */\r\n  get titleHtml(): string {\r\n    return getEntityTitleHtml(this.result);\r\n  }\r\n\r\n  /**\r\n   * Search result tooltip\r\n   * @internal\r\n   */\r\n  get tooltipHtml(): string {\r\n    return this.titleHtml\r\n      .replace(/<small?[^>]+(>|$)/g, '\\n')\r\n      .replace(/<\\/?[^>]+(>|$)/g, '');\r\n  }\r\n\r\n  /**\r\n   * Search result icon\r\n   * @internal\r\n   */\r\n  get icon(): string {\r\n    return getEntityIcon(this.result);\r\n  }\r\n\r\n  constructor() {}\r\n\r\n  onZoomHandler() {\r\n    const olFeature = this.format.readFeature(this.result.data, {\r\n      dataProjection: this.result.data.projection,\r\n      featureProjection: this.map.projection\r\n    });\r\n    moveToOlFeatures(this.map, [olFeature], FeatureMotion.Default);\r\n  }\r\n}\r\n","<igo-list [navigation]=\"true\">\r\n  <ng-template\r\n    #groupTemplate\r\n    ngFor let-group\r\n    [ngForOf]=\"results$ | async\">\r\n\r\n    <igo-collapsible [class]=\"group.source.getId()\"\r\n      *ngIf=\"mode === searchResultMode.Grouped; else flatTemplate\"\r\n      [title]=\"computeGroupTitle(group)\"\r\n      [collapsed]=\"collapsed[group.source.title]\"\r\n      (toggle)=\"collapsed[group.source.title] = $event\">\r\n      <ng-container *ngTemplateOutlet=\"storeItemTemplate; context: {results: group.results}\"></ng-container>\r\n    </igo-collapsible>\r\n\r\n    <ng-template #flatTemplate>\r\n      <ng-container *ngTemplateOutlet=\"storeItemTemplate; context: {results: group.results}\"></ng-container>\r\n    </ng-template>\r\n\r\n    <ng-template #storeItemTemplate let-results=\"results\">\r\n      <ng-template ngFor let-result [ngForOf]=\"results\">\r\n        <igo-search-results-item\r\n          igoListItem\r\n          color=\"accent\"\r\n          [map]=\"map\"\r\n          [result]=\"result\"\r\n          [showIcons]=\"showIcons\"\r\n          [withZoomButton]=\"withZoomButton\"\r\n          [focused]=\"store.state.get(result).focused\"\r\n          [selected]=\"store.state.get(result).selected\"\r\n          (focus)=\"resultFocus.emit(result)\"\r\n          (unfocus)=\"resultUnfocus.emit(result)\"\r\n          (select)=\"onResultSelect(result)\"\r\n          (mouseenter)=\"resultFocus.emit(result)\"\r\n          (mouseleave)=\"resultUnfocus.emit(result)\">\r\n\r\n          <ng-container igoSearchItemToolbar\r\n            [ngTemplateOutlet]=\"templateSearchToolbar\"\r\n            [ngTemplateOutletContext]=\"{result: result}\">\r\n          </ng-container>\r\n\r\n        </igo-search-results-item>\r\n      </ng-template>\r\n      <span class=\"moreResults mat-typography\" *ngIf=\"isMoreResults(group)\" (click)=\"displayMoreResults(group)\">\r\n        <u>{{ 'igo.geo.search.displayMoreResults' | translate }}</u>\r\n      </span>\r\n    </ng-template>\r\n\r\n  </ng-template>\r\n\r\n</igo-list>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ContentChild,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\nimport type { TemplateRef } from '@angular/core';\r\n\r\nimport { Observable, EMPTY, timer, BehaviorSubject, Subscription } from 'rxjs';\r\nimport { debounce, map } from 'rxjs/operators';\r\n\r\nimport { EntityState, EntityStore, EntityStoreFilterCustomFuncStrategy, EntityStoreWatcher } from '@igo2/common';\r\n\r\nimport { IgoMap } from '../../map';\r\n\r\nimport { TextSearchOptions } from '../shared/sources/source.interfaces';\r\nimport { SearchService } from '../shared/search.service';\r\nimport { SearchResult, Research } from '../shared/search.interfaces';\r\nimport { SearchSource } from '../shared/sources/source';\r\n\r\nexport enum SearchResultMode {\r\n  Grouped = 'grouped',\r\n  Flat = 'flat'\r\n}\r\n\r\n/**\r\n * List of search results with focus and selection capabilities.\r\n * This component is dumb and only emits events.\r\n */\r\n@Component({\r\n  selector: 'igo-search-results',\r\n  templateUrl: './search-results.component.html',\r\n  styleUrls: ['./search-results.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SearchResultsComponent implements OnInit, OnDestroy {\r\n  /**\r\n   * Reference to the SearchResultMode enum\r\n   * @internal\r\n   */\r\n  public searchResultMode = SearchResultMode;\r\n\r\n  /**\r\n   * Search results store watcher\r\n   */\r\n  private watcher: EntityStoreWatcher<SearchResult>;\r\n\r\n  private settingsChange$$: Subscription;\r\n\r\n  public pageIterator: {sourceId: string}[] = [];\r\n\r\n  public collapsed: {sourceId: string}[] = [];\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * Search results store\r\n   */\r\n  @Input() store: EntityStore<SearchResult>;\r\n\r\n  /**\r\n   * to show hide results icons\r\n   */\r\n  @Input() showIcons: boolean;\r\n\r\n  /**\r\n   * Search results display mode\r\n   */\r\n  @Input() mode: SearchResultMode = SearchResultMode.Grouped;\r\n\r\n  /**\r\n   * Whether there should be a zoom button\r\n   */\r\n  @Input() withZoomButton = false;\r\n\r\n  /**\r\n   * Search term\r\n   */\r\n  @Input()\r\n  get term(): string {\r\n    return this._term;\r\n  }\r\n  set term(value: string) {\r\n    this._term = value;\r\n    this.pageIterator = [];\r\n  }\r\n  public _term: string;\r\n\r\n  @Input() settingsChange$ = new BehaviorSubject<boolean>(undefined);\r\n\r\n  @Input() termSplitter: string = '|';\r\n\r\n  /**\r\n   * Event emitted when a result is focused\r\n   */\r\n  @Output() resultFocus = new EventEmitter<SearchResult>();\r\n\r\n  /**\r\n   * Event emitted when a result is unfocused\r\n   */\r\n  @Output() resultUnfocus = new EventEmitter<SearchResult>();\r\n\r\n  /**\r\n   * Event emitted when a result is selected\r\n   */\r\n  @Output() resultSelect = new EventEmitter<SearchResult>();\r\n\r\n  /**\r\n   * Event emitted when a research is completed after displaying more results is clicked\r\n   */\r\n  @Output() moreResults = new EventEmitter<{\r\n    research: Research;\r\n    results: SearchResult[];\r\n  }>();\r\n\r\n  /**\r\n   * Events emitted when a result is focus or unfocus by mouse event\r\n   */\r\n  @Output() resultMouseenter = new EventEmitter<SearchResult>();\r\n  @Output() resultMouseleave = new EventEmitter<SearchResult>();\r\n\r\n  @ContentChild('igoSearchItemToolbar', /* TODO: add static flag */ {}) templateSearchToolbar: TemplateRef<any>;\r\n\r\n  get results$(): Observable<{source: SearchSource; results: SearchResult[]}[]> {\r\n    if (this._results$ === undefined) {\r\n      this._results$ = this.liftResults();\r\n    }\r\n    return this._results$;\r\n  }\r\n  private _results$: Observable<\r\n    {source: SearchSource; results: SearchResult[]}[]\r\n  >;\r\n\r\n  constructor(private cdRef: ChangeDetectorRef,\r\n              private searchService: SearchService) {}\r\n\r\n  /**\r\n   * Bind the search results store to the watcher\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.watcher = new EntityStoreWatcher(this.store, this.cdRef);\r\n\r\n    this.settingsChange$$ = this.settingsChange$.subscribe(() => {\r\n      this.pageIterator = [];\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Unbind the search results store from the watcher\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.watcher.destroy();\r\n    this.settingsChange$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * Compute a group title\r\n   * @param group Search results group\r\n   * @returns Group title\r\n   * @internal\r\n   */\r\n  computeGroupTitle(group: {source: SearchSource; results: SearchResult[]}): string {\r\n    const parts = [group.source.title];\r\n    const count = group.results.length;\r\n    if (count > 1) {\r\n      parts.push(`(${count})`);\r\n    }\r\n    return parts.join(' ');\r\n  }\r\n\r\n  /**\r\n   * When a result is selected, update it's state in the store and emit\r\n   * an event. A selected result is also considered focused\r\n   * @param result Search result\r\n   * @internal\r\n   */\r\n  onResultSelect(result: SearchResult) {\r\n    if (this.store.state.get(result)) {\r\n      if (this.store.state.get(result).selected === true) {\r\n        return;\r\n      }\r\n    }\r\n    this.store.state.update(result, {focused: true, selected: true}, true);\r\n    this.resultSelect.emit(result);\r\n  }\r\n\r\n  /**\r\n   * Return an observable of the search results, grouped by search source\r\n   * @returns Observable of grouped search results\r\n   * @internal\r\n   */\r\n   private liftResults(): Observable<{source: SearchSource; results: SearchResult[]}[]> {\r\n    return this.store.stateView.all$().pipe(\r\n      debounce((results: {entity: SearchResult, state: EntityState}[]) => {\r\n        return results.length === 0 ? EMPTY : timer(200);\r\n      }),\r\n      map((results: {entity: SearchResult, state: EntityState}[]) => {\r\n        return this.groupResults(results.map(r => r.entity).sort(this.sortByOrder));\r\n      })\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Sort the results by display order.\r\n   * @param r1 First result\r\n   * @param r2 Second result\r\n   */\r\n  private sortByOrder(r1: SearchResult, r2: SearchResult) {\r\n    return r1.source.displayOrder - r2.source.displayOrder;\r\n  }\r\n\r\n  /**\r\n   * Group results by search source\r\n   * @param results Search results from all sources\r\n   * @returns Search results grouped by source\r\n   */\r\n  private groupResults(results: SearchResult[]): {source: SearchSource; results: SearchResult[]}[] {\r\n    const grouped = new Map<SearchSource, SearchResult[]>();\r\n    results.forEach((result: SearchResult) => {\r\n      const source = result.source;\r\n      let sourceResults = grouped.get(source);\r\n      if (sourceResults === undefined) {\r\n        sourceResults = [];\r\n        grouped.set(source, sourceResults);\r\n      }\r\n      sourceResults.push(result);\r\n    });\r\n\r\n    return Array.from(grouped.keys()).map((source: SearchSource) => {\r\n      if (this.pageIterator[source.getId()] === undefined) {\r\n        this.pageIterator[source.getId()] = 1;\r\n      }\r\n      return {source, results: grouped.get(source)};\r\n    });\r\n  }\r\n\r\n  isMoreResults(group: { source: SearchSource; results: SearchResult[] }) {\r\n    // getStrategyOfType is to avoid display more result based on a filtered state\r\n    const stategy = this.store.getStrategyOfType(EntityStoreFilterCustomFuncStrategy);\r\n    const active = stategy?.active || false;\r\n    return !active && group.results &&\r\n      group.results[group.results.length - 1].meta.nextPage === true;\r\n  }\r\n\r\n  displayMoreResults(group: {source: SearchSource; results: SearchResult[]}) {\r\n    const options: TextSearchOptions = {\r\n      sourceId: group.source.getId(),\r\n      page: ++this.pageIterator[group.source.getId()]\r\n    };\r\n\r\n    let terms;\r\n    if (this.termSplitter && this.term.match(new RegExp(this.termSplitter, 'g'))) {\r\n      terms = this.term.split(this.termSplitter);\r\n    } else {\r\n      terms = [this.term];\r\n    }\r\n\r\n    let researches: Research[] = [];\r\n    terms.map((term: string) => {\r\n      researches = researches.concat(this.searchService.search(term, options));\r\n    });\r\n\r\n    researches.map(research => {\r\n      research.request.subscribe((results: SearchResult[]) => {\r\n        const newResults = group.results.concat(results);\r\n        if (!results.length) {\r\n          newResults[newResults.length - 1].meta.nextPage = false;\r\n        }\r\n        this.moreResults.emit({research, results: newResults});\r\n      });\r\n    });\r\n    return;\r\n  }\r\n}\r\n","<button\r\nigoStopPropagation\r\n(mouseenter)=\"onMouseEvent($event)\" (mouseleave)=\"onMouseEvent($event)\"\r\n*ngIf=\"layer.meta.dataType === 'Layer'\"\r\nmat-icon-button\r\ntooltip-position=\"below\"\r\nmatTooltipShowDelay=\"500\"\r\n[matTooltip]=\"(tooltip$ | async) | translate\"\r\n[color]=\"(isPreview$ | async) ? '' : added ? 'warn' : ''\"\r\n(click)=\"onToggleClick($event)\">\r\n<mat-icon\r\n  matBadge=\"icon\"\r\n  igoMatBadgeIcon=\"eye-off\"\r\n  igoMatBadgeInverseColor=\"true\"\r\n  [matBadgeHidden]=\"(inRange$ | async)\"\r\n  matBadgeDisabled=\"true\"\r\n  matBadgeSize=\"small\"\r\n  matBadgePosition=\"after\"\r\n  [svgIcon]=\"(isPreview$ | async) ? 'plus' : added ? 'delete' : 'plus'\">\r\n</mat-icon>\r\n</button>\r\n","import {\r\n  Component,\r\n  Input,\r\n  ChangeDetectionStrategy,\r\n  OnInit,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { SearchResult } from '../shared/search.interfaces';\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { LayerOptions } from '../../layer/shared/layers/layer.interface';\r\nimport { LayerService } from '../../layer/shared/layer.service';\r\nimport { LAYER } from '../../layer/shared/layer.enums';\r\nimport { Subscription, BehaviorSubject } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'igo-search-add-button',\r\n  templateUrl: './search-results-add-button.component.html',\r\n  styleUrls: ['./search-results-add-button.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class SearchResultAddButtonComponent implements OnInit, OnDestroy {\r\n  public tooltip$: BehaviorSubject<string> = new BehaviorSubject(\r\n    'igo.geo.catalog.layer.addToMap'\r\n  );\r\n\r\n  private resolution$$: Subscription;\r\n\r\n  public inRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  public isPreview$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  private layersSubcriptions = [];\r\n\r\n  private lastTimeoutRequest;\r\n\r\n  private mouseInsideAdd: boolean = false;\r\n\r\n  @Input() layer: SearchResult;\r\n\r\n  /**\r\n   * Whether the layer is already added to the map\r\n   */\r\n  @Input() added: boolean;\r\n\r\n  /**\r\n   * The map to add the search result layer to\r\n   */\r\n  @Input() map: IgoMap;\r\n\r\n  @Input()\r\n  get color() {\r\n    return this._color;\r\n  }\r\n  set color(value: string) {\r\n    this._color = value;\r\n  }\r\n  private _color = 'primary';\r\n\r\n  constructor(private layerService: LayerService) {}\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnInit(): void {\r\n    if (this.layer.meta.dataType === 'Layer') {\r\n      this.added =\r\n        this.map.layers.findIndex(\r\n          lay => lay.id === this.layer.data.sourceOptions.id\r\n        ) !== -1;\r\n    }\r\n    this.resolution$$ = this.map.viewController.resolution$.subscribe(value => {\r\n      this.isInResolutionsRange(value);\r\n      this.tooltip$.next(this.computeTooltip());\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.resolution$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * On mouse event, mouseenter /mouseleave\r\n   * @internal\r\n   */\r\n  onMouseEvent(event) {\r\n    this.onToggleClick(event);\r\n  }\r\n\r\n  /**\r\n   * On toggle button click, emit the added change event\r\n   * @internal\r\n   */\r\n  onToggleClick(event) {\r\n    if (typeof this.lastTimeoutRequest !== 'undefined') {\r\n      clearTimeout(this.lastTimeoutRequest);\r\n    }\r\n\r\n    if (event.type === 'mouseenter' && this.mouseInsideAdd ) {\r\n      return;\r\n    }\r\n    switch (event.type) {\r\n      case 'click':\r\n        if (!this.isPreview$.value) {\r\n          if (this.added) {\r\n            this.remove();\r\n          } else {\r\n            this.add();\r\n          }\r\n        }\r\n        this.isPreview$.next(false);\r\n        break;\r\n      case 'mouseenter':\r\n        if (!this.isPreview$.value && !this.added) {\r\n          this.lastTimeoutRequest = setTimeout(() => {\r\n            this.add();\r\n            this.isPreview$.next(true);\r\n          }, 500);\r\n        }\r\n        this.mouseInsideAdd = true;\r\n        break;\r\n      case 'mouseleave':\r\n        if (this.isPreview$.value) {\r\n          this.remove();\r\n          this.isPreview$.next(false);\r\n        }\r\n        this.mouseInsideAdd = false;\r\n        break;\r\n      default:\r\n        break;\r\n    }\r\n  }\r\n\r\n  private add() {\r\n    if (!this.added) {\r\n      this.added = true;\r\n      this.addLayerToMap();\r\n    }\r\n  }\r\n\r\n  private remove() {\r\n    if (this.added) {\r\n      this.added = false;\r\n      this.removeLayerFromMap();\r\n      this.layersSubcriptions.map(s => s.unsubscribe());\r\n      this.layersSubcriptions = [];\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Emit added change event with added = true\r\n   */\r\n  private addLayerToMap() {\r\n    if (this.map === undefined) {\r\n      return;\r\n    }\r\n\r\n    if (this.layer.meta.dataType !== LAYER) {\r\n      return undefined;\r\n    }\r\n\r\n    const layerOptions = (this.layer as SearchResult<LayerOptions>).data;\r\n    if (layerOptions.sourceOptions.optionsFromApi === undefined) {\r\n      layerOptions.sourceOptions.optionsFromApi = true;\r\n    }\r\n    this.layersSubcriptions.push(\r\n      this.layerService\r\n        .createAsyncLayer(layerOptions)\r\n        .subscribe(layer => this.map.addLayer(layer))\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Emit added change event with added = false\r\n   */\r\n  private removeLayerFromMap() {\r\n    if (this.map === undefined) {\r\n      return;\r\n    }\r\n\r\n    if (this.layer.meta.dataType !== LAYER) {\r\n      return undefined;\r\n    }\r\n\r\n    const oLayer = this.map.getLayerById(this.layer.data.sourceOptions.id);\r\n    this.map.removeLayer(oLayer);\r\n  }\r\n\r\n  isInResolutionsRange(resolution: number) {\r\n    const minResolution = this.layer.data.minResolution || 0;\r\n    const maxResolution = this.layer.data.maxResolution || Infinity;\r\n    this.inRange$.next(\r\n      resolution >= minResolution && resolution <= maxResolution\r\n    );\r\n  }\r\n\r\n  computeTooltip(): string {\r\n    if (this.added) {\r\n      return this.inRange$.value\r\n        ? 'igo.geo.catalog.layer.removeFromMap'\r\n        : 'igo.geo.catalog.layer.removeFromMapOutRange';\r\n    } else {\r\n      return this.inRange$.value\r\n        ? 'igo.geo.catalog.layer.addToMap'\r\n        : 'igo.geo.catalog.layer.addToMapOutRange';\r\n    }\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport {\r\n  IgoCollapsibleModule,\r\n  IgoListModule,\r\n  IgoMatBadgeIconModule,\r\n  IgoStopPropagationModule\r\n} from '@igo2/common';\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { IgoMetadataModule } from './../../metadata/metadata.module';\r\nimport { SearchResultsComponent } from './search-results.component';\r\nimport { SearchResultsItemComponent } from './search-results-item.component';\r\nimport { SearchResultAddButtonComponent } from './search-results-add-button.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatBadgeModule,\r\n    MatTooltipModule,\r\n    MatIconModule,\r\n    MatListModule,\r\n    MatButtonModule,\r\n    IgoCollapsibleModule,\r\n    IgoListModule,\r\n    IgoStopPropagationModule,\r\n    IgoLanguageModule,\r\n    IgoMatBadgeIconModule,\r\n    IgoMetadataModule,\r\n  ],\r\n  exports: [\r\n    SearchResultsComponent,\r\n    SearchResultAddButtonComponent\r\n  ],\r\n  declarations: [\r\n    SearchResultsComponent,\r\n    SearchResultsItemComponent,\r\n    SearchResultAddButtonComponent\r\n  ]\r\n})\r\nexport class IgoSearchResultsModule {}\r\n","import { FeatureGeometry } from './../../feature/shared/feature.interfaces';\r\nimport {\r\n  Directive,\r\n  Input,\r\n  OnDestroy,\r\n  Self,\r\n  OnInit,\r\n  AfterContentChecked\r\n} from '@angular/core';\r\n\r\nimport { Subscription } from 'rxjs';\r\n\r\nimport MapBrowserPointerEvent from 'ol/MapBrowserEvent';\r\n\r\nimport { IgoMap } from '../../map/shared/map';\r\nimport { MapBrowserComponent } from '../../map/map-browser/map-browser.component';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport { SearchService } from './search.service';\r\n\r\nimport olFeature from 'ol/Feature';\r\nimport { transform } from 'ol/proj';\r\nimport * as olstyle from 'ol/style';\r\nimport * as olgeom from 'ol/geom';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport { SearchResult, Research } from './search.interfaces';\r\nimport { EntityStore } from '@igo2/common';\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { VectorLayer } from '../../layer/shared/layers/vector-layer';\r\nimport { take } from 'rxjs/operators';\r\nimport { tryBindStoreLayer } from '../../feature/shared/feature.utils';\r\nimport { FeatureStore } from '../../feature/shared/store';\r\nimport { FeatureMotion, FEATURE } from '../../feature/shared/feature.enums';\r\nimport { SearchSourceService } from './search-source.service';\r\nimport { sourceCanReverseSearchAsSummary } from './search.utils';\r\nimport { MediaService } from '@igo2/core';\r\nimport { unByKey } from 'ol/Observable';\r\n\r\n/**\r\n * This directive makes the mouse coordinate trigger a reverse search on available search sources.\r\n * The search results are placed into a label, on a cross icon, representing the mouse coordinate.\r\n * By default, no search sources. Config in config file must be defined.\r\n * the layer level.\r\n */\r\n@Directive({\r\n  selector: '[igoSearchPointerSummary]'\r\n})\r\nexport class SearchPointerSummaryDirective implements OnInit, OnDestroy, AfterContentChecked {\r\n\r\n  public store: FeatureStore<Feature>;\r\n  private lonLat: [number, number];\r\n  private pointerSearchStore: EntityStore<SearchResult> = new EntityStore<SearchResult>([]);\r\n  private lastTimeoutRequest;\r\n  private store$$: Subscription;\r\n  private layers$$: Subscription;\r\n  private reverseSearch$$: Subscription[] = [];\r\n  private hasPointerReverseSearchSource: boolean = false;\r\n\r\n  /**\r\n   * Listener to the pointer move event\r\n   */\r\n  private pointerMoveListener;\r\n\r\n  private searchPointerSummaryFeatureId: string = 'searchPointerSummaryFeatureId';\r\n  /**\r\n   * The delay where the mouse must be motionless before trigger the reverse search\r\n   */\r\n  @Input() igoSearchPointerSummaryDelay: number = 1000;\r\n\r\n  /**\r\n   * If the user has enabled or not the directive\r\n   */\r\n  @Input() igoSearchPointerSummaryEnabled: boolean = false;\r\n\r\n  /**\r\n   * IGO map\r\n   * @internal\r\n   */\r\n  get map(): IgoMap {\r\n    return this.component.map;\r\n  }\r\n\r\n  get mapProjection(): string {\r\n    return (this.component.map as IgoMap).projection;\r\n  }\r\n\r\n  constructor(\r\n    @Self() private component: MapBrowserComponent,\r\n    private searchService: SearchService,\r\n    private searchSourceService: SearchSourceService,\r\n    private mediaService: MediaService\r\n  ) { }\r\n\r\n  /**\r\n   * Start listening to pointermove and reverse search results.\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.listenToMapPointerMove();\r\n    this.subscribeToPointerStore();\r\n\r\n    this.map.status$.pipe(take(1)).subscribe(() => {\r\n      this.store = new FeatureStore<Feature>([], {map: this.map});\r\n      this.initStore();\r\n    });\r\n\r\n    // To handle context change without using the contextService.\r\n    this.layers$$ = this.map.layers$.subscribe((layers) => {\r\n      if (this.store && !layers.find(l => l.id === 'searchPointerSummaryId')) {\r\n        this.initStore();\r\n      }\r\n    });\r\n\r\n  }\r\n\r\n  /**\r\n   * Initialize the pointer position store\r\n   * @internal\r\n   */\r\n  private initStore() {\r\n    const store = this.store;\r\n\r\n    const layer = new VectorLayer({\r\n      isIgoInternalLayer: true,\r\n      id : 'searchPointerSummaryId',\r\n      title: 'searchPointerSummary',\r\n      zIndex: 900,\r\n      source: new FeatureDataSource(),\r\n      showInLayerList: false,\r\n      exportable: false,\r\n      browsable: false,\r\n      style: pointerPositionSummaryMarker\r\n    });\r\n    tryBindStoreLayer(store, layer);\r\n  }\r\n\r\n  ngAfterContentChecked(): void {\r\n      if (!this.searchSourceService.getEnabledSources().filter(sourceCanReverseSearchAsSummary).length) {\r\n        this.hasPointerReverseSearchSource = false;\r\n      } else {\r\n        this.hasPointerReverseSearchSource = true;\r\n      }\r\n    }\r\n\r\n  /**\r\n   * Stop listening to pointermove and reverse search results.\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.unlistenToMapPointerMove();\r\n    this.unsubscribeToPointerStore();\r\n    this.unsubscribeReverseSearch();\r\n    this.layers$$.unsubscribe();\r\n  }\r\n\r\n  /**\r\n   * Subscribe to pointermove result store\r\n   * @internal\r\n   */\r\n  subscribeToPointerStore() {\r\n    this.store$$ = this.pointerSearchStore.entities$.subscribe(resultsUnderPointerPosition => {\r\n      this.entitiesToPointerOverlay(resultsUnderPointerPosition);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Build an object based on the closest feature by type (base on type and distance properties )\r\n   * @param results SearchResult[]\r\n   * @returns OL style function\r\n   */\r\n  private computeSummaryClosestFeature(results: SearchResult[]): {} {\r\n    const closestResultByType = {};\r\n\r\n    results.map(result => {\r\n      if (result.data.properties.type && result.data.properties.distance >= 0) {\r\n        if (closestResultByType.hasOwnProperty(result.data.properties.type)) {\r\n          const prevDistance = closestResultByType[result.data.properties.type].distance;\r\n          if (result.data.properties.distance < prevDistance) {\r\n            const title = result.meta.pointerSummaryTitle || result.meta.title;\r\n            closestResultByType[result.data.properties.type] = { distance: result.data.properties.distance, title };\r\n          }\r\n        } else {\r\n          const title = result.meta.pointerSummaryTitle || result.meta.title;\r\n          closestResultByType[result.data.properties.type] = { distance: result.data.properties.distance, title };\r\n        }\r\n      }\r\n    });\r\n\r\n    return closestResultByType;\r\n  }\r\n\r\n  /**\r\n   * convert store entities to a pointer position overlay with label summary on.\r\n   * @param event OL map browser pointer event\r\n   */\r\n  private entitiesToPointerOverlay(resultsUnderPointerPosition: SearchResult[]) {\r\n    const closestResultByType = this.computeSummaryClosestFeature(resultsUnderPointerPosition);\r\n    const summarizedClosestType = Object.keys(closestResultByType);\r\n    const processedSummarizedClosestType = [];\r\n    const summary = [];\r\n    resultsUnderPointerPosition.map(result => {\r\n      const typeIndex = summarizedClosestType.indexOf(result.data.properties.type);\r\n      if (typeIndex !== -1) {\r\n        summary.push(closestResultByType[result.data.properties.type].title);\r\n        summarizedClosestType.splice(typeIndex, 1);\r\n        processedSummarizedClosestType.push(result.data.properties.type);\r\n      } else {\r\n        if (processedSummarizedClosestType.indexOf(result.data.properties.type) === -1) {\r\n          summary.push(result.meta.pointerSummaryTitle || result.meta.title);\r\n        }\r\n      }\r\n    });\r\n    if (summary.length) {\r\n      this.addPointerOverlay(summary.join('\\n'));\r\n    }\r\n  }\r\n\r\n  /**\r\n   * On map pointermove\r\n   */\r\n  private listenToMapPointerMove() {\r\n    this.pointerMoveListener = this.map.ol.on(\r\n      'pointermove',\r\n      (event: MapBrowserPointerEvent<any>) => this.onMapEvent(event)\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe to pointer store.\r\n   * @internal\r\n   */\r\n  unsubscribeToPointerStore() {\r\n    this.store$$.unsubscribe();\r\n  }\r\n  /**\r\n   * Unsubscribe to reverse seatch store.\r\n   * @internal\r\n   */\r\n  unsubscribeReverseSearch() {\r\n    this.reverseSearch$$.map(s => s.unsubscribe());\r\n    this.reverseSearch$$ = [];\r\n  }\r\n\r\n  /**\r\n   * Stop listening for map pointermove\r\n   * @internal\r\n   */\r\n  private unlistenToMapPointerMove() {\r\n    unByKey(this.pointerMoveListener);\r\n    this.pointerMoveListener = undefined;\r\n  }\r\n\r\n  /**\r\n   * Trigger reverse search when the mouse is motionless during the defined delay (pointerMoveDelay).\r\n   * @param event OL map browser pointer event\r\n   */\r\n  private onMapEvent(event: MapBrowserPointerEvent<any>) {\r\n    if (\r\n      event.dragging || !this.igoSearchPointerSummaryEnabled ||\r\n      !this.hasPointerReverseSearchSource || this.mediaService.isTouchScreen()) {\r\n      this.clearLayer();\r\n      return;\r\n    }\r\n    if (typeof this.lastTimeoutRequest !== 'undefined') { // cancel timeout when the mouse moves\r\n      clearTimeout(this.lastTimeoutRequest);\r\n      this.clearLayer();\r\n      this.unsubscribeReverseSearch();\r\n    }\r\n\r\n    this.lonLat = transform(event.coordinate, this.mapProjection, 'EPSG:4326') as [number, number];\r\n\r\n    this.lastTimeoutRequest = setTimeout(() => {\r\n      this.onSearchCoordinate();\r\n    }, this.igoSearchPointerSummaryDelay);\r\n  }\r\n\r\n    /**\r\n   * Sort the results by display order.\r\n   * @param r1 First result\r\n   * @param r2 Second result\r\n   */\r\n     private sortByOrder(r1: SearchResult, r2: SearchResult) {\r\n      return r1.source.displayOrder - r2.source.displayOrder;\r\n    }\r\n\r\n  private onSearchCoordinate() {\r\n    this.pointerSearchStore.clear();\r\n    const results = this.searchService.reverseSearch(this.lonLat, { params: { geometry: 'false', icon: 'false' } }, true);\r\n\r\n    for (const i in results) {\r\n      if (results.length > 0) {\r\n        this.reverseSearch$$.push(\r\n          results[i].request.subscribe((_results: SearchResult<Feature>[]) => {\r\n            this.onSearch({ research: results[i], results: _results });\r\n          }));\r\n      }\r\n    }\r\n  }\r\n\r\n  private onSearch(event: { research: Research; results: SearchResult[] }) {\r\n    const results = event.results;\r\n    const newResults = this.pointerSearchStore.all()\r\n      .filter((result: SearchResult) => result.source !== event.research.source)\r\n      .concat(results);\r\n    this.pointerSearchStore.load(newResults.sort(this.sortByOrder));\r\n  }\r\n\r\n  /**\r\n   * Add a feature to the pointer store\r\n   * @param text string\r\n   */\r\n  private addPointerOverlay(text: string) {\r\n    this.clearLayer();\r\n\r\n    const geometry = new olgeom.Point(\r\n      transform(this.lonLat, 'EPSG:4326', this.mapProjection)\r\n    );\r\n    const feature = new olFeature({ geometry });\r\n    const geojsonGeom = new OlGeoJSON().writeGeometryObject(geometry, {\r\n      featureProjection: this.mapProjection,\r\n      dataProjection: this.mapProjection\r\n    }) as FeatureGeometry;\r\n\r\n    const f: Feature = {\r\n      type: FEATURE,\r\n      geometry: geojsonGeom,\r\n      projection: this.mapProjection,\r\n      properties: {\r\n        id: this.searchPointerSummaryFeatureId,\r\n        pointerSummary: text\r\n      },\r\n      meta: {\r\n        id: this.searchPointerSummaryFeatureId\r\n      },\r\n      ol: feature\r\n    };\r\n    this.store.setLayerFeatures([f], FeatureMotion.None);\r\n  }\r\n\r\n/**\r\n * Clear the pointer store features\r\n */\r\nprivate clearLayer() {\r\n  if (this.store) {\r\n    this.store.clearLayer();\r\n  }\r\n}\r\n\r\n}\r\n\r\n/**\r\n * Create a default style for the pointer position and it's label summary.\r\n * @param feature OlFeature\r\n * @returns OL style function\r\n */\r\nexport function pointerPositionSummaryMarker(feature: olFeature<OlGeometry>, resolution: number): olstyle.Style {\r\n  return new olstyle.Style({\r\n    image: new olstyle.Icon({\r\n      src: './assets/igo2/geo/icons/cross_black_18px.svg',\r\n      imgSize: [18, 18], // for ie\r\n    }),\r\n\r\n    text: new olstyle.Text({\r\n      text: feature.get('pointerSummary'),\r\n      textAlign: 'left',\r\n      textBaseline: 'bottom',\r\n      font: '12px Calibri,sans-serif',\r\n      fill: new olstyle.Fill({ color: '#000' }),\r\n      backgroundFill: new olstyle.Fill({ color: 'rgba(255, 255, 255, 0.5)' }),\r\n      backgroundStroke: new olstyle.Stroke({ color: 'rgba(200, 200, 200, 0.75)', width: 2 }),\r\n      stroke: new olstyle.Stroke({ color: '#fff', width: 3 }),\r\n      overflow: true,\r\n      offsetX: 10,\r\n      offsetY: -10,\r\n      padding: [2.5, 2.5, 2.5, 2.5]\r\n    })\r\n  });\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { SearchService } from './shared/search.service';\r\nimport { provideSearchSourceService } from './shared/search-source-service.providers';\r\nimport { provideDefaultIChercheSearchResultFormatter } from './shared/sources/icherche.providers';\r\nimport { provideDefaultCoordinatesSearchResultFormatter } from './shared/sources/coordinates.providers';\r\nimport { provideILayerSearchResultFormatter } from './shared/sources/ilayer.providers';\r\n\r\nimport { IgoSearchBarModule } from './search-bar/search-bar.module';\r\nimport { IgoSearchSelectorModule } from './search-selector/search-selector.module';\r\nimport { IgoSearchResultsModule } from './search-results/search-results.module';\r\nimport { IgoSearchSettingsModule } from './search-settings/search-settings.module';\r\nimport { SearchPointerSummaryDirective } from './shared/search-pointer-summary.directive';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoSearchBarModule,\r\n    IgoSearchSelectorModule,\r\n    IgoSearchResultsModule,\r\n    IgoSearchSettingsModule\r\n  ],\r\n  exports: [\r\n    IgoSearchBarModule,\r\n    IgoSearchSelectorModule,\r\n    IgoSearchResultsModule,\r\n    IgoSearchSettingsModule,\r\n    SearchPointerSummaryDirective\r\n  ],\r\n  declarations: [SearchPointerSummaryDirective]\r\n})\r\nexport class IgoSearchModule {\r\n  static forRoot(): ModuleWithProviders<IgoSearchModule> {\r\n    return {\r\n      ngModule: IgoSearchModule,\r\n      providers: [\r\n        SearchService,\r\n        provideSearchSourceService(),\r\n        provideDefaultIChercheSearchResultFormatter(),\r\n        provideDefaultCoordinatesSearchResultFormatter(),\r\n        provideILayerSearchResultFormatter()\r\n      ]\r\n    };\r\n  }\r\n}\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\n\r\nimport { OnUpdateInputs, WidgetComponent } from '@igo2/common';\r\n\r\nimport { Layer } from '../../../layer/shared/layers/layer';\r\nimport { IgoMap } from '../../../map/shared/map';\r\n\r\n@Component({\r\n  selector: 'igo-ogc-filter',\r\n  templateUrl: './ogc-filter.component.html',\r\n  styleUrls: ['./ogc-filter.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class OgcFilterComponent implements OnUpdateInputs, WidgetComponent {\r\n\r\n  @Input() layer: Layer;\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  /**\r\n   * Event emitted on complete\r\n   */\r\n  @Output() complete = new EventEmitter<void>();\r\n\r\n  /**\r\n   * Event emitted on cancel\r\n   */\r\n  @Output() cancel = new EventEmitter<void>();\r\n\r\n  constructor(private cdRef: ChangeDetectorRef) {}\r\n\r\n  /**\r\n   * Implemented as part of OnUpdateInputs\r\n   */\r\n  onUpdateInputs() {\r\n    this.cdRef.detectChanges();\r\n  }\r\n\r\n  /**\r\n   * On close, emit the cancel event\r\n   */\r\n  onClose() {\r\n    this.cancel.emit();\r\n  }\r\n\r\n}\r\n","<igo-ogc-filterable-item\r\n  igoListItem\r\n  [layer]=\"layer\"\r\n  [header]=\"false\" \r\n  [map]=\"map\" >\r\n</igo-ogc-filterable-item>","import { InjectionToken } from '@angular/core';\r\n\r\nimport { Widget, WidgetService } from '@igo2/common';\r\n\r\nimport { OgcFilterComponent } from './ogc-filter/ogc-filter.component';\r\n\r\nexport const OgcFilterWidget = new InjectionToken<Widget>('OgcFilterWidget');\r\n\r\nexport function ogcFilterWidgetFactory(widgetService: WidgetService): Widget {\r\n  return widgetService.create(OgcFilterComponent);\r\n}\r\n\r\nexport function provideOgcFilterWidget() {\r\n  return {\r\n    provide: OgcFilterWidget,\r\n    useFactory: ogcFilterWidgetFactory,\r\n    deps: [WidgetService]\r\n  };\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\n\r\nimport { IgoFilterModule } from '../../../filter/filter.module';\r\nimport { OgcFilterComponent } from './ogc-filter.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatButtonModule,\r\n    IgoLanguageModule,\r\n    IgoFilterModule\r\n  ],\r\n  exports: [OgcFilterComponent],\r\n  declarations: [OgcFilterComponent]\r\n})\r\nexport class IgoOgcFilterModule {}\r\n","import {\r\n  Workspace,\r\n  WorkspaceOptions\r\n} from '@igo2/common';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { VectorLayer } from '../../layer';\r\nimport { IgoMap } from '../../map';\r\n\r\nexport interface WfsWorkspaceOptions extends WorkspaceOptions {\r\n  layer: VectorLayer;\r\n  map: IgoMap;\r\n}\r\n\r\nexport class WfsWorkspace extends Workspace {\r\n\r\n  readonly inResolutionRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  get layer(): VectorLayer { return this.options.layer; }\r\n\r\n  get map(): IgoMap { return this.options.map; }\r\n\r\n  constructor(protected options: WfsWorkspaceOptions) {\r\n    super(options);\r\n    this.map.viewController.resolution$.subscribe((mapResolution) => {\r\n      if (mapResolution > this.layer.minResolution && mapResolution < this.layer.maxResolution) {\r\n        this.inResolutionRange$.next(true);\r\n      } else {\r\n        this.inResolutionRange$.next(false);\r\n      }\r\n    });\r\n  }\r\n\r\n  public getLayerWksOptionTabQuery(): boolean {\r\n    if (this.layer.options.workspace.queryOptions?.tabQuery !== undefined) {\r\n      return this.layer.options.workspace.queryOptions.tabQuery;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  public getLayerWksOptionMapQuery(): boolean {\r\n    if (this.layer.options.workspace.queryOptions?.mapQueryOnOpenTab !== undefined) {\r\n      return this.layer.options.workspace.queryOptions.mapQueryOnOpenTab;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  private getInResolutionRange(): boolean {\r\n    return this.inResolutionRange$.value;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport {\r\n  ActionStore,\r\n  EntityTableTemplate,\r\n  EntityStoreFilterCustomFuncStrategy,\r\n  EntityRecord,\r\n  EntityStoreStrategyFuncOptions,\r\n  EntityStoreFilterSelectionStrategy,\r\n  EntityTableColumnRenderer\r\n} from '@igo2/common';\r\n\r\nimport {\r\n  FeatureStore,\r\n  FeatureStoreLoadingLayerStrategy,\r\n  FeatureStoreSelectionStrategy,\r\n  FeatureStoreInMapExtentStrategy,\r\n  Feature,\r\n  FeatureMotion,\r\n  FeatureStoreInMapResolutionStrategy\r\n} from '../../feature';\r\nimport { VectorLayer } from '../../layer';\r\nimport { GeoWorkspaceOptions } from '../../layer/shared/layers/layer.interface';\r\nimport { IgoMap } from '../../map';\r\nimport { SourceFieldsOptionsParams, FeatureDataSource, RelationOptions } from '../../datasource';\r\nimport { getCommonVectorSelectedStyle} from '../../utils';\r\n\r\nimport { WfsWorkspace } from './wfs-workspace';\r\nimport { skipWhile, take } from 'rxjs/operators';\r\nimport { StorageService, ConfigService } from '@igo2/core';\r\nimport olFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class WfsWorkspaceService {\r\n\r\n  get zoomAuto(): boolean {\r\n    return this.storageService.get('zoomAuto') as boolean;\r\n  }\r\n\r\n  public ws$ = new BehaviorSubject<string>(undefined);\r\n\r\n  constructor(private storageService: StorageService, private configService: ConfigService) {}\r\n\r\n  createWorkspace(layer: VectorLayer, map: IgoMap): WfsWorkspace {\r\n    if (layer.options.workspace?.enabled === false || layer.dataSource.options.edition) {\r\n      return;\r\n    }\r\n\r\n    layer.options.workspace = Object.assign({}, layer.options.workspace,\r\n      {\r\n        srcId: layer.id,\r\n        workspaceId: layer.id,\r\n        enabled: true\r\n      } as GeoWorkspaceOptions);\r\n\r\n    const wks = new WfsWorkspace({\r\n      id: layer.id,\r\n      title: layer.title,\r\n      layer,\r\n      map,\r\n      entityStore: this.createFeatureStore(layer, map),\r\n      actionStore: new ActionStore([]),\r\n      meta: {\r\n        tableTemplate: undefined\r\n      }\r\n    });\r\n    this.createTableTemplate(wks, layer);\r\n    return wks;\r\n  }\r\n\r\n  private createFeatureStore(layer: VectorLayer, map: IgoMap): FeatureStore {\r\n    const store = new FeatureStore([], {map});\r\n    store.bindLayer(layer);\r\n\r\n    const loadingStrategy = new FeatureStoreLoadingLayerStrategy({});\r\n    const inMapExtentStrategy = new FeatureStoreInMapExtentStrategy({});\r\n    const inMapResolutionStrategy = new FeatureStoreInMapResolutionStrategy({});\r\n    const selectedRecordStrategy = new EntityStoreFilterSelectionStrategy({});\r\n    const confQueryOverlayStyle= this.configService.getConfig('queryOverlayStyle');\r\n\r\n    const selectionStrategy = new FeatureStoreSelectionStrategy({\r\n      layer: new VectorLayer({\r\n        zIndex: 300,\r\n        source: new FeatureDataSource(),\r\n        style: (feature) => {\r\n          return getCommonVectorSelectedStyle(Object.assign({}, {feature}, confQueryOverlayStyle.selection || {}));\r\n        },\r\n        showInLayerList: false,\r\n        exportable: false,\r\n        browsable: false\r\n      }),\r\n      map,\r\n      hitTolerance: 15,\r\n      motion: this.zoomAuto ? FeatureMotion.Default : FeatureMotion.None,\r\n      many: true,\r\n      dragBox: true\r\n    });\r\n    store.addStrategy(loadingStrategy, true);\r\n    store.addStrategy(inMapExtentStrategy, true);\r\n    store.addStrategy(inMapResolutionStrategy, true);\r\n    store.addStrategy(selectionStrategy, true);\r\n    store.addStrategy(selectedRecordStrategy, false);\r\n    store.addStrategy(this.createFilterInMapExtentOrResolutionStrategy(), true);\r\n    return store;\r\n  }\r\n\r\n  private createTableTemplate(workspace: WfsWorkspace, layer: VectorLayer): EntityTableTemplate {\r\n    const fields = layer.dataSource.options.sourceFields || [];\r\n\r\n    const relations = layer.dataSource.options.relations || [];\r\n\r\n    if (fields.length === 0) {\r\n      workspace.entityStore.entities$.pipe(\r\n        skipWhile(val => val.length === 0),\r\n        take(1)\r\n      ).subscribe(entities => {\r\n        const ol = (entities[0] as Feature).ol as olFeature<OlGeometry>;\r\n        const columnsFromFeatures = ol.getKeys()\r\n        .filter(\r\n          col => !col.startsWith('_') &&\r\n          col !== 'geometry' &&\r\n          col !== ol.getGeometryName() &&\r\n          !col.match(/boundedby/gi))\r\n        .map(key => {\r\n          return {\r\n            name: `properties.${key}`,\r\n            title: key,\r\n            renderer: EntityTableColumnRenderer.UnsanitizedHTML\r\n          };\r\n        });\r\n        workspace.meta.tableTemplate = {\r\n          selection: true,\r\n          sort: true,\r\n          columns: columnsFromFeatures\r\n        };\r\n      });\r\n      return;\r\n    }\r\n    const columns = fields.map((field: SourceFieldsOptionsParams) => {\r\n      return {\r\n        name: `properties.${field.name}`,\r\n        title: field.alias ? field.alias : field.name,\r\n        renderer: EntityTableColumnRenderer.UnsanitizedHTML,\r\n        tooltip: field.tooltip\r\n      };\r\n    });\r\n\r\n    const relationsColumn = relations.map((relation: RelationOptions) => {\r\n      return {\r\n        name: `properties.${relation.name}`,\r\n        title: relation.alias ? relation.alias : relation.name,\r\n        renderer: EntityTableColumnRenderer.Icon,\r\n        icon: relation.icon,\r\n        parent: relation.parent,\r\n        type: 'relation',\r\n        tooltip: relation.tooltip,\r\n        onClick: () => {\r\n            this.ws$.next(relation.title);\r\n        },\r\n        cellClassFunc: () => {\r\n          return { 'class_icon': true };\r\n        }\r\n      };\r\n    });\r\n\r\n    columns.push(...relationsColumn);\r\n    workspace.meta.tableTemplate = {\r\n      selection: true,\r\n      sort: true,\r\n      columns\r\n    };\r\n  }\r\n  private createFilterInMapExtentOrResolutionStrategy(): EntityStoreFilterCustomFuncStrategy {\r\n    const filterClauseFunc = (record: EntityRecord<object>) => {\r\n      return record.state.inMapExtent === true && record.state.inMapResolution === true;\r\n    };\r\n    return new EntityStoreFilterCustomFuncStrategy({filterClauseFunc} as EntityStoreStrategyFuncOptions);\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport {\r\n  ActionStore,\r\n  EntityRecord,\r\n  EntityStoreFilterCustomFuncStrategy,\r\n  EntityStoreFilterSelectionStrategy,\r\n  EntityStoreStrategyFuncOptions,\r\n  EntityTableColumnRenderer,\r\n  EntityTableTemplate } from '@igo2/common';\r\nimport { StorageService, ConfigService } from '@igo2/core';\r\nimport { skipWhile, take } from 'rxjs/operators';\r\nimport { RelationOptions, SourceFieldsOptionsParams, WMSDataSource } from '../../datasource';\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { WFSDataSourceOptions } from '../../datasource/shared/datasources/wfs-datasource.interface';\r\nimport {\r\n  Feature,\r\n  FeatureMotion,\r\n  FeatureStore,\r\n  FeatureStoreInMapExtentStrategy,\r\n  FeatureStoreInMapResolutionStrategy,\r\n  FeatureStoreLoadingLayerStrategy,\r\n  FeatureStoreSelectionStrategy } from '../../feature';\r\n\r\nimport { OgcFilterableDataSourceOptions } from '../../filter/shared/ogc-filter.interface';\r\nimport { ImageLayer, LayerService, LayersLinkProperties, LinkedProperties, VectorLayer } from '../../layer';\r\nimport { StyleService } from '../../layer/shared/style.service';\r\nimport { GeoWorkspaceOptions } from '../../layer/shared/layers/layer.interface';\r\nimport { IgoMap } from '../../map';\r\nimport { QueryableDataSourceOptions } from '../../query/shared/query.interfaces';\r\nimport { WfsWorkspace } from './wfs-workspace';\r\nimport { getCommonVectorSelectedStyle} from '../../utils';\r\n\r\nimport olFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class WmsWorkspaceService {\r\n\r\n  get zoomAuto(): boolean {\r\n    return this.storageService.get('zoomAuto') as boolean;\r\n  }\r\n\r\n  public ws$ = new BehaviorSubject<string>(undefined);\r\n\r\n  constructor(\r\n    private layerService: LayerService,\r\n    private storageService: StorageService,\r\n    private styleService: StyleService,\r\n    private configService: ConfigService) { }\r\n\r\n  createWorkspace(layer: ImageLayer, map: IgoMap): WfsWorkspace {\r\n    if (\r\n      !layer.options.workspace ||\r\n      map.layers.find(lay => lay.id === layer.id + '.WfsWorkspaceTableDest') ||\r\n      layer.dataSource.options.edition) {\r\n      return;\r\n    }\r\n    const dataSource: WMSDataSource = layer.dataSource as WMSDataSource ;\r\n    const wmsLinkId = layer.id + '.WmsWorkspaceTableSrc';\r\n    const wfsLinkId = layer.id + '.WfsWorkspaceTableDest';\r\n    if (!layer.options.linkedLayers) {\r\n      layer.options.linkedLayers = { linkId: wmsLinkId, links: [] };\r\n    }\r\n    const linkProperties = {\r\n      bidirectionnal: true,\r\n      syncedDelete: true,\r\n      linkedIds: [wfsLinkId],\r\n      properties: [\r\n        LinkedProperties.ZINDEX,\r\n        LinkedProperties.VISIBLE]\r\n    } as LayersLinkProperties;\r\n\r\n    if (!layer.options.workspace?.minResolution) {\r\n       linkProperties.properties.push(LinkedProperties.MINRESOLUTION);\r\n    }\r\n    let hasOgcFilters = false;\r\n    if ((dataSource.options as OgcFilterableDataSourceOptions).ogcFilters?.enabled) {\r\n      linkProperties.properties.push(LinkedProperties.OGCFILTERS);\r\n      hasOgcFilters = true;\r\n    }\r\n    if (!layer.options.workspace?.maxResolution) {\r\n      linkProperties.properties.push(LinkedProperties.MAXRESOLUTION);\r\n    }\r\n\r\n    let clonedLinks: LayersLinkProperties[] = [];\r\n    if (layer.options.linkedLayers.links) {\r\n      clonedLinks = JSON.parse(JSON.stringify(layer.options.linkedLayers.links));\r\n    }\r\n    clonedLinks.push(linkProperties);\r\n\r\n    layer.options.linkedLayers.linkId = layer.options.linkedLayers.linkId ? layer.options.linkedLayers.linkId : wmsLinkId,\r\n      layer.options.linkedLayers.links = clonedLinks;\r\n    interface WFSoptions extends WFSDataSourceOptions, OgcFilterableDataSourceOptions { }\r\n\r\n    let wks;\r\n    let wksLayerOption = {\r\n      srcId: layer.id,\r\n      workspaceId: undefined,\r\n      enabled: false,\r\n      queryOptions: {\r\n        mapQueryOnOpenTab: layer.options.workspace?.queryOptions?.mapQueryOnOpenTab,\r\n        tabQuery: layer.options.workspace?.queryOptions?.tabQuery\r\n      },\r\n      pageSize: layer.options.workspace?.pageSize,\r\n      pageSizeOptions: layer.options.workspace?.pageSizeOptions\r\n    };\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        isIgoInternalLayer: true,\r\n        id: wfsLinkId,\r\n        linkedLayers: {\r\n          linkId: wfsLinkId\r\n        },\r\n        workspace: wksLayerOption,\r\n        showInLayerList: false,\r\n        opacity: 0,\r\n        title: layer.title,\r\n        minResolution: layer.options.workspace?.minResolution || layer.minResolution || 0,\r\n        maxResolution: layer.options.workspace?.maxResolution || layer.maxResolution || Infinity,\r\n        style: this.styleService.createStyle(\r\n          {\r\n            fill: {\r\n              \"color\": \"rgba(255, 255, 255, 0.01)\"\r\n            },\r\n            stroke: {\r\n              \"color\": \"rgba(255, 255, 255, 0.01)\"\r\n            },\r\n            circle: {\r\n              fill: {\r\n                color: \"rgba(255, 255, 255, 0.01)\"\r\n              },\r\n              stroke: {\r\n                color: \"rgba(255, 255, 255, 0.01)\"\r\n              },\r\n              radius: 5\r\n            }\r\n          }),\r\n        sourceOptions: {\r\n          download: dataSource.options.download,\r\n          type: 'wfs',\r\n          url: dataSource.options.urlWfs || dataSource.options.url,\r\n          queryable: true,\r\n          relations: dataSource.options.relations,\r\n          queryTitle: (dataSource.options as QueryableDataSourceOptions).queryTitle,\r\n          queryFormatAsWms: layer.options.workspace?.enabled ? (dataSource.options as QueryableDataSourceOptions).queryFormatAsWms : true,\r\n          params: dataSource.options.paramsWFS,\r\n          ogcFilters: Object.assign({}, dataSource.ogcFilters$.value, {enabled: hasOgcFilters}),\r\n          sourceFields: dataSource.options.sourceFields || undefined\r\n        } as WFSoptions\r\n      })\r\n      .subscribe((workspaceLayer: VectorLayer) => {\r\n        map.addLayer(workspaceLayer);\r\n        layer.ol.setProperties({ linkedLayers: { linkId: layer.options.linkedLayers.linkId, links: clonedLinks } }, false);\r\n        workspaceLayer.dataSource.ol.refresh();\r\n\r\n        if (!layer.options.workspace?.enabled) {\r\n          return;\r\n        }\r\n        wks = new WfsWorkspace({\r\n          id: layer.id,\r\n          title: layer.title,\r\n          layer: workspaceLayer,\r\n          map,\r\n          entityStore: this.createFeatureStore(workspaceLayer, map),\r\n          actionStore: new ActionStore([]),\r\n          meta: {\r\n            tableTemplate: undefined\r\n          }\r\n        });\r\n        this.createTableTemplate(wks, workspaceLayer);\r\n\r\n        workspaceLayer.options.workspace.workspaceId = workspaceLayer.id;\r\n        layer.options.workspace = Object.assign({}, layer.options.workspace,\r\n          {\r\n            enabled: true,\r\n            srcId: layer.id,\r\n            workspaceId: workspaceLayer.id,\r\n            queryOptions: {\r\n              mapQueryOnOpenTab: layer.options.workspace?.queryOptions?.mapQueryOnOpenTab,\r\n              tabQuery: layer.options.workspace?.queryOptions?.tabQuery\r\n            },\r\n            pageSize: layer.options.workspace?.pageSize,\r\n            pageSizeOptions: layer.options.workspace?.pageSizeOptions\r\n          } as GeoWorkspaceOptions);\r\n\r\n        delete dataSource.options.download;\r\n        return wks;\r\n\r\n      });\r\n\r\n    return wks;\r\n  }\r\n\r\n  private createFeatureStore(layer: VectorLayer, map: IgoMap): FeatureStore {\r\n    const store = new FeatureStore([], { map });\r\n    store.bindLayer(layer);\r\n\r\n    const loadingStrategy = new FeatureStoreLoadingLayerStrategy({});\r\n    const inMapExtentStrategy = new FeatureStoreInMapExtentStrategy({});\r\n    const inMapResolutionStrategy = new FeatureStoreInMapResolutionStrategy({});\r\n    const selectedRecordStrategy = new EntityStoreFilterSelectionStrategy({});\r\n    const confQueryOverlayStyle= this.configService.getConfig('queryOverlayStyle');\r\n\r\n    const selectionStrategy = new FeatureStoreSelectionStrategy({\r\n      layer: new VectorLayer({\r\n        zIndex: 300,\r\n        source: new FeatureDataSource(),\r\n        style: (feature) => {\r\n          return getCommonVectorSelectedStyle(Object.assign({}, {feature}, confQueryOverlayStyle.selection || {}));\r\n        },\r\n        showInLayerList: false,\r\n        exportable: false,\r\n        browsable: false\r\n      }),\r\n      map,\r\n      hitTolerance: 15,\r\n      motion: this.zoomAuto ? FeatureMotion.Default : FeatureMotion.None,\r\n      many: true,\r\n      dragBox: true\r\n    });\r\n    store.addStrategy(loadingStrategy, true);\r\n    store.addStrategy(inMapExtentStrategy, true);\r\n    store.addStrategy(inMapResolutionStrategy, true);\r\n    store.addStrategy(selectionStrategy, true);\r\n    store.addStrategy(selectedRecordStrategy, false);\r\n    store.addStrategy(this.createFilterInMapExtentOrResolutionStrategy(), true);\r\n    return store;\r\n  }\r\n\r\n  private createTableTemplate(workspace: WfsWorkspace, layer: VectorLayer): EntityTableTemplate {\r\n    const fields = layer.dataSource.options.sourceFields || [];\r\n\r\n    const relations = layer.dataSource.options.relations || [];\r\n\r\n    if (fields.length === 0) {\r\n      workspace.entityStore.entities$.pipe(\r\n        skipWhile(val => val.length === 0),\r\n        take(1)\r\n      ).subscribe(entities => {\r\n        const ol = (entities[0] as Feature).ol as olFeature<OlGeometry>;\r\n        const columnsFromFeatures = ol.getKeys()\r\n          .filter(\r\n            col => !col.startsWith('_') &&\r\n              col !== 'geometry' &&\r\n              col !== ol.getGeometryName() &&\r\n              !col.match(/boundedby/gi))\r\n          .map(key => {\r\n            return {\r\n              name: `properties.${key}`,\r\n              title: key,\r\n              renderer: EntityTableColumnRenderer.UnsanitizedHTML\r\n            };\r\n          });\r\n        workspace.meta.tableTemplate = {\r\n          selection: true,\r\n          sort: true,\r\n          columns: columnsFromFeatures\r\n        };\r\n      });\r\n      return;\r\n    }\r\n    const columns = fields.map((field: SourceFieldsOptionsParams) => {\r\n      return {\r\n        name: `properties.${field.name}`,\r\n        title: field.alias ? field.alias : field.name,\r\n        renderer: EntityTableColumnRenderer.UnsanitizedHTML,\r\n        tooltip: field.tooltip\r\n      };\r\n    });\r\n\r\n    const relationsColumn = relations.map((relation: RelationOptions) => {\r\n      return {\r\n        name: `properties.${relation.name}`,\r\n        title: relation.alias ? relation.alias : relation.name,\r\n        renderer: EntityTableColumnRenderer.Icon,\r\n        icon: relation.icon,\r\n        parent: relation.parent,\r\n        type: 'relation',\r\n        tooltip: relation.tooltip,\r\n        onClick: () => {\r\n            this.ws$.next(relation.title);\r\n        },\r\n        cellClassFunc: () => {\r\n          return { 'class_icon': true };\r\n        }\r\n      };\r\n    });\r\n\r\n    columns.push(...relationsColumn);\r\n    workspace.meta.tableTemplate = {\r\n      selection: true,\r\n      sort: true,\r\n      columns\r\n    };\r\n  }\r\n\r\n  private createFilterInMapExtentOrResolutionStrategy(): EntityStoreFilterCustomFuncStrategy {\r\n    const filterClauseFunc = (record: EntityRecord<object>) => {\r\n      return record.state.inMapExtent === true && record.state.inMapResolution === true;\r\n    };\r\n    return new EntityStoreFilterCustomFuncStrategy({filterClauseFunc} as EntityStoreStrategyFuncOptions);\r\n  }\r\n}\r\n","import { LanguageService } from '@igo2/core';\r\nimport { Component, Inject } from '@angular/core';\r\nimport { MatDialogRef, MAT_DIALOG_DATA } from '@angular/material/dialog';\r\n\r\nexport interface DialogData {\r\n  type: string;\r\n  cancel: boolean;\r\n}\r\n\r\n@Component({\r\n    selector: 'igo-confirmation-popup-component',\r\n    templateUrl: './confirmation-popup.component.html',\r\n    styleUrls: ['./confirmation-popup.component.scss']\r\n  })\r\n  export class ConfirmationPopupComponent {\r\n\r\n    constructor(\r\n      public dialogRef: MatDialogRef<ConfirmationPopupComponent>,\r\n      public languageService: LanguageService,\r\n      @Inject(MAT_DIALOG_DATA) public data: {type: string, cancel: boolean}) {}\r\n\r\n    cancelAction() {\r\n      this.data.cancel = true;\r\n      this.dialogRef.close(this.data.cancel);\r\n    }\r\n\r\n    confirmedAction() {\r\n      this.data.cancel = false;\r\n      this.dialogRef.close(this.data.cancel);\r\n    }\r\n  }\r\n","<div mat-dialog-content>\r\n  <p class=\"mat-typography\">{{data.type === 'add' ?\r\n    languageService.translate.instant('igo.geo.workspace.addConfirmation') :\r\n    languageService.translate.instant('igo.geo.workspace.deleteConfirmation')}}</p>\r\n</div>\r\n<div mat-dialog-actions>\r\n  <button\r\n    mat-raised-button\r\n    color=\"primary\"\r\n    (click)=\"confirmedAction()\">Ok\r\n  </button>\r\n  <button\r\n    mat-raised-button\r\n    (click)=\"cancelAction()\">{{languageService.translate.instant('igo.geo.workspace.cancel')}}\r\n  </button>\r\n</div>","import { MatDialog } from '@angular/material/dialog';\r\nimport {\r\n  Workspace,\r\n  WorkspaceOptions,\r\n  EntityRecord\r\n} from '@igo2/common';\r\nimport { ConfigService } from '@igo2/core';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\nimport { ImageLayer, VectorLayer } from '../../layer';\r\nimport { IgoMap } from '../../map';\r\nimport { EditionWorkspaceService } from './edition-workspace.service';\r\nimport { ConfirmationPopupComponent } from '../confirmation-popup/confirmation-popup.component';\r\nimport { DrawControl } from '../../geometry';\r\nimport { createInteractionStyle, GeometryType } from '../../draw';\r\nimport { featureToOl } from '../../feature';\r\n\r\nimport type { default as OlGeometryType } from 'ol/geom/GeometryType';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport OlGeoJSON from 'ol/format/GeoJSON';\r\nimport OlVectorSource from 'ol/source/Vector';\r\nimport * as OlStyle from 'ol/style';\r\nimport OlModify from 'ol/interaction/Modify';\r\nimport Collection from 'ol/Collection';\r\nimport OlFeature from 'ol/Feature';\r\nimport { FeatureDataSource } from '../../datasource/shared';\r\n\r\nexport interface EditionWorkspaceOptions extends WorkspaceOptions {\r\n  layer: ImageLayer | VectorLayer;\r\n  map: IgoMap;\r\n}\r\n\r\nexport class EditionWorkspace extends Workspace {\r\n\r\n  readonly inResolutionRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  get layer(): ImageLayer | VectorLayer { return this.options.layer; }\r\n\r\n  get map(): IgoMap { return this.options.map; }\r\n\r\n  private drawControl: DrawControl;\r\n  private drawEnd$$: Subscription;\r\n  private olDrawingLayerSource = new OlVectorSource();\r\n  private olDrawingLayer: VectorLayer;\r\n  public geometryType = GeometryType; // Reference to the GeometryType enum\r\n  public modify; // Reference to the ol interaction\r\n\r\n  public modifyStyle = new OlStyle.Style({\r\n    stroke: new OlStyle.Stroke({\r\n      color: 'rgba(255,255,255,1)',\r\n      width: 1\r\n    }),\r\n    fill: new OlStyle.Fill({\r\n      color: 'rgba(0,161,222,1)'\r\n    }),\r\n    image: new OlStyle.Circle({\r\n      radius: 7,\r\n      stroke: new OlStyle.Stroke({\r\n        color: 'rgba(255,255,255,1)',\r\n        width: 1\r\n      }),\r\n      fill: new OlStyle.Fill({\r\n        color: 'rgba(0,161,222,1)'\r\n      })\r\n    })\r\n  });\r\n\r\n  private newFeaturefilterClauseFunc = (record: EntityRecord<object>) => {\r\n    return record.state.newFeature === true;\r\n  };\r\n\r\n  private editFeaturefilterClauseFunc = (record: EntityRecord<object>) => {\r\n    return record.state.edit === true;\r\n  };\r\n\r\n  public fillColor: string;\r\n  public strokeColor: string;\r\n  public strokeWidth: number;\r\n\r\n  constructor(\r\n    protected options: EditionWorkspaceOptions,\r\n    private editionWorkspaceService: EditionWorkspaceService,\r\n    private dialog: MatDialog,\r\n    private configService: ConfigService) {\r\n    super(options);\r\n    this.map.viewController.resolution$.subscribe((mapResolution) => {\r\n      if (mapResolution > this.layer.minResolution && mapResolution < this.layer.maxResolution) {\r\n        this.inResolutionRange$.next(true);\r\n      } else {\r\n        this.inResolutionRange$.next(false);\r\n      }\r\n    });\r\n\r\n    this.drawControl = this.createDrawControl();\r\n    this.drawControl.setGeometryType(this.geometryType.Point as any);\r\n\r\n    this.map.removeLayer(this.olDrawingLayer);\r\n\r\n    this.olDrawingLayer = new VectorLayer({\r\n      id: 'igo-draw-layer',\r\n      title: 'edition',\r\n      zIndex: 300,\r\n      source: new FeatureDataSource(),\r\n      showInLayerList: false,\r\n      exportable: false,\r\n      browsable: false,\r\n      workspace: {\r\n        enabled: false\r\n      },\r\n    });\r\n  }\r\n\r\n  private getInResolutionRange(): boolean {\r\n    return this.inResolutionRange$.value;\r\n  }\r\n\r\n  deleteFeature(feature, workspace) {\r\n    setTimeout(() => {\r\n      const dialogRef = this.dialog.open(ConfirmationPopupComponent, {\r\n        disableClose: false,\r\n        data: {type: 'delete'}\r\n    });\r\n\r\n      dialogRef.afterClosed().subscribe(result => {\r\n        if (result === false) {\r\n          const baseUrl = workspace.layer.dataSource.options.edition.baseUrl;\r\n          const deleteUrl = workspace.layer.dataSource.options.edition.deleteUrl;\r\n          let id;\r\n          let url;\r\n          if (baseUrl) {\r\n            url = this.configService.getConfig('edition.url') + baseUrl + '?' + deleteUrl;\r\n          } else {\r\n            url = this.configService.getConfig('edition.url') + deleteUrl;\r\n          }\r\n\r\n          for (const column of workspace.meta.tableTemplate.columns) {\r\n            for (const property in feature.properties) {\r\n              let columnName = column.name;\r\n              if (columnName.includes('properties.')) {\r\n                columnName = columnName.split('.')[1];\r\n              }\r\n              if (columnName === property && column.primary === true) {\r\n                id = feature.properties[property];\r\n              }\r\n            }\r\n          }\r\n          if (url) {\r\n            url += id;\r\n            this.editionWorkspaceService.deleteFeature(workspace, url);\r\n          }\r\n        }\r\n      });\r\n    }, 250);\r\n  }\r\n\r\n  editFeature(feature, workspace: EditionWorkspace) {\r\n    feature.edition = true;\r\n    let id;\r\n    let find = false;\r\n    const editionOpt = workspace.layer.dataSource.options.edition;\r\n    for (const column of workspace.meta.tableTemplate.columns ) {\r\n\r\n      // Update domain list\r\n      if (column.type === 'list' || column.type === 'autocomplete') {\r\n        this.editionWorkspaceService.getDomainValues(column.relation).subscribe(result => {\r\n          column.domainValues = result;\r\n        });\r\n      }\r\n      if (find === false) {\r\n        for (const property in feature.properties) {\r\n          let columnName = column.name;\r\n          if (columnName.includes('properties.')) {\r\n            columnName = columnName.split('.')[1];\r\n          }\r\n          if (columnName === property && column.primary === true) {\r\n            id = feature.properties[property];\r\n            find = true;\r\n            break;\r\n          }\r\n        }\r\n      }\r\n    }\r\n    if (id) {\r\n      feature.original_properties = JSON.parse(JSON.stringify(feature.properties));\r\n      feature.original_geometry = feature.geometry;\r\n      feature.idkey = id;\r\n      workspace.entityStore.state.updateAll({ edit: false });\r\n      workspace.entityStore.stateView.filter(this.editFeaturefilterClauseFunc);\r\n      this.addFeatureToStore(feature, workspace);\r\n    } else {\r\n      // Only for edition with it's own geometry\r\n      if (!feature.newFeature && editionOpt.geomType) {\r\n        feature.newFeature = true;\r\n        this.editionWorkspaceService.adding$.next(true);\r\n        workspace.entityStore.state.updateAll({ newFeature: false });\r\n        workspace.entityStore.stateView.filter(this.newFeaturefilterClauseFunc);\r\n        if (editionOpt.addWithDraw) {\r\n          const geometryType = editionOpt.geomType;\r\n          this.onGeometryTypeChange(geometryType, feature, workspace);\r\n        } else {\r\n          workspace.entityStore.insert(feature);\r\n          workspace.entityStore.state.update(feature, { newFeature: true }, true);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Create a Draw Control\r\n   * @param fillColor the fill color\r\n   * @param strokeColor the stroke color\r\n   * @param strokeWidth the stroke width\r\n   * @returns a Draw Control\r\n   */\r\n  createDrawControl(fillColor?: string, strokeColor?: string, strokeWidth?: number) {\r\n    const drawControl = new DrawControl({\r\n      geometryType: undefined,\r\n      drawingLayerSource: this.olDrawingLayerSource,\r\n      drawingLayerStyle: new OlStyle.Style({}),\r\n      interactionStyle: createInteractionStyle(fillColor, strokeColor, strokeWidth),\r\n    });\r\n\r\n    return drawControl;\r\n  }\r\n\r\n  /**\r\n   * Called when the user selects a new geometry type\r\n   * @param geometryType the geometry type selected by the user\r\n   */\r\n  onGeometryTypeChange(geometryType: typeof OlGeometryType, feature, workspace: EditionWorkspace) {\r\n      this.drawControl.setGeometryType(geometryType);\r\n      this.toggleDrawControl(feature, workspace);\r\n    }\r\n\r\n  /**\r\n   * Activate the correct control\r\n   */\r\n  private toggleDrawControl(feature, workspace: EditionWorkspace) {\r\n    this.deactivateDrawControl();\r\n    this.activateDrawControl(feature, workspace);\r\n  }\r\n\r\n  /**\r\n   * Deactivate the active draw control\r\n   */\r\n  public deactivateDrawControl() {\r\n    if (!this.drawControl) {\r\n      return;\r\n    }\r\n\r\n    if (this.drawEnd$$) {\r\n      this.drawEnd$$.unsubscribe();\r\n    }\r\n\r\n    this.drawControl.setOlMap(undefined);\r\n  }\r\n\r\n  /**\r\n   * Activate a given control\r\n   */\r\n  private activateDrawControl(feature, workspace: EditionWorkspace) {\r\n    this.drawEnd$$ = this.drawControl.end$.subscribe((olGeometry: OlGeometry) => {\r\n      this.addFeatureToStore(feature, workspace, olGeometry);\r\n    });\r\n\r\n    this.drawControl.setOlMap(this.map.ol, true);\r\n  }\r\n\r\n  /**\r\n   * Add a feature to layer. The loading strategy of the layer\r\n   * will trigger and add the feature to the workspace store.\r\n   * @internal\r\n   */\r\n  private addFeatureToStore(feature, workspace: EditionWorkspace, olGeometry?: OlGeometry) {\r\n    const projection = this.map.ol.getView().getProjection();\r\n    let geometry = feature.geometry;\r\n\r\n    // If an olGeometry is passed, it means that it is a new feature\r\n    if (olGeometry) {\r\n      workspace.entityStore.insert(feature);\r\n      workspace.entityStore.state.update(feature, { newFeature: true }, true);\r\n      geometry = new OlGeoJSON().writeGeometryObject(olGeometry, {\r\n        featureProjection: projection,\r\n        dataProjection: 'EPSG:4326'\r\n      }) as any;\r\n\r\n      feature.geometry = geometry;\r\n    } else {\r\n      workspace.entityStore.state.update(feature, { edit: true }, true);\r\n    }\r\n\r\n    feature.projection = 'EPSG:4326';\r\n\r\n    const featureOl = featureToOl(feature, projection.getCode());\r\n\r\n    this.olDrawingLayer.dataSource.ol.clear();\r\n    this.olDrawingLayer.dataSource.ol.addFeature(featureOl);\r\n    this.map.addLayer(this.olDrawingLayer);\r\n\r\n    this.deactivateDrawControl();\r\n    this.createModifyInteraction(featureOl, feature, workspace);\r\n  }\r\n\r\n  /**\r\n   * Delete drawings layer and source from the map AND feature from the entity store.\r\n   * Layer refresh will automatically add the new feature into the store.\r\n   */\r\n  deleteDrawings() {\r\n    this.map.removeLayer(this.olDrawingLayer);\r\n    this.olDrawingLayerSource.clear();\r\n    this.map.ol.removeInteraction(this.modify);\r\n  }\r\n\r\n  /**\r\n   * Create a modify interaction to allow a geometry change one feature at the time (drag and drop)\r\n   */\r\n  createModifyInteraction(olFeature: OlFeature<OlGeometry>, feature, workspace: EditionWorkspace) {\r\n    this.map.ol.removeInteraction(this.modify);\r\n    const olCollection = new Collection([olFeature], { unique: true });\r\n    this.modify = new OlModify({\r\n      features: olCollection\r\n    });\r\n\r\n    this.map.ol.addInteraction(this.modify);\r\n    olCollection.forEach(feature => {\r\n      feature.setStyle(this.modifyStyle);\r\n    });\r\n\r\n    this.modify.on('modifyend', (event) => {\r\n      const olGeometry = event.features.getArray()[0]?.getGeometry();\r\n      if (olGeometry) {\r\n        this.addFeatureToStore(feature, workspace, olGeometry);\r\n      }\r\n    });\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient, HttpErrorResponse, HttpHeaders } from '@angular/common/http';\r\nimport { MatDialog } from '@angular/material/dialog';\r\n\r\nimport {\r\n  ActionStore,\r\n  EntityRecord,\r\n  EntityStoreFilterCustomFuncStrategy,\r\n  EntityStoreFilterSelectionStrategy,\r\n  EntityStoreStrategyFuncOptions,\r\n  EntityTableColumnRenderer,\r\n  EntityTableTemplate,\r\n  EntityTableButton} from '@igo2/common';\r\nimport { ConfigService, LanguageService, MessageService, StorageService } from '@igo2/core';\r\nimport { AuthInterceptor } from '@igo2/auth';\r\nimport { catchError, map, skipWhile, take } from 'rxjs/operators';\r\nimport { RelationOptions, SourceFieldsOptionsParams, WMSDataSource } from '../../datasource';\r\nimport { FeatureDataSource } from '../../datasource/shared/datasources/feature-datasource';\r\nimport { WFSDataSourceOptions } from '../../datasource/shared/datasources/wfs-datasource.interface';\r\nimport {\r\n  Feature,\r\n  FeatureMotion,\r\n  FeatureStore,\r\n  FeatureStoreInMapExtentStrategy,\r\n  FeatureStoreInMapResolutionStrategy,\r\n  FeatureStoreLoadingLayerStrategy,\r\n  FeatureStoreSelectionStrategy} from '../../feature';\r\n\r\nimport { OgcFilterableDataSourceOptions } from '../../filter/shared/ogc-filter.interface';\r\nimport { ImageLayer, LayerService, LayersLinkProperties, LinkedProperties, VectorLayer } from '../../layer';\r\nimport { StyleService } from '../../layer/shared/style.service';\r\nimport { GeoWorkspaceOptions } from '../../layer/shared/layers/layer.interface';\r\nimport { IgoMap } from '../../map';\r\nimport { QueryableDataSourceOptions } from '../../query/shared/query.interfaces';\r\nimport { EditionWorkspace } from './edition-workspace';\r\n\r\nimport olFeature from 'ol/Feature';\r\nimport olSourceImageWMS from 'ol/source/ImageWMS';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\nimport { BehaviorSubject, Observable, throwError } from 'rxjs';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class EditionWorkspaceService {\r\n\r\n  public ws$ = new BehaviorSubject<string>(undefined);\r\n  public adding$ = new BehaviorSubject<boolean>(false);\r\n  public relationLayers$ = new BehaviorSubject<ImageLayer[] | VectorLayer[]>(undefined);\r\n  public rowsInMapExtentCheckCondition$ = new BehaviorSubject<boolean>(true);\r\n  public loading = false;\r\n\r\n  get zoomAuto(): boolean {\r\n    return this.storageService.get('zoomAuto') as boolean;\r\n  }\r\n\r\n  constructor(\r\n    private layerService: LayerService,\r\n    private storageService: StorageService,\r\n    private configService: ConfigService,\r\n    private messageService: MessageService,\r\n    private languageService: LanguageService,\r\n    private http: HttpClient,\r\n    private dialog: MatDialog,\r\n    private styleService: StyleService,\r\n    public authInterceptor?: AuthInterceptor) { }\r\n\r\n  createWorkspace(layer: ImageLayer, map: IgoMap): EditionWorkspace {\r\n    if (layer.options.workspace?.enabled !== true || layer.dataSource.options.edition.enabled !== true) {\r\n      return;\r\n    }\r\n    let wksConfig;\r\n    if (layer.options.workspace) {\r\n      wksConfig = layer.options.workspace;\r\n    } else {\r\n      wksConfig = {};\r\n    }\r\n    wksConfig.srcId = layer.id;\r\n    wksConfig.workspaceId = layer.id;\r\n    wksConfig.enabled = true;\r\n    wksConfig.pageSize = layer.options.workspace?.pageSize;\r\n    wksConfig.pageSizeOptions = layer.options.workspace?.pageSizeOptions;\r\n\r\n    const dataSource: WMSDataSource = layer.dataSource as WMSDataSource ;\r\n    const wmsLinkId = layer.id + '.WmsWorkspaceTableSrc';\r\n    const wfsLinkId = layer.id + '.WfsWorkspaceTableDest';\r\n    if (!layer.options.linkedLayers) {\r\n      layer.options.linkedLayers = { linkId: wmsLinkId, links: [] };\r\n    }\r\n    const linkProperties = {\r\n      bidirectionnal: true,\r\n      syncedDelete: true,\r\n      linkedIds: [wfsLinkId],\r\n      properties: [\r\n        LinkedProperties.ZINDEX,\r\n        LinkedProperties.VISIBLE]\r\n    } as LayersLinkProperties;\r\n\r\n    if (!layer.options.workspace?.minResolution) {\r\n       linkProperties.properties.push(LinkedProperties.MINRESOLUTION);\r\n    }\r\n    let hasOgcFilters = false;\r\n    if ((dataSource.options as OgcFilterableDataSourceOptions).ogcFilters?.enabled) {\r\n      linkProperties.properties.push(LinkedProperties.OGCFILTERS);\r\n      hasOgcFilters = true;\r\n    }\r\n    if (!layer.options.workspace?.maxResolution) {\r\n      linkProperties.properties.push(LinkedProperties.MAXRESOLUTION);\r\n    }\r\n\r\n    let clonedLinks: LayersLinkProperties[] = [];\r\n    if (layer.options.linkedLayers.links) {\r\n      clonedLinks = JSON.parse(JSON.stringify(layer.options.linkedLayers.links));\r\n    }\r\n    clonedLinks.push(linkProperties);\r\n\r\n    layer.options.linkedLayers.linkId = layer.options.linkedLayers.linkId ? layer.options.linkedLayers.linkId : wmsLinkId,\r\n      layer.options.linkedLayers.links = clonedLinks;\r\n    interface WFSoptions extends WFSDataSourceOptions, OgcFilterableDataSourceOptions { }\r\n    let wks;\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        id: wfsLinkId,\r\n        linkedLayers: {\r\n          linkId: wfsLinkId\r\n        },\r\n        workspace: {\r\n          srcId: layer.id,\r\n          workspaceId: undefined,\r\n          enabled: false,\r\n          queryOptions: {\r\n            mapQueryOnOpenTab: layer.options.workspace?.queryOptions?.mapQueryOnOpenTab,\r\n            tabQuery: false\r\n          },\r\n          pageSize: layer.options.workspace?.pageSize,\r\n          pageSizeOptions: layer.options.workspace?.pageSizeOptions\r\n        },\r\n        showInLayerList: false,\r\n        opacity: 0,\r\n        title: layer.title,\r\n        minResolution: layer.options.workspace?.minResolution || layer.minResolution || 0,\r\n        maxResolution: layer.options.workspace?.maxResolution || layer.maxResolution || Infinity,\r\n        style: this.styleService.createStyle(\r\n          {\r\n            fill: {\r\n              \"color\": \"rgba(255, 255, 255, 0.01)\"\r\n            },\r\n            stroke: {\r\n              \"color\": \"rgba(255, 255, 255, 0.01)\"\r\n            },\r\n            circle: {\r\n              fill: {\r\n                color: \"rgba(255, 255, 255, 0.01)\"\r\n              },\r\n              stroke: {\r\n                color: \"rgba(255, 255, 255, 0.01)\"\r\n              },\r\n              radius: 5\r\n            }\r\n          }),\r\n          sourceOptions: {\r\n          download: dataSource.options.download,\r\n          type: 'wfs',\r\n          url: dataSource.options.urlWfs || dataSource.options.url,\r\n          queryable: true,\r\n          relations: dataSource.options.relations,\r\n          queryTitle: (dataSource.options as QueryableDataSourceOptions).queryTitle,\r\n          params: dataSource.options.paramsWFS,\r\n          ogcFilters: Object.assign({}, dataSource.ogcFilters$.value, {enabled: hasOgcFilters}),\r\n          sourceFields: dataSource.options.sourceFields || undefined,\r\n          edition: dataSource.options.edition\r\n        } as WFSoptions\r\n      })\r\n      .subscribe((workspaceLayer: VectorLayer) => {\r\n        map.addLayer(workspaceLayer);\r\n        layer.ol.setProperties({ linkedLayers: { linkId: layer.options.linkedLayers.linkId, links: clonedLinks } }, false);\r\n        workspaceLayer.dataSource.ol.refresh();\r\n\r\n        wks = new EditionWorkspace({\r\n          id: layer.id,\r\n          title: layer.title,\r\n          layer: workspaceLayer,\r\n          map,\r\n          entityStore: this.createFeatureStore(workspaceLayer, map),\r\n          actionStore: new ActionStore([]),\r\n          meta: {\r\n            tableTemplate: undefined\r\n          }\r\n        }, this, this.dialog, this.configService);\r\n        this.createTableTemplate(wks, workspaceLayer);\r\n\r\n        workspaceLayer.options.workspace.workspaceId = workspaceLayer.id;\r\n        layer.options.workspace = Object.assign({}, layer.options.workspace,\r\n          {\r\n            wksConfig\r\n          } as GeoWorkspaceOptions);\r\n\r\n        delete dataSource.options.download;\r\n        return wks;\r\n\r\n      });\r\n\r\n    return wks;\r\n  }\r\n\r\n  private createFeatureStore(layer: VectorLayer, map: IgoMap): FeatureStore {\r\n    const store = new FeatureStore([], { map });\r\n    store.bindLayer(layer);\r\n\r\n    const loadingStrategy = new FeatureStoreLoadingLayerStrategy({});\r\n    const inMapExtentStrategy = new FeatureStoreInMapExtentStrategy({});\r\n    const inMapResolutionStrategy = new FeatureStoreInMapResolutionStrategy({});\r\n    const selectedRecordStrategy = new EntityStoreFilterSelectionStrategy({});\r\n    const selectionStrategy = new FeatureStoreSelectionStrategy({\r\n      layer: new VectorLayer({\r\n        zIndex: 300,\r\n        source: new FeatureDataSource(),\r\n        style: undefined,\r\n        showInLayerList: false,\r\n        exportable: false,\r\n        browsable: false\r\n      }),\r\n      map,\r\n      hitTolerance: 15,\r\n      motion: this.zoomAuto ? FeatureMotion.Default : FeatureMotion.None,\r\n      many: true,\r\n      dragBox: true\r\n    });\r\n    store.addStrategy(loadingStrategy, true);\r\n    store.addStrategy(inMapExtentStrategy, true);\r\n    store.addStrategy(inMapResolutionStrategy, true);\r\n    store.addStrategy(selectionStrategy, true);\r\n    store.addStrategy(selectedRecordStrategy, false);\r\n    store.addStrategy(this.createFilterInMapExtentOrResolutionStrategy(), true);\r\n    return store;\r\n  }\r\n\r\n  private createTableTemplate(workspace: EditionWorkspace, layer: VectorLayer): EntityTableTemplate {\r\n    const fields = layer.dataSource.options.sourceFields || [];\r\n\r\n    const relations = layer.dataSource.options.relations || [];\r\n\r\n    let rendererType = EntityTableColumnRenderer.UnsanitizedHTML;\r\n    let buttons = [];\r\n    let columns = [];\r\n    let relationsColumn = [];\r\n\r\n    buttons = [{\r\n      name: 'edition',\r\n      title: undefined,\r\n      renderer: EntityTableColumnRenderer.ButtonGroup,\r\n      primary: false,\r\n      valueAccessor: () => {\r\n        return [{\r\n          editMode: false,\r\n          icon: 'pencil',\r\n          color: 'primary',\r\n          disabled: layer.dataSource.options.edition.modifyButton === false ? true : false,\r\n          click: (feature) => { workspace.editFeature(feature, workspace); }\r\n        },\r\n        {\r\n          editMode: false,\r\n          icon: 'delete',\r\n          color: 'warn',\r\n          disabled: layer.dataSource.options.edition.deleteButton === false ? true : false,\r\n          click: (feature) => { workspace.deleteFeature(feature, workspace); }\r\n        },\r\n        {\r\n          editMode: true,\r\n          icon: 'check',\r\n          color: 'primary',\r\n          disabled: this.loading,\r\n          click: (feature) => { this.saveFeature(feature, workspace); }\r\n        },\r\n        {\r\n          editMode: true,\r\n          icon: 'alpha-x',\r\n          color: 'primary',\r\n          disabled: this.loading,\r\n          click: (feature) => { this.cancelEdit(workspace, feature); }\r\n        }] as EntityTableButton[];\r\n      }\r\n    }];\r\n\r\n\r\n    if (fields.length === 0) {\r\n      workspace.entityStore.entities$.pipe(\r\n        skipWhile(val => val.length === 0),\r\n        take(1)\r\n      ).subscribe(entities => {\r\n        const ol = (entities[0] as Feature).ol as olFeature<OlGeometry>;\r\n        const columnsFromFeatures = ol.getKeys()\r\n          .filter(\r\n            col => !col.startsWith('_') &&\r\n              col !== 'geometry' &&\r\n              col !== ol.getGeometryName() &&\r\n              !col.match(/boundedby/gi))\r\n          .map(key => {\r\n            return {\r\n              name: `properties.${key}`,\r\n              title: key,\r\n              renderer: rendererType,\r\n            };\r\n          });\r\n        workspace.meta.tableTemplate = {\r\n          selection: false,\r\n          sort: true,\r\n          columns: columnsFromFeatures\r\n        };\r\n      });\r\n      return;\r\n    }\r\n\r\n    columns = fields.map((field: SourceFieldsOptionsParams) => {\r\n\r\n      let column = {\r\n        name: `properties.${field.name}`,\r\n        title: field.alias ? field.alias : field.name,\r\n        renderer: rendererType,\r\n        valueAccessor: undefined,\r\n        cellClassFunc: () => {\r\n          const cellClass = {};\r\n          if (field.type) {\r\n            cellClass[`class_${field.type}`] = true;\r\n            return cellClass;\r\n          }\r\n        },\r\n        primary: field.primary === true ? true : false,\r\n        visible: field.visible,\r\n        validation: field.validation,\r\n        linkColumnForce: field.linkColumnForce,\r\n        type: field.type,\r\n        domainValues: undefined,\r\n        relation: undefined,\r\n        multiple: field.multiple,\r\n        step: field.step,\r\n        tooltip: field.tooltip\r\n      };\r\n\r\n      if (field.type === 'list' || field.type === 'autocomplete') {\r\n        this.getDomainValues(field.relation).subscribe(result => {\r\n          column.domainValues = result;\r\n          column.relation = field.relation;\r\n        });\r\n      }\r\n      return column;\r\n    });\r\n\r\n    relationsColumn = relations.map((relation: RelationOptions) => {\r\n      return {\r\n        name: `properties.${relation.name}`,\r\n        title: relation.alias ? relation.alias : relation.name,\r\n        renderer: EntityTableColumnRenderer.Icon,\r\n        icon: relation.icon,\r\n        parent: relation.parent,\r\n        type: 'relation',\r\n        tooltip: relation.tooltip,\r\n        onClick: () => {\r\n          if (this.adding$.getValue() === false) {\r\n            this.ws$.next(relation.title);\r\n          }\r\n        },\r\n        cellClassFunc: () => {\r\n          return { 'class_icon': true };\r\n        }\r\n      };\r\n    });\r\n\r\n    columns.push(...relationsColumn);\r\n    columns.push(...buttons);\r\n\r\n    workspace.meta.tableTemplate = {\r\n      selection: false,\r\n      sort: true,\r\n      columns\r\n    };\r\n  }\r\n\r\n  private createFilterInMapExtentOrResolutionStrategy(): EntityStoreFilterCustomFuncStrategy {\r\n    const filterClauseFunc = (record: EntityRecord<object>) => {\r\n      return record.state.inMapExtent === true && record.state.inMapResolution === true;\r\n    };\r\n    return new EntityStoreFilterCustomFuncStrategy({filterClauseFunc} as EntityStoreStrategyFuncOptions);\r\n  }\r\n\r\n  public saveFeature(feature, workspace: EditionWorkspace) {\r\n    if (!this.validateFeature(feature, workspace)){\r\n      return false;\r\n    }\r\n\r\n    this.sanitizeParameter(feature, workspace);\r\n\r\n    let url = this.configService.getConfig('edition.url');\r\n\r\n    if (workspace.layer.dataSource.options.edition.baseUrl) {\r\n      url += workspace.layer.dataSource.options.edition.baseUrl;\r\n    }\r\n\r\n    if (feature.newFeature) {\r\n      url += workspace.layer.dataSource.options.edition.addUrl;\r\n\r\n      const addHeaders = workspace.layer.dataSource.options.edition.addHeaders;\r\n      const headers = new HttpHeaders(addHeaders);\r\n\r\n      this.addFeature(feature, workspace, url, headers);\r\n    } else {\r\n      if (workspace.layer.dataSource.options.edition.modifyProtocol !== \"post\") {\r\n        url += '?' + workspace.layer.dataSource.options.edition.modifyUrl + feature.idkey;\r\n      }\r\n      else {\r\n        url += workspace.layer.dataSource.options.edition.modifyUrl;\r\n      }\r\n\r\n      const protocole = workspace.layer.dataSource.options.edition.modifyProtocol;\r\n      const modifyHeaders = workspace.layer.dataSource.options.edition.modifyHeaders;\r\n      const headers = new HttpHeaders(modifyHeaders);\r\n\r\n      this.modifyFeature(feature, workspace, url, headers, protocole);\r\n    }\r\n  }\r\n\r\n  public addFeature(feature, workspace: EditionWorkspace, url: string, headers: {[key: string]: any}) {\r\n    // TODO: adapt to any kind of geometry\r\n    if (workspace.layer.dataSource.options.edition.hasGeometry) {\r\n      //feature.properties[geom] = feature.geometry;\r\n      feature.properties[\"longitude\"] = feature.geometry.coordinates[0];\r\n      feature.properties[\"latitude\"] = feature.geometry.coordinates[1];\r\n    }\r\n\r\n    for (const property in feature.properties) {\r\n      for (const sf of workspace.layer.dataSource.options.sourceFields) {\r\n        if ((sf.name === property && sf.validation?.readonly) || (sf.name === property && sf.validation?.send === false)) {\r\n          delete feature.properties[property];\r\n        }\r\n      }\r\n    }\r\n\r\n    this.loading = true;\r\n    this.http.post(`${url}`, feature.properties, { headers: headers }).subscribe(\r\n      () => {\r\n        this.loading = false;\r\n        workspace.entityStore.stateView.clear();\r\n        workspace.deleteDrawings();\r\n        workspace.entityStore.delete(feature);\r\n\r\n        const message = this.languageService.translate.instant(\r\n          'igo.geo.workspace.addSuccess'\r\n        );\r\n        this.messageService.success(message);\r\n\r\n        this.refreshMap(workspace.layer as VectorLayer, workspace.layer.map);\r\n        this.adding$.next(false);\r\n        this.rowsInMapExtentCheckCondition$.next(true);\r\n      },\r\n      error => {\r\n        this.loading = false;\r\n        error.error.caught = true;\r\n        const genericErrorMessage = this.languageService.translate.instant(\r\n          'igo.geo.workspace.addError'\r\n        );\r\n        const messages = workspace.layer.dataSource.options.edition.messages;\r\n        if (messages) {\r\n          let text;\r\n          messages.forEach(message => {\r\n            const key = Object.keys(message)[0];\r\n            if (error.error.message.includes(key)) {\r\n              text = message[key];\r\n              this.messageService.error(text);\r\n            }\r\n          });\r\n          if (!text) {\r\n            this.messageService.error(genericErrorMessage);\r\n          }\r\n        } else {\r\n          this.messageService.error(genericErrorMessage);\r\n        }\r\n      }\r\n    );\r\n  }\r\n\r\n  public deleteFeature(workspace: EditionWorkspace, url: string) {\r\n    this.loading = true;\r\n    this.http.delete(`${url}`, {}).subscribe(\r\n      () => {\r\n        this.loading = false;\r\n        const message = this.languageService.translate.instant(\r\n          'igo.geo.workspace.deleteSuccess'\r\n        );\r\n        this.messageService.success(message);\r\n\r\n        this.refreshMap(workspace.layer as VectorLayer, workspace.layer.map);\r\n        for (const relation of workspace.layer.options.sourceOptions.relations) {\r\n          workspace.map.layers.forEach((layer) => {\r\n            if (layer.title === relation.title) {\r\n              layer.dataSource.ol.refresh();\r\n            }\r\n          });\r\n        }\r\n      },\r\n      error => {\r\n        this.loading = false;\r\n        error.error.caught = true;\r\n          const genericErrorMessage = this.languageService.translate.instant(\r\n            'igo.geo.workspace.addError'\r\n          );\r\n          const messages = workspace.layer.dataSource.options.edition.messages;\r\n          if (messages) {\r\n            let text;\r\n            messages.forEach(message => {\r\n              const key = Object.keys(message)[0];\r\n              if (error.error.message.includes(key)) {\r\n                text = message[key];\r\n                this.messageService.error(text);\r\n              }\r\n            });\r\n            if (!text) {\r\n              this.messageService.error(genericErrorMessage);\r\n            }\r\n          } else {\r\n            this.messageService.error(genericErrorMessage);\r\n          }\r\n      }\r\n    );\r\n  }\r\n\r\n  public modifyFeature(feature, workspace: EditionWorkspace, url: string, headers: {[key: string]: any}, protocole = 'patch' ) {\r\n    //TODO: adapt to any kind of geometry\r\n    if (workspace.layer.dataSource.options.edition.hasGeometry) {\r\n      //feature.properties[geom] = feature.geometry;\r\n      feature.properties[\"longitude\"] = feature.geometry.coordinates[0];\r\n      feature.properties[\"latitude\"] = feature.geometry.coordinates[1];\r\n    }\r\n\r\n    for (const property in feature.properties) {\r\n      for (const sf of workspace.layer.dataSource.options.sourceFields) {\r\n        if ((sf.name === property && sf.validation?.readonly) || (sf.name === property && sf.validation?.send === false)\r\n          || property === 'boundedBy') {\r\n          delete feature.properties[property];\r\n        }\r\n      }\r\n    }\r\n\r\n    this.loading = true;\r\n    this.http[protocole](`${url}`, feature.properties, { headers: headers }).subscribe(\r\n      () => {\r\n        this.loading = false;\r\n        this.cancelEdit(workspace, feature, true);\r\n\r\n        const message = this.languageService.translate.instant(\r\n          'igo.geo.workspace.modifySuccess'\r\n        );\r\n        this.messageService.success(message);\r\n\r\n        this.refreshMap(workspace.layer as VectorLayer, workspace.layer.map);\r\n\r\n        let relationLayers = [];\r\n        for (const relation of workspace.layer.options.sourceOptions.relations) {\r\n          workspace.map.layers.forEach((layer) => {\r\n            if (layer.title === relation.title) {\r\n              relationLayers.push(layer);\r\n              layer.dataSource.ol.refresh();\r\n            }\r\n          });\r\n        }\r\n        this.relationLayers$.next(relationLayers);\r\n      },\r\n      error => {\r\n        this.loading = false;\r\n        error.error.caught = true;\r\n        const genericErrorMessage = this.languageService.translate.instant(\r\n          'igo.geo.workspace.addError'\r\n        );\r\n        const messages = workspace.layer.dataSource.options.edition.messages;\r\n        if (messages) {\r\n          let text;\r\n          messages.forEach(message => {\r\n            const key = Object.keys(message)[0];\r\n            if (error.error.message.includes(key)) {\r\n              text = message[key];\r\n              this.messageService.error(text);\r\n            }\r\n          });\r\n          if (!text) {\r\n            this.messageService.error(genericErrorMessage);\r\n          }\r\n        } else {\r\n          this.messageService.error(genericErrorMessage);\r\n        }\r\n      }\r\n    );\r\n  }\r\n\r\n  cancelEdit(workspace: EditionWorkspace, feature, fromSave = false) {\r\n    feature.edition = false;\r\n    this.adding$.next(false);\r\n    workspace.deleteDrawings();\r\n    workspace.entityStore.stateView.clear();\r\n\r\n    if (feature.newFeature) {\r\n      workspace.entityStore.delete(feature);\r\n      workspace.deactivateDrawControl();\r\n\r\n      this.rowsInMapExtentCheckCondition$.next(true);\r\n    } else {\r\n      if (!fromSave) {\r\n        feature.properties = feature.original_properties;\r\n        feature.geometry = feature.original_geometry;\r\n      }\r\n      delete feature.original_properties;\r\n      delete feature.original_geometry;\r\n    }\r\n  }\r\n\r\n  getDomainValues(relation: RelationOptions): Observable<any> {\r\n    let url = relation.url;\r\n    if (!url) {\r\n      url = this.configService.getConfig('edition.url') + relation.table;\r\n    }\r\n\r\n    return this.http.get<any>(url).pipe(\r\n      map(result => {\r\n        return result;\r\n      }),\r\n      catchError((err: HttpErrorResponse) => {\r\n        err.error.caught = true;\r\n        return throwError(err);\r\n      })\r\n    );\r\n  }\r\n\r\n  /*\r\n   * Refresh both wms and wfs layer\r\n   * A new wfs loader is used to ensure cache is not retrieving old data\r\n   * WMS params are updated to ensure layer is correctly refreshed\r\n   */\r\n  refreshMap(layer: VectorLayer, map: IgoMap) {\r\n    const wfsOlLayer = layer.dataSource.ol;\r\n    const loader = (extent, resolution, proj, success, failure) => {\r\n      layer.customWFSLoader(\r\n        layer.ol.getSource(),\r\n        layer.options.sourceOptions,\r\n        this.authInterceptor,\r\n        extent,\r\n        resolution,\r\n        proj,\r\n        success,\r\n        failure,\r\n        true\r\n      );\r\n    };\r\n    wfsOlLayer.setLoader(loader);\r\n    wfsOlLayer.refresh();\r\n\r\n    for (const lay of map.layers) {\r\n      if (\r\n        lay.id !== layer.id &&\r\n        lay.options.linkedLayers?.linkId.includes(layer.id.substr(0, layer.id.indexOf('.') - 1)) &&\r\n        lay.options.linkedLayers?.linkId.includes('WmsWorkspaceTableSrc')\r\n      )\r\n        {\r\n          const wmsOlLayer = lay.dataSource.ol as olSourceImageWMS;\r\n          let params = wmsOlLayer.getParams();\r\n          params._t = new Date().getTime();\r\n          wmsOlLayer.updateParams(params);\r\n        }\r\n    }\r\n  }\r\n\r\n  validateFeature(feature, workspace: EditionWorkspace) {\r\n    const translate = this.languageService.translate;\r\n    let message ;\r\n    let key;\r\n    let valid = true;\r\n    workspace.meta.tableTemplate.columns.forEach(column => {\r\n      if (column.hasOwnProperty('validation') && column.validation) {\r\n        key = getColumnKeyWithoutPropertiesTag(column.name);\r\n        Object.keys( column.validation).forEach((type) => {\r\n          switch (type) {\r\n            case 'mandatory': {\r\n              if (column.validation[type] && (!feature.properties.hasOwnProperty(key) || !feature.properties[key])) {\r\n                valid = false;\r\n                  message = translate.instant('igo.geo.formValidation.mandatory',\r\n                  {\r\n                    column: column.title\r\n                  }\r\n                );\r\n                this.messageService.error(message);\r\n              }\r\n              break;\r\n            }\r\n            case 'minValue': {\r\n              if (feature.properties.hasOwnProperty(key) && feature.properties[key] && feature.properties[key] < column.validation[type]) {\r\n                valid = false;\r\n                message = translate.instant('igo.geo.formValidation.minValue',\r\n                  {\r\n                    column: column.title,\r\n                    value: column.validation[type]\r\n                  }\r\n                );\r\n                this.messageService.error(message);\r\n              }\r\n              break;\r\n            }\r\n            case 'maxValue': {\r\n              if (feature.properties.hasOwnProperty(key) && feature.properties[key] && feature.properties[key] > column.validation[type]) {\r\n                valid = false;\r\n                message = translate.instant('igo.geo.formValidation.maxValue',\r\n                  {\r\n                    column: column.title,\r\n                    value: column.validation[type]\r\n                  }\r\n                );\r\n                this.messageService.error(message);\r\n              }\r\n              break;\r\n            }\r\n            case 'minLength': {\r\n              if (\r\n                feature.properties.hasOwnProperty(key) && feature.properties[key] &&\r\n                feature.properties[key].length < column.validation[type])\r\n              {\r\n                valid = false;\r\n                message = translate.instant('igo.geo.formValidation.minLength',\r\n                  {\r\n                    column: column.title,\r\n                    value: column.validation[type]\r\n                  }\r\n                );\r\n                this.messageService.error(message);\r\n              }\r\n              break;\r\n            }\r\n            case 'maxLength': {\r\n              if (\r\n                feature.properties.hasOwnProperty(key) && feature.properties[key] &&\r\n                feature.properties[key].length > column.validation[type])\r\n              {\r\n                valid = false;\r\n                message = translate.instant('igo.geo.formValidation.maxLength',\r\n                  {\r\n                    column: column.title,\r\n                    value: column.validation[type]\r\n                  }\r\n                );\r\n                this.messageService.error(message);\r\n              }\r\n              break;\r\n            }\r\n            }\r\n          });\r\n      }\r\n    });\r\n    return valid;\r\n  }\r\n\r\n  sanitizeParameter(feature, workspace: EditionWorkspace) {\r\n    workspace.meta.tableTemplate.columns.forEach(column => {\r\n      if (column.type === 'list' && feature.properties[getColumnKeyWithoutPropertiesTag(column.name)]) {\r\n        feature.properties[getColumnKeyWithoutPropertiesTag(column.name)] =\r\n          feature.properties[getColumnKeyWithoutPropertiesTag(column.name)].toString();\r\n      }\r\n\r\n    });\r\n  }\r\n\r\n}\r\n\r\nfunction getColumnKeyWithoutPropertiesTag(column: string) {\r\n  if (column.includes('properties.')) {\r\n    return column.split('.')[1];\r\n  }\r\n  return column;\r\n}\r\n","import {\r\n  Workspace,\r\n  WorkspaceOptions\r\n} from '@igo2/common';\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport { VectorLayer } from '../../layer';\r\nimport { IgoMap } from '../../map';\r\n\r\nexport interface FeatureWorkspaceOptions extends WorkspaceOptions {\r\n  layer: VectorLayer;\r\n  map: IgoMap;\r\n}\r\n\r\nexport class FeatureWorkspace extends Workspace {\r\n\r\n  readonly inResolutionRange$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n\r\n  get layer(): VectorLayer { return this.options.layer; }\r\n\r\n  get map(): IgoMap { return this.options.map; }\r\n\r\n  constructor(protected options: FeatureWorkspaceOptions) {\r\n    super(options);\r\n    this.map.viewController.resolution$.subscribe((mapResolution) => {\r\n      if (mapResolution > this.layer.minResolution && mapResolution < this.layer.maxResolution) {\r\n        this.inResolutionRange$.next(true);\r\n      } else {\r\n        this.inResolutionRange$.next(false);\r\n      }\r\n    });\r\n  }\r\n\r\n  public getLayerWksOptionTabQuery(): boolean {\r\n    if (this.layer.options.workspace.queryOptions?.tabQuery !== undefined) {\r\n      return this.layer.options.workspace.queryOptions.tabQuery;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  public getLayerWksOptionMapQuery(): boolean {\r\n    if (this.layer.options.workspace.queryOptions?.mapQueryOnOpenTab !== undefined) {\r\n      return this.layer.options.workspace.queryOptions.mapQueryOnOpenTab;\r\n    }\r\n    return true;\r\n  }\r\n\r\n  private getInResolutionRange(): boolean {\r\n    return this.inResolutionRange$.value;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport {\r\n  ActionStore,\r\n  EntityTableTemplate,\r\n  EntityStoreFilterCustomFuncStrategy,\r\n  EntityRecord,\r\n  EntityStoreStrategyFuncOptions,\r\n  EntityStoreFilterSelectionStrategy,\r\n  EntityTableColumnRenderer\r\n} from '@igo2/common';\r\n\r\nimport {\r\n  FeatureStore,\r\n  FeatureStoreLoadingLayerStrategy,\r\n  FeatureStoreSelectionStrategy,\r\n  FeatureStoreInMapExtentStrategy,\r\n  Feature,\r\n  FeatureMotion,\r\n  FeatureStoreInMapResolutionStrategy\r\n} from '../../feature';\r\nimport { VectorLayer } from '../../layer';\r\nimport { GeoWorkspaceOptions } from '../../layer/shared/layers/layer.interface';\r\nimport { IgoMap } from '../../map';\r\nimport { SourceFieldsOptionsParams, FeatureDataSource, RelationOptions } from '../../datasource';\r\nimport { getCommonVectorSelectedStyle} from '../../utils';\r\n\r\nimport { FeatureWorkspace } from './feature-workspace';\r\nimport { skipWhile, take } from 'rxjs/operators';\r\nimport { ConfigService, StorageService } from '@igo2/core';\r\n\r\nimport olFeature from 'ol/Feature';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class FeatureWorkspaceService {\r\n\r\n  get zoomAuto(): boolean {\r\n    return this.storageService.get('zoomAuto') as boolean;\r\n  }\r\n\r\n  public ws$ = new BehaviorSubject<string>(undefined);\r\n\r\n  constructor(private storageService: StorageService, private configService: ConfigService) {}\r\n\r\n  createWorkspace(layer: VectorLayer, map: IgoMap): FeatureWorkspace {\r\n    if (layer.options.workspace?.enabled === false || layer.dataSource.options.edition) {\r\n      return;\r\n    }\r\n\r\n    layer.options.workspace = Object.assign({}, layer.options.workspace,\r\n      {\r\n        srcId: layer.id,\r\n        workspaceId: layer.id,\r\n        enabled: true\r\n      } as GeoWorkspaceOptions);\r\n\r\n\r\n    const wks = new FeatureWorkspace({\r\n      id: layer.id,\r\n      title: layer.title,\r\n      layer,\r\n      map,\r\n      entityStore: this.createFeatureStore(layer, map),\r\n      actionStore: new ActionStore([]),\r\n      meta: {\r\n        tableTemplate: undefined\r\n      }\r\n    });\r\n    this.createTableTemplate(wks, layer);\r\n    return wks;\r\n\r\n  }\r\n\r\n  private createFeatureStore(layer: VectorLayer, map: IgoMap): FeatureStore {\r\n    const store = new FeatureStore([], {map});\r\n    store.bindLayer(layer);\r\n\r\n    const loadingStrategy = new FeatureStoreLoadingLayerStrategy({});\r\n    const inMapExtentStrategy = new FeatureStoreInMapExtentStrategy({});\r\n    const inMapResolutionStrategy = new FeatureStoreInMapResolutionStrategy({});\r\n    const selectedRecordStrategy = new EntityStoreFilterSelectionStrategy({});\r\n    const confQueryOverlayStyle= this.configService.getConfig('queryOverlayStyle');\r\n\r\n    const selectionStrategy = new FeatureStoreSelectionStrategy({\r\n      layer: new VectorLayer({\r\n        zIndex: 300,\r\n        source: new FeatureDataSource(),\r\n        style: (feature) => {\r\n          return getCommonVectorSelectedStyle(Object.assign({}, {feature}, confQueryOverlayStyle.selection || {}));\r\n        },\r\n        showInLayerList: false,\r\n        exportable: false,\r\n        browsable: false\r\n      }),\r\n      map,\r\n      hitTolerance: 15,\r\n      motion: this.zoomAuto ? FeatureMotion.Default : FeatureMotion.None,\r\n      many: true,\r\n      dragBox: true\r\n    });\r\n    store.addStrategy(loadingStrategy, true);\r\n    store.addStrategy(inMapExtentStrategy, true);\r\n    store.addStrategy(inMapResolutionStrategy, true);\r\n    store.addStrategy(selectionStrategy, true);\r\n    store.addStrategy(selectedRecordStrategy, false);\r\n    store.addStrategy(this.createFilterInMapExtentOrResolutionStrategy(), true);\r\n    return store;\r\n  }\r\n\r\n  private createTableTemplate(workspace: FeatureWorkspace, layer: VectorLayer): EntityTableTemplate {\r\n    const fields = layer.dataSource.options.sourceFields || [];\r\n\r\n    const relations = layer.dataSource.options.relations || [];\r\n\r\n    if (fields.length === 0) {\r\n      workspace.entityStore.entities$.pipe(\r\n        skipWhile(val => val.length === 0),\r\n        take(1)\r\n      ).subscribe(entities => {\r\n        const ol = (entities[0] as Feature).ol as olFeature<OlGeometry>;\r\n        const columnsFromFeatures = ol.getKeys()\r\n        .filter(\r\n          col => !col.startsWith('_') &&\r\n          col !== 'geometry' &&\r\n          col !== ol.getGeometryName() &&\r\n          !col.match(/boundedby/gi))\r\n        .map(key => {\r\n          return {\r\n            name: `properties.${key}`,\r\n            title: key,\r\n            renderer: EntityTableColumnRenderer.UnsanitizedHTML\r\n          };\r\n        });\r\n        workspace.meta.tableTemplate = {\r\n          selection: true,\r\n          sort: true,\r\n          columns: columnsFromFeatures\r\n        };\r\n      });\r\n      return;\r\n    }\r\n    const columns = fields.map((field: SourceFieldsOptionsParams) => {\r\n      return {\r\n        name: `properties.${field.name}`,\r\n        title: field.alias ? field.alias : field.name,\r\n        renderer: EntityTableColumnRenderer.UnsanitizedHTML,\r\n        tooltip: field.tooltip\r\n      };\r\n    });\r\n\r\n    const relationsColumn = relations.map((relation: RelationOptions) => {\r\n      return {\r\n        name: `properties.${relation.name}`,\r\n        title: relation.alias ? relation.alias : relation.name,\r\n        renderer: EntityTableColumnRenderer.Icon,\r\n        icon: relation.icon,\r\n        parent: relation.parent,\r\n        type: 'relation',\r\n        tooltip: relation.tooltip,\r\n        onClick: () => {\r\n            this.ws$.next(relation.title);\r\n        },\r\n        cellClassFunc: () => {\r\n          return { 'class_icon': true };\r\n        }\r\n      };\r\n    });\r\n\r\n    columns.push(...relationsColumn);\r\n    workspace.meta.tableTemplate = {\r\n      selection: true,\r\n      sort: true,\r\n      columns\r\n    };\r\n  }\r\n\r\n  private createFilterInMapExtentOrResolutionStrategy(): EntityStoreFilterCustomFuncStrategy {\r\n    const filterClauseFunc = (record: EntityRecord<object>) => {\r\n      return record.state.inMapExtent === true && record.state.inMapResolution === true;\r\n    };\r\n    return new EntityStoreFilterCustomFuncStrategy({filterClauseFunc} as EntityStoreStrategyFuncOptions);\r\n  }\r\n}\r\n","import { Directive, Input, OnInit, OnDestroy, Output, EventEmitter } from '@angular/core';\r\n\r\nimport { Subscription } from 'rxjs';\r\nimport { debounceTime } from 'rxjs/operators';\r\n\r\nimport { Workspace, WorkspaceStore, WorkspaceSelectorComponent } from '@igo2/common';\r\n\r\nimport { Layer, ImageLayer, VectorLayer } from '../../layer';\r\nimport { IgoMap } from '../../map';\r\nimport { WFSDataSource, WMSDataSource, FeatureDataSource } from '../../datasource';\r\nimport { OgcFilterableDataSourceOptions } from '../../filter';\r\n\r\nimport { WfsWorkspaceService } from '../shared/wfs-workspace.service';\r\nimport { WmsWorkspaceService } from '../shared/wms-workspace.service';\r\nimport { EditionWorkspaceService } from '../shared/edition-workspace.service';\r\nimport { FeatureWorkspaceService } from '../shared/feature-workspace.service';\r\nimport { FeatureStoreInMapExtentStrategy } from '../../feature/shared/strategies/in-map-extent';\r\nimport { QueryableDataSourceOptions } from '../../query/shared/query.interfaces';\r\n\r\n@Directive({\r\n  selector: '[igoWorkspaceSelector]'\r\n})\r\nexport class WorkspaceSelectorDirective implements OnInit, OnDestroy {\r\n\r\n  private layers$$: Subscription;\r\n  private entities$$: Subscription[] = [];\r\n\r\n  @Input() map: IgoMap;\r\n\r\n  @Output() changeWorkspace = new EventEmitter<string>();\r\n  @Output() disableSwitch = new EventEmitter<boolean>();\r\n  @Output() relationLayers = new EventEmitter<ImageLayer[] | VectorLayer[]>();\r\n  @Output() rowsInMapExtentCheckCondition = new EventEmitter<boolean>();\r\n\r\n  get workspaceStore(): WorkspaceStore {\r\n    return this.component.store;\r\n  }\r\n\r\n  constructor(\r\n    private component: WorkspaceSelectorComponent,\r\n    private wfsWorkspaceService: WfsWorkspaceService,\r\n    private wmsWorkspaceService: WmsWorkspaceService,\r\n    private editionWorkspaceService: EditionWorkspaceService,\r\n    private featureWorkspaceService: FeatureWorkspaceService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.layers$$ = this.map.layers$\r\n      .pipe(debounceTime(50))\r\n      .subscribe((layers: Layer[]) =>\r\n        this.onLayersChange(layers)\r\n      );\r\n\r\n    this.featureWorkspaceService.ws$.subscribe((ws) => { this.changeWorkspace.emit(ws); });\r\n    this.wmsWorkspaceService.ws$.subscribe((ws) => { this.changeWorkspace.emit(ws); });\r\n    this.wfsWorkspaceService.ws$.subscribe((ws) => { this.changeWorkspace.emit(ws); });\r\n    this.editionWorkspaceService.ws$.subscribe((ws) => { this.changeWorkspace.emit(ws); });\r\n    this.editionWorkspaceService.adding$.subscribe((adding) => { this.disableSwitch.emit(adding); });\r\n    this.editionWorkspaceService.relationLayers$.subscribe((layers) => { this.relationLayers.emit(layers); });\r\n    this.editionWorkspaceService.rowsInMapExtentCheckCondition$.subscribe((condition) => {\r\n      this.rowsInMapExtentCheckCondition.emit(condition);\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.layers$$.unsubscribe();\r\n    this.entities$$.map(entities => entities.unsubscribe());\r\n  }\r\n\r\n  private onLayersChange(layers: Layer[]) {\r\n    const editableLayers = layers.filter((layer: Layer) =>\r\n      this.layerIsEditable(layer)\r\n    );\r\n    const editableLayersIds = editableLayers.map((layer: Layer) => layer.id);\r\n\r\n    const workspacesToAdd = editableLayers\r\n      .map((layer: VectorLayer) => this.getOrCreateWorkspace(layer))\r\n      .filter((workspace: Workspace | undefined) => workspace !== undefined);\r\n\r\n    const workspacesToRemove = this.workspaceStore.all()\r\n      .filter((workspace: Workspace) => {\r\n        return editableLayersIds.indexOf(workspace.id) < 0;\r\n      });\r\n\r\n    if (workspacesToRemove.length > 0) {\r\n      workspacesToRemove.forEach((workspace: Workspace) => {\r\n        workspace.entityStore.deactivateStrategyOfType(FeatureStoreInMapExtentStrategy);\r\n        workspace.deactivate();\r\n      });\r\n      this.workspaceStore.state.updateMany(workspacesToRemove, {active: false, selected: false});\r\n      this.workspaceStore.deleteMany(workspacesToRemove);\r\n    }\r\n\r\n    if (workspacesToAdd.length > 0) {\r\n      this.workspaceStore.insertMany(workspacesToAdd);\r\n    }\r\n  }\r\n\r\n  private getOrCreateWorkspace(layer: VectorLayer | ImageLayer): Workspace | undefined {\r\n    const workspace = this.workspaceStore.get(layer.id);\r\n    if (workspace !== undefined) {\r\n      return;\r\n    }\r\n    if (layer.dataSource instanceof WFSDataSource && layer.dataSource.options.edition?.enabled !== true) {\r\n      const wfsWks = this.wfsWorkspaceService.createWorkspace(layer as VectorLayer, this.map);\r\n      return wfsWks;\r\n    } else if (layer.dataSource instanceof WMSDataSource && layer.dataSource.options.edition?.enabled !== true) {\r\n      if (!layer.dataSource.options.paramsWFS) { return; }\r\n      const wmsWks = this.wmsWorkspaceService.createWorkspace(layer as ImageLayer, this.map);\r\n      wmsWks?.inResolutionRange$.subscribe((inResolutionRange) => {\r\n        (layer.dataSource.options as QueryableDataSourceOptions).queryable = !inResolutionRange;\r\n        (wmsWks.layer.dataSource.options as QueryableDataSourceOptions).queryable = inResolutionRange;\r\n      });\r\n      return wmsWks;\r\n    } else if (\r\n        layer.dataSource instanceof FeatureDataSource &&\r\n        (layer as VectorLayer).exportable === true &&\r\n        layer.dataSource.options.edition?.enabled !== true) {\r\n      const featureWks = this.featureWorkspaceService.createWorkspace(layer as VectorLayer, this.map);\r\n      return featureWks;\r\n    } else if (layer.dataSource instanceof WMSDataSource && layer.dataSource.options.edition?.enabled === true) {\r\n      const editionWks = this.editionWorkspaceService.createWorkspace(layer as ImageLayer, this.map);\r\n      return editionWks;\r\n    }\r\n\r\n    return;\r\n  }\r\n\r\n  private layerIsEditable(layer: Layer): boolean {\r\n    const dataSource = layer.dataSource;\r\n    if (dataSource instanceof WFSDataSource) {\r\n      return true;\r\n    }\r\n    if (dataSource instanceof FeatureDataSource) {\r\n      return true;\r\n    }\r\n    if (dataSource instanceof WMSDataSource) {\r\n      const dataSourceOptions = (dataSource.options ||\r\n        {}) as OgcFilterableDataSourceOptions;\r\n      return (dataSourceOptions.ogcFilters?.enabled || dataSource.options.paramsWFS?.featureTypes !== undefined);\r\n    }\r\n\r\n    return false;\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { WorkspaceSelectorDirective } from './workspace-selector.directive';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule\r\n  ],\r\n  exports: [\r\n   WorkspaceSelectorDirective\r\n  ],\r\n  declarations: [\r\n    WorkspaceSelectorDirective\r\n  ]\r\n})\r\nexport class IgoWorkspaceSelectorModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { WorkspaceUpdatorDirective } from './workspace-updator.directive';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule\r\n  ],\r\n  exports: [\r\n   WorkspaceUpdatorDirective\r\n  ],\r\n  declarations: [\r\n    WorkspaceUpdatorDirective\r\n  ]\r\n})\r\nexport class IgoWorkspaceUpdatorModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatButtonToggleModule } from '@angular/material/button-toggle';\r\nimport { MatDialogModule } from '@angular/material/dialog';\r\n\r\nimport { ConfirmationPopupComponent } from './confirmation-popup.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatButtonModule,\r\n    MatDialogModule,\r\n    MatButtonToggleModule\r\n  ],\r\n  exports: [ConfirmationPopupComponent],\r\n  declarations: [ConfirmationPopupComponent]\r\n})\r\nexport class IgoConfirmationPopupModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatDialogModule } from '@angular/material/dialog';\r\nimport { IgoWidgetModule } from '@igo2/common';\r\n\r\nimport { provideOgcFilterWidget } from './widgets/widgets';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoOgcFilterModule } from './widgets/ogc-filter/ogc-filter.module';\r\nimport { IgoWorkspaceSelectorModule } from './workspace-selector/workspace-selector.module';\r\nimport { IgoWorkspaceUpdatorModule } from './workspace-updator/workspace-updator.module';\r\nimport { IgoConfirmationPopupModule } from './confirmation-popup/confirmation-popup.module';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoLanguageModule,\r\n    IgoWidgetModule,\r\n    IgoWorkspaceSelectorModule,\r\n    IgoWorkspaceUpdatorModule,\r\n    IgoOgcFilterModule,\r\n    MatDialogModule\r\n  ],\r\n  exports: [\r\n    IgoWorkspaceSelectorModule,\r\n    IgoWorkspaceUpdatorModule,\r\n    IgoOgcFilterModule,\r\n    IgoConfirmationPopupModule\r\n  ],\r\n  declarations: [],\r\n  providers: [\r\n    provideOgcFilterWidget()\r\n  ]\r\n})\r\nexport class IgoGeoWorkspaceModule {}\r\n","import { EntityStore } from '@igo2/common';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport { FeatureStore } from '../../feature/shared/store';\r\nimport { FeatureWithDirection, FeatureWithStep, FeatureWithStop, Stop } from './directions.interface';\r\n\r\n/**\r\n * The class is a specialized version of an EntityStore that stores\r\n * stops.\r\n */\r\nexport class StopsStore extends EntityStore<Stop> {\r\n\r\n    public storeInitialized$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n    public clearStops() {\r\n        this.storeInitialized$.next(false);\r\n        this.clear();\r\n    }\r\n\r\n}\r\n\r\nexport class StopsFeatureStore extends FeatureStore<FeatureWithStop> {\r\n\r\n}\r\nexport class RoutesFeatureStore extends FeatureStore<FeatureWithDirection> {\r\n\r\n}\r\nexport class StepFeatureStore extends FeatureStore<FeatureWithStep> {\r\n\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient, HttpParams } from '@angular/common/http';\r\nimport { Observable } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { Cacheable } from 'ts-cacheable';\r\n\r\nimport { uuid } from '@igo2/utils';\r\nimport { ConfigService } from '@igo2/core';\r\n\r\nimport { Direction, DirectionOptions } from '../shared/directions.interface';\r\nimport { DirectionsFormat, SourceDirectionsType } from '../shared/directions.enum';\r\n\r\nimport { DirectionsSource } from './directions-source';\r\nimport { DirectionsSourceOptions } from './directions-source.interface';\r\n\r\n@Injectable()\r\nexport class OsrmDirectionsSource extends DirectionsSource {\r\n  get enabled(): boolean {\r\n    return this.options.enabled !== false;\r\n  }\r\n  set enabled(value: boolean) {\r\n    this.options.enabled = value;\r\n  }\r\n  static _name = 'OSRM Qubec';\r\n  private directionsUrl =\r\n    'https://geoegl.msp.gouv.qc.ca/services/itineraire/route/v1/driving/';\r\n  private options: DirectionsSourceOptions;\r\n\r\n  constructor(private http: HttpClient, private config: ConfigService) {\r\n    super();\r\n    this.options = this.config.getConfig('directionsSources.osrm') || {};\r\n    this.directionsUrl = this.options.url || this.directionsUrl;\r\n  }\r\n\r\n  getName(): string {\r\n    return OsrmDirectionsSource._name;\r\n  }\r\n\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  route(coordinates: [number, number][], directionsOptions: DirectionOptions = {}): Observable<Direction[]> {\r\n    const directionsParams = this.getRouteParams(directionsOptions);\r\n    return this.http\r\n      .get<JSON[]>(this.directionsUrl + coordinates.join(';'), {\r\n        params: directionsParams\r\n      })\r\n      .pipe(map(res => this.extractRoutesData(res)));\r\n  }\r\n\r\n  private extractRoutesData(response): Direction[] {\r\n    const routeResponse = [];\r\n    response.routes.forEach(route => {\r\n      routeResponse.push(this.formatRoute(route, response.waypoints));\r\n    });\r\n    return routeResponse;\r\n  }\r\n\r\n  private getRouteParams(directionsOptions: DirectionOptions = {}): HttpParams {\r\n\r\n    directionsOptions.alternatives = directionsOptions.alternatives !== undefined ? directionsOptions.alternatives : true;\r\n    directionsOptions.steps = directionsOptions.steps !== undefined ? directionsOptions.steps : true;\r\n    directionsOptions.geometries = directionsOptions.geometries !== undefined ? directionsOptions.geometries : 'geojson';\r\n    directionsOptions.overview = directionsOptions.overview !== undefined ? directionsOptions.overview : false;\r\n    directionsOptions.continue_straight = directionsOptions.continue_straight !== undefined ? directionsOptions.continue_straight : false;\r\n\r\n    return new HttpParams({\r\n      fromObject: {\r\n        alternatives: directionsOptions.alternatives ? 'true' : 'false',\r\n        overview: directionsOptions.overview ? 'simplified' : 'full',\r\n        steps: directionsOptions.steps ? 'true' : 'false',\r\n        geometries: directionsOptions.geometries ? directionsOptions.geometries : 'geojson',\r\n        continue_straight: directionsOptions.continue_straight ? 'true' : 'false',\r\n      }\r\n    });\r\n  }\r\n\r\n  private formatRoute(roadNetworkRoute: any, waypoints: any): Direction {\r\n    const stepsUI = [];\r\n    roadNetworkRoute.legs.forEach(leg => {\r\n      leg.steps.forEach(step => {\r\n        stepsUI.push(step);\r\n      });\r\n    });\r\n    return {\r\n      id: uuid(),\r\n      title: roadNetworkRoute.legs[0].summary,\r\n      source: OsrmDirectionsSource._name,\r\n      sourceType: SourceDirectionsType.Route,\r\n      order: 1,\r\n      format: DirectionsFormat.GeoJSON,\r\n      icon: 'directions',\r\n      projection: 'EPSG:4326',\r\n      waypoints,\r\n      distance: roadNetworkRoute.distance,\r\n      duration: roadNetworkRoute.duration,\r\n      geometry: roadNetworkRoute.geometry,\r\n      legs: roadNetworkRoute.legs,\r\n      steps: stepsUI,\r\n      weight: roadNetworkRoute.weight,\r\n      weight_name: roadNetworkRoute.weight_name\r\n    };\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\n\r\nimport { DirectionsSource } from './directions-source';\r\nimport { OsrmDirectionsSource } from './osrm-directions-source';\r\n\r\nexport function osrmDirectionsSourcesFactory(\r\n  http: HttpClient,\r\n  config: ConfigService\r\n) {\r\n  return new OsrmDirectionsSource(http, config);\r\n}\r\n\r\nexport function provideOsrmDirectionsSource() {\r\n  return {\r\n    provide: DirectionsSource,\r\n    useFactory: osrmDirectionsSourcesFactory,\r\n    multi: true,\r\n    deps: [HttpClient, ConfigService]\r\n  };\r\n}\r\n","import { Injectable, Inject } from '@angular/core';\r\nimport { HttpClient, HttpParams } from '@angular/common/http';\r\n\r\nimport { Observable, of } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport olWKT from 'ol/format/WKT';\r\n\r\nimport { FEATURE, Feature, FeatureGeometry } from '../../../feature';\r\n\r\nimport { SearchResult } from '../search.interfaces';\r\nimport { SearchSource, TextSearch } from './source';\r\nimport { SearchSourceOptions, TextSearchOptions } from './source.interfaces';\r\n\r\nimport { LanguageService, StorageService } from '@igo2/core';\r\nimport { computeTermSimilarity } from '../search.utils';\r\nimport { Cacheable } from 'ts-cacheable';\r\n/**\r\n * Cadastre search source\r\n */\r\n@Injectable()\r\nexport class CadastreSearchSource extends SearchSource implements TextSearch {\r\n  static id = 'cadastre';\r\n  static type = FEATURE;\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private languageService: LanguageService,\r\n    storageService: StorageService,\r\n    @Inject('options') options: SearchSourceOptions\r\n  ) {\r\n    super(options, storageService);\r\n  }\r\n\r\n  getId(): string {\r\n    return CadastreSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return CadastreSearchSource.type;\r\n  }\r\n\r\n  /*\r\n   * Source : https://wiki.openstreetmap.org/wiki/Key:amenity\r\n   */\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    return {\r\n      title: 'Cadastre (Qubec)',\r\n      searchUrl: 'https://carto.cptaq.gouv.qc.ca/php/find_lot_v1.php?'\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a place by name\r\n   * @param term Place name\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  search(\r\n    term: string | undefined,\r\n    options?: TextSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    term = term.endsWith(',') ? term.slice(0, -1) : term;\r\n    term = term.startsWith(',') ? term.substr(1) : term;\r\n    term = term.replace(/ /g, '');\r\n\r\n    const params = this.computeSearchRequestParams(term, options || {});\r\n    if (!params.get('numero') || !params.get('numero').match(/^[0-9,]+$/g)) {\r\n      return of([]);\r\n    }\r\n    return this.http\r\n      .get(this.searchUrl, { params, responseType: 'text' })\r\n      .pipe(map((response: string) => this.extractResults(response, term)));\r\n  }\r\n\r\n  private computeSearchRequestParams(\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): HttpParams {\r\n    return new HttpParams({\r\n      fromObject: Object.assign(\r\n        {\r\n          numero: term,\r\n          epsg: '4326'\r\n        },\r\n        this.params,\r\n        options.params || {}\r\n      )\r\n    });\r\n  }\r\n\r\n  private extractResults(response: string, term: string): SearchResult<Feature>[] {\r\n    return response\r\n      .split('<br />')\r\n      .filter((lot: string) => lot.length > 0)\r\n      .map((lot: string) => this.dataToResult(lot, term));\r\n  }\r\n\r\n  private dataToResult(data: string, term: string): SearchResult<Feature> {\r\n    const lot = data.split(';');\r\n    const numero = lot[0];\r\n    const wkt = lot[7];\r\n    const geometry = this.computeGeometry(wkt);\r\n\r\n    const properties = {\r\n      NoLot: numero,\r\n      Route: '<span class=\"routing\"> <u>' + this.languageService.translate.instant('igo.geo.seeRouting') + '</u> </span>'\r\n    };\r\n    const id = [this.getId(), 'cadastre', numero].join('.');\r\n\r\n    return {\r\n      source: this,\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id,\r\n        title: numero,\r\n        score: computeTermSimilarity(term.trim(), numero),\r\n        icon: 'map-marker'\r\n      },\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry,\r\n        properties,\r\n        meta: {\r\n          id,\r\n          title: numero\r\n        }\r\n      }\r\n    };\r\n  }\r\n\r\n  private computeGeometry(wkt: string): FeatureGeometry {\r\n    const feature = new olWKT().readFeature(wkt, {\r\n      dataProjection: 'EPSG:4326',\r\n      featureProjection: 'EPSG:4326'\r\n    });\r\n    return {\r\n      type: feature.getGeometry().getType(),\r\n      coordinates: feature.getGeometry().getCoordinates()\r\n    };\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\n\r\nimport { ConfigService, LanguageService, StorageService } from '@igo2/core';\r\n\r\nimport { SearchSource } from './source';\r\nimport { CadastreSearchSource } from './cadastre';\r\n\r\n/**\r\n * Cadastre search source factory\r\n * @ignore\r\n */\r\nexport function cadastreSearchSourceFactory(\r\n  http: HttpClient,\r\n  languageService: LanguageService,\r\n  storageService: StorageService,\r\n  config: ConfigService\r\n) {\r\n  return new CadastreSearchSource(\r\n    http,\r\n    languageService,\r\n    storageService,\r\n    config.getConfig(`searchSources.${CadastreSearchSource.id}`),\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the Cadastre search source\r\n */\r\nexport function provideCadastreSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: cadastreSearchSourceFactory,\r\n    multi: true,\r\n    deps: [HttpClient, LanguageService, StorageService, ConfigService]\r\n  };\r\n}\r\n","import { Injectable, Inject } from '@angular/core';\r\nimport { HttpClient, HttpParams } from '@angular/common/http';\r\n\r\nimport { Observable, of } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { FEATURE, Feature, FeatureGeometry } from '../../../feature';\r\n\r\nimport { StorageService } from '@igo2/core';\r\nimport { SearchResult } from '../search.interfaces';\r\nimport { SearchSource, TextSearch } from './source';\r\nimport { SearchSourceOptions, TextSearchOptions } from './source.interfaces';\r\nimport { NominatimData } from './nominatim.interfaces';\r\nimport { computeTermSimilarity } from '../search.utils';\r\nimport { Cacheable } from 'ts-cacheable';\r\n\r\n/**\r\n * Nominatim search source\r\n */\r\n@Injectable()\r\nexport class NominatimSearchSource extends SearchSource implements TextSearch {\r\n  static id = 'nominatim';\r\n  static type = FEATURE;\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    @Inject('options') options: SearchSourceOptions,\r\n    storageService: StorageService\r\n  ) {\r\n    super(options, storageService);\r\n  }\r\n\r\n  getId(): string {\r\n    return NominatimSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return NominatimSearchSource.type;\r\n  }\r\n\r\n  /*\r\n   * Source : https://wiki.openstreetmap.org/wiki/Key:amenity\r\n   */\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    return {\r\n      title: 'Nominatim (OSM)',\r\n      searchUrl: 'https://nominatim.openstreetmap.org/search',\r\n      settings: [\r\n        {\r\n          type: 'checkbox',\r\n          title: 'results type',\r\n          name: 'amenity',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.nominatim.type.food',\r\n              value:\r\n                'bar,bbq,biergaten,cafe,drinking_water,fast_food,food_court,ice_cream,pub,restaurant',\r\n              enabled: false\r\n            },\r\n            {\r\n              title: 'igo.geo.search.nominatim.type.health',\r\n              value:\r\n                'baby_hatch,clinic,dentist,doctors,hospital,nursing_home,pharmacy,social_facility,veterinary',\r\n              enabled: false\r\n            },\r\n            {\r\n              title: 'igo.geo.search.nominatim.type.entertainment',\r\n              value:\r\n                'arts_centre,brothel,casino,cinema,community_center_fountain,gambling,nightclub,planetarium \\\r\n                          ,public_bookcase,social_centre,stripclub,studio,swingerclub,theatre,internet_cafe',\r\n              enabled: false\r\n            },\r\n            {\r\n              title: 'igo.geo.search.nominatim.type.finance',\r\n              value: 'atm,bank,bureau_de_change',\r\n              enabled: false\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'results limit',\r\n          name: 'limit',\r\n          values: [\r\n            {\r\n              title: '10',\r\n              value: 10,\r\n              enabled: true\r\n            },\r\n            {\r\n              title: '20',\r\n              value: 20,\r\n              enabled: false\r\n            },\r\n            {\r\n              title: '50',\r\n              value: 50,\r\n              enabled: false\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'restrictExtent',\r\n          name: 'countrycodes',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.nominatim.country.canada',\r\n              value: 'CA',\r\n              enabled: true\r\n            },\r\n            {\r\n              title: 'igo.geo.search.nominatim.country.all',\r\n              value: null,\r\n              enabled: false\r\n            }\r\n          ]\r\n        },\r\n        {\r\n          type: 'radiobutton',\r\n          title: 'multiple object',\r\n          name: 'dedupe',\r\n          values: [\r\n            {\r\n              title: 'igo.geo.search.searchSources.settings.true',\r\n              value: 0,\r\n              enabled: false\r\n            },\r\n            {\r\n              title: 'igo.geo.search.searchSources.settings.false',\r\n              value: 1,\r\n              enabled: true\r\n            }\r\n          ]\r\n        }\r\n      ]\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a place by name\r\n   * @param term Place name\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  search(\r\n    term: string | undefined,\r\n    options?: TextSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    const params = this.computeSearchRequestParams(term, options || {});\r\n    if (!params.get('q')) {\r\n      return of([]);\r\n    }\r\n    return this.http\r\n      .get(this.searchUrl, { params })\r\n      .pipe(map((response: NominatimData[]) => this.extractResults(response, term)));\r\n  }\r\n\r\n  private computeSearchRequestParams(\r\n    term: string,\r\n    options: TextSearchOptions\r\n  ): HttpParams {\r\n    return new HttpParams({\r\n      fromObject: Object.assign(\r\n        {\r\n          q: this.computeTerm(term),\r\n          format: 'json'\r\n        },\r\n        this.params,\r\n        options.params || {}\r\n      )\r\n    });\r\n  }\r\n\r\n  private extractResults(response: NominatimData[], term: string): SearchResult<Feature>[] {\r\n    return response.map((data: NominatimData) => this.dataToResult(data, term));\r\n  }\r\n\r\n  private dataToResult(data: NominatimData, term: string): SearchResult<Feature> {\r\n    const properties = this.computeProperties(data);\r\n    const geometry = this.computeGeometry(data);\r\n    const extent = this.computeExtent(data);\r\n    const id = [this.getId(), 'place', data.place_id].join('.');\r\n\r\n    return {\r\n      source: this,\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id,\r\n        title: data.display_name,\r\n        icon: 'map-marker',\r\n        score: computeTermSimilarity(term.trim(), data.display_name)\r\n      },\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry,\r\n        extent,\r\n        properties,\r\n        meta: {\r\n          id,\r\n          title: data.display_name\r\n        }\r\n      }\r\n    };\r\n  }\r\n\r\n  private computeProperties(data: NominatimData): { [key: string]: any } {\r\n    return {\r\n      display_name: data.display_name,\r\n      place_id: data.place_id,\r\n      osm_type: data.osm_type,\r\n      class: data.class,\r\n      type: data.type\r\n    };\r\n  }\r\n\r\n  private computeGeometry(data: NominatimData): FeatureGeometry {\r\n    return {\r\n      type: 'Point',\r\n      coordinates: [parseFloat(data.lon), parseFloat(data.lat)]\r\n    };\r\n  }\r\n\r\n  private computeExtent(data: NominatimData): [number, number, number, number] {\r\n    return [\r\n      parseFloat(data.boundingbox[2]),\r\n      parseFloat(data.boundingbox[0]),\r\n      parseFloat(data.boundingbox[3]),\r\n      parseFloat(data.boundingbox[1])\r\n    ];\r\n  }\r\n\r\n  private computeTerm(term: string): string {\r\n    return this.computeTermTags(term);\r\n  }\r\n\r\n  /**\r\n   * Add hashtag from query in Nominatim's format (+[])\r\n   * @param term Query with hashtag\r\n   */\r\n  private computeTermTags(term: string): string {\r\n    const hashtags = super.getHashtagsValid(term, 'amenity');\r\n    if (!hashtags) {\r\n      return this.computeTermSettings(term);\r\n    }\r\n\r\n    if (!hashtags.length) {\r\n      return null;\r\n    }\r\n\r\n    term = term.replace(/(#[^\\s]*)/g, '');\r\n    hashtags.forEach(tag => {\r\n      term += '+[' + tag + ']';\r\n    });\r\n\r\n    return term;\r\n  }\r\n\r\n  /**\r\n   * Add hashtag from settings in Nominatim's format (+[])\r\n   * @param term Query\r\n   */\r\n  private computeTermSettings(term: string): string {\r\n    this.options.settings.forEach(settings => {\r\n      if (settings.name === 'amenity') {\r\n        settings.values.forEach(conf => {\r\n          if (conf.enabled && typeof conf.value === 'string') {\r\n            const splitted = conf.value.split(',');\r\n            splitted.forEach(value => {\r\n              term += '+[' + value + ']';\r\n            });\r\n          }\r\n        });\r\n      }\r\n    });\r\n    return term;\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\n\r\nimport { ConfigService, StorageService } from '@igo2/core';\r\n\r\nimport { SearchSource } from './source';\r\nimport { NominatimSearchSource } from './nominatim';\r\n\r\n/**\r\n * Nominatim search source factory\r\n * @ignore\r\n */\r\nexport function nominatimSearchSourceFactory(\r\n  http: HttpClient,\r\n  config: ConfigService,\r\n  storageService: StorageService\r\n) {\r\n  return new NominatimSearchSource(\r\n    http,\r\n    config.getConfig(`searchSources.${NominatimSearchSource.id}`),\r\n    storageService\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the Nominatim search source\r\n */\r\nexport function provideNominatimSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: nominatimSearchSourceFactory,\r\n    multi: true,\r\n    deps: [HttpClient, ConfigService, StorageService]\r\n  };\r\n}\r\n","import { Injectable, Inject } from '@angular/core';\r\nimport { HttpClient, HttpParams } from '@angular/common/http';\r\n\r\nimport { Observable } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { ObjectUtils } from '@igo2/utils';\r\nimport { FEATURE, Feature } from '../../../feature';\r\n\r\nimport { SearchResult } from '../search.interfaces';\r\nimport { SearchSource, TextSearch, ReverseSearch } from './source';\r\nimport {\r\n  SearchSourceOptions,\r\n  TextSearchOptions,\r\n  ReverseSearchOptions\r\n} from './source.interfaces';\r\nimport {\r\n  StoredQueriesData,\r\n  StoredQueriesResponse,\r\n  StoredQueriesReverseData,\r\n  StoredQueriesReverseResponse,\r\n  StoredQueriesSearchSourceOptions,\r\n  StoredQueriesFields,\r\n  StoredQueriesReverseSearchSourceOptions\r\n} from './storedqueries.interfaces';\r\n\r\nimport * as olformat from 'ol/format';\r\nimport { LanguageService, StorageService } from '@igo2/core';\r\nimport { computeTermSimilarity } from '../search.utils';\r\nimport { Cacheable } from 'ts-cacheable';\r\n\r\n/**\r\n * StoredQueries search source\r\n */\r\n@Injectable()\r\nexport class StoredQueriesSearchSource extends SearchSource\r\n  implements TextSearch {\r\n  static id = 'storedqueries';\r\n  static type = FEATURE;\r\n  static propertiesBlacklist: string[] = [\r\n    'boundedBy',\r\n    'id',\r\n    'coord_x',\r\n    'coord_y'\r\n  ];\r\n  public resultTitle: 'title';\r\n  public storedQueriesOptions: StoredQueriesSearchSourceOptions;\r\n  public multipleFieldsQuery: boolean;\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private languageService: LanguageService,\r\n    storageService: StorageService,\r\n    @Inject('options') options: SearchSourceOptions\r\n  ) {\r\n    super(options, storageService);\r\n    this.storedQueriesOptions = options as StoredQueriesSearchSourceOptions;\r\n    if (this.storedQueriesOptions && !this.storedQueriesOptions.available) {\r\n      return;\r\n    }\r\n\r\n    const defaultStoredqueryId = 'rtss';\r\n    const defaultFieldSplitter: StoredQueriesFields[] = [\r\n      { name: 'rtss', defaultValue: '-99' },\r\n      { name: 'chainage', defaultValue: '0', splitPrefix: '\\\\+' }\r\n    ];\r\n    const defaultOutputformat = 'text/xml; subtype=gml/3.1.1';\r\n    const defaultSrsname = 'EPSG:4326';\r\n    const defaultResultTitle = 'title';\r\n\r\n    if (!this.storedQueriesOptions) {\r\n      console.log(\r\n        ' No configuration for this search source (storedqueries). You will use the default values'\r\n      );\r\n      this.storedQueriesOptions = {\r\n        storedquery_id: defaultStoredqueryId,\r\n        fields: defaultFieldSplitter,\r\n        outputformat: defaultOutputformat,\r\n        srsname: defaultSrsname,\r\n        resultTitle: defaultResultTitle\r\n      };\r\n      this.resultTitle = defaultResultTitle;\r\n      console.log('Default values', this.storedQueriesOptions);\r\n    }\r\n\r\n    if (!this.storedQueriesOptions.storedquery_id) {\r\n      const err =\r\n        'Stored Queries :You have to set \"storedquery_id\" into StoredQueries options. ex: storedquery_id: \"nameofstoredquerie\"';\r\n      throw new Error(err);\r\n    }\r\n    if (!this.storedQueriesOptions.fields) {\r\n      throw new Error(\r\n        'Stored Queries :You have to set \"fields\" into options. ex: fields: {\"name\": \"rtss\", \"defaultValue\": \"-99\"}'\r\n      );\r\n    }\r\n\r\n    this.storedQueriesOptions.outputformat =\r\n      this.storedQueriesOptions.outputformat || 'text/xml; subtype=gml/3.1.1';\r\n    this.storedQueriesOptions.srsname =\r\n      this.storedQueriesOptions.srsname || 'EPSG:4326';\r\n\r\n    const storedQueryId = this.storedQueriesOptions.storedquery_id.toLowerCase();\r\n    if (\r\n      storedQueryId.includes('getfeaturebyid') &&\r\n      this.storedQueriesOptions.outputformat\r\n        .toLowerCase()\r\n        .includes('getfeaturebyid')\r\n    ) {\r\n      let err =\r\n        'You must set a geojson format for your stored query. This is due to an openlayers issue)';\r\n      err += ' (wfs 1.1.0 & gml 3.1.1 limitation)';\r\n      throw new Error(err);\r\n    }\r\n\r\n    if (!(this.storedQueriesOptions.fields instanceof Array)) {\r\n      this.storedQueriesOptions.fields = [this.storedQueriesOptions.fields];\r\n    }\r\n\r\n    this.multipleFieldsQuery =\r\n      this.storedQueriesOptions.fields.length > 1 ? true : false;\r\n\r\n    this.storedQueriesOptions.fields.forEach((field, index) => {\r\n      if (this.multipleFieldsQuery && !field.splitPrefix && index !== 0) {\r\n        throw new Error(\r\n          'Stored Queries :You must set a field spliter into your field definition (optional for the first one!)'\r\n        );\r\n      }\r\n      if (!field.defaultValue) {\r\n        throw new Error(\r\n          'Stored Queries :You must set a field default value into your field definition'\r\n        );\r\n      }\r\n    });\r\n\r\n    this.storedQueriesOptions.resultTitle =\r\n      this.storedQueriesOptions.resultTitle || this.resultTitle;\r\n  }\r\n\r\n  getId(): string {\r\n    return StoredQueriesSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return StoredQueriesSearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    return {\r\n      title: 'Stored Queries',\r\n      searchUrl: 'https://ws.mapserver.transports.gouv.qc.ca/swtq'\r\n    };\r\n  }\r\n\r\n  // URL CALL EXAMPLES:\r\n  //  GetFeatureById (mandatory storedquery for wfs server) (outputformat must be in geojson)\r\n /* eslint-disable max-len */\r\n  //  https://ws.mapserver.transports.gouv.qc.ca/swtq?service=wfs&version=2.0.0&request=GetFeature&storedquery_id=urn:ogc:def:query:OGC-WFS::GetFeatureById&srsname=epsg:4326&outputformat=geojson&ID=a_num_route.132\r\n  //  Custom StoredQuery\r\n /* eslint-disable max-len */\r\n  //  https://ws.mapserver.transports.gouv.qc.ca/swtq?service=wfs&version=1.1.0&request=GetFeature&storedquery_id=rtss&srsname=epsg:4326&outputformat=text/xml;%20subtype=gml/3.1.1&rtss=0013801110000c&chainage=12\r\n\r\n  /**\r\n   * Search a location by name or keyword\r\n   * @param term Location name or keyword\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  search(\r\n    term: string,\r\n    options?: TextSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    const storedqueriesParams = this.termSplitter(\r\n      term,\r\n      this.storedQueriesOptions.fields\r\n    );\r\n    const params = this.computeRequestParams(\r\n      options || {},\r\n      storedqueriesParams\r\n    );\r\n    this.options.params = this.options.params ? this.options.params : {};\r\n    this.options.params.page = options.page ? String(options.page) : '1';\r\n\r\n    if (\r\n      new RegExp('.*?gml.*?', 'i').test(this.storedQueriesOptions.outputformat)\r\n    ) {\r\n      return this.http\r\n        .get(this.searchUrl, { params, responseType: 'text' })\r\n        .pipe(\r\n          map(response => {\r\n            let resultArray = this.extractResults(this.extractWFSData(response), term);\r\n            resultArray.sort((a, b) =>\r\n              (a.meta.score > b.meta.score) ? 1 :\r\n              (a.meta.score === b.meta.score) ? ((a.meta.titleHtml < b.meta.titleHtml) ? 1 : -1) : -1);\r\n            resultArray.reverse();\r\n            if (resultArray.length > Number(this.options.params.limit)) {\r\n              const idxEnd = Number(this.options.params.limit) * Number(this.options.params.page);\r\n              const resultTotLenght = resultArray.length;\r\n              resultArray = resultArray.slice(0, idxEnd);\r\n              if (idxEnd < resultTotLenght) {\r\n                resultArray[resultArray.length - 1 ].meta.nextPage = true;\r\n              } else {\r\n                resultArray[resultArray.length - 1 ].meta.nextPage = false;\r\n              }\r\n            }\r\n            return resultArray;\r\n          })\r\n        );\r\n    } else {\r\n      return this.http.get(this.searchUrl, { params }).pipe(\r\n        map(response => {\r\n          return this.extractResults(this.extractWFSData(response), term);\r\n        })\r\n      );\r\n    }\r\n  }\r\n\r\n  private getFormatFromOptions() {\r\n    let olFormatCls;\r\n\r\n    const outputFormat = this.storedQueriesOptions.outputformat;\r\n    const patternGml3 = new RegExp('.*?gml.*?', 'i');\r\n    const patternGeojson = new RegExp('.*?json.*?', 'i');\r\n\r\n    if (patternGeojson.test(outputFormat)) {\r\n      olFormatCls = olformat.GeoJSON;\r\n    }\r\n    if (patternGml3.test(outputFormat)) {\r\n      olFormatCls = olformat.WFS;\r\n    }\r\n\r\n    return new olFormatCls();\r\n  }\r\n\r\n  private extractWFSData(res) {\r\n    const olFormat = this.getFormatFromOptions();\r\n    const geojson = olformat.GeoJSON;\r\n    const wfsfeatures = olFormat.readFeatures(res);\r\n    const features = JSON.parse(new geojson().writeFeatures(wfsfeatures));\r\n    return features;\r\n  }\r\n\r\n  private termSplitter(term: string, fields: StoredQueriesFields[]): {} {\r\n    const splittedTerm = {};\r\n    let remainingTerm = term;\r\n    let cnt = 0;\r\n\r\n    // Used to build the default values\r\n    fields.forEach(field => {\r\n      splittedTerm[field.name] = field.defaultValue;\r\n      const splitterRegex = new RegExp(field.splitPrefix + '(.+)', 'i');\r\n      if (splitterRegex.test(remainingTerm)) {\r\n        cnt = field.splitPrefix ? (cnt += 1) : cnt;\r\n        remainingTerm = remainingTerm.split(splitterRegex)[1];\r\n      }\r\n    });\r\n    if (cnt === 0) {\r\n      splittedTerm[fields[0].name] = term;\r\n      return splittedTerm;\r\n    }\r\n    remainingTerm = term;\r\n    const localFields = [...fields].reverse();\r\n    localFields.forEach(field => {\r\n      const splitterRegex = new RegExp(field.splitPrefix || '' + '(.+)', 'i');\r\n      if (remainingTerm || remainingTerm !== '') {\r\n        const values = remainingTerm.split(splitterRegex);\r\n        remainingTerm = values[0];\r\n        if (values[1]) {\r\n          splittedTerm[field.name] = values[1].trim();\r\n        }\r\n      }\r\n    });\r\n    return splittedTerm;\r\n  }\r\n\r\n  private computeRequestParams(\r\n    options: TextSearchOptions,\r\n    queryParams\r\n  ): HttpParams {\r\n    const wfsversion = this.storedQueriesOptions.storedquery_id\r\n      .toLowerCase()\r\n      .includes('getfeaturebyid')\r\n      ? '2.0.0'\r\n      : '1.1.0';\r\n    return new HttpParams({\r\n      fromObject: Object.assign(\r\n        {\r\n          service: 'wfs',\r\n          version: wfsversion,\r\n          request: 'GetFeature',\r\n          storedquery_id: this.storedQueriesOptions.storedquery_id,\r\n          srsname: this.storedQueriesOptions.srsname,\r\n          outputformat: this.storedQueriesOptions.outputformat\r\n        },\r\n        queryParams,\r\n        this.params,\r\n        options.params || {}\r\n      )\r\n    });\r\n  }\r\n\r\n  private extractResults(\r\n    response: StoredQueriesResponse, term: string\r\n  ): SearchResult<Feature>[] {\r\n    return response.features.map((data: StoredQueriesData) => {\r\n      return this.dataToResult(data, term);\r\n    });\r\n  }\r\n\r\n  private dataToResult(data: StoredQueriesData, term: string): SearchResult<Feature> {\r\n    const properties = this.computeProperties(data);\r\n    const id = [this.getId(), properties.type, data.id].join('.');\r\n    const title = data.properties[this.storedQueriesOptions.resultTitle]\r\n      ? this.storedQueriesOptions.resultTitle\r\n      : this.resultTitle;\r\n    return {\r\n      source: this,\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry: data.geometry,\r\n        // extent: data.bbox,\r\n        properties,\r\n        meta: {\r\n          id,\r\n          title: data.properties[title]\r\n        }\r\n      },\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id,\r\n        title: data.properties.title,\r\n        titleHtml: data.properties[title],\r\n        icon: 'map-marker',\r\n        score: (data.properties.title) ?\r\n        computeTermSimilarity(term.trim(), data.properties.title) :\r\n        computeTermSimilarity(term.trim(), data.properties[title]),\r\n\r\n      }\r\n    };\r\n  }\r\n\r\n  private computeProperties(data: StoredQueriesData): { [key: string]: any } {\r\n    const properties = Object.assign(\r\n      {},\r\n      ObjectUtils.removeKeys(\r\n        data.properties,\r\n        StoredQueriesSearchSource.propertiesBlacklist\r\n      ),\r\n      { Route: '<span class=\"routing\"> <u>' + this.languageService.translate.instant('igo.geo.seeRouting') + '</u> </span>' }\r\n    );\r\n    return properties;\r\n  }\r\n}\r\n\r\n/**\r\n * StoredQueriesReverse search source\r\n */\r\n\r\n// EXAMPLE CALLS\r\n /* eslint-disable max-len */\r\n// https://ws.mapserver.transports.gouv.qc.ca/swtq?service=wfs&version=1.1.0&request=GetFeature&storedquery_id=lim_adm&srsname=epsg:4326&outputformat=text/xml;%20subtype=gml/3.1.1&long=-71.292469&lat=46.748107\r\n//\r\n\r\n@Injectable()\r\nexport class StoredQueriesReverseSearchSource extends SearchSource\r\n  implements ReverseSearch {\r\n  static id = 'storedqueriesreverse';\r\n  static type = FEATURE;\r\n  static propertiesBlacklist: string[] = [];\r\n  public resultTitle: 'title';\r\n  public storedQueriesOptions: StoredQueriesReverseSearchSourceOptions;\r\n  public multipleFieldsQuery: boolean;\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private languageService: LanguageService,\r\n    storageService: StorageService,\r\n    @Inject('options') options: SearchSourceOptions\r\n  ) {\r\n    super(options, storageService);\r\n    this.storedQueriesOptions = options as StoredQueriesReverseSearchSourceOptions;\r\n\r\n    if (!this.storedQueriesOptions || (this.storedQueriesOptions && !this.storedQueriesOptions.available) ) {\r\n      return;\r\n    }\r\n\r\n    if (!this.storedQueriesOptions.storedquery_id) {\r\n      const err =\r\n        'Stored Queries :You have to set \"storedquery_id\" into StoredQueries options. ex: storedquery_id: \"nameofstoredquerie\"';\r\n      throw new Error(err);\r\n    }\r\n    if (!this.storedQueriesOptions.longField) {\r\n      throw new Error(\r\n        'Stored Queries :You have to set \"longField\" to map the longitude coordinate to the query params.'\r\n      );\r\n    }\r\n    if (!this.storedQueriesOptions.latField) {\r\n      throw new Error(\r\n        'Stored Queries :You have to set \"latField\" to map the latitude coordinate to the query params.'\r\n      );\r\n    }\r\n\r\n    this.storedQueriesOptions.outputformat =\r\n      this.storedQueriesOptions.outputformat || 'text/xml; subtype=gml/3.1.1';\r\n    this.storedQueriesOptions.srsname =\r\n      this.storedQueriesOptions.srsname || 'EPSG:4326';\r\n    this.storedQueriesOptions.resultTitle =\r\n      this.storedQueriesOptions.resultTitle || this.resultTitle;\r\n  }\r\n\r\n  getId(): string {\r\n    return StoredQueriesReverseSearchSource.id;\r\n  }\r\n\r\n  getType(): string {\r\n    return StoredQueriesReverseSearchSource.type;\r\n  }\r\n\r\n  protected getDefaultOptions(): SearchSourceOptions {\r\n    return {\r\n      title: 'Stored Queries (reverse)',\r\n      searchUrl: 'https://ws.mapserver.transports.gouv.qc.ca/swtq'\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Search a location by coordinates\r\n   * @param lonLat Location coordinates\r\n   * @param distance Search raidus around lonLat\r\n   * @returns Observable of <SearchResult<Feature>[]\r\n   */\r\n  @Cacheable({\r\n    maxCacheCount: 20\r\n  })\r\n  reverseSearch(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions\r\n  ): Observable<SearchResult<Feature>[]> {\r\n    const params = this.computeRequestParams(lonLat, options || {});\r\n\r\n    if (\r\n      new RegExp('.*?gml.*?', 'i').test(this.storedQueriesOptions.outputformat)\r\n    ) {\r\n      return this.http\r\n        .get(this.searchUrl, { params, responseType: 'text' })\r\n        .pipe(\r\n          map(response => {\r\n            return this.extractResults(this.extractWFSData(response));\r\n          })\r\n        );\r\n    } else {\r\n      return this.http.get(this.searchUrl, { params }).pipe(\r\n        map(response => {\r\n          return this.extractResults(this.extractWFSData(response));\r\n        })\r\n      );\r\n    }\r\n  }\r\n\r\n  private getFormatFromOptions() {\r\n    let olFormatCls;\r\n\r\n    const outputFormat = this.storedQueriesOptions.outputformat;\r\n    const patternGml3 = new RegExp('.*?gml.*?', 'i');\r\n    const patternGeojson = new RegExp('.*?json.*?', 'i');\r\n\r\n    if (patternGeojson.test(outputFormat)) {\r\n      olFormatCls = olformat.GeoJSON;\r\n    }\r\n    if (patternGml3.test(outputFormat)) {\r\n      olFormatCls = olformat.WFS;\r\n    }\r\n\r\n    return new olFormatCls();\r\n  }\r\n\r\n  private extractWFSData(res) {\r\n    const olFormat = this.getFormatFromOptions();\r\n    const geojson = olformat.GeoJSON;\r\n    const wfsfeatures = olFormat.readFeatures(res);\r\n    const features = JSON.parse(new geojson().writeFeatures(wfsfeatures));\r\n    return features;\r\n  }\r\n\r\n  private computeRequestParams(\r\n    lonLat: [number, number],\r\n    options?: ReverseSearchOptions\r\n  ): HttpParams {\r\n    const longLatParams = {};\r\n    longLatParams[this.storedQueriesOptions.longField] = lonLat[0];\r\n    longLatParams[this.storedQueriesOptions.latField] = lonLat[1];\r\n\r\n    return new HttpParams({\r\n      fromObject: Object.assign(\r\n        {\r\n          service: 'WFS',\r\n          version: '1.1.0',\r\n          request: 'GetFeature',\r\n          storedquery_id: this.storedQueriesOptions.storedquery_id,\r\n          srsname: this.storedQueriesOptions.srsname,\r\n          outputformat: this.storedQueriesOptions.outputformat\r\n        },\r\n        longLatParams,\r\n        this.params,\r\n        options.params || {}\r\n      )\r\n    });\r\n  }\r\n\r\n  private extractResults(\r\n    response: StoredQueriesReverseResponse\r\n  ): SearchResult<Feature>[] {\r\n    return response.features.map((data: StoredQueriesReverseData) => {\r\n      return this.dataToResult(data);\r\n    });\r\n  }\r\n\r\n  private dataToResult(data: StoredQueriesReverseData): SearchResult<Feature> {\r\n    const properties = this.computeProperties(data);\r\n    const id = [this.getId(), properties.type, data.id].join('.');\r\n    const title = data.properties[this.storedQueriesOptions.resultTitle]\r\n      ? this.storedQueriesOptions.resultTitle\r\n      : this.resultTitle;\r\n\r\n    return {\r\n      source: this,\r\n      data: {\r\n        type: FEATURE,\r\n        projection: 'EPSG:4326',\r\n        geometry: data.geometry,\r\n        properties,\r\n        meta: {\r\n          id,\r\n          title: data.properties[title]\r\n        }\r\n      },\r\n      meta: {\r\n        dataType: FEATURE,\r\n        id,\r\n        title: data.properties[title],\r\n        icon: 'map-marker'\r\n      }\r\n    };\r\n  }\r\n\r\n  private computeProperties(\r\n    data: StoredQueriesReverseData\r\n  ): { [key: string]: any } {\r\n    const properties = ObjectUtils.removeKeys(\r\n      data.properties,\r\n      StoredQueriesReverseSearchSource.propertiesBlacklist\r\n    );\r\n    const routing = {\r\n      Route: '<span class=\"routing\"> <u>' + this.languageService.translate.instant('igo.geo.seeRouting') + '</u> </span>'\r\n    };\r\n    return Object.assign(properties, { type: data.properties.doc_type }, routing);\r\n  }\r\n}\r\n","import { HttpClient } from '@angular/common/http';\r\n\r\nimport { ConfigService, LanguageService, StorageService } from '@igo2/core';\r\n\r\nimport { SearchSource } from './source';\r\nimport {\r\n  StoredQueriesSearchSource,\r\n  StoredQueriesReverseSearchSource\r\n} from './storedqueries';\r\n\r\n/**\r\n * StoredQueries search source factory\r\n * @ignore\r\n */\r\nexport function storedqueriesSearchSourceFactory(\r\n  http: HttpClient,\r\n  languageService: LanguageService,\r\n  storageService: StorageService,\r\n  config: ConfigService\r\n) {\r\n  return new StoredQueriesSearchSource(\r\n    http,\r\n    languageService,\r\n    storageService,\r\n    config.getConfig(`searchSources.${StoredQueriesSearchSource.id}`)\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the StoredQueries search source\r\n */\r\nexport function provideStoredQueriesSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: storedqueriesSearchSourceFactory,\r\n    multi: true,\r\n    deps: [HttpClient, LanguageService, StorageService, ConfigService]\r\n  };\r\n}\r\n\r\n/**\r\n * StoredQueriesReverse search source factory\r\n * @ignore\r\n */\r\n\r\nexport function storedqueriesReverseSearchSourceFactory(\r\n  http: HttpClient,\r\n  languageService: LanguageService,\r\n  storageService: StorageService,\r\n  config: ConfigService\r\n) {\r\n  return new StoredQueriesReverseSearchSource(\r\n    http,\r\n    languageService,\r\n    storageService,\r\n    config.getConfig(`searchSources.${StoredQueriesReverseSearchSource.id}`)\r\n  );\r\n}\r\n\r\n/**\r\n * Function that returns a provider for the StoredQueriesReverse search source\r\n */\r\nexport function provideStoredQueriesReverseSearchSource() {\r\n  return {\r\n    provide: SearchSource,\r\n    useFactory: storedqueriesReverseSearchSourceFactory,\r\n    multi: true,\r\n    deps: [HttpClient, LanguageService, StorageService, ConfigService]\r\n  };\r\n}\r\n","import { WfsWorkspace } from './wfs-workspace';\r\nimport { FeatureWorkspace } from './feature-workspace';\r\nimport { EditionWorkspace } from './edition-workspace';\r\nimport { Observable } from 'rxjs';\r\nimport { EntityStoreFilterCustomFuncStrategy, EntityRecord } from '@igo2/common';\r\nimport { map } from 'rxjs/operators';\r\nimport { Feature } from '../../feature/shared/feature.interfaces';\r\nimport { StorageScope } from '@igo2/core';\r\n\r\n\r\nexport function getRowsInMapExtent(layerId, storageService): boolean {\r\n  return storageService.get(`workspace.rowsInMapExtent.${layerId}`) as boolean || true;\r\n}\r\n\r\nexport function setRowsInMapExtent(value, layerId, storageService) {\r\n  storageService.set(`workspace.rowsInMapExtent.${layerId}`, value, StorageScope.SESSION);\r\n}\r\n\r\nexport function getSelectedOnly(layerId, storageService): boolean {\r\n  return storageService.get(`workspace.selectedOnly.${layerId}`) as boolean || false;\r\n}\r\n\r\nexport function setSelectedOnly(value, layerId, storageService) {\r\n  storageService.set(`workspace.selectedOnly.${layerId}`, value, StorageScope.SESSION);\r\n}\r\n\r\nexport function mapExtentStrategyActiveToolTip(ws: WfsWorkspace | FeatureWorkspace | EditionWorkspace): Observable<string> {\r\n  return ws.entityStore.getStrategyOfType(EntityStoreFilterCustomFuncStrategy).active$.pipe(\r\n    map((active: boolean) => active ? 'igo.geo.workspace.inMapExtent.active.tooltip' : 'igo.geo.workspace.inMapExtent.inactive.tooltip')\r\n  );\r\n}\r\n\r\nexport function noElementSelected(ws: WfsWorkspace | FeatureWorkspace | EditionWorkspace): Observable<boolean> {\r\n  return ws.entityStore.stateView.manyBy$((record: EntityRecord<Feature>) => {\r\n    return record.state.selected === true;\r\n  }).pipe(\r\n    map((entities: EntityRecord<Feature>[]) => entities.length >= 1)\r\n  );\r\n}\r\n\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Simple Map</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/simple-map\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\"\r\n  igoPointerPosition\r\n  [pointerPositionDelay]=\"pointerCoordDelay\"\r\n  (pointerPositionCoord)=\"onPointerMove($event)\">\r\n    <igo-info-section [infoContent]=\"pointerCoord\"></igo-info-section>\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n    <igo-geolocate-button [map]=\"map\" color=\"primary\"></igo-geolocate-button>\r\n    <igo-home-extent-button [map]=\"map\" color=\"primary\"></igo-home-extent-button>\r\n    <igo-rotation-button [map]=\"map\" [showIfNoRotation]=\"true\" color=\"primary\"></igo-rotation-button>\r\n    <igo-wake-lock-button [map]=\"map\" color=\"primary\"></igo-wake-lock-button>\r\n  </igo-map-browser>\r\n\r\n</mat-card>\r\n\r\n<p *ngIf=\"!isTouchScreen\">{{pointerCoord}}</p>","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppSimpleMapComponent } from './simple-map.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'simple-map',\r\n    component: AppSimpleMapComponent\r\n  }\r\n];\r\n\r\nexport const AppSimpleMapRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService, MediaService } from '@igo2/core';\r\nimport { IgoMap, DataSourceService, LayerService } from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-simple-map',\r\n  templateUrl: './simple-map.component.html',\r\n  styleUrls: ['./simple-map.component.scss']\r\n})\r\nexport class AppSimpleMapComponent {\r\n  public pointerCoord;\r\n  public pointerCoordDelay: number = 0;\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      },\r\n      scaleLine: true\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 6,\r\n    rotation: 0.75\r\n  };\r\n\r\n  get media() {\r\n    return this.mediaService.getMedia();\r\n  }\r\n\r\n  get isTouchScreen() {\r\n    return this.mediaService.isTouchScreen();\r\n  }\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService,\r\n    private mediaService: MediaService\r\n  ) {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n  }\r\n\r\n  onPointerMove(event) {\r\n    this.pointerCoord = event;\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMapModule } from '@igo2/geo';\r\n\r\nimport { AppSimpleMapComponent } from './simple-map.component';\r\nimport { AppSimpleMapRoutingModule } from './simple-map-routing.module';\r\nimport { CommonModule } from '@angular/common';\r\n\r\n@NgModule({\r\n  declarations: [AppSimpleMapComponent],\r\n  imports: [\r\n    CommonModule,\r\n    AppSimpleMapRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoMapModule\r\n  ],\r\n  exports: [AppSimpleMapComponent]\r\n})\r\nexport class AppSimpleMapModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Simple Map</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/layer\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Layers\">\r\n    <igo-layer-list\r\n    [map]=\"map\"\r\n    [layers]=\"map.layers\"\r\n    [expandLegendOfVisibleLayers]=\"false\"\r\n    floatLabel=\"never\"\r\n    [queryBadge]=\"true\">\r\n\r\n      <ng-template #igoLayerItemToolbar let-layer=\"layer\">\r\n        <igo-metadata-button [layer]=\"layer\"></igo-metadata-button>\r\n        <igo-download-button [layer]=\"layer\"></igo-download-button>\r\n        <igo-ogc-filter-button [header]=\"true\" [layer]=\"layer\"></igo-ogc-filter-button>\r\n        <igo-time-filter-button [header]=\"true\" [layer]=\"layer\"></igo-time-filter-button>\r\n        <igo-track-feature-button [layer]=\"layer\" [trackFeature]=\"true\"></igo-track-feature-button>\r\n      </ng-template>\r\n\r\n    </igo-layer-list>\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppLayerComponent } from './layer.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'layer',\r\n    component: AppLayerComponent\r\n  }\r\n];\r\n\r\nexport const AppLayerRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  WMSDataSourceOptions,\r\n  LayerOptions,\r\n  WFSDataSourceOptions,\r\n  OgcFilterableDataSourceOptions,\r\n  MetadataLayerOptions\r\n} from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-layer',\r\n  templateUrl: './layer.component.html',\r\n  styleUrls: ['./layer.component.scss']\r\n})\r\nexport class AppLayerComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    maxLayerZoomExtent: [-11000000, 4500000, -4500000, 10000000],\r\n    zoom: 7\r\n  };\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService\r\n  ) {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            visible: true,\r\n            baseLayer: true,\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    interface WFSoptions\r\n      extends WFSDataSourceOptions,\r\n        OgcFilterableDataSourceOptions {}\r\n\r\n    const wfsDatasource: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'shp'\r\n      },\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        filters: {\r\n          operator: 'PropertyIsEqualTo',\r\n          propertyName: 'code_municipalite',\r\n          expression: '10043'\r\n        }\r\n      }\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(wfsDatasource)\r\n      .subscribe(dataSource => {\r\n        const layer: LayerOptions = {\r\n          title: 'WFS ',\r\n          visible: true,\r\n          source: dataSource\r\n        };\r\n        this.map.addLayer(this.layerService.createLayer(layer));\r\n      });\r\n\r\n    const wfsDatasourceCustomEPSG: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: 'geojson_utf8',\r\n        srsName: 'EPSG:32198',\r\n        outputFormatDownload: 'shp'\r\n      },\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        filters: {\r\n          operator: 'PropertyIsEqualTo',\r\n          propertyName: 'code_municipalite',\r\n          expression: '12072'\r\n        }\r\n      },\r\n      formatOptions: {\r\n        dataProjection: 'EPSG:32198'\r\n      }\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(wfsDatasourceCustomEPSG)\r\n      .subscribe(dataSource => {\r\n        const layer: LayerOptions = {\r\n          title: 'WFS (Custom EPSG)',\r\n          visible: true,\r\n          source: dataSource,\r\n          removable: false\r\n        };\r\n        this.map.addLayer(this.layerService.createLayer(layer));\r\n      });\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          optionsFromCapabilities: true,\r\n          params: {\r\n            LAYERS: 'parc_routier',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'Rseau routier',\r\n        visible: false,\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          params: {\r\n            LAYERS: 'bgr_v_sous_route_res_sup_act',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'lieu habit',\r\n        visible: false,\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          optionsFromCapabilities: true,\r\n          params: {\r\n            LAYERS: 'lieuhabite',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'sh_dis_eco',\r\n        visible: false,\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/mffpecofor.fcgi',\r\n          optionsFromCapabilities: true,\r\n          params: {\r\n            LAYERS: 'sh_dis_eco',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'nurc:Arc_Sample_Parent',\r\n        visible: false,\r\n        legendOptions: {\r\n          // collapsed: false,\r\n          display: true,\r\n          // url: 'https://v.seloger.com/s/width/1144/visuels/0/m/l/4/0ml42xbt1n3itaboek3qec5dtskdgw6nlscu7j69k.jpg',\r\n          stylesAvailable: [\r\n            { name: 'rain', title: 'Pluie' },\r\n            { name: 'raster', title: 'Dfaut' }\r\n          ] //\r\n        },\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://demo.geo-solutions.it/geoserver/ows',\r\n          optionsFromCapabilities: true,\r\n          params: {\r\n            LAYERS: 'nurc:Arc_Sample', // , test:Linea_costa\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'Avertissements routier',\r\n        visible: false,\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          params: {\r\n            LAYERS: 'evenements',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    const datasource: WMSDataSourceOptions = {\r\n      type: 'wms',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      refreshIntervalSec: 15,\r\n      params: {\r\n        LAYERS: 'vg_observation_v_inondation_embacle_wmst',\r\n        VERSION: '1.3.0'\r\n      }\r\n    };\r\n\r\n    interface LayerOptionsWithMetadata\r\n      extends LayerOptions,\r\n        MetadataLayerOptions {}\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasource)\r\n      .subscribe(dataSource => {\r\n        const layer: LayerOptionsWithMetadata = {\r\n          title: 'Embcle',\r\n          source: dataSource,\r\n          metadata: {\r\n            url:\r\n              'https://www.donneesquebec.ca/recherche/fr/dataset/historique-publique-d-embacles-repertories-au-msp',\r\n            extern: true\r\n          }\r\n        };\r\n        this.map.addLayer(this.layerService.createLayer(layer));\r\n      });\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoPanelModule } from '@igo2/common';\r\nimport {\r\n  IgoMapModule,\r\n  IgoLayerModule,\r\n  IgoFilterModule,\r\n  IgoMetadataModule,\r\n  IgoDownloadModule\r\n} from '@igo2/geo';\r\n\r\nimport { AppLayerComponent } from './layer.component';\r\nimport { AppLayerRoutingModule } from './layer-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppLayerComponent],\r\n  imports: [\r\n    AppLayerRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoLayerModule,\r\n    IgoFilterModule,\r\n    IgoMetadataModule,\r\n    IgoDownloadModule\r\n  ],\r\n  exports: [AppLayerComponent]\r\n})\r\nexport class AppLayerModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppLegendComponent } from './legend.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'legend',\r\n    component: AppLegendComponent\r\n  }\r\n];\r\n\r\nexport const AppLegendRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  WMSDataSourceOptions,\r\n  LayerOptions,\r\n  WFSDataSourceOptions,\r\n  OgcFilterableDataSourceOptions,\r\n  MetadataLayerOptions\r\n} from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-legend',\r\n  templateUrl: './legend.component.html',\r\n  styleUrls: ['./legend.component.scss']\r\n})\r\nexport class AppLegendComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 7\r\n  };\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService\r\n  ) {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            visible: true,\r\n            baseLayer: true,\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    interface WFSoptions\r\n      extends WFSDataSourceOptions,\r\n        OgcFilterableDataSourceOptions {}\r\n\r\n    const wfsDatasource: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'shp'\r\n      },\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        filters: {\r\n          operator: 'PropertyIsEqualTo',\r\n          propertyName: 'code_municipalite',\r\n          expression: '10043'\r\n        }\r\n      }\r\n    };\r\n\r\n    this.layerService\r\n    .createAsyncLayer({\r\n      title: 'legend with display:false',\r\n      visible: true,\r\n      legendOptions: {\r\n        display: false,\r\n        html: 'test html'\r\n      },\r\n      sourceOptions: {\r\n        type: 'wms',\r\n        url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/mffpecofor.fcgi',\r\n        optionsFromCapabilities: true,\r\n        params: {\r\n          LAYERS: 'sh_dis_eco',\r\n          VERSION: '1.3.0'\r\n        }\r\n      }\r\n    })\r\n    .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n    .createAsyncLayer({\r\n      title: 'legend in html',\r\n      visible: true,\r\n      legendOptions: {\r\n        display: true,\r\n        html: '<h2 style=\"background-color: blue;\">HTML lgende</h2>'\r\n      },\r\n      sourceOptions: {\r\n        type: 'wms',\r\n        url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/mffpecofor.fcgi',\r\n        optionsFromCapabilities: false,\r\n        params: {\r\n          LAYERS: 'sh_sreg_eco',\r\n          VERSION: '1.3.0'\r\n        }\r\n      }\r\n    })\r\n    .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n    .createAsyncLayer({\r\n      title: 'legend with url param',\r\n      visible: true,\r\n      legendOptions: {\r\n        url: `data:image/jpeg;base64,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`\r\n\r\n      },\r\n      sourceOptions: {\r\n        type: 'wms',\r\n        url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/mffpecofor.fcgi',\r\n        optionsFromCapabilities: true,\r\n        params: {\r\n          LAYERS: 'sh_reg_eco',\r\n          VERSION: '1.3.0'\r\n        }\r\n      }\r\n    })\r\n    .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(wfsDatasource)\r\n      .subscribe(dataSource => {\r\n        const layer: LayerOptions = {\r\n          title: 'WFS ',\r\n          visible: true,\r\n          source: dataSource\r\n        };\r\n        this.map.addLayer(this.layerService.createLayer(layer));\r\n      });\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n          optionsFromCapabilities: true,\r\n          params: {\r\n            LAYERS: 'MELS_CS_ANGLO_S',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'Rseau routier',\r\n        visible: false,\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          params: {\r\n            LAYERS: 'bgr_v_sous_route_res_sup_act',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'lieu habit',\r\n        visible: false,\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          optionsFromCapabilities: true,\r\n          params: {\r\n            LAYERS: 'lieuhabite',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: '2 styles nurc:Arc_Sample_Parent',\r\n        visible: true,\r\n        legendOptions: {\r\n          // collapsed: false,\r\n          display: true,\r\n          // url: 'https://v.seloger.com/s/width/1144/visuels/0/m/l/4/0ml42xbt1n3itaboek3qec5dtskdgw6nlscu7j69k.jpg',\r\n          stylesAvailable: [\r\n            { name: 'rain', title: 'Pluie' },\r\n            { name: 'raster', title: 'Dfaut' }\r\n          ] //\r\n        },\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://demo.geo-solutions.it/geoserver/ows',\r\n          optionsFromCapabilities: true,\r\n          params: {\r\n            LAYERS: 'nurc:Arc_Sample', // , test:Linea_costa\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'Avertissements routier',\r\n        visible: false,\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n          params: {\r\n            LAYERS: 'evenements',\r\n            VERSION: '1.3.0'\r\n          }\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    const datasource: WMSDataSourceOptions = {\r\n      type: 'wms',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      refreshIntervalSec: 15,\r\n      params: {\r\n        LAYERS: 'vg_observation_v_inondation_embacle_wmst',\r\n        VERSION: '1.3.0'\r\n      }\r\n    };\r\n\r\n    interface LayerOptionsWithMetadata\r\n      extends LayerOptions,\r\n        MetadataLayerOptions {}\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasource)\r\n      .subscribe(dataSource => {\r\n        const layer: LayerOptionsWithMetadata = {\r\n          title: 'Embcle',\r\n          visible: true,\r\n          source: dataSource,\r\n          metadata: {\r\n            url:\r\n              'https://www.donneesquebec.ca/recherche/fr/dataset/historique-publique-d-embacles-repertories-au-msp',\r\n            extern: true\r\n          }\r\n        };\r\n        this.map.addLayer(this.layerService.createLayer(layer));\r\n      });\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Simple Map with a legend list</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/layer\">code of this\r\n      example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Legends\">\r\n    <igo-layer-legend-list [layers]=\"map.layers\"\r\n    [excludeBaseLayers]=\"true\"\r\n    [allowShowAllLegends]=\"true\"\r\n    [updateLegendOnResolutionChange]=\"false\"\r\n    [showAllLegendsValue]=\"false\">\r\n  </igo-layer-legend-list>\r\n\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoPanelModule } from '@igo2/common';\r\nimport {\r\n  IgoMapModule,\r\n  IgoLayerModule,\r\n  IgoFilterModule,\r\n  IgoMetadataModule,\r\n  IgoDownloadModule\r\n} from '@igo2/geo';\r\n\r\nimport { AppLegendComponent } from './legend.component';\r\nimport { AppLegendRoutingModule } from './legend-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppLegendComponent],\r\n  imports: [\r\n    AppLegendRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoLayerModule,\r\n    IgoFilterModule,\r\n    IgoMetadataModule,\r\n    IgoDownloadModule\r\n  ],\r\n  exports: [AppLegendComponent]\r\n})\r\nexport class AppLegendModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppOverlayComponent } from './overlay.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'overlay',\r\n    component: AppOverlayComponent\r\n  }\r\n];\r\n\r\nexport const AppOverlayRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit, AfterViewInit } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  FEATURE,\r\n  Feature,\r\n  FeatureMotion\r\n} from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-overlay',\r\n  templateUrl: './overlay.component.html',\r\n  styleUrls: ['./overlay.component.scss']\r\n})\r\nexport class AppOverlayComponent implements OnInit, AfterViewInit {\r\n  public map = new IgoMap({\r\n    overlay: true,\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 6\r\n  };\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n  }\r\n\r\n  ngAfterViewInit() {\r\n    const feature1: Feature = {\r\n      type: FEATURE,\r\n      projection: 'EPSG:4326',\r\n      meta: {\r\n        id: 1\r\n      },\r\n      properties: {},\r\n      geometry: {\r\n        type: 'Point',\r\n        coordinates: [-73, 46.6]\r\n      }\r\n    };\r\n\r\n    const feature2: Feature = {\r\n      type: FEATURE,\r\n      projection: 'EPSG:4326',\r\n      meta: {\r\n        id: 2\r\n      },\r\n      properties: {},\r\n      geometry: {\r\n        type: 'LineString',\r\n        coordinates: [[-72, 47.8], [-73.5, 47.4], [-72.4, 48.6]]\r\n      }\r\n    };\r\n\r\n    const feature3: Feature = {\r\n      type: FEATURE,\r\n      projection: 'EPSG:4326',\r\n      meta: {\r\n        id: 3\r\n      },\r\n      properties: {},\r\n      geometry: {\r\n        type: 'Polygon',\r\n        coordinates: [[[-71, 46.8], [-73, 47], [-71.2, 46.6]]]\r\n      }\r\n    };\r\n\r\n    this.map.overlay.setFeatures(\r\n      [feature1, feature2, feature3],\r\n      FeatureMotion.None\r\n    );\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Overlay</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/overlay\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMapModule, IgoOverlayModule } from '@igo2/geo';\r\n\r\nimport { AppOverlayComponent } from './overlay.component';\r\nimport { AppOverlayRoutingModule } from './overlay-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppOverlayComponent],\r\n  imports: [\r\n    AppOverlayRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoMapModule,\r\n    IgoOverlayModule\r\n  ],\r\n  exports: [AppOverlayComponent]\r\n})\r\nexport class AppOverlayModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Geometry Form</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/common/form\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-form\r\n    *ngIf=\"form$ | async as form\"\r\n    [form]=\"form\"\r\n    [formData]=\"data$ | async\"\r\n    (submitForm)=\"onSubmit($event)\">\r\n\r\n    <igo-form-group [group]=\"form.groups[0]\"></igo-form-group>\r\n\r\n    <div formButtons>\r\n      <button\r\n        mat-stroked-button\r\n        type=\"button\"\r\n        color=\"primary\"\r\n        (click)=\"fillForm()\">\r\n        Fill Form\r\n      </button>\r\n      <button\r\n        mat-stroked-button\r\n        type=\"button\"\r\n        color=\"primary\"\r\n        (click)=\"clearForm()\">\r\n        Clear Form\r\n      </button>\r\n      <button\r\n        mat-flat-button\r\n        type=\"submit\"\r\n        color=\"primary\"\r\n        [disabled]=\"submitDisabled\">\r\n        Submit\r\n      </button>\r\n    </div>\r\n  </igo-form>\r\n</mat-card>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppGeometryComponent } from './geometry.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'geometry',\r\n    component: AppGeometryComponent\r\n  }\r\n];\r\n\r\nexport const AppGeometryRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit, OnDestroy } from '@angular/core';\r\nimport { Validators } from '@angular/forms';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport * as olstyle from 'ol/style';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { Form, FormService } from '@igo2/common';\r\nimport { IgoMap, DataSourceService, LayerService } from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-geometry',\r\n  templateUrl: './geometry.component.html',\r\n  styleUrls: ['./geometry.component.scss']\r\n})\r\nexport class AppGeometryComponent implements OnInit, OnDestroy {\r\n\r\n  map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      },\r\n      scaleLine: true\r\n    }\r\n  });\r\n\r\n  view = {\r\n    center: [-73, 47.2],\r\n    zoom: 15\r\n  };\r\n\r\n  form$ = new BehaviorSubject<Form>(undefined);\r\n\r\n  data$ = new BehaviorSubject<{[key: string]: any}>(undefined);\r\n\r\n  submitDisabled = true;\r\n\r\n  private valueChanges$$: Subscription;\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private formService: FormService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    const fieldConfigs = [\r\n      {\r\n        name: 'geometry',\r\n        title: 'Geometry',\r\n        options: {\r\n          validator: Validators.required\r\n        },\r\n        type: 'geometry',\r\n        inputs: {\r\n          map: this.map,\r\n          geometryTypeField: true,\r\n          geometryType: 'Polygon',\r\n          drawGuideField: true,\r\n          drawGuide: 50,\r\n          drawGuidePlaceholder: 'Draw Guide',\r\n          drawStyle: new olstyle.Style({\r\n            stroke: new olstyle.Stroke({\r\n              color: [255, 0, 0, 1],\r\n              width: 2\r\n            }),\r\n            fill:  new olstyle.Fill({\r\n              color: [255, 0, 0, 0.2]\r\n            }),\r\n            image: new olstyle.Circle({\r\n              radius: 8,\r\n              stroke: new olstyle.Stroke({\r\n                color: [255, 0, 0, 1]\r\n              }),\r\n              fill: new olstyle.Fill({\r\n                color: [255, 0, 0, 0.2]\r\n              })\r\n            })\r\n          })\r\n        }\r\n      },\r\n      {\r\n        name: 'name',\r\n        title: 'Name',\r\n        options: {\r\n          validator: Validators.required\r\n        }\r\n      }\r\n    ];\r\n\r\n    const fields = fieldConfigs.map((config) => this.formService.field(config));\r\n    const form = this.formService.form([], [this.formService.group({name: 'info'}, fields)]);\r\n\r\n    this.valueChanges$$ = form.control.valueChanges.subscribe(() => {\r\n      this.submitDisabled = !form.control.valid;\r\n    });\r\n\r\n    this.form$.next(form);\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.valueChanges$$.unsubscribe();\r\n  }\r\n\r\n  fillForm() {\r\n    this.data$.next({\r\n      name: 'Place',\r\n      geometry: JSON.stringify({type: 'Polygon', coordinates: [[\r\n        [-106, 42],\r\n        [-107, 31],\r\n        [-81, 32],\r\n        [-82, 42],\r\n        [-106, 42]\r\n      ]]})\r\n    });\r\n  }\r\n\r\n  clearForm() {\r\n    this.form$.value.control.reset();\r\n  }\r\n\r\n  onSubmit(data: {[key: string]: any}) {\r\n    alert(JSON.stringify(data));\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoFormModule } from '@igo2/common';\r\nimport { IgoGeometryModule, IgoMapModule } from '@igo2/geo';\r\n\r\nimport { AppGeometryComponent } from './geometry.component';\r\nimport { AppGeometryRoutingModule } from './geometry-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppGeometryComponent],\r\n  imports: [\r\n    CommonModule,\r\n    AppGeometryRoutingModule,\r\n    MatButtonModule,\r\n    MatCardModule,\r\n    IgoFormModule,\r\n    IgoGeometryModule,\r\n    IgoMapModule\r\n  ],\r\n  exports: [AppGeometryComponent]\r\n})\r\nexport class AppGeometryModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppFeatureComponent } from './feature.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'feature',\r\n    component: AppFeatureComponent\r\n  }\r\n];\r\n\r\nexport const AppFeatureRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit, OnDestroy } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  VectorLayer,\r\n  FeatureStore,\r\n  FeatureStoreLoadingStrategy,\r\n  FeatureStoreSelectionStrategy,\r\n  FeatureMotion\r\n} from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-feature',\r\n  templateUrl: './feature.component.html',\r\n  styleUrls: ['./feature.component.scss']\r\n})\r\nexport class AppFeatureComponent implements OnInit, OnDestroy {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 6\r\n  };\r\n\r\n  public tableTemplate = {\r\n    selection: true,\r\n    selectMany: true,\r\n    sort: true,\r\n    columns: [\r\n      {\r\n        name: 'properties.id',\r\n        title: 'ID'\r\n      },\r\n      {\r\n        name: 'properties.name',\r\n        title: 'Name'\r\n      },\r\n      {\r\n        name: 'properties.description',\r\n        title: 'Description'\r\n      }\r\n    ]\r\n  };\r\n\r\n  public store = new FeatureStore([], { map: this.map });\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    const loadingStrategy = new FeatureStoreLoadingStrategy({});\r\n    this.store.addStrategy(loadingStrategy);\r\n\r\n    const selectionStrategy = new FeatureStoreSelectionStrategy({\r\n      map: this.map,\r\n      motion: FeatureMotion.Default\r\n    });\r\n    this.store.addStrategy(selectionStrategy);\r\n\r\n    this.store.load([\r\n      {\r\n        meta: { id: 1 },\r\n        type: 'Feature',\r\n        geometry: {\r\n          type: 'Point',\r\n          coordinates: [-72, 47.8]\r\n        },\r\n        projection: 'EPSG:4326',\r\n        properties: {\r\n          id: 1,\r\n          name: 'Name 1',\r\n          description: 'Description 1'\r\n        }\r\n      },\r\n      {\r\n        meta: { id: 4 },\r\n        type: 'Feature',\r\n        geometry: {\r\n          type: 'Point',\r\n          coordinates: [-71, 46.8]\r\n        },\r\n        projection: 'EPSG:4326',\r\n        properties: {\r\n          id: 4,\r\n          name: 'Name 4',\r\n          description: 'Description 4'\r\n        }\r\n      },{\r\n        meta: { id: 5 },\r\n        type: 'Feature',\r\n        geometry: {\r\n          type: 'Point',\r\n          coordinates: [-73, 45.8]\r\n        },\r\n        projection: 'EPSG:4326',\r\n        properties: {\r\n          id: 5,\r\n          name: 'Name 5',\r\n          description: 'Description 5'\r\n        }\r\n      },\r\n      {\r\n        meta: { id: 2 },\r\n        type: 'Feature',\r\n        geometry: {\r\n          type: 'LineString',\r\n          coordinates: [[-72, 47.8], [-73.5, 47.4], [-72.4, 48.6]]\r\n        },\r\n        projection: 'EPSG:4326',\r\n        properties: {\r\n          id: 2,\r\n          name: 'Name 2',\r\n          description: 'Description 2'\r\n        }\r\n      },\r\n      {\r\n        meta: { id: 3 },\r\n        type: 'Feature',\r\n        geometry: {\r\n          type: 'Polygon',\r\n          coordinates: [[[-71, 46.8], [-73, 47], [-71.2, 46.6]]]\r\n        },\r\n        projection: 'EPSG:4326',\r\n        properties: {\r\n          id: 3,\r\n          name: 'Name 3',\r\n          description: 'Description 3'\r\n        }\r\n      }\r\n    ]);\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'MVT test',\r\n        visible: true,\r\n        sourceOptions: {\r\n          type: 'mvt',\r\n          url:\r\n            'https://ahocevar.com/geoserver/gwc/service/tms/1.0.0/ne:ne_10m_admin_0_countries@EPSG:900913@pbf/{z}/{x}/{-y}.pbf',\r\n          queryable: true\r\n        },\r\n        mapboxStyle: {\r\n          url: 'assets/mapboxStyleExample-vectortile.json',\r\n          source: 'ahocevar'\r\n        }\r\n      } as any)\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'vector'\r\n      })\r\n      .subscribe(dataSource => {\r\n        const layer = this.layerService.createLayer({\r\n          title: 'Vector Layer',\r\n          source: dataSource,\r\n          animation: {\r\n            duration: 2000\r\n          },\r\n          mapboxStyle: {\r\n            url: 'assets/mapboxStyleExample-feature.json',\r\n            source: 'source_nameX'\r\n          }\r\n        }) as VectorLayer;\r\n        this.map.addLayer(layer);\r\n        this.store.bindLayer(layer);\r\n        loadingStrategy.activate();\r\n        selectionStrategy.activate();\r\n      });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.store.destroy();\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Feature</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geom/feature\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-entity-table\r\n    [store]=\"store\"\r\n    [template]=\"tableTemplate\">\r\n  </igo-entity-table>\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoPanelModule, IgoEntityTableModule } from '@igo2/common';\r\nimport { IgoMapModule, IgoFeatureModule } from '@igo2/geo';\r\n\r\nimport { AppFeatureComponent } from './feature.component';\r\nimport { AppFeatureRoutingModule } from './feature-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppFeatureComponent],\r\n  imports: [\r\n    AppFeatureRoutingModule,\r\n    CommonModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoPanelModule,\r\n    IgoEntityTableModule,\r\n    IgoMapModule,\r\n    IgoFeatureModule\r\n  ],\r\n  exports: [AppFeatureComponent]\r\n})\r\nexport class AppFeatureModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\nimport { AppHoverComponent } from './hover.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'hover',\r\n    component: AppHoverComponent\r\n  }\r\n];\r\n\r\nexport const AppHoverRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService, MediaService } from '@igo2/core';\r\nimport { IgoMap, DataSourceService, LayerService, WFSDataSourceOptions, VectorLayerOptions, WFSDataSource } from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-hover',\r\n  templateUrl: './hover.component.html',\r\n  styleUrls: ['./hover.component.scss']\r\n})\r\nexport class AppHoverComponent {\r\n  public selected;\r\n  public pointerCoord;\r\n  public pointerCoordDelay: number = 0;\r\n  public pointerHoverFeatureDelay: number = 0;\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      },\r\n      scaleLine: true\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 8,\r\n    projection: 'EPSG:3857'\r\n  };\r\n\r\n\r\n  get media() {\r\n    return this.mediaService.getMedia();\r\n  }\r\n\r\n  get isTouchScreen() {\r\n    return this.mediaService.isTouchScreen();\r\n  }\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService,\r\n    private mediaService: MediaService\r\n  ) {\r\n\r\n    this.dataSourceService\r\n    .createAsyncDataSource({\r\n      type: 'wmts',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/carto/wmts/1.0.0/wmts',\r\n      layer: 'carte_gouv_qc_public',\r\n      matrixSet: 'EPSG_3857',\r\n      version: '1.3.0'\r\n    })\r\n    .subscribe(dataSource => {\r\n      this.map.addLayer(\r\n        this.layerService.createLayer({\r\n          title: 'Quebec',\r\n          visible: true,\r\n          baseLayer: true,\r\n          source: dataSource\r\n        })\r\n      );\r\n    });\r\n\r\n    interface WFSDataOptions\r\n      extends WFSDataSourceOptions {}\r\n\r\n    const wfsDatasourcePolygon: WFSDataOptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'adn_bassin_n1_public_v',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '3.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'shp'\r\n      }\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(wfsDatasourcePolygon)\r\n      .subscribe((dataSource: WFSDataSource) => {\r\n        const layer: VectorLayerOptions = {\r\n          title: 'WFS (polygon)',\r\n          visible: true,\r\n          source: dataSource\r\n        };\r\n        this.map.addLayer(this.layerService.createLayer(layer));\r\n      });\r\n\r\n    const wfsDatasourcePoint: WFSDataOptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'CASERNE',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'shp'\r\n      }\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(wfsDatasourcePoint)\r\n      .subscribe((dataSource: WFSDataSource) => {\r\n        const layer: VectorLayerOptions = {\r\n          title: 'WFS (point)',\r\n          visible: true,\r\n          source: dataSource,\r\n          styleByAttribute: {\r\n            attribute: 'en_caserne',\r\n            data: ['true', 'false'],\r\n            stroke: ['red', 'blue'],\r\n            fill: ['#ffffff', '#ffffff'],\r\n            radius: [7, 7],\r\n            width: [2, 2]\r\n          },\r\n          hoverStyle: {\r\n            label: {\r\n              attribute: 'Caserne: ${nom_service_incendie}\\n Mun: ${ville}',\r\n              style: {\r\n                textAlign: 'left',\r\n                textBaseline: 'top',\r\n                font: '12px Calibri,sans-serif',\r\n                fill: { color: '#000' },\r\n                backgroundFill: { color: 'rgba(255, 255, 255, 0.5)' },\r\n                backgroundStroke: { color: 'rgba(200, 200, 200, 0.75)', width: 2 },\r\n                stroke: { color: '#fff', width: 3 },\r\n                overflow: true,\r\n                offsetX: 20,\r\n                offsetY: 10,\r\n                padding: [2.5, 2.5, 2.5, 2.5]\r\n              }\r\n            },\r\n            baseStyle: {\r\n              circle: {\r\n                stroke: {\r\n                  color: 'orange',\r\n                  width: 5\r\n                },\r\n                width: [5],\r\n                radius: 15\r\n              }\r\n            }\r\n          }\r\n        };\r\n        this.map.addLayer(this.layerService.createLayer(layer));\r\n      });\r\n\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Hover</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/hover\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\"\r\n  igoHoverFeature\r\n  [igoHoverFeatureDelay]=\"pointerHoverFeatureDelay\"\r\n  [igoHoverFeatureEnabled]=\"true\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n    <igo-geolocate-button [map]=\"map\" color=\"primary\"></igo-geolocate-button>\r\n    <igo-home-extent-button [map]=\"map\" color=\"primary\"></igo-home-extent-button>\r\n    <igo-rotation-button [map]=\"map\" [showIfNoRotation]=\"true\" color=\"primary\"></igo-rotation-button>\r\n  </igo-map-browser>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMapModule } from '@igo2/geo';\r\n\r\nimport { AppHoverComponent } from './hover.component';\r\nimport { AppHoverRoutingModule } from './hover-routing.module';\r\nimport { CommonModule } from '@angular/common';\r\n\r\n@NgModule({\r\n  declarations: [AppHoverComponent],\r\n  imports: [\r\n    CommonModule,\r\n    AppHoverRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoMapModule\r\n  ],\r\n  exports: [AppHoverComponent]\r\n})\r\nexport class AppHoverModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppMeasureComponent } from './measure.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'measure',\r\n    component: AppMeasureComponent\r\n  }\r\n];\r\n\r\nexport const AppMeasureRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  FeatureStore,\r\n  FeatureWithMeasure\r\n} from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-measure',\r\n  templateUrl: './measure.component.html',\r\n  styleUrls: ['./measure.component.scss']\r\n})\r\nexport class AppMeasureComponent {\r\n\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      },\r\n      scaleLine: true\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 6,\r\n    projection: 'EPSG:3857'\r\n  };\r\n\r\n  public store = new FeatureStore<FeatureWithMeasure>([], {map: this.map});\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService\r\n  ) {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Simple Map</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/measure\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-measurer [store]=\"store\" [map]=\"map\"></igo-measurer>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMapModule, IgoMeasureModule } from '@igo2/geo';\r\n\r\nimport { AppMeasureComponent } from './measure.component';\r\nimport { AppMeasureRoutingModule } from './measure-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppMeasureComponent],\r\n  imports: [\r\n    AppMeasureRoutingModule,\r\n    MatCardModule,\r\n    IgoMapModule,\r\n    IgoMeasureModule\r\n  ],\r\n  exports: [AppMeasureComponent]\r\n})\r\nexport class AppMeasureModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\nimport { AppDrawComponent } from './draw.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'draw',\r\n    component: AppDrawComponent\r\n  }\r\n];\r\n\r\nexport const AppDrawRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  FeatureStore,\r\n  FeatureWithDraw,\r\n  MapService\r\n} from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-draw',\r\n  templateUrl: './draw.component.html',\r\n  styleUrls: ['./draw.component.scss']\r\n})\r\nexport class AppDrawComponent {\r\n\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      },\r\n      scaleLine: true\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 6,\r\n    projection: 'EPSG:3857'\r\n  };\r\n\r\n  public store = new FeatureStore<FeatureWithDraw>([], {map: this.map});\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService,\r\n    private mapService: MapService\r\n  ) {\r\n    this.mapService.setMap(this.map);\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Simple Map</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/draw\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-draw [store]=\"store\" [map]=\"map\"></igo-draw>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMapModule, IgoDrawModule } from '@igo2/geo';\r\n\r\nimport { AppDrawComponent } from './draw.component';\r\nimport { AppDrawRoutingModule } from './draw-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppDrawComponent],\r\n  imports: [\r\n    AppDrawRoutingModule,\r\n    MatCardModule,\r\n    IgoMapModule,\r\n    IgoDrawModule\r\n  ],\r\n  exports: [AppDrawComponent]\r\n})\r\nexport class AppDrawModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Query</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/query\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser\r\n    [map]=\"map\"\r\n    [view]=\"view\"\r\n    igoOverlay\r\n    igoQuery\r\n    [queryFeatures]=\"true\"\r\n    (query)=\"handleQueryResults($event)\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Details\">\r\n    <ng-container *ngIf=\"feature$ | async as feature\">\r\n      <h1>Query Title : <span style=\"background-color: #e0e0e0;\">{{getTitle(feature)}}</span></h1>\r\n      <igo-feature-details [feature]=\"feature\"></igo-feature-details>\r\n    </ng-container>\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppQueryComponent } from './query.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'query',\r\n    component: AppQueryComponent\r\n  }\r\n];\r\n\r\nexport const AppQueryRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\n\r\nimport olFeature from 'ol/Feature';\r\nimport olPoint from 'ol/geom/Point';\r\nimport olPolygon from 'ol/geom/Polygon';\r\nimport olLineString from 'ol/geom/LineString';\r\nimport * as olproj from 'ol/proj';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  FeatureDataSource,\r\n  DataSourceService,\r\n  LayerService,\r\n  OverlayService,\r\n  Feature,\r\n  QueryableDataSourceOptions,\r\n  QueryFormat,\r\n  QueryHtmlTarget,\r\n  SearchResult,\r\n  FeatureMotion\r\n} from '@igo2/geo';\r\n\r\nimport { getEntityTitle } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'app-query',\r\n  templateUrl: './query.component.html',\r\n  styleUrls: ['./query.component.scss']\r\n})\r\nexport class AppQueryComponent {\r\n  public feature$ = new BehaviorSubject<Feature>(undefined);\r\n\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 6\r\n  };\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService,\r\n    private overlayService: OverlayService\r\n  ) {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'wms',\r\n        url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n        queryable: true,\r\n        queryTitle: 'num_rts',\r\n        params: {\r\n          layers: 'bgr_v_sous_route_res_sup_act',\r\n          version: '1.3.0'\r\n        }\r\n      } as QueryableDataSourceOptions)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'WMS',\r\n            source: dataSource,\r\n            sourceOptions: dataSource.options\r\n          })\r\n        );\r\n      });\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'wms',\r\n        url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n        queryable: true,\r\n        queryFormat: QueryFormat.HTMLGML2,\r\n        queryHtmlTarget: QueryHtmlTarget.IFRAME,\r\n        params: {\r\n          layers: 'bgr_v_sous_route_res_sup_act',\r\n          version: '1.3.0'\r\n        }\r\n      } as QueryableDataSourceOptions)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'WMS html with a pre call in GML',\r\n            source: dataSource,\r\n            sourceOptions: dataSource.options\r\n          })\r\n        );\r\n      });\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'vector',\r\n        queryable: true,\r\n        queryTitle: 'So beautiful ${name}',\r\n        sourceFields: [\r\n          { name: 'name', alias: 'Alias name' },\r\n          { name: 'description', alias: 'Alias description' }\r\n        ]\r\n      } as QueryableDataSourceOptions)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Vector Layer',\r\n            source: dataSource,\r\n            sourceOptions: dataSource.options\r\n          })\r\n        );\r\n        this.addFeatures(dataSource as FeatureDataSource);\r\n      });\r\n  }\r\n\r\n  addFeatures(dataSource: FeatureDataSource) {\r\n    const feature1 = new olFeature({\r\n      name: 'feature1',\r\n      geometry: new olLineString([\r\n        olproj.transform([-72, 47.8], 'EPSG:4326', 'EPSG:3857'),\r\n        olproj.transform([-73.5, 47.4], 'EPSG:4326', 'EPSG:3857'),\r\n        olproj.transform([-72.4, 48.6], 'EPSG:4326', 'EPSG:3857')\r\n      ]),\r\n    });\r\n\r\n    const feature2 = new olFeature({\r\n      name: 'feature2',\r\n      geometry: new olPoint(\r\n        olproj.transform([-73, 46.6], 'EPSG:4326', 'EPSG:3857')\r\n      ),\r\n    });\r\n\r\n    const feature3 = new olFeature({\r\n      name: 'feature3',\r\n      geometry: new olPolygon([\r\n        [\r\n          olproj.transform([-71, 46.8], 'EPSG:4326', 'EPSG:3857'),\r\n          olproj.transform([-73, 47], 'EPSG:4326', 'EPSG:3857'),\r\n          olproj.transform([-71.2, 46.6], 'EPSG:4326', 'EPSG:3857')\r\n        ]\r\n      ]),\r\n    });\r\n\r\n    dataSource.ol.addFeatures([feature1, feature2, feature3]);\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'Vector tile with custom getfeatureinfo url',\r\n        visible: true,\r\n        sourceOptions: {\r\n          type: 'mvt',\r\n          url:\r\n            'https://ahocevar.com/geoserver/gwc/service/tms/1.0.0/ne:ne_10m_admin_0_countries@EPSG:900913@pbf/{z}/{x}/{-y}.pbf',\r\n          queryable: true,\r\n          queryUrl: 'https://geoegl.msp.gouv.qc.ca/apis/wss/amenagement.fcgi?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetFeatureInfo&FORMAT=image%2Fpng&TRANSPARENT=true&QUERY_LAYERS=SDA_REGION_S_20K&LAYERS=SDA_REGION_S_20K&DPI=96&MAP_RESOLUTION=96&FORMAT_OPTIONS=dpi%3A96&INFO_FORMAT=geojson&FEATURE_COUNT=5&I=50&J=50&CRS=EPSG:{srid}&STYLES=&WIDTH=101&HEIGHT=101&BBOX={xmin},{ymin},{xmax},{ymax}',\r\n          queryLayerFeatures: false,\r\n          queryFormat: 'geojson'\r\n        },\r\n        mapboxStyle: {\r\n          url: 'assets/mapboxStyleExample-vectortile.json',\r\n          source: 'ahocevar'\r\n        }\r\n      } as any)\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n\r\n      this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'wms',\r\n        url: 'https://geoegl.msp.gouv.qc.ca/apis/wss/incendie.fcgi',\r\n        queryable: true,\r\n        queryUrl: 'https://geoegl.msp.gouv.qc.ca/apis/wss/amenagement.fcgi?SERVICE=WMS&VERSION=1.3.0&REQUEST=GetFeatureInfo&FORMAT=image%2Fpng&TRANSPARENT=true&QUERY_LAYERS=SDA_MUNIC_S_20K&LAYERS=SDA_MUNIC_S_20K&DPI=96&MAP_RESOLUTION=96&FORMAT_OPTIONS=dpi%3A96&INFO_FORMAT=geojson&FEATURE_COUNT=5&I=50&J=50&CRS=EPSG:{srid}&STYLES=&WIDTH=101&HEIGHT=101&BBOX={xmin},{ymin},{xmax},{ymax}',\r\n        queryFormat: 'geojson',\r\n        params: {\r\n          layers: 'caserne',\r\n          version: '1.3.0'\r\n        }\r\n      } as QueryableDataSourceOptions)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'WMS with custom getfeatureinfo url',\r\n            source: dataSource,\r\n            sourceOptions: dataSource.options\r\n          })\r\n        );\r\n      });\r\n\r\n  }\r\n\r\n  handleQueryResults(results) {\r\n    const features: Feature[] = results.features;\r\n    let feature: Feature;\r\n    if (features.length && features[0]) {\r\n      feature = features[0];\r\n      this.feature$.next(feature);\r\n      this.map.queryResultsOverlay.setFeatures([feature], FeatureMotion.None);\r\n    }\r\n\r\n  }\r\n\r\n  getTitle(result: SearchResult) {\r\n    return getEntityTitle(result);\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoPanelModule } from '@igo2/common';\r\nimport {\r\n  IgoMapModule,\r\n  IgoOverlayModule,\r\n  IgoQueryModule,\r\n  IgoFeatureModule\r\n} from '@igo2/geo';\r\n\r\nimport { AppQueryComponent } from './query.component';\r\nimport { AppQueryRoutingModule } from './query-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppQueryComponent],\r\n  imports: [\r\n    AppQueryRoutingModule,\r\n    CommonModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoOverlayModule,\r\n    IgoQueryModule,\r\n    IgoFeatureModule\r\n  ],\r\n  exports: [AppQueryComponent]\r\n})\r\nexport class AppQueryModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppCatalogComponent } from './catalog.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'catalog',\r\n    component: AppCatalogComponent\r\n  }\r\n];\r\n\r\nexport const AppCatalogRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit } from '@angular/core';\r\n\r\nimport { LanguageService, ConfigService, StorageService } from '@igo2/core';\r\nimport { IgoMap, LayerService, Catalog, CatalogItem, CatalogService } from '@igo2/geo';\r\nimport { EntityStore } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'app-catalog',\r\n  templateUrl: './catalog.component.html',\r\n  styleUrls: ['./catalog.component.scss']\r\n})\r\nexport class AppCatalogComponent implements OnInit {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 7\r\n  };\r\n\r\n  public catalogStore = new EntityStore<Catalog>([]);\r\n\r\n  public catalogItemStore = new EntityStore<CatalogItem>([]);\r\n\r\n  constructor(\r\n    private configService: ConfigService,\r\n    private languageService: LanguageService,\r\n    private layerService: LayerService,\r\n    private catalogService: CatalogService,\r\n    private storageService: StorageService\r\n  ) {}\r\n\r\n  /**\r\n   * @internal\r\n   */\r\n  ngOnInit() {\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'OSM',\r\n        sourceOptions: {\r\n          type: 'osm'\r\n        }\r\n      })\r\n      .subscribe(layer => this.map.addLayer(layer));\r\n\r\n    this.loadCatalogs();\r\n  }\r\n\r\n  /**\r\n   * When the selected catalog changes, toggle the the CatalogBrowser tool.\r\n   * @internal\r\n   * @param event Select event\r\n   */\r\n  onCatalogSelectChange(event: {selected: boolean; catalog: Catalog}) {\r\n    this.loadCatalogItems(event.catalog);\r\n  }\r\n\r\n  /**\r\n   * Get all the available catalogs from the CatalogService and\r\n   * load them into the store.\r\n   */\r\n  private loadCatalogs() {\r\n    this.catalogService.loadCatalogs()\r\n      .subscribe((catalogs: Catalog[]) => {\r\n        this.catalogStore.clear();\r\n        this.catalogStore.load(catalogs.concat((this.storageService.get('addedCatalogs') || []) as Catalog[]));\r\n      });\r\n  }\r\n\r\n  /**\r\n   * Get the selected catalog's items from the CatalogService and\r\n   * load them into the store.\r\n   * @param catalog Selected catalog\r\n   */\r\n  private loadCatalogItems(catalog: Catalog) {\r\n    this.catalogService.loadCatalogItems(catalog)\r\n      .subscribe((items: CatalogItem[]) => {\r\n        this.catalogItemStore.clear();\r\n        this.catalogItemStore.load(items);\r\n      });\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Catalog</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: ConfigService, LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/catalog\">code of this example</a><br>\r\n    See catalog section of the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/environments\"> environment config</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Catalog Library\">\r\n    <igo-catalog-library\r\n      [store]=\"catalogStore\"\r\n      (catalogSelectChange)=\"onCatalogSelectChange($event)\">\r\n    </igo-catalog-library>\r\n  </igo-panel>\r\n\r\n  <igo-panel title=\"Catalog Browser\">\r\n    <igo-catalog-browser\r\n      [store]=\"catalogItemStore\"\r\n      [map]=\"map\">\r\n    </igo-catalog-browser>\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoConfigModule, provideConfigOptions } from '@igo2/core';\r\nimport { IgoPanelModule } from '@igo2/common';\r\nimport { IgoMapModule, IgoCatalogModule } from '@igo2/geo';\r\n\r\nimport { environment } from '../../../environments/environment';\r\nimport { AppCatalogComponent } from './catalog.component';\r\nimport { AppCatalogRoutingModule } from './catalog-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppCatalogComponent],\r\n  imports: [\r\n    CommonModule,\r\n    AppCatalogRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    MatTooltipModule,\r\n    IgoConfigModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoCatalogModule\r\n  ],\r\n  exports: [AppCatalogComponent],\r\n  providers: [\r\n    provideConfigOptions({\r\n      default: environment.igo\r\n    })\r\n  ]\r\n})\r\nexport class AppCatalogModule {}\r\n","export class ExportError extends Error {}\r\n\r\nexport class ExportInvalidFileError extends ExportError {\r\n  constructor() {\r\n    super('Invalid context');\r\n    Object.setPrototypeOf(this, ExportInvalidFileError.prototype);\r\n  }\r\n}\r\n\r\nexport class ExportNothingToExportError extends ExportError {\r\n  constructor() {\r\n    super('Nothing to export');\r\n    Object.setPrototypeOf(this, ExportNothingToExportError.prototype);\r\n  }\r\n}\r\n","export class ImportError extends Error {}\r\n\r\nexport class ImportInvalidFileError extends ImportError {\r\n  constructor() {\r\n    super('Invalid file');\r\n    Object.setPrototypeOf(this, ImportInvalidFileError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportUnreadableFileError extends ImportError {\r\n  constructor() {\r\n      super('Failed to read file');\r\n      Object.setPrototypeOf(this, ImportUnreadableFileError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportNothingToImportError extends ImportError {\r\n  constructor() {\r\n      super('Nothing to import');\r\n      Object.setPrototypeOf(this, ImportNothingToImportError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportSizeError extends ImportError {\r\n  constructor() {\r\n      super('File is too large');\r\n      Object.setPrototypeOf(this, ImportNothingToImportError.prototype);\r\n  }\r\n}\r\n\r\nexport class ImportSRSError extends ImportError {\r\n  constructor() {\r\n      super('Invalid SRS definition');\r\n      Object.setPrototypeOf(this, ImportNothingToImportError.prototype);\r\n  }\r\n}\r\n","export enum TypePermission {\r\n  null,\r\n  read,\r\n  write\r\n}\r\n\r\nexport enum Scope {\r\n  public,\r\n  protected,\r\n  private\r\n}\r\n","import { Injectable, Optional } from '@angular/core';\r\nimport { HttpClient, HttpErrorResponse } from '@angular/common/http';\r\n\r\nimport { BehaviorSubject, Observable, of, Subject } from 'rxjs';\r\nimport {\r\n  map,\r\n  tap,\r\n  catchError,\r\n  debounceTime,\r\n  mergeMap,\r\n  first,\r\n  skip\r\n} from 'rxjs/operators';\r\n\r\nimport olPoint from 'ol/geom/Point';\r\nimport GeoJSON from 'ol/format/GeoJSON';\r\nimport Cluster from 'ol/source/Cluster';\r\nimport olVectorSource from 'ol/source/Vector';\r\n\r\nimport { Tool } from '@igo2/common';\r\nimport { uuid, ObjectUtils } from '@igo2/utils';\r\nimport {\r\n  ConfigService,\r\n  RouteService,\r\n  Message,\r\n  MessageService,\r\n  LanguageService,\r\n  StorageService\r\n} from '@igo2/core';\r\n\r\nimport { AuthService } from '@igo2/auth';\r\nimport type { IgoMap, Layer } from '@igo2/geo';\r\n\r\nimport { TypePermission } from './context.enum';\r\nimport {\r\n  ContextsList,\r\n  ContextServiceOptions,\r\n  Context,\r\n  DetailedContext,\r\n  ContextMapView,\r\n  ContextPermission,\r\n  ContextProfils\r\n} from './context.interface';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ContextService {\r\n  public context$ = new BehaviorSubject<DetailedContext>(undefined);\r\n  public contexts$ = new BehaviorSubject<ContextsList>({ ours: [] });\r\n  public defaultContextId$ = new BehaviorSubject<string>(undefined);\r\n  public editedContext$ = new BehaviorSubject<DetailedContext>(undefined);\r\n  public importedContext: Array<DetailedContext> = [];\r\n  public toolsChanged$ = new Subject<DetailedContext>();\r\n  private mapViewFromRoute: ContextMapView = {};\r\n  private options: ContextServiceOptions;\r\n  private baseUrl: string;\r\n\r\n  // Until the ContextService is completely refactored, this is needed\r\n  // to track the current tools\r\n  private tools: Tool[];\r\n  private toolbar: string[];\r\n\r\n  get defaultContextUri(): string {\r\n    return this.storageService.get('favorite.context.uri') as string || this._defaultContextUri || this.options.defaultContextUri;\r\n  }\r\n  set defaultContextUri(uri: string) {\r\n    this._defaultContextUri = uri;\r\n  }\r\n  private _defaultContextUri: string;\r\n\r\n  constructor(\r\n    private http: HttpClient,\r\n    private authService: AuthService,\r\n    private languageService: LanguageService,\r\n    private config: ConfigService,\r\n    private messageService: MessageService,\r\n    private storageService: StorageService,\r\n    @Optional() private route: RouteService\r\n  ) {\r\n    this.options = Object.assign(\r\n      {\r\n        basePath: 'contexts',\r\n        contextListFile: '_contexts.json',\r\n        defaultContextUri: '_default'\r\n      },\r\n      this.config.getConfig('context')\r\n    );\r\n\r\n    this.baseUrl = this.options.url;\r\n\r\n    this.readParamsFromRoute();\r\n\r\n    if (this.authService.hasAuthService) {\r\n      this.authService.logged$.subscribe((logged) => {\r\n        if (logged) {\r\n          this.contexts$.pipe(skip(1), first()).subscribe((c) => {\r\n            this.handleContextsChange();\r\n          });\r\n          this.loadContexts();\r\n        }\r\n      });\r\n    } else {\r\n      this.loadContexts();\r\n      this.handleContextsChange(false);\r\n    }\r\n  }\r\n\r\n  get(permissions?: string[], hidden?: boolean): Observable<ContextsList> {\r\n    let url = this.baseUrl + '/contexts';\r\n    if (permissions && this.authService.authenticated) {\r\n      url += '?permission=' + permissions.join();\r\n      if (hidden) {\r\n        url += '&hidden=true';\r\n      }\r\n    }\r\n    return this.http.get<ContextsList>(url);\r\n  }\r\n\r\n  getById(id: string): Observable<Context> {\r\n    const url = this.baseUrl + '/contexts/' + id;\r\n    return this.http.get<Context>(url);\r\n  }\r\n\r\n  getDetails(id: string): Observable<DetailedContext> {\r\n    const url = `${this.baseUrl}/contexts/${id}/details`;\r\n    return this.http.get<DetailedContext>(url).pipe(\r\n      catchError((res) => {\r\n        this.handleError(res, id);\r\n        throw res;\r\n      })\r\n    );\r\n  }\r\n\r\n  getDefault(): Observable<DetailedContext> {\r\n    if (this.authService.authenticated) {\r\n      const url = this.baseUrl + '/contexts/default';\r\n      return this.http.get<DetailedContext>(url).pipe(\r\n        tap((context) => {\r\n          this.defaultContextId$.next(context.id);\r\n        })\r\n      );\r\n    } else {\r\n      const uri = this.storageService.get('favorite.context.uri') as string;\r\n      this.defaultContextId$.next(uri);\r\n      return this.getContextByUri(uri);\r\n    }\r\n\r\n  }\r\n\r\n  getProfilByUser(): Observable<ContextProfils[]> {\r\n    if (this.baseUrl) {\r\n      const url = this.baseUrl + '/profils?';\r\n      return this.http.get<ContextProfils[]>(url);\r\n    }\r\n    return of([]);\r\n  }\r\n\r\n  setDefault(id: string): Observable<any> {\r\n    if (this.authService.authenticated) {\r\n      const url = this.baseUrl + '/contexts/default';\r\n      return this.http.post(url, { defaultContextId: id });\r\n    } else {\r\n      this.storageService.set('favorite.context.uri', id);\r\n      return of(undefined);\r\n    }\r\n  }\r\n\r\n  hideContext(id: string) {\r\n    const url = this.baseUrl + '/contexts/' + id + '/hide';\r\n    return this.http.post(url, {});\r\n  }\r\n\r\n  showContext(id: string) {\r\n    const url = this.baseUrl + '/contexts/' + id + '/show';\r\n    return this.http.post(url, {});\r\n  }\r\n\r\n  delete(id: string, imported = false): Observable<void> {\r\n    const contexts: ContextsList = { ours: [] };\r\n    Object.keys(this.contexts$.value).forEach(\r\n      (key) =>\r\n        (contexts[key] = this.contexts$.value[key].filter((c) => c.id !== id))\r\n    );\r\n\r\n    if (imported) {\r\n      this.importedContext = this.importedContext.filter((c) => c.id !== id);\r\n      return of(this.contexts$.next(contexts));\r\n    }\r\n\r\n    const url = this.baseUrl + '/contexts/' + id;\r\n    return this.http.delete<void>(url).pipe(\r\n      tap((res) => {\r\n        this.contexts$.next(contexts);\r\n      })\r\n    );\r\n  }\r\n\r\n  create(context: DetailedContext): Observable<Context> {\r\n    const url = this.baseUrl + '/contexts';\r\n    return this.http.post<Context>(url, context).pipe(\r\n      map((contextCreated) => {\r\n        if (this.authService.authenticated) {\r\n          contextCreated.permission = TypePermission[TypePermission.write];\r\n        } else {\r\n          contextCreated.permission = TypePermission[TypePermission.read];\r\n        }\r\n        this.contexts$.value.ours.unshift(contextCreated);\r\n        this.contexts$.next(this.contexts$.value);\r\n        return contextCreated;\r\n      })\r\n    );\r\n  }\r\n\r\n  clone(id: string, properties = {}): Observable<Context> {\r\n    const url = this.baseUrl + '/contexts/' + id + '/clone';\r\n    return this.http.post<Context>(url, properties).pipe(\r\n      map((contextCloned) => {\r\n        contextCloned.permission = TypePermission[TypePermission.write];\r\n        this.contexts$.value.ours.unshift(contextCloned);\r\n        this.contexts$.next(this.contexts$.value);\r\n        return contextCloned;\r\n      })\r\n    );\r\n  }\r\n\r\n  update(id: string, context: Context): Observable<Context> {\r\n    const url = this.baseUrl + '/contexts/' + id;\r\n    return this.http.patch<Context>(url, context);\r\n  }\r\n\r\n  // =================================================================\r\n\r\n  addToolAssociation(contextId: string, toolId: string): Observable<void> {\r\n    const url = `${this.baseUrl}/contexts/${contextId}/tools`;\r\n    const association = {\r\n      toolId\r\n    };\r\n    return this.http.post<void>(url, association);\r\n  }\r\n\r\n  deleteToolAssociation(contextId: string, toolId: string): Observable<any> {\r\n    const url = `${this.baseUrl}/contexts/${contextId}/tools/${toolId}`;\r\n    return this.http.delete(url);\r\n  }\r\n\r\n  getPermissions(id: string): Observable<ContextPermission[]> {\r\n    const url = this.baseUrl + '/contexts/' + id + '/permissions';\r\n    return this.http.get<ContextPermission[]>(url);\r\n  }\r\n\r\n  addPermissionAssociation(\r\n    contextId: string,\r\n    profil: string,\r\n    type: TypePermission\r\n  ): Observable<ContextPermission[]> {\r\n    const url = `${this.baseUrl}/contexts/${contextId}/permissions`;\r\n    const association = {\r\n      profil,\r\n      typePermission: type\r\n    };\r\n\r\n    return this.http.post<ContextPermission[]>(url, association).pipe(\r\n      catchError((res) => {\r\n        this.handleError(res, undefined, true);\r\n        throw [res]; // TODO Not sure about this.\r\n      })\r\n    );\r\n  }\r\n\r\n  deletePermissionAssociation(\r\n    contextId: string,\r\n    permissionId: string\r\n  ): Observable<void> {\r\n    const url = `${this.baseUrl}/contexts/${contextId}/permissions/${permissionId}`;\r\n    return this.http.delete<void>(url);\r\n  }\r\n\r\n  // ======================================================================\r\n\r\n  getLocalContexts(): Observable<ContextsList> {\r\n    const url = this.getPath(this.options.contextListFile);\r\n    return this.http.get<ContextsList>(url).pipe(\r\n      map((res: any) => {\r\n        return { ours: res };\r\n      })\r\n    );\r\n  }\r\n\r\n  getLocalContext(uri: string): Observable<DetailedContext> {\r\n    const url = this.getPath(`${uri}.json`);\r\n    return this.http.get<DetailedContext>(url).pipe(\r\n      mergeMap((res) => {\r\n        if (!res.base) {\r\n          return of(res);\r\n        }\r\n        const urlBase = this.getPath(`${res.base}.json`);\r\n        return this.http.get<DetailedContext>(urlBase).pipe(\r\n          map((resBase: DetailedContext) => {\r\n            const resMerge = res;\r\n            resMerge.map = ObjectUtils.mergeDeep(resBase.map, res.map);\r\n            resMerge.layers = (resBase.layers || [])\r\n              .concat(res.layers || [])\r\n              .reverse()\r\n              .filter(\r\n                (l, index, self) =>\r\n                  !l.id || self.findIndex((l2) => l2.id === l.id) === index\r\n              )\r\n              .reverse();\r\n            resMerge.toolbar = res.toolbar || resBase.toolbar;\r\n            resMerge.message = res.message || resBase.message;\r\n            resMerge.messages = res.messages || resBase.messages;\r\n            resMerge.tools = (res.tools || [])\r\n              .concat(resBase.tools || [])\r\n              .filter(\r\n                (t, index, self) =>\r\n                  self.findIndex((t2) => t2.name === t.name) === index\r\n              );\r\n            return resMerge;\r\n          }),\r\n          catchError((err) => {\r\n            this.handleError(err, uri);\r\n            throw err;\r\n          })\r\n        );\r\n      }),\r\n      catchError((err2) => {\r\n        this.handleError(err2, uri);\r\n        throw err2;\r\n      })\r\n    );\r\n  }\r\n\r\n  loadContexts(permissions?: string[], hidden?: boolean) {\r\n    let request;\r\n    if (this.baseUrl) {\r\n      request = this.get(permissions, hidden);\r\n    } else {\r\n      request = this.getLocalContexts();\r\n    }\r\n    request.subscribe((contexts) => {\r\n      contexts.ours = this.importedContext.concat(contexts.ours);\r\n      this.contexts$.next(contexts);\r\n    });\r\n  }\r\n\r\n  loadDefaultContext() {\r\n    const loadFct = (direct = false) => {\r\n      if (!direct && this.baseUrl && this.authService.authenticated) {\r\n        this.getDefault().subscribe(\r\n          (_context: DetailedContext) => {\r\n            this.defaultContextUri = _context.uri;\r\n            this.addContextToList(_context);\r\n            this.setContext(_context);\r\n          },\r\n          () => {\r\n            this.defaultContextId$.next(undefined);\r\n            this.loadContext(this.defaultContextUri);\r\n          }\r\n        );\r\n      } else {\r\n        this.loadContext(this.defaultContextUri);\r\n      }\r\n    };\r\n\r\n    if (this.route && this.route.options.contextKey) {\r\n      this.route.queryParams.pipe(debounceTime(100)).subscribe((params) => {\r\n        const contextParam = params[this.route.options.contextKey as string];\r\n        let direct = false;\r\n        if (contextParam) {\r\n          this.defaultContextUri = contextParam;\r\n          direct = true;\r\n        }\r\n        loadFct(direct);\r\n      });\r\n    } else {\r\n      loadFct();\r\n    }\r\n  }\r\n\r\n  loadContext(uri: string) {\r\n    const context = this.context$.value;\r\n\r\n    if (context && context.uri === uri) {\r\n      return;\r\n    }\r\n\r\n    this.getContextByUri(uri)\r\n      .pipe(first())\r\n      .subscribe(\r\n        (_context: DetailedContext) => {\r\n          this.addContextToList(_context);\r\n          this.setContext(_context);\r\n        },\r\n        (err) => {\r\n          if (uri !== this.options.defaultContextUri) {\r\n            this.loadContext(this.options.defaultContextUri);\r\n          }\r\n        }\r\n      );\r\n  }\r\n\r\n  setContext(context: DetailedContext) {\r\n    this.handleContextMessage(context);\r\n    const currentContext = this.context$.value;\r\n    if (currentContext && context && context.id === currentContext.id) {\r\n      if (context.map.view.keepCurrentView === undefined) {\r\n        context.map.view.keepCurrentView = true;\r\n      }\r\n      this.context$.next(context);\r\n      return;\r\n    }\r\n\r\n    if (!context.map) {\r\n      context.map = { view: {} };\r\n    }\r\n\r\n    Object.assign(context.map.view, this.mapViewFromRoute);\r\n\r\n    this.context$.next(context);\r\n  }\r\n\r\n  loadEditedContext(uri: string) {\r\n    this.getContextByUri(uri).subscribe((_context: DetailedContext) => {\r\n      this.setEditedContext(_context);\r\n    });\r\n  }\r\n\r\n  setEditedContext(context: DetailedContext) {\r\n    this.editedContext$.next(context);\r\n  }\r\n\r\n  getContextFromMap(igoMap: IgoMap, empty?: boolean): DetailedContext {\r\n    const view = igoMap.ol.getView();\r\n    const proj = view.getProjection().getCode();\r\n    const center: any = new olPoint(view.getCenter()).transform(\r\n      proj,\r\n      'EPSG:4326'\r\n    );\r\n\r\n    const context = {\r\n      uri: uuid(),\r\n      title: '',\r\n      scope: 'private',\r\n      map: {\r\n        view: {\r\n          center: center.getCoordinates(),\r\n          zoom: view.getZoom(),\r\n          projection: proj,\r\n          maxZoomOnExtent: igoMap.viewController.maxZoomOnExtent\r\n        }\r\n      },\r\n      layers: [],\r\n      tools: []\r\n    };\r\n\r\n    let layers = [];\r\n    if (empty === true) {\r\n      layers = igoMap.layers$\r\n        .getValue()\r\n        .filter(\r\n          (lay) =>\r\n            lay.baseLayer === true ||\r\n            lay.options.id === 'searchPointerSummaryId'\r\n        )\r\n        .sort((a, b) => a.zIndex - b.zIndex);\r\n    } else {\r\n      layers = igoMap.layers$.getValue().filter(lay => !lay.id.includes('WfsWorkspaceTableDest')).sort((a, b) => a.zIndex - b.zIndex);\r\n    }\r\n\r\n    let i = 0;\r\n    for (const l of layers) {\r\n      const layer: any = l;\r\n      const opts = {\r\n        id: layer.options.id ? String(layer.options.id) : undefined,\r\n        layerOptions: {\r\n          title: layer.options.title,\r\n          zIndex: ++i,\r\n          visible: layer.visible\r\n        },\r\n        sourceOptions: {\r\n          type: layer.dataSource.options.type,\r\n          params: layer.dataSource.options.params,\r\n          url: layer.dataSource.options.url,\r\n          queryable: layer.queryable\r\n        }\r\n      };\r\n      if (opts.sourceOptions.type) {\r\n        context.layers.push(opts);\r\n      }\r\n    }\r\n\r\n    context.tools = this.tools.map((tool) => {\r\n      return { id: String(tool.id), global: tool.global };\r\n    });\r\n\r\n    return context;\r\n  }\r\n\r\n  getContextFromLayers(\r\n    igoMap: IgoMap,\r\n    layers: Layer[],\r\n    name: string\r\n  ): DetailedContext {\r\n    const currentContext = this.context$.getValue();\r\n    const view = igoMap.ol.getView();\r\n    const proj = view.getProjection().getCode();\r\n    const center: any = new olPoint(view.getCenter()).transform(\r\n      proj,\r\n      'EPSG:4326'\r\n    );\r\n\r\n    const context = {\r\n      uri: name,\r\n      title: name,\r\n      map: {\r\n        view: {\r\n          center: center.getCoordinates(),\r\n          zoom: view.getZoom(),\r\n          projection: proj\r\n        }\r\n      },\r\n      layers: [],\r\n      toolbar: [],\r\n      tools: [],\r\n      extraFeatures: []\r\n    };\r\n\r\n    const currentLayers = igoMap.layers$.getValue();\r\n    context.layers = currentLayers\r\n      .filter((l) => l.baseLayer)\r\n      .map((l) => {\r\n        return {\r\n          baseLayer: true,\r\n          sourceOptions: l.options.sourceOptions,\r\n          title: l.options.title,\r\n          visible: l.visible\r\n        };\r\n      });\r\n\r\n    layers.forEach((layer) => {\r\n      const layerFound = currentContext.layers.find(\r\n        (contextLayer) =>\r\n          layer.id === contextLayer.source.id && !contextLayer.baseLayer\r\n      );\r\n\r\n      if (layerFound) {\r\n        let layerStyle = layerFound[`style`];\r\n        if (layerFound[`styleByAttribute`]) {\r\n          layerStyle = undefined;\r\n        } else if (layerFound[`clusterBaseStyle`]) {\r\n          layerStyle = undefined;\r\n          delete layerFound.sourceOptions[`source`];\r\n          delete layerFound.sourceOptions[`format`];\r\n        }\r\n        const opts = {\r\n          baseLayer: layerFound.baseLayer,\r\n          title: layer.options.title,\r\n          zIndex: layer.zIndex,\r\n          styleByAttribute: layerFound[`styleByAttribute`],\r\n          clusterBaseStyle: layerFound[`clusterBaseStyle`],\r\n          style: layerStyle,\r\n          clusterParam: layerFound[`clusterParam`],\r\n          visible: layer.visible,\r\n          opacity: layer.opacity,\r\n          sourceOptions: layerFound.sourceOptions\r\n        };\r\n        context.layers.push(opts);\r\n      } else {\r\n        if (!(layer.ol.getSource() instanceof olVectorSource)) {\r\n          const catalogLayer = layer.options;\r\n          catalogLayer.zIndex = layer.zIndex;\r\n          delete catalogLayer.source;\r\n          context.layers.push(catalogLayer);\r\n        } else {\r\n          let features;\r\n          const writer = new GeoJSON();\r\n          if (layer.ol.getSource() instanceof Cluster) {\r\n            const clusterSource = layer.ol.getSource() as Cluster;\r\n            features = writer.writeFeatures(\r\n              clusterSource.getFeatures(),\r\n              {\r\n                dataProjection: 'EPSG:4326',\r\n                featureProjection: 'EPSG:3857'\r\n              }\r\n            );\r\n          } else {\r\n            const source = layer.ol.getSource() as any;\r\n            features = writer.writeFeatures(\r\n              source.getFeatures(),\r\n              {\r\n                dataProjection: 'EPSG:4326',\r\n                featureProjection: 'EPSG:3857'\r\n              }\r\n            );\r\n          }\r\n          features = JSON.parse(features);\r\n          features.name = layer.options.title;\r\n          context.extraFeatures.push(features);\r\n        }\r\n      }\r\n    });\r\n\r\n    context.toolbar = this.toolbar;\r\n    context.tools = this.tools;\r\n\r\n    return context;\r\n  }\r\n\r\n  setTools(tools: Tool[]) {\r\n    this.tools = tools;\r\n  }\r\n\r\n  setToolbar(toolbar: string[]) {\r\n    this.toolbar = toolbar;\r\n  }\r\n\r\n  private handleContextMessage(context: DetailedContext) {\r\n    if (this.context$.value && context.uri && this.context$.value.uri !== context.uri) {\r\n      this.messageService.removeAllAreNotError();\r\n    }\r\n\r\n    context.messages = context.messages ? context.messages : [];\r\n    context.messages.push(context.message);\r\n    context.messages.map(message => {\r\n      if (message) {\r\n        message.title = message.title\r\n          ? this.languageService.translate.instant(message.title)\r\n          : undefined;\r\n        message.text = message.text\r\n          ? this.languageService.translate.instant(message.text)\r\n          : undefined;\r\n        this.messageService.message(message as Message);\r\n      }\r\n    });\r\n  }\r\n\r\n  private getContextByUri(uri: string): Observable<DetailedContext> {\r\n    if (this.baseUrl) {\r\n      let contextToLoad;\r\n      for (const key of Object.keys(this.contexts$.value)) {\r\n        contextToLoad = this.contexts$.value[key].find((c) => {\r\n          return c.uri === uri;\r\n        });\r\n        if (contextToLoad) {\r\n          break;\r\n        }\r\n      }\r\n\r\n      if (contextToLoad && contextToLoad.imported) {\r\n        return of(contextToLoad);\r\n      }\r\n\r\n      // TODO : use always id or uri\r\n      const id = contextToLoad ? contextToLoad.id : uri;\r\n      return this.getDetails(id);\r\n    }\r\n\r\n    const importedContext = this.contexts$.value.ours.find((currentContext) => {\r\n      return currentContext.uri === uri && currentContext.imported === true;\r\n    });\r\n\r\n    if (importedContext) {\r\n      return of(importedContext);\r\n    } else {\r\n      return this.getLocalContext(uri);\r\n    }\r\n  }\r\n\r\n  getContextLayers(igoMap: IgoMap) {\r\n    const layers: Layer[] = [];\r\n    const mapLayers = igoMap.layers$.getValue();\r\n    mapLayers.forEach((layer) => {\r\n      if (!layer.baseLayer && layer.options.id !== 'searchPointerSummaryId') {\r\n        layers.push(layer);\r\n      }\r\n    });\r\n    return layers;\r\n  }\r\n\r\n  private readParamsFromRoute() {\r\n    if (!this.route) {\r\n      return;\r\n    }\r\n\r\n    this.route.queryParams.subscribe((params) => {\r\n      const centerKey = this.route.options.centerKey;\r\n      if (centerKey && params[centerKey as string]) {\r\n        const centerParams = params[centerKey as string];\r\n        this.mapViewFromRoute.center = centerParams.split(',').map(Number);\r\n      }\r\n\r\n      const projectionKey = this.route.options.projectionKey;\r\n      if (projectionKey && params[projectionKey as string]) {\r\n        const projectionParam = params[projectionKey as string];\r\n        this.mapViewFromRoute.projection = projectionParam;\r\n      }\r\n\r\n      const zoomKey = this.route.options.zoomKey;\r\n      if (zoomKey && params[zoomKey as string]) {\r\n        const zoomParam = params[zoomKey as string];\r\n        this.mapViewFromRoute.zoom = Number(zoomParam);\r\n      }\r\n    });\r\n  }\r\n\r\n  private getPath(file: string) {\r\n    const basePath = this.options.basePath.replace(/\\/$/, '');\r\n\r\n    return `${basePath}/${file}`;\r\n  }\r\n\r\n  private handleError(\r\n    error: HttpErrorResponse,\r\n    uri: string,\r\n    permissionError?: boolean\r\n  ) {\r\n    const context = this.contexts$.value.ours.find((obj) => obj.uri === uri);\r\n    const titleContext = context ? context.title : uri;\r\n    error.error.title = this.languageService.translate.instant(\r\n      'igo.context.contextManager.invalid.title'\r\n    );\r\n\r\n    error.error.message = this.languageService.translate.instant(\r\n      'igo.context.contextManager.invalid.text',\r\n      { value: titleContext }\r\n    );\r\n\r\n    error.error.toDisplay = true;\r\n\r\n    if (permissionError) {\r\n      error.error.title = this.languageService.translate.instant(\r\n        'igo.context.contextManager.errors.addPermissionTitle'\r\n      );\r\n      error.error.message = this.languageService.translate.instant(\r\n        'igo.context.contextManager.errors.addPermission'\r\n      );\r\n    }\r\n    this.messageService.error(error.error.message, error.error.title);\r\n  }\r\n\r\n  private handleContextsChange(\r\n    keepCurrentContext = true\r\n  ) {\r\n    const context = this.context$.value;\r\n    const editedContext = this.editedContext$.value;\r\n    if (!context || context.uri === this.options.defaultContextUri) {\r\n      keepCurrentContext = false;\r\n    }\r\n    if (!keepCurrentContext || !this.findContext(context)) {\r\n      this.defaultContextUri = undefined;\r\n      this.loadDefaultContext();\r\n    } else {\r\n      this.getContextByUri(context.uri)\r\n        .pipe(first())\r\n        .subscribe(\r\n          (newContext: DetailedContext) => {\r\n            this.toolsChanged$.next(newContext);\r\n          }\r\n        );\r\n\r\n      if (this.baseUrl && this.authService.authenticated) {\r\n        this.getDefault().subscribe();\r\n      }\r\n    }\r\n    const editedFound = this.findContext(editedContext);\r\n    if (!editedFound || editedFound.permission !== 'write') {\r\n      this.setEditedContext(undefined);\r\n    }\r\n  }\r\n\r\n  private addContextToList(context: Context) {\r\n    const contextFound = this.findContext(context);\r\n    if (!contextFound) {\r\n      const contextSimplifie = {\r\n        id: context.id,\r\n        uri: context.uri,\r\n        title: context.title,\r\n        scope: context.scope,\r\n        permission: TypePermission[TypePermission.read]\r\n      };\r\n\r\n      if (this.contexts$.value && this.contexts$.value.public) {\r\n        this.contexts$.value.public.push(contextSimplifie);\r\n        this.contexts$.next(this.contexts$.value);\r\n      }\r\n    }\r\n  }\r\n\r\n  private findContext(context: Context) {\r\n    if (!context) {\r\n      return false;\r\n    }\r\n\r\n    const contexts = this.contexts$.value;\r\n    let found;\r\n    for (const key of Object.keys(contexts)) {\r\n      const value = contexts[key];\r\n      found = value.find(\r\n        (c) =>\r\n          (context.id && c.id === context.id) ||\r\n          (context.uri && c.uri === context.uri)\r\n      );\r\n      if (found) {\r\n        break;\r\n      }\r\n    }\r\n\r\n    return found;\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatButtonToggleModule } from '@angular/material/button-toggle';\r\nimport { MatOptionModule } from '@angular/material/core';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatDividerModule } from '@angular/material/divider';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatTabsModule } from '@angular/material/tabs';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { ContextImportExportComponent } from './context-import-export/context-import-export.component';\r\nimport { IgoSpinnerModule } from '@igo2/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\n\r\n@NgModule({\r\n  imports: [\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    CommonModule,\r\n    MatButtonModule,\r\n    MatButtonToggleModule,\r\n    MatDividerModule,\r\n    MatTabsModule,\r\n    MatSelectModule,\r\n    MatOptionModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatCheckboxModule,\r\n    IgoLanguageModule,\r\n    IgoSpinnerModule,\r\n    MatTooltipModule,\r\n  ],\r\n  exports: [\r\n    ContextImportExportComponent\r\n  ],\r\n  declarations: [\r\n    ContextImportExportComponent\r\n  ]\r\n})\r\nexport class IgoContextImportExportModule {\r\n  static forRoot(): ModuleWithProviders<IgoContextImportExportModule> {\r\n    return {\r\n      ngModule: IgoContextImportExportModule\r\n    };\r\n  }\r\n}\r\n","import { Directive, OnInit, OnDestroy } from '@angular/core';\r\n\r\nimport { Subscription } from 'rxjs';\r\nimport { filter } from 'rxjs/operators';\r\n\r\nimport { MapViewOptions, MapBrowserComponent, MapControlsOptions, MapScaleLineOptions } from '@igo2/geo';\r\nimport type { IgoMap } from '@igo2/geo';\r\n\r\nimport { ContextService } from './context.service';\r\nimport { DetailedContext, ContextMapView } from './context.interface';\r\nimport { MediaService } from '@igo2/core';\r\n\r\n@Directive({\r\n  selector: '[igoMapContext]'\r\n})\r\nexport class MapContextDirective implements OnInit, OnDestroy {\r\n  private component: MapBrowserComponent;\r\n  private context$$: Subscription;\r\n\r\n  get map(): IgoMap {\r\n    return this.component.map;\r\n  }\r\n\r\n  constructor(\r\n    component: MapBrowserComponent,\r\n    private contextService: ContextService,\r\n    private mediaService: MediaService\r\n  ) {\r\n    this.component = component;\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.context$$ = this.contextService.context$\r\n      .pipe(filter(context => context !== undefined))\r\n      .subscribe(context => this.handleContextChange(context));\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.context$$.unsubscribe();\r\n  }\r\n\r\n  private handleContextChange(context: DetailedContext) {\r\n    if (context.map === undefined) {\r\n      return;\r\n    }\r\n\r\n    // This creates a new ol.Map when the context changes. Doing that\r\n    // allows the print tool to work properly even when the map's canvas\r\n    // has been tainted (CORS) with the layers of another context. This could\r\n    // have some side effects such as unbinding all listeners on the first map.\r\n    // A better solution would be to create a new map (preview) before\r\n    // printing and avoid the tainted canvas issue. This will come later so\r\n    // this snippet of code is kept here in case it takes too long becomes\r\n    // an issue\r\n\r\n    // const target = this.component.map.ol.getTarget();\r\n    // this.component.map.ol.setTarget(undefined);\r\n    // this.component.map.init();\r\n    // this.component.map.ol.setTarget(target);\r\n\r\n    const viewContext: ContextMapView = context.map.view;\r\n    if (!this.component.view || viewContext.keepCurrentView !== true) {\r\n      this.component.view = viewContext as MapViewOptions;\r\n    }\r\n    if (this.component.map.geolocationController) {\r\n      this.component.map.geolocationController.updateGeolocationOptions(viewContext);\r\n    }\r\n\r\n    const controlsContext: MapControlsOptions = context.map.controls;\r\n    if (!this.component.controls && controlsContext) {\r\n      if (this.mediaService.isMobile()) {\r\n        if (typeof(controlsContext.scaleLine) !== 'boolean') {\r\n          const scaleLineOption = controlsContext.scaleLine as MapScaleLineOptions;\r\n          if (!scaleLineOption.minWidth) {\r\n            scaleLineOption.minWidth = Math.min(64, scaleLineOption.minWidth);\r\n            controlsContext.scaleLine = scaleLineOption;\r\n          }\r\n        }\r\n      }\r\n      this.component.controls = controlsContext;\r\n    }\r\n  }\r\n}\r\n","import { Directive, OnInit, OnDestroy, Optional, Input } from '@angular/core';\r\n\r\nimport { Subscription, merge } from 'rxjs';\r\nimport { buffer, debounceTime, filter } from 'rxjs/operators';\r\n\r\nimport { RouteService, ConfigService } from '@igo2/core';\r\nimport {\r\n  MapBrowserComponent,\r\n  Layer,\r\n  LayerService,\r\n  LayerOptions,\r\n  StyleListService,\r\n  StyleService\r\n} from '@igo2/geo';\r\nimport type { IgoMap } from '@igo2/geo';\r\n\r\nimport { ContextService } from './context.service';\r\nimport { DetailedContext } from './context.interface';\r\nimport {\r\n  addImportedFeaturesToMap,\r\n  addImportedFeaturesStyledToMap\r\n} from '../../context-import-export/shared/context-import.utils';\r\nimport GeoJSON from 'ol/format/GeoJSON';\r\n\r\n@Directive({\r\n  selector: '[igoLayerContext]'\r\n})\r\nexport class LayerContextDirective implements OnInit, OnDestroy {\r\n  private context$$: Subscription;\r\n  private queryParams: any;\r\n\r\n  private contextLayers: Layer[] = [];\r\n\r\n  @Input() removeLayersOnContextChange: boolean = true;\r\n\r\n  get map(): IgoMap {\r\n    return this.component.map;\r\n  }\r\n\r\n  constructor(\r\n    private component: MapBrowserComponent,\r\n    private contextService: ContextService,\r\n    private layerService: LayerService,\r\n    private configService: ConfigService,\r\n    private styleListService: StyleListService,\r\n    private styleService: StyleService,\r\n    @Optional() private route: RouteService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.context$$ = this.contextService.context$\r\n      .pipe(filter((context) => context !== undefined))\r\n      .subscribe((context) => this.handleContextChange(context));\r\n\r\n    if (\r\n      this.route &&\r\n      this.route.options.visibleOnLayersKey &&\r\n      this.route.options.visibleOffLayersKey &&\r\n      this.route.options.contextKey\r\n    ) {\r\n      const queryParams$$ = this.route.queryParams.subscribe((params) => {\r\n        if (Object.keys(params).length > 0) {\r\n          this.queryParams = params;\r\n          queryParams$$.unsubscribe();\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.context$$.unsubscribe();\r\n  }\r\n\r\n  private handleContextChange(context: DetailedContext) {\r\n    if (context.layers === undefined) {\r\n      return;\r\n    }\r\n    if (this.removeLayersOnContextChange === true) {\r\n      this.map.removeAllLayers();\r\n    } else {\r\n      this.map.removeLayers(this.contextLayers);\r\n    }\r\n    this.contextLayers = [];\r\n\r\n    const layersAndIndex$ = merge(\r\n      ...context.layers.map((layerOptions: LayerOptions, index: number) => {\r\n        return this.layerService.createAsyncLayer(layerOptions, context.uri);\r\n      })\r\n    );\r\n\r\n    layersAndIndex$\r\n      .pipe(buffer(layersAndIndex$.pipe(debounceTime(500))))\r\n      .subscribe((layers: Layer[]) => {\r\n        layers = layers\r\n          .filter((layer: Layer) => layer !== undefined)\r\n          .map((layer) => {\r\n            layer.visible = this.computeLayerVisibilityFromUrl(layer);\r\n            layer.zIndex = layer.zIndex;\r\n\r\n            return layer;\r\n          });\r\n\r\n        this.contextLayers.concat(layers);\r\n        this.map.addLayers(layers);\r\n\r\n        if (context.extraFeatures) {\r\n          context.extraFeatures.forEach((featureCollection) => {\r\n            const format = new GeoJSON();\r\n            const title = featureCollection.name;\r\n            featureCollection = JSON.stringify(featureCollection);\r\n            featureCollection = format.readFeatures(featureCollection, {\r\n              dataProjection: 'EPSG:4326',\r\n              featureProjection: 'EPSG:3857'\r\n            });\r\n            if (!this.configService.getConfig('importWithStyle')) {\r\n              addImportedFeaturesToMap(featureCollection, this.map, title);\r\n            } else {\r\n              addImportedFeaturesStyledToMap(\r\n                featureCollection,\r\n                this.map,\r\n                title,\r\n                this.styleListService,\r\n                this.styleService\r\n              );\r\n            }\r\n          });\r\n        }\r\n      });\r\n  }\r\n\r\n  private computeLayerVisibilityFromUrl(layer: Layer): boolean {\r\n    const params = this.queryParams;\r\n    const currentContext = this.contextService.context$.value.uri;\r\n    const currentLayerid: string = layer.id;\r\n\r\n    let visible = layer.visible;\r\n    if (!params || !currentLayerid) {\r\n      return visible;\r\n    }\r\n\r\n    const contextParams = params[this.route.options.contextKey as string];\r\n    if (contextParams === currentContext || !contextParams) {\r\n      let visibleOnLayersParams = '';\r\n      let visibleOffLayersParams = '';\r\n      let visiblelayers: string[] = [];\r\n      let invisiblelayers: string[] = [];\r\n\r\n      if (\r\n        this.route.options.visibleOnLayersKey &&\r\n        params[this.route.options.visibleOnLayersKey as string]\r\n      ) {\r\n        visibleOnLayersParams =\r\n          params[this.route.options.visibleOnLayersKey as string];\r\n      }\r\n      if (\r\n        this.route.options.visibleOffLayersKey &&\r\n        params[this.route.options.visibleOffLayersKey as string]\r\n      ) {\r\n        visibleOffLayersParams =\r\n          params[this.route.options.visibleOffLayersKey as string];\r\n      }\r\n\r\n      /* This order is important because to control whichever\r\n       the order of * param. First whe open and close everything.*/\r\n      if (visibleOnLayersParams === '*') {\r\n        visible = true;\r\n      }\r\n      if (visibleOffLayersParams === '*') {\r\n        visible = false;\r\n      }\r\n\r\n      // After, managing named layer by id (context.json OR id from datasource)\r\n      visiblelayers = visibleOnLayersParams.split(',');\r\n      invisiblelayers = visibleOffLayersParams.split(',');\r\n      if (visiblelayers.indexOf(currentLayerid) > -1 || visiblelayers.indexOf(currentLayerid.toString()) > -1) {\r\n        visible = true;\r\n      }\r\n      if (invisiblelayers.indexOf(currentLayerid) > -1 || invisiblelayers.indexOf(currentLayerid.toString()) > -1) {\r\n        visible = false;\r\n      }\r\n    }\r\n\r\n    return visible;\r\n  }\r\n}\r\n","import * as olStyle from 'ol/style';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\nimport {\r\n  FeatureDataSource,\r\n  FeatureDataSourceOptions,\r\n  IgoMap,\r\n  VectorLayer,\r\n  QueryableDataSourceOptions,\r\n  StyleService,\r\n  StyleListService,\r\n  StyleByAttribute,\r\n  ClusterParam,\r\n  ClusterDataSourceOptions,\r\n  ClusterDataSource\r\n} from '@igo2/geo';\r\nimport { MessageService, LanguageService } from '@igo2/core';\r\nimport { DetailedContext } from '../../context-manager/shared/context.interface';\r\nimport { ContextService } from '../../context-manager/shared/context.service';\r\nimport OlFeature from 'ol/Feature';\r\n\r\nexport function handleFileImportSuccess(\r\n  file: File,\r\n  context: DetailedContext,\r\n  messageService: MessageService,\r\n  languageService: LanguageService,\r\n  contextService: ContextService\r\n) {\r\n  if (Object.keys(context).length <= 0) {\r\n    handleNothingToImportError(file, messageService, languageService);\r\n    return;\r\n  }\r\n\r\n  const contextTitle = computeLayerTitleFromFile(file);\r\n\r\n  addContextToContextList(context, contextTitle, contextService);\r\n\r\n  const translate = languageService.translate;\r\n  const messageTitle = translate.instant(\r\n    'igo.context.contextImportExport.import.success.title'\r\n  );\r\n  const message = translate.instant(\r\n    'igo.context.contextImportExport.import.success.text',\r\n    {\r\n      value: contextTitle\r\n    }\r\n  );\r\n  messageService.success(message, messageTitle);\r\n}\r\n\r\nexport function handleFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService,\r\n  sizeMb?: number\r\n) {\r\n  sizeMb = sizeMb ? sizeMb : 30;\r\n  const errMapping = {\r\n    'Invalid file': handleInvalidFileImportError,\r\n    'File is too large': handleSizeFileImportError,\r\n    'Failed to read file': handleUnreadbleFileImportError\r\n  };\r\n  errMapping[error.message](\r\n    file,\r\n    error,\r\n    messageService,\r\n    languageService,\r\n    sizeMb\r\n  );\r\n}\r\n\r\nexport function handleInvalidFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant(\r\n    'igo.context.contextImportExport.import.invalid.title'\r\n  );\r\n  const message = translate.instant(\r\n    'igo.context.contextImportExport.import.invalid.text',\r\n    {\r\n      value: file.name,\r\n      mimeType: file.type\r\n    }\r\n  );\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function handleSizeFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService,\r\n  sizeMb: number\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant(\r\n    'igo.context.contextImportExport.import.tooLarge.title'\r\n  );\r\n  const message = translate.instant(\r\n    'igo.context.contextImportExport.import.tooLarge.text',\r\n    {\r\n      value: file.name,\r\n      size: sizeMb\r\n    }\r\n  );\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function handleUnreadbleFileImportError(\r\n  file: File,\r\n  error: Error,\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant(\r\n    'igo.context.contextImportExport.import.unreadable.title'\r\n  );\r\n  const message = translate.instant(\r\n    'igo.context.contextImportExport.import.unreadable.text',\r\n    {\r\n      value: file.name\r\n    }\r\n  );\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function handleNothingToImportError(\r\n  file: File,\r\n  messageService: MessageService,\r\n  languageService: LanguageService\r\n) {\r\n  const translate = languageService.translate;\r\n  const title = translate.instant(\r\n    'igo.context.contextImportExport.import.empty.title'\r\n  );\r\n  const message = translate.instant(\r\n    'igo.context.contextImportExport.import.empty.text',\r\n    {\r\n      value: file.name\r\n    }\r\n  );\r\n  messageService.error(message, title);\r\n}\r\n\r\nexport function addContextToContextList(\r\n  context: DetailedContext,\r\n  contextTitle: string,\r\n  contextService: ContextService\r\n) {\r\n  context.title = contextTitle;\r\n  context.imported = true;\r\n  contextService.contexts$.value.ours.unshift(context);\r\n  contextService.contexts$.next(contextService.contexts$.value);\r\n  contextService.importedContext.unshift(context);\r\n  contextService.loadContext(context.uri);\r\n}\r\n\r\nexport function getFileExtension(file: File): string {\r\n  return file.name.split('.').pop().toLowerCase();\r\n}\r\n\r\nexport function computeLayerTitleFromFile(file: File): string {\r\n  return file.name.substr(0, file.name.lastIndexOf('.'));\r\n}\r\n\r\nexport function addImportedFeaturesToMap(\r\n  olFeatures: OlFeature<OlGeometry>[],\r\n  map: IgoMap,\r\n  layerTitle: string\r\n): VectorLayer {\r\n  const r = Math.floor(Math.random() * 255);\r\n  const g = Math.floor(Math.random() * 255);\r\n  const b = Math.floor(Math.random() * 255);\r\n  const stroke = new olStyle.Stroke({\r\n    color: [r, g, b, 1],\r\n    width: 2\r\n  });\r\n\r\n  const fill = new olStyle.Fill({\r\n    color: [r, g, b, 0.4]\r\n  });\r\n  const sourceOptions: FeatureDataSourceOptions & QueryableDataSourceOptions = {\r\n    type: 'vector',\r\n    queryable: true\r\n  };\r\n  const source = new FeatureDataSource(sourceOptions);\r\n  source.ol.addFeatures(olFeatures);\r\n  const layer = new VectorLayer({\r\n    title: layerTitle,\r\n    isIgoInternalLayer: true,\r\n    source,\r\n    style: new olStyle.Style({\r\n      stroke,\r\n      fill,\r\n      image: new olStyle.Circle({\r\n        radius: 5,\r\n        stroke,\r\n        fill\r\n      })\r\n    })\r\n  });\r\n  map.addLayer(layer);\r\n\r\n  return layer;\r\n}\r\n\r\nexport function addImportedFeaturesStyledToMap(\r\n  olFeatures: OlFeature<OlGeometry>[],\r\n  map: IgoMap,\r\n  layerTitle: string,\r\n  styleListService: StyleListService,\r\n  styleService: StyleService\r\n): VectorLayer {\r\n  let style;\r\n  let distance: number;\r\n\r\n  if (\r\n    styleListService.getStyleList(layerTitle.toString() + '.styleByAttribute')\r\n  ) {\r\n    const styleByAttribute: StyleByAttribute = styleListService.getStyleList(\r\n      layerTitle.toString() + '.styleByAttribute'\r\n    );\r\n\r\n    style = (feature, resolution) => {\r\n      return styleService.createStyleByAttribute(feature, styleByAttribute, resolution);\r\n    };\r\n  } else if (\r\n    styleListService.getStyleList(layerTitle.toString() + '.clusterStyle')\r\n  ) {\r\n    const clusterParam: ClusterParam = styleListService.getStyleList(\r\n      layerTitle.toString() + '.clusterParam'\r\n    );\r\n    distance = styleListService.getStyleList(\r\n      layerTitle.toString() + '.distance'\r\n    );\r\n\r\n    style = (feature, resolution) => {\r\n      const baseStyle = styleService.createStyle(\r\n        styleListService.getStyleList(layerTitle.toString() + '.clusterStyle'), feature, resolution\r\n      );\r\n      return styleService.createClusterStyle(feature, resolution, clusterParam, baseStyle);\r\n    };\r\n  } else if (styleListService.getStyleList(layerTitle.toString() + '.style')) {\r\n    style = (feature, resolution) => styleService.createStyle(\r\n      styleListService.getStyleList(layerTitle.toString() + '.style'), feature, resolution\r\n    );\r\n  } else {\r\n    style = (feature, resolution) => styleService.createStyle(\r\n      styleListService.getStyleList('default.style'), feature, resolution\r\n    );\r\n  }\r\n  let source;\r\n\r\n  if (styleListService.getStyleList(layerTitle.toString() + '.clusterStyle')) {\r\n    const sourceOptions: ClusterDataSourceOptions &\r\n      QueryableDataSourceOptions = {\r\n      distance,\r\n      type: 'cluster',\r\n      queryable: true\r\n    };\r\n    source = new ClusterDataSource(sourceOptions);\r\n    source.ol.source.addFeatures(olFeatures);\r\n  } else {\r\n    const sourceOptions: FeatureDataSourceOptions &\r\n      QueryableDataSourceOptions = {\r\n      type: 'vector',\r\n      queryable: true\r\n    };\r\n    source = new FeatureDataSource(sourceOptions);\r\n    source.ol.addFeatures(olFeatures);\r\n  }\r\n\r\n  const layer = new VectorLayer({\r\n    title: layerTitle,\r\n    isIgoInternalLayer: true,\r\n    source,\r\n    style\r\n  });\r\n  map.addLayer(layer);\r\n\r\n  return layer;\r\n}\r\n","export enum ContextListControlsEnum {\r\n  always = 'always',\r\n  never = 'never',\r\n  default = 'default'\r\n}\r\n","import { Component } from '@angular/core';\r\nimport { MatDialogRef } from '@angular/material/dialog';\r\n\r\n@Component({\r\n  selector: 'igo-bookmark-dialog',\r\n  templateUrl: './bookmark-dialog.component.html'\r\n})\r\nexport class BookmarkDialogComponent {\r\n  public title: string;\r\n\r\n  constructor(public dialogRef: MatDialogRef<BookmarkDialogComponent>) {}\r\n}\r\n","<h1 mat-dialog-title class=\"mat-typography\">{{ 'igo.context.bookmarkButton.dialog.title' |translate }}</h1>\r\n<div mat-dialog-content class=\"mat-typography\">\r\n  <mat-form-field>\r\n    <input matInput required autocomplete=\"off\"\r\n      maxlength=\"128\"\r\n      [placeholder]=\"'igo.context.bookmarkButton.dialog.placeholder' |translate\"\r\n      [(ngModel)]=\"title\">\r\n  </mat-form-field>\r\n</div>\r\n<div mat-dialog-actions>\r\n  <button mat-button color=\"primary\"\r\n         [disabled]=\"!title\"\r\n         (click)=\"dialogRef.close(title)\">\r\n    {{'igo.common.confirmDialog.confirmBtn' | translate}}\r\n  </button>\r\n  <button mat-button\r\n          (click)=\"dialogRef.close(false)\">\r\n    {{'igo.common.confirmDialog.cancelBtn' |translate}}\r\n  </button>\r\n</div>\r\n","<mat-list-item\r\n  class=\"mat-list-item\"\r\n  [ngClass]=\"{'mat-list-item-light': hidden}\">\r\n  <button mat-list-avatar\r\n    *ngIf=\"auth.authenticated\"\r\n    mat-icon-button\r\n    igoStopPropagation\r\n    [matTooltip]=\"auth.authenticated ? ('igo.context.contextManager.favorite' | translate) : ''\"\r\n    matTooltipShowDelay=\"500\"\r\n    [color]=\"default ? 'primary' : 'default'\"\r\n    (click)=\"favoriteClick(context)\">\r\n    <mat-icon *ngIf=\"!context.iconImage\" svgIcon=\"{{context.icon ? context.icon : context.scope === 'public' ? 'earth' : 'star'}}\"></mat-icon>\r\n    <img *ngIf=\"context.iconImage\" [src]=\"context.iconImage\">\r\n  </button>\r\n  <button mat-list-avatar\r\n    *ngIf=\"!auth.authenticated && showFavorite\"\r\n    mat-icon-button\r\n    igoStopPropagation\r\n    [matTooltip]=\"'igo.context.contextManager.favorite' | translate\"\r\n    matTooltipShowDelay=\"500\"\r\n    [color]=\"default ? 'primary' : 'default'\"\r\n    (click)=\"favoriteClick(context)\">\r\n    <mat-icon svgIcon=\"star\"></mat-icon>\r\n  </button>\r\n  <h4 matLine>{{context.title}}</h4>\r\n\r\n  <div *ngIf=\"auth.authenticated\"\r\n       igoStopPropagation\r\n       class=\"igo-actions-container\">\r\n\r\n     <button *ngIf=\"collapsed && selected && (context.permission === typePermission[typePermission.write] || context.imported)\"\r\n       class=\"save-button\"\r\n       mat-icon-button\r\n       [matTooltip]=\"'igo.context.contextManager.save' | translate\"\r\n       matTooltipShowDelay=\"500\"\r\n       [color]=\"color\"\r\n       (click)=\"save.emit(context)\">\r\n       <mat-icon svgIcon=\"content-save\"></mat-icon>\r\n     </button>\r\n\r\n    <div #actions class=\"igo-actions-expand-container\">\r\n\r\n      <button *ngIf=\"canShare && !context.imported\"\r\n        mat-icon-button\r\n        [matTooltip]=\"'igo.context.contextManager.managePermissions' | translate\"\r\n        matTooltipShowDelay=\"500\"\r\n        [color]=\"color\"\r\n        (click)=\"managePermissions.emit(context)\">\r\n        <mat-icon svgIcon=\"account-arrow-right\"></mat-icon>\r\n      </button>\r\n\r\n      <!--button\r\n        mat-icon-button\r\n        [matTooltip]=\"'igo.context.contextManager.manageTools' | translate\"\r\n        [color]=\"color\"\r\n        (click)=\"manageTools.emit(context)\">\r\n        <mat-icon svgIcon=\"widgets\"></mat-icon>\r\n      </button-->\r\n\r\n      <button *ngIf=\"!context.imported\"\r\n        class=\"clone-button\"\r\n        mat-icon-button\r\n        [matTooltip]=\"'igo.context.contextManager.clone' | translate\"\r\n        matTooltipShowDelay=\"500\"\r\n        [color]=\"color\"\r\n        (click)=\"clone.emit(context)\">\r\n        <mat-icon svgIcon=\"content-copy\"></mat-icon>\r\n      </button>\r\n\r\n      <button *ngIf=\"context.permission === typePermission[typePermission.write] && !context.imported\"\r\n        class=\"edit-button\"\r\n        mat-icon-button\r\n        [color]=\"color\"\r\n        [matTooltip]=\"'igo.context.contextManager.edit' | translate\"\r\n        matTooltipShowDelay=\"500\"\r\n        (click)=\"edit.emit(context)\">\r\n        <mat-icon svgIcon=\"pencil\"></mat-icon>\r\n      </button>\r\n\r\n      <button *ngIf=\"!context.hidden && !context.imported\"\r\n        class=\"hide-button\"\r\n        mat-icon-button\r\n        [color]=\"color\"\r\n        [matTooltip]=\"'igo.context.contextManager.hide' | translate\"\r\n        matTooltipShowDelay=\"500\"\r\n        (click)=\"hide.emit(context)\">\r\n        <mat-icon svgIcon=\"eye\"></mat-icon>\r\n      </button>\r\n\r\n      <button *ngIf=\"context.hidden && !context.imported\"\r\n        class=\"hide-button\"\r\n        mat-icon-button\r\n        [color]=\"color\"\r\n        [matTooltip]=\"'igo.context.contextManager.show' | translate\"\r\n        matTooltipShowDelay=\"500\"\r\n        (click)=\"show.emit(context)\">\r\n        <mat-icon svgIcon=\"eye-off\"></mat-icon>\r\n      </button>\r\n\r\n      <button *ngIf=\"context.permission === typePermission[typePermission.write] || context.imported\"\r\n        class=\"delete-button\"\r\n        mat-icon-button\r\n        color=\"warn\"\r\n        [matTooltip]=\"'igo.context.contextManager.delete' | translate\"\r\n        matTooltipShowDelay=\"500\"\r\n        (click)=\"delete.emit(context)\">\r\n        <mat-icon svgIcon=\"delete\"></mat-icon>\r\n      </button>\r\n    </div>\r\n\r\n    <button\r\n      class=\"actions-button\"\r\n      mat-icon-button\r\n      igoCollapse\r\n      [color]=\"color\"\r\n      [target]=\"actions\"\r\n      [collapsed]=collapsed\r\n      (click)=\"collapsed = !collapsed\">\r\n      <mat-icon svgIcon=\"dots-horizontal\"></mat-icon>\r\n    </button>\r\n\r\n  </div>\r\n\r\n</mat-list-item>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectionStrategy\r\n} from '@angular/core';\r\n\r\nimport { StorageService } from '@igo2/core';\r\nimport { AuthService } from '@igo2/auth';\r\nimport { TypePermission } from '../shared/context.enum';\r\nimport { DetailedContext } from '../shared/context.interface';\r\n\r\n@Component({\r\n  selector: 'igo-context-item',\r\n  templateUrl: './context-item.component.html',\r\n  styleUrls: ['./context-item.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class ContextItemComponent {\r\n  public typePermission = TypePermission;\r\n  public color = 'primary';\r\n  public collapsed = true;\r\n\r\n  @Input() showFavorite: boolean = true;\r\n  @Input() context: DetailedContext;\r\n  @Input() default: boolean;\r\n  @Input() selected: boolean;\r\n\r\n  @Output() edit = new EventEmitter<DetailedContext>();\r\n  @Output() delete = new EventEmitter<DetailedContext>();\r\n  @Output() save = new EventEmitter<DetailedContext>();\r\n  @Output() clone = new EventEmitter<DetailedContext>();\r\n  @Output() hide = new EventEmitter<DetailedContext>();\r\n  @Output() show = new EventEmitter<DetailedContext>();\r\n  @Output() favorite = new EventEmitter<DetailedContext>();\r\n  @Output() managePermissions = new EventEmitter<DetailedContext>();\r\n  @Output() manageTools = new EventEmitter<DetailedContext>();\r\n\r\n  get hidden(): boolean {\r\n    return this.context.hidden;\r\n  }\r\n\r\n  get canShare(): boolean {\r\n    return this.storageService.get('canShare') === true;\r\n  }\r\n\r\n  constructor(\r\n    public auth: AuthService,\r\n    private storageService: StorageService\r\n  ) {}\r\n\r\n  favoriteClick(context: DetailedContext) {\r\n    this.favorite.emit(context);\r\n  }\r\n}\r\n","<igo-list [navigation]=\"true\">\r\n  <mat-form-field *ngIf=\"showFilter()\" [ngClass]=\"auth.authenticated && configService.getConfig('context') ? 'context-filter-min-width' : 'context-filter-max-width'\">\r\n    <input\r\n      matInput\r\n      type=\"text\"\r\n      [placeholder]=\"'igo.context.contextManager.filterPlaceHolder' | translate\"\r\n      [(ngModel)]=\"term\">\r\n    <button\r\n      mat-button\r\n      mat-icon-button\r\n      matSuffix\r\n      class=\"clear-button\"\r\n      *ngIf=\"term.length\"\r\n      aria-label=\"Clear\"\r\n      color=\"warn\"\r\n      (click)=\"clearFilter()\">\r\n      <mat-icon svgIcon=\"close\"></mat-icon>\r\n    </button>\r\n  </mat-form-field>\r\n\r\n  <button\r\n  *ngIf=\"!sortedAlpha\"\r\n  class=\"sort-alpha\"\r\n  mat-icon-button\r\n  [matTooltip]=\"'igo.context.contextManager.sortAlphabetically' | translate\"\r\n  matTooltipShowDelay=\"500\"\r\n  (click)=\"toggleSort(true)\">\r\n  <mat-icon color=\"primary\" svgIcon=\"sort-alphabetical-variant\"></mat-icon>\r\n  </button>\r\n  <button\r\n    *ngIf=\"sortedAlpha\"\r\n    class=\"sort-alpha\"\r\n    mat-icon-button\r\n    [matTooltip]=\"'igo.context.contextManager.sortContextOrder' | translate\"\r\n    matTooltipShowDelay=\"500\"\r\n    (click)=\"toggleSort(false)\">\r\n    <mat-icon color=\"warn\" svgIcon=\"sort-variant-remove\"></mat-icon>\r\n  </button>\r\n\r\n  <igo-actionbar *ngIf=\"auth.authenticated && configService.getConfig('context')\"\r\n    class=\"add-context-button\"\r\n    [iconColor]=\"color\"\r\n    [store]=\"actionStore\"\r\n    [withIcon]=\"true\"\r\n    icon=\"plus\"\r\n    [withTitle]=\"actionbarMode === 'overlay'\"\r\n    [horizontal]=\"false\"\r\n    [mode]=\"actionbarMode\">\r\n  </igo-actionbar>\r\n\r\n  <button *ngIf=\"auth.authenticated && configService.getConfig('context')\"\r\n    class=\"users-filter\"\r\n    mat-icon-button\r\n    [matTooltip]=\"'igo.context.contextManager.filterUser' | translate\"\r\n    matTooltipShowDelay=\"500\"\r\n    [matMenuTriggerFor]=\"accountMenu\">\r\n    <mat-icon color=\"primary\" svgIcon=\"filter-menu\"></mat-icon>\r\n  </button>\r\n\r\n  <mat-menu #accountMenu=\"matMenu\">\r\n    <ng-container *ngFor=\"let user of users\">\r\n      <span class=\"profilsMenu\">\r\n        <mat-checkbox\r\n          class=\"mat-menu-item\"\r\n          [checked]=\"getPermission(user).checked\"\r\n          [indeterminate]=\"getPermission(user).indeterminate\"\r\n          (click)=\"$event.stopPropagation()\"\r\n          (change)=\"userSelection(user)\">\r\n        </mat-checkbox>\r\n        <button *ngIf=\"user.childs\"\r\n          [matMenuTriggerFor]=\"subAccountMenu\"\r\n          mat-menu-item>\r\n          {{user.title}}\r\n        </button>\r\n        <button\r\n          mat-menu-item\r\n          *ngIf=\"!user.childs\">\r\n          {{user.title}}\r\n        </button>\r\n      </span>\r\n\r\n      <mat-menu #subAccountMenu=\"matMenu\">\r\n        <mat-checkbox *ngFor=\"let child of user.childs\"\r\n          class=\"mat-menu-item\"\r\n          [checked]=\"getPermission(child).checked\"\r\n          (click)=\"$event.stopPropagation()\"\r\n          (change)=\"userSelection(child, user)\">\r\n          {{child.title}}\r\n        </mat-checkbox>\r\n      </mat-menu>\r\n    </ng-container>\r\n\r\n    <span class=\"profilsMenu\">\r\n      <mat-checkbox\r\n        class=\"mat-menu-item\"\r\n        [checked]=\"showHidden\"\r\n        (click)=\"$event.stopPropagation()\"\r\n        (change)=\"showHiddenContexts.emit()\">\r\n      </mat-checkbox>\r\n      <button mat-menu-item>\r\n        {{ 'igo.context.contextManager.showHidden' | translate }}\r\n      </button>\r\n    </span>\r\n  </mat-menu>\r\n\r\n  <ng-template ngFor let-groupContexts [ngForOf]=\"contexts$ | async | keyvalue\">\r\n\r\n    <igo-collapsible *ngIf=\"groupContexts.value.length && auth.authenticated\" [title]=\"titleMapping[groupContexts.key] | translate\"\r\n      [collapsed]=\"collapsed[titleMapping[groupContexts.key]]\" (toggle)=\"collapsed[titleMapping[groupContexts.key]] = $event\">\r\n\r\n      <ng-template ngFor let-context [ngForOf]=\"groupContexts.value\">\r\n        <igo-context-item\r\n          igoListItem\r\n          color=\"accent\"\r\n          [selected]=\"selectedContext && selectedContext.uri === context.uri\"\r\n          [context]=\"context\"\r\n          [default]=\"context.id && this.defaultContextId && this.defaultContextId === context.id\"\r\n          (edit)=\"edit.emit(context)\"\r\n          (delete)=\"delete.emit(context)\"\r\n          (clone)=\"clone.emit(context)\"\r\n          (save)=\"save.emit(context)\"\r\n          (hide)=\"hideContext(context)\"\r\n          (show)=\"showContext(context)\"\r\n          (favorite)=\"favorite.emit(context)\"\r\n          (manageTools)=\"manageTools.emit(context)\"\r\n          (managePermissions)=\"managePermissions.emit(context)\"\r\n          (select)=\"select.emit(context)\"\r\n          (unselect)=\"unselect.emit(context)\">\r\n        </igo-context-item>\r\n      </ng-template>\r\n\r\n    </igo-collapsible>\r\n\r\n    <ng-template *ngIf=\"groupContexts.value.length && !auth.authenticated\" ngFor let-context [ngForOf]=\"groupContexts.value\">\r\n      <igo-context-item\r\n        igoListItem\r\n        color=\"accent\"\r\n        [showFavorite]=\"configService.getConfig('favoriteContext4NonAuthenticated')\"\r\n        [selected]=\"selectedContext && selectedContext.uri === context.uri\"\r\n        [context]=\"context\"\r\n        [default]=\"configService.getConfig('context') ? defaultContextId === context.id : defaultContextId === context.uri\"\r\n        (favorite)=\"favorite.emit(context)\"\r\n        (select)=\"select.emit(context)\"\r\n        (unselect)=\"unselect.emit(context)\">\r\n      </igo-context-item>\r\n    </ng-template>\r\n\r\n  </ng-template>\r\n</igo-list>\r\n","import {\r\n  Component,\r\n  Input,\r\n  Output,\r\n  EventEmitter,\r\n  ChangeDetectorRef,\r\n  OnInit,\r\n  ChangeDetectionStrategy,\r\n  OnDestroy\r\n} from '@angular/core';\r\n\r\nimport { AuthService } from '@igo2/auth';\r\nimport { ConfigService, LanguageService, StorageService } from '@igo2/core';\r\nimport type { IgoMap } from '@igo2/geo';\r\n\r\nimport {\r\n  DetailedContext,\r\n  ContextsList,\r\n  ContextUserPermission,\r\n  ContextProfils\r\n} from '../shared/context.interface';\r\nimport { ContextListControlsEnum } from './context-list.enum';\r\nimport {\r\n  Subscription,\r\n  BehaviorSubject,\r\n  ReplaySubject,\r\n  EMPTY,\r\n  timer\r\n} from 'rxjs';\r\nimport { take } from 'rxjs/operators';\r\n\r\nimport { MatDialog } from '@angular/material/dialog';\r\nimport { BookmarkDialogComponent } from '../../context-map-button/bookmark-button/bookmark-dialog.component';\r\nimport { debounce } from 'rxjs/operators';\r\nimport { ActionStore, ActionbarMode } from '@igo2/common';\r\nimport { ContextService } from '../shared/context.service';\r\n\r\n@Component({\r\n  selector: 'igo-context-list',\r\n  templateUrl: './context-list.component.html',\r\n  styleUrls: ['./context-list.component.scss'],\r\n  changeDetection: ChangeDetectionStrategy.OnPush\r\n})\r\nexport class ContextListComponent implements OnInit, OnDestroy {\r\n  private contextsInitial: ContextsList = { ours: [] };\r\n  contexts$: BehaviorSubject<ContextsList> = new BehaviorSubject(\r\n    this.contextsInitial\r\n  );\r\n\r\n  change$ = new ReplaySubject<void>(1);\r\n\r\n  private change$$: Subscription;\r\n\r\n  @Input()\r\n  get contexts(): ContextsList {\r\n    return this._contexts;\r\n  }\r\n  set contexts(value: ContextsList) {\r\n    this._contexts = value;\r\n    this.cdRef.detectChanges();\r\n    this.next();\r\n  }\r\n  private _contexts: ContextsList = { ours: [] };\r\n\r\n  @Input()\r\n  get selectedContext(): DetailedContext {\r\n    return this._selectedContext;\r\n  }\r\n  set selectedContext(value: DetailedContext) {\r\n    this._selectedContext = value;\r\n    this.cdRef.detectChanges();\r\n  }\r\n  private _selectedContext: DetailedContext;\r\n\r\n  @Input()\r\n  get map(): IgoMap {\r\n    return this._map;\r\n  }\r\n  set map(value: IgoMap) {\r\n    this._map = value;\r\n  }\r\n  private _map: IgoMap;\r\n\r\n  @Input()\r\n  get defaultContextId(): string {\r\n    return this.configService.getConfig('context') ? this._defaultContextId :\r\n      this.storageService.get('favorite.context.uri') as string || this._defaultContextId;\r\n  }\r\n  set defaultContextId(value: string) {\r\n    this._defaultContextId = value;\r\n  }\r\n  private _defaultContextId: string;\r\n\r\n  public collapsed: { contextScope }[] = [];\r\n\r\n  @Output() select = new EventEmitter<DetailedContext>();\r\n  @Output() unselect = new EventEmitter<DetailedContext>();\r\n  @Output() edit = new EventEmitter<DetailedContext>();\r\n  @Output() delete = new EventEmitter<DetailedContext>();\r\n  @Output() save = new EventEmitter<DetailedContext>();\r\n  @Output() clone = new EventEmitter<DetailedContext>();\r\n  @Output() create = new EventEmitter<{ title: string; empty: boolean }>();\r\n  @Output() hide = new EventEmitter<DetailedContext>();\r\n  @Output() show = new EventEmitter<DetailedContext>();\r\n  @Output() showHiddenContexts = new EventEmitter<boolean>();\r\n  @Output() favorite = new EventEmitter<DetailedContext>();\r\n  @Output() managePermissions = new EventEmitter<DetailedContext>();\r\n  @Output() manageTools = new EventEmitter<DetailedContext>();\r\n  @Output() filterPermissionsChanged = new EventEmitter<\r\n    ContextUserPermission[]\r\n  >();\r\n\r\n  public titleMapping = {\r\n    ours: 'igo.context.contextManager.ourContexts',\r\n    shared: 'igo.context.contextManager.sharedContexts',\r\n    public: 'igo.context.contextManager.publicContexts'\r\n  };\r\n\r\n  public users: ContextProfils[];\r\n  public permissions: ContextUserPermission[] = [];\r\n\r\n  public actionStore = new ActionStore([]);\r\n  public actionbarMode = ActionbarMode.Overlay;\r\n\r\n  public color = 'primary';\r\n\r\n  public showHidden = false;\r\n\r\n  /**\r\n   * Context filter term\r\n   */\r\n  @Input()\r\n  set term(value: string) {\r\n    this._term = value;\r\n    this.next();\r\n  }\r\n  get term(): string {\r\n    return this._term;\r\n  }\r\n  public _term: string = '';\r\n\r\n  get sortedAlpha(): boolean {\r\n    return this._sortedAlpha;\r\n  }\r\n  set sortedAlpha(value: boolean) {\r\n    this._sortedAlpha = value;\r\n    this.next();\r\n  }\r\n  private _sortedAlpha: boolean = undefined;\r\n\r\n  public showContextFilter = ContextListControlsEnum.always;\r\n\r\n  public thresholdToFilter = 5;\r\n\r\n  constructor(\r\n    private cdRef: ChangeDetectorRef,\r\n    private contextService: ContextService,\r\n    public configService: ConfigService,\r\n    public auth: AuthService,\r\n    private dialog: MatDialog,\r\n    private languageService: LanguageService,\r\n    private storageService: StorageService\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.change$$ = this.change$\r\n      .pipe(\r\n        debounce(() => {\r\n          return this.contexts.ours.length === 0 ? EMPTY : timer(50);\r\n        })\r\n      )\r\n      .subscribe(() => {\r\n        this.contexts$.next(this.filterContextsList(this.contexts));\r\n      });\r\n\r\n    this.actionStore.load([\r\n      {\r\n        id: 'emptyContext',\r\n        title: this.languageService.translate.instant(\r\n          'igo.context.contextManager.emptyContext'\r\n        ),\r\n        icon: 'map-outline',\r\n        tooltip: this.languageService.translate.instant(\r\n          'igo.context.contextManager.emptyContextTooltip'\r\n        ),\r\n        handler: () => {\r\n          this.createContext(true);\r\n        }\r\n      },\r\n      {\r\n        id: 'contextFromMap',\r\n        title: this.languageService.translate.instant(\r\n          'igo.context.contextManager.contextMap'\r\n        ),\r\n        icon: 'map-check',\r\n        tooltip: this.languageService.translate.instant(\r\n          'igo.context.contextManager.contextMapTooltip'\r\n        ),\r\n        handler: () => {\r\n          this.createContext(false);\r\n        }\r\n      }\r\n    ]);\r\n  }\r\n\r\n  private next() {\r\n    this.change$.next();\r\n  }\r\n\r\n  private filterContextsList(contexts: ContextsList) {\r\n    if (this.term === '') {\r\n      if (this.sortedAlpha) {\r\n        contexts = this.sortContextsList(contexts);\r\n      }\r\n      return contexts;\r\n    } else {\r\n      const ours = contexts.ours.filter((context) => {\r\n        const filterNormalized = this.term\r\n          .toLowerCase()\r\n          .normalize('NFD')\r\n          .replace(/[\\u0300-\\u036f]/g, '');\r\n        const contextTitleNormalized = context.title\r\n          .toLowerCase()\r\n          .normalize('NFD')\r\n          .replace(/[\\u0300-\\u036f]/g, '');\r\n        return contextTitleNormalized.includes(filterNormalized);\r\n      });\r\n\r\n      let updateContexts: ContextsList = {\r\n        ours\r\n      };\r\n\r\n      if (this.contexts.public) {\r\n        const publics = contexts.public.filter((context) => {\r\n          const filterNormalized = this.term\r\n            .toLowerCase()\r\n            .normalize('NFD')\r\n            .replace(/[\\u0300-\\u036f]/g, '');\r\n          const contextTitleNormalized = context.title\r\n            .toLowerCase()\r\n            .normalize('NFD')\r\n            .replace(/[\\u0300-\\u036f]/g, '');\r\n          return contextTitleNormalized.includes(filterNormalized);\r\n        });\r\n        updateContexts.public = publics;\r\n      }\r\n\r\n      if (this.contexts.shared) {\r\n        const shared = contexts.shared.filter((context) => {\r\n          const filterNormalized = this.term\r\n            .toLowerCase()\r\n            .normalize('NFD')\r\n            .replace(/[\\u0300-\\u036f]/g, '');\r\n          const contextTitleNormalized = context.title\r\n            .toLowerCase()\r\n            .normalize('NFD')\r\n            .replace(/[\\u0300-\\u036f]/g, '');\r\n          return contextTitleNormalized.includes(filterNormalized);\r\n        });\r\n        updateContexts.shared = shared;\r\n      }\r\n\r\n      if (this.sortedAlpha) {\r\n        updateContexts = this.sortContextsList(updateContexts);\r\n      }\r\n      return updateContexts;\r\n    }\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.change$$.unsubscribe();\r\n  }\r\n\r\n  public showFilter() {\r\n    switch (this.showContextFilter) {\r\n      case ContextListControlsEnum.always:\r\n        return true;\r\n      case ContextListControlsEnum.never:\r\n        return false;\r\n      default:\r\n        let totalLength = this.contexts.ours.length;\r\n        this.contexts.public\r\n          ? (totalLength += this.contexts.public.length)\r\n          : (totalLength += 0);\r\n        this.contexts.shared\r\n          ? (totalLength += this.contexts.shared.length)\r\n          : (totalLength += 0);\r\n        if (totalLength >= this.thresholdToFilter) {\r\n          return true;\r\n        }\r\n        return false;\r\n    }\r\n  }\r\n\r\n  sortContextsList(contexts: ContextsList) {\r\n    if (contexts) {\r\n      const contextsList = JSON.parse(JSON.stringify(contexts));\r\n      contextsList.ours.sort((a, b) => {\r\n        if (this.normalize(a.title) < this.normalize(b.title)) {\r\n          return -1;\r\n        }\r\n        if (this.normalize(a.title) > this.normalize(b.title)) {\r\n          return 1;\r\n        }\r\n        return 0;\r\n      });\r\n\r\n      if (contextsList.shared) {\r\n        contextsList.shared.sort((a, b) => {\r\n          if (this.normalize(a.title) < this.normalize(b.title)) {\r\n            return -1;\r\n          }\r\n          if (this.normalize(a.title) > this.normalize(b.title)) {\r\n            return 1;\r\n          }\r\n          return 0;\r\n        });\r\n      } else if (contextsList.public) {\r\n        contextsList.public.sort((a, b) => {\r\n          if (this.normalize(a.title) < this.normalize(b.title)) {\r\n            return -1;\r\n          }\r\n          if (this.normalize(a.title) > this.normalize(b.title)) {\r\n            return 1;\r\n          }\r\n          return 0;\r\n        });\r\n      }\r\n      return contextsList;\r\n    }\r\n  }\r\n\r\n  normalize(str: string) {\r\n    return str\r\n      .normalize('NFD')\r\n      .replace(/[\\u0300-\\u036f]/g, '')\r\n      .toLowerCase();\r\n  }\r\n\r\n  toggleSort(sortAlpha: boolean) {\r\n    this.sortedAlpha = sortAlpha;\r\n  }\r\n\r\n  clearFilter() {\r\n    this.term = '';\r\n  }\r\n\r\n  createContext(empty?: boolean) {\r\n    this.dialog\r\n      .open(BookmarkDialogComponent, { disableClose: false })\r\n      .afterClosed()\r\n      .pipe(take(1))\r\n      .subscribe((title: string) => {\r\n        if (title) {\r\n          this.create.emit({ title, empty });\r\n        }\r\n      });\r\n  }\r\n\r\n  getPermission(user?): ContextUserPermission {\r\n    if (user) {\r\n      const permission = this.permissions.find((p) => p.name === user.name);\r\n      return permission;\r\n    }\r\n  }\r\n\r\n  userSelection(user, parent?) {\r\n    const permission = this.getPermission(user);\r\n    if (permission) {\r\n      permission.checked = !permission.checked;\r\n      this.storageService.set(\r\n        'contexts.permissions.' + permission.name,\r\n        permission.checked\r\n      );\r\n      permission.indeterminate = false;\r\n    }\r\n\r\n    if (parent) {\r\n      let indeterminate = false;\r\n\r\n      for (const c of parent.childs) {\r\n        const cPermission = this.getPermission(c);\r\n        if (cPermission.checked !== permission.checked) {\r\n          indeterminate = true;\r\n          break;\r\n        }\r\n      }\r\n      const parentPermission = this.getPermission(parent);\r\n      if (parentPermission) {\r\n        parentPermission.checked = permission.checked;\r\n        this.storageService.set(\r\n          'contexts.permissions.' + parentPermission.name,\r\n          permission.checked\r\n        );\r\n        parentPermission.indeterminate = indeterminate;\r\n      }\r\n    }\r\n\r\n    if (user.childs) {\r\n      for (const c of user.childs) {\r\n        const childrenPermission = this.getPermission(c);\r\n        if (\r\n          childrenPermission &&\r\n          childrenPermission.checked !== permission.checked\r\n        ) {\r\n          childrenPermission.checked = permission.checked;\r\n          this.storageService.set(\r\n            'contexts.permissions.' + childrenPermission.name,\r\n            permission.checked\r\n          );\r\n        }\r\n      }\r\n    }\r\n\r\n    this.filterPermissionsChanged.emit(this.permissions);\r\n  }\r\n\r\n  hideContext(context: DetailedContext) {\r\n    context.hidden = true;\r\n    if (!this.showHidden) {\r\n      const contexts: ContextsList = { ours: [], shared: [], public: [] };\r\n      contexts.ours = this.contexts.ours.filter((c) => c.id !== context.id);\r\n      contexts.shared = this.contexts.shared.filter((c) => c.id !== context.id);\r\n      contexts.public = this.contexts.public.filter((c) => c.id !== context.id);\r\n      this.contexts = contexts;\r\n    }\r\n    this.hide.emit(context);\r\n  }\r\n\r\n  showContext(context: DetailedContext) {\r\n    context.hidden = false;\r\n    this.show.emit(context);\r\n  }\r\n}\r\n","import {\r\n  Directive,\r\n  Self,\r\n  OnInit,\r\n  OnDestroy,\r\n  HostListener,\r\n  ChangeDetectorRef\r\n} from '@angular/core';\r\nimport { Subscription } from 'rxjs';\r\nimport { debounceTime } from 'rxjs/operators';\r\n\r\nimport { MessageService, LanguageService, StorageService } from '@igo2/core';\r\nimport { AuthService } from '@igo2/auth';\r\nimport { ConfirmDialogService } from '@igo2/common';\r\nimport { MapService } from '@igo2/geo';\r\n\r\nimport {\r\n  Context,\r\n  DetailedContext,\r\n  ContextsList,\r\n  ContextUserPermission\r\n} from '../shared/context.interface';\r\nimport { ContextService } from '../shared/context.service';\r\nimport { ContextListComponent } from './context-list.component';\r\n\r\n@Directive({\r\n  selector: '[igoContextListBinding]'\r\n})\r\nexport class ContextListBindingDirective implements OnInit, OnDestroy {\r\n  private component: ContextListComponent;\r\n  private contexts$$: Subscription;\r\n  private selectedContext$$: Subscription;\r\n  private defaultContextId$$: Subscription;\r\n  private previousMessageId;\r\n\r\n  @HostListener('select', ['$event'])\r\n  onSelect(context: Context) {\r\n    this.contextService.loadContext(context.uri);\r\n  }\r\n\r\n  @HostListener('edit', ['$event'])\r\n  onEdit(context: Context) {\r\n    this.contextService.loadEditedContext(context.uri);\r\n  }\r\n\r\n  @HostListener('save', ['$event'])\r\n  onSave(context: Context) {\r\n    const map = this.mapService.getMap();\r\n    const contextFromMap = this.contextService.getContextFromMap(map);\r\n\r\n    const msgSuccess = () => {\r\n      const translate = this.languageService.translate;\r\n      const message = translate.instant(\r\n        'igo.context.contextManager.dialog.saveMsg',\r\n        {\r\n          value: context.title\r\n        }\r\n      );\r\n      const title = translate.instant(\r\n        'igo.context.contextManager.dialog.saveTitle'\r\n      );\r\n      this.messageService.success(message, title);\r\n    };\r\n\r\n    if (context.imported) {\r\n      contextFromMap.title = context.title;\r\n      this.contextService.delete(context.id, true);\r\n      this.contextService.create(contextFromMap).subscribe((contextCreated) => {\r\n        this.contextService.loadContext(contextCreated.uri);\r\n        msgSuccess();\r\n      });\r\n      return;\r\n    }\r\n\r\n    const changes: any = {\r\n      layers: contextFromMap.layers,\r\n      map: {\r\n        view: contextFromMap.map.view\r\n      }\r\n    };\r\n\r\n    this.contextService.update(context.id, changes).subscribe(() => {\r\n      msgSuccess();\r\n    });\r\n  }\r\n\r\n  @HostListener('favorite', ['$event'])\r\n  onFavorite(context: Context) {\r\n    if (!context.id) {\r\n      context.id = context.uri;\r\n    }\r\n    this.contextService.setDefault(context.id).subscribe(() => {\r\n      if (this.previousMessageId) {\r\n        this.messageService.remove(this.previousMessageId);\r\n      }\r\n      this.contextService.defaultContextId$.next(context.id);\r\n      const translate = this.languageService.translate;\r\n      const message = translate.instant(\r\n        'igo.context.contextManager.dialog.favoriteMsg',\r\n        {\r\n          value: context.title\r\n        }\r\n      );\r\n      const title = translate.instant(\r\n        'igo.context.contextManager.dialog.favoriteTitle'\r\n      );\r\n      const messageObj = this.messageService.success(message, title);\r\n      this.previousMessageId = messageObj.toastId;\r\n      this.cdRef.detectChanges();\r\n    });\r\n  }\r\n\r\n  @HostListener('manageTools', ['$event'])\r\n  onManageTools(context: Context) {\r\n    this.contextService.loadEditedContext(context.uri);\r\n  }\r\n\r\n  @HostListener('managePermissions', ['$event'])\r\n  onManagePermissions(context: Context) {\r\n    this.contextService.loadEditedContext(context.uri);\r\n  }\r\n\r\n  @HostListener('delete', ['$event'])\r\n  onDelete(context: Context) {\r\n    const translate = this.languageService.translate;\r\n    this.confirmDialogService\r\n      .open(\r\n        translate.instant('igo.context.contextManager.dialog.confirmDelete')\r\n      )\r\n      .subscribe((confirm) => {\r\n        if (confirm) {\r\n          this.contextService\r\n            .delete(context.id, context.imported)\r\n            .subscribe(() => {\r\n              const message = translate.instant(\r\n                'igo.context.contextManager.dialog.deleteMsg',\r\n                {\r\n                  value: context.title\r\n                }\r\n              );\r\n              const title = translate.instant(\r\n                'igo.context.contextManager.dialog.deleteTitle'\r\n              );\r\n              this.messageService.info(message, title);\r\n            });\r\n        }\r\n      });\r\n  }\r\n\r\n  @HostListener('clone', ['$event'])\r\n  onClone(context: DetailedContext) {\r\n    const properties = {\r\n      title: context.title + '-copy',\r\n      uri: context.uri + '-copy'\r\n    };\r\n    this.contextService.clone(context.id, properties).subscribe(() => {\r\n      const translate = this.languageService.translate;\r\n      const message = translate.instant(\r\n        'igo.context.contextManager.dialog.cloneMsg',\r\n        {\r\n          value: context.title\r\n        }\r\n      );\r\n      const title = translate.instant(\r\n        'igo.context.contextManager.dialog.cloneTitle'\r\n      );\r\n      this.messageService.success(message, title);\r\n    });\r\n  }\r\n\r\n  @HostListener('create', ['$event'])\r\n  onCreate(opts: { title: string; empty: boolean }) {\r\n    const { title, empty } = opts;\r\n    const context = this.contextService.getContextFromMap(\r\n      this.component.map,\r\n      empty\r\n    );\r\n    context.title = title;\r\n    this.contextService.create(context).subscribe(() => {\r\n      const translate = this.languageService.translate;\r\n      const titleD = translate.instant(\r\n        'igo.context.bookmarkButton.dialog.createTitle'\r\n      );\r\n      const message = translate.instant(\r\n        'igo.context.bookmarkButton.dialog.createMsg',\r\n        {\r\n          value: context.title\r\n        }\r\n      );\r\n      this.messageService.success(message, titleD);\r\n      this.contextService.loadContext(context.uri);\r\n    });\r\n  }\r\n\r\n  @HostListener('filterPermissionsChanged')\r\n  loadContexts() {\r\n    const permissions = ['none'];\r\n    for (const p of this.component.permissions) {\r\n      if (p.checked === true || p.indeterminate === true) {\r\n        permissions.push(p.name);\r\n      }\r\n    }\r\n    this.component.showHidden\r\n      ? this.contextService.loadContexts(permissions, true)\r\n      : this.contextService.loadContexts(permissions, false);\r\n  }\r\n\r\n  @HostListener('showHiddenContexts')\r\n  showHiddenContexts() {\r\n    this.component.showHidden = !this.component.showHidden;\r\n    this.storageService.set('contexts.showHidden', this.component.showHidden);\r\n    this.loadContexts();\r\n  }\r\n\r\n  @HostListener('show', ['$event'])\r\n  onShowContext(context: DetailedContext) {\r\n    this.contextService.showContext(context.id).subscribe();\r\n  }\r\n\r\n  @HostListener('hide', ['$event'])\r\n  onHideContext(context: DetailedContext) {\r\n    this.contextService.hideContext(context.id).subscribe();\r\n  }\r\n\r\n  constructor(\r\n    @Self() component: ContextListComponent,\r\n    private contextService: ContextService,\r\n    private mapService: MapService,\r\n    private languageService: LanguageService,\r\n    private confirmDialogService: ConfirmDialogService,\r\n    private messageService: MessageService,\r\n    private auth: AuthService,\r\n    private storageService: StorageService,\r\n    private cdRef: ChangeDetectorRef\r\n  ) {\r\n    this.component = component;\r\n  }\r\n\r\n  ngOnInit() {\r\n    // Override input contexts\r\n    this.component.contexts = { ours: [] };\r\n    this.component.showHidden = this.storageService.get(\r\n      'contexts.showHidden'\r\n    ) as boolean;\r\n\r\n    this.contexts$$ = this.contextService.contexts$.subscribe((contexts) =>\r\n      this.handleContextsChange(contexts)\r\n    );\r\n\r\n    this.defaultContextId$$ = this.contextService.defaultContextId$.subscribe(\r\n      (id) => {\r\n        this.component.defaultContextId = id;\r\n      }\r\n    );\r\n    const storedContextUri = this.storageService.get('favorite.context.uri') as string;\r\n    if (storedContextUri && !this.auth.authenticated) {\r\n      this.contextService.defaultContextId$.next(storedContextUri);\r\n    }\r\n\r\n    // See feature-list.component for an explanation about the debounce time\r\n    this.selectedContext$$ = this.contextService.context$\r\n      .pipe(debounceTime(100))\r\n      .subscribe((context) => (this.component.selectedContext = context));\r\n\r\n    this.auth.authenticate$.subscribe((authenticate) => {\r\n      if (authenticate) {\r\n        this.contextService.getProfilByUser().subscribe((profils) => {\r\n          this.component.users = profils;\r\n          this.component.permissions = [];\r\n          const profilsAcc = this.component.users.reduce((acc, cur) => {\r\n            acc = acc.concat(cur);\r\n            acc = cur.childs ? acc.concat(cur.childs) : acc;\r\n            return acc;\r\n          }, []);\r\n\r\n          for (const user of profilsAcc) {\r\n            const permission: ContextUserPermission = {\r\n              name: user.name,\r\n              checked: this.storageService.get(\r\n                'contexts.permissions.' + user.name\r\n              ) as boolean\r\n            };\r\n            if (permission.checked === null) {\r\n              permission.checked = true;\r\n            }\r\n            this.component.permissions.push(permission);\r\n          }\r\n\r\n          const permissions = ['none'];\r\n          for (const p of this.component.permissions) {\r\n            if (p.checked === true || p.indeterminate === true) {\r\n              permissions.push(p.name);\r\n            }\r\n          }\r\n\r\n          this.component.showHidden\r\n            ? this.contextService.loadContexts(permissions, true)\r\n            : this.contextService.loadContexts(permissions, false);\r\n        });\r\n      }\r\n    });\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.contexts$$.unsubscribe();\r\n    this.selectedContext$$.unsubscribe();\r\n    this.defaultContextId$$.unsubscribe();\r\n  }\r\n\r\n  private handleContextsChange(contexts: ContextsList) {\r\n    this.component.contexts = contexts;\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\nimport { HttpClient } from '@angular/common/http';\r\nimport { Observable, EMPTY } from 'rxjs';\r\n\r\nimport { ConfigService } from '@igo2/core';\r\nimport { Poi } from './poi.interface';\r\n\r\n@Injectable()\r\nexport class PoiService {\r\n  private baseUrl: string;\r\n\r\n  constructor(private http: HttpClient, private config: ConfigService) {\r\n    this.baseUrl = this.config.getConfig('context.url');\r\n  }\r\n\r\n  get(): Observable<Poi[]> {\r\n    if (!this.baseUrl) {\r\n      return EMPTY;\r\n    }\r\n\r\n    const url = this.baseUrl + '/pois';\r\n    return this.http.get<Poi[]>(url);\r\n  }\r\n\r\n  delete(id: string): Observable<void> {\r\n    const url = this.baseUrl + '/pois/' + id;\r\n    return this.http.delete<void>(url);\r\n  }\r\n\r\n  create(context: Poi): Observable<Poi> {\r\n    const url = this.baseUrl + '/pois';\r\n    return this.http.post<Poi>(url, context);\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatOptionModule } from '@angular/material/core';\r\nimport { MatDialogModule } from '@angular/material/dialog';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatSelectModule } from '@angular/material/select';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoConfirmDialogModule, IgoStopPropagationModule } from '@igo2/common';\r\nimport { IgoAuthModule } from '@igo2/auth';\r\n\r\nimport { BookmarkButtonComponent } from './bookmark-button/bookmark-button.component';\r\nimport { BookmarkDialogComponent } from './bookmark-button/bookmark-dialog.component';\r\nimport { PoiButtonComponent } from './poi-button/poi-button.component';\r\nimport { PoiDialogComponent } from './poi-button/poi-dialog.component';\r\nimport { PoiService } from './poi-button/shared/poi.service';\r\nimport { UserDialogComponent } from './user-button/user-dialog.component';\r\nimport { UserButtonComponent } from './user-button/user-button.component';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    IgoLanguageModule,\r\n    IgoConfirmDialogModule,\r\n    IgoStopPropagationModule,\r\n    IgoAuthModule,\r\n    FormsModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatSelectModule,\r\n    MatOptionModule,\r\n    MatTooltipModule,\r\n    MatFormFieldModule,\r\n    MatDialogModule,\r\n    MatInputModule\r\n  ],\r\n  exports: [BookmarkButtonComponent, PoiButtonComponent, UserButtonComponent, BookmarkDialogComponent],\r\n  declarations: [\r\n    BookmarkButtonComponent,\r\n    BookmarkDialogComponent,\r\n    PoiButtonComponent,\r\n    PoiDialogComponent,\r\n    UserButtonComponent,\r\n    UserDialogComponent\r\n  ],\r\n  providers: [PoiService]\r\n})\r\nexport class IgoContextMapButtonModule {\r\n  static forRoot(): ModuleWithProviders<IgoContextMapButtonModule> {\r\n    return {\r\n      ngModule: IgoContextMapButtonModule\r\n    };\r\n  }\r\n}\r\n","import { NgModule, ModuleWithProviders } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule, ReactiveFormsModule } from '@angular/forms';\r\nimport { MatAutocompleteModule } from '@angular/material/autocomplete';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCheckboxModule } from '@angular/material/checkbox';\r\nimport { MatOptionModule } from '@angular/material/core';\r\nimport { MatDialogModule } from '@angular/material/dialog';\r\nimport { MatFormFieldModule } from '@angular/material/form-field';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatInputModule } from '@angular/material/input';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatMenuModule } from '@angular/material/menu';\r\nimport { MatRadioModule } from '@angular/material/radio';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoAuthModule } from '@igo2/auth';\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport {\r\n  IgoListModule,\r\n  IgoKeyValueModule,\r\n  IgoCollapsibleModule,\r\n  IgoStopPropagationModule,\r\n  IgoActionbarModule\r\n} from '@igo2/common';\r\n\r\nimport { MapContextDirective } from './shared/map-context.directive';\r\nimport { LayerContextDirective } from './shared/layer-context.directive';\r\nimport { ContextListComponent } from './context-list/context-list.component';\r\nimport { ContextListBindingDirective } from './context-list/context-list-binding.directive';\r\nimport { ContextItemComponent } from './context-item/context-item.component';\r\nimport { ContextFormComponent } from './context-form/context-form.component';\r\nimport { ContextEditComponent } from './context-edit/context-edit.component';\r\nimport { ContextEditBindingDirective } from './context-edit/context-edit-binding.directive';\r\nimport { ContextPermissionsComponent } from './context-permissions/context-permissions.component';\r\nimport { ContextPermissionsBindingDirective } from './context-permissions/context-permissions-binding.directive';\r\nimport { IgoContextMapButtonModule } from '../context-map-button/context-map-button.module';\r\nimport { IgoContextImportExportModule } from '../context-import-export/context-import-export.module';\r\n\r\nconst CONTEXT_DIRECTIVES = [\r\n  MapContextDirective,\r\n  LayerContextDirective\r\n];\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    ReactiveFormsModule,\r\n    MatFormFieldModule,\r\n    MatInputModule,\r\n    MatIconModule,\r\n    MatButtonModule,\r\n    MatTooltipModule,\r\n    MatListModule,\r\n    MatCheckboxModule,\r\n    MatRadioModule,\r\n    MatDialogModule,\r\n    MatMenuModule,\r\n    MatOptionModule,\r\n    MatAutocompleteModule,\r\n    IgoAuthModule,\r\n    IgoListModule,\r\n    IgoKeyValueModule,\r\n    IgoCollapsibleModule,\r\n    IgoStopPropagationModule,\r\n    IgoLanguageModule,\r\n    IgoContextImportExportModule,\r\n    IgoContextMapButtonModule,\r\n    IgoActionbarModule\r\n  ],\r\n  exports: [\r\n    ContextListComponent,\r\n    ContextListBindingDirective,\r\n    ContextItemComponent,\r\n    ContextFormComponent,\r\n    ContextEditComponent,\r\n    ContextEditBindingDirective,\r\n    ContextPermissionsComponent,\r\n    ContextPermissionsBindingDirective,\r\n\r\n    ...CONTEXT_DIRECTIVES\r\n  ],\r\n  declarations: [\r\n    ContextListComponent,\r\n    ContextListBindingDirective,\r\n    ContextItemComponent,\r\n    ContextFormComponent,\r\n    ContextEditComponent,\r\n    ContextEditBindingDirective,\r\n    ContextPermissionsComponent,\r\n    ContextPermissionsBindingDirective,\r\n\r\n    ...CONTEXT_DIRECTIVES\r\n  ]\r\n})\r\nexport class IgoContextManagerModule {\r\n  static forRoot(): ModuleWithProviders<IgoContextManagerModule> {\r\n    return {\r\n      ngModule: IgoContextManagerModule\r\n    };\r\n  }\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport { ExportOptions } from '@igo2/geo';\r\n\r\nexport enum ImportExportType {\r\n  layer = 'layer',\r\n  context = 'context'\r\n}\r\n\r\nexport enum ImportExportMode {\r\n  import = 'import',\r\n  export = 'export'\r\n}\r\n\r\n/**\r\n * Service that holds the state of the importExport module\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ImportExportState {\r\n\r\n  readonly importExportType$: BehaviorSubject<ImportExportType> = new BehaviorSubject(ImportExportType.layer);\r\n  readonly selectedMode$: BehaviorSubject<ImportExportMode> = new BehaviorSubject(ImportExportMode.import);\r\n  readonly exportOptions$: BehaviorSubject<ExportOptions> = new BehaviorSubject(undefined);\r\n\r\n  setImportExportType(type: ImportExportType) {\r\n    this.importExportType$.next(type);\r\n  }\r\n\r\n  setMode(mode: ImportExportMode) {\r\n    this.selectedMode$.next(mode);\r\n  }\r\n\r\n  setsExportOptions(exportOptions: ExportOptions) {\r\n      this.exportOptions$.next(exportOptions);\r\n    }\r\n\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { Toolbox, ToolService } from '@igo2/common';\r\n\r\nimport { ExportOptions } from '@igo2/geo';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport { ImportExportMode, ImportExportState } from '../import-export/import-export.state';\r\n\r\n/**\r\n * Service that holds the state of the search module\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class ToolState {\r\n  get toolbox(): Toolbox {\r\n    return this.toolService.toolbox;\r\n  }\r\n\r\n  public openSidenav$: BehaviorSubject<boolean> = new BehaviorSubject(undefined);\r\n\r\n  constructor(\r\n    private toolService: ToolService,\r\n    private importExportState: ImportExportState\r\n    ) {}\r\n\r\n    toolToActivateFromOptions(toolToActivate: { tool: string; options: {[key: string]: any} }) {\r\n    if (!toolToActivate) { return; }\r\n    if (toolToActivate.tool === 'importExport') {\r\n      let exportOptions: ExportOptions = this.importExportState.exportOptions$.value;\r\n      if (!exportOptions) {\r\n        exportOptions = {\r\n          layers: toolToActivate.options.layers,\r\n          featureInMapExtent: toolToActivate.options.featureInMapExtent\r\n        };\r\n      } else {\r\n        exportOptions.layers = toolToActivate.options.layers;\r\n        exportOptions.featureInMapExtent = toolToActivate.options.featureInMapExtent;\r\n      }\r\n      this.importExportState.setsExportOptions(exportOptions);\r\n      this.importExportState.setMode(ImportExportMode.export);\r\n    }\r\n\r\n    if (this.toolbox.getTool(toolToActivate.tool)) {\r\n      this.toolbox.activateTool(toolToActivate.tool);\r\n      this.openSidenav$.next(true);\r\n    }\r\n  }\r\n}\r\n","import {\r\n    FeatureMotion,\r\n    FeatureStoreSelectionStrategy,\r\n    FeatureWorkspace,\r\n    WfsWorkspace,\r\n    EditionWorkspace\r\n} from '@igo2/geo';\r\n\r\n\r\nexport function handleZoomAuto(workspace: FeatureWorkspace | WfsWorkspace | EditionWorkspace, storageService) {\r\n    const zoomStrategy = workspace.entityStore\r\n        .getStrategyOfType(FeatureStoreSelectionStrategy) as FeatureStoreSelectionStrategy;\r\n    zoomStrategy.setMotion(storageService.get('zoomAuto') as boolean ? FeatureMotion.Default : FeatureMotion.None);\r\n}\r\n\r\n\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { StorageService } from '@igo2/core';\r\n\r\n/**\r\n * Service that holds the state of storage service\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class StorageState {\r\n  get storageService(): StorageService {\r\n    return this.igoStorageService;\r\n  }\r\n\r\n  constructor(private igoStorageService: StorageService) {}\r\n}\r\n","import { Injectable, OnDestroy } from '@angular/core';\r\n\r\nimport {\r\n  Action,\r\n  EntityStoreFilterCustomFuncStrategy,\r\n  EntityStoreFilterSelectionStrategy\r\n} from '@igo2/common';\r\n\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport {\r\n  FeatureWorkspace,\r\n  mapExtentStrategyActiveToolTip,\r\n  noElementSelected,\r\n  ExportOptions\r\n} from '@igo2/geo';\r\nimport { StorageService, StorageServiceEvent, StorageServiceEventEnum, LanguageService, MediaService} from '@igo2/core';\r\nimport { StorageState } from '../../storage/storage.state';\r\nimport { map, skipWhile } from 'rxjs/operators';\r\nimport { ToolState } from '../../tool/tool.state';\r\nimport { handleZoomAuto } from './workspace.utils';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class FeatureActionsService implements OnDestroy {\r\n\r\n  public maximize$: BehaviorSubject<boolean> = new BehaviorSubject(\r\n    this.storageService.get('workspaceMaximize') as boolean\r\n  );\r\n\r\n  zoomAuto$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  private storageChange$$: Subscription;\r\n\r\n  get storageService(): StorageService {\r\n    return this.storageState.storageService;\r\n  }\r\n\r\n  get zoomAuto(): boolean {\r\n    return this.storageService.get('zoomAuto') as boolean;\r\n  }\r\n\r\n  constructor(\r\n    private storageState: StorageState,\r\n    public languageService: LanguageService,\r\n    private toolState: ToolState,\r\n    private mediaService: MediaService\r\n  ) {}\r\n\r\n  ngOnDestroy(): void {\r\n    if (this.storageChange$$) {\r\n      this.storageChange$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  loadActions(\r\n    workspace: FeatureWorkspace,\r\n    rowsInMapExtentCheckCondition$: BehaviorSubject<boolean>,\r\n    selectOnlyCheckCondition$: BehaviorSubject<boolean>\r\n    ) {\r\n    const actions = this.buildActions(\r\n      workspace,\r\n      rowsInMapExtentCheckCondition$,\r\n      selectOnlyCheckCondition$\r\n      );\r\n    workspace.actionStore.load(actions);\r\n  }\r\n\r\n  buildActions(\r\n    workspace: FeatureWorkspace,\r\n    rowsInMapExtentCheckCondition$: BehaviorSubject<boolean>,\r\n    selectOnlyCheckCondition$: BehaviorSubject<boolean>\r\n    ): Action[] {\r\n    this.zoomAuto$.next(this.zoomAuto);\r\n    this.storageChange$$ = this.storageService.storageChange$\r\n      .pipe(\r\n        skipWhile(\r\n          (storageChange: StorageServiceEvent) =>\r\n            storageChange.key !== 'zoomAuto' || storageChange.event === StorageServiceEventEnum.CLEARED\r\n        )\r\n      )\r\n      .subscribe(() => {\r\n        this.zoomAuto$.next(this.zoomAuto);\r\n        handleZoomAuto(workspace, this.storageService);\r\n      });\r\n    return [\r\n      {\r\n        id: 'zoomAuto',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.zoomAuto.title',\r\n        tooltip: 'igo.integration.workspace.zoomAuto.tooltip',\r\n        checkCondition: this.zoomAuto$,\r\n        handler: () => {\r\n          handleZoomAuto(workspace, this.storageService);\r\n          this.storageService.set(\r\n            'zoomAuto',\r\n            !this.storageService.get('zoomAuto') as boolean\r\n          );\r\n        }\r\n      },\r\n      {\r\n        id: 'filterInMapExtent',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.inMapExtent.title',\r\n        tooltip: mapExtentStrategyActiveToolTip(workspace),\r\n        checkCondition: rowsInMapExtentCheckCondition$,\r\n        handler: () => rowsInMapExtentCheckCondition$.next(!rowsInMapExtentCheckCondition$.value)\r\n      },\r\n      {\r\n        id: 'selectedOnly',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.selected.title',\r\n        tooltip: 'igo.integration.workspace.selected.tooltip',\r\n        checkCondition: selectOnlyCheckCondition$,\r\n        handler: () => selectOnlyCheckCondition$.next(!selectOnlyCheckCondition$.value)\r\n      },\r\n      {\r\n        id: 'clearselection',\r\n        icon: 'select-off',\r\n        title: 'igo.integration.workspace.clearSelection.title',\r\n        tooltip: 'igo.integration.workspace.clearSelection.tooltip',\r\n        handler: (ws: FeatureWorkspace) => {\r\n          ws.entityStore.state.updateMany(ws.entityStore.view.all(), {\r\n            selected: false\r\n          });\r\n        },\r\n        args: [workspace],\r\n        availability: (ws: FeatureWorkspace) => noElementSelected(ws)\r\n      },\r\n      {\r\n        id: 'featureDownload',\r\n        icon: 'file-export',\r\n        title: 'igo.integration.workspace.download.title',\r\n        tooltip: 'igo.integration.workspace.download.tooltip',\r\n        handler: (ws: FeatureWorkspace) => {\r\n          const filterStrategy = ws.entityStore.getStrategyOfType(\r\n            EntityStoreFilterCustomFuncStrategy\r\n          );\r\n          const filterSelectionStrategy = ws.entityStore.getStrategyOfType(\r\n            EntityStoreFilterSelectionStrategy\r\n          );\r\n          const layersWithSelection = filterSelectionStrategy.active\r\n            ? [ws.layer.id]\r\n            : [];\r\n          this.toolState.toolToActivateFromOptions({\r\n            tool: 'importExport',\r\n            options: {\r\n              layers: [ws.layer.id],\r\n              featureInMapExtent: filterStrategy.active,\r\n              layersWithSelection\r\n            } as ExportOptions\r\n          });\r\n        },\r\n        args: [workspace]\r\n      },\r\n      {\r\n        id: 'maximize',\r\n        title: this.languageService.translate.instant('igo.integration.workspace.maximize'),\r\n        tooltip: this.languageService.translate.instant(\r\n          'igo.integration.workspace.maximizeTooltip'\r\n        ),\r\n        icon: 'resize',\r\n        display: () => {\r\n          return this.maximize$.pipe(map((v) => !v && !this.mediaService.isMobile()));\r\n        },\r\n        handler: () => {\r\n          if (!this.mediaService.isMobile()) {\r\n            this.maximize$.next(true);\r\n          }\r\n        },\r\n      },\r\n      {\r\n        id: 'standardExtent',\r\n        title: this.languageService.translate.instant(\r\n          'igo.integration.workspace.standardExtent'\r\n        ),\r\n        tooltip: this.languageService.translate.instant(\r\n          'igo.integration.workspace.standardExtentTooltip'\r\n        ),\r\n        icon: 'resize',\r\n        display: () => {\r\n          return this.maximize$.pipe(map((v) => v && !this.mediaService.isMobile()));\r\n        },\r\n        handler: () => {\r\n          this.maximize$.next(false);\r\n        }\r\n      }\r\n    ];\r\n  }\r\n}\r\n","import { Inject, Injectable, OnDestroy } from '@angular/core';\r\n\r\nimport {\r\n  Action,\r\n  EntityStoreFilterCustomFuncStrategy,\r\n  EntityStoreFilterSelectionStrategy,\r\n  Widget\r\n} from '@igo2/common';\r\n\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport {\r\n  WfsWorkspace,\r\n  mapExtentStrategyActiveToolTip,\r\n  noElementSelected,\r\n  ExportOptions,\r\n  OgcFilterWidget,\r\n  OgcFilterableDataSource,\r\n} from '@igo2/geo';\r\nimport { StorageService, StorageServiceEvent, StorageServiceEventEnum, LanguageService, MediaService} from '@igo2/core';\r\nimport { StorageState } from '../../storage/storage.state';\r\nimport { map, skipWhile } from 'rxjs/operators';\r\nimport { ToolState } from '../../tool/tool.state';\r\nimport { handleZoomAuto } from './workspace.utils';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class WfsActionsService implements OnDestroy {\r\n\r\n  public maximize$: BehaviorSubject<boolean> = new BehaviorSubject(\r\n    this.storageService.get('workspaceMaximize') as boolean\r\n  );\r\n\r\n  selectOnlyCheckCondition$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  // rowsInMapExtentCheckCondition$: BehaviorSubject<boolean> = new BehaviorSubject(true);\r\n  zoomAuto$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  private storageChange$$: Subscription;\r\n\r\n  get storageService(): StorageService {\r\n    return this.storageState.storageService;\r\n  }\r\n\r\n  get zoomAuto(): boolean {\r\n    return this.storageService.get('zoomAuto') as boolean;\r\n  }\r\n\r\n  constructor(\r\n    @Inject(OgcFilterWidget) private ogcFilterWidget: Widget,\r\n    private storageState: StorageState,\r\n    public languageService: LanguageService,\r\n    private mediaService: MediaService,\r\n    private toolState: ToolState) {}\r\n\r\n  ngOnDestroy(): void {\r\n    if (this.storageChange$$) {\r\n      this.storageChange$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  loadActions(\r\n    workspace: WfsWorkspace,\r\n    rowsInMapExtentCheckCondition$: BehaviorSubject<boolean>,\r\n    selectOnlyCheckCondition$: BehaviorSubject<boolean>\r\n    ) {\r\n    const actions = this.buildActions(\r\n      workspace,\r\n      rowsInMapExtentCheckCondition$,\r\n      selectOnlyCheckCondition$\r\n      );\r\n    workspace.actionStore.load(actions);\r\n  }\r\n\r\n  buildActions(\r\n    workspace: WfsWorkspace,\r\n    rowsInMapExtentCheckCondition$: BehaviorSubject<boolean>,\r\n    selectOnlyCheckCondition$: BehaviorSubject<boolean>\r\n    ): Action[] {\r\n    this.zoomAuto$.next(this.zoomAuto);\r\n    this.storageChange$$ = this.storageService.storageChange$\r\n      .pipe(skipWhile((storageChange: StorageServiceEvent) =>\r\n        storageChange?.key !== 'zoomAuto' || storageChange?.event === StorageServiceEventEnum.CLEARED))\r\n      .subscribe(() => {\r\n        this.zoomAuto$.next(this.zoomAuto);\r\n        handleZoomAuto(workspace, this.storageService);\r\n      });\r\n    const actions = [\r\n      {\r\n        id: 'zoomAuto',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.zoomAuto.title',\r\n        tooltip: 'igo.integration.workspace.zoomAuto.tooltip',\r\n        checkCondition: this.zoomAuto$,\r\n        handler: () => {\r\n          handleZoomAuto(workspace, this.storageService);\r\n          this.storageService.set('zoomAuto', !this.storageService.get('zoomAuto') as boolean);\r\n        }\r\n      },\r\n      {\r\n        id: 'filterInMapExtent',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.inMapExtent.title',\r\n        tooltip: mapExtentStrategyActiveToolTip(workspace),\r\n        checkCondition: rowsInMapExtentCheckCondition$,\r\n        handler: () => rowsInMapExtentCheckCondition$.next(!rowsInMapExtentCheckCondition$.value)\r\n      },\r\n      {\r\n        id: 'selectedOnly',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.selected.title',\r\n        tooltip: 'igo.integration.workspace.selected.title',\r\n        checkCondition: selectOnlyCheckCondition$,\r\n        handler: () => selectOnlyCheckCondition$.next(!selectOnlyCheckCondition$.value)\r\n      },\r\n      {\r\n        id: 'clearselection',\r\n        icon: 'select-off',\r\n        title: 'igo.integration.workspace.clearSelection.title',\r\n        tooltip: 'igo.integration.workspace.clearSelection.tooltip',\r\n        handler: (ws: WfsWorkspace) => {\r\n          ws.entityStore.state.updateMany(ws.entityStore.view.all(), { selected: false });\r\n        },\r\n        args: [workspace],\r\n        availability: (ws: WfsWorkspace) => noElementSelected(ws)\r\n      },\r\n      {\r\n        id: 'wfsDownload',\r\n        icon: 'file-export',\r\n        title: 'igo.integration.workspace.download.title',\r\n        tooltip: 'igo.integration.workspace.download.tooltip',\r\n        handler: (ws: WfsWorkspace) => {\r\n          const filterStrategy = ws.entityStore.getStrategyOfType(EntityStoreFilterCustomFuncStrategy);\r\n          const filterSelectionStrategy = ws.entityStore.getStrategyOfType(EntityStoreFilterSelectionStrategy);\r\n          const layersWithSelection = filterSelectionStrategy.active ? [ws.layer.id] : [];\r\n          this.toolState.toolToActivateFromOptions({\r\n            tool: 'importExport',\r\n            options: { layers: [ws.layer.id], featureInMapExtent: filterStrategy.active, layersWithSelection } as ExportOptions\r\n          });\r\n        },\r\n        args: [workspace]\r\n      },\r\n      {\r\n        id: 'ogcFilter',\r\n        icon: 'filter',\r\n        title: 'igo.integration.workspace.ogcFilter.title',\r\n        tooltip: 'igo.integration.workspace.ogcFilter.tooltip',\r\n        handler: (widget: Widget, ws: WfsWorkspace) => {\r\n          ws.activateWidget(widget, {\r\n            map: ws.map,\r\n            layer: ws.layer\r\n          });\r\n        },\r\n        args: [this.ogcFilterWidget, workspace]\r\n      },\r\n      {\r\n        id: 'maximize',\r\n        title: this.languageService.translate.instant('igo.integration.workspace.maximize'),\r\n        tooltip: this.languageService.translate.instant(\r\n          'igo.integration.workspace.maximizeTooltip'\r\n        ),\r\n        icon: 'resize',\r\n        display: () => {\r\n          return this.maximize$.pipe(map((v) => !v && !this.mediaService.isMobile()));\r\n        },\r\n        handler: () => {\r\n          if (!this.mediaService.isMobile()) {\r\n            this.maximize$.next(true);\r\n          }\r\n        },\r\n      },\r\n      {\r\n        id: 'standardExtent',\r\n        title: this.languageService.translate.instant(\r\n          'igo.integration.workspace.standardExtent'\r\n        ),\r\n        tooltip: this.languageService.translate.instant(\r\n          'igo.integration.workspace.standardExtentTooltip'\r\n        ),\r\n        icon: 'resize',\r\n        display: () => {\r\n          return this.maximize$.pipe(map((v) => v && !this.mediaService.isMobile()));\r\n        },\r\n        handler: () => {\r\n          this.maximize$.next(false);\r\n        }\r\n      }\r\n    ];\r\n    return (workspace.layer.dataSource as OgcFilterableDataSource).ogcFilters$?.value?.enabled ?\r\n    actions : actions.filter(action => action.id !== 'ogcFilter');\r\n  }\r\n}\r\n","import { Inject, Injectable, OnDestroy } from '@angular/core';\r\n\r\nimport {\r\n  Action,\r\n  EntityStoreFilterCustomFuncStrategy,\r\n  EntityStoreFilterSelectionStrategy,\r\n  Widget\r\n} from '@igo2/common';\r\n\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\nimport {\r\n  EditionWorkspace,\r\n  mapExtentStrategyActiveToolTip,\r\n  noElementSelected,\r\n  ExportOptions,\r\n  OgcFilterWidget,\r\n  OgcFilterableDataSource,\r\n} from '@igo2/geo';\r\nimport { StorageService, StorageServiceEvent, StorageServiceEventEnum, LanguageService, MediaService} from '@igo2/core';\r\nimport { StorageState } from '../../storage/storage.state';\r\nimport { map, skipWhile } from 'rxjs/operators';\r\nimport { ToolState } from '../../tool/tool.state';\r\nimport { handleZoomAuto } from './workspace.utils';\r\n\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class EditionActionsService implements OnDestroy {\r\n\r\n  public maximize$: BehaviorSubject<boolean> = new BehaviorSubject(\r\n    this.storageService.get('workspaceMaximize') as boolean\r\n  );\r\n\r\n  zoomAuto$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  private storageChange$$: Subscription;\r\n\r\n  get storageService(): StorageService {\r\n    return this.storageState.storageService;\r\n  }\r\n\r\n  get zoomAuto(): boolean {\r\n    return this.storageService.get('zoomAuto') as boolean;\r\n  }\r\n\r\n  constructor(\r\n    @Inject(OgcFilterWidget) private ogcFilterWidget: Widget,\r\n    private storageState: StorageState,\r\n    public languageService: LanguageService,\r\n    private mediaService: MediaService,\r\n    private toolState: ToolState) {}\r\n\r\n  ngOnDestroy(): void {\r\n    if (this.storageChange$$) {\r\n      this.storageChange$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  loadActions(\r\n    workspace: EditionWorkspace,\r\n    rowsInMapExtentCheckCondition$: BehaviorSubject<boolean>,\r\n    selectOnlyCheckCondition$: BehaviorSubject<boolean>\r\n    ) {\r\n    const actions = this.buildActions(\r\n      workspace,\r\n      rowsInMapExtentCheckCondition$,\r\n      selectOnlyCheckCondition$\r\n      );\r\n    workspace.actionStore.load(actions);\r\n  }\r\n\r\n  buildActions(\r\n    workspace: EditionWorkspace,\r\n    rowsInMapExtentCheckCondition$: BehaviorSubject<boolean>,\r\n    selectOnlyCheckCondition$: BehaviorSubject<boolean>\r\n    ): Action[] {\r\n    this.zoomAuto$.next(this.zoomAuto);\r\n    this.storageChange$$ = this.storageService.storageChange$\r\n      .pipe(skipWhile((storageChange: StorageServiceEvent) =>\r\n        storageChange?.key !== 'zoomAuto' || storageChange?.event === StorageServiceEventEnum.CLEARED))\r\n      .subscribe(() => {\r\n        this.zoomAuto$.next(this.zoomAuto);\r\n        handleZoomAuto(workspace, this.storageService);\r\n      });\r\n    const actions = [\r\n      {\r\n        id: 'zoomAuto',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.zoomAuto.title',\r\n        tooltip: 'igo.integration.workspace.zoomAuto.tooltip',\r\n        checkCondition: this.zoomAuto$,\r\n        handler: () => {\r\n          handleZoomAuto(workspace, this.storageService);\r\n          this.storageService.set('zoomAuto', !this.storageService.get('zoomAuto') as boolean);\r\n        }\r\n      },\r\n      {\r\n        id: 'filterInMapExtent',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.inMapExtent.title',\r\n        tooltip: mapExtentStrategyActiveToolTip(workspace),\r\n        checkCondition: rowsInMapExtentCheckCondition$,\r\n        handler: () => rowsInMapExtentCheckCondition$.next(!rowsInMapExtentCheckCondition$.value)\r\n      },\r\n      {\r\n        id: 'selectedOnly',\r\n        checkbox: true,\r\n        title: 'igo.integration.workspace.selected.title',\r\n        tooltip: 'igo.integration.workspace.selected.title',\r\n        checkCondition: selectOnlyCheckCondition$,\r\n        handler: () => selectOnlyCheckCondition$.next(!selectOnlyCheckCondition$.value)\r\n      },\r\n      {\r\n        id: 'clearselection',\r\n        icon: 'select-off',\r\n        title: 'igo.integration.workspace.clearSelection.title',\r\n        tooltip: 'igo.integration.workspace.clearSelection.tooltip',\r\n        handler: (ws: EditionWorkspace) => {\r\n          ws.entityStore.state.updateMany(ws.entityStore.view.all(), { selected: false });\r\n        },\r\n        args: [workspace],\r\n        availability: (ws: EditionWorkspace) => noElementSelected(ws)\r\n      },\r\n      {\r\n        id: 'wfsDownload',\r\n        icon: 'file-export',\r\n        title: 'igo.integration.workspace.download.title',\r\n        tooltip: 'igo.integration.workspace.download.tooltip',\r\n        handler: (ws: EditionWorkspace) => {\r\n          const filterStrategy = ws.entityStore.getStrategyOfType(EntityStoreFilterCustomFuncStrategy);\r\n          const filterSelectionStrategy = ws.entityStore.getStrategyOfType(EntityStoreFilterSelectionStrategy);\r\n          const layersWithSelection = filterSelectionStrategy.active ? [ws.layer.id] : [];\r\n          this.toolState.toolToActivateFromOptions({\r\n            tool: 'importExport',\r\n            options: { layers: [ws.layer.id], featureInMapExtent: filterStrategy.active, layersWithSelection } as ExportOptions\r\n          });\r\n        },\r\n        args: [workspace]\r\n      },\r\n      {\r\n        id: 'ogcFilter',\r\n        icon: 'filter',\r\n        title: 'igo.integration.workspace.ogcFilter.title',\r\n        tooltip: 'igo.integration.workspace.ogcFilter.tooltip',\r\n        handler: (widget: Widget, ws: EditionWorkspace) => {\r\n          ws.activateWidget(widget, {\r\n            map: ws.map,\r\n            layer: ws.layer\r\n          });\r\n        },\r\n        args: [this.ogcFilterWidget, workspace]\r\n      },\r\n      {\r\n        id: 'maximize',\r\n        title: this.languageService.translate.instant('igo.integration.workspace.maximize'),\r\n        tooltip: this.languageService.translate.instant(\r\n          'igo.integration.workspace.maximizeTooltip'\r\n        ),\r\n        icon: 'resize',\r\n        display: () => {\r\n          return this.maximize$.pipe(map((v) => !v && !this.mediaService.isMobile()));\r\n        },\r\n        handler: () => {\r\n          if (!this.mediaService.isMobile()) {\r\n            this.maximize$.next(true);\r\n          }\r\n        },\r\n      },\r\n      {\r\n        id: 'standardExtent',\r\n        title: this.languageService.translate.instant(\r\n          'igo.integration.workspace.standardExtent'\r\n        ),\r\n        tooltip: this.languageService.translate.instant(\r\n          'igo.integration.workspace.standardExtentTooltip'\r\n        ),\r\n        icon: 'resize',\r\n        display: () => {\r\n          return this.maximize$.pipe(map((v) => v && !this.mediaService.isMobile()));\r\n        },\r\n        handler: () => {\r\n          this.maximize$.next(false);\r\n        }\r\n      }\r\n    ];\r\n    return (workspace.layer.dataSource as OgcFilterableDataSource).ogcFilters$?.value?.enabled ?\r\n    actions : actions.filter(action => action.id !== 'ogcFilter');\r\n  }\r\n}\r\n","import { Injectable, OnDestroy } from '@angular/core';\r\n\r\nimport { BehaviorSubject, Subscription, Observable, of } from 'rxjs';\r\n\r\nimport {\r\n  EntityRecord,\r\n  Workspace,\r\n  WorkspaceStore,\r\n  Widget,\r\n  EntityStoreFilterCustomFuncStrategy,\r\n  EntityStoreFilterSelectionStrategy,\r\n  EntityState } from '@igo2/common';\r\nimport { WfsWorkspace, FeatureWorkspace, EditionWorkspace } from '@igo2/geo';\r\nimport { FeatureActionsService } from './shared/feature-actions.service';\r\nimport { WfsActionsService } from './shared/wfs-actions.service';\r\nimport { StorageService } from '@igo2/core';\r\nimport { EditionActionsService } from './shared/edition-actions.service';\r\n\r\n/**\r\n * Service that holds the state of the workspace module\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class WorkspaceState implements OnDestroy {\r\n\r\n  public workspacePanelExpanded: boolean = false;\r\n\r\n  readonly workspaceEnabled$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(false);\r\n  readonly rowsInMapExtentCheckCondition$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(true);\r\n  readonly selectOnlyCheckCondition$: BehaviorSubject<boolean> = new BehaviorSubject<boolean>(false);\r\n\r\n  readonly workspaceMaximize$: BehaviorSubject<boolean> = new BehaviorSubject(\r\n    this.storageService.get('workspaceMaximize') as boolean\r\n  );\r\n  private actionMaximize$$: Subscription[] = [];\r\n\r\n  private rowsInMapExtentCheckCondition$$: Subscription;\r\n  private selectOnlyCheckCondition$$: Subscription;\r\n\r\n  /** Subscription to the active workspace */\r\n  private activeWorkspace$$: Subscription;\r\n\r\n  /** Subscription to the active workspace widget */\r\n  private activeWorkspaceWidget$$: Subscription;\r\n\r\n  /** Active widget observable. Only one may be active for all available workspaces */\r\n  readonly activeWorkspaceWidget$: BehaviorSubject<Widget> = new BehaviorSubject<Widget>(undefined);\r\n\r\n  /**\r\n   * Observable of the active workspace\r\n   */\r\n  public workspace$ = new BehaviorSubject<Workspace>(undefined);\r\n\r\n  /**\r\n   * Store that holds all the available workspaces\r\n   */\r\n  get store(): WorkspaceStore { return this._store; }\r\n  private _store: WorkspaceStore;\r\n\r\n  get workspaceSelection() {\r\n    if (this.workspace$.value) {\r\n    return this.workspace$.value?.entityStore.stateView.manyBy((r) => r.state.selected === true);\r\n    } else {\r\n      return [];\r\n    }\r\n  }\r\n\r\n  get workspaceSelection$(): Observable<EntityRecord<object, EntityState>[]> {\r\n    if (this.workspace$.value) {\r\n      return this.workspace$.value?.entityStore?.stateView.manyBy$((r) => r.state.selected === true);\r\n    } else {\r\n      return of([]);\r\n    }\r\n  }\r\n\r\n  constructor(\r\n    private featureActionsService: FeatureActionsService,\r\n    private wfsActionsService: WfsActionsService,\r\n    private editionActionsService: EditionActionsService,\r\n    private storageService: StorageService\r\n  ) {\r\n    this.initWorkspaces();\r\n  }\r\n\r\n  /**\r\n   * Initialize the workspace store. Each time a workspace is activated,\r\n   * subscribe to it's active widget. Tracking the active widget is useful\r\n   * to make sure only one widget is active at a time.\r\n   */\r\n  private initWorkspaces() {\r\n    this._store = new WorkspaceStore([]);\r\n    this._store.stateView\r\n      .firstBy$((record: EntityRecord<Workspace>) => record.state.active === true)\r\n      .subscribe((record: EntityRecord<Workspace>) => {\r\n        const workspace = record ? record.entity : undefined;\r\n        this.workspace$.next(workspace);\r\n      });\r\n\r\n    this._store.stateView.all$()\r\n    .subscribe((workspaces: EntityRecord<Workspace>[]) => {\r\n      workspaces.map((wks: EntityRecord<Workspace>) => {\r\n        if (wks.entity.actionStore.empty) {\r\n          if (wks.entity instanceof WfsWorkspace) {\r\n            this.wfsActionsService.loadActions(\r\n              wks.entity,\r\n              this.rowsInMapExtentCheckCondition$,\r\n              this.selectOnlyCheckCondition$);\r\n          } else if (wks.entity instanceof FeatureWorkspace) {\r\n            this.featureActionsService.loadActions(\r\n              wks.entity,\r\n              this.rowsInMapExtentCheckCondition$,\r\n              this.selectOnlyCheckCondition$);\r\n          } else if (wks.entity instanceof EditionWorkspace) {\r\n            this.editionActionsService.loadActions(\r\n              wks.entity,\r\n              this.rowsInMapExtentCheckCondition$,\r\n              this.selectOnlyCheckCondition$);\r\n          }\r\n        }\r\n\r\n      });\r\n    });\r\n\r\n    this.actionMaximize$$.push(this.featureActionsService.maximize$.subscribe(maximized => {\r\n      this.setWorkspaceIsMaximized(maximized);\r\n    }));\r\n\r\n    this.actionMaximize$$.push(this.wfsActionsService.maximize$.subscribe(maximized => {\r\n      this.setWorkspaceIsMaximized(maximized);\r\n    }));\r\n\r\n    this.actionMaximize$$.push(this.editionActionsService.maximize$.subscribe(maximized => {\r\n      this.setWorkspaceIsMaximized(maximized);\r\n    }));\r\n\r\n    this.activeWorkspace$$ = this.workspace$\r\n      .subscribe((workspace: Workspace) => {\r\n        if (this.activeWorkspaceWidget$$ !== undefined) {\r\n          this.activeWorkspaceWidget$$.unsubscribe();\r\n          this.activeWorkspaceWidget$$ = undefined;\r\n        }\r\n\r\n        if (workspace !== undefined) {\r\n          this.activeWorkspaceWidget$$ = workspace.widget$\r\n            .subscribe((widget: Widget) => this.activeWorkspaceWidget$.next(widget));\r\n        }\r\n      });\r\n\r\n    this.rowsInMapExtentCheckCondition$$ = this.rowsInMapExtentCheckCondition$.subscribe((rowsInMapExtent) => {\r\n      this._store.stateView.all().map((wks: EntityRecord<Workspace>) => {\r\n        if (!wks.entity.actionStore.empty) {\r\n          const filterStrategy = wks.entity.entityStore.getStrategyOfType(EntityStoreFilterCustomFuncStrategy);\r\n          if (filterStrategy) {\r\n            if (rowsInMapExtent) {\r\n              filterStrategy.activate();\r\n            } else {\r\n              filterStrategy.deactivate();\r\n            }\r\n          }\r\n        }\r\n      });\r\n    });\r\n\r\n    this.selectOnlyCheckCondition$$ = this.selectOnlyCheckCondition$.subscribe((selectOnly) => {\r\n      this._store.stateView.all().map((wks: EntityRecord<Workspace>) => {\r\n        if (!wks.entity.actionStore.empty) {\r\n          const filterStrategy = wks.entity.entityStore.getStrategyOfType(EntityStoreFilterSelectionStrategy);\r\n          if (filterStrategy) {\r\n            if (selectOnly) {\r\n              filterStrategy.activate();\r\n            } else {\r\n              filterStrategy.deactivate();\r\n            }\r\n          }\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  private setWorkspaceIsMaximized(maximized: boolean) {\r\n    this.storageService.set('workspaceMaximize', maximized);\r\n    this.workspaceMaximize$.next(maximized);\r\n  }\r\n\r\n  public setActiveWorkspaceById(id: string) {\r\n    const wksFromId = this.store\r\n    .all()\r\n    .find(workspace => workspace.id === id);\r\n    if (wksFromId) {\r\n      this.store.activateWorkspace(wksFromId);\r\n    }\r\n  }\r\n\r\n  public setActiveWorkspaceByTitle(title: string) {\r\n    const wksFromTitle = this.store\r\n      .all()\r\n      .find(workspace => workspace.title === title);\r\n    if (wksFromTitle) {\r\n      this.store.activateWorkspace(wksFromTitle);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Teardown all the workspaces\r\n   * @internal\r\n   */\r\n  ngOnDestroy() {\r\n    this.teardownWorkspaces();\r\n    this.actionMaximize$$.map(a => a.unsubscribe());\r\n    if (this.rowsInMapExtentCheckCondition$$) {\r\n      this.selectOnlyCheckCondition$$.unsubscribe();\r\n    }\r\n    if (this.selectOnlyCheckCondition$$) {\r\n      this.selectOnlyCheckCondition$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Teardown the workspace store and any subscribers\r\n   */\r\n  private teardownWorkspaces() {\r\n    this.store.clear();\r\n    if (this.activeWorkspaceWidget$$ !== undefined) {\r\n      this.activeWorkspaceWidget$$.unsubscribe();\r\n    }\r\n    if (this.activeWorkspace$$ !== undefined) {\r\n      this.activeWorkspace$$.unsubscribe();\r\n    }\r\n  }\r\n\r\n}\r\n","import { Injectable } from '@angular/core';\r\n\r\nimport { EntityRecord, EntityStore, EntityStoreFilterCustomFuncStrategy, EntityStoreStrategyFuncOptions } from '@igo2/common';\r\nimport { ConfigService, StorageService } from '@igo2/core';\r\nimport { SearchResult, SearchSourceService, SearchSource, CommonVectorStyleOptions } from '@igo2/geo';\r\nimport { BehaviorSubject, Subscription } from 'rxjs';\r\n\r\n/**\r\n * Service that holds the state of the search module\r\n */\r\n@Injectable({\r\n  providedIn: 'root'\r\n})\r\nexport class SearchState {\r\n  public searchOverlayStyle: CommonVectorStyleOptions = {};\r\n  public searchOverlayStyleSelection: CommonVectorStyleOptions = {};\r\n  public searchOverlayStyleFocus: CommonVectorStyleOptions = {};\r\n\r\n  public focusedOrResolution$$: Subscription;\r\n  public selectedOrResolution$$: Subscription;\r\n\r\n  readonly searchTermSplitter$: BehaviorSubject<string> = new BehaviorSubject('|');\r\n\r\n  readonly searchTerm$: BehaviorSubject<string> = new BehaviorSubject(undefined);\r\n\r\n  readonly searchType$: BehaviorSubject<string> = new BehaviorSubject(undefined);\r\n\r\n  readonly searchDisabled$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  readonly searchResultsGeometryEnabled$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n\r\n  readonly searchSettingsChange$: BehaviorSubject<boolean> = new BehaviorSubject(undefined);\r\n\r\n  readonly selectedResult$: BehaviorSubject<SearchResult> = new BehaviorSubject(undefined);\r\n\r\n  /**\r\n   * Store that holds the search results\r\n   */\r\n  readonly store: EntityStore<SearchResult> = new EntityStore<SearchResult>([]);\r\n\r\n  /**\r\n   * Search types currently enabled in the search source service\r\n   */\r\n  get searchTypes(): string[] {\r\n    return this.searchSourceService\r\n      .getEnabledSources()\r\n      .map((source: SearchSource) => (source.constructor as any).type);\r\n  }\r\n\r\n  constructor(\r\n    private searchSourceService: SearchSourceService,\r\n    private storageService: StorageService,\r\n    private configService: ConfigService) {\r\n    const searchOverlayStyle = this.configService.getConfig('searchOverlayStyle') as {\r\n      base?: CommonVectorStyleOptions,\r\n      selection?: CommonVectorStyleOptions,\r\n      focus?: CommonVectorStyleOptions\r\n    };\r\n    if (searchOverlayStyle) {\r\n      this.searchOverlayStyle = searchOverlayStyle.base;\r\n      this.searchOverlayStyleSelection = searchOverlayStyle.selection;\r\n      this.searchOverlayStyleFocus = searchOverlayStyle.focus;\r\n    }\r\n\r\n    const searchResultsGeometryEnabled = this.storageService.get('searchResultsGeometryEnabled') as boolean;\r\n    if (searchResultsGeometryEnabled) {\r\n      this.searchResultsGeometryEnabled$.next(searchResultsGeometryEnabled);\r\n    }\r\n    this.store.addStrategy(this.createCustomFilterTermStrategy(), false);\r\n  }\r\n\r\n  private createCustomFilterTermStrategy(): EntityStoreFilterCustomFuncStrategy {\r\n    const filterClauseFunc = (record: EntityRecord<SearchResult>) => {\r\n      return record.entity.meta.score === 100;\r\n    };\r\n    return new EntityStoreFilterCustomFuncStrategy({filterClauseFunc} as EntityStoreStrategyFuncOptions);\r\n  }\r\n\r\n  /**\r\n   * Activate custom strategy\r\n   *\r\n   */\r\n  activateCustomFilterTermStrategy() {\r\n    const strategy = this.store.getStrategyOfType(EntityStoreFilterCustomFuncStrategy);\r\n    if (strategy !== undefined) {\r\n      strategy.activate();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Deactivate custom strategy\r\n   *\r\n   */\r\n  deactivateCustomFilterTermStrategy() {\r\n    const strategy = this.store.getStrategyOfType(EntityStoreFilterCustomFuncStrategy);\r\n    if (strategy !== undefined) {\r\n      strategy.deactivate();\r\n    }\r\n  }\r\n\r\n  enableSearch() {\r\n    this.searchDisabled$.next(false);\r\n  }\r\n\r\n  disableSearch() {\r\n    this.searchDisabled$.next(true);\r\n  }\r\n\r\n  setSearchTerm(searchTerm: string) {\r\n    this.searchTerm$.next(searchTerm);\r\n  }\r\n\r\n  setSearchType(searchType: string) {\r\n    this.searchSourceService.enableSourcesByType(searchType);\r\n    this.searchType$.next(searchType);\r\n  }\r\n\r\n  setSearchSettingsChange() {\r\n    this.searchSettingsChange$.next(true);\r\n  }\r\n\r\n  setSelectedResult(result: SearchResult) {\r\n    this.selectedResult$.next(result);\r\n  }\r\n\r\n  setSearchResultsGeometryStatus(value) {\r\n    this.storageService.set('searchResultsGeometryEnabled', value);\r\n    this.searchResultsGeometryEnabled$.next(value);\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\n\r\nimport { IgoSearchModule } from '@igo2/geo';\r\n\r\nimport { SearchBarBindingDirective } from './search-bar-binding.directive';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [IgoSearchModule],\r\n  declarations: [SearchBarBindingDirective],\r\n  exports: [SearchBarBindingDirective],\r\n})\r\nexport class IgoAppSearchBarModule {}\r\n","import { NgModule, CUSTOM_ELEMENTS_SCHEMA } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatBadgeModule } from '@angular/material/badge';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoLanguageModule } from '@igo2/core';\r\nimport { IgoFlexibleModule, IgoCustomHtmlModule, IgoPanelModule } from '@igo2/common';\r\nimport {\r\n  IgoFeatureModule,\r\n  IgoSearchModule,\r\n  IgoFeatureDetailsModule\r\n} from '@igo2/geo';\r\n\r\nimport { SearchResultsToolComponent } from './search-results-tool.component';\r\n\r\n/**\r\n * @ignore\r\n */\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    MatIconModule,\r\n    MatBadgeModule,\r\n    MatTooltipModule,\r\n    MatButtonModule,\r\n    IgoLanguageModule,\r\n    IgoFeatureModule,\r\n    IgoSearchModule,\r\n    IgoFlexibleModule,\r\n    IgoPanelModule,\r\n    IgoFeatureDetailsModule,\r\n    IgoCustomHtmlModule\r\n  ],\r\n  declarations: [SearchResultsToolComponent],\r\n  exports: [SearchResultsToolComponent],\r\n  schemas: [CUSTOM_ELEMENTS_SCHEMA]\r\n})\r\nexport class IgoAppSearchResultsToolModule {}\r\n","import { NgModule } from '@angular/core';\r\n\r\nimport { IgoAppSearchBarModule } from './search-bar/search-bar.module';\r\nimport { IgoAppSearchResultsToolModule } from './search-results-tool/search-results-tool.module';\r\n\r\n@NgModule({\r\n  imports: [],\r\n  declarations: [],\r\n  exports: [\r\n   IgoAppSearchBarModule,\r\n   IgoAppSearchResultsToolModule\r\n  ],\r\n})\r\nexport class IgoAppSearchModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Search</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: ConfigService, LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/search\">code of this example</a><br>\r\n    See search section of the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/environments\"> environment config</a>\r\n    <hr>\r\n    <br>\r\n    <span *ngIf=\"!isTouchScreen\" title=\"Details\">\r\n      F2 activate/deactivate the pointer location.\r\n    </span>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser #mapBrowser [map]=\"map\" [view]=\"view\" igoOverlay [igoContextMenu]=actionbarMenu\r\n\r\n    igoSearchPointerSummary\r\n    [igoSearchPointerSummaryDelay]=\"500\"\r\n    [igoSearchPointerSummaryEnabled]=\"igoSearchPointerSummaryEnabled\"\r\n    (menuPosition)=\"onContextMenuOpen($event)\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Search\">\r\n    <igo-search-bar\r\n      (pointerSummaryStatus)=\"onPointerSummaryStatusChange($event)\"\r\n      [searchSettings]=\"true\"\r\n      [store]=\"searchStore\"\r\n      [termSplitter]=\"termSplitter\"\r\n      (searchTermChange)=\"onSearchTermChange($event)\"\r\n      (search)=\"onSearch($event)\"\r\n      (clearFeature)=\"removeFeatureFromMap()\"\r\n      (searchSettingsChange)=\"onSearchSettingsChange()\">\r\n    </igo-search-bar>\r\n\r\n    <igo-search-results\r\n      [store]=\"searchStore\"\r\n      [term]=\"term\"\r\n      [termSplitter]=\"termSplitter\"\r\n      placeholder=\"false\"\r\n      [settingsChange$]=\"settingsChange$\"\r\n      (resultFocus)=\"onResultFocus($event)\"\r\n      (resultSelect)=\"onResultFocus($event)\"\r\n      (moreResults)=\"onSearch($event)\">\r\n        <ng-template #igoSearchItemToolbar let-result=\"result\">\r\n          <igo-search-add-button\r\n            [map]=\"map\"\r\n            [layer]=\"result\">\r\n          </igo-search-add-button>\r\n        </ng-template>\r\n    </igo-search-results>\r\n\r\n  </igo-panel>\r\n\r\n  <igo-panel *ngIf=\"selectedFeature\" title=\"Details\">\r\n    <igo-feature-details [feature]=\"selectedFeature\"></igo-feature-details>\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n\r\n<ng-template #actionbarMenu>\r\n  <igo-actionbar\r\n    [store]=\"store\"\r\n    [withIcon]=\"false\"\r\n    [horizontal]=\"true\"\r\n    [mode]=\"'context'\">\r\n  </igo-actionbar>\r\n</ng-template>\r\n\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppSearchComponent } from './search.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'search',\r\n    component: AppSearchComponent\r\n  }\r\n];\r\n\r\nexport const AppSearchRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { BehaviorSubject } from 'rxjs';\r\nimport {\r\n  Component,\r\n  ElementRef,\r\n  OnDestroy,\r\n  OnInit,\r\n  ViewChild\r\n} from '@angular/core';\r\nimport * as proj from 'ol/proj';\r\n\r\nimport { LanguageService, MediaService } from '@igo2/core';\r\nimport { EntityStore, ActionStore } from '@igo2/common';\r\nimport {\r\n  FEATURE,\r\n  Feature,\r\n  FeatureMotion,\r\n  GoogleLinks,\r\n  IgoMap,\r\n  LayerService,\r\n  MapService,\r\n  Layer,\r\n  ProjectionService,\r\n  Research,\r\n  SearchResult,\r\n  SearchService\r\n} from '@igo2/geo';\r\n\r\nimport { SearchState } from '@igo2/integration';\r\n\r\n@Component({\r\n  selector: 'app-search',\r\n  templateUrl: './search.component.html',\r\n  styleUrls: ['./search.component.scss']\r\n})\r\nexport class AppSearchComponent implements OnInit, OnDestroy {\r\n  public store = new ActionStore([]);\r\n\r\n  public igoSearchPointerSummaryEnabled: boolean = false;\r\n\r\n  public termSplitter: string = '|';\r\n\r\n  public map = new IgoMap({\r\n    overlay: true,\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 7\r\n  };\r\n\r\n  public osmLayer: Layer;\r\n\r\n  @ViewChild('mapBrowser', { read: ElementRef, static: true }) mapBrowser: ElementRef;\r\n\r\n  public lonlat;\r\n  public mapProjection: string;\r\n  public term: string;\r\n\r\n  public settingsChange$ = new BehaviorSubject<boolean>(undefined);\r\n\r\n  get searchStore(): EntityStore<SearchResult> {\r\n    return this.searchState.store;\r\n  }\r\n\r\n  get isTouchScreen(): boolean {\r\n    return this.mediaService.isTouchScreen();\r\n  }\r\n\r\n  public selectedFeature: Feature;\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private projectionService: ProjectionService,\r\n    private mapService: MapService,\r\n    private layerService: LayerService,\r\n    private searchState: SearchState,\r\n    private searchService: SearchService,\r\n    private mediaService: MediaService\r\n  ) {\r\n    this.mapService.setMap(this.map);\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'OSM',\r\n        sourceOptions: {\r\n          type: 'osm'\r\n        }\r\n      })\r\n      .subscribe(layer => {\r\n        this.osmLayer = layer;\r\n        this.map.addLayer(layer);\r\n      });\r\n  }\r\n\r\n  onPointerSummaryStatusChange(value) {\r\n    this.igoSearchPointerSummaryEnabled = value;\r\n  }\r\n\r\n  onSearchTermChange(term = '') {\r\n    this.term = term;\r\n    const termWithoutHashtag = term.replace(/(#[^\\s]*)/g, '').trim();\r\n    if (termWithoutHashtag.length < 2) {\r\n      this.searchStore.clear();\r\n      this.selectedFeature = undefined;\r\n    }\r\n  }\r\n\r\n  onSearch(event: { research: Research; results: SearchResult[] }) {\r\n    const results = event.results;\r\n    this.searchStore.state.updateAll({ focused: false, selected: false });\r\n    const newResults = this.searchStore.entities$.value\r\n      .filter((result: SearchResult) => result.source !== event.research.source)\r\n      .concat(results);\r\n    this.searchStore.updateMany(newResults);\r\n  }\r\n\r\n  onSearchSettingsChange() {\r\n    this.settingsChange$.next(true);\r\n  }\r\n\r\n  /**\r\n   * Try to add a feature to the map when it's being focused\r\n   * @internal\r\n   * @param result A search result that could be a feature\r\n   */\r\n  onResultFocus(result: SearchResult) {\r\n    this.tryAddFeatureToMap(result);\r\n    this.selectedFeature = (result as SearchResult<Feature>).data;\r\n  }\r\n\r\n  /**\r\n   * Try to add a feature to the map overlay\r\n   * @param layer A search result that could be a feature\r\n   */\r\n  private tryAddFeatureToMap(layer: SearchResult) {\r\n    if (layer.meta.dataType !== FEATURE) {\r\n      return undefined;\r\n    }\r\n\r\n    // Somethimes features have no geometry. It happens with some GetFeatureInfo\r\n    if (layer.data.geometry === undefined) {\r\n      return;\r\n    }\r\n\r\n    this.map.searchResultsOverlay.setFeatures(\r\n      [layer.data] as Feature[],\r\n      FeatureMotion.Default\r\n    );\r\n  }\r\n\r\n  ngOnInit() {\r\n    this.store.load([\r\n      {\r\n        id: 'coordinates',\r\n        title: 'coordinates',\r\n        handler: this.onSearchCoordinate.bind(this)\r\n      },\r\n      {\r\n        id: 'googleMaps',\r\n        title: 'googleMap',\r\n        handler: this.onOpenGoogleMaps.bind(this),\r\n        args: ['1']\r\n      },\r\n      {\r\n        id: 'googleStreetView',\r\n        title: 'googleStreetView',\r\n        handler: this.onOpenGoogleStreetView.bind(this)\r\n      }\r\n    ]);\r\n  }\r\n\r\n  ngOnDestroy() {\r\n    this.store.destroy();\r\n  }\r\n\r\n  /*\r\n   * Remove a feature to the map overlay\r\n   */\r\n  removeFeatureFromMap() {\r\n    this.map.searchResultsOverlay.clear();\r\n  }\r\n\r\n  onContextMenuOpen(event: { x: number; y: number }) {\r\n    const position = this.mapPosition(event);\r\n    const coord = this.mapService.getMap().ol.getCoordinateFromPixel(position);\r\n    this.mapProjection = this.mapService.getMap().projection;\r\n    this.lonlat = proj.transform(coord, this.mapProjection, 'EPSG:4326');\r\n  }\r\n\r\n  mapPosition(event: { x: number; y: number }) {\r\n    const contextmenuPoint = event;\r\n    contextmenuPoint.y =\r\n      contextmenuPoint.y -\r\n      this.mapBrowser.nativeElement.getBoundingClientRect().top +\r\n      window.scrollY;\r\n    contextmenuPoint.x =\r\n      contextmenuPoint.x -\r\n      this.mapBrowser.nativeElement.getBoundingClientRect().left +\r\n      window.scrollX;\r\n    const position = [contextmenuPoint.x, contextmenuPoint.y];\r\n    return position;\r\n  }\r\n\r\n  onPointerSearch(event) {\r\n    this.lonlat = event;\r\n    this.onSearchCoordinate();\r\n  }\r\n\r\n  onSearchCoordinate() {\r\n    this.searchStore.clear();\r\n    const results = this.searchService.reverseSearch(this.lonlat);\r\n\r\n    for (const i in results) {\r\n      if (results.length > 0) {\r\n        results[i].request.subscribe((_results: SearchResult<Feature>[]) => {\r\n          this.onSearch({ research: results[i], results: _results });\r\n        });\r\n      }\r\n    }\r\n  }\r\n\r\n  onOpenGoogleMaps() {\r\n    window.open(GoogleLinks.getGoogleMapsCoordLink(this.lonlat[0], this.lonlat[1]));\r\n  }\r\n\r\n  onOpenGoogleStreetView() {\r\n    window.open(\r\n      GoogleLinks.getGoogleStreetViewLink(this.lonlat[0], this.lonlat[1])\r\n    );\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\n\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { MatTooltipModule } from '@angular/material/tooltip';\r\n\r\nimport { IgoMessageModule } from '@igo2/core';\r\n\r\nimport {\r\n  IgoPanelModule,\r\n  IgoActionbarModule,\r\n  IgoContextMenuModule\r\n} from '@igo2/common';\r\n\r\nimport {\r\n  IgoFeatureModule,\r\n  IgoMapModule,\r\n  IgoSearchModule,\r\n  provideIChercheSearchSource,\r\n  provideILayerSearchSource,\r\n  provideNominatimSearchSource,\r\n  provideIChercheReverseSearchSource,\r\n  provideCoordinatesReverseSearchSource,\r\n  provideCadastreSearchSource,\r\n  provideStoredQueriesSearchSource,\r\n  provideStoredQueriesReverseSearchSource\r\n} from '@igo2/geo';\r\n\r\nimport { IgoAppSearchModule } from '@igo2/integration';\r\n\r\nimport { AppSearchComponent } from './search.component';\r\nimport { AppSearchRoutingModule } from './search-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppSearchComponent],\r\n  imports: [\r\n    CommonModule,\r\n    AppSearchRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    MatTooltipModule,\r\n    IgoMessageModule.forRoot(),\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoSearchModule.forRoot(),\r\n    IgoAppSearchModule,\r\n    IgoActionbarModule,\r\n    IgoContextMenuModule,\r\n    IgoFeatureModule\r\n  ],\r\n  exports: [AppSearchComponent],\r\n  providers: [\r\n    provideCoordinatesReverseSearchSource(),\r\n    provideCadastreSearchSource(),\r\n    provideIChercheSearchSource(),\r\n    provideILayerSearchSource(),\r\n    provideNominatimSearchSource(),\r\n    provideIChercheReverseSearchSource(),\r\n    provideStoredQueriesSearchSource(),\r\n    provideStoredQueriesReverseSearchSource()\r\n  ]\r\n})\r\nexport class AppSearchModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppPrintComponent } from './print.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'print',\r\n    component: AppPrintComponent\r\n  }\r\n];\r\n\r\nexport const AppPrintRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { IgoMap, LayerService } from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-print',\r\n  templateUrl: './print.component.html',\r\n  styleUrls: ['./print.component.scss']\r\n})\r\nexport class AppPrintComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: false\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 9\r\n  };\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private layerService: LayerService\r\n  ) {\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'Quebec Base Map',\r\n        sourceOptions: {\r\n          type: 'wmts',\r\n          url: 'https://geoegl.msp.gouv.qc.ca/apis/carto/wmts/1.0.0/wmts',\r\n          layer: 'carte_gouv_qc_ro',\r\n          matrixSet: 'EPSG_3857',\r\n          version: '1.3.0',\r\n          crossOrigin: 'anonymous',\r\n          attributions: \" <a href='http://www.droitauteur.gouv.qc.ca/copyright.php' target='_blank'><img src='https://geoegl.msp.gouv.qc.ca/gouvouvert/public/images/quebec/gouv_qc_logo.png' width='64' height='14'>Gouvernement du Qubec</a> / <a href='https://www.igouverte.org/' target='_blank'>IGO2</a>\"\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'School board',\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n          params: {\r\n            LAYERS: 'MELS_CS_ANGLO_S',\r\n            VERSION: '1.3.0'\r\n          },\r\n          crossOrigin: 'anonymous'\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n    //\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'Embacle',\r\n        sourceOptions: {\r\n          type: 'wms',\r\n          url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n          params: {\r\n            LAYERS: 'vg_observation_v_inondation_embacle_wmst',\r\n            VERSION: '1.3.0'\r\n          },\r\n          crossOrigin: 'anonymous'\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n\r\n    // this.layerService\r\n    //   .createAsyncLayer({\r\n    //     title: 'Geomet',\r\n    //     sourceOptions: {\r\n    //       type: 'wms',\r\n    //       url: 'http://geo.weather.gc.ca/geomet/?lang=fr',\r\n    //       params: {\r\n    //         LAYERS: 'RADAR_1KM_RDBR',\r\n    //         VERSION: '1.3.0'\r\n    //       },\r\n    //       crossOrigin: 'anonymous'\r\n    //     }\r\n    //   })\r\n    //   .subscribe(l => this.map.addLayer(l));\r\n\r\n    /*\r\n        //CORS error if activate (for test)\r\n        this.layerService\r\n          .createAsyncLayer({\r\n            title: 'Geomet',\r\n            sourceOptions: {\r\n              type: 'wms',\r\n              url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq?service=wms',\r\n              params: {\r\n                layers: 'swtq',\r\n                version: '1.3.0',\r\n              }\r\n            }\r\n          })\r\n          .subscribe(l => this.map.addLayer(l));\r\n    */\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Print</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/print\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n    <igo-geolocate-button [map]=\"map\" color=\"primary\"></igo-geolocate-button>\r\n    <igo-home-extent-button [map]=\"map\" color=\"primary\"></igo-home-extent-button>\r\n    <igo-rotation-button [map]=\"map\" [showIfNoRotation]=\"false\" color=\"primary\"></igo-rotation-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-print [map]=\"map\"></igo-print>\r\n\r\n</mat-card>\r\n\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMessageModule } from '@igo2/core';\r\nimport { IgoMapModule, IgoPrintModule } from '@igo2/geo';\r\n\r\nimport { AppPrintComponent } from './print.component';\r\nimport { AppPrintRoutingModule } from './print-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppPrintComponent],\r\n  imports: [\r\n    AppPrintRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoMessageModule,\r\n    IgoMapModule,\r\n    IgoPrintModule\r\n  ],\r\n  exports: [AppPrintComponent]\r\n})\r\nexport class AppPrintModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppImportExportComponent } from './import-export.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'import-export',\r\n    component: AppImportExportComponent\r\n  }\r\n];\r\n\r\nexport const AppImportExportRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { IgoMap, LayerService } from '@igo2/geo';\r\nimport { WorkspaceStore } from '@igo2/common';\r\n\r\n@Component({\r\n  selector: 'app-import-export',\r\n  templateUrl: './import-export.component.html',\r\n  styleUrls: ['./import-export.component.scss']\r\n})\r\nexport class AppImportExportComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 9\r\n  };\r\n\r\n  public store = new WorkspaceStore([]);\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private layerService: LayerService\r\n  ) {\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'OSM',\r\n        sourceOptions: {\r\n          type: 'osm'\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Import / Export</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/import-export\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-import-export [store]=\"store\" [map]=\"map\"></igo-import-export>\r\n\r\n</mat-card>\r\n\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMessageModule } from '@igo2/core';\r\nimport {\r\n  IgoMapModule,\r\n  IgoImportExportModule,\r\n  provideStyleListOptions\r\n} from '@igo2/geo';\r\n\r\nimport { AppImportExportComponent } from './import-export.component';\r\nimport { AppImportExportRoutingModule } from './import-export-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppImportExportComponent],\r\n  imports: [\r\n    AppImportExportRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoMessageModule,\r\n    IgoMapModule,\r\n    IgoImportExportModule\r\n  ],\r\n  exports: [AppImportExportComponent],\r\n  providers: [\r\n    provideStyleListOptions({\r\n      path: './assets/import-style.json'\r\n    })\r\n  ]\r\n})\r\nexport class AppImportExport {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppDirectionsComponent } from './directions.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'directions',\r\n    component: AppDirectionsComponent\r\n  }\r\n];\r\n\r\nexport const AppDirectionsRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  LayerService,\r\n  MapService,\r\n  ProjectionService,\r\n  StopsStore,\r\n  StopsFeatureStore,\r\n  RoutesFeatureStore,\r\n  StepFeatureStore\r\n} from '@igo2/geo';\r\nimport { Subject } from 'rxjs';\r\n\r\n@Component({\r\n  selector: 'app-directions',\r\n  templateUrl: './directions.component.html',\r\n  styleUrls: ['./directions.component.scss']\r\n})\r\nexport class AppDirectionsComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 9,\r\n    geolocate: false\r\n  };\r\n\r\n  public stopsStore: StopsStore = new StopsStore([]);\r\n  public stopsFeatureStore: StopsFeatureStore = new StopsFeatureStore([], { map: this.map });\r\n  public stepFeatureStore: StepFeatureStore = new StepFeatureStore([], { map: this.map });\r\n  public routesFeatureStore: RoutesFeatureStore = new RoutesFeatureStore([], { map: this.map });\r\n  public zoomToActiveRoute$: Subject<void> = new Subject();\r\n\r\n  constructor(\r\n    private projectionService: ProjectionService,\r\n    private languageService: LanguageService,\r\n    private layerService: LayerService,\r\n    private mapService: MapService\r\n  ) {\r\n    this.mapService.setMap(this.map);\r\n    this.layerService\r\n      .createAsyncLayer({\r\n        title: 'OSM',\r\n        sourceOptions: {\r\n          type: 'osm'\r\n        }\r\n      })\r\n      .subscribe(l => this.map.addLayer(l));\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Directions</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/directions\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n    <igo-geolocate-button [map]=\"map\" color=\"primary\"></igo-geolocate-button>\r\n    <igo-home-extent-button [map]=\"map\" color=\"primary\"></igo-home-extent-button>\r\n    <igo-rotation-button [map]=\"map\" [showIfNoRotation]=\"false\" color=\"primary\"></igo-rotation-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-directions\r\n    [stopsStore]=\"stopsStore\"\r\n    [stopsFeatureStore]=\"stopsFeatureStore\"\r\n    [stepFeatureStore]=\"stepFeatureStore\"\r\n    [routesFeatureStore]=\"routesFeatureStore\"\r\n    [zoomToActiveRoute$]=\"zoomToActiveRoute$\">  \r\n  </igo-directions>\r\n\r\n\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\n\r\nimport { IgoMessageModule } from '@igo2/core';\r\nimport {\r\n  IgoMapModule,\r\n  IgoDirectionsModule,\r\n  provideOsrmDirectionsSource\r\n} from '@igo2/geo';\r\n\r\nimport { AppDirectionsComponent } from './directions.component';\r\nimport { AppDirectionsRoutingModule } from './directions-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppDirectionsComponent],\r\n  imports: [\r\n    AppDirectionsRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    IgoMessageModule,\r\n    IgoMapModule,\r\n    IgoDirectionsModule\r\n  ],\r\n  exports: [AppDirectionsComponent],\r\n  providers: [provideOsrmDirectionsSource()]\r\n})\r\nexport class AppDirectionsModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppTimeFilterComponent } from './time-filter.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'time-filter',\r\n    component: AppTimeFilterComponent\r\n  }\r\n];\r\n\r\nexport const AppTimeFilterRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  TimeFilterableDataSourceOptions,\r\n  TimeFilterType,\r\n  TimeFilterStyle\r\n} from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-time-filter',\r\n  templateUrl: './time-filter.component.html',\r\n  styleUrls: ['./time-filter.component.scss']\r\n})\r\nexport class AppTimeFilterComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 7\r\n  };\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService\r\n  ) {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    // const datasource: TimeFilterableDataSourceOptions = {\r\n    //   type: 'wms',\r\n    //   url: 'https://geoegl.msp.gouv.qc.ca/ws/igo_gouvouvert.fcgi',\r\n    //   params: {\r\n    //     layers: 'vg_observation_v_inondation_embacle_wmst',\r\n    //     version: '1.3.0'\r\n    //   },\r\n    //   timeFilterable: true,\r\n    //   timeFilter: {\r\n    //     min: '2017-01-01',\r\n    //     max: '2018-01-01',\r\n    //     range: true,\r\n    //     type: TimeFilterType.DATETIME,\r\n    //     style: TimeFilterStyle.SLIDER,\r\n    //     step: 86400000,\r\n    //     timeInterval: 2000\r\n    //   }\r\n    // };\r\n\r\n    const datasourceYear: TimeFilterableDataSourceOptions = {\r\n      type: 'wms',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        LAYERS: 'vg_observation_v_inondation_embacle_wmst',\r\n        VERSION: '1.3.0'\r\n      },\r\n      timeFilterable: true,\r\n      timeFilter: {\r\n        min: '2013',\r\n        max: '2019',\r\n        range: false,\r\n        type: TimeFilterType.YEAR,\r\n        style: TimeFilterStyle.SLIDER,\r\n        step: 1,\r\n        timeInterval: 2000\r\n      }\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasourceYear)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Embcle YEAR',\r\n            visible: true,\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Time filter</mat-card-title>\r\n  <mat-card-content>\r\n    <li>npm install --save moment@2.22.2</li>\r\n    <li>npm install --save @mat-datetimepicker/core@3.0.0-beta.0</li>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/time-filter\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Layers\">\r\n    <igo-time-filter-list [layers]=\"map.layers\"></igo-time-filter-list>\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoPanelModule } from '@igo2/common';\r\nimport { IgoMapModule, IgoFilterModule } from '@igo2/geo';\r\n\r\nimport { AppTimeFilterComponent } from './time-filter.component';\r\nimport { AppTimeFilterRoutingModule } from './time-filter-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppTimeFilterComponent],\r\n  imports: [\r\n    AppTimeFilterRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoFilterModule\r\n  ],\r\n  exports: [AppTimeFilterComponent]\r\n})\r\nexport class AppTimeFilterModule {}\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppOgcFilterComponent } from './ogc-filter.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'ogc-filter',\r\n    component: AppOgcFilterComponent\r\n  }\r\n];\r\n\r\nexport const AppOgcFilterRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  WMSDataSourceOptions,\r\n  WFSDataSourceOptions,\r\n  WFSDataSourceOptionsParams,\r\n  OgcFilterableDataSourceOptions,\r\n  AnyBaseOgcFilterOptions,\r\n  OgcFilterOperatorType,\r\n  OgcFilterDuringOptions\r\n} from '@igo2/geo';\r\n\r\nimport {Fill, Stroke, Circle, Style} from 'ol/style';\r\n\r\n@Component({\r\n  selector: 'app-ogc-filter',\r\n  templateUrl: './ogc-filter.component.html',\r\n  styleUrls: ['./ogc-filter.component.scss']\r\n})\r\nexport class AppOgcFilterComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 7\r\n  };\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService\r\n  ) {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    interface WFSoptions\r\n      extends WFSDataSourceOptions,\r\n        OgcFilterableDataSourceOptions {}\r\n\r\n    const datasource: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'SHP' // based on service capabilities\r\n      },\r\n      sourceFields: [\r\n        { name: 'code_municipalite', alias: '# de la municipalite' },\r\n        { name: 'date_observation', excludeFromOgcFilters: true },\r\n        { name: 'urgence', values: ['immdiate', 'inconnue'] }\r\n      ],\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        allowedOperatorsType: OgcFilterOperatorType.All,\r\n        filters: {\r\n          logical: 'Or',\r\n          filters: [\r\n            {\r\n              operator: 'PropertyIsEqualTo',\r\n              propertyName: 'code_municipalite',\r\n              expression: '10043'\r\n            },\r\n            {\r\n              operator: 'Intersects',\r\n              geometryName: 'the_geom',\r\n              wkt_geometry: `MULTIPOLYGON(((\r\n              -8379441.158019895 5844447.897707146,\r\n              -8379441.158019895 5936172.331649357,\r\n              -8134842.66750733 5936172.331649357,\r\n              -8134842.66750733 5844447.897707146,\r\n              -8379441.158019895 5844447.897707146\r\n            ), (\r\n              -8015003 5942074,\r\n              -8015003 5780349,\r\n              -7792364 5780349,\r\n              -7792364 5942074,\r\n              -8015003 5942074\r\n            )))`\r\n            }\r\n          ] as AnyBaseOgcFilterOptions[]\r\n        }\r\n      }\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasource)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Embcle (PropertyIsEqualTo OR Intersects)',\r\n            source: dataSource,\r\n            style: new Style({\r\n              image: new Circle({\r\n                radius: 5,\r\n                fill: new Fill({\r\n                  color: 'white'\r\n                }),\r\n                stroke: new Stroke({\r\n                  color: 'orange',\r\n                  width: 1\r\n                })\r\n              })\r\n            })\r\n          })\r\n        );\r\n      });\r\n\r\n    const datasourceDuringFilter: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'SHP' // based on service capabilities\r\n      },\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        allowedOperatorsType: OgcFilterOperatorType.All,\r\n        filters:\r\n          {\r\n            operator: 'During',\r\n            propertyName: 'date_observation',\r\n            begin: '2016-01-21T00:00:00-05:00',\r\n            end: '2016-01-26T00:00:00-05:00'\r\n          } as OgcFilterDuringOptions\r\n      },\r\n      minDate: '2016-01-01T00:00:00-05:00',\r\n      maxDate: '2016-02-10T00:00:00-05:00',\r\n      stepDate: 'P2D'\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasourceDuringFilter)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Embcle (During, Step: P2D)',\r\n            id: '1',\r\n            source: dataSource,\r\n            style: new Style({\r\n              image: new Circle({\r\n                radius: 5,\r\n                fill: new Fill({\r\n                  color: 'white'\r\n                }),\r\n                stroke: new Stroke({\r\n                  color: 'red',\r\n                  width: 1\r\n                })\r\n              })\r\n            })\r\n          })\r\n        );\r\n      });\r\n\r\n\r\n    const datasourceDuringFilterTime: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'SHP' // based on service capabilities\r\n      },\r\n      sourceFields: [\r\n        { name: 'date_observation', alias: 'Date de l\\'observation', allowedOperatorsType: 'Time' as OgcFilterOperatorType }\r\n      ],\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        allowedOperatorsType: OgcFilterOperatorType.All,\r\n        filters:\r\n          {\r\n            operator: 'During',\r\n            propertyName: 'date_observation',\r\n            begin: '2016-01-01T04:00:00-05:00',\r\n            end: '2016-01-12T16:00:00-05:00'\r\n          } as OgcFilterDuringOptions\r\n      },\r\n      minDate: '2016-01-01T00:00:00-05:00',\r\n      maxDate: '2016-02-14T20:00:00-05:00',\r\n      stepDate: 'PT4H'\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasourceDuringFilterTime)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Embcle (During, Step: PT4H)',\r\n            id: '2',\r\n            source: dataSource,\r\n            style: new Style({\r\n              image: new Circle({\r\n                radius: 5,\r\n                fill: new Fill({\r\n                  color: 'white'\r\n                }),\r\n                stroke: new Stroke({\r\n                  color: 'blue',\r\n                  width: 1\r\n                })\r\n              })\r\n            })\r\n          })\r\n        );\r\n      });\r\n\r\n    const datasourceDuringFilterTimeMonth: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'SHP' // based on service capabilities\r\n      },\r\n      sourceFields: [\r\n        { name: 'date_observation', alias: 'Date de l\\'observation', allowedOperatorsType: 'Time' as OgcFilterOperatorType }\r\n      ],\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        allowedOperatorsType: OgcFilterOperatorType.All,\r\n        filters:\r\n          {\r\n            operator: 'During',\r\n            propertyName: 'date_observation',\r\n            begin: '2016-01-01T00:00:00-05:00',\r\n            end: '2016-03-31T00:00:00-05:00',\r\n            displayFormat: 'MMMM'\r\n          } as OgcFilterDuringOptions\r\n      },\r\n      minDate: '2016-01-01T00:00:00-05:00',\r\n      maxDate: '2018-12-31T00:00:00-05:00',\r\n      stepDate: 'P1M'\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasourceDuringFilterTimeMonth)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Embcle (During, Step: P1M)',\r\n            id: '3',\r\n            source: dataSource,\r\n            style: new Style({\r\n              image: new Circle({\r\n                radius: 5,\r\n                fill: new Fill({\r\n                  color: 'white'\r\n                }),\r\n                stroke: new Stroke({\r\n                  color: 'yellow',\r\n                  width: 1\r\n                })\r\n              })\r\n            })\r\n          })\r\n        );\r\n      });\r\n\r\n    const datasourceDuringFilterTimeYear: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'SHP' // based on service capabilities\r\n      },\r\n      sourceFields: [\r\n        { name: 'date_observation', alias: 'Date de l\\'observation', allowedOperatorsType: 'Time' as OgcFilterOperatorType }\r\n      ],\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        allowedOperatorsType: OgcFilterOperatorType.All,\r\n        filters:\r\n          {\r\n            operator: 'During',\r\n            propertyName: 'date_observation',\r\n            begin: '2014-01-01T00:00:00-05:00',\r\n            end: '2019-12-31T00:00:00-05:00',\r\n            sliderOptions: {\r\n              interval: 2000,\r\n              displayFormat: 'YY'\r\n            },\r\n            displayFormat: 'YYYY'\r\n          } as OgcFilterDuringOptions\r\n      },\r\n      minDate: '2014-01-01T00:00:00-05:00',\r\n      maxDate: '2019-12-31T00:00:00-05:00',\r\n      stepDate: 'P1Y'\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasourceDuringFilterTimeYear)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Embcle (During, Step: P1Y)',\r\n            id: '4',\r\n            source: dataSource,\r\n            style: new Style({\r\n              image: new Circle({\r\n                radius: 5,\r\n                fill: new Fill({\r\n                  color: 'white'\r\n                }),\r\n                stroke: new Stroke({\r\n                  color: 'green',\r\n                  width: 1\r\n                })\r\n              })\r\n            })\r\n          })\r\n        );\r\n      });\r\n\r\n    const datasourceDuringFilterTimeInterval: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'SHP' // based on service capabilities\r\n      },\r\n      sourceFields: [\r\n        { name: 'date_observation', alias: 'Date de l\\'observation', allowedOperatorsType: 'Time' as OgcFilterOperatorType }\r\n      ],\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        allowedOperatorsType: OgcFilterOperatorType.All,\r\n        filters:\r\n          {\r\n            operator: 'During',\r\n            propertyName: 'date_observation',\r\n            begin: 'today - 2 days', // \"now\" can also be used. Instead of midnight, the current time will be used\r\n            end: 'today', // \"now\" can also be used. Instead of midnight, the current time will be used\r\n          } as OgcFilterDuringOptions\r\n      },\r\n      minDate: '2016-01-01T00:00:00-05:00',\r\n      maxDate: '2025-12-31T00:00:00-05:00',\r\n      stepDate: 'P1D'\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasourceDuringFilterTimeInterval)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Embcle (During, Interval from Now, Step: P1D)',\r\n            id: '5',\r\n            source: dataSource,\r\n            style: new Style({\r\n              image: new Circle({\r\n                radius: 5,\r\n                fill: new Fill({\r\n                  color: 'white'\r\n                }),\r\n                stroke: new Stroke({\r\n                  color: 'black',\r\n                  width: 1\r\n                })\r\n              })\r\n            })\r\n          })\r\n        );\r\n      });\r\n\r\n    const datasourceDuringFilterTimeRestrictedToStep: WFSoptions = {\r\n      type: 'wfs',\r\n      url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n      params: {\r\n        featureTypes: 'vg_observation_v_autre_wmst',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '2.0.0',\r\n        outputFormat: undefined,\r\n        outputFormatDownload: 'SHP' // based on service capabilities\r\n      },\r\n      sourceFields: [\r\n        { name: 'date_observation', alias: 'Date de l\\'observation', allowedOperatorsType: 'Time' as OgcFilterOperatorType }\r\n      ],\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        allowedOperatorsType: OgcFilterOperatorType.All,\r\n        filters:\r\n          {\r\n            operator: 'During',\r\n            propertyName: 'date_observation',\r\n            begin: '2019-01-01 00:00:00',\r\n            restrictToStep: true\r\n          } as OgcFilterDuringOptions\r\n      },\r\n      minDate: '2016-01-01T00:00:00-05:00',\r\n      maxDate: '2025-12-31T00:00:00-05:00',\r\n      stepDate: 'P1M'\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(datasourceDuringFilterTimeRestrictedToStep)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Embcle (During, RestrictToStep, Step: P1M)',\r\n            id: '6',\r\n            source: dataSource,\r\n            style: new Style({\r\n              image: new Circle({\r\n                radius: 5,\r\n                fill: new Fill({\r\n                  color: 'black'\r\n                }),\r\n                stroke: new Stroke({\r\n                  color: 'red',\r\n                  width: 1\r\n                })\r\n              })\r\n            })\r\n          })\r\n        );\r\n      });\r\n\r\n    const wmsOgcFilterOptions: WMSoptions = {\r\n        type: 'wms',\r\n        url: 'https://geoegl.msp.gouv.qc.ca/apis/ws/igo_gouvouvert.fcgi',\r\n        optionsFromCapabilities: true,\r\n        params: {\r\n          LAYERS: 'vg_observation_v_inondation23avril2017_wmst',\r\n          VERSION: '1.3.0'\r\n        },\r\n        sourceFields: [\r\n          { name: 'date_observation', alias: 'Date de l\\'observation', allowedOperatorsType: 'Time' as OgcFilterOperatorType }\r\n        ],\r\n        ogcFilters: {\r\n          enabled: true,\r\n          editable: true,\r\n          filters:\r\n          {\r\n            operator: 'During',\r\n            propertyName: 'date_observation'\r\n          } as OgcFilterDuringOptions,\r\n          allowedOperatorsType: OgcFilterOperatorType.Time\r\n        }\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(wmsOgcFilterOptions)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Inondation (During, optionsFromCapabilities)',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    interface WMSoptions\r\n      extends WMSDataSourceOptions,\r\n        OgcFilterableDataSourceOptions {}\r\n\r\n    const filterableWMSwithPushButtons: WMSoptions = {\r\n      type: 'wms',\r\n      url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n      urlWfs: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n      params: {\r\n        LAYERS: 'radars_photos',\r\n        VERSION: '1.3.0'\r\n      },\r\n      ogcFilters: {\r\n        enabled: true,\r\n        editable: true,\r\n        pushButtons: {\r\n          selectorType: 'pushButton',\r\n          order: 2,\r\n          groups : [\r\n            {title: 'Nom du group1 - push', name: '1 - push', ids : ['id1']},\r\n          ],\r\n          bundles: [\r\n            {\r\n              id: 'id1',\r\n              title: 'Rgions',\r\n              logical: 'Or',\r\n              vertical: true,\r\n              selectors: [\r\n                {\r\n                  title: 'Montral & Laval',\r\n                  enabled: false,\r\n                  tooltip: 'Here a tooltip explaning ...',\r\n                  filters: {\r\n                    logical: 'Or',\r\n                    filters: [\r\n                      {\r\n                        operator: 'PropertyIsEqualTo',\r\n                        propertyName: 'region',\r\n                        expression: 'Montral'\r\n                      },\r\n                      {\r\n                        operator: 'PropertyIsEqualTo',\r\n                        propertyName: 'region',\r\n                        expression: 'Laval'\r\n                      }\r\n                    ]\r\n                  }\r\n                },\r\n                {\r\n                  title: 'Outside Montral & Laval',\r\n                  enabled: false,\r\n                  tooltip: 'Here a tooltip explaning ...',\r\n                  filters: {\r\n                    logical: 'And',\r\n                    filters: [\r\n                      {\r\n                        operator: 'PropertyIsNotEqualTo',\r\n                        propertyName: 'region',\r\n                        expression: 'Montral'\r\n                      },\r\n                      {\r\n                        operator: 'PropertyIsNotEqualTo',\r\n                        propertyName: 'region',\r\n                        expression: 'Laval'\r\n                      }\r\n                    ]\r\n                  }\r\n                }\r\n              ]\r\n            }\r\n          ]\r\n        },\r\n        checkboxes: {\r\n          selectorType: 'checkbox',\r\n          order: 1,\r\n          groups : [\r\n            {title: 'Nom du group1 - checkbox', name: '1 - checkbox', ids : ['id1']},\r\n          ],\r\n          bundles: [\r\n            {\r\n              id: 'id1',\r\n              title: 'Type de radar photo',\r\n              logical: 'Or',\r\n              selectors: [\r\n                {\r\n                  title: 'Radar photo fixe',\r\n                  enabled: true,\r\n                  tooltip: 'Here a tooltip explaning ...',\r\n                  filters: {\r\n                    operator: 'PropertyIsEqualTo',\r\n                    propertyName: 'typeAppareil',\r\n                    expression: 'Radar photo fixe'\r\n                  }\r\n                },\r\n                {\r\n                  title: 'Radar photo mobile',\r\n                  enabled: false,\r\n                  tooltip: 'Here a tooltip explaning ...',\r\n                  filters: {\r\n                    operator: 'PropertyIsEqualTo',\r\n                    propertyName: 'typeAppareil',\r\n                    expression: 'Radar photo mobile'\r\n                  }\r\n                },\r\n                {\r\n                  title: 'Radar photo fixe + feu rouge',\r\n                  enabled: false,\r\n                  color: '0,200,0',\r\n                  tooltip: 'Here a tooltip explaning ...',\r\n                  filters: {\r\n                    operator: 'PropertyIsEqualTo',\r\n                    propertyName: 'typeAppareil',\r\n                    expression: 'Radar photo fixe et surveillance au feu rouge'\r\n                  }\r\n                },\r\n                {\r\n                  title: 'Radar feu rouge',\r\n                  enabled: false,\r\n                  color: '255,0,0',\r\n                  tooltip: 'Here a tooltip explaning ...',\r\n                  filters: {\r\n                    operator: 'PropertyIsEqualTo',\r\n                    propertyName: 'typeAppareil',\r\n                    expression: 'Appareil de surveillance au feu rouge'\r\n                  }\r\n                }\r\n              ]\r\n            }\r\n          ]\r\n        },\r\n        allowedOperatorsType: OgcFilterOperatorType.Basic\r\n        },\r\n      paramsWFS: {\r\n        featureTypes: 'radars_photos',\r\n        fieldNameGeometry: 'geometry',\r\n        maxFeatures: 10000,\r\n        version: '1.1.0',\r\n        outputFormat: 'geojson',\r\n        outputFormatDownload: 'shp'\r\n      } as WFSDataSourceOptionsParams\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(filterableWMSwithPushButtons)\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'Filterable WMS layers with predefined filters (push buttons)',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    // const datasourceWmsWith2Layers: WMSoptions = {\r\n    //   type: 'wms',\r\n    //   url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n    //   urlWfs: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n    //   params: {\r\n    //     layers: 'stations_meteoroutieres,histo_stations_meteoroutieres',\r\n    //     version: '1.3.0'\r\n    //   },\r\n    //   ogcFilters: {\r\n    //     enabled: true,\r\n    //     editable: true\r\n    //   },\r\n    //   paramsWFS: {\r\n    //     featureTypes: 'histo_stations_meteoroutieres',\r\n    //     fieldNameGeometry: 'geometry',\r\n    //     maxFeatures: 10000,\r\n    //     version: '1.1.0',\r\n    //     outputFormat: 'geojson',\r\n    //     outputFormatDownload: 'shp'\r\n    //   } as WFSDataSourceOptionsParams\r\n    // };\r\n    //\r\n    // this.dataSourceService\r\n    //   .createAsyncDataSource(datasourceWmsWith2Layers)\r\n    //   .subscribe(dataSource => {\r\n    //     this.map.addLayer(\r\n    //       this.layerService.createLayer({\r\n    //         title: 'Layer build from 2 WMS layers',\r\n    //         source: dataSource\r\n    //       })\r\n    //     );\r\n    //   });\r\n\r\n    // const datasourceWms: WMSoptions = {\r\n    //   type: 'wms',\r\n    //   url: '/geoserver/wms',\r\n    //   urlWfs: '/geoserver/wfs',\r\n    //   params: {\r\n    //     LAYERS: 'water_areas',\r\n    //     VERSION: '1.3.0'\r\n    //   },\r\n    //   ogcFilters: {\r\n    //     enabled: true,\r\n    //     editable: true,\r\n    //     filters: {\r\n    //       operator: 'PropertyIsEqualTo',\r\n    //       propertyName: 'waterway',\r\n    //       expression: 'riverbank'\r\n    //     }\r\n    //   },\r\n    //   sourceFields: [\r\n    //     { name: 'waterway', alias: 'Chemin d eau' },\r\n    //     { name: 'osm_id' },\r\n    //     { name: 'landuse', values: ['yes', 'no'] }\r\n    //   ],\r\n    //   paramsWFS: {\r\n    //     featureTypes: 'water_areas',\r\n    //     fieldNameGeometry: 'the_geom',\r\n    //     maxFeatures: 10000,\r\n    //     version: '1.1.0',\r\n    //     outputFormat: 'application/json',\r\n    //     outputFormatDownload: 'application/vnd.google-earth.kml+xml'\r\n    //   } as WFSDataSourceOptionsParams\r\n    // };\r\n    //\r\n    // this.dataSourceService\r\n    //   .createAsyncDataSource(datasourceWms)\r\n    //   .subscribe(dataSource => {\r\n    //     this.map.addLayer(\r\n    //       this.layerService.createLayer({\r\n    //         title: 'Geoserver water_areas',\r\n    //         source: dataSource\r\n    //       })\r\n    //     );\r\n    //   });\r\n  }\r\n}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Ogc filter</mat-card-title>\r\n  <mat-card-content>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/ogc-filter\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Layers\">\r\n    <igo-ogc-filterable-list [map]=\"map\" [layers]=\"map.layers\">\r\n\r\n    </igo-ogc-filterable-list>\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoPanelModule } from '@igo2/common';\r\nimport { IgoMapModule, IgoFilterModule } from '@igo2/geo';\r\n\r\nimport { AppOgcFilterComponent } from './ogc-filter.component';\r\nimport { AppOgcFilterRoutingModule } from './ogc-filter-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppOgcFilterComponent],\r\n  imports: [\r\n    AppOgcFilterRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoFilterModule\r\n  ],\r\n  exports: [AppOgcFilterComponent]\r\n})\r\nexport class AppOgcFilterModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Spatial filter</mat-card-title>\r\n  <mat-card-content>\r\n    <li>npm install --save moment@2.22.2</li>\r\n    <li>npm install --save @mat-datetimepicker/core@3.0.0-beta.0</li>\r\n    <li>Dependencies: LanguageService</li>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/spatial-filter\">code of this example</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser\r\n    [map]=\"map\"\r\n    [view]=\"view\"\r\n    igoOverlay igoQuery\r\n    (query)=\"handleQueryResults($event)\"\r\n    [queryFeatures]=\"true\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Spatial Filter\">\r\n    <igo-spatial-filter-type\r\n      [store]=\"spatialListStore\"\r\n      [selectedQueryType]=\"queryType\"\r\n      [zone]=\"zone\"\r\n      (eventType)=\"getOutputType($event)\"\r\n      (eventQueryType)=\"getOutputQueryType($event)\"\r\n      (zoneChange)=\"onZoneChange($event)\">\r\n    </igo-spatial-filter-type>\r\n\r\n    <igo-spatial-filter-item\r\n      [type]=\"type\"\r\n      [queryType]=\"queryType\"\r\n      [map]=\"map\"\r\n      [zone]=\"zone\"\r\n      [loading]=\"loading\"\r\n      [store]=\"store\"\r\n      [layers]=\"layers\"\r\n      (radiusEvent)=\"radius = $event\"\r\n      (freehandControl)=\"freehandDrawIsActive = $event\"\r\n      (drawZoneEvent)=\"zone = $event\"\r\n      (itemTypeChange)=\"itemType = $event\"\r\n      (thematicChange)=\"thematics = $event\"\r\n      (toggleSearch)=\"getOutputToggleSearch()\"\r\n      (clearButtonEvent)=\"layers = $event\"\r\n      (clearSearchEvent)=\"getOutputClearSearch()\">\r\n    </igo-spatial-filter-item>\r\n  </igo-panel>\r\n\r\n  <igo-panel title=\"Details\">\r\n    <ng-container *ngIf=\"selectedFeature$ | async as feature\">\r\n      <igo-feature-details [feature]=\"feature\"></igo-feature-details>\r\n    </ng-container>\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppSpatialFilterComponent } from './spatial-filter.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'spatial-filter',\r\n    component: AppSpatialFilterComponent\r\n  }\r\n];\r\n\r\nexport const AppSpatialFilterRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, Input } from '@angular/core';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  Feature,\r\n  moveToOlFeatures,\r\n  FeatureMotion,\r\n  ClusterDataSource,\r\n  featureToOl,\r\n  DataSource,\r\n  QueryableDataSourceOptions,\r\n  Layer,\r\n  SpatialFilterService,\r\n  SpatialFilterQueryType,\r\n  SpatialFilterType,\r\n  SpatialFilterItemType,\r\n  SpatialFilterThematic\r\n} from '@igo2/geo';\r\nimport { MessageService, LanguageService } from '@igo2/core';\r\nimport { EntityStore } from '@igo2/common';\r\nimport olFormatGeoJSON from 'ol/format/GeoJSON';\r\nimport { BehaviorSubject } from 'rxjs';\r\nimport * as olstyle from 'ol/style';\r\nimport olSourceCluster from 'ol/source/Cluster';\r\nimport olSourceVector from 'ol/source/Vector';\r\nimport type { default as OlGeometry } from 'ol/geom/Geometry';\r\n\r\n@Component({\r\n  selector: 'app-spatial-filter',\r\n  templateUrl: './spatial-filter.component.html',\r\n  styleUrls: ['./spatial-filter.component.scss']\r\n})\r\nexport class AppSpatialFilterComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  view = {\r\n    center: [-71.9, 46.9],\r\n    zoom: 10\r\n  };\r\n\r\n  @Input() type: SpatialFilterType;\r\n  @Input() itemType: SpatialFilterItemType = SpatialFilterItemType.Address;\r\n  @Input() freehandDrawIsActive: boolean;\r\n\r\n  public layers: Layer[] = [];\r\n\r\n  public queryType: SpatialFilterQueryType;\r\n  public thematics: SpatialFilterThematic[];\r\n  public zone: Feature;\r\n  public radius: number;\r\n\r\n  public selectedFeature$: BehaviorSubject<Feature> = new BehaviorSubject(\r\n    undefined\r\n  );\r\n\r\n  private format = new olFormatGeoJSON();\r\n\r\n  public store = new EntityStore<Feature>([]); // Store to print results at the end\r\n\r\n  public spatialListStore = new EntityStore<Feature>([]);\r\n\r\n  public loading = false;\r\n\r\n  constructor(\r\n    private spatialFilterService: SpatialFilterService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService,\r\n    private messageService: MessageService,\r\n    private languageService: LanguageService\r\n  ) {\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource,\r\n            baseLayer: true,\r\n            visible: true\r\n          })\r\n        );\r\n      });\r\n  }\r\n\r\n  getOutputType(event: SpatialFilterType) {\r\n    this.type = event;\r\n    this.queryType = undefined;\r\n    this.radius = undefined;\r\n  }\r\n\r\n  getOutputQueryType(event: SpatialFilterQueryType) {\r\n    this.queryType = event;\r\n    if (this.queryType) {\r\n      this.loadFilterList();\r\n    }\r\n  }\r\n\r\n  private loadFilterList() {\r\n    this.spatialFilterService\r\n      .loadFilterList(this.queryType)\r\n      .subscribe((features: Feature[]) => {\r\n        features.sort((a, b) => {\r\n          if (a.properties.nom < b.properties.nom) {\r\n            return -1;\r\n          }\r\n          if (a.properties.nom > b.properties.nom) {\r\n            return 1;\r\n          }\r\n          return 0;\r\n        });\r\n        this.spatialListStore.clear();\r\n        this.spatialListStore.load(features);\r\n      });\r\n  }\r\n\r\n  getOutputToggleSearch() {\r\n    this.loadThematics();\r\n  }\r\n\r\n  getOutputClearSearch() {\r\n    this.zone = undefined;\r\n    this.queryType = undefined;\r\n  }\r\n\r\n  private loadThematics() {\r\n    this.loading = true;\r\n    this.tryAddFeaturesToMap([this.zone]);\r\n    if (!this.thematics) {\r\n      const theme: SpatialFilterThematic = {\r\n        name: ''\r\n      };\r\n      this.thematics = [theme];\r\n    }\r\n    if (this.type === SpatialFilterType.Polygon) {\r\n      this.radius = undefined;\r\n    }\r\n    this.thematics.forEach(thematic => {\r\n      this.spatialFilterService\r\n        .loadFilterItem(\r\n          this.zone,\r\n          this.itemType,\r\n          this.queryType,\r\n          thematic,\r\n          this.radius\r\n        )\r\n        .subscribe((features: Feature[]) => {\r\n          this.store.insertMany(features);\r\n          const featuresPoint: Feature[] = [];\r\n          const featuresLinePoly: Feature[] = [];\r\n          let idPoint;\r\n          let idLinePoly;\r\n          features.forEach(feature => {\r\n            if (feature.geometry.type === 'Point') {\r\n              featuresPoint.push(feature);\r\n              idPoint = feature.meta.id;\r\n            } else {\r\n              featuresLinePoly.push(feature);\r\n              idLinePoly = feature.meta.id;\r\n            }\r\n          });\r\n          this.tryAddPointToMap(featuresPoint, idPoint);\r\n          this.tryAddLayerToMap(featuresLinePoly, idLinePoly);\r\n          this.loading = false;\r\n          if (features.length >= 10000) {\r\n            this.messageService.alert(\r\n              this.languageService.translate.instant(\r\n                'igo.geo.spatialFilter.maxSizeAlert'\r\n              ),\r\n              this.languageService.translate.instant(\r\n                'igo.geo.spatialFilter.warning'\r\n              ),\r\n              { timeOut: 10000 }\r\n            );\r\n          }\r\n          if (!features.length) {\r\n            this.messageService.alert(\r\n              this.languageService.translate.instant(\r\n                'igo.geo.spatialFilter.zeroResults'\r\n              ),\r\n              this.languageService.translate.instant(\r\n                'igo.geo.spatialFilter.warning'\r\n              ),\r\n              { timeOut: 10000 }\r\n            );\r\n          }\r\n        });\r\n    });\r\n  }\r\n\r\n  onZoneChange(feature: Feature) {\r\n    this.zone = feature;\r\n    if (feature) {\r\n      this.tryAddFeaturesToMap([feature]);\r\n      this.zoomToFeatureExtent(feature);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Try to add zone feature to the map overlay\r\n   */\r\n  public tryAddFeaturesToMap(features: Feature[]) {\r\n    let i = 1;\r\n    for (const feature of features) {\r\n      if (this.type === SpatialFilterType.Predefined) {\r\n        for (const layer of this.map.layers) {\r\n          if (\r\n            layer.options._internal &&\r\n            layer.options._internal.code === feature.properties.code\r\n          ) {\r\n            return;\r\n          }\r\n          if (layer.title.startsWith('Zone')) {\r\n            this.map.removeLayer(layer);\r\n          }\r\n        }\r\n      }\r\n      for (const layer of this.map.layers) {\r\n        if (layer.title.startsWith('Zone')) {\r\n          i++;\r\n        }\r\n      }\r\n      this.dataSourceService\r\n        .createAsyncDataSource({\r\n          type: 'vector',\r\n          queryable: true\r\n        } as QueryableDataSourceOptions)\r\n        .subscribe((dataSource: DataSource) => {\r\n          const olLayer = this.layerService.createLayer({\r\n            title: ('Zone ' + i) as string,\r\n            _internal: {\r\n              code:\r\n                this.type === SpatialFilterType.Predefined\r\n                  ? feature.properties.code\r\n                  : undefined\r\n            },\r\n            source: dataSource,\r\n            visible: true,\r\n            style: (_feature, resolution) => {\r\n              const coordinates = (features[0] as any).coordinates;\r\n              return new olstyle.Style({\r\n                image: new olstyle.Circle({\r\n                  radius: coordinates\r\n                    ? this.radius /\r\n                      Math.cos((Math.PI / 180) * coordinates[1]) /\r\n                      resolution\r\n                    : undefined,\r\n                  fill: new olstyle.Fill({\r\n                    color: 'rgba(200, 200, 20, 0.2)'\r\n                  }),\r\n                  stroke: new olstyle.Stroke({\r\n                    width: 1,\r\n                    color: 'orange'\r\n                  })\r\n                }),\r\n                stroke: new olstyle.Stroke({\r\n                  width: 1,\r\n                  color: 'orange'\r\n                }),\r\n                fill: new olstyle.Fill({\r\n                  color: 'rgba(200, 200, 20, 0.2)'\r\n                })\r\n              });\r\n            }\r\n          });\r\n          const featuresOl = features.map(f => {\r\n            return featureToOl(f, this.map.projection);\r\n          });\r\n          const ol = dataSource.ol as olSourceVector<OlGeometry> | olSourceCluster;\r\n          ol.addFeatures(featuresOl);\r\n          this.map.addLayer(olLayer);\r\n          this.layers.push(olLayer);\r\n        });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Try to point features to the map\r\n   * Necessary to create clusters\r\n   */\r\n  private tryAddPointToMap(features: Feature[], id) {\r\n    let i = 1;\r\n    if (features.length >= 1) {\r\n      if (this.map === undefined) {\r\n        return;\r\n      }\r\n      for (const layer of this.map.layers) {\r\n        if (layer.title.startsWith(features[0].meta.title)) {\r\n          i++;\r\n        }\r\n      }\r\n      this.dataSourceService\r\n        .createAsyncDataSource({\r\n          type: 'cluster',\r\n          id,\r\n          queryable: true,\r\n          distance: 120,\r\n          meta: {\r\n            title: 'Cluster'\r\n          }\r\n        } as QueryableDataSourceOptions)\r\n        .subscribe((dataSource: ClusterDataSource) => {\r\n          const olLayer = this.layerService.createLayer({\r\n            title: (features[0].meta.title + ' ' + i) as string,\r\n            source: dataSource,\r\n            visible: true,\r\n            clusterParam: {\r\n              clusterRanges: [{ minRadius: 1, maxRadius: 5, style: {} }]\r\n            }\r\n          });\r\n          const featuresOl = features.map(feature => {\r\n            return featureToOl(feature, this.map.projection);\r\n          });\r\n          const ol = dataSource.ol as olSourceCluster;\r\n          ol.getSource().addFeatures(featuresOl);\r\n          if (this.map.layers.find(layer => layer.id === olLayer.id)) {\r\n            this.map.removeLayer(\r\n              this.map.layers.find(layer => layer.id === olLayer.id)\r\n            );\r\n            i = i - 1;\r\n            olLayer.title = (features[0].meta.title + ' ' + i) as string;\r\n            olLayer.options.title = olLayer.title;\r\n          }\r\n          this.map.addLayer(olLayer);\r\n          this.layers.push(olLayer);\r\n        });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Try to add line or polygon features to the map\r\n   */\r\n  private tryAddLayerToMap(features: Feature[], id) {\r\n    let i = 1;\r\n    if (features.length > 1) {\r\n      if (this.map === undefined) {\r\n        return;\r\n      }\r\n      for (const layer of this.map.layers) {\r\n        if (layer.title.startsWith(features[0].meta.title)) {\r\n          i++;\r\n        }\r\n      }\r\n      this.dataSourceService\r\n        .createAsyncDataSource({\r\n          type: 'vector',\r\n          id,\r\n          queryable: true\r\n        } as QueryableDataSourceOptions)\r\n        .subscribe((dataSource: DataSource) => {\r\n          const olLayer = this.layerService.createLayer({\r\n            title: (features[0].meta.title + ' ' + i) as string,\r\n            source: dataSource,\r\n            visible: true\r\n          });\r\n          const featuresOl = features.map(feature => {\r\n            return featureToOl(feature, this.map.projection);\r\n          });\r\n          const ol = dataSource.ol as olSourceVector<OlGeometry> | olSourceCluster;\r\n          ol.addFeatures(featuresOl);\r\n          if (this.map.layers.find(layer => layer.id === olLayer.id)) {\r\n            this.map.removeLayer(\r\n              this.map.layers.find(layer => layer.id === olLayer.id)\r\n            );\r\n            i = i - 1;\r\n            olLayer.title = (features[0].meta.title + ' ' + i) as string;\r\n            olLayer.options.title = olLayer.title;\r\n          }\r\n          this.map.addLayer(olLayer);\r\n          this.layers.push(olLayer);\r\n        });\r\n    }\r\n  }\r\n\r\n  zoomToFeatureExtent(feature) {\r\n    if (feature) {\r\n      const olFeature = this.format.readFeature(feature, {\r\n        dataProjection: feature.projection,\r\n        featureProjection: this.map.projection\r\n      });\r\n      moveToOlFeatures(this.map, [olFeature], FeatureMotion.Zoom);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Permit the query action on one item result\r\n   */\r\n  handleQueryResults(results) {\r\n    const features: Feature[] = results.features;\r\n    let feature;\r\n    if (features.length) {\r\n      feature = features[0];\r\n    }\r\n    this.selectedFeature$.next(feature);\r\n  }\r\n}\r\n","import { CommonModule } from '@angular/common';\r\nimport { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport { IgoPanelModule, IgoFormModule } from '@igo2/common';\r\nimport { IgoMapModule, IgoFilterModule, IgoQueryModule, IgoFeatureModule, IgoFeatureDetailsModule } from '@igo2/geo';\r\nimport { IgoMessageModule } from '@igo2/core';\r\n\r\nimport { AppSpatialFilterComponent } from './spatial-filter.component';\r\nimport { AppSpatialFilterRoutingModule } from './spatial-filter-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppSpatialFilterComponent],\r\n  imports: [\r\n    AppSpatialFilterRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoMessageModule,\r\n    IgoQueryModule,\r\n    IgoFeatureModule,\r\n    IgoFeatureDetailsModule,\r\n    IgoFilterModule,\r\n    IgoFormModule,\r\n    CommonModule\r\n  ],\r\n  exports: [AppSpatialFilterComponent]\r\n})\r\nexport class AppSpatialFilterModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Workspace</mat-card-title>\r\n  <mat-card-content>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/geo/workspace\">code of this example</a>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser [map]=\"map\" [view]=\"view\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-workspace-selector\r\n    igoWorkspaceSelector\r\n    [store]=\"workspaceStore\"\r\n    [map]=\"map\">\r\n  </igo-workspace-selector>\r\n\r\n  <ng-container *ngIf=\"selectedWorkspace$ | async as workspace\">\r\n    <igo-entity-table-paginator\r\n      *ngIf=\"workspace.inResolutionRange$ | async\"\r\n      [store]=\"workspace.entityStore\"\r\n      [paginatorOptions]=\"paginatorOptions\"\r\n      [entitySortChange$]=\"entitySortChange$\"\r\n      (paginatorChange)=\"paginatorChange($event)\">\r\n    </igo-entity-table-paginator>\r\n  </ng-container>\r\n\r\n  <ng-container *ngIf=\"selectedWorkspace$ | async as workspace\">\r\n    <igo-actionbar\r\n      *ngIf=\"workspace.actionStore\"\r\n      [store]=\"workspace.actionStore\"\r\n      [horizontal]=\"true\"\r\n      [withToggleButton]=\"true\"\r\n      [withTitle]=\"true\"\r\n      [mode]=\"actionbarMode\">\r\n    </igo-actionbar>\r\n\r\n    <igo-entity-table\r\n      *ngIf=\"workspace.entityStore && workspace.meta && workspace.meta.tableTemplate && (workspace.inResolutionRange$ | async)\"\r\n      class=\"table-compact table-centered\"\r\n      [paginator]=\"workspacePaginator\"\r\n      [scrollBehavior]=\"scrollBehavior\"\r\n      [store]=\"workspace.entityStore\"\r\n      [template]=\"workspace.meta.tableTemplate\">\r\n    </igo-entity-table>\r\n    <mat-card-content\r\n    *ngIf=\"(workspace.inResolutionRange$ | async) === false\">\r\n      No data available at this scale. Please zoom in. \r\n    </mat-card-content>\r\n\r\n    <igo-workspace-widget-outlet [workspace]=\"workspace\"></igo-workspace-widget-outlet>\r\n\r\n  </ng-container>\r\n\r\n</mat-card>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppWorkspaceComponent } from './workspace.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'workspace',\r\n    component: AppWorkspaceComponent\r\n  }\r\n];\r\n\r\nexport const AppWorkspaceRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component, OnInit } from '@angular/core';\r\n\r\nimport { Observable, BehaviorSubject } from 'rxjs';\r\nimport { map } from 'rxjs/operators';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport {\r\n  ActionbarMode,\r\n  EntityRecord,\r\n  EntityTableScrollBehavior,\r\n  Workspace,\r\n  WorkspaceStore,\r\n  EntityTablePaginatorOptions\r\n} from '@igo2/common';\r\nimport {\r\n  IgoMap,\r\n  DataSourceService,\r\n  LayerService,\r\n  WFSDataSourceOptions\r\n} from '@igo2/geo';\r\nimport { MatPaginator } from '@angular/material/paginator';\r\nimport { WorkspaceState } from '@igo2/integration';\r\n\r\n@Component({\r\n  selector: 'app-workspace',\r\n  templateUrl: './workspace.component.html',\r\n  styleUrls: ['./workspace.component.scss']\r\n})\r\nexport class AppWorkspaceComponent implements OnInit {\r\n\r\n  public workspacePaginator: MatPaginator;\r\n  entitySortChange$: BehaviorSubject<boolean> = new BehaviorSubject(false);\r\n  public paginatorOptions: EntityTablePaginatorOptions = {\r\n    pageSize: 5, // Number of items to display on a page.\r\n    pageSizeOptions: [1, 5, 10, 15, 30, 50, 100], // The set of provided page size options to display to the user.\r\n    showFirstLastButtons: true // Whether to show the first/last buttons UI to the user.\r\n  };\r\n\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-72, 47.2],\r\n    zoom: 5\r\n  };\r\n\r\n  get workspaceStore(): WorkspaceStore {\r\n    return this.workspaceState.store;\r\n  }\r\n\r\n  public selectedWorkspace$: Observable<Workspace>;\r\n\r\n  public actionbarMode = ActionbarMode.Overlay;\r\n\r\n  public scrollBehavior = EntityTableScrollBehavior.Instant;\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private dataSourceService: DataSourceService,\r\n    private layerService: LayerService,\r\n    public workspaceState: WorkspaceState,\r\n  ) {}\r\n\r\n  ngOnInit() {\r\n    this.selectedWorkspace$ = this.workspaceStore.stateView\r\n      .firstBy$(\r\n        (record: EntityRecord<Workspace>) => record.state.selected === true\r\n      )\r\n      .pipe(\r\n        map((record: EntityRecord<Workspace>) => {\r\n          const entity = record === undefined ? undefined : record.entity;\r\n          if (entity) {\r\n            // In fact, the download action is not fully functionnal into the igo2-lib demo\r\n            // The reason why it's has been remove is that this button trigger a tool (importExport)\r\n            // and this tool is not available in the igo2-lib demo.\r\n            // This is why it's has been removed frome the actions's list.\r\n            // Refer to the igo2 demo at https://infra-geo-ouverte.github.io/igo2/\r\n            entity.actionStore.view.filter((action) => {\r\n              return action.id !== 'wfsDownload';\r\n            });\r\n          }\r\n          return entity;\r\n\r\n        })\r\n      );\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource({\r\n        type: 'osm'\r\n      })\r\n      .subscribe(dataSource => {\r\n        this.map.addLayer(\r\n          this.layerService.createLayer({\r\n            title: 'OSM',\r\n            source: dataSource\r\n          })\r\n        );\r\n      });\r\n\r\n    // const wmsDataSourceOptions = {\r\n    //   type: 'wms',\r\n    //   url: 'https://ahocevar.com/geoserver/wms',\r\n    //   urlWfs: 'https://ahocevar.com/geoserver/wfs',\r\n    //   params: {\r\n    //     LAYERS: 'water_areas',\r\n    //     VERSION: '1.3.0'\r\n    //   },\r\n    //   paramsWFS: {\r\n    //     featureTypes: 'water_areas',\r\n    //     fieldNameGeometry: 'the_geom',\r\n    //     maxFeatures: 10000,\r\n    //     version: '1.1.0',\r\n    //     outputFormat: 'application/json',\r\n    //     outputFormatDownload: 'application/vnd.google-earth.kml+xml'\r\n    //   },\r\n    //   sourceFields: [\r\n    //     {name: 'waterway', alias: 'Chemin d eau'},\r\n    //     {name: 'osm_id'},\r\n    //     {name: 'landuse'}\r\n    //   ],\r\n    //   ogcFilters: {\r\n    //     enabled: true,\r\n    //     editable: true\r\n    //   },\r\n    //   serverType: 'geoserver'\r\n    // };\r\n    //\r\n    // this.dataSourceService\r\n    //   .createAsyncDataSource(wmsDataSourceOptions as OgcFilterableDataSourceOptions)\r\n    //   .subscribe(dataSource => {\r\n    //     const layer = {\r\n    //       optionsFromCapabilities: true,\r\n    //       title: 'WMS Geoserver filterable ',\r\n    //       visible: true,\r\n    //       source: dataSource\r\n    //     };\r\n    //     this.map.addLayer(this.layerService.createLayer(layer));\r\n    //   });\r\n\r\n    const wfsDataSourceOptions: WFSDataSourceOptions = {\r\n      type: 'wfs',\r\n      url: 'https://ws.mapserver.transports.gouv.qc.ca/swtq',\r\n      params: {\r\n        featureTypes: 'etablissement_mtq',\r\n        fieldNameGeometry: 'geometry',\r\n        version: '2.0.0',\r\n        outputFormat: 'geojson'\r\n      },\r\n      sourceFields: [\r\n        { name: 'idetablis', alias: 'ID' },\r\n        { name: 'nometablis', alias: 'Name' },\r\n        { name: 'typetablis', alias: 'Type' }\r\n      ]\r\n    };\r\n\r\n    this.dataSourceService\r\n      .createAsyncDataSource(wfsDataSourceOptions)\r\n      .subscribe(dataSource => {\r\n        const layer = {\r\n          title: 'Simple WFS ',\r\n          maxResolution: 3000,\r\n          visible: true,\r\n          source: dataSource\r\n        };\r\n        this.map.addLayer(this.layerService.createLayer(layer));\r\n      });\r\n  }\r\n\r\n  paginatorChange(event: MatPaginator) {\r\n    this.workspacePaginator = event;\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\n\r\nimport {\r\n  IgoActionModule,\r\n  IgoEntityModule,\r\n  IgoWorkspaceModule,\r\n  IgoPanelModule\r\n} from '@igo2/common';\r\nimport {\r\n  IgoMapModule,\r\n  IgoGeoWorkspaceModule\r\n} from '@igo2/geo';\r\n\r\nimport { AppWorkspaceComponent } from './workspace.component';\r\nimport { AppWorkspaceRoutingModule } from './workspace-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppWorkspaceComponent],\r\n  imports: [\r\n    CommonModule,\r\n    AppWorkspaceRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoActionModule,\r\n    IgoEntityModule,\r\n    IgoWorkspaceModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoGeoWorkspaceModule\r\n  ],\r\n  exports: [AppWorkspaceComponent]\r\n})\r\nexport class AppWorkspaceModule {}\r\n","<mat-card>\r\n  <mat-card-subtitle>Geo</mat-card-subtitle>\r\n  <mat-card-title>Context</mat-card-title>\r\n  <mat-card-content>\r\n    <p>* Dependencies: LanguageService</p>\r\n\r\n    <br>\r\n    See the <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/app/context/context\">code of this example</a><br>\r\n    See <a href=\"https://github.com/infra-geo-ouverte/igo2-lib/tree/master/demo/src/contexts\"> contexts</a>\r\n    <hr>\r\n  </mat-card-content>\r\n\r\n  <igo-map-browser\r\n    igoMapContext\r\n    igoLayerContext\r\n    [map]=\"map\">\r\n    <igo-zoom-button [map]=\"map\" color=\"primary\"></igo-zoom-button>\r\n    <igo-geolocate-button [map]=\"map\" color=\"primary\"></igo-geolocate-button>\r\n    <igo-home-extent-button [map]=\"map\" color=\"primary\"></igo-home-extent-button>\r\n    <igo-rotation-button [map]=\"map\" [showIfNoRotation]=\"true\" color=\"primary\"></igo-rotation-button>\r\n  </igo-map-browser>\r\n\r\n  <igo-panel title=\"Contexts list\">\r\n    <igo-context-list igoContextListBinding [map]=\"map\"></igo-context-list>\r\n  </igo-panel>\r\n\r\n  <igo-panel title=\"Layers\">\r\n    <igo-layer-list igoLayerListBinding [map]=\"map\">\r\n      <ng-template #igoLayerItemToolbar let-layer=\"layer\">\r\n        <igo-metadata-button [layer]=\"layer\"></igo-metadata-button>\r\n      </ng-template>\r\n    </igo-layer-list>\r\n  </igo-panel>\r\n\r\n</mat-card>\r\n","import { Routes, RouterModule } from '@angular/router';\r\n\r\n\r\nimport { AppContextComponent } from './context.component';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: 'context',\r\n    component: AppContextComponent\r\n  }\r\n];\r\n\r\nexport const AppContextRoutingModule = RouterModule.forChild(\r\n  routes\r\n);\r\n","import { Component } from '@angular/core';\r\n\r\nimport { LanguageService } from '@igo2/core';\r\nimport { IgoMap, OverlayService, MapService } from '@igo2/geo';\r\n\r\n@Component({\r\n  selector: 'app-context',\r\n  templateUrl: './context.component.html',\r\n  styleUrls: ['./context.component.scss']\r\n})\r\nexport class AppContextComponent {\r\n  public map = new IgoMap({\r\n    controls: {\r\n      attribution: {\r\n        collapsed: true\r\n      }\r\n    }\r\n  });\r\n\r\n  public view = {\r\n    center: [-73, 47.2],\r\n    zoom: 6\r\n  };\r\n\r\n  constructor(\r\n    private languageService: LanguageService,\r\n    private mapService: MapService,\r\n    private overlayService: OverlayService\r\n  ) {\r\n    this.mapService.setMap(this.map);\r\n  }\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatCardModule } from '@angular/material/card';\r\nimport { MatIconModule } from '@angular/material/icon';\r\nimport { HttpClientJsonpModule } from '@angular/common/http';\r\nimport { IgoPanelModule } from '@igo2/common';\r\nimport {\r\n  IgoMapModule,\r\n  IgoLayerModule,\r\n  IgoMetadataModule,\r\n  IgoOverlayModule,\r\n  IgoQueryModule,\r\n  IgoFeatureModule\r\n} from '@igo2/geo';\r\nimport { IgoContextManagerModule } from '@igo2/context';\r\n\r\nimport { AppContextComponent } from './context.component';\r\nimport { AppContextRoutingModule } from './context-routing.module';\r\n\r\n@NgModule({\r\n  declarations: [AppContextComponent],\r\n  imports: [\r\n    HttpClientJsonpModule,\r\n    AppContextRoutingModule,\r\n    MatCardModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    IgoPanelModule,\r\n    IgoMapModule,\r\n    IgoLayerModule,\r\n    IgoMetadataModule,\r\n    IgoOverlayModule,\r\n    IgoQueryModule,\r\n    IgoFeatureModule,\r\n    IgoContextManagerModule\r\n  ],\r\n  exports: [AppContextComponent]\r\n})\r\nexport class AppContextModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { RouterModule, Routes } from '@angular/router';\r\n\r\nconst routes: Routes = [\r\n  { path: '', redirectTo: '/home', pathMatch: 'full' },\r\n  { path: '**', redirectTo: '/home' }\r\n];\r\n\r\n@NgModule({\r\n  imports: [RouterModule.forRoot(routes, { useHash: true })],\r\n  exports: [RouterModule]\r\n})\r\nexport class AppRoutingModule {}\r\n","import { MediaMatcher } from '@angular/cdk/layout';\r\nimport {\r\n  ChangeDetectorRef,\r\n  Component,\r\n  OnDestroy,\r\n  Renderer2\r\n} from '@angular/core';\r\n\r\nimport { userAgent } from '@igo2/utils';\r\nimport { version } from '@igo2/core';\r\n\r\n@Component({\r\n  selector: 'app-root',\r\n  templateUrl: './app.component.html',\r\n  styleUrls: ['./app.component.scss']\r\n})\r\nexport class AppComponent implements OnDestroy {\r\n  mobileQuery: MediaQueryList;\r\n\r\n  public title = 'IGO';\r\n  public version = version;\r\n  private themeClass = 'deeppurple-theme';\r\n  private _mobileQueryListener: () => void;\r\n\r\n  constructor(\r\n    private changeDetectorRef: ChangeDetectorRef,\r\n    private media: MediaMatcher,\r\n    private renderer: Renderer2\r\n  ) {\r\n    this.mobileQuery = media.matchMedia('(max-width: 600px)');\r\n    this._mobileQueryListener = () => changeDetectorRef.detectChanges();\r\n    this.mobileQuery.addEventListener('change', this._mobileQueryListener);\r\n\r\n    this.renderer.addClass(document.body, this.themeClass);\r\n\r\n    this.detectOldBrowser();\r\n  }\r\n\r\n  ngOnDestroy(): void {\r\n    this.mobileQuery.removeEventListener('change', this._mobileQueryListener);\r\n  }\r\n\r\n  private detectOldBrowser() {\r\n    const oldBrowser = userAgent.satisfies({\r\n      ie: '<11',\r\n      chrome: '<64',\r\n      firefox: '<60'\r\n    });\r\n\r\n    if (oldBrowser) {\r\n      console.log('Very old browser ! ', userAgent.getBrowser());\r\n    }\r\n  }\r\n}\r\n","<div class=\"example-container\" [class.example-is-mobile]=\"mobileQuery.matches\">\r\n  <mat-toolbar color=\"primary\" class=\"example-toolbar\">\r\n    <button mat-icon-button (click)=\"snav.toggle()\"><mat-icon svgIcon=\"menu\"></mat-icon></button>\r\n    <h1>{{title}}</h1>\r\n    <h5>{{version.lib}}</h5>\r\n  </mat-toolbar>\r\n\r\n  <mat-sidenav-container class=\"example-sidenav-container\" [style.marginTop.px]=\"mobileQuery.matches ? 56 : 0\">\r\n    <mat-sidenav #snav opened=\"true\" [mode]=\"mobileQuery.matches ? 'over' : 'side'\" [fixedInViewport]=\"mobileQuery.matches\" fixedTopGap=\"56\">\r\n      <mat-nav-list>\r\n        <a mat-list-item routerLink=\".\">Home</a>\r\n\r\n        <hr>\r\n\r\n        <a mat-list-item routerLink=\"activity\">Activity</a>\r\n        <a mat-list-item routerLink=\"config\">Config</a>\r\n        <a mat-list-item routerLink=\"language\">Language</a>\r\n        <a mat-list-item routerLink=\"media\">Media</a>\r\n        <a mat-list-item routerLink=\"message\">Message</a>\r\n        <a mat-list-item routerLink=\"request\">Request</a>\r\n\r\n        <hr>\r\n\r\n        <a mat-list-item routerLink=\"auth-form\">Authentification</a>\r\n\r\n        <hr>\r\n\r\n        <a mat-list-item routerLink=\"action\">Action</a>\r\n        <a mat-list-item routerLink=\"dynamic-component\">Dynamic Component</a>\r\n        <a mat-list-item routerLink=\"entity-table\">Entity Table</a>\r\n        <a mat-list-item routerLink=\"entity-selector\">Entity Selector</a>\r\n        <a mat-list-item routerLink=\"form\">Form</a>\r\n        <a mat-list-item routerLink=\"table\">Table</a>\r\n        <a mat-list-item routerLink=\"tool\">Tool</a>\r\n        <a mat-list-item routerLink=\"widget\">Widget</a>\r\n\r\n        <hr>\r\n\r\n        <a mat-list-item routerLink=\"simple-map\">Simple map</a>\r\n        <a mat-list-item routerLink=\"layer\">Layer</a>\r\n        <a mat-list-item routerLink=\"legend\">Legend</a>\r\n        <a mat-list-item routerLink=\"overlay\">Overlay</a>\r\n        <a mat-list-item routerLink=\"geometry\">Geometry</a>\r\n        <a mat-list-item routerLink=\"feature\">Feature</a>\r\n        <a mat-list-item routerLink=\"hover\">Hover</a>\r\n        <a mat-list-item routerLink=\"measure\">Measure</a>\r\n        <a mat-list-item routerLink=\"draw\">Draw</a>\r\n        <a mat-list-item routerLink=\"query\">Query</a>\r\n        <a mat-list-item routerLink=\"catalog\">Catalog</a>\r\n        <a mat-list-item routerLink=\"search\">Search</a>\r\n        <a mat-list-item routerLink=\"print\">Print</a>\r\n        <a mat-list-item routerLink=\"import-export\">Import/Export</a>\r\n        <a mat-list-item routerLink=\"directions\">Directions</a>\r\n        <a mat-list-item routerLink=\"time-filter\">Time filter</a>\r\n        <a mat-list-item routerLink=\"ogc-filter\">OGC filter</a>\r\n        <a mat-list-item routerLink=\"spatial-filter\">Spatial filter</a>\r\n        <a mat-list-item routerLink=\"workspace\">Workspace</a>\r\n\r\n        <hr>\r\n\r\n        <a mat-list-item routerLink=\"context\">Context</a>\r\n\r\n      </mat-nav-list>\r\n    </mat-sidenav>\r\n\r\n    <mat-sidenav-content>\r\n      <router-outlet></router-outlet>\r\n    </mat-sidenav-content>\r\n\r\n  </mat-sidenav-container>\r\n</div>\r\n","import { BrowserModule, DomSanitizer } from '@angular/platform-browser';\r\nimport { BrowserAnimationsModule } from '@angular/platform-browser/animations';\r\nimport { APP_INITIALIZER, NgModule } from '@angular/core';\r\nimport { HammerModule } from '@angular/platform-browser';\r\nimport { MatButtonModule } from '@angular/material/button';\r\nimport { MatIconRegistry, MatIconModule } from '@angular/material/icon';\r\nimport { MatListModule } from '@angular/material/list';\r\nimport { MatSidenavModule } from '@angular/material/sidenav';\r\nimport { MatToolbarModule } from '@angular/material/toolbar';\r\nimport { AppHomeModule } from './core/home/home.module';\r\nimport { AppActivityModule } from './core/activity/activity.module';\r\nimport { AppConfigModule } from './core/config/config.module';\r\nimport { AppLanguageModule } from './core/language/language.module';\r\nimport { AppMediaModule } from './core/media/media.module';\r\nimport { AppMessageModule } from './core/message/message.module';\r\nimport { AppRequestModule } from './core/request/request.module';\r\n\r\nimport { AppActionModule } from './common/action/action.module';\r\nimport { AppDynamicComponentModule } from './common/dynamic-component/dynamic-component.module';\r\nimport { AppEntityTableModule } from './common/entity-table/entity-table.module';\r\nimport { AppEntitySelectorModule } from './common/entity-selector/entity-selector.module';\r\nimport { AppFormModule } from './common/form/form.module';\r\nimport { AppTableModule } from './common/table/table.module';\r\nimport { AppToolModule } from './common/tool/tool.module';\r\nimport { AppWidgetModule } from './common/widget/widget.module';\r\n\r\nimport { AppAuthFormModule } from './auth/auth-form/auth-form.module';\r\n\r\nimport { AppSimpleMapModule } from './geo/simple-map/simple-map.module';\r\nimport { AppLayerModule } from './geo/layer/layer.module';\r\nimport { AppLegendModule } from './geo/legend/legend.module';\r\nimport { AppOverlayModule } from './geo/overlay/overlay.module';\r\nimport { AppGeometryModule } from './geo/geometry/geometry.module';\r\nimport { AppFeatureModule } from './geo/feature/feature.module';\r\nimport { AppHoverModule } from './geo/hover/hover.module';\r\nimport { AppMeasureModule } from './geo/measure/measure.module';\r\nimport { AppDrawModule } from './geo/draw/draw.module';\r\nimport { AppQueryModule } from './geo/query/query.module';\r\nimport { AppCatalogModule } from './geo/catalog/catalog.module';\r\nimport { AppSearchModule } from './geo/search/search.module';\r\nimport { AppPrintModule } from './geo/print/print.module';\r\nimport { AppImportExport } from './geo/import-export/import-export.module';\r\nimport { AppDirectionsModule } from './geo/directions/directions.module';\r\nimport { AppTimeFilterModule } from './geo/time-filter/time-filter.module';\r\nimport { AppOgcFilterModule } from './geo/ogc-filter/ogc-filter.module';\r\nimport { AppSpatialFilterModule } from './geo/spatial-filter/spatial-filter.module';\r\nimport { AppWorkspaceModule } from './geo/workspace/workspace.module';\r\n\r\nimport { AppContextModule } from './context/context/context.module';\r\n\r\nimport { AppRoutingModule } from './app-routing.module';\r\nimport { AppComponent } from './app.component';\r\nimport { IgoCoreModule, LanguageService } from '@igo2/core';\r\n\r\n@NgModule({\r\n  declarations: [AppComponent],\r\n  imports: [\r\n    IgoCoreModule,\r\n    BrowserModule,\r\n    BrowserAnimationsModule,\r\n    MatSidenavModule,\r\n    MatToolbarModule,\r\n    MatButtonModule,\r\n    MatIconModule,\r\n    MatListModule,\r\n\r\n    AppHomeModule,\r\n    AppActivityModule,\r\n    AppConfigModule,\r\n    AppLanguageModule,\r\n    AppMediaModule,\r\n    AppMessageModule,\r\n    AppRequestModule,\r\n\r\n    AppActionModule,\r\n    AppDynamicComponentModule,\r\n    AppEntityTableModule,\r\n    AppEntitySelectorModule,\r\n    AppFormModule,\r\n    AppTableModule,\r\n    AppToolModule,\r\n    AppWidgetModule,\r\n\r\n    AppAuthFormModule,\r\n\r\n    AppSimpleMapModule,\r\n    AppLayerModule,\r\n    AppLegendModule,\r\n    AppOverlayModule,\r\n    AppGeometryModule,\r\n    AppFeatureModule,\r\n    AppHoverModule,\r\n    AppMeasureModule,\r\n    AppDrawModule,\r\n    AppQueryModule,\r\n    AppCatalogModule,\r\n    AppSearchModule,\r\n    AppPrintModule,\r\n    AppImportExport,\r\n    AppDirectionsModule,\r\n    AppTimeFilterModule,\r\n    AppOgcFilterModule,\r\n    AppSpatialFilterModule,\r\n    AppWorkspaceModule,\r\n\r\n    AppContextModule,\r\n\r\n    AppRoutingModule,\r\n\r\n    HammerModule\r\n  ],\r\n  providers: [\r\n    {provide: APP_INITIALIZER, useFactory: appInitializerFactory, deps: [LanguageService], multi: true},\r\n  ],\r\n  bootstrap: [AppComponent]\r\n})\r\nexport class AppModule {\r\n  constructor(matIconRegistry: MatIconRegistry, domSanitizer: DomSanitizer) {\r\n    matIconRegistry.addSvgIconSet(\r\n      domSanitizer.bypassSecurityTrustResourceUrl(\r\n        './assets/igo2/core/icons/mdi.svg'\r\n      )\r\n    );\r\n  }\r\n}\r\n\r\nexport function appInitializerFactory(languageService: LanguageService) {\r\n  return () => new Promise<any>((resolve: any) => {\r\n      languageService.translate.getTranslation(languageService.getLanguage()).subscribe(() => {\r\n        console.info(`Successfully initialized '${languageService.getLanguage()}' language.'`);\r\n      }, err => {\r\n        console.error(`Problem with '${languageService.getLanguage()}' language initialization.'`);\r\n      }, () => {\r\n        resolve(null);\r\n      });\r\n  });\r\n}\r\n","import { enableProdMode } from '@angular/core';\r\nimport { platformBrowserDynamic } from '@angular/platform-browser-dynamic';\r\n\r\nimport { AppModule } from './app/app.module';\r\nimport { environment } from './environments/environment';\r\n\r\nimport 'hammerjs';\r\n\r\nif (environment.production) {\r\n  enableProdMode();\r\n}\r\n\r\nplatformBrowserDynamic()\r\n  .bootstrapModule(AppModule)\r\n  .catch(err => console.log(err));\r\n","var map = {\n\t\"./af\": 62275,\n\t\"./af.js\": 62275,\n\t\"./ar\": 90857,\n\t\"./ar-dz\": 11218,\n\t\"./ar-dz.js\": 11218,\n\t\"./ar-kw\": 14754,\n\t\"./ar-kw.js\": 14754,\n\t\"./ar-ly\": 66680,\n\t\"./ar-ly.js\": 66680,\n\t\"./ar-ma\": 92178,\n\t\"./ar-ma.js\": 92178,\n\t\"./ar-sa\": 56522,\n\t\"./ar-sa.js\": 56522,\n\t\"./ar-tn\": 95682,\n\t\"./ar-tn.js\": 95682,\n\t\"./ar.js\": 90857,\n\t\"./az\": 70164,\n\t\"./az.js\": 70164,\n\t\"./be\": 79774,\n\t\"./be.js\": 79774,\n\t\"./bg\": 60947,\n\t\"./bg.js\": 60947,\n\t\"./bm\": 21832,\n\t\"./bm.js\": 21832,\n\t\"./bn\": 89650,\n\t\"./bn-bd\": 74477,\n\t\"./bn-bd.js\": 74477,\n\t\"./bn.js\": 89650,\n\t\"./bo\": 66005,\n\t\"./bo.js\": 66005,\n\t\"./br\": 98492,\n\t\"./br.js\": 98492,\n\t\"./bs\": 70534,\n\t\"./bs.js\": 70534,\n\t\"./ca\": 52061,\n\t\"./ca.js\": 52061,\n\t\"./cs\": 84737,\n\t\"./cs.js\": 84737,\n\t\"./cv\": 61167,\n\t\"./cv.js\": 61167,\n\t\"./cy\": 77996,\n\t\"./cy.js\": 77996,\n\t\"./da\": 9528,\n\t\"./da.js\": 9528,\n\t\"./de\": 14540,\n\t\"./de-at\": 49430,\n\t\"./de-at.js\": 49430,\n\t\"./de-ch\": 67978,\n\t\"./de-ch.js\": 67978,\n\t\"./de.js\": 14540,\n\t\"./dv\": 83426,\n\t\"./dv.js\": 83426,\n\t\"./el\": 6616,\n\t\"./el.js\": 6616,\n\t\"./en-au\": 63816,\n\t\"./en-au.js\": 63816,\n\t\"./en-ca\": 32162,\n\t\"./en-ca.js\": 32162,\n\t\"./en-gb\": 83305,\n\t\"./en-gb.js\": 83305,\n\t\"./en-ie\": 61954,\n\t\"./en-ie.js\": 61954,\n\t\"./en-il\": 43060,\n\t\"./en-il.js\": 43060,\n\t\"./en-in\": 59923,\n\t\"./en-in.js\": 59923,\n\t\"./en-nz\": 13540,\n\t\"./en-nz.js\": 13540,\n\t\"./en-sg\": 16505,\n\t\"./en-sg.js\": 16505,\n\t\"./eo\": 41907,\n\t\"./eo.js\": 41907,\n\t\"./es\": 86640,\n\t\"./es-do\": 41246,\n\t\"./es-do.js\": 41246,\n\t\"./es-mx\": 56131,\n\t\"./es-mx.js\": 56131,\n\t\"./es-us\": 36430,\n\t\"./es-us.js\": 36430,\n\t\"./es.js\": 86640,\n\t\"./et\": 62551,\n\t\"./et.js\": 62551,\n\t\"./eu\": 32711,\n\t\"./eu.js\": 32711,\n\t\"./fa\": 54572,\n\t\"./fa.js\": 54572,\n\t\"./fi\": 33390,\n\t\"./fi.js\": 33390,\n\t\"./fil\": 87860,\n\t\"./fil.js\": 87860,\n\t\"./fo\": 48216,\n\t\"./fo.js\": 48216,\n\t\"./fr\": 99291,\n\t\"./fr-ca\": 98527,\n\t\"./fr-ca.js\": 98527,\n\t\"./fr-ch\": 58407,\n\t\"./fr-ch.js\": 58407,\n\t\"./fr.js\": 99291,\n\t\"./fy\": 47054,\n\t\"./fy.js\": 47054,\n\t\"./ga\": 49540,\n\t\"./ga.js\": 49540,\n\t\"./gd\": 73917,\n\t\"./gd.js\": 73917,\n\t\"./gl\": 51486,\n\t\"./gl.js\": 51486,\n\t\"./gom-deva\": 56245,\n\t\"./gom-deva.js\": 56245,\n\t\"./gom-latn\": 48868,\n\t\"./gom-latn.js\": 48868,\n\t\"./gu\": 59652,\n\t\"./gu.js\": 59652,\n\t\"./he\": 89019,\n\t\"./he.js\": 89019,\n\t\"./hi\": 42040,\n\t\"./hi.js\": 42040,\n\t\"./hr\": 63402,\n\t\"./hr.js\": 63402,\n\t\"./hu\": 79322,\n\t\"./hu.js\": 79322,\n\t\"./hy-am\": 27609,\n\t\"./hy-am.js\": 27609,\n\t\"./id\": 57942,\n\t\"./id.js\": 57942,\n\t\"./is\": 98275,\n\t\"./is.js\": 98275,\n\t\"./it\": 73053,\n\t\"./it-ch\": 4378,\n\t\"./it-ch.js\": 4378,\n\t\"./it.js\": 73053,\n\t\"./ja\": 46176,\n\t\"./ja.js\": 46176,\n\t\"./jv\": 679,\n\t\"./jv.js\": 679,\n\t\"./ka\": 92726,\n\t\"./ka.js\": 92726,\n\t\"./kk\": 72953,\n\t\"./kk.js\": 72953,\n\t\"./km\": 86957,\n\t\"./km.js\": 86957,\n\t\"./kn\": 59181,\n\t\"./kn.js\": 59181,\n\t\"./ko\": 47148,\n\t\"./ko.js\": 47148,\n\t\"./ku\": 27752,\n\t\"./ku.js\": 27752,\n\t\"./ky\": 65675,\n\t\"./ky.js\": 65675,\n\t\"./lb\": 41263,\n\t\"./lb.js\": 41263,\n\t\"./lo\": 65746,\n\t\"./lo.js\": 65746,\n\t\"./lt\": 11143,\n\t\"./lt.js\": 11143,\n\t\"./lv\": 38753,\n\t\"./lv.js\": 38753,\n\t\"./me\": 44054,\n\t\"./me.js\": 44054,\n\t\"./mi\": 31573,\n\t\"./mi.js\": 31573,\n\t\"./mk\": 30202,\n\t\"./mk.js\": 30202,\n\t\"./ml\": 68523,\n\t\"./ml.js\": 68523,\n\t\"./mn\": 79794,\n\t\"./mn.js\": 79794,\n\t\"./mr\": 56681,\n\t\"./mr.js\": 56681,\n\t\"./ms\": 56975,\n\t\"./ms-my\": 39859,\n\t\"./ms-my.js\": 39859,\n\t\"./ms.js\": 56975,\n\t\"./mt\": 3691,\n\t\"./mt.js\": 3691,\n\t\"./my\": 5152,\n\t\"./my.js\": 5152,\n\t\"./nb\": 7607,\n\t\"./nb.js\": 7607,\n\t\"./ne\": 21526,\n\t\"./ne.js\": 21526,\n\t\"./nl\": 86368,\n\t\"./nl-be\": 40076,\n\t\"./nl-be.js\": 40076,\n\t\"./nl.js\": 86368,\n\t\"./nn\": 68420,\n\t\"./nn.js\": 68420,\n\t\"./oc-lnc\": 51906,\n\t\"./oc-lnc.js\": 51906,\n\t\"./pa-in\": 94504,\n\t\"./pa-in.js\": 94504,\n\t\"./pl\": 54721,\n\t\"./pl.js\": 54721,\n\t\"./pt\": 74645,\n\t\"./pt-br\": 54548,\n\t\"./pt-br.js\": 54548,\n\t\"./pt.js\": 74645,\n\t\"./ro\": 71977,\n\t\"./ro.js\": 71977,\n\t\"./ru\": 26042,\n\t\"./ru.js\": 26042,\n\t\"./sd\": 78849,\n\t\"./sd.js\": 78849,\n\t\"./se\": 27739,\n\t\"./se.js\": 27739,\n\t\"./si\": 50084,\n\t\"./si.js\": 50084,\n\t\"./sk\": 92449,\n\t\"./sk.js\": 92449,\n\t\"./sl\": 23086,\n\t\"./sl.js\": 23086,\n\t\"./sq\": 33139,\n\t\"./sq.js\": 33139,\n\t\"./sr\": 30607,\n\t\"./sr-cyrl\": 30063,\n\t\"./sr-cyrl.js\": 30063,\n\t\"./sr.js\": 30607,\n\t\"./ss\": 40131,\n\t\"./ss.js\": 40131,\n\t\"./sv\": 21665,\n\t\"./sv.js\": 21665,\n\t\"./sw\": 5642,\n\t\"./sw.js\": 5642,\n\t\"./ta\": 33622,\n\t\"./ta.js\": 33622,\n\t\"./te\": 74825,\n\t\"./te.js\": 74825,\n\t\"./tet\": 48336,\n\t\"./tet.js\": 48336,\n\t\"./tg\": 39238,\n\t\"./tg.js\": 39238,\n\t\"./th\": 99463,\n\t\"./th.js\": 99463,\n\t\"./tk\": 39986,\n\t\"./tk.js\": 39986,\n\t\"./tl-ph\": 29672,\n\t\"./tl-ph.js\": 29672,\n\t\"./tlh\": 40043,\n\t\"./tlh.js\": 40043,\n\t\"./tr\": 51212,\n\t\"./tr.js\": 51212,\n\t\"./tzl\": 50110,\n\t\"./tzl.js\": 50110,\n\t\"./tzm\": 80482,\n\t\"./tzm-latn\": 38309,\n\t\"./tzm-latn.js\": 38309,\n\t\"./tzm.js\": 80482,\n\t\"./ug-cn\": 42495,\n\t\"./ug-cn.js\": 42495,\n\t\"./uk\": 54157,\n\t\"./uk.js\": 54157,\n\t\"./ur\": 80984,\n\t\"./ur.js\": 80984,\n\t\"./uz\": 64141,\n\t\"./uz-latn\": 43662,\n\t\"./uz-latn.js\": 43662,\n\t\"./uz.js\": 64141,\n\t\"./vi\": 12607,\n\t\"./vi.js\": 12607,\n\t\"./x-pseudo\": 66460,\n\t\"./x-pseudo.js\": 66460,\n\t\"./yo\": 92948,\n\t\"./yo.js\": 92948,\n\t\"./zh-cn\": 62658,\n\t\"./zh-cn.js\": 62658,\n\t\"./zh-hk\": 39352,\n\t\"./zh-hk.js\": 39352,\n\t\"./zh-mo\": 38274,\n\t\"./zh-mo.js\": 38274,\n\t\"./zh-tw\": 98451,\n\t\"./zh-tw.js\": 98451\n};\n\n\nfunction webpackContext(req) {\n\tvar id = webpackContextResolve(req);\n\treturn __webpack_require__(id);\n}\nfunction webpackContextResolve(req) {\n\tif(!__webpack_require__.o(map, req)) {\n\t\tvar e = new Error(\"Cannot find module '\" + req + \"'\");\n\t\te.code = 'MODULE_NOT_FOUND';\n\t\tthrow e;\n\t}\n\treturn map[req];\n}\nwebpackContext.keys = function webpackContextKeys() {\n\treturn Object.keys(map);\n};\nwebpackContext.resolve = webpackContextResolve;\nmodule.exports = webpackContext;\nwebpackContext.id = 46700;"]}